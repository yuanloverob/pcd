{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f0d3d5027367a725264fa6dca6c6a3fdfbf5fc50",
      "candidate_info": {
        "commit_hash": "f0d3d5027367a725264fa6dca6c6a3fdfbf5fc50",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f0d3d5027367a725264fa6dca6c6a3fdfbf5fc50",
        "files": [
          "admin/upgrade.txt",
          "lib/db/upgrade.php",
          "lib/tests/upgradelib_test.php",
          "lib/upgradelib.php",
          "version.php"
        ],
        "message": "MDL-65809 upgrade: remove upgrade_theme_is_from_family\n\nThese functions and setting were used only by deleted upgrade steps\nso it's safe to proceed with straight deletion, considering\nthem internal. Deletion has been documented in corresponding\nupgrade.txt files:\n\n- upgrade_theme_is_from_family()\n- upgrade_find_theme_location()\n- linkcoursesectionsupgradescriptwasrun setting",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/tests/upgradelib_test.php||lib/tests/upgradelib_test.php",
          "lib/upgradelib.php||lib/upgradelib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "922:         upgrade_main_savepoint(true, 2017082200.01);",
          "923:     }",
          "941:     if ($oldversion < 2017082500.00) {",
          "943:         $table = new xmldb_table('analytics_models_log');",
          "",
          "[Removed Lines]",
          "925:     if ($oldversion < 2017082300.01) {",
          "928:         if (empty($CFG->linkcoursesectionsupgradescriptwasrun)) {",
          "931:             if (upgrade_theme_is_from_family('boost', $CFG->theme)) {",
          "932:                 set_config('linkcoursesections', 1);",
          "933:             }",
          "934:             set_config('linkcoursesectionsupgradescriptwasrun', 1);",
          "935:         }",
          "938:         upgrade_main_savepoint(true, 2017082300.01);",
          "939:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3813:         upgrade_main_savepoint(true, 2019121800.00);",
          "3814:     }",
          "3816:     return true;",
          "3817: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3800:     if ($oldversion < 2019122000.01) {",
          "3802:         unset_config('linkcoursesectionsupgradescriptwasrun');",
          "3803:         upgrade_main_savepoint(true, 2019122000.01);",
          "3804:     }",
          "",
          "---------------"
        ],
        "lib/tests/upgradelib_test.php||lib/tests/upgradelib_test.php": [
          "File: lib/tests/upgradelib_test.php -> lib/tests/upgradelib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "783:         return \\org\\bovigo\\vfs\\vfsStream::url('themes');",
          "784:     }",
          "",
          "[Removed Lines]",
          "789:     public function test_upgrade_find_theme_location() {",
          "790:         global $CFG;",
          "792:         $this->resetAfterTest();",
          "794:         $CFG->themedir = $this->create_testthemes();",
          "796:         $this->assertSame($CFG->dirroot . '/theme/boost', upgrade_find_theme_location('boost'));",
          "797:         $this->assertSame($CFG->dirroot . '/theme/classic', upgrade_find_theme_location('classic'));",
          "799:         $this->assertSame($CFG->themedir . '/testtheme', upgrade_find_theme_location('testtheme'));",
          "800:         $this->assertSame($CFG->themedir . '/childoftesttheme', upgrade_find_theme_location('childoftesttheme'));",
          "801:     }",
          "806:     public function test_upgrade_theme_is_from_family() {",
          "807:         global $CFG;",
          "809:         $this->resetAfterTest();",
          "811:         $CFG->themedir = $this->create_testthemes();",
          "813:         $this->assertTrue(upgrade_theme_is_from_family('boost', 'boost'), 'Boost is a boost theme');",
          "814:         $this->assertTrue(upgrade_theme_is_from_family('boost', 'classic'), 'Classic is a boost base theme');",
          "815:         $this->assertFalse(upgrade_theme_is_from_family('classic', 'boost'), 'Boost is not a classic theme');",
          "817:         $this->assertTrue(upgrade_theme_is_from_family('testtheme', 'childoftesttheme'), 'childoftesttheme is a testtheme');",
          "818:         $this->assertFalse(upgrade_theme_is_from_family('testtheme', 'orphantheme'), 'ofphantheme is not a testtheme');",
          "819:         $this->assertTrue(upgrade_theme_is_from_family('testtheme', 'infinite'), 'Infinite loop with testtheme parent is true');",
          "820:         $this->assertFalse(upgrade_theme_is_from_family('testtheme', 'loop'), 'Infinite loop without testtheme parent is false');",
          "821:         $this->assertTrue(upgrade_theme_is_from_family('testtheme', 'themewithbrokenparent'), 'No error on broken parent');",
          "822:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/upgradelib.php||lib/upgradelib.php": [
          "File: lib/upgradelib.php -> lib/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2671:         }",
          "2672:     }",
          "2673: }",
          "",
          "[Removed Lines]",
          "2683: function upgrade_theme_is_from_family($needle, $themename, $checkedthemeforparents = []) {",
          "2684:     global $CFG;",
          "2687:     if (!empty($checkedthemeforparents[$themename])) {",
          "2688:         return false;",
          "2689:     }",
          "2690:     $checkedthemeforparents[$themename] = true;",
          "2692:     if ($themename == $needle) {",
          "2693:         return true;",
          "2694:     }",
          "2696:     if ($themedir = upgrade_find_theme_location($themename)) {",
          "2697:         $THEME = new stdClass();",
          "2698:         require($themedir . '/config.php');",
          "2699:         $theme = $THEME;",
          "2700:     } else {",
          "2701:         return false;",
          "2702:     }",
          "2704:     if (empty($theme->parents)) {",
          "2705:         return false;",
          "2706:     }",
          "2709:     foreach ($theme->parents as $parent) {",
          "2710:         if (upgrade_theme_is_from_family($needle, $parent, $checkedthemeforparents)) {",
          "2711:             return true;",
          "2712:         }",
          "2713:     }",
          "2714:     return false;",
          "2715: }",
          "2724: function upgrade_find_theme_location($themename) {",
          "2725:     global $CFG;",
          "2727:     if (file_exists(\"$CFG->dirroot/theme/$themename/config.php\")) {",
          "2728:         $dir = \"$CFG->dirroot/theme/$themename\";",
          "2729:     } else if (!empty($CFG->themedir) and file_exists(\"$CFG->themedir/$themename/config.php\")) {",
          "2730:         $dir = \"$CFG->themedir/$themename\";",
          "2731:     } else {",
          "2732:         return null;",
          "2733:     }",
          "2735:     return $dir;",
          "2736: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "35: $release  = '3.9dev (Build: 20191220)'; // Human-friendly version name",
          "",
          "[Removed Lines]",
          "32: $version  = 2019122000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b30b66c57e5af84b16536c019dc7840685ebaea2",
      "candidate_info": {
        "commit_hash": "b30b66c57e5af84b16536c019dc7840685ebaea2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b30b66c57e5af84b16536c019dc7840685ebaea2",
        "files": [
          "lib/coursecatlib.php",
          "lib/db/caches.php",
          "version.php"
        ],
        "message": "MDL-61519 coursecat: Reset the coursecat cache on enrolment",
        "before_after_code_files": [
          "lib/coursecatlib.php||lib/coursecatlib.php",
          "lib/db/caches.php||lib/db/caches.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/coursecatlib.php||lib/coursecatlib.php": [
          "File: lib/coursecatlib.php -> lib/coursecatlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "722:             return;",
          "723:         }",
          "725:         if (!$CFG->coursecontact || !in_array($roleid, explode(',', $CFG->coursecontact))) {",
          "727:             return;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "726:         cache_helper::purge_by_event('changesincategoryenrolment');",
          "",
          "---------------"
        ],
        "lib/db/caches.php||lib/db/caches.php": [
          "File: lib/db/caches.php -> lib/db/caches.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "134:         'simpledata' => true,",
          "135:         'invalidationevents' => array(",
          "136:             'changesincoursecat',",
          "137:         ),",
          "138:         'ttl' => 900,",
          "139:     ),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "137:             'changesincategoryenrolment',",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018031600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018031601.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5b2ab478635e69f9a7ca2f157b9f709b6ec7077",
      "candidate_info": {
        "commit_hash": "c5b2ab478635e69f9a7ca2f157b9f709b6ec7077",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c5b2ab478635e69f9a7ca2f157b9f709b6ec7077",
        "files": [
          "admin/settings/appearance.php",
          "lang/en/admin.php",
          "lib/db/upgrade.php",
          "lib/outputrenderers.php",
          "version.php"
        ],
        "message": "MDL-63612 core_admin: make course card colours configurable",
        "before_after_code_files": [
          "admin/settings/appearance.php||admin/settings/appearance.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/outputrenderers.php||lib/outputrenderers.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/appearance.php||admin/settings/appearance.php": [
          "File: admin/settings/appearance.php -> admin/settings/appearance.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "77:     $ADMIN->add('appearance', $temp);",
          "80:     $temp = new admin_settingpage('calendar', new lang_string('calendarsettings','admin'));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "80:     $temp = new admin_settingpage('coursecolors', new lang_string('coursecolorsettings', 'admin'));",
          "81:     $temp->add(new admin_setting_heading('coursecolorheading', '',",
          "82:         new lang_string('coursecolorheading_desc', 'admin')));",
          "84:     $basecolors = ['#81ecec', '#74b9ff', '#a29bfe', '#dfe6e9', '#00b894',",
          "85:             '#0984e3', '#b2bec3', '#fdcb6e', '#fd79a8', '#6c5ce7'];",
          "87:     foreach ($basecolors as $key => $color) {",
          "88:         $number = $key + 1;",
          "89:         $name = 'core_admin/coursecolor' . $number;",
          "90:         $title = get_string('coursecolor', 'admin', $number);",
          "91:         $setting = new admin_setting_configcolourpicker($name, $title, '', $color);",
          "92:         $temp->add($setting);",
          "93:     }",
          "95:     $ADMIN->add('appearance', $temp);",
          "",
          "---------------"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "390: $string['cookiesecure'] = 'Secure cookies only';",
          "391: $string['country'] = 'Default country';",
          "392: $string['course_customfield'] = 'Course custom fields';",
          "393: $string['coursecontact'] = 'Course contacts';",
          "394: $string['coursecontact_desc'] = 'This setting allows you to control who appears on the course description. Users need to have at least one of these roles in a course to be shown on the course description for that course.';",
          "395: $string['coursecontactduplicates'] = 'Display all course contact roles';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "393: $string['coursecolor'] = 'Colour {$a}';",
          "394: $string['coursecolorheading_desc'] = 'Any courses without a course image set in the course settings are displayed on the Dashboard with a patterned course card. The colours used in the pattern may be specified below.';",
          "395: $string['coursecolorsettings'] = 'Course card colours';",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3402:         upgrade_main_savepoint(true, 2019062900.00);",
          "3403:     }",
          "3405:     return true;",
          "3406: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3405:     if ($oldversion < 2019070400.01) {",
          "3407:         $basecolors = ['#81ecec', '#74b9ff', '#a29bfe', '#dfe6e9', '#00b894',",
          "3408:             '#0984e3', '#b2bec3', '#fdcb6e', '#fd79a8', '#6c5ce7'];",
          "3410:         $colornr = 1;",
          "3411:         foreach ($basecolors as $color) {",
          "3412:             set_config('coursecolor' .  $colornr, $color, 'core_admin');",
          "3413:             $colornr++;",
          "3414:         }",
          "3416:         upgrade_main_savepoint(true, 2019070400.01);",
          "3417:     }",
          "",
          "---------------"
        ],
        "lib/outputrenderers.php||lib/outputrenderers.php": [
          "File: lib/outputrenderers.php -> lib/outputrenderers.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1572:     public function get_generated_color_for_id($id) {",
          "1577:         $color = $basecolors[$id % 10];",
          "1578:         return $color;",
          "",
          "[Removed Lines]",
          "1574:         $basecolors = ['#81ecec', '#74b9ff', '#a29bfe', '#dfe6e9', '#00b894',",
          "1575:             '#0984e3', '#b2bec3', '#fdcb6e', '#fd79a8', '#6c5ce7'];",
          "",
          "[Added Lines]",
          "1573:         $colornumbers = range(1, 10);",
          "1574:         $basecolors = [];",
          "1575:         foreach ($colornumbers as $number) {",
          "1576:             $basecolors[] = get_config('core_admin', 'coursecolor' . $number);",
          "1577:         }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019071200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019071200.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5944a1d57cedd63984c4b67e4a246f457faf6a9",
      "candidate_info": {
        "commit_hash": "c5944a1d57cedd63984c4b67e4a246f457faf6a9",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c5944a1d57cedd63984c4b67e4a246f457faf6a9",
        "files": [
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-64553 message: Add index for the notifications.useridfrom field\n\nThe useridfrom would normally be a foreign key to the users table. But\nit can also contain some extra negative values with special semantics\n(-10 or -20 for no-reply or support user). Therefore we can't make it a\nforeign key and the index must be created explicitly.",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2680:         upgrade_main_savepoint(true, 2019011801.01);",
          "2681:     }",
          "2683:     return true;",
          "2684: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2683:     if ($oldversion < 2019011801.02) {",
          "2685:         $table = new xmldb_table('notifications');",
          "2686:         $index = new xmldb_index('useridfrom', XMLDB_INDEX_NOTUNIQUE, ['useridfrom']);",
          "2688:         if (!$dbman->index_exists($table, $index)) {",
          "2689:             $dbman->add_index($table, $index);",
          "2690:         }",
          "2692:         upgrade_main_savepoint(true, 2019011801.02);",
          "2693:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019011801.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019011801.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "20bf0c45ff43a5fad89f18b1cbdd09af9e67ba54",
      "candidate_info": {
        "commit_hash": "20bf0c45ff43a5fad89f18b1cbdd09af9e67ba54",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/20bf0c45ff43a5fad89f18b1cbdd09af9e67ba54",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018040500.03;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180405)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018041200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180412)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}