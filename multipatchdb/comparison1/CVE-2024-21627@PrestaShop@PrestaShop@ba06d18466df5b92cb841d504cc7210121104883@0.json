{
  "cve_id": "CVE-2024-21627",
  "cve_desc": "PrestaShop is an open-source e-commerce platform. Prior to versions 8.1.3 and 1.7.8.11, some event attributes are not detected by the `isCleanHTML` method. Some modules using the `isCleanHTML` method could be vulnerable to cross-site scripting. Versions 8.1.3 and 1.7.8.11 contain a patch for this issue. The best workaround is to use the `HTMLPurifier` library to sanitize html input coming from users. The library is already available as a dependency in the PrestaShop project. Beware though that in legacy object models, fields of `HTML` type will call `isCleanHTML`.",
  "repo": "PrestaShop/PrestaShop",
  "patch_hash": "ba06d18466df5b92cb841d504cc7210121104883",
  "patch_info": {
    "commit_hash": "ba06d18466df5b92cb841d504cc7210121104883",
    "repo": "PrestaShop/PrestaShop",
    "commit_url": "https://github.com/PrestaShop/PrestaShop/commit/ba06d18466df5b92cb841d504cc7210121104883",
    "files": [
      "classes/Validate.php",
      "js/admin.js",
      "js/tools.js",
      "src/Core/ConstraintValidator/CleanHtmlValidator.php",
      "tests/Unit/Adapter/ValidateTest.php",
      "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
    ],
    "message": "Merge remote-tracking branch 'security/advisory-fix-2' into build-1-1.7.8.11",
    "before_after_code_files": [
      "classes/Validate.php||classes/Validate.php",
      "js/admin.js||js/admin.js",
      "js/tools.js||js/tools.js",
      "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php",
      "tests/Unit/Adapter/ValidateTest.php||tests/Unit/Adapter/ValidateTest.php",
      "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
    ]
  },
  "patch_diff": {
    "classes/Validate.php||classes/Validate.php": [
      "File: classes/Validate.php -> classes/Validate.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "481:     public static function isCleanHtml($html, $allow_iframe = false)",
      "482:     {",
      "483:         $events = 'onmousedown|onmousemove|onmmouseup|onmouseover|onmouseout|onload|onunload|onfocus|onblur|onchange';",
      "484:         $events .= '|onsubmit|ondblclick|onclick|onkeydown|onkeyup|onkeypress|onmouseenter|onmouseleave|onerror|onselect|onreset|onabort|ondragdrop|onresize|onactivate|onafterprint|onmoveend';",
      "485:         $events .= '|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onmove';",
      "487:         $events .= '|ondragleave|ondragover|ondragstart|ondrop|onerrorupdate|onfilterchange|onfinish|onfocusin|onfocusout|onhashchange|onhelp|oninput|onlosecapture|onmessage|onmouseup|onmovestart';",
      "488:         $events .= '|onoffline|ononline|onpaste|onpropertychange|onreadystatechange|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onsearch|onselectionchange';",
      "489:         $events .= '|onselectstart|onstart|onstop|onanimationcancel|onanimationend|onanimationiteration|onanimationstart';",
      "490:         $events .= '|onpointerover|onpointerenter|onpointerdown|onpointermove|onpointerup|onpointerout|onpointerleave|onpointercancel|ongotpointercapture|onlostpointercapture';",
      "493:             return false;",
      "494:         }",
      "",
      "[Removed Lines]",
      "486:         $events .= '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|onmousewheel';",
      "492:         if (preg_match('/<[\\s]*script/ims', $html) || preg_match('/(' . $events . ')[\\s]*=/ims', $html) || preg_match('/.*script\\:/ims', $html)) {",
      "",
      "[Added Lines]",
      "484:         $eventAttributeRegex = '/<\\s*\\w+[^>]*\\s(on\\w+)=[\"\\'][^\"\\']*[\"\\']/ims';",
      "489:         $events .= '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|ondragexit|onmousewheel';",
      "494:         $events .= '|onpagehide|onpageshow|onautocomplete|onautocompleteerror|oncanplay|oncanplaythrough|onclose|oncuechange|ondurationchange|onemptied|onended|oninvalid|onloadeddata';",
      "495:         $events .= '|onloadedmetadata|onloadstart|onpause|onplay|onplaying|onpopstate|onprogress|onratechange|onreset|onseeked|onseeking|onshow|onsort|onstalled|onstorage|onsuspend|ontimeupdate';",
      "496:         $events .= '|ontoggle|onvolumechange|onwaiting';",
      "498:         if (preg_match('/<[\\s]*script/ims', $html) || preg_match($eventAttributeRegex, $html) || preg_match('/(' . $events . ')[\\s]*=/ims', $html) || preg_match('/.*script\\:/ims', $html)) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "497:             return false;",
      "498:         }",
      "500:         return true;",
      "501:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "507:         $rloCharacters = \"\\xE2\\x80\\xAE\";",
      "510:         if (strpos($html, $rloCharacters) !== false) {",
      "512:             return false;",
      "513:         }",
      "",
      "---------------"
    ],
    "js/admin.js||js/admin.js": [
      "File: js/admin.js -> js/admin.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1572:   var events = 'onmousedown|onmousemove|onmmouseup|onmouseover|onmouseout|onload|onunload|onfocus|onblur|onchange';",
      "1573:   events += '|onsubmit|ondblclick|onclick|onkeydown|onkeyup|onkeypress|onmouseenter|onmouseleave|onerror|onselect|onreset|onabort|ondragdrop|onresize|onactivate|onafterprint|onmoveend';",
      "1574:   events += '|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onmove';",
      "1576:   events += '|ondragleave|ondragover|ondragstart|ondrop|onerrorupdate|onfilterchange|onfinish|onfocusin|onfocusout|onhashchange|onhelp|oninput|onlosecapture|onmessage|onmouseup|onmovestart';",
      "1577:   events += '|onoffline|ononline|onpaste|onpropertychange|onreadystatechange|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onsearch|onselectionchange';",
      "1580:   var script1 = /<[\\s]*script/im;",
      "1581:   var script2 = new RegExp('('+events+')[\\s]*=', 'im');",
      "1582:   var script3 = /.*script\\:/im;",
      "1583:   var script4 = /<[\\s]*(i?frame|embed|object)/im;",
      "1586:     return false;",
      "1588:   return true;",
      "",
      "[Removed Lines]",
      "1575:   events += '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|onmousewheel';",
      "1578:   events += '|onselectstart|onstart|onstop';",
      "1585:   if (script1.test(content) || script2.test(content) || script3.test(content) || script4.test(content))",
      "",
      "[Added Lines]",
      "1575:   events += '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|ondragexit|onmousewheel';",
      "1578:   events += '|onselectstart|onstart|onstop|onanimationcancel|onanimationend|onanimationiteration|onanimationstart';",
      "1579:   events += '|onpointerover|onpointerenter|onpointerdown|onpointermove|onpointerup|onpointerout|onpointerleave|onpointercancel|ongotpointercapture|onlostpointercapture';",
      "1580:   events += '|onpagehide|onpageshow|onautocomplete|onautocompleteerror|oncanplay|oncanplaythrough|onclose|oncuechange|ondurationchange|onemptied|onended|oninvalid|onloadeddata';",
      "1581:   events += '|onloadedmetadata|onloadstart|onpause|onplay|onplaying|onpopstate|onprogress|onratechange|onreset|onseeked|onseeking|onshow|onsort|onstalled|onstorage|onsuspend|ontimeupdate';",
      "1582:   events += '|ontoggle|onvolumechange|onwaiting';",
      "1588:   var script5 = /<\\s*\\w+[^>]*\\s(on\\w+)=[\"'][^\"']*[\"']/ims;",
      "1589:   var rloCharacter = \"\\xE2\\x80\\xAE\";",
      "1591:   if (script1.test(content) || script2.test(content) || script3.test(content) || script4.test(content) || script5.test(content) || content.indexOf(rloCharacter) !== -1)",
      "",
      "---------------"
    ],
    "js/tools.js||js/tools.js": [
      "File: js/tools.js -> js/tools.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "706: function isCleanHtml(content)",
      "707: {",
      "725: }",
      "727: function getStorageAvailable() {",
      "",
      "[Removed Lines]",
      "708:  var events = 'onmousedown|onmousemove|onmmouseup|onmouseover|onmouseout|onload|onunload|onfocus|onblur|onchange';",
      "709:  events += '|onsubmit|ondblclick|onclick|onkeydown|onkeyup|onkeypress|onmouseenter|onmouseleave|onerror|onselect|onreset|onabort|ondragdrop|onresize|onactivate|onafterprint|onmoveend';",
      "710:  events += '|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onmove';",
      "711:  events += '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|onmousewheel';",
      "712:  events += '|ondragleave|ondragover|ondragstart|ondrop|onerrorupdate|onfilterchange|onfinish|onfocusin|onfocusout|onhashchange|onhelp|oninput|onlosecapture|onmessage|onmouseup|onmovestart';",
      "713:  events += '|onoffline|ononline|onpaste|onpropertychange|onreadystatechange|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onsearch|onselectionchange';",
      "714:  events += '|onselectstart|onstart|onstop';",
      "716:  var script1 = /<[\\s]*script/im;",
      "717:  var script2 = new RegExp('('+events+')[\\s]*=', 'im');",
      "718:  var script3 = /.*script\\:/im;",
      "719:  var script4 = /<[\\s]*(i?frame|embed|object)/im;",
      "721:  if (script1.test(content) || script2.test(content) || script3.test(content) || script4.test(content))",
      "722:   return false;",
      "724:  return true;",
      "",
      "[Added Lines]",
      "708:   var events = 'onmousedown|onmousemove|onmmouseup|onmouseover|onmouseout|onload|onunload|onfocus|onblur|onchange';",
      "709:   events += '|onsubmit|ondblclick|onclick|onkeydown|onkeyup|onkeypress|onmouseenter|onmouseleave|onerror|onselect|onreset|onabort|ondragdrop|onresize|onactivate|onafterprint|onmoveend';",
      "710:   events += '|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onmove';",
      "711:   events += '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|ondragexit|onmousewheel';",
      "712:   events += '|ondragleave|ondragover|ondragstart|ondrop|onerrorupdate|onfilterchange|onfinish|onfocusin|onfocusout|onhashchange|onhelp|oninput|onlosecapture|onmessage|onmouseup|onmovestart';",
      "713:   events += '|onoffline|ononline|onpaste|onpropertychange|onreadystatechange|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onsearch|onselectionchange';",
      "714:   events += '|onselectstart|onstart|onstop|onanimationcancel|onanimationend|onanimationiteration|onanimationstart';",
      "715:   events += '|onpointerover|onpointerenter|onpointerdown|onpointermove|onpointerup|onpointerout|onpointerleave|onpointercancel|ongotpointercapture|onlostpointercapture';",
      "716:   events += '|onpagehide|onpageshow|onautocomplete|onautocompleteerror|oncanplay|oncanplaythrough|onclose|oncuechange|ondurationchange|onemptied|onended|oninvalid|onloadeddata';",
      "717:   events += '|onloadedmetadata|onloadstart|onpause|onplay|onplaying|onpopstate|onprogress|onratechange|onreset|onseeked|onseeking|onshow|onsort|onstalled|onstorage|onsuspend|ontimeupdate';",
      "718:   events += '|ontoggle|onvolumechange|onwaiting';",
      "720:   var script1 = /<[\\s]*script/im;",
      "721:   var script2 = new RegExp('('+events+')[\\s]*=', 'im');",
      "722:   var script3 = /.*script\\:/im;",
      "723:   var script4 = /<[\\s]*(i?frame|embed|object)/im;",
      "724:   var script5 = /<\\s*\\w+[^>]*\\s(on\\w+)=[\"'][^\"']*[\"']/ims;",
      "725:   var rloCharacter = \"\\xE2\\x80\\xAE\";",
      "727:   if (script1.test(content) || script2.test(content) || script3.test(content) || script4.test(content) || script5.test(content) || content.indexOf(rloCharacter) !== -1)",
      "728:     return false;",
      "730:   return true;",
      "",
      "---------------"
    ],
    "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php": [
      "File: src/Core/ConstraintValidator/CleanHtmlValidator.php -> src/Core/ConstraintValidator/CleanHtmlValidator.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "70:         $containsJavascriptEvents = preg_match('/(' . $this->getJavascriptEvents() . ')[\\s]*=/ims', $value);",
      "72:         $iframe = !$this->allowEmbeddableHtml && preg_match(self::EMBEDDABLE_HTML_PATTERN, $value);",
      "74:             $this->context->buildViolation($constraint->message)",
      "75:                 ->setTranslationDomain('Admin.Notifications.Error')",
      "76:                 ->setParameter('%s', $this->formatValue($value))",
      "",
      "[Removed Lines]",
      "73:         if ($containsScriptTags || $containsJavascriptEvents || $iframe) {",
      "",
      "[Added Lines]",
      "75:         $eventAttributeRegex = '/<\\s*\\w+[^>]*\\s(on\\w+)=[\"\\'][^\"\\']*[\"\\']/ims';",
      "77:         $rloCharacters = \"\\xE2\\x80\\xAE\";",
      "80:         if (strpos($value, $rloCharacters) !== false) {",
      "82:             return false;",
      "83:         }",
      "85:         if ($containsScriptTags || $containsJavascriptEvents || $iframe || preg_match($eventAttributeRegex, $value) || strpos($value, $rloCharacters) !== false) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "90:         $events = 'onmousedown|onmousemove|onmmouseup|onmouseover|onmouseout|onload|onunload|onfocus|onblur|onchange';",
      "91:         $events .= '|onsubmit|ondblclick|onclick|onkeydown|onkeyup|onkeypress|onmouseenter|onmouseleave|onerror|onselect|onreset|onabort|ondragdrop|onresize|onactivate|onafterprint|onmoveend';",
      "92:         $events .= '|onafterupdate|onbeforeactivate|onbeforecopy|onbeforecut|onbeforedeactivate|onbeforeeditfocus|onbeforepaste|onbeforeprint|onbeforeunload|onbeforeupdate|onmove';",
      "94:         $events .= '|ondragleave|ondragover|ondragstart|ondrop|onerrorupdate|onfilterchange|onfinish|onfocusin|onfocusout|onhashchange|onhelp|oninput|onlosecapture|onmessage|onmouseup|onmovestart';",
      "95:         $events .= '|onoffline|ononline|onpaste|onpropertychange|onreadystatechange|onresizeend|onresizestart|onrowenter|onrowexit|onrowsdelete|onrowsinserted|onscroll|onsearch|onselectionchange';",
      "98:         return $events;",
      "99:     }",
      "",
      "[Removed Lines]",
      "93:         $events .= '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|onmousewheel';",
      "96:         $events .= '|onselectstart|onstart|onstop';",
      "",
      "[Added Lines]",
      "105:         $events .= '|onbounce|oncellchange|oncontextmenu|oncontrolselect|oncopy|oncut|ondataavailable|ondatasetchanged|ondatasetcomplete|ondeactivate|ondrag|ondragend|ondragenter|ondragexit|onmousewheel';",
      "108:         $events .= '|onselectstart|onstart|onstop|onanimationcancel|onanimationend|onanimationiteration|onanimationstart';",
      "109:         $events .= '|onpointerover|onpointerenter|onpointerdown|onpointermove|onpointerup|onpointerout|onpointerleave|onpointercancel|ongotpointercapture|onlostpointercapture';",
      "110:         $events .= '|onpagehide|onpageshow|onautocomplete|onautocompleteerror|oncanplay|oncanplaythrough|onclose|oncuechange|ondurationchange|onemptied|onended|oninvalid|onloadeddata';",
      "111:         $events .= '|onloadedmetadata|onloadstart|onpause|onplay|onplaying|onpopstate|onprogress|onratechange|onreset|onseeked|onseeking|onshow|onsort|onstalled|onstorage|onsuspend|ontimeupdate';",
      "112:         $events .= '|ontoggle|onvolumechange|onwaiting';",
      "",
      "---------------"
    ],
    "tests/Unit/Adapter/ValidateTest.php||tests/Unit/Adapter/ValidateTest.php": [
      "File: tests/Unit/Adapter/ValidateTest.php -> tests/Unit/Adapter/ValidateTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "77:         $this->assertSame($expected, $this->validate->isEmail($email));",
      "78:     }",
      "80:     public function isEmailDataProvider(): array",
      "81:     {",
      "82:         return [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "89:     public function testIsCleanHtml(string $html, bool $allowFrame, $expectedResult): void",
      "90:     {",
      "91:         $this->assertSame($expectedResult, $this->validate->isCleanHtml($html, $allowFrame));",
      "92:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "95:             [true, 'xn--80adrw@xn--80aswg.xn--p1ai'],",
      "96:         ];",
      "97:     }",
      "98: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "113:     private function isCleanHtmlDataProvider()",
      "114:     {",
      "115:         return [",
      "116:             [",
      "117:                 '<div randomattribute=\"randomvalue\">test</div>', // nominal case",
      "118:                 false,",
      "119:                 true",
      "120:             ],",
      "121:             [",
      "122:                 '<div",
      "124: randomattribute=\"anything\"   attributewithoutvalue",
      "126:         randomattr=\"random value\">",
      "128: </div>', // nominal case with added spaces and line jumps",
      "129:                 false,",
      "130:                 true",
      "131:             ],",
      "132:             [",
      "133:                 '/form input > embed onerror iframe object', // test plain words with forbidden tag / attributes: should pass",
      "134:                 false,",
      "135:                 true",
      "136:             ],",
      "137:             [",
      "138:                 '<a href=\"#\" onchange=\"evilJavascriptIsCalled()\"></a>', // event attributes are forbidden, should not pass",
      "139:                 false,",
      "140:                 false",
      "141:             ],",
      "142:             [",
      "143:                 '<a href=\"#\" onanything=\"evilJavascriptIsCalled()\"></a>', // random attribute starting with on should not pass",
      "144:                 false,",
      "145:                 false",
      "146:             ],",
      "147:             [",
      "148:                 '<a href=\"#\" oNnotexi=\"evilJavascriptIsCalled()\"></a>', // random attribute starting with on but case insensitive: should not pass",
      "149:                 false,",
      "150:                 false",
      "151:             ],",
      "152:             [",
      "153:                 '<iframe src=\"catvideo.html\" /></iframe>', // iframe forbidden",
      "154:                 false,",
      "155:                 false",
      "156:             ],",
      "157:             [",
      "158:                 '<iframe src=\"catvideo.html\" /></iframe>', // iframe parameter is set to true, should pass",
      "159:                 true,",
      "160:                 true",
      "161:             ],",
      "162:             [",
      "163:                 '<form></form>', // form should not pass,",
      "164:                 false,",
      "165:                 false",
      "166:             ],",
      "167:             [",
      "168:                 '<embed></embed>', // embed should not pass",
      "169:                 false,",
      "170:                 false",
      "171:             ],",
      "172:             [",
      "173:                 '<input>', // input should not pass",
      "174:                 false,",
      "175:                 false",
      "176:             ],",
      "177:             [",
      "178:                 '<script>",
      "180:     </script>', // script tags are forbidden, should not pass (added a random tabulation and line break",
      "181:                 false,",
      "182:                 false",
      "183:             ],",
      "184:             [",
      "185:                 '<object></object>', // objects are forbidden, should not pass",
      "186:                 false,",
      "187:                 false",
      "188:             ],",
      "189:             [",
      "190:                 '<div",
      "191: randomattribute=\"anything\"",
      "193:     onbidule=\"test\" attributewithoutvalue",
      "195:         randomattr=\"random value\">test",
      "197:         </div>', // puting an attribute starting with \"on\" in the middle of other attributes, with spaces and line breaks: shouldn't pass",
      "198:                 false,",
      "199:                 false",
      "200:             ],",
      "201:             [",
      "202:                 '\u202e<img src=x onerror=\"alert(\\'img\\')\">', // test RLO xss attack",
      "203:                 false,",
      "204:                 false",
      "205:             ]",
      "206:         ];",
      "207:     }",
      "",
      "---------------"
    ],
    "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php": [
      "File: tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php -> tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "56:         ;",
      "57:     }",
      "59:     public function testItFailsWhenIframeIsGiven()",
      "60:     {",
      "61:         $htmlTag = '<iframe src=\"catvideo.html\" /></iframe>';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "59:     public function testItFailsWhenAttributeStartingWithOnIsGiven()",
      "60:     {",
      "61:         $htmlTag = '<a href=\"#\" onanything=\"evilJavascriptIsCalled()\"></a>';",
      "63:         $this->validator->validate($htmlTag, new CleanHtml());",
      "65:         $this->buildViolation((new CleanHtml())->message)",
      "66:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
      "67:             ->assertRaised()",
      "68:         ;",
      "69:     }",
      "71:     public function testCaseInsensitiveOnEventAttributeDetection()",
      "72:     {",
      "73:         $htmlTag = '<a href=\"#\" oNnotexi=\"evilJavascriptIsCalled()\"></a>';",
      "75:         $this->validator->validate($htmlTag, new CleanHtml());",
      "77:         $this->buildViolation((new CleanHtml())->message)",
      "78:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
      "79:             ->assertRaised()",
      "80:         ;",
      "81:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "138:         $this->context->getViolations();",
      "139:     }",
      "141:     protected function createValidator()",
      "142:     {",
      "143:         return new CleanHtmlValidator(false);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "165:     public function testItSucceedsWhenRegularAttributeIsGiven()",
      "166:     {",
      "167:         $htmlTag = '<div randomattribute=\"blabla\">test</div>';",
      "168:         $this->validator->validate($htmlTag, new CleanHtml());",
      "170:         $this->assertNoViolation();",
      "171:         $this->context->getViolations();",
      "172:     }",
      "174:     public function testSucceedsWithSpaces()",
      "175:     {",
      "176:         $htmlTag = '<div",
      "178: randomattribute=\"blabla\"   attributewithoutvalue",
      "180:         randomattr=\"random value\">",
      "182: </div>';",
      "183:         $this->validator->validate($htmlTag, new CleanHtml());",
      "185:         $this->assertNoViolation();",
      "186:     }",
      "188:     public function itFailsToHaveOnAttributeWithRandomSpacesAndLines()",
      "189:     {",
      "190:         $htmlTag = '<div",
      "191: randomattribute=\"blabla\"",
      "193:     onbidule=\"test\" attributewithoutvalue",
      "195:         randomattr=\"random value\">test",
      "197:         </div>';",
      "199:         $this->buildViolation((new CleanHtml())->message)",
      "200:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
      "201:             ->assertRaised()",
      "202:         ;",
      "204:         $this->context->getViolations();",
      "205:     }",
      "207:     public function itFailsWithRLOInjection()",
      "208:     {",
      "209:         $htmlTag = '\u202e<img src=x onerror=\"alert(\\'img\\')\">';",
      "211:         $this->buildViolation((new CleanHtml())->message)",
      "212:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
      "213:             ->assertRaised()",
      "214:         ;",
      "216:         $this->context->getViolations();",
      "218:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8bc1bf6cdd877fc77bb4a5af301ad5ea7e1a1920",
      "candidate_info": {
        "commit_hash": "8bc1bf6cdd877fc77bb4a5af301ad5ea7e1a1920",
        "repo": "PrestaShop/PrestaShop",
        "commit_url": "https://github.com/PrestaShop/PrestaShop/commit/8bc1bf6cdd877fc77bb4a5af301ad5ea7e1a1920",
        "files": [
          "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
        ],
        "message": "add tests for event attribute detection",
        "before_after_code_files": [
          "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
          ],
          "candidate": [
            "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php"
          ]
        }
      },
      "candidate_diff": {
        "tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php||tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php": [
          "File: tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php -> tests/Unit/Core/ConstraintValidator/CleanHtmlValidatorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:         ;",
          "57:     }",
          "59:     public function testItFailsWhenIframeIsGiven()",
          "60:     {",
          "61:         $htmlTag = '<iframe src=\"catvideo.html\" /></iframe>';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:     public function testItFailsWhenAttributeStartingWithOnIsGiven()",
          "60:     {",
          "61:         $htmlTag = '<a href=\"#\" onanything=\"evilJavascriptIsCalled()\"></a>';",
          "63:         $this->validator->validate($htmlTag, new CleanHtml());",
          "65:         $this->buildViolation((new CleanHtml())->message)",
          "66:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
          "67:             ->assertRaised()",
          "68:         ;",
          "69:     }",
          "71:     public function testCaseInsensitiveOnEventAttributeDetection()",
          "72:     {",
          "73:         $htmlTag = '<a href=\"#\" oNnotexi=\"evilJavascriptIsCalled()\"></a>';",
          "75:         $this->validator->validate($htmlTag, new CleanHtml());",
          "77:         $this->buildViolation((new CleanHtml())->message)",
          "78:             ->setParameter('%s', '\"' . $htmlTag . '\"')",
          "79:             ->assertRaised()",
          "80:         ;",
          "81:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "138:         $this->context->getViolations();",
          "139:     }",
          "141:     protected function createValidator()",
          "142:     {",
          "143:         return new CleanHtmlValidator(false);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "165:     public function testItSucceedsWhenRegularAttributeIsGiven()",
          "166:     {",
          "167:         $htmlTag = '<div randomattribute=\"blabla\">test</div>';",
          "168:         $this->validator->validate($htmlTag, new CleanHtml());",
          "170:         $this->assertNoViolation();",
          "171:         $this->context->getViolations();",
          "172:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2a67af139930a575b13c10c1df77a71f7f162351",
      "candidate_info": {
        "commit_hash": "2a67af139930a575b13c10c1df77a71f7f162351",
        "repo": "PrestaShop/PrestaShop",
        "commit_url": "https://github.com/PrestaShop/PrestaShop/commit/2a67af139930a575b13c10c1df77a71f7f162351",
        "files": [
          "classes/Validate.php",
          "src/Core/ConstraintValidator/CleanHtmlValidator.php"
        ],
        "message": "add rlo protection",
        "before_after_code_files": [
          "classes/Validate.php||classes/Validate.php",
          "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "classes/Validate.php||classes/Validate.php",
            "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php"
          ],
          "candidate": [
            "classes/Validate.php||classes/Validate.php",
            "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php"
          ]
        }
      },
      "candidate_diff": {
        "classes/Validate.php||classes/Validate.php": [
          "File: classes/Validate.php -> classes/Validate.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:             return false;",
          "539:         }",
          "541:         return true;",
          "542:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "542:         $rloCharacters = \"\\xE2\\x80\\xAE\";",
          "545:         if (strpos($html, $rloCharacters) !== false) {",
          "547:             return false;",
          "548:         }",
          "",
          "---------------"
        ],
        "src/Core/ConstraintValidator/CleanHtmlValidator.php||src/Core/ConstraintValidator/CleanHtmlValidator.php": [
          "File: src/Core/ConstraintValidator/CleanHtmlValidator.php -> src/Core/ConstraintValidator/CleanHtmlValidator.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:         $eventAttributeRegex = '/<\\s*\\w+[^>]*\\s(on\\w+)=[\"\\'][^\"\\']*[\"\\']/ims';",
          "78:             $this->context->buildViolation($constraint->message)",
          "79:                 ->setTranslationDomain('Admin.Notifications.Error')",
          "80:                 ->setParameter('%s', $this->formatValue($value))",
          "",
          "[Removed Lines]",
          "77:         if ($containsScriptTags || $containsJavascriptEvents || $iframe || preg_match($eventAttributeRegex, $value)) {",
          "",
          "[Added Lines]",
          "77:         $rloCharacters = \"\\xE2\\x80\\xAE\";",
          "80:         if (strpos($value, $rloCharacters) !== false) {",
          "82:             return false;",
          "83:         }",
          "85:         if ($containsScriptTags || $containsJavascriptEvents || $iframe || preg_match($eventAttributeRegex, $value) || strpos($value, $rloCharacters) !== false) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}