{
  "cve_id": "CVE-2024-25981",
  "cve_desc": "Separate Groups mode restrictions were not honored when performing a forum export, which would export forum data for all groups. By default this only provided additional access to non-editing teachers.",
  "repo": "moodle/moodle",
  "patch_hash": "1c059cb3fe39da46959e912dc671844dd204e83b",
  "patch_info": {
    "commit_hash": "1c059cb3fe39da46959e912dc671844dd204e83b",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/1c059cb3fe39da46959e912dc671844dd204e83b",
    "files": [
      "enrol/externallib.php",
      "enrol/locallib.php",
      "enrol/tests/course_enrolment_manager_test.php",
      "enrol/tests/externallib_test.php",
      "enrol/upgrade.txt",
      "mod/forum/amd/build/form-user-selector.min.js",
      "mod/forum/amd/build/form-user-selector.min.js.map",
      "mod/forum/amd/src/form-user-selector.js",
      "mod/forum/classes/form/export_form.php",
      "mod/forum/classes/local/vaults/discussion.php",
      "mod/forum/export.php",
      "mod/forum/tests/behat/forum_export.feature"
    ],
    "message": "MDL-80504 forum: Fix seperate group mode",
    "before_after_code_files": [
      "enrol/externallib.php||enrol/externallib.php",
      "enrol/locallib.php||enrol/locallib.php",
      "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
      "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
      "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
      "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
      "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
      "mod/forum/export.php||mod/forum/export.php",
      "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
    ]
  },
  "patch_diff": {
    "enrol/externallib.php||enrol/externallib.php": [
      "File: enrol/externallib.php -> enrol/externallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "629:                 'searchanywhere' => new external_value(PARAM_BOOL, 'find a match anywhere, or only at the beginning'),",
      "630:                 'page' => new external_value(PARAM_INT, 'Page number'),",
      "631:                 'perpage' => new external_value(PARAM_INT, 'Number per page'),",
      "632:             ]",
      "633:         );",
      "634:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "632:                 'contextid' => new external_value(PARAM_INT, 'Context ID', VALUE_DEFAULT, null),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "650:         require_once($CFG->dirroot.'/enrol/locallib.php');",
      "651:         require_once($CFG->dirroot.'/user/lib.php');",
      "",
      "[Removed Lines]",
      "647:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage): array {",
      "648:         global $PAGE, $DB, $CFG;",
      "",
      "[Added Lines]",
      "649:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage, ?int $contextid = null): array {",
      "650:         global $PAGE, $CFG;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "657:                     'search'         => $search,",
      "658:                     'searchanywhere' => $searchanywhere,",
      "659:                     'page'           => $page,",
      "662:         );",
      "664:         try {",
      "665:             self::validate_context($context);",
      "666:         } catch (Exception $e) {",
      "",
      "[Removed Lines]",
      "660:                     'perpage'        => $perpage",
      "661:                 ]",
      "663:         $context = context_course::instance($params['courseid']);",
      "",
      "[Added Lines]",
      "662:                     'perpage'        => $perpage,",
      "663:                     'contextid'      => $contextid,",
      "664:                 ],",
      "666:         if (isset($contextid)) {",
      "667:             $context = context::instance_by_id($params['contextid']);",
      "668:         } else {",
      "669:             $context = context_course::instance($params['courseid']);",
      "670:         }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "674:         $course = get_course($params['courseid']);",
      "675:         $manager = new course_enrolment_manager($PAGE, $course);",
      "682:         $results = [];",
      "",
      "[Removed Lines]",
      "677:         $users = $manager->search_users($params['search'],",
      "678:                                         $params['searchanywhere'],",
      "679:                                         $params['page'],",
      "680:                                         $params['perpage']);",
      "",
      "[Added Lines]",
      "684:         $users = $manager->search_users(",
      "685:             $params['search'],",
      "686:             $params['searchanywhere'],",
      "687:             $params['page'],",
      "688:             $params['perpage'],",
      "689:             false,",
      "690:             $params['contextid']",
      "691:         );",
      "",
      "---------------"
    ],
    "enrol/locallib.php||enrol/locallib.php": [
      "File: enrol/locallib.php -> enrol/locallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "571:     public function search_users(string $search = '', bool $searchanywhere = false, int $page = 0, int $perpage = 25,",
      "573:         global $USER;",
      "575:         [$ufields, $joins, $params, $wherecondition] = $this->get_basic_search_conditions($search, $searchanywhere);",
      "579:             $groups = groups_get_all_groups($this->course->id, $USER->id, 0, 'g.id');",
      "580:             $groupids = array_column($groups, 'id');",
      "581:         } else {",
      "582:             $groupids = [];",
      "583:         }",
      "587:         $fields      = 'SELECT ' . $ufields;",
      "588:         $countfields = 'SELECT COUNT(u.id)';",
      "",
      "[Removed Lines]",
      "572:             bool $returnexactcount = false) {",
      "577:         $groupmode = groups_get_course_groupmode($this->course);",
      "578:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $this->context)) {",
      "585:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($this->context, '', $groupids);",
      "",
      "[Added Lines]",
      "573:             bool $returnexactcount = false, ?int $contextid = null) {",
      "578:         if (isset($contextid)) {",
      "580:             [$context, $course, $cm] = get_context_info_array($contextid);",
      "582:             $groupmode = $cm ? groups_get_activity_groupmode($cm, $course) : groups_get_course_groupmode($this->course);",
      "583:         } else {",
      "585:             $context = $this->context;",
      "586:             $groupmode = groups_get_course_groupmode($this->course);",
      "587:         }",
      "589:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $context)) {",
      "592:             if (!$groupids) {",
      "593:                 return ['totalusers' => 0, 'users' => [], 'moreusers' => false];",
      "594:             }",
      "599:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($context, '', $groupids);",
      "",
      "---------------"
    ],
    "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php": [
      "File: enrol/tests/course_enrolment_manager_test.php -> enrol/tests/course_enrolment_manager_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: use context_course;",
      "20: use course_enrolment_manager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "21: use stdClass;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "558:         $this->resetAfterTest();",
      "560:         $teacher = $this->getDataGenerator()->create_and_enrol($this->course, 'teacher');",
      "561:         $this->getDataGenerator()->create_group_member(['groupid' => $this->groups['group1']->id, 'userid' => $teacher->id]);",
      "562:         $this->setUser($teacher);",
      "565:         $this->assertEqualsCanonicalizing([",
      "566:             $teacher->username,",
      "567:             $this->users['user0']->username,",
      "",
      "[Removed Lines]",
      "564:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "",
      "[Added Lines]",
      "562:         $record = new stdClass();",
      "563:         $record->introformat = FORMAT_HTML;",
      "564:         $record->course = $this->course->id;",
      "565:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
      "566:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
      "572:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "570:             $this->users['user22']->username,",
      "571:             $this->users['userall']->username,",
      "572:             $this->users['usertch']->username,",
      "577:         $this->course->groupmode = SEPARATEGROUPS;",
      "578:         update_course($this->course);",
      "581:         $this->assertEqualsCanonicalizing([",
      "582:             $teacher->username,",
      "583:             $this->users['user1']->username,",
      "584:             $this->users['userall']->username,",
      "589:         $roleid = $DB->get_field('role', 'id', ['shortname' => 'teacher']);",
      "590:         assign_capability('moodle/site:accessallgroups', CAP_ALLOW, $roleid, context_course::instance($this->course->id)->id);",
      "593:         $this->assertEqualsCanonicalizing([",
      "594:             $teacher->username,",
      "595:             $this->users['user0']->username,",
      "",
      "[Removed Lines]",
      "573:         ], array_column($users['users'], 'username'));",
      "574:         $this->assertEquals(7, $users['totalusers']);",
      "580:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "585:         ], array_column($users['users'], 'username'));",
      "586:         $this->assertEquals(3, $users['totalusers']);",
      "592:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "",
      "[Added Lines]",
      "581:         ], array_column($courseusers['users'], 'username'));",
      "582:         $this->assertEquals(7, $courseusers['totalusers']);",
      "584:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
      "585:         $this->assertEqualsCanonicalizing([",
      "586:             $teacher->username,",
      "587:             $this->users['user1']->username,",
      "588:             $this->users['userall']->username,",
      "589:         ], array_column($forumusers['users'], 'username'));",
      "590:         $this->assertEquals(3, $forumusers['totalusers']);",
      "595:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
      "597:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "602:         ], array_column($courseusers['users'], 'username'));",
      "603:         $this->assertEquals(3, $courseusers['totalusers']);",
      "605:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
      "606:         $this->assertEqualsCanonicalizing([",
      "607:             $teacher->username,",
      "608:             $this->users['user0']->username,",
      "609:             $this->users['user1']->username,",
      "610:             $this->users['user21']->username,",
      "611:             $this->users['user22']->username,",
      "612:             $this->users['userall']->username,",
      "613:             $this->users['usertch']->username,",
      "614:         ], array_column($forumusers['users'], 'username'));",
      "615:         $this->assertEquals(7, $forumusers['totalusers']);",
      "617:         set_coursemodule_groupmode($forum->cmid, SEPARATEGROUPS);",
      "623:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
      "624:         $this->assertEqualsCanonicalizing([",
      "625:             $teacher->username,",
      "626:             $this->users['user0']->username,",
      "627:             $this->users['user1']->username,",
      "628:             $this->users['user21']->username,",
      "629:             $this->users['user22']->username,",
      "630:             $this->users['userall']->username,",
      "631:             $this->users['usertch']->username,",
      "632:         ], array_column($courseusers['users'], 'username'));",
      "633:         $this->assertEquals(7, $courseusers['totalusers']);",
      "635:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "598:             $this->users['user22']->username,",
      "599:             $this->users['userall']->username,",
      "600:             $this->users['usertch']->username,",
      "603:     }",
      "604: }",
      "",
      "[Removed Lines]",
      "601:         ], array_column($users['users'], 'username'));",
      "602:         $this->assertEquals(7, $users['totalusers']);",
      "",
      "[Added Lines]",
      "644:         ], array_column($forumusers['users'], 'username'));",
      "645:         $this->assertEquals(7, $forumusers['totalusers']);",
      "",
      "---------------"
    ],
    "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php": [
      "File: enrol/tests/externallib_test.php -> enrol/tests/externallib_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: use core_external\\external_api;",
      "21: use enrol_user_enrolment_form;",
      "22: use externallib_advanced_testcase;",
      "24: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "23: use stdClass;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1421:         $this->assertCount(0, $result);",
      "1422:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1429:     public function test_search_users_groupmode() {",
      "1430:         global $DB;",
      "1432:         $this->resetAfterTest();",
      "1433:         $datagen = $this->getDataGenerator();",
      "1435:         $studentroleid = $DB->get_field('role', 'id', ['shortname' => 'student'], MUST_EXIST);",
      "1436:         $teacherroleid = $DB->get_field('role', 'id', ['shortname' => 'teacher'], MUST_EXIST);",
      "1438:         $course = $datagen->create_course();",
      "1440:         $student1 = $datagen->create_and_enrol($course);",
      "1441:         $student2 = $datagen->create_and_enrol($course);",
      "1442:         $student3 = $datagen->create_and_enrol($course);",
      "1443:         $teacher1 = $datagen->create_and_enrol($course, 'teacher');",
      "1444:         $teacher2 = $datagen->create_and_enrol($course, 'teacher');",
      "1445:         $teacher3 = $datagen->create_and_enrol($course, 'teacher');",
      "1446:         $teacher4 = $datagen->create_and_enrol($course, 'editingteacher');",
      "1449:         $group1 = $datagen->create_group(['courseid' => $course->id]);",
      "1450:         $group2 = $datagen->create_group(['courseid' => $course->id]);",
      "1453:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $student1->id]);",
      "1454:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student2->id]);",
      "1455:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student3->id]);",
      "1456:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher1->id]);",
      "1457:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $teacher1->id]);",
      "1458:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher2->id]);",
      "1461:         $record = new stdClass();",
      "1462:         $record->introformat = FORMAT_HTML;",
      "1463:         $record->course = $course->id;",
      "1464:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
      "1465:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
      "1467:         $this->setUser($teacher1);",
      "1468:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
      "1469:         $this->assertCount(5, $result);",
      "1471:         $this->setUser($teacher2);",
      "1472:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
      "1473:         $this->assertCount(3, $result);",
      "1475:         $this->setUser($teacher3);",
      "1476:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
      "1477:         $this->assertCount(0, $result);",
      "1479:         $this->setUser($teacher4);",
      "1480:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
      "1481:         $this->assertCount(7, $result);",
      "1484:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
      "1485:         $this->setUser($teacher1);",
      "1486:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
      "1487:         $this->assertCount(7, $result);",
      "1488:     }",
      "",
      "---------------"
    ],
    "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js": [
      "File: mod/forum/amd/src/form-user-selector.js -> mod/forum/amd/src/form-user-selector.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "37:         transport: function(selector, query, success, failure) {",
      "38:             var promise;",
      "39:             var courseid = $(selector).attr('courseid');",
      "41:             promise = Ajax.call([{",
      "42:                 methodname: 'core_enrol_search_users',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "40:             var contextid = $(selector).attr('data-contextid');",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "45:                     search: query,",
      "46:                     searchanywhere: true,",
      "47:                     page: 0,",
      "49:                 }",
      "50:             }]);",
      "",
      "[Removed Lines]",
      "48:                     perpage: 30",
      "",
      "[Added Lines]",
      "49:                     perpage: 30,",
      "50:                     contextid: contextid,",
      "",
      "---------------"
    ],
    "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php": [
      "File: mod/forum/classes/form/export_form.php -> mod/forum/classes/form/export_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "53:             'ajax' => 'mod_forum/form-user-selector',",
      "54:             'multiple' => true,",
      "55:             'noselectionstring' => get_string('allusers', 'mod_forum'),",
      "56:             'courseid' => $forum->get_course_id(),",
      "57:                 'valuehtmlcallback' => function($value) {",
      "58:                     global $OUTPUT;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "56:             'data-contextid' => $forum->get_context()->id,",
      "",
      "---------------"
    ],
    "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php": [
      "File: mod/forum/classes/local/vaults/discussion.php -> mod/forum/classes/local/vaults/discussion.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: defined('MOODLE_INTERNAL') || die();",
      "29: use mod_forum\\local\\entities\\forum as forum_entity;",
      "30: use mod_forum\\local\\entities\\discussion as discussion_entity;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29: use mod_forum\\local\\container;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "95:     public function get_all_discussions_in_forum(forum_entity $forum, string $sort = null): ?array {",
      "100:         return $this->transform_db_records_to_entities($records);",
      "101:     }",
      "",
      "[Removed Lines]",
      "96:         $records = $this->get_db()->get_records(self::TABLE, [",
      "97:             'forum' => $forum->get_id(),",
      "98:         ], $sort ?? '');",
      "",
      "[Added Lines]",
      "97:         global $USER;",
      "98:         $options = ['forum' => $forum->get_id()];",
      "100:         $managerfactory = container::get_manager_factory();",
      "101:         $capabilitymanager = $managerfactory->get_capability_manager($forum);",
      "103:         $select = \"forum = :forum\";",
      "105:         if ($forum->is_in_group_mode() && !$capabilitymanager->can_access_all_groups($USER)) {",
      "106:             $allowedgroups = groups_get_activity_allowed_groups($forum->get_course_module_record());",
      "107:             $allowedgroups = implode(\",\", array_keys($allowedgroups));",
      "108:             if (!$allowedgroups) {",
      "109:                 return [];",
      "110:             }",
      "111:             $select .= \" AND groupid IN ($allowedgroups)\";",
      "112:         }",
      "113:         $records = $this->get_db()->get_records_select(self::TABLE, $select, $options, $sort ?? '');",
      "",
      "---------------"
    ],
    "mod/forum/export.php||mod/forum/export.php": [
      "File: mod/forum/export.php -> mod/forum/export.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "194: $userids = array_filter($userids, static function(int $userid) use ($course, $cm): bool {",
      "197: });",
      "198: $form->set_data(['useridsselected' => $userids, 'discussionids' => $discussionids, 'from' => $from, 'to' => $to]);",
      "",
      "[Removed Lines]",
      "195:     $user = core_user::get_user($userid, '*', MUST_EXIST);",
      "196:     return $cm->effectivegroupmode != SEPARATEGROUPS || user_can_view_profile($user, $course);",
      "",
      "[Added Lines]",
      "195:     return $cm->effectivegroupmode != SEPARATEGROUPS || groups_user_groups_visible($course, $userid, $cm);",
      "",
      "---------------"
    ],
    "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature": [
      "File: mod/forum/tests/behat/forum_export.feature -> mod/forum/tests/behat/forum_export.feature",
      "--- Hunk 1 ---",
      "[Context before]",
      "48:     # This will fail if an exception is thrown. This is the best we can do without the ability to use the download. Hence, there is no \"Then\" step.",
      "49:     And I click on \"Export\" \"button\"",
      "50:     And I log out",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "52:   Scenario: Group mode is respected when exporting discussions",
      "53:     Given the following \"groups\" exist:",
      "54:       | name | course | idnumber |",
      "55:       | G1   | C1     | G1       |",
      "56:       | G2   | C1     | G2       |",
      "57:     And the following \"users\" exist:",
      "58:       | username | firstname | lastname | email |",
      "59:       | teachera | Teacher   | A | teacherA@example.com |",
      "60:       | teacherb | Teacher   | B | teacherB@example.com |",
      "61:       | teacherc | Teacher   | C | teacherC@example.com |",
      "62:       | teacherd | Teacher   | D | teacherD@example.com |",
      "63:     And the following \"course enrolments\" exist:",
      "64:       | user     | course | role           |",
      "65:       | teachera | C1     | teacher        |",
      "66:       | teacherb | C1     | teacher        |",
      "67:       | teacherc | C1     | teacher        |",
      "68:       | teacherd | C1     | teacher        |",
      "69:     And the following \"group members\" exist:",
      "70:       | user        | group |",
      "71:       | teachera    | G1  |",
      "72:       | teachera    | G2  |",
      "73:       | teacherb    | G1  |",
      "74:       | teacherc    | G2  |",
      "75:     And the following \"activities\" exist:",
      "76:       | activity | course | idnumber | name                    | intro                      | type    | section | groupmode |",
      "77:       | forum    | C1     | 00001    | Separate groups forum   | Standard forum description | general | 1       | 1         |",
      "78:     And the following \"mod_forum > discussions\" exist:",
      "79:       | user     | forum                 | name                 | message           | group |",
      "80:       | teachera | Separate groups forum | Discussion 1 Group 1 | Test post message | G1    |",
      "81:       | teacherb | Separate groups forum | Discussion 2 Group 1 | Test post message | G1    |",
      "82:       | teachera | Separate groups forum | Discussion 1 Group 2 | Test post message | G2    |",
      "83:       | teacherc | Separate groups forum | Discussion 2 Group 2 | Test post message | G2    |",
      "84:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacher1",
      "85:     And I navigate to \"Export\" in current page administration",
      "86:     When I expand the \"Users\" autocomplete",
      "87:     # Editing teacher can see all users and discussions.",
      "88:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
      "89:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
      "90:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
      "91:     And I should see \"Teacher D\" in the \"Users\" \"autocomplete\"",
      "92:     And I should see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
      "93:     And I should see \"Student 1\" in the \"Users\" \"autocomplete\"",
      "94:     And I press the escape key",
      "95:     And I expand the \"Discussions\" autocomplete",
      "96:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "97:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "98:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "99:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "100:     And I click on \"Export\" \"button\"",
      "102:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teachera",
      "103:     And I navigate to \"Export\" in current page administration",
      "104:     When I expand the \"Users\" autocomplete",
      "105:     # Teacher A is is in both groups.",
      "106:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
      "107:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
      "108:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
      "109:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
      "110:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
      "111:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
      "112:     And I press the escape key",
      "113:     And I expand the \"Discussions\" autocomplete",
      "114:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "115:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "116:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "117:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "118:     And I click on \"Export\" \"button\"",
      "120:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherb",
      "121:     And I navigate to \"Export\" in current page administration",
      "122:     When I expand the \"Users\" autocomplete",
      "123:     # Teacher B is in group 1.",
      "124:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
      "125:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
      "126:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
      "127:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
      "128:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
      "129:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
      "130:     And I press the escape key",
      "131:     And I expand the \"Discussions\" autocomplete",
      "132:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "133:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "134:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "135:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "136:     And I click on \"Export\" \"button\"",
      "138:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherc",
      "139:     And I navigate to \"Export\" in current page administration",
      "140:     When I expand the \"Users\" autocomplete",
      "141:     # Teacher C is in group 2.",
      "142:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
      "143:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
      "144:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
      "145:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
      "146:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
      "147:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
      "148:     And I press the escape key",
      "149:     And I expand the \"Discussions\" autocomplete",
      "150:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "151:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "152:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "153:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "154:     And I click on \"Export\" \"button\"",
      "156:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherd",
      "157:     And I navigate to \"Export\" in current page administration",
      "158:     When I expand the \"Users\" autocomplete",
      "159:     # Teacher D is in no group.",
      "160:     Then I should not see \"Teacher A\" in the \"Users\" \"autocomplete\"",
      "161:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
      "162:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
      "163:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
      "164:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
      "165:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
      "166:     And I press the escape key",
      "167:     And I expand the \"Discussions\" autocomplete",
      "168:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "169:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
      "170:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "171:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
      "172:     And I click on \"Export\" \"button\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2bb6c551cf2e7be29857db35388911b8179394b0",
      "candidate_info": {
        "commit_hash": "2bb6c551cf2e7be29857db35388911b8179394b0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/2bb6c551cf2e7be29857db35388911b8179394b0",
        "files": [
          "enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php"
        ],
        "message": "MDL-79310 enrol: restrict searched users to those user can view.",
        "before_after_code_files": [
          "enrol/locallib.php||enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php"
          ],
          "candidate": [
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php"
          ]
        }
      },
      "candidate_diff": {
        "enrol/locallib.php||enrol/locallib.php": [
          "File: enrol/locallib.php -> enrol/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:     public function search_users(string $search = '', bool $searchanywhere = false, int $page = 0, int $perpage = 25,",
          "572:             bool $returnexactcount = false) {",
          "573:         [$ufields, $joins, $params, $wherecondition] = $this->get_basic_search_conditions($search, $searchanywhere);",
          "575:         $fields      = 'SELECT ' . $ufields;",
          "576:         $countfields = 'SELECT COUNT(u.id)';",
          "577:         $sql = \" FROM {user} u",
          "578:                       $joins",
          "585:         return $this->execute_search_queries($search, $fields, $countfields, $sql, $params, $page, $perpage, 0, $returnexactcount);",
          "586:     }",
          "",
          "[Removed Lines]",
          "579:                  JOIN {user_enrolments} ue ON ue.userid = u.id",
          "580:                  JOIN {enrol} e ON ue.enrolid = e.id",
          "581:                 WHERE $wherecondition",
          "582:                   AND e.courseid = :courseid\";",
          "583:         $params['courseid'] = $this->course->id;",
          "",
          "[Added Lines]",
          "573:         global $USER;",
          "577:         $groupmode = groups_get_course_groupmode($this->course);",
          "578:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $this->context)) {",
          "579:             $groups = groups_get_all_groups($this->course->id, $USER->id, 0, 'g.id');",
          "580:             $groupids = array_column($groups, 'id');",
          "581:         } else {",
          "582:             $groupids = [];",
          "583:         }",
          "585:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($this->context, '', $groupids);",
          "591:                  JOIN ($enrolledsql) je ON je.id = u.id",
          "592:                 WHERE $wherecondition\";",
          "594:         $params = array_merge($params, $enrolledparams);",
          "",
          "---------------"
        ],
        "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php": [
          "File: enrol/tests/course_enrolment_manager_test.php -> enrol/tests/course_enrolment_manager_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: namespace core_enrol;",
          "19: use course_enrolment_manager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: use context_course;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "546:             $this->assertArrayNotHasKey('totalusers', $users);",
          "547:         }",
          "548:     }",
          "549: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "555:     public function test_search_users_course_groupmode(): void {",
          "556:         global $DB, $PAGE;",
          "558:         $this->resetAfterTest();",
          "560:         $teacher = $this->getDataGenerator()->create_and_enrol($this->course, 'teacher');",
          "561:         $this->getDataGenerator()->create_group_member(['groupid' => $this->groups['group1']->id, 'userid' => $teacher->id]);",
          "562:         $this->setUser($teacher);",
          "564:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "565:         $this->assertEqualsCanonicalizing([",
          "566:             $teacher->username,",
          "567:             $this->users['user0']->username,",
          "568:             $this->users['user1']->username,",
          "569:             $this->users['user21']->username,",
          "570:             $this->users['user22']->username,",
          "571:             $this->users['userall']->username,",
          "572:             $this->users['usertch']->username,",
          "573:         ], array_column($users['users'], 'username'));",
          "574:         $this->assertEquals(7, $users['totalusers']);",
          "577:         $this->course->groupmode = SEPARATEGROUPS;",
          "578:         update_course($this->course);",
          "580:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "581:         $this->assertEqualsCanonicalizing([",
          "582:             $teacher->username,",
          "583:             $this->users['user1']->username,",
          "584:             $this->users['userall']->username,",
          "585:         ], array_column($users['users'], 'username'));",
          "586:         $this->assertEquals(3, $users['totalusers']);",
          "589:         $roleid = $DB->get_field('role', 'id', ['shortname' => 'teacher']);",
          "590:         assign_capability('moodle/site:accessallgroups', CAP_ALLOW, $roleid, context_course::instance($this->course->id)->id);",
          "592:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "593:         $this->assertEqualsCanonicalizing([",
          "594:             $teacher->username,",
          "595:             $this->users['user0']->username,",
          "596:             $this->users['user1']->username,",
          "597:             $this->users['user21']->username,",
          "598:             $this->users['user22']->username,",
          "599:             $this->users['userall']->username,",
          "600:             $this->users['usertch']->username,",
          "601:         ], array_column($users['users'], 'username'));",
          "602:         $this->assertEquals(7, $users['totalusers']);",
          "603:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6de45d2c9f7dd7b24210ab0310c296366a82986a",
      "candidate_info": {
        "commit_hash": "6de45d2c9f7dd7b24210ab0310c296366a82986a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6de45d2c9f7dd7b24210ab0310c296366a82986a",
        "files": [
          "mod/forum/export.php"
        ],
        "message": "MDL-79310 mod_forum: ensure only visible users can be exported.",
        "before_after_code_files": [
          "mod/forum/export.php||mod/forum/export.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/export.php||mod/forum/export.php"
          ],
          "candidate": [
            "mod/forum/export.php||mod/forum/export.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/export.php||mod/forum/export.php": [
          "File: mod/forum/export.php -> mod/forum/export.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "190: }",
          "193: $form->set_data(['useridsselected' => $userids, 'discussionids' => $discussionids, 'from' => $from, 'to' => $to]);",
          "195: $form->display();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "193: $userids = array_filter($userids, static function(int $userid) use ($course, $cm): bool {",
          "194:     $user = core_user::get_user($userid, '*', MUST_EXIST);",
          "195:     return $cm->effectivegroupmode != SEPARATEGROUPS || user_can_view_profile($user, $course);",
          "196: });",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4e3c61ba0e43c7612af73381d0426d6cc6ae2cb4",
      "candidate_info": {
        "commit_hash": "4e3c61ba0e43c7612af73381d0426d6cc6ae2cb4",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4e3c61ba0e43c7612af73381d0426d6cc6ae2cb4",
        "files": [
          "enrol/externallib.php",
          "enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php",
          "enrol/upgrade.txt",
          "mod/forum/amd/build/form-user-selector.min.js",
          "mod/forum/amd/build/form-user-selector.min.js.map",
          "mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature"
        ],
        "message": "MDL-80504 forum: Fix seperate group mode",
        "before_after_code_files": [
          "enrol/externallib.php||enrol/externallib.php",
          "enrol/locallib.php||enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
          "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php||mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ],
          "candidate": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ]
        }
      },
      "candidate_diff": {
        "enrol/externallib.php||enrol/externallib.php": [
          "File: enrol/externallib.php -> enrol/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "629:                 'searchanywhere' => new external_value(PARAM_BOOL, 'find a match anywhere, or only at the beginning'),",
          "630:                 'page' => new external_value(PARAM_INT, 'Page number'),",
          "631:                 'perpage' => new external_value(PARAM_INT, 'Number per page'),",
          "632:             ]",
          "633:         );",
          "634:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "632:                 'contextid' => new external_value(PARAM_INT, 'Context ID', VALUE_DEFAULT, null),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "650:         require_once($CFG->dirroot.'/enrol/locallib.php');",
          "651:         require_once($CFG->dirroot.'/user/lib.php');",
          "",
          "[Removed Lines]",
          "647:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage): array {",
          "648:         global $PAGE, $DB, $CFG;",
          "",
          "[Added Lines]",
          "649:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage, ?int $contextid = null): array {",
          "650:         global $PAGE, $CFG;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "657:                     'search'         => $search,",
          "658:                     'searchanywhere' => $searchanywhere,",
          "659:                     'page'           => $page,",
          "662:         );",
          "664:         try {",
          "665:             self::validate_context($context);",
          "666:         } catch (Exception $e) {",
          "",
          "[Removed Lines]",
          "660:                     'perpage'        => $perpage",
          "661:                 ]",
          "663:         $context = context_course::instance($params['courseid']);",
          "",
          "[Added Lines]",
          "662:                     'perpage'        => $perpage,",
          "663:                     'contextid'      => $contextid,",
          "664:                 ],",
          "666:         if (isset($contextid)) {",
          "667:             $context = context::instance_by_id($params['contextid']);",
          "668:         } else {",
          "669:             $context = context_course::instance($params['courseid']);",
          "670:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "674:         $course = get_course($params['courseid']);",
          "675:         $manager = new course_enrolment_manager($PAGE, $course);",
          "682:         $results = [];",
          "",
          "[Removed Lines]",
          "677:         $users = $manager->search_users($params['search'],",
          "678:                                         $params['searchanywhere'],",
          "679:                                         $params['page'],",
          "680:                                         $params['perpage']);",
          "",
          "[Added Lines]",
          "684:         $users = $manager->search_users(",
          "685:             $params['search'],",
          "686:             $params['searchanywhere'],",
          "687:             $params['page'],",
          "688:             $params['perpage'],",
          "689:             false,",
          "690:             $params['contextid']",
          "691:         );",
          "",
          "---------------"
        ],
        "enrol/locallib.php||enrol/locallib.php": [
          "File: enrol/locallib.php -> enrol/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:     public function search_users(string $search = '', bool $searchanywhere = false, int $page = 0, int $perpage = 25,",
          "573:         global $USER;",
          "575:         [$ufields, $joins, $params, $wherecondition] = $this->get_basic_search_conditions($search, $searchanywhere);",
          "579:             $groups = groups_get_all_groups($this->course->id, $USER->id, 0, 'g.id');",
          "580:             $groupids = array_column($groups, 'id');",
          "581:         } else {",
          "582:             $groupids = [];",
          "583:         }",
          "587:         $fields      = 'SELECT ' . $ufields;",
          "588:         $countfields = 'SELECT COUNT(u.id)';",
          "",
          "[Removed Lines]",
          "572:             bool $returnexactcount = false) {",
          "577:         $groupmode = groups_get_course_groupmode($this->course);",
          "578:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $this->context)) {",
          "585:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($this->context, '', $groupids);",
          "",
          "[Added Lines]",
          "573:             bool $returnexactcount = false, ?int $contextid = null) {",
          "578:         if (isset($contextid)) {",
          "580:             [$context, $course, $cm] = get_context_info_array($contextid);",
          "582:             $groupmode = $cm ? groups_get_activity_groupmode($cm, $course) : groups_get_course_groupmode($this->course);",
          "583:         } else {",
          "585:             $context = $this->context;",
          "586:             $groupmode = groups_get_course_groupmode($this->course);",
          "587:         }",
          "589:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $context)) {",
          "592:             if (!$groupids) {",
          "593:                 return ['totalusers' => 0, 'users' => [], 'moreusers' => false];",
          "594:             }",
          "599:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($context, '', $groupids);",
          "",
          "---------------"
        ],
        "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php": [
          "File: enrol/tests/course_enrolment_manager_test.php -> enrol/tests/course_enrolment_manager_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use context_course;",
          "20: use course_enrolment_manager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "558:         $this->resetAfterTest();",
          "560:         $teacher = $this->getDataGenerator()->create_and_enrol($this->course, 'teacher');",
          "561:         $this->getDataGenerator()->create_group_member(['groupid' => $this->groups['group1']->id, 'userid' => $teacher->id]);",
          "562:         $this->setUser($teacher);",
          "565:         $this->assertEqualsCanonicalizing([",
          "566:             $teacher->username,",
          "567:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "564:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "562:         $record = new stdClass();",
          "563:         $record->introformat = FORMAT_HTML;",
          "564:         $record->course = $this->course->id;",
          "565:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "566:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "572:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "570:             $this->users['user22']->username,",
          "571:             $this->users['userall']->username,",
          "572:             $this->users['usertch']->username,",
          "577:         $this->course->groupmode = SEPARATEGROUPS;",
          "578:         update_course($this->course);",
          "581:         $this->assertEqualsCanonicalizing([",
          "582:             $teacher->username,",
          "583:             $this->users['user1']->username,",
          "584:             $this->users['userall']->username,",
          "589:         $roleid = $DB->get_field('role', 'id', ['shortname' => 'teacher']);",
          "590:         assign_capability('moodle/site:accessallgroups', CAP_ALLOW, $roleid, context_course::instance($this->course->id)->id);",
          "593:         $this->assertEqualsCanonicalizing([",
          "594:             $teacher->username,",
          "595:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "573:         ], array_column($users['users'], 'username'));",
          "574:         $this->assertEquals(7, $users['totalusers']);",
          "580:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "585:         ], array_column($users['users'], 'username'));",
          "586:         $this->assertEquals(3, $users['totalusers']);",
          "592:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "581:         ], array_column($courseusers['users'], 'username'));",
          "582:         $this->assertEquals(7, $courseusers['totalusers']);",
          "584:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "585:         $this->assertEqualsCanonicalizing([",
          "586:             $teacher->username,",
          "587:             $this->users['user1']->username,",
          "588:             $this->users['userall']->username,",
          "589:         ], array_column($forumusers['users'], 'username'));",
          "590:         $this->assertEquals(3, $forumusers['totalusers']);",
          "595:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "597:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "602:         ], array_column($courseusers['users'], 'username'));",
          "603:         $this->assertEquals(3, $courseusers['totalusers']);",
          "605:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "606:         $this->assertEqualsCanonicalizing([",
          "607:             $teacher->username,",
          "608:             $this->users['user0']->username,",
          "609:             $this->users['user1']->username,",
          "610:             $this->users['user21']->username,",
          "611:             $this->users['user22']->username,",
          "612:             $this->users['userall']->username,",
          "613:             $this->users['usertch']->username,",
          "614:         ], array_column($forumusers['users'], 'username'));",
          "615:         $this->assertEquals(7, $forumusers['totalusers']);",
          "617:         set_coursemodule_groupmode($forum->cmid, SEPARATEGROUPS);",
          "623:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "624:         $this->assertEqualsCanonicalizing([",
          "625:             $teacher->username,",
          "626:             $this->users['user0']->username,",
          "627:             $this->users['user1']->username,",
          "628:             $this->users['user21']->username,",
          "629:             $this->users['user22']->username,",
          "630:             $this->users['userall']->username,",
          "631:             $this->users['usertch']->username,",
          "632:         ], array_column($courseusers['users'], 'username'));",
          "633:         $this->assertEquals(7, $courseusers['totalusers']);",
          "635:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "598:             $this->users['user22']->username,",
          "599:             $this->users['userall']->username,",
          "600:             $this->users['usertch']->username,",
          "603:     }",
          "604: }",
          "",
          "[Removed Lines]",
          "601:         ], array_column($users['users'], 'username'));",
          "602:         $this->assertEquals(7, $users['totalusers']);",
          "",
          "[Added Lines]",
          "644:         ], array_column($forumusers['users'], 'username'));",
          "645:         $this->assertEquals(7, $forumusers['totalusers']);",
          "",
          "---------------"
        ],
        "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php": [
          "File: enrol/tests/externallib_test.php -> enrol/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: use core_external\\external_api;",
          "21: use enrol_user_enrolment_form;",
          "22: use externallib_advanced_testcase;",
          "24: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1421:         $this->assertCount(0, $result);",
          "1422:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1429:     public function test_search_users_groupmode() {",
          "1430:         global $DB;",
          "1432:         $this->resetAfterTest();",
          "1433:         $datagen = $this->getDataGenerator();",
          "1435:         $studentroleid = $DB->get_field('role', 'id', ['shortname' => 'student'], MUST_EXIST);",
          "1436:         $teacherroleid = $DB->get_field('role', 'id', ['shortname' => 'teacher'], MUST_EXIST);",
          "1438:         $course = $datagen->create_course();",
          "1440:         $student1 = $datagen->create_and_enrol($course);",
          "1441:         $student2 = $datagen->create_and_enrol($course);",
          "1442:         $student3 = $datagen->create_and_enrol($course);",
          "1443:         $teacher1 = $datagen->create_and_enrol($course, 'teacher');",
          "1444:         $teacher2 = $datagen->create_and_enrol($course, 'teacher');",
          "1445:         $teacher3 = $datagen->create_and_enrol($course, 'teacher');",
          "1446:         $teacher4 = $datagen->create_and_enrol($course, 'editingteacher');",
          "1449:         $group1 = $datagen->create_group(['courseid' => $course->id]);",
          "1450:         $group2 = $datagen->create_group(['courseid' => $course->id]);",
          "1453:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $student1->id]);",
          "1454:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student2->id]);",
          "1455:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student3->id]);",
          "1456:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher1->id]);",
          "1457:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $teacher1->id]);",
          "1458:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher2->id]);",
          "1461:         $record = new stdClass();",
          "1462:         $record->introformat = FORMAT_HTML;",
          "1463:         $record->course = $course->id;",
          "1464:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "1465:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "1467:         $this->setUser($teacher1);",
          "1468:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1469:         $this->assertCount(5, $result);",
          "1471:         $this->setUser($teacher2);",
          "1472:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1473:         $this->assertCount(3, $result);",
          "1475:         $this->setUser($teacher3);",
          "1476:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1477:         $this->assertCount(0, $result);",
          "1479:         $this->setUser($teacher4);",
          "1480:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1481:         $this->assertCount(7, $result);",
          "1484:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "1485:         $this->setUser($teacher1);",
          "1486:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1487:         $this->assertCount(7, $result);",
          "1488:     }",
          "",
          "---------------"
        ],
        "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js": [
          "File: mod/forum/amd/src/form-user-selector.js -> mod/forum/amd/src/form-user-selector.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         transport: function(selector, query, success, failure) {",
          "38:             var promise;",
          "39:             var courseid = $(selector).attr('courseid');",
          "41:             promise = Ajax.call([{",
          "42:                 methodname: 'core_enrol_search_users',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:             var contextid = $(selector).attr('data-contextid');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45:                     search: query,",
          "46:                     searchanywhere: true,",
          "47:                     page: 0,",
          "49:                 }",
          "50:             }]);",
          "",
          "[Removed Lines]",
          "48:                     perpage: 30",
          "",
          "[Added Lines]",
          "49:                     perpage: 30,",
          "50:                     contextid: contextid,",
          "",
          "---------------"
        ],
        "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php": [
          "File: mod/forum/classes/form/export_form.php -> mod/forum/classes/form/export_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:             'ajax' => 'mod_forum/form-user-selector',",
          "54:             'multiple' => true,",
          "55:             'noselectionstring' => get_string('allusers', 'mod_forum'),",
          "56:             'courseid' => $forum->get_course_id(),",
          "57:                 'valuehtmlcallback' => function($value) {",
          "58:                     global $OUTPUT;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56:             'data-contextid' => $forum->get_context()->id,",
          "",
          "---------------"
        ],
        "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php": [
          "File: mod/forum/classes/local/vaults/discussion.php -> mod/forum/classes/local/vaults/discussion.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use mod_forum\\local\\entities\\forum as forum_entity;",
          "30: use mod_forum\\local\\entities\\discussion as discussion_entity;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: use mod_forum\\local\\container;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:     public function get_all_discussions_in_forum(forum_entity $forum, string $sort = null): ?array {",
          "100:         return $this->transform_db_records_to_entities($records);",
          "101:     }",
          "",
          "[Removed Lines]",
          "96:         $records = $this->get_db()->get_records(self::TABLE, [",
          "97:             'forum' => $forum->get_id(),",
          "98:         ], $sort ?? '');",
          "",
          "[Added Lines]",
          "97:         global $USER;",
          "98:         $options = ['forum' => $forum->get_id()];",
          "100:         $managerfactory = container::get_manager_factory();",
          "101:         $capabilitymanager = $managerfactory->get_capability_manager($forum);",
          "103:         $select = \"forum = :forum\";",
          "105:         if ($forum->is_in_group_mode() && !$capabilitymanager->can_access_all_groups($USER)) {",
          "106:             $allowedgroups = groups_get_activity_allowed_groups($forum->get_course_module_record());",
          "107:             $allowedgroups = implode(\",\", array_keys($allowedgroups));",
          "108:             if (!$allowedgroups) {",
          "109:                 return [];",
          "110:             }",
          "111:             $select .= \" AND groupid IN ($allowedgroups)\";",
          "112:         }",
          "113:         $records = $this->get_db()->get_records_select(self::TABLE, $select, $options, $sort ?? '');",
          "",
          "---------------"
        ],
        "mod/forum/export.php||mod/forum/export.php": [
          "File: mod/forum/export.php -> mod/forum/export.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "194: $userids = array_filter($userids, static function(int $userid) use ($course, $cm): bool {",
          "197: });",
          "198: $form->set_data(['useridsselected' => $userids, 'discussionids' => $discussionids, 'from' => $from, 'to' => $to]);",
          "",
          "[Removed Lines]",
          "195:     $user = core_user::get_user($userid, '*', MUST_EXIST);",
          "196:     return $cm->effectivegroupmode != SEPARATEGROUPS || user_can_view_profile($user, $course);",
          "",
          "[Added Lines]",
          "195:     return $cm->effectivegroupmode != SEPARATEGROUPS || groups_user_groups_visible($course, $userid, $cm);",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature": [
          "File: mod/forum/tests/behat/forum_export.feature -> mod/forum/tests/behat/forum_export.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     # This will fail if an exception is thrown. This is the best we can do without the ability to use the download. Hence, there is no \"Then\" step.",
          "49:     And I click on \"Export\" \"button\"",
          "50:     And I log out",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:   Scenario: Group mode is respected when exporting discussions",
          "53:     Given the following \"groups\" exist:",
          "54:       | name | course | idnumber |",
          "55:       | G1   | C1     | G1       |",
          "56:       | G2   | C1     | G2       |",
          "57:     And the following \"users\" exist:",
          "58:       | username | firstname | lastname | email |",
          "59:       | teachera | Teacher   | A | teacherA@example.com |",
          "60:       | teacherb | Teacher   | B | teacherB@example.com |",
          "61:       | teacherc | Teacher   | C | teacherC@example.com |",
          "62:       | teacherd | Teacher   | D | teacherD@example.com |",
          "63:     And the following \"course enrolments\" exist:",
          "64:       | user     | course | role           |",
          "65:       | teachera | C1     | teacher        |",
          "66:       | teacherb | C1     | teacher        |",
          "67:       | teacherc | C1     | teacher        |",
          "68:       | teacherd | C1     | teacher        |",
          "69:     And the following \"group members\" exist:",
          "70:       | user        | group |",
          "71:       | teachera    | G1  |",
          "72:       | teachera    | G2  |",
          "73:       | teacherb    | G1  |",
          "74:       | teacherc    | G2  |",
          "75:     And the following \"activities\" exist:",
          "76:       | activity | course | idnumber | name                    | intro                      | type    | section | groupmode |",
          "77:       | forum    | C1     | 00001    | Separate groups forum   | Standard forum description | general | 1       | 1         |",
          "78:     And the following \"mod_forum > discussions\" exist:",
          "79:       | user     | forum                 | name                 | message           | group |",
          "80:       | teachera | Separate groups forum | Discussion 1 Group 1 | Test post message | G1    |",
          "81:       | teacherb | Separate groups forum | Discussion 2 Group 1 | Test post message | G1    |",
          "82:       | teachera | Separate groups forum | Discussion 1 Group 2 | Test post message | G2    |",
          "83:       | teacherc | Separate groups forum | Discussion 2 Group 2 | Test post message | G2    |",
          "84:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacher1",
          "85:     And I navigate to \"Export\" in current page administration",
          "86:     When I expand the \"Users\" autocomplete",
          "87:     # Editing teacher can see all users and discussions.",
          "88:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "89:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "90:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "91:     And I should see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "92:     And I should see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "93:     And I should see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "94:     And I press the escape key",
          "95:     And I expand the \"Discussions\" autocomplete",
          "96:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "97:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "98:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "99:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "100:     And I click on \"Export\" \"button\"",
          "102:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teachera",
          "103:     And I navigate to \"Export\" in current page administration",
          "104:     When I expand the \"Users\" autocomplete",
          "105:     # Teacher A is is in both groups.",
          "106:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "107:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "108:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "109:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "110:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "111:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "112:     And I press the escape key",
          "113:     And I expand the \"Discussions\" autocomplete",
          "114:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "115:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "116:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "117:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "118:     And I click on \"Export\" \"button\"",
          "120:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherb",
          "121:     And I navigate to \"Export\" in current page administration",
          "122:     When I expand the \"Users\" autocomplete",
          "123:     # Teacher B is in group 1.",
          "124:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "125:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "126:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "127:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "128:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "129:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "130:     And I press the escape key",
          "131:     And I expand the \"Discussions\" autocomplete",
          "132:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "133:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "134:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "135:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "136:     And I click on \"Export\" \"button\"",
          "138:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherc",
          "139:     And I navigate to \"Export\" in current page administration",
          "140:     When I expand the \"Users\" autocomplete",
          "141:     # Teacher C is in group 2.",
          "142:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "143:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "144:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "145:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "146:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "147:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "148:     And I press the escape key",
          "149:     And I expand the \"Discussions\" autocomplete",
          "150:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "151:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "152:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "153:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "154:     And I click on \"Export\" \"button\"",
          "156:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherd",
          "157:     And I navigate to \"Export\" in current page administration",
          "158:     When I expand the \"Users\" autocomplete",
          "159:     # Teacher D is in no group.",
          "160:     Then I should not see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "161:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "162:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "163:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "164:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "165:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "166:     And I press the escape key",
          "167:     And I expand the \"Discussions\" autocomplete",
          "168:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "169:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "170:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "171:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "172:     And I click on \"Export\" \"button\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "87eb0fdf210a49c5334c6861bc6d82c206903efd",
      "candidate_info": {
        "commit_hash": "87eb0fdf210a49c5334c6861bc6d82c206903efd",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/87eb0fdf210a49c5334c6861bc6d82c206903efd",
        "files": [
          "enrol/externallib.php",
          "enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php",
          "enrol/upgrade.txt",
          "mod/forum/amd/build/form-user-selector.min.js",
          "mod/forum/amd/build/form-user-selector.min.js.map",
          "mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature"
        ],
        "message": "MDL-80504 forum: Fix seperate group mode",
        "before_after_code_files": [
          "enrol/externallib.php||enrol/externallib.php",
          "enrol/locallib.php||enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
          "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php||mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ],
          "candidate": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ]
        }
      },
      "candidate_diff": {
        "enrol/externallib.php||enrol/externallib.php": [
          "File: enrol/externallib.php -> enrol/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "619:                 'searchanywhere' => new external_value(PARAM_BOOL, 'find a match anywhere, or only at the beginning'),",
          "620:                 'page' => new external_value(PARAM_INT, 'Page number'),",
          "621:                 'perpage' => new external_value(PARAM_INT, 'Number per page'),",
          "622:             ]",
          "623:         );",
          "624:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "622:                 'contextid' => new external_value(PARAM_INT, 'Context ID', VALUE_DEFAULT, null),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "640:         require_once($CFG->dirroot.'/enrol/locallib.php');",
          "641:         require_once($CFG->dirroot.'/user/lib.php');",
          "",
          "[Removed Lines]",
          "637:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage): array {",
          "638:         global $PAGE, $DB, $CFG;",
          "",
          "[Added Lines]",
          "639:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage, ?int $contextid = null): array {",
          "640:         global $PAGE, $CFG;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "647:                     'search'         => $search,",
          "648:                     'searchanywhere' => $searchanywhere,",
          "649:                     'page'           => $page,",
          "652:         );",
          "654:         try {",
          "655:             self::validate_context($context);",
          "656:         } catch (Exception $e) {",
          "",
          "[Removed Lines]",
          "650:                     'perpage'        => $perpage",
          "651:                 ]",
          "653:         $context = context_course::instance($params['courseid']);",
          "",
          "[Added Lines]",
          "652:                     'perpage'        => $perpage,",
          "653:                     'contextid'      => $contextid,",
          "654:                 ],",
          "656:         if (isset($contextid)) {",
          "657:             $context = context::instance_by_id($params['contextid']);",
          "658:         } else {",
          "659:             $context = context_course::instance($params['courseid']);",
          "660:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "664:         $course = get_course($params['courseid']);",
          "665:         $manager = new course_enrolment_manager($PAGE, $course);",
          "672:         $results = [];",
          "",
          "[Removed Lines]",
          "667:         $users = $manager->search_users($params['search'],",
          "668:                                         $params['searchanywhere'],",
          "669:                                         $params['page'],",
          "670:                                         $params['perpage']);",
          "",
          "[Added Lines]",
          "674:         $users = $manager->search_users(",
          "675:             $params['search'],",
          "676:             $params['searchanywhere'],",
          "677:             $params['page'],",
          "678:             $params['perpage'],",
          "679:             false,",
          "680:             $params['contextid']",
          "681:         );",
          "",
          "---------------"
        ],
        "enrol/locallib.php||enrol/locallib.php": [
          "File: enrol/locallib.php -> enrol/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:     public function search_users(string $search = '', bool $searchanywhere = false, int $page = 0, int $perpage = 25,",
          "573:         global $USER;",
          "575:         [$ufields, $joins, $params, $wherecondition] = $this->get_basic_search_conditions($search, $searchanywhere);",
          "579:             $groups = groups_get_all_groups($this->course->id, $USER->id, 0, 'g.id');",
          "580:             $groupids = array_column($groups, 'id');",
          "581:         } else {",
          "582:             $groupids = [];",
          "583:         }",
          "587:         $fields      = 'SELECT ' . $ufields;",
          "588:         $countfields = 'SELECT COUNT(u.id)';",
          "",
          "[Removed Lines]",
          "572:             bool $returnexactcount = false) {",
          "577:         $groupmode = groups_get_course_groupmode($this->course);",
          "578:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $this->context)) {",
          "585:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($this->context, '', $groupids);",
          "",
          "[Added Lines]",
          "573:             bool $returnexactcount = false, ?int $contextid = null) {",
          "578:         if (isset($contextid)) {",
          "580:             [$context, $course, $cm] = get_context_info_array($contextid);",
          "582:             $groupmode = $cm ? groups_get_activity_groupmode($cm, $course) : groups_get_course_groupmode($this->course);",
          "583:         } else {",
          "585:             $context = $this->context;",
          "586:             $groupmode = groups_get_course_groupmode($this->course);",
          "587:         }",
          "589:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $context)) {",
          "592:             if (!$groupids) {",
          "593:                 return ['totalusers' => 0, 'users' => [], 'moreusers' => false];",
          "594:             }",
          "599:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($context, '', $groupids);",
          "",
          "---------------"
        ],
        "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php": [
          "File: enrol/tests/course_enrolment_manager_test.php -> enrol/tests/course_enrolment_manager_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use context_course;",
          "20: use course_enrolment_manager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "558:         $this->resetAfterTest();",
          "560:         $teacher = $this->getDataGenerator()->create_and_enrol($this->course, 'teacher');",
          "561:         $this->getDataGenerator()->create_group_member(['groupid' => $this->groups['group1']->id, 'userid' => $teacher->id]);",
          "562:         $this->setUser($teacher);",
          "565:         $this->assertEqualsCanonicalizing([",
          "566:             $teacher->username,",
          "567:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "564:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "562:         $record = new stdClass();",
          "563:         $record->introformat = FORMAT_HTML;",
          "564:         $record->course = $this->course->id;",
          "565:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "566:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "572:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "570:             $this->users['user22']->username,",
          "571:             $this->users['userall']->username,",
          "572:             $this->users['usertch']->username,",
          "577:         $this->course->groupmode = SEPARATEGROUPS;",
          "578:         update_course($this->course);",
          "581:         $this->assertEqualsCanonicalizing([",
          "582:             $teacher->username,",
          "583:             $this->users['user1']->username,",
          "584:             $this->users['userall']->username,",
          "589:         $roleid = $DB->get_field('role', 'id', ['shortname' => 'teacher']);",
          "590:         assign_capability('moodle/site:accessallgroups', CAP_ALLOW, $roleid, context_course::instance($this->course->id)->id);",
          "593:         $this->assertEqualsCanonicalizing([",
          "594:             $teacher->username,",
          "595:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "573:         ], array_column($users['users'], 'username'));",
          "574:         $this->assertEquals(7, $users['totalusers']);",
          "580:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "585:         ], array_column($users['users'], 'username'));",
          "586:         $this->assertEquals(3, $users['totalusers']);",
          "592:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "581:         ], array_column($courseusers['users'], 'username'));",
          "582:         $this->assertEquals(7, $courseusers['totalusers']);",
          "584:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "585:         $this->assertEqualsCanonicalizing([",
          "586:             $teacher->username,",
          "587:             $this->users['user1']->username,",
          "588:             $this->users['userall']->username,",
          "589:         ], array_column($forumusers['users'], 'username'));",
          "590:         $this->assertEquals(3, $forumusers['totalusers']);",
          "595:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "597:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "602:         ], array_column($courseusers['users'], 'username'));",
          "603:         $this->assertEquals(3, $courseusers['totalusers']);",
          "605:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "606:         $this->assertEqualsCanonicalizing([",
          "607:             $teacher->username,",
          "608:             $this->users['user0']->username,",
          "609:             $this->users['user1']->username,",
          "610:             $this->users['user21']->username,",
          "611:             $this->users['user22']->username,",
          "612:             $this->users['userall']->username,",
          "613:             $this->users['usertch']->username,",
          "614:         ], array_column($forumusers['users'], 'username'));",
          "615:         $this->assertEquals(7, $forumusers['totalusers']);",
          "617:         set_coursemodule_groupmode($forum->cmid, SEPARATEGROUPS);",
          "623:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "624:         $this->assertEqualsCanonicalizing([",
          "625:             $teacher->username,",
          "626:             $this->users['user0']->username,",
          "627:             $this->users['user1']->username,",
          "628:             $this->users['user21']->username,",
          "629:             $this->users['user22']->username,",
          "630:             $this->users['userall']->username,",
          "631:             $this->users['usertch']->username,",
          "632:         ], array_column($courseusers['users'], 'username'));",
          "633:         $this->assertEquals(7, $courseusers['totalusers']);",
          "635:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "598:             $this->users['user22']->username,",
          "599:             $this->users['userall']->username,",
          "600:             $this->users['usertch']->username,",
          "603:     }",
          "604: }",
          "",
          "[Removed Lines]",
          "601:         ], array_column($users['users'], 'username'));",
          "602:         $this->assertEquals(7, $users['totalusers']);",
          "",
          "[Added Lines]",
          "644:         ], array_column($forumusers['users'], 'username'));",
          "645:         $this->assertEquals(7, $forumusers['totalusers']);",
          "",
          "---------------"
        ],
        "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php": [
          "File: enrol/tests/externallib_test.php -> enrol/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use core_enrol_external;",
          "20: use enrol_user_enrolment_form;",
          "21: use externallib_advanced_testcase;",
          "23: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1402:         $this->assertCount(0, $result);",
          "1403:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1410:     public function test_search_users_groupmode() {",
          "1411:         global $DB;",
          "1413:         $this->resetAfterTest();",
          "1414:         $datagen = $this->getDataGenerator();",
          "1416:         $studentroleid = $DB->get_field('role', 'id', ['shortname' => 'student'], MUST_EXIST);",
          "1417:         $teacherroleid = $DB->get_field('role', 'id', ['shortname' => 'teacher'], MUST_EXIST);",
          "1419:         $course = $datagen->create_course();",
          "1421:         $student1 = $datagen->create_and_enrol($course);",
          "1422:         $student2 = $datagen->create_and_enrol($course);",
          "1423:         $student3 = $datagen->create_and_enrol($course);",
          "1424:         $teacher1 = $datagen->create_and_enrol($course, 'teacher');",
          "1425:         $teacher2 = $datagen->create_and_enrol($course, 'teacher');",
          "1426:         $teacher3 = $datagen->create_and_enrol($course, 'teacher');",
          "1427:         $teacher4 = $datagen->create_and_enrol($course, 'editingteacher');",
          "1430:         $group1 = $datagen->create_group(['courseid' => $course->id]);",
          "1431:         $group2 = $datagen->create_group(['courseid' => $course->id]);",
          "1434:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $student1->id]);",
          "1435:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student2->id]);",
          "1436:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student3->id]);",
          "1437:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher1->id]);",
          "1438:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $teacher1->id]);",
          "1439:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher2->id]);",
          "1442:         $record = new stdClass();",
          "1443:         $record->introformat = FORMAT_HTML;",
          "1444:         $record->course = $course->id;",
          "1445:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "1446:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "1448:         $this->setUser($teacher1);",
          "1449:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1450:         $this->assertCount(5, $result);",
          "1452:         $this->setUser($teacher2);",
          "1453:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1454:         $this->assertCount(3, $result);",
          "1456:         $this->setUser($teacher3);",
          "1457:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1458:         $this->assertCount(0, $result);",
          "1460:         $this->setUser($teacher4);",
          "1461:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1462:         $this->assertCount(7, $result);",
          "1465:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "1466:         $this->setUser($teacher1);",
          "1467:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1468:         $this->assertCount(7, $result);",
          "1469:     }",
          "",
          "---------------"
        ],
        "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js": [
          "File: mod/forum/amd/src/form-user-selector.js -> mod/forum/amd/src/form-user-selector.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         transport: function(selector, query, success, failure) {",
          "38:             var promise;",
          "39:             var courseid = $(selector).attr('courseid');",
          "41:             promise = Ajax.call([{",
          "42:                 methodname: 'core_enrol_search_users',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:             var contextid = $(selector).attr('data-contextid');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45:                     search: query,",
          "46:                     searchanywhere: true,",
          "47:                     page: 0,",
          "49:                 }",
          "50:             }]);",
          "",
          "[Removed Lines]",
          "48:                     perpage: 30",
          "",
          "[Added Lines]",
          "49:                     perpage: 30,",
          "50:                     contextid: contextid,",
          "",
          "---------------"
        ],
        "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php": [
          "File: mod/forum/classes/form/export_form.php -> mod/forum/classes/form/export_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:             'ajax' => 'mod_forum/form-user-selector',",
          "54:             'multiple' => true,",
          "55:             'noselectionstring' => get_string('allusers', 'mod_forum'),",
          "56:             'courseid' => $forum->get_course_id(),",
          "57:                 'valuehtmlcallback' => function($value) {",
          "58:                     global $OUTPUT;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56:             'data-contextid' => $forum->get_context()->id,",
          "",
          "---------------"
        ],
        "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php": [
          "File: mod/forum/classes/local/vaults/discussion.php -> mod/forum/classes/local/vaults/discussion.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use mod_forum\\local\\entities\\forum as forum_entity;",
          "30: use mod_forum\\local\\entities\\discussion as discussion_entity;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: use mod_forum\\local\\container;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:     public function get_all_discussions_in_forum(forum_entity $forum, string $sort = null): ?array {",
          "100:         return $this->transform_db_records_to_entities($records);",
          "101:     }",
          "",
          "[Removed Lines]",
          "96:         $records = $this->get_db()->get_records(self::TABLE, [",
          "97:             'forum' => $forum->get_id(),",
          "98:         ], $sort ?? '');",
          "",
          "[Added Lines]",
          "97:         global $USER;",
          "98:         $options = ['forum' => $forum->get_id()];",
          "100:         $managerfactory = container::get_manager_factory();",
          "101:         $capabilitymanager = $managerfactory->get_capability_manager($forum);",
          "103:         $select = \"forum = :forum\";",
          "105:         if ($forum->is_in_group_mode() && !$capabilitymanager->can_access_all_groups($USER)) {",
          "106:             $allowedgroups = groups_get_activity_allowed_groups($forum->get_course_module_record());",
          "107:             $allowedgroups = implode(\",\", array_keys($allowedgroups));",
          "108:             if (!$allowedgroups) {",
          "109:                 return [];",
          "110:             }",
          "111:             $select .= \" AND groupid IN ($allowedgroups)\";",
          "112:         }",
          "113:         $records = $this->get_db()->get_records_select(self::TABLE, $select, $options, $sort ?? '');",
          "",
          "---------------"
        ],
        "mod/forum/export.php||mod/forum/export.php": [
          "File: mod/forum/export.php -> mod/forum/export.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "194: $userids = array_filter($userids, static function(int $userid) use ($course, $cm): bool {",
          "197: });",
          "198: $form->set_data(['useridsselected' => $userids, 'discussionids' => $discussionids, 'from' => $from, 'to' => $to]);",
          "",
          "[Removed Lines]",
          "195:     $user = core_user::get_user($userid, '*', MUST_EXIST);",
          "196:     return $cm->effectivegroupmode != SEPARATEGROUPS || user_can_view_profile($user, $course);",
          "",
          "[Added Lines]",
          "195:     return $cm->effectivegroupmode != SEPARATEGROUPS || groups_user_groups_visible($course, $userid, $cm);",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature": [
          "File: mod/forum/tests/behat/forum_export.feature -> mod/forum/tests/behat/forum_export.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     # This will fail if an exception is thrown. This is the best we can do without the ability to use the download. Hence, there is no \"Then\" step.",
          "49:     And I click on \"Export\" \"button\"",
          "50:     And I log out",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:   Scenario: Group mode is respected when exporting discussions",
          "53:     Given the following \"groups\" exist:",
          "54:       | name | course | idnumber |",
          "55:       | G1   | C1     | G1       |",
          "56:       | G2   | C1     | G2       |",
          "57:     And the following \"users\" exist:",
          "58:       | username | firstname | lastname | email |",
          "59:       | teachera | Teacher   | A | teacherA@example.com |",
          "60:       | teacherb | Teacher   | B | teacherB@example.com |",
          "61:       | teacherc | Teacher   | C | teacherC@example.com |",
          "62:       | teacherd | Teacher   | D | teacherD@example.com |",
          "63:     And the following \"course enrolments\" exist:",
          "64:       | user     | course | role           |",
          "65:       | teachera | C1     | teacher        |",
          "66:       | teacherb | C1     | teacher        |",
          "67:       | teacherc | C1     | teacher        |",
          "68:       | teacherd | C1     | teacher        |",
          "69:     And the following \"group members\" exist:",
          "70:       | user        | group |",
          "71:       | teachera    | G1  |",
          "72:       | teachera    | G2  |",
          "73:       | teacherb    | G1  |",
          "74:       | teacherc    | G2  |",
          "75:     And the following \"activities\" exist:",
          "76:       | activity | course | idnumber | name                    | intro                      | type    | section | groupmode |",
          "77:       | forum    | C1     | 00001    | Separate groups forum   | Standard forum description | general | 1       | 1         |",
          "78:     And the following \"mod_forum > discussions\" exist:",
          "79:       | user     | forum                 | name                 | message           | group |",
          "80:       | teachera | Separate groups forum | Discussion 1 Group 1 | Test post message | G1    |",
          "81:       | teacherb | Separate groups forum | Discussion 2 Group 1 | Test post message | G1    |",
          "82:       | teachera | Separate groups forum | Discussion 1 Group 2 | Test post message | G2    |",
          "83:       | teacherc | Separate groups forum | Discussion 2 Group 2 | Test post message | G2    |",
          "84:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacher1",
          "85:     And I navigate to \"Export\" in current page administration",
          "86:     When I expand the \"Users\" autocomplete",
          "87:     # Editing teacher can see all users and discussions.",
          "88:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "89:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "90:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "91:     And I should see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "92:     And I should see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "93:     And I should see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "94:     And I press the escape key",
          "95:     And I expand the \"Discussions\" autocomplete",
          "96:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "97:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "98:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "99:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "100:     And I click on \"Export\" \"button\"",
          "102:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teachera",
          "103:     And I navigate to \"Export\" in current page administration",
          "104:     When I expand the \"Users\" autocomplete",
          "105:     # Teacher A is is in both groups.",
          "106:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "107:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "108:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "109:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "110:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "111:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "112:     And I press the escape key",
          "113:     And I expand the \"Discussions\" autocomplete",
          "114:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "115:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "116:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "117:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "118:     And I click on \"Export\" \"button\"",
          "120:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherb",
          "121:     And I navigate to \"Export\" in current page administration",
          "122:     When I expand the \"Users\" autocomplete",
          "123:     # Teacher B is in group 1.",
          "124:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "125:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "126:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "127:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "128:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "129:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "130:     And I press the escape key",
          "131:     And I expand the \"Discussions\" autocomplete",
          "132:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "133:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "134:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "135:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "136:     And I click on \"Export\" \"button\"",
          "138:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherc",
          "139:     And I navigate to \"Export\" in current page administration",
          "140:     When I expand the \"Users\" autocomplete",
          "141:     # Teacher C is in group 2.",
          "142:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "143:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "144:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "145:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "146:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "147:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "148:     And I press the escape key",
          "149:     And I expand the \"Discussions\" autocomplete",
          "150:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "151:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "152:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "153:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "154:     And I click on \"Export\" \"button\"",
          "156:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherd",
          "157:     And I navigate to \"Export\" in current page administration",
          "158:     When I expand the \"Users\" autocomplete",
          "159:     # Teacher D is in no group.",
          "160:     Then I should not see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "161:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "162:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "163:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "164:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "165:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "166:     And I press the escape key",
          "167:     And I expand the \"Discussions\" autocomplete",
          "168:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "169:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "170:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "171:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "172:     And I click on \"Export\" \"button\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "556a285702ed5ff81b363314b0e891dae4b1cf94",
      "candidate_info": {
        "commit_hash": "556a285702ed5ff81b363314b0e891dae4b1cf94",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/556a285702ed5ff81b363314b0e891dae4b1cf94",
        "files": [
          "enrol/externallib.php",
          "enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php",
          "enrol/upgrade.txt",
          "mod/forum/amd/build/form-user-selector.min.js",
          "mod/forum/amd/build/form-user-selector.min.js.map",
          "mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature"
        ],
        "message": "MDL-80504 forum: Fix seperate group mode",
        "before_after_code_files": [
          "enrol/externallib.php||enrol/externallib.php",
          "enrol/locallib.php||enrol/locallib.php",
          "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
          "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
          "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
          "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
          "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
          "mod/forum/export.php||mod/forum/export.php",
          "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ],
          "candidate": [
            "enrol/externallib.php||enrol/externallib.php",
            "enrol/locallib.php||enrol/locallib.php",
            "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php",
            "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php",
            "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js",
            "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php",
            "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php",
            "mod/forum/export.php||mod/forum/export.php",
            "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature"
          ]
        }
      },
      "candidate_diff": {
        "enrol/externallib.php||enrol/externallib.php": [
          "File: enrol/externallib.php -> enrol/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "629:                 'searchanywhere' => new external_value(PARAM_BOOL, 'find a match anywhere, or only at the beginning'),",
          "630:                 'page' => new external_value(PARAM_INT, 'Page number'),",
          "631:                 'perpage' => new external_value(PARAM_INT, 'Number per page'),",
          "632:             ]",
          "633:         );",
          "634:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "632:                 'contextid' => new external_value(PARAM_INT, 'Context ID', VALUE_DEFAULT, null),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "650:         require_once($CFG->dirroot.'/enrol/locallib.php');",
          "651:         require_once($CFG->dirroot.'/user/lib.php');",
          "",
          "[Removed Lines]",
          "647:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage): array {",
          "648:         global $PAGE, $DB, $CFG;",
          "",
          "[Added Lines]",
          "649:     public static function search_users(int $courseid, string $search, bool $searchanywhere, int $page, int $perpage, ?int $contextid = null): array {",
          "650:         global $PAGE, $CFG;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "657:                     'search'         => $search,",
          "658:                     'searchanywhere' => $searchanywhere,",
          "659:                     'page'           => $page,",
          "662:         );",
          "664:         try {",
          "665:             self::validate_context($context);",
          "666:         } catch (Exception $e) {",
          "",
          "[Removed Lines]",
          "660:                     'perpage'        => $perpage",
          "661:                 ]",
          "663:         $context = context_course::instance($params['courseid']);",
          "",
          "[Added Lines]",
          "662:                     'perpage'        => $perpage,",
          "663:                     'contextid'      => $contextid,",
          "664:                 ],",
          "666:         if (isset($contextid)) {",
          "667:             $context = context::instance_by_id($params['contextid']);",
          "668:         } else {",
          "669:             $context = context_course::instance($params['courseid']);",
          "670:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "674:         $course = get_course($params['courseid']);",
          "675:         $manager = new course_enrolment_manager($PAGE, $course);",
          "682:         $results = [];",
          "",
          "[Removed Lines]",
          "677:         $users = $manager->search_users($params['search'],",
          "678:                                         $params['searchanywhere'],",
          "679:                                         $params['page'],",
          "680:                                         $params['perpage']);",
          "",
          "[Added Lines]",
          "684:         $users = $manager->search_users(",
          "685:             $params['search'],",
          "686:             $params['searchanywhere'],",
          "687:             $params['page'],",
          "688:             $params['perpage'],",
          "689:             false,",
          "690:             $params['contextid']",
          "691:         );",
          "",
          "---------------"
        ],
        "enrol/locallib.php||enrol/locallib.php": [
          "File: enrol/locallib.php -> enrol/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:     public function search_users(string $search = '', bool $searchanywhere = false, int $page = 0, int $perpage = 25,",
          "573:         global $USER;",
          "575:         [$ufields, $joins, $params, $wherecondition] = $this->get_basic_search_conditions($search, $searchanywhere);",
          "579:             $groups = groups_get_all_groups($this->course->id, $USER->id, 0, 'g.id');",
          "580:             $groupids = array_column($groups, 'id');",
          "581:         } else {",
          "582:             $groupids = [];",
          "583:         }",
          "587:         $fields      = 'SELECT ' . $ufields;",
          "588:         $countfields = 'SELECT COUNT(u.id)';",
          "",
          "[Removed Lines]",
          "572:             bool $returnexactcount = false) {",
          "577:         $groupmode = groups_get_course_groupmode($this->course);",
          "578:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $this->context)) {",
          "585:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($this->context, '', $groupids);",
          "",
          "[Added Lines]",
          "573:             bool $returnexactcount = false, ?int $contextid = null) {",
          "578:         if (isset($contextid)) {",
          "580:             [$context, $course, $cm] = get_context_info_array($contextid);",
          "582:             $groupmode = $cm ? groups_get_activity_groupmode($cm, $course) : groups_get_course_groupmode($this->course);",
          "583:         } else {",
          "585:             $context = $this->context;",
          "586:             $groupmode = groups_get_course_groupmode($this->course);",
          "587:         }",
          "589:         if ($groupmode == SEPARATEGROUPS && !has_capability('moodle/site:accessallgroups', $context)) {",
          "592:             if (!$groupids) {",
          "593:                 return ['totalusers' => 0, 'users' => [], 'moreusers' => false];",
          "594:             }",
          "599:         [$enrolledsql, $enrolledparams] = get_enrolled_sql($context, '', $groupids);",
          "",
          "---------------"
        ],
        "enrol/tests/course_enrolment_manager_test.php||enrol/tests/course_enrolment_manager_test.php": [
          "File: enrol/tests/course_enrolment_manager_test.php -> enrol/tests/course_enrolment_manager_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use context_course;",
          "20: use course_enrolment_manager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "558:         $this->resetAfterTest();",
          "560:         $teacher = $this->getDataGenerator()->create_and_enrol($this->course, 'teacher');",
          "561:         $this->getDataGenerator()->create_group_member(['groupid' => $this->groups['group1']->id, 'userid' => $teacher->id]);",
          "562:         $this->setUser($teacher);",
          "565:         $this->assertEqualsCanonicalizing([",
          "566:             $teacher->username,",
          "567:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "564:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "562:         $record = new stdClass();",
          "563:         $record->introformat = FORMAT_HTML;",
          "564:         $record->course = $this->course->id;",
          "565:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "566:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "572:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "570:             $this->users['user22']->username,",
          "571:             $this->users['userall']->username,",
          "572:             $this->users['usertch']->username,",
          "577:         $this->course->groupmode = SEPARATEGROUPS;",
          "578:         update_course($this->course);",
          "581:         $this->assertEqualsCanonicalizing([",
          "582:             $teacher->username,",
          "583:             $this->users['user1']->username,",
          "584:             $this->users['userall']->username,",
          "589:         $roleid = $DB->get_field('role', 'id', ['shortname' => 'teacher']);",
          "590:         assign_capability('moodle/site:accessallgroups', CAP_ALLOW, $roleid, context_course::instance($this->course->id)->id);",
          "593:         $this->assertEqualsCanonicalizing([",
          "594:             $teacher->username,",
          "595:             $this->users['user0']->username,",
          "",
          "[Removed Lines]",
          "573:         ], array_column($users['users'], 'username'));",
          "574:         $this->assertEquals(7, $users['totalusers']);",
          "580:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "585:         ], array_column($users['users'], 'username'));",
          "586:         $this->assertEquals(3, $users['totalusers']);",
          "592:         $users = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "",
          "[Added Lines]",
          "581:         ], array_column($courseusers['users'], 'username'));",
          "582:         $this->assertEquals(7, $courseusers['totalusers']);",
          "584:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "585:         $this->assertEqualsCanonicalizing([",
          "586:             $teacher->username,",
          "587:             $this->users['user1']->username,",
          "588:             $this->users['userall']->username,",
          "589:         ], array_column($forumusers['users'], 'username'));",
          "590:         $this->assertEquals(3, $forumusers['totalusers']);",
          "595:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "597:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "602:         ], array_column($courseusers['users'], 'username'));",
          "603:         $this->assertEquals(3, $courseusers['totalusers']);",
          "605:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "606:         $this->assertEqualsCanonicalizing([",
          "607:             $teacher->username,",
          "608:             $this->users['user0']->username,",
          "609:             $this->users['user1']->username,",
          "610:             $this->users['user21']->username,",
          "611:             $this->users['user22']->username,",
          "612:             $this->users['userall']->username,",
          "613:             $this->users['usertch']->username,",
          "614:         ], array_column($forumusers['users'], 'username'));",
          "615:         $this->assertEquals(7, $forumusers['totalusers']);",
          "617:         set_coursemodule_groupmode($forum->cmid, SEPARATEGROUPS);",
          "623:         $courseusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true);",
          "624:         $this->assertEqualsCanonicalizing([",
          "625:             $teacher->username,",
          "626:             $this->users['user0']->username,",
          "627:             $this->users['user1']->username,",
          "628:             $this->users['user21']->username,",
          "629:             $this->users['user22']->username,",
          "630:             $this->users['userall']->username,",
          "631:             $this->users['usertch']->username,",
          "632:         ], array_column($courseusers['users'], 'username'));",
          "633:         $this->assertEquals(7, $courseusers['totalusers']);",
          "635:         $forumusers = (new course_enrolment_manager($PAGE, $this->course))->search_users('', false, 0, 25, true, $contextid);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "598:             $this->users['user22']->username,",
          "599:             $this->users['userall']->username,",
          "600:             $this->users['usertch']->username,",
          "603:     }",
          "604: }",
          "",
          "[Removed Lines]",
          "601:         ], array_column($users['users'], 'username'));",
          "602:         $this->assertEquals(7, $users['totalusers']);",
          "",
          "[Added Lines]",
          "644:         ], array_column($forumusers['users'], 'username'));",
          "645:         $this->assertEquals(7, $forumusers['totalusers']);",
          "",
          "---------------"
        ],
        "enrol/tests/externallib_test.php||enrol/tests/externallib_test.php": [
          "File: enrol/tests/externallib_test.php -> enrol/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: use core_external\\external_api;",
          "21: use enrol_user_enrolment_form;",
          "22: use externallib_advanced_testcase;",
          "24: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1421:         $this->assertCount(0, $result);",
          "1422:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1429:     public function test_search_users_groupmode() {",
          "1430:         global $DB;",
          "1432:         $this->resetAfterTest();",
          "1433:         $datagen = $this->getDataGenerator();",
          "1435:         $studentroleid = $DB->get_field('role', 'id', ['shortname' => 'student'], MUST_EXIST);",
          "1436:         $teacherroleid = $DB->get_field('role', 'id', ['shortname' => 'teacher'], MUST_EXIST);",
          "1438:         $course = $datagen->create_course();",
          "1440:         $student1 = $datagen->create_and_enrol($course);",
          "1441:         $student2 = $datagen->create_and_enrol($course);",
          "1442:         $student3 = $datagen->create_and_enrol($course);",
          "1443:         $teacher1 = $datagen->create_and_enrol($course, 'teacher');",
          "1444:         $teacher2 = $datagen->create_and_enrol($course, 'teacher');",
          "1445:         $teacher3 = $datagen->create_and_enrol($course, 'teacher');",
          "1446:         $teacher4 = $datagen->create_and_enrol($course, 'editingteacher');",
          "1449:         $group1 = $datagen->create_group(['courseid' => $course->id]);",
          "1450:         $group2 = $datagen->create_group(['courseid' => $course->id]);",
          "1453:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $student1->id]);",
          "1454:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student2->id]);",
          "1455:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $student3->id]);",
          "1456:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher1->id]);",
          "1457:         $datagen->create_group_member(['groupid' => $group2->id, 'userid' => $teacher1->id]);",
          "1458:         $datagen->create_group_member(['groupid' => $group1->id, 'userid' => $teacher2->id]);",
          "1461:         $record = new stdClass();",
          "1462:         $record->introformat = FORMAT_HTML;",
          "1463:         $record->course = $course->id;",
          "1464:         $forum = self::getDataGenerator()->create_module('forum', $record, ['groupmode' => SEPARATEGROUPS]);",
          "1465:         $contextid = $DB->get_field('context', 'id', ['instanceid' => $forum->cmid, 'contextlevel' => CONTEXT_MODULE]);",
          "1467:         $this->setUser($teacher1);",
          "1468:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1469:         $this->assertCount(5, $result);",
          "1471:         $this->setUser($teacher2);",
          "1472:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1473:         $this->assertCount(3, $result);",
          "1475:         $this->setUser($teacher3);",
          "1476:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1477:         $this->assertCount(0, $result);",
          "1479:         $this->setUser($teacher4);",
          "1480:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1481:         $this->assertCount(7, $result);",
          "1484:         set_coursemodule_groupmode($forum->cmid, NOGROUPS);",
          "1485:         $this->setUser($teacher1);",
          "1486:         $result = core_enrol_external::search_users($course->id, 'user', true, 0, 30, $contextid);",
          "1487:         $this->assertCount(7, $result);",
          "1488:     }",
          "",
          "---------------"
        ],
        "mod/forum/amd/src/form-user-selector.js||mod/forum/amd/src/form-user-selector.js": [
          "File: mod/forum/amd/src/form-user-selector.js -> mod/forum/amd/src/form-user-selector.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         transport: function(selector, query, success, failure) {",
          "38:             var promise;",
          "39:             var courseid = $(selector).attr('courseid');",
          "41:             promise = Ajax.call([{",
          "42:                 methodname: 'core_enrol_search_users',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:             var contextid = $(selector).attr('data-contextid');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45:                     search: query,",
          "46:                     searchanywhere: true,",
          "47:                     page: 0,",
          "49:                 }",
          "50:             }]);",
          "",
          "[Removed Lines]",
          "48:                     perpage: 30",
          "",
          "[Added Lines]",
          "49:                     perpage: 30,",
          "50:                     contextid: contextid,",
          "",
          "---------------"
        ],
        "mod/forum/classes/form/export_form.php||mod/forum/classes/form/export_form.php": [
          "File: mod/forum/classes/form/export_form.php -> mod/forum/classes/form/export_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:             'ajax' => 'mod_forum/form-user-selector',",
          "54:             'multiple' => true,",
          "55:             'noselectionstring' => get_string('allusers', 'mod_forum'),",
          "56:             'courseid' => $forum->get_course_id(),",
          "57:                 'valuehtmlcallback' => function($value) {",
          "58:                     global $OUTPUT;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56:             'data-contextid' => $forum->get_context()->id,",
          "",
          "---------------"
        ],
        "mod/forum/classes/local/vaults/discussion.php||mod/forum/classes/local/vaults/discussion.php": [
          "File: mod/forum/classes/local/vaults/discussion.php -> mod/forum/classes/local/vaults/discussion.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use mod_forum\\local\\entities\\forum as forum_entity;",
          "30: use mod_forum\\local\\entities\\discussion as discussion_entity;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: use mod_forum\\local\\container;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:     public function get_all_discussions_in_forum(forum_entity $forum, string $sort = null): ?array {",
          "100:         return $this->transform_db_records_to_entities($records);",
          "101:     }",
          "",
          "[Removed Lines]",
          "96:         $records = $this->get_db()->get_records(self::TABLE, [",
          "97:             'forum' => $forum->get_id(),",
          "98:         ], $sort ?? '');",
          "",
          "[Added Lines]",
          "97:         global $USER;",
          "98:         $options = ['forum' => $forum->get_id()];",
          "100:         $managerfactory = container::get_manager_factory();",
          "101:         $capabilitymanager = $managerfactory->get_capability_manager($forum);",
          "103:         $select = \"forum = :forum\";",
          "105:         if ($forum->is_in_group_mode() && !$capabilitymanager->can_access_all_groups($USER)) {",
          "106:             $allowedgroups = groups_get_activity_allowed_groups($forum->get_course_module_record());",
          "107:             $allowedgroups = implode(\",\", array_keys($allowedgroups));",
          "108:             if (!$allowedgroups) {",
          "109:                 return [];",
          "110:             }",
          "111:             $select .= \" AND groupid IN ($allowedgroups)\";",
          "112:         }",
          "113:         $records = $this->get_db()->get_records_select(self::TABLE, $select, $options, $sort ?? '');",
          "",
          "---------------"
        ],
        "mod/forum/export.php||mod/forum/export.php": [
          "File: mod/forum/export.php -> mod/forum/export.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "194: $userids = array_filter($userids, static function(int $userid) use ($course, $cm): bool {",
          "197: });",
          "198: $form->set_data(['useridsselected' => $userids, 'discussionids' => $discussionids, 'from' => $from, 'to' => $to]);",
          "",
          "[Removed Lines]",
          "195:     $user = core_user::get_user($userid, '*', MUST_EXIST);",
          "196:     return $cm->effectivegroupmode != SEPARATEGROUPS || user_can_view_profile($user, $course);",
          "",
          "[Added Lines]",
          "195:     return $cm->effectivegroupmode != SEPARATEGROUPS || groups_user_groups_visible($course, $userid, $cm);",
          "",
          "---------------"
        ],
        "mod/forum/tests/behat/forum_export.feature||mod/forum/tests/behat/forum_export.feature": [
          "File: mod/forum/tests/behat/forum_export.feature -> mod/forum/tests/behat/forum_export.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     # This will fail if an exception is thrown. This is the best we can do without the ability to use the download. Hence, there is no \"Then\" step.",
          "49:     And I click on \"Export\" \"button\"",
          "50:     And I log out",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:   Scenario: Group mode is respected when exporting discussions",
          "53:     Given the following \"groups\" exist:",
          "54:       | name | course | idnumber |",
          "55:       | G1   | C1     | G1       |",
          "56:       | G2   | C1     | G2       |",
          "57:     And the following \"users\" exist:",
          "58:       | username | firstname | lastname | email |",
          "59:       | teachera | Teacher   | A | teacherA@example.com |",
          "60:       | teacherb | Teacher   | B | teacherB@example.com |",
          "61:       | teacherc | Teacher   | C | teacherC@example.com |",
          "62:       | teacherd | Teacher   | D | teacherD@example.com |",
          "63:     And the following \"course enrolments\" exist:",
          "64:       | user     | course | role           |",
          "65:       | teachera | C1     | teacher        |",
          "66:       | teacherb | C1     | teacher        |",
          "67:       | teacherc | C1     | teacher        |",
          "68:       | teacherd | C1     | teacher        |",
          "69:     And the following \"group members\" exist:",
          "70:       | user        | group |",
          "71:       | teachera    | G1  |",
          "72:       | teachera    | G2  |",
          "73:       | teacherb    | G1  |",
          "74:       | teacherc    | G2  |",
          "75:     And the following \"activities\" exist:",
          "76:       | activity | course | idnumber | name                    | intro                      | type    | section | groupmode |",
          "77:       | forum    | C1     | 00001    | Separate groups forum   | Standard forum description | general | 1       | 1         |",
          "78:     And the following \"mod_forum > discussions\" exist:",
          "79:       | user     | forum                 | name                 | message           | group |",
          "80:       | teachera | Separate groups forum | Discussion 1 Group 1 | Test post message | G1    |",
          "81:       | teacherb | Separate groups forum | Discussion 2 Group 1 | Test post message | G1    |",
          "82:       | teachera | Separate groups forum | Discussion 1 Group 2 | Test post message | G2    |",
          "83:       | teacherc | Separate groups forum | Discussion 2 Group 2 | Test post message | G2    |",
          "84:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacher1",
          "85:     And I navigate to \"Export\" in current page administration",
          "86:     When I expand the \"Users\" autocomplete",
          "87:     # Editing teacher can see all users and discussions.",
          "88:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "89:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "90:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "91:     And I should see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "92:     And I should see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "93:     And I should see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "94:     And I press the escape key",
          "95:     And I expand the \"Discussions\" autocomplete",
          "96:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "97:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "98:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "99:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "100:     And I click on \"Export\" \"button\"",
          "102:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teachera",
          "103:     And I navigate to \"Export\" in current page administration",
          "104:     When I expand the \"Users\" autocomplete",
          "105:     # Teacher A is is in both groups.",
          "106:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "107:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "108:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "109:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "110:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "111:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "112:     And I press the escape key",
          "113:     And I expand the \"Discussions\" autocomplete",
          "114:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "115:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "116:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "117:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "118:     And I click on \"Export\" \"button\"",
          "120:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherb",
          "121:     And I navigate to \"Export\" in current page administration",
          "122:     When I expand the \"Users\" autocomplete",
          "123:     # Teacher B is in group 1.",
          "124:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "125:     And I should see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "126:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "127:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "128:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "129:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "130:     And I press the escape key",
          "131:     And I expand the \"Discussions\" autocomplete",
          "132:     And I should see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "133:     And I should see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "134:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "135:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "136:     And I click on \"Export\" \"button\"",
          "138:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherc",
          "139:     And I navigate to \"Export\" in current page administration",
          "140:     When I expand the \"Users\" autocomplete",
          "141:     # Teacher C is in group 2.",
          "142:     Then I should see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "143:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "144:     And I should see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "145:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "146:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "147:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "148:     And I press the escape key",
          "149:     And I expand the \"Discussions\" autocomplete",
          "150:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "151:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "152:     And I should see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "153:     And I should see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "154:     And I click on \"Export\" \"button\"",
          "156:     And I am on the \"Separate groups forum\" \"forum activity\" page logged in as teacherd",
          "157:     And I navigate to \"Export\" in current page administration",
          "158:     When I expand the \"Users\" autocomplete",
          "159:     # Teacher D is in no group.",
          "160:     Then I should not see \"Teacher A\" in the \"Users\" \"autocomplete\"",
          "161:     And I should not see \"Teacher B\" in the \"Users\" \"autocomplete\"",
          "162:     And I should not see \"Teacher C\" in the \"Users\" \"autocomplete\"",
          "163:     And I should not see \"Teacher D\" in the \"Users\" \"autocomplete\"",
          "164:     And I should not see \"Teacher 1\" in the \"Users\" \"autocomplete\"",
          "165:     And I should not see \"Student 1\" in the \"Users\" \"autocomplete\"",
          "166:     And I press the escape key",
          "167:     And I expand the \"Discussions\" autocomplete",
          "168:     And I should not see \"Discussion 1 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "169:     And I should not see \"Discussion 2 Group 1\" in the \"Discussions\" \"autocomplete\"",
          "170:     And I should not see \"Discussion 1 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "171:     And I should not see \"Discussion 2 Group 2\" in the \"Discussions\" \"autocomplete\"",
          "172:     And I click on \"Export\" \"button\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}