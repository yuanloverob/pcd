{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dccda6546bfde32444780d99931704c5beba1b36",
      "candidate_info": {
        "commit_hash": "dccda6546bfde32444780d99931704c5beba1b36",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/dccda6546bfde32444780d99931704c5beba1b36",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.6dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181110)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018111300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181113)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "29c395187f5e858368547fae83dee21b253509af",
      "candidate_info": {
        "commit_hash": "29c395187f5e858368547fae83dee21b253509af",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/29c395187f5e858368547fae83dee21b253509af",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.8dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190524)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019053000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190530)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "62b942a5100746e0f36e6e5509f7df0715eab5d9",
      "candidate_info": {
        "commit_hash": "62b942a5100746e0f36e6e5509f7df0715eab5d9",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/62b942a5100746e0f36e6e5509f7df0715eab5d9",
        "files": [
          "version.php"
        ],
        "message": "MDL-64528 core_completion: new cap version bump",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019012400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019013000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "800563e415f64d1cb36bbf9294dc94fdcd6feb84",
      "candidate_info": {
        "commit_hash": "800563e415f64d1cb36bbf9294dc94fdcd6feb84",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/800563e415f64d1cb36bbf9294dc94fdcd6feb84",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.9dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "36: $branch   = '39';                       // This version's branch.",
          "37: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019111800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "35: $release  = '3.9dev (Build: 20191122)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019112900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "35: $release  = '3.9dev (Build: 20191129)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f0a60e33dd15243fb818fcb95352e7dff44d03e",
      "candidate_info": {
        "commit_hash": "3f0a60e33dd15243fb818fcb95352e7dff44d03e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/3f0a60e33dd15243fb818fcb95352e7dff44d03e",
        "files": [
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-62897 Questions: Find duplicate top cats per context and fix them",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2268:         upgrade_main_savepoint(true, 2018062800.03);",
          "2269:     }",
          "2271:     return true;",
          "2272: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2271:     if ($oldversion < 2018072500.00) {",
          "2273:         $duplicates = $DB->get_records_sql(\"SELECT qc1.*",
          "2274:                                               FROM {question_categories} qc1",
          "2275:                                               JOIN {question_categories} qc2",
          "2276:                                                 ON qc1.contextid = qc2.contextid AND qc1.id <> qc2.id",
          "2277:                                              WHERE qc1.parent = 0 AND qc2.parent = 0",
          "2278:                                           ORDER BY qc1.contextid, qc1.id\");",
          "2281:         $currentcontextid = 0;",
          "2282:         $chosentopid = 0;",
          "2283:         foreach ($duplicates as $duplicate) {",
          "2284:             if ($currentcontextid != $duplicate->contextid) {",
          "2285:                 $currentcontextid = $duplicate->contextid;",
          "2286:                 $chosentopid = $duplicate->id;",
          "2287:             } else {",
          "2288:                 $DB->set_field('question_categories', 'parent', $chosentopid, ['id' => $duplicate->id]);",
          "2289:             }",
          "2290:         }",
          "2293:         upgrade_main_savepoint(true, 2018072500.00);",
          "2294:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018072000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018072500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}