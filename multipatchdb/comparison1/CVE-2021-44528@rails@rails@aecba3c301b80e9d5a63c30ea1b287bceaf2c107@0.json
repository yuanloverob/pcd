{
  "cve_id": "CVE-2021-44528",
  "cve_desc": "A open redirect vulnerability exists in Action Pack >= 6.0.0 that could allow an attacker to craft a \"X-Forwarded-Host\" headers in combination with certain \"allowed host\" formats can cause the Host Authorization middleware in Action Pack to redirect users to a malicious website.",
  "repo": "rails/rails",
  "patch_hash": "aecba3c301b80e9d5a63c30ea1b287bceaf2c107",
  "patch_info": {
    "commit_hash": "aecba3c301b80e9d5a63c30ea1b287bceaf2c107",
    "repo": "rails/rails",
    "commit_url": "https://github.com/rails/rails/commit/aecba3c301b80e9d5a63c30ea1b287bceaf2c107",
    "files": [
      "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
      "actionpack/test/dispatch/host_authorization_test.rb"
    ],
    "message": "Fix invalid forwarded host vulnerability\n\nPrior to this commit, it was possible to pass an unvalidated host\nthrough the `X-Forwarded-Host` header. If the value of the header\nwas prefixed with a invalid domain character (for example a `/`),\nit was always accepted as the actual host of that request.\n\nSince this host is used for all url helpers, an attacker could change\ngenerated links and redirects. If the header is set to\n`X-Forwarded-Host: //evil.hacker`, a redirect will be send to\n`https:////evil.hacker/`. Browsers will ignore these four slashes\nand redirect the user.\n\n[CVE-2021-44528]",
    "before_after_code_files": [
      "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
      "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
    ]
  },
  "patch_diff": {
    "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
      "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "52:         def sanitize_string(host)",
      "53:           if host.start_with?(\".\")",
      "55:           else",
      "56:             /\\A#{Regexp.escape host}\\z/i",
      "57:           end",
      "",
      "[Removed Lines]",
      "54:             /\\A(.+\\.)?#{Regexp.escape(host[1..-1])}\\z/i",
      "",
      "[Added Lines]",
      "54:             /\\A([a-z0-9-]+\\.)?#{Regexp.escape(host[1..-1])}\\z/i",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "102:     end",
      "104:     private",
      "109:       def authorized?(request)",
      "113:         @permissions.allows?(origin_host) && (forwarded_host.blank? || @permissions.allows?(forwarded_host))",
      "114:       end",
      "",
      "[Removed Lines]",
      "105:       HOSTNAME = /[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\]/i",
      "106:       VALID_ORIGIN_HOST = /\\A(#{HOSTNAME})(?::\\d+)?\\z/",
      "107:       VALID_FORWARDED_HOST = /(?:\\A|,[ ]?)(#{HOSTNAME})(?::\\d+)?\\z/",
      "110:         origin_host = request.get_header(\"HTTP_HOST\")&.slice(VALID_ORIGIN_HOST, 1) || \"\"",
      "111:         forwarded_host = request.x_forwarded_host&.slice(VALID_FORWARDED_HOST, 1) || \"\"",
      "",
      "[Added Lines]",
      "106:         origin_host = request.get_header(\"HTTP_HOST\")",
      "107:         forwarded_host = request.x_forwarded_host&.split(/,\\s?/)&.last",
      "",
      "---------------"
    ],
    "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb": [
      "File: actionpack/test/dispatch/host_authorization_test.rb -> actionpack/test/dispatch/host_authorization_test.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "155:     assert_match \"Blocked host: 127.0.0.1\", response.body",
      "156:   end",
      "158:   test \"does not consider IP addresses in X-FORWARDED-HOST spoofed when disabled\" do",
      "159:     @app = ActionDispatch::HostAuthorization.new(App, nil)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "158:   test \"blocks requests with spoofed relative X-FORWARDED-HOST\" do",
      "159:     @app = ActionDispatch::HostAuthorization.new(App, [\"www.example.com\"])",
      "161:     get \"/\", env: {",
      "162:       \"HTTP_X_FORWARDED_HOST\" => \"//randomhost.com\",",
      "163:       \"HOST\" => \"www.example.com\",",
      "164:       \"action_dispatch.show_detailed_exceptions\" => true",
      "165:     }",
      "167:     assert_response :forbidden",
      "168:     assert_match \"Blocked host: //randomhost.com\", response.body",
      "169:   end",
      "171:   test \"forwarded secondary hosts are allowed when permitted\" do",
      "172:     @app = ActionDispatch::HostAuthorization.new(App, \".domain.com\")",
      "174:     get \"/\", env: {",
      "175:       \"HTTP_X_FORWARDED_HOST\" => \"example.com, my-sub.domain.com\",",
      "176:       \"HOST\" => \"domain.com\",",
      "177:     }",
      "179:     assert_response :ok",
      "180:     assert_equal \"Success\", body",
      "181:   end",
      "183:   test \"forwarded secondary hosts are blocked when mismatch\" do",
      "184:     @app = ActionDispatch::HostAuthorization.new(App, \"domain.com\")",
      "186:     get \"/\", env: {",
      "187:       \"HTTP_X_FORWARDED_HOST\" => \"domain.com, evil.com\",",
      "188:       \"HOST\" => \"domain.com\",",
      "189:       \"action_dispatch.show_detailed_exceptions\" => true",
      "190:     }",
      "192:     assert_response :forbidden",
      "193:     assert_match \"Blocked host: evil.com\", response.body",
      "194:   end",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "191:     assert_match \"Blocked host: sub.domain.com\", response.body",
      "192:   end",
      "194:   test \"forwarded hosts are allowed when permitted\" do",
      "195:     @app = ActionDispatch::HostAuthorization.new(App, \".domain.com\")",
      "197:     get \"/\", env: {",
      "199:       \"HOST\" => \"domain.com\",",
      "200:     }",
      "",
      "[Removed Lines]",
      "198:       \"HTTP_X_FORWARDED_HOST\" => \"sub.domain.com\",",
      "",
      "[Added Lines]",
      "232:   test \"sub-sub domains should not be permitted\" do",
      "233:     @app = ActionDispatch::HostAuthorization.new(App, \".domain.com\")",
      "235:     get \"/\", env: {",
      "236:       \"HOST\" => \"secondary.sub.domain.com\",",
      "237:       \"action_dispatch.show_detailed_exceptions\" => true",
      "238:     }",
      "240:     assert_response :forbidden",
      "241:     assert_match \"Blocked host: secondary.sub.domain.com\", response.body",
      "242:   end",
      "248:       \"HTTP_X_FORWARDED_HOST\" => \"my-sub.domain.com\",",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "203:     assert_equal \"Success\", body",
      "204:   end",
      "206:   test \"exclude matches allow any host\" do",
      "207:     @app = ActionDispatch::HostAuthorization.new(App, \"only.com\", exclude: ->(req) { req.path == \"/foo\" })",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "256:   test \"lots of NG hosts\" do",
      "257:     ng_hosts = [",
      "258:       \"hacker%E3%80%82com\",",
      "259:       \"hacker%00.com\",",
      "260:       \"www.theirsite.com@yoursite.com\",",
      "261:       \"hacker.com/test/\",",
      "262:       \"hacker%252ecom\",",
      "263:       \".hacker.com\",",
      "264:       \"/\\/\\/hacker.com/\",",
      "265:       \"/hacker.com\",",
      "266:       \"../hacker.com\",",
      "267:       \".hacker.com\",",
      "268:       \"@hacker.com\",",
      "269:       \"hacker.com\",",
      "270:       \"hacker.com%23@example.com\",",
      "271:       \"hacker.com/.jpg\",",
      "272:       \"hacker.com\\texample.com/\",",
      "273:       \"hacker.com/example.com\",",
      "274:       \"hacker.com\\@example.com\",",
      "275:       \"hacker.com/example.com\",",
      "276:       \"hacker.com/\"",
      "277:     ]",
      "279:     @app = ActionDispatch::HostAuthorization.new(App, \"example.com\")",
      "281:     ng_hosts.each do |host|",
      "282:       get \"/\", env: {",
      "283:         \"HTTP_X_FORWARDED_HOST\" => host,",
      "284:         \"HOST\" => \"example.com\",",
      "285:         \"action_dispatch.show_detailed_exceptions\" => true",
      "286:       }",
      "288:       assert_response :forbidden",
      "289:       assert_match \"Blocked host: #{host}\", response.body",
      "290:     end",
      "291:   end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b5de7b3a4787d8a55aaad39f477c16e3af65e444",
      "candidate_info": {
        "commit_hash": "b5de7b3a4787d8a55aaad39f477c16e3af65e444",
        "repo": "rails/rails",
        "commit_url": "https://github.com/rails/rails/commit/b5de7b3a4787d8a55aaad39f477c16e3af65e444",
        "files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb"
        ],
        "message": "Prevent open redirect when allowed host starts with a dot\n\n[CVE-2021-22881]\n\nThanks to @tktech (https://hackerone.com/tktech) for reporting this\nissue and the patch!",
        "before_after_code_files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ],
          "candidate": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
          "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:     private",
          "105:       def authorized?(request)",
          "111:       end",
          "113:       def excluded?(request)",
          "",
          "[Removed Lines]",
          "106:         origin_host = request.get_header(\"HTTP_HOST\").to_s.sub(/:\\d+\\z/, \"\")",
          "107:         forwarded_host = request.x_forwarded_host.to_s.split(/,\\s?/).last.to_s.sub(/:\\d+\\z/, \"\")",
          "109:         @permissions.allows?(origin_host) &&",
          "110:           (forwarded_host.blank? || @permissions.allows?(forwarded_host))",
          "",
          "[Added Lines]",
          "106:         valid_host = /",
          "107:           \\A",
          "108:           (?<host>[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9\\.:]+\\])",
          "109:           (:\\d+)?",
          "110:           \\z",
          "111:         /x",
          "113:         origin_host = valid_host.match(",
          "114:           request.get_header(\"HTTP_HOST\").to_s.downcase)",
          "115:         forwarded_host = valid_host.match(",
          "116:           request.x_forwarded_host.to_s.split(/,\\s?/).last)",
          "118:         origin_host && @permissions.allows?(origin_host[:host]) && (",
          "119:           forwarded_host.nil? || @permissions.allows?(forwarded_host[:host]))",
          "",
          "---------------"
        ],
        "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb": [
          "File: actionpack/test/dispatch/host_authorization_test.rb -> actionpack/test/dispatch/host_authorization_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "221:     assert_match \"Blocked host: www.example.com\", response.body",
          "222:   end",
          "224:   test \"config setting action_dispatch.hosts_response_app is deprecated\" do",
          "225:     assert_deprecated do",
          "226:       ActionDispatch::HostAuthorization.new(App, \"example.com\", ->(env) { true })",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "224:   test \"only compare to valid hostnames\" do",
          "225:     @app = ActionDispatch::HostAuthorization.new(App, \".example.com\")",
          "227:     get \"/\", env: {",
          "228:       \"HOST\" => \"example.com#sub.example.com\",",
          "229:     }",
          "231:     assert_response :forbidden",
          "232:     assert_match \"Blocked host: example.com#sub.example.com\", response.body",
          "233:   end",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "32064abd0a8f78964906b616143df56af01637ea",
      "candidate_info": {
        "commit_hash": "32064abd0a8f78964906b616143df56af01637ea",
        "repo": "rails/rails",
        "commit_url": "https://github.com/rails/rails/commit/32064abd0a8f78964906b616143df56af01637ea",
        "files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "railties/test/application/middleware/remote_ip_test.rb",
          "railties/test/isolation/abstract_unit.rb"
        ],
        "message": "Remove unnessary escape char in Regexp\n\nFix the test by defining a valid host on the mocked requests.",
        "before_after_code_files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "railties/test/application/middleware/remote_ip_test.rb||railties/test/application/middleware/remote_ip_test.rb",
          "railties/test/isolation/abstract_unit.rb||railties/test/isolation/abstract_unit.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb"
          ],
          "candidate": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb"
          ]
        }
      },
      "candidate_diff": {
        "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
          "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "105:       def authorized?(request)",
          "106:         valid_host = /",
          "107:           \\A",
          "109:           (:\\d+)?",
          "110:           \\z",
          "111:         /x",
          "",
          "[Removed Lines]",
          "108:           (?<host>[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9\\.:]+\\])",
          "",
          "[Added Lines]",
          "108:           (?<host>[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\])",
          "",
          "---------------"
        ],
        "railties/test/application/middleware/remote_ip_test.rb||railties/test/application/middleware/remote_ip_test.rb": [
          "File: railties/test/application/middleware/remote_ip_test.rb -> railties/test/application/middleware/remote_ip_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:     def remote_ip(env = {})",
          "12:       remote_ip = nil",
          "13:       env = Rack::MockRequest.env_for(\"/\").merge(env).merge!(",
          "14:         \"action_dispatch.show_exceptions\" => false,",
          "16:           ActiveSupport::KeyGenerator.new(\"b3c631c314c0bbca50c1b2843150fe33\", iterations: 1000)",
          "17:         )",
          "18:       )",
          "",
          "[Removed Lines]",
          "15:         \"action_dispatch.key_generator\"   => ActiveSupport::CachingKeyGenerator.new(",
          "",
          "[Added Lines]",
          "14:         \"HTTP_HOST\" => \"example.com\",",
          "16:         \"action_dispatch.key_generator\" => ActiveSupport::CachingKeyGenerator.new(",
          "",
          "---------------"
        ],
        "railties/test/isolation/abstract_unit.rb||railties/test/isolation/abstract_unit.rb": [
          "File: railties/test/isolation/abstract_unit.rb -> railties/test/isolation/abstract_unit.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:     end",
          "84:     def get(path)",
          "86:     end",
          "88:     def assert_welcome(resp)",
          "",
          "[Removed Lines]",
          "85:       @app.call(::Rack::MockRequest.env_for(path))",
          "",
          "[Added Lines]",
          "85:       @app.call(::Rack::MockRequest.env_for(path, \"HTTP_HOST\" => \"example.com\"))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "78c6d8fabc4aa6bbaea1c21bcbbb8f8940594895",
      "candidate_info": {
        "commit_hash": "78c6d8fabc4aa6bbaea1c21bcbbb8f8940594895",
        "repo": "rails/rails",
        "commit_url": "https://github.com/rails/rails/commit/78c6d8fabc4aa6bbaea1c21bcbbb8f8940594895",
        "files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb"
        ],
        "message": "Merge pull request #43882 from rails/rm-allow-ip-with-port\n\nAllow IPs with port in the HostAuthorization middleware",
        "before_after_code_files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ],
          "candidate": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
          "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "16:   # default one will run, which responds with <tt>403 Forbidden</tt>.",
          "17:   class HostAuthorization",
          "18:     ALLOWED_HOSTS_IN_DEVELOPMENT = [\".localhost\", IPAddr.new(\"0.0.0.0/0\"), IPAddr.new(\"::/0\")]",
          "21:     class Permissions # :nodoc:",
          "22:       def initialize(hosts)",
          "",
          "[Removed Lines]",
          "19:     PORT_REGEX = /(?::\\d+)?/.freeze",
          "",
          "[Added Lines]",
          "19:     PORT_REGEX = /(?::\\d+)/ # :nodoc:",
          "20:     IPV4_HOSTNAME = /(?<host>\\d+\\.\\d+\\.\\d+\\.\\d+)#{PORT_REGEX}?/ # :nodoc:",
          "21:     IPV6_HOSTNAME = /(?<host>[a-f0-9]*:[a-f0-9.:]+)/i # :nodoc:",
          "22:     IPV6_HOSTNAME_WITH_PORT = /\\[#{IPV6_HOSTNAME}\\]#{PORT_REGEX}/i # :nodoc:",
          "23:     VALID_IP_HOSTNAME = Regexp.union( # :nodoc:",
          "24:       /\\A#{IPV4_HOSTNAME}\\z/,",
          "25:       /\\A#{IPV6_HOSTNAME}\\z/,",
          "26:       /\\A#{IPV6_HOSTNAME_WITH_PORT}\\z/,",
          "27:     )",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30:       def allows?(host)",
          "31:         @hosts.any? do |allowed|",
          "37:         end",
          "38:       end",
          "",
          "[Removed Lines]",
          "32:           allowed === host",
          "33:         rescue",
          "34:           # IPAddr#=== raises an error if you give it a hostname instead of",
          "35:           # IP. Treat similar errors as blocked access.",
          "36:           false",
          "",
          "[Added Lines]",
          "40:           if allowed.is_a?(IPAddr)",
          "41:             begin",
          "42:               allowed === extract_hostname(host)",
          "43:             rescue",
          "44:               # IPAddr#=== raises an error if you give it a hostname instead of",
          "45:               # IP. Treat similar errors as blocked access.",
          "46:               false",
          "47:             end",
          "48:           else",
          "49:             allowed === host",
          "50:           end",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "49:         end",
          "51:         def sanitize_regexp(host)",
          "53:         end",
          "55:         def sanitize_string(host)",
          "56:           if host.start_with?(\".\")",
          "58:           else",
          "60:           end",
          "61:         end",
          "62:     end",
          "64:     DEFAULT_RESPONSE_APP = -> env do",
          "",
          "[Removed Lines]",
          "52:           /\\A#{host}#{PORT_REGEX}\\z/",
          "57:             /\\A([a-z0-9-]+\\.)?#{Regexp.escape(host[1..-1])}#{PORT_REGEX}\\z/i",
          "59:             /\\A#{Regexp.escape host}#{PORT_REGEX}\\z/i",
          "",
          "[Added Lines]",
          "66:           /\\A#{host}#{PORT_REGEX}?\\z/",
          "71:             /\\A([a-z0-9-]+\\.)?#{Regexp.escape(host[1..-1])}#{PORT_REGEX}?\\z/i",
          "73:             /\\A#{Regexp.escape host}#{PORT_REGEX}?\\z/i",
          "77:         def extract_hostname(host)",
          "78:           host.slice(VALID_IP_HOSTNAME, \"host\") || host",
          "79:         end",
          "",
          "---------------"
        ],
        "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb": [
          "File: actionpack/test/dispatch/host_authorization_test.rb -> actionpack/test/dispatch/host_authorization_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "155:     assert_match \"Success\", response.body",
          "156:   end",
          "158:   test \"hosts with port works\" do",
          "159:     @app = ActionDispatch::HostAuthorization.new(App, [\"host.test\"])",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "158:   test \"localhost using IPV4 works in dev\" do",
          "159:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "161:     get \"/\", env: {",
          "162:       \"HOST\" => \"127.0.0.1\",",
          "163:       \"action_dispatch.show_detailed_exceptions\" => true",
          "164:     }",
          "166:     assert_response :ok",
          "167:     assert_match \"Success\", response.body",
          "168:   end",
          "170:   test \"localhost using IPV4 with port works in dev\" do",
          "171:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "173:     get \"/\", env: {",
          "174:       \"HOST\" => \"127.0.0.1:3000\",",
          "175:       \"action_dispatch.show_detailed_exceptions\" => true",
          "176:     }",
          "178:     assert_response :ok",
          "179:     assert_match \"Success\", response.body",
          "180:   end",
          "182:   test \"localhost using IPV4 binding in all addresses works in dev\" do",
          "183:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "185:     get \"/\", env: {",
          "186:       \"HOST\" => \"0.0.0.0\",",
          "187:       \"action_dispatch.show_detailed_exceptions\" => true",
          "188:     }",
          "190:     assert_response :ok",
          "191:     assert_match \"Success\", response.body",
          "192:   end",
          "194:   test \"localhost using IPV4 with port binding in all addresses works in dev\" do",
          "195:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "197:     get \"/\", env: {",
          "198:       \"HOST\" => \"0.0.0.0:3000\",",
          "199:       \"action_dispatch.show_detailed_exceptions\" => true",
          "200:     }",
          "202:     assert_response :ok",
          "203:     assert_match \"Success\", response.body",
          "204:   end",
          "206:   test \"localhost using IPV6 works in dev\" do",
          "207:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "209:     get \"/\", env: {",
          "210:       \"HOST\" => \"::1\",",
          "211:       \"action_dispatch.show_detailed_exceptions\" => true",
          "212:     }",
          "214:     assert_response :ok",
          "215:     assert_match \"Success\", response.body",
          "216:   end",
          "218:   test \"localhost using IPV6 with port works in dev\" do",
          "219:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "221:     get \"/\", env: {",
          "222:       \"HOST\" => \"[::1]:3000\",",
          "223:       \"action_dispatch.show_detailed_exceptions\" => true",
          "224:     }",
          "226:     assert_response :ok",
          "227:     assert_match \"Success\", response.body",
          "228:   end",
          "230:   test \"localhost using IPV6 binding in all addresses works in dev\" do",
          "231:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "233:     get \"/\", env: {",
          "234:       \"HOST\" => \"::\",",
          "235:       \"action_dispatch.show_detailed_exceptions\" => true",
          "236:     }",
          "238:     assert_response :ok",
          "239:     assert_match \"Success\", response.body",
          "240:   end",
          "242:   test \"localhost using IPV6 with port binding in all addresses works in dev\" do",
          "243:     @app = ActionDispatch::HostAuthorization.new(App, ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT)",
          "245:     get \"/\", env: {",
          "246:       \"HOST\" => \"[::]:3000\",",
          "247:       \"action_dispatch.show_detailed_exceptions\" => true",
          "248:     }",
          "250:     assert_response :ok",
          "251:     assert_match \"Success\", response.body",
          "252:   end",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "056cb0c1a8d049d55d273ed184eb7a1554c79396",
      "candidate_info": {
        "commit_hash": "056cb0c1a8d049d55d273ed184eb7a1554c79396",
        "repo": "rails/rails",
        "commit_url": "https://github.com/rails/rails/commit/056cb0c1a8d049d55d273ed184eb7a1554c79396",
        "files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb",
          "railties/lib/rails/application/configuration.rb"
        ],
        "message": "Merge pull request #43871 from rails/rm-fix-hosts-with-port\n\nAllow any allowed host with port",
        "before_after_code_files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb",
          "railties/lib/rails/application/configuration.rb||railties/lib/rails/application/configuration.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ],
          "candidate": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
          "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "15:   # application will be executed and rendered. If no +response_app+ is given, a",
          "16:   # default one will run, which responds with <tt>403 Forbidden</tt>.",
          "17:   class HostAuthorization",
          "20:     class Permissions # :nodoc:",
          "21:       def initialize(hosts)",
          "",
          "[Removed Lines]",
          "18:     ALLOWED_HOSTS_IN_DEVELOPMENT = [\".localhost\", /\\A([a-z0-9-]+\\.)?localhost:\\d+\\z/, IPAddr.new(\"0.0.0.0/0\"), IPAddr.new(\"::/0\")]",
          "",
          "[Added Lines]",
          "18:     ALLOWED_HOSTS_IN_DEVELOPMENT = [\".localhost\", IPAddr.new(\"0.0.0.0/0\"), IPAddr.new(\"::/0\")]",
          "19:     PORT_REGEX = /(?::\\d+)?/.freeze",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "48:         end",
          "50:         def sanitize_regexp(host)",
          "52:         end",
          "54:         def sanitize_string(host)",
          "55:           if host.start_with?(\".\")",
          "57:           else",
          "59:           end",
          "60:         end",
          "61:     end",
          "",
          "[Removed Lines]",
          "51:           /\\A#{host}\\z/",
          "56:             /\\A([a-z0-9-]+\\.)?#{Regexp.escape(host[1..-1])}\\z/i",
          "58:             /\\A#{Regexp.escape host}\\z/i",
          "",
          "[Added Lines]",
          "52:           /\\A#{host}#{PORT_REGEX}\\z/",
          "57:             /\\A([a-z0-9-]+\\.)?#{Regexp.escape(host[1..-1])}#{PORT_REGEX}\\z/i",
          "59:             /\\A#{Regexp.escape host}#{PORT_REGEX}\\z/i",
          "",
          "---------------"
        ],
        "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb": [
          "File: actionpack/test/dispatch/host_authorization_test.rb -> actionpack/test/dispatch/host_authorization_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "155:     assert_match \"Success\", response.body",
          "156:   end",
          "158:   test \"blocks requests with spoofed X-FORWARDED-HOST\" do",
          "159:     @app = ActionDispatch::HostAuthorization.new(App, [IPAddr.new(\"127.0.0.1\")])",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "158:   test \"hosts with port works\" do",
          "159:     @app = ActionDispatch::HostAuthorization.new(App, [\"host.test\"])",
          "161:     get \"/\", env: {",
          "162:       \"HOST\" => \"host.test:3000\",",
          "163:       \"action_dispatch.show_detailed_exceptions\" => true",
          "164:     }",
          "166:     assert_response :ok",
          "167:     assert_match \"Success\", response.body",
          "168:   end",
          "",
          "---------------"
        ],
        "railties/lib/rails/application/configuration.rb||railties/lib/rails/application/configuration.rb": [
          "File: railties/lib/rails/application/configuration.rb -> railties/lib/rails/application/configuration.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:         @filter_parameters                       = []",
          "35:         @filter_redirect                         = []",
          "36:         @helpers_paths                           = []",
          "38:         @host_authorization                      = {}",
          "39:         @public_file_server                      = ActiveSupport::OrderedOptions.new",
          "40:         @public_file_server.enabled              = true",
          "",
          "[Removed Lines]",
          "37:         @hosts                                   = Rails.env.development? ? ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT : []",
          "",
          "[Added Lines]",
          "37:         if Rails.env.development?",
          "38:           @hosts = ActionDispatch::HostAuthorization::ALLOWED_HOSTS_IN_DEVELOPMENT.dup",
          "39:         else",
          "40:           @hosts = []",
          "41:         end",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5e9973d6e020b98a5ec71578aa1837efcf4d7b7e",
      "candidate_info": {
        "commit_hash": "5e9973d6e020b98a5ec71578aa1837efcf4d7b7e",
        "repo": "rails/rails",
        "commit_url": "https://github.com/rails/rails/commit/5e9973d6e020b98a5ec71578aa1837efcf4d7b7e",
        "files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb",
          "railties/test/application/middleware/remote_ip_test.rb",
          "railties/test/isolation/abstract_unit.rb"
        ],
        "message": "Refactor CVE-2021-22881 fix\n\nFollow-up to 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f.\n\nThis allows `HTTP_HOST` to be omitted as before, and reduces the number\nof object allocations per request.\n\nBenchmark:\n\n```ruby\n # frozen_string_literal: true\nrequire \"benchmark/memory\"\n\nHOST = \"example.com:80\"\nBEFORE_REGEXP = /\\A(?<host>[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\])(:\\d+)?\\z/\nAFTER_REGEXP = /(?:\\A|,[ ]?)([a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\])(?::\\d+)?\\z/i\n\nBenchmark.memory do |x|\n  x.report(\"BEFORE (non-nil X-Forwarded-Host)\") do\n    origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]\n    forwarded_host = BEFORE_REGEXP.match(HOST.to_s.split(/,\\s?/).last)[:host]\n  end\n\n  x.report(\"BEFORE (nil X-Forwarded-Host)\") do\n    origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]\n    forwarded_host = BEFORE_REGEXP.match(nil.to_s.split(/,\\s?/).last)\n  end\n\n  x.report(\"AFTER (non-nil X-Forwarded-Host)\") do\n    origin_host = HOST&.slice(AFTER_REGEXP, 1) || \"\"\n    forwarded_host = HOST&.slice(AFTER_REGEXP, 1) || \"\"\n  end\n\n  x.report(\"AFTER (nil X-Forwarded-Host)\") do\n    origin_host = HOST&.slice(AFTER_REGEXP, 1) || \"\"\n    forwarded_host = nil&.slice(AFTER_REGEXP, 1) || \"\"\n  end\nend\n```\n\nResults:\n\n```\nBEFORE (non-nil X-Forwarded-Host)\n                       616.000  memsize (   208.000  retained)\n                         9.000  objects (     2.000  retained)\n                         2.000  strings (     1.000  retained)\nBEFORE (nil X-Forwarded-Host)\n                       328.000  memsize (     0.000  retained)\n                         5.000  objects (     0.000  retained)\n                         2.000  strings (     0.000  retained)\nAFTER (non-nil X-Forwarded-Host)\n                       248.000  memsize (   168.000  retained)\n                         3.000  objects (     1.000  retained)\n                         1.000  strings (     0.000  retained)\nAFTER (nil X-Forwarded-Host)\n                        40.000  memsize (     0.000  retained)\n                         1.000  objects (     0.000  retained)\n                         1.000  strings (     0.000  retained)\n```\n\n[CVE-2021-22942]",
        "before_after_code_files": [
          "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb",
          "railties/test/application/middleware/remote_ip_test.rb||railties/test/application/middleware/remote_ip_test.rb",
          "railties/test/isolation/abstract_unit.rb||railties/test/isolation/abstract_unit.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ],
          "candidate": [
            "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb",
            "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "actionpack/lib/action_dispatch/middleware/host_authorization.rb||actionpack/lib/action_dispatch/middleware/host_authorization.rb": [
          "File: actionpack/lib/action_dispatch/middleware/host_authorization.rb -> actionpack/lib/action_dispatch/middleware/host_authorization.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:     end",
          "104:     private",
          "105:       def authorized?(request)",
          "120:       end",
          "122:       def excluded?(request)",
          "",
          "[Removed Lines]",
          "106:         valid_host = /",
          "107:           \\A",
          "108:           (?<host>[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\])",
          "109:           (:\\d+)?",
          "110:           \\z",
          "111:         /x",
          "113:         origin_host = valid_host.match(",
          "114:           request.get_header(\"HTTP_HOST\").to_s.downcase)",
          "115:         forwarded_host = valid_host.match(",
          "116:           request.x_forwarded_host.to_s.split(/,\\s?/).last)",
          "118:         origin_host && @permissions.allows?(origin_host[:host]) && (",
          "119:           forwarded_host.nil? || @permissions.allows?(forwarded_host[:host]))",
          "",
          "[Added Lines]",
          "105:       HOSTNAME = /[a-z0-9.-]+|\\[[a-f0-9]*:[a-f0-9.:]+\\]/i",
          "106:       VALID_ORIGIN_HOST = /\\A(#{HOSTNAME})(?::\\d+)?\\z/",
          "107:       VALID_FORWARDED_HOST = /(?:\\A|,[ ]?)(#{HOSTNAME})(?::\\d+)?\\z/",
          "110:         origin_host = request.get_header(\"HTTP_HOST\")&.slice(VALID_ORIGIN_HOST, 1) || \"\"",
          "111:         forwarded_host = request.x_forwarded_host&.slice(VALID_FORWARDED_HOST, 1) || \"\"",
          "113:         @permissions.allows?(origin_host) && (forwarded_host.blank? || @permissions.allows?(forwarded_host))",
          "",
          "---------------"
        ],
        "actionpack/test/dispatch/host_authorization_test.rb||actionpack/test/dispatch/host_authorization_test.rb": [
          "File: actionpack/test/dispatch/host_authorization_test.rb -> actionpack/test/dispatch/host_authorization_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "221:     assert_match \"Blocked host: www.example.com\", response.body",
          "222:   end",
          "225:     @app = ActionDispatch::HostAuthorization.new(App, \".example.com\")",
          "227:     get \"/\", env: {",
          "229:     }",
          "231:     assert_response :forbidden",
          "233:   end",
          "235:   test \"blocks requests to similar host\" do",
          "",
          "[Removed Lines]",
          "224:   test \"only compare to valid hostnames\" do",
          "228:       \"HOST\" => \"example.com#sub.example.com\",",
          "232:     assert_match \"Blocked host: example.com#sub.example.com\", response.body",
          "",
          "[Added Lines]",
          "224:   test \"blocks requests with invalid hostnames\" do",
          "228:       \"HOST\" => \"attacker.com#x.example.com\",",
          "232:     assert_match \"Blocked host: attacker.com#x.example.com\", response.body",
          "",
          "---------------"
        ],
        "railties/test/application/middleware/remote_ip_test.rb||railties/test/application/middleware/remote_ip_test.rb": [
          "File: railties/test/application/middleware/remote_ip_test.rb -> railties/test/application/middleware/remote_ip_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:     def remote_ip(env = {})",
          "12:       remote_ip = nil",
          "13:       env = Rack::MockRequest.env_for(\"/\").merge(env).merge!(",
          "15:         \"action_dispatch.show_exceptions\" => false,",
          "16:         \"action_dispatch.key_generator\" => ActiveSupport::CachingKeyGenerator.new(",
          "17:           ActiveSupport::KeyGenerator.new(\"b3c631c314c0bbca50c1b2843150fe33\", iterations: 1000)",
          "",
          "[Removed Lines]",
          "14:         \"HTTP_HOST\" => \"example.com\",",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "railties/test/isolation/abstract_unit.rb||railties/test/isolation/abstract_unit.rb": [
          "File: railties/test/isolation/abstract_unit.rb -> railties/test/isolation/abstract_unit.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:     end",
          "84:     def get(path)",
          "86:     end",
          "88:     def assert_welcome(resp)",
          "",
          "[Removed Lines]",
          "85:       @app.call(::Rack::MockRequest.env_for(path, \"HTTP_HOST\" => \"example.com\"))",
          "",
          "[Added Lines]",
          "85:       @app.call(::Rack::MockRequest.env_for(path))",
          "",
          "---------------"
        ]
      }
    }
  ]
}