{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d547735f2f44285e6547b9b4c2111469838c4812",
      "candidate_info": {
        "commit_hash": "d547735f2f44285e6547b9b4c2111469838c4812",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d547735f2f44285e6547b9b4c2111469838c4812",
        "files": [
          "version.php"
        ],
        "message": "weekly back-to-dev release 3.9dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019111800.00;              // 20191118      = branching date YYYYMMDD - do not modify!",
          "35: $release  = '3.8 (Build: 20191118)'; // Human-friendly version name",
          "36: $branch   = '38';                       // This version's branch.",
          "37: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "[Added Lines]",
          "32: $version  = 2019111800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "35: $release  = '3.9dev (Build: 20191118)'; // Human-friendly version name",
          "36: $branch   = '39';                       // This version's branch.",
          "37: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e78849e8377896674b74ea14b7e7c222d28526db",
      "candidate_info": {
        "commit_hash": "e78849e8377896674b74ea14b7e7c222d28526db",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e78849e8377896674b74ea14b7e7c222d28526db",
        "files": [
          "blocks/html/backup/moodle1/lib.php",
          "lib/db/upgrade.php",
          "lib/db/upgradelib.php",
          "version.php"
        ],
        "message": "MDL-61268 blocks: Fix corrupt configdata in block instances.\n\nOld configuration data in the block instances is base64 encoded with\nthe deprecated object class instead of stdClass.",
        "before_after_code_files": [
          "blocks/html/backup/moodle1/lib.php||blocks/html/backup/moodle1/lib.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/db/upgradelib.php||lib/db/upgradelib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "blocks/html/backup/moodle1/lib.php||blocks/html/backup/moodle1/lib.php": [
          "File: blocks/html/backup/moodle1/lib.php -> blocks/html/backup/moodle1/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: class moodle1_block_html_handler extends moodle1_block_handler {",
          "31:     private $fileman = null;",
          "32:     protected function convert_configdata(array $olddata) {",
          "33:         $instanceid = $olddata['id'];",
          "34:         $contextid  = $this->converter->get_contextid(CONTEXT_BLOCK, $olddata['id']);",
          "38:         $this->fileman = $this->converter->get_file_manager($contextid, 'block_html');",
          "",
          "[Removed Lines]",
          "35:         $configdata = unserialize(base64_decode($olddata['configdata']));",
          "",
          "[Added Lines]",
          "33:         global $CFG;",
          "34:         require_once($CFG->libdir . '/db/upgradelib.php');",
          "37:         $decodeddata = base64_decode($olddata['configdata']);",
          "38:         list($updated, $configdata) = upgrade_fix_serialized_objects($decodeddata);",
          "39:         $configdata = unserialize($configdata);",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1973:         upgrade_main_savepoint(true, 2018020500.00);",
          "1974:     }",
          "1976:     return true;",
          "1977: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1976:     if ($oldversion < 2018022800.01) {",
          "1979:         upgrade_fix_block_instance_configuration();",
          "1982:         upgrade_main_savepoint(true, 2018022800.01);",
          "1983:     }",
          "",
          "---------------"
        ],
        "lib/db/upgradelib.php||lib/db/upgradelib.php": [
          "File: lib/db/upgradelib.php -> lib/db/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "502:     WHERE pagetype IN ('my-index', 'user-profile') AND subpage NOT IN (SELECT $id FROM {my_pages})\";",
          "503:     $DB->execute($sql, ['']);",
          "504: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "509: function upgrade_fix_block_instance_configuration() {",
          "510:     global $DB;",
          "512:     $sql = \"SELECT *",
          "513:               FROM {block_instances}",
          "514:              WHERE configdata <> ''\";",
          "515:     $blockinstances = $DB->get_recordset_sql($sql);",
          "516:     foreach ($blockinstances as $blockinstance) {",
          "517:         $configdata = base64_decode($blockinstance->configdata);",
          "518:         list($updated, $configdata) = upgrade_fix_serialized_objects($configdata);",
          "519:         if ($updated) {",
          "520:             $blockinstance->configdata = base64_encode($configdata);",
          "521:             $DB->update_record('block_instances', $blockinstance);",
          "522:         }",
          "523:     }",
          "524:     $blockinstances->close();",
          "525: }",
          "534: function upgrade_fix_serialized_objects($serializeddata) {",
          "535:     $updated = false;",
          "536:     if (strpos($serializeddata, \":6:\\\"object\") !== false) {",
          "537:         $serializeddata = str_replace(\":6:\\\"object\", \":8:\\\"stdClass\", $serializeddata);",
          "538:         $updated = true;",
          "539:     }",
          "540:     return [$updated, $serializeddata];",
          "541: }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018022800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018022800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ef05f29267d95d7bb27f1401a38228a5fb3f48c2",
      "candidate_info": {
        "commit_hash": "ef05f29267d95d7bb27f1401a38228a5fb3f48c2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ef05f29267d95d7bb27f1401a38228a5fb3f48c2",
        "files": [
          "admin/tool/analytics/model.php",
          "analytics/classes/model.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-67038 analytics: Remove null strings from the DB",
        "before_after_code_files": [
          "admin/tool/analytics/model.php||admin/tool/analytics/model.php",
          "analytics/classes/model.php||analytics/classes/model.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/analytics/model.php||admin/tool/analytics/model.php": [
          "File: admin/tool/analytics/model.php -> admin/tool/analytics/model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "159:                 $predictionsprocessor = false;",
          "160:             }",
          "162:             $model->update($data->enabled, $indicators, $timesplitting, $predictionsprocessor, $data->contexts);",
          "163:             redirect($returnurl);",
          "164:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "162:             if (!isset($data->contexts)) {",
          "163:                 $data->contexts = null;",
          "164:             }",
          "",
          "---------------"
        ],
        "analytics/classes/model.php||analytics/classes/model.php": [
          "File: analytics/classes/model.php -> analytics/classes/model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "493:             $predictionsprocessor = $this->model->predictionsprocessor;",
          "494:         }",
          "497:             $contextsstr = json_encode($contextids);",
          "500:             $this->contexts = null;",
          "503:         }",
          "505:         if ($this->model->timesplitting !== $timesplittingid ||",
          "",
          "[Removed Lines]",
          "496:         if ($contextids !== false) {",
          "501:         } else {",
          "502:             $contextsstr = $this->model->contextids;",
          "",
          "[Added Lines]",
          "496:         if ($contextids === false) {",
          "497:             $contextsstr = $this->model->contextids;",
          "498:         } else if (!$contextids) {",
          "499:             $contextsstr = null;",
          "500:         } else {",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3754:         upgrade_main_savepoint(true, 2019102500.04);",
          "3755:     }",
          "3757:     return true;",
          "3758: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3757:     if ($oldversion < 2019103000.13) {",
          "3759:         $DB->execute(\"UPDATE {analytics_models} set contextids = null",
          "3760:                        WHERE contextids = :zero or contextids = :null\", ['zero' => '0', 'null' => 'null']);",
          "3763:         upgrade_main_savepoint(true, 2019103000.13);",
          "3764:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019103000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019103000.13;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1287039e621c5aed299ee812baa1b83ced887c65",
      "candidate_info": {
        "commit_hash": "1287039e621c5aed299ee812baa1b83ced887c65",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1287039e621c5aed299ee812baa1b83ced887c65",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018022800.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180228)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018030800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180308)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "365dce5fad6a08402adabeb1a79afa6ced4f99a0",
      "candidate_info": {
        "commit_hash": "365dce5fad6a08402adabeb1a79afa6ced4f99a0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/365dce5fad6a08402adabeb1a79afa6ced4f99a0",
        "files": [
          "lib/classes/oauth2/access_token.php",
          "lib/classes/oauth2/client.php",
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "lib/oauthlib.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-63696-master' of https://github.com/Dagefoerde/moodle",
        "before_after_code_files": [
          "lib/classes/oauth2/access_token.php||lib/classes/oauth2/access_token.php",
          "lib/classes/oauth2/client.php||lib/classes/oauth2/client.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/oauthlib.php||lib/oauthlib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/classes/oauth2/access_token.php||lib/classes/oauth2/access_token.php": [
          "File: lib/classes/oauth2/access_token.php -> lib/classes/oauth2/access_token.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace core\\oauth2;",
          "26: defined('MOODLE_INTERNAL') || die();",
          "28: use core\\persistent;",
          "43: class access_token extends persistent {",
          "46:     const TABLE = 'oauth2_access_token';",
          "53:     protected static function define_properties() {",
          "54:         return array(",
          "57:             'issuerid' => array(",
          "58:                 'type' => PARAM_INT",
          "59:             ),",
          "60:             'token' => array(",
          "61:                 'type' => PARAM_RAW,",
          "62:             ),",
          "63:             'expires' => array(",
          "64:                 'type' => PARAM_INT,",
          "65:             ),",
          "66:             'scope' => array(",
          "67:                 'type' => PARAM_RAW,",
          "68:             ),",
          "69:         );",
          "70:     }",
          "71: }",
          "",
          "---------------"
        ],
        "lib/classes/oauth2/client.php||lib/classes/oauth2/client.php": [
          "File: lib/classes/oauth2/client.php -> lib/classes/oauth2/client.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:         return $name;",
          "153:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "161:     protected function store_token($token) {",
          "162:         if (!$this->system) {",
          "163:             parent::store_token($token);",
          "164:             return;",
          "165:         }",
          "167:         $this->accesstoken = $token;",
          "170:         $persistedtoken = access_token::get_record(['issuerid' => $this->issuer->get('id')]);",
          "171:         if ($token !== null) {",
          "172:             if (!$persistedtoken) {",
          "173:                 $persistedtoken = new access_token();",
          "174:                 $persistedtoken->set('issuerid', $this->issuer->get('id'));",
          "175:             }",
          "177:             $persistedtoken->set('token', $token->token);",
          "178:             $persistedtoken->set('expires', $token->expires);",
          "179:             $persistedtoken->set('scope', $token->scope);",
          "180:             $persistedtoken->save();",
          "181:         } else {",
          "182:             if ($persistedtoken) {",
          "183:                 $persistedtoken->delete();",
          "184:             }",
          "185:         }",
          "186:     }",
          "193:     protected function get_stored_token() {",
          "194:         if ($this->system) {",
          "195:             $token = access_token::get_record(['issuerid' => $this->issuer->get('id')]);",
          "196:             if ($token !== false) {",
          "197:                 return $token->to_record();",
          "198:             }",
          "199:             return null;",
          "200:         }",
          "202:         return parent::get_stored_token();",
          "203:     }",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2807:         upgrade_main_savepoint(true, 2018111900.00);",
          "2808:     }",
          "2810:     return true;",
          "2811: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2810:     if ($oldversion < 2018111900.01) {",
          "2812:         $table = new xmldb_table('oauth2_access_token');",
          "2815:         $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);",
          "2816:         $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2817:         $table->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2818:         $table->add_field('usermodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2819:         $table->add_field('issuerid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2820:         $table->add_field('token', XMLDB_TYPE_TEXT, null, null, XMLDB_NOTNULL, null, null);",
          "2821:         $table->add_field('expires', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2822:         $table->add_field('scope', XMLDB_TYPE_TEXT, null, null, XMLDB_NOTNULL, null, null);",
          "2825:         $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);",
          "2826:         $table->add_key('issueridkey', XMLDB_KEY_FOREIGN_UNIQUE, ['issuerid'], 'oauth2_issuer', ['id']);",
          "2829:         if (!$dbman->table_exists($table)) {",
          "2830:             $dbman->create_table($table);",
          "2831:         }",
          "2834:         upgrade_main_savepoint(true, 2018111900.01);",
          "2835:     }",
          "",
          "---------------"
        ],
        "lib/oauthlib.php||lib/oauthlib.php": [
          "File: lib/oauthlib.php -> lib/oauthlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "397:     protected $scope = '';",
          "401:     protected $refreshtoken = '';",
          "",
          "[Removed Lines]",
          "399:     private $accesstoken = null;",
          "",
          "[Added Lines]",
          "399:     protected $accesstoken = null;",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018111900.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}