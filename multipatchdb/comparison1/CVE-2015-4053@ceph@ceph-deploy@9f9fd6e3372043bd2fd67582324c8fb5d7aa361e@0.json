{
  "cve_id": "CVE-2015-4053",
  "cve_desc": "The admin command in ceph-deploy before 1.5.25 uses world-readable permissions for /etc/ceph/ceph.client.admin.keyring, which allows local users to obtain sensitive information by reading the file.",
  "repo": "ceph/ceph-deploy",
  "patch_hash": "9f9fd6e3372043bd2fd67582324c8fb5d7aa361e",
  "patch_info": {
    "commit_hash": "9f9fd6e3372043bd2fd67582324c8fb5d7aa361e",
    "repo": "ceph/ceph-deploy",
    "commit_url": "https://github.com/ceph/ceph-deploy/commit/9f9fd6e3372043bd2fd67582324c8fb5d7aa361e",
    "files": [
      "ceph_deploy/admin.py",
      "ceph_deploy/hosts/remotes.py",
      "ceph_deploy/tests/test_cli_admin.py"
    ],
    "message": "Merge pull request #300 from trhoden/RM-11694-admin-perms\n\nFix CVE-2015-4053 world-readable permissions on client.admin key\n\nReviewed-by: Dan Mick <dmick@redhat.com>\nReviewed-by: Sage Weil <sweil@redhat.com>",
    "before_after_code_files": [
      "ceph_deploy/admin.py||ceph_deploy/admin.py",
      "ceph_deploy/hosts/remotes.py||ceph_deploy/hosts/remotes.py",
      "ceph_deploy/tests/test_cli_admin.py||ceph_deploy/tests/test_cli_admin.py"
    ]
  },
  "patch_diff": {
    "ceph_deploy/admin.py||ceph_deploy/admin.py": [
      "File: ceph_deploy/admin.py -> ceph_deploy/admin.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "27:         LOG.debug('Pushing admin keys and conf to %s', hostname)",
      "28:         try:",
      "29:             distro = hosts.get(hostname, username=args.username)",
      "32:             distro.conn.remote_module.write_conf(",
      "33:                 args.cluster,",
      "",
      "[Removed Lines]",
      "30:             hostname = distro.conn.remote_module.shortname()",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "38:             distro.conn.remote_module.write_file(",
      "39:                 '/etc/ceph/%s.client.admin.keyring' % args.cluster,",
      "41:             )",
      "43:             distro.conn.exit()",
      "",
      "[Removed Lines]",
      "40:                 keyring",
      "",
      "[Added Lines]",
      "39:                 keyring,",
      "40:                 0600,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "58:     parser.add_argument(",
      "59:         'client',",
      "60:         metavar='HOST',",
      "62:         help='host to configure for ceph administration',",
      "63:         )",
      "64:     parser.set_defaults(",
      "",
      "[Removed Lines]",
      "61:         nargs='*',",
      "",
      "[Added Lines]",
      "61:         nargs='+',",
      "",
      "---------------"
    ],
    "ceph_deploy/hosts/remotes.py||ceph_deploy/hosts/remotes.py": [
      "File: ceph_deploy/hosts/remotes.py -> ceph_deploy/hosts/remotes.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "200:     write_file(keyring, monitor_keyring)",
      "205:         f.write(content)",
      "",
      "[Removed Lines]",
      "203: def write_file(path, content):",
      "204:     with file(path, 'w') as f:",
      "",
      "[Added Lines]",
      "203: def write_file(path, content, mode=0644, directory=None):",
      "204:     if directory:",
      "205:         if path.startswith(\"/\"):",
      "206:             path = path[1:]",
      "207:         path = os.path.join(directory, path)",
      "208:     with os.fdopen(os.open(path, os.O_WRONLY | os.O_CREAT, mode), 'w') as f:",
      "",
      "---------------"
    ],
    "ceph_deploy/tests/test_cli_admin.py||ceph_deploy/tests/test_cli_admin.py": [
      "File: ceph_deploy/tests/test_cli_admin.py -> ceph_deploy/tests/test_cli_admin.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: import os",
      "2: import subprocess",
      "4: import pytest",
      "5: from mock import patch, MagicMock, Mock",
      "7: from ceph_deploy.cli import _main as main",
      "8: from ceph_deploy.hosts import remotes",
      "9: from ceph_deploy.tests.directory import directory",
      "11: def test_help(tmpdir, cli):",
      "12:     with cli(",
      "13:         args=['ceph-deploy', 'admin', '--help'],",
      "14:         stdout=subprocess.PIPE,",
      "15:         ) as p:",
      "16:         result = p.stdout.read()",
      "17:     assert 'usage: ceph-deploy admin' in result",
      "18:     assert 'positional arguments' in result",
      "19:     assert 'optional arguments' in result",
      "22: def test_bad_no_hosts(tmpdir, cli):",
      "23:     with pytest.raises(cli.Failed) as err:",
      "24:         with cli(",
      "25:             args=['ceph-deploy', 'admin'],",
      "26:             stderr=subprocess.PIPE,",
      "27:             ) as p:",
      "28:             result = p.stderr.read()",
      "29:     assert 'usage: ceph-deploy admin' in result",
      "30:     assert 'too few arguments' in result",
      "31:     assert err.value.status == 2",
      "34: def test_bad_no_conf(tmpdir, cli):",
      "35:     with pytest.raises(cli.Failed) as err:",
      "36:         with cli(",
      "37:             args=['ceph-deploy', 'admin', 'host1'],",
      "38:             stderr=subprocess.PIPE,",
      "39:             ) as p:",
      "40:             result = p.stderr.read()",
      "41:     assert 'No such file or directory: \\'ceph.conf\\'' in result",
      "42:     assert err.value.status == 1",
      "45: def test_bad_no_key(tmpdir, cli):",
      "46:     with tmpdir.join('ceph.conf').open('w'):",
      "47:         pass",
      "48:     with pytest.raises(cli.Failed) as err:",
      "49:         with cli(",
      "50:             args=['ceph-deploy', 'admin', 'host1'],",
      "51:             stderr=subprocess.PIPE,",
      "52:             ) as p:",
      "53:             result = p.stderr.read()",
      "54:     assert 'ceph.client.admin.keyring not found' in result",
      "55:     assert err.value.status == 1",
      "58: def test_write_keyring(tmpdir):",
      "59:     with tmpdir.join('ceph.conf').open('w'):",
      "60:         pass",
      "61:     with tmpdir.join('ceph.client.admin.keyring').open('w'):",
      "62:         pass",
      "64:     etc_ceph = os.path.join(str(tmpdir), 'etc', 'ceph')",
      "65:     os.makedirs(etc_ceph)",
      "67:     distro = MagicMock()",
      "68:     distro.conn = MagicMock()",
      "69:     remotes.write_file.func_defaults = (str(tmpdir),)",
      "70:     distro.conn.remote_module = remotes",
      "71:     distro.conn.remote_module.write_conf = Mock()",
      "73:     with patch('ceph_deploy.admin.hosts'):",
      "74:         with patch('ceph_deploy.admin.hosts.get', MagicMock(return_value=distro)):",
      "75:             with directory(str(tmpdir)):",
      "76:                 main(args=['admin', 'host1'])",
      "78:     keyring_file = os.path.join(etc_ceph, 'ceph.client.admin.keyring')",
      "79:     assert os.path.exists(keyring_file)",
      "81:     file_mode = oct(os.stat(keyring_file).st_mode & 0777)",
      "82:     assert file_mode == oct(0600)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f898b4cf44abc1f7fe472b59e009e6ff44e441a7",
      "candidate_info": {
        "commit_hash": "f898b4cf44abc1f7fe472b59e009e6ff44e441a7",
        "repo": "ceph/ceph-deploy",
        "commit_url": "https://github.com/ceph/ceph-deploy/commit/f898b4cf44abc1f7fe472b59e009e6ff44e441a7",
        "files": [
          "ceph_deploy/admin.py"
        ],
        "message": "[RM-11694] Always write admin keyring with mode 0600\n\nSigned-off-by: Travis Rhoden <trhoden@redhat.com>\n(cherry picked from commit 8ef6d41e5bdbaf2717671c1ace237d35fa8ebcb4)",
        "before_after_code_files": [
          "ceph_deploy/admin.py||ceph_deploy/admin.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "ceph_deploy/admin.py||ceph_deploy/admin.py"
          ],
          "candidate": [
            "ceph_deploy/admin.py||ceph_deploy/admin.py"
          ]
        }
      },
      "candidate_diff": {
        "ceph_deploy/admin.py||ceph_deploy/admin.py": [
          "File: ceph_deploy/admin.py -> ceph_deploy/admin.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:             distro.conn.remote_module.write_file(",
          "39:                 '/etc/ceph/%s.client.admin.keyring' % args.cluster,",
          "41:             )",
          "43:             distro.conn.exit()",
          "",
          "[Removed Lines]",
          "40:                 keyring",
          "",
          "[Added Lines]",
          "40:                 keyring,",
          "41:                 0600,",
          "",
          "---------------"
        ]
      }
    }
  ]
}