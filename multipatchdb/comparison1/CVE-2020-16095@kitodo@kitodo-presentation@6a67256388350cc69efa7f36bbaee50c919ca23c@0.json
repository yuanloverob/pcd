{
  "cve_id": "CVE-2020-16095",
  "cve_desc": "The dlf (aka Kitodo.Presentation) extension before 3.1.2 for TYPO3 allows XSS.",
  "repo": "kitodo/kitodo-presentation",
  "patch_hash": "6a67256388350cc69efa7f36bbaee50c919ca23c",
  "patch_info": {
    "commit_hash": "6a67256388350cc69efa7f36bbaee50c919ca23c",
    "repo": "kitodo/kitodo-presentation",
    "commit_url": "https://github.com/kitodo/kitodo-presentation/commit/6a67256388350cc69efa7f36bbaee50c919ca23c",
    "files": [
      "Classes/Plugin/ListView.php",
      "Classes/Plugin/Navigation.php"
    ],
    "message": "Fix XSS issue",
    "before_after_code_files": [
      "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php",
      "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php"
    ]
  },
  "patch_diff": {
    "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php": [
      "File: Classes/Plugin/ListView.php -> Classes/Plugin/ListView.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "268:         $sorting = '<form action=\"' . $this->cObj->typoLink_URL($linkConf) . '\" method=\"get\"><div><input type=\"hidden\" name=\"id\" value=\"' . $GLOBALS['TSFE']->id . '\" />';",
      "269:         foreach ($this->piVars as $piVar => $value) {",
      "270:             if ($piVar != 'order' && $piVar != 'DATA' && !empty($value)) {",
      "272:             }",
      "273:         }",
      "",
      "[Removed Lines]",
      "271:                 $sorting .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
      "",
      "[Added Lines]",
      "271:                 $sorting .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . preg_replace('/[^A-Za-z0-9_-]/', '', $piVar) . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
      "",
      "---------------"
    ],
    "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php": [
      "File: Classes/Plugin/Navigation.php -> Classes/Plugin/Navigation.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "74:         foreach ($this->piVars as $piVar => $value) {",
      "75:             if ($piVar != 'page' && $piVar != 'DATA' && !empty($value)) {",
      "77:             }",
      "78:         }",
      "",
      "[Removed Lines]",
      "76:                 $output .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
      "",
      "[Added Lines]",
      "76:                 $output .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . preg_replace('/[^A-Za-z0-9_-]/', '', $piVar) . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bbdd8f77f7a3b799e093a22a7c5ecfbd29a194b1",
      "candidate_info": {
        "commit_hash": "bbdd8f77f7a3b799e093a22a7c5ecfbd29a194b1",
        "repo": "kitodo/kitodo-presentation",
        "commit_url": "https://github.com/kitodo/kitodo-presentation/commit/bbdd8f77f7a3b799e093a22a7c5ecfbd29a194b1",
        "files": [
          "Documentation/Settings.cfg",
          "SECURITY.md",
          "ext_emconf.php"
        ],
        "message": "Update version information",
        "before_after_code_files": [
          "Documentation/Settings.cfg||Documentation/Settings.cfg",
          "ext_emconf.php||ext_emconf.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/kitodo/kitodo-presentation/pull/536"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Documentation/Settings.cfg||Documentation/Settings.cfg": [
          "File: Documentation/Settings.cfg -> Documentation/Settings.cfg",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: [general]",
          "2: project = Kitodo.Presentation",
          "4: copyright = since 2017 by Kitodo Release Management Team",
          "6: [html_theme_options]",
          "",
          "[Removed Lines]",
          "3: release = 3.1.0",
          "",
          "[Added Lines]",
          "3: release = 3.1.2",
          "",
          "---------------"
        ],
        "ext_emconf.php||ext_emconf.php": [
          "File: ext_emconf.php -> ext_emconf.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: $EM_CONF[$_EXTKEY] = [",
          "14:     'title' => 'Kitodo.Presentation',",
          "15:     'description' => 'Base plugins, modules, services and API of the Digital Library Framework. It is part of the community-based Kitodo Digitization Suite.',",
          "17:     'category' => 'misc',",
          "18:     'constraints' => [",
          "19:         'depends' => [",
          "",
          "[Removed Lines]",
          "16:     'version' => '3.1.1',",
          "",
          "[Added Lines]",
          "16:     'version' => '3.1.2',",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bbb2e41f86a4ca3f86321aadf75798d7b9689b33",
      "candidate_info": {
        "commit_hash": "bbb2e41f86a4ca3f86321aadf75798d7b9689b33",
        "repo": "kitodo/kitodo-presentation",
        "commit_url": "https://github.com/kitodo/kitodo-presentation/commit/bbb2e41f86a4ca3f86321aadf75798d7b9689b33",
        "files": [
          "Classes/Plugin/Basket.php"
        ],
        "message": "Mitigate potential backend attack",
        "before_after_code_files": [
          "Classes/Plugin/Basket.php||Classes/Plugin/Basket.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/kitodo/kitodo-presentation/pull/536"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Classes/Plugin/Basket.php||Classes/Plugin/Basket.php": [
          "File: Classes/Plugin/Basket.php -> Classes/Plugin/Basket.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:             $mailForm = '<select name=\"tx_dlf[mail_action]\">';",
          "167:             $mailForm .= '<option value=\"\">' . htmlspecialchars($this->pi_getLL('chooseMail', '')) . '</option>';",
          "168:             while ($row = $resultMail->fetch()) {",
          "170:             }",
          "171:             $mailForm .= '</select><input type=\"submit\">';",
          "172:         }",
          "",
          "[Removed Lines]",
          "169:                 $mailForm .= '<option value=\"' . $row['uid'] . '\">' . $row['name'] . ' (' . $row['mail'] . ')</option>';",
          "",
          "[Added Lines]",
          "169:                 $mailForm .= '<option value=\"' . $row['uid'] . '\">' . htmlspecialchars($row['name']) . ' (' . htmlspecialchars($row['mail']) . ')</option>';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "200:             $printForm = '<select name=\"tx_dlf[print_action]\">';",
          "201:             $printForm .= '<option value=\"\">' . htmlspecialchars($this->pi_getLL('choosePrinter', '')) . '</option>';",
          "202:             while ($row = $resultPrinter->fetch()) {",
          "204:             }",
          "205:             $printForm .= '</select><input type=\"submit\" />';",
          "206:         }",
          "",
          "[Removed Lines]",
          "203:                 $printForm .= '<option value=\"' . $row['uid'] . '\">' . $row['label'] . '</option>';",
          "",
          "[Added Lines]",
          "203:                 $printForm .= '<option value=\"' . $row['uid'] . '\">' . htmlspecialchars($row['label']) . '</option>';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "482:             $downloadUrl = $this->conf['pdfgenerate'] . $urlParams;",
          "483:             $title = $document->getTitle($id, true);",
          "484:             if (empty($title)) {",
          "486:             }",
          "488:             $info = '';",
          "",
          "[Removed Lines]",
          "485:                 $title = htmlspecialchars($this->pi_getLL('noTitle', ''));",
          "",
          "[Added Lines]",
          "485:                 $title = $this->pi_getLL('noTitle', '');",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "496:             } else {",
          "497:                 $info .= htmlspecialchars($this->pi_getLL('page', '')) . ' ' . $data['startpage'] . '-' . $data['endpage'];",
          "498:             }",
          "500:             if ($data['startpage'] == $data['endpage']) {",
          "501:                 $pageNums = 1;",
          "502:             } else {",
          "",
          "[Removed Lines]",
          "499:             $downloadLink = '<a href=\"' . $downloadUrl . '\" target=\"_blank\">' . $title . '</a> (' . $info . ')';",
          "",
          "[Added Lines]",
          "499:             $downloadLink = '<a href=\"' . $downloadUrl . '\" target=\"_blank\">' . htmlspecialchars($title) . '</a> (' . $info . ')';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "90ba416f10cbc7ace0a5e2b0c4b857c05f50bfb8",
      "candidate_info": {
        "commit_hash": "90ba416f10cbc7ace0a5e2b0c4b857c05f50bfb8",
        "repo": "kitodo/kitodo-presentation",
        "commit_url": "https://github.com/kitodo/kitodo-presentation/commit/90ba416f10cbc7ace0a5e2b0c4b857c05f50bfb8",
        "files": [
          "Classes/Plugin/ListView.php",
          "Classes/Plugin/Navigation.php",
          "Classes/Plugin/PageView.php"
        ],
        "message": "Sanitize URL parameters before adding them to form fields",
        "before_after_code_files": [
          "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php",
          "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php",
          "Classes/Plugin/PageView.php||Classes/Plugin/PageView.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php",
            "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php"
          ],
          "candidate": [
            "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php",
            "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php"
          ]
        }
      },
      "candidate_diff": {
        "Classes/Plugin/ListView.php||Classes/Plugin/ListView.php": [
          "File: Classes/Plugin/ListView.php -> Classes/Plugin/ListView.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:         $sorting = '<form action=\"' . $this->cObj->typoLink_URL($linkConf) . '\" method=\"get\"><div><input type=\"hidden\" name=\"id\" value=\"' . $GLOBALS['TSFE']->id . '\" />';",
          "269:         foreach ($this->piVars as $piVar => $value) {",
          "270:             if ($piVar != 'order' && $piVar != 'DATA' && !empty($value)) {",
          "272:             }",
          "273:         }",
          "",
          "[Removed Lines]",
          "271:                 $sorting .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . $value . '\" />';",
          "",
          "[Added Lines]",
          "271:                 $sorting .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "279:             $sorting .= '<option value=\"score\"' . (($this->list->metadata['options']['order'] == 'score') ? ' selected=\"selected\"' : '') . '>' . htmlspecialchars($this->pi_getLL('relevance', '')) . '</option>';",
          "280:         }",
          "281:         foreach ($this->sortables as $index_name => $label) {",
          "283:         }",
          "284:         $sorting .= '</select>';",
          "",
          "[Removed Lines]",
          "282:             $sorting .= '<option value=\"' . $index_name . '\"' . (($this->list->metadata['options']['order'] == $index_name) ? ' selected=\"selected\"' : '') . '>' . htmlspecialchars($label) . '</option>';",
          "",
          "[Added Lines]",
          "282:             $sorting .= '<option value=\"' . htmlspecialcahrs($index_name) . '\"' . (($this->list->metadata['options']['order'] == $index_name) ? ' selected=\"selected\"' : '') . '>' . htmlspecialchars($label) . '</option>';",
          "",
          "---------------"
        ],
        "Classes/Plugin/Navigation.php||Classes/Plugin/Navigation.php": [
          "File: Classes/Plugin/Navigation.php -> Classes/Plugin/Navigation.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "74:         foreach ($this->piVars as $piVar => $value) {",
          "75:             if ($piVar != 'page' && $piVar != 'DATA' && !empty($value)) {",
          "77:             }",
          "78:         }",
          "",
          "[Removed Lines]",
          "76:                 $output .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . $value . '\" />';",
          "",
          "[Added Lines]",
          "76:                 $output .= '<input type=\"hidden\" name=\"' . $this->prefixId . '[' . $piVar . ']\" value=\"' . htmlspecialchars($value) . '\" />';",
          "",
          "---------------"
        ],
        "Classes/Plugin/PageView.php||Classes/Plugin/PageView.php": [
          "File: Classes/Plugin/PageView.php -> Classes/Plugin/PageView.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "187:                 'title' => $label",
          "188:             ];",
          "189:             $output = '<form id=\"addToBasketForm\" action=\"' . $this->cObj->typoLink_URL($basketConf) . '\" method=\"post\">';",
          "192:             $output .= '<input type=\"hidden\" name=\"tx_dlf[startX]\" id=\"startX\">';",
          "193:             $output .= '<input type=\"hidden\" name=\"tx_dlf[startY]\" id=\"startY\">';",
          "194:             $output .= '<input type=\"hidden\" name=\"tx_dlf[endX]\" id=\"endX\">';",
          "",
          "[Removed Lines]",
          "190:             $output .= '<input type=\"hidden\" name=\"tx_dlf[startpage]\" id=\"startpage\" value=\"' . $this->piVars['page'] . '\">';",
          "191:             $output .= '<input type=\"hidden\" name=\"tx_dlf[endpage]\" id=\"endpage\" value=\"' . $this->piVars['page'] . '\">';",
          "",
          "[Added Lines]",
          "190:             $output .= '<input type=\"hidden\" name=\"tx_dlf[startpage]\" id=\"startpage\" value=\"' . htmlspecialchars($this->piVars['page']) . '\">';",
          "191:             $output .= '<input type=\"hidden\" name=\"tx_dlf[endpage]\" id=\"endpage\" value=\"' . htmlspecialchars($this->piVars['page']) . '\">';",
          "",
          "---------------"
        ]
      }
    }
  ]
}