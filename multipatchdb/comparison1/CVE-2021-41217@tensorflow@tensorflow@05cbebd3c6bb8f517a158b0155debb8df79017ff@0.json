{
  "cve_id": "CVE-2021-41217",
  "cve_desc": "TensorFlow is an open source platform for machine learning. In affected versions the process of building the control flow graph for a TensorFlow model is vulnerable to a null pointer exception when nodes that should be paired are not. This occurs because the code assumes that the first node in the pairing (e.g., an `Enter` node) always exists when encountering the second node (e.g., an `Exit` node). When this is not the case, `parent` is `nullptr` so dereferencing it causes a crash. The fix will be included in TensorFlow 2.7.0. We will also cherrypick this commit on TensorFlow 2.6.1, TensorFlow 2.5.2, and TensorFlow 2.4.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "05cbebd3c6bb8f517a158b0155debb8df79017ff",
  "patch_info": {
    "commit_hash": "05cbebd3c6bb8f517a158b0155debb8df79017ff",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/05cbebd3c6bb8f517a158b0155debb8df79017ff",
    "files": [
      "tensorflow/core/common_runtime/immutable_executor_state.cc"
    ],
    "message": "Fix a NPE issue in invalid Exit op. Now it will report an error instead of crash.\n\nPiperOrigin-RevId: 404089902\nChange-Id: Ia6ec55445ea70ad045a4d339d354959ad0618f2a",
    "before_after_code_files": [
      "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc": [
      "File: tensorflow/core/common_runtime/immutable_executor_state.cc -> tensorflow/core/common_runtime/immutable_executor_state.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "316:     } else if (IsExit(curr_node)) {",
      "318:       parent = parent_nodes[curr_id];",
      "319:       frame_name = cf_info->frame_names[parent->id()];",
      "320:       parent = parent_nodes[parent->id()];",
      "321:     } else {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "319:       if (!parent) {",
      "320:         return errors::InvalidArgument(",
      "321:             \"Invalid Exit op: Cannot find a corresponding Enter op.\");",
      "322:       }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9687436a46bd2ac5426e5c7a636137a07ec91d47",
      "candidate_info": {
        "commit_hash": "9687436a46bd2ac5426e5c7a636137a07ec91d47",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/9687436a46bd2ac5426e5c7a636137a07ec91d47",
        "files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc"
        ],
        "message": "Fix a NPE issue in invalid Exit op. Now it will report an error instead of crash.\n\nPiperOrigin-RevId: 404089902\nChange-Id: Ia6ec55445ea70ad045a4d339d354959ad0618f2a",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc": [
          "File: tensorflow/core/common_runtime/immutable_executor_state.cc -> tensorflow/core/common_runtime/immutable_executor_state.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "316:     } else if (IsExit(curr_node)) {",
          "318:       parent = parent_nodes[curr_id];",
          "319:       frame_name = cf_info->frame_names[parent->id()];",
          "320:       parent = parent_nodes[parent->id()];",
          "321:     } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "319:       if (!parent) {",
          "320:         return errors::InvalidArgument(",
          "321:             \"Invalid Exit op: Cannot find a corresponding Enter op.\");",
          "322:       }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "74389e87cdd8b3af4301c80433454d5cff089c59",
      "candidate_info": {
        "commit_hash": "74389e87cdd8b3af4301c80433454d5cff089c59",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/74389e87cdd8b3af4301c80433454d5cff089c59",
        "files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc"
        ],
        "message": "Fix a NPE issue in invalid Exit op. Now it will report an error instead of crash.\n\nPiperOrigin-RevId: 404089902\nChange-Id: Ia6ec55445ea70ad045a4d339d354959ad0618f2a",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc": [
          "File: tensorflow/core/common_runtime/immutable_executor_state.cc -> tensorflow/core/common_runtime/immutable_executor_state.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "315:     } else if (IsExit(curr_node)) {",
          "317:       parent = parent_nodes[curr_id];",
          "318:       frame_name = cf_info->frame_names[parent->id()];",
          "319:       parent = parent_nodes[parent->id()];",
          "320:     } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "318:       if (!parent) {",
          "319:         return errors::InvalidArgument(",
          "320:             \"Invalid Exit op: Cannot find a corresponding Enter op.\");",
          "321:       }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "940617151ed7da08ef91222ebc9730e47ba9794f",
      "candidate_info": {
        "commit_hash": "940617151ed7da08ef91222ebc9730e47ba9794f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/940617151ed7da08ef91222ebc9730e47ba9794f",
        "files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc"
        ],
        "message": "Fix a NPE issue in invalid Exit op. Now it will report an error instead of crash.\n\nPiperOrigin-RevId: 404089902\nChange-Id: Ia6ec55445ea70ad045a4d339d354959ad0618f2a",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc": [
          "File: tensorflow/core/common_runtime/immutable_executor_state.cc -> tensorflow/core/common_runtime/immutable_executor_state.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "316:     } else if (IsExit(curr_node)) {",
          "318:       parent = parent_nodes[curr_id];",
          "319:       frame_name = cf_info->frame_names[parent->id()];",
          "320:       parent = parent_nodes[parent->id()];",
          "321:     } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "319:       if (!parent) {",
          "320:         return errors::InvalidArgument(",
          "321:             \"Invalid Exit op: Cannot find a corresponding Enter op.\");",
          "322:       }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ccb9d11983f9ab21aff337733c8b4d958fb648ca",
      "candidate_info": {
        "commit_hash": "ccb9d11983f9ab21aff337733c8b4d958fb648ca",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ccb9d11983f9ab21aff337733c8b4d958fb648ca",
        "files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc"
        ],
        "message": "Fix a NPE issue in invalid Exit op. Now it will report an error instead of crash.\n\nPiperOrigin-RevId: 404089902\nChange-Id: Ia6ec55445ea70ad045a4d339d354959ad0618f2a",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/immutable_executor_state.cc||tensorflow/core/common_runtime/immutable_executor_state.cc": [
          "File: tensorflow/core/common_runtime/immutable_executor_state.cc -> tensorflow/core/common_runtime/immutable_executor_state.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "315:     } else if (IsExit(curr_node)) {",
          "317:       parent = parent_nodes[curr_id];",
          "318:       frame_name = cf_info->frame_names[parent->id()];",
          "319:       parent = parent_nodes[parent->id()];",
          "320:     } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "318:       if (!parent) {",
          "319:         return errors::InvalidArgument(",
          "320:             \"Invalid Exit op: Cannot find a corresponding Enter op.\");",
          "321:       }",
          "",
          "---------------"
        ]
      }
    }
  ]
}