{
  "cve_id": "CVE-2022-4070",
  "cve_desc": "Insufficient Session Expiration in GitHub repository librenms/librenms prior to 22.10.0.",
  "repo": "librenms/librenms",
  "patch_hash": "ce8e5f3d056829bfa7a845f9dc2757e21e419ddc",
  "patch_info": {
    "commit_hash": "ce8e5f3d056829bfa7a845f9dc2757e21e419ddc",
    "repo": "librenms/librenms",
    "commit_url": "https://github.com/librenms/librenms/commit/ce8e5f3d056829bfa7a845f9dc2757e21e419ddc",
    "files": [
      "app/Http/Kernel.php",
      "app/Http/Middleware/VerifyUserEnabled.php",
      "resources/lang/en/auth.php",
      "resources/views/auth/login.blade.php",
      "resources/views/user/form.blade.php"
    ],
    "message": "Block disabled user session auth\nDo not allow users that are disabled to be logged in via cookie.\nAllow all auth methods to disable users",
    "before_after_code_files": [
      "app/Http/Kernel.php||app/Http/Kernel.php",
      "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php",
      "resources/lang/en/auth.php||resources/lang/en/auth.php",
      "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php",
      "resources/views/user/form.blade.php||resources/views/user/form.blade.php"
    ]
  },
  "patch_diff": {
    "app/Http/Kernel.php||app/Http/Kernel.php": [
      "File: app/Http/Kernel.php -> app/Http/Kernel.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "36:             \\Illuminate\\Session\\Middleware\\StartSession::class,",
      "37:             \\Illuminate\\Session\\Middleware\\AuthenticateSession::class,",
      "38:             \\Illuminate\\View\\Middleware\\ShareErrorsFromSession::class,",
      "39:             \\App\\Http\\Middleware\\VerifyCsrfToken::class,",
      "40:             \\Illuminate\\Routing\\Middleware\\SubstituteBindings::class,",
      "41:         ],",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39:             \\App\\Http\\Middleware\\VerifyUserEnabled::class,",
      "",
      "---------------"
    ],
    "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php": [
      "File: app/Http/Middleware/VerifyUserEnabled.php -> app/Http/Middleware/VerifyUserEnabled.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: namespace App\\Http\\Middleware;",
      "5: use Closure;",
      "6: use Illuminate\\Http\\Request;",
      "7: use Illuminate\\Support\\Facades\\Auth;",
      "9: class VerifyUserEnabled",
      "10: {",
      "18:     public function handle(Request $request, Closure $next)",
      "19:     {",
      "20:         if (Auth::check() && ! Auth::user()->enabled) {",
      "21:             Auth::logout();",
      "22:             $request->session()->invalidate();",
      "23:             $request->session()->regenerateToken();",
      "25:             return redirect()->route('login')->withErrors(['msg' => __('auth.disabled')]);",
      "26:         }",
      "28:         return $next($request);",
      "29:     }",
      "30: }",
      "",
      "---------------"
    ],
    "resources/lang/en/auth.php||resources/lang/en/auth.php": [
      "File: resources/lang/en/auth.php -> resources/lang/en/auth.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "16:     'title' => 'Auth',",
      "17:     'failed' => 'These credentials do not match our records.',",
      "18:     'throttle' => 'Too many login attempts. Please try again in :seconds seconds.',",
      "20: ];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "19:     'disabled' => 'Your Account is disabled, please contact Admin.',",
      "",
      "---------------"
    ],
    "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php": [
      "File: resources/views/auth/login.blade.php -> resources/views/auth/login.blade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "7:             @include('auth.login-form')",
      "8:         </div>",
      "9:     </div>",
      "10: </div>",
      "11: @endsection",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "10:     @if($errors->any())",
      "11:         <script>toastr.error('{{ $errors->first() }}')</script>",
      "12:     @endif",
      "",
      "---------------"
    ],
    "resources/views/user/form.blade.php||resources/views/user/form.blade.php": [
      "File: resources/views/user/form.blade.php -> resources/views/user/form.blade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "6:     </div>",
      "7: </div>",
      "10: <div class=\"form-group @if($errors->has('enabled')) has-error @endif\">",
      "11:     <label for=\"enabled\" class=\"control-label col-sm-3\">{{ __('Enabled') }}</label>",
      "12:     <div class=\"col-sm-9\">",
      "15:     </div>",
      "16: </div>",
      "19: <div class=\"form-group @if($errors->has('email')) has-error @endif\">",
      "20:     <label for=\"email\" class=\"control-label col-sm-3\">{{ __('Email') }}</label>",
      "",
      "[Removed Lines]",
      "9: @if(\\LibreNMS\\Config::get('auth_mechanism') == 'mysql')",
      "13:         <input type=\"hidden\" value=\"@if(Auth::id() == $user->user_id) 1 else 0 @endif\" name=\"enabled\">",
      "14:         <input type=\"checkbox\" id=\"enabled\" name=\"enabled\" data-size=\"small\" @if(old('enabled', $user->enabled)) checked @endif @if(Auth::id() == $user->user_id) disabled @endif>",
      "17: @endif",
      "",
      "[Added Lines]",
      "12:         <input type=\"hidden\" value=\"@if(Auth::id() == $user->user_id) 1 @else 0 @endif\" name=\"enabled\">",
      "13:         <input type=\"checkbox\" id=\"enabled\" name=\"enabled\" data-size=\"small\" @if(old('enabled', $user->enabled ?? true)) checked @endif @if(Auth::id() == $user->user_id) disabled @endif>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7dd3a224fa15929379c967eac40765ec136cb7b6",
      "candidate_info": {
        "commit_hash": "7dd3a224fa15929379c967eac40765ec136cb7b6",
        "repo": "librenms/librenms",
        "commit_url": "https://github.com/librenms/librenms/commit/7dd3a224fa15929379c967eac40765ec136cb7b6",
        "files": [
          "app/Http/Kernel.php",
          "app/Http/Middleware/VerifyUserEnabled.php",
          "resources/lang/en/auth.php",
          "resources/views/auth/login.blade.php",
          "resources/views/user/form.blade.php"
        ],
        "message": "Block disabled user session auth (#14473)\n\nDo not allow users that are disabled to be logged in via cookie.\nAllow all auth methods to disable users",
        "before_after_code_files": [
          "app/Http/Kernel.php||app/Http/Kernel.php",
          "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php",
          "resources/lang/en/auth.php||resources/lang/en/auth.php",
          "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php",
          "resources/views/user/form.blade.php||resources/views/user/form.blade.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/librenms/librenms/pull/14473"
        ],
        "olp_code_files": {
          "patch": [
            "app/Http/Kernel.php||app/Http/Kernel.php",
            "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php",
            "resources/lang/en/auth.php||resources/lang/en/auth.php",
            "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php",
            "resources/views/user/form.blade.php||resources/views/user/form.blade.php"
          ],
          "candidate": [
            "app/Http/Kernel.php||app/Http/Kernel.php",
            "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php",
            "resources/lang/en/auth.php||resources/lang/en/auth.php",
            "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php",
            "resources/views/user/form.blade.php||resources/views/user/form.blade.php"
          ]
        }
      },
      "candidate_diff": {
        "app/Http/Kernel.php||app/Http/Kernel.php": [
          "File: app/Http/Kernel.php -> app/Http/Kernel.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "36:             \\Illuminate\\Session\\Middleware\\StartSession::class,",
          "37:             \\Illuminate\\Session\\Middleware\\AuthenticateSession::class,",
          "38:             \\Illuminate\\View\\Middleware\\ShareErrorsFromSession::class,",
          "39:             \\App\\Http\\Middleware\\VerifyCsrfToken::class,",
          "40:             \\Illuminate\\Routing\\Middleware\\SubstituteBindings::class,",
          "41:         ],",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:             \\App\\Http\\Middleware\\VerifyUserEnabled::class,",
          "",
          "---------------"
        ],
        "app/Http/Middleware/VerifyUserEnabled.php||app/Http/Middleware/VerifyUserEnabled.php": [
          "File: app/Http/Middleware/VerifyUserEnabled.php -> app/Http/Middleware/VerifyUserEnabled.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: namespace App\\Http\\Middleware;",
          "5: use Closure;",
          "6: use Illuminate\\Http\\Request;",
          "7: use Illuminate\\Support\\Facades\\Auth;",
          "9: class VerifyUserEnabled",
          "10: {",
          "18:     public function handle(Request $request, Closure $next)",
          "19:     {",
          "20:         if (Auth::check() && ! Auth::user()->enabled) {",
          "21:             Auth::logout();",
          "22:             $request->session()->invalidate();",
          "23:             $request->session()->regenerateToken();",
          "25:             return redirect()->route('login')->withErrors(['msg' => __('auth.disabled')]);",
          "26:         }",
          "28:         return $next($request);",
          "29:     }",
          "30: }",
          "",
          "---------------"
        ],
        "resources/lang/en/auth.php||resources/lang/en/auth.php": [
          "File: resources/lang/en/auth.php -> resources/lang/en/auth.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "16:     'title' => 'Auth',",
          "17:     'failed' => 'These credentials do not match our records.',",
          "18:     'throttle' => 'Too many login attempts. Please try again in :seconds seconds.',",
          "20: ];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19:     'disabled' => 'Your Account is disabled, please contact Admin.',",
          "",
          "---------------"
        ],
        "resources/views/auth/login.blade.php||resources/views/auth/login.blade.php": [
          "File: resources/views/auth/login.blade.php -> resources/views/auth/login.blade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:             @include('auth.login-form')",
          "8:         </div>",
          "9:     </div>",
          "10: </div>",
          "11: @endsection",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10:     @if($errors->any())",
          "11:         <script>toastr.error('{{ $errors->first() }}')</script>",
          "12:     @endif",
          "",
          "---------------"
        ],
        "resources/views/user/form.blade.php||resources/views/user/form.blade.php": [
          "File: resources/views/user/form.blade.php -> resources/views/user/form.blade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "6:     </div>",
          "7: </div>",
          "10: <div class=\"form-group @if($errors->has('enabled')) has-error @endif\">",
          "11:     <label for=\"enabled\" class=\"control-label col-sm-3\">{{ __('Enabled') }}</label>",
          "12:     <div class=\"col-sm-9\">",
          "15:     </div>",
          "16: </div>",
          "19: <div class=\"form-group @if($errors->has('email')) has-error @endif\">",
          "20:     <label for=\"email\" class=\"control-label col-sm-3\">{{ __('Email') }}</label>",
          "",
          "[Removed Lines]",
          "9: @if(\\LibreNMS\\Config::get('auth_mechanism') == 'mysql')",
          "13:         <input type=\"hidden\" value=\"@if(Auth::id() == $user->user_id) 1 else 0 @endif\" name=\"enabled\">",
          "14:         <input type=\"checkbox\" id=\"enabled\" name=\"enabled\" data-size=\"small\" @if(old('enabled', $user->enabled)) checked @endif @if(Auth::id() == $user->user_id) disabled @endif>",
          "17: @endif",
          "",
          "[Added Lines]",
          "12:         <input type=\"hidden\" value=\"@if(Auth::id() == $user->user_id) 1 @else 0 @endif\" name=\"enabled\">",
          "13:         <input type=\"checkbox\" id=\"enabled\" name=\"enabled\" data-size=\"small\" @if(old('enabled', $user->enabled ?? true)) checked @endif @if(Auth::id() == $user->user_id) disabled @endif>",
          "",
          "---------------"
        ]
      }
    }
  ]
}