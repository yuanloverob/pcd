{
  "cve_id": "CVE-2023-34252",
  "cve_desc": "Grav is a flat-file content management system. Prior to version 1.7.42, there is a logic flaw in the `GravExtension.filterFilter()` function whereby validation against a denylist of unsafe functions is only performed when the argument passed to filter is a string. However, passing an array as a callable argument allows the validation check to be skipped. Consequently, a low privileged attacker with login access to Grav Admin panel and page creation/update permissions is able to inject malicious templates to obtain remote code execution. The vulnerability can be found in the `GravExtension.filterFilter()` function declared in `/system/src/Grav/Common/Twig/Extension/GravExtension.php`. Version 1.7.42 contains a patch for this issue. End users should also ensure that `twig.undefined_functions` and `twig.undefined_filters` properties in `/path/to/webroot/system/config/system.yaml` configuration file are set to `false` to disallow Twig from treating undefined filters/functions as PHP functions and executing them.",
  "repo": "getgrav/grav",
  "patch_hash": "244758d4383034fe4cd292d41e477177870b65ec",
  "patch_info": {
    "commit_hash": "244758d4383034fe4cd292d41e477177870b65ec",
    "repo": "getgrav/grav",
    "commit_url": "https://github.com/getgrav/grav/commit/244758d4383034fe4cd292d41e477177870b65ec",
    "files": [
      "CHANGELOG.md",
      "system/src/Grav/Common/Twig/Extension/GravExtension.php"
    ],
    "message": "also handle SSTI in reduce twig filter + function",
    "before_after_code_files": [
      "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
    ]
  },
  "patch_diff": {
    "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php": [
      "File: system/src/Grav/Common/Twig/Extension/GravExtension.php -> system/src/Grav/Common/Twig/Extension/GravExtension.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "171:             new TwigFilter('count', 'count'),",
      "172:             new TwigFilter('array_diff', 'array_diff'),",
      "177:         ];",
      "178:     }",
      "",
      "[Removed Lines]",
      "175:             new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),",
      "176:             new TwigFilter('map', [$this, 'mapFilter'], ['needs_environment' => true]),",
      "",
      "[Added Lines]",
      "175:             new TwigFilter('filter', [$this, 'filterFunc'], ['needs_environment' => true]),",
      "176:             new TwigFilter('map', [$this, 'mapFunc'], ['needs_environment' => true]),",
      "177:             new TwigFilter('reduce', [$this, 'reduceFunc'], ['needs_environment' => true]),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "250:             new TwigFunction('count', 'count'),",
      "251:             new TwigFunction('array_diff', 'array_diff'),",
      "252:             new TwigFunction('parse_url', 'parse_url'),",
      "253:         ];",
      "254:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "256:             new TwigFunction('filter', [$this, 'filterFunc'], ['needs_environment' => true]),",
      "257:             new TwigFunction('map', [$this, 'mapFunc'], ['needs_environment' => true]),",
      "258:             new TwigFunction('reduce', [$this, 'reduceFunc'], ['needs_environment' => true]),",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1710:     {",
      "1711:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
      "1712:             throw new RuntimeError('Twig |filter(\"' . $arrow . '\") is not allowed.');",
      "",
      "[Removed Lines]",
      "1709:     function filterFilter(Environment $env, $array, $arrow)",
      "",
      "[Added Lines]",
      "1715:     function filterFunc(Environment $env, $array, $arrow)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1726:     {",
      "1727:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
      "1728:             throw new RuntimeError('Twig |map(\"' . $arrow . '\") is not allowed.');",
      "",
      "[Removed Lines]",
      "1725:     function mapFilter(Environment $env, $array, $arrow)",
      "",
      "[Added Lines]",
      "1731:     function mapFunc(Environment $env, $array, $arrow)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1731:         return twig_array_map($env, $array, $arrow);",
      "1732:     }",
      "1733: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1747:     function reduceFunc(Environment $env, $array, $arrow)",
      "1748:     {",
      "1749:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
      "1750:             throw new RuntimeError('Twig |reduce(\"' . $arrow . '\") is not allowed.');",
      "1751:         }",
      "1753:         return twig_array_map($env, $array, $arrow);",
      "1754:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9d01140a63c77075ef09b26ef57cf186138151a5",
      "candidate_info": {
        "commit_hash": "9d01140a63c77075ef09b26ef57cf186138151a5",
        "repo": "getgrav/grav",
        "commit_url": "https://github.com/getgrav/grav/commit/9d01140a63c77075ef09b26ef57cf186138151a5",
        "files": [
          "CHANGELOG.md",
          "system/src/Grav/Common/Twig/Extension/GravExtension.php"
        ],
        "message": "Fix for dangerous tags in |map filter",
        "before_after_code_files": [
          "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ],
          "candidate": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ]
        }
      },
      "candidate_diff": {
        "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php": [
          "File: system/src/Grav/Common/Twig/Extension/GravExtension.php -> system/src/Grav/Common/Twig/Extension/GravExtension.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "175:             new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),",
          "176:         ];",
          "177:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "176:             new TwigFilter('map', [$this, 'mapFilter'], ['needs_environment' => true]),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1714:         return twig_array_filter($env, $array, $arrow);",
          "1715:     }",
          "1716: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1725:     function mapFilter(Environment $env, $array, $arrow)",
          "1726:     {",
          "1727:         if (is_string($arrow) && Utils::isDangerousFunction($arrow)) {",
          "1728:             throw new RuntimeError('Twig |map(\"' . $arrow . '\") is not allowed.');",
          "1729:         }",
          "1731:         return twig_array_map($env, $array, $arrow);",
          "1732:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}