{
  "cve_id": "CVE-2015-5254",
  "cve_desc": "Apache ActiveMQ 5.x before 5.13.0 does not restrict the classes that can be serialized in the broker, which allows remote attackers to execute arbitrary code via a crafted serialized Java Message Service (JMS) ObjectMessage object.",
  "repo": "apache/activemq",
  "patch_hash": "7eb9b218b2705cf9273e30ee2da026e43b6dd4e0",
  "patch_info": {
    "commit_hash": "7eb9b218b2705cf9273e30ee2da026e43b6dd4e0",
    "repo": "apache/activemq",
    "commit_url": "https://github.com/apache/activemq/commit/7eb9b218b2705cf9273e30ee2da026e43b6dd4e",
    "files": [
      "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
      "activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java",
      "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
      "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
    ],
    "message": "https://issues.apache.org/jira/browse/AMQ-6013 - init serializable packages statically",
    "before_after_code_files": [
      "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
      "activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java||activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java",
      "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
      "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
    ]
  },
  "patch_diff": {
    "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java": [
      "File: activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java -> activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:     private static final ClassLoader FALLBACK_CLASS_LOADER =",
      "35:         ClassLoadingAwareObjectInputStream.class.getClassLoader();",
      "39:     private final ClassLoader inLoader;",
      "41:     public ClassLoadingAwareObjectInputStream(InputStream in) throws IOException {",
      "42:         super(in);",
      "43:         inLoader = in.getClass().getClassLoader();",
      "",
      "[Removed Lines]",
      "37:     private static String[] serializablePackages;",
      "",
      "[Added Lines]",
      "37:     public static final String[] serializablePackages;",
      "41:     static {",
      "42:         serializablePackages = System.getProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\",",
      "43:                     \"java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper\").split(\",\");",
      "44:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "83:         }",
      "84:     }",
      "95:     public static boolean isAllAllowed() {",
      "97:     }",
      "99:     private void checkSecurity(Class clazz) throws ClassNotFoundException {",
      "100:         if (!clazz.isPrimitive()) {",
      "101:             if (clazz.getPackage() != null && !isAllAllowed()) {",
      "102:                boolean found = false;",
      "104:                    if (clazz.getPackage().getName().equals(packageName) || clazz.getPackage().getName().startsWith(packageName + \".\")) {",
      "105:                        found = true;",
      "106:                        break;",
      "",
      "[Removed Lines]",
      "86:     public static String[] getSerialziablePackages() {",
      "87:        if (serializablePackages == null) {",
      "88:            serializablePackages = System.getProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\",",
      "89:                        \"java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper\").split(\",\");",
      "90:        }",
      "92:        return serializablePackages;",
      "93:     };",
      "96:         return getSerialziablePackages().length == 1 && getSerialziablePackages()[0].equals(\"*\");",
      "103:                for (String packageName : getSerialziablePackages()) {",
      "",
      "[Added Lines]",
      "92:         return serializablePackages.length == 1 && serializablePackages[0].equals(\"*\");",
      "99:                for (String packageName : serializablePackages) {",
      "",
      "---------------"
    ],
    "activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java||activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java": [
      "File: activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java -> activemq-http/src/main/java/org/apache/activemq/transport/xstream/XStreamWireFormat.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: import java.io.IOException;",
      "20: import java.io.Reader;",
      "24: import com.thoughtworks.xstream.converters.Converter;",
      "25: import com.thoughtworks.xstream.converters.MarshallingContext;",
      "26: import com.thoughtworks.xstream.converters.UnmarshallingContext;",
      "27: import com.thoughtworks.xstream.io.HierarchicalStreamReader;",
      "28: import com.thoughtworks.xstream.io.HierarchicalStreamWriter;",
      "30: import org.apache.activemq.command.MarshallAware;",
      "31: import org.apache.activemq.command.MessageDispatch;",
      "32: import org.apache.activemq.transport.stomp.XStreamSupport;",
      "",
      "[Removed Lines]",
      "22: <<<<<<< HEAD",
      "23: =======",
      "29: >>>>>>> a7e2a44... https://issues.apache.org/jira/browse/AMQ-6013 - restrict classes which can be serialized inside the broker",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "102:     }",
      "106:         if (xStream == null) {",
      "107:             xStream = createXStream();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "103:     public XStream getXStream() {",
      "",
      "---------------"
    ],
    "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java": [
      "File: activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java -> activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "37:         if (ClassLoadingAwareObjectInputStream.isAllAllowed()) {",
      "38:             stream.addPermission(AnyTypePermission.ANY);",
      "39:         } else {",
      "41:                 stream.allowTypesByWildcard(new String[]{packageName + \".**\"});",
      "42:             }",
      "43:         }",
      "",
      "[Removed Lines]",
      "40:             for (String packageName : ClassLoadingAwareObjectInputStream.getSerialziablePackages()) {",
      "",
      "[Added Lines]",
      "40:             for (String packageName : ClassLoadingAwareObjectInputStream.serializablePackages) {",
      "",
      "---------------"
    ],
    "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java": [
      "File: activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java -> activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "111:     }",
      "113:     public void startBroker() throws Exception {",
      "117:         XStreamBrokerContext context = new XStreamBrokerContext();",
      "118:         brokerService.setBrokerContext(context);",
      "",
      "[Removed Lines]",
      "114:         System.setProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\", \"*\");",
      "115:         createBroker(true);",
      "",
      "[Added Lines]",
      "114:         createBroker();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e100638244c4ca5eb2a1f16bcdc671c9859c2694",
      "candidate_info": {
        "commit_hash": "e100638244c4ca5eb2a1f16bcdc671c9859c2694",
        "repo": "apache/activemq",
        "commit_url": "https://github.com/apache/activemq/commit/e100638244c4ca5eb2a1f16bcdc671c9859c2694",
        "files": [
          "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
          "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
          "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
        ],
        "message": "https://issues.apache.org/jira/browse/AMQ-6013 - init serializable packages statically",
        "before_after_code_files": [
          "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
          "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
          "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
            "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
            "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
          ],
          "candidate": [
            "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
            "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
            "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java"
          ]
        }
      },
      "candidate_diff": {
        "activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java||activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java": [
          "File: activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java -> activemq-client/src/main/java/org/apache/activemq/util/ClassLoadingAwareObjectInputStream.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:     private static final ClassLoader FALLBACK_CLASS_LOADER =",
          "35:         ClassLoadingAwareObjectInputStream.class.getClassLoader();",
          "39:     private final ClassLoader inLoader;",
          "41:     public ClassLoadingAwareObjectInputStream(InputStream in) throws IOException {",
          "42:         super(in);",
          "43:         inLoader = in.getClass().getClassLoader();",
          "",
          "[Removed Lines]",
          "37:     private static String[] serializablePackages;",
          "",
          "[Added Lines]",
          "37:     public static final String[] serializablePackages;",
          "41:     static {",
          "42:         serializablePackages = System.getProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\",",
          "43:                     \"java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper\").split(\",\");",
          "44:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "83:         }",
          "84:     }",
          "95:     public static boolean isAllAllowed() {",
          "97:     }",
          "99:     private void checkSecurity(Class clazz) throws ClassNotFoundException {",
          "100:         if (!clazz.isPrimitive()) {",
          "101:             if (clazz.getPackage() != null && !isAllAllowed()) {",
          "102:                boolean found = false;",
          "104:                    if (clazz.getPackage().getName().equals(packageName) || clazz.getPackage().getName().startsWith(packageName + \".\")) {",
          "105:                        found = true;",
          "106:                        break;",
          "",
          "[Removed Lines]",
          "86:     public static String[] getSerialziablePackages() {",
          "87:        if (serializablePackages == null) {",
          "88:            serializablePackages = System.getProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\",",
          "89:                        \"java.lang,java.util,org.apache.activemq,org.fusesource.hawtbuf,com.thoughtworks.xstream.mapper\").split(\",\");",
          "90:        }",
          "92:        return serializablePackages;",
          "93:     };",
          "96:         return getSerialziablePackages().length == 1 && getSerialziablePackages()[0].equals(\"*\");",
          "103:                for (String packageName : getSerialziablePackages()) {",
          "",
          "[Added Lines]",
          "92:         return serializablePackages.length == 1 && serializablePackages[0].equals(\"*\");",
          "99:                for (String packageName : serializablePackages) {",
          "",
          "---------------"
        ],
        "activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java||activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java": [
          "File: activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java -> activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/XStreamSupport.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         if (ClassLoadingAwareObjectInputStream.isAllAllowed()) {",
          "38:             stream.addPermission(AnyTypePermission.ANY);",
          "39:         } else {",
          "41:                 stream.allowTypesByWildcard(new String[]{packageName + \".**\"});",
          "42:             }",
          "43:         }",
          "",
          "[Removed Lines]",
          "40:             for (String packageName : ClassLoadingAwareObjectInputStream.getSerialziablePackages()) {",
          "",
          "[Added Lines]",
          "40:             for (String packageName : ClassLoadingAwareObjectInputStream.serializablePackages) {",
          "",
          "---------------"
        ],
        "activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java||activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java": [
          "File: activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java -> activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/StompTestSupport.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "119:     }",
          "121:     public void startBroker() throws Exception {",
          "123:         createBroker(true);",
          "125:         XStreamBrokerContext context = new XStreamBrokerContext();",
          "",
          "[Removed Lines]",
          "122:         System.setProperty(\"org.apache.activemq.SERIALIZABLE_PACKAGES\", \"*\");",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}