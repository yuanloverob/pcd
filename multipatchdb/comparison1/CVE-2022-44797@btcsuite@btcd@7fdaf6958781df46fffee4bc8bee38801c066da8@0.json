{
  "cve_id": "CVE-2022-44797",
  "cve_desc": "btcd before 0.23.2, as used in Lightning Labs lnd before 0.15.2-beta and other Bitcoin-related products, mishandles witness size checking.",
  "repo": "btcsuite/btcd",
  "patch_hash": "7fdaf6958781df46fffee4bc8bee38801c066da8",
  "patch_info": {
    "commit_hash": "7fdaf6958781df46fffee4bc8bee38801c066da8",
    "repo": "btcsuite/btcd",
    "commit_url": "https://github.com/btcsuite/btcd/commit/7fdaf6958781df46fffee4bc8bee38801c066da8",
    "files": [
      "blockchain/weight.go",
      "wire/msgtx.go"
    ],
    "message": "wire: remove erroneous witness size check in wire parsing\n\nIn this commit, we fix a bug that would cause nodes to be unable to\nparse a given block from the wire. The block would be properly accepted\nif fed in via other mechanisms.\n\nThe issue here is that the old checks for the maximum witness size,\ncirca segwit v0 where placed in the wire package _as well_ as the tx\nengine. This check should only be in the engine, since it's properly\ngated by other related scrip validation flags.\n\nThe fix itself is simple: limit witnesses only based on the maximum\nblock size in bytes, or ~4MB.",
    "before_after_code_files": [
      "blockchain/weight.go||blockchain/weight.go",
      "wire/msgtx.go||wire/msgtx.go"
    ]
  },
  "patch_diff": {
    "blockchain/weight.go||blockchain/weight.go": [
      "File: blockchain/weight.go -> blockchain/weight.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "7: import (",
      "8:  \"fmt\"",
      "10:  \"github.com/btcsuite/btcd/txscript\"",
      "11:  \"github.com/btcsuite/btcd/wire\"",
      "13: )",
      "15: const (",
      "",
      "[Removed Lines]",
      "12:  \"github.com/btcsuite/btcd/btcutil\"",
      "",
      "[Added Lines]",
      "10:  \"github.com/btcsuite/btcd/btcutil\"",
      "",
      "---------------"
    ],
    "wire/msgtx.go||wire/msgtx.go": [
      "File: wire/msgtx.go -> wire/msgtx.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "110: )",
      "",
      "[Removed Lines]",
      "109:  maxWitnessItemSize = 11000",
      "",
      "[Added Lines]",
      "109:  maxWitnessItemSize = 4_000_000",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "127: const TxFlagMarker = 0x00",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "587:    txin.Witness = make([][]byte, witCount)",
      "588:    for j := uint64(0); j < witCount; j++ {",
      "591:     if err != nil {",
      "592:      returnScriptBuffers()",
      "593:      return err",
      "",
      "[Removed Lines]",
      "589:     txin.Witness[j], err = readScript(r, pver,",
      "590:      maxWitnessItemSize, \"script witness item\")",
      "",
      "[Added Lines]",
      "591:     txin.Witness[j], err = readScript(",
      "592:      r, pver, maxWitnessItemSize, \"script witness item\",",
      "593:     )",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ae3b9c9ed77db5a78c0d307200e8bd65ee9319af",
      "candidate_info": {
        "commit_hash": "ae3b9c9ed77db5a78c0d307200e8bd65ee9319af",
        "repo": "btcsuite/btcd",
        "commit_url": "https://github.com/btcsuite/btcd/commit/ae3b9c9ed77db5a78c0d307200e8bd65ee9319af",
        "files": [
          "wire/msgtx.go"
        ],
        "message": "wire: remove erroneous witness size check in wire parsing\n\nIn this commit, we fix a bug that would cause nodes to be unable to\nparse a given block from the wire. The block would be properly accepted\nif fed in via other mechanisms.\n\nThe issue here is that the old checks for the maximum witness size,\ncirca segwit v0 where placed in the wire package _as well_ as the tx\nengine. This check should only be in the engine, since it's properly\ngated by other related scrip validation flags.\n\nThe fix itself is simple: limit witnesses only based on the maximum\nblock size in bytes, or ~4MB.",
        "before_after_code_files": [
          "wire/msgtx.go||wire/msgtx.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "wire/msgtx.go||wire/msgtx.go"
          ],
          "candidate": [
            "wire/msgtx.go||wire/msgtx.go"
          ]
        }
      },
      "candidate_diff": {
        "wire/msgtx.go||wire/msgtx.go": [
          "File: wire/msgtx.go -> wire/msgtx.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "103:  maxWitnessItemsPerInput = 500000",
          "110: )",
          "",
          "[Removed Lines]",
          "109:  maxWitnessItemSize = 11000",
          "",
          "[Added Lines]",
          "108:  maxWitnessItemSize = 4_000_000",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "587:    txin.Witness = make([][]byte, witCount)",
          "588:    for j := uint64(0); j < witCount; j++ {",
          "591:     if err != nil {",
          "592:      returnScriptBuffers()",
          "593:      return err",
          "",
          "[Removed Lines]",
          "589:     txin.Witness[j], err = readScript(r, pver,",
          "590:      maxWitnessItemSize, \"script witness item\")",
          "",
          "[Added Lines]",
          "590:     txin.Witness[j], err = readScript(",
          "591:      r, pver, maxWitnessItemSize, \"script witness item\",",
          "592:     )",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f523d4ccaa5f34a2f761f16a05f5d6e6665b1168",
      "candidate_info": {
        "commit_hash": "f523d4ccaa5f34a2f761f16a05f5d6e6665b1168",
        "repo": "btcsuite/btcd",
        "commit_url": "https://github.com/btcsuite/btcd/commit/f523d4ccaa5f34a2f761f16a05f5d6e6665b1168",
        "files": [
          "blockchain/weight.go",
          "wire/msgtx.go"
        ],
        "message": "wire: remove erroneous witness size check in wire parsing\n\nIn this commit, we fix a bug that would cause nodes to be unable to\nparse a given block from the wire. The block would be properly accepted\nif fed in via other mechanisms.\n\nThe issue here is that the old checks for the maximum witness size,\ncirca segwit v0 where placed in the wire package _as well_ as the tx\nengine. This check should only be in the engine, since it's properly\ngated by other related scrip validation flags.\n\nThe fix itself is simple: limit witnesses only based on the maximum\nblock size in bytes, or ~4MB.",
        "before_after_code_files": [
          "blockchain/weight.go||blockchain/weight.go",
          "wire/msgtx.go||wire/msgtx.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "blockchain/weight.go||blockchain/weight.go",
            "wire/msgtx.go||wire/msgtx.go"
          ],
          "candidate": [
            "blockchain/weight.go||blockchain/weight.go",
            "wire/msgtx.go||wire/msgtx.go"
          ]
        }
      },
      "candidate_diff": {
        "blockchain/weight.go||blockchain/weight.go": [
          "File: blockchain/weight.go -> blockchain/weight.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: import (",
          "8:  \"fmt\"",
          "10:  \"github.com/btcsuite/btcd/txscript\"",
          "11:  \"github.com/btcsuite/btcd/wire\"",
          "13: )",
          "15: const (",
          "",
          "[Removed Lines]",
          "12:  \"github.com/btcsuite/btcd/btcutil\"",
          "",
          "[Added Lines]",
          "10:  \"github.com/btcsuite/btcd/btcutil\"",
          "",
          "---------------"
        ],
        "wire/msgtx.go||wire/msgtx.go": [
          "File: wire/msgtx.go -> wire/msgtx.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "103:  maxWitnessItemsPerInput = 500000",
          "110: )",
          "",
          "[Removed Lines]",
          "109:  maxWitnessItemSize = 11000",
          "",
          "[Added Lines]",
          "108:  maxWitnessItemSize = 4_000_000",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "587:    txin.Witness = make([][]byte, witCount)",
          "588:    for j := uint64(0); j < witCount; j++ {",
          "591:     if err != nil {",
          "592:      returnScriptBuffers()",
          "593:      return err",
          "",
          "[Removed Lines]",
          "589:     txin.Witness[j], err = readScript(r, pver,",
          "590:      maxWitnessItemSize, \"script witness item\")",
          "",
          "[Added Lines]",
          "590:     txin.Witness[j], err = readScript(",
          "591:      r, pver, maxWitnessItemSize, \"script witness item\",",
          "592:     )",
          "",
          "---------------"
        ]
      }
    }
  ]
}