{
  "cve_id": "CVE-2022-45299",
  "cve_desc": "An issue in the IpFile argument of rust-lang webbrowser-rs v0.8.2 allows attackers to access arbitrary files via supplying a crafted URL.",
  "repo": "amodm/webbrowser-rs",
  "patch_hash": "431b5139e274b7e456bea27e768aaa121b97be4c",
  "patch_info": {
    "commit_hash": "431b5139e274b7e456bea27e768aaa121b97be4c",
    "repo": "amodm/webbrowser-rs",
    "commit_url": "https://github.com/amodm/webbrowser-rs/commit/431b5139e274b7e456bea27e768aaa121b97be4c",
    "files": [
      "README.md",
      "src/lib.rs",
      "src/macos.rs",
      "src/unix.rs",
      "src/windows.rs"
    ],
    "message": "define consistent behaviour to include opening web browser even for local files",
    "before_after_code_files": [
      "src/lib.rs||src/lib.rs",
      "src/macos.rs||src/macos.rs",
      "src/unix.rs||src/unix.rs",
      "src/windows.rs||src/windows.rs"
    ]
  },
  "patch_diff": {
    "src/lib.rs||src/lib.rs": [
      "File: src/lib.rs -> src/lib.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "62:     \"Only Windows, Mac OS, iOS, Linux, *BSD and Haiku and Wasm32 are currently supported\"",
      "63: );",
      "65: use std::default::Default;",
      "66: use std::io::{Error, ErrorKind, Result};",
      "67: use std::str::FromStr;",
      "68: use std::{error, fmt};",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "69: use std::convert::TryFrom;",
      "71: use std::fmt::Display;",
      "73: use std::ops::Deref;",
      "74: use std::path::PathBuf;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "280:     url: &str,",
      "281:     options: &BrowserOptions,",
      "282: ) -> Result<()> {",
      "284:     os::open_browser_internal(browser, &target, options)",
      "285: }",
      "294: impl TargetType {",
      "296:     #[cfg(any(target_os = \"android\", target_os = \"ios\", target_family = \"wasm\"))]",
      "297:     fn is_http(&self) -> bool {",
      "303:             _ => false,",
      "304:         }",
      "305:     }",
      "",
      "[Removed Lines]",
      "283:     let target = TargetType::from(url);",
      "289: enum TargetType {",
      "290:     Url(url::Url),",
      "291:     Path(String),",
      "292: }",
      "298:         match self {",
      "299:             Self::Url(u) => match u.scheme() {",
      "300:                 \"http\" | \"https\" => true,",
      "301:                 _ => false,",
      "302:             },",
      "",
      "[Added Lines]",
      "291:     let target = TargetType::try_from(url)?;",
      "297: struct TargetType(url::Url);",
      "303:         match self.0.scheme() {",
      "304:             \"http\" | \"https\" => true,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "309:     #[cfg(any(target_os = \"android\", target_os = \"ios\", target_family = \"wasm\"))]",
      "310:     fn get_http_url(&self) -> Result<&str> {",
      "311:         if self.is_http() {",
      "313:         } else {",
      "315:         }",
      "316:     }",
      "317: }",
      "325:     }",
      "326: }",
      "333:         }",
      "334:     }",
      "335: }",
      "",
      "[Removed Lines]",
      "312:             Ok(self.as_ref())",
      "314:             Err(Error::new(ErrorKind::InvalidInput, \"not a valid url\"))",
      "319: impl AsRef<str> for TargetType {",
      "320:     fn as_ref(&self) -> &str {",
      "321:         match self {",
      "322:             TargetType::Url(u) => u.as_str(),",
      "323:             TargetType::Path(p) => p,",
      "324:         }",
      "328: impl From<&str> for TargetType {",
      "329:     fn from(target: &str) -> Self {",
      "330:         match url::Url::parse(target) {",
      "331:             Ok(u) => TargetType::Url(u),",
      "332:             Err(_) => TargetType::Path(target.into()),",
      "",
      "[Added Lines]",
      "314:             Ok(self.0.as_str())",
      "316:             Err(Error::new(ErrorKind::InvalidInput, \"not an http url\"))",
      "321: impl Deref for TargetType {",
      "322:     type Target = str;",
      "324:     fn deref(&self) -> &Self::Target {",
      "325:         self.0.as_str()",
      "326:     }",
      "327: }",
      "329: impl Display for TargetType {",
      "330:     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {",
      "331:         (self as &str).fmt(f)",
      "335: impl TryFrom<&str> for TargetType {",
      "336:     type Error = Error;",
      "338:     fn try_from(value: &str) -> Result<Self> {",
      "339:         match url::Url::parse(value) {",
      "340:             Ok(u) => Ok(Self(u)),",
      "341:             Err(_) => {",
      "343:                 let pb = PathBuf::from(value);",
      "344:                 let url = url::Url::from_file_path(if pb.is_relative() {",
      "345:                     std::env::current_dir()?.join(pb)",
      "346:                 } else {",
      "347:                     pb",
      "348:                 })",
      "349:                 .map_err(|_| {",
      "350:                     Error::new(ErrorKind::InvalidInput, \"failed to convert path to url\")",
      "351:                 })?;",
      "353:                 Ok(Self(url))",
      "354:             }",
      "",
      "---------------"
    ],
    "src/macos.rs||src/macos.rs": [
      "File: src/macos.rs -> src/macos.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "82:     }",
      "90:     let mut launched_app: CFURLRef = std::ptr::null_mut();",
      "91:     let status = unsafe { LSOpenFromURLSpec(&spec, &mut launched_app) };",
      "92:     log::trace!(\"received status: {}\", status);",
      "",
      "[Removed Lines]",
      "85:     log::trace!(",
      "86:         \"about to start browser: {} for {}\",",
      "87:         &browser,",
      "88:         target.as_ref()",
      "89:     );",
      "",
      "[Added Lines]",
      "85:     log::trace!(\"about to start browser: {} for {}\", &browser, &target);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "208: #[cfg(test)]",
      "209: mod tests {",
      "210:     use super::*;",
      "212:     #[test]",
      "213:     fn open_non_existing_browser() {",
      "214:         let _ = env_logger::try_init();",
      "215:         if let Err(err) = open_browser_internal(",
      "216:             Browser::Opera,",
      "218:             &BrowserOptions::default(),",
      "219:         ) {",
      "220:             assert_eq!(err.kind(), ErrorKind::NotFound);",
      "",
      "[Removed Lines]",
      "217:             &TargetType::from(\"https://github.com\"),",
      "",
      "[Added Lines]",
      "207:     use std::convert::TryFrom;",
      "214:             &TargetType::try_from(\"https://github.com\").expect(\"failed to parse url\"),",
      "",
      "---------------"
    ],
    "src/unix.rs||src/unix.rs": [
      "File: src/unix.rs -> src/unix.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "30:     options: &BrowserOptions,",
      "31: ) -> Result<()> {",
      "32:     match browser {",
      "34:         _ => Err(Error::new(",
      "35:             ErrorKind::NotFound,",
      "36:             \"only default browser supported\",",
      "",
      "[Removed Lines]",
      "33:         Browser::Default => open_browser_default(target.as_ref(), options),",
      "",
      "[Added Lines]",
      "33:         Browser::Default => open_browser_default(&target, options),",
      "",
      "---------------"
    ],
    "src/windows.rs||src/windows.rs": [
      "File: src/windows.rs -> src/windows.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "33:             static OPEN: &[u16] = &['o' as u16, 'p' as u16, 'e' as u16, 'n' as u16, 0x0000];",
      "34:             static HTTP: &[u16] = &['h' as u16, 't' as u16, 't' as u16, 'p' as u16, 0x0000];",
      "36:                 .map_err(|e| Error::new(ErrorKind::InvalidInput, e))?;",
      "37:             let code = unsafe {",
      "38:                 let coinitializeex_result = CoInitializeEx(",
      "",
      "[Removed Lines]",
      "35:             let url = U16CString::from_str(target.as_ref())",
      "",
      "[Added Lines]",
      "35:             let url = U16CString::from_str(&target)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "30486a96ae3fab5bcd31e75c48b15440efaec9c1",
      "candidate_info": {
        "commit_hash": "30486a96ae3fab5bcd31e75c48b15440efaec9c1",
        "repo": "amodm/webbrowser-rs",
        "commit_url": "https://github.com/amodm/webbrowser-rs/commit/30486a96ae3fab5bcd31e75c48b15440efaec9c1",
        "files": [
          "src/lib.rs"
        ],
        "message": "better implementation for is_http",
        "before_after_code_files": [
          "src/lib.rs||src/lib.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/lib.rs||src/lib.rs"
          ],
          "candidate": [
            "src/lib.rs||src/lib.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/lib.rs||src/lib.rs": [
          "File: src/lib.rs -> src/lib.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "323:         target_family = \"wasm\"",
          "324:     ))]",
          "325:     fn is_http(&self) -> bool {",
          "330:     }",
          "",
          "[Removed Lines]",
          "326:         match self.0.scheme() {",
          "327:             \"http\" | \"https\" => true,",
          "328:             _ => false,",
          "329:         }",
          "",
          "[Added Lines]",
          "326:         matches!(self.0.scheme(), \"http\" | \"https\")",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "05cec736f89235c2e8085cac4f54107f57b1cf1a",
      "candidate_info": {
        "commit_hash": "05cec736f89235c2e8085cac4f54107f57b1cf1a",
        "repo": "amodm/webbrowser-rs",
        "commit_url": "https://github.com/amodm/webbrowser-rs/commit/05cec736f89235c2e8085cac4f54107f57b1cf1a",
        "files": [
          "Cargo.toml",
          "src/common.rs",
          "src/lib.rs",
          "src/macos.rs"
        ],
        "message": "move macos implementation to use CoreFoundation instead of open #build-macos",
        "before_after_code_files": [
          "src/common.rs||src/common.rs",
          "src/lib.rs||src/lib.rs",
          "src/macos.rs||src/macos.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs"
          ],
          "candidate": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/common.rs||src/common.rs": [
          "File: src/common.rs -> src/common.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/lib.rs||src/lib.rs": [
          "File: src/lib.rs -> src/lib.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "280:     url: &str,",
          "281:     options: &BrowserOptions,",
          "282: ) -> Result<()> {",
          "287:     os::open_browser_internal(browser, &target, options)",
          "288: }",
          "",
          "[Removed Lines]",
          "283:     let target = match url::Url::parse(url) {",
          "284:         Ok(u) => TargetType::Url(u),",
          "285:         Err(_) => TargetType::Path(url.into()),",
          "286:     };",
          "",
          "[Added Lines]",
          "283:     let target = TargetType::from(url);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "328:     }",
          "329: }",
          "331: #[test]",
          "332: #[ignore]",
          "333: fn test_open_firefox() {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "328: impl From<&str> for TargetType {",
          "329:     fn from(target: &str) -> Self {",
          "330:         match url::Url::parse(target) {",
          "331:             Ok(u) => TargetType::Url(u),",
          "332:             Err(_) => TargetType::Path(target.into()),",
          "333:         }",
          "334:     }",
          "335: }",
          "",
          "---------------"
        ],
        "src/macos.rs||src/macos.rs": [
          "File: src/macos.rs -> src/macos.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use crate::{Browser, BrowserOptions, Error, ErrorKind, Result, TargetType};",
          "8: pub(super) fn open_browser_internal(",
          "9:     browser: Browser,",
          "10:     target: &TargetType,",
          "11:     options: &BrowserOptions,",
          "12: ) -> Result<()> {",
          "16:         Browser::Default => {",
          "20:             }",
          "23:         }",
          "24:         _ => {",
          "55:             }",
          "56:         }",
          "57:     }",
          "58: }",
          "65:     }",
          "69:     }",
          "72: }",
          "",
          "[Removed Lines]",
          "2: use std::process::{Command, Stdio};",
          "4: mod common;",
          "5: use common::from_status;",
          "13:     let url = target.as_ref();",
          "14:     let mut cmd = Command::new(\"open\");",
          "15:     match browser {",
          "18:             if options.dry_run {",
          "19:                 return Ok(());",
          "22:             run_command(cmd.arg(url), options)",
          "25:             let app: Option<&str> = match browser {",
          "26:                 Browser::Firefox => Some(\"Firefox\"),",
          "27:                 Browser::Chrome => Some(\"Google Chrome\"),",
          "28:                 Browser::Opera => Some(\"Opera\"),",
          "29:                 Browser::Safari => Some(\"Safari\"),",
          "30:                 Browser::WebPositive => Some(\"WebPositive\"),",
          "31:                 _ => None,",
          "32:             };",
          "33:             match app {",
          "34:                 Some(name) => {",
          "35:                     if options.dry_run {",
          "37:                         let md = std::fs::metadata(format!(\"/Applications/{}.app\", name));",
          "38:                         if md.map(|x| x.is_dir()).unwrap_or(false) {",
          "39:                             Ok(())",
          "40:                         } else {",
          "41:                             Err(Error::new(",
          "42:                                 ErrorKind::NotFound,",
          "43:                                 format!(\"Browser {} not available\", name),",
          "44:                             ))",
          "45:                         }",
          "46:                     } else {",
          "48:                         run_command(cmd.arg(\"-a\").arg(name).arg(url), options)",
          "49:                     }",
          "50:                 }",
          "51:                 None => Err(Error::new(",
          "52:                     ErrorKind::NotFound,",
          "53:                     format!(\"Unsupported browser {:?}\", browser),",
          "54:                 )),",
          "60: fn run_command(cmd: &mut Command, options: &BrowserOptions) -> Result<()> {",
          "61:     if options.suppress_output && option_env!(\"WEBBROWSER_FORCE_NO_SUPPRESS\").is_none() {",
          "62:         cmd.stdout(Stdio::null())",
          "63:             .stdin(Stdio::null())",
          "64:             .stderr(Stdio::null());",
          "67:     if option_env!(\"WEBBROWSER_DEBUG_TESTS\").is_some() {",
          "68:         println!(\"[debug-macos-tests] about to run command: {:?}\", cmd);",
          "71:     from_status(cmd.status())",
          "",
          "[Added Lines]",
          "2: use core_foundation::array::{CFArray, CFArrayRef};",
          "3: use core_foundation::base::TCFType;",
          "4: use core_foundation::error::{CFError, CFErrorRef};",
          "5: use core_foundation::url::{CFURLRef, CFURL};",
          "6: use std::os::raw::c_void;",
          "15:     let browser_cf_url = match browser {",
          "16:         Browser::Firefox => create_cf_url(\"file:///Applications/Firefox.app/\"),",
          "17:         Browser::Chrome => create_cf_url(\"file:///Applications/Google Chrome.app/\"),",
          "18:         Browser::Opera => create_cf_url(\"file:///Applications/Opera.app/\"),",
          "19:         Browser::Safari => create_cf_url(\"file:///Applications/Safari.app/\"),",
          "21:             if let Some(dummy_url) = create_cf_url(\"https://\") {",
          "22:                 let mut err: CFErrorRef = std::ptr::null_mut();",
          "23:                 let result = unsafe {",
          "24:                     LSCopyDefaultApplicationURLForURL(",
          "25:                         dummy_url.as_concrete_TypeRef(),",
          "26:                         LSROLE_VIEWER,",
          "27:                         &mut err,",
          "28:                     )",
          "29:                 };",
          "30:                 if result.is_null() {",
          "31:                     log::error!(\"failed to get default browser: {}\", unsafe {",
          "32:                         CFError::wrap_under_create_rule(err)",
          "33:                     });",
          "34:                     create_cf_url(DEFAULT_BROWSER_URL)",
          "35:                 } else {",
          "36:                     let cf_url = unsafe { CFURL::wrap_under_create_rule(result) };",
          "37:                     log::trace!(\"default browser is {:?}\", &cf_url);",
          "38:                     Some(cf_url)",
          "39:                 }",
          "40:             } else {",
          "41:                 create_cf_url(DEFAULT_BROWSER_URL)",
          "45:             return Err(Error::new(",
          "46:                 ErrorKind::NotFound,",
          "47:                 \"browser not supported on macos\",",
          "48:             ))",
          "49:         }",
          "50:     }",
          "51:     .ok_or_else(|| Error::new(ErrorKind::Other, \"failed to create CFURL\"))?;",
          "53:     let cf_url = create_cf_url(target.as_ref())",
          "54:         .ok_or_else(|| Error::new(ErrorKind::Other, \"failed to create CFURL\"))?;",
          "56:     let urls_v = [cf_url];",
          "57:     let urls_arr = CFArray::<CFURL>::from_CFTypes(&urls_v);",
          "58:     let spec = LSLaunchURLSpec {",
          "59:         app_url: browser_cf_url.as_concrete_TypeRef(),",
          "60:         item_urls: urls_arr.as_concrete_TypeRef(),",
          "61:         pass_thru_params: std::ptr::null(),",
          "62:         launch_flags: LS_LAUNCH_FLAG_DEFAULTS | LS_LAUNCH_FLAG_ASYNC,",
          "63:         async_ref_con: std::ptr::null(),",
          "64:     };",
          "67:     if options.dry_run {",
          "68:         return if let Some(path) = browser_cf_url.to_path() {",
          "69:             if path.is_dir() {",
          "70:                 log::debug!(\"dry-run: not actually opening the browser {}\", &browser);",
          "71:                 Ok(())",
          "72:             } else {",
          "73:                 log::debug!(\"dry-run: browser {} not found\", &browser);",
          "74:                 Err(Error::new(ErrorKind::NotFound, \"browser not found\"))",
          "76:         } else {",
          "77:             Err(Error::new(",
          "78:                 ErrorKind::Other,",
          "79:                 \"unable to convert app url to path\",",
          "80:             ))",
          "81:         };",
          "82:     }",
          "85:     log::trace!(",
          "86:         \"about to start browser: {} for {}\",",
          "87:         &browser,",
          "88:         target.as_ref()",
          "89:     );",
          "90:     let mut launched_app: CFURLRef = std::ptr::null_mut();",
          "91:     let status = unsafe { LSOpenFromURLSpec(&spec, &mut launched_app) };",
          "92:     log::trace!(\"received status: {}\", status);",
          "93:     if status == 0 {",
          "94:         Ok(())",
          "95:     } else {",
          "96:         Err(Error::from(LSError::from(status)))",
          "97:     }",
          "98: }",
          "101: fn create_cf_url(url: &str) -> Option<CFURL> {",
          "102:     let url_u8 = url.as_bytes();",
          "103:     let url_ref = unsafe {",
          "104:         core_foundation::url::CFURLCreateWithBytes(",
          "105:             std::ptr::null(),",
          "106:             url_u8.as_ptr(),",
          "107:             url_u8.len() as isize,",
          "108:             core_foundation::string::kCFStringEncodingUTF8,",
          "109:             std::ptr::null(),",
          "110:         )",
          "111:     };",
          "113:     if url_ref.is_null() {",
          "114:         None",
          "115:     } else {",
          "116:         Some(unsafe { CFURL::wrap_under_create_rule(url_ref) })",
          "117:     }",
          "118: }",
          "120: type OSStatus = i32;",
          "124: enum LSError {",
          "125:     Unknown(OSStatus),",
          "126:     ApplicationNotFound,",
          "127:     NoLaunchPermission,",
          "128: }",
          "130: impl From<OSStatus> for LSError {",
          "131:     fn from(status: OSStatus) -> Self {",
          "132:         match status {",
          "134:             -43 | -10814 => Self::ApplicationNotFound,",
          "135:             -10826 => Self::NoLaunchPermission,",
          "136:             _ => Self::Unknown(status),",
          "141: impl std::fmt::Display for LSError {",
          "142:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "143:         match self {",
          "144:             Self::Unknown(code) => write!(f, \"ls_error: code {}\", code),",
          "145:             Self::ApplicationNotFound => f.write_str(\"ls_error: application not found\"),",
          "146:             Self::NoLaunchPermission => f.write_str(\"ls_error: no launch permission\"),",
          "147:         }",
          "148:     }",
          "149: }",
          "151: impl std::fmt::Debug for LSError {",
          "152:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "153:         std::fmt::Display::fmt(self, f)",
          "154:     }",
          "155: }",
          "157: impl From<LSError> for Error {",
          "158:     fn from(err: LSError) -> Self {",
          "159:         let kind = match err {",
          "160:             LSError::Unknown(_) => ErrorKind::Other,",
          "161:             LSError::ApplicationNotFound => ErrorKind::NotFound,",
          "162:             LSError::NoLaunchPermission => ErrorKind::PermissionDenied,",
          "163:         };",
          "164:         Error::new(kind, err.to_string())",
          "166: }",
          "168: type LSRolesMask = u32;",
          "171: const LSROLE_VIEWER: LSRolesMask = 0x00000002;",
          "174: const LS_LAUNCH_FLAG_DEFAULTS: u32 = 0x00000001;",
          "175: const LS_LAUNCH_FLAG_ASYNC: u32 = 0x00010000;",
          "177: #[repr(C)]",
          "178: struct LSLaunchURLSpec {",
          "179:     app_url: CFURLRef,",
          "180:     item_urls: CFArrayRef,",
          "181:     pass_thru_params: *const c_void,",
          "182:     launch_flags: u32,",
          "183:     async_ref_con: *const c_void,",
          "184: }",
          "187: #[link(name = \"CoreServices\", kind = \"framework\")]",
          "188: extern \"C\" {",
          "191:     fn LSCopyDefaultApplicationURLForURL(",
          "192:         inURL: CFURLRef,",
          "193:         inRoleMask: LSRolesMask,",
          "194:         outError: *mut CFErrorRef,",
          "195:     ) -> CFURLRef;",
          "199:     fn LSOpenFromURLSpec(",
          "200:         inLaunchSpec: *const LSLaunchURLSpec,",
          "201:         outLaunchedURL: *mut CFURLRef,",
          "202:     ) -> OSStatus;",
          "203: }",
          "206: const DEFAULT_BROWSER_URL: &str = \"file:///Applications/Safari.app/\";",
          "208: #[cfg(test)]",
          "209: mod tests {",
          "210:     use super::*;",
          "212:     #[test]",
          "213:     fn open_non_existing_browser() {",
          "214:         let _ = env_logger::try_init();",
          "215:         if let Err(err) = open_browser_internal(",
          "216:             Browser::Opera,",
          "217:             &TargetType::from(\"https://github.com\"),",
          "218:             &BrowserOptions::default(),",
          "219:         ) {",
          "220:             assert_eq!(err.kind(), ErrorKind::NotFound);",
          "221:         } else {",
          "222:             panic!(\"expected opening non-existing browser to fail\");",
          "223:         }",
          "226:     #[test]",
          "227:     fn test_existence() {",
          "228:         let _ = env_logger::try_init();",
          "229:         assert!(Browser::Safari.exists());",
          "230:         assert!(!Browser::Opera.exists());",
          "231:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "809ca269d46b54cb101387e0b69e3cb387d4e6a6",
      "candidate_info": {
        "commit_hash": "809ca269d46b54cb101387e0b69e3cb387d4e6a6",
        "repo": "amodm/webbrowser-rs",
        "commit_url": "https://github.com/amodm/webbrowser-rs/commit/809ca269d46b54cb101387e0b69e3cb387d4e6a6",
        "files": [
          "src/android.rs",
          "src/common.rs",
          "src/lib.rs",
          "src/macos.rs",
          "src/unix.rs",
          "src/wasm.rs",
          "src/windows.rs"
        ],
        "message": "Breaking change: modify publicly exposed signature to bring consistency. Fixes #42",
        "before_after_code_files": [
          "src/android.rs||src/android.rs",
          "src/common.rs||src/common.rs",
          "src/lib.rs||src/lib.rs",
          "src/macos.rs||src/macos.rs",
          "src/unix.rs||src/unix.rs",
          "src/wasm.rs||src/wasm.rs",
          "src/windows.rs||src/windows.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs",
            "src/unix.rs||src/unix.rs",
            "src/windows.rs||src/windows.rs"
          ],
          "candidate": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs",
            "src/unix.rs||src/unix.rs",
            "src/windows.rs||src/windows.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/android.rs||src/android.rs": [
          "File: src/android.rs -> src/android.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: #[inline]",
          "10:     let native_activity = ndk_glue::native_activity();",
          "11:     let vm_ptr = native_activity.vm();",
          "",
          "[Removed Lines]",
          "8: pub fn open_browser_internal(_: Browser, url: &str) -> Result<ExitStatus> {",
          "",
          "[Added Lines]",
          "8: pub fn open_browser_internal(_: Browser, url: &str) -> Result<()> {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:     )",
          "62:     .map_err(|_| -> Error { Error::new(ErrorKind::Other, \"Failed to start activity\") })?;",
          "65: }",
          "",
          "[Removed Lines]",
          "64:     Ok(ExitStatus::from_raw(0))",
          "",
          "[Added Lines]",
          "64:     Ok(())",
          "",
          "---------------"
        ],
        "src/common.rs||src/common.rs": [
          "File: src/common.rs -> src/common.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: use crate::{Error, ErrorKind, Result};",
          "2: use std::process::ExitStatus;",
          "6: pub fn from_status(res: Result<ExitStatus>) -> Result<()> {",
          "7:     match res {",
          "8:         Ok(status) => {",
          "9:             if let Some(code) = status.code() {",
          "10:                 if code == 0 {",
          "11:                     Ok(())",
          "12:                 } else {",
          "13:                     Err(Error::new(",
          "14:                         ErrorKind::Other,",
          "15:                         format!(\"return code {}\", code),",
          "16:                     ))",
          "17:                 }",
          "18:             } else {",
          "19:                 Err(Error::new(ErrorKind::Other, \"interrupted by signal\"))",
          "20:             }",
          "21:         }",
          "22:         Err(err) => Err(err),",
          "23:     }",
          "24: }",
          "",
          "---------------"
        ],
        "src/lib.rs||src/lib.rs": [
          "File: src/lib.rs -> src/lib.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:     target_os = \"linux\",",
          "54:     target_os = \"freebsd\",",
          "55:     target_os = \"netbsd\",",
          "56:     target_os = \"openbsd\",",
          "61: use std::default::Default;",
          "62: use std::io::{Error, ErrorKind, Result};",
          "64: use std::str::FromStr;",
          "65: use std::{error, fmt};",
          "70: #[derive(Debug, Eq, PartialEq, Copy, Clone, Hash)]",
          "72: pub enum Browser {",
          "",
          "[Removed Lines]",
          "29: #[cfg(windows)]",
          "30: mod windows;",
          "31: #[cfg(windows)]",
          "32: use windows::*;",
          "34: #[cfg(target_os = \"android\")]",
          "35: mod android;",
          "36: #[cfg(target_os = \"android\")]",
          "37: use android::*;",
          "39: #[cfg(target_os = \"macos\")]",
          "40: mod macos;",
          "41: #[cfg(target_os = \"macos\")]",
          "42: use macos::*;",
          "44: #[cfg(any(",
          "45:     target_os = \"linux\",",
          "46:     target_os = \"freebsd\",",
          "47:     target_os = \"netbsd\",",
          "48:     target_os = \"openbsd\",",
          "49:     target_os = \"haiku\"",
          "50: ))]",
          "51: mod unix;",
          "52: #[cfg(any(",
          "57:     target_os = \"haiku\"",
          "58: ))]",
          "59: use unix::*;",
          "63: use std::process::{ExitStatus, Output};",
          "67: #[cfg(target_arch = \"wasm32\")]",
          "68: use web_sys::Window;",
          "",
          "[Added Lines]",
          "29: #[cfg_attr(target_os = \"macos\", path = \"macos.rs\")]",
          "30: #[cfg_attr(target_os = \"android\", path = \"android.rs\")]",
          "31: #[cfg_attr(target_arch = \"wasm32\", path = \"wasm.rs\")]",
          "32: #[cfg_attr(windows, path = \"windows.rs\")]",
          "33: #[cfg_attr(",
          "34:     any(",
          "35:         target_os = \"linux\",",
          "36:         target_os = \"freebsd\",",
          "37:         target_os = \"netbsd\",",
          "38:         target_os = \"openbsd\",",
          "39:         target_os = \"haiku\"",
          "40:     ),",
          "41:     path = \"unix.rs\"",
          "42: )]",
          "43: mod os;",
          "45: #[cfg(not(any(",
          "46:     target_os = \"android\",",
          "47:     target_os = \"windows\",",
          "48:     target_os = \"macos\",",
          "53:     target_os = \"haiku\",",
          "54:     target_arch = \"wasm32\"",
          "55: )))]",
          "56: compile_error!(\"Only Windows, Mac OS, Linux, *BSD and Haiku and Wasm32 are currently supported\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "174: pub fn open(url: &str) -> Result<()> {",
          "186: }",
          "",
          "[Removed Lines]",
          "168: #[cfg(not(target_arch = \"wasm32\"))]",
          "169: pub fn open(url: &str) -> Result<Output> {",
          "170:     open_browser(Browser::Default, url)",
          "171: }",
          "173: #[cfg(target_arch = \"wasm32\")]",
          "175:     let window = web_sys::window();",
          "176:     match window {",
          "177:         Some(w) => {",
          "178:             w.open_with_url(url);",
          "179:             Ok(())",
          "180:         }",
          "181:         None => Err(std::io::Error::new(",
          "182:             ErrorKind::Other,",
          "183:             \"should have a window in this context\",",
          "184:         )),",
          "185:     }",
          "",
          "[Added Lines]",
          "162:     open_browser(Browser::Default, url)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "219: }",
          "234: #[test]",
          "235: #[ignore]",
          "236: fn test_open_firefox() {",
          "",
          "[Removed Lines]",
          "199: #[cfg(not(target_arch = \"wasm32\"))]",
          "200: pub fn open_browser(browser: Browser, url: &str) -> Result<Output> {",
          "201:     open_browser_internal(browser, url).and_then(|status| {",
          "202:         if let Some(code) = status.code() {",
          "203:             if code == 0 {",
          "204:                 Ok(Output {",
          "205:                     status: ExitStatus::from_raw(0),",
          "206:                     stdout: vec![],",
          "207:                     stderr: vec![],",
          "208:                 })",
          "209:             } else {",
          "210:                 Err(Error::new(",
          "211:                     ErrorKind::Other,",
          "212:                     format!(\"return code {}\", code),",
          "213:                 ))",
          "214:             }",
          "215:         } else {",
          "216:             Err(Error::new(ErrorKind::Other, \"interrupted by signal\"))",
          "217:         }",
          "218:     })",
          "221: #[cfg(not(any(",
          "222:     target_os = \"android\",",
          "223:     target_os = \"windows\",",
          "224:     target_os = \"macos\",",
          "225:     target_os = \"linux\",",
          "226:     target_os = \"freebsd\",",
          "227:     target_os = \"netbsd\",",
          "228:     target_os = \"openbsd\",",
          "229:     target_os = \"haiku\",",
          "230:     target_arch = \"wasm32\"",
          "231: )))]",
          "232: compile_error!(\"Only Windows, Mac OS, Linux, *BSD and Haiku and Wasm32 are currently supported\");",
          "",
          "[Added Lines]",
          "176: pub fn open_browser(browser: Browser, url: &str) -> Result<()> {",
          "177:     os::open_browser_internal(browser, url)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "243:     assert!(open_browser(Browser::Chrome, \"http://github.com\").is_ok());",
          "244: }",
          "252: #[test]",
          "253: #[ignore]",
          "254: fn test_open_safari() {",
          "",
          "[Removed Lines]",
          "246: #[test]",
          "247: #[cfg(target_arch = \"wasm32\")]",
          "248: fn test_open_default_wasm() {",
          "249:     assert!(open(\"http://github.com\").is_ok());",
          "250: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/macos.rs||src/macos.rs": [
          "File: src/macos.rs -> src/macos.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use crate::{Browser, Error, ErrorKind, Result};",
          "6: #[inline]",
          "8:     let mut cmd = Command::new(\"open\");",
          "9:     match browser {",
          "11:         _ => {",
          "12:             let app: Option<&str> = match browser {",
          "13:                 Browser::Firefox => Some(\"Firefox\"),",
          "",
          "[Removed Lines]",
          "2: pub use std::os::unix::process::ExitStatusExt;",
          "3: use std::process::{Command, ExitStatus};",
          "7: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<ExitStatus> {",
          "10:         Browser::Default => cmd.arg(url).status(),",
          "",
          "[Added Lines]",
          "2: use std::process::Command;",
          "4: mod common;",
          "5: use common::from_status;",
          "9: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<()> {",
          "12:         Browser::Default => from_status(cmd.arg(url).status()),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "18:                 _ => None,",
          "19:             };",
          "20:             match app {",
          "22:                 None => Err(Error::new(",
          "23:                     ErrorKind::NotFound,",
          "24:                     format!(\"Unsupported browser {:?}\", browser),",
          "",
          "[Removed Lines]",
          "21:                 Some(name) => cmd.arg(\"-a\").arg(name).arg(url).status(),",
          "",
          "[Added Lines]",
          "23:                 Some(name) => from_status(cmd.arg(\"-a\").arg(name).arg(url).status()),",
          "",
          "---------------"
        ],
        "src/unix.rs||src/unix.rs": [
          "File: src/unix.rs -> src/unix.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use crate::{Browser, Error, ErrorKind, Result};",
          "3: use std::process::{Command, ExitStatus};",
          "",
          "[Removed Lines]",
          "2: pub use std::os::unix::process::ExitStatusExt;",
          "",
          "[Added Lines]",
          "2: use std::os::unix::process::ExitStatusExt;",
          "5: mod common;",
          "6: use common::from_status;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "11: #[inline]",
          "13:     match browser {",
          "14:         Browser::Default => open_on_unix_using_browser_env(url)",
          "15:             .or_else(|_| -> Result<ExitStatus> { Command::new(\"xdg-open\").arg(url).status() })",
          "",
          "[Removed Lines]",
          "12: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<ExitStatus> {",
          "",
          "[Added Lines]",
          "15: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<()> {",
          "16:     from_status(open_browser_unix(browser, url))",
          "17: }",
          "19: fn open_browser_unix(browser: Browser, url: &str) -> Result<ExitStatus> {",
          "",
          "---------------"
        ],
        "src/wasm.rs||src/wasm.rs": [
          "File: src/wasm.rs -> src/wasm.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: use crate::{Browser, ErrorKind, Result};",
          "5: #[inline]",
          "6: pub fn open_browser_internal(_: Browser, url: &str) -> Result<()> {",
          "8:     let configured_target = option_env!(\"WEBBROWSER_WASM_TARGET\");",
          "9:     let window = web_sys::window();",
          "10:     match window {",
          "11:         Some(w) => {",
          "12:             let target = configured_target.unwrap_or_else(|| \"_blank\");",
          "13:             wasm_console_log(&format!(\"target for url {} detected as {}\", url, target));",
          "15:             match w.open_with_url_and_target(url, target) {",
          "16:                 Ok(x) => match x {",
          "17:                     Some(y) => Ok(()),",
          "18:                     None => {",
          "19:                         const err_msg: &'static str =",
          "20:                             \"popup blocked? window detected, but open_url failed\";",
          "21:                         wasm_console_log(&err_msg);",
          "22:                         Err(std::io::Error::new(ErrorKind::Other, err_msg))",
          "23:                     }",
          "24:                 },",
          "25:                 Err(_) => {",
          "26:                     wasm_console_log(\"window error while opening url\");",
          "27:                     Err(std::io::Error::new(ErrorKind::Other, \"error opening url\"))",
          "28:                 }",
          "29:             }",
          "30:         }",
          "31:         None => Err(std::io::Error::new(",
          "32:             ErrorKind::Other,",
          "33:             \"should have a window in this context\",",
          "34:         )),",
          "35:     }",
          "36: }",
          "39: fn wasm_console_log(msg: &str) {",
          "40:     #[cfg(debug_assertions)]",
          "41:     web_sys::console::log_1(&format!(\"[webbrowser] {}\", &msg).into());",
          "42: }",
          "",
          "---------------"
        ],
        "src/windows.rs||src/windows.rs": [
          "File: src/windows.rs -> src/windows.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: use crate::{Browser, Error, ErrorKind, Result};",
          "5: pub use std::os::windows::process::ExitStatusExt;",
          "7: use std::ptr;",
          "8: use widestring::U16CString;",
          "",
          "[Removed Lines]",
          "6: use std::process::ExitStatus;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "13: #[inline]",
          "15:     use winapi::shared::winerror::SUCCEEDED;",
          "16:     use winapi::um::combaseapi::{CoInitializeEx, CoUninitialize};",
          "17:     use winapi::um::objbase::{COINIT_APARTMENTTHREADED, COINIT_DISABLE_OLE1DDE};",
          "",
          "[Removed Lines]",
          "14: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<ExitStatus> {",
          "",
          "[Added Lines]",
          "13: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<()> {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "41:                 code",
          "42:             };",
          "43:             if code > 32 {",
          "45:             } else {",
          "46:                 Err(Error::last_os_error())",
          "47:             }",
          "",
          "[Removed Lines]",
          "44:                 Ok(ExitStatus::from_raw(0))",
          "",
          "[Added Lines]",
          "43:                 Ok(())",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a800e535b7cfdc33b597f4507a91166ecaf92952",
      "candidate_info": {
        "commit_hash": "a800e535b7cfdc33b597f4507a91166ecaf92952",
        "repo": "amodm/webbrowser-rs",
        "commit_url": "https://github.com/amodm/webbrowser-rs/commit/a800e535b7cfdc33b597f4507a91166ecaf92952",
        "files": [
          ".github/workflows/macos.yaml",
          "src/macos.rs"
        ],
        "message": "conditional compilation for debugging macos tests",
        "before_after_code_files": [
          "src/macos.rs||src/macos.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/macos.rs||src/macos.rs"
          ],
          "candidate": [
            "src/macos.rs||src/macos.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/macos.rs||src/macos.rs": [
          "File: src/macos.rs -> src/macos.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "40: }",
          "42: fn run_command(cmd: &mut Command, options: &BrowserOptions) -> Result<()> {",
          "44:         cmd.stdout(Stdio::null())",
          "45:             .stdin(Stdio::null())",
          "46:             .stderr(Stdio::null());",
          "47:     }",
          "48:     from_status(cmd.status())",
          "49: }",
          "",
          "[Removed Lines]",
          "43:     if options.suppress_output {",
          "",
          "[Added Lines]",
          "43:     if options.suppress_output && !option_env!(\"WEBBROWSER_FORCE_NO_SUPPRESS\").is_some() {",
          "49:     if option_env!(\"WEBBROWSER_DEBUG_TESTS\").is_some() {",
          "50:         println!(\"[debug-macos-tests] about to run command: {:?}\", cmd);",
          "51:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "11789ddfe36264bbbe7d596ab61e3fff855c3adb",
      "candidate_info": {
        "commit_hash": "11789ddfe36264bbbe7d596ab61e3fff855c3adb",
        "repo": "amodm/webbrowser-rs",
        "commit_url": "https://github.com/amodm/webbrowser-rs/commit/11789ddfe36264bbbe7d596ab61e3fff855c3adb",
        "files": [
          "Cargo.toml",
          "README.md",
          "src/lib.rs",
          "src/macos.rs",
          "tests/common.rs",
          "tests/test_macos.rs"
        ],
        "message": "fix handling of unicode characters in URL",
        "before_after_code_files": [
          "src/lib.rs||src/lib.rs",
          "src/macos.rs||src/macos.rs",
          "tests/common.rs||tests/common.rs",
          "tests/test_macos.rs||tests/test_macos.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs"
          ],
          "candidate": [
            "src/lib.rs||src/lib.rs",
            "src/macos.rs||src/macos.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/lib.rs||src/lib.rs": [
          "File: src/lib.rs -> src/lib.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "179: pub fn open_browser(browser: Browser, url: &str) -> Result<()> {",
          "181: }",
          "183: #[test]",
          "",
          "[Removed Lines]",
          "180:     os::open_browser_internal(browser, url)",
          "",
          "[Added Lines]",
          "180:     let url_s: String = match url::Url::parse(url) {",
          "181:         Ok(u) => u.as_str().into(),",
          "182:         Err(_) => url.into(),",
          "183:     };",
          "184:     os::open_browser_internal(browser, &url_s)",
          "",
          "---------------"
        ],
        "src/macos.rs||src/macos.rs": [
          "File: src/macos.rs -> src/macos.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: #[inline]",
          "10:     let mut cmd = Command::new(\"open\");",
          "11:     match browser {",
          "12:         Browser::Default => from_status(cmd.arg(url).status()),",
          "",
          "[Removed Lines]",
          "9: pub fn open_browser_internal(browser: Browser, url: &str) -> Result<()> {",
          "",
          "[Added Lines]",
          "9: pub fn open_browser_internal(browser: Browser, url_raw: &str) -> Result<()> {",
          "10:     let url_s: String = match url::Url::parse(url_raw) {",
          "11:         Ok(u) => u.as_str().into(),",
          "12:         Err(_) => url_raw.into(),",
          "13:     };",
          "14:     let url = &url_s;",
          "",
          "---------------"
        ],
        "tests/common.rs||tests/common.rs": [
          "File: tests/common.rs -> tests/common.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "70: #[allow(dead_code)]",
          "71: pub async fn check_browser(browser: Browser, platform: &str) {",
          "72:     check_request_received(browser, format!(\"/{}\", platform)).await;",
          "74: }",
          "",
          "[Removed Lines]",
          "73:     check_request_received(browser, format!(\"/{}/\uff4e\uff4f\uff4e\uff41\uff53\uff43\uff49\uff49\", platform)).await;",
          "",
          "[Added Lines]",
          "73:     check_request_received(browser, format!(\"/{}/\ud83d\ude00\ud83d\ude00\ud83d\ude00\", platform)).await;",
          "",
          "---------------"
        ],
        "tests/test_macos.rs||tests/test_macos.rs": [
          "File: tests/test_macos.rs -> tests/test_macos.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: mod tests {",
          "6:     const TEST_PLATFORM: &str = \"macos\";",
          "9:     use webbrowser::Browser;",
          "11:     #[actix_rt::test]",
          "12:     async fn test_open_default() {",
          "16:     }",
          "18:     #[actix_rt::test]",
          "19:     async fn test_open_safari() {",
          "23:     }",
          "25:     #[actix_rt::test]",
          "",
          "[Removed Lines]",
          "8:     use super::common::{check_browser, check_request_received};",
          "15:         check_request_received(Browser::Default, format!(\"/{}\", TEST_PLATFORM)).await;",
          "22:         check_request_received(Browser::Safari, format!(\"/{}\", TEST_PLATFORM)).await;",
          "",
          "[Added Lines]",
          "8:     use super::common::check_browser;",
          "13:         check_browser(Browser::Default, TEST_PLATFORM).await;",
          "18:         check_browser(Browser::Safari, TEST_PLATFORM).await;",
          "",
          "---------------"
        ]
      }
    }
  ]
}