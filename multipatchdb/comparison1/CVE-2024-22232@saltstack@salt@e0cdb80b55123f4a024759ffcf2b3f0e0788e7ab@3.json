{
  "cve_id": "CVE-2024-22232",
  "cve_desc": "A specially crafted url can be created which leads to a directory traversal in the salt file server.\nA malicious user can read an arbitrary file from a Salt master\u2019s filesystem.",
  "repo": "saltstack/salt",
  "patch_hash": "e0cdb80b55123f4a024759ffcf2b3f0e0788e7ab",
  "patch_info": {
    "commit_hash": "e0cdb80b55123f4a024759ffcf2b3f0e0788e7ab",
    "repo": "saltstack/salt",
    "commit_url": "https://github.com/saltstack/salt/commit/e0cdb80b55123f4a024759ffcf2b3f0e0788e7ab",
    "files": [
      "salt/fileserver/__init__.py",
      "salt/fileserver/roots.py",
      "salt/master.py",
      "tests/pytests/unit/fileserver/test_roots.py",
      "tests/pytests/unit/test_fileserver.py",
      "tests/pytests/unit/test_master.py",
      "tests/unit/test_fileserver.py"
    ],
    "message": "CVE fix",
    "before_after_code_files": [
      "salt/fileserver/__init__.py||salt/fileserver/__init__.py",
      "salt/fileserver/roots.py||salt/fileserver/roots.py",
      "salt/master.py||salt/master.py",
      "tests/pytests/unit/fileserver/test_roots.py||tests/pytests/unit/fileserver/test_roots.py",
      "tests/pytests/unit/test_fileserver.py||tests/pytests/unit/test_fileserver.py",
      "tests/pytests/unit/test_master.py||tests/pytests/unit/test_master.py",
      "tests/unit/test_fileserver.py||tests/unit/test_fileserver.py"
    ]
  },
  "patch_diff": {
    "salt/fileserver/__init__.py||salt/fileserver/__init__.py": [
      "File: salt/fileserver/__init__.py -> salt/fileserver/__init__.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "568:         saltenv = salt.utils.stringutils.to_unicode(saltenv)",
      "569:         back = self.backends(back)",
      "570:         kwargs = {}",
      "576:         if salt.utils.url.is_escaped(path):",
      "577:             # don't attempt to find URL query arguments in the path",
      "578:             path = salt.utils.url.unescape(path)",
      "",
      "[Removed Lines]",
      "571:         fnd = {\"path\": \"\", \"rel\": \"\"}",
      "572:         if os.path.isabs(path):",
      "573:             return fnd",
      "574:         if \"../\" in path:",
      "575:             return fnd",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "588:                     args = comp.split(\"=\", 1)",
      "589:                     kwargs[args[0]] = args[1]",
      "591:         if \"env\" in kwargs:",
      "592:             # \"env\" is not supported; Use \"saltenv\".",
      "593:             kwargs.pop(\"env\")",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "586:         fnd = {\"path\": \"\", \"rel\": \"\"}",
      "587:         if os.path.isabs(path) or \"../\" in path:",
      "588:             return fnd",
      "",
      "---------------"
    ],
    "salt/fileserver/roots.py||salt/fileserver/roots.py": [
      "File: salt/fileserver/roots.py -> salt/fileserver/roots.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: import salt.utils.path",
      "28: import salt.utils.platform",
      "29: import salt.utils.stringutils",
      "30: import salt.utils.versions",
      "32: log = logging.getLogger(__name__)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "30: import salt.utils.verify",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "98:         if saltenv == \"__env__\":",
      "99:             root = root.replace(\"__env__\", actual_saltenv)",
      "100:         full = os.path.join(root, path)",
      "101:         if os.path.isfile(full) and not salt.fileserver.is_file_ignored(__opts__, full):",
      "102:             fnd[\"path\"] = full",
      "103:             fnd[\"rel\"] = path",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "103:         # Refuse to serve file that is not under the root.",
      "104:         if not salt.utils.verify.clean_path(root, full, subdir=True):",
      "105:             continue",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "128:     ret[\"dest\"] = fnd[\"rel\"]",
      "129:     gzip = load.get(\"gzip\", None)",
      "130:     fpath = os.path.normpath(fnd[\"path\"])",
      "131:     with salt.utils.files.fopen(fpath, \"rb\") as fp_:",
      "132:         fp_.seek(load[\"loc\"])",
      "133:         data = fp_.read(__opts__[\"file_buffer_size\"])",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "138:     actual_saltenv = saltenv = load[\"saltenv\"]",
      "139:     if saltenv not in __opts__[\"file_roots\"]:",
      "140:         if \"__env__\" in __opts__[\"file_roots\"]:",
      "141:             log.debug(",
      "142:                 \"salt environment '%s' maps to __env__ file_roots directory\", saltenv",
      "143:             )",
      "144:             saltenv = \"__env__\"",
      "145:         else:",
      "146:             return fnd",
      "147:     file_in_root = False",
      "148:     for root in __opts__[\"file_roots\"][saltenv]:",
      "149:         if saltenv == \"__env__\":",
      "150:             root = root.replace(\"__env__\", actual_saltenv)",
      "151:         # Refuse to serve file that is not under the root.",
      "152:         if salt.utils.verify.clean_path(root, fpath, subdir=True):",
      "153:             file_in_root = True",
      "154:     if not file_in_root:",
      "155:         return ret",
      "",
      "---------------"
    ],
    "salt/master.py||salt/master.py": [
      "File: salt/master.py -> salt/master.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1036:         \"\"\"",
      "1037:         key = payload[\"enc\"]",
      "1038:         load = payload[\"load\"]",
      "1040:         raise salt.ext.tornado.gen.Return(ret)",
      "1042:     def _post_stats(self, start, cmd):",
      "",
      "[Removed Lines]",
      "1039:         ret = {\"aes\": self._handle_aes, \"clear\": self._handle_clear}[key](load)",
      "",
      "[Added Lines]",
      "1039:         if key == \"aes\":",
      "1040:             ret = self.handle_aes(load)",
      "1041:         else:",
      "1042:             ret = self.handle_clear(load)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1738:                 self.mminion.returners[fstr](load[\"jid\"], load[\"load\"])",
      "1740:             # Register the syndic",
      "1741:             syndic_cache_path = os.path.join(",
      "1742:                 self.opts[\"cachedir\"], \"syndics\", load[\"id\"]",
      "1743:             )",
      "1745:                 path_name = os.path.split(syndic_cache_path)[0]",
      "1746:                 if not os.path.exists(path_name):",
      "1747:                     os.makedirs(path_name)",
      "",
      "[Removed Lines]",
      "1744:             if not os.path.exists(syndic_cache_path):",
      "",
      "[Added Lines]",
      "1745:             # We are creating a path using user suplied input. Use the",
      "1746:             # clean_path to prevent a directory traversal.",
      "1747:             root = os.path.join(self.opts[\"cachedir\"], \"syndics\")",
      "1751:             if salt.utils.verify.clean_path(",
      "1752:                 root, syndic_cache_path",
      "1753:             ) and not os.path.exists(syndic_cache_path):",
      "",
      "---------------"
    ],
    "tests/pytests/unit/fileserver/test_roots.py||tests/pytests/unit/fileserver/test_roots.py": [
      "File: tests/pytests/unit/fileserver/test_roots.py -> tests/pytests/unit/fileserver/test_roots.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "53:     return dirname",
      "56: @pytest.fixture",
      "57: def configure_loader_modules(tmp_state_tree, temp_salt_master):",
      "58:     opts = temp_salt_master.config.copy()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "56: @pytest.fixture(autouse=True)",
      "57: def testfilepath(tmp_state_tree, testfile):",
      "58:     return tmp_state_tree / testfile.name",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "75:     assert full_path_to_file == ret[\"path\"]",
      "79:     with patch.dict(roots.__opts__, {\"file_buffer_size\": 262144}):",
      "80:         load = {",
      "81:             \"saltenv\": \"base\",",
      "83:             \"loc\": 0,",
      "84:         }",
      "86:         ret = roots.serve_file(load, fnd)",
      "89:             data = fp_.read()",
      "91:         assert ret == {\"data\": data, \"dest\": \"testfile\"}",
      "",
      "[Removed Lines]",
      "78: def test_serve_file(testfile):",
      "82:             \"path\": str(testfile),",
      "85:         fnd = {\"path\": str(testfile), \"rel\": \"testfile\"}",
      "88:         with salt.utils.files.fopen(str(testfile), \"rb\") as fp_:",
      "",
      "[Added Lines]",
      "83: def test_serve_file(testfilepath):",
      "87:             \"path\": str(testfilepath),",
      "90:         fnd = {\"path\": str(testfilepath), \"rel\": \"testfile\"}",
      "93:         with salt.utils.files.fopen(str(testfilepath), \"rb\") as fp_:",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "236:     # between Python releases.",
      "237:     lines_written = sorted(mtime_map_mock.write_calls())",
      "238:     expected = sorted(",
      "240:         for key, val in new_mtime_map.items()",
      "241:     )",
      "242:     assert lines_written == expected, lines_written",
      "",
      "[Removed Lines]",
      "239:         salt.utils.stringutils.to_bytes(\"{key}:{val}\\n\".format(key=key, val=val))",
      "",
      "[Added Lines]",
      "244:         salt.utils.stringutils.to_bytes(f\"{key}:{val}\\n\")",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "277:         },",
      "278:         \"backend\": \"roots\",",
      "279:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "287: def test_find_file_not_in_root(tmp_state_tree):",
      "288:     \"\"\"",
      "289:     Fileroots should never 'find' a file that is outside of it's root.",
      "290:     \"\"\"",
      "291:     badfile = pathlib.Path(tmp_state_tree).parent / \"bar\"",
      "292:     badfile.write_text(\"Bad file\")",
      "293:     badpath = f\"../bar\"",
      "294:     ret = roots.find_file(badpath)",
      "295:     assert ret == {\"path\": \"\", \"rel\": \"\"}",
      "296:     badpath = f\"{tmp_state_tree / '..' / 'bar'}\"",
      "297:     ret = roots.find_file(badpath)",
      "298:     assert ret == {\"path\": \"\", \"rel\": \"\"}",
      "301: def test_serve_file_not_in_root(tmp_state_tree):",
      "302:     \"\"\"",
      "303:     Fileroots should never 'serve' a file that is outside of it's root.",
      "304:     \"\"\"",
      "305:     badfile = pathlib.Path(tmp_state_tree).parent / \"bar\"",
      "306:     badfile.write_text(\"Bad file\")",
      "307:     badpath = f\"../bar\"",
      "308:     load = {\"path\": \"salt://|..\\\\bar\", \"saltenv\": \"base\", \"loc\": 0}",
      "309:     fnd = {",
      "310:         \"path\": f\"{tmp_state_tree / '..' / 'bar'}\",",
      "311:         \"rel\": f\"{pathlib.Path('..') / 'bar'}\",",
      "312:     }",
      "313:     ret = roots.serve_file(load, fnd)",
      "314:     assert ret == {\"data\": \"\", \"dest\": \"../bar\"}",
      "",
      "---------------"
    ],
    "tests/pytests/unit/test_fileserver.py||tests/pytests/unit/test_fileserver.py": [
      "File: tests/pytests/unit/test_fileserver.py -> tests/pytests/unit/test_fileserver.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: \"\"\"",
      "2: \"\"\"",
      "5: import datetime",
      "6: import os",
      "7: import time",
      "9: import salt.fileserver",
      "10: import salt.utils.files",
      "13: def test_diff_with_diffent_keys():",
      "14:     \"\"\"",
      "15:     Test that different maps are indeed reported different",
      "16:     \"\"\"",
      "17:     map1 = {\"file1\": 1234}",
      "18:     map2 = {\"file2\": 1234}",
      "19:     assert salt.fileserver.diff_mtime_map(map1, map2) is True",
      "22: def test_diff_with_diffent_values():",
      "23:     \"\"\"",
      "24:     Test that different maps are indeed reported different",
      "25:     \"\"\"",
      "26:     map1 = {\"file1\": 12345}",
      "27:     map2 = {\"file1\": 1234}",
      "28:     assert salt.fileserver.diff_mtime_map(map1, map2) is True",
      "31: def test_whitelist():",
      "32:     opts = {",
      "33:         \"fileserver_backend\": [\"roots\", \"git\", \"s3fs\", \"hgfs\", \"svn\"],",
      "34:         \"extension_modules\": \"\",",
      "35:     }",
      "36:     fs = salt.fileserver.Fileserver(opts)",
      "37:     assert sorted(fs.servers.whitelist) == sorted(",
      "38:         [\"git\", \"gitfs\", \"hg\", \"hgfs\", \"svn\", \"svnfs\", \"roots\", \"s3fs\"]",
      "39:     ), fs.servers.whitelist",
      "42: def test_future_file_list_cache_file_ignored(tmp_path):",
      "43:     opts = {",
      "44:         \"fileserver_backend\": [\"roots\"],",
      "45:         \"cachedir\": tmp_path,",
      "46:         \"extension_modules\": \"\",",
      "47:     }",
      "49:     back_cachedir = os.path.join(tmp_path, \"file_lists/roots\")",
      "50:     os.makedirs(os.path.join(back_cachedir))",
      "52:     # Touch a couple files",
      "53:     for filename in (\"base.p\", \"foo.txt\"):",
      "54:         with salt.utils.files.fopen(os.path.join(back_cachedir, filename), \"wb\") as _f:",
      "55:             if filename == \"base.p\":",
      "56:                 _f.write(b\"\\x80\")",
      "58:     # Set modification time to file list cache file to 1 year in the future",
      "59:     now = datetime.datetime.utcnow()",
      "60:     future = now + datetime.timedelta(days=365)",
      "61:     mod_time = time.mktime(future.timetuple())",
      "62:     os.utime(os.path.join(back_cachedir, \"base.p\"), (mod_time, mod_time))",
      "64:     list_cache = os.path.join(back_cachedir, \"base.p\")",
      "65:     w_lock = os.path.join(back_cachedir, \".base.w\")",
      "66:     ret = salt.fileserver.check_file_list_cache(opts, \"files\", list_cache, w_lock)",
      "67:     assert (",
      "68:         ret[1] is True",
      "69:     ), \"Cache file list cache file is not refreshed when future modification time\"",
      "72: def test_file_server_url_escape(tmp_path):",
      "73:     (tmp_path / \"srv\").mkdir()",
      "74:     (tmp_path / \"srv\" / \"salt\").mkdir()",
      "75:     (tmp_path / \"foo\").mkdir()",
      "76:     (tmp_path / \"foo\" / \"bar\").write_text(\"Bad file\")",
      "77:     fileroot = str(tmp_path / \"srv\" / \"salt\")",
      "78:     badfile = str(tmp_path / \"foo\" / \"bar\")",
      "79:     opts = {",
      "80:         \"fileserver_backend\": [\"roots\"],",
      "81:         \"extension_modules\": \"\",",
      "82:         \"optimization_order\": [",
      "83:             0,",
      "84:         ],",
      "85:         \"file_roots\": {",
      "86:             \"base\": [fileroot],",
      "87:         },",
      "88:         \"file_ignore_regex\": \"\",",
      "89:         \"file_ignore_glob\": \"\",",
      "90:     }",
      "91:     fs = salt.fileserver.Fileserver(opts)",
      "92:     ret = fs.find_file(",
      "93:         \"salt://|..\\\\..\\\\..\\\\foo/bar\",",
      "94:         \"base\",",
      "95:     )",
      "96:     assert ret == {\"path\": \"\", \"rel\": \"\"}",
      "99: def test_file_server_serve_url_escape(tmp_path):",
      "100:     (tmp_path / \"srv\").mkdir()",
      "101:     (tmp_path / \"srv\" / \"salt\").mkdir()",
      "102:     (tmp_path / \"foo\").mkdir()",
      "103:     (tmp_path / \"foo\" / \"bar\").write_text(\"Bad file\")",
      "104:     fileroot = str(tmp_path / \"srv\" / \"salt\")",
      "105:     badfile = str(tmp_path / \"foo\" / \"bar\")",
      "106:     opts = {",
      "107:         \"fileserver_backend\": [\"roots\"],",
      "108:         \"extension_modules\": \"\",",
      "109:         \"optimization_order\": [",
      "110:             0,",
      "111:         ],",
      "112:         \"file_roots\": {",
      "113:             \"base\": [fileroot],",
      "114:         },",
      "115:         \"file_ignore_regex\": \"\",",
      "116:         \"file_ignore_glob\": \"\",",
      "117:         \"file_buffer_size\": 2048,",
      "118:     }",
      "119:     fs = salt.fileserver.Fileserver(opts)",
      "120:     ret = fs.serve_file(",
      "121:         {",
      "122:             \"path\": \"salt://|..\\\\..\\\\..\\\\foo/bar\",",
      "123:             \"saltenv\": \"base\",",
      "124:             \"loc\": 0,",
      "125:         }",
      "126:     )",
      "127:     assert ret == {\"data\": \"\", \"dest\": \"\"}",
      "",
      "---------------"
    ],
    "tests/pytests/unit/test_master.py||tests/pytests/unit/test_master.py": [
      "File: tests/pytests/unit/test_master.py -> tests/pytests/unit/test_master.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: import time",
      "3: import pytest",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: import pathlib",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "160:     with patch.object(encrypted_requests, \"_return\", autospec=True) as fake_return:",
      "161:         encrypted_requests._syndic_return(payload)",
      "162:         fake_return.assert_called_with(expected_return)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "166: def test_syndic_return_cache_dir_creation(encrypted_requests):",
      "167:     \"\"\"master's cachedir for a syndic will be created by AESFuncs._syndic_return method\"\"\"",
      "168:     cachedir = pathlib.Path(encrypted_requests.opts[\"cachedir\"])",
      "169:     assert not (cachedir / \"syndics\").exists()",
      "170:     encrypted_requests._syndic_return(",
      "171:         {",
      "172:             \"id\": \"mamajama\",",
      "173:             \"jid\": \"\",",
      "174:             \"return\": {},",
      "175:         }",
      "176:     )",
      "177:     assert (cachedir / \"syndics\").exists()",
      "178:     assert (cachedir / \"syndics\" / \"mamajama\").exists()",
      "181: def test_syndic_return_cache_dir_creation_traversal(encrypted_requests):",
      "182:     \"\"\"",
      "183:     master's  AESFuncs._syndic_return method cachdir creation is not vulnerable to a directory traversal",
      "184:     \"\"\"",
      "185:     cachedir = pathlib.Path(encrypted_requests.opts[\"cachedir\"])",
      "186:     assert not (cachedir / \"syndics\").exists()",
      "187:     encrypted_requests._syndic_return(",
      "188:         {",
      "189:             \"id\": \"../mamajama\",",
      "190:             \"jid\": \"\",",
      "191:             \"return\": {},",
      "192:         }",
      "193:     )",
      "194:     assert not (cachedir / \"syndics\").exists()",
      "195:     assert not (cachedir / \"mamajama\").exists()",
      "",
      "---------------"
    ],
    "tests/unit/test_fileserver.py||tests/unit/test_fileserver.py": [
      "File: tests/unit/test_fileserver.py -> tests/unit/test_fileserver.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d8facee4de9fda5ed26c6622acfad603a904bd90",
      "candidate_info": {
        "commit_hash": "d8facee4de9fda5ed26c6622acfad603a904bd90",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/d8facee4de9fda5ed26c6622acfad603a904bd90",
        "files": [
          ".pylintrc",
          "tests/pytests/unit/utils/test_aws.py"
        ],
        "message": "Fix and `AttributeError` on Windows\n\n```\nAttributeError: module 'signal' has no attribute 'SIGALRM'. Did you mean: 'SIGABRT'?\n```\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/unit/utils/test_aws.py||tests/pytests/unit/utils/test_aws.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65969"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/unit/utils/test_aws.py||tests/pytests/unit/utils/test_aws.py": [
          "File: tests/pytests/unit/utils/test_aws.py -> tests/pytests/unit/utils/test_aws.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: import pytest",
          "13: import requests",
          "15: import salt.utils.aws as aws",
          "16: from tests.support.helpers import patched_environ",
          "17: from tests.support.mock import MagicMock, patch",
          "19: pytestmark = [",
          "22:     pytest.mark.skip_on_windows,",
          "24: ]",
          "",
          "[Removed Lines]",
          "20:     # Skip testing on windows since it does not support signals",
          "21:     # which is what the timeout marker is using.",
          "23:     pytest.mark.timeout(60, method=\"signal\"),",
          "",
          "[Added Lines]",
          "14: from pytest_timeout import DEFAULT_METHOD",
          "21:     # Skip testing on windows since it does not support signal.SIGALRM",
          "22:     # which is what the timeout marker is using by default.",
          "24:     pytest.mark.timeout(60, method=DEFAULT_METHOD),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81e15ea6c9bc53d410322a47916a0f106dee66c5",
      "candidate_info": {
        "commit_hash": "81e15ea6c9bc53d410322a47916a0f106dee66c5",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/81e15ea6c9bc53d410322a47916a0f106dee66c5",
        "files": [
          ".github/workflows/test-packages-action-linux.yml",
          ".github/workflows/test-packages-action-macos.yml",
          ".gitignore",
          "doc/topics/packaging/testing.rst",
          "noxfile.py",
          "pkg/tests/__init__.py",
          "pkg/tests/conftest.py",
          "pkg/tests/downgrade/__init__.py",
          "pkg/tests/downgrade/test_salt_downgrade.py",
          "pkg/tests/download/__init__.py",
          "pkg/tests/download/test_pkg_download.py",
          "pkg/tests/files/check_imports.sls",
          "pkg/tests/files/check_python.py",
          "pkg/tests/integration/__init__.py",
          "pkg/tests/integration/test_check_imports.py",
          "pkg/tests/integration/test_clean_zmq_teardown.py",
          "pkg/tests/integration/test_enabled_disabled.py",
          "pkg/tests/integration/test_help.py",
          "pkg/tests/integration/test_logrotate_config.py",
          "pkg/tests/integration/test_multi_minion.py",
          "pkg/tests/integration/test_pip.py",
          "pkg/tests/integration/test_pip_upgrade.py",
          "pkg/tests/integration/test_pkg.py",
          "pkg/tests/integration/test_python.py",
          "pkg/tests/integration/test_salt_api.py",
          "pkg/tests/integration/test_salt_call.py",
          "pkg/tests/integration/test_salt_exec.py",
          "pkg/tests/integration/test_salt_grains.py",
          "pkg/tests/integration/test_salt_key.py",
          "pkg/tests/integration/test_salt_minion.py",
          "pkg/tests/integration/test_salt_output.py",
          "pkg/tests/integration/test_salt_pillar.py",
          "pkg/tests/integration/test_salt_state_file.py",
          "pkg/tests/integration/test_salt_ufw.py",
          "pkg/tests/integration/test_salt_user.py",
          "pkg/tests/integration/test_ssm.py",
          "pkg/tests/integration/test_systemd_config.py",
          "pkg/tests/integration/test_version.py",
          "pkg/tests/support/__init__.py",
          "pkg/tests/support/coverage/sitecustomize.py",
          "pkg/tests/support/helpers.py",
          "pkg/tests/support/paths.py",
          "pkg/tests/support/runtests.py",
          "pkg/tests/support/sminion.py",
          "pkg/tests/upgrade/__init__.py",
          "pkg/tests/upgrade/test_salt_upgrade.py",
          "tests/pkg/rpm/salt.spec",
          "tests/pytests/pkg/__init__.py",
          "tests/pytests/pkg/conftest.py",
          "tests/pytests/pkg/downgrade/__init__.py",
          "tests/pytests/pkg/downgrade/test_salt_downgrade.py",
          "tests/pytests/pkg/download/__init__.py",
          "tests/pytests/pkg/download/test_pkg_download.py",
          "tests/pytests/pkg/files/check_imports.sls",
          "tests/pytests/pkg/files/check_python.py",
          "tests/pytests/pkg/integration/__init__.py",
          "tests/pytests/pkg/integration/test_check_imports.py",
          "tests/pytests/pkg/integration/test_clean_zmq_teardown.py",
          "tests/pytests/pkg/integration/test_enabled_disabled.py",
          "tests/pytests/pkg/integration/test_help.py",
          "tests/pytests/pkg/integration/test_logrotate_config.py",
          "tests/pytests/pkg/integration/test_multi_minion.py",
          "tests/pytests/pkg/integration/test_pip.py",
          "tests/pytests/pkg/integration/test_pip_upgrade.py",
          "tests/pytests/pkg/integration/test_pkg.py",
          "tests/pytests/pkg/integration/test_python.py",
          "tests/pytests/pkg/integration/test_salt_api.py",
          "tests/pytests/pkg/integration/test_salt_call.py",
          "tests/pytests/pkg/integration/test_salt_exec.py",
          "tests/pytests/pkg/integration/test_salt_grains.py",
          "tests/pytests/pkg/integration/test_salt_key.py",
          "tests/pytests/pkg/integration/test_salt_minion.py",
          "tests/pytests/pkg/integration/test_salt_output.py",
          "tests/pytests/pkg/integration/test_salt_pillar.py",
          "tests/pytests/pkg/integration/test_salt_state_file.py",
          "tests/pytests/pkg/integration/test_salt_ufw.py",
          "tests/pytests/pkg/integration/test_salt_user.py",
          "tests/pytests/pkg/integration/test_ssm.py",
          "tests/pytests/pkg/integration/test_systemd_config.py",
          "tests/pytests/pkg/integration/test_version.py",
          "tests/pytests/pkg/rpm/salt.spec",
          "tests/pytests/pkg/support/__init__.py",
          "tests/pytests/pkg/support/coverage/sitecustomize.py",
          "tests/pytests/pkg/support/helpers.py",
          "tests/pytests/pkg/support/paths.py",
          "tests/pytests/pkg/support/runtests.py",
          "tests/pytests/pkg/support/sminion.py",
          "tests/pytests/pkg/upgrade/__init__.py",
          "tests/pytests/pkg/upgrade/test_salt_upgrade.py",
          "tools/vm.py"
        ],
        "message": "Migrate package tests to the main test suite",
        "before_after_code_files": [
          "noxfile.py||noxfile.py",
          "pkg/tests/conftest.py||tests/pytests/pkg/conftest.py",
          "pkg/tests/downgrade/test_salt_downgrade.py||tests/pytests/pkg/downgrade/test_salt_downgrade.py",
          "pkg/tests/download/test_pkg_download.py||tests/pytests/pkg/download/test_pkg_download.py",
          "pkg/tests/integration/test_enabled_disabled.py||tests/pytests/pkg/integration/test_enabled_disabled.py",
          "pkg/tests/integration/test_help.py||tests/pytests/pkg/integration/test_help.py",
          "pkg/tests/integration/test_python.py||tests/pytests/pkg/integration/test_python.py",
          "pkg/tests/integration/test_salt_user.py||tests/pytests/pkg/integration/test_salt_user.py",
          "pkg/tests/integration/test_version.py||tests/pytests/pkg/integration/test_version.py",
          "pkg/tests/support/helpers.py||tests/pytests/pkg/support/helpers.py",
          "tools/vm.py||tools/vm.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65969"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "noxfile.py||noxfile.py": [
          "File: noxfile.py -> noxfile.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "463:         xml_coverage_file = COVERAGE_OUTPUT_DIR.relative_to(REPO_ROOT) / \"salt.xml\"",
          "464:         html_coverage_dir = COVERAGE_OUTPUT_DIR.relative_to(REPO_ROOT) / \"html\" / \"salt\"",
          "465:         cmd_args = [",
          "467:             \"--include=salt/*\",",
          "468:         ]",
          "",
          "[Removed Lines]",
          "466:             \"--omit=tests/*,pkg/tests/*\",",
          "",
          "[Added Lines]",
          "466:             \"--omit=tests/*,tests/pytests/pkg/*\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "475:         )",
          "476:         cmd_args = [",
          "477:             \"--omit=salt/*\",",
          "479:         ]",
          "480:     else:",
          "481:         json_coverage_file = (",
          "",
          "[Removed Lines]",
          "478:             \"--include=tests/*,pkg/tests/*\",",
          "",
          "[Added Lines]",
          "478:             \"--include=tests/*,tests/pytests/pkg/*\",",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "484:         xml_coverage_file = COVERAGE_OUTPUT_DIR.relative_to(REPO_ROOT) / \"coverage.xml\"",
          "485:         html_coverage_dir = COVERAGE_OUTPUT_DIR.relative_to(REPO_ROOT) / \"html\" / \"full\"",
          "486:         cmd_args = [",
          "488:         ]",
          "490:     if cli_report:",
          "",
          "[Removed Lines]",
          "487:             \"--include=salt/*,tests/*,pkg/tests/*\",",
          "",
          "[Added Lines]",
          "487:             \"--include=salt/*,tests/*,tests/pytests/pkg/*\",",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1837:         )",
          "1839:     chunks = {",
          "1841:         \"upgrade\": [",
          "1842:             \"--upgrade\",",
          "1843:             \"--no-uninstall\",",
          "1845:         ],",
          "1846:         \"upgrade-classic\": [",
          "1847:             \"--upgrade\",",
          "1848:             \"--no-uninstall\",",
          "1850:         ],",
          "1851:         \"downgrade\": [",
          "1852:             \"--downgrade\",",
          "1853:             \"--no-uninstall\",",
          "1855:         ],",
          "1856:         \"downgrade-classic\": [",
          "1857:             \"--downgrade\",",
          "1858:             \"--no-uninstall\",",
          "1860:         ],",
          "1861:         \"download-pkgs\": [",
          "1862:             \"--download-pkgs\",",
          "1864:         ],",
          "1865:     }",
          "",
          "[Removed Lines]",
          "1840:         \"install\": [\"pkg/tests/\"],",
          "1844:             \"pkg/tests/upgrade/\",",
          "1849:             \"pkg/tests/upgrade/\",",
          "1854:             \"pkg/tests/downgrade/\",",
          "1859:             \"pkg/tests/downgrade/\",",
          "1863:             \"pkg/tests/download/\",",
          "",
          "[Added Lines]",
          "1840:         \"install\": [\"tests/pytests/pkg/\"],",
          "1844:             \"tests/pytests/pkg/upgrade/\",",
          "1849:             \"tests/pytests/pkg/upgrade/\",",
          "1854:             \"tests/pytests/pkg/downgrade/\",",
          "1859:             \"tests/pytests/pkg/downgrade/\",",
          "1863:             \"tests/pytests/pkg/download/\",",
          "",
          "---------------"
        ],
        "pkg/tests/conftest.py||tests/pytests/pkg/conftest.py": [
          "File: pkg/tests/conftest.py -> tests/pytests/pkg/conftest.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: from saltfactories.utils.tempfiles import SaltPillarTree, SaltStateTree",
          "14: import salt.config",
          "16:     CODE_DIR,",
          "17:     TESTS_DIR,",
          "18:     ApiRequest,",
          "",
          "[Removed Lines]",
          "15: from tests.support.helpers import (",
          "",
          "[Added Lines]",
          "15: from tests.pytests.pkg.support.helpers import (",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "209:     envs = {",
          "210:         \"base\": [",
          "211:             str(file_root),",
          "213:         ],",
          "214:     }",
          "215:     tree = SaltStateTree(envs=envs)",
          "",
          "[Removed Lines]",
          "212:             str(TESTS_DIR / \"files\"),",
          "",
          "[Added Lines]",
          "212:             str(TESTS_DIR / \"pytests\" / \"pkg\" / \"files\"),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "345:     test_user = False",
          "346:     master_config = install_salt.config_path / \"master\"",
          "347:     if master_config.exists():",
          "349:             data = yaml.safe_load(fp)",
          "350:             if data and \"user\" in data:",
          "351:                 test_user = True",
          "",
          "[Removed Lines]",
          "348:         with open(master_config) as fp:",
          "",
          "[Added Lines]",
          "348:         with salt.utils.files.fopen(master_config) as fp:",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "439:                 \"-R\",",
          "440:                 \"salt:salt\",",
          "441:                 str(pathlib.Path(\"/etc\", \"salt\", \"pki\", \"master\")),",
          "443:         )",
          "444:         # The engines_dirs is created in .nox path. We need to set correct perms",
          "445:         # for the user running the Salt Master",
          "447:         file_roots = pathlib.Path(\"/srv/\", \"salt\")",
          "448:         pillar_roots = pathlib.Path(\"/srv/\", \"pillar\")",
          "449:         for _dir in [file_roots, pillar_roots]:",
          "452:     with factory.started(start_timeout=start_timeout):",
          "453:         yield factory",
          "",
          "[Removed Lines]",
          "442:             ]",
          "446:         subprocess.run([\"chown\", \"-R\", \"salt:salt\", str(CODE_DIR.parent / \".nox\")])",
          "450:             subprocess.run([\"chown\", \"-R\", \"salt:salt\", str(_dir)])",
          "",
          "[Added Lines]",
          "442:             ],",
          "443:             check=True,",
          "447:         subprocess.run(",
          "448:             [\"chown\", \"-R\", \"salt:salt\", str(CODE_DIR.parent / \".nox\")], check=False",
          "449:         )",
          "453:             subprocess.run([\"chown\", \"-R\", \"salt:salt\", str(_dir)], check=False)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "504:         file_roots = pathlib.Path(\"/srv/\", \"salt\")",
          "505:         pillar_roots = pathlib.Path(\"/srv/\", \"pillar\")",
          "506:         for _dir in [file_roots, pillar_roots]:",
          "509:     factory.after_terminate(",
          "511:     )",
          "512:     with factory.started(start_timeout=start_timeout):",
          "513:         yield factory",
          "",
          "[Removed Lines]",
          "507:             subprocess.run([\"chown\", \"-R\", \"salt:salt\", str(_dir)])",
          "510:         pytest.helpers.remove_stale_minion_key, salt_master, factory.id",
          "",
          "[Added Lines]",
          "510:             subprocess.run([\"chown\", \"-R\", \"salt:salt\", str(_dir)], check=True)",
          "513:         pytest.helpers.remove_stale_minion_key_pkg, salt_master, factory.id",
          "",
          "---------------"
        ],
        "pkg/tests/downgrade/test_salt_downgrade.py||tests/pytests/pkg/downgrade/test_salt_downgrade.py": [
          "File: pkg/tests/downgrade/test_salt_downgrade.py -> tests/pytests/pkg/downgrade/test_salt_downgrade.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import packaging.version",
          "4: import pytest",
          "5: from pytestskipmarkers.utils import platform",
          "",
          "[Removed Lines]",
          "1: import shutil",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "pkg/tests/download/test_pkg_download.py||tests/pytests/pkg/download/test_pkg_download.py": [
          "File: pkg/tests/download/test_pkg_download.py -> tests/pytests/pkg/download/test_pkg_download.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:     try:",
          "269:         pytest.helpers.download_file(gpg_file_url, downloads_path / gpg_key_name)",
          "271:         pytest.fail(f\"Failed to download {gpg_file_url}: {exc}\")",
          "273:     ret = shell.run(\"rpm\", \"--import\", str(downloads_path / gpg_key_name), check=False)",
          "",
          "[Removed Lines]",
          "270:     except Exception as exc:",
          "",
          "[Added Lines]",
          "270:     except Exception as exc:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "334:         try:",
          "335:             pytest.helpers.download_file(gpg_file_url, downloads_path / gpg_key_name)",
          "337:             pytest.fail(f\"Failed to download {gpg_file_url}: {exc}\")",
          "339:         salt_sources_path = downloads_path / \"salt.list\"",
          "",
          "[Removed Lines]",
          "336:         except Exception as exc:",
          "",
          "[Added Lines]",
          "336:         except Exception as exc:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "385:         try:",
          "386:             pytest.helpers.download_file(onedir_url, onedir_location)",
          "388:             pytest.fail(f\"Failed to download {onedir_url}: {exc}\")",
          "390:         shell.run(\"tar\", \"xvf\", str(onedir_location), \"-C\", str(onedir_extracted))",
          "",
          "[Removed Lines]",
          "387:         except Exception as exc:",
          "",
          "[Added Lines]",
          "387:         except Exception as exc:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "440:         try:",
          "441:             pytest.helpers.download_file(onedir_url, onedir_location)",
          "443:             pytest.fail(f\"Failed to download {onedir_url}: {exc}\")",
          "445:         shell.run(\"tar\", \"xvf\", str(onedir_location), \"-C\", str(onedir_extracted))",
          "",
          "[Removed Lines]",
          "442:         except Exception as exc:",
          "",
          "[Added Lines]",
          "442:         except Exception as exc:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "517:             try:",
          "518:                 pytest.helpers.download_file(onedir_url, onedir_location)",
          "520:                 pytest.fail(f\"Failed to download {onedir_url}: {exc}\")",
          "522:             shell.run(\"unzip\", str(onedir_location), \"-d\", str(onedir_extracted))",
          "",
          "[Removed Lines]",
          "519:             except Exception as exc:",
          "",
          "[Added Lines]",
          "519:             except Exception as exc:  # pylint: disable=broad-except",
          "",
          "---------------"
        ],
        "pkg/tests/integration/test_enabled_disabled.py||tests/pytests/pkg/integration/test_enabled_disabled.py": [
          "File: pkg/tests/integration/test_enabled_disabled.py -> tests/pytests/pkg/integration/test_enabled_disabled.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import pytest",
          "2: from pytestskipmarkers.utils import platform",
          "6: @pytest.mark.skip_on_windows(reason=\"Linux test only\")",
          "",
          "[Removed Lines]",
          "3: from saltfactories.utils.functional import MultiStateResult",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "pkg/tests/integration/test_help.py||tests/pytests/pkg/integration/test_help.py": [
          "File: pkg/tests/integration/test_help.py -> tests/pytests/pkg/integration/test_help.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import subprocess",
          "6: def test_help(install_salt):",
          "7:     \"\"\"",
          "",
          "[Removed Lines]",
          "3: from pytestskipmarkers.utils import platform",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "pkg/tests/integration/test_python.py||tests/pytests/pkg/integration/test_python.py": [
          "File: pkg/tests/integration/test_python.py -> tests/pytests/pkg/integration/test_python.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import pytest",
          "8: @pytest.fixture",
          "",
          "[Removed Lines]",
          "5: from tests.support.helpers import TESTS_DIR",
          "",
          "[Added Lines]",
          "5: from tests.pytests.pkg.support.helpers import TESTS_DIR",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "16: @pytest.mark.parametrize(\"exp_ret,user_arg\", [(1, \"false\"), (0, \"true\")])",
          "17: def test_python_script(install_salt, exp_ret, user_arg, python_script_bin):",
          "18:     ret = install_salt.proc.run(",
          "20:         stdout=subprocess.PIPE,",
          "21:         stderr=subprocess.PIPE,",
          "22:         check=False,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20:             python_script_bin",
          "21:             + [",
          "22:                 str(TESTS_DIR / \"pytests\" / \"pkg\" / \"files\" / \"check_python.py\"),",
          "23:                 user_arg,",
          "24:             ]",
          "25:         ),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "29: def test_python_script_exception(install_salt, python_script_bin):",
          "30:     ret = install_salt.proc.run(",
          "32:         stdout=subprocess.PIPE,",
          "33:         stderr=subprocess.PIPE,",
          "34:         check=False,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:             python_script_bin",
          "39:             + [",
          "40:                 str(TESTS_DIR / \"pytests\" / \"pkg\" / \"files\" / \"check_python.py\"),",
          "41:                 \"raise\",",
          "42:             ]",
          "43:         ),",
          "",
          "---------------"
        ],
        "pkg/tests/integration/test_salt_user.py||tests/pytests/pkg/integration/test_salt_user.py": [
          "File: pkg/tests/integration/test_salt_user.py -> tests/pytests/pkg/integration/test_salt_user.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "90:     home = \"\"",
          "91:     try:",
          "92:         home = proc.stdout.decode().split(\":\")[5]",
          "94:         pass",
          "95:     assert home == \"/opt/saltstack/salt\"",
          "",
          "[Removed Lines]",
          "93:     except:",
          "",
          "[Added Lines]",
          "93:     except Exception:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "106:         for group in proc.stdout.decode().split(\" \"):",
          "107:             if \"salt\" in group:",
          "108:                 in_group = True",
          "110:         pass",
          "111:     assert in_group is True",
          "",
          "[Removed Lines]",
          "109:     except:",
          "",
          "[Added Lines]",
          "109:     except Exception:  # pylint: disable=broad-except",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "124:     try:",
          "125:         shell = proc.stdout.decode().split(\":\")[6].strip()",
          "126:         shell_exists = pathlib.Path(shell).exists()",
          "128:         pass",
          "129:     assert shell_exists is True",
          "",
          "[Removed Lines]",
          "127:     except:",
          "",
          "[Added Lines]",
          "127:     except Exception:  # pylint: disable=broad-except",
          "",
          "---------------"
        ],
        "pkg/tests/integration/test_version.py||tests/pytests/pkg/integration/test_version.py": [
          "File: pkg/tests/integration/test_version.py -> tests/pytests/pkg/integration/test_version.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:     ret.stdout.matcher.fnmatch_lines([\"*Salt Version:*\"])",
          "33:     py_version = subprocess.run(",
          "34:         [str(python_bin), \"--version\"],",
          "35:         stdout=subprocess.PIPE,",
          "36:         stderr=subprocess.PIPE,",
          "37:     ).stdout",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "35:         check=True,",
          "",
          "---------------"
        ],
        "pkg/tests/support/helpers.py||tests/pytests/pkg/support/helpers.py": [
          "File: pkg/tests/support/helpers.py -> tests/pytests/pkg/support/helpers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: import psutil",
          "17: import pytest",
          "18: import requests",
          "19: from pytestshellutils.shell import DaemonImpl, Subprocess",
          "20: from pytestshellutils.utils.processes import (",
          "21:     ProcessResult,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: import saltfactories.cli",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "24: )",
          "25: from pytestskipmarkers.utils import platform",
          "26: from saltfactories.bases import SystemdSaltDaemonImpl",
          "28: from saltfactories.daemons import api, master, minion",
          "29: from saltfactories.utils import cli_scripts",
          "31: try:",
          "32:     import crypt",
          "",
          "[Removed Lines]",
          "27: from saltfactories.cli import call, key, salt",
          "",
          "[Added Lines]",
          "28: from saltfactories.cli import call, key",
          "32: import salt.utils.files",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "41: except ImportError:",
          "42:     HAS_PWD = False",
          "45: CODE_DIR = TESTS_DIR.parent",
          "48: log = logging.getLogger(__name__)",
          "",
          "[Removed Lines]",
          "44: TESTS_DIR = pathlib.Path(__file__).resolve().parent.parent",
          "46: ARTIFACTS_DIR = CODE_DIR / \"artifacts\"",
          "",
          "[Added Lines]",
          "47: TESTS_DIR = pathlib.Path(__file__).resolve().parent.parent.parent.parent",
          "49: ARTIFACTS_DIR = CODE_DIR / \"artifacts\" / \"pkg\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "420:                 # expects unless we do it via a batch file",
          "421:                 batch_file = pathlib.Path(pkg).parent / \"install_msi.cmd\"",
          "422:                 batch_content = f'msiexec /qn /i \"{str(pkg)}\" START_MINION=\"\"\\n'",
          "424:                     fp.write(batch_content)",
          "425:                 # Now run the batch file",
          "426:                 ret = self.proc.run(\"cmd.exe\", \"/c\", str(batch_file))",
          "",
          "[Removed Lines]",
          "423:                 with open(batch_file, \"w\") as fp:",
          "",
          "[Added Lines]",
          "426:                 with salt.utils.files.fopen(batch_file, \"w\") as fp:",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "618:                 f\"https://repo.saltproject.io/{root_url}{distro_name}/{self.distro_version}/{arch}/{major_ver}/{gpg_key}\",",
          "619:                 f\"/etc/apt/keyrings/{gpg_dest}\",",
          "620:             )",
          "622:                 pathlib.Path(\"/etc\", \"apt\", \"sources.list.d\", \"salt.list\"), \"w\"",
          "623:             ) as fp:",
          "624:                 fp.write(",
          "",
          "[Removed Lines]",
          "621:             with open(",
          "",
          "[Added Lines]",
          "624:             with salt.utils.files.fopen(",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "665:             # Let's not check the returncode if this is the case",
          "666:             if not (",
          "667:                 downgrade",
          "670:             ):",
          "671:                 self._check_retcode(ret)",
          "672:             if downgrade:",
          "",
          "[Removed Lines]",
          "668:                 and not packaging.version.parse(self.prev_version)",
          "669:                 >= packaging.version.parse(\"3006.0\")",
          "",
          "[Added Lines]",
          "671:                 and packaging.version.parse(self.prev_version)",
          "672:                 < packaging.version.parse(\"3006.0\")",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "710:                 # expects unless we do it via a batch file",
          "711:                 batch_file = pkg_path.parent / \"install_msi.cmd\"",
          "712:                 batch_content = f'msiexec /qn /i {str(pkg_path)} START_MINION=\"\"'",
          "714:                     fp.write(batch_content)",
          "715:                 # Now run the batch file",
          "716:                 ret = self.proc.run(\"cmd.exe\", \"/c\", str(batch_file))",
          "",
          "[Removed Lines]",
          "713:                 with open(batch_file, \"w\") as fp:",
          "",
          "[Added Lines]",
          "716:                 with salt.utils.files.fopen(batch_file, \"w\") as fp:",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "814:             ret = self.proc.run(self.pkg_mngr, self.rm_pkg, \"-y\", *self.salt_pkgs)",
          "815:             self._check_retcode(ret)",
          "851:     def write_launchd_conf(self, service):",
          "852:         service_name = f\"com.saltstack.salt.{service}\"",
          "853:         ret = self.proc.run(\"launchctl\", \"list\", service_name)",
          "",
          "[Removed Lines]",
          "817:     def assert_uninstalled(self):",
          "818:         \"\"\"",
          "819:         Assert that the paths in /opt/saltstack/ were correctly",
          "820:         removed or not removed",
          "821:         \"\"\"",
          "822:         return",
          "823:         if platform.is_windows():",
          "824:             # I'm not sure where the /opt/saltstack path is coming from",
          "825:             # This is the path we're using to test windows",
          "826:             opt_path = pathlib.Path(os.getenv(\"LocalAppData\"), \"salt\", \"pypath\")",
          "827:         else:",
          "828:             opt_path = pathlib.Path(os.sep, \"opt\", \"saltstack\", \"salt\", \"pypath\")",
          "829:         if not opt_path.exists():",
          "830:             if platform.is_windows():",
          "831:                 assert not opt_path.parent.exists()",
          "832:             else:",
          "833:                 assert not opt_path.parent.parent.exists()",
          "834:         else:",
          "835:             opt_path_contents = list(opt_path.rglob(\"*\"))",
          "836:             if not opt_path_contents:",
          "837:                 pytest.fail(",
          "838:                     f\"The path '{opt_path}' exists but there are no files in it.\"",
          "839:                 )",
          "840:             else:",
          "841:                 for path in list(opt_path_contents):",
          "842:                     if path.name in (\".installs.json\", \"__pycache__\"):",
          "843:                         opt_path_contents.remove(path)",
          "844:                 if opt_path_contents:",
          "845:                     pytest.fail(",
          "846:                         \"The test left some files behind: {}\".format(",
          "847:                             \", \".join([str(p) for p in opt_path_contents])",
          "848:                         )",
          "849:                     )",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "953:     def __exit__(self, *_):",
          "954:         if not self.no_uninstall:",
          "955:             self.uninstall()",
          "959: class PkgSystemdSaltDaemonImpl(SystemdSaltDaemonImpl):",
          "",
          "[Removed Lines]",
          "956:             self.assert_uninstalled()",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1335:             factory_class=SaltApi, salt_pkg_install=self.salt_pkg_install, **kwargs",
          "1336:         )",
          "1339:         return super().salt_key_cli(",
          "1343:         )",
          "1346:         return super().salt_cli(",
          "1350:         )",
          "",
          "[Removed Lines]",
          "1338:     def salt_key_cli(self, **factory_class_kwargs):",
          "1340:             factory_class=SaltKey,",
          "1341:             salt_pkg_install=self.salt_pkg_install,",
          "1345:     def salt_cli(self, **factory_class_kwargs):",
          "1347:             factory_class=SaltCli,",
          "1348:             salt_pkg_install=self.salt_pkg_install,",
          "",
          "[Added Lines]",
          "1306:     def salt_key_cli(self, factory_class=None, **factory_class_kwargs):",
          "1307:         if not factory_class:",
          "1308:             factory_class = SaltKey",
          "1309:         factory_class_kwargs[\"salt_pkg_install\"] = self.salt_pkg_install",
          "1311:             factory_class=factory_class,",
          "1315:     def salt_cli(self, factory_class=None, **factory_class_kwargs):",
          "1316:         if not factory_class:",
          "1317:             factory_class = SaltCli",
          "1318:         factory_class_kwargs[\"salt_pkg_install\"] = self.salt_pkg_install",
          "1320:             factory_class=factory_class,",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1403:             \"salt-minion\", self.salt_pkg_install.binary_paths[\"minion\"]",
          "1404:         )",
          "1407:         return super().salt_call_cli(",
          "1411:         )",
          "",
          "[Removed Lines]",
          "1406:     def salt_call_cli(self, **factory_class_kwargs):",
          "1408:             factory_class=SaltCall,",
          "1409:             salt_pkg_install=self.salt_pkg_install,",
          "",
          "[Added Lines]",
          "1378:     def salt_call_cli(self, factory_class=None, **factory_class_kwargs):",
          "1379:         if not factory_class:",
          "1380:             factory_class = SaltCall",
          "1381:         factory_class_kwargs[\"salt_pkg_install\"] = self.salt_pkg_install",
          "1383:             factory_class=factory_class,",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1455: @attr.s(kw_only=True, slots=True)",
          "1457:     \"\"\"",
          "1458:     Subclassed just to tweak the binary paths if needed.",
          "1459:     \"\"\"",
          "1461:     def __attrs_post_init__(self):",
          "1462:         self.script_name = \"salt\"",
          "1466: @attr.s(kw_only=True, slots=True)",
          "",
          "[Removed Lines]",
          "1456: class SaltCli(PkgMixin, salt.SaltCli):",
          "1463:         salt.SaltCli.__attrs_post_init__(self)",
          "",
          "[Added Lines]",
          "1430: class SaltCli(PkgMixin, saltfactories.cli.salt.SaltCli):",
          "1437:         saltfactories.cli.salt.SaltCli.__attrs_post_init__(self)",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1588: @pytest.helpers.register",
          "1590:     key_path = os.path.join(master.config[\"pki_dir\"], \"minions\", minion_id)",
          "1591:     if os.path.exists(key_path):",
          "1592:         os.unlink(key_path)",
          "",
          "[Removed Lines]",
          "1589: def remove_stale_minion_key(master, minion_id):",
          "",
          "[Added Lines]",
          "1563: def remove_stale_minion_key_pkg(master, minion_id):",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1624:     # NOTE the stream=True parameter below",
          "1625:     with requests.get(url, stream=True, auth=auth) as r:",
          "1626:         r.raise_for_status()",
          "1628:             for chunk in r.iter_content(chunk_size=8192):",
          "1629:                 if chunk:",
          "1630:                     f.write(chunk)",
          "",
          "[Removed Lines]",
          "1627:         with open(dest, \"wb\") as f:",
          "",
          "[Added Lines]",
          "1601:         with salt.utils.files.fopen(dest, \"wb\") as f:",
          "",
          "---------------"
        ],
        "tools/vm.py||tools/vm.py": [
          "File: tools/vm.py -> tools/vm.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1315:             \"--include\",",
          "1316:             \"artifacts/salt\",",
          "1317:             \"--include\",",
          "1319:             # But we also want to exclude all other entries under artifacts/",
          "1320:             \"--exclude\",",
          "1321:             \"artifacts/*\",",
          "",
          "[Removed Lines]",
          "1318:             \"pkg/artifacts/*\",",
          "",
          "[Added Lines]",
          "1318:             \"artifacts/pkg/*\",",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "457d5f71fc56f6c142a910b0c83dc1007a4fb5ec",
      "candidate_info": {
        "commit_hash": "457d5f71fc56f6c142a910b0c83dc1007a4fb5ec",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/457d5f71fc56f6c142a910b0c83dc1007a4fb5ec",
        "files": [
          "tests/support/pkg.py"
        ],
        "message": "Exitcode 3 just means the service is not running.\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/support/pkg.py||tests/support/pkg.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65969"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/support/pkg.py||tests/support/pkg.py": [
          "File: tests/support/pkg.py -> tests/support/pkg.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "868:         ret = self.proc.run(\"systemctl\", \"daemon-reload\")",
          "869:         self._check_retcode(ret)",
          "870:         ret = self.proc.run(\"systemctl\", \"status\", service)",
          "872:             log.warning(",
          "873:                 \"No systemd unit file was found for service %s. Creating one.\", service",
          "874:             )",
          "",
          "[Removed Lines]",
          "871:         if ret.returncode in (3, 4):",
          "",
          "[Added Lines]",
          "871:         if ret.returncode == 4:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "892:                 binary = shutil.which(binary[0]) or binary[0]",
          "893:             elif isinstance(binary, list):",
          "894:                 binary = \" \".join(binary)",
          "896:             contents = contents.format(",
          "897:                 service=service, tgt=binary, conf_dir=self.conf_dir",
          "898:             )",
          "",
          "[Removed Lines]",
          "895:             unit_path = pathlib.Path(\"/etc\", \"systemd\", \"system\", f\"{service}.service\")",
          "",
          "[Added Lines]",
          "895:             unit_path = pathlib.Path(f\"/etc/systemd/system/{service}.service\")",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "225464d3b5b8422b2309042b310c6a8b080f0538",
      "candidate_info": {
        "commit_hash": "225464d3b5b8422b2309042b310c6a8b080f0538",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/225464d3b5b8422b2309042b310c6a8b080f0538",
        "files": [
          "tests/pytests/pkg/download/test_pkg_download.py"
        ],
        "message": "Fix the Mac OS onedir package download tests\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/pkg/download/test_pkg_download.py||tests/pytests/pkg/download/test_pkg_download.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65969"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/pkg/download/test_pkg_download.py||tests/pytests/pkg/download/test_pkg_download.py": [
          "File: tests/pytests/pkg/download/test_pkg_download.py -> tests/pytests/pkg/download/test_pkg_download.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "431:         assert ret.returncode == 0, ret",
          "432:     else:",
          "433:         # We are testing the onedir download",
          "435:         if repo_subpath == \"minor\":",
          "436:             repo_url_base = f\"{root_url}/onedir/{repo_subpath}/{salt_release}\"",
          "437:         else:",
          "",
          "[Removed Lines]",
          "434:         onedir_name = f\"salt-{salt_release}-onedir-darwin-{arch}.tar.xz\"",
          "",
          "[Added Lines]",
          "434:         onedir_name = f\"salt-{salt_release}-onedir-macos-{arch}.tar.xz\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2ff09f5e8d1ba1877be8a65710fc5907a6f8341a",
      "candidate_info": {
        "commit_hash": "2ff09f5e8d1ba1877be8a65710fc5907a6f8341a",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/2ff09f5e8d1ba1877be8a65710fc5907a6f8341a",
        "files": [
          ".github/workflows/ci.yml",
          ".github/workflows/nightly.yml",
          ".github/workflows/scheduled.yml",
          ".github/workflows/templates/ci.yml.jinja",
          ".github/workflows/templates/test-package-downloads-action.yml.jinja",
          ".github/workflows/test-action-linux.yml",
          ".github/workflows/test-action-macos.yml",
          ".github/workflows/test-action-windows.yml",
          ".github/workflows/test-package-downloads-action.yml",
          ".github/workflows/test-packages-action-linux.yml",
          ".github/workflows/test-packages-action-macos.yml",
          ".github/workflows/test-packages-action-windows.yml"
        ],
        "message": "Some steps need to be kept at `actions/upload-artifact@v3`\n\nThis is because we upload multiple artifacts under the same name something that ``actions/upload-artifact@v4`` does not do.\n\nThere are breaking changes with this new version.\nSee https://github.blog/changelog/2023-12-14-github-actions-artifacts-v4-is-now-generally-available/\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          ".github/workflows/templates/ci.yml.jinja||.githuworkflows/templates/ci.yml.jinja",
          ".github/workflows/templates/test-package-downloads-action.yml.jinja||.githuworkflows/templates/test-package-downloads-action.yml.jinja"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65969"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        ".github/workflows/templates/ci.yml.jinja||.githuworkflows/templates/ci.yml.jinja": [
          "File: .github/workflows/templates/ci.yml.jinja -> .githuworkflows/templates/ci.yml.jinja",
          "--- Hunk 1 ---",
          "[Context before]",
          "343:       - name: Get coverage reports",
          "344:         id: get-coverage-reports",
          "346:         with:",
          "347:           name: all-testrun-coverage-artifacts",
          "348:           path: artifacts/coverage/",
          "",
          "[Removed Lines]",
          "345:         uses: actions/download-artifact@v4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        ".github/workflows/templates/test-package-downloads-action.yml.jinja||.githuworkflows/templates/test-package-downloads-action.yml.jinja": [
          "File: .github/workflows/templates/test-package-downloads-action.yml.jinja -> .githuworkflows/templates/test-package-downloads-action.yml.jinja",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:       - name: Upload Test Run Artifacts",
          "269:         if: always() && steps.download-artifacts-from-vm.outcome == 'success'",
          "271:         with:",
          "272:           name: pkg-testrun-artifacts-${{ matrix.distro-slug }}-${{ matrix.arch }}",
          "273:           path: |",
          "",
          "[Removed Lines]",
          "270:         uses: actions/upload-artifact@v4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "474:       - name: Upload Test Run Artifacts",
          "475:         if: always()",
          "477:         with:",
          "478:           name: pkg-testrun-artifacts-${{ matrix.distro-slug }}-${{ matrix.arch }}",
          "479:           path: |",
          "",
          "[Removed Lines]",
          "476:         uses: actions/upload-artifact@v4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "691:       - name: Upload Test Run Artifacts",
          "692:         if: always() && steps.download-artifacts-from-vm.outcome == 'success'",
          "694:         with:",
          "695:           name: pkg-testrun-artifacts-${{ matrix.distro-slug }}-${{ matrix.arch }}",
          "696:           path: |",
          "",
          "[Removed Lines]",
          "693:         uses: actions/upload-artifact@v4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}