{
  "cve_id": "CVE-2020-13947",
  "cve_desc": "An instance of a cross-site scripting vulnerability was identified to be present in the web based administration console on the message.jsp page of Apache ActiveMQ versions 5.15.12 through 5.16.0.",
  "repo": "apache/activemq",
  "patch_hash": "177eb71c52069712bcc9fe14c70e079cc2671a80",
  "patch_info": {
    "commit_hash": "177eb71c52069712bcc9fe14c70e079cc2671a80",
    "repo": "apache/activemq",
    "commit_url": "https://github.com/apache/activemq/commit/177eb71c52069712bcc9fe14c70e079cc2671a80",
    "files": [
      "activemq-web-console/src/main/webapp/message.jsp"
    ],
    "message": "Properly encode the copy/move message URL.\n\n(cherry picked from commit 4450c17c1c836a1daa7541dcb944f35798258197)",
    "before_after_code_files": [
      "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
    ]
  },
  "patch_diff": {
    "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp": [
      "File: activemq-web-console/src/main/webapp/message.jsp -> activemq-web-console/src/main/webapp/message.jsp",
      "--- Hunk 1 ---",
      "[Context before]",
      "234:   return;",
      "235:  }",
      "236:  var value = select.options[selectedIndex].value;",
      "240:  if (confirm(\"Are you sure?\"))",
      "241:    location.href=url;",
      "242: }",
      "",
      "[Removed Lines]",
      "237:  var url = action + \".action?destination=\" + value;",
      "238:  url += \"&JMSDestination=${requestContext.messageQuery.JMSDestination}\";",
      "239:  url += \"&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\";",
      "",
      "[Added Lines]",
      "237:  var url = action + \".action?destination=\" + encodeURIComponent(value);",
      "239:  var url = action +",
      "240:   \"<c:url value=\".action\">",
      "241:                      <c:param name=\"JMSDestination\" value=\"${requestContext.messageQuery.JMSDestination}\" />",
      "242:                      <c:param name=\"messageId\" value=\"${row.JMSMessageID}\" />",
      "243:                      <c:param name=\"JMSDestinationType\" value=\"queue\" />",
      "244:                      <c:param name=\"secret\" value='${sessionScope[\"secret\"]}' />",
      "245:                  </c:url>\";",
      "246:  url = url + \"&destination=\" + encodeURIComponent(value);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4450c17c1c836a1daa7541dcb944f35798258197",
      "candidate_info": {
        "commit_hash": "4450c17c1c836a1daa7541dcb944f35798258197",
        "repo": "apache/activemq",
        "commit_url": "https://github.com/apache/activemq/commit/4450c17c1c836a1daa7541dcb944f35798258197",
        "files": [
          "activemq-web-console/src/main/webapp/message.jsp"
        ],
        "message": "Properly encode the copy/move message URL.",
        "before_after_code_files": [
          "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ],
          "candidate": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ]
        }
      },
      "candidate_diff": {
        "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp": [
          "File: activemq-web-console/src/main/webapp/message.jsp -> activemq-web-console/src/main/webapp/message.jsp",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:   return;",
          "235:  }",
          "236:  var value = select.options[selectedIndex].value;",
          "240:  if (confirm(\"Are you sure?\"))",
          "241:    location.href=url;",
          "242: }",
          "",
          "[Removed Lines]",
          "237:  var url = action + \".action?destination=\" + value;",
          "238:  url += \"&JMSDestination=${requestContext.messageQuery.JMSDestination}\";",
          "239:  url += \"&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\";",
          "",
          "[Added Lines]",
          "237:  var url = action + \".action?destination=\" + encodeURIComponent(value);",
          "239:  var url = action +",
          "240:   \"<c:url value=\".action\">",
          "241:                      <c:param name=\"JMSDestination\" value=\"${requestContext.messageQuery.JMSDestination}\" />",
          "242:                      <c:param name=\"messageId\" value=\"${row.JMSMessageID}\" />",
          "243:                      <c:param name=\"JMSDestinationType\" value=\"queue\" />",
          "244:                      <c:param name=\"secret\" value='${sessionScope[\"secret\"]}' />",
          "245:                  </c:url>\";",
          "246:  url = url + \"&destination=\" + encodeURIComponent(value);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "032a9446adc21e6790b891e44af463a9ba165b3e",
      "candidate_info": {
        "commit_hash": "032a9446adc21e6790b891e44af463a9ba165b3e",
        "repo": "apache/activemq",
        "commit_url": "https://github.com/apache/activemq/commit/032a9446adc21e6790b891e44af463a9ba165b3e",
        "files": [
          "activemq-web-console/src/main/webapp/message.jsp"
        ],
        "message": "Properly encode the copy/move message URL.\n\n(cherry picked from commit 4450c17c1c836a1daa7541dcb944f35798258197)",
        "before_after_code_files": [
          "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ],
          "candidate": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ]
        }
      },
      "candidate_diff": {
        "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp": [
          "File: activemq-web-console/src/main/webapp/message.jsp -> activemq-web-console/src/main/webapp/message.jsp",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:   return;",
          "235:  }",
          "236:  var value = select.options[selectedIndex].value;",
          "240:  if (confirm(\"Are you sure?\"))",
          "241:    location.href=url;",
          "242: }",
          "",
          "[Removed Lines]",
          "237:  var url = action + \".action?destination=\" + value;",
          "238:  url += \"&JMSDestination=${requestContext.messageQuery.JMSDestination}\";",
          "239:  url += \"&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\";",
          "",
          "[Added Lines]",
          "237:  var url = action + \".action?destination=\" + encodeURIComponent(value);",
          "239:  var url = action +",
          "240:   \"<c:url value=\".action\">",
          "241:                      <c:param name=\"JMSDestination\" value=\"${requestContext.messageQuery.JMSDestination}\" />",
          "242:                      <c:param name=\"messageId\" value=\"${row.JMSMessageID}\" />",
          "243:                      <c:param name=\"JMSDestinationType\" value=\"queue\" />",
          "244:                      <c:param name=\"secret\" value='${sessionScope[\"secret\"]}' />",
          "245:                  </c:url>\";",
          "246:  url = url + \"&destination=\" + encodeURIComponent(value);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81bd743eaa243f0cc5dfbb1342cee1fef1fc5df2",
      "candidate_info": {
        "commit_hash": "81bd743eaa243f0cc5dfbb1342cee1fef1fc5df2",
        "repo": "apache/activemq",
        "commit_url": "https://github.com/apache/activemq/commit/81bd743eaa243f0cc5dfbb1342cee1fef1fc5df2",
        "files": [
          "activemq-web-console/src/main/webapp/browse.jsp",
          "activemq-web-console/src/main/webapp/js/common.js",
          "activemq-web-console/src/main/webapp/message.jsp"
        ],
        "message": "AMQ-7231 - Fix XSS in WebConsole",
        "before_after_code_files": [
          "activemq-web-console/src/main/webapp/browse.jsp||activemq-web-console/src/main/webapp/browse.jsp",
          "activemq-web-console/src/main/webapp/js/common.js||activemq-web-console/src/main/webapp/js/common.js",
          "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ],
          "candidate": [
            "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp"
          ]
        }
      },
      "candidate_diff": {
        "activemq-web-console/src/main/webapp/browse.jsp||activemq-web-console/src/main/webapp/browse.jsp": [
          "File: activemq-web-console/src/main/webapp/browse.jsp -> activemq-web-console/src/main/webapp/browse.jsp",
          "--- Hunk 1 ---",
          "[Context before]",
          "50: <td><a href=\"<c:url value=\"message.jsp\">",
          "51:                  <c:param name=\"id\" value=\"${row.JMSMessageID}\" />",
          "52:                  <c:param name=\"JMSDestination\" value=\"${requestContext.queueBrowser.JMSDestination}\"/></c:url>\"",
          "54: <td><c:out value=\"${row.JMSCorrelationID}\"/></td>",
          "55: <td><jms:persistent message=\"${row}\"/></td>",
          "56: <td><c:out value=\"${row.JMSPriority}\"/></td>",
          "",
          "[Removed Lines]",
          "53:     title=\"${row.properties}\">${row.JMSMessageID}</a></td>",
          "",
          "[Added Lines]",
          "53:     title=\"<c:out value=\"${row.properties}\"/>\">${row.JMSMessageID}</a></td>",
          "",
          "---------------"
        ],
        "activemq-web-console/src/main/webapp/js/common.js||activemq-web-console/src/main/webapp/js/common.js": [
          "File: activemq-web-console/src/main/webapp/js/common.js -> activemq-web-console/src/main/webapp/js/common.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:  return targ;",
          "107: }",
          "",
          "[Removed Lines]",
          "109: function confirmAction(id, url) {",
          "111:  var select = document.getElementById(id);",
          "112:  var selectedIndex = select.selectedIndex;",
          "113:  if (select.selectedIndex == 0) {",
          "114:   alert(\"Please select a value\");",
          "115:   return;",
          "116:  }",
          "117:  var value = select.options[selectedIndex].value;",
          "118:  url = url.replace(/%target%/gi, value);",
          "119:  if (confirm(\"Are you sure?\"))",
          "120:    location.href=url;",
          "121: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "activemq-web-console/src/main/webapp/message.jsp||activemq-web-console/src/main/webapp/message.jsp": [
          "File: activemq-web-console/src/main/webapp/message.jsp -> activemq-web-console/src/main/webapp/message.jsp",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:                        </tr>",
          "152:                     </c:if>",
          "153:                     <tr class=\"odd\">",
          "155:                         <td rowspan=\"2\">",
          "156:                             <select id=\"queue\">",
          "157:                                 <option value=\"\"> -- Please select --</option>",
          "",
          "[Removed Lines]",
          "154:                     <td><a href=\"<c:out value=\"javascript:confirmAction('queue', 'copyMessage.action?destination=%target%&JMSDestination=${requestContext.messageQuery.JMSDestination}&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\"/>')\">Copy</a></td>",
          "",
          "[Added Lines]",
          "154:                     <td><a href=\"<c:out value=\"javascript:confirmAction('queue', 'copyMessage\"/>')\">Copy</a></td>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "166:                     </tr>",
          "167:                     <tr class=\"odd\">",
          "169:                             >Move</a></td>",
          "170:                     </tr>",
          "171:                 </tbody>",
          "",
          "[Removed Lines]",
          "168:                         <td><a href=\"<c:out value=\"javascript:confirmAction('queue', 'moveMessage.action?destination=%target%&JMSDestination=${requestContext.messageQuery.JMSDestination}&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\"/>')\"",
          "",
          "[Added Lines]",
          "168:                         <td><a href=\"<c:out value=\"javascript:confirmAction('queue', 'moveMessage\"/>')\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "225:     }",
          "226: }",
          "228: window.onload=function() {",
          "229:  sortSelect( document.getElementById('queue') );",
          "230:  selectOptionByText( document.getElementById('queue'), \"-- Please select --\" );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "228: function confirmAction(id, action) {",
          "230:  var select = document.getElementById(id);",
          "231:  var selectedIndex = select.selectedIndex;",
          "232:  if (select.selectedIndex == 0) {",
          "233:   alert(\"Please select a value\");",
          "234:   return;",
          "235:  }",
          "236:  var value = select.options[selectedIndex].value;",
          "237:  var url = action + \".action?destination=\" + value;",
          "238:  url += \"&JMSDestination=${requestContext.messageQuery.JMSDestination}\";",
          "239:  url += \"&messageId=${row.JMSMessageID}&JMSDestinationType=queue&secret=${sessionScope['secret']}\";",
          "240:  if (confirm(\"Are you sure?\"))",
          "241:    location.href=url;",
          "242: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}