{
  "cve_id": "CVE-2021-45456",
  "cve_desc": "Apache kylin checks the legitimacy of the project before executing some commands with the project name passed in by the user. There is a mismatch between what is being checked and what is being used as the shell command argument in DiagnosisService. This may cause an illegal project name to pass the check and perform the following steps, resulting in a command injection vulnerability. This issue affects Apache Kylin 4.0.0.",
  "repo": "apache/kylin",
  "patch_hash": "f4daf14dde99b934c92ce2c832509f24342bc845",
  "patch_info": {
    "commit_hash": "f4daf14dde99b934c92ce2c832509f24342bc845",
    "repo": "apache/kylin",
    "commit_url": "https://github.com/apache/kylin/commit/f4daf14dde99b934c92ce2c832509f24342bc845",
    "files": [
      "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java",
      "server/src/main/webapp/WEB-INF/web.xml"
    ],
    "message": "test fix",
    "before_after_code_files": [
      "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java||core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java||core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java||core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java||server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java"
    ]
  },
  "patch_diff": {
    "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java||core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java": [
      "File: core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java -> core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "3403:     public String getKerberosPrincipal() {",
      "3404:         return getOptional(\"kylin.kerberos.principal\");",
      "3405:     }",
      "3406: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3407:     public String getEncryptCipherIvSpec() {",
      "3408:         return getOptional(\"kylin.security.encrypt.cipher.ivSpec\", \"AAAAAAAAAAAAAAAA\");",
      "3409:     }",
      "",
      "---------------"
    ],
    "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java||core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java": [
      "File: core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java -> core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "25: import java.security.NoSuchAlgorithmException;",
      "27: import org.apache.commons.codec.binary.Base64;",
      "29: import javax.crypto.Cipher;",
      "30: import javax.crypto.NoSuchPaddingException;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "28: import org.apache.kylin.common.KylinConfig;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "42:             InvalidKeyException, NoSuchPaddingException, NoSuchAlgorithmException, UnsupportedEncodingException {",
      "43:         Cipher cipher = Cipher.getInstance(\"AES/CFB/PKCS5Padding\");",
      "44:         final SecretKeySpec secretKey = new SecretKeySpec(key, \"AES\");",
      "46:         cipher.init(cipherMode, secretKey, ivSpec);",
      "47:         return cipher;",
      "48:     }",
      "",
      "[Removed Lines]",
      "45:         IvParameterSpec ivSpec = new IvParameterSpec(\"AAAAAAAAAAAAAAAA\".getBytes(\"UTF-8\"));",
      "",
      "[Added Lines]",
      "46:         IvParameterSpec ivSpec = new IvParameterSpec(KylinConfig.getInstanceFromEnv().getEncryptCipherIvSpec().getBytes(\"UTF-8\"));",
      "",
      "---------------"
    ],
    "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java||core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java": [
      "File: core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java -> core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: package org.apache.kylin.common.util;",
      "21: import org.junit.Assert;",
      "22: import org.junit.Test;",
      "26:     @Test",
      "27:     public void testAESEncrypt(){",
      "",
      "[Removed Lines]",
      "24: public class EncryptUtilTest {",
      "",
      "[Added Lines]",
      "21: import org.junit.After;",
      "23: import org.junit.Before;",
      "26: public class EncryptUtilTest extends LocalFileMetadataTestCase {",
      "27:     @Before",
      "28:     public void setUp() throws Exception {",
      "29:         this.createTestMetadata();",
      "30:     }",
      "32:     @After",
      "33:     public void after() throws Exception {",
      "34:         this.cleanupTestMetadata();",
      "35:     }",
      "",
      "---------------"
    ],
    "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java||server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java": [
      "File: server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java -> server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "87:     public String dumpProjectDiagnosisInfo(String project, File exportPath) throws IOException {",
      "88:         Message msg = MsgPicker.getMsg();",
      "89:         ProjectInstance projectInstance =",
      "90:                 ProjectManager.getInstance(KylinConfig.getInstanceFromEnv())",
      "92:         if (null == projectInstance) {",
      "93:             throw new BadRequestException(",
      "95:         }",
      "96:         aclEvaluate.checkProjectOperationPermission(projectInstance);",
      "98:         runDiagnosisCLI(args);",
      "99:         return getDiagnosisPackageName(exportPath);",
      "100:     }",
      "",
      "[Removed Lines]",
      "91:                         .getProject(ValidateUtil.convertStringToBeAlphanumericUnderscore(project));",
      "94:                     String.format(Locale.ROOT, msg.getDIAG_PROJECT_NOT_FOUND(), project));",
      "97:         String[] args = { project, exportPath.getAbsolutePath() };",
      "",
      "[Added Lines]",
      "89:         String projectName = ValidateUtil.convertStringToBeAlphanumericUnderscore(project);",
      "92:                         .getProject(projectName);",
      "95:                     String.format(Locale.ROOT, msg.getDIAG_PROJECT_NOT_FOUND(), projectName));",
      "98:         String[] args = { projectName, exportPath.getAbsolutePath() };",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a055639a733ff8912c63032af5a4a4ca761f6f72",
      "candidate_info": {
        "commit_hash": "a055639a733ff8912c63032af5a4a4ca761f6f72",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/a055639a733ff8912c63032af5a4a4ca761f6f72",
        "files": [
          "webapp/app/partials/admin/change_pwd.html",
          "webapp/app/partials/admin/user_create.html"
        ],
        "message": "KYLIN-4576 add some hint of password length\n\n(cherry picked from commit 3d52aa647bb242022ece99b5e08be5eb45ee9c87)",
        "before_after_code_files": [
          "webapp/app/partials/admin/change_pwd.html||webapp/app/partials/admin/change_pwd.html",
          "webapp/app/partials/admin/user_create.html||webapp/app/partials/admin/user_create.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "webapp/app/partials/admin/change_pwd.html||webapp/app/partials/admin/change_pwd.html": [
          "File: webapp/app/partials/admin/change_pwd.html -> webapp/app/partials/admin/change_pwd.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:       <div class=\"form-group\">",
          "52:         <label><b>User New Password</b></label>",
          "53:         <div class=\"clearfix\">",
          "56:                  ng-model=\"changePwdUser.newPassword\"/>",
          "57:           <span class=\"text-warning\"",
          "58:                           ng-if=\"change_pwd_form.pwd_input.$error.required  && change_pwd_form.pwd_input.$dirty\"",
          "",
          "[Removed Lines]",
          "54:           <input required ng-pattern=\"pwdPattern\" name=\"pwd_input\" type=\"password\" class=\"form-control\"",
          "55:                  placeholder=\"The password should contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\"",
          "",
          "[Added Lines]",
          "54:           <input required ng-pattern=\"pwdPattern\" name=\"pwd_input\" type=\"password\" class=\"form-control\"",
          "55:                  placeholder=\"The password should have at least 8 characters, and contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "65:       <div class=\"form-group\">",
          "66:         <label><b>Confirm New Password</b></label>",
          "67:         <div class=\"clearfix\">",
          "70:                  ng-model=\"changePwdUser.repeatPassword\"/>",
          "71:             <span class=\"text-warning\"",
          "72:                  ng-if=\"user_create_form.pwd_new_input.$error.required  && user_create_form.pwd_new_input.$dirty\"",
          "",
          "[Removed Lines]",
          "68:           <input required name=\"pwd_new_input\" type=\"password\" class=\"form-control\"",
          "69:                  placeholder=\"The password should contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\"",
          "",
          "[Added Lines]",
          "68:           <input required name=\"pwd_new_input\" type=\"password\" class=\"form-control\"",
          "69:                  placeholder=\"The password should have at least 8 characters, and contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\"",
          "",
          "---------------"
        ],
        "webapp/app/partials/admin/user_create.html||webapp/app/partials/admin/user_create.html": [
          "File: webapp/app/partials/admin/user_create.html -> webapp/app/partials/admin/user_create.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:       <div class=\"form-group\">",
          "42:         <label><b>User Password</b></label>",
          "43:         <div class=\"clearfix\">",
          "45:           <span class=\"text-warning\"",
          "46:                           ng-if=\"user_create_form.pwd_input.$error.required  && user_create_form.pwd_input.$dirty\"",
          "47:                     >&nbsp;The password is required</span>",
          "",
          "[Removed Lines]",
          "44:           <input ng-pattern=\"pwdPattern\" required name=\"pwd_input\" type=\"password\" class=\"form-control\" placeholder=\"The password should contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\" ng-model=\"user.password\"/>",
          "",
          "[Added Lines]",
          "44:           <input ng-pattern=\"pwdPattern\" required name=\"pwd_input\" type=\"password\" class=\"form-control\" placeholder=\"The password should have at least 8 characters, and contain at least one number, letter and special character\uff08~!@#$%^&*(){}|:&quot;\\<\\>?[];\\',./`).\" ng-model=\"user.password\"/>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1ca9d9bd2521c1b1156be8c0882d446d1801b42b",
      "candidate_info": {
        "commit_hash": "1ca9d9bd2521c1b1156be8c0882d446d1801b42b",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/1ca9d9bd2521c1b1156be8c0882d446d1801b42b",
        "files": [
          "query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java"
        ],
        "message": "KYLIN-4628: Fail to use custom measure type when specifying cube to query\n\n(cherry picked from commit 4efe9fce487f49d051893cac88b4b83346171734)",
        "before_after_code_files": [
          "query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java||query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java||query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java": [
          "File: query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java -> query/src/main/java/org/apache/kylin/query/routing/QueryRouter.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:                 candidates.add(new Candidate(real, sqlDigest));",
          "57:             if (BackdoorToggles.getForceHitCube() != null && BackdoorToggles.getForceHitCube().equalsIgnoreCase(real.getName())) {",
          "58:                 logger.info(\"Force choose {} as selected cube for specific purpose.\", real.getName());",
          "60:             }",
          "61:         }",
          "",
          "[Removed Lines]",
          "59:                 return real;",
          "",
          "[Added Lines]",
          "59:                 candidates = Lists.newArrayListWithCapacity(1);",
          "60:                 candidates.add(new Candidate(real, sqlDigest));",
          "61:                 break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d34f08594db97d0f175144f0190e782e11f2b9b5",
      "candidate_info": {
        "commit_hash": "d34f08594db97d0f175144f0190e782e11f2b9b5",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/d34f08594db97d0f175144f0190e782e11f2b9b5",
        "files": [
          "kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java"
        ],
        "message": "KYLIN-5057 CubeBuildJob in Kylin4.0 run failed when open Spark3.1 AQE\n\nRoot cause:\nWith KylinJoinSelection strategy, if AQE is true, this strategy will be applied before LogicalQueryStageStrategy,\nand then it will be applied JoinSelection strategy again, leading to change the 'Build Type' of BroadcastHashJoin in some cases.",
        "before_after_code_files": [
          "kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala||kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala||kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala||kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala": [
          "File: kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala -> kylin-spark-project/kylin-spark-common/src/main/spark24/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala||kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala": [
          "File: kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala -> kylin-spark-project/kylin-spark-common/src/main/spark31/org/apache/spark/sql/execution/KylinJoinSelection.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java -> kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/application/SparkApplication.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "55: import org.apache.kylin.common.util.JsonUtil;",
          "56: import org.apache.kylin.metadata.MetadataConstants;",
          "57: import org.apache.spark.SparkConf;",
          "59: import org.apache.spark.sql.SparkSession;",
          "62: import org.apache.spark.sql.hive.utils.ResourceDetectUtils;",
          "63: import org.apache.spark.util.Utils;",
          "64: import org.apache.spark.utils.ResourceUtils;",
          "",
          "[Removed Lines]",
          "58: import org.apache.spark.sql.execution.KylinJoinSelection;",
          "60: import org.apache.spark.sql.SparkSessionExtensions;",
          "61: import org.apache.spark.sql.execution.SparkStrategy;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "67: import org.apache.kylin.engine.spark.common.util.TimeZoneUtils;",
          "68: import org.slf4j.Logger;",
          "69: import org.slf4j.LoggerFactory;",
          "73: public abstract class SparkApplication {",
          "74:     private static final Logger logger = LoggerFactory.getLogger(SparkApplication.class);",
          "",
          "[Removed Lines]",
          "70: import scala.runtime.AbstractFunction1;",
          "71: import scala.runtime.BoxedUnit;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "287:                 }",
          "288:             }",
          "302:                     .getOrCreate();",
          "304:             if (isJobOnCluster(sparkConf)) {",
          "",
          "[Removed Lines]",
          "290:             ss = SparkSession.builder().withExtensions(new AbstractFunction1<SparkSessionExtensions, BoxedUnit>() {",
          "291:                 @Override",
          "292:                 public BoxedUnit apply(SparkSessionExtensions v1) {",
          "293:                     v1.injectPlannerStrategy(new AbstractFunction1<SparkSession, SparkStrategy>() {",
          "294:                         @Override",
          "295:                         public SparkStrategy apply(SparkSession session) {",
          "296:                             return new KylinJoinSelection(session);",
          "297:                         }",
          "298:                     });",
          "299:                     return BoxedUnit.UNIT;",
          "300:                 }",
          "301:             }).enableHiveSupport().config(sparkConf).config(\"mapreduce.fileoutputcommitter.marksuccessfuljobs\", \"false\")",
          "",
          "[Added Lines]",
          "285:             ss = SparkSession.builder()",
          "286:                     .enableHiveSupport()",
          "287:                     .config(sparkConf)",
          "288:                     .config(\"mapreduce.fileoutputcommitter.marksuccessfuljobs\", \"false\")",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee1be8c5f69ce87804913bdeabba7c1189e6358a",
      "candidate_info": {
        "commit_hash": "ee1be8c5f69ce87804913bdeabba7c1189e6358a",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/ee1be8c5f69ce87804913bdeabba7c1189e6358a",
        "files": [
          "docker/dockerfile/standalone/Dockerfile_hadoop",
          "docker/dockerfile/standalone/entrypoint.sh"
        ],
        "message": "KYLIN-4944  kylin4 Docker image is upgraded from centos6.9 to centos7\u2026 (#1635)\n\n* KYLIN-4944  kylin4 Docker image is upgraded from centos6.9 to centos7.9.2009\n\n* KYLIN-4944  kylin4 Docker image is upgraded from centos6.9 to centos7.9.2009",
        "before_after_code_files": [
          "docker/dockerfile/standalone/entrypoint.sh||docker/dockerfile/standalone/entrypoint.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "docker/dockerfile/standalone/entrypoint.sh||docker/dockerfile/standalone/entrypoint.sh": [
          "File: docker/dockerfile/standalone/entrypoint.sh -> docker/dockerfile/standalone/entrypoint.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: # clean pid files",
          "22: rm -f /tmp/*.pid",
          "24: # start mysql",
          "25: if [ ! -f \"/home/admin/first_run\" ]",
          "26: then",
          "29:     mysql -uroot -p123456 -e \"CREATE DATABASE IF NOT EXISTS kylin4 default charset utf8 COLLATE utf8_general_ci;\"",
          "31: fi",
          "34: # start hdfs",
          "35: if [ ! -f \"/home/admin/first_run\" ]",
          "",
          "[Removed Lines]",
          "27:     service mysqld start",
          "28:     mysqladmin -uroot password 123456",
          "30:     mysql -uroot -p123456 -e \"grant all privileges on root.* to root@'%' identified by '123456';\"",
          "32: service mysqld restart",
          "",
          "[Added Lines]",
          "23: if [ ! -f \"/home/admin/first_run\" ]",
          "24: then",
          "25:     mysqld_pre_systemd",
          "26: fi",
          "27: mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid -u root",
          "31:     mysql_init_password=`cat /var/log/mysqld.log |grep -Po '(?<=A temporary password is generated for root@localhost: )\\S+'`",
          "32:     mysql --connect-expired-password -u root -p$mysql_init_password -e \"set global validate_password_policy=0;set global validate_password_length=6;alter user user() identified by '123456';\"",
          "34:     mysql -uroot -p123456 -e \"grant all privileges on root.* to root@'%' identified by '123456';FLUSH   PRIVILEGES;\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "33c068fd66a028a174a15acb28bbca8394903f28",
      "candidate_info": {
        "commit_hash": "33c068fd66a028a174a15acb28bbca8394903f28",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/33c068fd66a028a174a15acb28bbca8394903f28",
        "files": [
          "kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java",
          "server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java",
          "server-base/src/main/java/org/apache/kylin/rest/service/JobService.java"
        ],
        "message": "KYLIN-4766 Cleanup segment storage after job be discarded (#1716)\n\n* KYLIN-4766 Cleanup segment storage after job be discarded\n\n* fix",
        "before_after_code_files": [
          "kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java||kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java",
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java",
          "server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java||server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java",
          "server-base/src/main/java/org/apache/kylin/rest/service/JobService.java||server-base/src/main/java/org/apache/kylin/rest/service/JobService.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java||kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java": [
          "File: kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java -> kylin-spark-project/kylin-spark-common/src/main/java/org/apache/kylin/engine/spark/metadata/cube/PathManager.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "63:             return false;",
          "64:         }",
          "67:         logger.info(\"Deleting segment parquet path {}\", path);",
          "68:         HadoopUtil.deletePath(HadoopUtil.getCurrentConfiguration(), new Path(path));",
          "69:         return true;",
          "",
          "[Removed Lines]",
          "61:     public static boolean deleteSegmentParquetStoragePath(CubeInstance cube, CubeSegment segment) throws IOException {",
          "62:         if (cube == null || segment == null) {",
          "65:         String path = getSegmentParquetStoragePath(cube, segment.getName(),",
          "66:                 segment.getStorageLocationIdentifier());",
          "",
          "[Added Lines]",
          "61:     public static boolean deleteSegmentParquetStoragePath(CubeInstance cube, String segmentName, String identifier) throws IOException {",
          "62:         if (cube == null || StringUtils.isNoneBlank(segmentName)|| StringUtils.isNoneBlank(identifier)) {",
          "65:         String path = getSegmentParquetStoragePath(cube, segmentName, identifier);",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java -> kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkCubingJob.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: import org.apache.kylin.engine.spark.metadata.cube.PathManager;",
          "37: import org.apache.kylin.engine.spark.utils.MetaDumpUtil;",
          "38: import org.apache.kylin.metadata.MetadataConstants;",
          "40: import org.apache.kylin.shaded.com.google.common.base.Preconditions;",
          "41: import org.slf4j.Logger;",
          "42: import org.slf4j.LoggerFactory;",
          "",
          "[Removed Lines]",
          "39: import org.apache.kylin.metadata.model.SegmentStatusEnum;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "143:         this.cube = cube;",
          "144:     }",
          "147:         try {",
          "148:             PathManager.deleteJobTempPath(getConfig(), getParam(MetadataConstants.P_PROJECT_NAME),",
          "149:                     getParam(MetadataConstants.P_JOB_ID));",
          "151:             CubeManager cubeManager = CubeManager.getInstance(getConfig());",
          "152:             CubeInstance cube = cubeManager.getCube(getParam(MetadataConstants.P_CUBE_NAME));",
          "155:         } catch (IOException e) {",
          "156:             logger.warn(\"Delete resource file failed after job be discarded, due to\", e);",
          "157:         }",
          "",
          "[Removed Lines]",
          "146:     public void cleanupAfterJobDiscard() {",
          "153:             CubeSegment segment = cube.getSegment(getParam(MetadataConstants.SEGMENT_NAME), SegmentStatusEnum.NEW);",
          "154:             PathManager.deleteSegmentParquetStoragePath(cube, segment);",
          "",
          "[Added Lines]",
          "145:     public void cleanupAfterJobDiscard(String segmentName, String segmentIdentifier) {",
          "152:             PathManager.deleteSegmentParquetStoragePath(cube, segmentName, segmentIdentifier);",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java -> kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkUpdateMetaAndCleanupAfterMergeStep.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:             for (CubeSegment segment : mergingSegments) {",
          "61:                 try {",
          "63:                 } catch (IOException e) {",
          "64:                     throw new ExecuteException(\"Can not delete segment: \" + segment.getName() + \", in cube: \" + cube.getName());",
          "65:                 }",
          "",
          "[Removed Lines]",
          "62:                     PathManager.deleteSegmentParquetStoragePath(cube, segment);",
          "",
          "[Added Lines]",
          "62:                     PathManager.deleteSegmentParquetStoragePath(cube, segment.getName(), segment.getStorageLocationIdentifier());",
          "",
          "---------------"
        ],
        "server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java||server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java": [
          "File: server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java -> server-base/src/main/java/org/apache/kylin/rest/service/CubeService.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "670:         if (toRemoveSegs != null && !toRemoveSegs.isEmpty()) {",
          "671:             for (CubeSegment segment : toRemoveSegs) {",
          "673:             }",
          "674:         }",
          "675:     }",
          "",
          "[Removed Lines]",
          "672:                 PathManager.deleteSegmentParquetStoragePath(cube, segment);",
          "",
          "[Added Lines]",
          "672:                 PathManager.deleteSegmentParquetStoragePath(cube, segment.getName(), segment.getStorageLocationIdentifier());",
          "",
          "---------------"
        ],
        "server-base/src/main/java/org/apache/kylin/rest/service/JobService.java||server-base/src/main/java/org/apache/kylin/rest/service/JobService.java": [
          "File: server-base/src/main/java/org/apache/kylin/rest/service/JobService.java -> server-base/src/main/java/org/apache/kylin/rest/service/JobService.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "689:         if (job.getStatus() != JobStatusEnum.DISCARDED) {",
          "690:             if (executable instanceof CubingJob) {",
          "692:                 if (executable instanceof NSparkCubingJob) {",
          "694:                 }",
          "698:                 if (executable.getStatus().isFinalState()) {",
          "699:                     try {",
          "",
          "[Removed Lines]",
          "693:                     ((NSparkCubingJob) executable).cleanupAfterJobDiscard();",
          "696:                 cancelCubingJobInner((CubingJob) executable);",
          "",
          "[Added Lines]",
          "691:                 String segmentName = job.getRelatedSegmentName();",
          "692:                 CubeSegment segment = getCubeManager().getCube(job.getRelatedCube()).getSegment(segmentName, SegmentStatusEnum.NEW);",
          "693:                 String segmentIdentifier = segment.getStorageLocationIdentifier();",
          "694:                 cancelCubingJobInner((CubingJob) executable);",
          "697:                     ((NSparkCubingJob) executable).cleanupAfterJobDiscard(segmentName, segmentIdentifier);",
          "",
          "---------------"
        ]
      }
    }
  ]
}