{
  "cve_id": "CVE-2021-4146",
  "cve_desc": "Business Logic Errors in GitHub repository pimcore/pimcore prior to 10.2.6.",
  "repo": "pimcore/pimcore",
  "patch_hash": "7011922f7f0f97a82d8c378559b91fcdb34604a6",
  "patch_info": {
    "commit_hash": "7011922f7f0f97a82d8c378559b91fcdb34604a6",
    "repo": "pimcore/pimcore",
    "commit_url": "https://github.com/pimcore/pimcore/commit/7011922f7f0f97a82d8c378559b91fcdb34604a6",
    "files": [
      "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
      "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
      "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
    ],
    "message": "[Ecommerce] Discounts shouldn't be negative",
    "before_after_code_files": [
      "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
      "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
      "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
    ]
  },
  "patch_diff": {
    "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php": [
      "File: bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php -> bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "91:     {",
      "92:         $json = json_decode($string);",
      "93:         if ($json->amount) {",
      "94:             $this->setAmount($json->amount);",
      "95:         }",
      "96:         if ($json->percent) {",
      "97:             $this->setPercent($json->percent);",
      "98:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "94:             if($json->amount < 0) {",
      "95:                 throw new \\Exception('Only positive numbers and 0 are valid values for absolute discounts');",
      "96:             }",
      "101:             if($json->percent < 0) {",
      "102:                 throw new \\Exception('Only positive numbers and 0 are valid values for % discounts');",
      "103:             }",
      "",
      "---------------"
    ],
    "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php": [
      "File: bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php -> bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "75:     {",
      "76:         $json = json_decode($string);",
      "77:         if ($json->amount) {",
      "78:             $this->setAmount($json->amount);",
      "79:         }",
      "80:         if ($json->percent) {",
      "81:             $this->setPercent($json->percent);",
      "82:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "78:             if($json->amount < 0) {",
      "79:                 throw new \\Exception('Only positive numbers and 0 are valid values for absolute discounts');",
      "80:             }",
      "85:             if($json->percent < 0) {",
      "86:                 throw new \\Exception('Only positive numbers and 0 are valid values for % discounts');",
      "87:             }",
      "",
      "---------------"
    ],
    "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js": [
      "File: bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js -> bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1408:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_cart_discount_amount\"),",
      "1409:                     name: \"amount\",",
      "1410:                     width: 200,",
      "1412:                 }, {",
      "1413:                     xtype: \"numberfield\",",
      "1414:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_cart_discount_percent\"),",
      "1415:                     name: \"percent\",",
      "1416:                     width: 200,",
      "1418:                 }",
      "1419:             ]",
      "1420:         });",
      "",
      "[Removed Lines]",
      "1411:                     value: data.amount",
      "1417:                     value: data.percent",
      "",
      "[Added Lines]",
      "1411:                     value: data.amount,",
      "1412:                     minValue: 0",
      "1418:                     value: data.percent,",
      "1419:                     maxValue: 100,",
      "1420:                     minValue: 0",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1460:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_product_discount_amount\"),",
      "1461:                     name: \"amount\",",
      "1462:                     width: 200,",
      "1464:                 }, {",
      "1465:                     xtype: \"numberfield\",",
      "1466:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_product_discount_percent\"),",
      "1467:                     name: \"percent\",",
      "1468:                     width: 200,",
      "1470:                 }",
      "1471:             ]",
      "1472:         });",
      "",
      "[Removed Lines]",
      "1463:                     value: data.amount",
      "1469:                     value: data.percent",
      "",
      "[Added Lines]",
      "1466:                     value: data.amount,",
      "1467:                     minValue: 0",
      "1473:                     value: data.percent,",
      "1474:                     maxValue: 100,",
      "1475:                     minValue: 0",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1a0a02e20ad2fea7c21757abedcbdbf828f05a2d",
      "candidate_info": {
        "commit_hash": "1a0a02e20ad2fea7c21757abedcbdbf828f05a2d",
        "repo": "pimcore/pimcore",
        "commit_url": "https://github.com/pimcore/pimcore/commit/1a0a02e20ad2fea7c21757abedcbdbf828f05a2d",
        "files": [
          "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
          "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
          "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
        ],
        "message": "[Ecommerce] Discounts shouldn't be negative (#11206)\n\n* [Ecommerce] Discounts shouldn't be negative\n\n* [Ecommerce] Discounts shouldn't be negative - form validation\n\nCo-authored-by: dpahuja <divesh.pahuja@pimcore.com>",
        "before_after_code_files": [
          "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
          "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
          "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/pimcore/pimcore/pull/11206"
        ],
        "olp_code_files": {
          "patch": [
            "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
            "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
            "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
          ],
          "candidate": [
            "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
            "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
            "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js"
          ]
        }
      },
      "candidate_diff": {
        "bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php": [
          "File: bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php -> bundles/EcommerceFrameworkBundle/PricingManager/Action/CartDiscount.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:     {",
          "92:         $json = json_decode($string);",
          "93:         if ($json->amount) {",
          "94:             $this->setAmount($json->amount);",
          "95:         }",
          "96:         if ($json->percent) {",
          "97:             $this->setPercent($json->percent);",
          "98:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "94:             if($json->amount < 0) {",
          "95:                 throw new \\Exception('Only positive numbers and 0 are valid values for absolute discounts');",
          "96:             }",
          "101:             if($json->percent < 0) {",
          "102:                 throw new \\Exception('Only positive numbers and 0 are valid values for % discounts');",
          "103:             }",
          "",
          "---------------"
        ],
        "bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php||bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php": [
          "File: bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php -> bundles/EcommerceFrameworkBundle/PricingManager/Action/ProductDiscount.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:     {",
          "76:         $json = json_decode($string);",
          "77:         if ($json->amount) {",
          "78:             $this->setAmount($json->amount);",
          "79:         }",
          "80:         if ($json->percent) {",
          "81:             $this->setPercent($json->percent);",
          "82:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:             if($json->amount < 0) {",
          "79:                 throw new \\Exception('Only positive numbers and 0 are valid values for absolute discounts');",
          "80:             }",
          "85:             if($json->percent < 0) {",
          "86:                 throw new \\Exception('Only positive numbers and 0 are valid values for % discounts');",
          "87:             }",
          "",
          "---------------"
        ],
        "bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js||bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js": [
          "File: bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js -> bundles/EcommerceFrameworkBundle/Resources/public/js/pricing/config/item.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "407:         var actionData = [];",
          "408:         var actions = this.actionsContainer.items.getRange();",
          "411:             action = actions[i].getForm().getFieldValues();",
          "412:             action['type'] = actions[i].type;",
          "414:             actionData.push(action);",
          "415:         }",
          "416:         saveData[\"actions\"] = actionData;",
          "",
          "[Removed Lines]",
          "409:         for (var i=0; i<actions.length; i++) {",
          "410:             var action = {};",
          "",
          "[Added Lines]",
          "409:         for (let i=0; i<actions.length; i++) {",
          "410:             let action = {};",
          "414:             if (!actions[i].getForm().isValid()) {",
          "415:                 console.error('Price action invalid');",
          "416:                 return;",
          "417:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1408:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_cart_discount_amount\"),",
          "1409:                     name: \"amount\",",
          "1410:                     width: 200,",
          "1412:                 }, {",
          "1413:                     xtype: \"numberfield\",",
          "1414:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_cart_discount_percent\"),",
          "1415:                     name: \"percent\",",
          "1416:                     width: 200,",
          "1418:                 }",
          "1419:             ]",
          "1420:         });",
          "",
          "[Removed Lines]",
          "1411:                     value: data.amount",
          "1417:                     value: data.percent",
          "",
          "[Added Lines]",
          "1416:                     value: data.amount,",
          "1417:                     minValue: 0",
          "1423:                     value: data.percent,",
          "1424:                     maxValue: 100,",
          "1425:                     minValue: 0",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1460:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_product_discount_amount\"),",
          "1461:                     name: \"amount\",",
          "1462:                     width: 200,",
          "1464:                 }, {",
          "1465:                     xtype: \"numberfield\",",
          "1466:                     fieldLabel: t(\"bundle_ecommerce_pricing_config_action_product_discount_percent\"),",
          "1467:                     name: \"percent\",",
          "1468:                     width: 200,",
          "1470:                 }",
          "1471:             ]",
          "1472:         });",
          "",
          "[Removed Lines]",
          "1463:                     value: data.amount",
          "1469:                     value: data.percent",
          "",
          "[Added Lines]",
          "1471:                     value: data.amount,",
          "1472:                     minValue: 0",
          "1478:                     value: data.percent,",
          "1479:                     maxValue: 100,",
          "1480:                     minValue: 0",
          "",
          "---------------"
        ]
      }
    }
  ]
}