{
  "cve_id": "CVE-2016-3096",
  "cve_desc": "The create_script function in the lxc_container module in Ansible before 1.9.6-1 and 2.x before 2.0.2.0 allows local users to write to arbitrary files or gain privileges via a symlink attack on (1) /opt/.lxc-attach-script, (2) the archived container in the archive_path directory, or the (3) lxc-attach-script.log or (4) lxc-attach-script.err files in the temporary directory.",
  "repo": "ansible/ansible-modules-extras",
  "patch_hash": "7c3999a92a1cd856ff9bc8913a93ff1aee8bffc3",
  "patch_info": {
    "commit_hash": "7c3999a92a1cd856ff9bc8913a93ff1aee8bffc3",
    "repo": "ansible/ansible-modules-extras",
    "commit_url": "https://github.com/ansible/ansible-modules-extras/commit/7c3999a92a1cd856ff9bc8913a93ff1aee8bffc3",
    "files": [
      "cloud/lxc/lxc_container.py"
    ],
    "message": "do not use a predictable filenames in the LXC plugin\n\n* do not use a predictable filename for the LXC attach script\n\n* don't use predictable filenames for LXC attach script logging\n\n* don't set a predictable archive_path\n\n\n\nthis should prevent symlink attacks which could result in\n\n* data corruption\n\n* data leakage\n\n* privilege escalation",
    "before_after_code_files": [
      "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
    ]
  },
  "patch_diff": {
    "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py": [
      "File: cloud/lxc/lxc_container.py -> cloud/lxc/lxc_container.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "144:         description:",
      "145:           - Path the save the archived container. If the path does not exist",
      "146:             the archive method will attempt to create it.",
      "148:     archive_compression:",
      "149:         choices:",
      "150:           - gzip",
      "",
      "[Removed Lines]",
      "147:         default: /tmp",
      "",
      "[Added Lines]",
      "147:         default: null",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "557:     import subprocess",
      "558:     import tempfile",
      "567:     try:",
      "568:         f.write(ATTACH_TEMPLATE % {'container_command': command})",
      "569:         f.flush()",
      "",
      "[Removed Lines]",
      "560:     # Ensure that the directory /opt exists.",
      "561:     if not path.isdir('/opt'):",
      "562:         os.mkdir('/opt')",
      "564:     # Create the script.",
      "565:     script_file = path.join('/opt', '.lxc-attach-script')",
      "566:     f = open(script_file, 'wb')",
      "",
      "[Added Lines]",
      "560:     (fd, script_file) = tempfile.mkstemp(prefix='lxc-attach-script')",
      "561:     f = os.fdopen(fd, 'wb')",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "573:     # Ensure the script is executable.",
      "574:     os.chmod(script_file, 0700)",
      "579:     # Output log file.",
      "582:     # Error log file.",
      "585:     # Execute the script command.",
      "586:     try:",
      "",
      "[Removed Lines]",
      "576:     # Get temporary directory.",
      "577:     tempdir = tempfile.gettempdir()",
      "580:     stdout_file = open(path.join(tempdir, 'lxc-attach-script.log'), 'ab')",
      "583:     stderr_file = open(path.join(tempdir, 'lxc-attach-script.err'), 'ab')",
      "",
      "[Added Lines]",
      "572:     stdout_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-log')[0], 'ab')",
      "575:     stderr_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-err')[0], 'ab')",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1747:             ),",
      "1748:             archive_path=dict(",
      "1749:                 type='str',",
      "1751:             ),",
      "1752:             archive_compression=dict(",
      "1753:                 choices=LXC_COMPRESSION_MAP.keys(),",
      "",
      "[Removed Lines]",
      "1750:                 default='/tmp'",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1755:             )",
      "1756:         ),",
      "1757:         supports_check_mode=False,",
      "1758:     )",
      "1760:     if not HAS_LXC:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1749:         required_if = ([",
      "1750:             ('archive', True, ['archive_path'])",
      "1751:         ]),",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "30e0c507e7b86e66662ad59367c9a97c0c19cd3b",
      "candidate_info": {
        "commit_hash": "30e0c507e7b86e66662ad59367c9a97c0c19cd3b",
        "repo": "ansible/ansible-modules-extras",
        "commit_url": "https://github.com/ansible/ansible-modules-extras/commit/30e0c507e7b86e66662ad59367c9a97c0c19cd3b",
        "files": [
          "cloud/lxc/lxc_container.py"
        ],
        "message": "do not use a predictable filenames in the LXC plugin\n\n* do not use a predictable filename for the LXC attach script\n\n* don't use predictable filenames for LXC attach script logging\n\n* don't set a predictable archive_path\n\nthis should prevent symlink attacks which could result in\n\n* data corruption\n\n* data leakage\n\n* privilege escalation",
        "before_after_code_files": [
          "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
          ],
          "candidate": [
            "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
          ]
        }
      },
      "candidate_diff": {
        "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py": [
          "File: cloud/lxc/lxc_container.py -> cloud/lxc/lxc_container.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: version_added: 1.8.0",
          "27: description:",
          "28:   - Management of LXC containers",
          "30: options:",
          "31:     name:",
          "32:         description:",
          "",
          "[Removed Lines]",
          "29: author: Kevin Carter",
          "",
          "[Added Lines]",
          "29: author: \"Kevin Carter (@cloudnull)\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:         description:",
          "125:           - Path the save the archived container. If the path does not exist",
          "126:             the archive method will attempt to create it.",
          "128:     archive_compression:",
          "129:         choices:",
          "130:           - gzip",
          "",
          "[Removed Lines]",
          "127:         default: /tmp",
          "",
          "[Added Lines]",
          "127:         default: null",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "425:     import subprocess",
          "426:     import tempfile",
          "435:     try:",
          "436:         f.write(ATTACH_TEMPLATE % {'container_command': command})",
          "437:         f.flush()",
          "",
          "[Removed Lines]",
          "428:     # Ensure that the directory /opt exists.",
          "429:     if not path.isdir('/opt'):",
          "430:         os.mkdir('/opt')",
          "432:     # Create the script.",
          "433:     script_file = path.join('/opt', '.lxc-attach-script')",
          "434:     f = open(script_file, 'wb')",
          "",
          "[Added Lines]",
          "428:     (fd, script_file) = tempfile.mkstemp(prefix='lxc-attach-script')",
          "429:     f = os.fdopen(fd, 'wb')",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "439:         f.close()",
          "441:     # Ensure the script is executable.",
          "447:     # Output log file.",
          "451:     # Error log file.",
          "455:     # Execute the script command.",
          "456:     try:",
          "",
          "[Removed Lines]",
          "442:     os.chmod(script_file, 0755)",
          "444:     # Get temporary directory.",
          "445:     tempdir = tempfile.gettempdir()",
          "448:     stdout = path.join(tempdir, 'lxc-attach-script.log')",
          "449:     stdout_file = open(stdout, 'ab')",
          "452:     stderr = path.join(tempdir, 'lxc-attach-script.err')",
          "453:     stderr_file = open(stderr, 'ab')",
          "",
          "[Added Lines]",
          "437:     os.chmod(script_file, 0700)",
          "440:     stdout_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-log')[0], 'ab')",
          "443:     stderr_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-err')[0], 'ab')",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1456:             ),",
          "1457:             archive_path=dict(",
          "1458:                 type='str',",
          "1460:             ),",
          "1461:             archive_compression=dict(",
          "1462:                 choices=LXC_COMPRESSION_MAP.keys(),",
          "",
          "[Removed Lines]",
          "1459:                 default='/tmp'",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1464:             )",
          "1465:         ),",
          "1466:         supports_check_mode=False,",
          "1467:     )",
          "1469:     lv_name = module.params.get('lv_name')",
          "1470:     if not lv_name:",
          "1471:         module.params['lv_name'] = module.params.get('name')",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1456:         required_if = ([",
          "1457:             ('archive', True, ['archive_path'])",
          "1458:         ]),",
          "1461:     if module.params.get('archive') and module.params.get('archive_path') is None:",
          "1462:         module.fail_json(msg='archive_path must be set to a directory path when archive is True')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "684111af01eaf867433cc052f727c7ff8e0d44c0",
      "candidate_info": {
        "commit_hash": "684111af01eaf867433cc052f727c7ff8e0d44c0",
        "repo": "ansible/ansible-modules-extras",
        "commit_url": "https://github.com/ansible/ansible-modules-extras/commit/684111af01eaf867433cc052f727c7ff8e0d44c0",
        "files": [
          "cloud/lxc/lxc_container.py"
        ],
        "message": "do not use a predictable filenames in the LXC plugin\n\n* do not use a predictable filename for the LXC attach script\n\n* don't use predictable filenames for LXC attach script logging\n\n* don't set a predictable archive_path\n\n\n\nthis should prevent symlink attacks which could result in\n\n* data corruption\n\n* data leakage\n\n* privilege escalation",
        "before_after_code_files": [
          "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
          ],
          "candidate": [
            "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py"
          ]
        }
      },
      "candidate_diff": {
        "cloud/lxc/lxc_container.py||cloud/lxc/lxc_container.py": [
          "File: cloud/lxc/lxc_container.py -> cloud/lxc/lxc_container.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "144:         description:",
          "145:           - Path the save the archived container. If the path does not exist",
          "146:             the archive method will attempt to create it.",
          "148:     archive_compression:",
          "149:         choices:",
          "150:           - gzip",
          "",
          "[Removed Lines]",
          "147:         default: /tmp",
          "",
          "[Added Lines]",
          "147:         default: null",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "515:     import subprocess",
          "516:     import tempfile",
          "525:     try:",
          "526:         f.write(ATTACH_TEMPLATE % {'container_command': command})",
          "527:         f.flush()",
          "",
          "[Removed Lines]",
          "518:     # Ensure that the directory /opt exists.",
          "519:     if not path.isdir('/opt'):",
          "520:         os.mkdir('/opt')",
          "522:     # Create the script.",
          "523:     script_file = path.join('/opt', '.lxc-attach-script')",
          "524:     f = open(script_file, 'wb')",
          "",
          "[Added Lines]",
          "518:     (fd, script_file) = tempfile.mkstemp(prefix='lxc-attach-script')",
          "519:     f = os.fdopen(fd, 'wb')",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "531:     # Ensure the script is executable.",
          "532:     os.chmod(script_file, 0700)",
          "537:     # Output log file.",
          "540:     # Error log file.",
          "543:     # Execute the script command.",
          "544:     try:",
          "",
          "[Removed Lines]",
          "534:     # Get temporary directory.",
          "535:     tempdir = tempfile.gettempdir()",
          "538:     stdout_file = open(path.join(tempdir, 'lxc-attach-script.log'), 'ab')",
          "541:     stderr_file = open(path.join(tempdir, 'lxc-attach-script.err'), 'ab')",
          "",
          "[Added Lines]",
          "530:     stdout_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-log')[0], 'ab')",
          "533:     stderr_file = os.fdopen(tempfile.mkstemp(prefix='lxc-attach-script-err')[0], 'ab')",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1704:             ),",
          "1705:             archive_path=dict(",
          "1706:                 type='str',",
          "1708:             ),",
          "1709:             archive_compression=dict(",
          "1710:                 choices=LXC_COMPRESSION_MAP.keys(),",
          "",
          "[Removed Lines]",
          "1707:                 default='/tmp'",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1712:             )",
          "1713:         ),",
          "1714:         supports_check_mode=False,",
          "1715:     )",
          "1717:     if not HAS_LXC:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1706:         required_if = ([",
          "1707:             ('archive', True, ['archive_path'])",
          "1708:         ]),",
          "",
          "---------------"
        ]
      }
    }
  ]
}