{
  "cve_id": "CVE-2022-31112",
  "cve_desc": "Parse Server is an open source backend that can be deployed to any infrastructure that can run Node.js. In affected versions parse Server LiveQuery does not remove protected fields in classes, passing them to the client. The LiveQueryController now removes protected fields from the client response. Users are advised to upgrade. Users unable t upgrade should use `Parse.Cloud.afterLiveQueryEvent` to manually remove protected fields.",
  "repo": "parse-community/parse-server",
  "patch_hash": "309f64ced8700321df056fb3cc97f15007a00df1",
  "patch_info": {
    "commit_hash": "309f64ced8700321df056fb3cc97f15007a00df1",
    "repo": "parse-community/parse-server",
    "commit_url": "https://github.com/parse-community/parse-server/commit/309f64ced8700321df056fb3cc97f15007a00df1",
    "files": [
      "spec/ParseLiveQuery.spec.js",
      "src/Controllers/DatabaseController.js",
      "src/LiveQuery/ParseCloudCodePublisher.js",
      "src/LiveQuery/ParseLiveQueryServer.js"
    ],
    "message": "fix: protected fields exposed via LiveQuery; this removes protected fields from the client response; this may be a breaking change if your app is currently expecting to receive these protected fields ([GHSA-crrq-vr9j-fxxh](https://github.com/parse-community/parse-server/security/advisories/GHSA-crrq-vr9j-fxxh)) (https://github.com/parse-community/parse-server/pull/8074) (#8073)",
    "before_after_code_files": [
      "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js",
      "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js",
      "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js",
      "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js"
    ]
  },
  "patch_diff": {
    "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js": [
      "File: spec/ParseLiveQuery.spec.js -> spec/ParseLiveQuery.spec.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1066:     }",
      "1067:   });",
      "1069:   afterEach(async function (done) {",
      "1070:     const client = await Parse.CoreManager.getLiveQueryController().getDefaultLiveQueryClient();",
      "1071:     client.close();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1069:   it('should strip out protected fields', async () => {",
      "1070:     await reconfigureServer({",
      "1071:       liveQuery: { classNames: ['Test'] },",
      "1072:       startLiveQueryServer: true,",
      "1073:     });",
      "1074:     const obj1 = new Parse.Object('Test');",
      "1075:     obj1.set('foo', 'foo');",
      "1076:     obj1.set('bar', 'bar');",
      "1077:     obj1.set('qux', 'qux');",
      "1078:     await obj1.save();",
      "1079:     const config = Config.get(Parse.applicationId);",
      "1080:     const schemaController = await config.database.loadSchema();",
      "1081:     await schemaController.updateClass(",
      "1082:       'Test',",
      "1083:       {},",
      "1084:       {",
      "1085:         get: { '*': true },",
      "1086:         find: { '*': true },",
      "1087:         update: { '*': true },",
      "1088:         protectedFields: {",
      "1089:           '*': ['foo'],",
      "1090:         },",
      "1091:       }",
      "1092:     );",
      "1093:     const object = await obj1.fetch();",
      "1094:     expect(object.get('foo')).toBe(undefined);",
      "1095:     expect(object.get('bar')).toBeDefined();",
      "1096:     expect(object.get('qux')).toBeDefined();",
      "1098:     const subscription = await new Parse.Query('Test').subscribe();",
      "1099:     await Promise.all([",
      "1100:       new Promise(resolve => {",
      "1101:         subscription.on('update', (obj, original) => {",
      "1102:           expect(obj.get('foo')).toBe(undefined);",
      "1103:           expect(obj.get('bar')).toBeDefined();",
      "1104:           expect(obj.get('qux')).toBeDefined();",
      "1105:           expect(original.get('foo')).toBe(undefined);",
      "1106:           expect(original.get('bar')).toBeDefined();",
      "1107:           expect(original.get('qux')).toBeDefined();",
      "1108:           resolve();",
      "1109:         });",
      "1110:       }),",
      "1111:       obj1.save({ foo: 'abc' }),",
      "1112:     ]);",
      "1113:   });",
      "",
      "---------------"
    ],
    "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js": [
      "File: src/Controllers/DatabaseController.js -> src/Controllers/DatabaseController.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "127:   aclGroup: any[],",
      "128:   auth: any,",
      "129:   operation: any,",
      "131:   className: string,",
      "132:   protectedFields: null | Array<any>,",
      "133:   object: any",
      "",
      "[Removed Lines]",
      "130:   schema: SchemaController.SchemaController,",
      "",
      "[Added Lines]",
      "130:   schema: SchemaController.SchemaController | any,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "136:   if (auth && auth.user) userId = auth.user.id;",
      "140:   if (perms) {",
      "141:     const isReadOperation = ['get', 'find'].indexOf(operation) > -1;",
      "",
      "[Removed Lines]",
      "139:   const perms = schema.getClassLevelPermissions(className);",
      "",
      "[Added Lines]",
      "139:   const perms =",
      "140:     schema && schema.getClassLevelPermissions ? schema.getClassLevelPermissions(className) : {};",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1533:   }",
      "1535:   addProtectedFields(",
      "1537:     className: string,",
      "1538:     query: any = {},",
      "1539:     aclGroup: any[] = [],",
      "1540:     auth: any = {},",
      "1541:     queryOptions: FullQueryOptions = {}",
      "1542:   ): null | string[] {",
      "1544:     if (!perms) return null;",
      "1546:     const protectedFields = perms.protectedFields;",
      "",
      "[Removed Lines]",
      "1536:     schema: SchemaController.SchemaController,",
      "1543:     const perms = schema.getClassLevelPermissions(className);",
      "",
      "[Added Lines]",
      "1537:     schema: SchemaController.SchemaController | any,",
      "1544:     const perms =",
      "1545:       schema && schema.getClassLevelPermissions",
      "1546:         ? schema.getClassLevelPermissions(className)",
      "1547:         : schema;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1806:   }",
      "1808:   static _validateQuery: any => void;",
      "1809: }",
      "1811: module.exports = DatabaseController;",
      "1813: module.exports._validateQuery = validateQuery;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1813:   static filterSensitiveData: (boolean, any[], any, any, any, string, any[], any) => void;",
      "1819: module.exports.filterSensitiveData = filterSensitiveData;",
      "",
      "---------------"
    ],
    "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js": [
      "File: src/LiveQuery/ParseCloudCodePublisher.js -> src/LiveQuery/ParseCloudCodePublisher.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "33:     if (request.original) {",
      "34:       message.originalParseObject = request.original._toFullJSON();",
      "35:     }",
      "36:     this.parsePublisher.publish(type, JSON.stringify(message));",
      "37:   }",
      "38: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "36:     if (request.classLevelPermissions) {",
      "37:       message.classLevelPermissions = request.classLevelPermissions;",
      "38:     }",
      "",
      "---------------"
    ],
    "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js": [
      "File: src/LiveQuery/ParseLiveQueryServer.js -> src/LiveQuery/ParseLiveQueryServer.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: import SchemaController from '../Controllers/SchemaController';",
      "11: import _ from 'lodash';",
      "12: import { v4 as uuidv4 } from 'uuid';",
      "14: import { getAuthForSessionToken, Auth } from '../Auth';",
      "16: import LRU from 'lru-cache';",
      "17: import UserRouter from '../Routers/UsersRouter';",
      "19: class ParseLiveQueryServer {",
      "20:   clients: Map;",
      "",
      "[Removed Lines]",
      "13: import { runLiveQueryEventHandlers, getTrigger, runTrigger, resolveError, toJSONwithObjects } from '../triggers';",
      "15: import { getCacheController } from '../Controllers';",
      "",
      "[Added Lines]",
      "13: import {",
      "14:   runLiveQueryEventHandlers,",
      "15:   getTrigger,",
      "16:   runTrigger,",
      "17:   resolveError,",
      "18:   toJSONwithObjects,",
      "19: } from '../triggers';",
      "21: import { getCacheController, getDatabaseController } from '../Controllers';",
      "24: import DatabaseController from '../Controllers/DatabaseController';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "185:             if (res.object && typeof res.object.toJSON === 'function') {",
      "186:               deletedParseObject = toJSONwithObjects(res.object, res.object.className || className);",
      "187:             }",
      "196:             client.pushDelete(requestId, deletedParseObject);",
      "197:           } catch (e) {",
      "198:             const error = resolveError(e);",
      "",
      "[Removed Lines]",
      "188:             if (",
      "189:               (deletedParseObject.className === '_User' ||",
      "190:                 deletedParseObject.className === '_Session') &&",
      "191:               !client.hasMasterKey",
      "192:             ) {",
      "193:               delete deletedParseObject.sessionToken;",
      "194:               delete deletedParseObject.authData;",
      "195:             }",
      "",
      "[Added Lines]",
      "195:             await this._filterSensitiveData(",
      "196:               classLevelPermissions,",
      "197:               res,",
      "198:               client,",
      "199:               requestId,",
      "200:               op,",
      "201:               subscription.query",
      "202:             );",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "339:                 res.original.className || className",
      "340:               );",
      "341:             }",
      "352:             const functionName = 'push' + res.event.charAt(0).toUpperCase() + res.event.slice(1);",
      "353:             if (client[functionName]) {",
      "354:               client[functionName](requestId, currentParseObject, originalParseObject);",
      "",
      "[Removed Lines]",
      "342:             if (",
      "343:               (currentParseObject.className === '_User' ||",
      "344:                 currentParseObject.className === '_Session') &&",
      "345:               !client.hasMasterKey",
      "346:             ) {",
      "347:               delete currentParseObject.sessionToken;",
      "348:               delete originalParseObject?.sessionToken;",
      "349:               delete currentParseObject.authData;",
      "350:               delete originalParseObject?.authData;",
      "351:             }",
      "",
      "[Added Lines]",
      "349:             await this._filterSensitiveData(",
      "350:               classLevelPermissions,",
      "351:               res,",
      "352:               client,",
      "353:               requestId,",
      "354:               op,",
      "355:               subscription.query",
      "356:             );",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "541:   }",
      "543:   _getCLPOperation(query: any) {",
      "544:     return typeof query === 'object' &&",
      "545:       Object.keys(query).length == 1 &&",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "548:   async _filterSensitiveData(",
      "549:     classLevelPermissions: ?any,",
      "550:     res: any,",
      "551:     client: any,",
      "552:     requestId: number,",
      "553:     op: string,",
      "554:     query: any",
      "555:   ) {",
      "556:     const subscriptionInfo = client.getSubscriptionInfo(requestId);",
      "557:     const aclGroup = ['*'];",
      "558:     let clientAuth;",
      "559:     if (typeof subscriptionInfo !== 'undefined') {",
      "560:       const { userId, auth } = await this.getAuthForSessionToken(subscriptionInfo.sessionToken);",
      "561:       if (userId) {",
      "562:         aclGroup.push(userId);",
      "563:       }",
      "564:       clientAuth = auth;",
      "565:     }",
      "566:     const filter = obj => {",
      "567:       if (!obj) {",
      "568:         return;",
      "569:       }",
      "570:       let protectedFields = classLevelPermissions?.protectedFields || [];",
      "571:       if (!client.hasMasterKey && !Array.isArray(protectedFields)) {",
      "572:         protectedFields = getDatabaseController(this.config).addProtectedFields(",
      "573:           classLevelPermissions,",
      "574:           res.object.className,",
      "575:           query,",
      "576:           aclGroup,",
      "577:           clientAuth",
      "578:         );",
      "579:       }",
      "580:       return DatabaseController.filterSensitiveData(",
      "581:         client.hasMasterKey,",
      "582:         aclGroup,",
      "583:         clientAuth,",
      "584:         op,",
      "585:         classLevelPermissions,",
      "586:         res.object.className,",
      "587:         protectedFields,",
      "588:         obj,",
      "589:         query",
      "590:       );",
      "591:     };",
      "592:     res.object = filter(res.object);",
      "593:     res.original = filter(res.original);",
      "594:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "054f3e6ab01d66a0dcfb77725af28eac1485b375",
      "candidate_info": {
        "commit_hash": "054f3e6ab01d66a0dcfb77725af28eac1485b375",
        "repo": "parse-community/parse-server",
        "commit_url": "https://github.com/parse-community/parse-server/commit/054f3e6ab01d66a0dcfb77725af28eac1485b375",
        "files": [
          "spec/ParseLiveQuery.spec.js",
          "src/Controllers/DatabaseController.js",
          "src/LiveQuery/ParseCloudCodePublisher.js",
          "src/LiveQuery/ParseLiveQueryServer.js"
        ],
        "message": "fix: protected fields exposed via LiveQuery; this removes protected fields from the client response; this may be a breaking change if your app is currently expecting to receive these protected fields ([GHSA-crrq-vr9j-fxxh](https://github.com/parse-community/parse-server/security/advisories/GHSA-crrq-vr9j-fxxh)) (#8074)",
        "before_after_code_files": [
          "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js",
          "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js",
          "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js",
          "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js",
            "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js",
            "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js",
            "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js"
          ],
          "candidate": [
            "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js",
            "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js",
            "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js",
            "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js"
          ]
        }
      },
      "candidate_diff": {
        "spec/ParseLiveQuery.spec.js||spec/ParseLiveQuery.spec.js": [
          "File: spec/ParseLiveQuery.spec.js -> spec/ParseLiveQuery.spec.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "974:     }",
          "975:   });",
          "977:   afterEach(async function (done) {",
          "978:     const client = await Parse.CoreManager.getLiveQueryController().getDefaultLiveQueryClient();",
          "979:     client.close();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "977:   it('should strip out protected fields', async () => {",
          "978:     await reconfigureServer({",
          "979:       liveQuery: { classNames: ['Test'] },",
          "980:       startLiveQueryServer: true,",
          "981:     });",
          "982:     const obj1 = new Parse.Object('Test');",
          "983:     obj1.set('foo', 'foo');",
          "984:     obj1.set('bar', 'bar');",
          "985:     obj1.set('qux', 'qux');",
          "986:     await obj1.save();",
          "987:     const config = Config.get(Parse.applicationId);",
          "988:     const schemaController = await config.database.loadSchema();",
          "989:     await schemaController.updateClass(",
          "990:       'Test',",
          "991:       {},",
          "992:       {",
          "993:         get: { '*': true },",
          "994:         find: { '*': true },",
          "995:         update: { '*': true },",
          "996:         protectedFields: {",
          "997:           '*': ['foo'],",
          "998:         },",
          "999:       }",
          "1000:     );",
          "1001:     const object = await obj1.fetch();",
          "1002:     expect(object.get('foo')).toBe(undefined);",
          "1003:     expect(object.get('bar')).toBeDefined();",
          "1004:     expect(object.get('qux')).toBeDefined();",
          "1006:     const subscription = await new Parse.Query('Test').subscribe();",
          "1007:     await Promise.all([",
          "1008:       new Promise(resolve => {",
          "1009:         subscription.on('update', (obj, original) => {",
          "1010:           expect(obj.get('foo')).toBe(undefined);",
          "1011:           expect(obj.get('bar')).toBeDefined();",
          "1012:           expect(obj.get('qux')).toBeDefined();",
          "1013:           expect(original.get('foo')).toBe(undefined);",
          "1014:           expect(original.get('bar')).toBeDefined();",
          "1015:           expect(original.get('qux')).toBeDefined();",
          "1016:           resolve();",
          "1017:         });",
          "1018:       }),",
          "1019:       obj1.save({ foo: 'abc' }),",
          "1020:     ]);",
          "1021:   });",
          "",
          "---------------"
        ],
        "src/Controllers/DatabaseController.js||src/Controllers/DatabaseController.js": [
          "File: src/Controllers/DatabaseController.js -> src/Controllers/DatabaseController.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:   aclGroup: any[],",
          "124:   auth: any,",
          "125:   operation: any,",
          "127:   className: string,",
          "128:   protectedFields: null | Array<any>,",
          "129:   object: any",
          "",
          "[Removed Lines]",
          "126:   schema: SchemaController.SchemaController,",
          "",
          "[Added Lines]",
          "126:   schema: SchemaController.SchemaController | any,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "132:   if (auth && auth.user) userId = auth.user.id;",
          "136:   if (perms) {",
          "137:     const isReadOperation = ['get', 'find'].indexOf(operation) > -1;",
          "",
          "[Removed Lines]",
          "135:   const perms = schema.getClassLevelPermissions(className);",
          "",
          "[Added Lines]",
          "135:   const perms =",
          "136:     schema && schema.getClassLevelPermissions ? schema.getClassLevelPermissions(className) : {};",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1430:   }",
          "1432:   addProtectedFields(",
          "1434:     className: string,",
          "1435:     query: any = {},",
          "1436:     aclGroup: any[] = [],",
          "1437:     auth: any = {},",
          "1438:     queryOptions: FullQueryOptions = {}",
          "1439:   ): null | string[] {",
          "1441:     if (!perms) return null;",
          "1443:     const protectedFields = perms.protectedFields;",
          "",
          "[Removed Lines]",
          "1433:     schema: SchemaController.SchemaController,",
          "1440:     const perms = schema.getClassLevelPermissions(className);",
          "",
          "[Added Lines]",
          "1434:     schema: SchemaController.SchemaController | any,",
          "1441:     const perms =",
          "1442:       schema && schema.getClassLevelPermissions",
          "1443:         ? schema.getClassLevelPermissions(className)",
          "1444:         : schema;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1741:   }",
          "1743:   static _validateQuery: any => void;",
          "1744: }",
          "1746: module.exports = DatabaseController;",
          "1748: module.exports._validateQuery = validateQuery;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1748:   static filterSensitiveData: (boolean, any[], any, any, any, string, any[], any) => void;",
          "1754: module.exports.filterSensitiveData = filterSensitiveData;",
          "",
          "---------------"
        ],
        "src/LiveQuery/ParseCloudCodePublisher.js||src/LiveQuery/ParseCloudCodePublisher.js": [
          "File: src/LiveQuery/ParseCloudCodePublisher.js -> src/LiveQuery/ParseCloudCodePublisher.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "33:     if (request.original) {",
          "34:       message.originalParseObject = request.original._toFullJSON();",
          "35:     }",
          "36:     this.parsePublisher.publish(type, JSON.stringify(message));",
          "37:   }",
          "38: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36:     if (request.classLevelPermissions) {",
          "37:       message.classLevelPermissions = request.classLevelPermissions;",
          "38:     }",
          "",
          "---------------"
        ],
        "src/LiveQuery/ParseLiveQueryServer.js||src/LiveQuery/ParseLiveQueryServer.js": [
          "File: src/LiveQuery/ParseLiveQueryServer.js -> src/LiveQuery/ParseLiveQueryServer.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "17:   maybeRunAfterEventTrigger,",
          "18: } from '../triggers';",
          "19: import { getAuthForSessionToken, Auth } from '../Auth';",
          "21: import LRU from 'lru-cache';",
          "22: import UserRouter from '../Routers/UsersRouter';",
          "24: class ParseLiveQueryServer {",
          "25:   clients: Map;",
          "",
          "[Removed Lines]",
          "20: import { getCacheController } from '../Controllers';",
          "",
          "[Added Lines]",
          "20: import { getCacheController, getDatabaseController } from '../Controllers';",
          "23: import DatabaseController from '../Controllers/DatabaseController';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "171:               };",
          "172:               return maybeRunAfterEventTrigger('afterEvent', className, res);",
          "173:             })",
          "175:               if (!res.sendEvent) {",
          "176:                 return;",
          "177:               }",
          "",
          "[Removed Lines]",
          "174:             .then(() => {",
          "",
          "[Added Lines]",
          "175:             .then(async () => {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "179:                 deletedParseObject = res.object.toJSON();",
          "180:                 deletedParseObject.className = className;",
          "181:               }",
          "190:               client.pushDelete(requestId, deletedParseObject);",
          "191:             })",
          "192:             .catch(error => {",
          "",
          "[Removed Lines]",
          "182:               if (",
          "183:                 (deletedParseObject.className === '_User' ||",
          "184:                   deletedParseObject.className === '_Session') &&",
          "185:                 !client.hasMasterKey",
          "186:               ) {",
          "187:                 delete deletedParseObject.sessionToken;",
          "188:                 delete deletedParseObject.authData;",
          "189:               }",
          "",
          "[Added Lines]",
          "183:               await this._filterSensitiveData(",
          "184:                 classLevelPermissions,",
          "185:                 res,",
          "186:                 client,",
          "187:                 requestId,",
          "188:                 op,",
          "189:                 subscription.query",
          "190:               );",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "310:               return maybeRunAfterEventTrigger('afterEvent', className, res);",
          "311:             })",
          "312:             .then(",
          "314:                 if (!res.sendEvent) {",
          "315:                   return;",
          "316:                 }",
          "",
          "[Removed Lines]",
          "313:               () => {",
          "",
          "[Added Lines]",
          "314:               async () => {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "323:                   originalParseObject = res.original.toJSON();",
          "324:                   originalParseObject.className = res.original.className || className;",
          "325:                 }",
          "336:                 const functionName =",
          "337:                   'push' + message.event.charAt(0).toUpperCase() + message.event.slice(1);",
          "338:                 if (client[functionName]) {",
          "",
          "[Removed Lines]",
          "326:                 if (",
          "327:                   (currentParseObject.className === '_User' ||",
          "328:                     currentParseObject.className === '_Session') &&",
          "329:                   !client.hasMasterKey",
          "330:                 ) {",
          "331:                   delete currentParseObject.sessionToken;",
          "332:                   delete originalParseObject?.sessionToken;",
          "333:                   delete currentParseObject.authData;",
          "334:                   delete originalParseObject?.authData;",
          "335:                 }",
          "",
          "[Added Lines]",
          "327:                 await this._filterSensitiveData(",
          "328:                   classLevelPermissions,",
          "329:                   res,",
          "330:                   client,",
          "331:                   requestId,",
          "332:                   op,",
          "333:                   subscription.query",
          "334:                 );",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "533:   }",
          "535:   _getCLPOperation(query: any) {",
          "536:     return typeof query === 'object' &&",
          "537:       Object.keys(query).length == 1 &&",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "534:   async _filterSensitiveData(",
          "535:     classLevelPermissions: ?any,",
          "536:     res: any,",
          "537:     client: any,",
          "538:     requestId: number,",
          "539:     op: string,",
          "540:     query: any",
          "541:   ) {",
          "542:     const subscriptionInfo = client.getSubscriptionInfo(requestId);",
          "543:     const aclGroup = ['*'];",
          "544:     let clientAuth;",
          "545:     if (typeof subscriptionInfo !== 'undefined') {",
          "546:       const { userId, auth } = await this.getAuthForSessionToken(subscriptionInfo.sessionToken);",
          "547:       if (userId) {",
          "548:         aclGroup.push(userId);",
          "549:       }",
          "550:       clientAuth = auth;",
          "551:     }",
          "552:     const filter = obj => {",
          "553:       if (!obj) {",
          "554:         return;",
          "555:       }",
          "556:       let protectedFields = classLevelPermissions?.protectedFields || [];",
          "557:       if (!client.hasMasterKey && !Array.isArray(protectedFields)) {",
          "558:         protectedFields = getDatabaseController(this.config).addProtectedFields(",
          "559:           classLevelPermissions,",
          "560:           res.object.className,",
          "561:           query,",
          "562:           aclGroup,",
          "563:           clientAuth",
          "564:         );",
          "565:       }",
          "566:       return DatabaseController.filterSensitiveData(",
          "567:         client.hasMasterKey,",
          "568:         aclGroup,",
          "569:         clientAuth,",
          "570:         op,",
          "571:         classLevelPermissions,",
          "572:         res.object.className,",
          "573:         protectedFields,",
          "574:         obj",
          "575:       );",
          "576:     };",
          "577:     res.object = filter(res.object);",
          "578:     res.original = filter(res.original);",
          "579:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}