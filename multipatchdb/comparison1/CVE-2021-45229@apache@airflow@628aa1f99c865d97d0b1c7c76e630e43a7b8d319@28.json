{
  "cve_id": "CVE-2021-45229",
  "cve_desc": "It was discovered that the \"Trigger DAG with config\" screen was susceptible to XSS attacks via the `origin` query argument. This issue affects Apache Airflow versions 2.2.3 and below.",
  "repo": "apache/airflow",
  "patch_hash": "628aa1f99c865d97d0b1c7c76e630e43a7b8d319",
  "patch_info": {
    "commit_hash": "628aa1f99c865d97d0b1c7c76e630e43a7b8d319",
    "repo": "apache/airflow",
    "commit_url": "https://github.com/apache/airflow/commit/628aa1f99c865d97d0b1c7c76e630e43a7b8d319",
    "files": [
      "airflow/www/templates/airflow/trigger.html",
      "tests/www/views/test_views_trigger_dag.py"
    ],
    "message": "Simplify trigger cancel button (#21591)\n\nCo-authored-by: Jed Cunningham <jedcunningham@apache.org>\n(cherry picked from commit 65297673a318660fba76797e50d0c06804dfcafc)",
    "before_after_code_files": [
      "airflow/www/templates/airflow/trigger.html||airflow/www/templates/airflow/trigger.html",
      "tests/www/views/test_views_trigger_dag.py||tests/www/views/test_views_trigger_dag.py"
    ]
  },
  "patch_diff": {
    "airflow/www/templates/airflow/trigger.html||airflow/www/templates/airflow/trigger.html": [
      "File: airflow/www/templates/airflow/trigger.html -> airflow/www/templates/airflow/trigger.html",
      "--- Hunk 1 ---",
      "[Context before]",
      "63:       </label>",
      "64:     </div>",
      "65:     <button type=\"submit\" class=\"btn btn-primary\">Trigger</button>",
      "67:   </form>",
      "68: {% endblock %}",
      "",
      "[Removed Lines]",
      "66:     <button type=\"button\" class=\"btn\" onclick=\"location.href = '{{ origin }}'; return false\">Cancel</button>",
      "",
      "[Added Lines]",
      "66:     <a class=\"btn\" href=\"{{ origin }}\">Cancel</a>",
      "",
      "---------------"
    ],
    "tests/www/views/test_views_trigger_dag.py||tests/www/views/test_views_trigger_dag.py": [
      "File: tests/www/views/test_views_trigger_dag.py -> tests/www/views/test_views_trigger_dag.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "133:         (\"javascript:alert(1)\", \"/home\"),",
      "134:         (\"http://google.com\", \"/home\"),",
      "135:         (\"36539'%3balert(1)%2f%2f166\", \"/home\"),",
      "136:         (",
      "137:             \"%2Ftree%3Fdag_id%3Dexample_bash_operator';alert(33)//\",",
      "138:             \"/home\",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "136:         (",
      "137:             '\"><script>alert(99)</script><a href=\"',",
      "138:             \"&#34;&gt;&lt;script&gt;alert(99)&lt;/script&gt;&lt;a href=&#34;\",",
      "139:         ),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "145:     test_dag_id = \"example_bash_operator\"",
      "147:     resp = admin_client.get(f'trigger?dag_id={test_dag_id}&origin={test_origin}')",
      "156: @pytest.mark.parametrize(",
      "",
      "[Removed Lines]",
      "148:     check_content_in_response(",
      "149:         '<button type=\"button\" class=\"btn\" onclick=\"location.href = \\'{}\\'; return false\">'.format(",
      "150:             expected_origin",
      "151:         ),",
      "152:         resp,",
      "153:     )",
      "",
      "[Added Lines]",
      "152:     check_content_in_response(f'<a class=\"btn\" href=\"{expected_origin}\">Cancel</a>', resp)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "793aaa939a645511a4fa3f4c37a9c7fc7675b109",
      "candidate_info": {
        "commit_hash": "793aaa939a645511a4fa3f4c37a9c7fc7675b109",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/793aaa939a645511a4fa3f4c37a9c7fc7675b109",
        "files": [
          "setup.py"
        ],
        "message": "Limit Snowflake connector to< 2.7.2 (#20395)\n\nThe Snowflake connector 2.7.2 requires pyarrow to be >=6.0.0\n(but it has no \"install_requires\" for it - it checks it\ndynamically and prints warning when imported.\n\nWe should limit the provider until apache-beam will remove the\npyarrow < 6.0.0 limitation.\n\n(cherry picked from commit 0050e44f473ad2802c882cf008846a32c83d009d)",
        "before_after_code_files": [
          "setup.py||setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/21659"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "setup.py||setup.py": [
          "File: setup.py -> setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "465:     'slack_sdk>=3.0.0,<4.0.0',",
          "466: ]",
          "467: snowflake = [",
          "469:     # The snowflake-alchemy 1.2.5 introduces a hard dependency on sqlalchemy>=1.4.0, but they didn't define",
          "470:     # this requirements in setup.py, so pip cannot figure out the correct set of dependencies.",
          "471:     # See: https://github.com/snowflakedb/snowflake-sqlalchemy/issues/234",
          "",
          "[Removed Lines]",
          "468:     'snowflake-connector-python>=2.4.1',",
          "",
          "[Added Lines]",
          "468:     # Snowflake connector 2.7.2 requires pyarrow >=6.0.0 but apache-beam requires < 6.0.0",
          "469:     # We should remove the limitation when apache-beam upgrades pyarrow",
          "470:     'snowflake-connector-python>=2.4.1,<2.7.2',",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "97c00695d4860760de02e47cde85421d9314c1dd",
      "candidate_info": {
        "commit_hash": "97c00695d4860760de02e47cde85421d9314c1dd",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/97c00695d4860760de02e47cde85421d9314c1dd",
        "files": [
          "dev/README_RELEASE_AIRFLOW.md",
          "dev/prepare_prod_docker_images.sh"
        ],
        "message": "Move scripts for prod image preparation to dev (#19623)\n\nThe script belongs to dev. Also it had `echo` debug commands left\nafter testing that are removed now.\n\n(cherry picked from commit d02c11780adfb56a788799c56ae23d875b7610dd)",
        "before_after_code_files": [
          "scripts/ci/tools/prepare_prod_docker_images.sh||dev/prepare_prod_docker_images.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/21659"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "scripts/ci/tools/prepare_prod_docker_images.sh||dev/prepare_prod_docker_images.sh": [
          "File: scripts/ci/tools/prepare_prod_docker_images.sh -> dev/prepare_prod_docker_images.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: # KIND, either express or implied.  See the License for the",
          "16: # specific language governing permissions and limitations",
          "17: # under the License.",
          "19: export AIRFLOW_SOURCES_DIR",
          "21: CURRENT_PYTHON_MAJOR_MINOR_VERSIONS=(\"3.7\" \"3.8\" \"3.9\" \"3.6\")",
          "",
          "[Removed Lines]",
          "18: AIRFLOW_SOURCES_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\"/../../../ && pwd)\"",
          "",
          "[Added Lines]",
          "18: AIRFLOW_SOURCES_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\"/.. && pwd)\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "43: for python_version in \"${CURRENT_PYTHON_MAJOR_MINOR_VERSIONS[@]}\"",
          "44: do",
          "45:   export PYTHON_MAJOR_MINOR_VERSION=${python_version}",
          "47: done",
          "49: if [[ ${INSTALL_AIRFLOW_VERSION} =~ .*rc.* ]]; then",
          "",
          "[Removed Lines]",
          "46:   echo \"${AIRFLOW_SOURCES_DIR}/scripts/ci/tools/build_dockerhub.sh\"",
          "",
          "[Added Lines]",
          "46:   \"${AIRFLOW_SOURCES_DIR}/scripts/ci/tools/build_dockerhub.sh\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "66: for python_version in \"${CURRENT_PYTHON_MAJOR_MINOR_VERSIONS[@]}\"",
          "67: do",
          "69:         \"apache/airflow:latest-python${python_version}\"",
          "71: done",
          "",
          "[Removed Lines]",
          "68:     echo docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}-python${python_version}\" \\",
          "70:     echo docker push \"apache/airflow:latest-python${python_version}\"",
          "73: echo docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}\" \"apache/airflow:latest\"",
          "74: echo docker push \"apache/airflow:latest\"",
          "",
          "[Added Lines]",
          "68:     docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}-python${python_version}\" \\",
          "70:     docker push \"apache/airflow:latest-python${python_version}\"",
          "73: docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}\" \"apache/airflow:latest\"",
          "74: docker push \"apache/airflow:latest\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e8a8566c7867e9e378d006fe6d196eed15136af6",
      "candidate_info": {
        "commit_hash": "e8a8566c7867e9e378d006fe6d196eed15136af6",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/e8a8566c7867e9e378d006fe6d196eed15136af6",
        "files": [
          "dev/README_RELEASE_AIRFLOW.md",
          "scripts/ci/tools/prepare_prod_docker_images.sh"
        ],
        "message": "Improve automation for docker image release (#19573)\n\nThe \"latest\" tags for docker images were not applied in recent\nreleases - mainly because the process of doing it was not followed,\nbut this was also not obvious as preparing the rc image and final\nimages was different - the latest images required extra manual\nstep.\n\nThis PR modifies the \"image preparation\" script to ask a question\nwhether the latest images should be tagged when non-RC build\nis being prepared.\n\nFixes: #19569\n(cherry picked from commit 4a072725cbe63bff8f69b05dfb960134783ee17e)",
        "before_after_code_files": [
          "scripts/ci/tools/prepare_prod_docker_images.sh||scripts/ci/tools/prepare_prod_docker_images.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/21659"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "scripts/ci/tools/prepare_prod_docker_images.sh||scripts/ci/tools/prepare_prod_docker_images.sh": [
          "File: scripts/ci/tools/prepare_prod_docker_images.sh -> scripts/ci/tools/prepare_prod_docker_images.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: AIRFLOW_SOURCES_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\"/../../../ && pwd)\"",
          "19: export AIRFLOW_SOURCES_DIR",
          "21: usage() {",
          "22:     local cmdname",
          "23:     cmdname=\"$(basename -- \"$0\")\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: CURRENT_PYTHON_MAJOR_MINOR_VERSIONS=(\"3.7\" \"3.8\" \"3.9\" \"3.6\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39: export INSTALL_AIRFLOW_VERSION=\"${1}\"",
          "42: do",
          "43:   export PYTHON_MAJOR_MINOR_VERSION=${python_version}",
          "45: done",
          "",
          "[Removed Lines]",
          "41: for python_version in \"3.6\" \"3.7\" \"3.8\" \"3.9\"",
          "44:   \"${AIRFLOW_SOURCES_DIR}/scripts/ci/tools/build_dockerhub.sh\"",
          "",
          "[Added Lines]",
          "43: for python_version in \"${CURRENT_PYTHON_MAJOR_MINOR_VERSIONS[@]}\"",
          "46:   echo \"${AIRFLOW_SOURCES_DIR}/scripts/ci/tools/build_dockerhub.sh\"",
          "47: done",
          "49: if [[ ${INSTALL_AIRFLOW_VERSION} =~ .*rc.* ]]; then",
          "50:     echo",
          "51:     echo \"Skipping tagging latest as this is an rc version\"",
          "52:     echo",
          "53:     exit",
          "54: fi",
          "56: echo \"Should we tag version ${1} with latest tag [y/N]\"",
          "57: read -r RESPONSE",
          "59: if [[ ${RESPONSE} == 'n' || ${RESPONSE} = 'N' ]]; then",
          "60:     echo",
          "61:     echo \"Skip tagging the image with latest tag.\"",
          "62:     echo",
          "63:     exit",
          "64: fi",
          "66: for python_version in \"${CURRENT_PYTHON_MAJOR_MINOR_VERSIONS[@]}\"",
          "67: do",
          "68:     echo docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}-python${python_version}\" \\",
          "69:         \"apache/airflow:latest-python${python_version}\"",
          "70:     echo docker push \"apache/airflow:latest-python${python_version}\"",
          "73: echo docker tag \"apache/airflow:${INSTALL_AIRFLOW_VERSION}\" \"apache/airflow:latest\"",
          "74: echo docker push \"apache/airflow:latest\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ae28789902c048afb8e35bcadc8c2934538d7cb5",
      "candidate_info": {
        "commit_hash": "ae28789902c048afb8e35bcadc8c2934538d7cb5",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/ae28789902c048afb8e35bcadc8c2934538d7cb5",
        "files": [
          "dev/README_RELEASE_AIRFLOW.md",
          "dev/retag_docker_images.py"
        ],
        "message": "Update description of release process for adding new major release (#19483)\n\n(cherry picked from commit 7b705aade6812bca5a806056fe40fb8db47f79c7)",
        "before_after_code_files": [
          "dev/retag_docker_images.py||dev/retag_docker_images.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/21659"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "dev/retag_docker_images.py||dev/retag_docker_images.py": [
          "File: dev/retag_docker_images.py -> dev/retag_docker_images.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "38: GHCR_IO_IMAGES = [",
          "39:     \"{prefix}/{branch}/ci-manifest/python{python_version}:latest\",",
          "40:     \"{prefix}/{branch}/ci/python{python_version}:latest\",",
          "43:     \"{prefix}/{branch}/python:{python_version}-slim-buster\",",
          "44: ]",
          "",
          "[Removed Lines]",
          "41:     \"{prefix}/{branch}/prod-build/python{python_version}-build-v2:latest\",",
          "42:     \"{prefix}/{branch}/prod/python{python_version}-build-v2:latest\",",
          "",
          "[Added Lines]",
          "41:     \"{prefix}/{branch}/prod-build/python{python_version}-build:latest\",",
          "42:     \"{prefix}/{branch}/prod/python{python_version}-build:latest\",",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e21fc841686b438c6ac96ff8b829ca87dbb3c5ab",
      "candidate_info": {
        "commit_hash": "e21fc841686b438c6ac96ff8b829ca87dbb3c5ab",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/e21fc841686b438c6ac96ff8b829ca87dbb3c5ab",
        "files": [
          "setup.py"
        ],
        "message": "upgrade celery 5.2.3 (#19703)\n\n(cherry picked from commit e1fbfc60d29af3fc0928b904ac80ca3b71a3a839)",
        "before_after_code_files": [
          "setup.py||setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/21659"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "setup.py||setup.py": [
          "File: setup.py -> setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "224:     'cassandra-driver>=3.13.0,<4',",
          "225: ]",
          "226: celery = [",
          "228:     'flower~=1.0.0',",
          "229: ]",
          "230: cgroups = [",
          "",
          "[Removed Lines]",
          "227:     'celery~=5.1,>=5.1.2',",
          "",
          "[Added Lines]",
          "227:     'celery>=5.2.3',",
          "",
          "---------------"
        ]
      }
    }
  ]
}