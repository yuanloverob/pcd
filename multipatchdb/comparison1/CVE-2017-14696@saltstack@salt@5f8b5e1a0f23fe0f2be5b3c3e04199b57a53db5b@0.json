{
  "cve_id": "CVE-2017-14696",
  "cve_desc": "SaltStack Salt before 2016.3.8, 2016.11.x before 2016.11.8, and 2017.7.x before 2017.7.2 allows remote attackers to cause a denial of service via a crafted authentication request.",
  "repo": "saltstack/salt",
  "patch_hash": "5f8b5e1a0f23fe0f2be5b3c3e04199b57a53db5b",
  "patch_info": {
    "commit_hash": "5f8b5e1a0f23fe0f2be5b3c3e04199b57a53db5b",
    "repo": "saltstack/salt",
    "commit_url": "https://github.com/saltstack/salt/commit/5f8b5e1a0f23fe0f2be5b3c3e04199b57a53db5b",
    "files": [
      "salt/crypt.py",
      "salt/transport/tcp.py",
      "salt/transport/zeromq.py"
    ],
    "message": "Do not allow IDs with null bytes in decoded payloads",
    "before_after_code_files": [
      "salt/crypt.py||salt/crypt.py",
      "salt/transport/tcp.py||salt/transport/tcp.py",
      "salt/transport/zeromq.py||salt/transport/zeromq.py"
    ]
  },
  "patch_diff": {
    "salt/crypt.py||salt/crypt.py": [
      "File: salt/crypt.py -> salt/crypt.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "607:                 raise tornado.gen.Return('retry')",
      "608:             else:",
      "609:                 raise SaltClientError('Attempt to authenticate with the salt master failed with timeout error')",
      "610:         if 'load' in payload:",
      "611:             if 'ret' in payload['load']:",
      "612:                 if not payload['load']['ret']:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "610:         if not isinstance(payload, dict):",
      "611:             log.error('Sign-in attempt failed: %s', payload)",
      "612:             raise tornado.gen.Return(False)",
      "",
      "---------------"
    ],
    "salt/transport/tcp.py||salt/transport/tcp.py": [
      "File: salt/transport/tcp.py -> salt/transport/tcp.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "623:                     'payload and load must be a dict', header=header))",
      "624:                 raise tornado.gen.Return()",
      "626:             # intercept the \"_auth\" commands, since the main daemon shouldn't know",
      "627:             # anything about our key auth",
      "628:             if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "626:             try:",
      "627:                 id_ = payload['load'].get('id', '')",
      "628:                 if '\\0' in id_:",
      "629:                     log.error('Payload contains an id with a null byte: %s', payload)",
      "630:                     stream.send(self.serial.dumps('bad load: id contains a null byte'))",
      "631:                     raise tornado.gen.Return()",
      "632:             except TypeError:",
      "633:                 log.error('Payload contains non-string id: %s', payload)",
      "634:                 stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
      "635:                 raise tornado.gen.Return()",
      "",
      "---------------"
    ],
    "salt/transport/zeromq.py||salt/transport/zeromq.py": [
      "File: salt/transport/zeromq.py -> salt/transport/zeromq.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "596:             stream.send(self.serial.dumps('payload and load must be a dict'))",
      "597:             raise tornado.gen.Return()",
      "599:         # intercept the \"_auth\" commands, since the main daemon shouldn't know",
      "600:         # anything about our key auth",
      "601:         if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "599:         try:",
      "600:             id_ = payload['load'].get('id', '')",
      "601:             if '\\0' in id_:",
      "602:                 log.error('Payload contains an id with a null byte: %s', payload)",
      "603:                 stream.send(self.serial.dumps('bad load: id contains a null byte'))",
      "604:                 raise tornado.gen.Return()",
      "605:         except TypeError:",
      "606:             log.error('Payload contains non-string id: %s', payload)",
      "607:             stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
      "608:             raise tornado.gen.Return()",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "80d90307b07b3703428ecbb7c8bb468e28a9ae6d",
      "candidate_info": {
        "commit_hash": "80d90307b07b3703428ecbb7c8bb468e28a9ae6d",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/80d90307b07b3703428ecbb7c8bb468e28a9ae6d",
        "files": [
          "salt/utils/verify.py",
          "tests/unit/utils/test_verify.py"
        ],
        "message": "Don't allow path separators in minion ID",
        "before_after_code_files": [
          "salt/utils/verify.py||salt/utils/verify.py",
          "tests/unit/utils/test_verify.py||tests/unit/utils/test_verify.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/45025"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "salt/utils/verify.py||salt/utils/verify.py": [
          "File: salt/utils/verify.py -> salt/utils/verify.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "480:     return ''",
          "492: def valid_id(opts, id_):",
          "493:     '''",
          "494:     Returns if the passed id is valid",
          "495:     '''",
          "496:     try:",
          "499:         return False",
          "",
          "[Removed Lines]",
          "483: def clean_id(id_):",
          "484:     '''",
          "485:     Returns if the passed id is clean.",
          "486:     '''",
          "487:     if re.search(r'\\.\\.\\{sep}'.format(sep=os.sep), id_):",
          "488:         return False",
          "489:     return True",
          "497:         return bool(clean_path(opts['pki_dir'], id_)) and clean_id(id_)",
          "498:     except (AttributeError, KeyError, TypeError) as e:",
          "",
          "[Added Lines]",
          "488:         if any(x in id_ for x in ('/', '\\\\', '\\0')):",
          "489:             return False",
          "490:         return bool(clean_path(opts['pki_dir'], id_))",
          "491:     except (AttributeError, KeyError, TypeError):",
          "",
          "---------------"
        ],
        "tests/unit/utils/test_verify.py||tests/unit/utils/test_verify.py": [
          "File: tests/unit/utils/test_verify.py -> tests/unit/utils/test_verify.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:         opts = {'pki_dir': '/tmp/whatever'}",
          "59:         self.assertFalse(valid_id(opts, None))",
          "61:     def test_zmq_verify(self):",
          "62:         self.assertTrue(zmq_version())",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61:     def test_valid_id_pathsep(self):",
          "62:         '''",
          "63:         Path separators in id should make it invalid",
          "64:         '''",
          "65:         opts = {'pki_dir': '/tmp/whatever'}",
          "66:         # We have to test both path separators because os.path.normpath will",
          "67:         # convert forward slashes to backslashes on Windows.",
          "68:         for pathsep in ('/', '\\\\'):",
          "69:             self.assertFalse(valid_id(opts, pathsep.join(('..', 'foobar'))))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0425defe84d98545c9ab3ead0300bbfd029f8a97",
      "candidate_info": {
        "commit_hash": "0425defe84d98545c9ab3ead0300bbfd029f8a97",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/0425defe84d98545c9ab3ead0300bbfd029f8a97",
        "files": [
          "salt/crypt.py",
          "salt/transport/tcp.py",
          "salt/transport/zeromq.py"
        ],
        "message": "Do not allow IDs with null bytes in decoded payloads",
        "before_after_code_files": [
          "salt/crypt.py||salt/crypt.py",
          "salt/transport/tcp.py||salt/transport/tcp.py",
          "salt/transport/zeromq.py||salt/transport/zeromq.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "salt/crypt.py||salt/crypt.py",
            "salt/transport/tcp.py||salt/transport/tcp.py",
            "salt/transport/zeromq.py||salt/transport/zeromq.py"
          ],
          "candidate": [
            "salt/crypt.py||salt/crypt.py",
            "salt/transport/tcp.py||salt/transport/tcp.py",
            "salt/transport/zeromq.py||salt/transport/zeromq.py"
          ]
        }
      },
      "candidate_diff": {
        "salt/crypt.py||salt/crypt.py": [
          "File: salt/crypt.py -> salt/crypt.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "548:                 log.warning('SaltReqTimeoutError: {0}'.format(e))",
          "549:                 raise tornado.gen.Return('retry')",
          "550:             raise SaltClientError('Attempt to authenticate with the salt master failed with timeout error')",
          "551:         if 'load' in payload:",
          "552:             if 'ret' in payload['load']:",
          "553:                 if not payload['load']['ret']:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "551:         if not isinstance(payload, dict):",
          "552:             log.error('Sign-in attempt failed: %s', payload)",
          "553:             raise tornado.gen.Return(False)",
          "",
          "---------------"
        ],
        "salt/transport/tcp.py||salt/transport/tcp.py": [
          "File: salt/transport/tcp.py -> salt/transport/tcp.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "499:                 'payload and load must be a dict', header=header))",
          "500:             raise tornado.gen.Return()",
          "502:         # intercept the \"_auth\" commands, since the main daemon shouldn't know",
          "503:         # anything about our key auth",
          "504:         if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "502:         try:",
          "503:             id_ = payload['load'].get('id', '')",
          "504:             if '\\0' in id_:",
          "505:                 log.error('Payload contains an id with a null byte: %s', payload)",
          "506:                 stream.send(self.serial.dumps('bad load: id contains a null byte'))",
          "507:                 raise tornado.gen.Return()",
          "508:         except TypeError:",
          "509:             log.error('Payload contains non-string id: %s', payload)",
          "510:             stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
          "511:             raise tornado.gen.Return()",
          "",
          "---------------"
        ],
        "salt/transport/zeromq.py||salt/transport/zeromq.py": [
          "File: salt/transport/zeromq.py -> salt/transport/zeromq.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "593:             stream.send(self.serial.dumps('payload and load must be a dict'))",
          "594:             raise tornado.gen.Return()",
          "596:         # intercept the \"_auth\" commands, since the main daemon shouldn't know",
          "597:         # anything about our key auth",
          "598:         if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "596:         try:",
          "597:             id_ = payload['load'].get('id', '')",
          "598:             if '\\0' in id_:",
          "599:                 log.error('Payload contains an id with a null byte: %s', payload)",
          "600:                 stream.send(self.serial.dumps('bad load: id contains a null byte'))",
          "601:                 raise tornado.gen.Return()",
          "602:         except TypeError:",
          "603:             log.error('Payload contains non-string id: %s', payload)",
          "604:             stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
          "605:             raise tornado.gen.Return()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "862f6b8eb8a8172d5b1d43c97136ded52b97b957",
      "candidate_info": {
        "commit_hash": "862f6b8eb8a8172d5b1d43c97136ded52b97b957",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/862f6b8eb8a8172d5b1d43c97136ded52b97b957",
        "files": [
          "salt/crypt.py",
          "salt/transport/tcp.py",
          "salt/transport/zeromq.py"
        ],
        "message": "Do not allow IDs with null bytes in decoded payloads",
        "before_after_code_files": [
          "salt/crypt.py||salt/crypt.py",
          "salt/transport/tcp.py||salt/transport/tcp.py",
          "salt/transport/zeromq.py||salt/transport/zeromq.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "salt/crypt.py||salt/crypt.py",
            "salt/transport/tcp.py||salt/transport/tcp.py",
            "salt/transport/zeromq.py||salt/transport/zeromq.py"
          ],
          "candidate": [
            "salt/crypt.py||salt/crypt.py",
            "salt/transport/tcp.py||salt/transport/tcp.py",
            "salt/transport/zeromq.py||salt/transport/zeromq.py"
          ]
        }
      },
      "candidate_diff": {
        "salt/crypt.py||salt/crypt.py": [
          "File: salt/crypt.py -> salt/crypt.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "606:                 raise tornado.gen.Return('retry')",
          "607:             else:",
          "608:                 raise SaltClientError('Attempt to authenticate with the salt master failed with timeout error')",
          "609:         if 'load' in payload:",
          "610:             if 'ret' in payload['load']:",
          "611:                 if not payload['load']['ret']:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "609:         if not isinstance(payload, dict):",
          "610:             log.error('Sign-in attempt failed: %s', payload)",
          "611:             raise tornado.gen.Return(False)",
          "",
          "---------------"
        ],
        "salt/transport/tcp.py||salt/transport/tcp.py": [
          "File: salt/transport/tcp.py -> salt/transport/tcp.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "623:                     'payload and load must be a dict', header=header))",
          "624:                 raise tornado.gen.Return()",
          "626:             # intercept the \"_auth\" commands, since the main daemon shouldn't know",
          "627:             # anything about our key auth",
          "628:             if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "626:             try:",
          "627:                 id_ = payload['load'].get('id', '')",
          "628:                 if '\\0' in id_:",
          "629:                     log.error('Payload contains an id with a null byte: %s', payload)",
          "630:                     stream.send(self.serial.dumps('bad load: id contains a null byte'))",
          "631:                     raise tornado.gen.Return()",
          "632:             except TypeError:",
          "633:                 log.error('Payload contains non-string id: %s', payload)",
          "634:                 stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
          "635:                 raise tornado.gen.Return()",
          "",
          "---------------"
        ],
        "salt/transport/zeromq.py||salt/transport/zeromq.py": [
          "File: salt/transport/zeromq.py -> salt/transport/zeromq.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "596:             stream.send(self.serial.dumps('payload and load must be a dict'))",
          "597:             raise tornado.gen.Return()",
          "599:         # intercept the \"_auth\" commands, since the main daemon shouldn't know",
          "600:         # anything about our key auth",
          "601:         if payload['enc'] == 'clear' and payload.get('load', {}).get('cmd') == '_auth':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "599:         try:",
          "600:             id_ = payload['load'].get('id', '')",
          "601:             if '\\0' in id_:",
          "602:                 log.error('Payload contains an id with a null byte: %s', payload)",
          "603:                 stream.send(self.serial.dumps('bad load: id contains a null byte'))",
          "604:                 raise tornado.gen.Return()",
          "605:         except TypeError:",
          "606:             log.error('Payload contains non-string id: %s', payload)",
          "607:             stream.send(self.serial.dumps('bad load: id {0} is not a string'.format(id_)))",
          "608:             raise tornado.gen.Return()",
          "",
          "---------------"
        ]
      }
    }
  ]
}