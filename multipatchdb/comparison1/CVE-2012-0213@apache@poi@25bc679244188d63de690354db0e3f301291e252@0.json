{
  "cve_id": "CVE-2012-0213",
  "cve_desc": "The UnhandledDataStructure function in hwpf/model/UnhandledDataStructure.java in Apache POI 3.8 and earlier allows remote attackers to cause a denial of service (OutOfMemoryError exception and possibly JVM destabilization) via a crafted length value in a Channel Definition Format (CDF) or Compound File Binary Format (CFBF) document.",
  "repo": "apache/poi",
  "patch_hash": "25bc679244188d63de690354db0e3f301291e252",
  "patch_info": {
    "commit_hash": "25bc679244188d63de690354db0e3f301291e252",
    "repo": "apache/poi",
    "commit_url": "https://github.com/apache/poi/commit/25bc679244188d63de690354db0e3f301291e252",
    "files": [
      "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
    ],
    "message": "Fix bug #54682 - UnhandledDataStructure should sanity check before allocating, not after\n\ngit-svn-id: https://svn.apache.org/repos/asf/poi/trunk@1487555 13f79535-47bb-0310-9956-ffa450edef68",
    "before_after_code_files": [
      "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
    ]
  },
  "patch_diff": {
    "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java": [
      "File: src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java -> src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "18: package org.apache.poi.hwpf.model;",
      "20: import org.apache.poi.util.Internal;",
      "22: @Internal",
      "23: public final class UnhandledDataStructure",
      "24: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: import java.util.Arrays;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "27:   public UnhandledDataStructure(byte[] buf, int offset, int length)",
      "28:   {",
      "31:     if (offset + length > buf.length)",
      "32:     {",
      "35:     }",
      "37:   }",
      "39:   byte[] getBuf()",
      "",
      "[Removed Lines]",
      "30:     _buf = new byte[length];",
      "33:       throw new IndexOutOfBoundsException(\"buffer length is \" + buf.length +",
      "34:                                           \"but code is trying to read \" + length + \" from offset \" + offset);",
      "36:     System.arraycopy(buf, offset, _buf, 0, length);",
      "",
      "[Added Lines]",
      "39:       throw new IndexOutOfBoundsException(\"Buffer Length is \" + buf.length + \" \" +",
      "40:                                           \"but code is tried to read \" + length + \" from offset \" + offset);",
      "41:     }",
      "42:     if (offset < 0 || length < 0)",
      "43:     {",
      "44:        throw new IndexOutOfBoundsException(\"Offset and Length must both be >= 0, negative \" +",
      "45:          \"indicies are not permitted - code is tried to read \" + length + \" from offset \" + offset);",
      "49:     _buf = Arrays.copyOfRange(buf, offset, offset + length);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1a2591a8c1ca077a9885dc078a56bb677ff0c670",
      "candidate_info": {
        "commit_hash": "1a2591a8c1ca077a9885dc078a56bb677ff0c670",
        "repo": "apache/poi",
        "commit_url": "https://github.com/apache/poi/commit/1a2591a8c1ca077a9885dc078a56bb677ff0c670",
        "files": [
          "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
        ],
        "message": "More on bug #54682 - check for the end offset overflowing too\n\ngit-svn-id: https://svn.apache.org/repos/asf/poi/trunk@1487558 13f79535-47bb-0310-9956-ffa450edef68",
        "before_after_code_files": [
          "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
          ],
          "candidate": [
            "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
          ]
        }
      },
      "candidate_diff": {
        "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java": [
          "File: src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java -> src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:   public UnhandledDataStructure(byte[] buf, int offset, int length)",
          "35:   {",
          "38:     {",
          "39:       throw new IndexOutOfBoundsException(\"Buffer Length is \" + buf.length + \" \" +",
          "41:     }",
          "42:     if (offset < 0 || length < 0)",
          "43:     {",
          "",
          "[Removed Lines]",
          "37:     if (offset + length > buf.length)",
          "40:                                           \"but code is tried to read \" + length + \" from offset \" + offset);",
          "",
          "[Added Lines]",
          "37:     int offsetEnd = offset + length;",
          "38:     if (offsetEnd > buf.length || offsetEnd < 0)",
          "41:                                           \"but code is tried to read \" + length + \" \" +",
          "42:                                           \"from offset \" + offset + \" to \" + offsetEnd);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "46:     }",
          "50:   }",
          "52:   byte[] getBuf()",
          "",
          "[Removed Lines]",
          "49:     _buf = Arrays.copyOfRange(buf, offset, offset + length);",
          "",
          "[Added Lines]",
          "51:     _buf = Arrays.copyOfRange(buf, offset, offsetEnd);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "63b0cd28025c5cf9d3b2664c0b4afe80b57c0304",
      "candidate_info": {
        "commit_hash": "63b0cd28025c5cf9d3b2664c0b4afe80b57c0304",
        "repo": "apache/poi",
        "commit_url": "https://github.com/apache/poi/commit/63b0cd28025c5cf9d3b2664c0b4afe80b57c0304",
        "files": [
          "src/java/org/apache/poi/ss/formula/functions/Complex.java",
          "src/java/org/apache/poi/ss/formula/functions/Quotient.java",
          "src/java/org/apache/poi/ss/formula/functions/Rept.java",
          "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
        ],
        "message": "fixed compatibility issues with JDK 1.5\n\ngit-svn-id: https://svn.apache.org/repos/asf/poi/trunk@1489685 13f79535-47bb-0310-9956-ffa450edef68",
        "before_after_code_files": [
          "src/java/org/apache/poi/ss/formula/functions/Complex.java||src/java/org/apache/poi/ss/formula/functions/Complex.java",
          "src/java/org/apache/poi/ss/formula/functions/Quotient.java||src/java/org/apache/poi/ss/formula/functions/Quotient.java",
          "src/java/org/apache/poi/ss/formula/functions/Rept.java||src/java/org/apache/poi/ss/formula/functions/Rept.java",
          "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
          ],
          "candidate": [
            "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java"
          ]
        }
      },
      "candidate_diff": {
        "src/java/org/apache/poi/ss/formula/functions/Complex.java||src/java/org/apache/poi/ss/formula/functions/Complex.java": [
          "File: src/java/org/apache/poi/ss/formula/functions/Complex.java -> src/java/org/apache/poi/ss/formula/functions/Complex.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "70:         }",
          "72:         String suffixValue = OperandResolver.coerceValueToString(suffix);",
          "74:             suffixValue = DEFAULT_SUFFIX;",
          "75:         }",
          "76:         if (suffixValue.equals(DEFAULT_SUFFIX.toUpperCase()) || suffixValue.equals(SUPPORTED_SUFFIX.toUpperCase())) {",
          "",
          "[Removed Lines]",
          "73:         if (suffixValue.isEmpty()) {",
          "",
          "[Added Lines]",
          "73:         if (suffixValue.length() == 0) {",
          "",
          "---------------"
        ],
        "src/java/org/apache/poi/ss/formula/functions/Quotient.java||src/java/org/apache/poi/ss/formula/functions/Quotient.java": [
          "File: src/java/org/apache/poi/ss/formula/functions/Quotient.java -> src/java/org/apache/poi/ss/formula/functions/Quotient.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: public class Quotient extends Fixed2ArgFunction {",
          "27:     public ValueEval evaluate(int srcRowIndex, int srcColumnIndex, ValueEval venumerator, ValueEval vedenominator) {",
          "29:         double enumerator = 0;",
          "",
          "[Removed Lines]",
          "26:     @Override",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/java/org/apache/poi/ss/formula/functions/Rept.java||src/java/org/apache/poi/ss/formula/functions/Rept.java": [
          "File: src/java/org/apache/poi/ss/formula/functions/Rept.java -> src/java/org/apache/poi/ss/formula/functions/Rept.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "42: public class Rept extends Fixed2ArgFunction  {",
          "46:     public ValueEval evaluate(int srcRowIndex, int srcColumnIndex, ValueEval text, ValueEval number_times) {",
          "48:         ValueEval veText1;",
          "",
          "[Removed Lines]",
          "45:     @Override",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java||src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java": [
          "File: src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java -> src/scratchpad/src/org/apache/poi/hwpf/model/UnhandledDataStructure.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     }",
          "52:   }",
          "54:   byte[] getBuf()",
          "55:   {",
          "56:     return _buf;",
          "",
          "[Removed Lines]",
          "51:     _buf = Arrays.copyOfRange(buf, offset, offsetEnd);",
          "",
          "[Added Lines]",
          "51:     _buf = copyOfRange(buf, offset, offsetEnd);",
          "58:     static byte[] copyOfRange(byte[] original, int from, int to) {",
          "59:         int newLength = to - from;",
          "60:         if (newLength < 0)",
          "61:             throw new IllegalArgumentException(from + \" > \" + to);",
          "62:         byte[] copy = new byte[newLength];",
          "63:         System.arraycopy(original, from, copy, 0,",
          "64:                 Math.min(original.length - from, newLength));",
          "65:         return copy;",
          "66:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}