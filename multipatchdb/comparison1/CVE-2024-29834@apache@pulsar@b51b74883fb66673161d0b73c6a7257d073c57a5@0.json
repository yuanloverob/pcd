{
  "cve_id": "CVE-2024-29834",
  "cve_desc": "This vulnerability allows authenticated users with produce or consume permissions to perform unauthorized operations on partitioned topics, such as unloading topics and triggering compaction. These management operations should be restricted to users with the tenant admin role or superuser role. An authenticated user with produce permission can create subscriptions and update subscription properties on partitioned topics, even though this should be limited to users with consume permissions. This impact analysis assumes that Pulsar has been configured with the default authorization provider. For custom authorization providers, the impact could be slightly different. Additionally, the vulnerability allows an authenticated user to read, create, modify, and delete namespace properties in any namespace in any tenant. In Pulsar, namespace properties are reserved for user provided metadata about the namespace.\n\nThis issue affects Apache Pulsar versions from 2.7.1 to 2.10.6, from 2.11.0 to 2.11.4, from 3.0.0 to 3.0.3, from 3.1.0 to 3.1.3, and from 3.2.0 to 3.2.1. \n\n3.0 Apache Pulsar users should upgrade to at least 3.0.4.\n3.1 and 3.2 Apache Pulsar users should upgrade to at least 3.2.2.\n\nUsers operating versions prior to those listed above should upgrade to the aforementioned patched versions or newer versions.",
  "repo": "apache/pulsar",
  "patch_hash": "b51b74883fb66673161d0b73c6a7257d073c57a5",
  "patch_info": {
    "commit_hash": "b51b74883fb66673161d0b73c6a7257d073c57a5",
    "repo": "apache/pulsar",
    "commit_url": "https://github.com/apache/pulsar/commit/b51b74883fb66673161d0b73c6a7257d073c57a5",
    "files": [
      "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java",
      "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java",
      "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java"
    ],
    "message": "[improve][broker] Add fine-grain authorization to ns/topic management endpoints (#22309)",
    "before_after_code_files": [
      "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java||pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java",
      "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java",
      "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java",
      "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java"
    ]
  },
  "patch_diff": {
    "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java||pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java": [
      "File: pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java -> pulsar-broker-common/src/main/java/org/apache/pulsar/broker/authorization/PulsarAuthorizationProvider.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "542:                             case COMPACT:",
      "543:                             case OFFLOAD:",
      "544:                             case UNLOAD:",
      "545:                             case DELETE_METADATA:",
      "546:                             case UPDATE_METADATA:",
      "547:                             case ADD_BUNDLE_RANGE:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "545:                             case TRIM_TOPIC:",
      "",
      "---------------"
    ],
    "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java": [
      "File: pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java -> pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/AdminResource.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "59: import org.apache.pulsar.common.policies.data.NamespaceOperation;",
      "60: import org.apache.pulsar.common.policies.data.PersistencePolicies;",
      "61: import org.apache.pulsar.common.policies.data.Policies;",
      "64: import org.apache.pulsar.common.policies.data.RetentionPolicies;",
      "65: import org.apache.pulsar.common.policies.data.SchemaCompatibilityStrategy;",
      "66: import org.apache.pulsar.common.policies.data.SubscribeRate;",
      "",
      "[Removed Lines]",
      "62: import org.apache.pulsar.common.policies.data.PolicyName;",
      "63: import org.apache.pulsar.common.policies.data.PolicyOperation;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "710:     }",
      "712:     protected CompletableFuture<SchemaCompatibilityStrategy> getSchemaCompatibilityStrategyAsync() {",
      "717:                     if (ex != null) {",
      "718:                         log.error(\"[{}] Failed to get schema compatibility strategy of topic {} {}\",",
      "719:                                 clientAppId(), topicName, ex);",
      "",
      "[Removed Lines]",
      "713:         return validateTopicPolicyOperationAsync(topicName,",
      "714:                 PolicyName.SCHEMA_COMPATIBILITY_STRATEGY,",
      "715:                 PolicyOperation.READ)",
      "716:                 .thenCompose((__) -> getSchemaCompatibilityStrategyAsyncWithoutAuth()).whenComplete((__, ex) -> {",
      "",
      "[Added Lines]",
      "711:         return getSchemaCompatibilityStrategyAsyncWithoutAuth().whenComplete((__, ex) -> {",
      "",
      "---------------"
    ],
    "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java": [
      "File: pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java -> pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "2378:    }",
      "2380:    protected void internalSetProperty(String key, String value, AsyncResponse asyncResponse) {",
      "2396:    }",
      "2398:    protected void internalSetProperties(Map<String, String> properties, AsyncResponse asyncResponse) {",
      "2414:    }",
      "2416:    protected void internalGetProperty(String key, AsyncResponse asyncResponse) {",
      "2426:    }",
      "2428:    protected void internalGetProperties(AsyncResponse asyncResponse) {",
      "2437:    }",
      "2439:    protected void internalRemoveProperty(String key, AsyncResponse asyncResponse) {",
      "2442:        AtomicReference<String> oldVal = new AtomicReference<>(null);",
      "2457:    }",
      "2459:    protected void internalClearProperties(AsyncResponse asyncResponse) {",
      "2461:        AtomicReference<Integer> clearedCount = new AtomicReference<>(0);",
      "2477:    }",
      "2479:    private CompletableFuture<Void> updatePoliciesAsync(NamespaceName ns, Function<Policies, Policies> updateFunction) {",
      "",
      "[Removed Lines]",
      "2381:        validatePoliciesReadOnlyAccess();",
      "2382:        updatePoliciesAsync(namespaceName, policies -> {",
      "2383:            policies.properties.put(key, value);",
      "2384:            return policies;",
      "2385:        }).thenAccept(v -> {",
      "2386:            log.info(\"[{}] Successfully set property for key {} on namespace {}\", clientAppId(), key,",
      "2387:                    namespaceName);",
      "2388:            asyncResponse.resume(Response.noContent().build());",
      "2389:        }).exceptionally(ex -> {",
      "2390:            Throwable cause = ex.getCause();",
      "2391:            log.error(\"[{}] Failed to set property for key {} on namespace {}\", clientAppId(), key,",
      "2392:                    namespaceName, cause);",
      "2393:            asyncResponse.resume(cause);",
      "2394:            return null;",
      "2395:        });",
      "2399:        validatePoliciesReadOnlyAccess();",
      "2400:        updatePoliciesAsync(namespaceName, policies -> {",
      "2401:            policies.properties.putAll(properties);",
      "2402:            return policies;",
      "2403:        }).thenAccept(v -> {",
      "2404:            log.info(\"[{}] Successfully set {} properties on namespace {}\", clientAppId(), properties.size(),",
      "2405:                    namespaceName);",
      "2406:            asyncResponse.resume(Response.noContent().build());",
      "2407:        }).exceptionally(ex -> {",
      "2408:            Throwable cause = ex.getCause();",
      "2409:            log.error(\"[{}] Failed to set {} properties on namespace {}\", clientAppId(), properties.size(),",
      "2410:                    namespaceName, cause);",
      "2411:            asyncResponse.resume(cause);",
      "2412:            return null;",
      "2413:        });",
      "2417:         getNamespacePoliciesAsync(namespaceName).thenAccept(policies -> {",
      "2418:             asyncResponse.resume(policies.properties.get(key));",
      "2419:         }).exceptionally(ex -> {",
      "2420:             Throwable cause = ex.getCause();",
      "2421:             log.error(\"[{}] Failed to get property for key {} of namespace {}\", clientAppId(), key,",
      "2422:                     namespaceName, cause);",
      "2423:             asyncResponse.resume(cause);",
      "2424:             return null;",
      "2425:         });",
      "2429:        getNamespacePoliciesAsync(namespaceName).thenAccept(policies -> {",
      "2430:            asyncResponse.resume(policies.properties);",
      "2431:        }).exceptionally(ex -> {",
      "2432:            Throwable cause = ex.getCause();",
      "2433:            log.error(\"[{}] Failed to get properties of namespace {}\", clientAppId(), namespaceName, cause);",
      "2434:            asyncResponse.resume(cause);",
      "2435:            return null;",
      "2436:        });",
      "2440:        validatePoliciesReadOnlyAccess();",
      "2443:        updatePoliciesAsync(namespaceName, policies -> {",
      "2444:            oldVal.set(policies.properties.remove(key));",
      "2445:            return policies;",
      "2446:        }).thenAccept(v -> {",
      "2447:            asyncResponse.resume(oldVal.get());",
      "2448:            log.info(\"[{}] Successfully remove property for key {} on namespace {}\", clientAppId(), key,",
      "2449:                    namespaceName);",
      "2450:        }).exceptionally(ex -> {",
      "2451:            Throwable cause = ex.getCause();",
      "2452:            log.error(\"[{}] Failed to remove property for key {} on namespace {}\", clientAppId(), key,",
      "2453:                    namespaceName, cause);",
      "2454:            asyncResponse.resume(cause);",
      "2455:           return null;",
      "2456:        });",
      "2460:        validatePoliciesReadOnlyAccess();",
      "2462:        updatePoliciesAsync(namespaceName, policies -> {",
      "2463:            clearedCount.set(policies.properties.size());",
      "2464:            policies.properties.clear();",
      "2465:            return policies;",
      "2466:        }).thenAccept(v -> {",
      "2467:            asyncResponse.resume(Response.noContent().build());",
      "2468:            log.info(\"[{}] Successfully clear {} properties on namespace {}\", clientAppId(), clearedCount.get(),",
      "2469:                    namespaceName);",
      "2470:        }).exceptionally(ex -> {",
      "2471:            Throwable cause = ex.getCause();",
      "2472:            log.error(\"[{}] Failed to clear {} properties on namespace {}\", clientAppId(), clearedCount.get(),",
      "2473:                    namespaceName, cause);",
      "2474:            asyncResponse.resume(cause);",
      "2475:            return null;",
      "2476:        });",
      "",
      "[Added Lines]",
      "2381:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2382:                .thenCompose(__ -> validatePoliciesReadOnlyAccessAsync())",
      "2383:                .thenCompose(__ -> updatePoliciesAsync(namespaceName, policies -> {",
      "2384:                    policies.properties.put(key, value);",
      "2385:                    return policies;",
      "2386:                }))",
      "2387:                .thenAccept(v -> {",
      "2388:                    log.info(\"[{}] Successfully set property for key {} on namespace {}\", clientAppId(), key,",
      "2389:                            namespaceName);",
      "2390:                    asyncResponse.resume(Response.noContent().build());",
      "2391:                }).exceptionally(ex -> {",
      "2392:                    Throwable cause = ex.getCause();",
      "2393:                    log.error(\"[{}] Failed to set property for key {} on namespace {}\", clientAppId(), key,",
      "2394:                            namespaceName, cause);",
      "2395:                    asyncResponse.resume(cause);",
      "2396:                    return null;",
      "2397:                });",
      "2401:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2402:                .thenCompose(__ -> validatePoliciesReadOnlyAccessAsync())",
      "2403:                .thenCompose(__ -> updatePoliciesAsync(namespaceName, policies -> {",
      "2404:                    policies.properties.putAll(properties);",
      "2405:                    return policies;",
      "2406:                }))",
      "2407:                .thenAccept(v -> {",
      "2408:                    log.info(\"[{}] Successfully set {} properties on namespace {}\", clientAppId(), properties.size(),",
      "2409:                            namespaceName);",
      "2410:                    asyncResponse.resume(Response.noContent().build());",
      "2411:                }).exceptionally(ex -> {",
      "2412:                    Throwable cause = ex.getCause();",
      "2413:                    log.error(\"[{}] Failed to set {} properties on namespace {}\", clientAppId(), properties.size(),",
      "2414:                            namespaceName, cause);",
      "2415:                    asyncResponse.resume(cause);",
      "2416:                    return null;",
      "2417:                });",
      "2421:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2422:                .thenCompose(__ -> getNamespacePoliciesAsync(namespaceName))",
      "2423:                .thenAccept(policies -> asyncResponse.resume(policies.properties.get(key)))",
      "2424:                .exceptionally(ex -> {",
      "2425:                    Throwable cause = ex.getCause();",
      "2426:                    log.error(\"[{}] Failed to get property for key {} of namespace {}\", clientAppId(), key,",
      "2427:                            namespaceName, cause);",
      "2428:                    asyncResponse.resume(cause);",
      "2429:                    return null;",
      "2430:                });",
      "2434:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2435:                .thenCompose(__ -> getNamespacePoliciesAsync(namespaceName))",
      "2436:                .thenAccept(policies -> asyncResponse.resume(policies.properties))",
      "2437:                .exceptionally(ex -> {",
      "2438:                    Throwable cause = ex.getCause();",
      "2439:                    log.error(\"[{}] Failed to get properties of namespace {}\", clientAppId(), namespaceName, cause);",
      "2440:                    asyncResponse.resume(cause);",
      "2441:                    return null;",
      "2442:                });",
      "2447:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2448:                .thenCompose(__ -> validatePoliciesReadOnlyAccessAsync())",
      "2449:                .thenCompose(__ -> updatePoliciesAsync(namespaceName, policies -> {",
      "2450:                    oldVal.set(policies.properties.remove(key));",
      "2451:                    return policies;",
      "2452:                })).thenAccept(v -> {",
      "2453:                    asyncResponse.resume(oldVal.get());",
      "2454:                    log.info(\"[{}] Successfully remove property for key {} on namespace {}\", clientAppId(), key,",
      "2455:                            namespaceName);",
      "2456:                }).exceptionally(ex -> {",
      "2457:                    Throwable cause = ex.getCause();",
      "2458:                    log.error(\"[{}] Failed to remove property for key {} on namespace {}\", clientAppId(), key,",
      "2459:                            namespaceName, cause);",
      "2460:                    asyncResponse.resume(cause);",
      "2461:                    return null;",
      "2462:                });",
      "2467:        validateAdminAccessForTenantAsync(namespaceName.getTenant())",
      "2468:                .thenCompose(__ -> validatePoliciesReadOnlyAccessAsync())",
      "2469:                .thenCompose(__ -> updatePoliciesAsync(namespaceName, policies -> {",
      "2470:                    clearedCount.set(policies.properties.size());",
      "2471:                    policies.properties.clear();",
      "2472:                    return policies;",
      "2473:                }))",
      "2474:                .thenAccept(v -> {",
      "2475:                    asyncResponse.resume(Response.noContent().build());",
      "2476:                    log.info(\"[{}] Successfully clear {} properties on namespace {}\", clientAppId(), clearedCount.get(),",
      "2477:                            namespaceName);",
      "2478:                }).exceptionally(ex -> {",
      "2479:                    Throwable cause = ex.getCause();",
      "2480:                    log.error(\"[{}] Failed to clear {} properties on namespace {}\", clientAppId(), clearedCount.get(),",
      "2481:                            namespaceName, cause);",
      "2482:                    asyncResponse.resume(cause);",
      "2483:                    return null;",
      "2484:                });",
      "",
      "---------------"
    ],
    "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java||pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java": [
      "File: pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java -> pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "572:     protected void internalCreateMissedPartitions(AsyncResponse asyncResponse) {",
      "573:         getPartitionedTopicMetadataAsync(topicName, false, false).thenAccept(metadata -> {",
      "574:             if (metadata != null) {",
      "576:                     asyncResponse.resume(Response.noContent().build());",
      "577:                 }).exceptionally(e -> {",
      "578:                     log.error(\"[{}] Failed to create partitions for topic {}\", clientAppId(), topicName);",
      "",
      "[Removed Lines]",
      "575:                 tryCreatePartitionsAsync(metadata.partitions).thenAccept(v -> {",
      "",
      "[Added Lines]",
      "575:                 CompletableFuture<Void> future = validateNamespaceOperationAsync(topicName.getNamespaceObject(),",
      "576:                         NamespaceOperation.CREATE_TOPIC);",
      "577:                 future.thenCompose(__ -> tryCreatePartitionsAsync(metadata.partitions)).thenAccept(v -> {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "912:     protected void internalUnloadTopic(AsyncResponse asyncResponse, boolean authoritative) {",
      "913:         log.info(\"[{}] Unloading topic {}\", clientAppId(), topicName);",
      "922:            if (topicName.isPartitioned()) {",
      "923:                if (isTransactionCoordinatorAssign(topicName)) {",
      "",
      "[Removed Lines]",
      "914:         CompletableFuture<Void> future;",
      "915:         if (topicName.isGlobal()) {",
      "916:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "917:         } else {",
      "918:             future = CompletableFuture.completedFuture(null);",
      "919:         }",
      "920:        future.thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "916:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.UNLOAD);",
      "917:         future.thenCompose(__ -> {",
      "918:             if (topicName.isGlobal()) {",
      "919:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "920:             }",
      "921:             return CompletableFuture.completedFuture(null);",
      "922:         }).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1135:     private void internalUnloadNonPartitionedTopicAsync(AsyncResponse asyncResponse, boolean authoritative) {",
      "1136:         validateTopicOwnershipAsync(topicName, authoritative)",
      "1139:                         .thenCompose(topic -> topic.close(false))",
      "1140:                         .thenRun(() -> {",
      "1141:                             log.info(\"[{}] Successfully unloaded topic {}\", clientAppId(), topicName);",
      "1142:                             asyncResponse.resume(Response.noContent().build());",
      "1144:                 .exceptionally(ex -> {",
      "1146:                     if (!isNot307And404Exception(ex)) {",
      "",
      "[Removed Lines]",
      "1137:                 .thenCompose(unused -> validateTopicOperationAsync(topicName, TopicOperation.UNLOAD)",
      "1138:                         .thenCompose(__ -> getTopicReferenceAsync(topicName))",
      "1143:                         }))",
      "",
      "[Added Lines]",
      "1139:                 .thenCompose(__ -> getTopicReferenceAsync(topicName))",
      "1144:                         })",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1154:     private void internalUnloadTransactionCoordinatorAsync(AsyncResponse asyncResponse, boolean authoritative) {",
      "1155:         validateTopicOwnershipAsync(topicName, authoritative)",
      "1158:                                 .getTransactionMetadataStoreService()",
      "1159:                                 .removeTransactionMetadataStore(",
      "1160:                                         TransactionCoordinatorID.get(topicName.getPartitionIndex())))",
      "",
      "[Removed Lines]",
      "1156:                 .thenCompose(__ -> validateTopicOperationAsync(topicName, TopicOperation.UNLOAD)",
      "1157:                         .thenCompose(v -> pulsar()",
      "",
      "[Added Lines]",
      "1157:                 .thenCompose(v -> pulsar()",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1162:                             log.info(\"[{}] Successfully unloaded tc {}\", clientAppId(),",
      "1163:                                     topicName.getPartitionIndex());",
      "1164:                             asyncResponse.resume(Response.noContent().build());",
      "1166:                 .exceptionally(ex -> {",
      "1168:                     if (!isNot307And404Exception(ex)) {",
      "",
      "[Removed Lines]",
      "1165:                         }))",
      "",
      "[Added Lines]",
      "1165:                         })",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1373:     }",
      "1375:     protected void internalGetManagedLedgerInfo(AsyncResponse asyncResponse, boolean authoritative) {",
      "1384:             if (topicName.isPartitioned()) {",
      "1385:                 internalGetManagedLedgerInfoForNonPartitionedTopic(asyncResponse);",
      "",
      "[Removed Lines]",
      "1376:         CompletableFuture<Void> future;",
      "1377:         if (topicName.isGlobal()) {",
      "1378:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1379:         } else {",
      "1380:             future = CompletableFuture.completedFuture(null);",
      "1381:         }",
      "1382:         future.thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "1376:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.GET_STATS);",
      "1377:         future.thenCompose(__ -> {",
      "1378:             if (topicName.isGlobal()) {",
      "1379:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1380:             }",
      "1381:             return CompletableFuture.completedFuture(null);",
      "1382:         }).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1484:     protected void internalGetPartitionedStats(AsyncResponse asyncResponse, boolean authoritative, boolean perPartition,",
      "1485:                                                boolean getPreciseBacklog, boolean subscriptionBacklogSize,",
      "1486:                                                boolean getEarliestTimeInBacklog) {",
      "1494:                 authoritative, false)).thenAccept(partitionMetadata -> {",
      "1495:             if (partitionMetadata.partitions == 0) {",
      "1496:                 asyncResponse.resume(new RestException(Status.NOT_FOUND,",
      "",
      "[Removed Lines]",
      "1487:         CompletableFuture<Void> future;",
      "1488:         if (topicName.isGlobal()) {",
      "1489:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1490:         } else {",
      "1491:             future = CompletableFuture.completedFuture(null);",
      "1492:         }",
      "1493:         future.thenCompose(__ -> getPartitionedTopicMetadataAsync(topicName,",
      "",
      "[Added Lines]",
      "1487:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.GET_STATS);",
      "1488:         future.thenCompose(__ -> {",
      "1489:             if (topicName.isGlobal()) {",
      "1490:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1491:             }",
      "1492:             return  CompletableFuture.completedFuture(null);",
      "1493:         }).thenCompose(__ -> getPartitionedTopicMetadataAsync(topicName,",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1570:     }",
      "1572:     protected void internalGetPartitionedStatsInternal(AsyncResponse asyncResponse, boolean authoritative) {",
      "1581:             if (partitionMetadata.partitions == 0) {",
      "1582:                 asyncResponse.resume(new RestException(Status.NOT_FOUND,",
      "1583:                         getPartitionedTopicNotFoundErrorMessage(topicName.toString())));",
      "",
      "[Removed Lines]",
      "1573:         CompletableFuture<Void> future;",
      "1574:         if (topicName.isGlobal()) {",
      "1575:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1576:         } else {",
      "1577:             future = CompletableFuture.completedFuture(null);",
      "1578:         }",
      "1579:         future.thenCompose(__ -> getPartitionedTopicMetadataAsync(topicName, authoritative, false))",
      "1580:                 .thenAccept(partitionMetadata -> {",
      "",
      "[Added Lines]",
      "1573:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.GET_STATS);",
      "1574:         future.thenCompose(__ -> {",
      "1575:             if (topicName.isGlobal()) {",
      "1576:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "1577:             } else {",
      "1578:                 return CompletableFuture.completedFuture(null);",
      "1579:             }",
      "1580:         }).thenCompose(__ -> getPartitionedTopicMetadataAsync(topicName, authoritative, false))",
      "1581:         .thenAccept(partitionMetadata -> {",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "2331:     protected void internalCreateSubscription(AsyncResponse asyncResponse, String subscriptionName,",
      "2332:             MessageIdImpl messageId, boolean authoritative, boolean replicated, Map<String, String> properties) {",
      "2340:             final MessageIdImpl targetMessageId = messageId == null ? (MessageIdImpl) MessageId.latest : messageId;",
      "2341:             log.info(\"[{}][{}] Creating subscription {} at message id {} with properties {}\", clientAppId(),",
      "2342:                     topicName, subscriptionName, targetMessageId, properties);",
      "",
      "[Removed Lines]",
      "2333:         CompletableFuture<Void> ret;",
      "2334:         if (topicName.isGlobal()) {",
      "2335:             ret = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2336:         } else {",
      "2337:             ret = CompletableFuture.completedFuture(null);",
      "2338:         }",
      "2339:         ret.thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "2334:         CompletableFuture<Void> ret = validateTopicOperationAsync(topicName, TopicOperation.SUBSCRIBE,",
      "2335:                 subscriptionName);",
      "2336:         ret.thenCompose(__ -> {",
      "2337:             if (topicName.isGlobal()) {",
      "2338:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2339:             }",
      "2340:             return CompletableFuture.completedFuture(null);",
      "2341:         }).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "2495:     protected void internalUpdateSubscriptionProperties(AsyncResponse asyncResponse, String subName,",
      "2496:                                                         Map<String, String> subscriptionProperties,",
      "2497:                                                         boolean authoritative) {",
      "2506:             if (topicName.isPartitioned()) {",
      "2507:                 internalUpdateSubscriptionPropertiesForNonPartitionedTopic(asyncResponse, subName,",
      "2508:                         subscriptionProperties, authoritative);",
      "",
      "[Removed Lines]",
      "2498:         CompletableFuture<Void> future;",
      "2499:         if (topicName.isGlobal()) {",
      "2500:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2501:         } else {",
      "2502:             future = CompletableFuture.completedFuture(null);",
      "2503:         }",
      "2505:         future.thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative)).thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "2500:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.SUBSCRIBE, subName);",
      "2501:         future.thenCompose(__ -> {",
      "2502:             if (topicName.isGlobal()) {",
      "2503:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2504:             }",
      "2505:             return CompletableFuture.completedFuture(null);",
      "2506:         }).thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative)).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "2574:     protected void internalAnalyzeSubscriptionBacklog(AsyncResponse asyncResponse, String subName,",
      "2575:                                                       Optional<Position> position,",
      "2576:                                                       boolean authoritative) {",
      "2585:                 .thenCompose(__ -> {",
      "2586:                     if (topicName.isPartitioned()) {",
      "2587:                         return CompletableFuture.completedFuture(null);",
      "",
      "[Removed Lines]",
      "2577:         CompletableFuture<Void> future;",
      "2578:         if (topicName.isGlobal()) {",
      "2579:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2580:         } else {",
      "2581:             future = CompletableFuture.completedFuture(null);",
      "2582:         }",
      "2584:         future.thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative))",
      "",
      "[Added Lines]",
      "2578:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.CONSUME, subName);",
      "2579:         future.thenCompose(__ -> {",
      "2580:             if (topicName.isGlobal()) {",
      "2581:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2582:             }",
      "2583:             return CompletableFuture.completedFuture(null);",
      "2584:         }).thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative))",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "2614:     protected void internalGetSubscriptionProperties(AsyncResponse asyncResponse, String subName,",
      "2615:                                                         boolean authoritative) {",
      "2624:             if (topicName.isPartitioned()) {",
      "2625:                 internalGetSubscriptionPropertiesForNonPartitionedTopic(asyncResponse, subName,",
      "2626:                         authoritative);",
      "",
      "[Removed Lines]",
      "2616:         CompletableFuture<Void> future;",
      "2617:         if (topicName.isGlobal()) {",
      "2618:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2619:         } else {",
      "2620:             future = CompletableFuture.completedFuture(null);",
      "2621:         }",
      "2623:         future.thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative)).thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "2616:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.CONSUME, subName);",
      "2617:         future.thenCompose(__ -> {",
      "2618:             if (topicName.isGlobal()) {",
      "2619:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "2620:             }",
      "2621:             return CompletableFuture.completedFuture(null);",
      "2622:         }).thenCompose(__ -> validateTopicOwnershipAsync(topicName, authoritative)).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "4249:     protected void internalTriggerCompaction(AsyncResponse asyncResponse, boolean authoritative) {",
      "4250:         log.info(\"[{}] Trigger compaction on topic {}\", clientAppId(), topicName);",
      "4259:             if (topicName.isPartitioned()) {",
      "4260:                 internalTriggerCompactionNonPartitionedTopic(asyncResponse, authoritative);",
      "",
      "[Removed Lines]",
      "4251:         CompletableFuture<Void> future;",
      "4252:         if (topicName.isGlobal()) {",
      "4253:             future = validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "4254:         } else {",
      "4255:             future = CompletableFuture.completedFuture(null);",
      "4256:         }",
      "4257:         future.thenAccept(__ -> {",
      "",
      "[Added Lines]",
      "4250:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.COMPACT);",
      "4251:         future.thenCompose(__ -> {",
      "4252:             if (topicName.isGlobal()) {",
      "4253:                 return validateGlobalNamespaceOwnershipAsync(namespaceName);",
      "4254:             } else {",
      "4255:                 return CompletableFuture.completedFuture(null);",
      "4256:             }",
      "4257:         }).thenAccept(__ -> {",
      "",
      "---------------",
      "--- Hunk 14 ---",
      "[Context before]",
      "4734:                     \"Trim on a non-persistent topic is not allowed\"));",
      "4735:             return null;",
      "4736:         }",
      "4737:         if (topicName.isPartitioned()) {",
      "4739:                     -> trimNonPartitionedTopic(asyncResponse, topicName, authoritative));",
      "4740:         }",
      "4742:                 .thenCompose(__ -> pulsar().getBrokerService().fetchPartitionedTopicMetadataAsync(topicName))",
      "4743:                 .thenCompose(metadata -> {",
      "4744:                     if (metadata.partitions > 0) {",
      "",
      "[Removed Lines]",
      "4738:             return validateTopicOperationAsync(topicName, TopicOperation.TRIM_TOPIC).thenCompose((x)",
      "4741:         return validateTopicOperationAsync(topicName, TopicOperation.TRIM_TOPIC)",
      "",
      "[Added Lines]",
      "4737:         CompletableFuture<Void> future = validateTopicOperationAsync(topicName, TopicOperation.TRIM_TOPIC);",
      "4739:             return future.thenCompose((x)",
      "4742:         return future",
      "",
      "---------------",
      "--- Hunk 15 ---",
      "[Context before]",
      "5420:     }",
      "5422:     protected CompletableFuture<SchemaCompatibilityStrategy> internalGetSchemaCompatibilityStrategy(boolean applied) {",
      "5423:         if (applied) {",
      "5425:         }",
      "5429:                 .thenCompose(n -> getTopicPoliciesAsyncWithRetry(topicName).thenApply(op -> {",
      "5430:                     if (!op.isPresent()) {",
      "5431:                         return null;",
      "",
      "[Removed Lines]",
      "5424:             return getSchemaCompatibilityStrategyAsync();",
      "5426:         return validateTopicPolicyOperationAsync(topicName,",
      "5427:                 PolicyName.SCHEMA_COMPATIBILITY_STRATEGY,",
      "5428:                 PolicyOperation.READ)",
      "",
      "[Added Lines]",
      "5424:         CompletableFuture<Void> future = validateTopicPolicyOperationAsync(topicName,",
      "5425:                 PolicyName.SCHEMA_COMPATIBILITY_STRATEGY, PolicyOperation.READ);",
      "5427:             return future.thenCompose(__ -> getSchemaCompatibilityStrategyAsync());",
      "5429:         return future",
      "",
      "---------------"
    ],
    "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java": [
      "File: pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/NamespaceAuthZTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.apache.pulsar.broker.admin;",
      "22: import io.jsonwebtoken.Jwts;",
      "23: import lombok.Cleanup;",
      "24: import lombok.SneakyThrows;",
      "25: import org.apache.pulsar.client.admin.PulsarAdmin;",
      "26: import org.apache.pulsar.client.admin.PulsarAdminException;",
      "27: import org.apache.pulsar.client.impl.auth.AuthenticationToken;",
      "28: import org.apache.pulsar.common.policies.data.AuthAction;",
      "29: import org.apache.pulsar.common.policies.data.TenantInfo;",
      "30: import org.apache.pulsar.security.MockedPulsarStandalone;",
      "31: import org.testng.Assert;",
      "32: import org.testng.annotations.AfterClass;",
      "33: import org.testng.annotations.BeforeClass;",
      "34: import org.testng.annotations.Test;",
      "36: import java.util.HashMap;",
      "37: import java.util.Map;",
      "38: import java.util.Set;",
      "39: import java.util.UUID;",
      "41: @Test(groups = \"broker-admin\")",
      "42: public class NamespaceAuthZTest extends MockedPulsarStandalone {",
      "44:     private PulsarAdmin superUserAdmin;",
      "46:     private PulsarAdmin tenantManagerAdmin;",
      "48:     private static final String TENANT_ADMIN_SUBJECT =  UUID.randomUUID().toString();",
      "49:     private static final String TENANT_ADMIN_TOKEN = Jwts.builder()",
      "50:             .claim(\"sub\", TENANT_ADMIN_SUBJECT).signWith(SECRET_KEY).compact();",
      "52:     @SneakyThrows",
      "53:     @BeforeClass",
      "54:     public void before() {",
      "55:         configureTokenAuthentication();",
      "56:         configureDefaultAuthorization();",
      "57:         start();",
      "58:         this.superUserAdmin =PulsarAdmin.builder()",
      "59:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "60:                 .authentication(new AuthenticationToken(SUPER_USER_TOKEN))",
      "61:                 .build();",
      "62:         final TenantInfo tenantInfo = superUserAdmin.tenants().getTenantInfo(\"public\");",
      "63:         tenantInfo.getAdminRoles().add(TENANT_ADMIN_SUBJECT);",
      "64:         superUserAdmin.tenants().updateTenant(\"public\", tenantInfo);",
      "65:         this.tenantManagerAdmin = PulsarAdmin.builder()",
      "66:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "67:                 .authentication(new AuthenticationToken(TENANT_ADMIN_TOKEN))",
      "68:                 .build();",
      "69:     }",
      "72:     @SneakyThrows",
      "73:     @AfterClass",
      "74:     public void after() {",
      "75:         if (superUserAdmin != null) {",
      "76:             superUserAdmin.close();",
      "77:         }",
      "78:         if (tenantManagerAdmin != null) {",
      "79:             tenantManagerAdmin.close();",
      "80:         }",
      "81:         close();",
      "82:     }",
      "85:     @SneakyThrows",
      "86:     @Test",
      "87:     public void testProperties() {",
      "88:         final String random = UUID.randomUUID().toString();",
      "89:         final String namespace = \"public/default\";",
      "90:         final String topic = \"persistent://public/default/\" + random;",
      "91:         final String subject =  UUID.randomUUID().toString();",
      "92:         final String token = Jwts.builder()",
      "93:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "94:         superUserAdmin.topics().createNonPartitionedTopic(topic);",
      "96:         @Cleanup",
      "97:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "98:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "99:                 .authentication(new AuthenticationToken(token))",
      "100:                 .build();",
      "102:         Map<String, String> properties = new HashMap<>();",
      "103:         properties.put(\"key1\", \"value1\");",
      "104:         superUserAdmin.namespaces().setProperties(namespace, properties);",
      "105:         superUserAdmin.namespaces().setProperty(namespace, \"key2\", \"value2\");",
      "106:         superUserAdmin.namespaces().getProperties(namespace);",
      "107:         superUserAdmin.namespaces().getProperty(namespace, \"key2\");",
      "108:         superUserAdmin.namespaces().removeProperty(namespace, \"key2\");",
      "109:         superUserAdmin.namespaces().clearProperties(namespace);",
      "112:         tenantManagerAdmin.namespaces().setProperties(namespace, properties);",
      "113:         tenantManagerAdmin.namespaces().setProperty(namespace, \"key2\", \"value2\");",
      "114:         tenantManagerAdmin.namespaces().getProperties(namespace);",
      "115:         tenantManagerAdmin.namespaces().getProperty(namespace, \"key2\");",
      "116:         tenantManagerAdmin.namespaces().removeProperty(namespace, \"key2\");",
      "117:         tenantManagerAdmin.namespaces().clearProperties(namespace);",
      "120:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "121:                 () -> subAdmin.namespaces().setProperties(namespace, properties));",
      "123:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "124:                 () -> subAdmin.namespaces().setProperty(namespace, \"key2\", \"value2\"));",
      "126:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "127:                 () -> subAdmin.namespaces().getProperties(namespace));",
      "129:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "130:                 () -> subAdmin.namespaces().getProperty(namespace, \"key2\"));",
      "133:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "134:                 () -> subAdmin.namespaces().removeProperty(namespace, \"key2\"));",
      "136:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "137:                 () -> subAdmin.namespaces().clearProperties(namespace));",
      "139:         for (AuthAction action : AuthAction.values()) {",
      "140:             superUserAdmin.namespaces().grantPermissionOnNamespace(namespace, subject, Set.of(action));",
      "141:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "142:                     () -> subAdmin.namespaces().setProperties(namespace, properties));",
      "144:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "145:                     () -> subAdmin.namespaces().setProperty(namespace, \"key2\", \"value2\"));",
      "147:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "148:                     () -> subAdmin.namespaces().getProperties(namespace));",
      "150:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "151:                     () -> subAdmin.namespaces().getProperty(namespace, \"key2\"));",
      "154:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "155:                     () -> subAdmin.namespaces().removeProperty(namespace, \"key2\"));",
      "157:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "158:                     () -> subAdmin.namespaces().clearProperties(namespace));",
      "160:             superUserAdmin.namespaces().revokePermissionsOnNamespace(namespace, subject);",
      "161:         }",
      "162:         superUserAdmin.topics().delete(topic, true);",
      "163:     }",
      "164: }",
      "",
      "---------------"
    ],
    "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java": [
      "File: pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.apache.pulsar.broker.admin;",
      "22: import io.jsonwebtoken.Jwts;",
      "23: import lombok.Cleanup;",
      "24: import lombok.SneakyThrows;",
      "25: import org.apache.pulsar.client.admin.PulsarAdmin;",
      "26: import org.apache.pulsar.client.admin.PulsarAdminException;",
      "27: import org.apache.pulsar.client.api.MessageId;",
      "28: import org.apache.pulsar.client.impl.auth.AuthenticationToken;",
      "29: import org.apache.pulsar.common.naming.TopicName;",
      "30: import org.apache.pulsar.common.policies.data.AuthAction;",
      "31: import org.apache.pulsar.common.policies.data.TenantInfo;",
      "32: import org.apache.pulsar.security.MockedPulsarStandalone;",
      "33: import org.testng.Assert;",
      "34: import org.testng.annotations.AfterClass;",
      "35: import org.testng.annotations.BeforeClass;",
      "36: import org.testng.annotations.Test;",
      "38: import java.util.HashMap;",
      "39: import java.util.Map;",
      "40: import java.util.Optional;",
      "41: import java.util.Set;",
      "42: import java.util.UUID;",
      "43: import java.util.concurrent.atomic.AtomicInteger;",
      "45: @Test(groups = \"broker-admin\")",
      "46: public class TopicAuthZTest extends MockedPulsarStandalone {",
      "48:     private PulsarAdmin superUserAdmin;",
      "50:     private PulsarAdmin tenantManagerAdmin;",
      "52:     private static final String TENANT_ADMIN_SUBJECT =  UUID.randomUUID().toString();",
      "53:     private static final String TENANT_ADMIN_TOKEN = Jwts.builder()",
      "54:             .claim(\"sub\", TENANT_ADMIN_SUBJECT).signWith(SECRET_KEY).compact();",
      "56:     @SneakyThrows",
      "57:     @BeforeClass",
      "58:     public void before() {",
      "59:         configureTokenAuthentication();",
      "60:         configureDefaultAuthorization();",
      "61:         start();",
      "62:         this.superUserAdmin =PulsarAdmin.builder()",
      "63:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "64:                 .authentication(new AuthenticationToken(SUPER_USER_TOKEN))",
      "65:                 .build();",
      "66:         final TenantInfo tenantInfo = superUserAdmin.tenants().getTenantInfo(\"public\");",
      "67:         tenantInfo.getAdminRoles().add(TENANT_ADMIN_SUBJECT);",
      "68:         superUserAdmin.tenants().updateTenant(\"public\", tenantInfo);",
      "69:         this.tenantManagerAdmin = PulsarAdmin.builder()",
      "70:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "71:                 .authentication(new AuthenticationToken(TENANT_ADMIN_TOKEN))",
      "72:                 .build();",
      "73:     }",
      "76:     @SneakyThrows",
      "77:     @AfterClass",
      "78:     public void after() {",
      "79:         if (superUserAdmin != null) {",
      "80:             superUserAdmin.close();",
      "81:         }",
      "82:         if (tenantManagerAdmin != null) {",
      "83:             tenantManagerAdmin.close();",
      "84:         }",
      "85:         close();",
      "86:     }",
      "89:     @SneakyThrows",
      "90:     @Test",
      "91:     public void testUnloadAndCompactAndTrim() {",
      "92:         final String random = UUID.randomUUID().toString();",
      "93:         final String topic = \"persistent://public/default/\" + random;",
      "94:         final String subject =  UUID.randomUUID().toString();",
      "95:         final String token = Jwts.builder()",
      "96:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "97:         superUserAdmin.topics().createPartitionedTopic(topic, 2);",
      "99:         @Cleanup",
      "100:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "101:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "102:                 .authentication(new AuthenticationToken(token))",
      "103:                 .build();",
      "105:         superUserAdmin.topics().unload(topic);",
      "106:         superUserAdmin.topics().triggerCompaction(topic);",
      "107:         superUserAdmin.topics().trimTopic(TopicName.get(topic).getPartition(0).getLocalName());",
      "108:         superUserAdmin.topicPolicies().getSchemaCompatibilityStrategy(topic, false);",
      "111:         tenantManagerAdmin.topics().unload(topic);",
      "112:         tenantManagerAdmin.topics().triggerCompaction(topic);",
      "113:         tenantManagerAdmin.topics().trimTopic(TopicName.get(topic).getPartition(0).getLocalName());",
      "114:         tenantManagerAdmin.topicPolicies().getSchemaCompatibilityStrategy(topic, false);",
      "117:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "118:                 () -> subAdmin.topics().unload(topic));",
      "120:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "121:                 () -> subAdmin.topics().triggerCompaction(topic));",
      "123:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "124:                 () -> subAdmin.topics().trimTopic(TopicName.get(topic).getPartition(0).getLocalName()));",
      "126:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "127:                 () -> subAdmin.topicPolicies().getSchemaCompatibilityStrategy(topic, false));",
      "130:         for (AuthAction action : AuthAction.values()) {",
      "131:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "133:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "134:                     () -> subAdmin.topics().unload(topic));",
      "136:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "137:                     () -> subAdmin.topics().triggerCompaction(topic));",
      "139:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "140:                     () -> subAdmin.topics().trimTopic(topic));",
      "142:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "143:                     () -> subAdmin.topicPolicies().getSchemaCompatibilityStrategy(topic, false));",
      "145:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "146:         }",
      "147:         superUserAdmin.topics().deletePartitionedTopic(topic, true);",
      "148:     }",
      "150:     @Test",
      "151:     @SneakyThrows",
      "152:     public void testGetManagedLedgerInfo() {",
      "153:         final String random = UUID.randomUUID().toString();",
      "154:         final String topic = \"persistent://public/default/\" + random;",
      "155:         final String subject =  UUID.randomUUID().toString();",
      "156:         final String token = Jwts.builder()",
      "157:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "158:         superUserAdmin.topics().createPartitionedTopic(topic, 2);",
      "160:         @Cleanup",
      "161:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "162:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "163:                 .authentication(new AuthenticationToken(token))",
      "164:                 .build();",
      "166:         superUserAdmin.topics().getInternalInfo(topic);",
      "169:         tenantManagerAdmin.topics().getInternalInfo(topic);",
      "172:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "173:                 () -> subAdmin.topics().getInternalInfo(topic));",
      "175:         for (AuthAction action : AuthAction.values()) {",
      "176:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "177:             if (action == AuthAction.produce || action == AuthAction.consume) {",
      "178:                 subAdmin.topics().getInternalInfo(topic);",
      "179:             } else {",
      "180:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "181:                         () -> subAdmin.topics().getInternalInfo(topic));",
      "182:             }",
      "183:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "184:         }",
      "185:         superUserAdmin.topics().deletePartitionedTopic(topic, true);",
      "186:     }",
      "188:     @Test",
      "189:     @SneakyThrows",
      "190:     public void testGetPartitionedStatsAndInternalStats() {",
      "191:         final String random = UUID.randomUUID().toString();",
      "192:         final String topic = \"persistent://public/default/\" + random;",
      "193:         final String subject =  UUID.randomUUID().toString();",
      "194:         final String token = Jwts.builder()",
      "195:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "196:         superUserAdmin.topics().createPartitionedTopic(topic, 2);",
      "198:         @Cleanup",
      "199:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "200:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "201:                 .authentication(new AuthenticationToken(token))",
      "202:                 .build();",
      "204:         superUserAdmin.topics().getPartitionedStats(topic, false);",
      "205:         superUserAdmin.topics().getPartitionedInternalStats(topic);",
      "208:         tenantManagerAdmin.topics().getPartitionedStats(topic, false);",
      "209:         tenantManagerAdmin.topics().getPartitionedInternalStats(topic);",
      "212:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "213:                 () -> subAdmin.topics().getPartitionedStats(topic, false));",
      "215:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "216:                 () -> subAdmin.topics().getPartitionedInternalStats(topic));",
      "218:         for (AuthAction action : AuthAction.values()) {",
      "219:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "220:             if (action == AuthAction.produce || action == AuthAction.consume) {",
      "221:                 subAdmin.topics().getPartitionedStats(topic, false);",
      "222:                 subAdmin.topics().getPartitionedInternalStats(topic);",
      "223:             } else {",
      "224:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "225:                         () -> subAdmin.topics().getPartitionedStats(topic, false));",
      "227:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "228:                         () -> subAdmin.topics().getPartitionedInternalStats(topic));",
      "229:             }",
      "230:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "231:         }",
      "232:         superUserAdmin.topics().deletePartitionedTopic(topic, true);",
      "233:     }",
      "235:     @Test",
      "236:     @SneakyThrows",
      "237:     public void testCreateSubscriptionAndUpdateSubscriptionPropertiesAndAnalyzeSubscriptionBacklog() {",
      "238:         final String random = UUID.randomUUID().toString();",
      "239:         final String topic = \"persistent://public/default/\" + random;",
      "240:         final String subject =  UUID.randomUUID().toString();",
      "241:         final String token = Jwts.builder()",
      "242:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "243:         superUserAdmin.topics().createPartitionedTopic(topic, 2);",
      "244:         AtomicInteger suffix = new AtomicInteger(1);",
      "245:         @Cleanup",
      "246:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "247:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "248:                 .authentication(new AuthenticationToken(token))",
      "249:                 .build();",
      "251:         superUserAdmin.topics().createSubscription(topic, \"test-sub\" + suffix.incrementAndGet(), MessageId.earliest);",
      "254:         tenantManagerAdmin.topics().createSubscription(topic, \"test-sub\" + suffix.incrementAndGet(), MessageId.earliest);",
      "257:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "258:                 () -> subAdmin.topics().createSubscription(topic, \"test-sub\" + suffix.incrementAndGet(), MessageId.earliest));",
      "260:         for (AuthAction action : AuthAction.values()) {",
      "261:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "262:             if (action == AuthAction.consume) {",
      "263:                 subAdmin.topics().createSubscription(topic, \"test-sub\" + suffix.incrementAndGet(), MessageId.earliest);",
      "264:             } else {",
      "265:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "266:                         () -> subAdmin.topics().createSubscription(topic, \"test-sub\" + suffix.incrementAndGet(), MessageId.earliest));",
      "267:             }",
      "268:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "269:         }",
      "271:         Map<String, String> properties = new HashMap<>();",
      "272:         superUserAdmin.topics().createSubscription(topic, \"test-sub\", MessageId.earliest);",
      "274:         superUserAdmin.topics().updateSubscriptionProperties(topic, \"test-sub\" , properties);",
      "275:         superUserAdmin.topics().getSubscriptionProperties(topic, \"test-sub\");",
      "276:         superUserAdmin.topics().analyzeSubscriptionBacklog(TopicName.get(topic).getPartition(0).getLocalName(), \"test-sub\", Optional.empty());",
      "279:         tenantManagerAdmin.topics().updateSubscriptionProperties(topic, \"test-sub\" , properties);",
      "280:         tenantManagerAdmin.topics().getSubscriptionProperties(topic, \"test-sub\");",
      "281:         tenantManagerAdmin.topics().analyzeSubscriptionBacklog(TopicName.get(topic).getPartition(0).getLocalName(), \"test-sub\", Optional.empty());",
      "284:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "285:                 () -> subAdmin.topics().updateSubscriptionProperties(topic, \"test-sub\", properties));",
      "287:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "288:                 () -> subAdmin.topics().getSubscriptionProperties(topic, \"test-sub\"));",
      "290:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "291:                 () -> subAdmin.topics().analyzeSubscriptionBacklog(TopicName.get(topic).getPartition(0).getLocalName(), \"test-sub\", Optional.empty()));",
      "293:         for (AuthAction action : AuthAction.values()) {",
      "294:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "295:             if (action == AuthAction.consume) {",
      "296:                 subAdmin.topics().updateSubscriptionProperties(topic, \"test-sub\", properties);",
      "297:                 subAdmin.topics().getSubscriptionProperties(topic, \"test-sub\");",
      "298:                 subAdmin.topics().analyzeSubscriptionBacklog(TopicName.get(topic).getPartition(0).getLocalName(), \"test-sub\", Optional.empty());",
      "299:             } else {",
      "300:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "301:                         () -> subAdmin.topics().updateSubscriptionProperties(topic, \"test-sub\", properties));",
      "303:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "304:                         () -> subAdmin.topics().getSubscriptionProperties(topic, \"test-sub\"));",
      "306:                 Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "307:                         () -> subAdmin.topics().analyzeSubscriptionBacklog(TopicName.get(topic).getPartition(0).getLocalName(), \"test-sub\", Optional.empty()));",
      "308:             }",
      "309:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "310:         }",
      "311:         superUserAdmin.topics().deletePartitionedTopic(topic, true);",
      "312:     }",
      "314:     @Test",
      "315:     @SneakyThrows",
      "316:     public void testCreateMissingPartition() {",
      "317:         final String random = UUID.randomUUID().toString();",
      "318:         final String topic = \"persistent://public/default/\" + random;",
      "319:         final String subject =  UUID.randomUUID().toString();",
      "320:         final String token = Jwts.builder()",
      "321:                 .claim(\"sub\", subject).signWith(SECRET_KEY).compact();",
      "322:         superUserAdmin.topics().createPartitionedTopic(topic, 2);",
      "323:         AtomicInteger suffix = new AtomicInteger(1);",
      "324:         @Cleanup",
      "325:         final PulsarAdmin subAdmin = PulsarAdmin.builder()",
      "326:                 .serviceHttpUrl(getPulsarService().getWebServiceAddress())",
      "327:                 .authentication(new AuthenticationToken(token))",
      "328:                 .build();",
      "330:         superUserAdmin.topics().createMissedPartitions(topic);",
      "333:         tenantManagerAdmin.topics().createMissedPartitions(topic);",
      "335:         Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "336:                 () -> subAdmin.topics().createMissedPartitions(topic));",
      "338:         for (AuthAction action : AuthAction.values()) {",
      "339:             superUserAdmin.topics().grantPermission(topic, subject, Set.of(action));",
      "340:             Assert.assertThrows(PulsarAdminException.NotAuthorizedException.class,",
      "341:                     () -> subAdmin.topics().createMissedPartitions(topic));",
      "342:             superUserAdmin.topics().revokePermissions(topic, subject);",
      "343:         }",
      "344:         superUserAdmin.topics().deletePartitionedTopic(topic, true);",
      "345:     }",
      "346: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "52ac5c9de2f9f2b4579af25823b26c7e3f3c851d",
      "candidate_info": {
        "commit_hash": "52ac5c9de2f9f2b4579af25823b26c7e3f3c851d",
        "repo": "apache/pulsar",
        "commit_url": "https://github.com/apache/pulsar/commit/52ac5c9de2f9f2b4579af25823b26c7e3f3c851d",
        "files": [
          "build/run_unit_group.sh",
          "buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java",
          "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java",
          "pom.xml",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java"
        ],
        "message": "[improve][test] Move most flaky tests to flaky group (#22433)\n\n- also add solution for running test methods added to flaky group since that was missing\n\n(cherry picked from commit 5f31ec383bb7526eca24b95002f6cd498057fee7)\n\n# Conflicts:\n#\tpulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java\n#\tpulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java",
        "before_after_code_files": [
          "build/run_unit_group.sh||build/run_unit_group.sh",
          "buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java||buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java",
          "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java||managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java",
          "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java"
          ],
          "candidate": [
            "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java"
          ]
        }
      },
      "candidate_diff": {
        "build/run_unit_group.sh||build/run_unit_group.sh": [
          "File: build/run_unit_group.sh -> build/run_unit_group.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "135: function test_group_broker_flaky() {",
          "136:   echo \"::endgroup::\"",
          "137:   echo \"::group::Running quarantined tests\"",
          "139:     -DtestForkCount=2 ||",
          "140:     print_testng_failures pulsar-broker/target/surefire-reports/testng-failed.xml \"Quarantined test failure in\" \"Quarantined test failures\"",
          "141:   echo \"::endgroup::\"",
          "142:   echo \"::group::Running flaky tests\"",
          "144:   echo \"::endgroup::\"",
          "145: }",
          "147: function test_group_proxy() {",
          "",
          "[Removed Lines]",
          "138:   mvn_test --no-fail-fast -pl pulsar-broker -Dgroups='quarantine' -DexcludedGroups='' -DfailIfNoTests=false \\",
          "143:   mvn_test --no-fail-fast -pl pulsar-broker -Dgroups='flaky' -DtestForkCount=2",
          "",
          "[Added Lines]",
          "138:   mvn_test --no-fail-fast -pl pulsar-broker -Dgroups='quarantine' -DexcludedGroups='flaky' -DfailIfNoTests=false \\",
          "143:   mvn_test --no-fail-fast -pl pulsar-broker -Dgroups='flaky' -DexcludedGroups='quarantine' -DtestForkCount=2",
          "145:   local modules_with_flaky_tests=$(git grep -l '@Test.*\"flaky\"' | grep '/src/test/java/' | \\",
          "146:     awk -F '/src/test/java/' '{ print $1 }' | grep -v -E 'pulsar-broker' | sort | uniq | \\",
          "147:     perl -0777 -p -e 's/\\n(\\S)/,$1/g')",
          "148:   if [ -n \"${modules_with_flaky_tests}\" ]; then",
          "149:     echo \"::group::Running flaky tests in modules '${modules_with_flaky_tests}'\"",
          "150:     mvn_test --no-fail-fast -pl \"${modules_with_flaky_tests}\" -Dgroups='flaky' -DexcludedGroups='quarantine' -DfailIfNoTests=false",
          "151:     echo \"::endgroup::\"",
          "152:   fi",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "175:     perl -0777 -p -e 's/\\n(\\S)/,$1/g')",
          "176:   if [ -n \"${modules_with_quarantined_tests}\" ]; then",
          "177:     echo \"::group::Running quarantined tests outside of pulsar-broker & pulsar-proxy (if any)\"",
          "179:       -DfailIfNoTests=false || \\",
          "180:         echo \"::warning::There were test failures in the 'quarantine' test group.\"",
          "181:     echo \"::endgroup::\"",
          "",
          "[Removed Lines]",
          "178:     mvn_test --no-fail-fast -pl \"${modules_with_quarantined_tests}\" test -Dgroups='quarantine' -DexcludedGroups='' \\",
          "",
          "[Added Lines]",
          "186:     mvn_test --no-fail-fast -pl \"${modules_with_quarantined_tests}\" test -Dgroups='quarantine' -DexcludedGroups='flaky' \\",
          "",
          "---------------"
        ],
        "buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java||buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java": [
          "File: buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java -> buildtools/src/main/java/org/apache/pulsar/tests/AnnotationListener.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:     private static final long DEFAULT_TEST_TIMEOUT_MILLIS = TimeUnit.MINUTES.toMillis(5);",
          "33:     private static final String OTHER_GROUP = \"other\";",
          "35:     public AnnotationListener() {",
          "36:         System.out.println(\"Created annotation listener\");",
          "37:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "35:     private static final String FLAKY_GROUP = \"flaky\";",
          "37:     private static final String QUARANTINE_GROUP = \"quarantine\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:             annotation.setTimeOut(DEFAULT_TEST_TIMEOUT_MILLIS);",
          "52:         }",
          "54:         addToOtherGroupIfNoGroupsSpecified(annotation);",
          "55:     }",
          "57:     private void addToOtherGroupIfNoGroupsSpecified(ITestOrConfiguration annotation) {",
          "59:         if (annotation.getGroups() == null || annotation.getGroups().length == 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:         replaceGroupsIfFlakyOrQuarantineGroupIsIncluded(annotation);",
          "64:     private void replaceGroupsIfFlakyOrQuarantineGroupIsIncluded(ITestAnnotation annotation) {",
          "65:         if (annotation.getGroups() != null && annotation.getGroups().length > 1) {",
          "66:             for (String group : annotation.getGroups()) {",
          "67:                 if (group.equals(QUARANTINE_GROUP)) {",
          "68:                     annotation.setGroups(new String[]{QUARANTINE_GROUP});",
          "69:                     return;",
          "70:                 }",
          "71:                 if (group.equals(FLAKY_GROUP)) {",
          "72:                     annotation.setGroups(new String[]{FLAKY_GROUP});",
          "73:                     return;",
          "74:                 }",
          "75:             }",
          "76:         }",
          "77:     }",
          "",
          "---------------"
        ],
        "managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java||managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java": [
          "File: managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java -> managed-ledger/src/test/java/org/apache/bookkeeper/mledger/impl/ManagedLedgerTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "2440:         });",
          "2441:     }",
          "2444:     public void testTimestampOnWorkingLedger() throws Exception {",
          "2445:         ManagedLedgerConfig conf = new ManagedLedgerConfig();",
          "2446:         conf.setMaxEntriesPerLedger(1);",
          "",
          "[Removed Lines]",
          "2443:     @Test",
          "",
          "[Added Lines]",
          "2443:     @Test(groups = \"flaky\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3505:                 .until(() -> firstLedgerId != ml.addEntry(\"test\".getBytes()).getLedgerId());",
          "3506:     }",
          "3509:     public void testLedgerNotRolloverWithoutOpenState() throws Exception {",
          "3510:         ManagedLedgerConfig config = new ManagedLedgerConfig();",
          "3511:         config.setMaxEntriesPerLedger(2);",
          "",
          "[Removed Lines]",
          "3508:     @Test",
          "",
          "[Added Lines]",
          "3508:     @Test(groups = \"flaky\")",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/AdminApiMultiBrokersTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "132:         Assert.assertEquals(lookupResultSet.size(), 1);",
          "133:     }",
          "136:     public void testForceDeletePartitionedTopicWithSub() throws Exception {",
          "137:         final int numPartitions = 10;",
          "138:         TenantInfoImpl tenantInfo = new TenantInfoImpl(Set.of(\"role1\", \"role2\"), Set.of(\"test\"));",
          "",
          "[Removed Lines]",
          "135:     @Test",
          "",
          "[Added Lines]",
          "135:     @Test(groups = \"flaky\")",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicAuthZTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:             .claim(\"sub\", TENANT_ADMIN_SUBJECT).signWith(SECRET_KEY).compact();",
          "56:     @SneakyThrows",
          "58:     public void before() {",
          "59:         configureTokenAuthentication();",
          "60:         configureDefaultAuthorization();",
          "",
          "[Removed Lines]",
          "57:     @BeforeClass",
          "",
          "[Added Lines]",
          "57:     @BeforeClass(alwaysRun = true)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "76:     @SneakyThrows",
          "78:     public void after() {",
          "79:         if (superUserAdmin != null) {",
          "80:             superUserAdmin.close();",
          "",
          "[Removed Lines]",
          "77:     @AfterClass",
          "",
          "[Added Lines]",
          "77:     @AfterClass(alwaysRun = true)",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java||pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/broker/service/PersistentMessageFinderTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "382:     void testMessageExpiryWithTimestampNonRecoverableException() throws Exception {",
          "384:         final String ledgerAndCursorName = \"testPersistentMessageExpiryWithNonRecoverableLedgers\";",
          "",
          "[Removed Lines]",
          "381:     @Test",
          "",
          "[Added Lines]",
          "381:     @Test(groups = \"flaky\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "432:     }",
          "435:     public void testIncorrectClientClock() throws Exception {",
          "436:         final String ledgerAndCursorName = \"testIncorrectClientClock\";",
          "437:         int maxTTLSeconds = 1;",
          "",
          "[Removed Lines]",
          "434:     @Test",
          "",
          "[Added Lines]",
          "434:     @Test(groups = \"flaky\")",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/client/impl/ProducerConsumerInternalTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:         });",
          "117:     }",
          "120:     public void testExclusiveConsumerWillAlwaysRetryEvenIfReceivedConsumerBusyError() throws Exception {",
          "121:         final String topicName = BrokerTestUtil.newUniqueName(\"persistent://my-property/my-ns/tp_\");",
          "122:         final String subscriptionName = \"subscription1\";",
          "",
          "[Removed Lines]",
          "119:     @Test",
          "",
          "[Added Lines]",
          "119:     @Test(groups = \"flaky\")",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:     protected static final String TOPIC_OUTPUT = NAMESPACE1 + \"/output\";",
          "97:     protected static final String TOPIC_MESSAGE_ACK_TEST = NAMESPACE1 + \"/message-ack-test\";",
          "98:     protected static final int NUM_PARTITIONS = 16;",
          "100:     protected void setup() throws Exception {",
          "101:         conf.setAcknowledgmentAtBatchIndexLevelEnabled(true);",
          "102:         setUpBase(1, NUM_PARTITIONS, TOPIC_OUTPUT, TOPIC_PARTITION);",
          "",
          "[Removed Lines]",
          "99:     @BeforeClass",
          "",
          "[Added Lines]",
          "99:     @BeforeClass(alwaysRun = true)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1624:         admin.topics().delete(topic, true);",
          "1625:     }",
          "1628:     public void testDelayedTransactionMessages() throws Exception {",
          "1629:         String topic = NAMESPACE1 + \"/testDelayedTransactionMessages\";",
          "",
          "[Removed Lines]",
          "1627:     @Test",
          "",
          "[Added Lines]",
          "1627:     @Test(groups = \"flaky\")",
          "",
          "---------------"
        ],
        "pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java||pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java": [
          "File: pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java -> pulsar-broker/src/test/java/org/apache/pulsar/client/impl/TransactionEndToEndWithoutBatchIndexAckTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: @Test(groups = \"broker-impl\")",
          "31: public class TransactionEndToEndWithoutBatchIndexAckTest extends TransactionEndToEndTest {",
          "34:     protected void setup() throws Exception {",
          "35:         conf.setAcknowledgmentAtBatchIndexLevelEnabled(false);",
          "36:         setUpBase(1, NUM_PARTITIONS, TOPIC_OUTPUT, TOPIC_PARTITION);",
          "",
          "[Removed Lines]",
          "33:     @BeforeClass",
          "",
          "[Added Lines]",
          "33:     @BeforeClass(alwaysRun = true)",
          "",
          "---------------"
        ]
      }
    }
  ]
}