{
  "cve_id": "CVE-2010-0156",
  "cve_desc": "Puppet 0.24.x before 0.24.9 and 0.25.x before 0.25.2 allows local users to overwrite arbitrary files via a symlink attack on the (1) /tmp/daemonout, (2) /tmp/puppetdoc.txt, (3) /tmp/puppetdoc.tex, or (4) /tmp/puppetdoc.aux temporary file.",
  "repo": "puppetlabs/puppet",
  "patch_hash": "0aae57f91dc69b22fb674f8de3a13c22edd07128",
  "patch_info": {
    "commit_hash": "0aae57f91dc69b22fb674f8de3a13c22edd07128",
    "repo": "puppetlabs/puppet",
    "commit_url": "https://github.com/puppetlabs/puppet/commit/0aae57f91dc69b22fb674f8de3a13c22edd07128",
    "files": [
      "lib/puppet/daemon.rb",
      "lib/puppet/util.rb",
      "lib/puppet/util/reference.rb"
    ],
    "message": "Backport of tmpfile patch from 0.25.2",
    "before_after_code_files": [
      "lib/puppet/daemon.rb||lib/puppet/daemon.rb",
      "lib/puppet/util.rb||lib/puppet/util.rb",
      "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb"
    ]
  },
  "patch_diff": {
    "lib/puppet/daemon.rb||lib/puppet/daemon.rb": [
      "File: lib/puppet/daemon.rb -> lib/puppet/daemon.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "30:             $stderr.reopen $stdout",
      "31:             Puppet::Util::Log.reopen",
      "32:         rescue => detail",
      "34:                 f.puts \"Could not start %s: %s\" % [Puppet[:name], detail]",
      "35:             }",
      "36:             Puppet.err \"Could not start %s: %s\" % [Puppet[:name], detail]",
      "",
      "[Removed Lines]",
      "33:             File.open(\"/tmp/daemonout\", \"w\") { |f|",
      "",
      "[Added Lines]",
      "33:             Puppet::Util.secure_open(\"/tmp/daemonout\", \"w\") { |f|",
      "",
      "---------------"
    ],
    "lib/puppet/util.rb||lib/puppet/util.rb": [
      "File: lib/puppet/util.rb -> lib/puppet/util.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "429:     end",
      "431:     module_function :memory, :thinmark",
      "433: end",
      "435: require 'puppet/util/errors'",
      "",
      "[Removed Lines]",
      "432: end",
      "",
      "[Added Lines]",
      "433:     def secure_open(file,must_be_w,&block)",
      "434:         raise Puppet::DevError,\"secure_open only works with mode 'w'\" unless must_be_w == 'w'",
      "435:         raise Puppet::DevError,\"secure_open only requires a block\"    unless block_given?",
      "436:         Puppet.warning \"#{file} was a symlink to #{File.readlink(file)}\" if File.symlink?(file)",
      "437:         if File.exists?(file) or File.symlink?(file)",
      "438:             wait = File.symlink?(file) ? 5.0 : 0.1",
      "439:             File.delete(file)",
      "440:             sleep wait # give it a chance to reappear, just in case someone is actively trying something.",
      "441:         end",
      "442:         begin",
      "443:             File.open(file,File::CREAT|File::EXCL|File::TRUNC|File::WRONLY,&block)",
      "444:         rescue Errno::EEXIST",
      "445:             desc = File.symlink?(file) ? \"symlink to #{File.readlink(file)}\" : File.stat(file).ftype",
      "446:             puts \"Warning: #{file} was apparently created by another process (as\"",
      "447:             puts \"a #{desc}) as soon as it was deleted by this process.  Someone may be trying\"",
      "448:             puts \"to do something objectionable (such as tricking you into overwriting system\"",
      "449:             puts \"files if you are running as root).\"",
      "450:             raise",
      "451:         end",
      "452:     end",
      "453:     module_function :secure_open",
      "",
      "---------------"
    ],
    "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb": [
      "File: lib/puppet/util/reference.rb -> lib/puppet/util/reference.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "37:     def self.pdf(text)",
      "38:         puts \"creating pdf\"",
      "40:             f.puts text",
      "41:         end",
      "42:         rst2latex = %x{which rst2latex}",
      "",
      "[Removed Lines]",
      "39:         File.open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
      "",
      "[Added Lines]",
      "39:         Puppet::Util.secure_open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "48:         end",
      "49:         rst2latex.chomp!",
      "50:         cmd = %{#{rst2latex} /tmp/puppetdoc.txt > /tmp/puppetdoc.tex}",
      "51:         output = %x{#{cmd}}",
      "52:         unless $? == 0",
      "53:             $stderr.puts \"rst2latex failed\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "51:         Puppet::Util.secure_open('/tmp/puppetdoc.tex','w') {}",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "168:     end",
      "170:     def trac",
      "172:             f.puts self.to_trac",
      "173:         end",
      "",
      "[Removed Lines]",
      "171:         File.open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
      "",
      "[Added Lines]",
      "172:         Puppet::Util.secure_open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0aae57f91dc69b22fb674f8de3a13c22edd07128",
      "candidate_info": {
        "commit_hash": "0aae57f91dc69b22fb674f8de3a13c22edd07128",
        "repo": "puppetlabs/puppet",
        "commit_url": "https://github.com/puppetlabs/puppet/commit/0aae57f91dc69b22fb674f8de3a13c22edd07128",
        "files": [
          "lib/puppet/daemon.rb",
          "lib/puppet/util.rb",
          "lib/puppet/util/reference.rb"
        ],
        "message": "Backport of tmpfile patch from 0.25.2",
        "before_after_code_files": [
          "lib/puppet/daemon.rb||lib/puppet/daemon.rb",
          "lib/puppet/util.rb||lib/puppet/util.rb",
          "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/puppet/daemon.rb||lib/puppet/daemon.rb",
            "lib/puppet/util.rb||lib/puppet/util.rb",
            "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb"
          ],
          "candidate": [
            "lib/puppet/daemon.rb||lib/puppet/daemon.rb",
            "lib/puppet/util.rb||lib/puppet/util.rb",
            "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/puppet/daemon.rb||lib/puppet/daemon.rb": [
          "File: lib/puppet/daemon.rb -> lib/puppet/daemon.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:             $stderr.reopen $stdout",
          "31:             Puppet::Util::Log.reopen",
          "32:         rescue => detail",
          "34:                 f.puts \"Could not start %s: %s\" % [Puppet[:name], detail]",
          "35:             }",
          "36:             Puppet.err \"Could not start %s: %s\" % [Puppet[:name], detail]",
          "",
          "[Removed Lines]",
          "33:             File.open(\"/tmp/daemonout\", \"w\") { |f|",
          "",
          "[Added Lines]",
          "33:             Puppet::Util.secure_open(\"/tmp/daemonout\", \"w\") { |f|",
          "",
          "---------------"
        ],
        "lib/puppet/util.rb||lib/puppet/util.rb": [
          "File: lib/puppet/util.rb -> lib/puppet/util.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "429:     end",
          "431:     module_function :memory, :thinmark",
          "433: end",
          "435: require 'puppet/util/errors'",
          "",
          "[Removed Lines]",
          "432: end",
          "",
          "[Added Lines]",
          "433:     def secure_open(file,must_be_w,&block)",
          "434:         raise Puppet::DevError,\"secure_open only works with mode 'w'\" unless must_be_w == 'w'",
          "435:         raise Puppet::DevError,\"secure_open only requires a block\"    unless block_given?",
          "436:         Puppet.warning \"#{file} was a symlink to #{File.readlink(file)}\" if File.symlink?(file)",
          "437:         if File.exists?(file) or File.symlink?(file)",
          "438:             wait = File.symlink?(file) ? 5.0 : 0.1",
          "439:             File.delete(file)",
          "440:             sleep wait # give it a chance to reappear, just in case someone is actively trying something.",
          "441:         end",
          "442:         begin",
          "443:             File.open(file,File::CREAT|File::EXCL|File::TRUNC|File::WRONLY,&block)",
          "444:         rescue Errno::EEXIST",
          "445:             desc = File.symlink?(file) ? \"symlink to #{File.readlink(file)}\" : File.stat(file).ftype",
          "446:             puts \"Warning: #{file} was apparently created by another process (as\"",
          "447:             puts \"a #{desc}) as soon as it was deleted by this process.  Someone may be trying\"",
          "448:             puts \"to do something objectionable (such as tricking you into overwriting system\"",
          "449:             puts \"files if you are running as root).\"",
          "450:             raise",
          "451:         end",
          "452:     end",
          "453:     module_function :secure_open",
          "",
          "---------------"
        ],
        "lib/puppet/util/reference.rb||lib/puppet/util/reference.rb": [
          "File: lib/puppet/util/reference.rb -> lib/puppet/util/reference.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:     def self.pdf(text)",
          "38:         puts \"creating pdf\"",
          "40:             f.puts text",
          "41:         end",
          "42:         rst2latex = %x{which rst2latex}",
          "",
          "[Removed Lines]",
          "39:         File.open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
          "",
          "[Added Lines]",
          "39:         Puppet::Util.secure_open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "48:         end",
          "49:         rst2latex.chomp!",
          "50:         cmd = %{#{rst2latex} /tmp/puppetdoc.txt > /tmp/puppetdoc.tex}",
          "51:         output = %x{#{cmd}}",
          "52:         unless $? == 0",
          "53:             $stderr.puts \"rst2latex failed\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51:         Puppet::Util.secure_open('/tmp/puppetdoc.tex','w') {}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "168:     end",
          "170:     def trac",
          "172:             f.puts self.to_trac",
          "173:         end",
          "",
          "[Removed Lines]",
          "171:         File.open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
          "",
          "[Added Lines]",
          "172:         Puppet::Util.secure_open(\"/tmp/puppetdoc.txt\", \"w\") do |f|",
          "",
          "---------------"
        ]
      }
    }
  ]
}