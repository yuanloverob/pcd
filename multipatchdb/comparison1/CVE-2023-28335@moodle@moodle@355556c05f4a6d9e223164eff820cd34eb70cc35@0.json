{
  "cve_id": "CVE-2023-28335",
  "cve_desc": "The link to reset all templates of a database activity did not include the necessary token to prevent a CSRF risk.",
  "repo": "moodle/moodle",
  "patch_hash": "355556c05f4a6d9e223164eff820cd34eb70cc35",
  "patch_info": {
    "commit_hash": "355556c05f4a6d9e223164eff820cd34eb70cc35",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/355556c05f4a6d9e223164eff820cd34eb70cc35",
    "files": [
      "mod/data/classes/output/action_bar.php",
      "mod/data/templates.php"
    ],
    "message": "MDL-77008 mod_data: require sesskey to reset module templates.",
    "before_after_code_files": [
      "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php",
      "mod/dattemplates.php||mod/data/templates.php"
    ]
  },
  "patch_diff": {
    "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php": [
      "File: mod/datclasses/output/action_bar.php -> mod/data/classes/output/action_bar.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "201:         $resetallurl->params([",
      "202:             'action' => 'resetalltemplates',",
      "203:             'sesskey' => sesskey(),",
      "204:         ]);",
      "",
      "---------------"
    ],
    "mod/dattemplates.php||mod/data/templates.php": [
      "File: mod/dattemplates.php -> mod/data/templates.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "60: if ($action == 'resetalltemplates') {",
      "61:     require_sesskey();",
      "62:     $manager->reset_all_templates();",
      "63:     redirect($PAGE->url, get_string('templateresetall', 'mod_data'), null, \\core\\output\\notification::NOTIFY_SUCCESS);",
      "64: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e2da14bbb8758da24a692349ef2163bb55ddddda",
      "candidate_info": {
        "commit_hash": "e2da14bbb8758da24a692349ef2163bb55ddddda",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e2da14bbb8758da24a692349ef2163bb55ddddda",
        "files": [
          "mod/data/amd/build/templateseditor.min.js",
          "mod/data/amd/build/templateseditor.min.js.map",
          "mod/data/amd/src/templateseditor.js",
          "mod/data/classes/manager.php",
          "mod/data/classes/output/template_editor.php",
          "mod/data/classes/output/template_editor_tools.php",
          "mod/data/lang/en/data.php",
          "mod/data/lang/en/deprecated.txt",
          "mod/data/lib.php",
          "mod/data/templates.php",
          "mod/data/templates/template_editor.mustache",
          "mod/data/templates/template_editor_tools.mustache",
          "mod/data/tests/behat/edit_templates.feature"
        ],
        "message": "MDL-75146 mod_data: migrate templates editor to mustache",
        "before_after_code_files": [
          "mod/data/amd/src/templateseditor.js||mod/data/amd/src/templateseditor.js",
          "mod/data/classes/manager.php||mod/data/classes/manager.php",
          "mod/data/classes/output/template_editor.php||mod/data/classes/output/template_editor.php",
          "mod/data/classes/output/template_editor_tools.php||mod/data/classes/output/template_editor_tools.php",
          "mod/data/lang/en/data.php||mod/data/lang/en/data.php",
          "mod/data/lib.php||mod/data/lib.php",
          "mod/data/templates.php||mod/data/templates.php",
          "mod/data/templates/template_editor.mustache||mod/data/templates/template_editor.mustache",
          "mod/data/templates/template_editor_tools.mustache||mod/data/templates/template_editor_tools.mustache",
          "mod/data/tests/behat/edit_templates.feature||mod/data/tests/behat/edit_templates.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "mod/data/amd/src/templateseditor.js||mod/data/amd/src/templateseditor.js": [
          "File: mod/data/amd/src/templateseditor.js -> mod/data/amd/src/templateseditor.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: const registerEventListeners = (d, mode) => {",
          "42:     const toggleTemplateEditor = document.querySelector(selectors.toggleTemplateEditor);",
          "44:     toggleTemplateEditor.addEventListener('click', async(event) => {",
          "45:         event.preventDefault();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44:     if (!toggleTemplateEditor) {",
          "45:         return;",
          "46:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/manager.php||mod/data/classes/manager.php": [
          "File: mod/data/classes/manager.php -> mod/data/classes/manager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: namespace mod_data;",
          "20: use cm_info;",
          "21: use completion_info;",
          "22: use mod_data\\event\\course_module_viewed;",
          "23: use mod_data\\event\\template_viewed;",
          "24: use stdClass;",
          "",
          "[Removed Lines]",
          "19: use context_module;",
          "",
          "[Added Lines]",
          "20: use context_module;",
          "22: use data_field_base;",
          "25: use mod_data\\event\\template_updated;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39:     const PLUGIN = 'mod_data';",
          "42:     private $instance;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44:     const TEMPLATES_LIST = [",
          "45:         'listtemplate' => 'listtemplate.html',",
          "46:         'singletemplate' => 'singletemplate.html',",
          "47:         'asearchtemplate' => 'asearchtemplate.html',",
          "48:         'addtemplate' => 'addtemplate.html',",
          "49:         'rsstemplate' => 'rsstemplate.html',",
          "50:         'csstemplate' => 'csstemplate.css',",
          "51:         'jstemplate' => 'jstemplate.js',",
          "52:         'listtemplateheader' => 'listtemplateheader.html',",
          "53:         'listtemplatefooter' => 'listtemplatefooter.html',",
          "54:         'rsstitletemplate' => 'rsstitletemplate.html',",
          "55:     ];",
          "58:     private $path;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "48:     private $cm;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "72:     private $_fieldrecords = null;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "56:     public function __construct(cm_info $cm, stdClass $instance) {",
          "57:         $this->cm = $cm;",
          "58:         $this->instance = $instance;",
          "59:         $this->context = context_module::instance($cm->id);",
          "60:         $this->instance->cmidnumber = $cm->idnumber;",
          "61:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:         global $CFG;",
          "86:         $this->path = $CFG->dirroot . '/mod/' . self::MODULE;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "167:         $event->add_record_snapshot(self::MODULE, $this->instance);",
          "168:         $event->trigger();",
          "169:     }",
          "170: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "202:     public function get_fields(): array {",
          "203:         $result = [];",
          "204:         $fieldrecords = $this->get_field_records();",
          "205:         foreach ($fieldrecords as $fieldrecord) {",
          "206:             $result[$fieldrecord->id] = $this->get_field($fieldrecord);",
          "207:         }",
          "208:         return $result;",
          "209:     }",
          "216:     public function get_field_records() {",
          "217:         global $DB;",
          "218:         if ($this->_fieldrecords === null) {",
          "219:             $this->_fieldrecords = $DB->get_records('data_fields', ['dataid' => $this->instance->id]);",
          "220:         }",
          "221:         return $this->_fieldrecords;",
          "222:     }",
          "230:     public function get_field(stdClass $fieldrecord): data_field_base {",
          "231:         $filepath = \"{$this->path}/field/{$fieldrecord->type}/field.class.php\";",
          "232:         $classname = \"data_field_{$fieldrecord->type}\";",
          "233:         if (!file_exists($filepath) || !class_exists($classname)) {",
          "234:             return new data_field_base($fieldrecord, $this->instance, $this->cm);",
          "235:         }",
          "236:         require_once($filepath);",
          "237:         $newfield = new $classname($fieldrecord, $this->instance, $this->cm);",
          "238:         return $newfield;",
          "239:     }",
          "251:     public function get_template(string $templatename, array $options = []): template {",
          "252:         if ($templatename == 'single') {",
          "253:             $templatename == 'singletemplate';",
          "254:         }",
          "255:         $instance = $this->instance;",
          "256:         $templatestr = $instance->{$templatename} ?? '';",
          "257:         if (empty($templatestr)) {",
          "258:             $templatestr = data_generate_default_template($instance, $templatename, 0, false, false);",
          "259:         }",
          "261:         if ($templatename == 'singletemplate') {",
          "262:             $options['comments'] = true;",
          "263:             $options['ratings'] = true;",
          "264:         }",
          "265:         return new template($this, $templatestr, $options);",
          "266:     }",
          "274:     public function update_templates(stdClass $newtemplates) {",
          "275:         global $DB;",
          "276:         $record = (object)[",
          "277:             'id' => $this->instance->id,",
          "278:         ];",
          "279:         foreach (self::TEMPLATES_LIST as $templatename => $templatefile) {",
          "280:             if (!isset($newtemplates->{$templatename})) {",
          "281:                 continue;",
          "282:             }",
          "283:             $record->{$templatename} = $newtemplates->{$templatename};",
          "284:         }",
          "287:         if (isset($record->addtemplate) && !data_tags_check($this->instance->id, $record->addtemplate)) {",
          "288:                 return false;",
          "289:         }",
          "291:         $DB->update_record(self::MODULE, $record);",
          "292:         $this->instance = $DB->get_record(self::MODULE, ['id' => $this->cm->instance], '*', MUST_EXIST);",
          "295:         $event = template_updated::create(array(",
          "296:             'context' => $this->context,",
          "297:             'courseid' => $this->cm->course,",
          "298:             'other' => array(",
          "299:                 'dataid' => $this->instance->id,",
          "300:             )",
          "301:         ));",
          "302:         $event->trigger();",
          "304:         return true;",
          "305:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/template_editor.php||mod/data/classes/output/template_editor.php": [
          "File: mod/data/classes/output/template_editor.php -> mod/data/classes/output/template_editor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "17: namespace mod_data\\output;",
          "19: use templatable;",
          "20: use renderable;",
          "21: use mod_data\\manager;",
          "22: use moodle_url;",
          "23: use texteditor;",
          "32: class template_editor implements templatable, renderable {",
          "35:     private $manager;",
          "38:     private $templatename;",
          "46:     public function __construct(manager $manager, string $templatename) {",
          "47:         $this->manager = $manager;",
          "48:         $this->templatename = $templatename;",
          "49:     }",
          "57:     public function export_for_template(\\renderer_base $output): array {",
          "58:         $instance = $this->manager->get_instance();",
          "59:         $cm = $this->manager->get_coursemodule();",
          "61:         $data = [",
          "62:             'title' => get_string('header' . $this->templatename, 'data'),",
          "63:             'sesskey' => sesskey(),",
          "64:             'disableeditor' => true,",
          "65:             'url' => new moodle_url('/mod/data/templates.php', ['id' => $cm->id, 'mode' => $this->templatename]),",
          "66:         ];",
          "69:         if (($this->templatename === 'csstemplate') || ($this->templatename === 'jstemplate')) {",
          "70:             $usehtmleditor = false;",
          "71:         } else {",
          "72:             $usehtmleditor = data_get_config($instance, \"editor_{$this->templatename}\", true);",
          "73:         }",
          "74:         $data['usehtmleditor'] = $usehtmleditor;",
          "76:         $tools = new template_editor_tools($this->manager, $this->templatename);",
          "77:         $data['toolbar'] = $tools->export_for_template($output);",
          "78:         $data['editors'] = $this->get_editors_data($usehtmleditor);",
          "81:         if ($this->templatename == 'csstemplate' || $this->templatename == 'jstemplate') {",
          "82:             $data['disableeditor'] = false;",
          "83:         }",
          "84:         return $data;",
          "85:     }",
          "93:     private function get_editors_data(bool $usehtmleditor): array {",
          "94:         global $PAGE;",
          "96:         $result = [];",
          "97:         $instance = $this->manager->get_instance();",
          "100:         editors_head_setup();",
          "101:         $PAGE->requires->js_call_amd(",
          "102:             'mod_data/templateseditor',",
          "103:             'init',",
          "104:             ['d' => $instance->id, 'mode' => $this->templatename]",
          "105:         );",
          "107:         if ($usehtmleditor) {",
          "108:             $format = FORMAT_HTML;",
          "109:         } else {",
          "110:             $format = FORMAT_PLAIN;",
          "111:         }",
          "113:         $editor = editors_get_preferred_editor($format);",
          "116:         if ($this->templatename == 'listtemplate') {",
          "117:             $result[] = $this->generate_editor_data(",
          "118:                 $editor,",
          "119:                 'header',",
          "120:                 'listtemplateheader',",
          "121:                 $instance->listtemplateheader",
          "122:             );",
          "123:             $maineditorname = 'multientry';",
          "124:         } else {",
          "125:             $maineditorname = $this->templatename;",
          "126:         }",
          "128:         $value = $instance->{$this->templatename} ?? '';",
          "129:         $result[] = $this->generate_editor_data(",
          "130:             $editor,",
          "131:             $maineditorname,",
          "132:             $this->templatename,",
          "133:             $value",
          "134:         );",
          "136:         if ($this->templatename == 'listtemplate') {",
          "137:             $result[] = $this->generate_editor_data(",
          "138:                 $editor,",
          "139:                 'footer',",
          "140:                 'listtemplatefooter',",
          "141:                 $instance->listtemplatefooter",
          "142:             );",
          "143:         }",
          "145:         if ($this->templatename == 'rsstemplate') {",
          "146:             $result[] = $this->generate_editor_data(",
          "147:                 $editor,",
          "148:                 'rsstitletemplate',",
          "149:                 'rsstitletemplate',",
          "150:                 $instance->rsstitletemplate",
          "151:             );",
          "152:         }",
          "154:         return $result;",
          "155:     }",
          "166:     private function generate_editor_data(",
          "167:         texteditor $editor,",
          "168:         string $name,",
          "169:         string $fieldname,",
          "170:         ?string $value",
          "171:     ): array {",
          "172:         $options = [",
          "173:             'trusttext' => false,",
          "174:             'forcehttps' => false,",
          "175:             'subdirs' => false,",
          "176:             'maxfiles' => 0,",
          "177:             'maxbytes' => 0,",
          "178:             'changeformat' => 0,",
          "179:             'noclean' => false,",
          "180:         ];",
          "182:         $result = [",
          "183:             'name' => get_string($name, 'data'),",
          "184:             'fieldname' => $fieldname,",
          "185:             'value' => $value,",
          "186:         ];",
          "187:         $editor->set_text($value);",
          "188:         $editor->use_editor($fieldname, $options);",
          "189:         return $result;",
          "190:     }",
          "191: }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/template_editor_tools.php||mod/data/classes/output/template_editor_tools.php": [
          "File: mod/data/classes/output/template_editor_tools.php -> mod/data/classes/output/template_editor_tools.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "17: namespace mod_data\\output;",
          "19: use templatable;",
          "20: use renderable;",
          "21: use core_tag_tag;",
          "22: use mod_data\\manager;",
          "23: use moodle_url;",
          "32: class template_editor_tools implements templatable, renderable {",
          "35:     private $manager;",
          "38:     private $templatename;",
          "46:     public function __construct(manager $manager, string $templatename) {",
          "47:         $this->manager = $manager;",
          "48:         $this->templatename = $templatename;",
          "49:     }",
          "57:     public function export_for_template(\\renderer_base $output): array {",
          "58:         $tools = [",
          "59:             $this->get_field_tags($this->templatename),",
          "60:             $this->get_field_id_tags($this->templatename),",
          "61:             $this->get_action_tags($this->templatename),",
          "62:             $this->get_other_tags($this->templatename),",
          "63:         ];",
          "64:         $tools = array_filter($tools, static function ($value) {",
          "65:             return !empty($value['tags']);",
          "66:         });",
          "67:         return [",
          "68:             'toolshelp' => $output->help_icon('availabletags', 'data'),",
          "69:             'hastools' => !empty($tools),",
          "70:             'tools' => array_values($tools),",
          "71:         ];",
          "72:     }",
          "80:     protected function get_field_tags(string $templatename): array {",
          "81:         $name = get_string('fields', 'data');",
          "82:         if ($templatename == 'csstemplate' || $templatename == 'jstemplate') {",
          "83:             return $this->get_optgroup_data($name, []);",
          "84:         }",
          "85:         $taglist = [];",
          "86:         $fields = $this->manager->get_fields();",
          "87:         foreach ($fields as $field) {",
          "88:             $fieldname = $field->get_name();",
          "89:             $taglist[\"[[$fieldname]]\"] = $fieldname;",
          "90:         }",
          "91:         return $this->get_optgroup_data($name, $taglist);",
          "92:     }",
          "100:     protected function get_field_id_tags(string $templatename): array {",
          "101:         $name = get_string('fieldids', 'data');",
          "102:         if ($templatename != 'addtemplate') {",
          "103:             return $this->get_optgroup_data($name, []);",
          "104:         }",
          "105:         $taglist = [];",
          "107:         $fields = $this->manager->get_fields();",
          "108:         foreach ($fields as $field) {",
          "109:             $fieldname = $field->get_name();",
          "110:             $taglist[\"[[$fieldname#id]]\"] = \"$fieldname id\";",
          "111:         }",
          "112:         return $this->get_optgroup_data($name, $taglist);",
          "113:     }",
          "121:     protected function get_action_tags(string $templatename = null): array {",
          "122:         $name = get_string('actions');",
          "123:         if ($templatename == 'addtemplate' || $templatename == 'asearchtemplate') {",
          "124:             return $this->get_optgroup_data($name, []);",
          "125:         }",
          "126:         $taglist = [",
          "127:             '##edit##' => get_string('edit', 'data'),",
          "128:             '##delete##' => get_string('delete', 'data'),",
          "129:             '##approve##' => get_string('approve', 'data'),",
          "130:             '##disapprove##' => get_string('disapprove', 'data'),",
          "131:         ];",
          "132:         if ($templatename != 'rsstemplate') {",
          "133:             $taglist['##export##'] = get_string('export', 'data');",
          "134:         }",
          "135:         if ($templatename != 'singletemplate') {",
          "136:             $taglist['##more##'] = get_string('more', 'data');",
          "137:             $taglist['##moreurl##'] = get_string('moreurl', 'data');",
          "138:             $taglist['##delcheck##'] = get_string('delcheck', 'data');",
          "139:         }",
          "140:         return $this->get_optgroup_data($name, $taglist);",
          "141:     }",
          "149:     protected function get_other_tags(string $templatename = null): array {",
          "150:         $name = get_string('other', 'data');",
          "151:         $taglist = [];",
          "152:         if ($templatename == 'asearchtemplate') {",
          "153:             $taglist['##firstname##'] = get_string('firstname');",
          "154:             $taglist['##lastname##'] = get_string('lastname');",
          "155:             return $this->get_optgroup_data($name, $taglist);",
          "156:         }",
          "157:         if (core_tag_tag::is_enabled('mod_data', 'data_records')) {",
          "158:             $taglist['##tags##'] = get_string('tags');",
          "159:         }",
          "160:         if ($templatename == 'addtemplate') {",
          "161:             return $this->get_optgroup_data($name, $taglist);",
          "162:         }",
          "163:         $taglist['##timeadded##'] = get_string('timeadded', 'data');",
          "164:         $taglist['##timemodified##'] = get_string('timemodified', 'data');",
          "165:         $taglist['##user##'] = get_string('user');",
          "166:         $taglist['##userpicture##'] = get_string('userpic');",
          "167:         $taglist['##approvalstatus##'] = get_string('approvalstatus', 'data');",
          "168:         $taglist['##id##'] = get_string('id', 'data');",
          "170:         if ($templatename == 'singletemplate') {",
          "171:             return $this->get_optgroup_data($name, $taglist);",
          "172:         }",
          "174:         $taglist['##comments##'] = get_string('comments', 'data');",
          "176:         return $this->get_optgroup_data($name, $taglist);",
          "177:     }",
          "186:     protected function get_optgroup_data (string $name, array $taglist): array {",
          "187:         $tags = [];",
          "188:         foreach ($taglist as $tag => $tagname) {",
          "189:             $tags[] = [",
          "190:                 'tag' => \"$tag\",",
          "191:                 'tagname' => $tagname . ' - ' . $tag,",
          "192:             ];",
          "193:         }",
          "194:         return [",
          "195:             'name' => $name,",
          "196:             'tags' => $tags,",
          "197:         ];",
          "198:     }",
          "199: }",
          "",
          "---------------"
        ],
        "mod/data/lang/en/data.php||mod/data/lang/en/data.php": [
          "File: mod/data/lang/en/data.php -> mod/data/lang/en/data.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52: $string['availabletodate'] = 'Available to';",
          "53: $string['availabletodatevalidation'] = 'The available to date cannot be before the available from date.';",
          "54: $string['blank'] = 'Blank';",
          "56: $string['bynameondate'] = 'by {$a->name} - {$a->date}';",
          "57: $string['calendarend'] = '{$a} closes';",
          "58: $string['calendarstart'] = '{$a} opens';",
          "",
          "[Removed Lines]",
          "55: $string['buttons'] = 'Actions';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "203: $string['headerrsstemplate'] = 'Defines appearance of entries in RSS feeds';",
          "204: $string['headersingletemplate'] = 'Defines browsing interface for a single entry';",
          "205: $string['checkbox'] = 'Checkbox';",
          "206: $string['chooseexportfields'] = 'Choose the fields you wish to export';",
          "207: $string['chooseexportformat'] = 'Choose the format you wish to export to';",
          "208: $string['chooseorupload'] = 'Choose file';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "205: $string['id'] = 'Entry ID';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "434: $string['unsupportedexport'] = '({$a->fieldtype}) cannot be exported.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "437: $string['buttons'] = 'Actions';",
          "",
          "---------------"
        ],
        "mod/data/lib.php||mod/data/lib.php": [
          "File: mod/data/lib.php -> mod/data/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: use mod_data\\manager;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "136:         $this->context = context_module::instance($this->cm->id);",
          "137:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "146:     public function get_name(): string {",
          "147:         return $this->field->name;",
          "148:     }",
          "",
          "---------------"
        ],
        "mod/data/templates.php||mod/data/templates.php": [
          "File: mod/data/templates.php -> mod/data/templates.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: $url = new moodle_url('/mod/data/templates.php');",
          "38: if ($id) {",
          "40:     list($course, $cm) = get_course_and_cm_from_cmid($id, manager::MODULE);",
          "41:     $manager = manager::create_from_coursemodule($cm);",
          "42: } else {   // We must have $d.",
          "43:     $url->param('d', $d);",
          "46: }",
          "49: $cm = $manager->get_coursemodule();",
          "50: $context = $manager->get_context();",
          "51: $course = get_course($cm->course);",
          "",
          "[Removed Lines]",
          "39:     $url->param('id', $id);",
          "44:     $data = $DB->get_record('data', ['id' => $d], '*', MUST_EXIST);",
          "45:     $manager = manager::create_from_instance($data);",
          "48: $data = $manager->get_instance();",
          "",
          "[Added Lines]",
          "41:     $url->param('d', $cm->instance);",
          "43:     $instance = $DB->get_record('data', ['id' => $d], '*', MUST_EXIST);",
          "44:     $manager = manager::create_from_instance($instance);",
          "48: $instance = $manager->get_instance();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "54: $PAGE->set_url($url);",
          "56: require_login($course, false, $cm);",
          "58: require_capability('mod/data:managetemplates', $context);",
          "67: }",
          "69: $manager->set_template_viewed();",
          "80: }",
          "82: $PAGE->requires->js('/mod/data/data.js');",
          "84: $PAGE->set_heading($course->fullname);",
          "85: $PAGE->set_pagelayout('admin');",
          "86: $PAGE->force_settings_menu(true);",
          "87: $PAGE->activityheader->disable();",
          "89: echo $OUTPUT->header();",
          "92: echo $actionbar->get_templates_action_bar();",
          "94: echo $OUTPUT->heading(get_string($mode, 'data'), 2, 'mb-4');",
          "108:         if ($mode == 'listtemplate') {",
          "111:         }",
          "112:     } else {",
          "126:             echo $OUTPUT->notification(get_string('templatesaved', 'data'), 'notifysuccess');",
          "137:         }",
          "138:     }",
          "141: }",
          "363: }",
          "372: echo $OUTPUT->footer();",
          "",
          "[Removed Lines]",
          "60: if ($useeditor !== null) {",
          "62:     data_set_config($data, \"editor_{$mode}\", !!$useeditor);",
          "63: }",
          "65: if (!$DB->count_records('data_fields', array('dataid'=>$data->id))) {      // Brand new database!",
          "66:     redirect($CFG->wwwroot.'/mod/data/field.php?d='.$data->id);  // Redirect to field entry",
          "73: $strdata = get_string('modulenameplural','data');",
          "78: if ($mode == 'singletemplate') {",
          "79:     $PAGE->navbar->add(get_string($mode,'data'));",
          "83: $PAGE->set_title($data->name);",
          "91: $actionbar = new \\mod_data\\output\\action_bar($data->id, $url);",
          "97: $resettemplate = false;",
          "99: if (($mytemplate = data_submitted()) && confirm_sesskey()) {",
          "100:     $newtemplate = new stdClass();",
          "101:     $newtemplate->id = $data->id;",
          "102:     $newtemplate->{$mode} = $mytemplate->template;",
          "104:     if (!empty($mytemplate->defaultform)) {",
          "106:         $resettemplate = true;",
          "107:         $data->{$mode} = data_generate_default_template($data, $mode, 0, false, false);",
          "109:             $data->listtemplateheader = '';",
          "110:             $data->listtemplatefooter = '';",
          "113:         if (isset($mytemplate->listtemplateheader)){",
          "114:             $newtemplate->listtemplateheader = $mytemplate->listtemplateheader;",
          "115:         }",
          "116:         if (isset($mytemplate->listtemplatefooter)){",
          "117:             $newtemplate->listtemplatefooter = $mytemplate->listtemplatefooter;",
          "118:         }",
          "119:         if (isset($mytemplate->rsstitletemplate)){",
          "120:             $newtemplate->rsstitletemplate = $mytemplate->rsstitletemplate;",
          "121:         }",
          "124:         if ($mode != 'addtemplate' or data_tags_check($data->id, $newtemplate->{$mode})) {",
          "125:             $DB->update_record('data', $newtemplate);",
          "129:             $event = \\mod_data\\event\\template_updated::create(array(",
          "130:                 'context' => $context,",
          "131:                 'courseid' => $course->id,",
          "132:                 'other' => array(",
          "133:                     'dataid' => $data->id,",
          "134:                 )",
          "135:             ));",
          "136:             $event->trigger();",
          "139: } else {",
          "140:     echo '<div class=\"template_heading\">'.get_string('header'.$mode,'data').'</div>';",
          "144: if (empty($data->addtemplate) and empty($data->singletemplate) and",
          "145:     empty($data->listtemplate) and empty($data->rsstemplate)) {",
          "146:     data_generate_default_template($data, 'singletemplate');",
          "147:     data_generate_default_template($data, 'listtemplate');",
          "148:     data_generate_default_template($data, 'addtemplate');",
          "149:     data_generate_default_template($data, 'asearchtemplate');           //Template for advanced searches.",
          "150:     data_generate_default_template($data, 'rsstemplate');",
          "151: }",
          "153: editors_head_setup();",
          "156: if (($mode === 'csstemplate') || ($mode === 'jstemplate')) {",
          "158:     $usehtmleditor = false;",
          "159: } else {",
          "160:     $usehtmleditor = data_get_config($data, \"editor_{$mode}\", true);",
          "161: }",
          "163: if ($usehtmleditor) {",
          "164:     $format = FORMAT_HTML;",
          "165: } else {",
          "166:     $format = FORMAT_PLAIN;",
          "167: }",
          "169: $editor = editors_get_preferred_editor($format);",
          "170: $strformats = format_text_menu();",
          "171: $formats =  $editor->get_supported_formats();",
          "172: foreach ($formats as $fid) {",
          "173:     $formats[$fid] = $strformats[$fid];",
          "174: }",
          "175: $options = array();",
          "176: $options['trusttext'] = false;",
          "177: $options['forcehttps'] = false;",
          "178: $options['subdirs'] = false;",
          "179: $options['maxfiles'] = 0;",
          "180: $options['maxbytes'] = 0;",
          "181: $options['changeformat'] = 0;",
          "182: $options['noclean'] = false;",
          "184: echo '<form id=\"tempform\" action=\"templates.php?d='.$data->id.'&amp;mode='.$mode.'\" method=\"post\">';",
          "185: echo '<div>';",
          "186: echo '<input name=\"sesskey\" value=\"'.sesskey().'\" type=\"hidden\" />';",
          "189: if (!$resettemplate) {",
          "191:     $data = $DB->get_record('data', array('id'=>$d));",
          "192: }",
          "193: echo $OUTPUT->box_start('generalbox boxaligncenter boxwidthwide');",
          "194: echo '<table cellpadding=\"4\" cellspacing=\"0\" border=\"0\">';",
          "196: if ($mode == 'listtemplate'){",
          "198:     echo '<tr>';",
          "199:     echo '<td>&nbsp;</td>';",
          "200:     echo '<td>';",
          "201:     echo '<div class=\"template_heading\"><label for=\"edit-listtemplateheader\">'.get_string('header','data').'</label></div>';",
          "203:     $field = 'listtemplateheader';",
          "204:     $editor->set_text($data->listtemplateheader);",
          "205:     $editor->use_editor($field, $options);",
          "206:     echo '<div><textarea id=\"'.$field.'\" name=\"'.$field.'\" class=\"form-control\" rows=\"15\" cols=\"80\">' .",
          "207:         s($data->listtemplateheader) . '</textarea></div>';",
          "209:     echo '</td>';",
          "210:     echo '</tr>';",
          "211: }",
          "215: echo '<tr><td valign=\"top\">';",
          "216: if ($mode != 'csstemplate' and $mode != 'jstemplate') {",
          "218:     echo '<label for=\"availabletags\">'.get_string('availabletags','data').'</label>';",
          "219:     echo $OUTPUT->help_icon('availabletags', 'data');",
          "220:     echo '<br />';",
          "222:     echo '<div class=\"no-overflow\" id=\"availabletags_wrapper\">';",
          "223:     echo '<select name=\"fields1[]\" id=\"availabletags\" size=\"12\" onclick=\"insert_field_tags(this)\" class=\"form-control\">';",
          "225:     $fields = $DB->get_records('data_fields', array('dataid'=>$data->id));",
          "226:     echo '<optgroup label=\"'.get_string('fields', 'data').'\">';",
          "227:     foreach ($fields as $field) {",
          "228:         echo '<option value=\"[['.$field->name.']]\" title=\"'.$field->description.'\">'.$field->name.' - [['.$field->name.']]</option>';",
          "229:     }",
          "230:     echo '</optgroup>';",
          "232:     if ($mode == 'addtemplate') {",
          "233:         echo '<optgroup label=\"'.get_string('fieldids', 'data').'\">';",
          "234:         foreach ($fields as $field) {",
          "235:             if (in_array($field->type, array('picture', 'checkbox', 'date', 'latlong', 'radiobutton'))) {",
          "236:                 continue; //ids are not usable for these composed items",
          "237:             }",
          "238:             echo '<option value=\"[['.$field->name.'#id]]\" title=\"'.$field->description.' id\">'.$field->name.' id - [['.$field->name.'#id]]</option>';",
          "239:         }",
          "240:         echo '</optgroup>';",
          "241:         if (core_tag_tag::is_enabled('mod_data', 'data_records')) {",
          "242:             echo '<optgroup label=\"'.get_string('other', 'data').'\">';",
          "243:             echo '<option value=\"##tags##\">' . get_string('tags') . ' - ##tags##</option>';",
          "244:             echo '</optgroup>';",
          "245:         }",
          "246:     }",
          "249:     if ($mode != 'addtemplate' && $mode != 'asearchtemplate') {             //Don't print special tags when viewing the advanced search template and add template.",
          "250:         echo '<optgroup label=\"'.get_string('buttons', 'data').'\">';",
          "251:         echo '<option value=\"##edit##\">' .get_string('edit', 'data'). ' - ##edit##</option>';",
          "252:         echo '<option value=\"##delete##\">' .get_string('delete', 'data'). ' - ##delete##</option>';",
          "253:         echo '<option value=\"##approve##\">' .get_string('approve', 'data'). ' - ##approve##</option>';",
          "254:         echo '<option value=\"##disapprove##\">' .get_string('disapprove', 'data'). ' - ##disapprove##</option>';",
          "255:         if ($mode != 'rsstemplate') {",
          "256:             echo '<option value=\"##export##\">' .get_string('export', 'data'). ' - ##export##</option>';",
          "257:         }",
          "258:         if ($mode != 'singletemplate') {",
          "260:             echo '<option value=\"##more##\">' .get_string('more', 'data'). ' - ##more##</option>';",
          "261:             echo '<option value=\"##moreurl##\">' .get_string('moreurl', 'data'). ' - ##moreurl##</option>';",
          "262:             echo '<option value=\"##delcheck##\">' .get_string('delcheck', 'data'). ' - ##delcheck##</option>';",
          "263:         }",
          "264:         echo '</optgroup>';",
          "265:         echo '<optgroup label=\"'.get_string('other', 'data').'\">';",
          "266:         echo '<option value=\"##timeadded##\">'.get_string('timeadded', 'data'). ' - ##timeadded##</option>';",
          "267:         echo '<option value=\"##timemodified##\">'.get_string('timemodified', 'data'). ' - ##timemodified##</option>';",
          "268:         echo '<option value=\"##user##\">' .get_string('user'). ' - ##user##</option>';",
          "269:         echo '<option value=\"##userpicture##\">' . get_string('userpic') . ' - ##userpicture##</option>';",
          "270:         echo '<option value=\"##approvalstatus##\">' .get_string('approvalstatus', 'data'). ' - ##approvalstatus##</option>';",
          "272:         if (core_tag_tag::is_enabled('mod_data', 'data_records')) {",
          "273:             echo '<option value=\"##tags##\">' . get_string('tags') . ' - ##tags##</option>';",
          "274:         }",
          "276:         if ($mode != 'singletemplate') {",
          "278:             echo '<option value=\"##comments##\">' .get_string('comments', 'data'). ' - ##comments##</option>';",
          "279:         }",
          "280:         echo '</optgroup>';",
          "281:     }",
          "283:     if ($mode == 'asearchtemplate') {",
          "284:         echo '<optgroup label=\"'.get_string('other', 'data').'\">';",
          "285:         echo '<option value=\"##firstname##\">' .get_string('authorfirstname', 'data'). ' - ##firstname##</option>';",
          "286:         echo '<option value=\"##lastname##\">' .get_string('authorlastname', 'data'). ' - ##lastname##</option>';",
          "287:         echo '</optgroup>';",
          "288:     }",
          "290:     echo '</select>';",
          "291:     echo '</div>';",
          "292: }",
          "293: echo '</td>';",
          "295: echo '<td valign=\"top\">';",
          "296: if ($mode == 'listtemplate'){",
          "297:     echo '<div class=\"template_heading\"><label for=\"edit-template\">'.get_string('multientry','data').'</label></div>';",
          "298: } else {",
          "299:     echo '<div class=\"template_heading\"><label for=\"edit-template\">'.get_string($mode,'data').'</label></div>';",
          "300: }",
          "302: $field = 'template';",
          "303: $editor->set_text($data->{$mode});",
          "304: $editor->use_editor($field, $options);",
          "305: echo '<div>';",
          "306: echo '<textarea class=\"form-control\" id=\"' . $field . '\" ' .",
          "307:      'name=\"' . $field . '\" rows=\"15\" cols=\"80\">' . s($data->{$mode}) . '</textarea>';",
          "308: echo '</div>';",
          "309: echo '</td>';",
          "310: echo '</tr>';",
          "312: if ($mode == 'listtemplate'){",
          "313:     echo '<tr>';",
          "314:     echo '<td>&nbsp;</td>';",
          "315:     echo '<td>';",
          "316:     echo '<div class=\"template_heading\"><label for=\"edit-listtemplatefooter\">'.get_string('footer','data').'</label></div>';",
          "318:     $field = 'listtemplatefooter';",
          "319:     $editor->set_text($data->listtemplatefooter);",
          "320:     $editor->use_editor($field, $options);",
          "321:     echo '<div>';",
          "322:     echo '<textarea id=\"' . $field . '\" class=\"form-control\" ' .",
          "323:          'name=\"' . $field . '\" rows=\"15\" cols=\"80\">' . s($data->listtemplatefooter) . '</textarea>';",
          "324:     echo '</div>';",
          "325:     echo '</td>';",
          "326:     echo '</tr>';",
          "327: } else if ($mode == 'rsstemplate') {",
          "328:     echo '<tr>';",
          "329:     echo '<td>&nbsp;</td>';",
          "330:     echo '<td>';",
          "331:     echo '<div class=\"template_heading\">';",
          "332:     echo '<label for=\"edit-rsstitletemplate\">' . get_string('rsstitletemplate', 'data') . '</label>';",
          "333:     echo '</div>';",
          "335:     $field = 'rsstitletemplate';",
          "336:     $editor->set_text($data->rsstitletemplate);",
          "337:     $editor->use_editor($field, $options);",
          "338:     echo '<div>';",
          "339:     echo '<textarea id=\"' . $field . '\" name=\"' . $field . '\" ' .",
          "340:          'class=\"form-control\" rows=\"15\" cols=\"80\">' . s($data->rsstitletemplate) . '</textarea>';",
          "341:     echo '</div>';",
          "342:     echo '</td>';",
          "343:     echo '</tr>';",
          "344: }",
          "346: echo '</table>';",
          "347: echo html_writer::start_div('container-fluid mt-4');",
          "348: echo html_writer::start_div('row');",
          "350: $resettemplatebutton = html_writer::empty_tag('input', ['type' => 'submit', 'name' => 'defaultform',",
          "351:     'class' => 'btn btn-secondary', 'value' => get_string('resettemplate', 'data')]);",
          "352: $savetemplatebutton = html_writer::empty_tag('input', ['type' => 'submit', 'class' => 'btn btn-primary ml-2',",
          "353:     'value' => get_string('savetemplate', 'data')]);",
          "355: echo html_writer::div($resettemplatebutton . $savetemplatebutton);",
          "357: if ($mode != 'csstemplate' and $mode != 'jstemplate') {",
          "359:     $toggletemplateeditor = html_writer::checkbox('useeditor', 1, $usehtmleditor,",
          "360:         get_string('editorenable', 'data'), null, ['class' => 'pl-2']);",
          "361:     echo html_writer::div($toggletemplateeditor, 'ml-auto');",
          "362:     $PAGE->requires->js_call_amd('mod_data/templateseditor', 'init', ['d' => $d, 'mode' => $mode]);",
          "364: echo html_writer::end_div();",
          "365: echo html_writer::end_div();",
          "367: echo $OUTPUT->box_end();",
          "368: echo '</div>';",
          "369: echo '</form>';",
          "",
          "[Added Lines]",
          "60: if (count($manager->get_field_records()) == 0) {",
          "61:     redirect($CFG->wwwroot.'/mod/data/field.php?d='.$instance->id);",
          "66: if ($useeditor !== null) {",
          "68:     data_set_config($instance, \"editor_{$mode}\", !!$useeditor);",
          "72: $PAGE->set_title($instance->name);",
          "77: $PAGE->add_body_class('limitedwidth');",
          "81: $actionbar = new \\mod_data\\output\\action_bar($instance->id, $url);",
          "86: if (($formdata = data_submitted()) && confirm_sesskey()) {",
          "87:     if (!empty($formdata->defaultform)) {",
          "89:         $instance->{$mode} = data_generate_default_template($instance, $mode, 0, false, false);",
          "91:             $instance->listtemplateheader = '';",
          "92:             $instance->listtemplatefooter = '';",
          "95:         if ($manager->update_templates($formdata)) {",
          "97:             $instance = $manager->get_instance();",
          "104: if (empty($instance->addtemplate) && empty($instance->singletemplate) &&",
          "105:     empty($instance->listtemplate) && empty($instance->rsstemplate)) {",
          "106:     data_generate_default_template($instance, 'singletemplate');",
          "107:     data_generate_default_template($instance, 'listtemplate');",
          "108:     data_generate_default_template($instance, 'addtemplate');",
          "109:     data_generate_default_template($instance, 'asearchtemplate');",
          "110:     data_generate_default_template($instance, 'rsstemplate');",
          "113: $renderer = $PAGE->get_renderer('mod_data');",
          "114: $templateeditor = new \\mod_data\\output\\template_editor($manager, $mode);",
          "115: echo $renderer->render($templateeditor);",
          "",
          "---------------"
        ],
        "mod/data/templates/template_editor.mustache||mod/data/templates/template_editor.mustache": [
          "File: mod/data/templates/template_editor.mustache -> mod/data/templates/template_editor.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "3:     Moodle is free software: you can redistribute it and/or modify",
          "4:     it under the terms of the GNU General Public License as published by",
          "5:     the Free Software Foundation, either version 3 of the License, or",
          "6:     (at your option) any later version.",
          "7:     Moodle is distributed in the hope that it will be useful,",
          "8:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "9:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "10:     GNU General Public License for more details.",
          "11:     You should have received a copy of the GNU General Public License",
          "12:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "13: }}",
          "14: {{!",
          "15:     @template mod_data/template_editor",
          "17:     Template editor in the database activity.",
          "19:     Example context (json):",
          "20:     {",
          "21:         \"title\": \"Defines browsing interface for multiple entries\",",
          "22:         \"sesskey\": \"XXXXX\",",
          "23:         \"disableeditor\": true,",
          "24:         \"url\": {},",
          "25:         \"usehtmleditor\": true,",
          "26:         \"toolbar\": {",
          "27:             \"toolshelp\": \"Available tags help\",",
          "28:             \"hastools\": true,",
          "29:             \"tools\": [",
          "30:                 {",
          "31:                     \"name\": \"Fields\",",
          "32:                     \"tags\": [",
          "33:                     {",
          "34:                         \"tag\": \"[[Checkme]]\",",
          "35:                         \"tagname\": \"Checkme - [[Checkme]]\"",
          "36:                     },",
          "37:                     {",
          "38:                         \"tag\": \"[[Description]]\",",
          "39:                         \"tagname\": \"Description - [[Description]]\"",
          "40:                     },",
          "41:                     {",
          "42:                         \"tag\": \"[[Name]]\",",
          "43:                         \"tagname\": \"Name - [[Name]]\"",
          "44:                     }",
          "45:                     ]",
          "46:                 }",
          "47:             ]",
          "48:         },",
          "49:         \"editors\": [",
          "50:             {",
          "51:             \"name\": \"Header\",",
          "52:             \"fieldname\": \"listtemplateheader\",",
          "53:             \"value\": \"\"",
          "54:             },",
          "55:             {",
          "56:             \"name\": \"Repeated entry\",",
          "57:             \"fieldname\": \"listtemplate\",",
          "58:             \"value\": \"Template content\"",
          "59:             },",
          "60:             {",
          "61:             \"name\": \"Footer\",",
          "62:             \"fieldname\": \"listtemplatefooter\",",
          "63:             \"value\": \"\"",
          "64:             }",
          "65:         ]",
          "66:     }",
          "67: }}",
          "68: <div>{{title}}</div>",
          "69: <form id=\"tempform\" action=\"{{{url}}}\" method=\"post\">",
          "70:     <input name=\"sesskey\" value=\"{{sesskey}}\" type=\"hidden\" />",
          "71:     <div class=\"d-flex flex-row align-items-center\">",
          "72:         {{#toolbar}}",
          "73:             {{> mod_data/template_editor_tools }}",
          "74:         {{/toolbar}}",
          "75:         <div class=\"d-flex flex-column\">",
          "76:             {{#editors}}",
          "77:             <div class=\"m-1\">",
          "78:                 <div class=\"template_heading\">",
          "79:                     <label for=\"{{fieldname}}\">{{name}}</label>",
          "80:                 </div>",
          "81:                 <div>",
          "82:                     <textarea",
          "83:                         id=\"{{fieldname}}\"",
          "84:                         name=\"{{fieldname}}\"",
          "85:                         class=\"form-control\"",
          "86:                         rows=\"15\"",
          "87:                         cols=\"80\"",
          "88:                     >{{value}}</textarea>",
          "89:                 </div>",
          "90:             </div>",
          "91:             {{/editors}}",
          "92:         </div>",
          "93:     </div>",
          "94:     <div class=\"container-fluid mt-4\">",
          "95:         <div class=\"row\">",
          "96:             <div>",
          "97:                 <input",
          "98:                     class=\"btn btn-secondary\"",
          "99:                     type=\"submit\"",
          "100:                     name=\"defaultform\"",
          "101:                     value=\"{{#str}} resettemplate, data {{/str}}\"",
          "102:                 />",
          "103:                 <input",
          "104:                     class=\"btn btn-primary\"",
          "105:                     type=\"submit\"",
          "106:                     value=\"{{#str}} savetemplate, data {{/str}}\"",
          "107:                 />",
          "108:             </div>",
          "109:             {{#disableeditor}}",
          "110:             <div class=\"ml-auto\">",
          "111:                 <input",
          "112:                     type=\"checkbox\"",
          "113:                     name=\"useeditor\"",
          "114:                     id=\"useeditor\"",
          "115:                     value=\"1\"",
          "116:                     {{#usehtmleditor}}checked{{/usehtmleditor}}",
          "117:                 />",
          "118:                 <label for=\"useeditor\">{{#str}} editorenable, data {{/str}}</label>",
          "119:             </div>",
          "120:             {{/disableeditor}}",
          "121:         </div>",
          "122:     </div>",
          "123: </form>",
          "",
          "---------------"
        ],
        "mod/data/templates/template_editor_tools.mustache||mod/data/templates/template_editor_tools.mustache": [
          "File: mod/data/templates/template_editor_tools.mustache -> mod/data/templates/template_editor_tools.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "3:     Moodle is free software: you can redistribute it and/or modify",
          "4:     it under the terms of the GNU General Public License as published by",
          "5:     the Free Software Foundation, either version 3 of the License, or",
          "6:     (at your option) any later version.",
          "7:     Moodle is distributed in the hope that it will be useful,",
          "8:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "9:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "10:     GNU General Public License for more details.",
          "11:     You should have received a copy of the GNU General Public License",
          "12:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "13: }}",
          "14: {{!",
          "15:     @template mod_data/template_editor_tools",
          "17:     Tag tool box for the template editor in the mod_data.",
          "19:     Example context (json):",
          "20:     {",
          "21:         \"toolshelp\": \"Available tags\",",
          "22:         \"hastools\": true,",
          "23:         \"tools\": [",
          "24:             {",
          "25:                 \"name\": \"Fields\",",
          "26:                 \"tags\": [",
          "27:                     {",
          "28:                     \"tag\": \"[[Checkme]]\",",
          "29:                     \"tagname\": \"Checkme - [[Checkme]]\"",
          "30:                     },",
          "31:                     {",
          "32:                     \"tag\": \"[[Description]]\",",
          "33:                     \"tagname\": \"Description - [[Description]]\"",
          "34:                     },",
          "35:                     {",
          "36:                     \"tag\": \"[[Name]]\",",
          "37:                     \"tagname\": \"Name - [[Name]]\"",
          "38:                     }",
          "39:                 ]",
          "40:             },",
          "41:             {",
          "42:                 \"name\": \"Actions\",",
          "43:                 \"tags\": [",
          "44:                     {",
          "45:                     \"tag\": \"##edit##\",",
          "46:                     \"tagname\": \"Edit - ##edit##\"",
          "47:                     },",
          "48:                     {",
          "49:                     \"tag\": \"##delete##\",",
          "50:                     \"tagname\": \"Delete - ##delete##\"",
          "51:                     },",
          "52:                     {",
          "53:                     \"tag\": \"##approve##\",",
          "54:                     \"tagname\": \"Approve - ##approve##\"",
          "55:                     },",
          "56:                     {",
          "57:                     \"tag\": \"##disapprove##\",",
          "58:                     \"tagname\": \"Undo approval - ##disapprove##\"",
          "59:                     },",
          "60:                     {",
          "61:                     \"tag\": \"##export##\",",
          "62:                     \"tagname\": \"Export - ##export##\"",
          "63:                     },",
          "64:                     {",
          "65:                     \"tag\": \"##more##\",",
          "66:                     \"tagname\": \"More - ##more##\"",
          "67:                     },",
          "68:                     {",
          "69:                     \"tag\": \"##moreurl##\",",
          "70:                     \"tagname\": \"More URL - ##moreurl##\"",
          "71:                     },",
          "72:                     {",
          "73:                     \"tag\": \"##delcheck##\",",
          "74:                     \"tagname\": \"Bulk delete checkbox - ##delcheck##\"",
          "75:                     }",
          "76:                 ]",
          "77:             },",
          "78:             {",
          "79:                 \"name\": \"Other\",",
          "80:                 \"tags\": [",
          "81:                     {",
          "82:                     \"tag\": \"##tags##\",",
          "83:                     \"tagname\": \"Tags - ##tags##\"",
          "84:                     },",
          "85:                     {",
          "86:                     \"tag\": \"##timeadded##\",",
          "87:                     \"tagname\": \"Time added - ##timeadded##\"",
          "88:                     },",
          "89:                     {",
          "90:                     \"tag\": \"##timemodified##\",",
          "91:                     \"tagname\": \"Time modified - ##timemodified##\"",
          "92:                     },",
          "93:                     {",
          "94:                     \"tag\": \"##user##\",",
          "95:                     \"tagname\": \"User - ##user##\"",
          "96:                     },",
          "97:                     {",
          "98:                     \"tag\": \"##userpicture##\",",
          "99:                     \"tagname\": \"User picture - ##userpicture##\"",
          "100:                     },",
          "101:                     {",
          "102:                     \"tag\": \"##approvalstatus##\",",
          "103:                     \"tagname\": \"Approval status - ##approvalstatus##\"",
          "104:                     },",
          "105:                     {",
          "106:                     \"tag\": \"##id##\",",
          "107:                     \"tagname\": \"Entry ID - ##id##\"",
          "108:                     },",
          "109:                     {",
          "110:                     \"tag\": \"##comments##\",",
          "111:                     \"tagname\": \"Comments - ##comments##\"",
          "112:                     }",
          "113:                 ]",
          "114:             }",
          "115:         ]",
          "116:     }",
          "117: }}",
          "118: {{#hastools}}",
          "119: <div class=\"p-2\">",
          "120:     <label for=\"availabletags\">{{#str}} availabletags, data {{/str}}</label>",
          "121:     {{{toolshelp}}}",
          "122:     <div class=\"no-overflow\" id=\"availabletags_wrapper\">",
          "123:         <select name=\"fields1[]\" id=\"availabletags\" size=\"20\" onclick=\"insert_field_tags(this)\" class=\"form-control\">",
          "124:             {{#tools}}",
          "125:                 <optgroup label=\"{{name}}\">",
          "126:                     {{#tags}}",
          "127:                     <option value=\"{{tag}}\">{{tagname}}</option>",
          "128:                     {{/tags}}",
          "129:                 </optgroup>",
          "130:             {{/tools}}",
          "131:         </select>",
          "132:     </div>",
          "133: </div>",
          "134: {{/hastools}}",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/edit_templates.feature||mod/data/tests/behat/edit_templates.feature": [
          "File: mod/data/tests/behat/edit_templates.feature -> mod/data/tests/behat/edit_templates.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @mod @mod_data",
          "2: Feature: Users can edit the database templates",
          "3:   In order to use custom templates for entries",
          "4:   As a teacher",
          "5:   I need to edit the templates html",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email                |",
          "10:       | teacher1 | Teacher   | 1        | teacher1@example.com |",
          "11:     And the following \"courses\" exist:",
          "12:       | fullname | shortname | category |",
          "13:       | Course 1 | C1        | 0        |",
          "14:     And the following \"course enrolments\" exist:",
          "15:       | user     | course | role           |",
          "16:       | teacher1 | C1     | editingteacher |",
          "17:     And the following \"activities\" exist:",
          "18:       | activity | name               | intro          | course | idnumber |",
          "19:       | data     | Test database name | Database intro | C1     | data1    |",
          "20:     And the following \"mod_data > fields\" exist:",
          "21:       | database | type | name   | description              |",
          "22:       | data1    | text | field1 | Test field description   |",
          "23:       | data1    | text | field2 | Test field 2 description |",
          "24:     And the following \"mod_data > templates\" exist:",
          "25:       | database | name            |",
          "26:       | data1    | singletemplate  |",
          "27:       | data1    | listtemplate    |",
          "28:       | data1    | addtemplate     |",
          "29:       | data1    | asearchtemplate |",
          "30:       | data1    | rsstemplate     |",
          "31:     And the following \"mod_data > entries\" exist:",
          "32:       | database | field1          | field2         |",
          "33:       | data1    | Student entry 1 | Some content 1 |",
          "34:     And I am on the \"Test database name\" \"data activity\" page logged in as teacher1",
          "35:     And I navigate to \"Templates\" in current page administration",
          "37:   @javascript",
          "38:   Scenario: Edit list template",
          "39:     Given I set the following fields to these values:",
          "40:       | Header         | New header!                |",
          "41:       | Repeated entry | [[field1]] and [[field2]]! |",
          "42:       | Footer         | New footer!                |",
          "43:     And I click on \"Save template\" \"button\"",
          "44:     When I navigate to \"Database\" in current page administration",
          "45:     Then I should see \"New header!\"",
          "46:     And I should see \"Student entry 1 and Some content 1!\"",
          "47:     And I should see \"New footer!\"",
          "49:   @javascript",
          "50:   Scenario: Edit single template",
          "51:     Given I set the field \"Templates tertiary navigation\" to \"Single template\"",
          "52:     And I set the following fields to these values:",
          "53:       | Single template | [[field1]] and [[field2]] details! |",
          "54:     And I click on \"Save template\" \"button\"",
          "55:     When I navigate to \"Database\" in current page administration",
          "56:     And I set the field \"View mode tertiary navigation\" to \"Single view\"",
          "57:     Then I should see \"Student entry 1 and Some content 1 details!\"",
          "59:   @javascript",
          "60:   Scenario: Edit add entry template",
          "61:     Given I set the field \"Templates tertiary navigation\" to \"Add entry template\"",
          "62:     And I set the following fields to these values:",
          "63:       | Add entry template | [[field1]] [[field2]] Form extra! |",
          "64:     And I click on \"Save template\" \"button\"",
          "65:     When I navigate to \"Database\" in current page administration",
          "66:     And I click on \"Add entry\" \"button\"",
          "67:     Then I should see \"Form extra!\"",
          "69:   @javascript",
          "70:   Scenario: Edit advanced search template",
          "71:     Given I set the field \"Templates tertiary navigation\" to \"Advanced search template\"",
          "72:     And I set the following fields to these values:",
          "73:       | Advanced search template | New advanced search template! |",
          "74:     And I click on \"Save template\" \"button\"",
          "75:     When I navigate to \"Database\" in current page administration",
          "76:     And I click on \"Advanced search\" \"checkbox\"",
          "77:     Then I should see \"New advanced search template!\"",
          "79:   @javascript",
          "80:   Scenario: Edit without the wysiwyg editor",
          "81:     Given I click on \"Enable editor\" \"checkbox\"",
          "82:     And I set the following fields to these values:",
          "83:       | Repeated entry | <span class=\"d-none\">Nope</span>Yep! |",
          "84:     And I click on \"Save template\" \"button\"",
          "85:     When I navigate to \"Database\" in current page administration",
          "86:     Then I should not see \"Nope\"",
          "87:     And I should see \"Yep!\"",
          "89:   @javascript",
          "90:   Scenario: Edit CSS teamplate",
          "91:     Given I click on \"Enable editor\" \"checkbox\"",
          "92:     And I set the following fields to these values:",
          "93:       | Repeated entry | <span class=\"hideme\">Nope</span>Yep! |",
          "94:     And I click on \"Save template\" \"button\"",
          "95:     And I set the field \"Templates tertiary navigation\" to \"CSS template\"",
          "96:     And I set the following fields to these values:",
          "97:       | CSS template | .hideme {display: none;} |",
          "98:     And I click on \"Save template\" \"button\"",
          "99:     When I navigate to \"Database\" in current page administration",
          "100:     Then I should not see \"Nope\"",
          "101:     And I should see \"Yep!\"",
          "103:   @javascript",
          "104:   Scenario: Edit Javascript template",
          "105:     Given I click on \"Enable editor\" \"checkbox\"",
          "106:     And I set the following fields to these values:",
          "107:       | Repeated entry | <span id=\"hideme\">Nope</span>Yep! |",
          "108:     And I click on \"Save template\" \"button\"",
          "109:     And I set the field \"Templates tertiary navigation\" to \"Javascript template\"",
          "110:     And I set the following fields to these values:",
          "111:       | Javascript template | window.onload = () => document.querySelector('#hideme').style.display = 'none'; |",
          "112:     And I click on \"Save template\" \"button\"",
          "113:     When I navigate to \"Database\" in current page administration",
          "114:     Then I should not see \"Nope\"",
          "115:     And I should see \"Yep!\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ab97d41644bf692fd23826968638874cdb689032",
      "candidate_info": {
        "commit_hash": "ab97d41644bf692fd23826968638874cdb689032",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ab97d41644bf692fd23826968638874cdb689032",
        "files": [
          "lib/outputcomponents.php",
          "lib/upgrade.txt",
          "mod/data/classes/manager.php",
          "mod/data/classes/output/action_bar.php",
          "mod/data/classes/output/fields_action_bar.php",
          "mod/data/classes/output/zero_state_action_bar.php",
          "mod/data/edit.php",
          "mod/data/field.php",
          "mod/data/lang/en/data.php",
          "mod/data/lang/en/deprecated.txt",
          "mod/data/renderer.php",
          "mod/data/styles.css",
          "mod/data/templates.php",
          "mod/data/templates/fields_action_bar.mustache",
          "mod/data/templates/zero_state.mustache",
          "mod/data/tests/behat/behat_mod_data.php",
          "mod/data/tests/behat/data_activity_completion.feature",
          "mod/data/tests/behat/data_activity_completion_pass_grade.feature",
          "mod/data/tests/behat/preview_preset.feature",
          "mod/data/tests/behat/zero_state.feature",
          "mod/data/upgrade.txt",
          "mod/data/view.php",
          "theme/boost/scss/moodle/core.scss",
          "theme/boost/style/moodle.css",
          "theme/classic/style/moodle.css"
        ],
        "message": "MDL-75335 mod_data: Zero state for Fields and Templates",
        "before_after_code_files": [
          "lib/outputcomponents.php||lib/outputcomponents.php",
          "mod/data/classes/manager.php||mod/data/classes/manager.php",
          "mod/data/classes/output/action_bar.php||mod/data/classes/output/action_bar.php",
          "mod/data/classes/output/fields_action_bar.php||mod/data/classes/output/fields_action_bar.php",
          "mod/data/classes/output/zero_state_action_bar.php||mod/data/classes/output/zero_state_action_bar.php",
          "mod/data/edit.php||mod/data/edit.php",
          "mod/data/field.php||mod/data/field.php",
          "mod/data/lang/en/data.php||mod/data/lang/en/data.php",
          "mod/data/renderer.php||mod/data/renderer.php",
          "mod/data/styles.css||mod/data/styles.css",
          "mod/data/templates.php||mod/data/templates.php",
          "mod/data/templates/fields_action_bar.mustache||mod/data/templates/fields_action_bar.mustache",
          "mod/data/templates/zero_state.mustache||mod/data/templates/zero_state.mustache",
          "mod/data/tests/behat/behat_mod_data.php||mod/data/tests/behat/behat_mod_data.php",
          "mod/data/tests/behat/data_activity_completion.feature||mod/data/tests/behat/data_activity_completion.feature",
          "mod/data/tests/behat/data_activity_completion_pass_grade.feature||mod/data/tests/behat/data_activity_completion_pass_grade.feature",
          "mod/data/tests/behat/preview_preset.feature||mod/data/tests/behat/preview_preset.feature",
          "mod/data/tests/behat/zero_state.feature||mod/data/tests/behat/zero_state.feature",
          "mod/data/view.php||mod/data/view.php",
          "theme/boost/scss/moodle/core.scss||theme/boost/scss/moodle/core.scss",
          "theme/boost/style/moodle.css||theme/boost/style/moodle.css",
          "theme/classic/style/moodle.css||theme/classic/style/moodle.css"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/outputcomponents.php||lib/outputcomponents.php": [
          "File: lib/outputcomponents.php -> lib/outputcomponents.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4569:         }",
          "4570:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4577:     public function set_additional_classes(string $class = '') {",
          "4578:         if (!empty($this->attributes['class'])) {",
          "4579:             $this->attributes['class'] .= \" \".$class;",
          "4580:         } else {",
          "4581:             $this->attributes['class'] = $class;",
          "4582:         }",
          "4583:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/manager.php||mod/data/classes/manager.php": [
          "File: mod/data/classes/manager.php -> mod/data/classes/manager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "301:         return new template($this, $templatecontent, $options);",
          "302:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "309:     public function can_manage_templates(?int $userid = null): bool {",
          "310:         global $USER;",
          "311:         if (!$userid) {",
          "312:             $userid = $USER->id;",
          "313:         }",
          "314:         return has_capability('mod/data:managetemplates', $this->context, $userid);",
          "315:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/action_bar.php||mod/data/classes/output/action_bar.php": [
          "File: mod/data/classes/output/action_bar.php -> mod/data/classes/output/action_bar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         global $PAGE, $DB;",
          "61:         $createfieldlink = new moodle_url('/mod/data/field.php', ['d' => $this->id]);",
          "",
          "[Removed Lines]",
          "57:     public function get_fields_action_bar(bool $hasfieldselect = false, bool $hassaveaspreset = false,",
          "58:             bool $hasexportpreset = false): string {",
          "",
          "[Added Lines]",
          "57:     public function get_fields_action_bar(",
          "58:         bool $hasfieldselect = false,",
          "59:         bool $hassaveaspreset = false,",
          "60:         bool $hasexportpreset = false",
          "61:     ): string {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:         $fieldselect = null;",
          "72:         if ($hasfieldselect) {",
          "86:         }",
          "88:         $saveaspresetbutton = null;",
          "",
          "[Removed Lines]",
          "74:             $plugins = \\core_component::get_plugin_list('datafield');",
          "75:             $menufield = [];",
          "77:             foreach ($plugins as $plugin => $fulldir) {",
          "78:                 $menufield[$plugin] = get_string('pluginname', \"datafield_{$plugin}\");",
          "79:             }",
          "80:             asort($menufield);",
          "82:             $fieldselecturl = new moodle_url('/mod/data/field.php', ['d' => $this->id, 'mode' => 'new']);",
          "83:             $fieldselect = new \\single_select($fieldselecturl, 'newtype', $menufield, null, get_string('newfield', 'data'),",
          "84:                 'fieldform');",
          "85:             $fieldselect->set_label(get_string('newfield', 'mod_data'), ['class' => 'sr-only']);",
          "",
          "[Added Lines]",
          "76:             $fieldselect = $this->get_create_fields();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "105:             }",
          "106:         }",
          "107:         $renderer = $PAGE->get_renderer('mod_data');",
          "111:         return $renderer->render_fields_action_bar($fieldsactionbar);",
          "112:     }",
          "",
          "[Removed Lines]",
          "108:         $fieldsactionbar = new fields_action_bar($this->id, $urlselect, $fieldselect, $saveaspresetbutton,",
          "109:             $exportpresetbutton);",
          "",
          "[Added Lines]",
          "99:         $fieldsactionbar = new fields_action_bar($this->id, $urlselect, null, $saveaspresetbutton,",
          "100:             $exportpresetbutton, $fieldselect);",
          "110:     public function get_create_fields(): \\action_menu {",
          "112:         $plugins = \\core_component::get_plugin_list('datafield');",
          "113:         $menufield = [];",
          "114:         foreach ($plugins as $plugin => $fulldir) {",
          "115:             $menufield[$plugin] = get_string('pluginname', \"datafield_{$plugin}\");",
          "116:         }",
          "117:         asort($menufield);",
          "119:         $fieldselect = new \\action_menu();",
          "120:         $fieldselect->set_menu_trigger(get_string('newfield', 'mod_data'), 'btn btn-secondary');",
          "121:         $fieldselectparams = ['d' => $this->id, 'mode' => 'new'];",
          "122:         foreach ($menufield as $fieldtype => $fieldname) {",
          "123:             $fieldselectparams['newtype'] = $fieldtype;",
          "124:             $fieldselect->add(new \\action_menu_link(",
          "125:                 new \\moodle_url('/mod/data/field.php', $fieldselectparams),",
          "126:                 new \\pix_icon('field/' . $fieldtype, $fieldname, 'data'),",
          "127:                 $fieldname,",
          "128:                 false",
          "129:             ));",
          "130:         }",
          "131:         $fieldselect->set_additional_classes('singlebutton');",
          "133:         return $fieldselect;",
          "134:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/fields_action_bar.php||mod/data/classes/output/fields_action_bar.php": [
          "File: mod/data/classes/output/fields_action_bar.php -> mod/data/classes/output/fields_action_bar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "57:         $this->id = $id;",
          "58:         $this->urlselect = $urlselect;",
          "59:         $this->fieldselect = $fieldselect;",
          "",
          "[Removed Lines]",
          "55:     public function __construct(int $id, \\url_select $urlselect, ?\\single_select $fieldselect = null,",
          "56:             ?\\single_button $saveaspresetbutton = null, ?\\single_button $exportpresetbutton = null) {",
          "",
          "[Added Lines]",
          "56:     public function __construct(int $id, \\url_select $urlselect, $unused = null,",
          "57:             ?\\single_button $saveaspresetbutton = null, ?\\single_button $exportpresetbutton = null,",
          "58:             ?\\action_menu $fieldselect = null) {",
          "60:         if ($unused !== null) {",
          "61:             debugging('Deprecated argument passed to fields_action_bar constructor', DEBUG_DEVELOPER);",
          "62:         }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/zero_state_action_bar.php||mod/data/classes/output/zero_state_action_bar.php": [
          "File: mod/data/classes/output/zero_state_action_bar.php -> mod/data/classes/output/zero_state_action_bar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:         global $PAGE;",
          "54:         $data = [];",
          "56:             $instance = $this->manager->get_instance();",
          "57:             $params = ['d' => $instance->id, 'backto' => $PAGE->url->out(false)];",
          "",
          "[Removed Lines]",
          "55:         if (has_capability('mod/data:managetemplates', $PAGE->context)) {",
          "",
          "[Added Lines]",
          "55:         if ($this->manager->can_manage_templates()) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:                 get_string('usepreset', 'mod_data'), 'get', true);",
          "62:             $data['usepresetbutton'] = $usepresetbutton->export_for_template($output);",
          "67:             $data['createfieldbutton'] = $createfieldbutton->export_for_template($output);",
          "69:             $params['action'] = 'import';",
          "",
          "[Removed Lines]",
          "64:             $createfieldlink = new moodle_url('/mod/data/field.php', $params);",
          "65:             $createfieldbutton = new \\single_button($createfieldlink,",
          "66:                 get_string('newfield', 'mod_data'), 'get', false);",
          "",
          "[Added Lines]",
          "64:             $actionbar = new \\mod_data\\output\\action_bar($instance->id, $PAGE->url);",
          "65:             $createfieldbutton = $actionbar->get_create_fields();",
          "",
          "---------------"
        ],
        "mod/data/edit.php||mod/data/edit.php": [
          "File: mod/data/edit.php -> mod/data/edit.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "74: }",
          "78:     if (!$manager->has_fields()) {",
          "79:         redirect($CFG->wwwroot.'/mod/data/field.php?d='.$data->id);  // Redirect to field entry.",
          "80:     }",
          "",
          "[Removed Lines]",
          "77: if (has_capability('mod/data:managetemplates', $context)) {",
          "",
          "[Added Lines]",
          "77: if ($manager->can_manage_templates()) {",
          "",
          "---------------"
        ],
        "mod/data/field.php||mod/data/field.php": [
          "File: mod/data/field.php -> mod/data/field.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "333:     $field->display_edit_field();",
          "335: } else {                                              /// Display the main listing of all fields",
          "336:     $fieldactionbar = $actionbar->get_fields_action_bar(true, true, true);",
          "337:     data_print_header($course, $cm, $data, 'fields', $fieldactionbar);",
          "338:     echo $OUTPUT->heading(get_string('managefields', 'data'), 2, 'mb-4');",
          "402:         }",
          "404:     }",
          "406:     echo '<div class=\"sortdefault\">';",
          "407:     echo '<form id=\"sortdefault\" action=\"'.$CFG->wwwroot.'/mod/data/field.php\" method=\"get\">';",
          "",
          "[Removed Lines]",
          "340:     if (!$DB->record_exists('data_fields', array('dataid'=>$data->id))) {",
          "341:         echo $OUTPUT->notification(get_string('nofieldindatabase','data'));  // nothing in database",
          "342:         echo $OUTPUT->notification(get_string('pleaseaddsome','data', 'preset.php?id='.$cm->id));      // link to presets",
          "344:     } else {    //else print quiz style list of fields",
          "346:         $table = new html_table();",
          "347:         $table->head = array(",
          "348:             get_string('fieldname', 'data'),",
          "349:             get_string('type', 'data'),",
          "350:             get_string('required', 'data'),",
          "351:             get_string('fielddescription', 'data'),",
          "352:             get_string('action', 'data'),",
          "353:         );",
          "354:         $table->align = array('left', 'left', 'left', 'left');",
          "355:         $table->wrap = array(false,false,false,false);",
          "357:         if ($fff = $DB->get_records('data_fields', array('dataid'=>$data->id),'id')){",
          "358:             $missingfieldtypes = [];",
          "359:             foreach ($fff as $ff) {",
          "361:                 $field = data_get_field($ff, $data);",
          "363:                 $baseurl = new moodle_url('/mod/data/field.php', array(",
          "364:                     'd'         => $data->id,",
          "365:                     'fid'       => $field->field->id,",
          "366:                     'sesskey'   => sesskey(),",
          "367:                 ));",
          "369:                 $displayurl = new moodle_url($baseurl, array(",
          "370:                     'mode'      => 'display',",
          "371:                 ));",
          "373:                 $deleteurl = new moodle_url($baseurl, array(",
          "374:                     'mode'      => 'delete',",
          "375:                 ));",
          "378:                 $deletelink = html_writer::link($deleteurl, $OUTPUT->pix_icon('t/delete', get_string('delete')));",
          "379:                 $editlink = html_writer::link($displayurl, $OUTPUT->pix_icon('t/edit', get_string('edit')));",
          "380:                 if ($field->type === 'unknown') {",
          "381:                     $missingfieldtypes[] = $field->field->name;",
          "382:                     $fieldnamedata = $field->field->name;",
          "383:                     $fieltypedata = $field->field->type;",
          "384:                     $fieldlinkdata = $deletelink;",
          "385:                 } else {",
          "386:                     $fieldnamedata = html_writer::link($displayurl, $field->field->name);",
          "387:                     $fieltypedata = $field->image() . '&nbsp;' . $field->name();",
          "388:                     $fieldlinkdata = $editlink . '&nbsp;' . $deletelink;",
          "389:                 }",
          "391:                 $table->data[] = [",
          "392:                     $fieldnamedata,",
          "393:                     $fieltypedata,",
          "394:                     $field->field->required ? get_string('yes') : get_string('no'),",
          "395:                     shorten_text($field->field->description, 30),",
          "396:                     $fieldlinkdata",
          "397:                 ];",
          "398:             }",
          "399:             if (!empty($missingfieldtypes)) {",
          "400:                 echo $OUTPUT->notification(get_string('missingfieldtypes', 'data') . html_writer::alist($missingfieldtypes));",
          "401:             }",
          "403:         echo html_writer::table($table);",
          "",
          "[Added Lines]",
          "336:     $hasfields = $manager->has_fields();",
          "339:     if (!$hasfields) {",
          "340:         $PAGE->set_title($data->name);",
          "341:         echo $OUTPUT->header();",
          "342:         echo $renderer->render_fields_zero_state($manager);",
          "343:         echo $OUTPUT->footer();",
          "345:         exit;",
          "346:     }",
          "351:     $table = new html_table();",
          "352:     $table->head = [",
          "353:         get_string('fieldname', 'data'),",
          "354:         get_string('type', 'data'),",
          "355:         get_string('required', 'data'),",
          "356:         get_string('fielddescription', 'data'),",
          "357:         get_string('action', 'data'),",
          "358:     ];",
          "359:     $table->align = ['left', 'left', 'left', 'left'];",
          "360:     $table->wrap = [false,false,false,false];",
          "362:     $fieldrecords = $manager->get_field_records();",
          "363:     $missingfieldtypes = [];",
          "364:     foreach ($fieldrecords as $fieldrecord) {",
          "366:         $field = data_get_field($fieldrecord, $data);",
          "368:         $baseurl = new moodle_url('/mod/data/field.php', array(",
          "369:             'd'         => $data->id,",
          "370:             'fid'       => $field->field->id,",
          "371:             'sesskey'   => sesskey(),",
          "372:         ));",
          "374:         $displayurl = new moodle_url($baseurl, array(",
          "375:             'mode'      => 'display',",
          "376:         ));",
          "378:         $deleteurl = new moodle_url($baseurl, array(",
          "379:             'mode'      => 'delete',",
          "380:         ));",
          "383:         $deletelink = html_writer::link($deleteurl, $OUTPUT->pix_icon('t/delete', get_string('delete')));",
          "384:         $editlink = html_writer::link($displayurl, $OUTPUT->pix_icon('t/edit', get_string('edit')));",
          "385:         if ($field->type === 'unknown') {",
          "386:             $missingfieldtypes[] = $field->field->name;",
          "387:             $fieldnamedata = $field->field->name;",
          "388:             $fieltypedata = $field->field->type;",
          "389:             $fieldlinkdata = $deletelink;",
          "390:         } else {",
          "391:             $fieldnamedata = html_writer::link($displayurl, $field->field->name);",
          "392:             $fieltypedata = $field->image() . '&nbsp;' . $field->name();",
          "393:             $fieldlinkdata = $editlink . '&nbsp;' . $deletelink;",
          "394:         }",
          "396:         $table->data[] = [",
          "397:             $fieldnamedata,",
          "398:             $fieltypedata,",
          "399:             $field->field->required ? get_string('yes') : get_string('no'),",
          "400:             shorten_text($field->field->description, 30),",
          "401:             $fieldlinkdata",
          "402:         ];",
          "404:         if (!empty($missingfieldtypes)) {",
          "405:             echo $OUTPUT->notification(get_string('missingfieldtypes', 'data') . html_writer::alist($missingfieldtypes));",
          "408:     echo html_writer::table($table);",
          "",
          "---------------"
        ],
        "mod/data/lang/en/data.php||mod/data/lang/en/data.php": [
          "File: mod/data/lang/en/data.php -> mod/data/lang/en/data.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "78: $string['confirmdeletefield'] = 'You are about to delete this field, are you sure?';",
          "79: $string['confirmdeleterecord'] = 'Are you sure you want to delete this entry?';",
          "80: $string['confirmdeleterecords'] = 'Are you sure you want to delete these entries?';",
          "82: $string['csstemplate'] = 'CSS template';",
          "83: $string['csvfailed'] = 'Unable to read the raw data from the CSV file';",
          "84: $string['csvfile'] = 'CSV file';",
          "",
          "[Removed Lines]",
          "81: $string['createfields'] = 'Create your own fields to collect data, or use a preset which includes fields already.';",
          "",
          "[Added Lines]",
          "81: $string['createactivity'] = 'Create your own fields to collect data, or use a preset which includes fields already.';",
          "82: $string['createfields'] = 'Create fields to collect different types of data.';",
          "83: $string['createtemplates'] = 'Create fields for your activity to generate a template, or import a preset with existing fields and templates.';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "291: $string['multimenu'] = 'Menu (Multi-select)';",
          "292: $string['multipletags'] = 'Multiple tags found! Template not saved';",
          "293: $string['newentry'] = 'New entry';",
          "295: $string['newfield_help'] = 'A field allows the input of data. Each entry in a database activity can have multiple fields of multiple types such as a date field, which allows participants to select a day, month and year from a drop-down menu, a picture field, which allows participants to upload an image file, or a checkbox field, which allows participants to select one or more options.",
          "297: Each field must have a unique field name. The field description is optional.';",
          "",
          "[Removed Lines]",
          "294: $string['newfield'] = 'Create a new field';",
          "",
          "[Added Lines]",
          "296: $string['newfield'] = 'Create a field';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "299: $string['nodefinedfields'] = 'New preset has no defined fields!';",
          "300: $string['nofieldcontent'] = 'Field content not found';",
          "301: $string['nofieldindatabase'] = 'There are no fields defined for this database.';",
          "302: $string['nomatch'] = 'No matching entries found!';",
          "303: $string['nomaximum'] = 'No maximum';",
          "304: $string['nopreviewavailable'] = 'No preview available for {$a}';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "304: $string['nofields'] = 'No fields yet';",
          "305: $string['nolisttemplate'] = 'List template is not yet defined';",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "306: $string['notapproved'] = 'Pending approval';",
          "307: $string['notapprovederror'] = 'Entry is not approved yet.';",
          "308: $string['notinjectivemap'] = 'Not an injective map';",
          "309: $string['notopenyet'] = 'Sorry, this activity is not available until {$a}';",
          "310: $string['number'] = 'Number';",
          "311: $string['numberrssarticles'] = 'Entries in the RSS feed';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "313: $string['notemplates'] = 'Not templates yet';",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "323: $string['pagesize'] = 'Entries per page';",
          "324: $string['participants'] = 'Participants';",
          "325: $string['picture'] = 'Picture';",
          "327: $string['pluginadministration'] = 'Database activity administration';",
          "328: $string['pluginname'] = 'Database';",
          "329: $string['portfolionotfile'] = 'Export to a portfolio rather than a file (csv and leap2a only)';",
          "",
          "[Removed Lines]",
          "326: $string['pleaseaddsome'] = 'Please create some below or <a href=\"{$a}\">choose a predefined set</a> to get started.';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "455: $string['buttons'] = 'Actions';",
          "456: $string['nolisttemplate'] = 'List template is not yet defined';",
          "457: $string['nosingletemplate'] = 'Single template is not yet defined';",
          "458: $string['blank'] = 'Blank';",
          "459: $string['savetemplate'] = 'Save template';",
          "460: $string['addedby'] = 'Added by';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "462: $string['pleaseaddsome'] = 'Please create some below or <a href=\"{$a}\">choose a predefined set</a> to get started.';",
          "",
          "---------------"
        ],
        "mod/data/renderer.php||mod/data/renderer.php": [
          "File: mod/data/renderer.php -> mod/data/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "155:     public function render_fields_action_bar(\\mod_data\\output\\fields_action_bar $actionbar): string {",
          "156:         $data = $actionbar->export_for_template($this);",
          "157:         return $this->render_from_template('mod_data/fields_action_bar', $data);",
          "158:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "157:         $data['title'] = get_string('nofields', 'mod_data');",
          "158:         $data['intro'] = get_string('createfields', 'mod_data');",
          "159:         $data['noitemsimgurl'] = $this->output->image_url('nofields', 'mod_data')->out();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "237:         $actionbar = new \\mod_data\\output\\zero_state_action_bar($manager);",
          "238:         $data = $actionbar->export_for_template($this);",
          "239:         if (empty($data)) {",
          "",
          "[Removed Lines]",
          "236:     public function render_zero_state(\\mod_data\\manager $manager): string {",
          "",
          "[Added Lines]",
          "239:     public function render_database_zero_state(\\mod_data\\manager $manager): string {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "242:             $data['intro'] = get_string('comebacklater');",
          "243:         } else {",
          "244:             $data['title'] = get_string('startbuilding', 'mod_data');",
          "246:         }",
          "247:         $data['noitemsimgurl'] = $this->output->image_url('nofields', 'mod_data')->out();",
          "",
          "[Removed Lines]",
          "245:             $data['intro'] = get_string('createfields', 'mod_data');",
          "",
          "[Added Lines]",
          "248:             $data['intro'] = get_string('createactivity', 'mod_data');",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "264:         return $this->render_from_template('mod_data/view_noentries', $data);",
          "265:     }",
          "266: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "277:     public function render_fields_zero_state(\\mod_data\\manager $manager): string {",
          "278:         $data = [",
          "279:             'noitemsimgurl' => $this->output->image_url('nofields', 'mod_data')->out(),",
          "280:             'title' => get_string('nofields', 'mod_data'),",
          "281:             'intro' => get_string('createfields', 'mod_data'),",
          "282:             ];",
          "283:         if ($manager->can_manage_templates()) {",
          "284:             $actionbar = new \\mod_data\\output\\action_bar($manager->get_instance()->id, $this->page->url);",
          "285:             $createfieldbutton = $actionbar->get_create_fields();",
          "286:             $data['createfieldbutton'] = $createfieldbutton->export_for_template($this);",
          "287:         }",
          "289:         return $this->render_from_template('mod_data/zero_state', $data);",
          "290:     }",
          "299:     public function render_templates_zero_state(\\mod_data\\manager $manager): string {",
          "300:         $actionbar = new \\mod_data\\output\\zero_state_action_bar($manager);",
          "301:         $data = $actionbar->export_for_template($this);",
          "302:         $data['title'] = get_string('notemplates', 'mod_data');",
          "303:         $data['intro'] = get_string('createtemplates', 'mod_data');",
          "304:         $data['noitemsimgurl'] = $this->output->image_url('nofields', 'mod_data')->out();",
          "306:         return $this->render_from_template('mod_data/zero_state', $data);",
          "307:     }",
          "",
          "---------------"
        ],
        "mod/data/styles.css||mod/data/styles.css": [
          "File: mod/data/styles.css -> mod/data/styles.css",
          "--- Hunk 1 ---",
          "[Context before]",
          "188: .template-preview-content .data-field-html button {",
          "189:     pointer-events: none;",
          "190: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "192: #page-mod-data-view .whitebutton .btn-secondary,",
          "193: #page-mod-data-field- .whitebutton .btn-secondary,",
          "194: #page-mod-data-templates .whitebutton .btn-secondary {",
          "195:     background: white;",
          "196:     border-color: var(--primary);",
          "197:     color: var(--primary);",
          "198: }",
          "",
          "---------------"
        ],
        "mod/data/templates.php||mod/data/templates.php": [
          "File: mod/data/templates.php -> mod/data/templates.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "56: require_login($course, false, $cm);",
          "57: require_capability('mod/data:managetemplates', $context);",
          "64: $manager->set_template_viewed();",
          "66: if ($useeditor !== null) {",
          "",
          "[Removed Lines]",
          "60: if (count($manager->get_field_records()) == 0) {",
          "61:     redirect($CFG->wwwroot.'/mod/data/field.php?d='.$instance->id);",
          "62: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "79: echo $OUTPUT->header();",
          "81: $actionbar = new \\mod_data\\output\\action_bar($instance->id, $url);",
          "82: echo $actionbar->get_templates_action_bar();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76: $renderer = $manager->get_renderer();",
          "78: if (!$manager->has_fields()) {",
          "79:     echo $renderer->render_templates_zero_state($manager);",
          "80:     echo $OUTPUT->footer();",
          "82:     exit;",
          "83: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "104:     }",
          "105: }",
          "108: $templateeditor = new \\mod_data\\output\\template_editor($manager, $mode);",
          "109: echo $renderer->render($templateeditor);",
          "",
          "[Removed Lines]",
          "107: $renderer = $manager->get_renderer();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "mod/data/templates/fields_action_bar.mustache||mod/data/templates/fields_action_bar.mustache": [
          "File: mod/data/templates/fields_action_bar.mustache -> mod/data/templates/fields_action_bar.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:                     {{>core/url_select}}",
          "88:                 </div>",
          "89:             {{/urlselect}}",
          "95:         </div>",
          "96:         <div class=\"ml-sm-auto d-flex\">",
          "97:             {{#saveaspreset}}",
          "",
          "[Removed Lines]",
          "90:             {{#fieldselect}}",
          "91:                 <div class='navitem fieldadd'>",
          "92:                     {{>core/single_select}}",
          "93:                 </div>",
          "94:             {{/fieldselect}}",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "104:                     {{>core/single_button}}",
          "105:                 </div>",
          "106:             {{/exportpreset}}",
          "107:         </div>",
          "108:     </div>",
          "109: </div>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102:             {{#fieldselect}}",
          "103:                 {{>core/action_menu}}",
          "104:             {{/fieldselect}}",
          "",
          "---------------"
        ],
        "mod/data/templates/zero_state.mustache||mod/data/templates/zero_state.mustache": [
          "File: mod/data/templates/zero_state.mustache -> mod/data/templates/zero_state.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "77:             style=\"height: 70px; width: 70px;\"",
          "78:     >",
          "79:     <h5 class=\"h5 mt-3 mb-0\">{{{ title }}}</h5>",
          "83:         {{#importpresetbutton}}",
          "84:             {{>core/single_button}}",
          "85:         {{/importpresetbutton}}",
          "89:         {{#usepresetbutton}}",
          "90:             {{>core/single_button}}",
          "91:         {{/usepresetbutton}}",
          "",
          "[Removed Lines]",
          "80:     <p class=\"mt-3 mb-0\">{{{ intro }}}</p>",
          "82:     <div class=\"mt-5 mb-0\" id=\"action_bar\">",
          "86:         {{#createfieldbutton}}",
          "87:             {{>core/single_button}}",
          "88:         {{/createfieldbutton}}",
          "",
          "[Added Lines]",
          "80:     {{#intro}}",
          "81:         <p class=\"mt-3 mb-0\">{{{ intro }}}</p>",
          "82:     {{/intro}}",
          "84:     <div class=\"mt-5 mb-0 whitebutton\" id=\"action_bar\">",
          "85:         {{#createfieldbutton}}",
          "86:             {{>core/action_menu}}",
          "87:         {{/createfieldbutton}}",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/behat_mod_data.php||mod/data/tests/behat/behat_mod_data.php": [
          "File: mod/data/tests/behat/behat_mod_data.php -> mod/data/tests/behat/behat_mod_data.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:         $fieldsstr = get_string('fields', 'mod_data');",
          "55:         $this->execute(\"behat_navigation::i_navigate_to_in_current_page_administration\", $fieldsstr);",
          "58:         if (!$this->running_javascript()) {",
          "59:             $this->execute('behat_general::i_click_on_in_the',",
          "",
          "[Removed Lines]",
          "56:         $this->execute('behat_forms::i_set_the_field_to', array('newtype', $this->escape($fieldtype)));",
          "",
          "[Added Lines]",
          "56:         $this->execute('behat_general::i_click_on', [get_string('newfield', 'mod_data'), \"button\"]);",
          "57:         $this->execute('behat_general::i_click_on_in_the',",
          "58:             [$this->escape($fieldtype), \"link\", \"#action_bar\", \"css_element\"]",
          "59:         );",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/data_activity_completion.feature||mod/data/tests/behat/data_activity_completion.feature": [
          "File: mod/data/tests/behat/data_activity_completion.feature -> mod/data/tests/behat/data_activity_completion.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: Feature: View activity completion in the database activity",
          "3:   In order to have visibility of database completion requirements",
          "4:   As a student",
          "",
          "[Removed Lines]",
          "1: @mod @mod_data @core_completion",
          "",
          "[Added Lines]",
          "1: @mod @mod_data @core_completion @javascript",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77:     And I am on the \"Music history\" \"data activity\" page logged in as teacher1",
          "78:     And I select \"Single view\" from the \"jump\" singleselect",
          "79:     And I set the field \"rating\" to \"3\"",
          "81:     And I log out",
          "83:     When I am on the \"Music history\" \"data activity\" page logged in as student1",
          "",
          "[Removed Lines]",
          "80:     And I press \"Rate\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/data_activity_completion_pass_grade.feature||mod/data/tests/behat/data_activity_completion_pass_grade.feature": [
          "File: mod/data/tests/behat/data_activity_completion_pass_grade.feature -> mod/data/tests/behat/data_activity_completion_pass_grade.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:       | Field name | Instrument types |",
          "53:     And I log out",
          "55:   Scenario: View automatic completion items as a teacher",
          "56:     Given I am on the \"Music history\" \"data activity\" page logged in as teacher1",
          "57: #   We add an entry to let the user change to a different view.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:   @javascript",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/preview_preset.feature||mod/data/tests/behat/preview_preset.feature": [
          "File: mod/data/tests/behat/preview_preset.feature -> mod/data/tests/behat/preview_preset.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "140:     And I click on \"Image gallery\" \"link\"",
          "141:     When I click on \"Use a preset\" \"button\"",
          "142:     Then I should see \"image\"",
          "143:     And I should see \"title\"",
          "145:   @javascript @_file_upload",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "143:     And I should see \"image\"",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/zero_state.feature||mod/data/tests/behat/zero_state.feature": [
          "File: mod/data/tests/behat/zero_state.feature -> mod/data/tests/behat/zero_state.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: Feature: Zero state page (no fields created)",
          "4:   Background:",
          "",
          "[Removed Lines]",
          "1: @mod @mod_data",
          "",
          "[Added Lines]",
          "1: @mod @mod_data @javascript",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "15:       | activity | name               | intro | course | idnumber |",
          "16:       | data     | Test database name | n     | C1     | data1    |",
          "20:     Given I am on the \"Test database name\" \"data activity\" page logged in as \"teacher1\"",
          "21:     And \"Import a preset\" \"button\" should exist",
          "22:     When I click on \"Import a preset\" \"button\"",
          "23:     Then I should see \"Import from zip file\"",
          "24:     And I am on the \"Test database name\" \"data activity\" page",
          "28:     And I am on the \"Test database name\" \"data activity\" page",
          "29:     And \"Use a preset\" \"button\" should exist",
          "30:     And I click on \"Use a preset\" \"button\"",
          "31:     And I should see \"Presets\"",
          "",
          "[Removed Lines]",
          "18:   @javascript",
          "19:   Scenario: Teachers see buttons to manage database when there is no field created",
          "25:     And \"Create a new field\" \"button\" should exist",
          "26:     And I click on \"Create a new field\" \"button\"",
          "27:     And I should see \"Manage fields\"",
          "",
          "[Added Lines]",
          "18:   Scenario: Teachers see buttons to manage database when there is no field created on view page",
          "24:     And \"Create a field\" \"button\" should exist",
          "25:     And I click on \"Create a field\" \"button\"",
          "26:     And I click on \"Short text\" \"link\"",
          "27:     And I should see \"Create a field\"",
          "33:   Scenario: Teachers see buttons to manage database when there is no field created on templates page",
          "34:     Given I am on the \"Test database name\" \"data activity\" page logged in as \"teacher1\"",
          "35:     And \"Import a preset\" \"button\" should exist",
          "36:     When I click on \"Import a preset\" \"button\"",
          "37:     Then I should see \"Import from zip file\"",
          "38:     And I am on the \"Test database name\" \"data activity\" page",
          "39:     And I click on \"Templates\" \"link\"",
          "40:     And \"Create a field\" \"button\" should exist",
          "41:     And I click on \"Create a field\" \"button\"",
          "42:     And I click on \"Short text\" \"link\"",
          "43:     And I should see \"Create a field\"",
          "44:     And I am on the \"Test database name\" \"data activity\" page",
          "45:     And I click on \"Templates\" \"link\"",
          "46:     And \"Use a preset\" \"button\" should exist",
          "47:     And I click on \"Use a preset\" \"button\"",
          "48:     And I should see \"Presets\"",
          "50:   Scenario: Teachers see buttons to manage database when there is no field created on fields page",
          "51:     Given I am on the \"Test database name\" \"data activity\" page logged in as \"teacher1\"",
          "52:     And I click on \"Fields\" \"link\"",
          "53:     And \"Import a preset\" \"button\" should not exist",
          "54:     And \"Use a preset\" \"button\" should not exist",
          "55:     And \"Create a field\" \"button\" should exist",
          "56:     Then I should see \"No fields yet\"",
          "57:     And I click on \"Create a field\" \"button\"",
          "58:     And I click on \"Short text\" \"link\"",
          "59:     And I should see \"Create a field\"",
          "",
          "---------------"
        ],
        "mod/data/view.php||mod/data/view.php": [
          "File: mod/data/view.php -> mod/data/view.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "242: if (!$manager->has_fields()) {",
          "244:     $renderer = $manager->get_renderer();",
          "246:     echo $OUTPUT->footer();",
          "248:     exit;",
          "",
          "[Removed Lines]",
          "245:     echo $renderer->render_zero_state($manager);",
          "",
          "[Added Lines]",
          "245:     echo $renderer->render_database_zero_state($manager);",
          "",
          "---------------"
        ],
        "theme/boost/scss/moodle/core.scss||theme/boost/scss/moodle/core.scss": [
          "File: theme/boost/scss/moodle/core.scss -> theme/boost/scss/moodle/core.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: $font-size-xs: ($font-size-base * .75) !default;",
          "20: #region-main {",
          "22:     overflow-y: visible;",
          "23:     background-color: $body-bg;",
          "24: }",
          "",
          "[Removed Lines]",
          "21:     overflow-x: auto;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "theme/boost/style/moodle.css||theme/boost/style/moodle.css": [
          "File: theme/boost/style/moodle.css -> theme/boost/style/moodle.css",
          "--- Hunk 1 ---",
          "[Context before]",
          "9862: #region-main {",
          "9864:   overflow-y: visible;",
          "9865:   background-color: #fff; }",
          "",
          "[Removed Lines]",
          "9863:   overflow-x: auto;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "theme/classic/style/moodle.css||theme/classic/style/moodle.css": [
          "File: theme/classic/style/moodle.css -> theme/classic/style/moodle.css",
          "--- Hunk 1 ---",
          "[Context before]",
          "9862: #region-main {",
          "9864:   overflow-y: visible;",
          "9865:   background-color: #fff; }",
          "",
          "[Removed Lines]",
          "9863:   overflow-x: auto;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "151b0ba35025237f624c926cce85858f4936b408",
      "candidate_info": {
        "commit_hash": "151b0ba35025237f624c926cce85858f4936b408",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/151b0ba35025237f624c926cce85858f4936b408",
        "files": [
          "mod/data/amd/build/resetalltemplates.min.js",
          "mod/data/amd/build/resetalltemplates.min.js.map",
          "mod/data/amd/build/templateseditor.min.js",
          "mod/data/amd/build/templateseditor.min.js.map",
          "mod/data/amd/src/resetalltemplates.js",
          "mod/data/amd/src/templateseditor.js",
          "mod/data/classes/manager.php",
          "mod/data/classes/output/action_bar.php",
          "mod/data/lang/en/data.php",
          "mod/data/templates.php",
          "mod/data/templates/template_editor.mustache",
          "mod/data/templates/template_editor_resetmodal.mustache",
          "mod/data/templates/templates_action_bar.mustache",
          "mod/data/tests/behat/default_templates.feature",
          "mod/data/tests/behat/edit_templates.feature",
          "mod/data/tests/manager_test.php"
        ],
        "message": "MDL-75410 mod_data: reset all templates feature",
        "before_after_code_files": [
          "mod/data/amd/src/resetalltemplates.js||mod/data/amd/src/resetalltemplates.js",
          "mod/data/amd/src/templateseditor.js||mod/data/amd/src/templateseditor.js",
          "mod/data/classes/manager.php||mod/data/classes/manager.php",
          "mod/data/classes/output/action_bar.php||mod/data/classes/output/action_bar.php",
          "mod/data/lang/en/data.php||mod/data/lang/en/data.php",
          "mod/data/templates.php||mod/data/templates.php",
          "mod/data/templates/template_editor.mustache||mod/data/templates/template_editor.mustache",
          "mod/data/templates/template_editor_resetmodal.mustache||mod/data/templates/template_editor_resetmodal.mustache",
          "mod/data/templates/templates_action_bar.mustache||mod/data/templates/templates_action_bar.mustache",
          "mod/data/tests/behat/default_templates.feature||mod/data/tests/behat/default_templates.feature",
          "mod/data/tests/behat/edit_templates.feature||mod/data/tests/behat/edit_templates.feature",
          "mod/data/tests/manager_test.php||mod/data/tests/manager_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "mod/data/amd/src/resetalltemplates.js||mod/data/amd/src/resetalltemplates.js": [
          "File: mod/data/amd/src/resetalltemplates.js -> mod/data/amd/src/resetalltemplates.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: import Notification from 'core/notification';",
          "25: import {prefetchStrings} from 'core/prefetch';",
          "26: import {get_string as getString} from 'core/str';",
          "28: const selectors = {",
          "29:     resetAllTemplatesAction: '[data-action=\"resetalltemplates\"]',",
          "30: };",
          "35: export const init = () => {",
          "36:     prefetchStrings('mod_data', [",
          "37:         'resetalltemplatesconfirmtitle',",
          "38:         'resetalltemplatesconfirm',",
          "39:     ]);",
          "40:     prefetchStrings('core', [",
          "41:         'reset',",
          "42:     ]);",
          "43:     registerEventListeners();",
          "44: };",
          "49: const registerEventListeners = () => {",
          "50:     document.addEventListener('click', (event) => {",
          "51:         const actionLink = event.target.closest(selectors.resetAllTemplatesAction);",
          "52:         if (actionLink) {",
          "53:             event.preventDefault();",
          "54:             resetAllTemplatesConfirm(actionLink);",
          "55:         }",
          "56:     });",
          "57: };",
          "64: const resetAllTemplatesConfirm = async(actionLink) => {",
          "65:     try {",
          "66:         await Notification.saveCancelPromise(",
          "67:             getString('resetalltemplatesconfirmtitle', 'mod_data'),",
          "68:             getString('resetalltemplatesconfirm', 'mod_data'),",
          "69:             getString('reset', 'core'),",
          "70:         );",
          "71:         window.location = actionLink.href;",
          "72:     } catch (error) {",
          "73:         return;",
          "74:     }",
          "75: };",
          "",
          "---------------"
        ],
        "mod/data/amd/src/templateseditor.js||mod/data/amd/src/templateseditor.js": [
          "File: mod/data/amd/src/templateseditor.js -> mod/data/amd/src/templateseditor.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: import {prefetchStrings} from 'core/prefetch';",
          "26: import {relativeUrl} from 'core/url';",
          "27: import {saveCancel} from 'core/notification';",
          "29: prefetchStrings('admin', ['confirmation']);",
          "30: prefetchStrings('mod_data', [",
          "31:     'resettemplateconfirmtitle',",
          "32:     'resettemplateconfirm',",
          "34:     'enabletemplateeditorcheck',",
          "35:     'editorenable'",
          "36: ]);",
          "",
          "[Removed Lines]",
          "33:     'resettemplate',",
          "",
          "[Added Lines]",
          "28: import Templates from 'core/templates';",
          "37: prefetchStrings('core', [",
          "38:     'reset',",
          "39: ]);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "41: const selectors = {",
          "42:     toggleTemplateEditor: 'input[name=\"useeditor\"]',",
          "43:     resetTemplate: 'input[name=\"defaultform\"]',",
          "44:     resetButton: 'input[name=\"resetbutton\"]',",
          "45:     editForm: '#edittemplateform',",
          "46: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:     resetAllTemplates: 'input[name=\"resetall\"]',",
          "49:     resetAllCheck: 'input[name=\"resetallcheck\"]',",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "60:     const editForm = document.querySelector(selectors.editForm);",
          "61:     const resetButton = document.querySelector(selectors.resetButton);",
          "62:     const resetTemplate = document.querySelector(selectors.resetTemplate);",
          "64:     if (!resetButton || !resetTemplate || !editForm) {",
          "65:         return;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:     const resetAllTemplates = document.querySelector(selectors.resetAllTemplates);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "69:         event.preventDefault();",
          "70:         saveCancel(",
          "71:             getString('resettemplateconfirmtitle', 'mod_data'),",
          "74:             () => {",
          "75:                 resetTemplate.value = \"true\";",
          "76:                 editForm.submit();",
          "",
          "[Removed Lines]",
          "72:             getString('resettemplateconfirm', 'mod_data'),",
          "73:             getString('resettemplate', 'mod_data'),",
          "",
          "[Added Lines]",
          "78:             Templates.render('mod_data/template_editor_resetmodal', {resetallname: \"resetallcheck\"}),",
          "79:             getString('reset', 'core'),",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "79:             {triggerElement: event.target}",
          "80:         );",
          "81:     });",
          "82: };",
          "84: const registerEditorToggler = (instanceId, mode) => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "90:     if (!resetAllTemplates) {",
          "91:         return;",
          "92:     }",
          "93:     document.addEventListener('change', (event) => {",
          "94:         if (event.target.matches(selectors.resetAllCheck)) {",
          "95:             resetAllTemplates.value = (event.target.checked) ? \"true\" : \"\";",
          "96:         }",
          "97:     });",
          "",
          "---------------"
        ],
        "mod/data/classes/manager.php||mod/data/classes/manager.php": [
          "File: mod/data/classes/manager.php -> mod/data/classes/manager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "372:         return true;",
          "373:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "380:     public function reset_all_templates(): bool {",
          "381:         $newtemplates = new stdClass();",
          "382:         foreach (self::TEMPLATES_LIST as $templatename => $templatefile) {",
          "383:             $newtemplates->{$templatename} = '';",
          "384:         }",
          "385:         return $this->update_templates($newtemplates);",
          "386:     }",
          "394:     public function reset_template(string $templatename): bool {",
          "395:         $newtemplates = new stdClass();",
          "397:         $newtemplates->{$templatename} = '';",
          "398:         if ($templatename == 'listtemplate') {",
          "399:             $newtemplates->listtemplateheader = '';",
          "400:             $newtemplates->listtemplatefooter = '';",
          "401:         }",
          "402:         if ($templatename == 'rsstemplate') {",
          "403:             $newtemplates->rsstitletemplate = '';",
          "404:         }",
          "405:         return $this->update_templates($newtemplates);",
          "406:     }",
          "",
          "---------------"
        ],
        "mod/data/classes/output/action_bar.php||mod/data/classes/output/action_bar.php": [
          "File: mod/data/classes/output/action_bar.php -> mod/data/classes/output/action_bar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "178:         $selectmenu->set_label(get_string('templatesnavigation', 'mod_data'), ['class' => 'sr-only']);",
          "180:         $renderer = $PAGE->get_renderer('mod_data');",
          "181:         $presetsactions = $this->get_presets_actions_select(false);",
          "182:         $templatesactionbar = new templates_action_bar($this->id, $selectmenu, null, null, $presetsactions);",
          "184:         return $renderer->render_templates_action_bar($templatesactionbar);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "185:         $resetallurl = new moodle_url($this->currenturl);",
          "186:         $resetallurl->param('action', 'resetalltemplates');",
          "187:         $presetsactions->add(new \\action_menu_link(",
          "188:             $resetallurl,",
          "189:             null,",
          "190:             get_string('resetalltemplates', 'mod_data'),",
          "191:             false,",
          "192:             ['data-action' => 'resetalltemplates', 'data-dataid' => $this->id]",
          "193:         ));",
          "",
          "---------------"
        ],
        "mod/data/lang/en/data.php||mod/data/lang/en/data.php": [
          "File: mod/data/lang/en/data.php -> mod/data/lang/en/data.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "384: Note: If entries are required before viewing, the database auto-linking filter should be disabled. This is because the database auto-linking filter can\\'t determine whether a user has submitted the required number of entries.';",
          "385: $string['requiredfield'] = 'Required field';",
          "386: $string['resetsettings'] = 'Reset filters';",
          "387: $string['resettemplate'] = 'Reset template';",
          "388: $string['resettemplateconfirmtitle'] = 'Reset template?';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "386: $string['resetalltemplates'] = 'Reset all templates';",
          "387: $string['resetalltemplatesconfirmtitle'] = 'Reset all templates?';",
          "388: $string['resetalltemplatesconfirm'] = 'You\\'re about to remove all templates for your current preset. If you want to restore the templates later, you need to choose the preset again in the \\'Presets\\' tab.';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "424: $string['teachersandstudents'] = '{$a->teachers} and {$a->students}';",
          "425: $string['templates'] = 'Templates';",
          "426: $string['templatereset'] = 'Template reset';",
          "427: $string['templatesnavigation'] = 'Templates tertiary navigation';",
          "428: $string['templatesaved'] = 'Template saved';",
          "429: $string['text'] = 'Text';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "430: $string['templateresetall'] = 'All templates reset';",
          "",
          "---------------"
        ],
        "mod/data/templates.php||mod/data/templates.php": [
          "File: mod/data/templates.php -> mod/data/templates.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: $id    = optional_param('id', 0, PARAM_INT);  // course module id",
          "32: $d     = optional_param('d', 0, PARAM_INT);   // database id",
          "33: $mode  = optional_param('mode', 'addtemplate', PARAM_ALPHA);",
          "34: $useeditor = optional_param('useeditor', null, PARAM_BOOL);",
          "36: $url = new moodle_url('/mod/data/templates.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: $action  = optional_param('action', '', PARAM_ALPHA);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "85: $actionbar = new \\mod_data\\output\\action_bar($instance->id, $url);",
          "86: echo $actionbar->get_templates_action_bar();",
          "88: if (($formdata = data_submitted()) && confirm_sesskey()) {",
          "90:     if (!empty($formdata->defaultform)) {",
          "99:         }",
          "106:     }",
          "107: }",
          "109: $templateeditor = new \\mod_data\\output\\template_editor($manager, $mode);",
          "110: echo $renderer->render($templateeditor);",
          "",
          "[Removed Lines]",
          "89:     $notificationstr = get_string('templatesaved', 'data');",
          "92:         $formdata->{$mode} = '';",
          "93:         if ($mode == 'listtemplate') {",
          "94:             $formdata->listtemplateheader = '';",
          "95:             $formdata->listtemplatefooter = '';",
          "96:         }",
          "97:         if ($mode == 'rsstemplate') {",
          "98:             $formdata->rsstitletemplate = '';",
          "100:         $notificationstr = get_string('templatereset', 'data');",
          "101:     }",
          "102:     if ($manager->update_templates($formdata)) {",
          "104:         $instance = $manager->get_instance();",
          "105:         echo $OUTPUT->notification($notificationstr, 'notifysuccess');",
          "",
          "[Added Lines]",
          "89: if ($action == 'resetalltemplates') {",
          "90:     $manager->reset_all_templates();",
          "91:     $notificationstr = get_string('templateresetall', 'mod_data');",
          "92: }",
          "97:         if (!empty($formdata->resetall)) {",
          "98:             $manager->reset_all_templates();",
          "99:             $notificationstr = get_string('templateresetall', 'mod_data');",
          "100:         } else {",
          "101:             $manager->reset_template($mode);",
          "102:             $notificationstr = get_string('templatereset', 'data');",
          "104:     } else {",
          "105:         $manager->update_templates($formdata);",
          "106:         $notificationstr = get_string('templatesaved', 'data');",
          "110: if (!empty($notificationstr)) {",
          "111:     echo $OUTPUT->notification($notificationstr, 'notifysuccess');",
          "112: }",
          "",
          "---------------"
        ],
        "mod/data/templates/template_editor.mustache||mod/data/templates/template_editor.mustache": [
          "File: mod/data/templates/template_editor.mustache -> mod/data/templates/template_editor.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "69: <form id=\"edittemplateform\" action=\"{{{url}}}\" method=\"post\">",
          "70:     <input name=\"sesskey\" value=\"{{sesskey}}\" type=\"hidden\" />",
          "71:     <input name=\"defaultform\" type=\"hidden\" value=\"\"/>",
          "72:     <div class=\"d-flex flex-row align-items-center\">",
          "73:         {{#toolbar}}",
          "74:             {{> mod_data/template_editor_tools }}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "72:     <input name=\"resetall\" type=\"hidden\" value=\"\"/>",
          "",
          "---------------"
        ],
        "mod/data/templates/template_editor_resetmodal.mustache||mod/data/templates/template_editor_resetmodal.mustache": [
          "File: mod/data/templates/template_editor_resetmodal.mustache -> mod/data/templates/template_editor_resetmodal.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "3:     Moodle is free software: you can redistribute it and/or modify",
          "4:     it under the terms of the GNU General Public License as published by",
          "5:     the Free Software Foundation, either version 3 of the License, or",
          "6:     (at your option) any later version.",
          "7:     Moodle is distributed in the hope that it will be useful,",
          "8:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "9:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "10:     GNU General Public License for more details.",
          "11:     You should have received a copy of the GNU General Public License",
          "12:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "13: }}",
          "14: {{!",
          "15:     @template mod_data/template_editor_resetmodal",
          "17:     Reset template modal content.",
          "19:     Example context (json):",
          "20:     {",
          "21:         \"resetallname\": \"resetallcheck\"",
          "22:     }",
          "23: }}",
          "24: <p>{{#str}} resetalltemplatesconfirm, mod_data {{/str}}</p>",
          "25: <div class=\"form-check\">",
          "26:     <input type=\"checkbox\" class=\"form-check-input\" id=\"modalcheckbox\" name=\"{{resetallname}}\">",
          "27:     <label class=\"form-check-label\" for=\"modalcheckbox\">{{#str}} resetalltemplates, mod_data {{/str}}</label>",
          "28: </div>",
          "",
          "---------------"
        ],
        "mod/data/templates/templates_action_bar.mustache||mod/data/templates/templates_action_bar.mustache": [
          "File: mod/data/templates/templates_action_bar.mustache -> mod/data/templates/templates_action_bar.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "98: </div>",
          "99: <hr/>",
          "100: {{#js}}",
          "102:         saveAsPreset.init();",
          "103:     });",
          "104: {{/js}}",
          "",
          "[Removed Lines]",
          "101:     require(['mod_data/saveaspreset'], function(saveAsPreset) {",
          "",
          "[Added Lines]",
          "101:     require(['mod_data/saveaspreset', 'mod_data/resetalltemplates'], function(saveAsPreset, resetAll) {",
          "103:         resetAll.init();",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/default_templates.feature||mod/data/tests/behat/default_templates.feature": [
          "File: mod/data/tests/behat/default_templates.feature -> mod/data/tests/behat/default_templates.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "143:     When I navigate to \"Templates\" in current page administration",
          "144:     And I set the field \"Templates tertiary navigation\" to \"List view template\"",
          "145:     And I click on \"Reset\" \"button\" in the \"sticky-footer\" \"region\"",
          "147:     And I should see \"Template reset\"",
          "148:     And I navigate to \"Database\" in current page administration",
          "149:     And I should not see \"New header!\"",
          "",
          "[Removed Lines]",
          "146:     And I click on \"Reset template\" \"button\" in the \"Reset template?\" \"dialogue\"",
          "",
          "[Added Lines]",
          "146:     And I click on \"Reset\" \"button\" in the \"Reset template?\" \"dialogue\"",
          "",
          "---------------"
        ],
        "mod/data/tests/behat/edit_templates.feature||mod/data/tests/behat/edit_templates.feature": [
          "File: mod/data/tests/behat/edit_templates.feature -> mod/data/tests/behat/edit_templates.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     When I navigate to \"Templates\" in current page administration",
          "125:     And I set the field \"Templates tertiary navigation\" to \"List view template\"",
          "126:     And I click on \"Reset\" \"button\" in the \"sticky-footer\" \"region\"",
          "128:     Then I should see \"Template reset\"",
          "129:     And I navigate to \"Database\" in current page administration",
          "130:     And I should not see \"New header!\"",
          "",
          "[Removed Lines]",
          "127:     And I click on \"Reset template\" \"button\" in the \"Reset template?\" \"dialogue\"",
          "",
          "[Added Lines]",
          "127:     And I click on \"Reset\" \"button\" in the \"Reset template?\" \"dialogue\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "132:     And I should not see \"New footer!\"",
          "133:     And I should see \"Student entry 1\"",
          "134:     And I should see \"Some content 1\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "136:   @javascript",
          "137:   Scenario: Reset all database templates using the action menu",
          "138:     Given the following \"mod_data > templates\" exist:",
          "139:       | database | name            | content        |",
          "140:       | data1    | singletemplate  | Initial single |",
          "141:       | data1    | listtemplate    | Initial list   |",
          "142:       | data1    | addtemplate     | Initial add    |",
          "143:       | data1    | asearchtemplate | Initial search |",
          "144:     And I navigate to \"Database\" in current page administration",
          "145:     And I should see \"Initial list\"",
          "146:     And I should not see \"Student entry 1\"",
          "147:     And I should not see \"Some content 1\"",
          "148:     And I click on \"Advanced search\" \"checkbox\"",
          "149:     And I should see \"Initial search\"",
          "150:     And I set the field \"View mode tertiary navigation\" to \"Single view\"",
          "151:     And I should see \"Initial single\"",
          "152:     And I should not see \"Student entry 1\"",
          "153:     And I should not see \"Some content 1\"",
          "154:     And I click on \"Add entry\" \"button\"",
          "155:     And I should see \"Initial add\"",
          "156:     When I navigate to \"Templates\" in current page administration",
          "157:     And I click on \"Actions\" \"button\"",
          "158:     And I choose \"Reset all templates\" in the open action menu",
          "159:     And I click on \"Reset\" \"button\" in the \"Reset all templates?\" \"dialogue\"",
          "160:     Then I should see \"All templates reset\"",
          "161:     And I navigate to \"Database\" in current page administration",
          "162:     And I should not see \"Initial list\"",
          "163:     And I should see \"Student entry 1\"",
          "164:     And I should see \"Some content 1\"",
          "165:     And I click on \"Advanced search\" \"checkbox\"",
          "166:     And I should not see \"Initial search\"",
          "167:     And I set the field \"View mode tertiary navigation\" to \"Single view\"",
          "168:     And I should not see \"Initial single\"",
          "169:     And I should see \"Student entry 1\"",
          "170:     And I should see \"Some content 1\"",
          "171:     And I click on \"Add entry\" \"button\"",
          "172:     And I should not see \"Initial add\"",
          "174:   @javascript",
          "175:   Scenario: Reset all database templates using the reset template button",
          "176:     Given the following \"mod_data > templates\" exist:",
          "177:       | database | name            | content        |",
          "178:       | data1    | singletemplate  | Initial single |",
          "179:       | data1    | listtemplate    | Initial list   |",
          "180:       | data1    | addtemplate     | Initial add    |",
          "181:       | data1    | asearchtemplate | Initial search |",
          "182:     And I navigate to \"Database\" in current page administration",
          "183:     And I should see \"Initial list\"",
          "184:     And I should not see \"Student entry 1\"",
          "185:     And I should not see \"Some content 1\"",
          "186:     And I click on \"Advanced search\" \"checkbox\"",
          "187:     And I should see \"Initial search\"",
          "188:     And I set the field \"View mode tertiary navigation\" to \"Single view\"",
          "189:     And I should see \"Initial single\"",
          "190:     And I should not see \"Student entry 1\"",
          "191:     And I should not see \"Some content 1\"",
          "192:     And I click on \"Add entry\" \"button\"",
          "193:     And I should see \"Initial add\"",
          "194:     When I navigate to \"Templates\" in current page administration",
          "195:     And I click on \"Reset\" \"button\" in the \"sticky-footer\" \"region\"",
          "196:     And I click on \"Reset all templates\" \"checkbox\"",
          "197:     And I click on \"Reset\" \"button\" in the \"Reset template?\" \"dialogue\"",
          "198:     Then I should see \"All templates reset\"",
          "199:     And I navigate to \"Database\" in current page administration",
          "200:     And I should not see \"Initial list\"",
          "201:     And I should see \"Student entry 1\"",
          "202:     And I should see \"Some content 1\"",
          "203:     And I click on \"Advanced search\" \"checkbox\"",
          "204:     And I should not see \"Initial search\"",
          "205:     And I set the field \"View mode tertiary navigation\" to \"Single view\"",
          "206:     And I should not see \"Initial single\"",
          "207:     And I should see \"Student entry 1\"",
          "208:     And I should see \"Some content 1\"",
          "209:     And I click on \"Add entry\" \"button\"",
          "210:     And I should not see \"Initial add\"",
          "",
          "---------------"
        ],
        "mod/data/tests/manager_test.php||mod/data/tests/manager_test.php": [
          "File: mod/data/tests/manager_test.php -> mod/data/tests/manager_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use context_module;",
          "20: use moodle_url;",
          "21: use core_component;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: use stdClass;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "609:         $result = $manager->can_export_entries();",
          "610:         $this->assertEquals(true, $result);",
          "611:     }",
          "612: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "619:     public function test_reset_all_templates() {",
          "620:         global $DB;",
          "622:         $this->resetAfterTest();",
          "623:         $this->setAdminUser();",
          "626:         $course = $this->getDataGenerator()->create_course();",
          "627:         $instance = $this->getDataGenerator()->create_module(",
          "628:             'data',",
          "629:             ['course' => $course->id]",
          "630:         );",
          "631:         $manager = manager::create_from_instance($instance);",
          "634:         $initialtemplates = new stdClass();",
          "635:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "636:             $initialtemplates->$templatename = \"Initial $templatename\";",
          "637:         }",
          "638:         $manager->update_templates($initialtemplates);",
          "639:         $instance = $manager->get_instance();",
          "640:         $record = $DB->get_record('data', ['id' => $instance->id]);",
          "641:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "642:             $this->assertEquals($initialtemplates->$templatename, $instance->$templatename);",
          "643:             $this->assertEquals($initialtemplates->$templatename, $record->$templatename);",
          "644:         }",
          "647:         $result = $manager->reset_all_templates();",
          "648:         $this->assertTrue($result);",
          "649:         $instance = $manager->get_instance();",
          "650:         $record = $DB->get_record('data', ['id' => $instance->id]);",
          "651:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "652:             $this->assertEquals('', $instance->$templatename);",
          "653:             $this->assertEquals('', $record->$templatename);",
          "654:         }",
          "655:     }",
          "665:     public function test_reset_template(string $templatetoreset, array $expected) {",
          "666:         global $DB;",
          "668:         $this->resetAfterTest();",
          "669:         $this->setAdminUser();",
          "672:         $course = $this->getDataGenerator()->create_course();",
          "673:         $instance = $this->getDataGenerator()->create_module(",
          "674:             'data',",
          "675:             ['course' => $course->id]",
          "676:         );",
          "677:         $manager = manager::create_from_instance($instance);",
          "680:         $initialtemplates = new stdClass();",
          "681:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "682:             $initialtemplates->$templatename = \"Initial $templatename\";",
          "683:         }",
          "684:         $manager->update_templates($initialtemplates);",
          "685:         $instance = $manager->get_instance();",
          "686:         $record = $DB->get_record('data', ['id' => $instance->id]);",
          "687:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "688:             $this->assertEquals($initialtemplates->$templatename, $instance->$templatename);",
          "689:             $this->assertEquals($initialtemplates->$templatename, $record->$templatename);",
          "690:         }",
          "693:         $result = $manager->reset_template($templatetoreset);",
          "694:         $this->assertTrue($result);",
          "695:         $instance = $manager->get_instance();",
          "696:         $record = $DB->get_record('data', ['id' => $instance->id]);",
          "697:         foreach (manager::TEMPLATES_LIST as $templatename => $unused) {",
          "698:             if (in_array($templatename, $expected)) {",
          "699:                 $this->assertEquals('', $instance->$templatename);",
          "700:                 $this->assertEquals('', $record->$templatename);",
          "701:             } else {",
          "702:                 $this->assertEquals($initialtemplates->$templatename, $instance->$templatename);",
          "703:                 $this->assertEquals($initialtemplates->$templatename, $record->$templatename);",
          "704:             }",
          "705:         }",
          "706:     }",
          "713:     public function reset_template_provider(): array {",
          "714:         return [",
          "716:             'listtemplate' => [",
          "717:                 'templatename' => 'listtemplate',",
          "718:                 'expected' => ['listtemplate', 'listtemplateheader', 'listtemplatefooter'],",
          "719:             ],",
          "720:             'singletemplate' => [",
          "721:                 'templatename' => 'singletemplate',",
          "722:                 'expected' => ['singletemplate'],",
          "723:             ],",
          "724:             'asearchtemplate' => [",
          "725:                 'templatename' => 'asearchtemplate',",
          "726:                 'expected' => ['asearchtemplate'],",
          "727:             ],",
          "728:             'addtemplate' => [",
          "729:                 'templatename' => 'addtemplate',",
          "730:                 'expected' => ['addtemplate'],",
          "731:             ],",
          "732:             'rsstemplate' => [",
          "733:                 'templatename' => 'rsstemplate',",
          "734:                 'expected' => ['rsstemplate', 'rsstitletemplate'],",
          "735:             ],",
          "736:             'csstemplate' => [",
          "737:                 'templatename' => 'csstemplate',",
          "738:                 'expected' => ['csstemplate'],",
          "739:             ],",
          "740:             'jstemplate' => [",
          "741:                 'templatename' => 'jstemplate',",
          "742:                 'expected' => ['jstemplate'],",
          "743:             ],",
          "744:         ];",
          "745:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2d0c7359df2c1c3dfc8e25cdb6ed72b2c2a9a5d",
      "candidate_info": {
        "commit_hash": "c2d0c7359df2c1c3dfc8e25cdb6ed72b2c2a9a5d",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c2d0c7359df2c1c3dfc8e25cdb6ed72b2c2a9a5d",
        "files": [
          "mod/data/classes/output/action_bar.php",
          "mod/data/templates.php"
        ],
        "message": "MDL-77008 mod_data: require sesskey to reset module templates.",
        "before_after_code_files": [
          "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php",
          "mod/dattemplates.php||mod/data/templates.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php",
            "mod/dattemplates.php||mod/data/templates.php"
          ],
          "candidate": [
            "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php",
            "mod/dattemplates.php||mod/data/templates.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/datclasses/output/action_bar.php||mod/data/classes/output/action_bar.php": [
          "File: mod/datclasses/output/action_bar.php -> mod/data/classes/output/action_bar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "201:         $resetallurl->params([",
          "202:             'action' => 'resetalltemplates',",
          "203:             'sesskey' => sesskey(),",
          "204:         ]);",
          "",
          "---------------"
        ],
        "mod/dattemplates.php||mod/data/templates.php": [
          "File: mod/dattemplates.php -> mod/data/templates.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "60: if ($action == 'resetalltemplates') {",
          "61:     require_sesskey();",
          "62:     $manager->reset_all_templates();",
          "63:     redirect($PAGE->url, get_string('templateresetall', 'mod_data'), null, \\core\\output\\notification::NOTIFY_SUCCESS);",
          "64: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}