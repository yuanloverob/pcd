{
  "cve_id": "CVE-2024-24810",
  "cve_desc": "WiX toolset lets developers create installers for Windows Installer, the Windows installation engine. The .be TEMP folder is vulnerable to DLL redirection attacks that allow the attacker to escalate privileges. This impacts any installer built with the WiX installer framework. This issue has been patched in version 4.0.4.",
  "repo": "wixtoolset/wix",
  "patch_hash": "fec38b6461d0551339139a2fe52403a61942adc0",
  "patch_info": {
    "commit_hash": "fec38b6461d0551339139a2fe52403a61942adc0",
    "repo": "wixtoolset/wix",
    "commit_url": "https://github.com/wixtoolset/wix/commit/fec38b6461d0551339139a2fe52403a61942adc0",
    "files": [
      "src/burn/stub/precomp.h",
      "src/burn/stub/stub.cpp",
      "src/burn/stub/stub.vcxproj"
    ],
    "message": "Mitigate .local DLL redirection Windows bug.",
    "before_after_code_files": [
      "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
      "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp",
      "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
    ]
  },
  "patch_diff": {
    "src/burn/stub/precomp.h||src/burn/stub/precomp.h": [
      "File: src/burn/stub/precomp.h -> src/burn/stub/precomp.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #include <dutil.h>",
      "11: #include <apputil.h>",
      "12: #include <strutil.h>",
      "13: #include <fileutil.h>",
      "14: #include <pathutil.h>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "12: #include <dirutil.h>",
      "",
      "---------------"
    ],
    "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp": [
      "File: src/burn/stub/stub.cpp -> src/burn/stub/stub.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: #include \"precomp.h\"",
      "6: int WINAPI wWinMain(",
      "7:     __in HINSTANCE hInstance,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "5: static const HRESULT E_SUSPECTED_TAMPERING = MAKE_HRESULT(SEVERITY_ERROR, 500/*FACILITY_WIX*/, 2001);",
      "7: static void AvoidLocalDllRedirection(LPCWSTR wzPath);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "52:         AppInitialize(rgsczSafelyLoadSystemDlls, countof(rgsczSafelyLoadSystemDlls));",
      "53:     }",
      "56:     hr = EngineRun(hInstance, hEngineFile, lpCmdLine, nCmdShow, &dwExitCode);",
      "57:     ExitOnFailure(hr, \"Failed to run application.\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "59:     AvoidLocalDllRedirection(sczPath);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "64:     return FAILED(hr) ? (int)hr : (int)dwExitCode;",
      "65: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "73: static void AvoidLocalDllRedirection(LPCWSTR wzPath)",
      "74: {",
      "75:     LPWSTR sczLocalPath = NULL;",
      "76:     HMODULE hmodComCtl = NULL;",
      "82:     if (FAILED(StrAllocFormatted(&sczLocalPath, L\"%ls.local\", wzPath))",
      "83:         || DirExists(sczLocalPath, NULL)",
      "84:         || FileExistsEx(sczLocalPath, NULL)",
      "85:         || FAILED(LoadSystemLibrary(L\"Comctl32.dll\", &hmodComCtl)))",
      "86:     {",
      "87:         ::ExitProcess((UINT)E_SUSPECTED_TAMPERING);",
      "88:     }",
      "90:     ReleaseStr(sczLocalPath);",
      "91: }",
      "",
      "---------------"
    ],
    "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj": [
      "File: src/burn/stub/stub.vcxproj -> src/burn/stub/stub.vcxproj",
      "--- Hunk 1 ---",
      "[Context before]",
      "63:       <SwapRunFromCD>true</SwapRunFromCD>",
      "64:       <SwapRunFromNET>true</SwapRunFromNET>",
      "65:       <DelayLoadDLLs>cabinet.dll;crypt32.dll;msi.dll;shlwapi.dll;userenv.dll;version.dll;wininet.dll;wintrust.dll</DelayLoadDLLs>",
      "66:     </Link>",
      "67:   </ItemDefinitionGroup>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "66:       <AdditionalOptions>/DEPENDENTLOADFLAG:0x800 %(AdditionalOptions)</AdditionalOptions>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ce9ef4702cddf9a2398f6fbb7702988b662b5565",
      "candidate_info": {
        "commit_hash": "ce9ef4702cddf9a2398f6fbb7702988b662b5565",
        "repo": "wixtoolset/wix",
        "commit_url": "https://github.com/wixtoolset/wix/commit/ce9ef4702cddf9a2398f6fbb7702988b662b5565",
        "files": [
          "src/burn/stub/precomp.h",
          "src/burn/stub/stub.cpp"
        ],
        "message": "Mitigate .local DLL redirection Windows bug.",
        "before_after_code_files": [
          "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
          "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
            "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp"
          ],
          "candidate": [
            "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
            "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/burn/stub/precomp.h||src/burn/stub/precomp.h": [
          "File: src/burn/stub/precomp.h -> src/burn/stub/precomp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #include <dutil.h>",
          "11: #include <apputil.h>",
          "12: #include <strutil.h>",
          "13: #include <fileutil.h>",
          "14: #include <pathutil.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12: #include <dirutil.h>",
          "",
          "---------------"
        ],
        "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp": [
          "File: src/burn/stub/stub.cpp -> src/burn/stub/stub.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: #include \"precomp.h\"",
          "6: int WINAPI wWinMain(",
          "7:     __in HINSTANCE hInstance,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5: static const HRESULT E_SUSPECTED_TAMPERING = MAKE_HRESULT(SEVERITY_ERROR, 500/*FACILITY_WIX*/, 2001);",
          "7: static void AvoidLocalDllRedirection(LPCWSTR wzPath);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:         AppInitialize(rgsczSafelyLoadSystemDlls, countof(rgsczSafelyLoadSystemDlls));",
          "53:     }",
          "56:     hr = EngineRun(hInstance, hEngineFile, lpCmdLine, nCmdShow, &dwExitCode);",
          "57:     ExitOnFailure(hr, \"Failed to run application.\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:     AvoidLocalDllRedirection(sczPath);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "64:     return FAILED(hr) ? (int)hr : (int)dwExitCode;",
          "65: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73: static void AvoidLocalDllRedirection(LPCWSTR wzPath)",
          "74: {",
          "75:     LPWSTR sczLocalPath = NULL;",
          "76:     HMODULE hmodComCtl = NULL;",
          "82:     if (FAILED(StrAllocFormatted(&sczLocalPath, L\"%ls.local\", wzPath))",
          "83:         || DirExists(sczLocalPath, NULL)",
          "84:         || FileExistsEx(sczLocalPath, NULL)",
          "85:         || FAILED(LoadSystemLibrary(L\"Comctl32.dll\", &hmodComCtl)))",
          "86:     {",
          "87:         ::ExitProcess((UINT)E_SUSPECTED_TAMPERING);",
          "88:     }",
          "90:     ReleaseStr(sczLocalPath);",
          "91: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fec38b6461d0551339139a2fe52403a61942adc0",
      "candidate_info": {
        "commit_hash": "fec38b6461d0551339139a2fe52403a61942adc0",
        "repo": "wixtoolset/wix",
        "commit_url": "https://github.com/wixtoolset/wix/commit/fec38b6461d0551339139a2fe52403a61942adc0",
        "files": [
          "src/burn/stub/precomp.h",
          "src/burn/stub/stub.cpp",
          "src/burn/stub/stub.vcxproj"
        ],
        "message": "Mitigate .local DLL redirection Windows bug.",
        "before_after_code_files": [
          "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
          "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp",
          "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
            "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp",
            "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
          ],
          "candidate": [
            "src/burn/stub/precomp.h||src/burn/stub/precomp.h",
            "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp",
            "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
          ]
        }
      },
      "candidate_diff": {
        "src/burn/stub/precomp.h||src/burn/stub/precomp.h": [
          "File: src/burn/stub/precomp.h -> src/burn/stub/precomp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #include <dutil.h>",
          "11: #include <apputil.h>",
          "12: #include <strutil.h>",
          "13: #include <fileutil.h>",
          "14: #include <pathutil.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12: #include <dirutil.h>",
          "",
          "---------------"
        ],
        "src/burn/stub/stub.cpp||src/burn/stub/stub.cpp": [
          "File: src/burn/stub/stub.cpp -> src/burn/stub/stub.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: #include \"precomp.h\"",
          "6: int WINAPI wWinMain(",
          "7:     __in HINSTANCE hInstance,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5: static const HRESULT E_SUSPECTED_TAMPERING = MAKE_HRESULT(SEVERITY_ERROR, 500/*FACILITY_WIX*/, 2001);",
          "7: static void AvoidLocalDllRedirection(LPCWSTR wzPath);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:         AppInitialize(rgsczSafelyLoadSystemDlls, countof(rgsczSafelyLoadSystemDlls));",
          "53:     }",
          "56:     hr = EngineRun(hInstance, hEngineFile, lpCmdLine, nCmdShow, &dwExitCode);",
          "57:     ExitOnFailure(hr, \"Failed to run application.\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:     AvoidLocalDllRedirection(sczPath);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "64:     return FAILED(hr) ? (int)hr : (int)dwExitCode;",
          "65: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73: static void AvoidLocalDllRedirection(LPCWSTR wzPath)",
          "74: {",
          "75:     LPWSTR sczLocalPath = NULL;",
          "76:     HMODULE hmodComCtl = NULL;",
          "82:     if (FAILED(StrAllocFormatted(&sczLocalPath, L\"%ls.local\", wzPath))",
          "83:         || DirExists(sczLocalPath, NULL)",
          "84:         || FileExistsEx(sczLocalPath, NULL)",
          "85:         || FAILED(LoadSystemLibrary(L\"Comctl32.dll\", &hmodComCtl)))",
          "86:     {",
          "87:         ::ExitProcess((UINT)E_SUSPECTED_TAMPERING);",
          "88:     }",
          "90:     ReleaseStr(sczLocalPath);",
          "91: }",
          "",
          "---------------"
        ],
        "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj": [
          "File: src/burn/stub/stub.vcxproj -> src/burn/stub/stub.vcxproj",
          "--- Hunk 1 ---",
          "[Context before]",
          "63:       <SwapRunFromCD>true</SwapRunFromCD>",
          "64:       <SwapRunFromNET>true</SwapRunFromNET>",
          "65:       <DelayLoadDLLs>cabinet.dll;crypt32.dll;msi.dll;shlwapi.dll;userenv.dll;version.dll;wininet.dll;wintrust.dll</DelayLoadDLLs>",
          "66:     </Link>",
          "67:   </ItemDefinitionGroup>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "66:       <AdditionalOptions>/DEPENDENTLOADFLAG:0x800 %(AdditionalOptions)</AdditionalOptions>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "59ca47751ea1d59198e01b7e6a0a3d9fc144088e",
      "candidate_info": {
        "commit_hash": "59ca47751ea1d59198e01b7e6a0a3d9fc144088e",
        "repo": "wixtoolset/wix",
        "commit_url": "https://github.com/wixtoolset/wix/commit/59ca47751ea1d59198e01b7e6a0a3d9fc144088e",
        "files": [
          "src/burn/stub/stub.vcxproj"
        ],
        "message": "Use `/DEPENDENTLOADFLAG` to tell the loader...\n\n...to load DLLs from System32 only.\n\n(Belt and suspenders to current approaches.) See\nhttps://devblogs.microsoft.com/oldnewthing/20230328-00/?p=107978.\n\nFixes https://github.com/wixtoolset/issues/issues/7319.",
        "before_after_code_files": [
          "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
          ],
          "candidate": [
            "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj"
          ]
        }
      },
      "candidate_diff": {
        "src/burn/stub/stub.vcxproj||src/burn/stub/stub.vcxproj": [
          "File: src/burn/stub/stub.vcxproj -> src/burn/stub/stub.vcxproj",
          "--- Hunk 1 ---",
          "[Context before]",
          "63:       <SwapRunFromCD>true</SwapRunFromCD>",
          "64:       <SwapRunFromNET>true</SwapRunFromNET>",
          "65:       <DelayLoadDLLs>cabinet.dll;crypt32.dll;msi.dll;shlwapi.dll;userenv.dll;version.dll;wininet.dll;wintrust.dll</DelayLoadDLLs>",
          "66:     </Link>",
          "67:   </ItemDefinitionGroup>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "66:       <AdditionalOptions>/DEPENDENTLOADFLAG:0x800 %(AdditionalOptions)</AdditionalOptions>",
          "",
          "---------------"
        ]
      }
    }
  ]
}