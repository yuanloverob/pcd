{
  "cve_id": "CVE-2023-5544",
  "cve_desc": "Wiki comments required additional sanitizing and access restrictions to prevent a stored XSS risk and potential IDOR risk.",
  "repo": "moodle/moodle",
  "patch_hash": "5fec728be9df3c9fc282cd0897c73ca5cfcfea5f",
  "patch_info": {
    "commit_hash": "5fec728be9df3c9fc282cd0897c73ca5cfcfea5f",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/5fec728be9df3c9fc282cd0897c73ca5cfcfea5f",
    "files": [
      "mod/wiki/editcomments.php",
      "mod/wiki/pagelib.php"
    ],
    "message": "MDL-79509 mod_wiki: Improve comment editing",
    "before_after_code_files": [
      "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
      "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
    ]
  },
  "patch_diff": {
    "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
      "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
      "65:         throw new \\moodle_exception('invalidcomment');",
      "66:     }",
      "67: }",
      "69: $editcomments->set_page($page);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "67:     if ($USER->id != $comment->userid) {",
      "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
      "69:     }",
      "",
      "---------------"
    ],
    "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
      "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "836:         if ($this->format == 'html') {",
      "837:             $com->action = 'edit';",
      "839:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
      "841:             $this->form->set_data($com);",
      "",
      "[Removed Lines]",
      "838:             $com->entrycomment_editor['text'] = $com->content;",
      "",
      "[Added Lines]",
      "838:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fce36ecf4fa338231cda911ce899c709f642e42c",
      "candidate_info": {
        "commit_hash": "fce36ecf4fa338231cda911ce899c709f642e42c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/fce36ecf4fa338231cda911ce899c709f642e42c",
        "files": [
          "mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php"
        ],
        "message": "MDL-79509 mod_wiki: Improve comment editing",
        "before_after_code_files": [
          "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ],
          "candidate": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
          "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
          "65:         throw new \\moodle_exception('invalidcomment');",
          "66:     }",
          "67: }",
          "69: $editcomments->set_page($page);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67:     if ($USER->id != $comment->userid) {",
          "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
          "69:     }",
          "",
          "---------------"
        ],
        "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
          "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "836:         if ($this->format == 'html') {",
          "837:             $com->action = 'edit';",
          "839:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
          "841:             $this->form->set_data($com);",
          "",
          "[Removed Lines]",
          "838:             $com->entrycomment_editor['text'] = $com->content;",
          "",
          "[Added Lines]",
          "838:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5ff2f6ab2be8acd77d5e6c395a5f6c54139ff59",
      "candidate_info": {
        "commit_hash": "c5ff2f6ab2be8acd77d5e6c395a5f6c54139ff59",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c5ff2f6ab2be8acd77d5e6c395a5f6c54139ff59",
        "files": [
          "mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php"
        ],
        "message": "MDL-79509 mod_wiki: Improve comment editing",
        "before_after_code_files": [
          "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ],
          "candidate": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
          "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
          "65:         print_error('invalidcomment');",
          "66:     }",
          "67: }",
          "69: $editcomments->set_page($page);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67:     if ($USER->id != $comment->userid) {",
          "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
          "69:     }",
          "",
          "---------------"
        ],
        "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
          "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "798:         if ($this->format == 'html') {",
          "799:             $com->action = 'edit';",
          "801:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
          "803:             $this->form->set_data($com);",
          "",
          "[Removed Lines]",
          "800:             $com->entrycomment_editor['text'] = $com->content;",
          "",
          "[Added Lines]",
          "800:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b0f1c1afe49460c5e53b09f434090fc4c2a48cd1",
      "candidate_info": {
        "commit_hash": "b0f1c1afe49460c5e53b09f434090fc4c2a48cd1",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b0f1c1afe49460c5e53b09f434090fc4c2a48cd1",
        "files": [
          "mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php"
        ],
        "message": "MDL-79509 mod_wiki: Improve comment editing",
        "before_after_code_files": [
          "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ],
          "candidate": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
          "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
          "65:         print_error('invalidcomment');",
          "66:     }",
          "67: }",
          "69: $editcomments->set_page($page);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67:     if ($USER->id != $comment->userid) {",
          "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
          "69:     }",
          "",
          "---------------"
        ],
        "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
          "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "798:         if ($this->format == 'html') {",
          "799:             $com->action = 'edit';",
          "801:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
          "803:             $this->form->set_data($com);",
          "",
          "[Removed Lines]",
          "800:             $com->entrycomment_editor['text'] = $com->content;",
          "",
          "[Added Lines]",
          "800:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4777e96a28ee12d8ae545feec424d129726b0eeb",
      "candidate_info": {
        "commit_hash": "4777e96a28ee12d8ae545feec424d129726b0eeb",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4777e96a28ee12d8ae545feec424d129726b0eeb",
        "files": [
          "mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php"
        ],
        "message": "MDL-79509 mod_wiki: Improve comment editing",
        "before_after_code_files": [
          "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ],
          "candidate": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
          "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
          "65:         print_error('invalidcomment');",
          "66:     }",
          "67: }",
          "69: $editcomments->set_page($page);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67:     if ($USER->id != $comment->userid) {",
          "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
          "69:     }",
          "",
          "---------------"
        ],
        "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
          "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "836:         if ($this->format == 'html') {",
          "837:             $com->action = 'edit';",
          "839:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
          "841:             $this->form->set_data($com);",
          "",
          "[Removed Lines]",
          "838:             $com->entrycomment_editor['text'] = $com->content;",
          "",
          "[Added Lines]",
          "838:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "924fa47b5bb11aa79a4fae6f899eb05c423b0013",
      "candidate_info": {
        "commit_hash": "924fa47b5bb11aa79a4fae6f899eb05c423b0013",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/924fa47b5bb11aa79a4fae6f899eb05c423b0013",
        "files": [
          "mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php"
        ],
        "message": "MDL-79509 mod_wiki: Improve comment editing",
        "before_after_code_files": [
          "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
          "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ],
          "candidate": [
            "mod/wiki/editcomments.php||mod/wiki/editcomments.php",
            "mod/wiki/pagelib.php||mod/wiki/pagelib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/wiki/editcomments.php||mod/wiki/editcomments.php": [
          "File: mod/wiki/editcomments.php -> mod/wiki/editcomments.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     if (!$comment = $DB->get_record('comments', array('id' => $commentid))) {",
          "65:         throw new \\moodle_exception('invalidcomment');",
          "66:     }",
          "67: }",
          "69: $editcomments->set_page($page);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67:     if ($USER->id != $comment->userid) {",
          "68:         throw new \\moodle_exception('cannotviewpage', 'wiki');",
          "69:     }",
          "",
          "---------------"
        ],
        "mod/wiki/pagelib.php||mod/wiki/pagelib.php": [
          "File: mod/wiki/pagelib.php -> mod/wiki/pagelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "836:         if ($this->format == 'html') {",
          "837:             $com->action = 'edit';",
          "839:             $com->commentoptions = array('trusttext' => true, 'maxfiles' => 0);",
          "841:             $this->form->set_data($com);",
          "",
          "[Removed Lines]",
          "838:             $com->entrycomment_editor['text'] = $com->content;",
          "",
          "[Added Lines]",
          "838:             $com->entrycomment_editor['text'] = clean_text($com->content, $this->format);",
          "",
          "---------------"
        ]
      }
    }
  ]
}