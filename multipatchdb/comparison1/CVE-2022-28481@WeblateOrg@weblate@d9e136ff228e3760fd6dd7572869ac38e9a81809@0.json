{
  "cve_id": "CVE-2022-28481",
  "cve_desc": "CSV-Safe gem < 3.0.0 doesn't filter out special characters which could trigger CSV Injection.",
  "repo": "WeblateOrg/weblate",
  "patch_hash": "d9e136ff228e3760fd6dd7572869ac38e9a81809",
  "patch_info": {
    "commit_hash": "d9e136ff228e3760fd6dd7572869ac38e9a81809",
    "repo": "WeblateOrg/weblate",
    "commit_url": "https://github.com/WeblateOrg/weblate/commit/d9e136ff228e3760fd6dd7572869ac38e9a81809",
    "files": [
      "weblate/trans/exporters.py"
    ],
    "message": "Improve filter on CSV formulas\n\nIt seems that Excel is interpreting way more than I originally thought.\n\nFixes https://hackerone.com/reports/223999\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
    "before_after_code_files": [
      "weblate/trans/exporters.py||weblate/trans/exporters.py"
    ]
  },
  "patch_diff": {
    "weblate/trans/exporters.py||weblate/trans/exporters.py": [
      "File: weblate/trans/exporters.py -> weblate/trans/exporters.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "279:         used at first position of translatable strings, so the harm is not",
      "280:         that big.",
      "281:         \"\"\"",
      "284:         return text",
      "",
      "[Removed Lines]",
      "282:         if text and text[0] in ('=', '+', '-', '@'):",
      "283:             return \"'\" + text",
      "",
      "[Added Lines]",
      "282:         if text and text[0] in ('=', '+', '-', '@', '|', '%'):",
      "283:             return \"'{0}'\".format(text.replace('|', '\\|'))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0939b7715ab5166f4505c0bc2f82ffc7b1700f65",
      "candidate_info": {
        "commit_hash": "0939b7715ab5166f4505c0bc2f82ffc7b1700f65",
        "repo": "WeblateOrg/weblate",
        "commit_url": "https://github.com/WeblateOrg/weblate/commit/0939b7715ab5166f4505c0bc2f82ffc7b1700f65",
        "files": [
          "weblate/trans/exporters.py"
        ],
        "message": "Add forgotten escaping\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
        "before_after_code_files": [
          "weblate/trans/exporters.py||weblate/trans/exporters.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "weblate/trans/exporters.py||weblate/trans/exporters.py"
          ],
          "candidate": [
            "weblate/trans/exporters.py||weblate/trans/exporters.py"
          ]
        }
      },
      "candidate_diff": {
        "weblate/trans/exporters.py||weblate/trans/exporters.py": [
          "File: weblate/trans/exporters.py -> weblate/trans/exporters.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "280:         that big.",
          "281:         \"\"\"",
          "282:         if text and text[0] in ('=', '+', '-', '@', '|', '%'):",
          "284:         return text",
          "",
          "[Removed Lines]",
          "283:             return \"'{0}'\".format(text.replace('|', '\\|'))",
          "",
          "[Added Lines]",
          "283:             return \"'{0}'\".format(text.replace('|', '\\\\|'))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1216f65655ca4b3f32b9d59605eb4446d503bdbf",
      "candidate_info": {
        "commit_hash": "1216f65655ca4b3f32b9d59605eb4446d503bdbf",
        "repo": "WeblateOrg/weblate",
        "commit_url": "https://github.com/WeblateOrg/weblate/commit/1216f65655ca4b3f32b9d59605eb4446d503bdbf",
        "files": [
          "docs/changes.rst",
          "weblate/trans/exporters.py",
          "weblate/trans/tests/test_exporters.py"
        ],
        "message": "The CSV exports now escape potential formulas.\n\nFixes https://hackerone.com/reports/223344\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
        "before_after_code_files": [
          "weblate/trans/exporters.py||weblate/trans/exporters.py",
          "weblate/trans/tests/test_exporters.py||weblate/trans/tests/test_exporters.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "weblate/trans/exporters.py||weblate/trans/exporters.py"
          ],
          "candidate": [
            "weblate/trans/exporters.py||weblate/trans/exporters.py"
          ]
        }
      },
      "candidate_diff": {
        "weblate/trans/exporters.py||weblate/trans/exporters.py": [
          "File: weblate/trans/exporters.py -> weblate/trans/exporters.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "270:     def get_storage(self):",
          "271:         return csvfile()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "273:     def string_filter(self, text):",
          "274:         \"\"\"Avoid Excel interpreting text as formula.",
          "276:         This is really bad idea implemented in Excel as this change leads",
          "277:         to displaying additional ' in all other tools, but this seems to be",
          "278:         what most people are get used to. Hopefully these chars are not widely",
          "279:         used at first position of translatable strings, so the harm is not",
          "280:         that big.",
          "281:         \"\"\"",
          "282:         if text and text[0] in ('=', '+', '-', '@'):",
          "283:             return \"'\" + text",
          "284:         return text",
          "",
          "---------------"
        ],
        "weblate/trans/tests/test_exporters.py||weblate/trans/tests/test_exporters.py": [
          "File: weblate/trans/tests/test_exporters.py -> weblate/trans/tests/test_exporters.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "193:     def check_plurals(self, result):",
          "194:         # Doesn't support plurals",
          "195:         pass",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "197:     def test_escaping(self):",
          "198:         output = self.check_unit(",
          "199:             source='=HYPERLINK(\"https://weblate.org/\"&A1, \"Weblate\")',",
          "200:             target='yyy',",
          "201:         )",
          "202:         self.assertIn('\"\\'=HYPERLINK', output)",
          "",
          "---------------"
        ]
      }
    }
  ]
}