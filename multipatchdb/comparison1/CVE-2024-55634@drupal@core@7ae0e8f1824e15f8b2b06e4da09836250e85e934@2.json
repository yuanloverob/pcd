{
  "cve_id": "CVE-2024-55634",
  "cve_desc": "A vulnerability in Drupal Core allows Privilege Escalation.This issue affects Drupal Core: from 8.0.0 before 10.2.11, from 10.3.0 before 10.3.9, from 11.0.0 before 11.0.8.",
  "repo": "drupal/core",
  "patch_hash": "7ae0e8f1824e15f8b2b06e4da09836250e85e934",
  "patch_info": {
    "commit_hash": "7ae0e8f1824e15f8b2b06e4da09836250e85e934",
    "repo": "drupal/core",
    "commit_url": "https://github.com/drupal/core/commit/7ae0e8f1824e15f8b2b06e4da09836250e85e934",
    "files": [
      "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
      "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
      "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
      "modules/user/user.install"
    ],
    "message": "SA-CORE-2024-004 by zengenuity, cilefen, kristiaanvandeneynde, mcdruid, larowlan",
    "before_after_code_files": [
      "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
      "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
      "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
      "modules/user/user.install||modules/user/user.install"
    ]
  },
  "patch_diff": {
    "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php": [
      "File: lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php -> lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "18:   public $message = 'A @entity_type with @field_name %value already exists.';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "28:   public $caseSensitive = FALSE;",
      "",
      "---------------"
    ],
    "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php": [
      "File: lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php -> lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "64:       ->getStorage($entity_type_id)",
      "65:       ->getAggregateQuery()",
      "66:       ->accessCheck(FALSE)",
      "68:       ->groupBy(\"$field_name.$property_name\");",
      "69:     if (!$is_new) {",
      "70:       $entity_id = $entity->id();",
      "71:       $query->condition($id_key, $entity_id, '<>');",
      "72:     }",
      "73:     $results = $query->execute();",
      "75:     if (!empty($results)) {",
      "",
      "[Removed Lines]",
      "67:       ->condition($field_name, $item_values, 'IN')",
      "",
      "[Added Lines]",
      "73:     if ($constraint->caseSensitive) {",
      "74:       $query->condition($field_name, $item_values, 'IN');",
      "75:     }",
      "76:     else {",
      "77:       $or_group = $query->orConditionGroup();",
      "78:       foreach ($item_values as $item_value) {",
      "79:         $or_group->condition($field_name, \\Drupal::database()->escapeLike($item_value), 'LIKE');",
      "80:       }",
      "81:       $query->condition($or_group);",
      "82:     }",
      "",
      "---------------"
    ],
    "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php": [
      "File: modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php -> modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: use Drupal\\Core\\StringTranslation\\TranslatableMarkup;",
      "6: use Drupal\\Core\\Validation\\Attribute\\Constraint;",
      "",
      "[Removed Lines]",
      "7: use Symfony\\Component\\Validator\\Constraint as SymfonyConstraint;",
      "",
      "[Added Lines]",
      "7: use Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldConstraint;",
      "8: use Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldValueValidator;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "13:   id: 'FileUriUnique',",
      "14:   label: new TranslatableMarkup('File URI', [], ['context' => 'Validation'])",
      "15: )]",
      "18:   public $message = 'The file %value already exists. Enter a unique file URI.';",
      "23:   public function validatedBy(): string {",
      "25:   }",
      "27: }",
      "",
      "[Removed Lines]",
      "16: class FileUriUnique extends SymfonyConstraint {",
      "24:     return '\\Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldValueValidator';",
      "",
      "[Added Lines]",
      "17: class FileUriUnique extends UniqueFieldConstraint {",
      "29:   public $caseSensitive = TRUE;",
      "35:     return UniqueFieldValueValidator::class;",
      "",
      "---------------"
    ],
    "modules/user/user.install||modules/user/user.install": [
      "File: modules/user/user.install -> modules/user/user.install",
      "--- Hunk 1 ---",
      "[Context before]",
      "98:   if ($phase !== 'runtime') {",
      "99:     return [];",
      "100:   }",
      "102:   $result = (bool) \\Drupal::entityQuery('user')",
      "103:     ->accessCheck(FALSE)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "101:   $return = [];",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "106:     ->execute();",
      "108:   if ($result === FALSE) {",
      "117:     ];",
      "118:   }",
      "120: }",
      "",
      "[Removed Lines]",
      "109:     return [",
      "110:       'anonymous user' => [",
      "111:         'title' => t('Anonymous user'),",
      "112:         'description' => t('The anonymous user does not exist. See the <a href=\":url\">restore the anonymous (user ID 0) user record</a> for more information', [",
      "113:           ':url' => 'https://www.drupal.org/node/1029506',",
      "114:         ]),",
      "115:         'severity' => REQUIREMENT_WARNING,",
      "116:       ],",
      "119:   return [];",
      "",
      "[Added Lines]",
      "110:     $return['anonymous user'] = [",
      "111:       'title' => t('Anonymous user'),",
      "112:       'description' => t('The anonymous user does not exist. See the <a href=\":url\">restore the anonymous (user ID 0) user record</a> for more information', [",
      "113:         ':url' => 'https://www.drupal.org/node/1029506',",
      "114:       ]),",
      "115:       'severity' => REQUIREMENT_WARNING,",
      "116:     ];",
      "117:   }",
      "119:   $query = \\Drupal::database()->select('users_field_data');",
      "120:   $query->addExpression('LOWER(mail)', 'lower_mail');",
      "121:   $query->groupBy('lower_mail');",
      "122:   $query->having('COUNT(uid) > :matches', [':matches' => 1]);",
      "123:   $conflicts = $query->countQuery()->execute()->fetchField();",
      "125:   if ($conflicts > 0) {",
      "126:     $return['conflicting emails'] = [",
      "127:       'title' => t('Conflicting user emails'),",
      "128:       'description' => t('Some user accounts have email addresses that differ only by case. For example, one account might have alice@example.com and another might have Alice@Example.com. See <a href=\":url\">Conflicting User Emails</a> for more information.', [",
      "129:         ':url' => 'https://www.drupal.org/node/3486109',",
      "130:       ]),",
      "131:       'severity' => REQUIREMENT_WARNING,",
      "135:   return $return;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "13e9e9e182e754c2214f2ded1f2571e2ffd4883d",
      "candidate_info": {
        "commit_hash": "13e9e9e182e754c2214f2ded1f2571e2ffd4883d",
        "repo": "drupal/core",
        "commit_url": "https://github.com/drupal/core/commit/13e9e9e182e754c2214f2ded1f2571e2ffd4883d",
        "files": [
          "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
          "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
          "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
          "modules/user/user.install"
        ],
        "message": "SA-CORE-2024-004 by zengenuity, cilefen, kristiaanvandeneynde, mcdruid, larowlan",
        "before_after_code_files": [
          "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
          "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
          "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
          "modules/user/user.install||modules/user/user.install"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
            "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
            "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
            "modules/user/user.install||modules/user/user.install"
          ],
          "candidate": [
            "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
            "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
            "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
            "modules/user/user.install||modules/user/user.install"
          ]
        }
      },
      "candidate_diff": {
        "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php": [
          "File: lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php -> lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldConstraint.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "18:   public $message = 'A @entity_type with @field_name %value already exists.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28:   public $caseSensitive = FALSE;",
          "",
          "---------------"
        ],
        "lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php||lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php": [
          "File: lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php -> lib/Drupal/Core/Validation/Plugin/Validation/Constraint/UniqueFieldValueValidator.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:       ->getStorage($entity_type_id)",
          "65:       ->getAggregateQuery()",
          "66:       ->accessCheck(FALSE)",
          "68:       ->groupBy(\"$field_name.$property_name\");",
          "69:     if (!$is_new) {",
          "70:       $entity_id = $entity->id();",
          "71:       $query->condition($id_key, $entity_id, '<>');",
          "72:     }",
          "73:     $results = $query->execute();",
          "75:     if (!empty($results)) {",
          "",
          "[Removed Lines]",
          "67:       ->condition($field_name, $item_values, 'IN')",
          "",
          "[Added Lines]",
          "73:     if ($constraint->caseSensitive) {",
          "74:       $query->condition($field_name, $item_values, 'IN');",
          "75:     }",
          "76:     else {",
          "77:       $or_group = $query->orConditionGroup();",
          "78:       foreach ($item_values as $item_value) {",
          "79:         $or_group->condition($field_name, \\Drupal::database()->escapeLike($item_value), 'LIKE');",
          "80:       }",
          "81:       $query->condition($or_group);",
          "82:     }",
          "",
          "---------------"
        ],
        "modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php||modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php": [
          "File: modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php -> modules/file/src/Plugin/Validation/Constraint/FileUriUnique.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Drupal\\Core\\StringTranslation\\TranslatableMarkup;",
          "6: use Drupal\\Core\\Validation\\Attribute\\Constraint;",
          "",
          "[Removed Lines]",
          "7: use Symfony\\Component\\Validator\\Constraint as SymfonyConstraint;",
          "",
          "[Added Lines]",
          "7: use Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldConstraint;",
          "8: use Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldValueValidator;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "13:   id: 'FileUriUnique',",
          "14:   label: new TranslatableMarkup('File URI', [], ['context' => 'Validation'])",
          "15: )]",
          "18:   public $message = 'The file %value already exists. Enter a unique file URI.';",
          "25:   }",
          "27: }",
          "",
          "[Removed Lines]",
          "16: class FileUriUnique extends SymfonyConstraint {",
          "23:   public function validatedBy() {",
          "24:     return '\\Drupal\\Core\\Validation\\Plugin\\Validation\\Constraint\\UniqueFieldValueValidator';",
          "",
          "[Added Lines]",
          "17: class FileUriUnique extends UniqueFieldConstraint {",
          "29:   public $caseSensitive = TRUE;",
          "34:   public function validatedBy(): string {",
          "35:     return UniqueFieldValueValidator::class;",
          "",
          "---------------"
        ],
        "modules/user/user.install||modules/user/user.install": [
          "File: modules/user/user.install -> modules/user/user.install",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:   if ($phase !== 'runtime') {",
          "101:     return [];",
          "102:   }",
          "104:   $result = (bool) \\Drupal::entityQuery('user')",
          "105:     ->accessCheck(FALSE)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:   $return = [];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108:     ->execute();",
          "110:   if ($result === FALSE) {",
          "119:     ];",
          "120:   }",
          "122: }",
          "",
          "[Removed Lines]",
          "111:     return [",
          "112:       'anonymous user' => [",
          "113:         'title' => t('Anonymous user'),",
          "114:         'description' => t('The anonymous user does not exist. See the <a href=\":url\">restore the anonymous (user ID 0) user record</a> for more information', [",
          "115:           ':url' => 'https://www.drupal.org/node/1029506',",
          "116:         ]),",
          "117:         'severity' => REQUIREMENT_WARNING,",
          "118:       ],",
          "121:   return [];",
          "",
          "[Added Lines]",
          "112:     $return['anonymous user'] = [",
          "113:       'title' => t('Anonymous user'),",
          "114:       'description' => t('The anonymous user does not exist. See the <a href=\":url\">restore the anonymous (user ID 0) user record</a> for more information', [",
          "115:         ':url' => 'https://www.drupal.org/node/1029506',",
          "116:       ]),",
          "117:       'severity' => REQUIREMENT_WARNING,",
          "118:     ];",
          "119:   }",
          "121:   $query = \\Drupal::database()->select('users_field_data');",
          "122:   $query->addExpression('LOWER(mail)', 'lower_mail');",
          "123:   $query->groupBy('lower_mail');",
          "124:   $query->having('COUNT(uid) > :matches', [':matches' => 1]);",
          "125:   $conflicts = $query->countQuery()->execute()->fetchField();",
          "127:   if ($conflicts > 0) {",
          "128:     $return['conflicting emails'] = [",
          "129:       'title' => t('Conflicting user emails'),",
          "130:       'description' => t('Some user accounts have email addresses that differ only by case. For example, one account might have alice@example.com and another might have Alice@Example.com. See <a href=\":url\">Conflicting User Emails</a> for more information.', [",
          "131:         ':url' => 'https://www.drupal.org/node/3486109',",
          "132:       ]),",
          "133:       'severity' => REQUIREMENT_WARNING,",
          "137:   return $return;",
          "",
          "---------------"
        ]
      }
    }
  ]
}