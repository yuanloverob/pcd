{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "19069c7f28dd554a3c78e729b15f08876f6e214a",
      "candidate_info": {
        "commit_hash": "19069c7f28dd554a3c78e729b15f08876f6e214a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/19069c7f28dd554a3c78e729b15f08876f6e214a",
        "files": [
          "admin/tool/behat/tests/behat/edit_permissions.feature",
          "blocks/community/block_community.php",
          "lang/en/error.php",
          "version.php"
        ],
        "message": "MDL-66120 block_community: Disable community block and related caps\n\nDisable community block access",
        "before_after_code_files": [
          "admin/tool/behat/tests/behat/edit_permissions.feature||admin/tool/behat/tests/behat/edit_permissions.feature",
          "blocks/community/block_community.php||blocks/community/block_community.php",
          "lang/en/error.php||lang/en/error.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/behat/tests/behat/edit_permissions.feature||admin/tool/behat/tests/behat/edit_permissions.feature": [
          "File: admin/tool/behat/tests/behat/edit_permissions.feature -> admin/tool/behat/tests/behat/edit_permissions.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "20:     And I set the following system permissions of \"Teacher\" role:",
          "21:       | capability | permission |",
          "22:       | block/mnet_hosts:myaddinstance | Allow |",
          "24:       | moodle/grade:managesharedforms | Prevent |",
          "25:       | moodle/course:request | Prohibit |",
          "26:     When I follow \"Edit Teacher role\"",
          "27:     Then \"block/mnet_hosts:myaddinstance\" capability has \"Allow\" permission",
          "29:     And \"moodle/grade:managesharedforms\" capability has \"Prevent\" permission",
          "30:     And \"moodle/course:request\" capability has \"Prohibit\" permission",
          "",
          "[Removed Lines]",
          "23:       | moodle/community:add | Inherit |",
          "28:     And \"moodle/community:add\" capability has \"Not set\" permission",
          "",
          "[Added Lines]",
          "23:       | moodle/site:messageanyuser | Inherit |",
          "28:     And \"moodle/site:messageanyuser\" capability has \"Not set\" permission",
          "",
          "---------------"
        ],
        "blocks/community/block_community.php||blocks/community/block_community.php": [
          "File: blocks/community/block_community.php -> blocks/community/block_community.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     }",
          "50:     function get_content() {",
          "60:         $this->content = new stdClass();",
          "61:         $this->content->items = array();",
          "62:         $this->content->icons = array();",
          "63:         $this->content->footer = '';",
          "100:         return $this->content;",
          "101:     }",
          "",
          "[Removed Lines]",
          "51:         global $CFG, $OUTPUT, $USER;",
          "53:         $coursecontext = context::instance_by_id($this->instance->parentcontextid);",
          "55:         if (!has_capability('moodle/community:add', $coursecontext)",
          "56:                 or $this->content !== NULL) {",
          "57:             return $this->content;",
          "58:         }",
          "65:         if (!isloggedin()) {",
          "66:             return $this->content;",
          "67:         }",
          "69:         $icon = $OUTPUT->pix_icon('i/group', get_string('group'));",
          "70:         $addcourseurl = new moodle_url('/blocks/community/communitycourse.php',",
          "71:                         array('add' => true, 'courseid' => $this->page->course->id));",
          "72:         $searchlink = html_writer::tag('a', $icon . get_string('addcourse', 'block_community'),",
          "73:                         array('href' => $addcourseurl->out(false)));",
          "74:         $this->content->items[] = $searchlink;",
          "76:         require_once($CFG->dirroot . '/blocks/community/locallib.php');",
          "77:         $communitymanager = new block_community_manager();",
          "78:         $courses = $communitymanager->block_community_get_courses($USER->id);",
          "79:         if ($courses) {",
          "80:             $this->content->items[] = html_writer::empty_tag('hr');",
          "81:             $this->content->icons[] = '';",
          "82:             $this->content->items[] = get_string('mycommunities', 'block_community');",
          "83:             $this->content->icons[] = '';",
          "84:             foreach ($courses as $course) {",
          "86:                 $deleteicon = $OUTPUT->pix_icon('t/delete', get_string('removecommunitycourse', 'block_community'));",
          "87:                 $deleteurl = new moodle_url('/blocks/community/communitycourse.php',",
          "88:                                 array('remove' => true,",
          "89:                                     'courseid' => $this->page->course->id,",
          "90:                                     'communityid' => $course->id, 'sesskey' => sesskey()));",
          "91:                 $deleteatag = html_writer::tag('a', $deleteicon, array('href' => $deleteurl));",
          "93:                 $courselink = html_writer::tag('a', $course->coursename,",
          "94:                                 array('href' => $course->courseurl));",
          "95:                 $this->content->items[] = $courselink . ' ' . $deleteatag;",
          "96:                 $this->content->icons[] = '';",
          "97:             }",
          "98:         }",
          "",
          "[Added Lines]",
          "55:         $this->content->items[] = get_string('functionalityremoved', 'error');",
          "",
          "---------------"
        ],
        "lang/en/error.php||lang/en/error.php": [
          "File: lang/en/error.php -> lang/en/error.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "263: $string['filternotenabled'] = 'Filter not enabled!';",
          "264: $string['filternotinstalled'] = 'Filter {$a} is not currently installed';",
          "265: $string['forumblockingtoomanyposts'] = 'You have exceeded the posting threshold set for this forum';",
          "266: $string['generalexceptionmessage'] = 'Exception - {$a}';",
          "267: $string['gradepubdisable'] = 'Grade publishing disabled';",
          "268: $string['gradesneedregrading'] = 'The course grades need to be recalculated';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "266: $string['functionalityremoved'] = 'You are trying to access functionality that has been removed.';",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052001.10;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2019052001.11;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "315a0a3aaf6be4f71362b3e1dd958c69cd464fbd",
      "candidate_info": {
        "commit_hash": "315a0a3aaf6be4f71362b3e1dd958c69cd464fbd",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/315a0a3aaf6be4f71362b3e1dd958c69cd464fbd",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018020600.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180205)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018020800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180208)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bef0fe2000e332402c572b6fe9d0e20b5b31133a",
      "candidate_info": {
        "commit_hash": "bef0fe2000e332402c572b6fe9d0e20b5b31133a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bef0fe2000e332402c572b6fe9d0e20b5b31133a",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.7dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019041000.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev+ (Build: 20190410)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019041300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev+ (Build: 20190413)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a15c7459360f220a34c138f808340e3848c85b7c",
      "candidate_info": {
        "commit_hash": "a15c7459360f220a34c138f808340e3848c85b7c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a15c7459360f220a34c138f808340e3848c85b7c",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018031601.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180316)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018032200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180322)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9d8cdb9ba8eb6602b9b6f587dc2d50ecd3687ed6",
      "candidate_info": {
        "commit_hash": "9d8cdb9ba8eb6602b9b6f587dc2d50ecd3687ed6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9d8cdb9ba8eb6602b9b6f587dc2d50ecd3687ed6",
        "files": [
          "course/edit_form.php",
          "lang/en/moodle.php",
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-66143 course: Add relativedatesmode course setting",
        "before_after_code_files": [
          "course/edit_form.php||course/edit_form.php",
          "lang/en/moodle.php||lang/en/moodle.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "course/edit_form.php||course/edit_form.php": [
          "File: course/edit_form.php -> course/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "129:         $mform->addElement('date_time_selector', 'enddate', get_string('enddate'), array('optional' => true));",
          "130:         $mform->addHelpButton('enddate', 'enddate');",
          "132:         $mform->addElement('text','idnumber', get_string('idnumbercourse'),'maxlength=\"100\"  size=\"10\"');",
          "133:         $mform->addHelpButton('idnumber', 'idnumbercourse');",
          "134:         $mform->setType('idnumber', PARAM_RAW);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "132:         if (!empty($CFG->enablecourserelativedates)) {",
          "133:             $attributes = [];",
          "134:             if (!empty($course->id)) {",
          "135:                 $attributes['disabled'] = true;",
          "136:             }",
          "137:             $relativeoptions = [",
          "138:                 0 => get_string('no'),",
          "139:                 1 => get_string('yes'),",
          "140:             ];",
          "141:             $relativedatesmodegroup = [];",
          "142:             $relativedatesmodegroup[] = $mform->createElement('select', 'relativedatesmode', get_string('relativedatesmode'),",
          "143:                 $relativeoptions, $attributes);",
          "144:             $relativedatesmodegroup[] = $mform->createElement('html', html_writer::span(get_string('relativedatesmode_warning')));",
          "145:             $mform->addGroup($relativedatesmodegroup, 'relativedatesmodegroup', get_string('relativedatesmode'), null, false);",
          "146:             $mform->addHelpButton('relativedatesmodegroup', 'relativedatesmode');",
          "147:         }",
          "",
          "---------------"
        ],
        "lang/en/moodle.php||lang/en/moodle.php": [
          "File: lang/en/moodle.php -> lang/en/moodle.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1633: $string['registrationyes'] = 'Yes, notify me about important news (e.g. security issues or releases) ';",
          "1634: $string['reject'] = 'Reject';",
          "1635: $string['rejectdots'] = 'Reject...';",
          "1636: $string['reload'] = 'Reload';",
          "1637: $string['remoteappuser'] = 'Remote {$a} User';",
          "1638: $string['remove'] = 'Remove';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1636: $string['relativedatesmode'] = 'Relative dates mode';",
          "1637: $string['relativedatesmode_help'] = 'Display course or activity dates relative to the user\\'s start date in the course .<br />The user\\'s course start date will be their enrolment start date, unless they are enrolled before the course begins in which case their start date will be the course start date.<br/><strong>WARNING: This is an experimental feature and not all activities may support it. Once the course has been created, this course setting can no longer be changed.</strong>';",
          "1638: $string['relativedatesmode_warning'] = '<strong>Warning:</strong> This cannot be changed once the course has been created.';",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3416:         upgrade_main_savepoint(true, 2019070400.01);",
          "3417:     }",
          "3419:     return true;",
          "3420: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3419:     if ($oldversion < 2019072200.00) {",
          "3422:         $table = new xmldb_table('course');",
          "3423:         $field = new xmldb_field('relativedatesmode', XMLDB_TYPE_INTEGER, '1', null, XMLDB_NOTNULL, null, '0', 'enddate');",
          "3426:         if (!$dbman->field_exists($table, $field)) {",
          "3427:             $dbman->add_field($table, $field);",
          "3428:         }",
          "3431:         upgrade_main_savepoint(true, 2019072200.00);",
          "3432:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019071800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019072200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}