{
  "cve_id": "CVE-2024-12678",
  "cve_desc": "Nomad Community and Nomad Enterprise (\"Nomad\") allocations are vulnerable to privilege escalation within a namespace through unredacted workload identity tokens. This vulnerability, identified as CVE-2024-12678, is fixed in Nomad Community Edition 1.9.4 and Nomad Enterprise 1.9.4, 1.8.8, and 1.7.16.",
  "repo": "hashicorp/nomad",
  "patch_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
  "patch_info": {
    "commit_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "repo": "hashicorp/nomad",
    "commit_url": "https://github.com/hashicorp/nomad/commit/359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "files": [
      ".changelog/24683.txt",
      "command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go",
      "nomad/structs/structs.go"
    ],
    "message": "Backport of sec: fix alloc workload identity namespace permission into release/1.9.x (#24685)\n\nCo-authored-by: Deniz Onur Duzgun <59659739+dduzgun-security@users.noreply.github.com>",
    "before_after_code_files": [
      "command/agent/node_endpoint.go||command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go",
      "nomad/structs/structs.go||nomad/structs/structs.go"
    ]
  },
  "patch_diff": {
    "command/agent/node_endpoint.go||command/agent/node_endpoint.go": [
      "File: command/agent/node_endpoint.go -> command/agent/node_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "105:   out.Allocs = make([]*structs.Allocation, 0)",
      "106:  }",
      "107:  for _, alloc := range out.Allocs {",
      "108:   alloc.SetEventDisplayMessages()",
      "109:  }",
      "110:  return out.Allocs, nil",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "108:   alloc = alloc.Sanitize()",
      "",
      "---------------"
    ],
    "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go": [
      "File: nomad/alloc_endpoint.go -> nomad/alloc_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "172:    }",
      "176:    if out != nil {",
      "178:     if !aclObj.AllowClientOp() && !allowNsOp(aclObj, out.Namespace) {",
      "179:      return structs.NewErrUnknownAllocation(args.AllocID)",
      "",
      "[Removed Lines]",
      "175:    reply.Alloc = out",
      "",
      "[Added Lines]",
      "176:     out = out.Sanitize()",
      "177:     reply.Alloc = out",
      "",
      "---------------"
    ],
    "nomad/structs/structs.go||nomad/structs/structs.go": [
      "File: nomad/structs/structs.go -> nomad/structs/structs.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "11199:  return a.ID",
      "11200: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "11205: func (a *Allocation) Sanitize() *Allocation {",
      "11206:  if a == nil {",
      "11207:   return nil",
      "11208:  }",
      "11210:  if a.SignedIdentities == nil {",
      "11211:   return a",
      "11212:  }",
      "11214:  clean := a.Copy()",
      "11215:  clean.SignedIdentities = nil",
      "11216:  return clean",
      "11217: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "496bfaa741bc83e1d0b3a5314407a1d8028848c7",
      "candidate_info": {
        "commit_hash": "496bfaa741bc83e1d0b3a5314407a1d8028848c7",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/496bfaa741bc83e1d0b3a5314407a1d8028848c7",
        "files": [
          "go.mod",
          "go.sum"
        ],
        "message": "(deps): bump github.com/stretchr/testify from 1.9.0 to 1.10.0 (#24552)\n\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:  github.com/shoenig/go-landlock v1.2.2",
          "124:  github.com/shoenig/go-m1cpu v0.1.6",
          "125:  github.com/shoenig/test v1.11.0",
          "127:  github.com/zclconf/go-cty v1.13.0",
          "128:  github.com/zclconf/go-cty-yaml v1.0.3",
          "129:  go.etcd.io/bbolt v1.3.9",
          "",
          "[Removed Lines]",
          "126:  github.com/stretchr/testify v1.9.0",
          "",
          "[Added Lines]",
          "126:  github.com/stretchr/testify v1.10.0",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "1058: github.com/stretchr/testify v1.7.2/go.mod h1:R6va5+xMeoiuVRoj+gSkQ7d3FALtqAAGI1FQKckRals=",
          "1059: github.com/stretchr/testify v1.8.0/go.mod h1:yNjHg4UonilssWZ8iaSj1OCr/vHnekPRkoO+kdMU+MU=",
          "1060: github.com/stretchr/testify v1.8.1/go.mod h1:w2LPCIKwWwSfY2zedu0+kehJoqGctiVI29o6fzry7u4=",
          "1063: github.com/syndtr/gocapability v0.0.0-20200815063812-42c35b437635 h1:kdXcSzyDtseVEc4yCz2qF8ZrQvIDBJLl4S1c3GCXmoI=",
          "1064: github.com/syndtr/gocapability v0.0.0-20200815063812-42c35b437635/go.mod h1:hkRG7XYTFWNJGYcbNJQlaLq0fg1yr4J4t/NcTQtrfww=",
          "1065: github.com/tencentcloud/tencentcloud-sdk-go v1.0.162 h1:8fDzz4GuVg4skjY2B0nMN7h6uN61EDVkuLyI2+qGHhI=",
          "",
          "[Removed Lines]",
          "1061: github.com/stretchr/testify v1.9.0 h1:HtqpIVDClZ4nwg75+f6Lvsy/wHu+3BoSGCbBAcpTsTg=",
          "1062: github.com/stretchr/testify v1.9.0/go.mod h1:r2ic/lqez/lEtzL7wO/rwa5dbSLXVDPFyf8C91i36aY=",
          "",
          "[Added Lines]",
          "1061: github.com/stretchr/testify v1.10.0 h1:Xv5erBjTwe/5IxqUQTdXv5kgmIvbHo3QQyRwhJsOfJA=",
          "1062: github.com/stretchr/testify v1.10.0/go.mod h1:r2ic/lqez/lEtzL7wO/rwa5dbSLXVDPFyf8C91i36aY=",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "643a951a11ba223afcfe130919a4beb6654c937f",
      "candidate_info": {
        "commit_hash": "643a951a11ba223afcfe130919a4beb6654c937f",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/643a951a11ba223afcfe130919a4beb6654c937f",
        "files": [
          ".changelog/24280.txt",
          "client/allocrunner/consul_grpc_sock_hook.go"
        ],
        "message": "backport of commit 4ef4bebd1f9e714f8d3d7a76d771f3901a99528e (#24388)\n\nCo-authored-by: Seth Hoenig <shoenig@duck.com>",
        "before_after_code_files": [
          "client/allocrunner/consul_grpc_sock_hook.go||client/allocrunner/consul_grpc_sock_hook.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "client/allocrunner/consul_grpc_sock_hook.go||client/allocrunner/consul_grpc_sock_hook.go": [
          "File: client/allocrunner/consul_grpc_sock_hook.go -> client/allocrunner/consul_grpc_sock_hook.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "18:  \"github.com/hashicorp/go-hclog\"",
          "19:  multierror \"github.com/hashicorp/go-multierror\"",
          "20:  \"github.com/hashicorp/go-set/v3\"",
          "21:  \"github.com/hashicorp/nomad/client/allocdir\"",
          "22:  \"github.com/hashicorp/nomad/client/allocrunner/interfaces\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20:  \"github.com/hashicorp/go-secure-stdlib/listenerutil\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "133:  var mErr *multierror.Error",
          "134:  for _, proxy := range h.proxies {",
          "136:    mErr = multierror.Append(mErr, err)",
          "137:   }",
          "138:  }",
          "",
          "[Removed Lines]",
          "135:   if err := proxy.run(h.alloc); err != nil {",
          "",
          "[Added Lines]",
          "136:   if err := proxy.run(); err != nil {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "157:  var mErr *multierror.Error",
          "158:  for _, proxy := range h.proxies {",
          "160:    mErr = multierror.Append(mErr, err)",
          "161:   }",
          "162:  }",
          "",
          "[Removed Lines]",
          "159:   if err := proxy.run(h.alloc); err != nil {",
          "",
          "[Added Lines]",
          "160:   if err := proxy.run(); err != nil {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "221:  if p.runOnce {",
          "222:   return nil",
          "",
          "[Removed Lines]",
          "219: func (p *grpcSocketProxy) run(alloc *structs.Allocation) error {",
          "",
          "[Added Lines]",
          "220: func (p *grpcSocketProxy) run() error {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "248:    return fmt.Errorf(\"error parsing Consul address %q: %v\", p.config.Addr, err)",
          "249:   }",
          "250:   destAddr = net.JoinHostPort(host, p.consulGRPCFallbackPort)",
          "251:  }",
          "253:  socketFile := allocdir.AllocGRPCSocket",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:  } else {",
          "255:   ipStr, err := listenerutil.ParseSingleIPTemplate(destAddr)",
          "256:   if err != nil {",
          "257:    return fmt.Errorf(\"unable to parse address template %q: %v\", destAddr, err)",
          "258:   }",
          "259:   destAddr = ipStr",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ae3942c8c538430b64cebedf50016fac09c7958b",
      "candidate_info": {
        "commit_hash": "ae3942c8c538430b64cebedf50016fac09c7958b",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/ae3942c8c538430b64cebedf50016fac09c7958b",
        "files": [
          "go.mod",
          "go.sum"
        ],
        "message": "backport of commit 0178a698c1e033549aeaaa2e64501816cbe9e986 (#24744)\n\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "90:  github.com/hashicorp/vault/api v1.15.0",
          "91:  github.com/hashicorp/yamux v0.1.2",
          "92:  github.com/hpcloud/tail v1.0.1-0.20170814160653-37f427138745",
          "94:  github.com/kr/pretty v0.3.1",
          "95:  github.com/kr/text v0.2.0",
          "96:  github.com/mattn/go-colorable v0.1.13",
          "",
          "[Removed Lines]",
          "93:  github.com/klauspost/cpuid/v2 v2.2.8",
          "",
          "[Added Lines]",
          "93:  github.com/klauspost/cpuid/v2 v2.2.9",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "819: github.com/klauspost/compress v1.15.11/go.mod h1:QPwzmACJjUTFsnSHH934V6woptycfrDDJnH7hvFVbGM=",
          "820: github.com/klauspost/compress v1.17.9 h1:6KIumPrER1LHsvBVuDa0r5xaG0Es51mhhB9BQB2qeMA=",
          "821: github.com/klauspost/compress v1.17.9/go.mod h1:Di0epgTjJY877eYKx5yC51cX2A2Vl2ibi7bDH9ttBbw=",
          "824: github.com/konsorten/go-windows-terminal-sequences v1.0.1/go.mod h1:T0+1ngSBFLxvqU3pZ+m/2kptfBszLMUkC4ZK/EgS/cQ=",
          "825: github.com/kr/logfmt v0.0.0-20140226030751-b84e30acd515/go.mod h1:+0opPa2QZZtGFBFZlji/RkVcI2GknAs/DXo4wKdlNEc=",
          "826: github.com/kr/pretty v0.1.0/go.mod h1:dAy3ld7l9f0ibDNOQOHHMYYIIbhfbHSm3C4ZsoJORNo=",
          "",
          "[Removed Lines]",
          "822: github.com/klauspost/cpuid/v2 v2.2.8 h1:+StwCXwm9PdpiEkPyzBXIy+M9KUb4ODm0Zarf1kS5BM=",
          "823: github.com/klauspost/cpuid/v2 v2.2.8/go.mod h1:Lcz8mBdAVJIBVzewtcLocK12l3Y+JytZYpaMropDUws=",
          "",
          "[Added Lines]",
          "822: github.com/klauspost/cpuid/v2 v2.2.9 h1:66ze0taIn2H33fBvCkXuv9BmCwDfafmiIVpKV9kKGuY=",
          "823: github.com/klauspost/cpuid/v2 v2.2.9/go.mod h1:rqkxqrZ1EhYM9G+hXH7YdowN5R5RGN6NK4QwQ3WMXF8=",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e902f8d8a788d5fffb46f7d7d280a7c75665b4c4",
      "candidate_info": {
        "commit_hash": "e902f8d8a788d5fffb46f7d7d280a7c75665b4c4",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/e902f8d8a788d5fffb46f7d7d280a7c75665b4c4",
        "files": [
          ".changelog/24237.txt",
          "drivers/docker/docklog/docker_logger.go",
          "drivers/docker/driver.go"
        ],
        "message": "backport of commit 1ac14f4869e6f1a884f9f1384dbde863ac7fa69b (#24239)\n\nCo-authored-by: Piotr Kazmierczak <470696+pkazmierczak@users.noreply.github.com>",
        "before_after_code_files": [
          "drivers/docker/docklog/docker_logger.go||drivers/docker/docklog/docker_logger.go",
          "drivers/docker/driver.go||drivers/docker/driver.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/docker/docklog/docker_logger.go||drivers/docker/docklog/docker_logger.go": [
          "File: drivers/docker/docklog/docker_logger.go -> drivers/docker/docklog/docker_logger.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "225:    d.logger.Debug(\"using TLS client connection to docker\", \"endpoint\", opts.Endpoint)",
          "226:    newClient, err = client.NewClientWithOpts(",
          "227:     client.WithHost(opts.Endpoint),",
          "229:    if err != nil {",
          "230:     merr.Errors = append(merr.Errors, err)",
          "231:    }",
          "232:   } else {",
          "233:    d.logger.Debug(\"using plaintext client connection to docker\", \"endpoint\", opts.Endpoint)",
          "235:    if err != nil {",
          "236:     merr.Errors = append(merr.Errors, err)",
          "237:    }",
          "",
          "[Removed Lines]",
          "228:     client.WithTLSClientConfig(opts.TLSCA, opts.TLSCert, opts.TLSKey))",
          "234:    newClient, err = client.NewClientWithOpts(client.WithHost(opts.Endpoint))",
          "",
          "[Added Lines]",
          "228:     client.WithTLSClientConfig(opts.TLSCA, opts.TLSCert, opts.TLSKey),",
          "229:     client.WithAPIVersionNegotiation(),",
          "230:    )",
          "236:    newClient, err = client.NewClientWithOpts(",
          "237:     client.WithHost(opts.Endpoint),",
          "238:     client.WithAPIVersionNegotiation(),",
          "239:    )",
          "",
          "---------------"
        ],
        "drivers/docker/driver.go||drivers/docker/driver.go": [
          "File: drivers/docker/driver.go -> drivers/docker/driver.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1927:    newClient, err = client.NewClientWithOpts(",
          "1928:     client.WithHost(dockerEndpoint),",
          "1929:     client.WithTLSClientConfig(ca, cert, key),",
          "1930:    )",
          "1931:    if err != nil {",
          "1932:     merr.Errors = append(merr.Errors, err)",
          "1933:    }",
          "1934:   } else {",
          "1935:    d.logger.Debug(\"using standard client connection\", \"endpoint\", dockerEndpoint)",
          "1937:    if err != nil {",
          "1938:     merr.Errors = append(merr.Errors, err)",
          "1939:    }",
          "",
          "[Removed Lines]",
          "1936:    newClient, err = client.NewClientWithOpts(client.WithHost(dockerEndpoint))",
          "",
          "[Added Lines]",
          "1930:     client.WithAPIVersionNegotiation(),",
          "1937:    newClient, err = client.NewClientWithOpts(",
          "1938:     client.WithHost(dockerEndpoint),",
          "1939:     client.WithAPIVersionNegotiation(),",
          "1940:    )",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee5584856f721c46805ecbbbaaf3cc2b35c75d57",
      "candidate_info": {
        "commit_hash": "ee5584856f721c46805ecbbbaaf3cc2b35c75d57",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/ee5584856f721c46805ecbbbaaf3cc2b35c75d57",
        "files": [
          ".changelog/24374.txt",
          "ui/app/components/forbidden-message.js",
          "ui/app/controllers/application.js",
          "ui/app/controllers/settings/tokens.js",
          "ui/app/routes/application.js",
          "ui/app/services/token.js",
          "ui/app/templates/application.hbs",
          "ui/app/templates/components/forbidden-message.hbs",
          "ui/tests/acceptance/token-test.js"
        ],
        "message": "backport of commit 498b29b3cf789d05fb2884a1ba6548159f59c9d9 (#24390)\n\nCo-authored-by: Phil Renaud <phil.renaud@hashicorp.com>",
        "before_after_code_files": [
          "ui/app/components/forbidden-message.js||ui/app/components/forbidden-message.js",
          "ui/app/controllers/application.js||ui/app/controllers/application.js",
          "ui/app/controllers/settings/tokens.js||ui/app/controllers/settings/tokens.js",
          "ui/app/routes/application.js||ui/app/routes/application.js",
          "ui/app/services/token.js||ui/app/services/token.js",
          "ui/app/templates/application.hbs||ui/app/templates/application.hbs",
          "ui/app/templates/components/forbidden-message.hbs||ui/app/templates/components/forbidden-message.hbs",
          "ui/tests/acceptance/token-test.js||ui/tests/acceptance/token-test.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "ui/app/components/forbidden-message.js||ui/app/components/forbidden-message.js": [
          "File: ui/app/components/forbidden-message.js -> ui/app/components/forbidden-message.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: export default class ForbiddenMessage extends Component {",
          "12:   @service token;",
          "13:   @service store;",
          "15:   get authMethods() {",
          "16:     return this.store.findAll('auth-method');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14:   @service router;",
          "",
          "---------------"
        ],
        "ui/app/controllers/application.js||ui/app/controllers/application.js": [
          "File: ui/app/controllers/application.js -> ui/app/controllers/application.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "22:   @service system;",
          "23:   @service token;",
          "24:   @service notifications;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25:   @service router;",
          "",
          "---------------"
        ],
        "ui/app/controllers/settings/tokens.js||ui/app/controllers/settings/tokens.js": [
          "File: ui/app/controllers/settings/tokens.js -> ui/app/controllers/settings/tokens.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "24:   @service store;",
          "25:   @service router;",
          "26:   @service system;",
          "27:   queryParams = ['code', 'state', 'jwtAuthMethod'];",
          "29:   @tracked secret = this.token.secret;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27:   @service notifications;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "145:           this.token.get('fetchSelfTokenAndPolicies').perform().catch();",
          "147:           this.signInStatus = 'success';",
          "148:         },",
          "149:         () => {",
          "150:           this.token.set('secret', undefined);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "149:           this.optionallyRedirectPathAfterSignIn();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "175:           this.signInStatus = 'success';",
          "176:           this.token.set('tokenNotFound', false);",
          "177:         },",
          "178:         () => {",
          "179:           this.token.set('secret', undefined);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "179:           this.optionallyRedirectPathAfterSignIn();",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "183:     }",
          "184:   }",
          "188:   generateNonce() {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "193:   optionallyRedirectPathAfterSignIn() {",
          "194:     if (this.token.postExpiryPath) {",
          "195:       this.router.transitionTo(this.token.postExpiryPath);",
          "196:       this.token.postExpiryPath = null;",
          "199:       this.notifications.add({",
          "200:         title: 'Successfully signed in',",
          "201:         message:",
          "202:           'You were redirected back to the page you were on before you were signed out.',",
          "203:         color: 'success',",
          "204:         timeout: 10000,",
          "205:       });",
          "206:     }",
          "207:   }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "271:       this.signInStatus = 'success';",
          "272:       this.token.set('tokenNotFound', false);",
          "273:     } else {",
          "274:       this.state = 'failure';",
          "275:       this.code = null;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "296:       this.optionallyRedirectPathAfterSignIn();",
          "",
          "---------------"
        ],
        "ui/app/routes/application.js||ui/app/routes/application.js": [
          "File: ui/app/routes/application.js -> ui/app/routes/application.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "153:             e.detail === 'ACL token not found'",
          "154:         )",
          "155:       ) {",
          "156:         this.router.transitionTo('settings.tokens');",
          "157:       } else {",
          "158:         this.controllerFor('application').set('error', error);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "156:         this.token.postExpiryPath = this.router.currentURL;",
          "",
          "---------------"
        ],
        "ui/app/services/token.js||ui/app/services/token.js": [
          "File: ui/app/services/token.js -> ui/app/services/token.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "196:               title: 'Your access has expired',",
          "197:               message: `Your token will need to be re-authenticated`,",
          "198:             });",
          "199:           }",
          "200:           this.monitorTokenTime.cancelAll(); // Stop updating time left after expiration",
          "201:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "199:             const currentPath = this.router.currentURL;",
          "200:             this.postExpiryPath = currentPath;",
          "",
          "---------------"
        ],
        "ui/app/templates/application.hbs||ui/app/templates/application.hbs": [
          "File: ui/app/templates/application.hbs -> ui/app/templates/application.hbs",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:         <h1 data-test-error-title class=\"title is-spaced\">Not Authorized</h1>",
          "81:         {{#if this.token.secret}}",
          "82:           <p data-test-error-message class=\"subtitle\">Your",
          "84:             does not provide the required permissions. Contact your",
          "85:             administrator if this is an error.</p>",
          "86:         {{else}}",
          "87:           <p data-test-error-message class=\"subtitle\">Provide an",
          "89:             with requisite permissions to view this.</p>",
          "90:         {{/if}}",
          "91:       {{else}}",
          "",
          "[Removed Lines]",
          "83:             <LinkTo @route=\"settings.tokens\" data-test-error-acl-link>ACL token</LinkTo>",
          "88:             <LinkTo @route=\"settings.tokens\" data-test-error-acl-link>ACL token</LinkTo>",
          "",
          "[Added Lines]",
          "83:             <LinkTo @route=\"settings.tokens\" data-test-error-acl-link {{on \"click\" (action (mut this.token.postExpiryPath) this.router.currentURL)}}>ACL token</LinkTo>",
          "88:             <LinkTo @route=\"settings.tokens\" data-test-error-acl-link {{on \"click\" (action (mut this.token.postExpiryPath) this.router.currentURL)}}>ACL token</LinkTo>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108:         @route=\"settings.tokens\"",
          "109:         data-test-error-signin-link",
          "110:         class=\"button is-white\"",
          "111:       >Go to Sign In</LinkTo>",
          "112:     </div>",
          "113:   </div>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "111:         {{on \"click\" (action (mut this.token.postExpiryPath) this.router.currentURL)}}",
          "",
          "---------------"
        ],
        "ui/app/templates/components/forbidden-message.hbs||ui/app/templates/components/forbidden-message.hbs": [
          "File: ui/app/templates/components/forbidden-message.hbs -> ui/app/templates/components/forbidden-message.hbs",
          "--- Hunk 1 ---",
          "[Context before]",
          "13:       {{else}}",
          "14:         required",
          "15:       {{/if}}",
          "17:     {{else}}",
          "18:       {{#if this.authMethods}}",
          "19:         Sign in with",
          "20:         {{#each this.authMethods as |authMethod|}}",
          "22:         {{/each}}",
          "23:         or",
          "24:       {{/if}}",
          "",
          "[Removed Lines]",
          "16:       <LinkTo @route=\"settings.tokens\">permission</LinkTo> for this resource.<br /> Contact your administrator if this is an error.",
          "21:           <LinkTo @route=\"settings.tokens\">{{authMethod.name}}</LinkTo>,",
          "",
          "[Added Lines]",
          "16:       <LinkTo data-test-permission-link @route=\"settings.tokens\" {{on \"click\" (action (mut this.token.postExpiryPath) this.router.currentURL)}}>permission</LinkTo> for this resource.<br /> Contact your administrator if this is an error.",
          "21:           <LinkTo @route=\"settings.tokens\">{{authMethod.name}}</LinkTo>,",
          "",
          "---------------"
        ],
        "ui/tests/acceptance/token-test.js||ui/tests/acceptance/token-test.js": [
          "File: ui/tests/acceptance/token-test.js -> ui/tests/acceptance/token-test.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: let node;",
          "37: let managementToken;",
          "38: let clientToken;",
          "40: module('Acceptance | tokens', function (hooks) {",
          "41:   setupApplicationTest(hooks);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39: let recentlyExpiredToken;",
          "40: let soonExpiringToken;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "53:     job = server.create('job');",
          "54:     managementToken = server.create('token');",
          "55:     clientToken = server.create('token');",
          "56:   });",
          "58:   test('it passes an accessibility audit', async function (assert) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:     recentlyExpiredToken = server.create('token', {",
          "59:       expirationTime: moment().add(-5, 'm').toDate(),",
          "60:     });",
          "61:     soonExpiringToken = server.create('token', {",
          "62:       expirationTime: moment().add(1, 's').toDate(),",
          "63:     });",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "757:     window.localStorage.nomadTokenSecret = null;",
          "758:   });",
          "760:   function getHeader({ requestHeaders }, name) {",
          "762:     return (",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "773:   test('When a token expires with permission denial, the user is prompted to redirect to the token page (jobs page)', async function (assert) {",
          "774:     assert.expect(4);",
          "775:     window.localStorage.clear();",
          "777:     window.localStorage.nomadTokenSecret = recentlyExpiredToken.secretId; // simulate refreshing the page with an expired token",
          "778:     server.pretender.get('/v1/jobs/statuses', function () {",
          "779:       return [403, {}, 'Permission Denied'];",
          "780:     });",
          "782:     await visit('/jobs');",
          "784:     assert",
          "785:       .dom('[data-test-error]')",
          "786:       .exists('Error message is shown on the Jobs page');",
          "787:     await click('[data-test-permission-link]');",
          "788:     assert.equal(",
          "789:       currentURL(),",
          "790:       '/settings/tokens',",
          "791:       'Redirected to the tokens page'",
          "792:     );",
          "794:     server.pretender.get('/v1/jobs/statuses', function () {",
          "795:       return [200, {}, null];",
          "796:     });",
          "797:     await Tokens.visit();",
          "799:     await Tokens.secret(recentlyExpiredToken.secretId).submit();",
          "800:     assert.equal(currentURL(), '/jobs');",
          "802:     assert.dom('.flash-message.alert-success').exists();",
          "803:   });",
          "806:   test('When a token expires with permission denial, the user is prompted to redirect to the token page (evaluations page)', async function (assert) {",
          "807:     window.localStorage.clear();",
          "808:     window.localStorage.nomadTokenSecret = recentlyExpiredToken.secretId; // simulate refreshing the page with an expired token",
          "809:     server.pretender.get('/v1/evaluations', function () {",
          "810:       return [403, {}, 'Permission Denied'];",
          "811:     });",
          "813:     await visit('/evaluations');",
          "815:     assert",
          "816:       .dom('[data-test-error]')",
          "817:       .exists('Error message is shown on the Evaluations page');",
          "818:     await click('[data-test-error-acl-link]');",
          "819:     assert.equal(",
          "820:       currentURL(),",
          "821:       '/settings/tokens',",
          "822:       'Redirected to the tokens page'",
          "823:     );",
          "825:     server.pretender.get('/v1/evaluations', function () {",
          "826:       return [200, {}, JSON.stringify([])];",
          "827:     });",
          "829:     await Tokens.secret(managementToken.secretId).submit();",
          "831:     assert.equal(currentURL(), '/evaluations');",
          "833:     assert.dom('.flash-message.alert-success').exists();",
          "834:   });",
          "836:   module('Token Expiry and redirect', function (hooks) {",
          "837:     hooks.beforeEach(function () {",
          "838:       window.localStorage.nomadTokenSecret = soonExpiringToken.secretId;",
          "839:     });",
          "841:     test('When a token expires while the user is on a page, the notification saves redirect route', async function (assert) {",
          "843:       await Jobs.visit();",
          "844:       assert.equal(currentURL(), '/jobs');",
          "846:       assert",
          "847:         .dom('.flash-message.alert-warning button')",
          "848:         .exists('A global alert exists and has a clickable button');",
          "850:       await click('.flash-message.alert-warning button');",
          "852:       assert.equal(",
          "853:         currentURL(),",
          "854:         '/settings/tokens',",
          "855:         'Redirected to tokens page on notification action'",
          "856:       );",
          "858:       assert",
          "859:         .dom('[data-test-token-expired]')",
          "860:         .exists('Notification is rendered');",
          "862:       await Tokens.secret(managementToken.secretId).submit();",
          "863:       assert.equal(",
          "864:         currentURL(),",
          "865:         '/jobs',",
          "866:         'Redirected to initial route on manager sign in'",
          "867:       );",
          "868:     });",
          "869:   });",
          "",
          "---------------"
        ]
      }
    }
  ]
}