{
  "cve_id": "CVE-2023-47125",
  "cve_desc": "TYPO3 is an open source PHP based web content management system released under the GNU GPL. In affected versions DOM processing instructions are not handled correctly. This allows bypassing the cross-site scripting mechanism of typo3/html-sanitizer. This vulnerability has been addressed in versions 1.5.3 and 2.1.4. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "TYPO3/html-sanitizer",
  "patch_hash": "b8f90717251d968c49dc77f8c1e5912e2fbe0dff",
  "patch_info": {
    "commit_hash": "b8f90717251d968c49dc77f8c1e5912e2fbe0dff",
    "repo": "TYPO3/html-sanitizer",
    "commit_url": "https://github.com/TYPO3/html-sanitizer/commit/b8f90717251d968c49dc77f8c1e5912e2fbe0dff",
    "files": [
      "src/Behavior.php",
      "src/Builder/CommonBuilder.php",
      "src/Visitor/CommonVisitor.php",
      "tests/CommonBuilderTest.php"
    ],
    "message": "[SECURITY] Deny processing instructions\n\nXML processing instructions (e.g. `<?xml>`)\nare denied during the sanitization process.",
    "before_after_code_files": [
      "src/Behavior.php||src/Behavior.php",
      "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php",
      "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php",
      "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php"
    ]
  },
  "patch_diff": {
    "src/Behavior.php||src/Behavior.php": [
      "File: src/Behavior.php -> src/Behavior.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "63:     public const ENCODE_INVALID_CDATA_SECTION = 32;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "68:     public const ENCODE_INVALID_PROCESSING_INSTRUCTION = 64;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "224:         return ($this->flags & self::ENCODE_INVALID_CDATA_SECTION) === self::ENCODE_INVALID_CDATA_SECTION;",
      "225:     }",
      "227:     public function shallRemoveUnexpectedChildren(): bool",
      "228:     {",
      "229:         return ($this->flags & self::REMOVE_UNEXPECTED_CHILDREN) === self::REMOVE_UNEXPECTED_CHILDREN;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "232:     public function shallEncodeInvalidProcessingInstruction(): bool",
      "233:     {",
      "234:         return ($this->flags & self::ENCODE_INVALID_PROCESSING_INSTRUCTION) === self::ENCODE_INVALID_PROCESSING_INSTRUCTION;",
      "235:     }",
      "",
      "---------------"
    ],
    "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php": [
      "File: src/Builder/CommonBuilder.php -> src/Builder/CommonBuilder.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "76:     protected function createBehavior(): Behavior",
      "77:     {",
      "78:         return (new Behavior())",
      "80:             ->withName('common')",
      "81:             ->withTags(...array_values($this->createBasicTags()))",
      "82:             ->withTags(...array_values($this->createMediaTags()))",
      "",
      "[Removed Lines]",
      "79:             ->withFlags(Behavior::ENCODE_INVALID_TAG | Behavior::REMOVE_UNEXPECTED_CHILDREN)",
      "",
      "[Added Lines]",
      "79:             ->withFlags(",
      "80:                 Behavior::ENCODE_INVALID_TAG",
      "81:                 | Behavior::REMOVE_UNEXPECTED_CHILDREN",
      "82:                 | Behavior::ENCODE_INVALID_PROCESSING_INSTRUCTION",
      "83:             )",
      "",
      "---------------"
    ],
    "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php": [
      "File: src/Visitor/CommonVisitor.php -> src/Visitor/CommonVisitor.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: use DOMComment;",
      "20: use DOMElement;",
      "21: use DOMNode;",
      "22: use DOMText;",
      "23: use Psr\\Log\\LoggerAwareInterface;",
      "24: use Psr\\Log\\LoggerAwareTrait;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: use DOMProcessingInstruction;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "65:     public function enterNode(DOMNode $domNode): ?DOMNode",
      "66:     {",
      "67:         if (!$domNode instanceof DOMCdataSection",
      "68:             && !$domNode instanceof DOMComment",
      "69:             && !$domNode instanceof DOMElement",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "68:         if ($domNode instanceof DOMProcessingInstruction) {",
      "69:             return $this->handleInvalidNode($domNode);",
      "70:         }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "219:         if (",
      "220:             ($domNode instanceof DOMComment && $this->behavior->shallEncodeInvalidComment())",
      "221:             || ($domNode instanceof DOMCdataSection && $this->behavior->shallEncodeInvalidCdataSection())",
      "222:         ) {",
      "223:             $this->log('Found unexpected node {nodeName}', [",
      "224:                 'behavior' => $this->behavior->getName(),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "227:             || ($domNode instanceof DOMProcessingInstruction && $this->behavior->shallEncodeInvalidProcessingInstruction())",
      "",
      "---------------"
    ],
    "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php": [
      "File: tests/CommonBuilderTest.php -> tests/CommonBuilderTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "263:                 '<!-- &lt;&quot;comment&quot;&gt; -->',",
      "264:                 '<!-- &lt;&quot;comment&quot;&gt; -->',",
      "265:             ],",
      "266:             '#915' => [",
      "267:                 '#text',",
      "268:                 '#text',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "266:             '#912' => [",
      "267:                 '<!---><p>',",
      "268:                 '<!---&gt;&lt;p&gt;-->',",
      "269:             ],",
      "270:             '#913' => [",
      "271:                 '<!---!><p>',",
      "272:                 '<!---!&gt;&lt;p&gt;-->',",
      "273:             ],",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "303:                 '<p class=\"{&quot;json&quot;:true}\">value</p>',",
      "304:                 '<p class=\"{&quot;json&quot;:true}\">value</p>',",
      "305:             ],",
      "306:         ];",
      "307:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "314:             '#941' => [",
      "315:                 '<?xml >s<img src=x onerror=alert(1)> ?>',",
      "316:                 '&lt;?xml &gt;s&lt;img src=x onerror=alert(1)&gt; ?&gt;',",
      "317:             ],",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cead6b60be7122c9e6bdc40f702ca8b5980abca4",
      "candidate_info": {
        "commit_hash": "cead6b60be7122c9e6bdc40f702ca8b5980abca4",
        "repo": "TYPO3/html-sanitizer",
        "commit_url": "https://github.com/TYPO3/html-sanitizer/commit/cead6b60be7122c9e6bdc40f702ca8b5980abca4",
        "files": [
          "src/Behavior.php",
          "src/Builder/CommonBuilder.php",
          "src/Visitor/CommonVisitor.php",
          "tests/CommonBuilderTest.php"
        ],
        "message": "[SECURITY] Deny processing instructions\n\nXML processing instructions (e.g. `<?xml>`)\nare denied during the sanitization process.",
        "before_after_code_files": [
          "src/Behavior.php||src/Behavior.php",
          "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php",
          "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php",
          "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/Behavior.php||src/Behavior.php",
            "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php",
            "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php",
            "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php"
          ],
          "candidate": [
            "src/Behavior.php||src/Behavior.php",
            "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php",
            "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php",
            "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Behavior.php||src/Behavior.php": [
          "File: src/Behavior.php -> src/Behavior.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "63:     const ENCODE_INVALID_CDATA_SECTION = 32;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:     const ENCODE_INVALID_PROCESSING_INSTRUCTION = 64;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "230:         return ($this->flags & self::ENCODE_INVALID_CDATA_SECTION) === self::ENCODE_INVALID_CDATA_SECTION;",
          "231:     }",
          "233:     public function shallRemoveUnexpectedChildren(): bool",
          "234:     {",
          "235:         return ($this->flags & self::REMOVE_UNEXPECTED_CHILDREN) === self::REMOVE_UNEXPECTED_CHILDREN;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "238:     public function shallEncodeInvalidProcessingInstruction(): bool",
          "239:     {",
          "240:         return ($this->flags & self::ENCODE_INVALID_PROCESSING_INSTRUCTION) === self::ENCODE_INVALID_PROCESSING_INSTRUCTION;",
          "241:     }",
          "",
          "---------------"
        ],
        "src/Builder/CommonBuilder.php||src/Builder/CommonBuilder.php": [
          "File: src/Builder/CommonBuilder.php -> src/Builder/CommonBuilder.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:     protected function createBehavior(): Behavior",
          "77:     {",
          "78:         return (new Behavior())",
          "80:             ->withName('common')",
          "81:             ->withTags(...array_values($this->createBasicTags()))",
          "82:             ->withTags(...array_values($this->createMediaTags()))",
          "",
          "[Removed Lines]",
          "79:             ->withFlags(Behavior::ENCODE_INVALID_TAG | Behavior::REMOVE_UNEXPECTED_CHILDREN)",
          "",
          "[Added Lines]",
          "79:             ->withFlags(",
          "80:                 Behavior::ENCODE_INVALID_TAG",
          "81:                 | Behavior::REMOVE_UNEXPECTED_CHILDREN",
          "82:                 | Behavior::ENCODE_INVALID_PROCESSING_INSTRUCTION",
          "83:             )",
          "",
          "---------------"
        ],
        "src/Visitor/CommonVisitor.php||src/Visitor/CommonVisitor.php": [
          "File: src/Visitor/CommonVisitor.php -> src/Visitor/CommonVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: use DOMComment;",
          "20: use DOMElement;",
          "21: use DOMNode;",
          "22: use DOMText;",
          "23: use Psr\\Log\\LoggerAwareInterface;",
          "24: use Psr\\Log\\LoggerAwareTrait;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: use DOMProcessingInstruction;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:     public function enterNode(DOMNode $domNode)",
          "72:     {",
          "73:         if (!$domNode instanceof DOMCdataSection",
          "74:             && !$domNode instanceof DOMComment",
          "75:             && !$domNode instanceof DOMElement",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:         if ($domNode instanceof DOMProcessingInstruction) {",
          "75:             return $this->handleInvalidNode($domNode);",
          "76:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "248:         if (",
          "249:             ($domNode instanceof DOMComment && $this->behavior->shallEncodeInvalidComment())",
          "250:             || ($domNode instanceof DOMCdataSection && $this->behavior->shallEncodeInvalidCdataSection())",
          "251:         ) {",
          "252:             $this->log('Found unexpected node {nodeName}', [",
          "253:                 'behavior' => $this->behavior->getName(),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "256:             || ($domNode instanceof DOMProcessingInstruction && $this->behavior->shallEncodeInvalidProcessingInstruction())",
          "",
          "---------------"
        ],
        "tests/CommonBuilderTest.php||tests/CommonBuilderTest.php": [
          "File: tests/CommonBuilderTest.php -> tests/CommonBuilderTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "263:                 '<!-- &lt;&quot;comment&quot;&gt; -->',",
          "264:                 '<!-- &lt;&quot;comment&quot;&gt; -->',",
          "265:             ],",
          "266:             '#915' => [",
          "267:                 '#text',",
          "268:                 '#text',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "266:             '#912' => [",
          "267:                 '<!---><p>',",
          "268:                 '<!---&gt;&lt;p&gt;-->',",
          "269:             ],",
          "270:             '#913' => [",
          "271:                 '<!---!><p>',",
          "272:                 '<!---!&gt;&lt;p&gt;-->',",
          "273:             ],",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "303:                 '<p class=\"{&quot;json&quot;:true}\">value</p>',",
          "304:                 '<p class=\"{&quot;json&quot;:true}\">value</p>',",
          "305:             ],",
          "306:         ];",
          "307:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "314:             '#941' => [",
          "315:                 '<?xml >s<img src=x onerror=alert(1)> ?>',",
          "316:                 '&lt;?xml &gt;s&lt;img src=x onerror=alert(1)&gt; ?&gt;',",
          "317:             ],",
          "",
          "---------------"
        ]
      }
    }
  ]
}