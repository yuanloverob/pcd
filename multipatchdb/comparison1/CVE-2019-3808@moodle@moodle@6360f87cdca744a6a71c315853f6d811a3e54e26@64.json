{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f11a7d6a053c88c658121c63b401af70428bf0e1",
      "candidate_info": {
        "commit_hash": "f11a7d6a053c88c658121c63b401af70428bf0e1",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f11a7d6a053c88c658121c63b401af70428bf0e1",
        "files": [
          "lib/classes/oauth2/access_token.php",
          "lib/classes/oauth2/client.php",
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "lib/oauthlib.php",
          "version.php"
        ],
        "message": "MDL-63696 oauth2: Store system account access tokens in DB",
        "before_after_code_files": [
          "lib/classes/oauth2/access_token.php||lib/classes/oauth2/access_token.php",
          "lib/classes/oauth2/client.php||lib/classes/oauth2/client.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/oauthlib.php||lib/oauthlib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/classes/oauth2/access_token.php||lib/classes/oauth2/access_token.php": [
          "File: lib/classes/oauth2/access_token.php -> lib/classes/oauth2/access_token.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace core\\oauth2;",
          "26: defined('MOODLE_INTERNAL') || die();",
          "28: use core\\persistent;",
          "43: class access_token extends persistent {",
          "46:     const TABLE = 'oauth2_access_token';",
          "53:     protected static function define_properties() {",
          "54:         return array(",
          "57:             'issuerid' => array(",
          "58:                 'type' => PARAM_INT",
          "59:             ),",
          "60:             'token' => array(",
          "61:                 'type' => PARAM_RAW,",
          "62:             ),",
          "63:             'expires' => array(",
          "64:                 'type' => PARAM_INT,",
          "65:             ),",
          "66:             'scope' => array(",
          "67:                 'type' => PARAM_RAW,",
          "68:             ),",
          "69:         );",
          "70:     }",
          "71: }",
          "",
          "---------------"
        ],
        "lib/classes/oauth2/client.php||lib/classes/oauth2/client.php": [
          "File: lib/classes/oauth2/client.php -> lib/classes/oauth2/client.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:         return $name;",
          "153:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "161:     protected function store_token($token) {",
          "162:         if (!$this->system) {",
          "163:             parent::store_token($token);",
          "164:             return;",
          "165:         }",
          "167:         $this->accesstoken = $token;",
          "170:         $persistedtoken = access_token::get_record(['issuerid' => $this->issuer->get('id')]);",
          "171:         if ($token !== null) {",
          "172:             if (!$persistedtoken) {",
          "173:                 $persistedtoken = new access_token();",
          "174:                 $persistedtoken->set('issuerid', $this->issuer->get('id'));",
          "175:             }",
          "177:             $persistedtoken->set('token', $token->token);",
          "178:             $persistedtoken->set('expires', $token->expires);",
          "179:             $persistedtoken->set('scope', $token->scope);",
          "180:             $persistedtoken->save();",
          "181:         } else {",
          "182:             if ($persistedtoken) {",
          "183:                 $persistedtoken->delete();",
          "184:             }",
          "185:         }",
          "186:     }",
          "193:     protected function get_stored_token() {",
          "194:         if ($this->system) {",
          "195:             $token = access_token::get_record(['issuerid' => $this->issuer->get('id')]);",
          "196:             if ($token !== false) {",
          "197:                 return $token->to_record();",
          "198:             }",
          "199:             return null;",
          "200:         }",
          "202:         return parent::get_stored_token();",
          "203:     }",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2771:         upgrade_main_savepoint(true, 2018110700.01);",
          "2772:     }",
          "2774:     return true;",
          "2775: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2774:     if ($oldversion < 2018111300.01) {",
          "2776:         $table = new xmldb_table('oauth2_access_token');",
          "2779:         $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null);",
          "2780:         $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2781:         $table->add_field('timemodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2782:         $table->add_field('usermodified', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2783:         $table->add_field('issuerid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2784:         $table->add_field('token', XMLDB_TYPE_TEXT, null, null, XMLDB_NOTNULL, null, null);",
          "2785:         $table->add_field('expires', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null);",
          "2786:         $table->add_field('scope', XMLDB_TYPE_TEXT, null, null, XMLDB_NOTNULL, null, null);",
          "2789:         $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id']);",
          "2790:         $table->add_key('issueridkey', XMLDB_KEY_FOREIGN_UNIQUE, ['issuerid'], 'oauth2_issuer', ['id']);",
          "2793:         if (!$dbman->table_exists($table)) {",
          "2794:             $dbman->create_table($table);",
          "2795:         }",
          "2798:         upgrade_main_savepoint(true, 2018111300.01);",
          "2799:     }",
          "",
          "---------------"
        ],
        "lib/oauthlib.php||lib/oauthlib.php": [
          "File: lib/oauthlib.php -> lib/oauthlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "397:     protected $scope = '';",
          "401:     protected $refreshtoken = '';",
          "",
          "[Removed Lines]",
          "399:     private $accesstoken = null;",
          "",
          "[Added Lines]",
          "399:     protected $accesstoken = null;",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018111300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1f39068e0325981191a09737954cc4e2358487a0",
      "candidate_info": {
        "commit_hash": "1f39068e0325981191a09737954cc4e2358487a0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1f39068e0325981191a09737954cc4e2358487a0",
        "files": [
          "lang/en/course.php",
          "lang/en/user.php",
          "lib/db/upgrade.php",
          "user/classes/analytics/target/upcoming_activities_due.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-65248' of git://github.com/stronk7/moodle",
        "before_after_code_files": [
          "lang/en/course.php||lang/en/course.php",
          "lang/en/user.php||lang/en/user.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "user/classes/analytics/target/upcoming_activities_due.php||user/classes/analytics/target/upcoming_activities_due.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lang/en/course.php||lang/en/course.php": [
          "File: lang/en/course.php -> lang/en/course.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "62: $string['target:coursegradetopass_help'] = 'This target describes whether the student is at risk of not getting the minimum grade to pass the course.';",
          "63: $string['target:noteachingactivity'] = 'No teaching';",
          "64: $string['target:noteachingactivity_help'] = 'This target describes whether courses due to start in the coming week will have teaching activity.';",
          "67: $string['targetlabelstudentcompletionno'] = 'Student who is likely to meet the course completion conditions';",
          "68: $string['targetlabelstudentcompletionyes'] = 'Student at risk of not meeting the course completion conditions';",
          "69: $string['targetlabelstudentcompetenciesno'] = 'Student who is likely to achieve the competencies assigned to a course';",
          "",
          "[Removed Lines]",
          "65: $string['target:upcomingactivitiesdue'] = 'Upcoming activities due';",
          "66: $string['target:upcomingactivitiesdue_help'] = 'This target generates reminders for upcoming activities due.';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73: $string['targetlabelstudentgradetopassno'] = 'Student who is likely to meet the minimum grade to pass the course.';",
          "74: $string['targetlabelstudentgradetopassyes'] = 'Student at risk of not meeting the minimum grade to pass the course.';",
          "75: $string['targetlabelteachingyes'] = 'Users with teaching capabilities have access to the course';",
          "",
          "[Removed Lines]",
          "76: $string['targetlabelteachingno'] = 'No teaching';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lang/en/user.php||lang/en/user.php": [
          "File: lang/en/user.php -> lang/en/user.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "125: $string['privacy:profileimagespath'] = 'Profile images';",
          "126: $string['privacy:privatefilespath'] = 'Private files';",
          "127: $string['privacy:sessionpath'] = 'Session data';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128: $string['target:upcomingactivitiesdue'] = 'Upcoming activities due';",
          "129: $string['target:upcomingactivitiesdue_help'] = 'This target generates reminders for upcoming activities due.';",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3184:         upgrade_main_savepoint(true, 2019041800.01);",
          "3185:     }",
          "3211:     if ($oldversion < 2019042200.01) {",
          "",
          "[Removed Lines]",
          "3187:     if ($oldversion < 2019041900.00) {",
          "3189:         $params = [",
          "3190:             'target' => '\\core\\analytics\\target\\no_teaching',",
          "3191:         ];",
          "3192:         $models = $DB->get_records('analytics_models', $params);",
          "3193:         foreach ($models as $model) {",
          "3194:             $model->target = '\\core_course\\analytics\\target\\no_teaching';",
          "3195:             $DB->update_record('analytics_models', $model);",
          "3196:         }",
          "3198:         $params = [",
          "3199:             'target' => '\\core\\analytics\\target\\course_dropout',",
          "3200:         ];",
          "3201:         $models = $DB->get_records('analytics_models', $params);",
          "3202:         foreach ($models as $model) {",
          "3203:             $model->target = '\\core_course\\analytics\\target\\course_dropout';",
          "3204:             $DB->update_record('analytics_models', $model);",
          "3205:         }",
          "3208:         upgrade_main_savepoint(true, 2019041900.00);",
          "3209:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3222:         upgrade_main_savepoint(true, 2019042200.01);",
          "3223:     }",
          "3225:     return true;",
          "3226: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3201:     if ($oldversion < 2019042200.02) {",
          "3204:         $targets = [",
          "3205:             '\\core\\analytics\\target\\course_competencies' => '\\core_course\\analytics\\target\\course_competencies',",
          "3206:             '\\core\\analytics\\target\\course_completion' => '\\core_course\\analytics\\target\\course_completion',",
          "3207:             '\\core\\analytics\\target\\course_dropout' => '\\core_course\\analytics\\target\\course_dropout',",
          "3208:             '\\core\\analytics\\target\\course_gradetopass' => '\\core_course\\analytics\\target\\course_gradetopass',",
          "3209:             '\\core\\analytics\\target\\no_teaching' => '\\core_course\\analytics\\target\\no_teaching',",
          "3210:         ];",
          "3212:         foreach ($targets as $oldclass => $newclass) {",
          "3213:             $DB->set_field('analytics_models', 'target', $newclass, ['target' => $oldclass]);",
          "3214:         }",
          "3217:         upgrade_main_savepoint(true, 2019042200.02);",
          "3218:     }",
          "",
          "---------------"
        ],
        "user/classes/analytics/target/upcoming_activities_due.php||user/classes/analytics/target/upcoming_activities_due.php": [
          "File: user/classes/analytics/target/upcoming_activities_due.php -> user/classes/analytics/target/upcoming_activities_due.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     public static function get_name() : \\lang_string {",
          "66:     }",
          "",
          "[Removed Lines]",
          "65:         return new \\lang_string('target:upcomingactivitiesdue');",
          "",
          "[Added Lines]",
          "65:         return new \\lang_string('target:upcomingactivitiesdue', 'user');",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019042200.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019042200.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9e7c3978895c7cab585c2f5234ca536151d3bef6",
      "candidate_info": {
        "commit_hash": "9e7c3978895c7cab585c2f5234ca536151d3bef6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9e7c3978895c7cab585c2f5234ca536151d3bef6",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018060700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180607)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018061400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180614)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5dae8c051579b6d79dba4763d45500b049fc0fb5",
      "candidate_info": {
        "commit_hash": "5dae8c051579b6d79dba4763d45500b049fc0fb5",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5dae8c051579b6d79dba4763d45500b049fc0fb5",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.8dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019060600.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190606)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019061400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190614)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eb770889918bd8acb51178f6df7e52c96672e2ed",
      "candidate_info": {
        "commit_hash": "eb770889918bd8acb51178f6df7e52c96672e2ed",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/eb770889918bd8acb51178f6df7e52c96672e2ed",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.7.2+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052002.03;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7.2+ (Build: 20190913)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019052002.04;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7.2+ (Build: 20190920)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}