{
  "cve_id": "CVE-2017-12631",
  "cve_desc": "Apache CXF Fediz ships with a number of container-specific plugins to enable WS-Federation for applications. A CSRF (Cross Style Request Forgery) style vulnerability has been found in the Spring 2, Spring 3 and Spring 4 plugins in versions before 1.4.3 and 1.3.3. The vulnerability can result in a security context that is set up using a malicious client's roles for the given enduser.",
  "repo": "apache/cxf-fediz",
  "patch_hash": "ccdb12b26ff89e0a998a333e84dd84bd713ac76c",
  "patch_info": {
    "commit_hash": "ccdb12b26ff89e0a998a333e84dd84bd713ac76c",
    "repo": "apache/cxf-fediz",
    "commit_url": "https://github.com/apache/cxf-fediz/commit/ccdb12b26ff89e0a998a333e84dd84bd713ac76c",
    "files": [
      "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java",
      "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java",
      "systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java",
      "systests/webapps/springWebapp/src/main/webapp/WEB-INF/applicationContext-security.xml"
    ],
    "message": "Some improvements to the Spring plugins",
    "before_after_code_files": [
      "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java",
      "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java",
      "systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java||systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java"
    ]
  },
  "patch_diff": {
    "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java": [
      "File: plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java -> plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "129:     private void verifySavedState(HttpServletRequest request) {",
      "130:         HttpSession session = request.getSession(false);",
      "138:         }",
      "139:     }",
      "",
      "[Removed Lines]",
      "131:         if (session != null) {",
      "132:             String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "133:             String state = getState(request);",
      "134:             if (savedContext != null && !savedContext.equals(state)) {",
      "135:                 logger.warn(\"The received state does not match the state saved in the context\");",
      "136:                 throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "137:             }",
      "",
      "[Added Lines]",
      "132:         if (session == null) {",
      "133:             logger.warn(\"The received state does not match the state saved in the context\");",
      "134:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "135:         }",
      "137:         String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "138:         String state = getState(request);",
      "139:         if (savedContext == null || !savedContext.equals(state)) {",
      "140:             logger.warn(\"The received state does not match the state saved in the context\");",
      "141:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "143:         session.removeAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "",
      "---------------"
    ],
    "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java": [
      "File: plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java -> plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "129:     private void verifySavedState(HttpServletRequest request) {",
      "130:         HttpSession session = request.getSession(false);",
      "138:         }",
      "139:     }",
      "",
      "[Removed Lines]",
      "131:         if (session != null) {",
      "132:             String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "133:             String state = getState(request);",
      "134:             if (savedContext != null && !savedContext.equals(state)) {",
      "135:                 logger.warn(\"The received state does not match the state saved in the context\");",
      "136:                 throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "137:             }",
      "",
      "[Added Lines]",
      "132:         if (session == null) {",
      "133:             logger.warn(\"The received state does not match the state saved in the context\");",
      "134:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "135:         }",
      "137:         String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "138:         String state = getState(request);",
      "139:         if (savedContext == null || !savedContext.equals(state)) {",
      "140:             logger.warn(\"The received state does not match the state saved in the context\");",
      "141:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
      "143:         session.removeAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
      "",
      "---------------"
    ],
    "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java": [
      "File: systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java -> systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring3Test.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "159:         csrfAttackTest(url);",
      "160:     }",
      "162: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "162:     @Override",
      "163:     @org.junit.Test",
      "164:     public void testCSRFAttack2() throws Exception {",
      "165:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName()",
      "166:             + \"/j_spring_fediz_security_check\";",
      "167:         csrfAttackTest2(url);",
      "168:     }",
      "",
      "---------------"
    ],
    "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java": [
      "File: systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java -> systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/SpringTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "157:             + \"/j_spring_fediz_security_check\";",
      "158:         csrfAttackTest(url);",
      "159:     }",
      "160: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "161:     @Override",
      "162:     @org.junit.Test",
      "163:     public void testCSRFAttack2() throws Exception {",
      "164:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName()",
      "165:             + \"/j_spring_fediz_security_check\";",
      "166:         csrfAttackTest2(url);",
      "167:     }",
      "",
      "---------------"
    ],
    "systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java||systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java": [
      "File: systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java -> systests/tests/src/test/java/org/apache/cxf/fediz/integrationtests/AbstractTests.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "800:     }",
      "802: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "802:     @org.junit.Test",
      "803:     public void testCSRFAttack2() throws Exception {",
      "804:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName() + \"/secure/fedservlet\";",
      "805:         csrfAttackTest2(url);",
      "806:     }",
      "808:     protected void csrfAttackTest2(String rpURL) throws Exception {",
      "809:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName() + \"/secure/fedservlet\";",
      "812:         WebClient webClient2 = new WebClient();",
      "813:         webClient2.getOptions().setUseInsecureSSL(true);",
      "814:         webClient2.getCredentialsProvider().setCredentials(",
      "815:             new AuthScope(\"localhost\", Integer.parseInt(getIdpHttpsPort())),",
      "816:             new UsernamePasswordCredentials(\"bob\", \"bob\"));",
      "818:         webClient2.getOptions().setJavaScriptEnabled(false);",
      "819:         final HtmlPage idpPage2 = webClient2.getPage(url);",
      "820:         webClient2.getOptions().setJavaScriptEnabled(true);",
      "821:         Assert.assertEquals(\"IDP SignIn Response Form\", idpPage2.getTitleText());",
      "826:         WebRequest request = new WebRequest(new URL(rpURL), HttpMethod.POST);",
      "827:         request.setRequestParameters(new ArrayList<NameValuePair>());",
      "829:         DomNodeList<DomElement> results = idpPage2.getElementsByTagName(\"input\");",
      "831:         for (DomElement result : results) {",
      "832:             if (\"wresult\".equals(result.getAttributeNS(null, \"name\"))",
      "833:                 || \"wa\".equals(result.getAttributeNS(null, \"name\"))",
      "834:                 || \"wctx\".equals(result.getAttributeNS(null, \"name\"))) {",
      "835:                 String value = result.getAttributeNS(null, \"value\");",
      "836:                 request.getRequestParameters().add(new NameValuePair(result.getAttributeNS(null, \"name\"), value));",
      "837:             }",
      "838:         }",
      "840:         WebClient webClient = new WebClient();",
      "841:         webClient.getOptions().setUseInsecureSSL(true);",
      "843:         try {",
      "844:             webClient.getPage(request);",
      "845:             Assert.fail(\"Failure expected on a CSRF attack\");",
      "846:         } catch (FailingHttpStatusCodeException ex) {",
      "848:         }",
      "850:         webClient.close();",
      "851:         webClient2.close();",
      "853:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e7127129dbc0f4ee83985052085e185e750cebbf",
      "candidate_info": {
        "commit_hash": "e7127129dbc0f4ee83985052085e185e750cebbf",
        "repo": "apache/cxf-fediz",
        "commit_url": "https://github.com/apache/cxf-fediz/commit/e7127129dbc0f4ee83985052085e185e750cebbf",
        "files": [
          "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java",
          "systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java",
          "systests/webapps/springWebapp/src/main/webapp/WEB-INF/applicationContext-security.xml"
        ],
        "message": "Some improvements to the Spring plugins",
        "before_after_code_files": [
          "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java||systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java",
          "systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java||systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
            "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java"
          ],
          "candidate": [
            "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
            "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java"
          ]
        }
      },
      "candidate_diff": {
        "plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java": [
          "File: plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java -> plugins/spring/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "129:     private void verifySavedState(HttpServletRequest request) {",
          "130:         HttpSession session = request.getSession(false);",
          "138:         }",
          "139:     }",
          "",
          "[Removed Lines]",
          "131:         if (session != null) {",
          "132:             String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "133:             String state = getState(request);",
          "134:             if (savedContext != null && !savedContext.equals(state)) {",
          "135:                 logger.warn(\"The received state does not match the state saved in the context\");",
          "136:                 throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "137:             }",
          "",
          "[Added Lines]",
          "132:         if (session == null) {",
          "133:             logger.warn(\"The received state does not match the state saved in the context\");",
          "134:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "135:         }",
          "137:         String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "138:         String state = getState(request);",
          "139:         if (savedContext == null || !savedContext.equals(state)) {",
          "140:             logger.warn(\"The received state does not match the state saved in the context\");",
          "141:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "143:         session.removeAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "",
          "---------------"
        ],
        "plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java": [
          "File: plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java -> plugins/spring3/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "129:     private void verifySavedState(HttpServletRequest request) {",
          "130:         HttpSession session = request.getSession(false);",
          "138:         }",
          "139:     }",
          "",
          "[Removed Lines]",
          "131:         if (session != null) {",
          "132:             String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "133:             String state = getState(request);",
          "134:             if (savedContext != null && !savedContext.equals(state)) {",
          "135:                 logger.warn(\"The received state does not match the state saved in the context\");",
          "136:                 throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "137:             }",
          "",
          "[Added Lines]",
          "132:         if (session == null) {",
          "133:             logger.warn(\"The received state does not match the state saved in the context\");",
          "134:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "135:         }",
          "137:         String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "138:         String state = getState(request);",
          "139:         if (savedContext == null || !savedContext.equals(state)) {",
          "140:             logger.warn(\"The received state does not match the state saved in the context\");",
          "141:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "143:         session.removeAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "",
          "---------------"
        ],
        "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java": [
          "File: systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java -> systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/Spring3Test.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:         csrfAttackTest(url);",
          "153:     }",
          "155: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "155:     @Override",
          "156:     @org.junit.Test",
          "157:     public void testCSRFAttack2() throws Exception {",
          "158:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName()",
          "159:             + \"/j_spring_fediz_security_check\";",
          "160:         csrfAttackTest2(url);",
          "161:     }",
          "",
          "---------------"
        ],
        "systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java||systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java": [
          "File: systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java -> systests/spring/src/test/java/org/apache/cxf/fediz/systests/spring/SpringTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "150:             + \"/j_spring_fediz_security_check\";",
          "151:         csrfAttackTest(url);",
          "152:     }",
          "153: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "154:     @Override",
          "155:     @org.junit.Test",
          "156:     public void testCSRFAttack2() throws Exception {",
          "157:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName()",
          "158:             + \"/j_spring_fediz_security_check\";",
          "159:         csrfAttackTest2(url);",
          "160:     }",
          "",
          "---------------"
        ],
        "systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java||systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java": [
          "File: systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java -> systests/tests/src/test/java/org/apache/cxf/fediz/systests/common/AbstractTests.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "802:     }",
          "804: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "804:     @org.junit.Test",
          "805:     public void testCSRFAttack2() throws Exception {",
          "806:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName() + \"/secure/fedservlet\";",
          "807:         csrfAttackTest2(url);",
          "808:     }",
          "810:     protected void csrfAttackTest2(String rpURL) throws Exception {",
          "811:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName() + \"/secure/fedservlet\";",
          "814:         WebClient webClient2 = new WebClient();",
          "815:         webClient2.getOptions().setUseInsecureSSL(true);",
          "816:         webClient2.getCredentialsProvider().setCredentials(",
          "817:             new AuthScope(\"localhost\", Integer.parseInt(getIdpHttpsPort())),",
          "818:             new UsernamePasswordCredentials(\"bob\", \"bob\"));",
          "820:         webClient2.getOptions().setJavaScriptEnabled(false);",
          "821:         final HtmlPage idpPage2 = webClient2.getPage(url);",
          "822:         webClient2.getOptions().setJavaScriptEnabled(true);",
          "823:         Assert.assertEquals(\"IDP SignIn Response Form\", idpPage2.getTitleText());",
          "828:         WebRequest request = new WebRequest(new URL(rpURL), HttpMethod.POST);",
          "829:         request.setRequestParameters(new ArrayList<NameValuePair>());",
          "831:         DomNodeList<DomElement> results = idpPage2.getElementsByTagName(\"input\");",
          "833:         for (DomElement result : results) {",
          "834:             if (\"wresult\".equals(result.getAttributeNS(null, \"name\"))",
          "835:                 || \"wa\".equals(result.getAttributeNS(null, \"name\"))",
          "836:                 || \"wctx\".equals(result.getAttributeNS(null, \"name\"))) {",
          "837:                 String value = result.getAttributeNS(null, \"value\");",
          "838:                 request.getRequestParameters().add(new NameValuePair(result.getAttributeNS(null, \"name\"), value));",
          "839:             }",
          "840:         }",
          "842:         WebClient webClient = new WebClient();",
          "843:         webClient.getOptions().setUseInsecureSSL(true);",
          "845:         try {",
          "846:             webClient.getPage(request);",
          "847:             Assert.fail(\"Failure expected on a CSRF attack\");",
          "848:         } catch (FailingHttpStatusCodeException ex) {",
          "850:         }",
          "852:         webClient.close();",
          "853:         webClient2.close();",
          "855:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "509b1d0b9919beeefeff255e231cba9f26b04c95",
      "candidate_info": {
        "commit_hash": "509b1d0b9919beeefeff255e231cba9f26b04c95",
        "repo": "apache/cxf-fediz",
        "commit_url": "https://github.com/apache/cxf-fediz/commit/509b1d0b9919beeefeff255e231cba9f26b04c95",
        "files": [
          "plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java"
        ],
        "message": "Porting fix to spring2",
        "before_after_code_files": [
          "plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java||plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java": [
          "File: plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java -> plugins/spring2/src/main/java/org/apache/cxf/fediz/spring/web/FederationAuthenticationFilter.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "135:     private void verifySavedState(HttpServletRequest request) {",
          "136:         HttpSession session = request.getSession(false);",
          "144:         }",
          "145:     }",
          "147:     private String getState(ServletRequest request) {",
          "",
          "[Removed Lines]",
          "137:         if (session != null) {",
          "138:             String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "139:             String state = getState(request);",
          "140:             if (savedContext != null && !savedContext.equals(state)) {",
          "141:                 logger.warn(\"The received state does not match the state saved in the context\");",
          "142:                 throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "143:             }",
          "",
          "[Added Lines]",
          "138:         if (session == null) {",
          "139:             logger.warn(\"The received state does not match the state saved in the context\");",
          "140:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "141:         }",
          "143:         String savedContext = (String)session.getAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "144:         String state = getState(request);",
          "145:         if (savedContext == null || !savedContext.equals(state)) {",
          "146:             logger.warn(\"The received state does not match the state saved in the context\");",
          "147:             throw new BadCredentialsException(\"The received state does not match the state saved in the context\");",
          "149:         session.removeAttribute(FederationAuthenticationEntryPoint.SAVED_CONTEXT);",
          "",
          "---------------"
        ],
        "systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java||systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java": [
          "File: systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java -> systests/spring/src/test/java/org/apache/cxf/fediz/integrationtests/Spring2Test.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "258:         csrfAttackTest(url);",
          "259:     }",
          "261: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "261:     @Override",
          "262:     @org.junit.Test",
          "263:     public void testCSRFAttack2() throws Exception {",
          "264:         String url = \"https://localhost:\" + getRpHttpsPort() + \"/\" + getServletContextName()",
          "265:             + \"/j_spring_fediz_security_check\";",
          "266:         csrfAttackTest2(url);",
          "267:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}