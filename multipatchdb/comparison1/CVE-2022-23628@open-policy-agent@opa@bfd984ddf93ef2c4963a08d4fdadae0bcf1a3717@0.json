{
  "cve_id": "CVE-2022-23628",
  "cve_desc": "OPA is an open source, general-purpose policy engine. Under certain conditions, pretty-printing an abstract syntax tree (AST) that contains synthetic nodes could change the logic of some statements by reordering array literals. Example of policies impacted are those that parse and compare web paths. **All of these** three conditions have to be met to create an adverse effect: 1. An AST of Rego had to be **created programmatically** such that it ends up containing terms without a location (such as wildcard variables). 2. The AST had to be **pretty-printed** using the `github.com/open-policy-agent/opa/format` package. 3. The result of the pretty-printing had to be **parsed and evaluated again** via an OPA instance using the bundles, or the Golang packages. If any of these three conditions are not met, you are not affected. Notably, all three would be true if using **optimized bundles**, i.e. bundles created with `opa build -O=1` or higher. In that case, the optimizer would fulfil condition (1.), the result of that would be pretty-printed when writing the bundle to disk, fulfilling (2.). When the bundle was then used, we'd satisfy (3.). As a workaround users may disable optimization when creating bundles.",
  "repo": "open-policy-agent/opa",
  "patch_hash": "bfd984ddf93ef2c4963a08d4fdadae0bcf1a3717",
  "patch_info": {
    "commit_hash": "bfd984ddf93ef2c4963a08d4fdadae0bcf1a3717",
    "repo": "open-policy-agent/opa",
    "commit_url": "https://github.com/open-policy-agent/opa/commit/bfd984ddf93ef2c4963a08d4fdadae0bcf1a3717",
    "files": [
      "format/format.go",
      "format/testfiles/test.rego.formatted",
      "format/testfiles/test_issue_3849.rego",
      "format/testfiles/test_issue_3849.rego.formatted"
    ],
    "message": "format: make groupIterable sort by row\n\nBefore, it depended on the elements being passed in ordered by their rows.\nBefore https://github.com/open-policy-agent/opa/pull/3823, the iteration\norder was the same as the row order; but with sorting the keys slice (which\ndetermines iteration order) on creation, that was changed.\n\nNow, we'll sort the elements within `groupIterable`.\n\nFixes #3849.\n\nSigned-off-by: Stephan Renatus <stephan.renatus@gmail.com>",
    "before_after_code_files": [
      "format/format.go||format/format.go",
      "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted",
      "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego",
      "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted"
    ]
  },
  "patch_diff": {
    "format/format.go||format/format.go": [
      "File: format/format.go -> format/format.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "810:  }",
      "811: }",
      "814:  var cur []interface{}",
      "815:  for i, t := range elements {",
      "817:   lineDiff := loc.Row - last.Row",
      "818:   if lineDiff > 0 && i > 0 {",
      "819:    lines = append(lines, cur)",
      "",
      "[Removed Lines]",
      "813: func groupIterable(elements []interface{}, last *ast.Location) (lines [][]interface{}) {",
      "816:   loc := getLoc(t)",
      "",
      "[Added Lines]",
      "815: func groupIterable(elements []interface{}, last *ast.Location) [][]interface{} {",
      "816:  sort.Slice(elements, func(i, j int) bool {",
      "817:   return locLess(elements[i], elements[j])",
      "818:  })",
      "819:  var lines [][]interface{}",
      "822:   elem := t",
      "823:   loc := getLoc(elem)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "821:   }",
      "823:   last = loc",
      "825:  }",
      "826:  return append(lines, cur)",
      "827: }",
      "",
      "[Removed Lines]",
      "824:   cur = append(cur, t)",
      "",
      "[Added Lines]",
      "831:   cur = append(cur, elem)",
      "",
      "---------------"
    ],
    "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted": [
      "File: format/testfiles/test.rego.formatted -> format/testfiles/test.rego.formatted",
      "--- Hunk 1 ---",
      "[Context before]",
      "19:  g(x, \"foo\") = z",
      "20: }",
      "24: partial_obj[\"x\"] = 1",
      "",
      "[Removed Lines]",
      "22: globals = {\"fizz\": \"buzz\", \"foo\": \"bar\"}",
      "",
      "[Added Lines]",
      "22: globals = {",
      "23:  \"foo\": \"bar\",",
      "24:  \"fizz\": \"buzz\",",
      "25: }",
      "",
      "---------------"
    ],
    "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego": [
      "File: format/testfiles/test_issue_3849.rego -> format/testfiles/test_issue_3849.rego",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: package test_issue_3849",
      "3: test_require_context {",
      "4:  require_context(\"monkey\", \"eat\", \"banana\") with input as {",
      "5:   \"principal\": {\"id\": 101, \"type\": \"monkey\"},",
      "6:   \"action\": \"eat\",",
      "7:   \"entity\": {\"id\": 102, \"type\": \"banana\"},",
      "8:  }",
      "9: }",
      "11: test_contrived {",
      "12:  allow with input as {",
      "13:   \"a\": 101,",
      "14:   \"b\": 101,",
      "15:   \"z\": 101,",
      "16:   \"y\": 101,",
      "17:   \"x\": 101,",
      "18:   \"w\": 101,",
      "19:   \"v\": 101,",
      "20:   \"u\": 101,",
      "21:   \"t\": 101,",
      "22:   \"s\": 101,",
      "23:   \"r\": 101,",
      "24:   \"q\": 101,",
      "25:   \"p\": 101,",
      "26:   \"o\": 101,",
      "27:   \"n\": 101,",
      "28:   \"j\": 101,",
      "29:   \"k\": 101,",
      "30:   \"l\": 101,",
      "31:   \"m\": 101,",
      "32:  }",
      "33: }",
      "",
      "---------------"
    ],
    "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted": [
      "File: format/testfiles/test_issue_3849.rego.formatted -> format/testfiles/test_issue_3849.rego.formatted",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: package test_issue_3849",
      "3: test_require_context {",
      "4:  require_context(\"monkey\", \"eat\", \"banana\") with input as {",
      "5:   \"principal\": {\"id\": 101, \"type\": \"monkey\"},",
      "6:   \"action\": \"eat\",",
      "7:   \"entity\": {\"id\": 102, \"type\": \"banana\"},",
      "8:  }",
      "9: }",
      "11: test_contrived {",
      "12:  allow with input as {",
      "13:   \"a\": 101,",
      "14:   \"b\": 101,",
      "15:   \"z\": 101,",
      "16:   \"y\": 101,",
      "17:   \"x\": 101,",
      "18:   \"w\": 101,",
      "19:   \"v\": 101,",
      "20:   \"u\": 101,",
      "21:   \"t\": 101,",
      "22:   \"s\": 101,",
      "23:   \"r\": 101,",
      "24:   \"q\": 101,",
      "25:   \"p\": 101,",
      "26:   \"o\": 101,",
      "27:   \"n\": 101,",
      "28:   \"j\": 101,",
      "29:   \"k\": 101,",
      "30:   \"l\": 101,",
      "31:   \"m\": 101,",
      "32:  }",
      "33: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bff539985626b2a4b8a76eebcb884a5968f0d484",
      "candidate_info": {
        "commit_hash": "bff539985626b2a4b8a76eebcb884a5968f0d484",
        "repo": "open-policy-agent/opa",
        "commit_url": "https://github.com/open-policy-agent/opa/commit/bff539985626b2a4b8a76eebcb884a5968f0d484",
        "files": [
          "ast/compile_test.go",
          "ast/term.go",
          "ast/term_bench_test.go",
          "ast/term_test.go",
          "format/testfiles/test.rego.formatted",
          "rego/example_test.go",
          "test/cases/testdata/partialsetdoc/test-issue-3819.yaml"
        ],
        "message": "ast/term: don't sort an object's keys slice in-place (#3823)\n\n* ast/term: sort-on-insert for object.keys slice\n\nInstead of sorting on each call including Compare() or String(), we'll sort the key\nslice on insertion of a new value.\n\n* testcases: add case\n\nAs observed in the original issue, the failure does not happen on every\nrun. To observe the added test case _failing_ on branch main, use a test\ncall like\n\n    go test -v ./topdown -run TestRego/partialsetdoc:_object_sort_while_iter -count=10 -v\n\nThe added `sort_bindings: true` is not required for the topdown eval,\nbut when executing this on the wasm engine, the (unspecified, non-\nguaranteed) order is reversed.\n\nFixes #3819\n\nSigned-off-by: Stephan Renatus <stephan.renatus@gmail.com>",
        "before_after_code_files": [
          "ast/compile_test.go||ast/compile_test.go",
          "ast/term.go||ast/term.go",
          "ast/term_bench_test.go||ast/term_bench_test.go",
          "ast/term_test.go||ast/term_test.go",
          "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted",
          "rego/example_test.go||rego/example_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted"
          ],
          "candidate": [
            "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted"
          ]
        }
      },
      "candidate_diff": {
        "ast/compile_test.go||ast/compile_test.go": [
          "File: ast/compile_test.go -> ast/compile_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1907:    `,",
          "1908:    exp: `",
          "1909:     package test",
          "1911:    `,",
          "1912:    expRewrittenMap: map[Var]Var{",
          "1915:    },",
          "1916:   },",
          "1917:   {",
          "",
          "[Removed Lines]",
          "1910:     object_keys = true { {k: __local0__, \"k2\": __local1__} = {\"foo\": 1, \"k2\": 2} }",
          "1913:     Var(\"__local0__\"): Var(\"v1\"),",
          "1914:     Var(\"__local1__\"): Var(\"v2\"),",
          "",
          "[Added Lines]",
          "1910:     object_keys = true { {\"k2\": __local0__, k: __local1__} = {\"foo\": 1, \"k2\": 2} }",
          "1913:     Var(\"__local0__\"): Var(\"v2\"),",
          "1914:     Var(\"__local1__\"): Var(\"v1\"),",
          "",
          "---------------"
        ],
        "ast/term.go||ast/term.go": [
          "File: ast/term.go -> ast/term.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1800:  }",
          "1801:  a := obj",
          "1802:  b := other.(*object)",
          "1806:  minLen := len(a.keys)",
          "1807:  if len(b.keys) < len(a.keys) {",
          "1808:   minLen = len(b.keys)",
          "",
          "[Removed Lines]",
          "1804:  sort.Sort(a.keys)",
          "1805:  sort.Sort(b.keys)",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2055:  var b strings.Builder",
          "2056:  b.WriteRune('{')",
          "2060:   if i > 0 {",
          "2061:    b.WriteString(\", \")",
          "2062:   }",
          "",
          "[Removed Lines]",
          "2058:  sorted := objectElemSliceSorted(obj.keys)",
          "2059:  for i, elem := range sorted {",
          "",
          "[Added Lines]",
          "2055:  for i, elem := range obj.keys {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2260:   next:  head,",
          "2261:  }",
          "2262:  obj.elems[hash] = elem",
          "2264:  obj.hash = 0",
          "2266:  if k.IsGround() {",
          "",
          "[Removed Lines]",
          "2263:  obj.keys = append(obj.keys, elem)",
          "",
          "[Added Lines]",
          "2259:  i := sort.Search(len(obj.keys), func(i int) bool { return Compare(elem.key, obj.keys[i].key) < 0 })",
          "2260:  if i < len(obj.keys) {",
          "2262:   obj.keys = append(obj.keys, nil)   // add some space",
          "2263:   copy(obj.keys[i+1:], obj.keys[i:]) // move things over",
          "2264:   obj.keys[i] = elem                 // drop it in position",
          "2265:  } else {",
          "2266:   obj.keys = append(obj.keys, elem)",
          "2267:  }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2559:  return fmt.Sprintf(\"%v(%v)\", c[0], strings.Join(args, \", \"))",
          "2560: }",
          "2571: func termSliceCopy(a []*Term) []*Term {",
          "2572:  cpy := make([]*Term, len(a))",
          "2573:  for i := range a {",
          "",
          "[Removed Lines]",
          "2562: func objectElemSliceSorted(a objectElemSlice) objectElemSlice {",
          "2563:  b := make(objectElemSlice, len(a))",
          "2564:  for i := range b {",
          "2565:   b[i] = a[i]",
          "2566:  }",
          "2567:  sort.Sort(b)",
          "2568:  return b",
          "2569: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "ast/term_bench_test.go||ast/term_bench_test.go": [
          "File: ast/term_bench_test.go -> ast/term_bench_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: import (",
          "7:  \"encoding/json\"",
          "8:  \"fmt\"",
          "9:  \"strings\"",
          "10:  \"testing\"",
          "11: )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9:  \"math/rand\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "152:  }",
          "153: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "156: func BenchmarkObjectConstruction(b *testing.B) {",
          "157:  sizes := []int{5, 50, 500, 5000, 50000}",
          "159:  b.Run(\"random keys\", func(b *testing.B) {",
          "160:   for _, n := range sizes {",
          "161:    b.Run(fmt.Sprint(n), func(b *testing.B) {",
          "162:     obj := map[string]int{}",
          "163:     for i := 0; i < n; i++ {",
          "164:      j := rand.Intn(n)",
          "165:      obj[fmt.Sprint(j)] = i",
          "166:     }",
          "167:     benchObjectConstruction(b, obj)",
          "168:    })",
          "169:   }",
          "170:  })",
          "171:  b.Run(\"increasing keys\", func(b *testing.B) {",
          "172:   for _, n := range sizes {",
          "173:    b.Run(fmt.Sprint(n), func(b *testing.B) {",
          "174:     obj := map[string]int{}",
          "175:     for i := 0; i < n; i++ {",
          "176:      obj[fmt.Sprint(i)] = i",
          "177:     }",
          "178:     benchObjectConstruction(b, obj)",
          "179:    })",
          "180:   }",
          "181:  })",
          "182: }",
          "184: func benchObjectConstruction(b *testing.B, obj map[string]int) {",
          "185:  b.ResetTimer()",
          "186:  for i := 0; i < b.N; i++ {",
          "187:   val := MustInterfaceToValue(obj)",
          "188:   _, ok := val.(Object)",
          "189:   if !ok {",
          "190:    b.Fail()",
          "191:   }",
          "192:  }",
          "193: }",
          "",
          "---------------"
        ],
        "ast/term_test.go||ast/term_test.go": [
          "File: ast/term_test.go -> ast/term_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "8:  \"encoding/json\"",
          "9:  \"fmt\"",
          "10:  \"reflect\"",
          "11:  \"strings\"",
          "12:  \"testing\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11:  \"sort\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "262:  }",
          "263: }",
          "265: func TestTermBadJSON(t *testing.T) {",
          "267:  input := `{",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "266: func TestObjectInsertKeepsSorting(t *testing.T) {",
          "267:  keysSorted := func(o *object) func(int, int) bool {",
          "268:   return func(i, j int) bool {",
          "269:    return Compare(o.keys[i].key, o.keys[j].key) < 0",
          "270:   }",
          "271:  }",
          "273:  obj := NewObject(",
          "274:   [2]*Term{StringTerm(\"d\"), IntNumberTerm(4)},",
          "275:   [2]*Term{StringTerm(\"b\"), IntNumberTerm(2)},",
          "276:   [2]*Term{StringTerm(\"a\"), IntNumberTerm(1)},",
          "277:  )",
          "278:  o := obj.(*object)",
          "279:  act := sort.SliceIsSorted(o.keys, keysSorted(o))",
          "280:  if exp := true; act != exp {",
          "281:   t.Errorf(\"SliceIsSorted: expected %v, got %v\", exp, act)",
          "282:   for i := range o.keys {",
          "283:    t.Logf(\"elem[%d]: %v\", i, o.keys[i].key)",
          "284:   }",
          "285:  }",
          "287:  obj.Insert(StringTerm(\"c\"), IntNumberTerm(3))",
          "288:  act = sort.SliceIsSorted(o.keys, keysSorted(o))",
          "289:  if exp := true; act != exp {",
          "290:   t.Errorf(\"SliceIsSorted: expected %v, got %v\", exp, act)",
          "291:   for i := range o.keys {",
          "292:    t.Logf(\"elem[%d]: %v\", i, o.keys[i].key)",
          "293:   }",
          "294:  }",
          "295: }",
          "",
          "---------------"
        ],
        "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted": [
          "File: format/testfiles/test.rego.formatted -> format/testfiles/test.rego.formatted",
          "--- Hunk 1 ---",
          "[Context before]",
          "19:  g(x, \"foo\") = z",
          "20: }",
          "27: partial_obj[\"x\"] = 1",
          "",
          "[Removed Lines]",
          "22: globals = {",
          "23:  \"foo\": \"bar\",",
          "24:  \"fizz\": \"buzz\",",
          "25: }",
          "",
          "[Added Lines]",
          "22: globals = {\"fizz\": \"buzz\", \"foo\": \"bar\"}",
          "",
          "---------------"
        ],
        "rego/example_test.go||rego/example_test.go": [
          "File: rego/example_test.go -> rego/example_test.go"
        ]
      }
    },
    {
      "candidate_hash": "b5e7139a1140bcc6a3b0f38175d8dc2520797558",
      "candidate_info": {
        "commit_hash": "b5e7139a1140bcc6a3b0f38175d8dc2520797558",
        "repo": "open-policy-agent/opa",
        "commit_url": "https://github.com/open-policy-agent/opa/commit/b5e7139a1140bcc6a3b0f38175d8dc2520797558",
        "files": [
          "CHANGELOG.md",
          "ast/term_bench_test.go",
          "capabilities/v0.33.1.json",
          "format/format.go",
          "format/testfiles/test.rego.formatted",
          "format/testfiles/test_issue_3849.rego",
          "format/testfiles/test_issue_3849.rego.formatted"
        ],
        "message": "format: make groupIterable sort by row (#3851)\n\n* format: make groupIterable sort by row\n\nBefore, it depended on the elements being passed in ordered by their rows.\nBefore https://github.com/open-policy-agent/opa/pull/3823, the iteration\norder was the same as the row order; but with sorting the keys slice (which\ndetermines iteration order) on creation, that was changed.\n\nNow, we'll sort the elements within `groupIterable`.\n\nFixes #3849.\n\nAlso includes:\n\n* ast/term_bench_test: fix benchmark\n\nSince map iteration is randomized in golang, this benchmark didn't\nactually measure what was intended, but rather the presence or ab-\nsence of duplicate keys.\n\nNow, we'll create a set of keys to insert before, and either shuffle\nit or use it in its increasing order: to call `(Object).Insert()` in\na loop.\n\n* CHANGELOG/capabilities: update for v0.33.1 bugfix release\n\nSigned-off-by: Stephan Renatus <stephan.renatus@gmail.com>",
        "before_after_code_files": [
          "ast/term_bench_test.go||ast/term_bench_test.go",
          "format/format.go||format/format.go",
          "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted",
          "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego",
          "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "format/format.go||format/format.go",
            "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted",
            "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego",
            "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted"
          ],
          "candidate": [
            "format/format.go||format/format.go",
            "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted",
            "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego",
            "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted"
          ]
        }
      },
      "candidate_diff": {
        "ast/term_bench_test.go||ast/term_bench_test.go": [
          "File: ast/term_bench_test.go -> ast/term_bench_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:  \"math/rand\"",
          "10:  \"strings\"",
          "11:  \"testing\"",
          "12: )",
          "14: func BenchmarkObjectLookup(b *testing.B) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12:  \"time\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "156: func BenchmarkObjectConstruction(b *testing.B) {",
          "157:  sizes := []int{5, 50, 500, 5000, 50000}",
          "160:   for _, n := range sizes {",
          "161:    b.Run(fmt.Sprint(n), func(b *testing.B) {",
          "163:     for i := 0; i < n; i++ {",
          "166:     }",
          "168:    })",
          "169:   }",
          "170:  })",
          "171:  b.Run(\"increasing keys\", func(b *testing.B) {",
          "172:   for _, n := range sizes {",
          "173:    b.Run(fmt.Sprint(n), func(b *testing.B) {",
          "177:     }",
          "179:    })",
          "180:   }",
          "181:  })",
          "182: }",
          "",
          "[Removed Lines]",
          "159:  b.Run(\"random keys\", func(b *testing.B) {",
          "162:     obj := map[string]int{}",
          "164:      j := rand.Intn(n)",
          "165:      obj[fmt.Sprint(j)] = i",
          "167:     benchObjectConstruction(b, obj)",
          "174:     obj := map[string]int{}",
          "175:     for i := 0; i < n; i++ {",
          "176:      obj[fmt.Sprint(i)] = i",
          "178:     benchObjectConstruction(b, obj)",
          "184: func benchObjectConstruction(b *testing.B, obj map[string]int) {",
          "185:  b.ResetTimer()",
          "186:  for i := 0; i < b.N; i++ {",
          "187:   val := MustInterfaceToValue(obj)",
          "188:   _, ok := val.(Object)",
          "189:   if !ok {",
          "190:    b.Fail()",
          "191:   }",
          "192:  }",
          "193: }",
          "",
          "[Added Lines]",
          "159:  seed := time.Now().UnixNano()",
          "161:  b.Run(\"shuffled keys\", func(b *testing.B) {",
          "164:     es := []struct{ k, v int }{}",
          "166:      es = append(es, struct{ k, v int }{i, i})",
          "167:     }",
          "168:     rand.Seed(seed)",
          "169:     rand.Shuffle(len(es), func(i, j int) { es[i], es[j] = es[j], es[i] })",
          "170:     b.ResetTimer()",
          "171:     for i := 0; i < b.N; i++ {",
          "172:      obj := NewObject()",
          "173:      for _, e := range es {",
          "174:       obj.Insert(IntNumberTerm(e.k), IntNumberTerm(e.v))",
          "175:      }",
          "183:     es := []struct{ k, v int }{}",
          "184:     for v := 0; v < n; v++ {",
          "185:      es = append(es, struct{ k, v int }{v, v})",
          "186:     }",
          "187:     b.ResetTimer()",
          "188:     for i := 0; i < b.N; i++ {",
          "189:      obj := NewObject()",
          "190:      for _, e := range es {",
          "191:       obj.Insert(IntNumberTerm(e.k), IntNumberTerm(e.v))",
          "192:      }",
          "",
          "---------------"
        ],
        "format/format.go||format/format.go": [
          "File: format/format.go -> format/format.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "810:  }",
          "811: }",
          "814:  var cur []interface{}",
          "815:  for i, t := range elements {",
          "817:   lineDiff := loc.Row - last.Row",
          "818:   if lineDiff > 0 && i > 0 {",
          "819:    lines = append(lines, cur)",
          "",
          "[Removed Lines]",
          "813: func groupIterable(elements []interface{}, last *ast.Location) (lines [][]interface{}) {",
          "816:   loc := getLoc(t)",
          "",
          "[Added Lines]",
          "815: func groupIterable(elements []interface{}, last *ast.Location) [][]interface{} {",
          "816:  sort.Slice(elements, func(i, j int) bool {",
          "817:   return locLess(elements[i], elements[j])",
          "818:  })",
          "819:  var lines [][]interface{}",
          "822:   elem := t",
          "823:   loc := getLoc(elem)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "821:   }",
          "823:   last = loc",
          "825:  }",
          "826:  return append(lines, cur)",
          "827: }",
          "",
          "[Removed Lines]",
          "824:   cur = append(cur, t)",
          "",
          "[Added Lines]",
          "831:   cur = append(cur, elem)",
          "",
          "---------------"
        ],
        "format/testfiles/test.rego.formatted||format/testfiles/test.rego.formatted": [
          "File: format/testfiles/test.rego.formatted -> format/testfiles/test.rego.formatted",
          "--- Hunk 1 ---",
          "[Context before]",
          "19:  g(x, \"foo\") = z",
          "20: }",
          "24: partial_obj[\"x\"] = 1",
          "",
          "[Removed Lines]",
          "22: globals = {\"fizz\": \"buzz\", \"foo\": \"bar\"}",
          "",
          "[Added Lines]",
          "22: globals = {",
          "23:  \"foo\": \"bar\",",
          "24:  \"fizz\": \"buzz\",",
          "25: }",
          "",
          "---------------"
        ],
        "format/testfiles/test_issue_3849.rego||format/testfiles/test_issue_3849.rego": [
          "File: format/testfiles/test_issue_3849.rego -> format/testfiles/test_issue_3849.rego",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package test_issue_3849",
          "3: test_require_context {",
          "4:  require_context(\"monkey\", \"eat\", \"banana\") with input as {",
          "5:   \"principal\": {\"id\": 101, \"type\": \"monkey\"},",
          "6:   \"action\": \"eat\",",
          "7:   \"entity\": {\"id\": 102, \"type\": \"banana\"},",
          "8:  }",
          "9: }",
          "11: test_contrived {",
          "12:  allow with input as {",
          "13:   \"a\": 101,",
          "14:   \"b\": 101,",
          "15:   \"z\": 101,",
          "16:   \"y\": 101,",
          "17:   \"x\": 101,",
          "18:   \"w\": 101,",
          "19:   \"v\": 101,",
          "20:   \"u\": 101,",
          "21:   \"t\": 101,",
          "22:   \"s\": 101,",
          "23:   \"r\": 101,",
          "24:   \"q\": 101,",
          "25:   \"p\": 101,",
          "26:   \"o\": 101,",
          "27:   \"n\": 101,",
          "28:   \"j\": 101,",
          "29:   \"k\": 101,",
          "30:   \"l\": 101,",
          "31:   \"m\": 101,",
          "32:  }",
          "33: }",
          "",
          "---------------"
        ],
        "format/testfiles/test_issue_3849.rego.formatted||format/testfiles/test_issue_3849.rego.formatted": [
          "File: format/testfiles/test_issue_3849.rego.formatted -> format/testfiles/test_issue_3849.rego.formatted",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package test_issue_3849",
          "3: test_require_context {",
          "4:  require_context(\"monkey\", \"eat\", \"banana\") with input as {",
          "5:   \"principal\": {\"id\": 101, \"type\": \"monkey\"},",
          "6:   \"action\": \"eat\",",
          "7:   \"entity\": {\"id\": 102, \"type\": \"banana\"},",
          "8:  }",
          "9: }",
          "11: test_contrived {",
          "12:  allow with input as {",
          "13:   \"a\": 101,",
          "14:   \"b\": 101,",
          "15:   \"z\": 101,",
          "16:   \"y\": 101,",
          "17:   \"x\": 101,",
          "18:   \"w\": 101,",
          "19:   \"v\": 101,",
          "20:   \"u\": 101,",
          "21:   \"t\": 101,",
          "22:   \"s\": 101,",
          "23:   \"r\": 101,",
          "24:   \"q\": 101,",
          "25:   \"p\": 101,",
          "26:   \"o\": 101,",
          "27:   \"n\": 101,",
          "28:   \"j\": 101,",
          "29:   \"k\": 101,",
          "30:   \"l\": 101,",
          "31:   \"m\": 101,",
          "32:  }",
          "33: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}