{
  "cve_id": "CVE-2023-34049",
  "cve_desc": "The Salt-SSH pre-flight option copies the script to the target at a predictable path, which allows an attacker to force Salt-SSH to run their script. If an attacker has access to the target VM and knows the path to the pre-flight script before it runs they can ensure Salt-SSH runs their script with the privileges of the user running Salt-SSH.\u00a0Do not make the copy path on the target predictable and ensure we check return codes of the scp command if the copy fails.",
  "repo": "saltstack/salt",
  "patch_hash": "286d55eb5a6e6bf9428405bdf5632b419bdf8444",
  "patch_info": {
    "commit_hash": "286d55eb5a6e6bf9428405bdf5632b419bdf8444",
    "repo": "saltstack/salt",
    "commit_url": "https://github.com/saltstack/salt/commit/286d55eb5a6e6bf9428405bdf5632b419bdf8444",
    "files": [
      "tests/integration/ssh/test_pre_flight.py",
      "tests/pytests/integration/ssh/test_pre_flight.py"
    ],
    "message": "Add pytest integration pre_flight integration tests for CVE-2023-34049",
    "before_after_code_files": [
      "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py",
      "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
    ]
  },
  "patch_diff": {
    "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py": [
      "File: tests/integration/ssh/test_pre_flight.py -> tests/integration/ssh/test_pre_flight.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py": [
      "File: tests/pytests/integration/ssh/test_pre_flight.py -> tests/pytests/integration/ssh/test_pre_flight.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: \"\"\"",
      "2: Test for ssh_pre_flight roster option",
      "3: \"\"\"",
      "5: import grp",
      "6: import os",
      "7: import pathlib",
      "8: import pwd",
      "9: import shutil",
      "10: import subprocess",
      "12: import pytest",
      "13: import yaml",
      "14: from saltfactories.utils import random_string",
      "16: import salt.utils.files",
      "19: def _custom_roster(roster_file, roster_data):",
      "20:     with salt.utils.files.fopen(roster_file, \"r\") as fp:",
      "21:         data = salt.utils.yaml.safe_load(fp)",
      "22:     for key, item in roster_data.items():",
      "23:         data[\"localhost\"][key] = item",
      "24:     with salt.utils.files.fopen(roster_file, \"w\") as fp:",
      "25:         yaml.safe_dump(data, fp)",
      "28: @pytest.fixture",
      "29: def _create_roster(salt_ssh_roster_file, tmp_path):",
      "30:     ret = {}",
      "31:     ret[\"roster\"] = salt_ssh_roster_file",
      "32:     ret[\"data\"] = {\"ssh_pre_flight\": str(tmp_path / \"ssh_pre_flight.sh\")}",
      "33:     ret[\"test_script\"] = str(tmp_path / \"test-pre-flight-script-worked.txt\")",
      "34:     ret[\"thin_dir\"] = tmp_path / \"thin_dir\"",
      "36:     with salt.utils.files.fopen(salt_ssh_roster_file, \"r\") as fp:",
      "37:         data = salt.utils.yaml.safe_load(fp)",
      "38:     pre_flight_script = ret[\"data\"][\"ssh_pre_flight\"]",
      "39:     data[\"localhost\"][\"ssh_pre_flight\"] = pre_flight_script",
      "40:     data[\"localhost\"][\"thin_dir\"] = str(ret[\"thin_dir\"])",
      "41:     with salt.utils.files.fopen(salt_ssh_roster_file, \"w\") as fp:",
      "42:         yaml.safe_dump(data, fp)",
      "44:     with salt.utils.files.fopen(pre_flight_script, \"w\") as fp:",
      "45:         fp.write(\"touch {}\".format(ret[\"test_script\"]))",
      "47:     yield ret",
      "48:     if ret[\"thin_dir\"].exists():",
      "49:         shutil.rmtree(ret[\"thin_dir\"])",
      "52: @pytest.mark.slow_test",
      "53: def test_ssh_pre_flight(salt_ssh_cli, caplog, _create_roster):",
      "54:     \"\"\"",
      "55:     test ssh when ssh_pre_flight is set",
      "56:     ensure the script runs successfully",
      "57:     \"\"\"",
      "58:     ret = salt_ssh_cli.run(\"test.ping\")",
      "59:     assert ret.returncode == 0",
      "61:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
      "64: @pytest.mark.slow_test",
      "65: def test_ssh_run_pre_flight(salt_ssh_cli, _create_roster):",
      "66:     \"\"\"",
      "67:     test ssh when --pre-flight is passed to salt-ssh",
      "68:     to ensure the script runs successfully",
      "69:     \"\"\"",
      "70:     # make sure we previously ran a command so the thin dir exists",
      "71:     ret = salt_ssh_cli.run(\"test.ping\")",
      "72:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
      "74:     # Now remeove the script to ensure pre_flight doesn't run",
      "75:     # without --pre-flight",
      "76:     pathlib.Path(_create_roster[\"test_script\"]).unlink()",
      "78:     assert salt_ssh_cli.run(\"test.ping\").returncode == 0",
      "79:     assert not pathlib.Path(_create_roster[\"test_script\"]).exists()",
      "81:     # Now ensure",
      "82:     ret = salt_ssh_cli.run(",
      "83:         \"test.ping\",",
      "84:         \"--pre-flight\",",
      "85:     )",
      "86:     assert ret.returncode == 0",
      "87:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
      "90: @pytest.mark.slow_test",
      "91: def test_ssh_run_pre_flight_args(salt_ssh_cli, _create_roster):",
      "92:     \"\"\"",
      "93:     test ssh when --pre-flight is passed to salt-ssh",
      "94:     to ensure the script runs successfully passing some args",
      "95:     \"\"\"",
      "96:     _custom_roster(salt_ssh_cli.roster_file, {\"ssh_pre_flight_args\": \"foobar test\"})",
      "97:     # Create pre_flight script that accepts args",
      "98:     test_script = _create_roster[\"test_script\"]",
      "99:     test_script_1 = pathlib.Path(test_script + \"-foobar\")",
      "100:     test_script_2 = pathlib.Path(test_script + \"-test\")",
      "101:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp:",
      "102:         fp.write(",
      "103:             f\"\"\"",
      "104:         touch {str(test_script)}-$1",
      "105:         touch {str(test_script)}-$2",
      "106:         \"\"\"",
      "107:         )",
      "108:     ret = salt_ssh_cli.run(\"test.ping\")",
      "109:     assert ret.returncode == 0",
      "110:     assert test_script_1.exists()",
      "111:     assert test_script_2.exists()",
      "112:     pathlib.Path(test_script_1).unlink()",
      "113:     pathlib.Path(test_script_2).unlink()",
      "115:     ret = salt_ssh_cli.run(\"test.ping\")",
      "116:     assert ret.returncode == 0",
      "117:     assert not test_script_1.exists()",
      "118:     assert not test_script_2.exists()",
      "120:     ret = salt_ssh_cli.run(",
      "121:         \"test.ping\",",
      "122:         \"--pre-flight\",",
      "123:     )",
      "124:     assert ret.returncode == 0",
      "125:     assert test_script_1.exists()",
      "126:     assert test_script_2.exists()",
      "129: @pytest.mark.slow_test",
      "130: def test_ssh_run_pre_flight_args_prevent_injection(",
      "131:     salt_ssh_cli, _create_roster, tmp_path",
      "132: ):",
      "133:     \"\"\"",
      "134:     test ssh when --pre-flight is passed to salt-ssh",
      "135:     and evil arguments are used in order to produce shell injection",
      "136:     \"\"\"",
      "137:     injected_file = tmp_path / \"injection\"",
      "138:     _custom_roster(",
      "139:         salt_ssh_cli.roster_file,",
      "140:         {\"ssh_pre_flight_args\": f\"foobar; echo injected > {str(injected_file)}\"},",
      "141:     )",
      "142:     # Create pre_flight script that accepts args",
      "143:     test_script = _create_roster[\"test_script\"]",
      "144:     test_script_1 = pathlib.Path(test_script + \"-echo\")",
      "145:     test_script_2 = pathlib.Path(test_script + \"-foobar;\")",
      "146:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp:",
      "147:         fp.write(",
      "148:             f\"\"\"",
      "149:         touch {str(test_script)}-$1",
      "150:         touch {str(test_script)}-$2",
      "151:         \"\"\"",
      "152:         )",
      "154:     # make sure we previously ran a command so the thin dir exists",
      "155:     ret = salt_ssh_cli.run(\"test.ping\")",
      "156:     assert ret.returncode == 0",
      "157:     assert test_script_1.exists()",
      "158:     assert test_script_2.exists()",
      "159:     test_script_1.unlink()",
      "160:     test_script_2.unlink()",
      "161:     assert not injected_file.is_file()",
      "163:     ret = salt_ssh_cli.run(",
      "164:         \"test.ping\",",
      "165:         \"--pre-flight\",",
      "166:     )",
      "167:     assert ret.returncode == 0",
      "169:     assert test_script_1.exists()",
      "170:     assert test_script_2.exists()",
      "171:     assert not pathlib.Path(",
      "172:         injected_file",
      "173:     ).is_file(), \"File injection suceeded. This shouldn't happend\"",
      "176: @pytest.mark.flaky(max_runs=4)",
      "177: @pytest.mark.slow_test",
      "178: def test_ssh_run_pre_flight_failure(salt_ssh_cli, _create_roster):",
      "179:     \"\"\"",
      "180:     test ssh_pre_flight when there is a failure",
      "181:     in the script.",
      "182:     \"\"\"",
      "183:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp_:",
      "184:         fp_.write(\"exit 2\")",
      "186:     ret = salt_ssh_cli.run(",
      "187:         \"test.ping\",",
      "188:         \"--pre-flight\",",
      "189:     )",
      "190:     assert ret.data[\"retcode\"] == 2",
      "193: @pytest.fixture",
      "194: def account():",
      "195:     username = random_string(\"test-account-\", uppercase=False)",
      "196:     with pytest.helpers.create_account(username=username) as account:",
      "197:         yield account",
      "200: @pytest.mark.slow_test",
      "201: def test_ssh_pre_flight_script(salt_ssh_cli, caplog, _create_roster, tmp_path, account):",
      "202:     \"\"\"",
      "203:     Test to ensure user cannot create and run a script",
      "204:     with the expected pre_flight script path on target.",
      "205:     \"\"\"",
      "206:     try:",
      "207:         script = pathlib.Path.home() / \"hacked\"",
      "208:         tmp_preflight = pathlib.Path(\"/tmp\", \"ssh_pre_flight.sh\")",
      "209:         tmp_preflight.write_text(f\"touch {script}\")",
      "210:         os.chown(tmp_preflight, account.info.uid, account.info.gid)",
      "211:         ret = salt_ssh_cli.run(\"test.ping\")",
      "212:         assert not script.is_file()",
      "213:         assert ret.returncode == 0",
      "214:         assert ret.stdout == '{\\n\"localhost\": true\\n}\\n'",
      "215:     finally:",
      "216:         for _file in [script, tmp_preflight]:",
      "217:             if _file.is_file():",
      "218:                 _file.unlink()",
      "221: def demote(user_uid, user_gid):",
      "222:     def result():",
      "223:         # os.setgid does not remove group membership, so we remove them here so they are REALLY non-root",
      "224:         os.setgroups([])",
      "225:         os.setgid(user_gid)",
      "226:         os.setuid(user_uid)",
      "228:     return result",
      "231: @pytest.mark.slow_test",
      "232: def test_ssh_pre_flight_perms(salt_ssh_cli, caplog, _create_roster, account):",
      "233:     \"\"\"",
      "234:     Test to ensure standard user cannot run pre flight script",
      "235:     on target when user sets wrong permissions (777) on",
      "236:     ssh_pre_flight script.",
      "237:     \"\"\"",
      "238:     try:",
      "239:         script = pathlib.Path(\"/tmp\", \"itworked\")",
      "240:         preflight = pathlib.Path(\"/ssh_pre_flight.sh\")",
      "241:         preflight.write_text(f\"touch {str(script)}\")",
      "242:         tmp_preflight = pathlib.Path(\"/tmp\", preflight.name)",
      "244:         _custom_roster(salt_ssh_cli.roster_file, {\"ssh_pre_flight\": str(preflight)})",
      "245:         preflight.chmod(0o0777)",
      "246:         run_script = pathlib.Path(\"/run_script\")",
      "247:         run_script.write_text(",
      "248:             f\"\"\"",
      "249:         x=1",
      "250:         while [ $x -le 200000 ]; do",
      "251:             SCRIPT=`bash {str(tmp_preflight)} 2> /dev/null; echo $?`",
      "252:             if [ ${{SCRIPT}} == 0 ]; then",
      "253:                 break",
      "254:             fi",
      "255:             x=$(( $x + 1 ))",
      "256:         done",
      "257:         \"\"\"",
      "258:         )",
      "259:         run_script.chmod(0o0777)",
      "260:         # pylint: disable=W1509",
      "261:         ret = subprocess.Popen(",
      "262:             [\"sh\", f\"{run_script}\"],",
      "263:             preexec_fn=demote(account.info.uid, account.info.gid),",
      "264:             stdout=None,",
      "265:             stderr=None,",
      "266:             stdin=None,",
      "267:             universal_newlines=True,",
      "268:         )",
      "269:         # pylint: enable=W1509",
      "270:         ret = salt_ssh_cli.run(\"test.ping\")",
      "271:         assert ret.returncode == 0",
      "273:         # Lets make sure a different user other than root",
      "274:         # Didn't run the script",
      "275:         assert os.stat(script).st_uid != account.info.uid",
      "276:         assert script.is_file()",
      "277:     finally:",
      "278:         for _file in [script, preflight, tmp_preflight, run_script]:",
      "279:             if _file.is_file():",
      "280:                 _file.unlink()",
      "283: @pytest.mark.slow_test",
      "284: def test_ssh_run_pre_flight_target_file_perms(salt_ssh_cli, _create_roster, tmp_path):",
      "285:     \"\"\"",
      "286:     test ssh_pre_flight to ensure the target pre flight script",
      "287:     has the correct perms",
      "288:     \"\"\"",
      "289:     perms_file = tmp_path / \"perms\"",
      "290:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp_:",
      "291:         fp_.write(",
      "292:             f\"\"\"",
      "293:         SCRIPT_NAME=$0",
      "294:         stat -L -c \"%a %G %U\" $SCRIPT_NAME > {perms_file}",
      "295:         \"\"\"",
      "296:         )",
      "298:     ret = salt_ssh_cli.run(",
      "299:         \"test.ping\",",
      "300:         \"--pre-flight\",",
      "301:     )",
      "302:     assert ret.returncode == 0",
      "303:     with salt.utils.files.fopen(perms_file) as fp:",
      "304:         data = fp.read()",
      "305:     assert data.split()[0] == \"600\"",
      "306:     uid = os.getuid()",
      "307:     gid = os.getgid()",
      "308:     assert data.split()[1] == grp.getgrgid(gid).gr_name",
      "309:     assert data.split()[2] == pwd.getpwuid(uid).pw_name",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "22afb445651652128265d81b893d2e5898ecb1bb",
      "candidate_info": {
        "commit_hash": "22afb445651652128265d81b893d2e5898ecb1bb",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/22afb445651652128265d81b893d2e5898ecb1bb",
        "files": [
          "tests/pytests/integration/ssh/test_pre_flight.py"
        ],
        "message": "Fix pre_flight tests on darwin",
        "before_after_code_files": [
          "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [
            "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
          ],
          "candidate": [
            "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
          ]
        }
      },
      "candidate_diff": {
        "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py": [
          "File: tests/pytests/integration/ssh/test_pre_flight.py -> tests/pytests/integration/ssh/test_pre_flight.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: import pathlib",
          "13: import shutil",
          "14: import subprocess",
          "16: import pytest",
          "17: import salt.utils.files",
          "18: import yaml",
          "19: from saltfactories.utils import random_string",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: import tempfile",
          "19: import salt.utils.platform",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "240:     on target when user sets wrong permissions (777) on",
          "241:     ssh_pre_flight script.",
          "242:     \"\"\"",
          "243:     try:",
          "244:         script = pathlib.Path(\"/tmp\", \"itworked\")",
          "245:         preflight = pathlib.Path(\"/ssh_pre_flight.sh\")",
          "246:         preflight.write_text(f\"touch {str(script)}\")",
          "247:         tmp_preflight = pathlib.Path(\"/tmp\", preflight.name)",
          "249:         _custom_roster(salt_ssh_cli.roster_file, {\"ssh_pre_flight\": str(preflight)})",
          "250:         preflight.chmod(0o0777)",
          "251:         run_script = pathlib.Path(\"/run_script\")",
          "252:         run_script.write_text(",
          "253:             f\"\"\"",
          "254:         x=1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "245:     is_darwin = salt.utils.platform.is_darwin()",
          "249:         if is_darwin:",
          "250:             preflight = pathlib.Path(\"/etc/ssh_pre_flight.sh\")",
          "253:         if is_darwin:",
          "254:             tmp_preflight = pathlib.Path(tempfile.gettempdir(), preflight.name)",
          "259:         if is_darwin:",
          "260:             run_script = pathlib.Path(\"/etc/run_script\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "291:     test ssh_pre_flight to ensure the target pre flight script",
          "292:     has the correct perms",
          "293:     \"\"\"",
          "294:     perms_file = tmp_path / \"perms\"",
          "295:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp_:",
          "296:         fp_.write(",
          "297:             f\"\"\"",
          "298:         SCRIPT_NAME=$0",
          "300:         \"\"\"",
          "301:         )",
          "",
          "[Removed Lines]",
          "299:         stat -L -c \"%a %G %U\" $SCRIPT_NAME > {perms_file}",
          "",
          "[Added Lines]",
          "303:     is_darwin = salt.utils.platform.is_darwin()",
          "304:     stat_cmd = 'stat -L -c \"%a %G %U\"'",
          "305:     if is_darwin:",
          "306:         stat_cmd = 'stat -L -f\"%p %g %u\"'",
          "312:         {stat_cmd} $SCRIPT_NAME > {perms_file}",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "307:     assert ret.returncode == 0",
          "308:     with salt.utils.files.fopen(perms_file) as fp:",
          "309:         data = fp.read()",
          "311:     uid = os.getuid()",
          "312:     gid = os.getgid()",
          "",
          "[Removed Lines]",
          "310:     assert data.split()[0] == \"600\"",
          "313:     assert data.split()[1] == grp.getgrgid(gid).gr_name",
          "314:     assert data.split()[2] == pwd.getpwuid(uid).pw_name",
          "",
          "[Added Lines]",
          "323:     if is_darwin:",
          "324:         assert data.split()[0] == \"100600\"",
          "325:     else:",
          "326:         assert data.split()[0] == \"600\"",
          "329:     if is_darwin:",
          "330:         assert int(data.split()[1]) == gid",
          "331:         assert int(data.split()[2]) == uid",
          "332:     else:",
          "333:         assert data.split()[1] == grp.getgrgid(gid).gr_name",
          "334:         assert data.split()[2] == pwd.getpwuid(uid).pw_name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1184c5ebfaae8458b7ba27c9965adfd9216c311c",
      "candidate_info": {
        "commit_hash": "1184c5ebfaae8458b7ba27c9965adfd9216c311c",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/1184c5ebfaae8458b7ba27c9965adfd9216c311c",
        "files": [
          "changelog/65383.security",
          "requirements/darwin.txt",
          "requirements/static/ci/common.in",
          "requirements/static/ci/py3.10/cloud.txt",
          "requirements/static/ci/py3.10/darwin.txt",
          "requirements/static/ci/py3.10/docs.txt",
          "requirements/static/ci/py3.10/freebsd.txt",
          "requirements/static/ci/py3.10/lint.txt",
          "requirements/static/ci/py3.10/linux.txt",
          "requirements/static/ci/py3.7/cloud.txt",
          "requirements/static/ci/py3.7/docs.txt",
          "requirements/static/ci/py3.7/freebsd.txt",
          "requirements/static/ci/py3.7/lint.txt",
          "requirements/static/ci/py3.7/linux.txt",
          "requirements/static/ci/py3.7/windows.txt",
          "requirements/static/ci/py3.8/cloud.txt",
          "requirements/static/ci/py3.8/docs.txt",
          "requirements/static/ci/py3.8/freebsd.txt",
          "requirements/static/ci/py3.8/lint.txt",
          "requirements/static/ci/py3.8/linux.txt",
          "requirements/static/ci/py3.8/windows.txt",
          "requirements/static/ci/py3.9/cloud.txt",
          "requirements/static/ci/py3.9/darwin.txt",
          "requirements/static/ci/py3.9/docs.txt",
          "requirements/static/ci/py3.9/freebsd.txt",
          "requirements/static/ci/py3.9/lint.txt",
          "requirements/static/ci/py3.9/linux.txt",
          "requirements/static/ci/py3.9/windows.txt",
          "requirements/static/pkg/py3.10/darwin.txt",
          "requirements/static/pkg/py3.7/windows.txt",
          "requirements/static/pkg/py3.8/windows.txt",
          "requirements/static/pkg/py3.9/darwin.txt",
          "requirements/static/pkg/py3.9/windows.txt",
          "requirements/windows.txt"
        ],
        "message": "[3005.4] Update gitpython to 3.1.37",
        "before_after_code_files": [
          "changelog/65383.security||changelog/65383.security",
          "requirements/static/ci/common.in||requirements/static/ci/common.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "changelog/65383.security||changelog/65383.security": [
          "File: changelog/65383.security -> changelog/65383.security",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Bump to `gitpython==3.1.37` due to https://github.com/advisories/GHSA-cwvm-v4w8-q58c",
          "",
          "---------------"
        ],
        "requirements/static/ci/common.in||requirements/static/ci/common.in": [
          "File: requirements/static/ci/common.in -> requirements/static/ci/common.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: docker",
          "18: etcd3-py==0.1.6 ; python_version >= '3.6'",
          "19: gitpython>=2.1.15 ; python_version <= \"3.6\"",
          "21: jmespath",
          "22: jsonschema",
          "23: junos-eznc==2.4.0; sys_platform != 'win32' and python_version <= '3.9'",
          "",
          "[Removed Lines]",
          "20: gitpython>=3.1.35 ; python_version >= \"3.7\"",
          "",
          "[Added Lines]",
          "20: gitpython>=3.1.37 ; python_version >= \"3.7\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5c236eaac16964e1e7d925232d1ccec038c004c2",
      "candidate_info": {
        "commit_hash": "5c236eaac16964e1e7d925232d1ccec038c004c2",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/5c236eaac16964e1e7d925232d1ccec038c004c2",
        "files": [
          "changelog/65334.security",
          "requirements/static/ci/py3.10/cloud.txt",
          "requirements/static/ci/py3.10/darwin.txt",
          "requirements/static/ci/py3.10/docs.txt",
          "requirements/static/ci/py3.10/freebsd.txt",
          "requirements/static/ci/py3.10/lint.txt",
          "requirements/static/ci/py3.10/linux.txt",
          "requirements/static/ci/py3.6/cloud.txt",
          "requirements/static/ci/py3.6/docs.txt",
          "requirements/static/ci/py3.6/lint.txt",
          "requirements/static/ci/py3.6/linux.txt",
          "requirements/static/ci/py3.7/cloud.txt",
          "requirements/static/ci/py3.7/docs.txt",
          "requirements/static/ci/py3.7/freebsd.txt",
          "requirements/static/ci/py3.7/lint.txt",
          "requirements/static/ci/py3.7/linux.txt",
          "requirements/static/ci/py3.7/windows.txt",
          "requirements/static/ci/py3.8/cloud.txt",
          "requirements/static/ci/py3.8/docs.txt",
          "requirements/static/ci/py3.8/freebsd.txt",
          "requirements/static/ci/py3.8/lint.txt",
          "requirements/static/ci/py3.8/linux.txt",
          "requirements/static/ci/py3.8/windows.txt",
          "requirements/static/ci/py3.9/cloud.txt",
          "requirements/static/ci/py3.9/darwin.txt",
          "requirements/static/ci/py3.9/docs.txt",
          "requirements/static/ci/py3.9/freebsd.txt",
          "requirements/static/ci/py3.9/lint.txt",
          "requirements/static/ci/py3.9/linux.txt",
          "requirements/static/ci/py3.9/windows.txt",
          "requirements/static/pkg/py3.10/darwin.txt",
          "requirements/static/pkg/py3.10/freebsd.txt",
          "requirements/static/pkg/py3.10/linux.txt",
          "requirements/static/pkg/py3.6/linux.txt",
          "requirements/static/pkg/py3.7/freebsd.txt",
          "requirements/static/pkg/py3.7/linux.txt",
          "requirements/static/pkg/py3.7/windows.txt",
          "requirements/static/pkg/py3.8/freebsd.txt",
          "requirements/static/pkg/py3.8/linux.txt",
          "requirements/static/pkg/py3.8/windows.txt",
          "requirements/static/pkg/py3.9/darwin.txt",
          "requirements/static/pkg/py3.9/freebsd.txt",
          "requirements/static/pkg/py3.9/linux.txt",
          "requirements/static/pkg/py3.9/windows.txt"
        ],
        "message": "Bump urllib3 to 1.26.17 or 2.0.6",
        "before_after_code_files": [
          "changelog/65334.security||changelog/65334.security"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "changelog/65334.security||changelog/65334.security": [
          "File: changelog/65334.security -> changelog/65334.security",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Bump to `urllib3==1.26.17` or `urllib3==2.0.6` due to https://github.com/advisories/GHSA-v845-jxx5-vc9f",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c33977f96fc36f066aba929926cb44bc8ce8b9f8",
      "candidate_info": {
        "commit_hash": "c33977f96fc36f066aba929926cb44bc8ce8b9f8",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/c33977f96fc36f066aba929926cb44bc8ce8b9f8",
        "files": [
          "requirements/static/ci/py3.10/cloud.txt",
          "requirements/static/ci/py3.10/darwin.txt",
          "requirements/static/ci/py3.10/freebsd.txt",
          "requirements/static/ci/py3.10/lint.txt",
          "requirements/static/ci/py3.10/linux.txt",
          "requirements/static/ci/py3.10/pkgtests.txt",
          "requirements/static/ci/py3.10/windows.txt",
          "requirements/static/ci/py3.7/cloud.txt",
          "requirements/static/ci/py3.7/freebsd.txt",
          "requirements/static/ci/py3.7/lint.txt",
          "requirements/static/ci/py3.7/linux.txt",
          "requirements/static/ci/py3.7/windows.txt",
          "requirements/static/ci/py3.8/cloud.txt",
          "requirements/static/ci/py3.8/freebsd.txt",
          "requirements/static/ci/py3.8/lint.txt",
          "requirements/static/ci/py3.8/linux.txt",
          "requirements/static/ci/py3.8/windows.txt",
          "requirements/static/ci/py3.9/cloud.txt",
          "requirements/static/ci/py3.9/darwin.txt",
          "requirements/static/ci/py3.9/freebsd.txt",
          "requirements/static/ci/py3.9/lint.txt",
          "requirements/static/ci/py3.9/linux.txt",
          "requirements/static/ci/py3.9/windows.txt",
          "tests/pytests/unit/modules/dockermod/test_module.py"
        ],
        "message": "Bump to `docker==6.1.2`\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/unit/modules/dockermod/test_module.py||tests/pytests/unit/modules/dockermod/test_module.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/unit/modules/dockermod/test_module.py||tests/pytests/unit/modules/dockermod/test_module.py": [
          "File: tests/pytests/unit/modules/dockermod/test_module.py -> tests/pytests/unit/modules/dockermod/test_module.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: import salt.loader",
          "10: import salt.modules.dockermod as docker_mod",
          "11: import salt.utils.platform",
          "12: from salt.exceptions import CommandExecutionError, SaltInvocationError",
          "13: from tests.support.mock import MagicMock, Mock, call, patch",
          "15: log = logging.getLogger(__name__)",
          "18:     \"docker\", reason=\"The python 'docker' package must be installed to run these tests\"",
          "19: )",
          "22: @pytest.fixture",
          "",
          "[Removed Lines]",
          "17: pytest.importorskip(",
          "",
          "[Added Lines]",
          "12: import salt.utils.versions",
          "18: docker = pytest.importorskip(",
          "21: docker_older_than_1_5_0_skip_marker = pytest.mark.skipif(",
          "22:     salt.utils.versions.Version(docker.__version__) < \"1.5.0\",",
          "23:     reason=\"docker module must be installed to run this test or is too old. <=1.5.0\",",
          "24: )",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "354:         mine_mock.assert_called_once()",
          "361: def test_list_networks():",
          "362:     \"\"\"",
          "363:     test list networks.",
          "",
          "[Removed Lines]",
          "357: @pytest.mark.skipif(",
          "358:     docker_mod.docker.version_info < (1, 5, 0),",
          "359:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "360: )",
          "",
          "[Added Lines]",
          "362: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "378:     client.networks.assert_called_once_with(names=[\"foo\"], ids=[\"01234\"])",
          "385: def test_create_network():",
          "386:     \"\"\"",
          "387:     test create network.",
          "",
          "[Removed Lines]",
          "381: @pytest.mark.skipif(",
          "382:     docker_mod.docker.version_info < (1, 5, 0),",
          "383:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "384: )",
          "",
          "[Added Lines]",
          "383: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "422:     )",
          "429: def test_remove_network():",
          "430:     \"\"\"",
          "431:     test remove network.",
          "",
          "[Removed Lines]",
          "425: @pytest.mark.skipif(",
          "426:     docker_mod.docker.version_info < (1, 5, 0),",
          "427:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "428: )",
          "",
          "[Added Lines]",
          "424: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "444:     client.remove_network.assert_called_once_with(\"foo\")",
          "451: def test_inspect_network():",
          "452:     \"\"\"",
          "453:     test inspect network.",
          "",
          "[Removed Lines]",
          "447: @pytest.mark.skipif(",
          "448:     docker_mod.docker.version_info < (1, 5, 0),",
          "449:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "450: )",
          "",
          "[Added Lines]",
          "443: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "466:     client.inspect_network.assert_called_once_with(\"foo\")",
          "473: def test_connect_container_to_network():",
          "474:     \"\"\"",
          "475:     test connect_container_to_network",
          "",
          "[Removed Lines]",
          "469: @pytest.mark.skipif(",
          "470:     docker_mod.docker.version_info < (1, 5, 0),",
          "471:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "472: )",
          "",
          "[Added Lines]",
          "462: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "491:     client.connect_container_to_network.assert_called_once_with(\"container\", \"foo\")",
          "498: def test_disconnect_container_from_network():",
          "499:     \"\"\"",
          "500:     test disconnect_container_from_network",
          "",
          "[Removed Lines]",
          "494: @pytest.mark.skipif(",
          "495:     docker_mod.docker.version_info < (1, 5, 0),",
          "496:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "497: )",
          "",
          "[Added Lines]",
          "484: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "513:     client.disconnect_container_from_network.assert_called_once_with(\"container\", \"foo\")",
          "520: def test_list_volumes():",
          "521:     \"\"\"",
          "522:     test list volumes.",
          "",
          "[Removed Lines]",
          "516: @pytest.mark.skipif(",
          "517:     docker_mod.docker.version_info < (1, 5, 0),",
          "518:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "519: )",
          "",
          "[Added Lines]",
          "503: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "539:     )",
          "546: def test_create_volume():",
          "547:     \"\"\"",
          "548:     test create volume.",
          "",
          "[Removed Lines]",
          "542: @pytest.mark.skipif(",
          "543:     docker_mod.docker.version_info < (1, 5, 0),",
          "544:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "545: )",
          "",
          "[Added Lines]",
          "526: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "569:     )",
          "576: def test_remove_volume():",
          "577:     \"\"\"",
          "578:     test remove volume.",
          "",
          "[Removed Lines]",
          "572: @pytest.mark.skipif(",
          "573:     docker_mod.docker.version_info < (1, 5, 0),",
          "574:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "575: )",
          "",
          "[Added Lines]",
          "553: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "591:     client.remove_volume.assert_called_once_with(\"foo\")",
          "598: def test_inspect_volume():",
          "599:     \"\"\"",
          "600:     test inspect volume.",
          "",
          "[Removed Lines]",
          "594: @pytest.mark.skipif(",
          "595:     docker_mod.docker.version_info < (1, 5, 0),",
          "596:     reason=\"docker module must be installed to run this test or is too old. >=1.5.0\",",
          "597: )",
          "",
          "[Added Lines]",
          "572: @docker_older_than_1_5_0_skip_marker",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b7735ab8f6868610db7b25e29ecf35d5263d9c9b",
      "candidate_info": {
        "commit_hash": "b7735ab8f6868610db7b25e29ecf35d5263d9c9b",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/b7735ab8f6868610db7b25e29ecf35d5263d9c9b",
        "files": [
          "tests/integration/ssh/test_pre_flight.py",
          "tests/pytests/integration/ssh/test_pre_flight.py"
        ],
        "message": "Add pytest integration pre_flight integration tests for CVE-2023-34049",
        "before_after_code_files": [
          "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py",
          "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [
            "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py",
            "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
          ],
          "candidate": [
            "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py",
            "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py"
          ]
        }
      },
      "candidate_diff": {
        "tests/integration/ssh/test_pre_flight.py||tests/integration/ssh/test_pre_flight.py": [
          "File: tests/integration/ssh/test_pre_flight.py -> tests/integration/ssh/test_pre_flight.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "tests/pytests/integration/ssh/test_pre_flight.py||tests/pytests/integration/ssh/test_pre_flight.py": [
          "File: tests/pytests/integration/ssh/test_pre_flight.py -> tests/pytests/integration/ssh/test_pre_flight.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: \"\"\"",
          "2: Test for ssh_pre_flight roster option",
          "3: \"\"\"",
          "5: import grp",
          "6: import os",
          "7: import pathlib",
          "8: import pwd",
          "9: import shutil",
          "10: import subprocess",
          "12: import pytest",
          "13: import salt.utils.files",
          "14: import yaml",
          "15: from saltfactories.utils import random_string",
          "18: def _custom_roster(roster_file, roster_data):",
          "19:     with salt.utils.files.fopen(roster_file, \"r\") as fp:",
          "20:         data = salt.utils.yaml.safe_load(fp)",
          "21:     for key, item in roster_data.items():",
          "22:         data[\"localhost\"][key] = item",
          "23:     with salt.utils.files.fopen(roster_file, \"w\") as fp:",
          "24:         yaml.safe_dump(data, fp)",
          "27: @pytest.fixture",
          "28: def _create_roster(salt_ssh_roster_file, tmp_path):",
          "29:     ret = {}",
          "30:     ret[\"roster\"] = salt_ssh_roster_file",
          "31:     ret[\"data\"] = {\"ssh_pre_flight\": str(tmp_path / \"ssh_pre_flight.sh\")}",
          "32:     ret[\"test_script\"] = str(tmp_path / \"test-pre-flight-script-worked.txt\")",
          "33:     ret[\"thin_dir\"] = tmp_path / \"thin_dir\"",
          "35:     with salt.utils.files.fopen(salt_ssh_roster_file, \"r\") as fp:",
          "36:         data = salt.utils.yaml.safe_load(fp)",
          "37:     pre_flight_script = ret[\"data\"][\"ssh_pre_flight\"]",
          "38:     data[\"localhost\"][\"ssh_pre_flight\"] = pre_flight_script",
          "39:     data[\"localhost\"][\"thin_dir\"] = str(ret[\"thin_dir\"])",
          "40:     with salt.utils.files.fopen(salt_ssh_roster_file, \"w\") as fp:",
          "41:         yaml.safe_dump(data, fp)",
          "43:     with salt.utils.files.fopen(pre_flight_script, \"w\") as fp:",
          "44:         fp.write(\"touch {}\".format(ret[\"test_script\"]))",
          "46:     yield ret",
          "47:     if ret[\"thin_dir\"].exists():",
          "48:         shutil.rmtree(ret[\"thin_dir\"])",
          "51: @pytest.mark.slow_test",
          "52: def test_ssh_pre_flight(salt_ssh_cli, caplog, _create_roster):",
          "53:     \"\"\"",
          "54:     test ssh when ssh_pre_flight is set",
          "55:     ensure the script runs successfully",
          "56:     \"\"\"",
          "57:     ret = salt_ssh_cli.run(\"test.ping\")",
          "58:     assert ret.returncode == 0",
          "60:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
          "63: @pytest.mark.slow_test",
          "64: def test_ssh_run_pre_flight(salt_ssh_cli, _create_roster):",
          "65:     \"\"\"",
          "66:     test ssh when --pre-flight is passed to salt-ssh",
          "67:     to ensure the script runs successfully",
          "68:     \"\"\"",
          "69:     # make sure we previously ran a command so the thin dir exists",
          "70:     ret = salt_ssh_cli.run(\"test.ping\")",
          "71:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
          "73:     # Now remeove the script to ensure pre_flight doesn't run",
          "74:     # without --pre-flight",
          "75:     pathlib.Path(_create_roster[\"test_script\"]).unlink()",
          "77:     assert salt_ssh_cli.run(\"test.ping\").returncode == 0",
          "78:     assert not pathlib.Path(_create_roster[\"test_script\"]).exists()",
          "80:     # Now ensure",
          "81:     ret = salt_ssh_cli.run(",
          "82:         \"test.ping\",",
          "83:         \"--pre-flight\",",
          "84:     )",
          "85:     assert ret.returncode == 0",
          "86:     assert pathlib.Path(_create_roster[\"test_script\"]).exists()",
          "89: @pytest.mark.slow_test",
          "90: def test_ssh_run_pre_flight_args(salt_ssh_cli, _create_roster):",
          "91:     \"\"\"",
          "92:     test ssh when --pre-flight is passed to salt-ssh",
          "93:     to ensure the script runs successfully passing some args",
          "94:     \"\"\"",
          "95:     _custom_roster(salt_ssh_cli.roster_file, {\"ssh_pre_flight_args\": \"foobar test\"})",
          "96:     # Create pre_flight script that accepts args",
          "97:     test_script = _create_roster[\"test_script\"]",
          "98:     test_script_1 = pathlib.Path(test_script + \"-foobar\")",
          "99:     test_script_2 = pathlib.Path(test_script + \"-test\")",
          "100:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp:",
          "101:         fp.write(",
          "102:             f\"\"\"",
          "103:         touch {str(test_script)}-$1",
          "104:         touch {str(test_script)}-$2",
          "105:         \"\"\"",
          "106:         )",
          "107:     ret = salt_ssh_cli.run(\"test.ping\")",
          "108:     assert ret.returncode == 0",
          "109:     assert test_script_1.exists()",
          "110:     assert test_script_2.exists()",
          "111:     pathlib.Path(test_script_1).unlink()",
          "112:     pathlib.Path(test_script_2).unlink()",
          "114:     ret = salt_ssh_cli.run(\"test.ping\")",
          "115:     assert ret.returncode == 0",
          "116:     assert not test_script_1.exists()",
          "117:     assert not test_script_2.exists()",
          "119:     ret = salt_ssh_cli.run(",
          "120:         \"test.ping\",",
          "121:         \"--pre-flight\",",
          "122:     )",
          "123:     assert ret.returncode == 0",
          "124:     assert test_script_1.exists()",
          "125:     assert test_script_2.exists()",
          "128: @pytest.mark.slow_test",
          "129: def test_ssh_run_pre_flight_args_prevent_injection(",
          "130:     salt_ssh_cli, _create_roster, tmp_path",
          "131: ):",
          "132:     \"\"\"",
          "133:     test ssh when --pre-flight is passed to salt-ssh",
          "134:     and evil arguments are used in order to produce shell injection",
          "135:     \"\"\"",
          "136:     injected_file = tmp_path / \"injection\"",
          "137:     _custom_roster(",
          "138:         salt_ssh_cli.roster_file,",
          "139:         {\"ssh_pre_flight_args\": f\"foobar; echo injected > {str(injected_file)}\"},",
          "140:     )",
          "141:     # Create pre_flight script that accepts args",
          "142:     test_script = _create_roster[\"test_script\"]",
          "143:     test_script_1 = pathlib.Path(test_script + \"-echo\")",
          "144:     test_script_2 = pathlib.Path(test_script + \"-foobar;\")",
          "145:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp:",
          "146:         fp.write(",
          "147:             f\"\"\"",
          "148:         touch {str(test_script)}-$1",
          "149:         touch {str(test_script)}-$2",
          "150:         \"\"\"",
          "151:         )",
          "153:     # make sure we previously ran a command so the thin dir exists",
          "154:     ret = salt_ssh_cli.run(\"test.ping\")",
          "155:     assert ret.returncode == 0",
          "156:     assert test_script_1.exists()",
          "157:     assert test_script_2.exists()",
          "158:     test_script_1.unlink()",
          "159:     test_script_2.unlink()",
          "160:     assert not injected_file.is_file()",
          "162:     ret = salt_ssh_cli.run(",
          "163:         \"test.ping\",",
          "164:         \"--pre-flight\",",
          "165:     )",
          "166:     assert ret.returncode == 0",
          "168:     assert test_script_1.exists()",
          "169:     assert test_script_2.exists()",
          "170:     assert not pathlib.Path(",
          "171:         injected_file",
          "172:     ).is_file(), \"File injection suceeded. This shouldn't happend\"",
          "175: @pytest.mark.flaky(max_runs=4)",
          "176: @pytest.mark.slow_test",
          "177: def test_ssh_run_pre_flight_failure(salt_ssh_cli, _create_roster):",
          "178:     \"\"\"",
          "179:     test ssh_pre_flight when there is a failure",
          "180:     in the script.",
          "181:     \"\"\"",
          "182:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp_:",
          "183:         fp_.write(\"exit 2\")",
          "185:     ret = salt_ssh_cli.run(",
          "186:         \"test.ping\",",
          "187:         \"--pre-flight\",",
          "188:     )",
          "189:     assert ret.data[\"retcode\"] == 2",
          "192: @pytest.fixture",
          "193: def account():",
          "194:     username = random_string(\"test-account-\", uppercase=False)",
          "195:     with pytest.helpers.create_account(username=username) as account:",
          "196:         yield account",
          "199: @pytest.mark.slow_test",
          "200: def test_ssh_pre_flight_script(salt_ssh_cli, caplog, _create_roster, tmp_path, account):",
          "201:     \"\"\"",
          "202:     Test to ensure user cannot create and run a script",
          "203:     with the expected pre_flight script path on target.",
          "204:     \"\"\"",
          "205:     try:",
          "206:         script = pathlib.Path.home() / \"hacked\"",
          "207:         tmp_preflight = pathlib.Path(\"/tmp\", \"ssh_pre_flight.sh\")",
          "208:         tmp_preflight.write_text(f\"touch {script}\")",
          "209:         os.chown(tmp_preflight, account.info.uid, account.info.gid)",
          "210:         ret = salt_ssh_cli.run(\"test.ping\")",
          "211:         assert not script.is_file()",
          "212:         assert ret.returncode == 0",
          "213:         assert ret.stdout == '{\\n\"localhost\": true\\n}\\n'",
          "214:     finally:",
          "215:         for _file in [script, tmp_preflight]:",
          "216:             if _file.is_file():",
          "217:                 _file.unlink()",
          "220: def demote(user_uid, user_gid):",
          "221:     def result():",
          "222:         # os.setgid does not remove group membership, so we remove them here so they are REALLY non-root",
          "223:         os.setgroups([])",
          "224:         os.setgid(user_gid)",
          "225:         os.setuid(user_uid)",
          "227:     return result",
          "230: @pytest.mark.slow_test",
          "231: def test_ssh_pre_flight_perms(salt_ssh_cli, caplog, _create_roster, account):",
          "232:     \"\"\"",
          "233:     Test to ensure standard user cannot run pre flight script",
          "234:     on target when user sets wrong permissions (777) on",
          "235:     ssh_pre_flight script.",
          "236:     \"\"\"",
          "237:     try:",
          "238:         script = pathlib.Path(\"/tmp\", \"itworked\")",
          "239:         preflight = pathlib.Path(\"/ssh_pre_flight.sh\")",
          "240:         preflight.write_text(f\"touch {str(script)}\")",
          "241:         tmp_preflight = pathlib.Path(\"/tmp\", preflight.name)",
          "243:         _custom_roster(salt_ssh_cli.roster_file, {\"ssh_pre_flight\": str(preflight)})",
          "244:         preflight.chmod(0o0777)",
          "245:         run_script = pathlib.Path(\"/run_script\")",
          "246:         run_script.write_text(",
          "247:             f\"\"\"",
          "248:         x=1",
          "249:         while [ $x -le 200000 ]; do",
          "250:             SCRIPT=`bash {str(tmp_preflight)} 2> /dev/null; echo $?`",
          "251:             if [ ${{SCRIPT}} == 0 ]; then",
          "252:                 break",
          "253:             fi",
          "254:             x=$(( $x + 1 ))",
          "255:         done",
          "256:         \"\"\"",
          "257:         )",
          "258:         run_script.chmod(0o0777)",
          "259:         # pylint: disable=W1509",
          "260:         ret = subprocess.Popen(",
          "261:             [\"sh\", f\"{run_script}\"],",
          "262:             preexec_fn=demote(account.info.uid, account.info.gid),",
          "263:             stdout=None,",
          "264:             stderr=None,",
          "265:             stdin=None,",
          "266:             universal_newlines=True,",
          "267:         )",
          "268:         # pylint: enable=W1509",
          "269:         ret = salt_ssh_cli.run(\"test.ping\")",
          "270:         assert ret.returncode == 0",
          "272:         # Lets make sure a different user other than root",
          "273:         # Didn't run the script",
          "274:         assert os.stat(script).st_uid != account.info.uid",
          "275:         assert script.is_file()",
          "276:     finally:",
          "277:         for _file in [script, preflight, tmp_preflight, run_script]:",
          "278:             if _file.is_file():",
          "279:                 _file.unlink()",
          "282: @pytest.mark.slow_test",
          "283: def test_ssh_run_pre_flight_target_file_perms(salt_ssh_cli, _create_roster, tmp_path):",
          "284:     \"\"\"",
          "285:     test ssh_pre_flight to ensure the target pre flight script",
          "286:     has the correct perms",
          "287:     \"\"\"",
          "288:     perms_file = tmp_path / \"perms\"",
          "289:     with salt.utils.files.fopen(_create_roster[\"data\"][\"ssh_pre_flight\"], \"w\") as fp_:",
          "290:         fp_.write(",
          "291:             f\"\"\"",
          "292:         SCRIPT_NAME=$0",
          "293:         stat -L -c \"%a %G %U\" $SCRIPT_NAME > {perms_file}",
          "294:         \"\"\"",
          "295:         )",
          "297:     ret = salt_ssh_cli.run(",
          "298:         \"test.ping\",",
          "299:         \"--pre-flight\",",
          "300:     )",
          "301:     assert ret.returncode == 0",
          "302:     with salt.utils.files.fopen(perms_file) as fp:",
          "303:         data = fp.read()",
          "304:     assert data.split()[0] == \"600\"",
          "305:     uid = os.getuid()",
          "306:     gid = os.getgid()",
          "307:     assert data.split()[1] == grp.getgrgid(gid).gr_name",
          "308:     assert data.split()[2] == pwd.getpwuid(uid).pw_name",
          "",
          "---------------"
        ]
      }
    }
  ]
}