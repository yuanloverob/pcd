{
  "cve_id": "CVE-2012-3387",
  "cve_desc": "Moodle 2.3.x before 2.3.1 uses only a client-side check for whether references are permitted in a file upload, which allows remote authenticated users to bypass intended alias (aka shortcut) restrictions via a client that omits this check.",
  "repo": "moodle/moodle",
  "patch_hash": "3b6629c088f14c6ee8f13a009ff27441d164f334",
  "patch_info": {
    "commit_hash": "3b6629c088f14c6ee8f13a009ff27441d164f334",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/3b6629c088f14c6ee8f13a009ff27441d164f334",
    "files": [
      "lib/filelib.php"
    ],
    "message": "MDL-33948 file_save_draft_area_files() validates if references are allowed and allows unlimited file size",
    "before_after_code_files": [
      "lib/filelib.php||lib/filelib.php"
    ]
  },
  "patch_diff": {
    "lib/filelib.php||lib/filelib.php": [
      "File: lib/filelib.php -> lib/filelib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "721:     if (!isset($options['maxfiles'])) {",
      "722:         $options['maxfiles'] = -1; // unlimited",
      "723:     }",
      "725:         $options['maxbytes'] = 0; // unlimited",
      "726:     }",
      "728:     $draftfiles = $fs->get_area_files($usercontext->id, 'user', 'draft', $draftitemid, 'id');",
      "729:     $oldfiles   = $fs->get_area_files($contextid, $component, $filearea, $itemid, 'id');",
      "",
      "[Removed Lines]",
      "724:     if (!isset($options['maxbytes'])) {",
      "",
      "[Added Lines]",
      "724:     if (!isset($options['maxbytes']) || $options['maxbytes'] == USER_CAN_IGNORE_FILE_SIZE_LIMITS) {",
      "727:     $allowreferences = true;",
      "728:     if (isset($options['return_types']) && !($options['return_types'] & FILE_REFERENCE)) {",
      "732:         $allowreferences = false;",
      "733:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "755:             }",
      "757:             if ($file->is_external_file()) {",
      "758:                 $repoid = $file->get_repository_id();",
      "759:                 if (!empty($repoid)) {",
      "760:                     $file_record['repositoryid'] = $repoid;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "765:                 if (!$allowreferences) {",
      "766:                     continue;",
      "767:                 }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "856:             }",
      "858:             if ($file->is_external_file()) {",
      "859:                 $repoid = $file->get_repository_id();",
      "860:                 if (!empty($repoid)) {",
      "861:                     $file_record['repositoryid'] = $repoid;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "869:                 if (!$allowreferences) {",
      "870:                     continue;",
      "871:                 }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "489bd32b298445d4f7ec64a9644d4e2ac7a6b800",
      "candidate_info": {
        "commit_hash": "489bd32b298445d4f7ec64a9644d4e2ac7a6b800",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/489bd32b298445d4f7ec64a9644d4e2ac7a6b800",
        "files": [
          "lib/filelib.php"
        ],
        "message": "MDL-39177 Remove code duplication",
        "before_after_code_files": [
          "lib/filelib.php||lib/filelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/filelib.php||lib/filelib.php"
          ],
          "candidate": [
            "lib/filelib.php||lib/filelib.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/filelib.php||lib/filelib.php": [
          "File: lib/filelib.php -> lib/filelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "796:     $draftfiles = $fs->get_area_files($usercontext->id, 'user', 'draft', $draftitemid, 'id');",
          "797:     $oldfiles   = $fs->get_area_files($contextid, $component, $filearea, $itemid, 'id');",
          "",
          "[Removed Lines]",
          "799:     if (count($draftfiles) < 2) {",
          "801:         $fs->delete_area_files($contextid, $component, $filearea, $itemid);",
          "803:     } else if (count($oldfiles) < 2) {",
          "804:         $filecount = 0;",
          "806:         foreach ($draftfiles as $file) {",
          "807:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid);",
          "808:             if ($source = @unserialize($file->get_source())) {",
          "810:                 $file_record['source'] = $source->source;",
          "811:             }",
          "812:             if (!$options['subdirs']) {",
          "813:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "814:                     continue;",
          "815:                 }",
          "816:             }",
          "817:             if ($options['maxbytes'] and $options['maxbytes'] < $file->get_filesize()) {",
          "819:                 continue;",
          "820:             }",
          "821:             if ($options['maxfiles'] != -1 and $options['maxfiles'] <= $filecount) {",
          "823:                 break;",
          "824:             }",
          "825:             if (!$file->is_directory()) {",
          "826:                 $filecount++;",
          "827:             }",
          "829:             if ($file->is_external_file()) {",
          "830:                 if (!$allowreferences) {",
          "831:                     continue;",
          "832:                 }",
          "833:                 $repoid = $file->get_repository_id();",
          "834:                 if (!empty($repoid)) {",
          "835:                     $file_record['repositoryid'] = $repoid;",
          "836:                     $file_record['reference'] = $file->get_reference();",
          "837:                 }",
          "838:             }",
          "840:             $fs->create_file_from_storedfile($file_record, $file);",
          "841:         }",
          "843:     } else {",
          "",
          "[Added Lines]",
          "800:     if (count($draftfiles) > 1 || count($oldfiles) > 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bb597bbc1a1e9cc1217341e22b14fd5ff01c84b6",
      "candidate_info": {
        "commit_hash": "bb597bbc1a1e9cc1217341e22b14fd5ff01c84b6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bb597bbc1a1e9cc1217341e22b14fd5ff01c84b6",
        "files": [
          "lib/filelib.php"
        ],
        "message": "MDL-39177 Remove code duplication",
        "before_after_code_files": [
          "lib/filelib.php||lib/filelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/filelib.php||lib/filelib.php"
          ],
          "candidate": [
            "lib/filelib.php||lib/filelib.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/filelib.php||lib/filelib.php": [
          "File: lib/filelib.php -> lib/filelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "783:     $draftfiles = $fs->get_area_files($usercontext->id, 'user', 'draft', $draftitemid, 'id');",
          "784:     $oldfiles   = $fs->get_area_files($contextid, $component, $filearea, $itemid, 'id');",
          "",
          "[Removed Lines]",
          "786:     if (count($draftfiles) < 2) {",
          "788:         $fs->delete_area_files($contextid, $component, $filearea, $itemid);",
          "790:     } else if (count($oldfiles) < 2) {",
          "791:         $filecount = 0;",
          "793:         foreach ($draftfiles as $file) {",
          "794:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid);",
          "795:             if ($source = @unserialize($file->get_source())) {",
          "797:                 $file_record['source'] = $source->source;",
          "798:             }",
          "799:             if (!$options['subdirs']) {",
          "800:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "801:                     continue;",
          "802:                 }",
          "803:             }",
          "804:             if ($options['maxbytes'] and $options['maxbytes'] < $file->get_filesize()) {",
          "806:                 continue;",
          "807:             }",
          "808:             if ($options['maxfiles'] != -1 and $options['maxfiles'] <= $filecount) {",
          "810:                 break;",
          "811:             }",
          "812:             if (!$file->is_directory()) {",
          "813:                 $filecount++;",
          "814:             }",
          "816:             if ($file->is_external_file()) {",
          "817:                 if (!$allowreferences) {",
          "818:                     continue;",
          "819:                 }",
          "820:                 $repoid = $file->get_repository_id();",
          "821:                 if (!empty($repoid)) {",
          "822:                     $file_record['repositoryid'] = $repoid;",
          "823:                     $file_record['reference'] = $file->get_reference();",
          "824:                 }",
          "825:             }",
          "827:             $fs->create_file_from_storedfile($file_record, $file);",
          "828:         }",
          "830:     } else {",
          "",
          "[Added Lines]",
          "787:     if (count($draftfiles) > 1 || count($oldfiles) > 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b8aca19538f6b2a484cf8ba8d151c30556865ca7",
      "candidate_info": {
        "commit_hash": "b8aca19538f6b2a484cf8ba8d151c30556865ca7",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b8aca19538f6b2a484cf8ba8d151c30556865ca7",
        "files": [
          "lib/filelib.php"
        ],
        "message": "MDL-39177 Remove code duplication",
        "before_after_code_files": [
          "lib/filelib.php||lib/filelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/filelib.php||lib/filelib.php"
          ],
          "candidate": [
            "lib/filelib.php||lib/filelib.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/filelib.php||lib/filelib.php": [
          "File: lib/filelib.php -> lib/filelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "796:     $draftfiles = $fs->get_area_files($usercontext->id, 'user', 'draft', $draftitemid, 'id');",
          "797:     $oldfiles   = $fs->get_area_files($contextid, $component, $filearea, $itemid, 'id');",
          "",
          "[Removed Lines]",
          "799:     if (count($draftfiles) < 2) {",
          "801:         $fs->delete_area_files($contextid, $component, $filearea, $itemid);",
          "803:     } else if (count($oldfiles) < 2) {",
          "804:         $filecount = 0;",
          "806:         foreach ($draftfiles as $file) {",
          "807:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid);",
          "808:             if ($source = @unserialize($file->get_source())) {",
          "810:                 $file_record['source'] = $source->source;",
          "811:             }",
          "812:             if (!$options['subdirs']) {",
          "813:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "814:                     continue;",
          "815:                 }",
          "816:             }",
          "817:             if ($options['maxbytes'] and $options['maxbytes'] < $file->get_filesize()) {",
          "819:                 continue;",
          "820:             }",
          "821:             if ($options['maxfiles'] != -1 and $options['maxfiles'] <= $filecount) {",
          "823:                 break;",
          "824:             }",
          "825:             if (!$file->is_directory()) {",
          "826:                 $filecount++;",
          "827:             }",
          "829:             if ($file->is_external_file()) {",
          "830:                 if (!$allowreferences) {",
          "831:                     continue;",
          "832:                 }",
          "833:                 $repoid = $file->get_repository_id();",
          "834:                 if (!empty($repoid)) {",
          "835:                     $file_record['repositoryid'] = $repoid;",
          "836:                     $file_record['reference'] = $file->get_reference();",
          "837:                 }",
          "838:             }",
          "840:             $fs->create_file_from_storedfile($file_record, $file);",
          "841:         }",
          "843:     } else {",
          "",
          "[Added Lines]",
          "800:     if (count($draftfiles) > 1 || count($oldfiles) > 1) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0e7fd52e20790915f96154da00a041756c3abeb1",
      "candidate_info": {
        "commit_hash": "0e7fd52e20790915f96154da00a041756c3abeb1",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0e7fd52e20790915f96154da00a041756c3abeb1",
        "files": [
          "lib/filelib.php"
        ],
        "message": "MDL-39177 Update file in filearea only if original is present\n\nNow when file was deleted in filemanager and new file with the same file was uploaded the references will be converted to copies exactly like UI warns in filemanager.\nAlso do not delete original information from draftfiles.",
        "before_after_code_files": [
          "lib/filelib.php||lib/filelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/filelib.php||lib/filelib.php"
          ],
          "candidate": [
            "lib/filelib.php||lib/filelib.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/filelib.php||lib/filelib.php": [
          "File: lib/filelib.php -> lib/filelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "806:         foreach ($draftfiles as $file) {",
          "807:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid);",
          "808:             if (!$options['subdirs']) {",
          "809:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "810:                     continue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "808:             if ($source = @unserialize($file->get_source())) {",
          "810:                 $file_record['source'] = $source->source;",
          "811:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "832:                     $file_record['reference'] = $file->get_reference();",
          "833:                 }",
          "834:             }",
          "837:             $fs->create_file_from_storedfile($file_record, $file);",
          "838:         }",
          "",
          "[Removed Lines]",
          "835:             file_restore_source_field_from_draft_file($file);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "844:         $newhashes = array();",
          "845:         foreach ($draftfiles as $file) {",
          "846:             $newhash = $fs->get_pathname_hash($contextid, $component, $filearea, $itemid, $file->get_filepath(), $file->get_filename());",
          "848:             $newhashes[$newhash] = $file;",
          "849:         }",
          "850:         $filecount = 0;",
          "",
          "[Removed Lines]",
          "847:             file_restore_source_field_from_draft_file($file);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "857:             }",
          "859:             $newfile = $newhashes[$oldhash];",
          "861:             if ($oldfile->get_status() != $newfile->get_status()) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "864:             if ($newfile->is_directory()) {",
          "866:             } else if (($source = @unserialize($newfile->get_source())) && isset($source->original)) {",
          "868:                 $original = file_storage::unpack_reference($source->original);",
          "869:                 if ($original['filename'] !== $oldfile->get_filename() || $original['filepath'] !== $oldfile->get_filepath()) {",
          "871:                     $oldfile->delete();",
          "872:                     continue;",
          "873:                 }",
          "874:             } else {",
          "877:                 $oldfile->delete();",
          "878:                 continue;",
          "879:             }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "875:             }",
          "880:             }",
          "",
          "[Removed Lines]",
          "878:             if ($oldfile->get_source() != $newfile->get_source()) {",
          "879:                 $oldfile->set_source($newfile->get_source());",
          "",
          "[Added Lines]",
          "899:             $newsource = $newfile->get_source();",
          "900:             if ($source = @unserialize($newfile->get_source())) {",
          "901:                 $newsource = $source->source;",
          "902:             }",
          "903:             if ($oldfile->get_source() !== $newsource) {",
          "904:                 $oldfile->set_source($newsource);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "893:                 continue;",
          "894:             }",
          "897:                     $oldfile->get_filesize() != $newfile->get_filesize() ||",
          "899:                 $oldfile->replace_file_with($newfile);",
          "901:                 $fs->update_references_to_storedfile($oldfile);",
          "",
          "[Removed Lines]",
          "896:             else if ($oldfile->get_contenthash() != $newfile->get_contenthash() ||",
          "898:                     $oldfile->get_referencefileid() != $newfile->get_referencefileid()) {",
          "",
          "[Added Lines]",
          "921:             if (!$oldfile->is_directory() &&",
          "922:                     ($oldfile->get_contenthash() != $newfile->get_contenthash() ||",
          "924:                     $oldfile->get_referencefileid() != $newfile->get_referencefileid())) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "913:         foreach ($newhashes as $file) {",
          "914:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid, 'timemodified'=>time());",
          "915:             if (!$options['subdirs']) {",
          "916:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "917:                     continue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "941:             if ($source = @unserialize($file->get_source())) {",
          "943:                 $file_record['source'] = $source->source;",
          "944:             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "73e7cca3c2825b49f8ab8c72d5970f563237cf62",
      "candidate_info": {
        "commit_hash": "73e7cca3c2825b49f8ab8c72d5970f563237cf62",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/73e7cca3c2825b49f8ab8c72d5970f563237cf62",
        "files": [
          "lib/filelib.php"
        ],
        "message": "MDL-39177 Update file in filearea only if original is present\n\nNow when file was deleted in filemanager and new file with the same file was uploaded the references will be converted to copies exactly like UI warns in filemanager.\nAlso do not delete original information from draftfiles.",
        "before_after_code_files": [
          "lib/filelib.php||lib/filelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/filelib.php||lib/filelib.php"
          ],
          "candidate": [
            "lib/filelib.php||lib/filelib.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/filelib.php||lib/filelib.php": [
          "File: lib/filelib.php -> lib/filelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "793:         foreach ($draftfiles as $file) {",
          "794:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid);",
          "795:             if (!$options['subdirs']) {",
          "796:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "797:                     continue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "795:             if ($source = @unserialize($file->get_source())) {",
          "797:                 $file_record['source'] = $source->source;",
          "798:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "819:                     $file_record['reference'] = $file->get_reference();",
          "820:                 }",
          "821:             }",
          "824:             $fs->create_file_from_storedfile($file_record, $file);",
          "825:         }",
          "",
          "[Removed Lines]",
          "822:             file_restore_source_field_from_draft_file($file);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "831:         $newhashes = array();",
          "832:         foreach ($draftfiles as $file) {",
          "833:             $newhash = $fs->get_pathname_hash($contextid, $component, $filearea, $itemid, $file->get_filepath(), $file->get_filename());",
          "835:             $newhashes[$newhash] = $file;",
          "836:         }",
          "837:         $filecount = 0;",
          "",
          "[Removed Lines]",
          "834:             file_restore_source_field_from_draft_file($file);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "844:             }",
          "846:             $newfile = $newhashes[$oldhash];",
          "848:             if ($oldfile->get_status() != $newfile->get_status()) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "851:             if ($newfile->is_directory()) {",
          "853:             } else if (($source = @unserialize($newfile->get_source())) && isset($source->original)) {",
          "855:                 $original = file_storage::unpack_reference($source->original);",
          "856:                 if ($original['filename'] !== $oldfile->get_filename() || $original['filepath'] !== $oldfile->get_filepath()) {",
          "858:                     $oldfile->delete();",
          "859:                     continue;",
          "860:                 }",
          "861:             } else {",
          "864:                 $oldfile->delete();",
          "865:                 continue;",
          "866:             }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "862:             }",
          "867:             }",
          "",
          "[Removed Lines]",
          "865:             if ($oldfile->get_source() != $newfile->get_source()) {",
          "866:                 $oldfile->set_source($newfile->get_source());",
          "",
          "[Added Lines]",
          "886:             $newsource = $newfile->get_source();",
          "887:             if ($source = @unserialize($newfile->get_source())) {",
          "888:                 $newsource = $source->source;",
          "889:             }",
          "890:             if ($oldfile->get_source() !== $newsource) {",
          "891:                 $oldfile->set_source($newsource);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "880:                 continue;",
          "881:             }",
          "884:                     $oldfile->get_filesize() != $newfile->get_filesize() ||",
          "886:                 $oldfile->replace_file_with($newfile);",
          "888:                 $fs->update_references_to_storedfile($oldfile);",
          "",
          "[Removed Lines]",
          "883:             else if ($oldfile->get_contenthash() != $newfile->get_contenthash() ||",
          "885:                     $oldfile->get_referencefileid() != $newfile->get_referencefileid()) {",
          "",
          "[Added Lines]",
          "908:             if (!$oldfile->is_directory() &&",
          "909:                     ($oldfile->get_contenthash() != $newfile->get_contenthash() ||",
          "911:                     $oldfile->get_referencefileid() != $newfile->get_referencefileid())) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "900:         foreach ($newhashes as $file) {",
          "901:             $file_record = array('contextid'=>$contextid, 'component'=>$component, 'filearea'=>$filearea, 'itemid'=>$itemid, 'timemodified'=>time());",
          "902:             if (!$options['subdirs']) {",
          "903:                 if ($file->get_filepath() !== '/' or $file->is_directory()) {",
          "904:                     continue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "928:             if ($source = @unserialize($file->get_source())) {",
          "930:                 $file_record['source'] = $source->source;",
          "931:             }",
          "",
          "---------------"
        ]
      }
    }
  ]
}