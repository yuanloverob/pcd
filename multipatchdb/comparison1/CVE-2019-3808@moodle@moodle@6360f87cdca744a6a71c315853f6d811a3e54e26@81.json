{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "daf0b4f08be69c34550f9df47cef43b17473c372",
      "candidate_info": {
        "commit_hash": "daf0b4f08be69c34550f9df47cef43b17473c372",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/daf0b4f08be69c34550f9df47cef43b17473c372",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.6dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018102300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181019)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018102300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181023)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e0034b5da6ffe2f1573cb17e50d7ac79d91c4652",
      "candidate_info": {
        "commit_hash": "e0034b5da6ffe2f1573cb17e50d7ac79d91c4652",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e0034b5da6ffe2f1573cb17e50d7ac79d91c4652",
        "files": [
          "lib/classes/output/external.php",
          "lib/db/services.php",
          "lib/tests/output_external_test.php",
          "version.php"
        ],
        "message": "MDL-64348 template: add load_template_with_dependencies external func",
        "before_after_code_files": [
          "lib/classes/output/external.php||lib/classes/output/external.php",
          "lib/db/services.php||lib/db/services.php",
          "lib/tests/output_external_test.php||lib/tests/output_external_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/classes/output/external.php||lib/classes/output/external.php": [
          "File: lib/classes/output/external.php -> lib/classes/output/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:             );",
          "59:     }",
          "",
          "[Removed Lines]",
          "66:     protected static function strip_template_comments($templatestr) {",
          "67:         return preg_replace('/(?={{!)(.*)(}})/sU', '', $templatestr);",
          "68:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "84:                                                   'themename' => $themename,",
          "85:                                                   'includecomments' => $includecomments));",
          "104:     }",
          "",
          "[Removed Lines]",
          "87:         $component = $params['component'];",
          "88:         $template = $params['template'];",
          "89:         $themename = $params['themename'];",
          "90:         $includecomments = $params['includecomments'];",
          "92:         $templatename = $component . '/' . $template;",
          "95:         $filename = mustache_template_finder::get_template_filepath($templatename, $themename);",
          "96:         $templatestr = file_get_contents($filename);",
          "99:         if (!$includecomments) {",
          "100:             $templatestr = self::strip_template_comments($templatestr);",
          "101:         }",
          "103:         return $templatestr;",
          "",
          "[Added Lines]",
          "78:         $loader = new mustache_template_source_loader();",
          "80:         return $loader->load(",
          "81:             $params['component'],",
          "82:             $params['template'],",
          "83:             $params['themename'],",
          "84:             $params['includecomments']",
          "85:         );",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "112:         return new external_value(PARAM_RAW, 'template');",
          "113:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102:     public static function load_template_with_dependencies_parameters() {",
          "103:         return new external_function_parameters([",
          "104:             'component' => new external_value(PARAM_COMPONENT, 'component containing the template'),",
          "105:             'template' => new external_value(PARAM_ALPHANUMEXT, 'name of the template'),",
          "106:             'themename' => new external_value(PARAM_ALPHANUMEXT, 'The current theme.'),",
          "107:             'includecomments' => new external_value(PARAM_BOOL, 'Include comments or not', VALUE_DEFAULT, false)",
          "108:         ]);",
          "109:     }",
          "120:     public static function load_template_with_dependencies(",
          "121:         string $component,",
          "122:         string $template,",
          "123:         string $themename,",
          "124:         bool $includecomments = false",
          "125:     ) {",
          "126:         global $DB, $CFG, $PAGE;",
          "128:         $params = self::validate_parameters(",
          "129:             self::load_template_with_dependencies_parameters(),",
          "130:             [",
          "131:                 'component' => $component,",
          "132:                 'template' => $template,",
          "133:                 'themename' => $themename,",
          "134:                 'includecomments' => $includecomments",
          "135:             ]",
          "136:         );",
          "138:         $loader = new mustache_template_source_loader();",
          "140:         $dependencies = $loader->load_with_dependencies(",
          "141:             $params['component'],",
          "142:             $params['template'],",
          "143:             $params['themename'],",
          "144:             $params['includecomments']",
          "145:         );",
          "146:         $formatdependencies = function($dependency) {",
          "147:             $results = [];",
          "148:             foreach ($dependency as $dependencycomponent => $dependencyvalues) {",
          "149:                 foreach ($dependencyvalues as $dependencyname => $dependencyvalue) {",
          "150:                     array_push($results, [",
          "151:                         'component' => $dependencycomponent,",
          "152:                         'name' => $dependencyname,",
          "153:                         'value' => $dependencyvalue",
          "154:                     ]);",
          "155:                 }",
          "156:             }",
          "157:             return $results;",
          "158:         };",
          "162:         return [",
          "163:             'templates' => $formatdependencies($dependencies['templates']),",
          "164:             'strings' => $formatdependencies($dependencies['strings'])",
          "165:         ];",
          "166:     }",
          "173:     public static function load_template_with_dependencies_returns() {",
          "174:         $resourcestructure = new external_single_structure([",
          "175:             'component' => new external_value(PARAM_COMPONENT, 'component containing the resource'),",
          "176:             'name' => new external_value(PARAM_TEXT, 'name of the resource'),",
          "177:             'value' => new external_value(PARAM_RAW, 'resource value')",
          "178:         ]);",
          "180:         return new external_single_structure([",
          "181:             'templates' => new external_multiple_structure($resourcestructure),",
          "182:             'strings' => new external_multiple_structure($resourcestructure)",
          "183:         ]);",
          "184:     }",
          "",
          "---------------"
        ],
        "lib/db/services.php||lib/db/services.php": [
          "File: lib/db/services.php -> lib/db/services.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1396:         'loginrequired' => false,",
          "1397:         'ajax' => true,",
          "1398:     ),",
          "1399:     'core_output_load_fontawesome_icon_map' => array(",
          "1400:         'classname' => 'core\\output\\external',",
          "1401:         'methodname' => 'load_fontawesome_icon_map',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1399:     'core_output_load_template_with_dependencies' => array(",
          "1400:         'classname' => 'core\\output\\external',",
          "1401:         'methodname' => 'load_template_with_dependencies',",
          "1402:         'description' => 'Load a template and its dependencies for a renderable',",
          "1403:         'type' => 'read',",
          "1404:         'loginrequired' => false,",
          "1405:         'ajax' => true,",
          "1406:     ),",
          "",
          "---------------"
        ],
        "lib/tests/output_external_test.php||lib/tests/output_external_test.php": [
          "File: lib/tests/output_external_test.php -> lib/tests/output_external_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018122000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4428b042cbbd92933196e1a8bf592d106cf4387f",
      "candidate_info": {
        "commit_hash": "4428b042cbbd92933196e1a8bf592d106cf4387f",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4428b042cbbd92933196e1a8bf592d106cf4387f",
        "files": [
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-63211 core: upgrade to move blocked contacts to new table",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2473:         upgrade_main_savepoint(true, 2018092800.00);",
          "2474:     }",
          "2476:     return true;",
          "2477: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2476:     if ($oldversion < 2018092800.01) {",
          "2478:         $updatesql = \"INSERT INTO {message_users_blocked} (userid, blockeduserid, timecreated)",
          "2479:                            SELECT userid, contactid, null as timecreated",
          "2480:                              FROM {message_contacts}",
          "2481:                             WHERE blocked = :blocked\";",
          "2482:         $DB->execute($updatesql, ['blocked' => 1]);",
          "2485:         $table = new xmldb_table('message_contacts');",
          "2486:         $field = new xmldb_field('blocked');",
          "2487:         $dbman->drop_field($table, $field);",
          "2489:         upgrade_main_savepoint(true, 2018092800.01);",
          "2490:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018092800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018092800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "39fab18e27035b610fba956e1ff9e5f945bed0c5",
      "candidate_info": {
        "commit_hash": "39fab18e27035b610fba956e1ff9e5f945bed0c5",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/39fab18e27035b610fba956e1ff9e5f945bed0c5",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018032700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180322)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018032900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180329)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bc2f679bca4de016327a56d42871b8ad89d91fdb",
      "candidate_info": {
        "commit_hash": "bc2f679bca4de016327a56d42871b8ad89d91fdb",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bc2f679bca4de016327a56d42871b8ad89d91fdb",
        "files": [
          "analytics/tests/stats_test.php",
          "lib/db/analytics.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-65582 analytics: Upcoming activities due enabled by default",
        "before_after_code_files": [
          "analytics/tests/stats_test.php||analytics/tests/stats_test.php",
          "lib/db/analytics.php||lib/db/analytics.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "analytics/tests/stats_test.php||analytics/tests/stats_test.php": [
          "File: analytics/tests/stats_test.php -> analytics/tests/stats_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:         $this->resetAfterTest(true);",
          "57:         $model = \\core_analytics\\model::create(",
          "58:             \\core_analytics\\manager::get_target('\\core_course\\analytics\\target\\course_dropout'),",
          "",
          "[Removed Lines]",
          "55:         $this->assertEquals(1, \\core_analytics\\stats::enabled_models());",
          "",
          "[Added Lines]",
          "56:         $this->assertEquals(2, \\core_analytics\\stats::enabled_models());",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "62:         );",
          "68:         $model->enable('\\core\\analytics\\time_splitting\\quarters');",
          "70:     }",
          "",
          "[Removed Lines]",
          "65:         $this->assertEquals(1, \\core_analytics\\stats::enabled_models());",
          "69:         $this->assertEquals(2, \\core_analytics\\stats::enabled_models());",
          "",
          "[Added Lines]",
          "66:         $this->assertEquals(2, \\core_analytics\\stats::enabled_models());",
          "70:         $this->assertEquals(3, \\core_analytics\\stats::enabled_models());",
          "",
          "---------------"
        ],
        "lib/db/analytics.php||lib/db/analytics.php": [
          "File: lib/db/analytics.php -> lib/db/analytics.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:             '\\core_course\\analytics\\indicator\\activities_due',",
          "96:         ],",
          "97:         'timesplitting' => '\\core\\analytics\\time_splitting\\upcoming_week',",
          "98:     ],",
          "99: ];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "98:         'enabled' => true,",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3421:         upgrade_main_savepoint(true, 2019050600.00);",
          "3422:     }",
          "3424:     return true;",
          "3425: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3424:     if ($oldversion < 2019051100.02) {",
          "3425:         $DB->set_field('analytics_models', 'enabled', '1', ['target' => '\\core_user\\analytics\\target\\upcoming_activities_due']);",
          "3428:         upgrade_main_savepoint(true, 2019051100.02);",
          "3429:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019051100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019051100.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}