{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5acef15175ffd3d4da17cadd860a7a2f21511ba3",
      "candidate_info": {
        "commit_hash": "5acef15175ffd3d4da17cadd860a7a2f21511ba3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5acef15175ffd3d4da17cadd860a7a2f21511ba3",
        "files": [
          "lang/en/admin.php",
          "lib/classes/task/grade_cron_task.php",
          "lib/classes/task/grade_history_cleanup_task.php",
          "lib/db/tasks.php",
          "version.php"
        ],
        "message": "MDL-65044 core: add task for grade history cleanup",
        "before_after_code_files": [
          "lang/en/admin.php||lang/en/admin.php",
          "lib/classes/task/grade_cron_task.php||lib/classes/task/grade_cron_task.php",
          "lib/classes/task/grade_history_cleanup_task.php||lib/classes/task/grade_history_cleanup_task.php",
          "lib/db/tasks.php||lib/db/tasks.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1234: $string['taskglobalsearchindex'] = 'Global search indexing';",
          "1235: $string['taskglobalsearchoptimize'] = 'Global search index optimization';",
          "1236: $string['taskgradecron'] = 'Background processing for gradebook';",
          "1237: $string['tasklegacycron'] = 'Legacy cron processing for plugins';",
          "1238: $string['tasklogcleanup'] = 'Cleanup of task logs';",
          "1239: $string['tasklogs'] = 'Task logs';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1237: $string['taskgradehistorycleanup'] = 'Background processing for clean grade history tables';",
          "",
          "---------------"
        ],
        "lib/classes/task/grade_cron_task.php||lib/classes/task/grade_cron_task.php": [
          "File: lib/classes/task/grade_cron_task.php -> lib/classes/task/grade_cron_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "85:             $gradegrade->update('locktime');",
          "86:         }",
          "87:         $rs->close();",
          "99:     }",
          "101: }",
          "",
          "[Removed Lines]",
          "90:         if (!empty($CFG->gradehistorylifetime)) {",
          "91:             $histlifetime = $now - ($CFG->gradehistorylifetime * DAYSECS);",
          "92:             $tables = array('grade_outcomes_history', 'grade_categories_history', 'grade_items_history', 'grade_grades_history', 'scale_history');",
          "93:             foreach ($tables as $table) {",
          "94:                 if ($DB->delete_records_select($table, \"timemodified < ?\", array($histlifetime))) {",
          "95:                     mtrace(\"    Deleted old grade history records from '$table'\");",
          "96:                 }",
          "97:             }",
          "98:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/classes/task/grade_history_cleanup_task.php||lib/classes/task/grade_history_cleanup_task.php": [
          "File: lib/classes/task/grade_history_cleanup_task.php -> lib/classes/task/grade_history_cleanup_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace core\\task;",
          "25: defined('MOODLE_INTERNAL') || die();",
          "33: class grade_history_cleanup_task extends scheduled_task {",
          "40:     public function get_name() {",
          "41:         return get_string('taskgradehistorycleanup', 'admin');",
          "42:     }",
          "47:     public function execute() {",
          "48:         global $CFG, $DB;",
          "50:         if (!empty($CFG->gradehistorylifetime)) {",
          "51:             $now = time();",
          "52:             $histlifetime = $now - ($CFG->gradehistorylifetime * DAYSECS);",
          "53:             $tables = [",
          "54:                 'grade_outcomes_history',",
          "55:                 'grade_categories_history',",
          "56:                 'grade_items_history',",
          "57:                 'grade_grades_history',",
          "58:                 'scale_history'",
          "59:             ];",
          "60:             foreach ($tables as $table) {",
          "61:                 if ($DB->delete_records_select($table, \"timemodified < ?\", [$histlifetime])) {",
          "62:                     mtrace(\"    Deleted old grade history records from '$table'\");",
          "63:                 }",
          "64:             }",
          "65:         }",
          "66:     }",
          "67: }",
          "",
          "---------------"
        ],
        "lib/db/tasks.php||lib/db/tasks.php": [
          "File: lib/db/tasks.php -> lib/db/tasks.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "149:         'dayofweek' => '*',",
          "150:         'month' => '*'",
          "151:     ),",
          "152:     array(",
          "153:         'classname' => 'core\\task\\completion_regular_task',",
          "154:         'blocking' => 0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152:     array(",
          "153:         'classname' => 'core\\task\\grade_history_cleanup_task',",
          "154:         'blocking' => 0,",
          "155:         'minute' => '*',",
          "156:         'hour' => '0',",
          "157:         'day' => '*',",
          "158:         'dayofweek' => '*',",
          "159:         'month' => '*'",
          "160:     ),",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019032200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019032200.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "06888cfef9f7d8d8b69923132104e7a449b573eb",
      "candidate_info": {
        "commit_hash": "06888cfef9f7d8d8b69923132104e7a449b573eb",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/06888cfef9f7d8d8b69923132104e7a449b573eb",
        "files": [
          "lib/db/services.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-66374-master' of git://github.com/jleyva/moodle",
        "before_after_code_files": [
          "lib/db/services.php||lib/db/services.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/services.php||lib/db/services.php": [
          "File: lib/db/services.php -> lib/db/services.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "862:         'classpath' => 'group/externallib.php',",
          "863:         'description' => 'Returns all groupings in specified course.',",
          "864:         'type' => 'read',",
          "865:     ),",
          "866:     'core_group_get_course_groups' => array(",
          "867:         'classname' => 'core_group_external',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "865:         'services' => array(MOODLE_OFFICIAL_MOBILE_SERVICE),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "870:         'description' => 'Returns all groups in specified course.',",
          "871:         'type' => 'read',",
          "872:         'ajax' => true,",
          "874:     ),",
          "875:     'core_group_get_course_user_groups' => array(",
          "876:         'classname' => 'core_group_external',",
          "",
          "[Removed Lines]",
          "873:         'capabilities' => 'moodle/course:managegroups'",
          "",
          "[Added Lines]",
          "874:         'capabilities' => 'moodle/course:managegroups',",
          "875:         'services' => array(MOODLE_OFFICIAL_MOBILE_SERVICE),",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019082400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019082400.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "22dfa6d31dcb2f5fb6f47b819fa83d739c4547ac",
      "candidate_info": {
        "commit_hash": "22dfa6d31dcb2f5fb6f47b819fa83d739c4547ac",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/22dfa6d31dcb2f5fb6f47b819fa83d739c4547ac",
        "files": [
          "admin/settings/development.php",
          "config-dist.php",
          "lang/en/admin.php",
          "lib/db/upgrade.php",
          "lib/moodlelib.php",
          "version.php"
        ],
        "message": "MDL-60347 core: debugsmtp should be a developer only setting.",
        "before_after_code_files": [
          "admin/settings/development.php||admin/settings/development.php",
          "config-dist.php||config-dist.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/moodlelib.php||lib/moodlelib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/development.php||admin/settings/development.php": [
          "File: admin/settings/development.php -> admin/settings/development.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "35:     $temp = new admin_settingpage('debugging', new lang_string('debugging', 'admin'));",
          "36:     $temp->add(new admin_setting_special_debug());",
          "37:     $temp->add(new admin_setting_configcheckbox('debugdisplay', new lang_string('debugdisplay', 'admin'), new lang_string('configdebugdisplay', 'admin'), ini_get_bool('display_errors')));",
          "39:     $temp->add(new admin_setting_configcheckbox('perfdebug', new lang_string('perfdebug', 'admin'), new lang_string('configperfdebug', 'admin'), '7', '15', '7'));",
          "40:     $temp->add(new admin_setting_configcheckbox('debugstringids', new lang_string('debugstringids', 'admin'), new lang_string('debugstringids_desc', 'admin'), 0));",
          "41:     $temp->add(new admin_setting_configcheckbox('debugvalidators', new lang_string('debugvalidators', 'admin'), new lang_string('configdebugvalidators', 'admin'), 0));",
          "",
          "[Removed Lines]",
          "38:     $temp->add(new admin_setting_configcheckbox('debugsmtp', new lang_string('debugsmtp', 'admin'), new lang_string('configdebugsmtp', 'admin'), 0));",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "config-dist.php||config-dist.php": [
          "File: config-dist.php -> config-dist.php"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "199: $string['configdebug'] = 'If you turn this on, then PHP\\'s error_reporting will be increased so that more warnings are printed.  This is only useful for developers.';",
          "200: $string['configdebugdisplay'] = 'Set to on, the error reporting will go to the HTML page. This is practical, but breaks XHTML, JS, cookies and HTTP headers in general. Set to off, it will send the output to your server logs, allowing better debugging. The PHP setting error_log controls which log this goes to.';",
          "201: $string['configdebugpageinfo'] = 'Enable if you want page information printed in page footer.';",
          "203: $string['configdebugvalidators'] = 'Enable if you want to have links to external validator servers in page footer. You may need to create new user with username <em>w3cvalidator</em>, and enable guest access. These changes may allow unauthorized access to server, do not enable on production sites!';",
          "204: $string['configdefaulthomepage'] = 'This determines the home page for logged in users';",
          "205: $string['configdefaultrequestcategory'] = 'Courses requested by users will be automatically placed in this category.';",
          "",
          "[Removed Lines]",
          "202: $string['configdebugsmtp'] = 'Enable verbose debug information during sending of email messages to SMTP server.';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "448: $string['debugnone'] = 'NONE: Do not show any errors or warnings';",
          "449: $string['debugnormal'] = 'NORMAL: Show errors, warnings and notices';",
          "450: $string['debugpageinfo'] = 'Show page information';",
          "452: $string['debugstringids'] = 'Show origin of languages strings';",
          "453: $string['debugstringids_desc'] = 'If enabled, language string components and identifiers are displayed when ?strings=1 or &strings=1 is appended to the page URL.';",
          "454: $string['debugvalidators'] = 'Show validator links';",
          "",
          "[Removed Lines]",
          "451: $string['debugsmtp'] = 'Debug email sending';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3394:         upgrade_main_savepoint(true, 2019060600.02);",
          "3395:     }",
          "3397:     return true;",
          "3398: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3397:     if ($oldversion < 2019062900.00) {",
          "3399:         $DB->delete_records('config', array('name' => 'debugsmtp'));",
          "3402:         upgrade_main_savepoint(true, 2019062900.00);",
          "3403:     }",
          "",
          "---------------"
        ],
        "lib/moodlelib.php||lib/moodlelib.php": [
          "File: lib/moodlelib.php -> lib/moodlelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5770:         } else {",
          "5772:             $mailer->isSMTP();",
          "5774:                 $mailer->SMTPDebug = 3;",
          "5775:             }",
          "",
          "[Removed Lines]",
          "5773:             if (!empty($CFG->debugsmtp)) {",
          "",
          "[Added Lines]",
          "5773:             if (!empty($CFG->debugsmtp) && (!empty($CFG->debugdeveloper))) {",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019062800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019062900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0e1e1e5586a1f43c951d9a399243220a3ccf882c",
      "candidate_info": {
        "commit_hash": "0e1e1e5586a1f43c951d9a399243220a3ccf882c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0e1e1e5586a1f43c951d9a399243220a3ccf882c",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.7dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019011801.03;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev (Build: 20190118)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019012400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev (Build: 20190124)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a31719f91a91f6329752c6d01ba9cb8b1cea68cc",
      "candidate_info": {
        "commit_hash": "a31719f91a91f6329752c6d01ba9cb8b1cea68cc",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a31719f91a91f6329752c6d01ba9cb8b1cea68cc",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.8dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019100400.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191004)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019100800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191008)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}