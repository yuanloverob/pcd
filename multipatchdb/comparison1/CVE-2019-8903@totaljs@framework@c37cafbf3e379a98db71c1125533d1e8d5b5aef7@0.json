{
  "cve_id": "CVE-2019-8903",
  "cve_desc": "index.js in Total.js Platform before 3.2.3 allows path traversal.",
  "repo": "totaljs/framework",
  "patch_hash": "c37cafbf3e379a98db71c1125533d1e8d5b5aef7",
  "patch_info": {
    "commit_hash": "c37cafbf3e379a98db71c1125533d1e8d5b5aef7",
    "repo": "totaljs/framework",
    "commit_url": "https://github.com/totaljs/framework/commit/c37cafbf3e379a98db71c1125533d1e8d5b5aef7",
    "files": [
      "index.js",
      "package.json"
    ],
    "message": "Improved security.",
    "before_after_code_files": [
      "index.js||index.js"
    ]
  },
  "patch_diff": {
    "index.js||index.js": [
      "File: index.js -> index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "68: const REG_SKIPERROR = /epipe|invalid\\sdistance/i;",
      "69: const REG_OLDCONF = /-/g;",
      "70: const REG_UTF8 = /[^\\x20-\\x7E]+/;",
      "72: const FLAGS_INSTALL = ['get'];",
      "73: const FLAGS_DOWNLOAD = ['get', 'dnscache'];",
      "74: const QUERYPARSEROPTIONS = { maxKeys: 33 };",
      "",
      "[Removed Lines]",
      "71: const REG_TRAVEL = /(\\/)?\\.\\.\\//g;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "7327:  var headers = req.headers;",
      "7328:  req.$protocol = ((req.connection && req.connection.encrypted) || ((headers['x-forwarded-proto'] || ['x-forwarded-protocol']) === 'https')) ? 'https' : 'http';",
      "7331:  req.uri = framework_internal.parseURI(req);",
      "7333:  F.stats.request.request++;",
      "",
      "[Removed Lines]",
      "7330:  req.url = req.url.replace(REG_TRAVEL, '');",
      "",
      "[Added Lines]",
      "7329:  var beg = 0;",
      "7332:  for (var i = 0; i < req.url.length; i++) {",
      "7333:   if (req.url[i] === '.' && req.url[i + 1] === '/')",
      "7334:    beg = i + 1;",
      "7335:   else if (req.url[i] === '?')",
      "7336:    break;",
      "7337:  }",
      "7339:  if (beg)",
      "7340:   req.url = req.url.substring(beg);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fca784f28a702f9795a482f2a6081db0a6b63032",
      "candidate_info": {
        "commit_hash": "fca784f28a702f9795a482f2a6081db0a6b63032",
        "repo": "totaljs/framework",
        "commit_url": "https://github.com/totaljs/framework/commit/fca784f28a702f9795a482f2a6081db0a6b63032",
        "files": [
          "changes.txt",
          "index.js"
        ],
        "message": "Fixed security.",
        "before_after_code_files": [
          "index.js||index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "index.js||index.js"
          ],
          "candidate": [
            "index.js||index.js"
          ]
        }
      },
      "candidate_diff": {
        "index.js||index.js": [
          "File: index.js -> index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "68: const REG_SKIPERROR = /epipe|invalid\\sdistance/i;",
          "69: const REG_OLDCONF = /-/g;",
          "70: const REG_UTF8 = /[^\\x20-\\x7E]+/;",
          "71: const FLAGS_INSTALL = ['get'];",
          "72: const FLAGS_DOWNLOAD = ['get', 'dnscache'];",
          "73: const QUERYPARSEROPTIONS = { maxKeys: 33 };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: const REG_TRAVEL = /(\\/)?\\.\\.\\//g;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "117: HEADERS.responseCode = {};",
          "118: HEADERS.responseCode[HEADER_TYPE] = CT_TEXT;",
          "120: HEADERS.redirect = {};",
          "121: HEADERS.redirect[HEADER_TYPE] = CT_HTML + '; charset=utf-8';",
          "122: HEADERS.redirect[HEADER_LENGTH] = '0';",
          "",
          "[Removed Lines]",
          "119: HEADERS.responseCode['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "125: HEADERS.sse['Pragma'] = 'no-cache';",
          "126: HEADERS.sse['Expires'] = '-1';",
          "127: HEADERS.sse[HEADER_TYPE] = 'text/event-stream';",
          "129: HEADERS.file_lastmodified = {};",
          "130: HEADERS.file_lastmodified['Access-Control-Allow-Origin'] = '*';",
          "131: HEADERS.file_lastmodified[HEADER_CACHE] = 'public, max-age=11111111';",
          "133: HEADERS.file_release_compress = {};",
          "134: HEADERS.file_release_compress[HEADER_CACHE] = 'public, max-age=11111111';",
          "135: HEADERS.file_release_compress['Vary'] = 'Accept-Encoding';",
          "136: HEADERS.file_release_compress['Access-Control-Allow-Origin'] = '*';",
          "137: HEADERS.file_release_compress['Last-Modified'] = 'Mon, 01 Jan 2001 08:00:00 GMT';",
          "138: HEADERS.file_release_compress['Content-Encoding'] = 'gzip';",
          "140: HEADERS.file_release_compress_range = {};",
          "141: HEADERS.file_release_compress_range['Accept-Ranges'] = 'bytes';",
          "142: HEADERS.file_release_compress_range[HEADER_CACHE] = 'public, max-age=11111111';",
          "",
          "[Removed Lines]",
          "128: HEADERS.sse['X-Powered-By'] = 'Total.js';",
          "132: HEADERS.file_lastmodified['X-Powered-By'] = 'Total.js';",
          "139: HEADERS.file_release_compress['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "146: HEADERS.file_release_compress_range['Content-Encoding'] = 'gzip';",
          "147: HEADERS.file_release_compress_range[HEADER_LENGTH] = '0';",
          "148: HEADERS.file_release_compress_range['Content-Range'] = '';",
          "150: HEADERS.file_release = {};",
          "151: HEADERS.file_release[HEADER_CACHE] = 'public, max-age=11111111';",
          "152: HEADERS.file_release['Vary'] = 'Accept-Encoding';",
          "153: HEADERS.file_release['Access-Control-Allow-Origin'] = '*';",
          "154: HEADERS.file_release['Last-Modified'] = 'Mon, 01 Jan 2001 08:00:00 GMT';",
          "156: HEADERS.file_release_range = {};",
          "157: HEADERS.file_release_range['Accept-Ranges'] = 'bytes';",
          "158: HEADERS.file_release_range[HEADER_CACHE] = 'public, max-age=11111111';",
          "",
          "[Removed Lines]",
          "149: HEADERS.file_release_compress_range['X-Powered-By'] = 'Total.js';",
          "155: HEADERS.file_release['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "161: HEADERS.file_release_range['Last-Modified'] = 'Mon, 01 Jan 2001 08:00:00 GMT';",
          "162: HEADERS.file_release_range[HEADER_LENGTH] = '0';",
          "163: HEADERS.file_release_range['Content-Range'] = '';",
          "165: HEADERS.file_debug_compress = {};",
          "166: HEADERS.file_debug_compress[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "167: HEADERS.file_debug_compress['Vary'] = 'Accept-Encoding';",
          "",
          "[Removed Lines]",
          "164: HEADERS.file_release_range['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "169: HEADERS.file_debug_compress['Pragma'] = 'no-cache';",
          "170: HEADERS.file_debug_compress['Expires'] = '-1';",
          "171: HEADERS.file_debug_compress['Content-Encoding'] = 'gzip';",
          "173: HEADERS.file_debug_compress_range = {};",
          "174: HEADERS.file_debug_compress_range['Accept-Ranges'] = 'bytes';",
          "175: HEADERS.file_debug_compress_range[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "",
          "[Removed Lines]",
          "172: HEADERS.file_debug_compress['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "180: HEADERS.file_debug_compress_range['Expires'] = '-1';",
          "181: HEADERS.file_debug_compress_range[HEADER_LENGTH] = '0';",
          "182: HEADERS.file_debug_compress_range['Content-Range'] = '';",
          "184: HEADERS.file_debug = {};",
          "185: HEADERS.file_debug[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "186: HEADERS.file_debug['Vary'] = 'Accept-Encoding';",
          "187: HEADERS.file_debug['Pragma'] = 'no-cache';",
          "188: HEADERS.file_debug['Expires'] = '-1';",
          "189: HEADERS.file_debug['Access-Control-Allow-Origin'] = '*';",
          "191: HEADERS.file_debug_range = {};",
          "192: HEADERS.file_debug_range['Accept-Ranges'] = 'bytes';",
          "193: HEADERS.file_debug_range[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "",
          "[Removed Lines]",
          "183: HEADERS.file_debug_compress_range['X-Powered-By'] = 'Total.js';",
          "190: HEADERS.file_debug['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "197: HEADERS.file_debug_range['Expires'] = '-1';",
          "198: HEADERS.file_debug_range[HEADER_LENGTH] = '0';",
          "199: HEADERS.file_debug_range['Content-Range'] = '';",
          "201: HEADERS.content_mobile_release = {};",
          "202: HEADERS.content_mobile_release[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "203: HEADERS.content_mobile_release['Vary'] = 'Accept-Encoding, User-Agent';",
          "204: HEADERS.content_mobile_release['Content-Encoding'] = 'gzip';",
          "205: HEADERS.content_mobile_release['Expires'] = '-1';",
          "207: HEADERS.content_mobile = {};",
          "208: HEADERS.content_mobile[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "209: HEADERS.content_mobile['Vary'] = 'Accept-Encoding, User-Agent';",
          "210: HEADERS.content_mobile['Expires'] = '-1';",
          "212: HEADERS.content_compress = {};",
          "213: HEADERS.content_compress[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "214: HEADERS.content_compress['Vary'] = 'Accept-Encoding';",
          "215: HEADERS.content_compress['Content-Encoding'] = 'gzip';",
          "216: HEADERS.content_compress['Expires'] = '-1';",
          "218: HEADERS.content = {};",
          "219: HEADERS.content[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "220: HEADERS.content['Vary'] = 'Accept-Encoding';",
          "221: HEADERS.content['Expires'] = '-1';",
          "223: HEADERS.stream_release_compress = {};",
          "224: HEADERS.stream_release_compress[HEADER_CACHE] = 'public, max-age=11111111';",
          "225: HEADERS.stream_release_compress['Access-Control-Allow-Origin'] = '*';",
          "226: HEADERS.stream_release_compress['Content-Encoding'] = 'gzip';",
          "228: HEADERS.stream_release = {};",
          "229: HEADERS.stream_release[HEADER_CACHE] = 'public, max-age=11111111';",
          "230: HEADERS.stream_release['Access-Control-Allow-Origin'] = '*';",
          "232: HEADERS.stream_debug_compress = {};",
          "233: HEADERS.stream_debug_compress[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "234: HEADERS.stream_debug_compress['Pragma'] = 'no-cache';",
          "235: HEADERS.stream_debug_compress['Expires'] = '-1';",
          "236: HEADERS.stream_debug_compress['Access-Control-Allow-Origin'] = '*';",
          "237: HEADERS.stream_debug_compress['Content-Encoding'] = 'gzip';",
          "239: HEADERS.stream_debug = {};",
          "240: HEADERS.stream_debug[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "241: HEADERS.stream_debug['Pragma'] = 'no-cache';",
          "242: HEADERS.stream_debug['Expires'] = '-1';",
          "243: HEADERS.stream_debug['Access-Control-Allow-Origin'] = '*';",
          "245: HEADERS.binary_compress = {};",
          "246: HEADERS.binary_compress[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "247: HEADERS.binary_compress['Content-Encoding'] = 'gzip';",
          "249: HEADERS.binary = {};",
          "250: HEADERS.binary[HEADER_CACHE] = 'public';",
          "252: HEADERS.authorization = { user: '', password: '', empty: true };",
          "253: HEADERS.fsStreamRead = { flags: 'r', mode: '0666', autoClose: true };",
          "254: HEADERS.fsStreamReadRange = { flags: 'r', mode: '0666', autoClose: true, start: 0, end: 0 };",
          "",
          "[Removed Lines]",
          "200: HEADERS.file_debug_range['X-Powered-By'] = 'Total.js';",
          "206: HEADERS.content_mobile_release['X-Powered-By'] = 'Total.js';",
          "211: HEADERS.content_mobile['X-Powered-By'] = 'Total.js';",
          "217: HEADERS.content_compress['X-Powered-By'] = 'Total.js';",
          "222: HEADERS.content['X-Powered-By'] = 'Total.js';",
          "227: HEADERS.stream_release_compress['X-Powered-By'] = 'Total.js';",
          "231: HEADERS.stream_release['X-Powered-By'] = 'Total.js';",
          "238: HEADERS.stream_debug_compress['X-Powered-By'] = 'Total.js';",
          "244: HEADERS.stream_debug['X-Powered-By'] = 'Total.js';",
          "248: HEADERS.binary_compress['X-Powered-By'] = 'Total.js';",
          "251: HEADERS.binary['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "256: HEADERS.responseLocalize = {};",
          "257: HEADERS.responseNotModified = {};",
          "258: HEADERS.responseNotModified[HEADER_CACHE] = 'public, max-age=11111111';",
          "260: HEADERS.response503 = {};",
          "261: HEADERS.response503[HEADER_CACHE] = 'private, no-cache, no-store, max-age=0';",
          "262: HEADERS.response503[HEADER_TYPE] = CT_HTML;",
          "269: Object.freeze(HEADERS.authorization);",
          "",
          "[Removed Lines]",
          "259: HEADERS.responseNotModified['X-Powered-By'] = 'Total.js';",
          "263: HEADERS.response503['X-Powered-By'] = 'Total.js';",
          "264: HEADERS.notModifiedEtag = {};",
          "265: HEADERS.notModifiedEtag['X-Powered-By'] = 'Total.js';",
          "266: HEADERS.notModifiedLastModifiedDate = {};",
          "267: HEADERS.notModifiedLastModifiedDate['X-Powered-By'] = 'Total.js';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "622: function UIDGENERATOR_REFRESH() {",
          "626:  UIDGENERATOR.date = NOW.format('yyMMddHHmm');",
          "627:  UIDGENERATOR.index = 1;",
          "628:  UIDGENERATOR.instance = random3string();",
          "",
          "[Removed Lines]",
          "624:  var year = NOW.getYear().toString();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "668:  self.version = 3200;",
          "669:  self.version_header = '3.2.0';",
          "670:  self.version_node = process.version.toString();",
          "673:  global.CONF = self.config = {",
          "",
          "[Removed Lines]",
          "671:  self.syshash = (Os.hostname() + '-' + Os.platform() + '-' + Os.arch() + '-' + Os.release() + '-' + Os.tmpdir()).md5();",
          "",
          "[Added Lines]",
          "643:  self.syshash = (__dirname + '-' + Os.hostname() + '-' + Os.platform() + '-' + Os.arch() + '-' + Os.release() + '-' + Os.tmpdir() + JSON.stringify(process.versions)).md5();",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "727:   default_layout: 'layout',",
          "728:   default_theme: '',",
          "729:   default_proxy: '',",
          "",
          "[Removed Lines]",
          "726:   default_xpoweredby: 'Total.js',",
          "",
          "[Added Lines]",
          "698:   default_xpoweredby: '',",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "7355:  var headers = req.headers;",
          "7356:  req.$protocol = ((req.connection && req.connection.encrypted) || ((headers['x-forwarded-proto'] || ['x-forwarded-protocol']) === 'https')) ? 'https' : 'http';",
          "7358:  req.uri = framework_internal.parseURI(req);",
          "7360:  F.stats.request.request++;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7330:  req.url = req.url.replace(REG_TRAVEL, '');",
          "",
          "---------------"
        ]
      }
    }
  ]
}