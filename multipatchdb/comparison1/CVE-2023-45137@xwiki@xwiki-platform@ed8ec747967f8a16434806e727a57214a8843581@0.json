{
  "cve_id": "CVE-2023-45137",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. `org.xwiki.platform:xwiki-platform-web` starting in version 3.1-milestone-2 and prior to version 13.4-rc-1, as well as `org.xwiki.platform:xwiki-platform-web-templates` prior to versions 14.10.12 and 15.5-rc-1, are vulnerable to cross-site scripting. When trying to create a document that already exists, XWiki displays an error message in the form for creating it. Due to missing escaping, this error message is vulnerable to raw HTML injection and thus XSS. The injected code is the document reference of the existing document so this requires that the attacker first creates a non-empty document whose name contains the attack code. This has been patched in `org.xwiki.platform:xwiki-platform-web` version 13.4-rc-1 and `org.xwiki.platform:xwiki-platform-web-templates` versions 14.10.12 and 15.5-rc-1 by adding the appropriate escaping. The vulnerable template file `createinline.vm` is part of XWiki's WAR and can be patched by manually applying the changes from the fix.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "ed8ec747967f8a16434806e727a57214a8843581",
  "patch_info": {
    "commit_hash": "ed8ec747967f8a16434806e727a57214a8843581",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/ed8ec747967f8a16434806e727a57214a8843581",
    "files": [
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
    ],
    "message": "XWIKI-20961: Improve escaping for document exists error\n\n* Add escaping for the document reference and add a test.",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
      "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "--- Hunk 1 ---",
      "[Context before]",
      "79:   <div class='box errormessage'>",
      "80:       ## Use the 'existingDocumentReference' context binding set by the create action for this case.",
      "81:       $services.localization.render('core.create.page.error.docalreadyexists',",
      "83:          $xwiki.getURL($existingDocumentReference, 'view', ''),",
      "84:          $xwiki.getURL($existingDocumentReference, 'edit', '')",
      "85:         ]",
      "",
      "[Removed Lines]",
      "82:         [\"${existingDocumentReference}\",",
      "",
      "[Added Lines]",
      "82:         [$escapetool.xml(\"${existingDocumentReference}\"),",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "52:     private static final String CREATE_INLINE_VM = \"createinline.vm\";",
      "54:     private VelocityManager velocityManager;",
      "56:     @Inject",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "54:     private static final String DOCUMENT_REFERENCE = \"xwiki:space.</div>page\";",
      "56:     private static final String CREATE_EXCEPTION_VELOCITY_KEY = \"createException\";",
      "58:     private static final String ERROR_MESSAGE_CLASS = \"errormessage\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71:     void testNameValidationError() throws Exception",
      "72:     {",
      "76:         XWikiException invalidNameException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
      "77:             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NAME_INVALID,",
      "78:             \"Cannot create document {0} because its name does not respect the name strategy of the wiki.\", null,",
      "79:             args);",
      "84:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
      "86:         assertNotNull(errormessage);",
      "88:         assertEquals(expectedMessage, errormessage.text());",
      "89:     }",
      "90: }",
      "",
      "[Removed Lines]",
      "74:         String documentReference = \"xwiki:space.</div>page\";",
      "75:         Object[] args = { documentReference };",
      "80:         this.velocityManager.getVelocityContext().put(\"createException\", invalidNameException);",
      "81:         this.velocityManager.getVelocityContext().put(\"invalidNameReference\", documentReference);",
      "85:         Element errormessage = document.getElementsByClass(\"errormessage\").first();",
      "87:         String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", documentReference);",
      "",
      "[Added Lines]",
      "80:         Object[] args = { DOCUMENT_REFERENCE };",
      "85:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, invalidNameException);",
      "86:         this.velocityManager.getVelocityContext().put(\"invalidNameReference\", DOCUMENT_REFERENCE);",
      "89:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
      "90:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
      "91:         assertNotNull(errormessage);",
      "92:         String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", DOCUMENT_REFERENCE);",
      "93:         assertEquals(expectedMessage, errormessage.text());",
      "94:     }",
      "99:     @Test",
      "100:     void testDocumentAlreadyExistsError() throws Exception",
      "101:     {",
      "103:         String urlToDocument = \"space/%3C%2Fdiv%3Epage\";",
      "104:         Object[] args = { DOCUMENT_REFERENCE };",
      "105:         XWikiException documentAlreadyExistsException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
      "106:             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NOT_EMPTY,",
      "107:             \"Cannot create document {0} because it already has content\", null, args);",
      "108:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, documentAlreadyExistsException);",
      "109:         this.velocityManager.getVelocityContext().put(\"existingDocumentReference\", DOCUMENT_REFERENCE);",
      "113:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
      "115:         String viewURL = String.format(\"/xwiki/bin/view/%s\", urlToDocument);",
      "116:         String editURL = String.format(\"/xwiki/bin/edit/%s\", urlToDocument);",
      "117:         String expectedMessage = String.format(\"core.create.page.error.docalreadyexists [%s, %s, %s]\",",
      "118:             DOCUMENT_REFERENCE, viewURL, editURL);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cbda5f1b567ff6af22624c02e99eb80b354c53d4",
      "candidate_info": {
        "commit_hash": "cbda5f1b567ff6af22624c02e99eb80b354c53d4",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/cbda5f1b567ff6af22624c02e99eb80b354c53d4",
        "files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ],
        "message": "XWIKI-20961: Improve escaping for document exists error\n\n* Add escaping for the document reference and add a test.\n\n(cherry picked from commit ed8ec747967f8a16434806e727a57214a8843581)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:   <div class='box errormessage'>",
          "80:       ## Use the 'existingDocumentReference' context binding set by the create action for this case.",
          "81:       $services.localization.render('core.create.page.error.docalreadyexists',",
          "83:          $xwiki.getURL($existingDocumentReference, 'view', ''),",
          "84:          $xwiki.getURL($existingDocumentReference, 'edit', '')",
          "85:         ]",
          "",
          "[Removed Lines]",
          "82:         [\"${existingDocumentReference}\",",
          "",
          "[Added Lines]",
          "82:         [$escapetool.xml(\"${existingDocumentReference}\"),",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:     private static final String CREATE_INLINE_VM = \"createinline.vm\";",
          "54:     private VelocityManager velocityManager;",
          "56:     @Inject",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:     private static final String DOCUMENT_REFERENCE = \"xwiki:space.</div>page\";",
          "56:     private static final String CREATE_EXCEPTION_VELOCITY_KEY = \"createException\";",
          "58:     private static final String ERROR_MESSAGE_CLASS = \"errormessage\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:     void testNameValidationError() throws Exception",
          "72:     {",
          "76:         XWikiException invalidNameException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
          "77:             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NAME_INVALID,",
          "78:             \"Cannot create document {0} because its name does not respect the name strategy of the wiki.\", null,",
          "79:             args);",
          "84:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
          "86:         assertNotNull(errormessage);",
          "88:         assertEquals(expectedMessage, errormessage.text());",
          "89:     }",
          "90: }",
          "",
          "[Removed Lines]",
          "74:         String documentReference = \"xwiki:space.</div>page\";",
          "75:         Object[] args = { documentReference };",
          "80:         this.velocityManager.getVelocityContext().put(\"createException\", invalidNameException);",
          "81:         this.velocityManager.getVelocityContext().put(\"invalidNameReference\", documentReference);",
          "85:         Element errormessage = document.getElementsByClass(\"errormessage\").first();",
          "87:         String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", documentReference);",
          "",
          "[Added Lines]",
          "80:         Object[] args = { DOCUMENT_REFERENCE };",
          "85:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, invalidNameException);",
          "86:         this.velocityManager.getVelocityContext().put(\"invalidNameReference\", DOCUMENT_REFERENCE);",
          "89:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
          "90:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
          "91:         assertNotNull(errormessage);",
          "92:         String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", DOCUMENT_REFERENCE);",
          "93:         assertEquals(expectedMessage, errormessage.text());",
          "94:     }",
          "99:     @Test",
          "100:     void testDocumentAlreadyExistsError() throws Exception",
          "101:     {",
          "103:         String urlToDocument = \"space/%3C%2Fdiv%3Epage\";",
          "104:         Object[] args = { DOCUMENT_REFERENCE };",
          "105:         XWikiException documentAlreadyExistsException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
          "106:             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NOT_EMPTY,",
          "107:             \"Cannot create document {0} because it already has content\", null, args);",
          "108:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, documentAlreadyExistsException);",
          "109:         this.velocityManager.getVelocityContext().put(\"existingDocumentReference\", DOCUMENT_REFERENCE);",
          "113:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
          "115:         String viewURL = String.format(\"/xwiki/bin/view/%s\", urlToDocument);",
          "116:         String editURL = String.format(\"/xwiki/bin/edit/%s\", urlToDocument);",
          "117:         String expectedMessage = String.format(\"core.create.page.error.docalreadyexists [%s, %s, %s]\",",
          "118:             DOCUMENT_REFERENCE, viewURL, editURL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "50ca40dde7316cc0274276b64d3c5bcb98346eeb",
      "candidate_info": {
        "commit_hash": "50ca40dde7316cc0274276b64d3c5bcb98346eeb",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/50ca40dde7316cc0274276b64d3c5bcb98346eeb",
        "files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ],
        "message": "XWIKI-20854: Improve escaping for name validation errors\n\n* Add escaping and introduce a page test for it.",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "--- Hunk 1 ---",
          "[Context before]",
          "90: #if(\"$!exception\" != '' && $exception.code == 11018)",
          "91: <div class='box errormessage'>",
          "92:   ## Use the 'invalidNameReference' context binding set by the create action for this case.",
          "94: </div>",
          "95: #end",
          "",
          "[Removed Lines]",
          "93:   $services.localization.render('entitynamevalidation.create.invalidname', [$invalidNameReference])",
          "",
          "[Added Lines]",
          "93:   $escapetool.xml($services.localization.render('entitynamevalidation.create.invalidname', [$invalidNameReference]))",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.web;",
          "22: import java.util.List;",
          "24: import javax.inject.Inject;",
          "26: import org.jsoup.Jsoup;",
          "27: import org.jsoup.nodes.Document;",
          "28: import org.jsoup.nodes.Element;",
          "29: import org.junit.jupiter.api.BeforeEach;",
          "30: import org.junit.jupiter.api.Test;",
          "31: import org.xwiki.template.TemplateManager;",
          "32: import org.xwiki.test.page.PageTest;",
          "33: import org.xwiki.velocity.VelocityManager;",
          "35: import com.xpn.xwiki.XWikiException;",
          "37: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "38: import static org.junit.jupiter.api.Assertions.assertNotNull;",
          "47: class CreateInlinePageTest extends PageTest",
          "48: {",
          "52:     private static final String CREATE_INLINE_VM = \"createinline.vm\";",
          "54:     private VelocityManager velocityManager;",
          "56:     @Inject",
          "57:     private TemplateManager templateManager;",
          "59:     @BeforeEach",
          "60:     void setup() throws Exception",
          "61:     {",
          "62:         this.velocityManager = this.oldcore.getMocker().getInstance(VelocityManager.class);",
          "64:         this.velocityManager.getVelocityContext().put(\"recommendedTemplateProviders\", List.of());",
          "65:     }",
          "70:     @Test",
          "71:     void testNameValidationError() throws Exception",
          "72:     {",
          "74:         String documentReference = \"xwiki:space.</div>page\";",
          "75:         Object[] args = { documentReference };",
          "76:         XWikiException invalidNameException = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
          "77:             XWikiException.ERROR_XWIKI_APP_DOCUMENT_NAME_INVALID,",
          "78:             \"Cannot create document {0} because its name does not respect the name strategy of the wiki.\", null,",
          "79:             args);",
          "80:         this.velocityManager.getVelocityContext().put(\"createException\", invalidNameException);",
          "81:         this.velocityManager.getVelocityContext().put(\"invalidNameReference\", documentReference);",
          "84:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
          "85:         Element errormessage = document.getElementsByClass(\"errormessage\").first();",
          "86:         assertNotNull(errormessage);",
          "87:         String expectedMessage = String.format(\"entitynamevalidation.create.invalidname [%s]\", documentReference);",
          "88:         assertEquals(expectedMessage, errormessage.text());",
          "89:     }",
          "90: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}