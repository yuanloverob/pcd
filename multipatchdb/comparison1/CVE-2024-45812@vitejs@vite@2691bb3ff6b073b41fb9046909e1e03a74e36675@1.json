{
  "cve_id": "CVE-2024-45812",
  "cve_desc": "Vite a frontend build tooling framework for javascript. Affected versions of vite were discovered to contain a DOM Clobbering vulnerability when building scripts to `cjs`/`iife`/`umd` output format. The DOM Clobbering gadget in the module can lead to cross-site scripting (XSS) in web pages where scriptless attacker-controlled HTML elements (e.g., an img tag with an unsanitized name attribute) are present. DOM Clobbering is a type of code-reuse attack where the attacker first embeds a piece of non-script, seemingly benign HTML markups in the webpage (e.g. through a post or comment) and leverages the gadgets (pieces of js code) living in the existing javascript code to transform it into executable code. We have identified a DOM Clobbering vulnerability in Vite bundled scripts, particularly when the scripts dynamically import other scripts from the assets folder and the developer sets the build output format to `cjs`, `iife`, or `umd`. In such cases, Vite replaces relative paths starting with `__VITE_ASSET__` using the URL retrieved from `document.currentScript`. However, this implementation is vulnerable to a DOM Clobbering attack. The `document.currentScript` lookup can be shadowed by an attacker via the browser's named DOM tree element access mechanism. This manipulation allows an attacker to replace the intended script element with a malicious HTML element. When this happens, the src attribute of the attacker-controlled element is used as the URL for importing scripts, potentially leading to the dynamic loading of scripts from an attacker-controlled server. This vulnerability can result in cross-site scripting (XSS) attacks on websites that include Vite-bundled files (configured with an output format of `cjs`, `iife`, or `umd`) and allow users to inject certain scriptless HTML tags without properly sanitizing the name or id attributes. This issue has been patched in versions 5.4.6, 5.3.6, 5.2.14, 4.5.5, and 3.2.11. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "vitejs/vite",
  "patch_hash": "2691bb3ff6b073b41fb9046909e1e03a74e36675",
  "patch_info": {
    "commit_hash": "2691bb3ff6b073b41fb9046909e1e03a74e36675",
    "repo": "vitejs/vite",
    "commit_url": "https://github.com/vitejs/vite/commit/2691bb3ff6b073b41fb9046909e1e03a74e36675",
    "files": [
      "packages/vite/src/node/build.ts"
    ],
    "message": "fix: avoid DOM Clobbering gadget in `getRelativeUrlFromDocument` (#18115)",
    "before_after_code_files": [
      "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
    ]
  },
  "patch_diff": {
    "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts": [
      "File: packages/vite/src/node/build.ts -> packages/vite/src/node/build.ts",
      "--- Hunk 1 ---",
      "[Context before]",
      "1133:   getResolveUrl(",
      "1134:     `'${escapeId(partialEncodeURIPath(relativePath))}', ${",
      "1135:       umd ? `typeof document === 'undefined' ? location.href : ` : ''",
      "1137:   )",
      "1139: const getFileUrlFromFullPath = (path: string) =>",
      "",
      "[Removed Lines]",
      "1136:     }document.currentScript && document.currentScript.src || document.baseURI`,",
      "",
      "[Added Lines]",
      "1136:     }document.currentScript && document.currentScript.tagName.toUpperCase() === 'SCRIPT' && document.currentScript.src || document.baseURI`,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2ddd8541ec3b2d2e5b698749e0f2362ef28056bd",
      "candidate_info": {
        "commit_hash": "2ddd8541ec3b2d2e5b698749e0f2362ef28056bd",
        "repo": "vitejs/vite",
        "commit_url": "https://github.com/vitejs/vite/commit/2ddd8541ec3b2d2e5b698749e0f2362ef28056bd",
        "files": [
          "packages/vite/src/node/build.ts"
        ],
        "message": "fix: backport #18115, DOM Clobbering in",
        "before_after_code_files": [
          "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
          ],
          "candidate": [
            "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
          ]
        }
      },
      "candidate_diff": {
        "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts": [
          "File: packages/vite/src/node/build.ts -> packages/vite/src/node/build.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "1005:   getResolveUrl(",
          "1006:     `'${relativePath}', ${",
          "1007:       umd ? `typeof document === 'undefined' ? location.href : ` : ''",
          "1009:   )",
          "1011: const relativeUrlMechanisms: Record<",
          "",
          "[Removed Lines]",
          "1008:     }document.currentScript && document.currentScript.src || document.baseURI`",
          "",
          "[Added Lines]",
          "1008:     }document.currentScript && document.currentScript.tagName.toUpperCase() === 'SCRIPT' && document.currentScript.src || document.baseURI`",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ade1d89660e17eedfd35652165b0c26905259fad",
      "candidate_info": {
        "commit_hash": "ade1d89660e17eedfd35652165b0c26905259fad",
        "repo": "vitejs/vite",
        "commit_url": "https://github.com/vitejs/vite/commit/ade1d89660e17eedfd35652165b0c26905259fad",
        "files": [
          "packages/vite/src/node/build.ts"
        ],
        "message": "fix: avoid DOM Clobbering gadget in `getRelativeUrlFromDocument` (#18115)",
        "before_after_code_files": [
          "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
          ],
          "candidate": [
            "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts"
          ]
        }
      },
      "candidate_diff": {
        "packages/vite/src/node/build.ts||packages/vite/src/node/build.ts": [
          "File: packages/vite/src/node/build.ts -> packages/vite/src/node/build.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "1297:   getResolveUrl(",
          "1298:     `'${escapeId(partialEncodeURIPath(relativePath))}', ${",
          "1299:       umd ? `typeof document === 'undefined' ? location.href : ` : ''",
          "1301:   )",
          "1303: const getFileUrlFromFullPath = (path: string) =>",
          "",
          "[Removed Lines]",
          "1300:     }document.currentScript && document.currentScript.src || document.baseURI`,",
          "",
          "[Added Lines]",
          "1300:     }document.currentScript && document.currentScript.tagName.toUpperCase() === 'SCRIPT' && document.currentScript.src || document.baseURI`,",
          "",
          "---------------"
        ]
      }
    }
  ]
}