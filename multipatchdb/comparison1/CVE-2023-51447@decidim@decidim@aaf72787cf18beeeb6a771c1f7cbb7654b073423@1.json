{
  "cve_id": "CVE-2023-51447",
  "cve_desc": "Decidim is a participatory democracy framework. Starting in version 0.27.0 and prior to versions 0.27.5 and 0.28.0, the dynamic file upload feature is subject to potential cross-site scripting attacks in case the attacker manages to modify the file names of the records being uploaded to the server. This appears in sections where the user controls the file upload dialogs themselves and has the technical knowledge to change the file names through the dynamic upload endpoint. Therefore I believe it would require the attacker to control the whole session of the particular user but in any case, this needs to be fixed. Successful exploit of this vulnerability would require the user to have successfully uploaded a file blob to the server with a malicious file name and then have the possibility to direct the other user to the edit page of the record where the attachment is attached. The users are able to craft the direct upload requests themselves controlling the file name that gets stored to the database. The attacker is able to change the filename e.g. to `<svg onload=alert('XSS')>` if they know how to craft these requests themselves. And then enter the returned blob ID to the form inputs manually by modifying the edit page source. Versions 0.27.5 and 0.28.0 contain a patch for this issue. As a workaround, disable dynamic uploads for the instance, e.g. from proposals.",
  "repo": "decidim/decidim",
  "patch_hash": "aaf72787cf18beeeb6a771c1f7cbb7654b073423",
  "patch_info": {
    "commit_hash": "aaf72787cf18beeeb6a771c1f7cbb7654b073423",
    "repo": "decidim/decidim",
    "commit_url": "https://github.com/decidim/decidim/commit/aaf72787cf18beeeb6a771c1f7cbb7654b073423",
    "files": [
      "decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "decidim-core/app/packs/src/decidim/utilities/text.js",
      "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "decidim-proposals/spec/system/edit_proposal_spec.rb"
    ],
    "message": "Fix issues with the file uploader input display (#11612)",
    "before_after_code_files": [
      "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js",
      "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
    ]
  },
  "patch_diff": {
    "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb": [
      "File: decidim-core/app/cells/decidim/upload_modal_cell.rb -> decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "159:     end",
      "161:     def truncated_file_name_for(attachment, max_length = 31)",
      "165:       name = File.basename(filename, File.extname(filename))",
      "167:     end",
      "169:     def file_name_for(attachment)",
      "171:     end",
      "173:     def determine_filename(attachment)",
      "",
      "[Removed Lines]",
      "162:       filename = file_name_for(attachment)",
      "163:       return filename if filename.length <= max_length",
      "166:       name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")",
      "170:       determine_filename(attachment)",
      "",
      "[Added Lines]",
      "162:       filename = determine_filename(attachment)",
      "163:       return decidim_html_escape(filename).html_safe if filename.length <= max_length",
      "166:       decidim_html_escape(name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")).html_safe",
      "170:       decidim_html_escape(determine_filename(attachment)).html_safe",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js": [
      "File: decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: import { Uploader } from \"src/decidim/direct_uploads/redesigned_uploader\";",
      "2: import icon from \"src/decidim/redesigned_icon\";",
      "3: import { truncateFilename } from \"src/decidim/direct_uploads/upload_utility\";",
      "5: const STATUS = {",
      "6:   VALIDATED: \"validated\",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: import { escapeHtml, escapeQuotes } from \"src/decidim/utilities/text\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "166:   createUploadItem(file, errors, opts = {}) {",
      "167:     const okTemplate = `",
      "168:       <img src=\"\" alt=\"${file.name}\" />",
      "170:     `",
      "172:     const errorTemplate = `",
      "173:       <div>${icon(\"error-warning-line\")}</div>",
      "174:       <div>",
      "176:         <span>${this.locales.validation_error}</span>",
      "177:         <ul>${errors.map((error) => `<li>${error}</li>`).join(\"\\n\")}</ul>",
      "178:       </div>",
      "",
      "[Removed Lines]",
      "169:       <span>${truncateFilename(file.name)}</span>",
      "175:         <span>${truncateFilename(file.name)}</span>",
      "",
      "[Added Lines]",
      "170:       <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "176:         <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "183:       <div>",
      "184:         <div>",
      "185:           <label>${this.locales.filename}</label>",
      "187:         </div>",
      "188:         <div>",
      "189:           <label>${this.locales.title}</label>",
      "191:         </div>",
      "192:       </div>",
      "193:     `",
      "",
      "[Removed Lines]",
      "186:           <span>${truncateFilename(file.name)}</span>",
      "190:           <input class=\"sm\" type=\"text\" value=\"${opts.title || truncateFilename(file.name)}\" />",
      "",
      "[Added Lines]",
      "187:           <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "191:           <input class=\"sm\" type=\"text\" value=\"${escapeQuotes(opts.title || truncateFilename(file.name))}\" />",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "212:       ? `data-attachment-id=\"${opts.attachmentId}\"`",
      "213:       : \"\"",
      "214:     const fullTemplate = `",
      "216:         <div data-template=\"${template}\">",
      "217:           ${content.trim()}",
      "218:           <button>${this.locales.remove}</button>",
      "",
      "[Removed Lines]",
      "215:       <li ${attachmentId} data-filename=\"${file.name}\" data-state=\"${state}\">",
      "",
      "[Added Lines]",
      "216:       <li ${attachmentId} data-filename=\"${escapeQuotes(file.name)}\" data-state=\"${state}\">",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "248:   }",
      "250:   setProgressBar(name, value) {",
      "252:   }",
      "254:   updateAddAttachmentsButton() {",
      "",
      "[Removed Lines]",
      "251:     this.uploadItems.querySelector(`[data-filename=\"${name}\"] progress`).value = value",
      "",
      "[Added Lines]",
      "252:     this.uploadItems.querySelector(`[data-filename=\"${escapeQuotes(name)}\"] progress`).value = value",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
      "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: import { Uploader } from \"src/decidim/direct_uploads/uploader\";",
      "2: import { truncateFilename, checkTitles, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3: import { escapeHtml } from \"src/decidim/utilities/text\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71:         const attachmentDetails = document.createElement(\"div\");",
      "72:         attachmentDetails.classList.add(\"attachment-details\");",
      "74:         const titleAndFileNameSpan = document.createElement(\"span\");",
      "75:         titleAndFileNameSpan.style.display = \"none\";",
      "76:         attachmentDetails.appendChild(titleAndFileNameSpan);",
      "",
      "[Removed Lines]",
      "73:         attachmentDetails.dataset.filename = file.name;",
      "",
      "[Added Lines]",
      "74:         attachmentDetails.dataset.filename = escapeHtml(file.name);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "85:         if (this.options.titled) {",
      "86:           const hiddenTitleField = createHiddenInput(\"hidden-title\", `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]`, title);",
      "88:           attachmentDetails.appendChild(hiddenTitleField);",
      "89:         } else {",
      "91:         }",
      "93:         if (!this.options.multiple) {",
      "",
      "[Removed Lines]",
      "87:           titleAndFileNameSpan.innerHTML = `${title} (${file.name})`;",
      "90:           titleAndFileNameSpan.innerHTML = file.name;",
      "",
      "[Added Lines]",
      "88:           titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${file.name})`);",
      "91:           titleAndFileNameSpan.innerHTML = escapeHtml(file.name);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "127:   createUploadItem(fileName, title, state) {",
      "128:     const wrapper = document.createElement(\"div\");",
      "129:     wrapper.classList.add(\"upload-item\");",
      "132:     const firstRow = document.createElement(\"div\");",
      "133:     const secondRow = document.createElement(\"div\");",
      "",
      "[Removed Lines]",
      "130:     wrapper.setAttribute(\"data-filename\", fileName);",
      "",
      "[Added Lines]",
      "131:     wrapper.setAttribute(\"data-filename\", escapeHtml(fileName));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "144:       fileNameSpanClasses.push(\"small-12\");",
      "145:     }",
      "146:     fileNameSpan.classList.add(...fileNameSpanClasses);",
      "149:     const progressBar = document.createElement(\"div\");",
      "150:     progressBar.classList.add(\"progress-bar\");",
      "",
      "[Removed Lines]",
      "147:     fileNameSpan.innerHTML = truncateFilename(fileName);",
      "",
      "[Added Lines]",
      "148:     fileNameSpan.innerHTML = escapeHtml(truncateFilename(fileName));",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "179:     removeButton.innerHTML = `&times; ${this.locales.remove}`;",
      "180:     removeButton.addEventListener((\"click\"), (event) => {",
      "181:       event.preventDefault();",
      "184:       this.updateDropZone();",
      "185:     })",
      "187:     const titleAndFileNameSpan = document.createElement(\"span\");",
      "188:     titleAndFileNameSpan.classList.add(\"columns\", \"small-5\", \"title-and-filename-span\");",
      "191:     firstRow.appendChild(fileNameSpan);",
      "192:     secondRow.appendChild(progressBarWrapper);",
      "",
      "[Removed Lines]",
      "182:       const item = this.uploadItems.querySelector(`[data-filename='${fileName}']`);",
      "183:       this.trashCan.append(item);",
      "189:     titleAndFileNameSpan.innerHTML = `${title} (${truncateFilename(fileName)})`;",
      "",
      "[Added Lines]",
      "183:       this.trashCan.append(wrapper);",
      "189:     titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${truncateFilename(fileName)})`);",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js": [
      "File: decidim-core/app/packs/src/decidim/utilities/text.js -> decidim-core/app/packs/src/decidim/utilities/text.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: export const escapeHtml = (text) => {",
      "2:   if (!text) {",
      "3:     return \"\";",
      "4:   }",
      "6:   const el = document.createElement(\"div\");",
      "7:   el.appendChild(document.createTextNode(text));",
      "8:   return el.innerHTML;",
      "9: }",
      "11: export const escapeQuotes = (text) => {",
      "12:   if (!text) {",
      "13:     return \"\";",
      "14:   }",
      "16:   return text.replace(/\"/g, \"&quot;\");",
      "17: }",
      "",
      "---------------"
    ],
    "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb": [
      "File: decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb -> decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "147:         expect(details).to have_content(\"#{attachments[0].title[\"en\"]} (#{filename})\")",
      "148:       end",
      "149:     end",
      "150:   end",
      "152:   context \"when multiple attachments are present\" do",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "151:     context \"when there is rich content in the filename\" do",
      "152:       let(:blob) { ActiveStorage::Blob.find_signed(attachments.first) }",
      "154:       before do",
      "155:         blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
      "156:       end",
      "158:       it \"escapes the truncated filename\" do",
      "159:         expect(my_cell.send(:truncated_file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
      "160:       end",
      "162:       it \"escapes the filename\" do",
      "163:         expect(my_cell.send(:file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
      "164:       end",
      "165:     end",
      "",
      "---------------"
    ],
    "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb": [
      "File: decidim-proposals/spec/system/edit_proposal_spec.rb -> decidim-proposals/spec/system/edit_proposal_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "110:             expect(translated(Decidim::Attachment.find_by(attached_to_id: proposal.id, content_type: \"application/pdf\").title)).to eq(attachment_file_title)",
      "111:           end",
      "112:         end",
      "113:       end",
      "115:       context \"with multiple images\", :slow do",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "114:         context \"with problematic file titles\" do",
      "115:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
      "116:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
      "118:           before do",
      "119:             document.update!(title: { en: \"<svg onload=alert('ALERT')>.pdf\" })",
      "120:             photo.update!(title: { en: \"<svg onload=alert('ALERT')>.jpg\" })",
      "121:           end",
      "123:           it \"displays them correctly on the edit form\" do",
      "124:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
      "125:             click_link \"Edit proposal\"",
      "126:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
      "127:             click_button(\"Edit documents\")",
      "128:             within \"[data-dialog]\" do",
      "129:               click_button(\"Next\")",
      "130:             end",
      "131:             click_button(\"Send\")",
      "132:             expect(page).to have_content(\"Proposal successfully updated.\")",
      "133:           end",
      "134:         end",
      "136:         context \"with problematic file names\" do",
      "137:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
      "138:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
      "140:           before do",
      "141:             document.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
      "142:             photo.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.jpg\")",
      "143:           end",
      "145:           it \"displays them correctly on the edit form\" do",
      "146:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
      "147:             click_link \"Edit proposal\"",
      "148:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
      "149:             click_button(\"Edit documents\")",
      "150:             within \"[data-dialog]\" do",
      "151:               click_button(\"Next\")",
      "152:             end",
      "153:             click_button(\"Send\")",
      "154:             expect(page).to have_content(\"Proposal successfully updated.\")",
      "155:           end",
      "156:         end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7d6340c6822f158233770a6cc5af7d1e0d3c6cc3",
      "candidate_info": {
        "commit_hash": "7d6340c6822f158233770a6cc5af7d1e0d3c6cc3",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/7d6340c6822f158233770a6cc5af7d1e0d3c6cc3",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ],
        "message": "Fix flaky with accessibility errors in Direct Uploads (#12636)\n\n* Fix a11y error in 'Select file' button\n\nError fixed\n\n>  Attribute \u201cdisabled\u201d not allowed on element \u201clabel\u201d at this point.\n\nThis also fixes a focus problem: you can't focus a label by default in\nHTML.\n\n* Fix a11y error in img\n\nError fixed\n\n> Bad value \u201c\u201d for attribute \u201csrc\u201d on element \u201cimg\u201d: Must be non-empty.\n\n* Fix a11y error in src img with base64 value\n\nError fixed\n\n> Bad value  for attribute \u201csrc\u201d on element \u201cimg\u201d: Expected a token\ncharacter or \u201c/\u201d but saw \u201c;\u201d instead.\n\nThe problem is that we're generating this src:\n\n```\n<img src=\"data:image;base64,/9j/4QAYRXhpZ...\">\n```\n\nMind that the MIME type is invalid.",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ],
          "candidate": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/modal.erb -> decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:             <%= icon \"upload-cloud-2-line\", class: \"w-8 h-8 text-gray fill-current\" %>",
          "38:             <%= t(\"decidim.forms.upload_help.dropzone\") %>",
          "39:           </span>",
          "41:             <span><%= t(\"decidim.forms.upload.select_file\") %></span>",
          "42:             <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "44:         </div>",
          "45:       </div>",
          "46:     </div>",
          "",
          "[Removed Lines]",
          "40:           <label class=\"button button__sm button__secondary\" for=\"files-<%= modal_id %>\">",
          "43:           </label>",
          "",
          "[Added Lines]",
          "40:           <button class=\"button button__sm button__secondary\" data-select-file-button>",
          "43:           </button>",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "67:     const template = `",
          "68:       <div ${attachmentIdOrHiddenField} data-filename=\"${escapeQuotes(file.name)}\" data-title=\"${escapeQuotes(title)}\">",
          "70:         <span>${escapeHtml(title)} (${escapeHtml(truncateFilename(file.name))})</span>",
          "71:         ${hidden}",
          "72:       </div>",
          "",
          "[Removed Lines]",
          "69:         ${(/image/).test(file.type) && `<div><img src=\"\" alt=\"${escapeQuotes(file.name)}\" /></div>` || \"\"}",
          "",
          "[Added Lines]",
          "69:         ${(/image/).test(file.type) && `<div><img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" /></div>` || \"\"}",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "122:     if (src) {",
          "123:       buffer = await fetch(src).then((res) => res.arrayBuffer())",
          "127:     }",
          "129:     const file = new File([buffer], element.dataset.filename, { type })",
          "",
          "[Removed Lines]",
          "126:       type = \"image\"",
          "",
          "[Added Lines]",
          "126:       type = \"image/*\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "155:     this.saveButton.disabled = Array.from(files).filter(({ dataset: { state } }) => state === STATUS.ERROR).length > 0;",
          "158:     const continueUpload = !files.length || this.options.multiple",
          "159:     this.input.disabled = !continueUpload",
          "160:     if (continueUpload) {",
          "161:       this.emptyItems.classList.remove(\"is-disabled\");",
          "163:     } else {",
          "164:       this.emptyItems.classList.add(\"is-disabled\");",
          "166:     }",
          "167:   }",
          "169:   createUploadItem(file, errors, opts = {}) {",
          "170:     const okTemplate = `",
          "172:       <span>${escapeHtml(truncateFilename(file.name))}</span>",
          "173:     `",
          "",
          "[Removed Lines]",
          "162:       this.emptyItems.querySelector(\"label\").removeAttribute(\"disabled\");",
          "165:       this.emptyItems.querySelector(\"label\").setAttribute(\"disabled\", true);",
          "171:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "[Added Lines]",
          "157:     const dataSelectFileButton = this.emptyItems.querySelector(\"[data-select-file-button]\");",
          "164:       dataSelectFileButton.removeAttribute(\"disabled\");",
          "167:       dataSelectFileButton.disabled = true;",
          "170:     dataSelectFileButton.addEventListener(\"click\", () => this.input.click());",
          "175:       <img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "182:     `",
          "184:     const titleTemplate = `",
          "186:       <div>",
          "187:         <div>",
          "188:           <label>${this.locales.filename}</label>",
          "",
          "[Removed Lines]",
          "185:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "[Added Lines]",
          "189:       <img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e135006374c0e2d2c9a57e2ba0bb91241c326a56",
      "candidate_info": {
        "commit_hash": "e135006374c0e2d2c9a57e2ba0bb91241c326a56",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/e135006374c0e2d2c9a57e2ba0bb91241c326a56",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/config/locales/en.yml",
          "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb",
          "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb"
        ],
        "message": "Backport 'Label changes on Save button in Modals' to v0.28 (#13094)\n\n* updates to styling and i18n changes made on accountaility\n\n* missing translations\n\n* updated the dynamic attach condition for save value\n\n* updated specs to include string change from Next to Save\n\n* rspec updated in participatory processes\n\n* Update decidim-core/app/cells/decidim/upload_modal/modal.erb\n\n\n\n* Update decidim-core/app/cells/decidim/user_conversations/new_conversation_button.erb\n\n\n\n* Update decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb\n\n\n\n* updated yml file\n\n* updated yml file\n\n* push updates to test\n\n* Update decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb\n\n\n\n---------\n\nCo-authored-by: Tom <101816158+greenwoodt@users.noreply.github.com>\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb||decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb||decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb||decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb",
          "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb||decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ],
          "candidate": [
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/modal.erb -> decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     <%= t(\"decidim.shared.confirm_modal.cancel\") %>",
          "61:   </button>",
          "62:   <button type=\"button\" class=\"button button__sm md:button__lg button__secondary\" data-dropzone-save data-dialog-close=\"<%= modal_id %>\" disabled>",
          "65:   </button>",
          "66: </div>",
          "67: <% end %>",
          "",
          "[Removed Lines]",
          "63:     <%= t(\"next\", scope: \"decidim.messaging.conversations.index\") %>",
          "64:     <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "",
          "[Added Lines]",
          "63:     <%= t(\"save\", scope: \"decidim.forms.upload.labels\") %>",
          "",
          "---------------"
        ],
        "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb||decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb": [
          "File: decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb -> decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "23:           expect(page).to have_content(filename.first(12)) if front_interface",
          "24:         end",
          "25:         all(title_input(front_interface)).last.set(options[:title]) if options.has_key?(:title)",
          "27:       end",
          "28:     end",
          "",
          "[Removed Lines]",
          "26:         click_button(front_interface ? \"Next\" : \"Save\") unless options[:keep_modal_open]",
          "",
          "[Added Lines]",
          "26:         click_button(\"Save\") unless options[:keep_modal_open]",
          "",
          "---------------"
        ],
        "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb||decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb": [
          "File: decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb -> decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "137:       end",
          "139:       click_button \"Remove\"",
          "142:       click_button \"Update\"",
          "",
          "[Removed Lines]",
          "140:       click_button \"Next\"",
          "",
          "[Added Lines]",
          "140:       click_button \"Save\"",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb||decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb": [
          "File: decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb -> decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "105:         find(\"input#proposal_attachment_delete_file\").set(true)",
          "106:         click_button(\"Replace\")",
          "107:         click_button(\"Remove\")",
          "109:         dynamically_attach_file(:proposal_attachment_file, Decidim::Dev.asset(\"city.jpeg\"))",
          "111:         click_button(\"Update\")",
          "",
          "[Removed Lines]",
          "108:         click_button(\"Next\")",
          "",
          "[Added Lines]",
          "108:         click_button(\"Save\")",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb": [
          "File: decidim-proposals/spec/system/edit_proposal_spec.rb -> decidim-proposals/spec/system/edit_proposal_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:             within \"[data-filename='Exampledocument.pdf']\" do",
          "77:               click_button(\"Remove\")",
          "78:             end",
          "80:           end",
          "82:           click_button \"Send\"",
          "",
          "[Removed Lines]",
          "79:             click_button \"Next\"",
          "",
          "[Added Lines]",
          "79:             click_button \"Save\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "101:               within \"[data-filename='Exampledocument.pdf']\" do",
          "102:                 find(\"input[type='text']\").set(attachment_file_title)",
          "103:               end",
          "105:             end",
          "106:             click_button \"Send\"",
          "107:             expect(page).to have_selector(\"[data-alert-box].success\")",
          "",
          "[Removed Lines]",
          "104:               click_button \"Next\"",
          "",
          "[Added Lines]",
          "104:               click_button \"Save\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "126:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "127:             click_button(\"Edit documents\")",
          "128:             within \"[data-dialog]\" do",
          "130:             end",
          "131:             click_button(\"Send\")",
          "132:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "",
          "[Removed Lines]",
          "129:               click_button(\"Next\")",
          "",
          "[Added Lines]",
          "129:               click_button(\"Save\")",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "148:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "149:             click_button(\"Edit documents\")",
          "150:             within \"[data-dialog]\" do",
          "152:             end",
          "153:             click_button(\"Send\")",
          "154:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "",
          "[Removed Lines]",
          "151:               click_button(\"Next\")",
          "",
          "[Added Lines]",
          "151:               click_button(\"Save\")",
          "",
          "---------------"
        ],
        "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb||decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb": [
          "File: decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb -> decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     )",
          "40:     expect(page).to have_content(\"Validation error!\")",
          "42:   end",
          "44:   private",
          "",
          "[Removed Lines]",
          "41:     expect(page).to have_css(\"button[disabled]\", text: \"Next\")",
          "",
          "[Added Lines]",
          "41:     expect(page).to have_css(\"button[disabled]\", text: \"Save\")",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "17300e07674f3b940127dbab1b29532e807fd089",
      "candidate_info": {
        "commit_hash": "17300e07674f3b940127dbab1b29532e807fd089",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/17300e07674f3b940127dbab1b29532e807fd089",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "decidim-core/app/packs/src/decidim/utilities/text.js",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb"
        ],
        "message": "Backport 'Fix issues with the file uploader input display' to v0.27 (#11731)\n\n* Fix issues with the file uploader input display\n\n* Map the files with an arbitrary ID instead of the title\n\nBecause using the title can cause other issues and is not always\nunique.\n\n* Fix the edit proposal spec with the legacy design\n\n* Fix further issues with the dynamic title display",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
            "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ],
          "candidate": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
            "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb": [
          "File: decidim-core/app/cells/decidim/upload_modal_cell.rb -> decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:     end",
          "158:     def truncated_file_name_for(attachment, max_length = 31)",
          "162:       name = File.basename(filename, File.extname(filename))",
          "164:     end",
          "166:     def file_name_for(attachment)",
          "168:     end",
          "170:     def determine_filename(attachment)",
          "",
          "[Removed Lines]",
          "159:       filename = file_name_for(attachment)",
          "160:       return filename if filename.length <= max_length",
          "163:       name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")",
          "167:       determine_filename(attachment)",
          "",
          "[Added Lines]",
          "159:       filename = determine_filename(attachment)",
          "160:       return decidim_html_escape(filename).html_safe if filename.length <= max_length",
          "163:       decidim_html_escape(name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")).html_safe",
          "167:       decidim_html_escape(determine_filename(attachment)).html_safe",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import UploadModal from \"src/decidim/direct_uploads/upload_modal\";",
          "2: import { truncateFilename, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";",
          "4: const loadAttachments = (modal) => {",
          "5:   Array.from(modal.activeAttachments.children).forEach((child) => {",
          "7:   })",
          "8: }",
          "",
          "[Removed Lines]",
          "6:     modal.createUploadItem(child.dataset.filename, child.dataset.title, \"validated\");",
          "",
          "[Added Lines]",
          "3: import { escapeHtml } from \"src/decidim/utilities/text\";",
          "7:     const uploadItem = modal.createUploadItem(child.dataset.filename, child.dataset.title, \"validated\");",
          "8:     child.dataset.fileid = uploadItem.dataset.fileid;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:       if (details) {",
          "62:         modal.activeAttachments.appendChild(details);",
          "63:       } else {",
          "65:       }",
          "66:       const span = details.querySelector(\"span\");",
          "67:       span.classList.add(\"filename\");",
          "",
          "[Removed Lines]",
          "64:         details = modal.activeAttachments.querySelector(`.attachment-details[data-filename='${item.dataset.filename}'`);",
          "",
          "[Added Lines]",
          "66:         details = modal.activeAttachments.querySelector(`.attachment-details[data-fileid='${item.dataset.fileid}'`);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "79:           details.appendChild(hiddenTitleField);",
          "80:           details.appendChild(hiddenIdField);",
          "81:         }",
          "83:       } else {",
          "85:       }",
          "86:       span.style.display = \"block\";",
          "87:     });",
          "",
          "[Removed Lines]",
          "82:         span.innerHTML = `${title} (${truncateFilename(item.dataset.filename)})`;",
          "84:         span.innerHTML = truncateFilename(item.dataset.filename, 19);",
          "",
          "[Added Lines]",
          "84:         span.innerHTML = `${escapeHtml(title)} (${escapeHtml(truncateFilename(item.dataset.filename))})`;",
          "86:         span.innerHTML = escapeHtml(truncateFilename(item.dataset.filename, 19));",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import { Uploader } from \"src/decidim/direct_uploads/uploader\";",
          "2: import { truncateFilename, checkTitles, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: import { escapeHtml } from \"src/decidim/utilities/text\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:         const attachmentDetails = document.createElement(\"div\");",
          "72:         attachmentDetails.classList.add(\"attachment-details\");",
          "73:         attachmentDetails.dataset.filename = file.name;",
          "74:         const titleAndFileNameSpan = document.createElement(\"span\");",
          "75:         titleAndFileNameSpan.style.display = \"none\";",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:         attachmentDetails.dataset.fileid = uploadItem.dataset.fileid;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "85:         if (this.options.titled) {",
          "86:           const hiddenTitleField = createHiddenInput(\"hidden-title\", `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]`, title);",
          "88:           attachmentDetails.appendChild(hiddenTitleField);",
          "89:         } else {",
          "91:         }",
          "93:         if (!this.options.multiple) {",
          "",
          "[Removed Lines]",
          "87:           titleAndFileNameSpan.innerHTML = `${title} (${file.name})`;",
          "90:           titleAndFileNameSpan.innerHTML = file.name;",
          "",
          "[Added Lines]",
          "89:           titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${file.name})`);",
          "92:           titleAndFileNameSpan.innerHTML = escapeHtml(file.name);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "127:   createUploadItem(fileName, title, state) {",
          "128:     const wrapper = document.createElement(\"div\");",
          "129:     wrapper.classList.add(\"upload-item\");",
          "130:     wrapper.setAttribute(\"data-filename\", fileName);",
          "132:     const firstRow = document.createElement(\"div\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "132:     wrapper.setAttribute(\"data-fileid\", Math.random().toString(36).substring(7));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "144:       fileNameSpanClasses.push(\"small-12\");",
          "145:     }",
          "146:     fileNameSpan.classList.add(...fileNameSpanClasses);",
          "149:     const progressBar = document.createElement(\"div\");",
          "150:     progressBar.classList.add(\"progress-bar\");",
          "",
          "[Removed Lines]",
          "147:     fileNameSpan.innerHTML = truncateFilename(fileName);",
          "",
          "[Added Lines]",
          "150:     fileNameSpan.innerHTML = escapeHtml(truncateFilename(fileName));",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "179:     removeButton.innerHTML = `&times; ${this.locales.remove}`;",
          "180:     removeButton.addEventListener((\"click\"), (event) => {",
          "181:       event.preventDefault();",
          "184:       this.updateDropZone();",
          "185:     })",
          "187:     const titleAndFileNameSpan = document.createElement(\"span\");",
          "188:     titleAndFileNameSpan.classList.add(\"columns\", \"small-5\", \"title-and-filename-span\");",
          "191:     firstRow.appendChild(fileNameSpan);",
          "192:     secondRow.appendChild(progressBarWrapper);",
          "",
          "[Removed Lines]",
          "182:       const item = this.uploadItems.querySelector(`[data-filename='${fileName}']`);",
          "183:       this.trashCan.append(item);",
          "189:     titleAndFileNameSpan.innerHTML = `${title} (${truncateFilename(fileName)})`;",
          "",
          "[Added Lines]",
          "185:       this.trashCan.append(wrapper);",
          "191:     titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${truncateFilename(fileName)})`);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "253:   cleanTrashCan() {",
          "254:     Array.from(this.trashCan.children).forEach((item) => {",
          "257:       if (activeAttachment) {",
          "258:         activeAttachment.remove();",
          "259:       }",
          "",
          "[Removed Lines]",
          "255:       const fileName = item.dataset.filename;",
          "256:       const activeAttachment = this.activeAttachments.querySelector(`div[data-filename='${fileName}']`);",
          "",
          "[Added Lines]",
          "257:       const fileId = item.dataset.fileid;",
          "258:       const activeAttachment = this.activeAttachments.querySelector(`div[data-fileid='${fileId}']`);",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js": [
          "File: decidim-core/app/packs/src/decidim/utilities/text.js -> decidim-core/app/packs/src/decidim/utilities/text.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: export const escapeHtml = (text) => {",
          "2:   if (!text) {",
          "3:     return \"\";",
          "4:   }",
          "6:   const el = document.createElement(\"div\");",
          "7:   el.appendChild(document.createTextNode(text));",
          "8:   return el.innerHTML;",
          "9: }",
          "11: export const escapeQuotes = (text) => {",
          "12:   if (!text) {",
          "13:     return \"\";",
          "14:   }",
          "16:   return text.replace(/\"/g, \"&quot;\");",
          "17: }",
          "",
          "---------------"
        ],
        "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb": [
          "File: decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb -> decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "125:         expect(details).to have_content(\"#{attachments[0].title[\"en\"]} (#{filename})\")",
          "126:       end",
          "127:     end",
          "128:   end",
          "130:   context \"when there is a title\" do",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "129:     context \"when there is rich content in the filename\" do",
          "130:       let(:blob) { ActiveStorage::Blob.find_signed(attachments.first) }",
          "132:       before do",
          "133:         blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
          "134:       end",
          "136:       it \"escapes the truncated filename\" do",
          "137:         expect(my_cell.send(:truncated_file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
          "138:       end",
          "140:       it \"escapes the filename\" do",
          "141:         expect(my_cell.send(:file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
          "142:       end",
          "143:     end",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb": [
          "File: decidim-proposals/spec/system/edit_proposal_spec.rb -> decidim-proposals/spec/system/edit_proposal_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "110:             expect(translated(Decidim::Attachment.find_by(attached_to_id: proposal.id, content_type: \"application/pdf\").title)).to eq(attachment_file_title)",
          "111:           end",
          "112:         end",
          "113:       end",
          "115:       context \"with multiple images\" do",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "114:         context \"with problematic file titles\" do",
          "115:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
          "116:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
          "118:           before do",
          "119:             document.update!(title: { en: \"<svg onload=alert('ALERT')>.pdf\" })",
          "120:             photo.update!(title: { en: \"<svg onload=alert('ALERT')>.jpg\" })",
          "121:           end",
          "123:           it \"displays them correctly on the edit form\" do",
          "124:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
          "125:             click_link \"Edit proposal\"",
          "126:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "127:             click_button(\"Edit documents\")",
          "128:             within \"[data-reveal]\" do",
          "129:               click_button(\"Save\")",
          "130:             end",
          "131:             click_button(\"Send\")",
          "132:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "133:           end",
          "134:         end",
          "136:         context \"with problematic file names\" do",
          "137:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
          "138:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
          "140:           before do",
          "141:             document.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
          "142:             photo.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.jpg\")",
          "143:           end",
          "145:           it \"displays them correctly on the edit form\" do",
          "146:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
          "147:             click_link \"Edit proposal\"",
          "148:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "149:             click_button(\"Edit documents\")",
          "150:             within \"[data-reveal]\" do",
          "151:               click_button(\"Save\")",
          "152:             end",
          "153:             click_button(\"Send\")",
          "154:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "155:           end",
          "156:         end",
          "",
          "---------------"
        ]
      }
    }
  ]
}