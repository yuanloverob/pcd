{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "02c7769422633f9b30ece28777e5b6f5a596eb49",
      "candidate_info": {
        "commit_hash": "02c7769422633f9b30ece28777e5b6f5a596eb49",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/02c7769422633f9b30ece28777e5b6f5a596eb49",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.5beta+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_BETA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018050800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5beta+ (Build: 20180502)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018050800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5beta+ (Build: 20180508)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "39ef515a6464603e11e77827c48becdfd6797481",
      "candidate_info": {
        "commit_hash": "39ef515a6464603e11e77827c48becdfd6797481",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/39ef515a6464603e11e77827c48becdfd6797481",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.7.1+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052001.00;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7.1 (Build: 20190708)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019052001.01;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7.1+ (Build: 20190712)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "16cb4f32a0a7531e91ed43bbe2fd62c39f37b7bc",
      "candidate_info": {
        "commit_hash": "16cb4f32a0a7531e91ed43bbe2fd62c39f37b7bc",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/16cb4f32a0a7531e91ed43bbe2fd62c39f37b7bc",
        "files": [
          "analytics/classes/analysis.php",
          "analytics/classes/calculable.php",
          "analytics/classes/calculation_info.php",
          "analytics/classes/insights_generator.php",
          "analytics/classes/local/target/base.php",
          "analytics/classes/model.php",
          "analytics/classes/prediction_action.php",
          "analytics/templates/insight_info_message.mustache",
          "analytics/templates/insight_info_message_prediction.mustache",
          "analytics/templates/notification_styles.mustache",
          "analytics/tests/calculation_info_test.php",
          "analytics/upgrade.txt",
          "course/classes/analytics/indicator/activities_due.php",
          "lang/en/analytics.php",
          "lang/en/cache.php",
          "lang/en/calendar.php",
          "lang/en/moodle.php",
          "lib/db/caches.php",
          "user/classes/analytics/target/upcoming_activities_due.php",
          "user/templates/upcoming_activities_due_insight_body.mustache",
          "version.php"
        ],
        "message": "MDL-66536 analytics: Indicators can add extra data for targets",
        "before_after_code_files": [
          "analytics/classes/analysis.php||analytics/classes/analysis.php",
          "analytics/classes/calculable.php||analytics/classes/calculable.php",
          "analytics/classes/calculation_info.php||analytics/classes/calculation_info.php",
          "analytics/classes/insights_generator.php||analytics/classes/insights_generator.php",
          "analytics/classes/local/target/base.php||analytics/classes/local/target/base.php",
          "analytics/classes/model.php||analytics/classes/model.php",
          "analytics/classes/prediction_action.php||analytics/classes/prediction_action.php",
          "analytics/templates/insight_info_message.mustache||analytics/templates/insight_info_message.mustache",
          "analytics/templates/insight_info_message_prediction.mustache||analytics/templates/insight_info_message_prediction.mustache",
          "analytics/templates/notification_styles.mustache||analytics/templates/notification_styles.mustache",
          "analytics/tests/calculation_info_test.php||analytics/tests/calculation_info_test.php",
          "course/classes/analytics/indicator/activities_due.php||course/classes/analytics/indicator/activities_due.php",
          "lang/en/analytics.php||lang/en/analytics.php",
          "lang/en/cache.php||lang/en/cache.php",
          "lang/en/calendar.php||lang/en/calendar.php",
          "lang/en/moodle.php||lang/en/moodle.php",
          "lib/db/caches.php||lib/db/caches.php",
          "user/classes/analytics/target/upcoming_activities_due.php||user/classes/analytics/target/upcoming_activities_due.php",
          "user/templates/upcoming_activities_due_insight_body.mustache||user/templates/upcoming_activities_due_insight_body.mustache",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "analytics/classes/analysis.php||analytics/classes/analysis.php": [
          "File: analytics/classes/analysis.php -> analytics/classes/analysis.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "477:                 list($samplesfeatures, $newindicatorcalculations, $indicatornotnulls) = $rangeindicator->calculate($sampleids,",
          "478:                     $this->analyser->get_samples_origin(), $range['start'], $range['end'], $prevcalculations);",
          "481:                 unset($rangeindicator);",
          "482:                 gc_collect_cycles();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "481:                 $rangeindicator->save_calculation_info($timesplitting, $rangeindex);",
          "",
          "---------------"
        ],
        "analytics/classes/calculable.php||analytics/classes/calculable.php": [
          "File: analytics/classes/calculable.php -> analytics/classes/calculable.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     protected $sampledata = array();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71:     protected $calculationinfo = null;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "143:         return $this->sampledata[$sampleid][$elementname];",
          "144:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "163:     protected final function add_shared_calculation_info(int $sampleid, array $info) {",
          "164:         if (is_null($this->calculationinfo)) {",
          "166:             $this->calculationinfo = new \\core_analytics\\calculation_info();",
          "167:         }",
          "169:         $this->calculationinfo->add_shared($sampleid, $info);",
          "170:     }",
          "181:     public final function save_calculation_info(\\core_analytics\\local\\time_splitting\\base $timesplitting, int $rangeindex) {",
          "182:         if (!is_null($this->calculationinfo)) {",
          "183:             $this->calculationinfo->save($this, $timesplitting, $rangeindex);",
          "184:         }",
          "185:     }",
          "",
          "---------------"
        ],
        "analytics/classes/calculation_info.php||analytics/classes/calculation_info.php": [
          "File: analytics/classes/calculation_info.php -> analytics/classes/calculation_info.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace core_analytics;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "39: class calculation_info {",
          "44:     private $info = [];",
          "49:     private $samplesinfo = [];",
          "64:     public function add_shared(int $sampleid, array $info) {",
          "68:         $this->info = $info + $this->info;",
          "71:         $this->samplesinfo[$sampleid] = array_keys($info);",
          "72:     }",
          "82:     public function save(\\core_analytics\\calculable $calculable, \\core_analytics\\local\\time_splitting\\base $timesplitting,",
          "83:             int $rangeindex) {",
          "85:         $calculableclass = get_class($calculable);",
          "86:         $cache = \\cache::make('core', 'calculablesinfo');",
          "88:         foreach ($this->info as $key => $value) {",
          "89:             $datakey = self::get_data_key($calculableclass, $key);",
          "92:             if (!$cache->has($datakey)) {",
          "93:                 $cache->set($datakey, $value);",
          "94:             }",
          "95:         }",
          "97:         foreach ($this->samplesinfo as $sampleid => $infokeys) {",
          "98:             $uniquesampleid = $timesplitting->append_rangeindex($sampleid, $rangeindex);",
          "99:             $samplekey = self::get_sample_key($uniquesampleid);",
          "102:             $cacheddata = $cache->get($samplekey);",
          "103:             $cacheddata[$calculableclass] = $infokeys;",
          "104:             $cache->set($samplekey, $cacheddata);",
          "105:         }",
          "108:         $this->info = [];",
          "109:         $this->samplesinfo = [];",
          "110:     }",
          "120:     public static function pull_info(array $predictionrecords) {",
          "122:         $cache = \\cache::make('core', 'calculablesinfo');",
          "124:         foreach ($predictionrecords as $uniquesampleid => $predictionrecord) {",
          "126:             $sampleid = $predictionrecord->sampleid;",
          "128:             $sampleinfo = $cache->get(self::get_sample_key($uniquesampleid));",
          "133:             $data = [];",
          "135:             if ($sampleinfo) {",
          "136:                 foreach ($sampleinfo as $calculableclass => $infokeys) {",
          "138:                     foreach ($infokeys as $infokey) {",
          "141:                         if (!isset($data[$calculableclass][$infokey])) {",
          "142:                             $datakey = self::get_data_key($calculableclass, $infokey);",
          "143:                             $data[$calculableclass][$infokey] = $cache->get($datakey);",
          "144:                         }",
          "146:                         $samplesdatakey = $calculableclass . ':extradata';",
          "147:                         $samplesdata[$sampleid][$samplesdatakey][$infokey] = & $data[$calculableclass][$infokey];",
          "148:                     }",
          "149:                 }",
          "150:             }",
          "151:         }",
          "155:         $cache->purge();",
          "157:         if (empty($samplesdata)) {",
          "158:             return false;",
          "159:         }",
          "161:         return $samplesdata;",
          "162:     }",
          "171:     private static function get_data_key(string $calculableclass, $key): string {",
          "172:         return 'data:' . $calculableclass . ':' . $key;",
          "173:     }",
          "181:     private static function get_sample_key(string $uniquesampleid): string {",
          "182:         return 'sample:' . $uniquesampleid;",
          "183:     }",
          "184: }",
          "",
          "---------------"
        ],
        "analytics/classes/insights_generator.php||analytics/classes/insights_generator.php": [
          "File: analytics/classes/insights_generator.php -> analytics/classes/insights_generator.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:     public function generate($samplecontexts, $predictions) {",
          "76:         $analyserclass = $this->target->get_analyser_class();",
          "",
          "[Removed Lines]",
          "74:         global $OUTPUT;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "89:                 foreach ($users as $user) {",
          "91:                     $this->set_notification_language($user);",
          "93:                     $this->notification($context, $user, $insighturl, $fullmessage, $fullmessagehtml);",
          "94:                 }",
          "95:             }",
          "",
          "[Removed Lines]",
          "92:                     list($insighturl, $fullmessage, $fullmessagehtml) = $this->prediction_info($prediction);",
          "",
          "[Added Lines]",
          "91:                     list($insighturl, $fullmessage, $fullmessagehtml) = $this->prediction_info($prediction, $context, $user);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "100:             foreach ($samplecontexts as $context) {",
          "102:                 $users = $this->target->get_insights_users($context);",
          "103:                 foreach ($users as $user) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:                 $contextname = $context->get_context_name(false);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "107:                     $insighturl = $this->target->get_insight_context_url($this->modelid, $context);",
          "114:                     $this->notification($context, $user, $insighturl, $fullmessage, $fullmessagehtml);",
          "115:                 }",
          "",
          "[Removed Lines]",
          "109:                     $fullmessage = get_string('insightinfomessage', 'analytics', $insighturl->out(false));",
          "110:                     $fullmessagehtml = $OUTPUT->render_from_template('core_analytics/insight_info_message',",
          "111:                         ['url' => $insighturl->out(false)]",
          "112:                     );",
          "",
          "[Added Lines]",
          "112:                     list($fullmessage, $fullmessagehtml) = $this->target->get_insight_body($context, $contextname, $user,",
          "113:                         $insighturl);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "184:         global $OUTPUT;",
          "186:         $predictionactions = $this->target->prediction_actions($prediction, true, true);",
          "192:         $messageactions  = [];",
          "194:         foreach ($predictionactions as $action) {",
          "195:             $actionurl = $action->get_url();",
          "197:             if (!$actionurl->get_param('forwardurl')) {",
          "199:                 $params = ['actionvisiblename' => $action->get_text(), 'target' => '_blank'];",
          "200:                 $actiondoneurl = new \\moodle_url('/report/insights/done.php', $params);",
          "202:                 $actionurl->param('forwardurl', $actiondoneurl->out(false));",
          "205:             }",
          "207:             if (empty($insighturl)) {",
          "209:                 $insighturl = $action->get_url();",
          "210:             }",
          "213:             $fullmessageplaintext .= get_string('insightinfomessageaction', 'analytics', $actiondata) . PHP_EOL;",
          "215:         }",
          "219:         return [$insighturl, $fullmessageplaintext, $fullmessagehtml];",
          "220:     }",
          "",
          "[Removed Lines]",
          "183:     private function prediction_info(\\core_analytics\\prediction $prediction) {",
          "189:         $fullmessageplaintext  = '';",
          "193:         $insighturl = null;",
          "196:             $opentoblank = false;",
          "204:                 $opentoblank = true;",
          "211:             $actiondata = (object)['url' => $action->get_url()->out(false), 'text' => $action->get_text(),",
          "212:                 'opentoblank' => $opentoblank];",
          "214:             $messageactions[] = $actiondata;",
          "217:         $fullmessagehtml = $OUTPUT->render_from_template('core_analytics/insight_info_message_prediction',",
          "218:             ['actions' => $messageactions]);",
          "",
          "[Added Lines]",
          "186:     private function prediction_info(\\core_analytics\\prediction $prediction, \\context $context, \\stdClass $user) {",
          "191:         $predictioninfo = $this->target->get_insight_body_for_prediction($context, $user, $prediction, $predictionactions);",
          "194:         $fullmessageplaintext = '';",
          "195:         if (!empty($predictioninfo[FORMAT_PLAIN])) {",
          "196:             $fullmessageplaintext .= $predictioninfo[FORMAT_PLAIN];",
          "197:         }",
          "199:         $insighturl = $predictioninfo['url'] ?? null;",
          "218:             $actiondata = (object)['url' => $action->get_url()->out(false), 'text' => $action->get_text()];",
          "224:             if ($action->get_action_name() === 'fixed') {",
          "225:                 $usefulurl = $actiondata->url;",
          "226:             } else if ($action->get_action_name() === 'notuseful') {",
          "227:                 $notusefulurl = $actiondata->url;",
          "228:             } else {",
          "229:                 $messageactions[] = $actiondata;",
          "230:             }",
          "231:         }",
          "234:         if (!empty($usefulurl) && !empty($notusefulurl)) {",
          "235:             $usefulbuttons = ['usefulurl' => $usefulurl, 'notusefulurl' => $notusefulurl];",
          "238:         $contextinfo = [",
          "239:             'usefulbuttons' => $usefulbuttons,",
          "240:             'actions' => $messageactions,",
          "241:             'body' => $predictioninfo[FORMAT_HTML] ?? ''",
          "242:         ];",
          "243:         $fullmessagehtml = $OUTPUT->render_from_template('core_analytics/insight_info_message_prediction', $contextinfo);",
          "",
          "---------------"
        ],
        "analytics/classes/local/target/base.php||analytics/classes/local/target/base.php": [
          "File: analytics/classes/local/target/base.php -> analytics/classes/local/target/base.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "288:         return get_string('insightmessagesubject', 'analytics', $context->get_context_name());",
          "289:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "303:     public function get_insight_body(\\context $context, string $contextname, \\stdClass $user, \\moodle_url $insighturl): array {",
          "304:         global $OUTPUT;",
          "306:         $fullmessage = get_string('insightinfomessageplain', 'analytics', $insighturl->out(false));",
          "307:         $fullmessagehtml = $OUTPUT->render_from_template('core_analytics/insight_info_message',",
          "308:             ['url' => $insighturl->out(false), 'insightinfomessage' => get_string('insightinfomessagehtml', 'analytics')]",
          "309:         );",
          "311:         return [$fullmessage, $fullmessagehtml];",
          "312:     }",
          "328:     public function get_insight_body_for_prediction(\\context $context, \\stdClass $user, \\core_analytics\\prediction $prediction,",
          "329:             array &$predictionactions): array {",
          "331:         return [FORMAT_PLAIN => '', FORMAT_HTML => '', 'url' => null];",
          "332:     }",
          "",
          "---------------"
        ],
        "analytics/classes/model.php||analytics/classes/model.php": [
          "File: analytics/classes/model.php -> analytics/classes/model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "951:             $predictionrecords = $this->add_prediction_ids($predictionrecords);",
          "953:             $samplesdata = $this->predictions_sample_data($predictionrecords);",
          "954:             $predictions = array_map(function($predictionobj) use ($samplesdata) {",
          "955:                 $prediction = new \\core_analytics\\prediction($predictionobj, $samplesdata[$predictionobj->sampleid]);",
          "956:                 return $prediction;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "954:             $samplesdata = $this->append_calculations_info($predictionrecords, $samplesdata);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1426:         return $samplesdata;",
          "1427:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1438:     public function append_calculations_info(array $predictionrecords, array $samplesdata): array {",
          "1440:         if ($extrainfo = calculation_info::pull_info($predictionrecords)) {",
          "1441:             foreach ($samplesdata as $sampleid => $data) {",
          "1443:                 $samplesdata[$sampleid] = $samplesdata[$sampleid] + $extrainfo[$sampleid];",
          "1444:             }",
          "1445:         }",
          "1446:         return $samplesdata;",
          "1447:     }",
          "",
          "---------------"
        ],
        "analytics/classes/prediction_action.php||analytics/classes/prediction_action.php": [
          "File: analytics/classes/prediction_action.php -> analytics/classes/prediction_action.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         $this->actionname = $actionname;",
          "69:         $this->text = $text;",
          "76:         if ($primary === false) {",
          "77:             $this->actionlink = new \\action_menu_link_secondary($this->url, $icon, $this->text, $attributes);",
          "",
          "[Removed Lines]",
          "72:         $params = array('action' => $this->actionname, 'predictionid' => $prediction->get_prediction_data()->id,",
          "73:             'forwardurl' => $actionurl->out(false));",
          "74:         $this->url = new \\moodle_url('/report/insights/action.php', $params);",
          "",
          "[Added Lines]",
          "71:         $this->url = self::transform_to_forward_url($actionurl, $actionname, $prediction->get_prediction_data()->id);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "114:     public function get_text() {",
          "115:         return $this->text;",
          "116:     }",
          "117: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "125:     public static function transform_to_forward_url(\\moodle_url $actionurl, string $actionname, int $predictionid): \\moodle_url {",
          "128:         $params = ['action' => $actionname, 'predictionid' => $predictionid,",
          "129:             'forwardurl' => $actionurl->out(false)];",
          "130:         return new \\moodle_url('/report/insights/action.php', $params);",
          "131:     }",
          "",
          "---------------"
        ],
        "analytics/templates/insight_info_message.mustache||analytics/templates/insight_info_message.mustache": [
          "File: analytics/templates/insight_info_message.mustache -> analytics/templates/insight_info_message.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "28:     Example context (json):",
          "29:     {",
          "31:     }",
          "32: }}",
          "59: <br/><br/>",
          "",
          "[Removed Lines]",
          "30:         \"url\": \"https://moodle.org\"",
          "33: <style>",
          "35: {{! Default btn-default styles. These styles are not applied to Moodle's web UI as there is a body:not(.dir-ltr):not(.dir-rtl)}}",
          "37: body:not(.dir-ltr):not(.dir-rtl) .btn-insight {",
          "38:     margin-bottom: 1rem!important;",
          "39:     margin-right: 1rem!important;",
          "40:     color: #212529;",
          "41:     background-color: #e9ecef;",
          "42:     border-color: #e9ecef",
          "43:     display: inline-block;",
          "44:     font-weight: 400;",
          "45:     text-align: center;",
          "46:     white-space: nowrap;",
          "47:     vertical-align: middle;",
          "48:     user-select: none;",
          "49:     border: 1px solid transparent;",
          "50:     padding: .375rem .75rem;",
          "51:     font-size: .9375rem;",
          "52:     line-height: 1.5;",
          "53:     border-radius: .25rem;",
          "54:     text-decoration: none;",
          "55: }",
          "56: </style>",
          "58: {{#str}} insightinfomessagehtml, analytics {{/str}}",
          "60: <a class=\"btn btn-default btn-insight\" href=\"{{url}}\">{{#str}} viewinsight, analytics {{/str}}</a>",
          "",
          "[Added Lines]",
          "30:         \"url\": \"https://moodle.org\",",
          "31:         \"insightinfomessage\": \"This insight is very <strong>useful</strong> because bla bla bla.\"",
          "35: {{> core_analytics/notification_styles}}",
          "37: {{{insightinfomessage}}}",
          "",
          "---------------"
        ],
        "analytics/templates/insight_info_message_prediction.mustache||analytics/templates/insight_info_message_prediction.mustache": [
          "File: analytics/templates/insight_info_message_prediction.mustache -> analytics/templates/insight_info_message_prediction.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "28:     Example context (json):",
          "29:     {",
          "40:     }",
          "41: }}",
          "67: <br/>",
          "68: {{#actions}}",
          "70: {{/actions}}",
          "",
          "[Removed Lines]",
          "30:         \"actions\": [",
          "31:             {",
          "32:                 \"url\": \"https://moodle.org\",",
          "33:                 \"text\": \"Moodle\"",
          "34:             }, {",
          "35:                 \"url\": \"https://en.wikipedia.org/wiki/Noodle\",",
          "36:                 \"text\": \"Noodle\",",
          "37:                 \"opentoblank\": 1",
          "38:             }",
          "39:         ]",
          "43: {{! Default btn-default styles. These styles are not applied to Moodle's web UI as there is a body:not(.dir-ltr):not(.dir-rtl)}}",
          "45: <style>",
          "46: body:not(.dir-ltr):not(.dir-rtl) .btn-insight {",
          "47:     margin-bottom: 1rem!important;",
          "48:     margin-right: 1rem!important;",
          "49:     color: #212529;",
          "50:     background-color: #e9ecef;",
          "51:     border-color: #e9ecef",
          "52:     display: inline-block;",
          "53:     font-weight: 400;",
          "54:     text-align: center;",
          "55:     white-space: nowrap;",
          "56:     vertical-align: middle;",
          "57:     user-select: none;",
          "58:     border: 1px solid transparent;",
          "59:     padding: .375rem .75rem;",
          "60:     font-size: .9375rem;",
          "61:     line-height: 1.5;",
          "62:     border-radius: .25rem;",
          "63:     text-decoration: none;",
          "64: }",
          "65: </style>",
          "69:     <a class=\"btn btn-default m-r-1 m-b-1 btn-insight\" {{#opentoblank}}target=\"_blank\" {{/opentoblank}}href=\"{{url}}\">{{text}}</a>",
          "",
          "[Added Lines]",
          "30:         \"body\": \"I am a <a href=\\\"#\\\">link</a> in a text body.\",",
          "31:         \"usefulbuttons\": {",
          "32:             \"usefulurl\": \"https://en.wikipedia.org/wiki/Noodle\",",
          "33:             \"notusefulurl\": \"https://en.wikipedia.org/wiki/Noodle\"",
          "34:         }",
          "38: {{> core_analytics/notification_styles}}",
          "40: {{#body}}",
          "41:     <div>",
          "42:         {{{.}}}",
          "43:     </div>",
          "44: {{/body}}",
          "48:     <a class=\"btn btn-outline-primary m-r-1 m-b-1 btn-insight\" href=\"{{url}}\">{{text}}</a><br/><br/>",
          "51: {{#usefulbuttons}}",
          "52:     <div>",
          "53:         {{! Using target blank for these actions as they only return a small notification.}}",
          "54:         <strong>{{#str}} washelpful, analytics {{/str}}</strong>",
          "55:         <a href=\"{{usefulurl}}\" target=\"_blank\" class=\"btn-insight btn btn-outline-primary\">{{#str}}yes{{/str}}</a>",
          "56:         <a href=\"{{notusefulurl}}\" target=\"_blank\" class=\"btn-insight btn btn-outline-primary\">{{#str}}no{{/str}}</a>",
          "57:     </div>",
          "58: {{/usefulbuttons}}",
          "",
          "---------------"
        ],
        "analytics/templates/notification_styles.mustache||analytics/templates/notification_styles.mustache": [
          "File: analytics/templates/notification_styles.mustache -> analytics/templates/notification_styles.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_analytics/notification_styles",
          "20:     Styles for insights' notifications (only for email).",
          "22:     These styles are not applied to Moodle's web UI as there is a body:not(.dir-ltr):not(.dir-rtl)",
          "24:     Classes required for JS:",
          "27:     Data attributes required for JS:",
          "30:     Example context (json):",
          "31:     {",
          "32:     }",
          "33: }}",
          "35: <style>",
          "36: body:not(.dir-ltr):not(.dir-rtl) {",
          "37:     font-family: 'Open Sans', sans-serif;",
          "38: }",
          "39: body:not(.dir-ltr):not(.dir-rtl) .btn-insight {",
          "40:     color: #007bff;",
          "41:     background-color: transparent;",
          "42:     display: inline-block;",
          "43:     font-weight: 400;",
          "44:     text-align: center;",
          "45:     white-space: nowrap;",
          "46:     vertical-align: middle;",
          "47:     user-select: none;",
          "48:     border: 1px solid #007bff;",
          "49:     padding: .375rem .75rem;",
          "50:     font-size: .9375rem;",
          "51:     line-height: 1.5;",
          "52:     border-radius: 0;",
          "53:     text-decoration: none;",
          "54:     cursor: pointer;",
          "55: }",
          "56: </style>",
          "",
          "---------------"
        ],
        "analytics/tests/calculation_info_test.php||analytics/tests/calculation_info_test.php": [
          "File: analytics/tests/calculation_info_test.php -> analytics/tests/calculation_info_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "27: require_once(__DIR__ . '/fixtures/test_indicator_max.php');",
          "28: require_once(__DIR__ . '/fixtures/test_indicator_min.php');",
          "37: class analytics_calculation_info_testcase extends advanced_testcase {",
          "49:     public function test_calculation_info_add_pull($info1, $info2, $info3, $info4) {",
          "50:         $this->resetAfterTest();",
          "52:         $atimesplitting = new \\core\\analytics\\time_splitting\\quarters();",
          "54:         $indicator1 = new test_indicator_min();",
          "55:         $indicator2 = new test_indicator_max();",
          "57:         $calculationinfo = new \\core_analytics\\calculation_info();",
          "58:         $calculationinfo->add_shared(111, [111 => $info1]);",
          "59:         $calculationinfo->add_shared(222, [222 => 'should-get-overwritten-in-next-line']);",
          "60:         $calculationinfo->add_shared(222, [222 => $info2]);",
          "61:         $calculationinfo->save($indicator1, $atimesplitting, 0);",
          "65:         $calculationinfo->add_shared(222, [222 => 'eheheh']);",
          "66:         $calculationinfo->save($indicator1, $atimesplitting, 0);",
          "70:         $calculationinfo->add_shared(111, [111 => $info3]);",
          "71:         $calculationinfo->add_shared(333, [333 => $info4]);",
          "72:         $calculationinfo->save($indicator2, $atimesplitting, 0);",
          "75:         $predictionrecords = [",
          "76:             '111-0' => (object)['sampleid' => '111'],",
          "77:             '222-0' => (object)['sampleid' => '222'],",
          "78:             '333-0' => (object)['sampleid' => '333'],",
          "79:         ];",
          "80:         $info = \\core_analytics\\calculation_info::pull_info($predictionrecords);",
          "82:         $this->assertCount(3, $info);",
          "83:         $this->assertCount(2, $info[111]);",
          "84:         $this->assertCount(1, $info[222]);",
          "85:         $this->assertCount(1, $info[333]);",
          "86:         $this->assertEquals($info1, $info[111]['test_indicator_min:extradata'][111]);",
          "87:         $this->assertEquals($info2, $info[222]['test_indicator_min:extradata'][222]);",
          "88:         $this->assertEquals($info3, $info[111]['test_indicator_max:extradata'][111]);",
          "89:         $this->assertEquals($info4, $info[333]['test_indicator_max:extradata'][333]);",
          "92:         $this->assertFalse(\\core_analytics\\calculation_info::pull_info($predictionrecords));",
          "93:     }",
          "100:     public function provider_test_calculation_info_add_pull() {",
          "101:         return [",
          "102:             'mixed-types' => ['asd', true, [123, 123, 123], (object)['asd' => 'fgfg']],",
          "103:         ];",
          "104:     }",
          "105: }",
          "",
          "---------------"
        ],
        "course/classes/analytics/indicator/activities_due.php||course/classes/analytics/indicator/activities_due.php": [
          "File: course/classes/analytics/indicator/activities_due.php -> course/classes/analytics/indicator/activities_due.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:         $actionevents = \\core_calendar_external::get_calendar_action_events_by_timesort($starttime, $endtime, 0, 1,",
          "74:             true, $user->id);",
          "76:         if ($actionevents->events) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76:         $useractionevents = [];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:             foreach ($actionevents->events as $event) {",
          "81:                 $nparams = $this->get_provide_event_action_num_params($event->modulename);",
          "82:                 if ($nparams > 2) {",
          "84:                 }",
          "85:             }",
          "86:         }",
          "88:         return self::get_min_value();",
          "",
          "[Removed Lines]",
          "83:                     return self::get_max_value();",
          "",
          "[Added Lines]",
          "85:                     $useractionevents[$event->id] = (object)[",
          "86:                         'name' => $event->name,",
          "87:                         'url' => $event->url,",
          "88:                         'time' => $event->timesort,",
          "89:                         'coursename' => $event->course->fullnamedisplay,",
          "90:                         'icon' => $event->icon,",
          "91:                     ];",
          "95:             if (!empty($useractionevents)) {",
          "96:                 $this->add_shared_calculation_info($sampleid, $useractionevents);",
          "97:                 return self::get_max_value();",
          "98:             }",
          "",
          "---------------"
        ],
        "lang/en/analytics.php||lang/en/analytics.php": [
          "File: lang/en/analytics.php -> lang/en/analytics.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "150: $string['viewinsight'] = 'View insight';",
          "151: $string['viewinsightdetails'] = 'View insight details';",
          "152: $string['viewprediction'] = 'View prediction details';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "153: $string['washelpful'] = 'Was this helpful?';",
          "",
          "---------------"
        ],
        "lang/en/cache.php||lang/en/cache.php": [
          "File: lang/en/cache.php -> lang/en/cache.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: $string['caching'] = 'Caching';",
          "37: $string['cacheadmin'] = 'Cache administration';",
          "38: $string['cacheconfig'] = 'Configuration';",
          "39: $string['cachedef_calendar_subscriptions'] = 'Calendar subscriptions';",
          "40: $string['cachedef_calendar_categories'] = 'Calendar course categories that a user can access';",
          "41: $string['cachedef_capabilities'] = 'System capabilities list';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39: $string['cachedef_calculablesinfo'] = 'Analytics calculables info';",
          "",
          "---------------"
        ],
        "lang/en/calendar.php||lang/en/calendar.php": [
          "File: lang/en/calendar.php -> lang/en/calendar.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "268: $string['weeknext'] = 'Next week';",
          "269: $string['weekthis'] = 'This week';",
          "270: $string['when'] = 'When';",
          "271: $string['yesterday'] = 'Yesterday';",
          "272: $string['youcandeleteallrepeats'] = 'This event is part of a repeating event series. You can delete this event only, or all {$a} events in the series at once.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271: $string['whendate'] = 'When: {$a}';",
          "",
          "---------------"
        ],
        "lang/en/moodle.php||lang/en/moodle.php": [
          "File: lang/en/moodle.php -> lang/en/moodle.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2190: $string['youareabouttocreatezip'] = 'You are about to create a zip file containing';",
          "2191: $string['youaregoingtorestorefrom'] = 'You are about to start the restore process for';",
          "2192: $string['youhaveupcomingactivitiesdue'] = 'You have upcoming activities due';",
          "2193: $string['youneedtoenrol'] = 'To perform that action you need to enrol in this course.';",
          "2194: $string['yourlastlogin'] = 'Your last login was';",
          "2195: $string['yourself'] = 'yourself';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2193: $string['youhaveupcomingactivitiesdueinfo'] = 'Hi {$a},",
          "2195: <br/><br/>You have upcoming activities due:';",
          "",
          "---------------"
        ],
        "lib/db/caches.php||lib/db/caches.php": [
          "File: lib/db/caches.php -> lib/db/caches.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "408:         'simpledata' => true,",
          "409:         'staticacceleration' => true",
          "410:     ],",
          "411: );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "413:     'calculablesinfo' => [",
          "414:         'mode' => cache_store::MODE_REQUEST,",
          "415:         'simplekeys' => false,",
          "416:         'simpledata' => false,",
          "417:     ],",
          "",
          "---------------"
        ],
        "user/classes/analytics/target/upcoming_activities_due.php||user/classes/analytics/target/upcoming_activities_due.php": [
          "File: user/classes/analytics/target/upcoming_activities_due.php -> user/classes/analytics/target/upcoming_activities_due.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "169:         return false;",
          "170:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "186:     public function get_insight_body_for_prediction(\\context $context, \\stdClass $user, \\core_analytics\\prediction $prediction,",
          "187:             array &$predictionactions): array {",
          "188:         global $OUTPUT;",
          "190:         $fullmessageplaintext = get_string('youhaveupcomingactivitiesdueinfo', 'moodle', $user->firstname);",
          "192:         $sampledata = $prediction->get_sample_data();",
          "193:         $activitiesdue = $sampledata['core_course\\analytics\\indicator\\activities_due:extradata'];",
          "195:         if (empty($activitiesdue)) {",
          "196:             throw new \\coding_exception('The activities_due indicator must be part of the model indicators.');",
          "197:         }",
          "199:         $activitiestext = [];",
          "200:         foreach ($activitiesdue as $key => $activitydue) {",
          "203:             $activitiesdue[$key]->formattedtime = userdate($activitydue->time);",
          "206:             $activityurl = new \\moodle_url($activitydue->url);",
          "207:             $actionurl = \\core_analytics\\prediction_action::transform_to_forward_url($activityurl, 'viewupcoming',",
          "208:                 $prediction->get_prediction_data()->id);",
          "209:             $activitiesdue[$key]->url = $actionurl->out(false);",
          "211:             if (count($activitiesdue) === 1) {",
          "213:                 $insighturl = $actionurl;",
          "214:             }",
          "216:             $activitiestext[] = $activitydue->name . ': ' . $activitiesdue[$key]->url;",
          "217:         }",
          "219:         foreach ($predictionactions as $key => $action) {",
          "220:             if ($action->get_action_name() === 'viewupcoming') {",
          "223:                 if (empty($insighturl)) {",
          "224:                     $insighturl = $action->get_url();",
          "225:                 }",
          "229:                 unset($predictionactions[$key]);",
          "230:                 break;",
          "231:             }",
          "232:         }",
          "234:         $activitieshtml = $OUTPUT->render_from_template('core_user/upcoming_activities_due_insight_body', (object) [",
          "235:             'activitiesdue' => array_values($activitiesdue),",
          "236:             'userfirstname' => $user->firstname",
          "237:         ]);",
          "239:         return [",
          "240:             FORMAT_PLAIN => $fullmessageplaintext . PHP_EOL . PHP_EOL . implode(PHP_EOL, $activitiestext) . PHP_EOL,",
          "241:             FORMAT_HTML => $activitieshtml,",
          "242:             'url' => $insighturl,",
          "243:         ];",
          "244:     }",
          "",
          "---------------"
        ],
        "user/templates/upcoming_activities_due_insight_body.mustache||user/templates/upcoming_activities_due_insight_body.mustache": [
          "File: user/templates/upcoming_activities_due_insight_body.mustache -> user/templates/upcoming_activities_due_insight_body.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_user/upcoming_activities_due_insight_body",
          "20:     Template for the upcoming activity due insight",
          "22:     Context variables required for this template:",
          "26:     Example context (json):",
          "27:     {",
          "28:         \"userfirstname\": \"John\",",
          "29:         \"activitiesdue\": [",
          "30:             {",
          "31:                 \"name\": \"Introduction to ASP is due\",",
          "32:                 \"formattedtime\": \"31 January 2018\",",
          "33:                 \"coursename\": \"Programming I\",",
          "34:                 \"url\": \"https://www.google.com\"",
          "35:             }",
          "36:         ]",
          "37:     }",
          "38: }}",
          "40: <style>",
          "41: body:not(.dir-ltr):not(.dir-rtl) table.upcoming-activity-due {",
          "42:     font-family: 'Open Sans', sans-serif;",
          "43:     text-align: justify;",
          "44:     margin-bottom: 1rem;",
          "45:     margin-top: 1rem;",
          "46: }",
          "47: body:not(.dir-ltr):not(.dir-rtl) table.upcoming-activity-due tr.when {",
          "48:     background-color: #e9ecef;",
          "49: }",
          "50: body:not(.dir-ltr):not(.dir-rtl) table.upcoming-activity-due th {",
          "51:     padding: 1rem .75rem 1rem .75rem;",
          "52:     font-weight: 400;",
          "53:     font-size: larger;",
          "54:     border-top: 1px solid #dee2e6;",
          "55: }",
          "56: body:not(.dir-ltr):not(.dir-rtl) table.upcoming-activity-due td {",
          "57:     padding: .75rem;",
          "58: }",
          "59: body:not(.dir-ltr):not(.dir-rtl) table.upcoming-activity-due td.link {",
          "60:     border-top: 1px solid #dee2e6;",
          "61:     border-bottom: 1px solid #dee2e6;",
          "62: }",
          "63: </style>",
          "65: {{#str}} youhaveupcomingactivitiesdueinfo, moodle, {{userfirstname}} {{/str}}",
          "66: <br/><br/>",
          "68: {{#activitiesdue}}",
          "69:     <table class=\"table upcoming-activity-due\">",
          "70:         <thead>",
          "71:             <tr>",
          "72:                 <th scope=\"col\" class=\"h5\">",
          "73:                     {{#icon}}",
          "74:                         {{#pix}} {{key}}, {{component}}, {{title}} {{alttext}} {{/pix}}",
          "75:                     {{/icon}}",
          "76:                     {{name}}",
          "77:                 </th>",
          "78:             </tr>",
          "79:         </thead>",
          "80:         <tbody>",
          "81:             <tr class=\"when\">",
          "82:                 <td><strong>{{#str}} whendate, calendar, {{formattedtime}} {{/str}}</strong></td>",
          "83:             </tr>",
          "84:             <tr>",
          "85:                 <td>{{#str}} coursetitle, moodle, {\"course\": \"{{coursename}}\" } {{/str}}</td>",
          "86:             </tr>",
          "87:             <tr>",
          "88:                 <td class=\"link\"><a href=\"{{url}}\">{{#str}} gotoactivity, calendar{{/str}}</a></td>",
          "89:             </tr>",
          "90:         </tbody>",
          "91:     </table>",
          "92: {{/activitiesdue}}",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019091300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019091300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ecc9960ead88582a3e7197e6f339cae940138945",
      "candidate_info": {
        "commit_hash": "ecc9960ead88582a3e7197e6f339cae940138945",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ecc9960ead88582a3e7197e6f339cae940138945",
        "files": [
          "lib/classes/hub/registration.php",
          "lib/db/upgrade.php",
          "lib/db/upgradelib.php",
          "lib/tests/upgradelib_test.php",
          "version.php"
        ],
        "message": "MDL-66118 hub: Stop using the hub URL as the setting name suffix\n\nSite indicators shared with the registration hub used to have the hub\nURL in the relevant setting names - such as site_name_httpsmoodlenet.\nThis upgrade step converts all such settings and drops the URL suffix\nbecause we do not support alternative hubs any more.\n\nAdditionally the upgrade step renames the official hub and updates its\nURL so that existing registrations with https://moodle.net are still\nvalid.",
        "before_after_code_files": [
          "lib/classes/hub/registration.php||lib/classes/hub/registration.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/db/upgradelib.php||lib/db/upgradelib.php",
          "lib/tests/upgradelib_test.php||lib/tests/upgradelib_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/classes/hub/registration.php||lib/classes/hub/registration.php": [
          "File: lib/classes/hub/registration.php -> lib/classes/hub/registration.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "158:         require_once($CFG->dirroot . \"/course/lib.php\");",
          "160:         $siteinfo = array();",
          "162:         foreach (self::FORM_FIELDS as $field) {",
          "164:             if ($siteinfo[$field] === false) {",
          "165:                 $siteinfo[$field] = array_key_exists($field, $defaults) ? $defaults[$field] : null;",
          "166:             }",
          "",
          "[Removed Lines]",
          "161:         $cleanhuburl = clean_param(HUB_MOODLEORGHUBURL, PARAM_ALPHANUMEXT);",
          "163:             $siteinfo[$field] = get_config('hub', 'site_'.$field.'_' . $cleanhuburl);",
          "",
          "[Added Lines]",
          "162:             $siteinfo[$field] = get_config('hub', 'site_'.$field);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "266:     public static function save_site_info($formdata) {",
          "268:         foreach (self::FORM_FIELDS as $field) {",
          "270:         }",
          "274:     }",
          "",
          "[Removed Lines]",
          "267:         $cleanhuburl = clean_param(HUB_MOODLEORGHUBURL, PARAM_ALPHANUMEXT);",
          "269:             set_config('site_' . $field . '_' . $cleanhuburl, $formdata->$field, 'hub');",
          "273:         set_config('site_regupdateversion_' . $cleanhuburl, max(array_keys(self::CONFIRM_NEW_FIELDS)), 'hub');",
          "",
          "[Added Lines]",
          "267:             set_config('site_' . $field, $formdata->$field, 'hub');",
          "271:         set_config('site_regupdateversion', max(array_keys(self::CONFIRM_NEW_FIELDS)), 'hub');",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "537:             return $fieldsneedconfirm;",
          "538:         }",
          "542:         foreach (self::CONFIRM_NEW_FIELDS as $version => $fields) {",
          "543:             if ($version > $lastupdated) {",
          "544:                 $fieldsneedconfirm = array_merge($fieldsneedconfirm, $fields);",
          "",
          "[Removed Lines]",
          "540:         $cleanhuburl = clean_param(HUB_MOODLEORGHUBURL, PARAM_ALPHANUMEXT);",
          "541:         $lastupdated = (int)get_config('hub', 'site_regupdateversion_' . $cleanhuburl);",
          "",
          "[Added Lines]",
          "538:         $lastupdated = (int)get_config('hub', 'site_regupdateversion');",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3556:         upgrade_main_savepoint(true, 2019092700.01);",
          "3557:     }",
          "3559:     return true;",
          "3560: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3559:     if ($oldversion < 2019100400.01) {",
          "3561:         $DB->execute(\"UPDATE {registration_hubs}",
          "3562:                          SET hubname = ?, huburl = ?",
          "3563:                        WHERE huburl = ?\", ['moodle', 'https://stats.moodle.org', 'https://moodle.net']);",
          "3566:         $hubconfig = get_config('hub');",
          "3568:         if (!empty($hubconfig)) {",
          "3569:             foreach (upgrade_convert_hub_config_site_param_names($hubconfig, 'https://moodle.net') as $name => $value) {",
          "3570:                 set_config($name, $value, 'hub');",
          "3571:             }",
          "3572:         }",
          "3574:         upgrade_main_savepoint(true, 2019100400.01);",
          "3575:     }",
          "",
          "---------------"
        ],
        "lib/db/upgradelib.php||lib/db/upgradelib.php": [
          "File: lib/db/upgradelib.php -> lib/db/upgradelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "609:         $DB->execute($updatesql, $params + ['modelid' => $model->id]);",
          "610:     }",
          "",
          "[Removed Lines]",
          "611: }",
          "",
          "[Added Lines]",
          "620: function upgrade_convert_hub_config_site_param_names(stdClass $hubconfig, string $huburl): stdClass {",
          "622:     $cleanhuburl = clean_param($huburl, PARAM_ALPHANUMEXT);",
          "623:     $converted = [];",
          "625:     foreach ($hubconfig as $oldname => $value) {",
          "626:         if (preg_match('/^site_([a-z]+)([A-Za-z0-9_-]*)/', $oldname, $matches)) {",
          "627:             $newname = 'site_'.$matches[1];",
          "629:             if ($oldname === $newname) {",
          "631:                 $converted[$newname] = $value;",
          "633:             } else if (!array_key_exists($newname, $converted)) {",
          "635:                 $converted[$newname] = $value;",
          "636:                 $converted[$oldname] = null;",
          "638:             } else if ($matches[2] === '_'.$cleanhuburl) {",
          "640:                 $converted[$newname] = $value;",
          "641:                 $converted[$oldname] = null;",
          "643:             } else {",
          "645:                 $converted[$oldname] = null;",
          "646:             }",
          "648:         } else {",
          "650:             $converted[$oldname] = $value;",
          "651:         }",
          "652:     }",
          "654:     return (object) $converted;",
          "655: }",
          "",
          "---------------"
        ],
        "lib/tests/upgradelib_test.php||lib/tests/upgradelib_test.php": [
          "File: lib/tests/upgradelib_test.php -> lib/tests/upgradelib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1124:         $this->assertEquals(1, $DB->count_records('analytics_prediction_actions',",
          "1125:             ['actionname' => \\core_analytics\\prediction::ACTION_INCORRECTLY_FLAGGED]));",
          "1126:     }",
          "1127: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1131:     public function test_upgrade_convert_hub_config_site_param_names() {",
          "1133:         $config = (object) [",
          "1135:             'site_name_httpsmoodlenet' => 'Foo Site',",
          "1136:             'site_language_httpsmoodlenet' => 'en',",
          "1137:             'site_emailalert_httpsmoodlenet' => 1,",
          "1139:             'site_name_httphubmoodleorg' => 'Bar Site',",
          "1140:             'site_description_httphubmoodleorg' => 'Old description',",
          "1142:             'site_emailalert' => 0,",
          "1144:             'custom' => 'Do not touch this',",
          "1146:             'site_foo_httpfirsthuborg' => 'First',",
          "1147:             'site_foo_httpanotherhubcom' => 'Another',",
          "1148:             'site_foo_httpyetanotherhubcom' => 'Yet another',",
          "1150:             'site_bar_httpfirsthuborg' => 'First',",
          "1151:             'site_bar_httpanotherhubcom' => 'Another',",
          "1152:             'site_bar_httpsmoodlenet' => 'One hub to rule them all!',",
          "1153:             'site_bar_httpyetanotherhubcom' => 'Yet another',",
          "1154:         ];",
          "1156:         $converted = upgrade_convert_hub_config_site_param_names($config, 'https://moodle.net');",
          "1159:         $this->assertSame($converted->site_name, 'Foo Site');",
          "1160:         $this->assertSame($converted->site_bar, 'One hub to rule them all!');",
          "1161:         $this->assertNull($converted->site_name_httpsmoodlenet);",
          "1162:         $this->assertNull($converted->site_bar_httpfirsthuborg);",
          "1163:         $this->assertNull($converted->site_bar_httpanotherhubcom);",
          "1164:         $this->assertNull($converted->site_bar_httpyetanotherhubcom);",
          "1166:         $this->assertSame($converted->site_foo, 'First');",
          "1167:         $this->assertNull($converted->site_foo_httpfirsthuborg);",
          "1168:         $this->assertNull($converted->site_foo_httpanotherhubcom);",
          "1169:         $this->assertNull($converted->site_foo_httpyetanotherhubcom);",
          "1171:         $this->assertSame($converted->site_emailalert, 0);",
          "1173:         $this->assertSame($converted->custom, 'Do not touch this');",
          "1174:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019100400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019100400.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b742fe1403e8e8030a0a092c01e56836903c5d45",
      "candidate_info": {
        "commit_hash": "b742fe1403e8e8030a0a092c01e56836903c5d45",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b742fe1403e8e8030a0a092c01e56836903c5d45",
        "files": [
          "version.php"
        ],
        "message": "Moodle release 3.7rc1",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019051300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7beta (Build: 20190511)'; // Human-friendly version name",
          "39: $maturity = MATURITY_BETA;             // This version's maturity level.",
          "",
          "[Added Lines]",
          "32: $version  = 2019051400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7rc1 (Build: 20190514)'; // Human-friendly version name",
          "39: $maturity = MATURITY_RC;             // This version's maturity level.",
          "",
          "---------------"
        ]
      }
    }
  ]
}