{
  "cve_id": "CVE-2011-3870",
  "cve_desc": "Puppet 2.7.x before 2.7.5, 2.6.x before 2.6.11, and 0.25.x allows local users to modify the permissions of arbitrary files via a symlink attack on the SSH authorized_keys file.",
  "repo": "puppetlabs/puppet",
  "patch_hash": "88512e880bd2a03694b5fef42540dc7b3da05d30",
  "patch_info": {
    "commit_hash": "88512e880bd2a03694b5fef42540dc7b3da05d30",
    "repo": "puppetlabs/puppet",
    "commit_url": "https://github.com/puppetlabs/puppet/commit/88512e880bd2a03694b5fef42540dc7b3da05d30",
    "files": [
      "lib/puppet/provider/ssh_authorized_key/parsed.rb",
      "spec/unit/provider/ssh_authorized_key/parsed_spec.rb"
    ],
    "message": "Drop privileges before creating and chmodding SSH keys.\n\nPreviously, potentially abusable chown and chmod calls were performed as\nroot.  This tries to moves as much as possible into code which is run\nafter privileges have been dropped.\n\nHuge thanks to Ricky Zhou <ricky@fedoraproject.org> for discovering this and\nsupplying the security fix.  Awesome work.\n\nFixes CVE-2011-3870\n\nSigned-off-by: Daniel Pittman <daniel@puppetlabs.com>",
    "before_after_code_files": [
      "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb",
      "spec/unit/provider/ssh_authorized_key/parsed_spec.rb||spec/unit/provider/ssh_authorized_key/parsed_spec.rb"
    ]
  },
  "patch_diff": {
    "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb": [
      "File: lib/puppet/provider/ssh_authorized_key/parsed.rb -> lib/puppet/provider/ssh_authorized_key/parsed.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "56:   def flush",
      "57:     raise Puppet::Error, \"Cannot write SSH authorized keys without user\"    unless @resource.should(:user)",
      "58:     raise Puppet::Error, \"User '#{@resource.should(:user)}' does not exist\" unless uid = Puppet::Util.uid(@resource.should(:user))",
      "65:     # ParsedFile usually calls backup_target much later in the flush process,",
      "66:     # but our SUID makes that fail to open filebucket files for writing.",
      "67:     # Fortunately, there's already logic to make sure it only ever happens once,",
      "68:     # so calling it here supresses the later attempt by our superclass's flush method.",
      "69:     self.class.backup_target(target)",
      "74:   end",
      "76:   # parse sshv2 option strings, wich is a comma separated list of",
      "",
      "[Removed Lines]",
      "59:     unless File.exist?(dir = File.dirname(target))",
      "60:       Puppet.debug \"Creating #{dir}\"",
      "61:       Dir.mkdir(dir, dir_perm)",
      "62:       File.chown(uid, nil, dir)",
      "63:     end",
      "71:     Puppet::Util::SUIDManager.asuser(@resource.should(:user)) { super }",
      "72:     File.chown(uid, nil, target)",
      "73:     File.chmod(file_perm, target)",
      "",
      "[Added Lines]",
      "65:     Puppet::Util::SUIDManager.asuser(@resource.should(:user)) do",
      "66:         unless File.exist?(dir = File.dirname(target))",
      "67:           Puppet.debug \"Creating #{dir}\"",
      "68:           Dir.mkdir(dir, dir_perm)",
      "69:         end",
      "71:         super",
      "73:         File.chmod(file_perm, target)",
      "74:     end",
      "",
      "---------------"
    ],
    "spec/unit/provider/ssh_authorized_key/parsed_spec.rb||spec/unit/provider/ssh_authorized_key/parsed_spec.rb": [
      "File: spec/unit/provider/ssh_authorized_key/parsed_spec.rb -> spec/unit/provider/ssh_authorized_key/parsed_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "133:         @provider.flush",
      "134:       end",
      "137:         uid = Puppet::Util.uid(\"random_bob\")",
      "139:         @provider.flush",
      "140:       end",
      "143:         uid = Puppet::Util.uid(\"random_bob\")",
      "145:         @provider.flush",
      "146:       end",
      "",
      "[Removed Lines]",
      "136:       it \"should chown the directory to the user\" do",
      "138:         File.expects(:chown).with(uid, nil, \"/tmp/.ssh_dir\")",
      "142:       it \"should chown the key file to the user\" do",
      "144:         File.expects(:chown).with(uid, nil, \"/tmp/.ssh_dir/place_to_put_authorized_keys\")",
      "",
      "[Added Lines]",
      "136:       it \"should absolutely not chown the directory to the user\" do",
      "138:         File.expects(:chown).never",
      "142:       it \"should absolutely not chown the key file to the user\" do",
      "144:         File.expects(:chown).never",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "177:         @provider.flush",
      "178:       end",
      "181:         File.stubs(:exist?).with(@dir).returns false",
      "182:         Dir.stubs(:mkdir).with(@dir,0700)",
      "183:         uid = Puppet::Util.uid(\"nobody\")",
      "185:         @provider.flush",
      "186:       end",
      "",
      "[Removed Lines]",
      "180:       it \"should chown the directory to the user if it creates it\" do",
      "184:         File.expects(:chown).with(uid, nil, @dir)",
      "",
      "[Added Lines]",
      "180:       it \"should absolutely not chown the directory to the user if it creates it\" do",
      "184:         File.expects(:chown).never",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "192:         @provider.flush",
      "193:       end",
      "196:         uid = Puppet::Util.uid(\"nobody\")",
      "198:         @provider.flush",
      "199:       end",
      "",
      "[Removed Lines]",
      "195:       it \"should chown the key file to the user\" do",
      "197:         File.expects(:chown).with(uid, nil, File.expand_path(\"~nobody/.ssh/authorized_keys\"))",
      "",
      "[Added Lines]",
      "195:       it \"should absolutely not chown the key file to the user\" do",
      "197:         File.expects(:chown).never",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1e5fbb2968a6967221ffabeab9512d799f0ba6a7",
      "candidate_info": {
        "commit_hash": "1e5fbb2968a6967221ffabeab9512d799f0ba6a7",
        "repo": "puppetlabs/puppet",
        "commit_url": "https://github.com/puppetlabs/puppet/commit/1e5fbb2968a6967221ffabeab9512d799f0ba6a7",
        "files": [
          "lib/puppet/provider/ssh_authorized_key/parsed.rb"
        ],
        "message": "Drop privileges before creating and chmodding SSH keys.\n\nPreviously, potentially abusable chown and chmod calls were performed as\nroot.  This tries to moves as much as possible into code which is run\nafter privileges have been dropped.\n\nHuge thanks to Ricky Zhou <ricky@fedoraproject.org> for discovering this and\nsupplying the security fix.  Awesome work.\n\nFixes CVE-2011-3870\n\nSigned-off-by: Daniel Pittman <daniel@puppetlabs.com>",
        "before_after_code_files": [
          "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb"
          ],
          "candidate": [
            "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/puppet/provider/ssh_authorized_key/parsed.rb||lib/puppet/provider/ssh_authorized_key/parsed.rb": [
          "File: lib/puppet/provider/ssh_authorized_key/parsed.rb -> lib/puppet/provider/ssh_authorized_key/parsed.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "62:     end",
          "64:     def flush",
          "67:         unless File.exist?(dir = File.dirname(target))",
          "71:         end",
          "74:         File.chmod(file_perm, target)",
          "75:     end",
          "77:     # parse sshv2 option strings, wich is a comma separated list of",
          "",
          "[Removed Lines]",
          "65:         raise Puppet::Error, \"Cannot write SSH authorized keys without user\" unless user",
          "66:         raise Puppet::Error, \"User '#{user}' does not exist\"                 unless uid = Puppet::Util.uid(user)",
          "68:             Puppet.debug \"Creating #{dir}\"",
          "69:             Dir.mkdir(dir, dir_perm)",
          "70:             File.chown(uid, nil, dir)",
          "72:         Puppet::Util::SUIDManager.asuser(user) { super }",
          "73:         File.chown(uid, nil, target)",
          "",
          "[Added Lines]",
          "65:       raise Puppet::Error, \"Cannot write SSH authorized keys without user\" unless user",
          "66:       raise Puppet::Error, \"User '#{user}' does not exist\"                 unless uid = Puppet::Util.uid(user)",
          "67:       Puppet::Util::SUIDManager.asuser(@resource.should(:user)) do",
          "69:           Puppet.debug \"Creating #{dir}\"",
          "70:           Dir.mkdir(dir, dir_perm)",
          "73:         super",
          "76:       end",
          "",
          "---------------"
        ]
      }
    }
  ]
}