{
  "cve_id": "CVE-2018-14774",
  "cve_desc": "An issue was discovered in HttpKernel in Symfony 2.7.0 through 2.7.48, 2.8.0 through 2.8.43, 3.3.0 through 3.3.17, 3.4.0 through 3.4.13, 4.0.0 through 4.0.13, and 4.1.0 through 4.1.2. When using HttpCache, the values of the X-Forwarded-Host headers are implicitly set as trusted while this should be forbidden, leading to potential host header injection.",
  "repo": "symfony/symfony",
  "patch_hash": "725dee4cd8b4ccd52e335ae4b4522242cea9bd4a",
  "patch_info": {
    "commit_hash": "725dee4cd8b4ccd52e335ae4b4522242cea9bd4a",
    "repo": "symfony/symfony",
    "commit_url": "https://github.com/symfony/symfony/commit/725dee4cd8b4ccd52e335ae4b4522242cea9bd4a",
    "files": [
      "src/Symfony/Component/HttpFoundation/Request.php",
      "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
      "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
      "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
      "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
    ],
    "message": "[HttpKernel] fix trusted headers management in HttpCache and InlineFragmentRenderer",
    "before_after_code_files": [
      "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php",
      "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
      "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
      "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
      "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
      "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
    ]
  },
  "patch_diff": {
    "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php": [
      "File: src/Symfony/Component/HttpFoundation/Request.php -> src/Symfony/Component/HttpFoundation/Request.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1944:         if (self::$trustedHeaders[self::HEADER_FORWARDED] && $this->headers->has(self::$trustedHeaders[self::HEADER_FORWARDED])) {",
      "1945:             $forwardedValues = $this->headers->get(self::$trustedHeaders[self::HEADER_FORWARDED]);",
      "1946:             $forwardedValues = preg_match_all(sprintf('{(?:%s)=(?:\"?\\[?)([a-zA-Z0-9\\.:_\\-/]*+)}', self::$forwardedParams[$type]), $forwardedValues, $matches) ? $matches[1] : array();",
      "1947:         }",
      "1949:         if (null !== $ip) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1947:             if (self::HEADER_CLIENT_PORT === $type) {",
      "1948:                 foreach ($forwardedValues as $k => $v) {",
      "1949:                     $forwardedValues[$k] = substr_replace($v, '0.0.0.0', 0, strrpos($v, ':'));",
      "1950:                 }",
      "1951:             }",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php": [
      "File: src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php -> src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "16: use Symfony\\Component\\HttpFoundation\\Response;",
      "17: use Symfony\\Component\\HttpKernel\\Controller\\ControllerReference;",
      "18: use Symfony\\Component\\HttpKernel\\Event\\GetResponseForExceptionEvent;",
      "19: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
      "20: use Symfony\\Component\\HttpKernel\\KernelEvents;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "19: use Symfony\\Component\\HttpKernel\\HttpCache\\SubRequestHandler;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "77:         $level = ob_get_level();",
      "78:         try {",
      "80:         } catch (\\Exception $e) {",
      "",
      "[Removed Lines]",
      "79:             return $this->kernel->handle($subRequest, HttpKernelInterface::SUB_REQUEST, false);",
      "",
      "[Added Lines]",
      "80:             return SubRequestHandler::handle($this->kernel, $subRequest, HttpKernelInterface::SUB_REQUEST, false);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "109:         $cookies = $request->cookies->all();",
      "110:         $server = $request->server->all();",
      "127:         unset($server['HTTP_IF_MODIFIED_SINCE']);",
      "128:         unset($server['HTTP_IF_NONE_MATCH']);",
      "",
      "[Removed Lines]",
      "115:         try {",
      "116:             if ($trustedHeaderName = Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
      "117:                 $currentXForwardedFor = $request->headers->get($trustedHeaderName, '');",
      "119:                 $server['HTTP_'.$trustedHeaderName] = ($currentXForwardedFor ? $currentXForwardedFor.', ' : '').$request->getClientIp();",
      "120:             }",
      "121:         } catch (\\InvalidArgumentException $e) {",
      "123:         }",
      "125:         $server['REMOTE_ADDR'] = $this->resolveTrustedProxy();",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "139:         return $subRequest;",
      "140:     }",
      "",
      "[Removed Lines]",
      "142:     private function resolveTrustedProxy()",
      "143:     {",
      "144:         if (!$trustedProxies = Request::getTrustedProxies()) {",
      "145:             return '127.0.0.1';",
      "146:         }",
      "148:         $firstTrustedProxy = reset($trustedProxies);",
      "150:         return false !== ($i = strpos($firstTrustedProxy, '/')) ? substr($firstTrustedProxy, 0, $i) : $firstTrustedProxy;",
      "151:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php": [
      "File: src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php -> src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "468:             $this->surrogate->addSurrogateCapability($request);",
      "469:         }",
      "494:         if (null !== $entry && \\in_array($response->getStatusCode(), array(500, 502, 503, 504))) {",
      "",
      "[Removed Lines]",
      "472:         $forwardedFor = $request->headers->get('X-Forwarded-For');",
      "473:         if ($forwardedFor) {",
      "474:             $request->headers->set('X-Forwarded-For', $forwardedFor.', '.$request->server->get('REMOTE_ADDR'));",
      "475:         } else {",
      "476:             $request->headers->set('X-Forwarded-For', $request->server->get('REMOTE_ADDR'));",
      "477:         }",
      "481:         $request->server->set('REMOTE_ADDR', '127.0.0.1');",
      "484:         if (!\\in_array('127.0.0.1', $trustedProxies = Request::getTrustedProxies())) {",
      "485:             $trustedProxies[] = '127.0.0.1';",
      "486:             Request::setTrustedProxies($trustedProxies);",
      "487:         }",
      "490:         $response = $this->kernel->handle($request, HttpKernelInterface::MASTER_REQUEST, $catch);",
      "",
      "[Added Lines]",
      "472:         $response = SubRequestHandler::handle($this->kernel, $request, HttpKernelInterface::MASTER_REQUEST, $catch);",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php": [
      "File: src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php -> src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "12: namespace Symfony\\Component\\HttpKernel\\HttpCache;",
      "14: use Symfony\\Component\\HttpFoundation\\IpUtils;",
      "15: use Symfony\\Component\\HttpFoundation\\Request;",
      "16: use Symfony\\Component\\HttpFoundation\\Response;",
      "17: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
      "24: class SubRequestHandler",
      "25: {",
      "29:     public static function handle(HttpKernelInterface $kernel, Request $request, $type, $catch)",
      "30:     {",
      "32:         $trustedProxies = Request::getTrustedProxies();",
      "33:         $trustedHeaders = array(",
      "34:             Request::HEADER_FORWARDED => Request::getTrustedHeaderName(Request::HEADER_FORWARDED),",
      "35:             Request::HEADER_CLIENT_IP => Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP),",
      "36:             Request::HEADER_CLIENT_HOST => Request::getTrustedHeaderName(Request::HEADER_CLIENT_HOST),",
      "37:             Request::HEADER_CLIENT_PROTO => Request::getTrustedHeaderName(Request::HEADER_CLIENT_PROTO),",
      "38:             Request::HEADER_CLIENT_PORT => Request::getTrustedHeaderName(Request::HEADER_CLIENT_PORT),",
      "39:         );",
      "42:         $remoteAddr = $request->server->get('REMOTE_ADDR');",
      "43:         if (!IpUtils::checkIp($remoteAddr, $trustedProxies)) {",
      "44:             foreach (array_filter($trustedHeaders) as $name) {",
      "45:                 $request->headers->remove($name);",
      "46:             }",
      "47:         }",
      "50:         $trustedIps = array();",
      "51:         $trustedValues = array();",
      "52:         foreach (array_reverse($request->getClientIps()) as $ip) {",
      "53:             $trustedIps[] = $ip;",
      "54:             $trustedValues[] = sprintf('for=\"%s\"', $ip);",
      "55:         }",
      "56:         if ($ip !== $remoteAddr) {",
      "57:             $trustedIps[] = $remoteAddr;",
      "58:             $trustedValues[] = sprintf('for=\"%s\"', $remoteAddr);",
      "59:         }",
      "62:         if ($name = $trustedHeaders[Request::HEADER_FORWARDED]) {",
      "63:             $trustedValues[0] .= sprintf(';host=\"%s\";proto=%s', $request->getHttpHost(), $request->getScheme());",
      "64:             $request->headers->set($name, implode(', ', $trustedValues));",
      "65:         }",
      "66:         if ($name = $trustedHeaders[Request::HEADER_CLIENT_IP]) {",
      "67:             $request->headers->set($name, implode(', ', $trustedIps));",
      "68:         }",
      "69:         if (!$name && !$trustedHeaders[Request::HEADER_FORWARDED]) {",
      "70:             $request->headers->set('X-Forwarded-For', implode(', ', $trustedIps));",
      "71:             Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, 'X_FORWARDED_FOR');",
      "72:         }",
      "76:         $request->server->set('REMOTE_ADDR', '127.0.0.1');",
      "79:         if (!IpUtils::checkIp('127.0.0.1', $trustedProxies)) {",
      "80:             Request::setTrustedProxies(array_merge($trustedProxies, array('127.0.0.1')));",
      "81:         }",
      "83:         try {",
      "84:             $e = null;",
      "85:             $response = $kernel->handle($request, $type, $catch);",
      "86:         } catch (\\Throwable $e) {",
      "87:         } catch (\\Exception $e) {",
      "88:         }",
      "91:         Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, $trustedHeaders[Request::HEADER_CLIENT_IP]);",
      "92:         Request::setTrustedProxies($trustedProxies);",
      "94:         if (null !== $e) {",
      "95:             throw $e;",
      "96:         }",
      "98:         return $response;",
      "99:     }",
      "100: }",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php": [
      "File: src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php -> src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27:     protected function setUp()",
      "28:     {",
      "30:     }",
      "32:     protected function tearDown()",
      "33:     {",
      "35:     }",
      "37:     public function testRender()",
      "",
      "[Removed Lines]",
      "29:         $this->originalTrustedHeaderName = Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP);",
      "34:         Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, $this->originalTrustedHeaderName);",
      "",
      "[Added Lines]",
      "29:         $this->originalTrustedHeaderNames = array(",
      "30:             Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP),",
      "31:             Request::getTrustedHeaderName(Request::HEADER_FORWARDED),",
      "32:         );",
      "37:         Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, $this->originalTrustedHeaderNames[0]);",
      "38:         Request::setTrustedHeaderName(Request::HEADER_FORWARDED, $this->originalTrustedHeaderNames[1]);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "55:         $subRequest = Request::create('/_fragment?_path=_format%3Dhtml%26_locale%3Den%26_controller%3Dmain_controller');",
      "56:         $subRequest->attributes->replace(array('object' => $object, '_format' => 'html', '_controller' => 'main_controller', '_locale' => 'en'));",
      "57:         $subRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "60:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($subRequest));",
      "",
      "[Removed Lines]",
      "58:         $subRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
      "",
      "[Added Lines]",
      "62:         $subRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "83:     public function testRenderWithTrustedHeaderDisabled()",
      "84:     {",
      "85:         Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, '');",
      "88:         $this->assertSame('foo', $strategy->render('/', Request::create('/'))->getContent());",
      "89:     }",
      "",
      "[Removed Lines]",
      "87:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest(Request::create('/')));",
      "",
      "[Added Lines]",
      "90:         Request::setTrustedHeaderName(Request::HEADER_FORWARDED, '');",
      "92:         $expectedSubRequest = Request::create('/');",
      "93:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "95:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "168:     {",
      "169:         $expectedSubRequest = Request::create('/');",
      "170:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
      "172:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
      "173:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "175:         }",
      "177:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
      "",
      "[Removed Lines]",
      "174:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
      "",
      "[Added Lines]",
      "182:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "194:     public function testHeadersPossiblyResultingIn304AreNotAssignedToSubrequest()",
      "195:     {",
      "196:         $expectedSubRequest = Request::create('/');",
      "202:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
      "203:         $request = Request::create('/', 'GET', array(), array(), array(), array('HTTP_IF_MODIFIED_SINCE' => 'Fri, 01 Jan 2016 00:00:00 GMT', 'HTTP_IF_NONE_MATCH' => '*'));",
      "",
      "[Removed Lines]",
      "197:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
      "198:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "199:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
      "200:         }",
      "",
      "[Added Lines]",
      "204:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "205:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "208:     {",
      "209:         $expectedSubRequest = Request::create('/');",
      "210:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
      "218:         Request::setTrustedProxies(array('1.1.1.1'));",
      "",
      "[Removed Lines]",
      "211:         $expectedSubRequest->server->set('REMOTE_ADDR', '1.1.1.1');",
      "213:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
      "214:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "215:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
      "216:         }",
      "",
      "[Added Lines]",
      "216:         $expectedSubRequest->server->set('REMOTE_ADDR', '127.0.0.1');",
      "217:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "218:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "230:     {",
      "231:         $expectedSubRequest = Request::create('/');",
      "232:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
      "234:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
      "237:         Request::setTrustedProxies(array('1.1.1.1/24'));",
      "",
      "[Removed Lines]",
      "233:         $expectedSubRequest->server->set('REMOTE_ADDR', '1.1.1.1');",
      "235:         $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
      "",
      "[Added Lines]",
      "235:         $expectedSubRequest->server->set('REMOTE_ADDR', '127.0.0.1');",
      "237:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php": [
      "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1303:         $this->setNextResponse();",
      "1304:         $this->request('GET', '/', array('REMOTE_ADDR' => '10.0.0.1'));",
      "1307:     }",
      "1313:     {",
      "1314:         Request::setTrustedProxies($existing);",
      "1316:         $this->setNextResponse();",
      "1317:         $this->request('GET', '/', array('REMOTE_ADDR' => '10.0.0.1'));",
      "1321:         Request::setTrustedProxies(array());",
      "1322:     }",
      "",
      "[Removed Lines]",
      "1306:         $this->assertEquals('127.0.0.1', $this->kernel->getBackendRequest()->server->get('REMOTE_ADDR'));",
      "1312:     public function testHttpCacheIsSetAsATrustedProxy(array $existing, array $expected)",
      "1319:         $this->assertEquals($expected, Request::getTrustedProxies());",
      "",
      "[Added Lines]",
      "1306:         $that = $this;",
      "1307:         $this->kernel->assert(function ($backendRequest) use ($that) {",
      "1308:             $that->assertSame('127.0.0.1', $backendRequest->server->get('REMOTE_ADDR'));",
      "1309:         });",
      "1315:     public function testHttpCacheIsSetAsATrustedProxy(array $existing)",
      "1321:         $this->assertSame($existing, Request::getTrustedProxies());",
      "1323:         $that = $this;",
      "1324:         $existing = array_unique(array_merge($existing, array('127.0.0.1')));",
      "1325:         $this->kernel->assert(function ($backendRequest) use ($existing, $that) {",
      "1326:             $that->assertSame($existing, Request::getTrustedProxies());",
      "1327:             $that->assertsame('10.0.0.1', $backendRequest->getClientIp());",
      "1328:         });",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1324:     public function getTrustedProxyData()",
      "1325:     {",
      "1326:         return array(",
      "1330:         );",
      "1331:     }",
      "1337:     {",
      "1338:         $this->setNextResponse();",
      "1339:         $server = array('REMOTE_ADDR' => '10.0.0.1');",
      "1342:         }",
      "1343:         $this->request('GET', '/', $server);",
      "1346:     }",
      "1349:     {",
      "1350:         return array(",
      "1354:         );",
      "1355:     }",
      "1366:     public function testEsiCacheRemoveValidationHeadersIfEmbeddedResponses()",
      "1367:     {",
      "1368:         $time = \\DateTime::createFromFormat('U', time());",
      "",
      "[Removed Lines]",
      "1327:             array(array(), array('127.0.0.1')),",
      "1328:             array(array('10.0.0.2'), array('10.0.0.2', '127.0.0.1')),",
      "1329:             array(array('10.0.0.2', '127.0.0.1'), array('10.0.0.2', '127.0.0.1')),",
      "1336:     public function testXForwarderForHeaderForForwardedRequests($xForwardedFor, $expected)",
      "1340:         if (false !== $xForwardedFor) {",
      "1341:             $server['HTTP_X_FORWARDED_FOR'] = $xForwardedFor;",
      "1345:         $this->assertEquals($expected, $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For'));",
      "1348:     public function getXForwardedForData()",
      "1351:             array(false, '10.0.0.1'),",
      "1352:             array('10.0.0.2', '10.0.0.2, 10.0.0.1'),",
      "1353:             array('10.0.0.2, 10.0.0.3', '10.0.0.2, 10.0.0.3, 10.0.0.1'),",
      "1357:     public function testXForwarderForHeaderForPassRequests()",
      "1358:     {",
      "1359:         $this->setNextResponse();",
      "1360:         $server = array('REMOTE_ADDR' => '10.0.0.1');",
      "1361:         $this->request('POST', '/', $server);",
      "1363:         $this->assertEquals('10.0.0.1', $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For'));",
      "1364:     }",
      "",
      "[Added Lines]",
      "1336:             array(array()),",
      "1337:             array(array('10.0.0.2')),",
      "1338:             array(array('10.0.0.2', '127.0.0.1')),",
      "1345:     public function testForwarderHeaderForForwardedRequests($forwarded, $expected)",
      "1349:         if (null !== $forwarded) {",
      "1350:             Request::setTrustedProxies($server);",
      "1351:             $server['HTTP_FORWARDED'] = $forwarded;",
      "1355:         $that = $this;",
      "1356:         $this->kernel->assert(function ($backendRequest) use ($expected, $that) {",
      "1357:             $that->assertSame($expected, $backendRequest->headers->get('Forwarded'));",
      "1358:         });",
      "1360:         Request::setTrustedProxies(array());",
      "1363:     public function getForwardedData()",
      "1366:             array(null, 'for=\"10.0.0.1\";host=\"localhost\";proto=http'),",
      "1367:             array('for=10.0.0.2', 'for=\"10.0.0.2\";host=\"localhost\";proto=http, for=\"10.0.0.1\"'),",
      "1368:             array('for=10.0.0.2, for=10.0.0.3', 'for=\"10.0.0.2\";host=\"localhost\";proto=http, for=\"10.0.0.3\", for=\"10.0.0.1\"'),",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php": [
      "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "12: namespace Symfony\\Component\\HttpKernel\\Tests\\HttpCache;",
      "14: use PHPUnit\\Framework\\TestCase;",
      "15: use Symfony\\Component\\HttpFoundation\\Request;",
      "16: use Symfony\\Component\\HttpFoundation\\Response;",
      "17: use Symfony\\Component\\HttpKernel\\HttpCache\\SubRequestHandler;",
      "18: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
      "20: class SubRequestHandlerTest extends TestCase",
      "21: {",
      "22:     private static $globalState;",
      "24:     protected function setUp()",
      "25:     {",
      "26:         self::$globalState = $this->getGlobalState();",
      "27:     }",
      "29:     protected function tearDown()",
      "30:     {",
      "31:         foreach (self::$globalState[1] as $key => $name) {",
      "32:             Request::setTrustedHeaderName($key, $name);",
      "33:         }",
      "34:         Request::setTrustedProxies(self::$globalState[0]);",
      "35:     }",
      "37:     public function testTrustedHeadersAreKept()",
      "38:     {",
      "39:         Request::setTrustedProxies(array('10.0.0.1'));",
      "40:         $globalState = $this->getGlobalState();",
      "42:         $request = Request::create('/');",
      "43:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
      "44:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
      "45:         $request->headers->set('X-Forwarded-Host', 'Good');",
      "46:         $request->headers->set('X-Forwarded-Port', '1234');",
      "47:         $request->headers->set('X-Forwarded-Proto', 'https');",
      "49:         $that = $this;",
      "50:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) use ($that) {",
      "51:             $that->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
      "52:             $that->assertSame('10.0.0.2', $request->getClientIp());",
      "53:             $that->assertSame('Good', $request->headers->get('X-Forwarded-Host'));",
      "54:             $that->assertSame('1234', $request->headers->get('X-Forwarded-Port'));",
      "55:             $that->assertSame('https', $request->headers->get('X-Forwarded-Proto'));",
      "56:         });",
      "58:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
      "60:         $this->assertSame($globalState, $this->getGlobalState());",
      "61:     }",
      "63:     public function testUntrustedHeadersAreRemoved()",
      "64:     {",
      "65:         $request = Request::create('/');",
      "66:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
      "67:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
      "68:         $request->headers->set('X-Forwarded-Host', 'Evil');",
      "69:         $request->headers->set('X-Forwarded-Port', '1234');",
      "70:         $request->headers->set('X-Forwarded-Proto', 'http');",
      "71:         $request->headers->set('Forwarded', 'Evil2');",
      "73:         $that = $this;",
      "74:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) use ($that) {",
      "75:             $that->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
      "76:             $that->assertSame('10.0.0.1', $request->getClientIp());",
      "77:             $that->assertFalse($request->headers->has('X-Forwarded-Host'));",
      "78:             $that->assertFalse($request->headers->has('X-Forwarded-Port'));",
      "79:             $that->assertFalse($request->headers->has('X-Forwarded-Proto'));",
      "80:             $that->assertSame('for=\"10.0.0.1\";host=\"localhost\";proto=http', $request->headers->get('Forwarded'));",
      "81:         });",
      "83:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
      "85:         $this->assertSame(self::$globalState, $this->getGlobalState());",
      "86:     }",
      "88:     public function testTrustedForwardedHeader()",
      "89:     {",
      "90:         Request::setTrustedProxies(array('10.0.0.1'));",
      "91:         $globalState = $this->getGlobalState();",
      "93:         $request = Request::create('/');",
      "94:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
      "95:         $request->headers->set('Forwarded', 'for=\"10.0.0.2\";host=\"foo.bar\";proto=https');",
      "96:         $request->headers->set('X-Forwarded-Host', 'foo.bar');",
      "97:         $request->headers->set('X-Forwarded-Proto', 'https');",
      "99:         $that = $this;",
      "100:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) use ($that) {",
      "101:             $that->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
      "102:             $that->assertSame('10.0.0.2', $request->getClientIp());",
      "103:             $that->assertSame('foo.bar', $request->getHttpHost());",
      "104:             $that->assertSame('https', $request->getScheme());",
      "105:             $that->assertSame(443, $request->getPort());",
      "106:         });",
      "108:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
      "110:         $this->assertSame($globalState, $this->getGlobalState());",
      "111:     }",
      "113:     public function testTrustedXForwardedForHeader()",
      "114:     {",
      "115:         Request::setTrustedProxies(array('10.0.0.1'));",
      "116:         $globalState = $this->getGlobalState();",
      "118:         $request = Request::create('/');",
      "119:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
      "120:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
      "121:         $request->headers->set('X-Forwarded-Host', 'foo.bar');",
      "122:         $request->headers->set('X-Forwarded-Proto', 'https');",
      "124:         $that = $this;",
      "125:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) use ($that) {",
      "126:             $that->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
      "127:             $that->assertSame('10.0.0.2', $request->getClientIp());",
      "128:             $that->assertSame('foo.bar', $request->getHttpHost());",
      "129:             $that->assertSame('https', $request->getScheme());",
      "130:         });",
      "132:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
      "134:         $this->assertSame($globalState, $this->getGlobalState());",
      "135:     }",
      "137:     private function getGlobalState()",
      "138:     {",
      "139:         return array(",
      "140:             Request::getTrustedProxies(),",
      "141:             array(",
      "142:                 Request::HEADER_FORWARDED => Request::getTrustedHeaderName(Request::HEADER_FORWARDED),",
      "143:                 Request::HEADER_CLIENT_IP => Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP),",
      "144:                 Request::HEADER_CLIENT_HOST => Request::getTrustedHeaderName(Request::HEADER_CLIENT_HOST),",
      "145:                 Request::HEADER_CLIENT_PROTO => Request::getTrustedHeaderName(Request::HEADER_CLIENT_PROTO),",
      "146:                 Request::HEADER_CLIENT_PORT => Request::getTrustedHeaderName(Request::HEADER_CLIENT_PORT),",
      "147:             ),",
      "148:         );",
      "149:     }",
      "150: }",
      "152: class TestSubRequestHandlerKernel implements HttpKernelInterface",
      "153: {",
      "154:     private $assertCallback;",
      "156:     public function __construct(\\Closure $assertCallback)",
      "157:     {",
      "158:         $this->assertCallback = $assertCallback;",
      "159:     }",
      "161:     public function handle(Request $request, $type = self::MASTER_REQUEST, $catch = true)",
      "162:     {",
      "163:         $assertCallback = $this->assertCallback;",
      "164:         $assertCallback($request, $type, $catch);",
      "166:         return new Response();",
      "167:     }",
      "168: }",
      "",
      "---------------"
    ],
    "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php": [
      "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:         $this->status = $status;",
      "35:         $this->headers = $headers;",
      "36:         $this->customizer = $customizer;",
      "38:         parent::__construct(new EventDispatcher(), $this);",
      "39:     }",
      "42:     {",
      "44:     }",
      "46:     public function handle(Request $request, $type = HttpKernelInterface::MASTER_REQUEST, $catch = false)",
      "47:     {",
      "48:         $this->catch = $catch;",
      "51:         return parent::handle($request, $type, $catch);",
      "52:     }",
      "",
      "[Removed Lines]",
      "41:     public function getBackendRequest()",
      "43:         return $this->backendRequest;",
      "49:         $this->backendRequest = $request;",
      "",
      "[Added Lines]",
      "37:         $this->trustedHeadersReflector = new \\ReflectionProperty('Symfony\\Component\\HttpFoundation\\Request', 'trustedHeaders');",
      "38:         $this->trustedHeadersReflector->setAccessible(true);",
      "43:     public function assert(\\Closure $callback)",
      "45:         $trustedConfig = array(Request::getTrustedProxies(), $this->trustedHeadersReflector->getValue());",
      "47:         list($trustedProxies, $trustedHeaders, $backendRequest) = $this->backendRequest;",
      "48:         Request::setTrustedProxies($trustedProxies);",
      "49:         $this->trustedHeadersReflector->setValue(null, $trustedHeaders);",
      "51:         try {",
      "52:             $e = null;",
      "53:             $callback($backendRequest);",
      "54:         } catch (\\Throwable $e) {",
      "55:         } catch (\\Exception $e) {",
      "56:         }",
      "58:         list($trustedProxies, $trustedHeaders) = $trustedConfig;",
      "59:         Request::setTrustedProxies($trustedProxies);",
      "60:         $this->trustedHeadersReflector->setValue(null, $trustedHeaders);",
      "62:         if (null !== $e) {",
      "63:             throw $e;",
      "64:         }",
      "70:         $this->backendRequest = array($request::getTrustedProxies(), $this->trustedHeadersReflector->getValue(), $request);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "efe9beb1863f6a80fb975200c8dd6227d8f2befc",
      "candidate_info": {
        "commit_hash": "efe9beb1863f6a80fb975200c8dd6227d8f2befc",
        "repo": "symfony/symfony",
        "commit_url": "https://github.com/symfony/symfony/commit/efe9beb1863f6a80fb975200c8dd6227d8f2befc",
        "files": [
          "src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php",
          "src/Symfony/Component/HttpFoundation/Tests/RequestTest.php",
          "src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php",
          "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php"
        ],
        "message": "[HttpKernel] Fix restoring trusted proxies in tests",
        "before_after_code_files": [
          "src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php||src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php",
          "src/Symfony/Component/HttpFoundation/Tests/RequestTest.php||src/Symfony/Component/HttpFoundation/Tests/RequestTest.php",
          "src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php||src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php",
          "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php||src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php"
          ],
          "candidate": [
            "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php||src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php": [
          "File: src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php -> src/Symfony/Bridge/Monolog/Tests/Processor/WebProcessorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:         $this->assertEquals($server['REQUEST_METHOD'], $record['extra']['http_method']);",
          "50:         $this->assertEquals($server['SERVER_NAME'], $record['extra']['server']);",
          "51:         $this->assertEquals($server['HTTP_REFERER'], $record['extra']['referrer']);",
          "52:     }",
          "54:     public function testCanBeConstructedWithExtraFields()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53:         Request::setTrustedProxies(array());",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpFoundation/Tests/RequestTest.php||src/Symfony/Component/HttpFoundation/Tests/RequestTest.php": [
          "File: src/Symfony/Component/HttpFoundation/Tests/RequestTest.php -> src/Symfony/Component/HttpFoundation/Tests/RequestTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: {",
          "21:     protected function tearDown()",
          "22:     {",
          "23:         Request::setTrustedHosts(array());",
          "24:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23:         Request::setTrustedProxies(array());",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "750:         ));",
          "751:         $port = $request->getPort();",
          "752:         $this->assertEquals(80, $port, 'With only PROTO set and value is not recognized, getPort() defaults to 80.');",
          "755:     }",
          "",
          "[Removed Lines]",
          "754:         Request::setTrustedProxies(array());",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "827:         $request = $this->getRequestInstanceForClientIpTests($remoteAddr, $httpForwardedFor, $trustedProxies);",
          "829:         $this->assertEquals($expected[0], $request->getClientIp());",
          "832:     }",
          "",
          "[Removed Lines]",
          "831:         Request::setTrustedProxies(array());",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "839:         $request = $this->getRequestInstanceForClientIpTests($remoteAddr, $httpForwardedFor, $trustedProxies);",
          "841:         $this->assertEquals($expected, $request->getClientIps());",
          "844:     }",
          "",
          "[Removed Lines]",
          "843:         Request::setTrustedProxies(array());",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "851:         $request = $this->getRequestInstanceForClientIpsForwardedTests($remoteAddr, $httpForwarded, $trustedProxies);",
          "853:         $this->assertEquals($expected, $request->getClientIps());",
          "856:     }",
          "858:     public function getClientIpsForwardedProvider()",
          "",
          "[Removed Lines]",
          "855:         Request::setTrustedProxies(array());",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "976:         $clientIps = $request->getClientIps();",
          "980:         $this->assertSame($expectedIps, $clientIps);",
          "981:     }",
          "",
          "[Removed Lines]",
          "978:         Request::setTrustedProxies(array());",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php||src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php -> src/Symfony/Component/HttpKernel/Tests/EventListener/ValidateRequestListenerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: class ValidateRequestListenerTest extends TestCase",
          "23: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24:     protected function tearDown()",
          "25:     {",
          "26:         Request::setTrustedProxies(array());",
          "27:     }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php -> src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:         $subRequest->attributes->replace(array('object' => $object, '_format' => 'html', '_controller' => 'main_controller', '_locale' => 'en'));",
          "57:         $subRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "58:         $subRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "61:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($subRequest));",
          "",
          "[Removed Lines]",
          "59:         $subRequest->server->set('REMOTE_ADDR', '1.1.1.1');",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "85:     {",
          "86:         Request::setTrustedHeaderName(Request::HEADER_CLIENT_IP, '');",
          "89:         $this->assertSame('foo', $strategy->render('/', Request::create('/'))->getContent());",
          "90:     }",
          "",
          "[Removed Lines]",
          "88:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest(Request::create('/', 'GET', array(), array(), array(), array('REMOTE_ADDR' => '1.1.1.1'))));",
          "",
          "[Added Lines]",
          "87:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest(Request::create('/')));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "169:     {",
          "170:         $expectedSubRequest = Request::create('/');",
          "171:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "174:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
          "175:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "",
          "[Removed Lines]",
          "172:         $expectedSubRequest->server->set('REMOTE_ADDR', '1.1.1.1');",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "196:     public function testHeadersPossiblyResultingIn304AreNotAssignedToSubrequest()",
          "197:     {",
          "199:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
          "200:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "201:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "",
          "[Removed Lines]",
          "198:         $expectedSubRequest = Request::create('/', 'GET', array(), array(), array(), array('REMOTE_ADDR' => '1.1.1.1'));",
          "",
          "[Added Lines]",
          "196:         $expectedSubRequest = Request::create('/');",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "206:         $strategy->render('/', $request);",
          "207:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "207:     public function testFirstTrustedProxyIsSetAsRemote()",
          "208:     {",
          "209:         $expectedSubRequest = Request::create('/');",
          "210:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "211:         $expectedSubRequest->server->set('REMOTE_ADDR', '1.1.1.1');",
          "213:         if (Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP)) {",
          "214:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "215:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "216:         }",
          "218:         Request::setTrustedProxies(array('1.1.1.1'));",
          "220:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "222:         $request = Request::create('/');",
          "223:         $request->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "224:         $strategy->render('/', $request);",
          "226:         Request::setTrustedProxies(array());",
          "227:     }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1315:         $this->request('GET', '/', array('REMOTE_ADDR' => '10.0.0.1'));",
          "1317:         $this->assertEquals($expected, Request::getTrustedProxies());",
          "1318:     }",
          "1320:     public function getTrustedProxyData()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1319:         Request::setTrustedProxies(array());",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php||src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpKernelTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "291:         $request->headers->set('X_FORWARDED_FOR', '3.3.3.3');",
          "293:         $kernel->handle($request, $kernel::MASTER_REQUEST, false);",
          "294:     }",
          "296:     protected function getResolver($controller = null)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "295:         Request::setTrustedProxies(array());",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7f912bbb78377c2ea331b3da28363435fbd91337",
      "candidate_info": {
        "commit_hash": "7f912bbb78377c2ea331b3da28363435fbd91337",
        "repo": "symfony/symfony",
        "commit_url": "https://github.com/symfony/symfony/commit/7f912bbb78377c2ea331b3da28363435fbd91337",
        "files": [
          "src/Symfony/Component/HttpFoundation/Request.php",
          "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
          "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
          "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
          "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
        ],
        "message": "[HttpKernel] fix trusted headers management in HttpCache and InlineFragmentRenderer",
        "before_after_code_files": [
          "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php",
          "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
          "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
          "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
          "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
          "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php",
            "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
            "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
            "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
            "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
          ],
          "candidate": [
            "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php",
            "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
            "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
            "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
            "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
            "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Symfony/Component/HttpFoundation/Request.php||src/Symfony/Component/HttpFoundation/Request.php": [
          "File: src/Symfony/Component/HttpFoundation/Request.php -> src/Symfony/Component/HttpFoundation/Request.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2060:         if (self::$trustedHeaders[self::HEADER_FORWARDED] && $this->headers->has(self::$trustedHeaders[self::HEADER_FORWARDED])) {",
          "2061:             $forwardedValues = $this->headers->get(self::$trustedHeaders[self::HEADER_FORWARDED]);",
          "2062:             $forwardedValues = preg_match_all(sprintf('{(?:%s)=(?:\"?\\[?)([a-zA-Z0-9\\.:_\\-/]*+)}', self::$forwardedParams[$type]), $forwardedValues, $matches) ? $matches[1] : array();",
          "2063:         }",
          "2065:         if (null !== $ip) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2063:             if (self::HEADER_CLIENT_PORT === $type) {",
          "2064:                 foreach ($forwardedValues as $k => $v) {",
          "2065:                     $forwardedValues[$k] = substr_replace($v, '0.0.0.0', 0, strrpos($v, ':'));",
          "2066:                 }",
          "2067:             }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php||src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php": [
          "File: src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php -> src/Symfony/Component/HttpKernel/Fragment/InlineFragmentRenderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: use Symfony\\Component\\HttpFoundation\\Request;",
          "15: use Symfony\\Component\\HttpFoundation\\Response;",
          "16: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
          "17: use Symfony\\Component\\HttpKernel\\Controller\\ControllerReference;",
          "18: use Symfony\\Component\\HttpKernel\\KernelEvents;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "16: use Symfony\\Component\\HttpKernel\\HttpCache\\SubRequestHandler;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77:         $level = ob_get_level();",
          "78:         try {",
          "80:         } catch (\\Exception $e) {",
          "",
          "[Removed Lines]",
          "79:             return $this->kernel->handle($subRequest, HttpKernelInterface::SUB_REQUEST, false);",
          "",
          "[Added Lines]",
          "80:             return SubRequestHandler::handle($this->kernel, $subRequest, HttpKernelInterface::SUB_REQUEST, false);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "109:         $cookies = $request->cookies->all();",
          "110:         $server = $request->server->all();",
          "130:         unset($server['HTTP_IF_MODIFIED_SINCE']);",
          "131:         unset($server['HTTP_IF_NONE_MATCH']);",
          "",
          "[Removed Lines]",
          "115:         try {",
          "116:             if (Request::HEADER_X_FORWARDED_FOR & Request::getTrustedHeaderSet()) {",
          "117:                 $currentXForwardedFor = $request->headers->get('X_FORWARDED_FOR', '');",
          "119:                 $server['HTTP_X_FORWARDED_FOR'] = ($currentXForwardedFor ? $currentXForwardedFor.', ' : '').$request->getClientIp();",
          "120:             } elseif (method_exists(Request::class, 'getTrustedHeaderName') && $trustedHeaderName = Request::getTrustedHeaderName(Request::HEADER_CLIENT_IP, false)) {",
          "121:                 $currentXForwardedFor = $request->headers->get($trustedHeaderName, '');",
          "123:                 $server['HTTP_'.$trustedHeaderName] = ($currentXForwardedFor ? $currentXForwardedFor.', ' : '').$request->getClientIp();",
          "124:             }",
          "125:         } catch (\\InvalidArgumentException $e) {",
          "127:         }",
          "129:         $server['REMOTE_ADDR'] = '127.0.0.1';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php||src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php": [
          "File: src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php -> src/Symfony/Component/HttpKernel/HttpCache/HttpCache.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "440:             $this->surrogate->addSurrogateCapability($request);",
          "441:         }",
          "466:         if (null !== $entry && in_array($response->getStatusCode(), array(500, 502, 503, 504))) {",
          "",
          "[Removed Lines]",
          "444:         $forwardedFor = $request->headers->get('X-Forwarded-For');",
          "445:         if ($forwardedFor) {",
          "446:             $request->headers->set('X-Forwarded-For', $forwardedFor.', '.$request->server->get('REMOTE_ADDR'));",
          "447:         } else {",
          "448:             $request->headers->set('X-Forwarded-For', $request->server->get('REMOTE_ADDR'));",
          "449:         }",
          "453:         $request->server->set('REMOTE_ADDR', '127.0.0.1');",
          "456:         if (!in_array('127.0.0.1', $trustedProxies = Request::getTrustedProxies())) {",
          "457:             $trustedProxies[] = '127.0.0.1';",
          "458:             Request::setTrustedProxies($trustedProxies, Request::HEADER_X_FORWARDED_ALL);",
          "459:         }",
          "462:         $response = $this->kernel->handle($request, HttpKernelInterface::MASTER_REQUEST, $catch);",
          "",
          "[Added Lines]",
          "444:         $response = SubRequestHandler::handle($this->kernel, $request, HttpKernelInterface::MASTER_REQUEST, $catch);",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php||src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php": [
          "File: src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php -> src/Symfony/Component/HttpKernel/HttpCache/SubRequestHandler.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "12: namespace Symfony\\Component\\HttpKernel\\HttpCache;",
          "14: use Symfony\\Component\\HttpFoundation\\IpUtils;",
          "15: use Symfony\\Component\\HttpFoundation\\Request;",
          "16: use Symfony\\Component\\HttpFoundation\\Response;",
          "17: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
          "24: class SubRequestHandler",
          "25: {",
          "29:     public static function handle(HttpKernelInterface $kernel, Request $request, $type, $catch)",
          "30:     {",
          "32:         $trustedProxies = Request::getTrustedProxies();",
          "33:         $trustedHeaderSet = Request::getTrustedHeaderSet();",
          "34:         $trustedHeaders = array(",
          "35:             Request::HEADER_FORWARDED => Request::getTrustedHeaderName(Request::HEADER_FORWARDED, false),",
          "36:             Request::HEADER_X_FORWARDED_FOR => Request::getTrustedHeaderName(Request::HEADER_X_FORWARDED_FOR, false),",
          "37:             Request::HEADER_X_FORWARDED_HOST => Request::getTrustedHeaderName(Request::HEADER_X_FORWARDED_HOST, false),",
          "38:             Request::HEADER_X_FORWARDED_PROTO => Request::getTrustedHeaderName(Request::HEADER_X_FORWARDED_PROTO, false),",
          "39:             Request::HEADER_X_FORWARDED_PORT => Request::getTrustedHeaderName(Request::HEADER_X_FORWARDED_PORT, false),",
          "40:         );",
          "43:         $remoteAddr = $request->server->get('REMOTE_ADDR');",
          "44:         if (!IpUtils::checkIp($remoteAddr, $trustedProxies)) {",
          "45:             foreach (array_filter($trustedHeaders) as $name) {",
          "46:                 $request->headers->remove($name);",
          "47:             }",
          "48:         }",
          "51:         $trustedIps = array();",
          "52:         $trustedValues = array();",
          "53:         foreach (array_reverse($request->getClientIps()) as $ip) {",
          "54:             $trustedIps[] = $ip;",
          "55:             $trustedValues[] = sprintf('for=\"%s\"', $ip);",
          "56:         }",
          "57:         if ($ip !== $remoteAddr) {",
          "58:             $trustedIps[] = $remoteAddr;",
          "59:             $trustedValues[] = sprintf('for=\"%s\"', $remoteAddr);",
          "60:         }",
          "63:         if ($name = $trustedHeaders[Request::HEADER_FORWARDED]) {",
          "64:             $trustedValues[0] .= sprintf(';host=\"%s\";proto=%s', $request->getHttpHost(), $request->getScheme());",
          "65:             $request->headers->set($name, implode(', ', $trustedValues));",
          "66:         }",
          "67:         if ($name = $trustedHeaders[Request::HEADER_X_FORWARDED_FOR]) {",
          "68:             $request->headers->set($name, implode(', ', $trustedIps));",
          "69:         }",
          "70:         if (!$name && !$trustedHeaders[Request::HEADER_FORWARDED]) {",
          "71:             Request::setTrustedProxies($trustedProxies, $trustedHeaderSet | Request::HEADER_X_FORWARDED_FOR);",
          "72:             $request->headers->set(Request::getTrustedHeaderName(Request::HEADER_X_FORWARDED_FOR, false), implode(', ', $trustedIps));",
          "73:         }",
          "77:         $request->server->set('REMOTE_ADDR', '127.0.0.1');",
          "80:         if (!IpUtils::checkIp('127.0.0.1', $trustedProxies)) {",
          "81:             Request::setTrustedProxies(array_merge($trustedProxies, array('127.0.0.1')), Request::getTrustedHeaderSet());",
          "82:         }",
          "84:         try {",
          "85:             return $kernel->handle($request, $type, $catch);",
          "86:         } finally {",
          "88:             Request::setTrustedProxies($trustedProxies, $trustedHeaderSet);",
          "89:         }",
          "90:     }",
          "91: }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php||src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php -> src/Symfony/Component/HttpKernel/Tests/Fragment/InlineFragmentRendererTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "46:         $subRequest = Request::create('/_fragment?_path=_format%3Dhtml%26_locale%3Den%26_controller%3Dmain_controller');",
          "47:         $subRequest->attributes->replace(array('object' => $object, '_format' => 'html', '_controller' => 'main_controller', '_locale' => 'en'));",
          "48:         $subRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "51:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($subRequest));",
          "",
          "[Removed Lines]",
          "49:         $subRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "",
          "[Added Lines]",
          "49:         $subRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "99:     {",
          "100:         Request::setTrustedProxies(array(), 0);",
          "103:         $this->assertSame('foo', $strategy->render('/', Request::create('/'))->getContent());",
          "105:         Request::setTrustedProxies(array(), -1);",
          "",
          "[Removed Lines]",
          "102:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest(Request::create('/')));",
          "",
          "[Added Lines]",
          "102:         $expectedSubRequest = Request::create('/');",
          "103:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "105:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "191:         if (Request::HEADER_X_FORWARDED_FOR & Request::getTrustedHeaderSet()) {",
          "192:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "194:         }",
          "196:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "",
          "[Removed Lines]",
          "193:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "",
          "[Added Lines]",
          "197:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "203:     public function testESIHeaderIsKeptInSubrequestWithTrustedHeaderDisabled()",
          "204:     {",
          "207:         $this->testESIHeaderIsKeptInSubrequest();",
          "",
          "[Removed Lines]",
          "205:         Request::setTrustedProxies(array(), 0);",
          "",
          "[Added Lines]",
          "208:         Request::setTrustedProxies(array(), Request::HEADER_FORWARDED);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "212:     public function testHeadersPossiblyResultingIn304AreNotAssignedToSubrequest()",
          "213:     {",
          "214:         $expectedSubRequest = Request::create('/');",
          "220:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "221:         $request = Request::create('/', 'GET', array(), array(), array(), array('HTTP_IF_MODIFIED_SINCE' => 'Fri, 01 Jan 2016 00:00:00 GMT', 'HTTP_IF_NONE_MATCH' => '*'));",
          "222:         $strategy->render('/', $request);",
          "223:     }",
          "",
          "[Removed Lines]",
          "215:         if (Request::HEADER_X_FORWARDED_FOR & Request::getTrustedHeaderSet()) {",
          "216:             $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "217:             $expectedSubRequest->server->set('HTTP_X_FORWARDED_FOR', '127.0.0.1');",
          "218:         }",
          "",
          "[Added Lines]",
          "218:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "219:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
          "226:     public function testFirstTrustedProxyIsSetAsRemote()",
          "227:     {",
          "228:         Request::setTrustedProxies(array('1.1.1.1'), -1);",
          "230:         $expectedSubRequest = Request::create('/');",
          "231:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "232:         $expectedSubRequest->server->set('REMOTE_ADDR', '127.0.0.1');",
          "233:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "234:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
          "236:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "238:         $request = Request::create('/');",
          "239:         $request->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "240:         $strategy->render('/', $request);",
          "242:         Request::setTrustedProxies(array(), -1);",
          "243:     }",
          "245:     public function testIpAddressOfRangedTrustedProxyIsSetAsRemote()",
          "246:     {",
          "247:         $expectedSubRequest = Request::create('/');",
          "248:         $expectedSubRequest->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "249:         $expectedSubRequest->server->set('REMOTE_ADDR', '127.0.0.1');",
          "250:         $expectedSubRequest->headers->set('x-forwarded-for', array('127.0.0.1'));",
          "251:         $expectedSubRequest->headers->set('forwarded', array('for=\"127.0.0.1\";host=\"localhost\";proto=http'));",
          "253:         Request::setTrustedProxies(array('1.1.1.1/24'), -1);",
          "255:         $strategy = new InlineFragmentRenderer($this->getKernelExpectingRequest($expectedSubRequest));",
          "257:         $request = Request::create('/');",
          "258:         $request->headers->set('Surrogate-Capability', 'abc=\"ESI/1.0\"');",
          "259:         $strategy->render('/', $request);",
          "261:         Request::setTrustedProxies(array(), -1);",
          "262:     }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/HttpCacheTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1336:         $this->setNextResponse();",
          "1337:         $this->request('GET', '/', array('REMOTE_ADDR' => '10.0.0.1'));",
          "1340:     }",
          "1346:     {",
          "1347:         Request::setTrustedProxies($existing, Request::HEADER_X_FORWARDED_ALL);",
          "1349:         $this->setNextResponse();",
          "1350:         $this->request('GET', '/', array('REMOTE_ADDR' => '10.0.0.1'));",
          "1353:     }",
          "1355:     public function getTrustedProxyData()",
          "1356:     {",
          "1357:         return array(",
          "1361:         );",
          "1362:     }",
          "1368:     {",
          "1369:         $this->setNextResponse();",
          "1370:         $server = array('REMOTE_ADDR' => '10.0.0.1');",
          "1373:         }",
          "1374:         $this->request('GET', '/', $server);",
          "1377:     }",
          "1380:     {",
          "1381:         return array(",
          "1385:         );",
          "1386:     }",
          "1397:     public function testEsiCacheRemoveValidationHeadersIfEmbeddedResponses()",
          "1398:     {",
          "1399:         $time = \\DateTime::createFromFormat('U', time());",
          "",
          "[Removed Lines]",
          "1339:         $this->assertEquals('127.0.0.1', $this->kernel->getBackendRequest()->server->get('REMOTE_ADDR'));",
          "1345:     public function testHttpCacheIsSetAsATrustedProxy(array $existing, array $expected)",
          "1352:         $this->assertEquals($expected, Request::getTrustedProxies());",
          "1358:             array(array(), array('127.0.0.1')),",
          "1359:             array(array('10.0.0.2'), array('10.0.0.2', '127.0.0.1')),",
          "1360:             array(array('10.0.0.2', '127.0.0.1'), array('10.0.0.2', '127.0.0.1')),",
          "1367:     public function testXForwarderForHeaderForForwardedRequests($xForwardedFor, $expected)",
          "1371:         if (false !== $xForwardedFor) {",
          "1372:             $server['HTTP_X_FORWARDED_FOR'] = $xForwardedFor;",
          "1376:         $this->assertEquals($expected, $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For'));",
          "1379:     public function getXForwardedForData()",
          "1382:             array(false, '10.0.0.1'),",
          "1383:             array('10.0.0.2', '10.0.0.2, 10.0.0.1'),",
          "1384:             array('10.0.0.2, 10.0.0.3', '10.0.0.2, 10.0.0.3, 10.0.0.1'),",
          "1388:     public function testXForwarderForHeaderForPassRequests()",
          "1389:     {",
          "1390:         $this->setNextResponse();",
          "1391:         $server = array('REMOTE_ADDR' => '10.0.0.1');",
          "1392:         $this->request('POST', '/', $server);",
          "1394:         $this->assertEquals('10.0.0.1', $this->kernel->getBackendRequest()->headers->get('X-Forwarded-For'));",
          "1395:     }",
          "",
          "[Added Lines]",
          "1339:         $this->kernel->assert(function ($backendRequest) {",
          "1340:             $this->assertSame('127.0.0.1', $backendRequest->server->get('REMOTE_ADDR'));",
          "1341:         });",
          "1347:     public function testHttpCacheIsSetAsATrustedProxy(array $existing)",
          "1353:         $this->assertSame($existing, Request::getTrustedProxies());",
          "1355:         $existing = array_unique(array_merge($existing, array('127.0.0.1')));",
          "1356:         $this->kernel->assert(function ($backendRequest) use ($existing) {",
          "1357:             $this->assertSame($existing, Request::getTrustedProxies());",
          "1358:             $this->assertsame('10.0.0.1', $backendRequest->getClientIp());",
          "1359:         });",
          "1361:         Request::setTrustedProxies(array(), -1);",
          "1367:             array(array()),",
          "1368:             array(array('10.0.0.2')),",
          "1369:             array(array('10.0.0.2', '127.0.0.1')),",
          "1376:     public function testForwarderHeaderForForwardedRequests($forwarded, $expected)",
          "1380:         if (null !== $forwarded) {",
          "1381:             Request::setTrustedProxies($server, -1);",
          "1382:             $server['HTTP_FORWARDED'] = $forwarded;",
          "1386:         $this->kernel->assert(function ($backendRequest) use ($expected) {",
          "1387:             $this->assertSame($expected, $backendRequest->headers->get('Forwarded'));",
          "1388:         });",
          "1390:         Request::setTrustedProxies(array(), -1);",
          "1393:     public function getForwardedData()",
          "1396:             array(null, 'for=\"10.0.0.1\";host=\"localhost\";proto=http'),",
          "1397:             array('for=10.0.0.2', 'for=\"10.0.0.2\";host=\"localhost\";proto=http, for=\"10.0.0.1\"'),",
          "1398:             array('for=10.0.0.2, for=10.0.0.3', 'for=\"10.0.0.2\";host=\"localhost\";proto=http, for=\"10.0.0.3\", for=\"10.0.0.1\"'),",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/SubRequestHandlerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "12: namespace Symfony\\Component\\HttpKernel\\Tests\\HttpCache;",
          "14: use PHPUnit\\Framework\\TestCase;",
          "15: use Symfony\\Component\\HttpFoundation\\Request;",
          "16: use Symfony\\Component\\HttpFoundation\\Response;",
          "17: use Symfony\\Component\\HttpKernel\\HttpCache\\SubRequestHandler;",
          "18: use Symfony\\Component\\HttpKernel\\HttpKernelInterface;",
          "20: class SubRequestHandlerTest extends TestCase",
          "21: {",
          "22:     private static $globalState;",
          "24:     protected function setUp()",
          "25:     {",
          "26:         self::$globalState = $this->getGlobalState();",
          "27:     }",
          "29:     protected function tearDown()",
          "30:     {",
          "31:         Request::setTrustedProxies(self::$globalState[0], self::$globalState[1]);",
          "32:     }",
          "34:     public function testTrustedHeadersAreKept()",
          "35:     {",
          "36:         Request::setTrustedProxies(array('10.0.0.1'), -1);",
          "37:         $globalState = $this->getGlobalState();",
          "39:         $request = Request::create('/');",
          "40:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
          "41:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
          "42:         $request->headers->set('X-Forwarded-Host', 'Good');",
          "43:         $request->headers->set('X-Forwarded-Port', '1234');",
          "44:         $request->headers->set('X-Forwarded-Proto', 'https');",
          "46:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) {",
          "47:             $this->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
          "48:             $this->assertSame('10.0.0.2', $request->getClientIp());",
          "49:             $this->assertSame('Good', $request->headers->get('X-Forwarded-Host'));",
          "50:             $this->assertSame('1234', $request->headers->get('X-Forwarded-Port'));",
          "51:             $this->assertSame('https', $request->headers->get('X-Forwarded-Proto'));",
          "52:         });",
          "54:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
          "56:         $this->assertSame($globalState, $this->getGlobalState());",
          "57:     }",
          "59:     public function testUntrustedHeadersAreRemoved()",
          "60:     {",
          "61:         $request = Request::create('/');",
          "62:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
          "63:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
          "64:         $request->headers->set('X-Forwarded-Host', 'Evil');",
          "65:         $request->headers->set('X-Forwarded-Port', '1234');",
          "66:         $request->headers->set('X-Forwarded-Proto', 'http');",
          "67:         $request->headers->set('Forwarded', 'Evil2');",
          "69:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) {",
          "70:             $this->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
          "71:             $this->assertSame('10.0.0.1', $request->getClientIp());",
          "72:             $this->assertFalse($request->headers->has('X-Forwarded-Host'));",
          "73:             $this->assertFalse($request->headers->has('X-Forwarded-Port'));",
          "74:             $this->assertFalse($request->headers->has('X-Forwarded-Proto'));",
          "75:             $this->assertSame('for=\"10.0.0.1\";host=\"localhost\";proto=http', $request->headers->get('Forwarded'));",
          "76:         });",
          "78:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
          "80:         $this->assertSame(self::$globalState, $this->getGlobalState());",
          "81:     }",
          "83:     public function testTrustedForwardedHeader()",
          "84:     {",
          "85:         Request::setTrustedProxies(array('10.0.0.1'), -1);",
          "86:         $globalState = $this->getGlobalState();",
          "88:         $request = Request::create('/');",
          "89:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
          "90:         $request->headers->set('Forwarded', 'for=\"10.0.0.2\";host=\"foo.bar:1234\";proto=https');",
          "92:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) {",
          "93:             $this->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
          "94:             $this->assertSame('10.0.0.2', $request->getClientIp());",
          "95:             $this->assertSame('foo.bar:1234', $request->getHttpHost());",
          "96:             $this->assertSame('https', $request->getScheme());",
          "97:             $this->assertSame(1234, $request->getPort());",
          "98:         });",
          "100:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
          "102:         $this->assertSame($globalState, $this->getGlobalState());",
          "103:     }",
          "105:     public function testTrustedXForwardedForHeader()",
          "106:     {",
          "107:         Request::setTrustedProxies(array('10.0.0.1'), -1);",
          "108:         $globalState = $this->getGlobalState();",
          "110:         $request = Request::create('/');",
          "111:         $request->server->set('REMOTE_ADDR', '10.0.0.1');",
          "112:         $request->headers->set('X-Forwarded-For', '10.0.0.2');",
          "113:         $request->headers->set('X-Forwarded-Host', 'foo.bar');",
          "114:         $request->headers->set('X-Forwarded-Proto', 'https');",
          "116:         $kernel = new TestSubRequestHandlerKernel(function ($request, $type, $catch) {",
          "117:             $this->assertSame('127.0.0.1', $request->server->get('REMOTE_ADDR'));",
          "118:             $this->assertSame('10.0.0.2', $request->getClientIp());",
          "119:             $this->assertSame('foo.bar', $request->getHttpHost());",
          "120:             $this->assertSame('https', $request->getScheme());",
          "121:         });",
          "123:         SubRequestHandler::handle($kernel, $request, HttpKernelInterface::MASTER_REQUEST, true);",
          "125:         $this->assertSame($globalState, $this->getGlobalState());",
          "126:     }",
          "128:     private function getGlobalState()",
          "129:     {",
          "130:         return array(",
          "131:             Request::getTrustedProxies(),",
          "132:             Request::getTrustedHeaderSet(),",
          "133:         );",
          "134:     }",
          "135: }",
          "137: class TestSubRequestHandlerKernel implements HttpKernelInterface",
          "138: {",
          "139:     private $assertCallback;",
          "141:     public function __construct(\\Closure $assertCallback)",
          "142:     {",
          "143:         $this->assertCallback = $assertCallback;",
          "144:     }",
          "146:     public function handle(Request $request, $type = self::MASTER_REQUEST, $catch = true)",
          "147:     {",
          "148:         $assertCallback = $this->assertCallback;",
          "149:         $assertCallback($request, $type, $catch);",
          "151:         return new Response();",
          "152:     }",
          "153: }",
          "",
          "---------------"
        ],
        "src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php||src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php": [
          "File: src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php -> src/Symfony/Component/HttpKernel/Tests/HttpCache/TestHttpKernel.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:         parent::__construct(new EventDispatcher(), $this, null, $this);",
          "40:     }",
          "43:     {",
          "45:     }",
          "47:     public function handle(Request $request, $type = HttpKernelInterface::MASTER_REQUEST, $catch = false)",
          "48:     {",
          "49:         $this->catch = $catch;",
          "52:         return parent::handle($request, $type, $catch);",
          "53:     }",
          "",
          "[Removed Lines]",
          "42:     public function getBackendRequest()",
          "44:         return $this->backendRequest;",
          "50:         $this->backendRequest = $request;",
          "",
          "[Added Lines]",
          "42:     public function assert(\\Closure $callback)",
          "44:         $trustedConfig = array(Request::getTrustedProxies(), Request::getTrustedHeaderSet());",
          "46:         list($trustedProxies, $trustedHeaderSet, $backendRequest) = $this->backendRequest;",
          "47:         Request::setTrustedProxies($trustedProxies, $trustedHeaderSet);",
          "49:         try {",
          "50:             $callback($backendRequest);",
          "51:         } finally {",
          "52:             list($trustedProxies, $trustedHeaderSet) = $trustedConfig;",
          "53:             Request::setTrustedProxies($trustedProxies, $trustedHeaderSet);",
          "54:         }",
          "60:         $this->backendRequest = array(Request::getTrustedProxies(), Request::getTrustedHeaderSet(), $request);",
          "",
          "---------------"
        ]
      }
    }
  ]
}