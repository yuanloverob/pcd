{
  "cve_id": "CVE-2021-41090",
  "cve_desc": "Grafana Agent is a telemetry collector for sending metrics, logs, and trace data to the opinionated Grafana observability stack. Prior to versions 0.20.1 and 0.21.2, inline secrets defined within a metrics instance config are exposed in plaintext over two endpoints: metrics instance configs defined in the base YAML file are exposed at `/-/config` and metrics instance configs defined for the scraping service are exposed at `/agent/api/v1/configs/:key`. Inline secrets will be exposed to anyone being able to reach these endpoints. If HTTPS with client authentication is not configured, these endpoints are accessible to unauthenticated users. Secrets found in these sections are used for delivering metrics to a Prometheus Remote Write system, authenticating against a system for discovering Prometheus targets, and authenticating against a system for collecting metrics. This does not apply for non-inlined secrets, such as `*_file` based secrets. This issue is patched in Grafana Agent versions 0.20.1 and 0.21.2. A few workarounds are available. Users who cannot upgrade should use non-inline secrets where possible. Users may also desire to restrict API access to Grafana Agent with some combination of restricting the network interfaces Grafana Agent listens on through `http_listen_address` in the `server` block, configuring Grafana Agent to use HTTPS with client authentication, and/or using firewall rules to restrict external access to Grafana Agent's API.",
  "repo": "grafana/agent",
  "patch_hash": "a5479755e946e5c7cddb793ee9adda8f5692ba11",
  "patch_info": {
    "commit_hash": "a5479755e946e5c7cddb793ee9adda8f5692ba11",
    "repo": "grafana/agent",
    "commit_url": "https://github.com/grafana/agent/commit/a5479755e946e5c7cddb793ee9adda8f5692ba11",
    "files": [
      "pkg/metrics/instance/configstore/api.go",
      "pkg/metrics/instance/configstore/api_test.go",
      "pkg/metrics/instance/instance.go",
      "pkg/metrics/instance/marshal_test.go"
    ],
    "message": "Merge pull request #17 from grafana/marshal-instance-config-secrets-0.21.2\n\n[v0.21.2] Scrub secrets when marshaling instance configs",
    "before_after_code_files": [
      "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go",
      "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go",
      "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go",
      "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go"
    ]
  },
  "patch_diff": {
    "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go": [
      "File: pkg/metrics/instance/configstore/api.go -> pkg/metrics/instance/configstore/api.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "126:  case err != nil:",
      "127:   api.writeError(rw, http.StatusInternalServerError, err)",
      "128:  case err == nil:",
      "130:   if err != nil {",
      "131:    api.writeError(rw, http.StatusInternalServerError, fmt.Errorf(\"could not marshal config for response: %w\", err))",
      "132:    return",
      "",
      "[Removed Lines]",
      "129:   bb, err := instance.MarshalConfig(&cfg, false)",
      "",
      "[Added Lines]",
      "129:   bb, err := instance.MarshalConfig(&cfg, true)",
      "",
      "---------------"
    ],
    "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go": [
      "File: pkg/metrics/instance/configstore/api_test.go -> pkg/metrics/instance/configstore/api_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: import (",
      "4:  \"bytes\"",
      "5:  \"context\"",
      "6:  \"fmt\"",
      "7:  \"io/ioutil\"",
      "8:  \"net/http\"",
      "9:  \"net/http/httptest\"",
      "10:  \"testing\"",
      "11:  \"time\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6:  \"encoding/json\"",
      "8:  \"io\"",
      "12:  \"strings\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "128:  })",
      "129: }",
      "131: func TestServer_PutConfiguration(t *testing.T) {",
      "132:  var s Mock",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "134: func TestAPI_GetConfiguration_ScrubSecrets(t *testing.T) {",
      "135:  rawConfig := `name: exists",
      "136: scrape_configs:",
      "137: - job_name: local_scrape",
      "138:   follow_redirects: true",
      "139:   honor_timestamps: true",
      "140:   metrics_path: /metrics",
      "141:   scheme: http",
      "142:   static_configs:",
      "143:   - targets:",
      "144:     - 127.0.0.1:12345",
      "145:     labels:",
      "146:       cluster: localhost",
      "147:   basic_auth:",
      "148:     username: admin",
      "149:     password: SCRUBME",
      "150: remote_write:",
      "151: - url: http://localhost:9009/api/prom/push",
      "152:   remote_timeout: 30s",
      "153:   name: test-d0f32c",
      "154:   basic_auth:",
      "155:     username: admin",
      "156:     password: SCRUBME",
      "157:   queue_config:",
      "158:     capacity: 500",
      "159:     max_shards: 1000",
      "160:     min_shards: 1",
      "161:     max_samples_per_send: 100",
      "162:     batch_send_deadline: 5s",
      "163:     min_backoff: 30ms",
      "164:     max_backoff: 100ms",
      "165:   follow_redirects: true",
      "166:   metadata_config:",
      "167:     send: true",
      "168:     send_interval: 1m",
      "169:     max_samples_per_send: 500",
      "170: wal_truncate_frequency: 1m0s",
      "171: min_wal_time: 5m0s",
      "172: max_wal_time: 4h0m0s",
      "173: remote_flush_deadline: 1m0s",
      "174: `",
      "175:  scrubbedConfig := strings.ReplaceAll(rawConfig, \"SCRUBME\", \"<secret>\")",
      "177:  s := &Mock{",
      "178:   GetFunc: func(ctx context.Context, key string) (instance.Config, error) {",
      "179:    c, err := instance.UnmarshalConfig(strings.NewReader(rawConfig))",
      "180:    if err != nil {",
      "181:     return instance.Config{}, err",
      "182:    }",
      "183:    return *c, nil",
      "184:   },",
      "185:  }",
      "187:  api := NewAPI(log.NewNopLogger(), s, nil)",
      "188:  env := newAPITestEnvironment(t, api)",
      "190:  resp, err := http.Get(env.srv.URL + \"/agent/api/v1/configs/exists\")",
      "191:  require.NoError(t, err)",
      "192:  require.Equal(t, http.StatusOK, resp.StatusCode)",
      "193:  respBytes, err := io.ReadAll(resp.Body)",
      "194:  require.NoError(t, err)",
      "196:  var apiResp struct {",
      "197:   Status string `json:\"status\"`",
      "198:   Data   struct {",
      "199:    Value string `json:\"value\"`",
      "200:   } `json:\"data\"`",
      "201:  }",
      "202:  err = json.Unmarshal(respBytes, &apiResp)",
      "203:  require.NoError(t, err)",
      "204:  require.Equal(t, \"success\", apiResp.Status)",
      "205:  require.YAMLEq(t, scrubbedConfig, apiResp.Data.Value)",
      "207:  t.Run(\"With Client\", func(t *testing.T) {",
      "208:   cli := client.New(env.srv.URL)",
      "209:   actual, err := cli.GetConfiguration(context.Background(), \"exists\")",
      "210:   require.NoError(t, err)",
      "215:   actualBytes, err := instance.MarshalConfig(actual, false)",
      "216:   require.NoError(t, err)",
      "217:   require.YAMLEq(t, scrubbedConfig, string(actualBytes))",
      "218:  })",
      "219: }",
      "",
      "---------------"
    ],
    "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go": [
      "File: pkg/metrics/instance/instance.go -> pkg/metrics/instance/instance.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "94:  if err != nil {",
      "95:   return nil, err",
      "96:  }",
      "",
      "[Removed Lines]",
      "93:  bb, err := MarshalConfig(&c, false)",
      "",
      "[Added Lines]",
      "93:  bb, err := MarshalConfig(&c, true)",
      "",
      "---------------"
    ],
    "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go": [
      "File: pkg/metrics/instance/marshal_test.go -> pkg/metrics/instance/marshal_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "25:  require.Error(t, err)",
      "26: }",
      "31:  cfg := `name: test",
      "32: scrape_configs:",
      "33: - job_name: local_scrape",
      "",
      "[Removed Lines]",
      "30: func TestMarshal_UnmarshalConfig(t *testing.T) {",
      "",
      "[Added Lines]",
      "30: func TestMarshal_UnmarshalConfig_RetainSecrets(t *testing.T) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "69: remote_flush_deadline: 1m0s",
      "70: `",
      "100: }",
      "105:  cfg := `name: test",
      "106: scrape_configs:",
      "107: - job_name: local_scrape",
      "",
      "[Removed Lines]",
      "72:  t.Run(\"direct marshal\", func(t *testing.T) {",
      "73:   var c Config",
      "74:   err := yaml.Unmarshal([]byte(cfg), &c)",
      "75:   require.NoError(t, err)",
      "77:   out, err := yaml.Marshal(c)",
      "78:   require.NoError(t, err)",
      "79:   require.YAMLEq(t, cfg, string(out))",
      "80:  })",
      "82:  t.Run(\"direct mashal pointer\", func(t *testing.T) {",
      "83:   c := &Config{}",
      "84:   err := yaml.Unmarshal([]byte(cfg), c)",
      "85:   require.NoError(t, err)",
      "87:   out, err := yaml.Marshal(c)",
      "88:   require.NoError(t, err)",
      "89:   require.YAMLEq(t, cfg, string(out))",
      "90:  })",
      "92:  t.Run(\"custom marshal methods\", func(t *testing.T) {",
      "93:   c, err := UnmarshalConfig(strings.NewReader(cfg))",
      "94:   require.NoError(t, err)",
      "96:   out, err := MarshalConfig(c, false)",
      "97:   require.NoError(t, err)",
      "98:   require.YAMLEq(t, cfg, string(out))",
      "99:  })",
      "104: func TestMarshal_UnmarshalConfig_Sigv4(t *testing.T) {",
      "",
      "[Added Lines]",
      "72:  c, err := UnmarshalConfig(strings.NewReader(cfg))",
      "73:  require.NoError(t, err)",
      "75:  out, err := MarshalConfig(c, false)",
      "76:  require.NoError(t, err)",
      "77:  require.YAMLEq(t, cfg, string(out))",
      "82: func TestMarshal_UnmarshalConfig_ScrubSecrets(t *testing.T) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "116:       cluster: localhost",
      "117:   basic_auth:",
      "118:     username: admin",
      "120: remote_write:",
      "121: - url: http://localhost:9009/api/prom/push",
      "122:   remote_timeout: 30s",
      "123:   name: test-d0f32c",
      "125:   queue_config:",
      "126:     capacity: 500",
      "127:     max_shards: 1000",
      "",
      "[Removed Lines]",
      "119:     password: foobar",
      "124:   sigv4: {}",
      "",
      "[Added Lines]",
      "97:     password: SCRUBME",
      "102:   basic_auth:",
      "103:     username: admin",
      "104:     password: SCRUBME",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "141: remote_flush_deadline: 1m0s",
      "142: `",
      "144:  t.Run(\"direct marshal\", func(t *testing.T) {",
      "145:   var c Config",
      "146:   err := yaml.Unmarshal([]byte(cfg), &c)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "124:  scrub := func(in string) string {",
      "125:   return strings.ReplaceAll(in, \"SCRUBME\", \"<secret>\")",
      "126:  }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "149:   out, err := yaml.Marshal(c)",
      "150:   require.NoError(t, err)",
      "152:  })",
      "157:   require.NoError(t, err)",
      "160:   require.NoError(t, err)",
      "162:  })",
      "164:  t.Run(\"custom marshal methods\", func(t *testing.T) {",
      "165:   c, err := UnmarshalConfig(strings.NewReader(cfg))",
      "166:   require.NoError(t, err)",
      "169:   require.NoError(t, err)",
      "171:  })",
      "172: }",
      "",
      "[Removed Lines]",
      "151:   require.YAMLEq(t, cfg, string(out))",
      "154:  t.Run(\"direct mashal pointer\", func(t *testing.T) {",
      "155:   c := &Config{}",
      "156:   err := yaml.Unmarshal([]byte(cfg), c)",
      "159:   out, err := yaml.Marshal(c)",
      "161:   require.YAMLEq(t, cfg, string(out))",
      "168:   out, err := MarshalConfig(c, false)",
      "170:   require.YAMLEq(t, cfg, string(out))",
      "",
      "[Added Lines]",
      "135:   require.YAMLEq(t, scrub(cfg), string(out))",
      "138:  t.Run(\"direct marshal pointer\", func(t *testing.T) {",
      "139:   var c Config",
      "140:   err := yaml.Unmarshal([]byte(cfg), &c)",
      "143:   out, err := yaml.Marshal(&c)",
      "145:   require.YAMLEq(t, scrub(cfg), string(out))",
      "152:   out, err := MarshalConfig(c, true)",
      "154:   require.YAMLEq(t, scrub(cfg), string(out))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3ee10484c4d629672a48dcee877782a561612179",
      "candidate_info": {
        "commit_hash": "3ee10484c4d629672a48dcee877782a561612179",
        "repo": "grafana/agent",
        "commit_url": "https://github.com/grafana/agent/commit/3ee10484c4d629672a48dcee877782a561612179",
        "files": [
          "cmd/agent/entrypoint.go"
        ],
        "message": "fix /-/config endpoint",
        "before_after_code_files": [
          "cmd/agent/entrypoint.go||cmd/agent/entrypoint.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/grafana/agent/pull/1153"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cmd/agent/entrypoint.go||cmd/agent/entrypoint.go": [
          "File: cmd/agent/entrypoint.go -> cmd/agent/entrypoint.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "167:   fmt.Fprintf(w, \"Agent is Ready.\\n\")",
          "168:  })",
          "180:    if err != nil {",
          "181:     http.Error(rw, fmt.Sprintf(\"failed to marshal config: %s\", err), http.StatusInternalServerError)",
          "182:    } else {",
          "183:     _, _ = rw.Write(bb)",
          "184:    }",
          "185:   }",
          "189:  mux.HandleFunc(\"/-/reload\", ep.reloadHandler).Methods(\"GET\", \"POST\")",
          "190: }",
          "",
          "[Removed Lines]",
          "170:  configHandler := func(rw http.ResponseWriter, r *http.Request) {",
          "171:   rw.WriteHeader(http.StatusNotFound)",
          "172:   _, _ = rw.Write([]byte(\"404 - config endpoint is disabled\"))",
          "173:  }",
          "174:  if ep.cfg.EnableEndpoint {",
          "175:   configHandler = func(rw http.ResponseWriter, r *http.Request) {",
          "176:    ep.mut.Lock()",
          "177:    bb, err := yaml.Marshal(ep.cfg)",
          "178:    ep.mut.Unlock()",
          "186:  }",
          "187:  mux.HandleFunc(\"/-/config\", configHandler)",
          "",
          "[Added Lines]",
          "170:  mux.HandleFunc(\"/-/config\", func(rw http.ResponseWriter, r *http.Request) {",
          "171:   ep.mut.Lock()",
          "172:   cfg := ep.cfg",
          "173:   ep.mut.Unlock()",
          "175:   if cfg.EnableEndpoint {",
          "176:    bb, err := yaml.Marshal(cfg)",
          "182:   } else {",
          "183:    rw.WriteHeader(http.StatusNotFound)",
          "184:    _, _ = rw.Write([]byte(\"404 - config endpoint is disabled\"))",
          "186:  })",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6d604d3a4e7ccab6b79e601708f7967c90cd6e84",
      "candidate_info": {
        "commit_hash": "6d604d3a4e7ccab6b79e601708f7967c90cd6e84",
        "repo": "grafana/agent",
        "commit_url": "https://github.com/grafana/agent/commit/6d604d3a4e7ccab6b79e601708f7967c90cd6e84",
        "files": [
          "pkg/traces/config.go",
          "pkg/traces/config_test.go"
        ],
        "message": "Scrub out receivers has ***receivers_scrubber***:null",
        "before_after_code_files": [
          "pkg/traces/config.go||pkg/traces/config.go",
          "pkg/traces/config_test.go||pkg/traces/config_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/grafana/agent/pull/1153"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "pkg/traces/config.go||pkg/traces/config.go": [
          "File: pkg/traces/config.go -> pkg/traces/config.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:  alwaysSamplePolicy = \"always_sample\"",
          "55: )",
          "58: type Config struct {",
          "59:  Configs []InstanceConfig `yaml:\"configs,omitempty\"`",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "57: var scrubbedMap = map[string]interface{}{",
          "58:  \"***receivers_scrubbed***\": nil,",
          "59: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "129:  ServiceGraphs *serviceGraphsConfig `yaml:\"service_graphs,omitempty\"`",
          "130: }",
          "132: const (",
          "133:  compressionNone = \"none\"",
          "134:  compressionGzip = \"gzip\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "137: func (c InstanceConfig) MarshalYAML() (interface{}, error) {",
          "138:  c.Receivers = scrubbedMap",
          "139:  return c, nil",
          "140: }",
          "",
          "---------------"
        ],
        "pkg/traces/config_test.go||pkg/traces/config_test.go": [
          "File: pkg/traces/config_test.go -> pkg/traces/config_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "4:  \"io/ioutil\"",
          "5:  \"os\"",
          "6:  \"sort\"",
          "7:  \"testing\"",
          "9:  \"github.com/stretchr/testify/assert\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7:  \"strings\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1304:  }",
          "1305: }",
          "1308: func sortPipelines(cfg *config.Config) {",
          "1309:  tracePipeline := cfg.Pipelines[string(config.TracesDataType)]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1308: func TestScrubbedReceivers(t *testing.T) {",
          "1309:  test := `",
          "1310: receivers:",
          "1311:   jaeger:",
          "1312:     protocols:",
          "1313:       grpc:`",
          "1314:  var cfg InstanceConfig",
          "1315:  err := yaml.Unmarshal([]byte(test), &cfg)",
          "1316:  assert.Nil(t, err)",
          "1317:  data, err := yaml.Marshal(cfg)",
          "1318:  assert.Nil(t, err)",
          "1319:  scrubbedString := string(data)",
          "1320:  assert.True(t, strings.Index(scrubbedString, \"receivers_scrubbed\") > 0)",
          "1321: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7d68f46a559a4d33daa49106ee877d646d476d7f",
      "candidate_info": {
        "commit_hash": "7d68f46a559a4d33daa49106ee877d646d476d7f",
        "repo": "grafana/agent",
        "commit_url": "https://github.com/grafana/agent/commit/7d68f46a559a4d33daa49106ee877d646d476d7f",
        "files": [
          "go.mod",
          "go.sum",
          "pkg/config/config.go",
          "pkg/config/config_test.go"
        ],
        "message": "obscure etcd/consul credentials",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum",
          "pkg/config/config.go||pkg/config/config.go",
          "pkg/config/config_test.go||pkg/config/config_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/grafana/agent/pull/1153"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "108:  github.com/hashicorp/consul => github.com/hashicorp/consul v1.5.1",
          "109:  github.com/hpcloud/tail => github.com/grafana/tail v0.0.0-20201004203643-7aa4e4a91f03",
          "110:  github.com/prometheus/prometheus => github.com/grafana/prometheus v1.8.2-0.20211103031328-89bb32ee4ae7",
          "112:  k8s.io/api => k8s.io/api v0.21.0",
          "113:  k8s.io/apimachinery => k8s.io/apimachinery v0.21.0",
          "114:  k8s.io/client-go => k8s.io/client-go v0.21.0",
          "",
          "[Removed Lines]",
          "111:  gopkg.in/yaml.v2 => github.com/rfratto/go-yaml v0.0.0-20200521142311-984fc90c8a04",
          "",
          "[Added Lines]",
          "111:  gopkg.in/yaml.v2 => github.com/rfratto/go-yaml v0.0.0-20211119180816-77389c3526dc",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "1967: github.com/remyoudompheng/bigfft v0.0.0-20200410134404-eec4a21b6bb0/go.mod h1:qqbHyh8v60DhA7CoWK5oRCqLrMHRGoxYCSS9EjAz6Eo=",
          "1968: github.com/renier/xmlrpc v0.0.0-20170708154548-ce4a1a486c03/go.mod h1:gRAiPF5C5Nd0eyyRdqIu9qTiFSoZzpTq727b5B8fkkU=",
          "1969: github.com/retailnext/hllpp v1.0.1-0.20180308014038-101a6d2f8b52/go.mod h1:RDpi1RftBQPUCDRw6SmxeaREsAaRKnOclghuzp/WRzc=",
          "1972: github.com/rgeyer/github-exporter v0.0.0-20210722215637-d0cec2ee0dc8 h1:wNuNGrFzFmZlhrtz1Q8EiK1Ob6yWli8lX7D2AGmSGzE=",
          "1973: github.com/rgeyer/github-exporter v0.0.0-20210722215637-d0cec2ee0dc8/go.mod h1:6XoOvFDTfk3aqGaOLHLxoWiZNx4zHobApOhKc3oHF/g=",
          "1974: github.com/rhnvrm/simples3 v0.6.1/go.mod h1:Y+3vYm2V7Y4VijFoJHHTrja6OgPrJ2cBti8dPGkC3sA=",
          "",
          "[Removed Lines]",
          "1970: github.com/rfratto/go-yaml v0.0.0-20200521142311-984fc90c8a04 h1:1HAVwfHi7d7nGq7IEds0aGGX6jLPblrZod5TrGxHghs=",
          "1971: github.com/rfratto/go-yaml v0.0.0-20200521142311-984fc90c8a04/go.mod h1:hI93XBmqTisBFMUTm0b8Fm+jr3Dg1NNxqwp+5A1VGuI=",
          "",
          "[Added Lines]",
          "1970: github.com/rfratto/go-yaml v0.0.0-20211119180816-77389c3526dc h1:g196Usc63pWDzWallipxVhsEjDdh/+RLc/Oz7q3ihW4=",
          "1971: github.com/rfratto/go-yaml v0.0.0-20211119180816-77389c3526dc/go.mod h1:rMzeXFmWpS5JnfDANtpzbklRJY4pqZMJNN9/SJHAXPA=",
          "",
          "---------------"
        ],
        "pkg/config/config.go||pkg/config/config.go": [
          "File: pkg/config/config.go -> pkg/config/config.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: package config",
          "3: import (",
          "4:  \"flag\"",
          "5:  \"fmt\"",
          "7:  \"io/ioutil\"",
          "8:  \"os\"",
          "9:  \"strings\"",
          "10:  \"testing\"",
          "11:  \"unicode\"",
          "13:  \"github.com/go-kit/log\"",
          "14:  \"github.com/go-kit/log/level\"",
          "18:  \"github.com/grafana/agent/pkg/integrations\"",
          "19:  \"github.com/grafana/agent/pkg/logs\"",
          "20:  \"github.com/grafana/agent/pkg/metrics\"",
          "21:  \"github.com/grafana/agent/pkg/traces\"",
          "22:  \"github.com/grafana/agent/pkg/util\"",
          "23:  \"github.com/pkg/errors\"",
          "24:  \"github.com/prometheus/common/version\"",
          "25:  \"gopkg.in/yaml.v2\"",
          "26: )",
          "",
          "[Removed Lines]",
          "6:  \"github.com/stretchr/testify/require\"",
          "15:  \"github.com/weaveworks/common/server\"",
          "17:  \"github.com/drone/envsubst/v2\"",
          "",
          "[Added Lines]",
          "4:  \"bytes\"",
          "13:  \"github.com/drone/envsubst/v2\"",
          "21:  \"github.com/grafana/dskit/kv/consul\"",
          "22:  \"github.com/grafana/dskit/kv/etcd\"",
          "25:  \"github.com/stretchr/testify/require\"",
          "26:  \"github.com/weaveworks/common/server\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "104:  return nil",
          "105: }",
          "109: func (c *Config) LogDeprecations(l log.Logger) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "110: func (c *Config) MarshalYAML() (interface{}, error) {",
          "111:  var buf bytes.Buffer",
          "113:  enc := yaml.NewEncoder(&buf)",
          "114:  enc.SetHook(func(in interface{}) (ok bool, out interface{}, err error) {",
          "116:   switch v := in.(type) {",
          "117:   case etcd.Config:",
          "118:    v.Password = \"<secret>\"",
          "119:    return true, v, nil",
          "120:   case consul.Config:",
          "121:    v.ACLToken = \"<secret>\"",
          "122:    return true, v, nil",
          "123:   default:",
          "124:    return false, nil, nil",
          "125:   }",
          "126:  })",
          "128:  type config Config",
          "129:  if err := enc.Encode((*config)(c)); err != nil {",
          "130:   return nil, err",
          "131:  }",
          "133:  fmt.Println(string(buf.Bytes()))",
          "137:  var m yaml.MapSlice",
          "138:  if err := yaml.Unmarshal(buf.Bytes(), &m); err != nil {",
          "139:   return nil, err",
          "140:  }",
          "141:  return m, nil",
          "142: }",
          "",
          "---------------"
        ],
        "pkg/config/config_test.go||pkg/config/config_test.go": [
          "File: pkg/config/config_test.go -> pkg/config/config_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import (",
          "4:  \"flag\"",
          "5:  \"os\"",
          "6:  \"testing\"",
          "7:  \"time\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:  \"strings\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:  promCfg \"github.com/prometheus/prometheus/config\"",
          "15:  \"github.com/prometheus/prometheus/pkg/labels\"",
          "16:  \"github.com/stretchr/testify/require\"",
          "17: )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "18:  \"gopkg.in/yaml.v2\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "359:  expected := `\\\\temp\\\\Logs\\\\(?P<log_app>.+?)\\\\`",
          "360:  require.Equal(t, expected, pipelineStages[\"expression\"].(string))",
          "361: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "365: func TestConfig_ObscureSecrets(t *testing.T) {",
          "366:  cfgText := `",
          "367: metrics:",
          "368:   wal_directory: /tmp",
          "369:   scraping_service:",
          "370:     enabled: true",
          "371:     kvstore:",
          "372:       store: consul",
          "373:       consul:",
          "374:         acl_token: verysecret",
          "375:       etcd:",
          "376:         password: verysecret",
          "377:     lifecycler:",
          "378:       ring:",
          "379:         kvstore:",
          "380:           store: consul",
          "381:           consul:",
          "382:             acl_token: verysecret",
          "383:           etcd:",
          "384:             password: verysecret",
          "385: `",
          "387:  var cfg Config",
          "388:  require.NoError(t, LoadBytes([]byte(cfgText), false, &cfg))",
          "390:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.KVStore.Consul.ACLToken)",
          "391:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.KVStore.Etcd.Password)",
          "392:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.Lifecycler.RingConfig.KVStore.Consul.ACLToken)",
          "393:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.Lifecycler.RingConfig.KVStore.Etcd.Password)",
          "395:  bb, err := yaml.Marshal(&cfg)",
          "396:  require.NoError(t, err)",
          "398:  require.False(t, strings.Contains(string(bb), \"verysecret\"), \"secrets did not get obscured\")",
          "399:  require.True(t, strings.Contains(string(bb), \"<secret>\"), \"secrets did not get obscured properly\")",
          "402:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.KVStore.Consul.ACLToken)",
          "403:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.KVStore.Etcd.Password)",
          "404:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.Lifecycler.RingConfig.KVStore.Consul.ACLToken)",
          "405:  require.Equal(t, \"verysecret\", cfg.Metrics.ServiceConfig.Lifecycler.RingConfig.KVStore.Etcd.Password)",
          "406: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5fc7b4e8d051830217d8e6b9734d0444ff7f4247",
      "candidate_info": {
        "commit_hash": "5fc7b4e8d051830217d8e6b9734d0444ff7f4247",
        "repo": "grafana/agent",
        "commit_url": "https://github.com/grafana/agent/commit/5fc7b4e8d051830217d8e6b9734d0444ff7f4247",
        "files": [
          "pkg/config/config.go"
        ],
        "message": "also fix non-pointer config bug",
        "before_after_code_files": [
          "pkg/config/config.go||pkg/config/config.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/grafana/agent/pull/1153"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "pkg/config/config.go||pkg/config/config.go": [
          "File: pkg/config/config.go -> pkg/config/config.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "111: }",
          "115:  var buf bytes.Buffer",
          "117:  enc := yaml.NewEncoder(&buf)",
          "",
          "[Removed Lines]",
          "114: func (c *Config) MarshalYAML() (interface{}, error) {",
          "",
          "[Added Lines]",
          "114: func (c Config) MarshalYAML() (interface{}, error) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "130:  })",
          "132:  type config Config",
          "134:   return nil, err",
          "135:  }",
          "",
          "[Removed Lines]",
          "133:  if err := enc.Encode((*config)(c)); err != nil {",
          "",
          "[Added Lines]",
          "133:  if err := enc.Encode((config)(c)); err != nil {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a5479755e946e5c7cddb793ee9adda8f5692ba11",
      "candidate_info": {
        "commit_hash": "a5479755e946e5c7cddb793ee9adda8f5692ba11",
        "repo": "grafana/agent",
        "commit_url": "https://github.com/grafana/agent/commit/a5479755e946e5c7cddb793ee9adda8f5692ba11",
        "files": [
          "pkg/metrics/instance/configstore/api.go",
          "pkg/metrics/instance/configstore/api_test.go",
          "pkg/metrics/instance/instance.go",
          "pkg/metrics/instance/marshal_test.go"
        ],
        "message": "Merge pull request #17 from grafana/marshal-instance-config-secrets-0.21.2\n\n[v0.21.2] Scrub secrets when marshaling instance configs",
        "before_after_code_files": [
          "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go",
          "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go",
          "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go",
          "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go",
            "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go",
            "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go",
            "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go"
          ],
          "candidate": [
            "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go",
            "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go",
            "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go",
            "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go"
          ]
        }
      },
      "candidate_diff": {
        "pkg/metrics/instance/configstore/api.go||pkg/metrics/instance/configstore/api.go": [
          "File: pkg/metrics/instance/configstore/api.go -> pkg/metrics/instance/configstore/api.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "126:  case err != nil:",
          "127:   api.writeError(rw, http.StatusInternalServerError, err)",
          "128:  case err == nil:",
          "130:   if err != nil {",
          "131:    api.writeError(rw, http.StatusInternalServerError, fmt.Errorf(\"could not marshal config for response: %w\", err))",
          "132:    return",
          "",
          "[Removed Lines]",
          "129:   bb, err := instance.MarshalConfig(&cfg, false)",
          "",
          "[Added Lines]",
          "129:   bb, err := instance.MarshalConfig(&cfg, true)",
          "",
          "---------------"
        ],
        "pkg/metrics/instance/configstore/api_test.go||pkg/metrics/instance/configstore/api_test.go": [
          "File: pkg/metrics/instance/configstore/api_test.go -> pkg/metrics/instance/configstore/api_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import (",
          "4:  \"bytes\"",
          "5:  \"context\"",
          "6:  \"fmt\"",
          "7:  \"io/ioutil\"",
          "8:  \"net/http\"",
          "9:  \"net/http/httptest\"",
          "10:  \"testing\"",
          "11:  \"time\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:  \"encoding/json\"",
          "8:  \"io\"",
          "12:  \"strings\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "128:  })",
          "129: }",
          "131: func TestServer_PutConfiguration(t *testing.T) {",
          "132:  var s Mock",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "134: func TestAPI_GetConfiguration_ScrubSecrets(t *testing.T) {",
          "135:  rawConfig := `name: exists",
          "136: scrape_configs:",
          "137: - job_name: local_scrape",
          "138:   follow_redirects: true",
          "139:   honor_timestamps: true",
          "140:   metrics_path: /metrics",
          "141:   scheme: http",
          "142:   static_configs:",
          "143:   - targets:",
          "144:     - 127.0.0.1:12345",
          "145:     labels:",
          "146:       cluster: localhost",
          "147:   basic_auth:",
          "148:     username: admin",
          "149:     password: SCRUBME",
          "150: remote_write:",
          "151: - url: http://localhost:9009/api/prom/push",
          "152:   remote_timeout: 30s",
          "153:   name: test-d0f32c",
          "154:   basic_auth:",
          "155:     username: admin",
          "156:     password: SCRUBME",
          "157:   queue_config:",
          "158:     capacity: 500",
          "159:     max_shards: 1000",
          "160:     min_shards: 1",
          "161:     max_samples_per_send: 100",
          "162:     batch_send_deadline: 5s",
          "163:     min_backoff: 30ms",
          "164:     max_backoff: 100ms",
          "165:   follow_redirects: true",
          "166:   metadata_config:",
          "167:     send: true",
          "168:     send_interval: 1m",
          "169:     max_samples_per_send: 500",
          "170: wal_truncate_frequency: 1m0s",
          "171: min_wal_time: 5m0s",
          "172: max_wal_time: 4h0m0s",
          "173: remote_flush_deadline: 1m0s",
          "174: `",
          "175:  scrubbedConfig := strings.ReplaceAll(rawConfig, \"SCRUBME\", \"<secret>\")",
          "177:  s := &Mock{",
          "178:   GetFunc: func(ctx context.Context, key string) (instance.Config, error) {",
          "179:    c, err := instance.UnmarshalConfig(strings.NewReader(rawConfig))",
          "180:    if err != nil {",
          "181:     return instance.Config{}, err",
          "182:    }",
          "183:    return *c, nil",
          "184:   },",
          "185:  }",
          "187:  api := NewAPI(log.NewNopLogger(), s, nil)",
          "188:  env := newAPITestEnvironment(t, api)",
          "190:  resp, err := http.Get(env.srv.URL + \"/agent/api/v1/configs/exists\")",
          "191:  require.NoError(t, err)",
          "192:  require.Equal(t, http.StatusOK, resp.StatusCode)",
          "193:  respBytes, err := io.ReadAll(resp.Body)",
          "194:  require.NoError(t, err)",
          "196:  var apiResp struct {",
          "197:   Status string `json:\"status\"`",
          "198:   Data   struct {",
          "199:    Value string `json:\"value\"`",
          "200:   } `json:\"data\"`",
          "201:  }",
          "202:  err = json.Unmarshal(respBytes, &apiResp)",
          "203:  require.NoError(t, err)",
          "204:  require.Equal(t, \"success\", apiResp.Status)",
          "205:  require.YAMLEq(t, scrubbedConfig, apiResp.Data.Value)",
          "207:  t.Run(\"With Client\", func(t *testing.T) {",
          "208:   cli := client.New(env.srv.URL)",
          "209:   actual, err := cli.GetConfiguration(context.Background(), \"exists\")",
          "210:   require.NoError(t, err)",
          "215:   actualBytes, err := instance.MarshalConfig(actual, false)",
          "216:   require.NoError(t, err)",
          "217:   require.YAMLEq(t, scrubbedConfig, string(actualBytes))",
          "218:  })",
          "219: }",
          "",
          "---------------"
        ],
        "pkg/metrics/instance/instance.go||pkg/metrics/instance/instance.go": [
          "File: pkg/metrics/instance/instance.go -> pkg/metrics/instance/instance.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "94:  if err != nil {",
          "95:   return nil, err",
          "96:  }",
          "",
          "[Removed Lines]",
          "93:  bb, err := MarshalConfig(&c, false)",
          "",
          "[Added Lines]",
          "93:  bb, err := MarshalConfig(&c, true)",
          "",
          "---------------"
        ],
        "pkg/metrics/instance/marshal_test.go||pkg/metrics/instance/marshal_test.go": [
          "File: pkg/metrics/instance/marshal_test.go -> pkg/metrics/instance/marshal_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "25:  require.Error(t, err)",
          "26: }",
          "31:  cfg := `name: test",
          "32: scrape_configs:",
          "33: - job_name: local_scrape",
          "",
          "[Removed Lines]",
          "30: func TestMarshal_UnmarshalConfig(t *testing.T) {",
          "",
          "[Added Lines]",
          "30: func TestMarshal_UnmarshalConfig_RetainSecrets(t *testing.T) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "69: remote_flush_deadline: 1m0s",
          "70: `",
          "100: }",
          "105:  cfg := `name: test",
          "106: scrape_configs:",
          "107: - job_name: local_scrape",
          "",
          "[Removed Lines]",
          "72:  t.Run(\"direct marshal\", func(t *testing.T) {",
          "73:   var c Config",
          "74:   err := yaml.Unmarshal([]byte(cfg), &c)",
          "75:   require.NoError(t, err)",
          "77:   out, err := yaml.Marshal(c)",
          "78:   require.NoError(t, err)",
          "79:   require.YAMLEq(t, cfg, string(out))",
          "80:  })",
          "82:  t.Run(\"direct mashal pointer\", func(t *testing.T) {",
          "83:   c := &Config{}",
          "84:   err := yaml.Unmarshal([]byte(cfg), c)",
          "85:   require.NoError(t, err)",
          "87:   out, err := yaml.Marshal(c)",
          "88:   require.NoError(t, err)",
          "89:   require.YAMLEq(t, cfg, string(out))",
          "90:  })",
          "92:  t.Run(\"custom marshal methods\", func(t *testing.T) {",
          "93:   c, err := UnmarshalConfig(strings.NewReader(cfg))",
          "94:   require.NoError(t, err)",
          "96:   out, err := MarshalConfig(c, false)",
          "97:   require.NoError(t, err)",
          "98:   require.YAMLEq(t, cfg, string(out))",
          "99:  })",
          "104: func TestMarshal_UnmarshalConfig_Sigv4(t *testing.T) {",
          "",
          "[Added Lines]",
          "72:  c, err := UnmarshalConfig(strings.NewReader(cfg))",
          "73:  require.NoError(t, err)",
          "75:  out, err := MarshalConfig(c, false)",
          "76:  require.NoError(t, err)",
          "77:  require.YAMLEq(t, cfg, string(out))",
          "82: func TestMarshal_UnmarshalConfig_ScrubSecrets(t *testing.T) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "116:       cluster: localhost",
          "117:   basic_auth:",
          "118:     username: admin",
          "120: remote_write:",
          "121: - url: http://localhost:9009/api/prom/push",
          "122:   remote_timeout: 30s",
          "123:   name: test-d0f32c",
          "125:   queue_config:",
          "126:     capacity: 500",
          "127:     max_shards: 1000",
          "",
          "[Removed Lines]",
          "119:     password: foobar",
          "124:   sigv4: {}",
          "",
          "[Added Lines]",
          "97:     password: SCRUBME",
          "102:   basic_auth:",
          "103:     username: admin",
          "104:     password: SCRUBME",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "141: remote_flush_deadline: 1m0s",
          "142: `",
          "144:  t.Run(\"direct marshal\", func(t *testing.T) {",
          "145:   var c Config",
          "146:   err := yaml.Unmarshal([]byte(cfg), &c)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "124:  scrub := func(in string) string {",
          "125:   return strings.ReplaceAll(in, \"SCRUBME\", \"<secret>\")",
          "126:  }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "149:   out, err := yaml.Marshal(c)",
          "150:   require.NoError(t, err)",
          "152:  })",
          "157:   require.NoError(t, err)",
          "160:   require.NoError(t, err)",
          "162:  })",
          "164:  t.Run(\"custom marshal methods\", func(t *testing.T) {",
          "165:   c, err := UnmarshalConfig(strings.NewReader(cfg))",
          "166:   require.NoError(t, err)",
          "169:   require.NoError(t, err)",
          "171:  })",
          "172: }",
          "",
          "[Removed Lines]",
          "151:   require.YAMLEq(t, cfg, string(out))",
          "154:  t.Run(\"direct mashal pointer\", func(t *testing.T) {",
          "155:   c := &Config{}",
          "156:   err := yaml.Unmarshal([]byte(cfg), c)",
          "159:   out, err := yaml.Marshal(c)",
          "161:   require.YAMLEq(t, cfg, string(out))",
          "168:   out, err := MarshalConfig(c, false)",
          "170:   require.YAMLEq(t, cfg, string(out))",
          "",
          "[Added Lines]",
          "135:   require.YAMLEq(t, scrub(cfg), string(out))",
          "138:  t.Run(\"direct marshal pointer\", func(t *testing.T) {",
          "139:   var c Config",
          "140:   err := yaml.Unmarshal([]byte(cfg), &c)",
          "143:   out, err := yaml.Marshal(&c)",
          "145:   require.YAMLEq(t, scrub(cfg), string(out))",
          "152:   out, err := MarshalConfig(c, true)",
          "154:   require.YAMLEq(t, scrub(cfg), string(out))",
          "",
          "---------------"
        ]
      }
    }
  ]
}