{
  "cve_id": "CVE-2023-39441",
  "cve_desc": "Apache Airflow SMTP Provider before 1.3.0, Apache Airflow IMAP Provider before 3.3.0, and\u00a0Apache Airflow before 2.7.0 are affected by the\u00a0Validation of OpenSSL Certificate vulnerability.\n\nThe default SSL context with SSL library did not check a server's X.509\u00a0certificate.\u00a0 Instead, the code accepted any certificate, which could\u00a0result in the disclosure of mail server credentials or mail contents\u00a0when the client connects to an attacker in a MITM position.\n\nUsers are strongly advised to upgrade to Apache Airflow version 2.7.0 or newer, Apache Airflow IMAP Provider version 3.3.0 or newer, and Apache Airflow SMTP Provider version 1.3.0 or newer to mitigate the risk associated with this vulnerability",
  "repo": "apache/airflow",
  "patch_hash": "dbacacbd4d476da757de148a4e747924c34fd7fe",
  "patch_info": {
    "commit_hash": "dbacacbd4d476da757de148a4e747924c34fd7fe",
    "repo": "apache/airflow",
    "commit_url": "https://github.com/apache/airflow/commit/dbacacbd4d476da757de148a4e747924c34fd7fe",
    "files": [
      "airflow/providers/smtp/CHANGELOG.rst",
      "airflow/providers/smtp/hooks/smtp.py",
      "airflow/providers/smtp/provider.yaml",
      "docs/apache-airflow-providers-smtp/configurations-ref.rst",
      "docs/apache-airflow-providers-smtp/index.rst",
      "docs/apache-airflow/configurations-ref.rst",
      "tests/providers/smtp/hooks/test_smtp.py"
    ],
    "message": "Allows to choose SSL context for SMTP provider (#33075)\n\n* Allows to choose SSL context for SMTP provider\n\nThis change add two options to choose from when SSL SMTP connection\nis created:\n\n* default - for balance between compatibility and security\n* none - in case compatibility with existing infrastructure is\n\u00a0 preferred\n\nThe fallback is:\n\n* The Airflow \"email\", \"ssl_context\"\n* \"default\"\n\n* Update airflow/providers/smtp/CHANGELOG.rst\n\nCo-authored-by: Ephraim Anierobi <splendidzigy24@gmail.com>\n(cherry picked from commit e20325db38fdfdd9db423a345b13d18aab6fe578)",
    "before_after_code_files": [
      "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py",
      "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py"
    ]
  },
  "patch_diff": {
    "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py": [
      "File: airflow/providers/smtp/hooks/smtp.py -> airflow/providers/smtp/hooks/smtp.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "26: import os",
      "27: import re",
      "28: import smtplib",
      "29: from email.mime.application import MIMEApplication",
      "30: from email.mime.multipart import MIMEMultipart",
      "31: from email.mime.text import MIMEText",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29: import ssl",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "109:             smtp_kwargs[\"port\"] = self.port",
      "110:         smtp_kwargs[\"timeout\"] = self.timeout",
      "112:         return SMTP(**smtp_kwargs)",
      "114:     @classmethod",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "112:         if self.use_ssl:",
      "113:             from airflow.configuration import conf",
      "115:             ssl_context_string = conf.get(\"smtp_provider\", \"SSL_CONTEXT\", fallback=None)",
      "116:             if ssl_context_string is None:",
      "117:                 ssl_context_string = conf.get(\"email\", \"SSL_CONTEXT\", fallback=None)",
      "118:             if ssl_context_string is None:",
      "119:                 ssl_context_string = \"default\"",
      "120:             if ssl_context_string == \"default\":",
      "121:                 ssl_context = ssl.create_default_context()",
      "122:             elif ssl_context_string == \"none\":",
      "123:                 ssl_context = None",
      "124:             else:",
      "125:                 raise RuntimeError(",
      "126:                     f\"The email.ssl_context configuration variable must \"",
      "127:                     f\"be set to 'default' or 'none' and is '{ssl_context_string}'.\"",
      "128:                 )",
      "129:             smtp_kwargs[\"context\"] = ssl_context",
      "",
      "---------------"
    ],
    "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py": [
      "File: tests/providers/smtp/hooks/test_smtp.py -> tests/providers/smtp/hooks/test_smtp.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: from airflow.providers.smtp.hooks.smtp import SmtpHook",
      "31: from airflow.utils import db",
      "32: from airflow.utils.session import create_session",
      "34: smtplib_string = \"airflow.providers.smtp.hooks.smtp.smtplib\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "33: from tests.test_utils.config import conf_vars",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "75:         )",
      "77:     @patch(smtplib_string)",
      "79:         mock_conn = _create_fake_smtp(mock_smtplib)",
      "81:         with SmtpHook():",
      "82:             pass",
      "85:         mock_conn.login.assert_called_once_with(\"smtp_user\", \"smtp_password\")",
      "86:         assert mock_conn.close.call_count == 1",
      "",
      "[Removed Lines]",
      "78:     def test_connect_and_disconnect(self, mock_smtplib):",
      "84:         mock_smtplib.SMTP_SSL.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30)",
      "",
      "[Added Lines]",
      "79:     @patch(\"ssl.create_default_context\")",
      "80:     def test_connect_and_disconnect(self, create_default_context, mock_smtplib):",
      "85:         assert create_default_context.called",
      "86:         mock_smtplib.SMTP_SSL.assert_called_once_with(",
      "87:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
      "88:         )",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "202:     @patch(\"smtplib.SMTP_SSL\")",
      "203:     @patch(\"smtplib.SMTP\")",
      "205:         mock_smtp_ssl.return_value = Mock()",
      "206:         with SmtpHook() as smtp_hook:",
      "207:             smtp_hook.send_email_smtp(to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\")",
      "208:         assert not mock_smtp.called",
      "211:     @patch(\"smtplib.SMTP_SSL\")",
      "212:     @patch(\"smtplib.SMTP\")",
      "",
      "[Removed Lines]",
      "204:     def test_send_mime_ssl(self, mock_smtp, mock_smtp_ssl):",
      "209:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30)",
      "",
      "[Added Lines]",
      "208:     @patch(\"ssl.create_default_context\")",
      "209:     def test_send_mime_ssl(self, create_default_context, mock_smtp, mock_smtp_ssl):",
      "214:         assert create_default_context.called",
      "215:         mock_smtp_ssl.assert_called_once_with(",
      "216:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
      "217:         )",
      "219:     @patch(\"smtplib.SMTP_SSL\")",
      "220:     @patch(\"smtplib.SMTP\")",
      "221:     @patch(\"ssl.create_default_context\")",
      "222:     def test_send_mime_ssl_none_email_context(self, create_default_context, mock_smtp, mock_smtp_ssl):",
      "223:         mock_smtp_ssl.return_value = Mock()",
      "224:         with conf_vars({(\"smtp\", \"smtp_ssl\"): \"True\", (\"email\", \"ssl_context\"): \"none\"}):",
      "225:             with SmtpHook() as smtp_hook:",
      "226:                 smtp_hook.send_email_smtp(",
      "227:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
      "228:                 )",
      "229:         assert not mock_smtp.called",
      "230:         assert not create_default_context.called",
      "231:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
      "233:     @patch(\"smtplib.SMTP_SSL\")",
      "234:     @patch(\"smtplib.SMTP\")",
      "235:     @patch(\"ssl.create_default_context\")",
      "236:     def test_send_mime_ssl_none_smtp_provider_context(self, create_default_context, mock_smtp, mock_smtp_ssl):",
      "237:         mock_smtp_ssl.return_value = Mock()",
      "238:         with conf_vars({(\"smtp\", \"smtp_ssl\"): \"True\", (\"smtp_provider\", \"ssl_context\"): \"none\"}):",
      "239:             with SmtpHook() as smtp_hook:",
      "240:                 smtp_hook.send_email_smtp(",
      "241:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
      "242:                 )",
      "243:         assert not mock_smtp.called",
      "244:         assert not create_default_context.called",
      "245:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
      "247:     @patch(\"smtplib.SMTP_SSL\")",
      "248:     @patch(\"smtplib.SMTP\")",
      "249:     @patch(\"ssl.create_default_context\")",
      "250:     def test_send_mime_ssl_none_smtp_provider_default_email_context(",
      "251:         self, create_default_context, mock_smtp, mock_smtp_ssl",
      "252:     ):",
      "253:         mock_smtp_ssl.return_value = Mock()",
      "254:         with conf_vars(",
      "255:             {",
      "256:                 (\"smtp\", \"smtp_ssl\"): \"True\",",
      "257:                 (\"email\", \"ssl_context\"): \"default\",",
      "258:                 (\"smtp_provider\", \"ssl_context\"): \"none\",",
      "259:             }",
      "260:         ):",
      "261:             with SmtpHook() as smtp_hook:",
      "262:                 smtp_hook.send_email_smtp(",
      "263:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
      "264:                 )",
      "265:         assert not mock_smtp.called",
      "266:         assert not create_default_context.called",
      "267:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
      "269:     @patch(\"smtplib.SMTP_SSL\")",
      "270:     @patch(\"smtplib.SMTP\")",
      "271:     @patch(\"ssl.create_default_context\")",
      "272:     def test_send_mime_ssl_default_smtp_provider_none_email_context(",
      "273:         self, create_default_context, mock_smtp, mock_smtp_ssl",
      "274:     ):",
      "275:         mock_smtp_ssl.return_value = Mock()",
      "276:         with conf_vars(",
      "277:             {",
      "278:                 (\"smtp\", \"smtp_ssl\"): \"True\",",
      "279:                 (\"email\", \"ssl_context\"): \"none\",",
      "280:                 (\"smtp_provider\", \"ssl_context\"): \"default\",",
      "281:             }",
      "282:         ):",
      "283:             with SmtpHook() as smtp_hook:",
      "284:                 smtp_hook.send_email_smtp(",
      "285:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
      "286:                 )",
      "287:         assert not mock_smtp.called",
      "288:         assert create_default_context.called",
      "289:         mock_smtp_ssl.assert_called_once_with(",
      "290:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
      "291:         )",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "270:     @patch(\"airflow.models.connection.Connection\")",
      "271:     @patch(\"smtplib.SMTP_SSL\")",
      "273:         mock_smtp_ssl().sendmail.side_effect = smtplib.SMTPServerDisconnected()",
      "274:         custom_retry_limit = 10",
      "275:         custom_timeout = 60",
      "",
      "[Removed Lines]",
      "272:     def test_send_mime_custom_timeout_retrylimit(self, mock_smtp_ssl, connection_mock):",
      "",
      "[Added Lines]",
      "354:     @patch(\"ssl.create_default_context\")",
      "355:     def test_send_mime_custom_timeout_retrylimit(",
      "356:         self, create_default_context, mock_smtp_ssl, connection_mock",
      "357:     ):",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "287:             with pytest.raises(smtplib.SMTPServerDisconnected):",
      "288:                 smtp_hook.send_email_smtp(to=\"to\", subject=\"subject\", html_content=\"content\")",
      "289:         mock_smtp_ssl.assert_any_call(",
      "291:         )",
      "292:         assert mock_smtp_ssl().sendmail.call_count == 10",
      "",
      "[Removed Lines]",
      "290:             host=fake_conn.host, port=fake_conn.port, timeout=fake_conn.extra_dejson[\"timeout\"]",
      "",
      "[Added Lines]",
      "375:             host=fake_conn.host,",
      "376:             port=fake_conn.port,",
      "377:             timeout=fake_conn.extra_dejson[\"timeout\"],",
      "378:             context=create_default_context.return_value,",
      "380:         assert create_default_context.called",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e20325db38fdfdd9db423a345b13d18aab6fe578",
      "candidate_info": {
        "commit_hash": "e20325db38fdfdd9db423a345b13d18aab6fe578",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/e20325db38fdfdd9db423a345b13d18aab6fe578",
        "files": [
          "airflow/providers/smtp/CHANGELOG.rst",
          "airflow/providers/smtp/hooks/smtp.py",
          "airflow/providers/smtp/provider.yaml",
          "docs/apache-airflow-providers-smtp/configurations-ref.rst",
          "docs/apache-airflow-providers-smtp/index.rst",
          "docs/apache-airflow/configurations-ref.rst",
          "tests/providers/smtp/hooks/test_smtp.py"
        ],
        "message": "Allows to choose SSL context for SMTP provider (#33075)\n\n* Allows to choose SSL context for SMTP provider\n\nThis change add two options to choose from when SSL SMTP connection\nis created:\n\n* default - for balance between compatibility and security\n* none - in case compatibility with existing infrastructure is\n\u00a0 preferred\n\nThe fallback is:\n\n* The Airflow \"email\", \"ssl_context\"\n* \"default\"\n\n* Update airflow/providers/smtp/CHANGELOG.rst\n\nCo-authored-by: Ephraim Anierobi <splendidzigy24@gmail.com>",
        "before_after_code_files": [
          "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py",
          "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py",
            "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py"
          ],
          "candidate": [
            "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py",
            "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py"
          ]
        }
      },
      "candidate_diff": {
        "airflow/providers/smtp/hooks/smtp.py||airflow/providers/smtp/hooks/smtp.py": [
          "File: airflow/providers/smtp/hooks/smtp.py -> airflow/providers/smtp/hooks/smtp.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: import os",
          "27: import re",
          "28: import smtplib",
          "29: from email.mime.application import MIMEApplication",
          "30: from email.mime.multipart import MIMEMultipart",
          "31: from email.mime.text import MIMEText",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: import ssl",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:             smtp_kwargs[\"port\"] = self.port",
          "110:         smtp_kwargs[\"timeout\"] = self.timeout",
          "112:         return SMTP(**smtp_kwargs)",
          "114:     @classmethod",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "112:         if self.use_ssl:",
          "113:             from airflow.configuration import conf",
          "115:             ssl_context_string = conf.get(\"smtp_provider\", \"SSL_CONTEXT\", fallback=None)",
          "116:             if ssl_context_string is None:",
          "117:                 ssl_context_string = conf.get(\"email\", \"SSL_CONTEXT\", fallback=None)",
          "118:             if ssl_context_string is None:",
          "119:                 ssl_context_string = \"default\"",
          "120:             if ssl_context_string == \"default\":",
          "121:                 ssl_context = ssl.create_default_context()",
          "122:             elif ssl_context_string == \"none\":",
          "123:                 ssl_context = None",
          "124:             else:",
          "125:                 raise RuntimeError(",
          "126:                     f\"The email.ssl_context configuration variable must \"",
          "127:                     f\"be set to 'default' or 'none' and is '{ssl_context_string}'.\"",
          "128:                 )",
          "129:             smtp_kwargs[\"context\"] = ssl_context",
          "",
          "---------------"
        ],
        "tests/providers/smtp/hooks/test_smtp.py||tests/providers/smtp/hooks/test_smtp.py": [
          "File: tests/providers/smtp/hooks/test_smtp.py -> tests/providers/smtp/hooks/test_smtp.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: from airflow.providers.smtp.hooks.smtp import SmtpHook",
          "31: from airflow.utils import db",
          "32: from airflow.utils.session import create_session",
          "34: smtplib_string = \"airflow.providers.smtp.hooks.smtp.smtplib\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: from tests.test_utils.config import conf_vars",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "75:         )",
          "77:     @patch(smtplib_string)",
          "79:         mock_conn = _create_fake_smtp(mock_smtplib)",
          "81:         with SmtpHook():",
          "82:             pass",
          "85:         mock_conn.login.assert_called_once_with(\"smtp_user\", \"smtp_password\")",
          "86:         assert mock_conn.close.call_count == 1",
          "",
          "[Removed Lines]",
          "78:     def test_connect_and_disconnect(self, mock_smtplib):",
          "84:         mock_smtplib.SMTP_SSL.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30)",
          "",
          "[Added Lines]",
          "79:     @patch(\"ssl.create_default_context\")",
          "80:     def test_connect_and_disconnect(self, create_default_context, mock_smtplib):",
          "85:         assert create_default_context.called",
          "86:         mock_smtplib.SMTP_SSL.assert_called_once_with(",
          "87:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
          "88:         )",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "202:     @patch(\"smtplib.SMTP_SSL\")",
          "203:     @patch(\"smtplib.SMTP\")",
          "205:         mock_smtp_ssl.return_value = Mock()",
          "206:         with SmtpHook() as smtp_hook:",
          "207:             smtp_hook.send_email_smtp(to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\")",
          "208:         assert not mock_smtp.called",
          "211:     @patch(\"smtplib.SMTP_SSL\")",
          "212:     @patch(\"smtplib.SMTP\")",
          "",
          "[Removed Lines]",
          "204:     def test_send_mime_ssl(self, mock_smtp, mock_smtp_ssl):",
          "209:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30)",
          "",
          "[Added Lines]",
          "208:     @patch(\"ssl.create_default_context\")",
          "209:     def test_send_mime_ssl(self, create_default_context, mock_smtp, mock_smtp_ssl):",
          "214:         assert create_default_context.called",
          "215:         mock_smtp_ssl.assert_called_once_with(",
          "216:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
          "217:         )",
          "219:     @patch(\"smtplib.SMTP_SSL\")",
          "220:     @patch(\"smtplib.SMTP\")",
          "221:     @patch(\"ssl.create_default_context\")",
          "222:     def test_send_mime_ssl_none_email_context(self, create_default_context, mock_smtp, mock_smtp_ssl):",
          "223:         mock_smtp_ssl.return_value = Mock()",
          "224:         with conf_vars({(\"smtp\", \"smtp_ssl\"): \"True\", (\"email\", \"ssl_context\"): \"none\"}):",
          "225:             with SmtpHook() as smtp_hook:",
          "226:                 smtp_hook.send_email_smtp(",
          "227:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
          "228:                 )",
          "229:         assert not mock_smtp.called",
          "230:         assert not create_default_context.called",
          "231:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
          "233:     @patch(\"smtplib.SMTP_SSL\")",
          "234:     @patch(\"smtplib.SMTP\")",
          "235:     @patch(\"ssl.create_default_context\")",
          "236:     def test_send_mime_ssl_none_smtp_provider_context(self, create_default_context, mock_smtp, mock_smtp_ssl):",
          "237:         mock_smtp_ssl.return_value = Mock()",
          "238:         with conf_vars({(\"smtp\", \"smtp_ssl\"): \"True\", (\"smtp_provider\", \"ssl_context\"): \"none\"}):",
          "239:             with SmtpHook() as smtp_hook:",
          "240:                 smtp_hook.send_email_smtp(",
          "241:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
          "242:                 )",
          "243:         assert not mock_smtp.called",
          "244:         assert not create_default_context.called",
          "245:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
          "247:     @patch(\"smtplib.SMTP_SSL\")",
          "248:     @patch(\"smtplib.SMTP\")",
          "249:     @patch(\"ssl.create_default_context\")",
          "250:     def test_send_mime_ssl_none_smtp_provider_default_email_context(",
          "251:         self, create_default_context, mock_smtp, mock_smtp_ssl",
          "252:     ):",
          "253:         mock_smtp_ssl.return_value = Mock()",
          "254:         with conf_vars(",
          "255:             {",
          "256:                 (\"smtp\", \"smtp_ssl\"): \"True\",",
          "257:                 (\"email\", \"ssl_context\"): \"default\",",
          "258:                 (\"smtp_provider\", \"ssl_context\"): \"none\",",
          "259:             }",
          "260:         ):",
          "261:             with SmtpHook() as smtp_hook:",
          "262:                 smtp_hook.send_email_smtp(",
          "263:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
          "264:                 )",
          "265:         assert not mock_smtp.called",
          "266:         assert not create_default_context.called",
          "267:         mock_smtp_ssl.assert_called_once_with(host=\"smtp_server_address\", port=465, timeout=30, context=None)",
          "269:     @patch(\"smtplib.SMTP_SSL\")",
          "270:     @patch(\"smtplib.SMTP\")",
          "271:     @patch(\"ssl.create_default_context\")",
          "272:     def test_send_mime_ssl_default_smtp_provider_none_email_context(",
          "273:         self, create_default_context, mock_smtp, mock_smtp_ssl",
          "274:     ):",
          "275:         mock_smtp_ssl.return_value = Mock()",
          "276:         with conf_vars(",
          "277:             {",
          "278:                 (\"smtp\", \"smtp_ssl\"): \"True\",",
          "279:                 (\"email\", \"ssl_context\"): \"none\",",
          "280:                 (\"smtp_provider\", \"ssl_context\"): \"default\",",
          "281:             }",
          "282:         ):",
          "283:             with SmtpHook() as smtp_hook:",
          "284:                 smtp_hook.send_email_smtp(",
          "285:                     to=\"to\", subject=\"subject\", html_content=\"content\", from_email=\"from\"",
          "286:                 )",
          "287:         assert not mock_smtp.called",
          "288:         assert create_default_context.called",
          "289:         mock_smtp_ssl.assert_called_once_with(",
          "290:             host=\"smtp_server_address\", port=465, timeout=30, context=create_default_context.return_value",
          "291:         )",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "270:     @patch(\"airflow.models.connection.Connection\")",
          "271:     @patch(\"smtplib.SMTP_SSL\")",
          "273:         mock_smtp_ssl().sendmail.side_effect = smtplib.SMTPServerDisconnected()",
          "274:         custom_retry_limit = 10",
          "275:         custom_timeout = 60",
          "",
          "[Removed Lines]",
          "272:     def test_send_mime_custom_timeout_retrylimit(self, mock_smtp_ssl, connection_mock):",
          "",
          "[Added Lines]",
          "354:     @patch(\"ssl.create_default_context\")",
          "355:     def test_send_mime_custom_timeout_retrylimit(",
          "356:         self, create_default_context, mock_smtp_ssl, connection_mock",
          "357:     ):",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "287:             with pytest.raises(smtplib.SMTPServerDisconnected):",
          "288:                 smtp_hook.send_email_smtp(to=\"to\", subject=\"subject\", html_content=\"content\")",
          "289:         mock_smtp_ssl.assert_any_call(",
          "291:         )",
          "292:         assert mock_smtp_ssl().sendmail.call_count == 10",
          "",
          "[Removed Lines]",
          "290:             host=fake_conn.host, port=fake_conn.port, timeout=fake_conn.extra_dejson[\"timeout\"]",
          "",
          "[Added Lines]",
          "375:             host=fake_conn.host,",
          "376:             port=fake_conn.port,",
          "377:             timeout=fake_conn.extra_dejson[\"timeout\"],",
          "378:             context=create_default_context.return_value,",
          "380:         assert create_default_context.called",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7af9938a924f66b749c63fe302fcf865789b6b26",
      "candidate_info": {
        "commit_hash": "7af9938a924f66b749c63fe302fcf865789b6b26",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/7af9938a924f66b749c63fe302fcf865789b6b26",
        "files": [
          "airflow/config_templates/config.yml",
          "airflow/providers/openlineage/plugins/openlineage.py",
          "airflow/providers/openlineage/provider.yaml",
          "docs/apache-airflow-providers-openlineage/configurations-ref.rst",
          "docs/apache-airflow-providers-openlineage/index.rst",
          "docs/apache-airflow/configurations-ref.rst"
        ],
        "message": "Move openlineage configuration to provider (#33124)\n\n(cherry picked from commit bdc10a5ff6fea0fd968345fd4a9b732be49b9761)",
        "before_after_code_files": [
          "airflow/providers/openlineage/plugins/openlineage.py||airflow/providers/openlineage/plugins/openlineage.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/33247"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "airflow/providers/openlineage/plugins/openlineage.py||airflow/providers/openlineage/plugins/openlineage.py": [
          "File: airflow/providers/openlineage/plugins/openlineage.py -> airflow/providers/openlineage/plugins/openlineage.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: def _is_disabled() -> bool:",
          "27:     return (",
          "29:         or os.getenv(\"OPENLINEAGE_DISABLED\", \"false\").lower() == \"true\"",
          "30:         or (",
          "33:             and os.getenv(\"OPENLINEAGE_URL\", \"\") == \"\"",
          "34:             and os.getenv(\"OPENLINEAGE_CONFIG\", \"\") == \"\"",
          "35:         )",
          "",
          "[Removed Lines]",
          "28:         conf.getboolean(\"openlineage\", \"disabled\")",
          "31:             conf.get(\"openlineage\", \"transport\") == \"\"",
          "32:             and conf.get(\"openlineage\", \"config_path\") == \"\"",
          "",
          "[Added Lines]",
          "28:         conf.getboolean(\"openlineage\", \"disabled\", fallback=False)",
          "31:             conf.get(\"openlineage\", \"transport\", fallback=\"\") == \"\"",
          "32:             and conf.get(\"openlineage\", \"config_path\", fallback=\"\") == \"\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4e817c46b4c94d44b5c50665f23f19d7284b42be",
      "candidate_info": {
        "commit_hash": "4e817c46b4c94d44b5c50665f23f19d7284b42be",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/4e817c46b4c94d44b5c50665f23f19d7284b42be",
        "files": [
          "tests/models/test_xcom_arg_map.py"
        ],
        "message": "Fix flaky sqlite tests with `test_xcom_map_nest` hopefully (#33145)\n\nRecently sqlite started to fail randomly during teardown of\n`test_xcom_map_nest` or `test_xcom_map_zip_nest`. This happpened\nafter adding `test_xcom_map_zip_nest` . It looked very strange:\n\n```\nsqlite3.ProgrammingError: SQLite objects created in a thread can only be\nused in that same thread\n```\n\nBy analysing possible reasons it seems that it was a side effect\nof the existing `test_xcom_map_nest` that allocated a new\nsession in the run method of task instance rather than pass\nthe sesion that is created and torrn down in the pytest fixture.\n\nThe hypothesis is that the session created in the ``test_xcom_map_nest``\nwere being reclaimed and closed while the `test_xcom_map_zip_nest` test\nwas already starting in a different thread started by Pytest.\n\nThe fix is to pass the session object to run method of the taskinstance\nin the ``test_xcom_map_nest`` test.\n\n(cherry picked from commit d1d6fc994d46aaed9c801162595cae91a1ffc19c)",
        "before_after_code_files": [
          "tests/models/test_xcom_arg_map.py||tests/models/test_xcom_arg_map.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/33247"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/models/test_xcom_arg_map.py||tests/models/test_xcom_arg_map.py": [
          "File: tests/models/test_xcom_arg_map.py -> tests/models/test_xcom_arg_map.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "251:     # Run \"push\".",
          "252:     decision = dr.task_instance_scheduling_decisions(session=session)",
          "253:     for ti in decision.schedulable_tis:",
          "256:     session.flush()",
          "257:     session.commit()",
          "",
          "[Removed Lines]",
          "254:         ti.run()",
          "",
          "[Added Lines]",
          "254:         ti.run(session=session)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "262:     # Now \"pull\" should apply the mapping functions in order.",
          "263:     decision = dr.task_instance_scheduling_decisions(session=session)",
          "264:     for ti in decision.schedulable_tis:",
          "266:     assert results == {\"aa\", \"bb\", \"cc\"}",
          "",
          "[Removed Lines]",
          "265:         ti.run()",
          "",
          "[Added Lines]",
          "265:         ti.run(session=session)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1109ea9003216a4fea1967f4f22cdae955ccd153",
      "candidate_info": {
        "commit_hash": "1109ea9003216a4fea1967f4f22cdae955ccd153",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/1109ea9003216a4fea1967f4f22cdae955ccd153",
        "files": [
          "airflow/executors/base_executor.py",
          "airflow/providers/celery/executors/celery_executor.py",
          "airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py",
          "docs/apache-airflow-providers-celery/cli-ref.rst",
          "docs/apache-airflow-providers-celery/index.rst",
          "docs/apache-airflow-providers-cncf-kubernetes/cli-ref.rst",
          "docs/apache-airflow-providers-cncf-kubernetes/index.rst"
        ],
        "message": "aDd documentation generation for CLI commands from executors (#33081)\n\nThe #29055 moved relevant CLI command definition to executors but\nit automatically removed the command from generated documentation.\n\nThis PR brings it back for both Celery and Cncf Kubernetes provider\n\nCloses: #27932\n(cherry picked from commit 879fd34e97a5343e6d2bbf3d5373831b9641b5ad)",
        "before_after_code_files": [
          "airflow/executors/base_executor.py||airflow/executors/base_executor.py",
          "airflow/providers/celery/executors/celery_executor.py||airflow/providers/celery/executors/celery_executor.py",
          "airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py||airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/33247"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "airflow/executors/base_executor.py||airflow/executors/base_executor.py": [
          "File: airflow/executors/base_executor.py -> airflow/executors/base_executor.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: \"\"\"Base executor - this is the base class for all the implemented executors.\"\"\"",
          "18: from __future__ import annotations",
          "20: import logging",
          "21: import sys",
          "22: import warnings",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: import argparse",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28: import pendulum",
          "31: from airflow.configuration import conf",
          "32: from airflow.exceptions import RemovedInAirflow3Warning",
          "33: from airflow.stats import Stats",
          "",
          "[Removed Lines]",
          "30: from airflow.cli.cli_config import GroupCommand",
          "",
          "[Added Lines]",
          "31: from airflow.cli.cli_config import DefaultHelpParser, GroupCommand",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "489:         be commands to setup/teardown the executor, inspect state, etc.",
          "490:         \"\"\"",
          "491:         return []",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "494:     @classmethod",
          "495:     def _get_parser(cls) -> argparse.ArgumentParser:",
          "496:         \"\"\"This method is used by Sphinx argparse to generate documentation.",
          "498:         :meta private:",
          "499:         \"\"\"",
          "500:         from airflow.cli.cli_parser import AirflowHelpFormatter, _add_command",
          "502:         parser = DefaultHelpParser(prog=\"airflow\", formatter_class=AirflowHelpFormatter)",
          "503:         subparsers = parser.add_subparsers(dest=\"subcommand\", metavar=\"GROUP_OR_COMMAND\")",
          "504:         for group_command in cls.get_cli_commands():",
          "505:             _add_command(subparsers, group_command)",
          "506:         return parser",
          "",
          "---------------"
        ],
        "airflow/providers/celery/executors/celery_executor.py||airflow/providers/celery/executors/celery_executor.py": [
          "File: airflow/providers/celery/executors/celery_executor.py -> airflow/providers/celery/executors/celery_executor.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: \"\"\"",
          "24: from __future__ import annotations",
          "26: import logging",
          "27: import math",
          "28: import operator",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: import argparse",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "480:                 subcommands=CELERY_COMMANDS,",
          "481:             ),",
          "482:         ]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "486: def _get_parser() -> argparse.ArgumentParser:",
          "487:     \"\"\"This method is used by Sphinx to generate documentation.",
          "489:     :meta private:",
          "490:     \"\"\"",
          "491:     return CeleryExecutor._get_parser()",
          "",
          "---------------"
        ],
        "airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py||airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py": [
          "File: airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py -> airflow/providers/cncf/kubernetes/executors/kubernetes_executor.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: \"\"\"",
          "24: from __future__ import annotations",
          "26: import json",
          "27: import logging",
          "28: import multiprocessing",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: import argparse",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "728:                 subcommands=KUBERNETES_COMMANDS,",
          "729:             )",
          "730:         ]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "734: def _get_parser() -> argparse.ArgumentParser:",
          "735:     \"\"\"This method is used by Sphinx to generate documentation.",
          "737:     :meta private:",
          "738:     \"\"\"",
          "739:     return KubernetesExecutor._get_parser()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "489d3dd6e91b1320d072a8a919890db3241e1756",
      "candidate_info": {
        "commit_hash": "489d3dd6e91b1320d072a8a919890db3241e1756",
        "repo": "apache/airflow",
        "commit_url": "https://github.com/apache/airflow/commit/489d3dd6e91b1320d072a8a919890db3241e1756",
        "files": [
          "tests/models/test_xcom_arg_map.py"
        ],
        "message": "Give the the test_xcom_ar_map test opportunity to flush the data (#33153)\n\nUsing same session in different steps of the same test has the\npotential of not flishing/committing the changes between.\n\nSeems that the #33150 traded one flakiness with another. Attempting to\nmake sure that the flash/commit is executed before the second run.\n\nError:\n\nThe test RuntimeError: number of values in row (0) differ from number of\ncolumn processors (29)\n\nThe error is strange however and indicates a bug in sqlite library.\n\n(cherry picked from commit 6b21b79f33e245ff1612b1970d05ef692c41f15c)",
        "before_after_code_files": [
          "tests/models/test_xcom_arg_map.py||tests/models/test_xcom_arg_map.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/airflow/pull/33247"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/models/test_xcom_arg_map.py||tests/models/test_xcom_arg_map.py": [
          "File: tests/models/test_xcom_arg_map.py -> tests/models/test_xcom_arg_map.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "253:     for ti in decision.schedulable_tis:",
          "254:         ti.run()",
          "256:     # Now \"pull\" should apply the mapping functions in order.",
          "257:     decision = dr.task_instance_scheduling_decisions(session=session)",
          "258:     for ti in decision.schedulable_tis:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "256:     session.flush()",
          "257:     session.commit()",
          "",
          "---------------"
        ]
      }
    }
  ]
}