{
  "cve_id": "CVE-2023-5236",
  "cve_desc": "A flaw was found in Infinispan, which does not detect circular object references when unmarshalling. An authenticated attacker with sufficient permissions could insert a maliciously constructed object into the cache and use it to cause out of memory errors and achieve a denial of service.",
  "repo": "infinispan/protostream",
  "patch_hash": "4501b6b307a6bab545346f66238f8be7e42f83eb",
  "patch_info": {
    "commit_hash": "4501b6b307a6bab545346f66238f8be7e42f83eb",
    "repo": "infinispan/protostream",
    "commit_url": "https://github.com/infinispan/protostream/commit/4501b6b307a6bab545346f66238f8be7e42f83eb",
    "files": [
      "core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java",
      "core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java",
      "core/src/main/java/org/infinispan/protostream/impl/Log.java"
    ],
    "message": "IPROTO-263 Limit message nested depth on generated marshallers",
    "before_after_code_files": [
      "core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java||core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java",
      "core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java||core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java",
      "core/src/main/java/org/infinispan/protostream/impl/Log.java||core/src/main/java/org/infinispan/protostream/impl/Log.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java||core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java": [
      "File: core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java -> core/src/main/java/org/infinispan/protostream/annotations/impl/GeneratedMarshallerBase.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: import org.infinispan.protostream.ProtobufTagMarshaller;",
      "6: import org.infinispan.protostream.impl.BaseMarshallerDelegate;",
      "7: import org.infinispan.protostream.impl.ByteArrayOutputStreamEx;",
      "8: import org.infinispan.protostream.impl.TagWriterImpl;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "8: import org.infinispan.protostream.impl.Log;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "16: @SuppressWarnings(\"unused\")",
      "17: public class GeneratedMarshallerBase {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20:    private static final Log log = Log.LogFactory.getLog(GeneratedMarshallerBase.class);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "40:    protected final <T> void writeNestedMessage(BaseMarshallerDelegate<T> marshallerDelegate, ProtobufTagMarshaller.WriteContext ctx, int fieldNumber, T message) throws IOException {",
      "41:       ByteArrayOutputStreamEx baos = new ByteArrayOutputStreamEx();",
      "42:       TagWriterImpl nested = TagWriterImpl.newNestedInstance(ctx, baos);",
      "43:       writeMessage(marshallerDelegate, nested, message);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "44:       int maxNestedMessageDepth = ctx.getSerializationContext().getConfiguration().maxNestedMessageDepth();",
      "45:       if (ctx.depth() >= maxNestedMessageDepth) {",
      "46:          throw log.maxNestedMessageDepth(maxNestedMessageDepth, message.getClass());",
      "47:       }",
      "",
      "---------------"
    ],
    "core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java||core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java": [
      "File: core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java -> core/src/main/java/org/infinispan/protostream/exception/ProtoStreamException.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: package org.infinispan.protostream.exception;",
      "3: public class ProtoStreamException extends RuntimeException {",
      "5:    public ProtoStreamException() {",
      "6:       super();",
      "7:    }",
      "9:    public ProtoStreamException(Throwable cause) {",
      "10:       super(cause);",
      "11:    }",
      "13:    public ProtoStreamException(String msg) {",
      "14:       super(msg);",
      "15:    }",
      "17:    public ProtoStreamException(String msg, Throwable cause) {",
      "18:       super(msg, cause);",
      "19:    }",
      "21:    public ProtoStreamException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {",
      "22:       super(message, cause, enableSuppression, writableStackTrace);",
      "23:    }",
      "24: }",
      "",
      "---------------"
    ],
    "core/src/main/java/org/infinispan/protostream/impl/Log.java||core/src/main/java/org/infinispan/protostream/impl/Log.java": [
      "File: core/src/main/java/org/infinispan/protostream/impl/Log.java -> core/src/main/java/org/infinispan/protostream/impl/Log.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: import java.io.IOException;",
      "7: import org.infinispan.protostream.MalformedProtobufException;",
      "8: import org.jboss.logging.BasicLogger;",
      "9: import org.jboss.logging.Logger;",
      "10: import org.jboss.logging.annotations.Cause;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "8: import org.infinispan.protostream.exception.ProtoStreamException;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "45:    @Message(value = \"Ran out of buffer space\", id = 7)",
      "46:    IOException outOfWriteBufferSpace(@Cause Throwable cause);",
      "48:    class LogFactory {",
      "49:       public static Log getLog(Class<?> clazz) {",
      "50:          return Logger.getMessageLogger(Log.class, clazz.getName());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "49:    @Message(value = \"The nested message depth appears to be larger than the configured limit of '%s'.\" +",
      "50:          \"It is possible that the entity to marshall with type '%s' can have some circular dependencies.\", id = 8)",
      "51:    ProtoStreamException maxNestedMessageDepth(int maxNestedMessageDepth, Class<?> entityType);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5caed435d5937eb10319c05426a2ea8afd91bfff",
      "candidate_info": {
        "commit_hash": "5caed435d5937eb10319c05426a2ea8afd91bfff",
        "repo": "infinispan/protostream",
        "commit_url": "https://github.com/infinispan/protostream/commit/5caed435d5937eb10319c05426a2ea8afd91bfff",
        "files": [
          "integrationtests/pom.xml",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java",
          "parent/pom.xml"
        ],
        "message": "IPROTO-263 Test circular dependencies entity marshalling",
        "before_after_code_files": [
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java",
          "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/infinispan/protostream/pull/189"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java": [
          "File: integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java -> integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/GeneratedMarshallerTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package org.infinispan.protostream.integrationtests.processor.marshaller;",
          "3: import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;",
          "4: import static org.junit.Assert.assertTrue;",
          "6: import java.util.Collections;",
          "8: import org.infinispan.protostream.GeneratedSchema;",
          "9: import org.infinispan.protostream.ProtobufUtil;",
          "10: import org.infinispan.protostream.SerializationContext;",
          "11: import org.infinispan.protostream.exception.ProtoStreamException;",
          "12: import org.infinispan.protostream.integrationtests.processor.marshaller.model.FootballSchemaImpl;",
          "13: import org.infinispan.protostream.integrationtests.processor.marshaller.model.FootballTeam;",
          "14: import org.infinispan.protostream.integrationtests.processor.marshaller.model.Player;",
          "15: import org.junit.Test;",
          "17: public class GeneratedMarshallerTest {",
          "19:    @Test",
          "20:    public void testGenericMessage() {",
          "21:       SerializationContext ctx = ProtobufUtil.newSerializationContext();",
          "23:       GeneratedSchema generatedSchema = new FootballSchemaImpl();",
          "24:       generatedSchema.registerSchema(ctx);",
          "25:       generatedSchema.registerMarshallers(ctx);",
          "27:       assertTrue(generatedSchema.getProtoFile().contains(\"message Player\"));",
          "29:       FootballTeam footBallTeam = new FootballTeam();",
          "30:       footBallTeam.setName(\"New-Team\");",
          "32:       Player player = new Player(\"fax4ever\", footBallTeam);",
          "33:       footBallTeam.setPlayers(Collections.singletonList(player));",
          "35:       assertThatThrownBy(() -> ProtobufUtil.toWrappedByteArray(ctx, player))",
          "36:             .isInstanceOf(ProtoStreamException.class)",
          "37:             .hasMessageContaining(\"IPROTO000008\");",
          "38:    }",
          "39: }",
          "",
          "---------------"
        ],
        "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java": [
          "File: integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java -> integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballSchema.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package org.infinispan.protostream.integrationtests.processor.marshaller.model;",
          "3: import org.infinispan.protostream.GeneratedSchema;",
          "4: import org.infinispan.protostream.annotations.AutoProtoSchemaBuilder;",
          "6: @AutoProtoSchemaBuilder(includeClasses = { FootballTeam.class, Player.class }, schemaPackageName = \"org.football\",",
          "7:       schemaFileName = \"football.proto\", schemaFilePath = \"proto\")",
          "8: public interface FootballSchema extends GeneratedSchema {",
          "10: }",
          "",
          "---------------"
        ],
        "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java": [
          "File: integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java -> integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/FootballTeam.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package org.infinispan.protostream.integrationtests.processor.marshaller.model;",
          "3: import java.util.List;",
          "5: import org.infinispan.protostream.annotations.ProtoField;",
          "7: public class FootballTeam {",
          "9:    private String name;",
          "10:    private List<Player> players;",
          "12:    @ProtoField(value = 1)",
          "13:    public String getName() {",
          "14:       return name;",
          "15:    }",
          "17:    public void setName(String name) {",
          "18:       this.name = name;",
          "19:    }",
          "21:    @ProtoField(value = 2)",
          "22:    public List<Player> getPlayers() {",
          "23:       return players;",
          "24:    }",
          "26:    public void setPlayers(List<Player> players) {",
          "27:       this.players = players;",
          "28:    }",
          "29: }",
          "",
          "---------------"
        ],
        "integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java||integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java": [
          "File: integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java -> integrationtests/src/test/java/org/infinispan/protostream/integrationtests/processor/marshaller/model/Player.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package org.infinispan.protostream.integrationtests.processor.marshaller.model;",
          "3: import org.infinispan.protostream.annotations.ProtoFactory;",
          "4: import org.infinispan.protostream.annotations.ProtoField;",
          "6: public class Player {",
          "8:    private String name;",
          "9:    private FootballTeam footballTeam;",
          "11:    @ProtoFactory",
          "12:    public Player(String name, FootballTeam footballTeam) {",
          "13:       this.name = name;",
          "14:       this.footballTeam = footballTeam;",
          "15:    }",
          "17:    @ProtoField(value = 1)",
          "18:    public String getName() {",
          "19:       return name;",
          "20:    }",
          "22:    @ProtoField(value = 2)",
          "23:    public FootballTeam getFootballTeam() {",
          "24:       return footballTeam;",
          "25:    }",
          "26: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}