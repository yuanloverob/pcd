{
  "cve_id": "CVE-2018-15133",
  "cve_desc": "In Laravel Framework through 5.5.40 and 5.6.x through 5.6.29, remote code execution might occur as a result of an unserialize call on a potentially untrusted X-XSRF-TOKEN value. This involves the decrypt method in Illuminate/Encryption/Encrypter.php and PendingBroadcast in gadgetchains/Laravel/RCE/3/chain.php in phpggc. The attacker must know the application key, which normally would never occur, but could happen if the attacker previously had privileged access or successfully accomplished a previous attack.",
  "repo": "laravel/framework",
  "patch_hash": "d84cf988ed5d4661a4bf1fdcb08f5073835083a0",
  "patch_info": {
    "commit_hash": "d84cf988ed5d4661a4bf1fdcb08f5073835083a0",
    "repo": "laravel/framework",
    "commit_url": "https://github.com/laravel/framework/commit/d84cf988ed5d4661a4bf1fdcb08f5073835083a0",
    "files": [
      "src/Illuminate/Cookie/Middleware/EncryptCookies.php",
      "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
    ],
    "message": "dont serialize csrf cookie / header",
    "before_after_code_files": [
      "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php",
      "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
    ]
  },
  "patch_diff": {
    "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php": [
      "File: src/Illuminate/Cookie/Middleware/EncryptCookies.php -> src/Illuminate/Cookie/Middleware/EncryptCookies.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "26:     protected $except = [];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "33:     protected $serialization = [",
      "34:         'XSRF-TOKEN' => false,",
      "35:     ];",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "73:             }",
      "75:             try {",
      "77:             } catch (DecryptException $e) {",
      "78:                 $request->cookies->set($key, null);",
      "79:             }",
      "",
      "[Removed Lines]",
      "76:                 $request->cookies->set($key, $this->decryptCookie($cookie));",
      "",
      "[Added Lines]",
      "85:                 $request->cookies->set($key, $this->decryptCookie($key, $cookie));",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "92:     {",
      "93:         return is_array($cookie)",
      "94:                         ? $this->decryptArray($cookie)",
      "96:     }",
      "",
      "[Removed Lines]",
      "91:     protected function decryptCookie($cookie)",
      "95:                         : $this->encrypter->decrypt($cookie);",
      "",
      "[Added Lines]",
      "101:     protected function decryptCookie($name, $cookie)",
      "105:                         : $this->encrypter->decrypt($cookie, $this->serialization[$name] ?? true);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "108:         foreach ($cookie as $key => $value) {",
      "109:             if (is_string($value)) {",
      "111:             }",
      "112:         }",
      "",
      "[Removed Lines]",
      "110:                 $decrypted[$key] = $this->encrypter->decrypt($value);",
      "",
      "[Added Lines]",
      "120:                 $decrypted[$key] = $this->encrypter->decrypt($value, $this->serialization[$key] ?? true);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "127:                 continue;",
      "128:             }",
      "130:             $response->headers->setCookie($this->duplicate(",
      "132:             ));",
      "133:         }",
      "",
      "[Removed Lines]",
      "131:                 $cookie, $this->encrypter->encrypt($cookie->getValue())",
      "",
      "[Added Lines]",
      "140:             $serialize = $this->serialization[$cookie->getName()] ?? true;",
      "143:                 $cookie, $this->encrypter->encrypt($cookie->getValue(), $serialize)",
      "",
      "---------------"
    ],
    "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php": [
      "File: src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php -> src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "138:         $token = $request->input('_token') ?: $request->header('X-CSRF-TOKEN');",
      "140:         if (! $token && $header = $request->header('X-XSRF-TOKEN')) {",
      "142:         }",
      "144:         return $token;",
      "",
      "[Removed Lines]",
      "141:             $token = $this->encrypter->decrypt($header);",
      "",
      "[Added Lines]",
      "141:             $token = $this->encrypter->decrypt($header, false);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c0eb9073eb2cedab1db6c0d1ea4b3aecdc258597",
      "candidate_info": {
        "commit_hash": "c0eb9073eb2cedab1db6c0d1ea4b3aecdc258597",
        "repo": "laravel/framework",
        "commit_url": "https://github.com/laravel/framework/commit/c0eb9073eb2cedab1db6c0d1ea4b3aecdc258597",
        "files": [
          "src/Illuminate/Cookie/Middleware/EncryptCookies.php",
          "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
        ],
        "message": "dont serialize csrf cookie / header (#25121)",
        "before_after_code_files": [
          "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php",
          "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/laravel/framework/pull/25121"
        ],
        "olp_code_files": {
          "patch": [
            "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php",
            "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
          ],
          "candidate": [
            "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php",
            "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Illuminate/Cookie/Middleware/EncryptCookies.php||src/Illuminate/Cookie/Middleware/EncryptCookies.php": [
          "File: src/Illuminate/Cookie/Middleware/EncryptCookies.php -> src/Illuminate/Cookie/Middleware/EncryptCookies.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "26:     protected $except = [];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33:     protected $serialization = [",
          "34:         'XSRF-TOKEN' => false,",
          "35:     ];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73:             }",
          "75:             try {",
          "77:             } catch (DecryptException $e) {",
          "78:                 $request->cookies->set($key, null);",
          "79:             }",
          "",
          "[Removed Lines]",
          "76:                 $request->cookies->set($key, $this->decryptCookie($cookie));",
          "",
          "[Added Lines]",
          "85:                 $request->cookies->set($key, $this->decryptCookie($key, $cookie));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "92:     {",
          "93:         return is_array($cookie)",
          "94:                         ? $this->decryptArray($cookie)",
          "96:     }",
          "",
          "[Removed Lines]",
          "91:     protected function decryptCookie($cookie)",
          "95:                         : $this->encrypter->decrypt($cookie);",
          "",
          "[Added Lines]",
          "101:     protected function decryptCookie($name, $cookie)",
          "105:                         : $this->encrypter->decrypt($cookie, $this->serialization[$name] ?? true);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "108:         foreach ($cookie as $key => $value) {",
          "109:             if (is_string($value)) {",
          "111:             }",
          "112:         }",
          "",
          "[Removed Lines]",
          "110:                 $decrypted[$key] = $this->encrypter->decrypt($value);",
          "",
          "[Added Lines]",
          "120:                 $decrypted[$key] = $this->encrypter->decrypt($value, $this->serialization[$key] ?? true);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "127:                 continue;",
          "128:             }",
          "130:             $response->headers->setCookie($this->duplicate(",
          "132:             ));",
          "133:         }",
          "",
          "[Removed Lines]",
          "131:                 $cookie, $this->encrypter->encrypt($cookie->getValue())",
          "",
          "[Added Lines]",
          "140:             $serialize = $this->serialization[$cookie->getName()] ?? true;",
          "143:                 $cookie, $this->encrypter->encrypt($cookie->getValue(), $serialize)",
          "",
          "---------------"
        ],
        "src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php||src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php": [
          "File: src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php -> src/Illuminate/Foundation/Http/Middleware/VerifyCsrfToken.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:         $token = $request->input('_token') ?: $request->header('X-CSRF-TOKEN');",
          "140:         if (! $token && $header = $request->header('X-XSRF-TOKEN')) {",
          "142:         }",
          "144:         return $token;",
          "",
          "[Removed Lines]",
          "141:             $token = $this->encrypter->decrypt($header);",
          "",
          "[Added Lines]",
          "141:             $token = $this->encrypter->decrypt($header, false);",
          "",
          "---------------"
        ]
      }
    }
  ]
}