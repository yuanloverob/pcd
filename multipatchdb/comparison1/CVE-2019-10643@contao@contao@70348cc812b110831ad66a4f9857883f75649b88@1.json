{
  "cve_id": "CVE-2019-10643",
  "cve_desc": "Contao 4.7 allows Use of a Key Past its Expiration Date.",
  "repo": "contao/contao",
  "patch_hash": "70348cc812b110831ad66a4f9857883f75649b88",
  "patch_info": {
    "commit_hash": "70348cc812b110831ad66a4f9857883f75649b88",
    "repo": "contao/contao",
    "commit_url": "https://github.com/contao/contao/commit/70348cc812b110831ad66a4f9857883f75649b88",
    "files": [
      "CHANGELOG.md",
      "comments-bundle/src/Resources/contao/classes/Comments.php",
      "core-bundle/src/OptIn/OptIn.php",
      "core-bundle/src/OptIn/OptInToken.php",
      "core-bundle/src/Resources/contao/controllers/BackendConfirm.php",
      "core-bundle/src/Resources/contao/dca/tl_opt_in.php",
      "core-bundle/src/Resources/contao/languages/en/default.xlf",
      "core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf",
      "core-bundle/src/Resources/contao/models/OptInModel.php",
      "core-bundle/src/Resources/contao/modules/ModulePassword.php",
      "core-bundle/src/Resources/contao/modules/ModuleRegistration.php",
      "core-bundle/tests/OptIn/OptInTest.php",
      "core-bundle/tests/OptIn/OptInTokenTest.php",
      "newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php"
    ],
    "message": "Invalidate old opt-in tokens when a token is confirmed (see CVE-2019-10643)",
    "before_after_code_files": [
      "comments-bundle/src/Resources/contao/classes/Comments.php||comments-bundle/src/Resources/contao/classes/Comments.php",
      "core-bundle/src/OptIn/OptIn.php||core-bundle/src/OptIn/OptIn.php",
      "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php",
      "core-bundle/src/Resources/contao/controllers/BackendConfirm.php||core-bundle/src/Resources/contao/controllers/BackendConfirm.php",
      "core-bundle/src/Resources/contao/dca/tl_opt_in.php||core-bundle/src/Resources/contao/dca/tl_opt_in.php",
      "core-bundle/src/Resources/contao/languages/en/default.xlf||core-bundle/src/Resources/contao/languages/en/default.xlf",
      "core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf||core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf",
      "core-bundle/src/Resources/contao/models/OptInModel.php||core-bundle/src/Resources/contao/models/OptInModel.php",
      "core-bundle/src/Resources/contao/modules/ModulePassword.php||core-bundle/src/Resources/contao/modules/ModulePassword.php",
      "core-bundle/src/Resources/contao/modules/ModuleRegistration.php||core-bundle/src/Resources/contao/modules/ModuleRegistration.php",
      "core-bundle/tests/OptIn/OptInTest.php||core-bundle/tests/OptIn/OptInTest.php",
      "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php",
      "newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php||newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php"
    ]
  },
  "patch_diff": {
    "comments-bundle/src/Resources/contao/classes/Comments.php||comments-bundle/src/Resources/contao/classes/Comments.php": [
      "File: comments-bundle/src/Resources/contao/classes/Comments.php -> comments-bundle/src/Resources/contao/classes/Comments.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "586:   $optIn = System::getContainer()->get('contao.opt-in');",
      "590:   $optInToken->send(sprintf($GLOBALS['TL_LANG']['MSC']['com_optInSubject'], Idna::decode(Environment::get('host'))), sprintf($GLOBALS['TL_LANG']['MSC']['com_optInMessage'], $objComment->name, $strUrl, $strUrl . $strConnector . 'token=' . $optInToken->getIdentifier(), $strUrl . $strConnector . 'token=' . $objNotify->tokenRemove));",
      "",
      "[Removed Lines]",
      "587:   $optInToken = $optIn->create('com-', $objComment->email, array('tl_comments_notify'=>array($objNotify->id)));",
      "",
      "[Added Lines]",
      "587:   $optInToken = $optIn->create('com', $objComment->email, array('tl_comments_notify'=>array($objNotify->id)));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "603:    $optIn = System::getContainer()->get('contao.opt-in');",
      "607:    {",
      "610:     return;",
      "611:    }",
      "",
      "[Removed Lines]",
      "606:    if ((!$optInToken = $optIn->find(Input::get('token'))) || $optInToken->isConfirmed() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_comments_notify' || \\count($arrIds = current($arrRelated)) != 1 || (!$objNotify = CommentsNotifyModel::findByPk($arrIds[0])))",
      "608:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['invalidTokenUrl'];",
      "",
      "[Added Lines]",
      "606:    if ((!$optInToken = $optIn->find(Input::get('token'))) || !$optInToken->isValid() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_comments_notify' || \\count($arrIds = current($arrRelated)) != 1 || (!$objNotify = CommentsNotifyModel::findByPk($arrIds[0])))",
      "608:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "610:     return;",
      "611:    }",
      "613:    if ($optInToken->isConfirmed())",
      "614:    {",
      "615:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['tokenConfirmed'];",
      "617:     return;",
      "618:    }",
      "620:    if ($optInToken->getEmail() != $objNotify->email)",
      "621:    {",
      "622:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['tokenEmailMismatch'];",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "624:    if ($objNotify === null)",
      "625:    {",
      "628:     return;",
      "629:    }",
      "",
      "[Removed Lines]",
      "626:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['invalidTokenUrl'];",
      "",
      "[Added Lines]",
      "640:     $objTemplate->confirm = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "",
      "---------------"
    ],
    "core-bundle/src/OptIn/OptIn.php||core-bundle/src/OptIn/OptIn.php": [
      "File: core-bundle/src/OptIn/OptIn.php -> core-bundle/src/OptIn/OptIn.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:     public function create(string $prefix, string $email, array $related): OptInTokenInterface",
      "35:     {",
      "36:         if (\\strlen($prefix) > 6) {",
      "37:             throw new \\InvalidArgumentException('The token prefix must not be longer than 6 characters');",
      "38:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "36:         if ($prefix) {",
      "37:             $prefix = rtrim($prefix, '-');",
      "38:         }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "40:         $token = bin2hex(random_bytes(12));",
      "42:         if ($prefix) {",
      "44:         }",
      "",
      "[Removed Lines]",
      "43:             $token = $prefix.substr($token, \\strlen($prefix));",
      "",
      "[Added Lines]",
      "47:             $token = $prefix.'-'.substr($token, \\strlen($prefix) + 1);",
      "",
      "---------------"
    ],
    "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php": [
      "File: core-bundle/src/OptIn/OptInToken.php -> core-bundle/src/OptIn/OptInToken.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "56:     public function isValid(): bool",
      "57:     {",
      "59:     }",
      "",
      "[Removed Lines]",
      "58:         return $this->model->createdOn > strtotime('-24 hours');",
      "",
      "[Added Lines]",
      "58:         return !$this->model->invalidatedThrough && $this->model->createdOn > strtotime('-24 hours');",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "75:         $this->model->confirmedOn = time();",
      "76:         $this->model->removeOn = strtotime('+3 years');",
      "77:         $this->model->save();",
      "78:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "79:         $related = $this->model->getRelatedRecords();",
      "81:         if (empty($related)) {",
      "82:             return;",
      "83:         }",
      "86:         $adapter = $this->framework->getAdapter(OptInModel::class);",
      "87:         $prefix = strtok($this->getIdentifier(), '-');",
      "90:         foreach ($related as $table => $ids) {",
      "91:             if (!$models = $adapter->findByRelatedTableAndIds($table, $ids)) {",
      "92:                 continue;",
      "93:             }",
      "95:             foreach ($models as $model) {",
      "96:                 if (",
      "97:                     $model->confirmedOn > 0",
      "98:                     || $model->invalidatedThrough",
      "99:                     || $model->token === $this->getIdentifier()",
      "100:                     || 0 !== strncmp($model->token, $prefix.'-', \\strlen($prefix) + 1)",
      "101:                 ) {",
      "102:                     continue;",
      "103:                 }",
      "105:                 $token = new OptInToken($model, $this->framework);",
      "108:                 if ($token->getRelatedRecords() !== $related) {",
      "109:                     continue;",
      "110:                 }",
      "112:                 $model->invalidatedThrough = $this->model->token;",
      "113:                 $model->save();",
      "114:             }",
      "115:         }",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/controllers/BackendConfirm.php||core-bundle/src/Resources/contao/controllers/BackendConfirm.php": [
      "File: core-bundle/src/Resources/contao/controllers/BackendConfirm.php -> core-bundle/src/Resources/contao/controllers/BackendConfirm.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "145:   $objTemplate->link = StringUtil::specialchars($url);",
      "146:   $objTemplate->info = $arrInfo;",
      "147:   $objTemplate->labels = $GLOBALS['TL_LANG']['CONFIRM'];",
      "149:   $objTemplate->cancel = $GLOBALS['TL_LANG']['MSC']['cancelBT'];",
      "150:   $objTemplate->continue = $GLOBALS['TL_LANG']['MSC']['continue'];",
      "151:   $objTemplate->theme = Backend::getTheme();",
      "152:   $objTemplate->base = Environment::get('base');",
      "153:   $objTemplate->language = $GLOBALS['TL_LANGUAGE'];",
      "156:   $objTemplate->host = Environment::get('host');",
      "157:   $objTemplate->charset = Config::get('characterSet');",
      "",
      "[Removed Lines]",
      "148:   $objTemplate->explain = $GLOBALS['TL_LANG']['ERR']['invalidTokenUrl'];",
      "154:   $objTemplate->h1 = $GLOBALS['TL_LANG']['MSC']['invalidTokenUrl'];",
      "155:   $objTemplate->title = StringUtil::specialchars($GLOBALS['TL_LANG']['MSC']['invalidTokenUrl']);",
      "",
      "[Added Lines]",
      "148:   $objTemplate->explain = $GLOBALS['TL_LANG']['MSC']['invalidTokenUrl'];",
      "154:   $objTemplate->h1 = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "155:   $objTemplate->title = StringUtil::specialchars($GLOBALS['TL_LANG']['MSC']['invalidToken']);",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/dca/tl_opt_in.php||core-bundle/src/Resources/contao/dca/tl_opt_in.php": [
      "File: core-bundle/src/Resources/contao/dca/tl_opt_in.php -> core-bundle/src/Resources/contao/dca/tl_opt_in.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "110:    'eval'                    => array('rgxp'=>'datim'),",
      "111:    'sql'                     => \"int(10) unsigned NOT NULL default '0'\"",
      "112:   ),",
      "113:   'email' => array",
      "114:   (",
      "115:    'label'                   => &$GLOBALS['TL_LANG']['MSC']['emailAddress'],",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "113:   'invalidatedThrough' => array",
      "114:   (",
      "115:    'label'                   => &$GLOBALS['TL_LANG']['tl_opt_in']['invalidatedThrough'],",
      "116:    'search'                  => true,",
      "117:    'sql'                     => \"varchar(24) NOT NULL default ''\"",
      "118:   ),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "202:  public function resendButton($row, $href, $label, $title, $icon, $attributes)",
      "203:  {",
      "205:  }",
      "206: }",
      "",
      "[Removed Lines]",
      "204:   return (!$row['confirmedOn'] && $row['emailSubject'] && $row['emailText'] && $row['createdOn'] > strtotime('-24 hours')) ? '<a href=\"'.$this->addToUrl($href.'&amp;id='.$row['id']).'\" title=\"'.Contao\\StringUtil::specialchars($title).'\"'.$attributes.'>'.Contao\\Image::getHtml($icon, $label).'</a> ' : '';",
      "",
      "[Added Lines]",
      "210:   return (!$row['confirmedOn'] &&!$row['invalidatedThrough'] && $row['emailSubject'] && $row['emailText'] && $row['createdOn'] > strtotime('-24 hours')) ? '<a href=\"'.$this->addToUrl($href.'&amp;id='.$row['id']).'\" title=\"'.Contao\\StringUtil::specialchars($title).'\"'.$attributes.'>'.Contao\\Image::getHtml($icon, $label).'</a> ' : '';",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/languages/en/default.xlf||core-bundle/src/Resources/contao/languages/en/default.xlf": [
      "File: core-bundle/src/Resources/contao/languages/en/default.xlf -> core-bundle/src/Resources/contao/languages/en/default.xlf",
      "--- Hunk 1 ---",
      "[Context before]",
      "188:       <trans-unit id=\"ERR.topLevelRegular\">",
      "189:         <source>There are top-level pages in the site structure which are not website root pages.</source>",
      "190:       </trans-unit>",
      "194:       <trans-unit id=\"ERR.form\">",
      "195:         <source>The form could not be sent</source>",
      "196:       </trans-unit>",
      "",
      "[Removed Lines]",
      "191:       <trans-unit id=\"ERR.invalidTokenUrl\">",
      "192:         <source>The link you were trying to open could not be verified. If you have clicked the link yourself or have received it by a trustworthy person, you can confirm the process below.</source>",
      "193:       </trans-unit>",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1736:       <trans-unit id=\"MSC.relevance\">",
      "1737:         <source>%s relevance</source>",
      "1738:       </trans-unit>",
      "1740:         <source>Invalid token</source>",
      "1741:       </trans-unit>",
      "1742:       <trans-unit id=\"MSC.resendToken\">",
      "1743:         <source>The token has been re-sent to %s.</source>",
      "1744:       </trans-unit>",
      "1745:       <trans-unit id=\"MSC.versionConflict\">",
      "1746:         <source>Version conflict</source>",
      "1747:       </trans-unit>",
      "",
      "[Removed Lines]",
      "1739:       <trans-unit id=\"MSC.invalidTokenUrl\">",
      "",
      "[Added Lines]",
      "1736:       <trans-unit id=\"MSC.invalidToken\">",
      "1739:       <trans-unit id=\"MSC.tokenConfirmed\">",
      "1740:         <source>This token has already been confirmed</source>",
      "1741:       </trans-unit>",
      "1742:       <trans-unit id=\"MSC.tokenEmailMismatch\">",
      "1743:         <source>The e-mail address of the token does not match</source>",
      "1744:       </trans-unit>",
      "1748:       <trans-unit id=\"MSC.invalidTokenUrl\">",
      "1749:         <source>The link you were trying to open could not be verified. If you have clicked the link yourself or have received it by a trustworthy person, you can confirm the process below.</source>",
      "1750:       </trans-unit>",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf||core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf": [
      "File: core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf -> core-bundle/src/Resources/contao/languages/en/tl_opt_in.xlf",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:       <trans-unit id=\"tl_opt_in.removeOn\">",
      "12:         <source>Remove on</source>",
      "13:       </trans-unit>",
      "14:       <trans-unit id=\"tl_opt_in.emailSubject\">",
      "15:         <source>E-mail subject</source>",
      "16:       </trans-unit>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14:       <trans-unit id=\"tl_opt_in.invalidatedThrough\">",
      "15:         <source>Invalidated through</source>",
      "16:       </trans-unit>",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/models/OptInModel.php||core-bundle/src/Resources/contao/models/OptInModel.php": [
      "File: core-bundle/src/Resources/contao/models/OptInModel.php -> core-bundle/src/Resources/contao/models/OptInModel.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "98:  public static function findOneByRelatedTableAndId($strTable, $intId, array $arrOptions=array())",
      "99:  {",
      "100:   $t = static::$strTable;",
      "101:   $objDatabase = Database::getInstance();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "107:   @trigger_error('Using the Contao\\OptInModel::findOneByRelatedTableAndIds() method has been deprecated and will no longer work in Contao 5.0. Use the Contao\\OptInModel::findByRelatedTableAndIds() method instead.', E_USER_DEPRECATED);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "119:   return new static($objResult);",
      "120:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "140:  public static function findByRelatedTableAndIds($strTable, array $arrIds, array $arrOptions=array())",
      "141:  {",
      "142:   $t = static::$strTable;",
      "143:   $objDatabase = Database::getInstance();",
      "145:   $objResult = $objDatabase->prepare(\"SELECT * FROM $t WHERE $t.id IN (SELECT pid FROM tl_opt_in_related WHERE relTable=? AND relId IN(\" . implode(',', array_map('\\intval', $arrIds)) . \")) ORDER BY $t.createdOn DESC\")",
      "146:          ->execute($strTable, $arrIds);",
      "148:   if ($objResult->numRows < 1)",
      "149:   {",
      "150:    return null;",
      "151:   }",
      "153:   $arrModels = array();",
      "154:   $objRegistry = Registry::getInstance();",
      "156:   while ($objResult->next())",
      "157:   {",
      "159:    if ($objOptIn = $objRegistry->fetch($t, $objResult->id))",
      "160:    {",
      "161:     $arrModels[] = $objOptIn;",
      "162:    }",
      "163:    else",
      "164:    {",
      "165:     $arrModels[] = new static($objResult->row());",
      "166:    }",
      "167:   }",
      "169:   return static::createCollection($arrModels, $t);",
      "170:  }",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/modules/ModulePassword.php||core-bundle/src/Resources/contao/modules/ModulePassword.php": [
      "File: core-bundle/src/Resources/contao/modules/ModulePassword.php -> core-bundle/src/Resources/contao/modules/ModulePassword.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "177:   $optIn = System::getContainer()->get('contao.opt-in');",
      "181:   {",
      "182:    $this->strTemplate = 'mod_message';",
      "184:    $this->Template = new FrontendTemplate($this->strTemplate);",
      "185:    $this->Template->type = 'error';",
      "188:    return;",
      "189:   }",
      "",
      "[Removed Lines]",
      "180:   if ((!$optInToken = $optIn->find(Input::get('token'))) || $optInToken->isConfirmed() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_member' || \\count($arrIds = current($arrRelated)) != 1 || (!$objMember = MemberModel::findByPk($arrIds[0])))",
      "186:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['accountError'];",
      "",
      "[Added Lines]",
      "180:   if ((!$optInToken = $optIn->find(Input::get('token'))) || !$optInToken->isValid() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_member' || \\count($arrIds = current($arrRelated)) != 1 || (!$objMember = MemberModel::findByPk($arrIds[0])))",
      "186:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "188:    return;",
      "189:   }",
      "191:   if ($optInToken->isConfirmed())",
      "192:   {",
      "193:    $this->strTemplate = 'mod_message';",
      "195:    $this->Template = new FrontendTemplate($this->strTemplate);",
      "196:    $this->Template->type = 'error';",
      "197:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenConfirmed'];",
      "199:    return;",
      "200:   }",
      "202:   if ($optInToken->getEmail() != $objMember->email)",
      "203:   {",
      "204:    $this->strTemplate = 'mod_message';",
      "206:    $this->Template = new FrontendTemplate($this->strTemplate);",
      "207:    $this->Template->type = 'error';",
      "208:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenEmailMismatch'];",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "287:  {",
      "289:   $optIn = System::getContainer()->get('contao.opt-in');",
      "293:   $arrData = $objMember->row();",
      "",
      "[Removed Lines]",
      "290:   $optInToken = $optIn->create('pw-', $objMember->email, array('tl_member'=>array($objMember->id)));",
      "",
      "[Added Lines]",
      "312:   $optInToken = $optIn->create('pw', $objMember->email, array('tl_member'=>array($objMember->id)));",
      "",
      "---------------"
    ],
    "core-bundle/src/Resources/contao/modules/ModuleRegistration.php||core-bundle/src/Resources/contao/modules/ModuleRegistration.php": [
      "File: core-bundle/src/Resources/contao/modules/ModuleRegistration.php -> core-bundle/src/Resources/contao/modules/ModuleRegistration.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "464:  {",
      "466:   $optIn = System::getContainer()->get('contao.opt-in');",
      "470:   $arrTokenData = $arrData;",
      "",
      "[Removed Lines]",
      "467:   $optInToken = $optIn->create('reg-', $arrData['email'], array('tl_member'=>array($arrData['id'])));",
      "",
      "[Added Lines]",
      "467:   $optInToken = $optIn->create('reg', $arrData['email'], array('tl_member'=>array($arrData['id'])));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "521:   $optIn = System::getContainer()->get('contao.opt-in');",
      "525:   {",
      "526:    $this->Template->type = 'error';",
      "529:    return;",
      "530:   }",
      "",
      "[Removed Lines]",
      "524:   if ((!$optInToken = $optIn->find(Input::get('token'))) || $optInToken->isConfirmed() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_member' || \\count($arrIds = current($arrRelated)) != 1 || (!$objMember = MemberModel::findByPk($arrIds[0])))",
      "527:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['accountError'];",
      "",
      "[Added Lines]",
      "524:   if ((!$optInToken = $optIn->find(Input::get('token'))) || !$optInToken->isValid() || \\count($arrRelated = $optInToken->getRelatedRecords()) != 1 || key($arrRelated) != 'tl_member' || \\count($arrIds = current($arrRelated)) != 1 || (!$objMember = MemberModel::findByPk($arrIds[0])))",
      "527:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "529:    return;",
      "530:   }",
      "532:   if ($optInToken->isConfirmed())",
      "533:   {",
      "534:    $this->Template->type = 'error';",
      "535:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenConfirmed'];",
      "537:    return;",
      "538:   }",
      "540:   if ($optInToken->getEmail() != $objMember->email)",
      "541:   {",
      "542:    $this->Template->type = 'error';",
      "543:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenEmailMismatch'];",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "578:   $optIn = System::getContainer()->get('contao.opt-in');",
      "582:   {",
      "583:    return;",
      "584:   }",
      "",
      "[Removed Lines]",
      "581:   if ((!$model = OptInModel::findOneByRelatedTableAndId('tl_member', $objMember->id)) || (!$optInToken = $optIn->find($model->token)))",
      "",
      "[Added Lines]",
      "595:   $optInToken = null;",
      "596:   $models = OptInModel::findByRelatedTableAndIds('tl_member', array($objMember->id));",
      "598:   foreach ($models as $model)",
      "599:   {",
      "601:    if (($token = $optIn->find($model->token)) && $token->isValid() && !$token->isConfirmed())",
      "602:    {",
      "603:     $optInToken = $token;",
      "604:     break;",
      "605:    }",
      "606:   }",
      "608:   if ($optInToken === null)",
      "",
      "---------------"
    ],
    "core-bundle/tests/OptIn/OptInTest.php||core-bundle/tests/OptIn/OptInTest.php": [
      "File: core-bundle/tests/OptIn/OptInTest.php -> core-bundle/tests/OptIn/OptInTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "43:             ->willReturn($model)",
      "44:         ;",
      "48:         $this->assertStringMatchesFormat('reg-%x', $token->getIdentifier());",
      "49:         $this->assertTrue($token->isValid());",
      "",
      "[Removed Lines]",
      "46:         $token = (new OptIn($framework))->create('reg-', 'foo@bar.com', ['tl_member' => 1]);",
      "",
      "[Added Lines]",
      "46:         $token = (new OptIn($framework))->create('reg', 'foo@bar.com', ['tl_member' => 1]);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "62:         $this->expectException('InvalidArgumentException');",
      "63:         $this->expectExceptionMessage('The token prefix must not be longer than 6 characters');",
      "66:     }",
      "68:     public function testFindsAToken(): void",
      "",
      "[Removed Lines]",
      "65:         (new OptIn($framework))->create('registration-', 'foo@bar.com', ['tl_member' => 1]);",
      "",
      "[Added Lines]",
      "65:         (new OptIn($framework))->create('registration', 'foo@bar.com', ['tl_member' => 1]);",
      "",
      "---------------"
    ],
    "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php": [
      "File: core-bundle/tests/OptIn/OptInTokenTest.php -> core-bundle/tests/OptIn/OptInTokenTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "42:         $this->assertSame('foo@bar.com', $token->getEmail());",
      "43:     }",
      "45:     public function testConfirmsAToken(): void",
      "46:     {",
      "47:         $properties = [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "45:     public function testInvalidatesAToken(): void",
      "46:     {",
      "48:         $model = $this->mockClassWithGetterSetter(OptInModel::class, ['invalidatedThrough' => 'foo']);",
      "49:         $token = $this->getToken($model);",
      "51:         $this->assertFalse($token->isValid());",
      "52:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "53:         $model = $this->mockClassWithGetterSetter(OptInModel::class, $properties);",
      "55:         $token = $this->getToken($model);",
      "56:         $token->confirm();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "63:         $model",
      "64:             ->expects($this->once())",
      "65:             ->method('getRelatedRecords')",
      "66:             ->willReturn([])",
      "67:         ;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "58:         $this->assertTrue($token->isConfirmed());",
      "59:     }",
      "61:     public function testDoesNotConfirmAConfirmedToken(): void",
      "62:     {",
      "63:         $properties = [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "75:     public function testInvalidatesRelatedTokens(): void",
      "76:     {",
      "77:         $properties = [",
      "78:             'token' => 'reg-first',",
      "79:             'createdOn' => time(),",
      "80:             'confirmedOn' => 0,",
      "81:         ];",
      "84:         $related = $this->mockClassWithGetterSetter(OptInModel::class, $properties);",
      "85:         $related",
      "86:             ->expects($this->once())",
      "87:             ->method('save')",
      "88:         ;",
      "90:         $related",
      "91:             ->expects($this->once())",
      "92:             ->method('getRelatedRecords')",
      "93:             ->willReturn(['tl_user' => [2]])",
      "94:         ;",
      "96:         $adapter = $this->mockAdapter(['findByRelatedTableAndIds']);",
      "97:         $adapter",
      "98:             ->expects($this->once())",
      "99:             ->method('findByRelatedTableAndIds')",
      "100:             ->with('tl_user', [2])",
      "101:             ->willReturn([$related])",
      "102:         ;",
      "104:         $framework = $this->mockContaoFramework([OptInModel::class => $adapter]);",
      "106:         $properties = [",
      "107:             'token' => 'reg-second',",
      "108:             'createdOn' => time(),",
      "109:             'confirmedOn' => 0,",
      "110:         ];",
      "113:         $model = $this->mockClassWithGetterSetter(OptInModel::class, $properties);",
      "114:         $model",
      "115:             ->expects($this->once())",
      "116:             ->method('getRelatedRecords')",
      "117:             ->willReturn(['tl_user' => [2]])",
      "118:         ;",
      "120:         $token = $this->getToken($model, $framework);",
      "121:         $token->confirm();",
      "123:         $this->assertTrue($token->isConfirmed());",
      "124:         $this->assertSame('reg-second', $related->invalidatedThrough);",
      "125:     }",
      "127:     public function testDoesNotInvalidateRelatedTokensIfTheRelatedRecordsDoNotMatch(): void",
      "128:     {",
      "129:         $properties = [",
      "130:             'token' => 'reg-first',",
      "131:             'createdOn' => time(),",
      "132:             'confirmedOn' => 0,",
      "133:         ];",
      "136:         $related = $this->mockClassWithGetterSetter(OptInModel::class, $properties);",
      "137:         $related",
      "138:             ->expects($this->never())",
      "139:             ->method('save')",
      "140:         ;",
      "142:         $related",
      "143:             ->expects($this->once())",
      "144:             ->method('getRelatedRecords')",
      "145:             ->willReturn(['tl_user' => [2, 3]])",
      "146:         ;",
      "148:         $adapter = $this->mockAdapter(['findByRelatedTableAndIds']);",
      "149:         $adapter",
      "150:             ->expects($this->once())",
      "151:             ->method('findByRelatedTableAndIds')",
      "152:             ->with('tl_user', [2])",
      "153:             ->willReturn([$related])",
      "154:         ;",
      "156:         $framework = $this->mockContaoFramework([OptInModel::class => $adapter]);",
      "158:         $properties = [",
      "159:             'token' => 'reg-second',",
      "160:             'createdOn' => time(),",
      "161:             'confirmedOn' => 0,",
      "162:         ];",
      "165:         $model = $this->mockClassWithGetterSetter(OptInModel::class, $properties);",
      "166:         $model",
      "167:             ->expects($this->once())",
      "168:             ->method('getRelatedRecords')",
      "169:             ->willReturn(['tl_user' => [2]])",
      "170:         ;",
      "172:         $token = $this->getToken($model, $framework);",
      "173:         $token->confirm();",
      "175:         $this->assertTrue($token->isConfirmed());",
      "176:         $this->assertNull($related->invalidatedThrough);",
      "177:     }",
      "",
      "---------------"
    ],
    "newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php||newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php": [
      "File: newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php -> newsletter-bundle/src/Resources/contao/modules/ModuleSubscribe.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "169:   $optIn = System::getContainer()->get('contao.opt-in');",
      "173:   {",
      "174:    $this->Template->type = 'error';",
      "177:    return;",
      "178:   }",
      "185:   foreach ($arrIds as $intId)",
      "186:   {",
      "187:    if (!$objRecipient = NewsletterRecipientsModel::findByPk($intId))",
      "188:    {",
      "190:    }",
      "192:    $arrAdd[] = $objRecipient->id;",
      "193:    $arrCids[] = $objRecipient->pid;",
      "",
      "[Removed Lines]",
      "172:   if ((!$optInToken = $optIn->find(Input::get('token'))) || $optInToken->isConfirmed() || \\count($arrRelated = $optInToken->getRelatedRecords()) < 1 || key($arrRelated) != 'tl_newsletter_recipients' || \\count($arrIds = current($arrRelated)) < 1)",
      "175:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['accountError'];",
      "180:   $time = time();",
      "181:   $arrAdd = array();",
      "182:   $arrCids = array();",
      "189:     continue;",
      "",
      "[Added Lines]",
      "172:   if ((!$optInToken = $optIn->find(Input::get('token'))) || !$optInToken->isValid() || \\count($arrRelated = $optInToken->getRelatedRecords()) < 1 || key($arrRelated) != 'tl_newsletter_recipients' || \\count($arrIds = current($arrRelated)) < 1)",
      "175:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "180:   if ($optInToken->isConfirmed())",
      "181:   {",
      "182:    $this->Template->type = 'error';",
      "183:    $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenConfirmed'];",
      "185:    return;",
      "186:   }",
      "188:   $arrRecipients = array();",
      "195:     $this->Template->type = 'error';",
      "196:     $this->Template->message = $GLOBALS['TL_LANG']['MSC']['invalidToken'];",
      "198:     return;",
      "201:    if ($optInToken->getEmail() != $objRecipient->email)",
      "202:    {",
      "203:     $this->Template->type = 'error';",
      "204:     $this->Template->message = $GLOBALS['TL_LANG']['MSC']['tokenEmailMismatch'];",
      "206:     return;",
      "207:    }",
      "209:    $arrRecipients[] = $objRecipient;",
      "210:   }",
      "212:   $time = time();",
      "213:   $arrAdd = array();",
      "214:   $arrCids = array();",
      "217:   foreach ($arrRecipients as $objRecipient)",
      "218:   {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "335:   $optIn = System::getContainer()->get('contao.opt-in');",
      "339:   $objChannel = NewsletterChannelModel::findByIds($arrNew);",
      "",
      "[Removed Lines]",
      "336:   $optInToken = $optIn->create('nl-', $strEmail, $arrRelated);",
      "",
      "[Added Lines]",
      "363:   $optInToken = $optIn->create('nl', $strEmail, $arrRelated);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "12895c9a27ebad67efbf0077159ff386f967b318",
      "candidate_info": {
        "commit_hash": "12895c9a27ebad67efbf0077159ff386f967b318",
        "repo": "contao/contao",
        "commit_url": "https://github.com/contao/contao/commit/12895c9a27ebad67efbf0077159ff386f967b318",
        "files": [
          "core-bundle/src/EventListener/RequestTokenListener.php",
          "core-bundle/src/OptIn/OptInToken.php",
          "core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php",
          "core-bundle/tests/Framework/ContaoFrameworkTest.php",
          "core-bundle/tests/OptIn/OptInTokenTest.php",
          "core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php"
        ],
        "message": "Temporarily disable two failing tests (false positives)",
        "before_after_code_files": [
          "core-bundle/src/EventListener/RequestTokenListener.php||core-bundle/src/EventListener/RequestTokenListener.php",
          "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php",
          "core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php||core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php",
          "core-bundle/tests/Framework/ContaoFrameworkTest.php||core-bundle/tests/Framework/ContaoFrameworkTest.php",
          "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php",
          "core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php||core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php",
            "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php"
          ],
          "candidate": [
            "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php",
            "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php"
          ]
        }
      },
      "candidate_diff": {
        "core-bundle/src/EventListener/RequestTokenListener.php||core-bundle/src/EventListener/RequestTokenListener.php": [
          "File: core-bundle/src/EventListener/RequestTokenListener.php -> core-bundle/src/EventListener/RequestTokenListener.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "94:             $hostname = gethostbyaddr($request->getClientIp());",
          "96:             foreach ($config->get('requestTokenWhitelist') as $domain) {",
          "98:                     return;",
          "99:                 }",
          "100:             }",
          "",
          "[Removed Lines]",
          "97:                 if ($domain === $hostname || preg_match('/\\.' . preg_quote($domain, '/') . '$/', $hostname)) {",
          "",
          "[Added Lines]",
          "97:                 if ($domain === $hostname || preg_match('/\\.'.preg_quote($domain, '/').'$/', $hostname)) {",
          "",
          "---------------"
        ],
        "core-bundle/src/OptIn/OptInToken.php||core-bundle/src/OptIn/OptInToken.php": [
          "File: core-bundle/src/OptIn/OptInToken.php -> core-bundle/src/OptIn/OptInToken.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:                     continue;",
          "103:                 }",
          "108:                 if ($token->getRelatedRecords() !== $related) {",
          "",
          "[Removed Lines]",
          "105:                 $token = new OptInToken($model, $this->framework);",
          "",
          "[Added Lines]",
          "105:                 $token = new self($model, $this->framework);",
          "",
          "---------------"
        ],
        "core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php||core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php": [
          "File: core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php -> core-bundle/tests/DependencyInjection/ContaoCoreExtensionTest.php"
        ],
        "core-bundle/tests/Framework/ContaoFrameworkTest.php||core-bundle/tests/Framework/ContaoFrameworkTest.php": [
          "File: core-bundle/tests/Framework/ContaoFrameworkTest.php -> core-bundle/tests/Framework/ContaoFrameworkTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: use Contao\\Config;",
          "16: use Contao\\CoreBundle\\Exception\\IncompleteInstallationException;",
          "18: use Contao\\CoreBundle\\Fixtures\\Adapter\\LegacyClass;",
          "19: use Contao\\CoreBundle\\Fixtures\\Adapter\\LegacySingletonClass;",
          "20: use Contao\\CoreBundle\\Framework\\Adapter;",
          "",
          "[Removed Lines]",
          "17: use Contao\\CoreBundle\\Exception\\InvalidRequestTokenException;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "core-bundle/tests/OptIn/OptInTokenTest.php||core-bundle/tests/OptIn/OptInTokenTest.php": [
          "File: core-bundle/tests/OptIn/OptInTokenTest.php -> core-bundle/tests/OptIn/OptInTokenTest.php"
        ],
        "core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php||core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php": [
          "File: core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php -> core-bundle/tests/Security/Authentication/Token/TokenCheckerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "214:                         case 'username':",
          "215:                             return 'foobar';",
          "217:                         case 'admin':",
          "218:                         case 'disable':",
          "219:                             return '';",
          "224:                         default:",
          "225:                             return null;",
          "226:                     }",
          "",
          "[Removed Lines]",
          "221:                         case 'groups':",
          "222:                             return [];",
          "",
          "[Added Lines]",
          "219:                         case 'password':",
          "222:                         case 'start':",
          "223:                         case 'stop':",
          "",
          "---------------"
        ]
      }
    }
  ]
}