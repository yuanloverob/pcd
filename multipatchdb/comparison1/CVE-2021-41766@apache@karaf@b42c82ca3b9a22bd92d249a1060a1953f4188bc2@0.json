{
  "cve_id": "CVE-2021-41766",
  "cve_desc": "Apache Karaf allows monitoring of applications and the Java runtime by using the Java Management Extensions (JMX). JMX is a Java RMI based technology that relies on Java serialized objects for client server communication. Whereas the default JMX implementation is hardened against unauthenticated deserialization attacks, the implementation used by Apache Karaf is not protected against this kind of attack. The impact of Java deserialization vulnerabilities strongly depends on the classes that are available within the targets class path. Generally speaking, deserialization of untrusted data does always represent a high security risk and should be prevented. The risk is low as, by default, Karaf uses a limited set of classes in the JMX server class path. It depends of system scoped classes (e.g. jar in the lib folder).",
  "repo": "apache/karaf",
  "patch_hash": "b42c82ca3b9a22bd92d249a1060a1953f4188bc2",
  "patch_info": {
    "commit_hash": "b42c82ca3b9a22bd92d249a1060a1953f4188bc2",
    "repo": "apache/karaf",
    "commit_url": "https://github.com/apache/karaf/commit/b42c82ca3b9a22bd92d249a1060a1953f4188bc2",
    "files": [
      "assemblies/features/standard/src/main/feature/feature.xml",
      "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
    ],
    "message": "[KARAF-7312] Add JMX credentials filter pattern support on the RMI connector and enforce it by default",
    "before_after_code_files": [
      "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
    ]
  },
  "patch_diff": {
    "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java": [
      "File: management/server/src/main/java/org/apache/karaf/management/internal/Activator.java -> management/server/src/main/java/org/apache/karaf/management/internal/Activator.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: import javax.management.MBeanServer;",
      "23: import javax.management.ObjectName;",
      "25: import org.apache.karaf.jaas.config.KeystoreInstance;",
      "26: import org.apache.karaf.jaas.config.KeystoreManager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "24: import javax.management.remote.rmi.RMIConnectorServer;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "109:         originalRmiServerHostname = System.getProperty(\"java.rmi.server.hostname\");",
      "110:         System.setProperty(\"java.rmi.server.hostname\", rmiServerHost);",
      "112:         String jmxRealm = getString(\"jmxRealm\", \"karaf\");",
      "113:         String serviceUrl = getString(\"serviceUrl\",",
      "114:                 \"service:jmx:rmi://\" + rmiServerHost + \":\" + rmiServerPort + \"/jndi/rmi://\" + rmiRegistryHost + \":\" + rmiRegistryPort + \"/karaf-\" + System.getProperty(\"karaf.name\"));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "115:         String credentialsFilterPattern = getString(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, String.class.getName() + \";!*\");",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "170:         jmxmpEnvironment.put(\"jmx.remote.sasl.callback.handler\", jaasAuthenticator);",
      "171:         Map<String, Object> environment = new HashMap<>();",
      "172:         environment.put(\"jmx.remote.authenticator\", jaasAuthenticator);",
      "173:         try {",
      "174:             connectorServerFactory.setEnvironment(environment);",
      "175:             connectorServerFactory.setJmxmpEnvironment(jmxmpEnvironment);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "178:         environment.put(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, credentialsFilterPattern);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "72f446e5a0ffda2929f113acfc76493ab478264a",
      "candidate_info": {
        "commit_hash": "72f446e5a0ffda2929f113acfc76493ab478264a",
        "repo": "apache/karaf",
        "commit_url": "https://github.com/apache/karaf/commit/72f446e5a0ffda2929f113acfc76493ab478264a",
        "files": [
          "assemblies/features/standard/src/main/feature/feature.xml",
          "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
        ],
        "message": "[KARAF-7312] Add JMX credentials filter pattern support on the RMI connector and enforce it by default\n\n(cherry picked from commit b42c82ca3b9a22bd92d249a1060a1953f4188bc2)",
        "before_after_code_files": [
          "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
          ],
          "candidate": [
            "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
          ]
        }
      },
      "candidate_diff": {
        "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java": [
          "File: management/server/src/main/java/org/apache/karaf/management/internal/Activator.java -> management/server/src/main/java/org/apache/karaf/management/internal/Activator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import javax.management.MBeanServer;",
          "23: import javax.management.ObjectName;",
          "25: import org.apache.karaf.jaas.config.KeystoreInstance;",
          "26: import org.apache.karaf.jaas.config.KeystoreManager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: import javax.management.remote.rmi.RMIConnectorServer;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:         originalRmiServerHostname = System.getProperty(\"java.rmi.server.hostname\");",
          "110:         System.setProperty(\"java.rmi.server.hostname\", rmiServerHost);",
          "112:         String jmxRealm = getString(\"jmxRealm\", \"karaf\");",
          "113:         String serviceUrl = getString(\"serviceUrl\",",
          "114:                 \"service:jmx:rmi://\" + rmiServerHost + \":\" + rmiServerPort + \"/jndi/rmi://\" + rmiRegistryHost + \":\" + rmiRegistryPort + \"/karaf-\" + System.getProperty(\"karaf.name\"));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "115:         String credentialsFilterPattern = getString(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, String.class.getName() + \";!*\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "170:         jmxmpEnvironment.put(\"jmx.remote.sasl.callback.handler\", jaasAuthenticator);",
          "171:         Map<String, Object> environment = new HashMap<>();",
          "172:         environment.put(\"jmx.remote.authenticator\", jaasAuthenticator);",
          "173:         try {",
          "174:             connectorServerFactory.setEnvironment(environment);",
          "175:             connectorServerFactory.setJmxmpEnvironment(jmxmpEnvironment);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "178:         environment.put(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, credentialsFilterPattern);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "93a019c560f0202e6057174f2023ff53cb11db65",
      "candidate_info": {
        "commit_hash": "93a019c560f0202e6057174f2023ff53cb11db65",
        "repo": "apache/karaf",
        "commit_url": "https://github.com/apache/karaf/commit/93a019c560f0202e6057174f2023ff53cb11db65",
        "files": [
          "assemblies/features/standard/src/main/feature/feature.xml",
          "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
        ],
        "message": "[KARAF-7312] Add JMX credentials filter pattern support on the RMI connector and enforce it by default\n\n(cherry picked from commit b42c82ca3b9a22bd92d249a1060a1953f4188bc2)",
        "before_after_code_files": [
          "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
          ],
          "candidate": [
            "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java"
          ]
        }
      },
      "candidate_diff": {
        "management/server/src/main/java/org/apache/karaf/management/internal/Activator.java||management/server/src/main/java/org/apache/karaf/management/internal/Activator.java": [
          "File: management/server/src/main/java/org/apache/karaf/management/internal/Activator.java -> management/server/src/main/java/org/apache/karaf/management/internal/Activator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import javax.management.MBeanServer;",
          "23: import javax.management.ObjectName;",
          "25: import org.apache.karaf.jaas.config.KeystoreInstance;",
          "26: import org.apache.karaf.jaas.config.KeystoreManager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: import javax.management.remote.rmi.RMIConnectorServer;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:         originalRmiServerHostname = System.getProperty(\"java.rmi.server.hostname\");",
          "110:         System.setProperty(\"java.rmi.server.hostname\", rmiServerHost);",
          "112:         String jmxRealm = getString(\"jmxRealm\", \"karaf\");",
          "113:         String serviceUrl = getString(\"serviceUrl\",",
          "114:                 \"service:jmx:rmi://\" + rmiServerHost + \":\" + rmiServerPort + \"/jndi/rmi://\" + rmiRegistryHost + \":\" + rmiRegistryPort + \"/karaf-\" + System.getProperty(\"karaf.name\"));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "115:         String credentialsFilterPattern = getString(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, String.class.getName() + \";!*\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "170:         jmxmpEnvironment.put(\"jmx.remote.sasl.callback.handler\", jaasAuthenticator);",
          "171:         Map<String, Object> environment = new HashMap<>();",
          "172:         environment.put(\"jmx.remote.authenticator\", jaasAuthenticator);",
          "173:         try {",
          "174:             connectorServerFactory.setEnvironment(environment);",
          "175:             connectorServerFactory.setJmxmpEnvironment(jmxmpEnvironment);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "178:         environment.put(RMIConnectorServer.CREDENTIALS_FILTER_PATTERN, credentialsFilterPattern);",
          "",
          "---------------"
        ]
      }
    }
  ]
}