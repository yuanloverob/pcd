{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5ff115743c7c36f4e0bcd3d0a18f7fc58ccd8883",
      "candidate_info": {
        "commit_hash": "5ff115743c7c36f4e0bcd3d0a18f7fc58ccd8883",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5ff115743c7c36f4e0bcd3d0a18f7fc58ccd8883",
        "files": [
          "version.php"
        ],
        "message": "Moodle release 3.6rc3",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_RC;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018112900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6rc2 (Build: 20181128)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018120100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6rc3 (Build: 20181201)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4d5849b0e4665244cec6017a3178bb3cf23f981b",
      "candidate_info": {
        "commit_hash": "4d5849b0e4665244cec6017a3178bb3cf23f981b",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4d5849b0e4665244cec6017a3178bb3cf23f981b",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.8+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "36: $branch   = '38';                       // This version's branch.",
          "37: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019111800.06;              // 20191118      = branching date YYYYMMDD - do not modify!",
          "35: $release  = '3.8+ (Build: 20191220)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019111800.07;              // 20191118      = branching date YYYYMMDD - do not modify!",
          "35: $release  = '3.8+ (Build: 20200103)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "856e07e4e7b45a848a8a44f6c6269673251ea310",
      "candidate_info": {
        "commit_hash": "856e07e4e7b45a848a8a44f6c6269673251ea310",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/856e07e4e7b45a848a8a44f6c6269673251ea310",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018022300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180223)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018022800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180228)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2f1dbcf4932b23fc604d61e32b33b87145d7cf4",
      "candidate_info": {
        "commit_hash": "c2f1dbcf4932b23fc604d61e32b33b87145d7cf4",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c2f1dbcf4932b23fc604d61e32b33b87145d7cf4",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.6dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018101100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20181011)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018101600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181016)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e159b53b5b33d1313c3ce69dff4c5160629d2668",
      "candidate_info": {
        "commit_hash": "e159b53b5b33d1313c3ce69dff4c5160629d2668",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e159b53b5b33d1313c3ce69dff4c5160629d2668",
        "files": [
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "message/classes/helper.php",
          "version.php"
        ],
        "message": "MDL-36941 core_message: improved performance of helper::get_messages()\n\nImproved the query to use the 'convhash' field as well as adding an index.\n\nAlso fixed issue where 'timeread' was hardcoded as 0.",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "message/classes/helper.php||message/classes/helper.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2176:         upgrade_main_savepoint(true, 2018032200.06);",
          "2177:     }",
          "2179:     return true;",
          "2180: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2179:     if ($oldversion < 2018032200.07) {",
          "2181:         $table = new xmldb_table('messages');",
          "2184:         $index = new xmldb_index('conversationid_timecreated', XMLDB_INDEX_NOTUNIQUE, array('conversationid, timecreated'));",
          "2185:         if (!$dbman->index_exists($table, $index)) {",
          "2186:             $dbman->add_index($table, $index);",
          "2187:         }",
          "2190:         upgrade_main_savepoint(true, 2018032200.07);",
          "2191:     }",
          "",
          "---------------"
        ],
        "message/classes/helper.php||message/classes/helper.php": [
          "File: message/classes/helper.php -> message/classes/helper.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:                                         $sort = 'timecreated ASC', $timefrom = 0, $timeto = 0) {",
          "52:         global $DB;",
          "63:         if (empty($timedeleted)) {",
          "64:             $sql .= \" LEFT JOIN {message_user_actions} mua",
          "68:         } else {",
          "69:             $sql .= \" INNER JOIN {message_user_actions} mua",
          "74:         }",
          "79:         if (!empty($timefrom)) {",
          "82:         }",
          "84:         if (!empty($timeto)) {",
          "87:         }",
          "89:         if (empty($timedeleted)) {",
          "",
          "[Removed Lines]",
          "54:         $sql = \"SELECT m.id, m.useridfrom, mdm.userid as useridto, m.subject, m.fullmessage, m.fullmessagehtml,",
          "55:                        m.fullmessageformat, m.smallmessage, m.timecreated, 0 as timeread",
          "56:                   FROM {messages} m",
          "57:             INNER JOIN {message_conversations} md",
          "58:                     ON md.id = m.conversationid",
          "59:             INNER JOIN {message_conversation_members} mdm",
          "60:                     ON mdm.conversationid = md.id\";",
          "61:         $params = [];",
          "65:                              ON (mua.messageid = m.id AND mua.userid = ? AND mua.action = ? AND mua.timecreated is NOT NULL)\";",
          "66:             $params[] = $userid;",
          "67:             $params[] = api::MESSAGE_ACTION_DELETED;",
          "70:                               ON (mua.messageid = m.id AND mua.userid = ? AND mua.action = ? AND mua.timecreated = ?)\";",
          "71:             $params[] = $userid;",
          "72:             $params[] = api::MESSAGE_ACTION_DELETED;",
          "73:             $params[] = $timedeleted;",
          "76:         $sql .= \" WHERE (m.useridfrom = ? AND mdm.userid = ? OR m.useridfrom = ? AND mdm.userid = ?)\";",
          "77:         $params = array_merge($params, [$userid, $otheruserid, $otheruserid, $userid]);",
          "80:             $sql .= \" AND m.timecreated >= ?\";",
          "81:             $params[] = $timefrom;",
          "85:             $sql .= \" AND m.timecreated <= ?\";",
          "86:             $params[] = $timeto;",
          "",
          "[Added Lines]",
          "54:         $hash = self::get_conversation_hash([$userid, $otheruserid]);",
          "56:         $sql = \"SELECT m.id, m.useridfrom, m.subject, m.fullmessage, m.fullmessagehtml,",
          "57:                        m.fullmessageformat, m.smallmessage, m.timecreated, muaread.timecreated AS timeread",
          "58:                   FROM {message_conversations} mc",
          "59:             INNER JOIN {messages} m",
          "60:                     ON m.conversationid = mc.id",
          "61:              LEFT JOIN {message_user_actions} muaread",
          "62:                     ON (muaread.messageid = m.id",
          "63:                    AND muaread.userid = :userid1",
          "64:                    AND muaread.action = :readaction)\";",
          "65:         $params = ['userid1' => $userid, 'readaction' => api::MESSAGE_ACTION_READ, 'convhash' => $hash];",
          "69:                              ON (mua.messageid = m.id",
          "70:                             AND mua.userid = :userid2",
          "71:                             AND mua.action = :deleteaction",
          "72:                             AND mua.timecreated is NOT NULL)\";",
          "75:                               ON (mua.messageid = m.id",
          "76:                              AND mua.userid = :userid2",
          "77:                              AND mua.action = :deleteaction",
          "78:                              AND mua.timecreated = :timedeleted)\";",
          "79:             $params['timedeleted'] = $timedeleted;",
          "82:         $params['userid2'] = $userid;",
          "83:         $params['deleteaction'] = api::MESSAGE_ACTION_DELETED;",
          "85:         $sql .= \" WHERE mc.convhash = :convhash\";",
          "88:             $sql .= \" AND m.timecreated >= :timefrom\";",
          "89:             $params['timefrom'] = $timefrom;",
          "93:             $sql .= \" AND m.timecreated <= :timeto\";",
          "94:             $params['timeto'] = $timeto;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "93:         $sql .= \" ORDER BY m.$sort\";",
          "96:     }",
          "",
          "[Removed Lines]",
          "95:         return $DB->get_records_sql($sql, $params, $limitfrom, $limitnum);",
          "",
          "[Added Lines]",
          "103:         $messages = $DB->get_records_sql($sql, $params, $limitfrom, $limitnum);",
          "104:         foreach ($messages as &$message) {",
          "105:             $message->useridto = ($message->useridfrom == $userid) ? $otheruserid : $userid;",
          "106:         }",
          "108:         return $messages;",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018032200.06;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018032200.07;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}