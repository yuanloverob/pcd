{
  "cve_id": "CVE-2023-6831",
  "cve_desc": "Path Traversal: '\\..\\filename' in GitHub repository mlflow/mlflow prior to 2.9.2.",
  "repo": "mlflow/mlflow",
  "patch_hash": "1da75dfcecd4d169e34809ade55748384e8af6c1",
  "patch_info": {
    "commit_hash": "1da75dfcecd4d169e34809ade55748384e8af6c1",
    "repo": "mlflow/mlflow",
    "commit_url": "https://github.com/mlflow/mlflow/commit/1da75dfcecd4d169e34809ade55748384e8af6c1",
    "files": [
      "mlflow/utils/uri.py",
      "tests/server/test_handlers.py",
      "tests/store/artifact/test_http_artifact_repo.py",
      "tests/tracking/test_rest_tracking.py",
      "tests/utils/test_uri.py"
    ],
    "message": "Prevent path traversal with encoded URL (#10650)\n\nSigned-off-by: B-Step62 <yuki.watanabe@databricks.com>",
    "before_after_code_files": [
      "mlflow/utils/uri.py||mlflow/utils/uri.py",
      "tests/server/test_handlers.py||tests/server/test_handlers.py",
      "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py",
      "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py",
      "tests/utils/test_uri.py||tests/utils/test_uri.py"
    ]
  },
  "patch_diff": {
    "mlflow/utils/uri.py||mlflow/utils/uri.py": [
      "File: mlflow/utils/uri.py -> mlflow/utils/uri.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "430:     \"\"\"",
      "431:     from mlflow.utils.file_utils import local_file_uri_to_path",
      "434:     if any((s in path) for s in (\"#\", \"%23\")):",
      "435:         raise exc",
      "",
      "[Removed Lines]",
      "433:     exc = MlflowException(f\"Invalid path: {path}\", error_code=INVALID_PARAMETER_VALUE)",
      "",
      "[Added Lines]",
      "433:     # We must decode URL before validating it",
      "434:     path = urllib.parse.unquote(path)",
      "436:     exc = MlflowException(\"Invalid path\", error_code=INVALID_PARAMETER_VALUE)",
      "",
      "---------------"
    ],
    "tests/server/test_handlers.py||tests/server/test_handlers.py": [
      "File: tests/server/test_handlers.py -> tests/server/test_handlers.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "38:     UpdateRegisteredModel,",
      "39: )",
      "40: from mlflow.protos.service_pb2 import CreateExperiment, SearchRuns",
      "42: from mlflow.server.handlers import (",
      "43:     _create_experiment,",
      "44:     _create_model_version,",
      "45:     _create_registered_model,",
      "46:     _delete_model_version,",
      "47:     _delete_model_version_tag,",
      "48:     _delete_registered_model,",
      "",
      "[Removed Lines]",
      "41: from mlflow.server import BACKEND_STORE_URI_ENV_VAR, app",
      "",
      "[Added Lines]",
      "41: from mlflow.server import BACKEND_STORE_URI_ENV_VAR, SERVE_ARTIFACTS_ENV_VAR, app",
      "46:     _delete_artifact_mlflow_artifacts,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "105:         yield mock_store",
      "108: def test_health():",
      "109:     with app.test_client() as c:",
      "110:         response = c.get(\"/health\")",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "109: @pytest.fixture",
      "110: def enable_serve_artifacts(monkeypatch):",
      "111:     monkeypatch.setenv(SERVE_ARTIFACTS_ENV_VAR, \"true\")",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "777:     _, args = mock_model_registry_store.get_model_version_by_alias.call_args",
      "778:     assert args == {\"name\": name, \"alias\": alias}",
      "779:     assert json.loads(resp.get_data()) == {\"model_version\": jsonify(mvd)}",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "788: @pytest.mark.parametrize(",
      "789:     \"path\",",
      "790:     [",
      "791:         \"/path\",",
      "792:         \"path/../to/file\",",
      "793:         \"/etc/passwd\",",
      "794:         \"/etc/passwd%00.jpg\",",
      "795:         \"/file://etc/passwd\",",
      "796:         \"%2E%2E%2F%2E%2E%2Fpath\",",
      "797:     ],",
      "798: )",
      "799: def test_delete_artifact_mlflow_artifacts_throws_for_malicious_path(enable_serve_artifacts, path):",
      "800:     response = _delete_artifact_mlflow_artifacts(path)",
      "801:     assert response.status_code == 400",
      "802:     json_response = json.loads(response.get_data())",
      "803:     assert json_response[\"error_code\"] == ErrorCode.Name(INVALID_PARAMETER_VALUE)",
      "804:     assert json_response[\"message\"] == \"Invalid path\"",
      "",
      "---------------"
    ],
    "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py": [
      "File: tests/store/artifact/test_http_artifact_repo.py -> tests/store/artifact/test_http_artifact_repo.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "246:             http_artifact_repo.list_artifacts()",
      "250: def test_list_artifacts_malicious_path(http_artifact_repo, path):",
      "251:     with mock.patch(",
      "252:         \"mlflow.store.artifact.http_artifact_repo.http_request\",",
      "",
      "[Removed Lines]",
      "249: @pytest.mark.parametrize(\"path\", [\"/tmp/path\", \"../../path\"])",
      "",
      "[Added Lines]",
      "249: @pytest.mark.parametrize(\"path\", [\"/tmp/path\", \"../../path\", \"%2E%2E%2Fpath\"])",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "259:             200,",
      "260:         ),",
      "261:     ):",
      "263:             http_artifact_repo.list_artifacts()",
      "",
      "[Removed Lines]",
      "262:         with pytest.raises(MlflowException, match=f\"Invalid path: {path}\"):",
      "",
      "[Added Lines]",
      "262:         with pytest.raises(MlflowException, match=\"Invalid path\"):",
      "",
      "---------------"
    ],
    "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py": [
      "File: tests/tracking/test_rest_tracking.py -> tests/tracking/test_rest_tracking.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "35: )",
      "36: from mlflow.exceptions import MlflowException",
      "37: from mlflow.models import Model",
      "39: from mlflow.store.tracking.sqlalchemy_store import SqlAlchemyStore",
      "40: from mlflow.utils import mlflow_tags",
      "41: from mlflow.utils.file_utils import TempDir, path_to_local_file_uri",
      "",
      "[Removed Lines]",
      "38: from mlflow.server.handlers import validate_path_is_safe",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "514:     assert response.status_code == 200",
      "663: def test_path_validation(mlflow_client):",
      "664:     experiment_id = mlflow_client.create_experiment(\"tags validation\")",
      "665:     created_run = mlflow_client.create_run(experiment_id)",
      "",
      "[Removed Lines]",
      "517: @pytest.mark.parametrize(",
      "518:     \"path\",",
      "519:     [",
      "520:         \"path\",",
      "521:         \"path/\",",
      "522:         \"path/to/file\",",
      "523:     ],",
      "524: )",
      "525: def test_validate_path_is_safe_good(path):",
      "526:     validate_path_is_safe(path)",
      "529: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
      "530: @pytest.mark.parametrize(",
      "531:     \"path\",",
      "532:     [",
      "533:         # relative path from current directory of C: drive",
      "534:         \".../...//\",",
      "535:     ],",
      "536: )",
      "537: def test_validate_path_is_safe_windows_good(path):",
      "538:     validate_path_is_safe(path)",
      "541: @pytest.mark.skipif(is_windows(), reason=\"This test does not pass on Windows\")",
      "542: @pytest.mark.parametrize(",
      "543:     \"path\",",
      "544:     [",
      "545:         \"/path\",",
      "546:         \"../path\",",
      "547:         \"../../path\",",
      "548:         \"./../path\",",
      "549:         \"path/../to/file\",",
      "550:         \"path/../../to/file\",",
      "551:         \"file://a#/..//tmp\",",
      "552:         \"file://a%23/..//tmp/\",",
      "553:         \"/etc/passwd\",",
      "554:         \"/etc/passwd%00.jpg\",",
      "555:         \"/etc/passwd%00.html\",",
      "556:         \"/etc/passwd%00.txt\",",
      "557:         \"/etc/passwd%00.php\",",
      "558:         \"/etc/passwd%00.asp\",",
      "559:         \"/file://etc/passwd\",",
      "560:     ],",
      "561: )",
      "562: def test_validate_path_is_safe_bad(path):",
      "563:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
      "564:         validate_path_is_safe(path)",
      "567: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
      "568: @pytest.mark.parametrize(",
      "569:     \"path\",",
      "570:     [",
      "571:         r\"../path\",",
      "572:         r\"../../path\",",
      "573:         r\"./../path\",",
      "574:         r\"path/../to/file\",",
      "575:         r\"path/../../to/file\",",
      "576:         r\"..\\path\",",
      "577:         r\"..\\..\\path\",",
      "578:         r\".\\..\\path\",",
      "579:         r\"path\\..\\to\\file\",",
      "580:         r\"path\\..\\..\\to\\file\",",
      "581:         # Drive-relative paths",
      "582:         r\"C:path\",",
      "583:         r\"C:path/\",",
      "584:         r\"C:path/to/file\",",
      "585:         r\"C:../path/to/file\",",
      "586:         r\"C:\\path\",",
      "587:         r\"C:/path\",",
      "588:         r\"C:\\path\\to\\file\",",
      "589:         r\"C:\\path/to/file\",",
      "590:         r\"C:\\path\\..\\to\\file\",",
      "591:         r\"C:/path/../to/file\",",
      "592:         # UNC(Universal Naming Convention) paths",
      "593:         r\"\\\\path\\to\\file\",",
      "594:         r\"\\\\path/to/file\",",
      "595:         r\"\\\\.\\\\C:\\path\\to\\file\",",
      "596:         r\"\\\\?\\C:\\path\\to\\file\",",
      "597:         r\"\\\\?\\UNC/path/to/file\",",
      "598:         # Other potential attackable paths",
      "599:         r\"/etc/password\",",
      "600:         r\"/path\",",
      "601:         r\"/etc/passwd%00.jpg\",",
      "602:         r\"/etc/passwd%00.html\",",
      "603:         r\"/etc/passwd%00.txt\",",
      "604:         r\"/etc/passwd%00.php\",",
      "605:         r\"/etc/passwd%00.asp\",",
      "606:         r\"/Windows/no/such/path\",",
      "607:         r\"/file://etc/passwd\",",
      "608:         r\"/file:c:/passwd\",",
      "609:         r\"/file://d:/windows/win.ini\",",
      "610:         r\"/file://./windows/win.ini\",",
      "611:         r\"file://c:/boot.ini\",",
      "612:         r\"file://C:path\",",
      "613:         r\"file://C:path/\",",
      "614:         r\"file://C:path/to/file\",",
      "615:         r\"file:///C:/Windows/System32/\",",
      "616:         r\"file:///etc/passwd\",",
      "617:         r\"file:///d:/windows/repair/sam\",",
      "618:         r\"file:///proc/version\",",
      "619:         r\"file:///inetpub/wwwroot/global.asa\",",
      "620:         r\"/file://../windows/win.ini\",",
      "621:         r\"../etc/passwd\",",
      "622:         r\"..\\Windows\\System32\\\\\",",
      "623:         r\"C:\\Windows\\System32\\\\\",",
      "624:         r\"/etc/passwd\",",
      "625:         r\"::Windows\\System32\",",
      "626:         r\"..\\..\\..\\..\\Windows\\System32\\\\\",",
      "627:         r\"../Windows/System32\",",
      "628:         r\"....\\\\\",",
      "629:         r\"\\\\?\\C:\\Windows\\System32\\\\\",",
      "630:         r\"\\\\.\\C:\\Windows\\System32\\\\\",",
      "631:         r\"\\\\UNC\\Server\\Share\\\\\",",
      "632:         r\"\\\\Server\\Share\\folder\\\\\",",
      "633:         r\"\\\\127.0.0.1\\c$\\Windows\\\\\",",
      "634:         r\"\\\\localhost\\c$\\Windows\\\\\",",
      "635:         r\"\\\\smbserver\\share\\path\\\\\",",
      "636:         r\"..\\\\?\\C:\\Windows\\System32\\\\\",",
      "637:         r\"C:/Windows/../Windows/System32/\",",
      "638:         r\"C:\\Windows\\..\\Windows\\System32\\\\\",",
      "639:         r\"../../../../../../../../../../../../Windows/System32\",",
      "640:         r\"../../../../../../../../../../../../etc/passwd\",",
      "641:         r\"../../../../../../../../../../../../var/www/html/index.html\",",
      "642:         r\"../../../../../../../../../../../../usr/local/etc/openvpn/server.conf\",",
      "643:         r\"../../../../../../../../../../../../Program Files (x86)\",",
      "644:         r\"/../../../../../../../../../../../../Windows/System32\",",
      "645:         r\"/Windows\\../etc/passwd\",",
      "646:         r\"/Windows\\..\\Windows\\System32\\\\\",",
      "647:         r\"/Windows\\..\\Windows\\System32\\cmd.exe\",",
      "648:         r\"/Windows\\..\\Windows\\System32\\msconfig.exe\",",
      "649:         r\"/Windows\\..\\Windows\\System32\\regedit.exe\",",
      "650:         r\"/Windows\\..\\Windows\\System32\\taskmgr.exe\",",
      "651:         r\"/Windows\\..\\Windows\\System32\\control.exe\",",
      "652:         r\"/Windows\\..\\Windows\\System32\\services.msc\",",
      "653:         r\"/Windows\\..\\Windows\\System32\\diskmgmt.msc\",",
      "654:         r\"/Windows\\..\\Windows\\System32\\eventvwr.msc\",",
      "655:         r\"/Windows/System32/drivers/etc/hosts\",",
      "656:     ],",
      "657: )",
      "658: def test_validate_path_is_safe_windows_bad(path):",
      "659:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
      "660:         validate_path_is_safe(path)",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "670:         assert resp.status_code == 400",
      "671:         assert response.json() == {",
      "672:             \"error_code\": \"INVALID_PARAMETER_VALUE\",",
      "674:         }",
      "676:     response = requests.get(",
      "",
      "[Removed Lines]",
      "673:             \"message\": f\"Invalid path: {invalid_path}\",",
      "",
      "[Added Lines]",
      "526:             \"message\": \"Invalid path\",",
      "",
      "---------------"
    ],
    "tests/utils/test_uri.py||tests/utils/test_uri.py": [
      "File: tests/utils/test_uri.py -> tests/utils/test_uri.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "24:     is_valid_dbfs_uri,",
      "25:     remove_databricks_profile_info_from_artifact_uri,",
      "26:     resolve_uri_if_local,",
      "27: )",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27:     validate_path_is_safe,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "724: )",
      "725: def test_negative_detection(uri):",
      "726:     assert not is_fuse_or_uc_volumes_uri(uri)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "730: @pytest.mark.parametrize(",
      "731:     \"path\",",
      "732:     [",
      "733:         \"path\",",
      "734:         \"path/\",",
      "735:         \"path/to/file\",",
      "736:     ],",
      "737: )",
      "738: def test_validate_path_is_safe_good(path):",
      "739:     validate_path_is_safe(path)",
      "742: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
      "743: @pytest.mark.parametrize(",
      "744:     \"path\",",
      "745:     [",
      "746:         # relative path from current directory of C: drive",
      "747:         \".../...//\",",
      "748:     ],",
      "749: )",
      "750: def test_validate_path_is_safe_windows_good(path):",
      "751:     validate_path_is_safe(path)",
      "754: @pytest.mark.skipif(is_windows(), reason=\"This test does not pass on Windows\")",
      "755: @pytest.mark.parametrize(",
      "756:     \"path\",",
      "757:     [",
      "758:         \"/path\",",
      "759:         \"../path\",",
      "760:         \"../../path\",",
      "761:         \"./../path\",",
      "762:         \"path/../to/file\",",
      "763:         \"path/../../to/file\",",
      "764:         \"file://a#/..//tmp\",",
      "765:         \"file://a%23/..//tmp/\",",
      "766:         \"/etc/passwd\",",
      "767:         \"/etc/passwd%00.jpg\",",
      "768:         \"/etc/passwd%00.html\",",
      "769:         \"/etc/passwd%00.txt\",",
      "770:         \"/etc/passwd%00.php\",",
      "771:         \"/etc/passwd%00.asp\",",
      "772:         \"/file://etc/passwd\",",
      "773:         # Encoded paths with '..'",
      "774:         \"%2E%2E%2Fpath\",",
      "775:         \"%2E%2E%2F%2E%2E%2Fpath\",",
      "776:     ],",
      "777: )",
      "778: def test_validate_path_is_safe_bad(path):",
      "779:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
      "780:         validate_path_is_safe(path)",
      "783: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
      "784: @pytest.mark.parametrize(",
      "785:     \"path\",",
      "786:     [",
      "787:         r\"../path\",",
      "788:         r\"../../path\",",
      "789:         r\"./../path\",",
      "790:         r\"path/../to/file\",",
      "791:         r\"path/../../to/file\",",
      "792:         r\"..\\path\",",
      "793:         r\"..\\..\\path\",",
      "794:         r\".\\..\\path\",",
      "795:         r\"path\\..\\to\\file\",",
      "796:         r\"path\\..\\..\\to\\file\",",
      "797:         # Drive-relative paths",
      "798:         r\"C:path\",",
      "799:         r\"C:path/\",",
      "800:         r\"C:path/to/file\",",
      "801:         r\"C:../path/to/file\",",
      "802:         r\"C:\\path\",",
      "803:         r\"C:/path\",",
      "804:         r\"C:\\path\\to\\file\",",
      "805:         r\"C:\\path/to/file\",",
      "806:         r\"C:\\path\\..\\to\\file\",",
      "807:         r\"C:/path/../to/file\",",
      "808:         # UNC(Universal Naming Convention) paths",
      "809:         r\"\\\\path\\to\\file\",",
      "810:         r\"\\\\path/to/file\",",
      "811:         r\"\\\\.\\\\C:\\path\\to\\file\",",
      "812:         r\"\\\\?\\C:\\path\\to\\file\",",
      "813:         r\"\\\\?\\UNC/path/to/file\",",
      "814:         # Other potential attackable paths",
      "815:         r\"/etc/password\",",
      "816:         r\"/path\",",
      "817:         r\"/etc/passwd%00.jpg\",",
      "818:         r\"/etc/passwd%00.html\",",
      "819:         r\"/etc/passwd%00.txt\",",
      "820:         r\"/etc/passwd%00.php\",",
      "821:         r\"/etc/passwd%00.asp\",",
      "822:         r\"/Windows/no/such/path\",",
      "823:         r\"/file://etc/passwd\",",
      "824:         r\"/file:c:/passwd\",",
      "825:         r\"/file://d:/windows/win.ini\",",
      "826:         r\"/file://./windows/win.ini\",",
      "827:         r\"file://c:/boot.ini\",",
      "828:         r\"file://C:path\",",
      "829:         r\"file://C:path/\",",
      "830:         r\"file://C:path/to/file\",",
      "831:         r\"file:///C:/Windows/System32/\",",
      "832:         r\"file:///etc/passwd\",",
      "833:         r\"file:///d:/windows/repair/sam\",",
      "834:         r\"file:///proc/version\",",
      "835:         r\"file:///inetpub/wwwroot/global.asa\",",
      "836:         r\"/file://../windows/win.ini\",",
      "837:         r\"../etc/passwd\",",
      "838:         r\"..\\Windows\\System32\\\\\",",
      "839:         r\"C:\\Windows\\System32\\\\\",",
      "840:         r\"/etc/passwd\",",
      "841:         r\"::Windows\\System32\",",
      "842:         r\"..\\..\\..\\..\\Windows\\System32\\\\\",",
      "843:         r\"../Windows/System32\",",
      "844:         r\"....\\\\\",",
      "845:         r\"\\\\?\\C:\\Windows\\System32\\\\\",",
      "846:         r\"\\\\.\\C:\\Windows\\System32\\\\\",",
      "847:         r\"\\\\UNC\\Server\\Share\\\\\",",
      "848:         r\"\\\\Server\\Share\\folder\\\\\",",
      "849:         r\"\\\\127.0.0.1\\c$\\Windows\\\\\",",
      "850:         r\"\\\\localhost\\c$\\Windows\\\\\",",
      "851:         r\"\\\\smbserver\\share\\path\\\\\",",
      "852:         r\"..\\\\?\\C:\\Windows\\System32\\\\\",",
      "853:         r\"C:/Windows/../Windows/System32/\",",
      "854:         r\"C:\\Windows\\..\\Windows\\System32\\\\\",",
      "855:         r\"../../../../../../../../../../../../Windows/System32\",",
      "856:         r\"../../../../../../../../../../../../etc/passwd\",",
      "857:         r\"../../../../../../../../../../../../var/www/html/index.html\",",
      "858:         r\"../../../../../../../../../../../../usr/local/etc/openvpn/server.conf\",",
      "859:         r\"../../../../../../../../../../../../Program Files (x86)\",",
      "860:         r\"/../../../../../../../../../../../../Windows/System32\",",
      "861:         r\"/Windows\\../etc/passwd\",",
      "862:         r\"/Windows\\..\\Windows\\System32\\\\\",",
      "863:         r\"/Windows\\..\\Windows\\System32\\cmd.exe\",",
      "864:         r\"/Windows\\..\\Windows\\System32\\msconfig.exe\",",
      "865:         r\"/Windows\\..\\Windows\\System32\\regedit.exe\",",
      "866:         r\"/Windows\\..\\Windows\\System32\\taskmgr.exe\",",
      "867:         r\"/Windows\\..\\Windows\\System32\\control.exe\",",
      "868:         r\"/Windows\\..\\Windows\\System32\\services.msc\",",
      "869:         r\"/Windows\\..\\Windows\\System32\\diskmgmt.msc\",",
      "870:         r\"/Windows\\..\\Windows\\System32\\eventvwr.msc\",",
      "871:         r\"/Windows/System32/drivers/etc/hosts\",",
      "872:     ],",
      "873: )",
      "874: def test_validate_path_is_safe_windows_bad(path):",
      "875:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
      "876:         validate_path_is_safe(path)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2b8b6619456396df2bd51df951ce56968e125b0d",
      "candidate_info": {
        "commit_hash": "2b8b6619456396df2bd51df951ce56968e125b0d",
        "repo": "mlflow/mlflow",
        "commit_url": "https://github.com/mlflow/mlflow/commit/2b8b6619456396df2bd51df951ce56968e125b0d",
        "files": [
          "mlflow/utils/uri.py",
          "tests/server/test_handlers.py",
          "tests/store/artifact/test_http_artifact_repo.py",
          "tests/tracking/test_rest_tracking.py",
          "tests/utils/test_uri.py"
        ],
        "message": "Prevent path traversal with encoded URL (#10650)\n\nSigned-off-by: B-Step62 <yuki.watanabe@databricks.com>",
        "before_after_code_files": [
          "mlflow/utils/uri.py||mlflow/utils/uri.py",
          "tests/server/test_handlers.py||tests/server/test_handlers.py",
          "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py",
          "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py",
          "tests/utils/test_uri.py||tests/utils/test_uri.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mlflow/utils/uri.py||mlflow/utils/uri.py",
            "tests/server/test_handlers.py||tests/server/test_handlers.py",
            "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py",
            "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py",
            "tests/utils/test_uri.py||tests/utils/test_uri.py"
          ],
          "candidate": [
            "mlflow/utils/uri.py||mlflow/utils/uri.py",
            "tests/server/test_handlers.py||tests/server/test_handlers.py",
            "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py",
            "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py",
            "tests/utils/test_uri.py||tests/utils/test_uri.py"
          ]
        }
      },
      "candidate_diff": {
        "mlflow/utils/uri.py||mlflow/utils/uri.py": [
          "File: mlflow/utils/uri.py -> mlflow/utils/uri.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "427:     \"\"\"",
          "428:     from mlflow.utils.file_utils import local_file_uri_to_path",
          "431:     if any((s in path) for s in (\"#\", \"%23\")):",
          "432:         raise exc",
          "",
          "[Removed Lines]",
          "430:     exc = MlflowException(f\"Invalid path: {path}\", error_code=INVALID_PARAMETER_VALUE)",
          "",
          "[Added Lines]",
          "430:     # We must decode URL before validating it",
          "431:     path = urllib.parse.unquote(path)",
          "433:     exc = MlflowException(\"Invalid path\", error_code=INVALID_PARAMETER_VALUE)",
          "",
          "---------------"
        ],
        "tests/server/test_handlers.py||tests/server/test_handlers.py": [
          "File: tests/server/test_handlers.py -> tests/server/test_handlers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     UpdateRegisteredModel,",
          "39: )",
          "40: from mlflow.protos.service_pb2 import CreateExperiment, SearchRuns",
          "42: from mlflow.server.handlers import (",
          "43:     _create_experiment,",
          "44:     _create_model_version,",
          "45:     _create_registered_model,",
          "46:     _delete_model_version,",
          "47:     _delete_model_version_tag,",
          "48:     _delete_registered_model,",
          "",
          "[Removed Lines]",
          "41: from mlflow.server import BACKEND_STORE_URI_ENV_VAR, app",
          "",
          "[Added Lines]",
          "41: from mlflow.server import BACKEND_STORE_URI_ENV_VAR, SERVE_ARTIFACTS_ENV_VAR, app",
          "46:     _delete_artifact_mlflow_artifacts,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "105:         yield mock_store",
          "108: def test_health():",
          "109:     with app.test_client() as c:",
          "110:         response = c.get(\"/health\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "109: @pytest.fixture",
          "110: def enable_serve_artifacts(monkeypatch):",
          "111:     monkeypatch.setenv(SERVE_ARTIFACTS_ENV_VAR, \"true\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "777:     _, args = mock_model_registry_store.get_model_version_by_alias.call_args",
          "778:     assert args == {\"name\": name, \"alias\": alias}",
          "779:     assert json.loads(resp.get_data()) == {\"model_version\": jsonify(mvd)}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "788: @pytest.mark.parametrize(",
          "789:     \"path\",",
          "790:     [",
          "791:         \"/path\",",
          "792:         \"path/../to/file\",",
          "793:         \"/etc/passwd\",",
          "794:         \"/etc/passwd%00.jpg\",",
          "795:         \"/file://etc/passwd\",",
          "796:         \"%2E%2E%2F%2E%2E%2Fpath\",",
          "797:     ],",
          "798: )",
          "799: def test_delete_artifact_mlflow_artifacts_throws_for_malicious_path(enable_serve_artifacts, path):",
          "800:     response = _delete_artifact_mlflow_artifacts(path)",
          "801:     assert response.status_code == 400",
          "802:     json_response = json.loads(response.get_data())",
          "803:     assert json_response[\"error_code\"] == ErrorCode.Name(INVALID_PARAMETER_VALUE)",
          "804:     assert json_response[\"message\"] == \"Invalid path\"",
          "",
          "---------------"
        ],
        "tests/store/artifact/test_http_artifact_repo.py||tests/store/artifact/test_http_artifact_repo.py": [
          "File: tests/store/artifact/test_http_artifact_repo.py -> tests/store/artifact/test_http_artifact_repo.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "246:             http_artifact_repo.list_artifacts()",
          "250: def test_list_artifacts_malicious_path(http_artifact_repo, path):",
          "251:     with mock.patch(",
          "252:         \"mlflow.store.artifact.http_artifact_repo.http_request\",",
          "",
          "[Removed Lines]",
          "249: @pytest.mark.parametrize(\"path\", [\"/tmp/path\", \"../../path\"])",
          "",
          "[Added Lines]",
          "249: @pytest.mark.parametrize(\"path\", [\"/tmp/path\", \"../../path\", \"%2E%2E%2Fpath\"])",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "259:             200,",
          "260:         ),",
          "261:     ):",
          "263:             http_artifact_repo.list_artifacts()",
          "",
          "[Removed Lines]",
          "262:         with pytest.raises(MlflowException, match=f\"Invalid path: {path}\"):",
          "",
          "[Added Lines]",
          "262:         with pytest.raises(MlflowException, match=\"Invalid path\"):",
          "",
          "---------------"
        ],
        "tests/tracking/test_rest_tracking.py||tests/tracking/test_rest_tracking.py": [
          "File: tests/tracking/test_rest_tracking.py -> tests/tracking/test_rest_tracking.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: )",
          "36: from mlflow.exceptions import MlflowException",
          "37: from mlflow.models import Model",
          "39: from mlflow.store.tracking.sqlalchemy_store import SqlAlchemyStore",
          "40: from mlflow.utils import mlflow_tags",
          "41: from mlflow.utils.file_utils import TempDir, path_to_local_file_uri",
          "",
          "[Removed Lines]",
          "38: from mlflow.server.handlers import validate_path_is_safe",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "514:     assert response.status_code == 200",
          "663: def test_path_validation(mlflow_client):",
          "664:     experiment_id = mlflow_client.create_experiment(\"tags validation\")",
          "665:     created_run = mlflow_client.create_run(experiment_id)",
          "",
          "[Removed Lines]",
          "517: @pytest.mark.parametrize(",
          "518:     \"path\",",
          "519:     [",
          "520:         \"path\",",
          "521:         \"path/\",",
          "522:         \"path/to/file\",",
          "523:     ],",
          "524: )",
          "525: def test_validate_path_is_safe_good(path):",
          "526:     validate_path_is_safe(path)",
          "529: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
          "530: @pytest.mark.parametrize(",
          "531:     \"path\",",
          "532:     [",
          "533:         # relative path from current directory of C: drive",
          "534:         \".../...//\",",
          "535:     ],",
          "536: )",
          "537: def test_validate_path_is_safe_windows_good(path):",
          "538:     validate_path_is_safe(path)",
          "541: @pytest.mark.skipif(is_windows(), reason=\"This test does not pass on Windows\")",
          "542: @pytest.mark.parametrize(",
          "543:     \"path\",",
          "544:     [",
          "545:         \"/path\",",
          "546:         \"../path\",",
          "547:         \"../../path\",",
          "548:         \"./../path\",",
          "549:         \"path/../to/file\",",
          "550:         \"path/../../to/file\",",
          "551:         \"file://a#/..//tmp\",",
          "552:         \"file://a%23/..//tmp/\",",
          "553:         \"/etc/passwd\",",
          "554:         \"/etc/passwd%00.jpg\",",
          "555:         \"/etc/passwd%00.html\",",
          "556:         \"/etc/passwd%00.txt\",",
          "557:         \"/etc/passwd%00.php\",",
          "558:         \"/etc/passwd%00.asp\",",
          "559:         \"/file://etc/passwd\",",
          "560:     ],",
          "561: )",
          "562: def test_validate_path_is_safe_bad(path):",
          "563:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
          "564:         validate_path_is_safe(path)",
          "567: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
          "568: @pytest.mark.parametrize(",
          "569:     \"path\",",
          "570:     [",
          "571:         r\"../path\",",
          "572:         r\"../../path\",",
          "573:         r\"./../path\",",
          "574:         r\"path/../to/file\",",
          "575:         r\"path/../../to/file\",",
          "576:         r\"..\\path\",",
          "577:         r\"..\\..\\path\",",
          "578:         r\".\\..\\path\",",
          "579:         r\"path\\..\\to\\file\",",
          "580:         r\"path\\..\\..\\to\\file\",",
          "581:         # Drive-relative paths",
          "582:         r\"C:path\",",
          "583:         r\"C:path/\",",
          "584:         r\"C:path/to/file\",",
          "585:         r\"C:../path/to/file\",",
          "586:         r\"C:\\path\",",
          "587:         r\"C:/path\",",
          "588:         r\"C:\\path\\to\\file\",",
          "589:         r\"C:\\path/to/file\",",
          "590:         r\"C:\\path\\..\\to\\file\",",
          "591:         r\"C:/path/../to/file\",",
          "592:         # UNC(Universal Naming Convention) paths",
          "593:         r\"\\\\path\\to\\file\",",
          "594:         r\"\\\\path/to/file\",",
          "595:         r\"\\\\.\\\\C:\\path\\to\\file\",",
          "596:         r\"\\\\?\\C:\\path\\to\\file\",",
          "597:         r\"\\\\?\\UNC/path/to/file\",",
          "598:         # Other potential attackable paths",
          "599:         r\"/etc/password\",",
          "600:         r\"/path\",",
          "601:         r\"/etc/passwd%00.jpg\",",
          "602:         r\"/etc/passwd%00.html\",",
          "603:         r\"/etc/passwd%00.txt\",",
          "604:         r\"/etc/passwd%00.php\",",
          "605:         r\"/etc/passwd%00.asp\",",
          "606:         r\"/Windows/no/such/path\",",
          "607:         r\"/file://etc/passwd\",",
          "608:         r\"/file:c:/passwd\",",
          "609:         r\"/file://d:/windows/win.ini\",",
          "610:         r\"/file://./windows/win.ini\",",
          "611:         r\"file://c:/boot.ini\",",
          "612:         r\"file://C:path\",",
          "613:         r\"file://C:path/\",",
          "614:         r\"file://C:path/to/file\",",
          "615:         r\"file:///C:/Windows/System32/\",",
          "616:         r\"file:///etc/passwd\",",
          "617:         r\"file:///d:/windows/repair/sam\",",
          "618:         r\"file:///proc/version\",",
          "619:         r\"file:///inetpub/wwwroot/global.asa\",",
          "620:         r\"/file://../windows/win.ini\",",
          "621:         r\"../etc/passwd\",",
          "622:         r\"..\\Windows\\System32\\\\\",",
          "623:         r\"C:\\Windows\\System32\\\\\",",
          "624:         r\"/etc/passwd\",",
          "625:         r\"::Windows\\System32\",",
          "626:         r\"..\\..\\..\\..\\Windows\\System32\\\\\",",
          "627:         r\"../Windows/System32\",",
          "628:         r\"....\\\\\",",
          "629:         r\"\\\\?\\C:\\Windows\\System32\\\\\",",
          "630:         r\"\\\\.\\C:\\Windows\\System32\\\\\",",
          "631:         r\"\\\\UNC\\Server\\Share\\\\\",",
          "632:         r\"\\\\Server\\Share\\folder\\\\\",",
          "633:         r\"\\\\127.0.0.1\\c$\\Windows\\\\\",",
          "634:         r\"\\\\localhost\\c$\\Windows\\\\\",",
          "635:         r\"\\\\smbserver\\share\\path\\\\\",",
          "636:         r\"..\\\\?\\C:\\Windows\\System32\\\\\",",
          "637:         r\"C:/Windows/../Windows/System32/\",",
          "638:         r\"C:\\Windows\\..\\Windows\\System32\\\\\",",
          "639:         r\"../../../../../../../../../../../../Windows/System32\",",
          "640:         r\"../../../../../../../../../../../../etc/passwd\",",
          "641:         r\"../../../../../../../../../../../../var/www/html/index.html\",",
          "642:         r\"../../../../../../../../../../../../usr/local/etc/openvpn/server.conf\",",
          "643:         r\"../../../../../../../../../../../../Program Files (x86)\",",
          "644:         r\"/../../../../../../../../../../../../Windows/System32\",",
          "645:         r\"/Windows\\../etc/passwd\",",
          "646:         r\"/Windows\\..\\Windows\\System32\\\\\",",
          "647:         r\"/Windows\\..\\Windows\\System32\\cmd.exe\",",
          "648:         r\"/Windows\\..\\Windows\\System32\\msconfig.exe\",",
          "649:         r\"/Windows\\..\\Windows\\System32\\regedit.exe\",",
          "650:         r\"/Windows\\..\\Windows\\System32\\taskmgr.exe\",",
          "651:         r\"/Windows\\..\\Windows\\System32\\control.exe\",",
          "652:         r\"/Windows\\..\\Windows\\System32\\services.msc\",",
          "653:         r\"/Windows\\..\\Windows\\System32\\diskmgmt.msc\",",
          "654:         r\"/Windows\\..\\Windows\\System32\\eventvwr.msc\",",
          "655:         r\"/Windows/System32/drivers/etc/hosts\",",
          "656:     ],",
          "657: )",
          "658: def test_validate_path_is_safe_windows_bad(path):",
          "659:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
          "660:         validate_path_is_safe(path)",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "670:         assert resp.status_code == 400",
          "671:         assert response.json() == {",
          "672:             \"error_code\": \"INVALID_PARAMETER_VALUE\",",
          "674:         }",
          "676:     response = requests.get(",
          "",
          "[Removed Lines]",
          "673:             \"message\": f\"Invalid path: {invalid_path}\",",
          "",
          "[Added Lines]",
          "526:             \"message\": \"Invalid path\",",
          "",
          "---------------"
        ],
        "tests/utils/test_uri.py||tests/utils/test_uri.py": [
          "File: tests/utils/test_uri.py -> tests/utils/test_uri.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "24:     is_valid_dbfs_uri,",
          "25:     remove_databricks_profile_info_from_artifact_uri,",
          "26:     resolve_uri_if_local,",
          "27: )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27:     validate_path_is_safe,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "722: )",
          "723: def test_negative_detection(uri):",
          "724:     assert not is_fuse_or_uc_volumes_uri(uri)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "728: @pytest.mark.parametrize(",
          "729:     \"path\",",
          "730:     [",
          "731:         \"path\",",
          "732:         \"path/\",",
          "733:         \"path/to/file\",",
          "734:     ],",
          "735: )",
          "736: def test_validate_path_is_safe_good(path):",
          "737:     validate_path_is_safe(path)",
          "740: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
          "741: @pytest.mark.parametrize(",
          "742:     \"path\",",
          "743:     [",
          "744:         # relative path from current directory of C: drive",
          "745:         \".../...//\",",
          "746:     ],",
          "747: )",
          "748: def test_validate_path_is_safe_windows_good(path):",
          "749:     validate_path_is_safe(path)",
          "752: @pytest.mark.skipif(is_windows(), reason=\"This test does not pass on Windows\")",
          "753: @pytest.mark.parametrize(",
          "754:     \"path\",",
          "755:     [",
          "756:         \"/path\",",
          "757:         \"../path\",",
          "758:         \"../../path\",",
          "759:         \"./../path\",",
          "760:         \"path/../to/file\",",
          "761:         \"path/../../to/file\",",
          "762:         \"file://a#/..//tmp\",",
          "763:         \"file://a%23/..//tmp/\",",
          "764:         \"/etc/passwd\",",
          "765:         \"/etc/passwd%00.jpg\",",
          "766:         \"/etc/passwd%00.html\",",
          "767:         \"/etc/passwd%00.txt\",",
          "768:         \"/etc/passwd%00.php\",",
          "769:         \"/etc/passwd%00.asp\",",
          "770:         \"/file://etc/passwd\",",
          "771:         # Encoded paths with '..'",
          "772:         \"%2E%2E%2Fpath\",",
          "773:         \"%2E%2E%2F%2E%2E%2Fpath\",",
          "774:     ],",
          "775: )",
          "776: def test_validate_path_is_safe_bad(path):",
          "777:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
          "778:         validate_path_is_safe(path)",
          "781: @pytest.mark.skipif(not is_windows(), reason=\"This test only passes on Windows\")",
          "782: @pytest.mark.parametrize(",
          "783:     \"path\",",
          "784:     [",
          "785:         r\"../path\",",
          "786:         r\"../../path\",",
          "787:         r\"./../path\",",
          "788:         r\"path/../to/file\",",
          "789:         r\"path/../../to/file\",",
          "790:         r\"..\\path\",",
          "791:         r\"..\\..\\path\",",
          "792:         r\".\\..\\path\",",
          "793:         r\"path\\..\\to\\file\",",
          "794:         r\"path\\..\\..\\to\\file\",",
          "795:         # Drive-relative paths",
          "796:         r\"C:path\",",
          "797:         r\"C:path/\",",
          "798:         r\"C:path/to/file\",",
          "799:         r\"C:../path/to/file\",",
          "800:         r\"C:\\path\",",
          "801:         r\"C:/path\",",
          "802:         r\"C:\\path\\to\\file\",",
          "803:         r\"C:\\path/to/file\",",
          "804:         r\"C:\\path\\..\\to\\file\",",
          "805:         r\"C:/path/../to/file\",",
          "806:         # UNC(Universal Naming Convention) paths",
          "807:         r\"\\\\path\\to\\file\",",
          "808:         r\"\\\\path/to/file\",",
          "809:         r\"\\\\.\\\\C:\\path\\to\\file\",",
          "810:         r\"\\\\?\\C:\\path\\to\\file\",",
          "811:         r\"\\\\?\\UNC/path/to/file\",",
          "812:         # Other potential attackable paths",
          "813:         r\"/etc/password\",",
          "814:         r\"/path\",",
          "815:         r\"/etc/passwd%00.jpg\",",
          "816:         r\"/etc/passwd%00.html\",",
          "817:         r\"/etc/passwd%00.txt\",",
          "818:         r\"/etc/passwd%00.php\",",
          "819:         r\"/etc/passwd%00.asp\",",
          "820:         r\"/Windows/no/such/path\",",
          "821:         r\"/file://etc/passwd\",",
          "822:         r\"/file:c:/passwd\",",
          "823:         r\"/file://d:/windows/win.ini\",",
          "824:         r\"/file://./windows/win.ini\",",
          "825:         r\"file://c:/boot.ini\",",
          "826:         r\"file://C:path\",",
          "827:         r\"file://C:path/\",",
          "828:         r\"file://C:path/to/file\",",
          "829:         r\"file:///C:/Windows/System32/\",",
          "830:         r\"file:///etc/passwd\",",
          "831:         r\"file:///d:/windows/repair/sam\",",
          "832:         r\"file:///proc/version\",",
          "833:         r\"file:///inetpub/wwwroot/global.asa\",",
          "834:         r\"/file://../windows/win.ini\",",
          "835:         r\"../etc/passwd\",",
          "836:         r\"..\\Windows\\System32\\\\\",",
          "837:         r\"C:\\Windows\\System32\\\\\",",
          "838:         r\"/etc/passwd\",",
          "839:         r\"::Windows\\System32\",",
          "840:         r\"..\\..\\..\\..\\Windows\\System32\\\\\",",
          "841:         r\"../Windows/System32\",",
          "842:         r\"....\\\\\",",
          "843:         r\"\\\\?\\C:\\Windows\\System32\\\\\",",
          "844:         r\"\\\\.\\C:\\Windows\\System32\\\\\",",
          "845:         r\"\\\\UNC\\Server\\Share\\\\\",",
          "846:         r\"\\\\Server\\Share\\folder\\\\\",",
          "847:         r\"\\\\127.0.0.1\\c$\\Windows\\\\\",",
          "848:         r\"\\\\localhost\\c$\\Windows\\\\\",",
          "849:         r\"\\\\smbserver\\share\\path\\\\\",",
          "850:         r\"..\\\\?\\C:\\Windows\\System32\\\\\",",
          "851:         r\"C:/Windows/../Windows/System32/\",",
          "852:         r\"C:\\Windows\\..\\Windows\\System32\\\\\",",
          "853:         r\"../../../../../../../../../../../../Windows/System32\",",
          "854:         r\"../../../../../../../../../../../../etc/passwd\",",
          "855:         r\"../../../../../../../../../../../../var/www/html/index.html\",",
          "856:         r\"../../../../../../../../../../../../usr/local/etc/openvpn/server.conf\",",
          "857:         r\"../../../../../../../../../../../../Program Files (x86)\",",
          "858:         r\"/../../../../../../../../../../../../Windows/System32\",",
          "859:         r\"/Windows\\../etc/passwd\",",
          "860:         r\"/Windows\\..\\Windows\\System32\\\\\",",
          "861:         r\"/Windows\\..\\Windows\\System32\\cmd.exe\",",
          "862:         r\"/Windows\\..\\Windows\\System32\\msconfig.exe\",",
          "863:         r\"/Windows\\..\\Windows\\System32\\regedit.exe\",",
          "864:         r\"/Windows\\..\\Windows\\System32\\taskmgr.exe\",",
          "865:         r\"/Windows\\..\\Windows\\System32\\control.exe\",",
          "866:         r\"/Windows\\..\\Windows\\System32\\services.msc\",",
          "867:         r\"/Windows\\..\\Windows\\System32\\diskmgmt.msc\",",
          "868:         r\"/Windows\\..\\Windows\\System32\\eventvwr.msc\",",
          "869:         r\"/Windows/System32/drivers/etc/hosts\",",
          "870:     ],",
          "871: )",
          "872: def test_validate_path_is_safe_windows_bad(path):",
          "873:     with pytest.raises(MlflowException, match=\"Invalid path\"):",
          "874:         validate_path_is_safe(path)",
          "",
          "---------------"
        ]
      }
    }
  ]
}