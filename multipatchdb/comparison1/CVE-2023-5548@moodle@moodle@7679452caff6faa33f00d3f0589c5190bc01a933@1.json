{
  "cve_id": "CVE-2023-5548",
  "cve_desc": "Stronger revision number limitations were required on file serving endpoints to improve cache poisoning protection.",
  "repo": "moodle/moodle",
  "patch_hash": "7679452caff6faa33f00d3f0589c5190bc01a933",
  "patch_info": {
    "commit_hash": "7679452caff6faa33f00d3f0589c5190bc01a933",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/7679452caff6faa33f00d3f0589c5190bc01a933",
    "files": [
      "lib/configonlylib.php",
      "lib/editor/tiny/lang.php",
      "lib/editor/tiny/loader.php",
      "lib/javascript.php",
      "lib/tests/configonlylib_test.php",
      "theme/font.php",
      "theme/image.php",
      "theme/javascript.php",
      "theme/styles.php",
      "theme/yui_combo.php"
    ],
    "message": "MDL-77846 core: Make endpoint revision number checks stricter\n\nIn some places we prevented cache poisoning, in others we did not. We\nalso did not place any restriction on the minimum value for a revision.\n\nThis change introduces a new set of functions for configonly endpoints\nwhich validates the revision numbers passed in. If the revision is\neither too old, or too new, it is rejected and the file content is not\ncached. The content is still served, but caching headers are not sent,\nand any local storage caching is prevented.\n\nThe current time is used as the maximum version, with 60 seconds added\nto allow for any clock skew between cluster nodes. Previously some\nlocations used one hour, but there should never be such a large clock\nskew on a correctly configured system.\n\nCo-authored-by: Andrew Nicols <andrew@nicols.co.uk>",
    "before_after_code_files": [
      "lib/configonlylib.php||lib/configonlylib.php",
      "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
      "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
      "lib/javascript.php||lib/javascript.php",
      "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
      "theme/font.php||theme/font.php",
      "theme/image.php||theme/image.php",
      "theme/javascript.php||theme/javascript.php",
      "theme/styles.php||theme/styles.php",
      "theme/yui_combo.php||theme/yui_combo.php"
    ]
  },
  "patch_diff": {
    "lib/configonlylib.php||lib/configonlylib.php": [
      "File: lib/configonlylib.php -> lib/configonlylib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "205:     }",
      "206:     return $relativepath;",
      "207: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "216: function min_get_minimum_revision(): int {",
      "217:     static $timestamp = null;",
      "219:     if ($timestamp === null) {",
      "220:         global $CFG;",
      "221:         require(\"{$CFG->dirroot}/version.php\");",
      "223:         $datestring = floor($version / 100);",
      "225:         $year = intval(substr($datestring, 0, 4));",
      "226:         $month = intval(substr($datestring, 4, 2));",
      "227:         $day = intval(substr($datestring, 6, 2));",
      "229:         $timestamp = gmmktime(0, 0, 0, $month, $day, $year);",
      "230:     }",
      "232:     return $timestamp;",
      "233: }",
      "244: function min_get_maximum_revision(): int {",
      "245:     return time() + 60;",
      "246: }",
      "254: function min_is_revision_valid_and_current(int $revision): bool {",
      "256:     if ($revision <= 0) {",
      "257:         return false;",
      "258:     }",
      "260:     return $revision >= min_get_minimum_revision() && $revision <= min_get_maximum_revision();",
      "261: }",
      "",
      "---------------"
    ],
    "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php": [
      "File: lib/editor/tiny/lang.php -> lib/editor/tiny/lang.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "96:     protected function serve_file(): void {",
      "99:             if ($this->is_candidate_file_available()) {",
      "",
      "[Removed Lines]",
      "98:         if ($this->rev > 0) {",
      "",
      "[Added Lines]",
      "99:         if (min_is_revision_valid_and_current($this->rev)) {",
      "",
      "---------------"
    ],
    "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php": [
      "File: lib/editor/tiny/loader.php -> lib/editor/tiny/loader.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "115:     public function serve_file(): void {",
      "118:             if ($this->is_candidate_file_available()) {",
      "",
      "[Removed Lines]",
      "117:         if ($this->rev > 0) {",
      "",
      "[Added Lines]",
      "118:         if (min_is_revision_valid_and_current($this->rev)) {",
      "",
      "---------------"
    ],
    "lib/javascript.php||lib/javascript.php": [
      "File: lib/javascript.php -> lib/javascript.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "47:     $file = min_optional_param('jsfile', '', 'RAW'); // 'file' would collide with URL rewriting!",
      "48: }",
      "51: $jsfiles = array();",
      "52: $files = explode(',', $file);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "50: if (!min_is_revision_valid_and_current($rev)) {",
      "52:     $rev = -1;",
      "53: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "80: $etag = sha1($rev.implode(',', $jsfiles));",
      "84:     $candidate = $CFG->localcachedir.'/js/'.$etag;",
      "86:     if (file_exists($candidate)) {",
      "",
      "[Removed Lines]",
      "83: if ($rev > 0 and $rev < (time() + 60*60)) {",
      "",
      "[Added Lines]",
      "87: if ($rev > 0) {",
      "",
      "---------------"
    ],
    "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php": [
      "File: lib/tests/configonlylib_test.php -> lib/tests/configonlylib_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "145:         $this->assertSame('/standardcore/./5/u/f1', min_get_slash_argument());",
      "146:     }",
      "147: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "152:     public function test_min_get_minimum_version(): void {",
      "155:         $firstintroduced = 1693612800; // Equivalent to 20230902 00:00:00 GMT.",
      "156:         $this->assertGreaterThanOrEqual($firstintroduced, min_get_minimum_revision());",
      "157:     }",
      "164:     public function test_min_get_maximum_version(): void {",
      "168:         $this->assertGreaterThan(time(), min_get_maximum_revision());",
      "169:         $this->assertLessThanOrEqual(time() + 65, min_get_maximum_revision());",
      "170:     }",
      "178:     public function test_min_is_revision_valid_and_current(int $revision, bool $expected): void {",
      "179:         $this->assertEquals($expected, min_is_revision_valid_and_current($revision));",
      "180:     }",
      "187:     public function min_is_revision_valid_and_current_provider(): array {",
      "188:         return [",
      "189:             'Negative value' => [-1, false],",
      "190:             'Empty value' => [0, false],",
      "191:             'A time before the minimum accepted value' => [min_get_minimum_revision() - 1, false],",
      "192:             'The minimum accepted value' => [min_get_minimum_revision(), true],",
      "193:             'The current time' => [time(), true],",
      "198:             'A time in the future' => [time() + DAYSECS, false]",
      "199:         ];",
      "200:     }",
      "210:     public function test_min_is_revision_valid_and_current_close_proximity(): void {",
      "212:         $this->assertTrue(min_is_revision_valid_and_current(time() + 55));",
      "215:         $this->assertFalse(min_is_revision_valid_and_current(time() + 70));",
      "217:     }",
      "",
      "---------------"
    ],
    "theme/font.php||theme/font.php": [
      "File: theme/font.php -> theme/font.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "49:     $font      = min_optional_param('font', '', 'RAW');",
      "50: }",
      "52: if (!$font) {",
      "53:     font_not_found();",
      "54: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "52: if (!min_is_revision_valid_and_current($rev)) {",
      "54:     $rev = -1;",
      "55: }",
      "",
      "---------------"
    ],
    "theme/image.php||theme/image.php": [
      "File: theme/image.php -> theme/image.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "58:     $usesvg    = (bool)min_optional_param('svg', '1', 'INT');",
      "59: }",
      "61: if (empty($component) or $component === 'moodle' or $component === 'core') {",
      "62:     $component = 'core';",
      "63: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "61: if (!min_is_revision_valid_and_current($rev)) {",
      "63:     $rev = -1;",
      "64: }",
      "",
      "---------------"
    ],
    "theme/javascript.php||theme/javascript.php": [
      "File: theme/javascript.php -> theme/javascript.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "50:     $type      = min_optional_param('type', 'head', 'RAW');",
      "51: }",
      "53: if ($type !== 'head' and $type !== 'footer') {",
      "54:     header('HTTP/1.0 404 not found');",
      "55:     die('Theme was not found, sorry.');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "53: if (!min_is_revision_valid_and_current($rev)) {",
      "55:     $rev = -1;",
      "56: }",
      "",
      "---------------"
    ],
    "theme/styles.php||theme/styles.php": [
      "File: theme/styles.php -> theme/styles.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "66:     $themesubrev = min_clean_param($themesubrev, 'INT');",
      "67: }",
      "70: if (!in_array($type, ['all', 'all-rtl', 'editor', 'editor-rtl'])) {",
      "71:     css_send_css_not_found();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "71: if (!min_is_revision_valid_and_current($rev)) {",
      "73:     $rev = -1;",
      "74: }",
      "",
      "---------------"
    ],
    "theme/yui_combo.php||theme/yui_combo.php": [
      "File: theme/yui_combo.php -> theme/yui_combo.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "231:             continue;",
      "232:         }",
      "233:         $revision = (int)array_shift($bits);",
      "236:             $cache = false;",
      "237:         }",
      "238:         $frankenstyle = array_shift($bits);",
      "",
      "[Removed Lines]",
      "234:         if ($revision === -1) {",
      "",
      "[Added Lines]",
      "234:         if (!min_is_revision_valid_and_current($revision)) {",
      "236:             $revision = -1;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "278:             continue;",
      "279:         }",
      "280:         $revision = (int)array_shift($bits);",
      "283:             $cache = false;",
      "284:         }",
      "285:         $contentfile = \"$CFG->libdir/yuilib/gallery/\" . join('/', $bits);",
      "",
      "[Removed Lines]",
      "281:         if ($revision === -1) {",
      "",
      "[Added Lines]",
      "282:         if (!min_is_revision_valid_and_current($revision)) {",
      "284:             $revision = -1;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "42518c7c4a9fd8cfa209971ca81e59cc3c4d72e2",
      "candidate_info": {
        "commit_hash": "42518c7c4a9fd8cfa209971ca81e59cc3c4d72e2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/42518c7c4a9fd8cfa209971ca81e59cc3c4d72e2",
        "files": [
          "lib/configonlylib.php",
          "lib/javascript.php",
          "lib/tests/configonlylib_test.php",
          "theme/font.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php",
          "theme/yui_combo.php"
        ],
        "message": "MDL-77846 core: Make endpoint revision number checks stricter\n\nIn some places we prevented cache poisoning, in others we did not. We\nalso did not place any restriction on the minimum value for a revision.\n\nThis change introduces a new set of functions for configonly endpoints\nwhich validates the revision numbers passed in. If the revision is\neither too old, or too new, it is rejected and the file content is not\ncached. The content is still served, but caching headers are not sent,\nand any local storage caching is prevented.\n\nThe current time is used as the maximum version, with 60 seconds added\nto allow for any clock skew between cluster nodes. Previously some\nlocations used one hour, but there should never be such a large clock\nskew on a correctly configured system.\n\nCo-authored-by: Andrew Nicols <andrew@nicols.co.uk>",
        "before_after_code_files": [
          "lib/configonlylib.php||lib/configonlylib.php",
          "lib/javascript.php||lib/javascript.php",
          "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
          "theme/font.php||theme/font.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php",
          "theme/yui_combo.php||theme/yui_combo.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ],
          "candidate": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/configonlylib.php||lib/configonlylib.php": [
          "File: lib/configonlylib.php -> lib/configonlylib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:     }",
          "206:     return $relativepath;",
          "207: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "216: function min_get_minimum_revision(): int {",
          "217:     static $timestamp = null;",
          "219:     if ($timestamp === null) {",
          "220:         global $CFG;",
          "221:         require(\"{$CFG->dirroot}/version.php\");",
          "223:         $datestring = floor($version / 100);",
          "225:         $year = intval(substr($datestring, 0, 4));",
          "226:         $month = intval(substr($datestring, 4, 2));",
          "227:         $day = intval(substr($datestring, 6, 2));",
          "229:         $timestamp = gmmktime(0, 0, 0, $month, $day, $year);",
          "230:     }",
          "232:     return $timestamp;",
          "233: }",
          "244: function min_get_maximum_revision(): int {",
          "245:     return time() + 60;",
          "246: }",
          "254: function min_is_revision_valid_and_current(int $revision): bool {",
          "256:     if ($revision <= 0) {",
          "257:         return false;",
          "258:     }",
          "260:     return $revision >= min_get_minimum_revision() && $revision <= min_get_maximum_revision();",
          "261: }",
          "",
          "---------------"
        ],
        "lib/javascript.php||lib/javascript.php": [
          "File: lib/javascript.php -> lib/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     $file = min_optional_param('jsfile', '', 'RAW'); // 'file' would collide with URL rewriting!",
          "48: }",
          "51: $jsfiles = array();",
          "52: $files = explode(',', $file);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50: if (!min_is_revision_valid_and_current($rev)) {",
          "52:     $rev = -1;",
          "53: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80: $etag = sha1($rev.implode(',', $jsfiles));",
          "84:     $candidate = $CFG->localcachedir.'/js/'.$etag;",
          "86:     if (file_exists($candidate)) {",
          "",
          "[Removed Lines]",
          "83: if ($rev > 0 and $rev < (time() + 60*60)) {",
          "",
          "[Added Lines]",
          "87: if ($rev > 0) {",
          "",
          "---------------"
        ],
        "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php": [
          "File: lib/tests/configonlylib_test.php -> lib/tests/configonlylib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "145:         $this->assertSame('/standardcore/./5/u/f1', min_get_slash_argument());",
          "146:     }",
          "147: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152:     public function test_min_get_minimum_version(): void {",
          "155:         $firstintroduced = 1650326400; // Equivalent to 20220419 00:00:00 GMT.",
          "156:         $this->assertGreaterThanOrEqual($firstintroduced, min_get_minimum_revision());",
          "157:     }",
          "164:     public function test_min_get_maximum_version(): void {",
          "168:         $this->assertGreaterThan(time(), min_get_maximum_revision());",
          "169:         $this->assertLessThanOrEqual(time() + 65, min_get_maximum_revision());",
          "170:     }",
          "178:     public function test_min_is_revision_valid_and_current(int $revision, bool $expected): void {",
          "179:         $this->assertEquals($expected, min_is_revision_valid_and_current($revision));",
          "180:     }",
          "187:     public function min_is_revision_valid_and_current_provider(): array {",
          "188:         return [",
          "189:             'Negative value' => [-1, false],",
          "190:             'Empty value' => [0, false],",
          "191:             'A time before the minimum accepted value' => [min_get_minimum_revision() - 1, false],",
          "192:             'The minimum accepted value' => [min_get_minimum_revision(), true],",
          "193:             'The current time' => [time(), true],",
          "198:             'A time in the future' => [time() + DAYSECS, false]",
          "199:         ];",
          "200:     }",
          "210:     public function test_min_is_revision_valid_and_current_close_proximity(): void {",
          "212:         $this->assertTrue(min_is_revision_valid_and_current(time() + 55));",
          "215:         $this->assertFalse(min_is_revision_valid_and_current(time() + 70));",
          "217:     }",
          "",
          "---------------"
        ],
        "theme/font.php||theme/font.php": [
          "File: theme/font.php -> theme/font.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     $font      = min_optional_param('font', '', 'RAW');",
          "50: }",
          "52: if (!$font) {",
          "53:     font_not_found();",
          "54: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: if (!min_is_revision_valid_and_current($rev)) {",
          "54:     $rev = -1;",
          "55: }",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     $usesvg    = (bool)min_optional_param('svg', '1', 'INT');",
          "59: }",
          "61: if (empty($component) or $component === 'moodle' or $component === 'core') {",
          "62:     $component = 'core';",
          "63: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: if (!min_is_revision_valid_and_current($rev)) {",
          "63:     $rev = -1;",
          "64: }",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:     $type      = min_optional_param('type', 'head', 'RAW');",
          "51: }",
          "53: if ($type !== 'head' and $type !== 'footer') {",
          "54:     header('HTTP/1.0 404 not found');",
          "55:     die('Theme was not found, sorry.');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53: if (!min_is_revision_valid_and_current($rev)) {",
          "55:     $rev = -1;",
          "56: }",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     $themesubrev = min_clean_param($themesubrev, 'INT');",
          "67: }",
          "70: if (!in_array($type, ['all', 'all-rtl', 'editor', 'editor-rtl'])) {",
          "71:     css_send_css_not_found();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: if (!min_is_revision_valid_and_current($rev)) {",
          "73:     $rev = -1;",
          "74: }",
          "",
          "---------------"
        ],
        "theme/yui_combo.php||theme/yui_combo.php": [
          "File: theme/yui_combo.php -> theme/yui_combo.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:             continue;",
          "235:         }",
          "236:         $revision = (int)array_shift($bits);",
          "239:             $cache = false;",
          "240:         }",
          "241:         $frankenstyle = array_shift($bits);",
          "",
          "[Removed Lines]",
          "237:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "237:         if (!min_is_revision_valid_and_current($revision)) {",
          "239:             $revision = -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "281:             continue;",
          "282:         }",
          "283:         $revision = (int)array_shift($bits);",
          "286:             $cache = false;",
          "287:         }",
          "288:         $contentfile = \"$CFG->libdir/yuilib/gallery/\" . join('/', $bits);",
          "",
          "[Removed Lines]",
          "284:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "285:         if (!min_is_revision_valid_and_current($revision)) {",
          "287:             $revision = -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9ecef711915d62a79d0f6d63a5996197f7f36c6d",
      "candidate_info": {
        "commit_hash": "9ecef711915d62a79d0f6d63a5996197f7f36c6d",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9ecef711915d62a79d0f6d63a5996197f7f36c6d",
        "files": [
          "lib/configonlylib.php",
          "lib/javascript.php",
          "lib/tests/configonlylib_test.php",
          "theme/font.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php",
          "theme/yui_combo.php"
        ],
        "message": "MDL-77846 core: Make endpoint revision number checks stricter\n\nIn some places we prevented cache poisoning, in others we did not. We\nalso did not place any restriction on the minimum value for a revision.\n\nThis change introduces a new set of functions for configonly endpoints\nwhich validates the revision numbers passed in. If the revision is\neither too old, or too new, it is rejected and the file content is not\ncached. The content is still served, but caching headers are not sent,\nand any local storage caching is prevented.\n\nThe current time is used as the maximum version, with 60 seconds added\nto allow for any clock skew between cluster nodes. Previously some\nlocations used one hour, but there should never be such a large clock\nskew on a correctly configured system.\n\nCo-authored-by: Andrew Nicols <andrew@nicols.co.uk>",
        "before_after_code_files": [
          "lib/configonlylib.php||lib/configonlylib.php",
          "lib/javascript.php||lib/javascript.php",
          "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
          "theme/font.php||theme/font.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php",
          "theme/yui_combo.php||theme/yui_combo.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ],
          "candidate": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/configonlylib.php||lib/configonlylib.php": [
          "File: lib/configonlylib.php -> lib/configonlylib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:     }",
          "206:     return $relativepath;",
          "207: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "216: function min_get_minimum_revision(): int {",
          "217:     static $timestamp = null;",
          "219:     if ($timestamp === null) {",
          "220:         global $CFG;",
          "221:         require(\"{$CFG->dirroot}/version.php\");",
          "223:         $datestring = floor($version / 100);",
          "225:         $year = intval(substr($datestring, 0, 4));",
          "226:         $month = intval(substr($datestring, 4, 2));",
          "227:         $day = intval(substr($datestring, 6, 2));",
          "229:         $timestamp = gmmktime(0, 0, 0, $month, $day, $year);",
          "230:     }",
          "232:     return $timestamp;",
          "233: }",
          "244: function min_get_maximum_revision(): int {",
          "245:     return time() + 60;",
          "246: }",
          "254: function min_is_revision_valid_and_current(int $revision): bool {",
          "256:     if ($revision <= 0) {",
          "257:         return false;",
          "258:     }",
          "260:     return $revision >= min_get_minimum_revision() && $revision <= min_get_maximum_revision();",
          "261: }",
          "",
          "---------------"
        ],
        "lib/javascript.php||lib/javascript.php": [
          "File: lib/javascript.php -> lib/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     $file = min_optional_param('jsfile', '', 'RAW'); // 'file' would collide with URL rewriting!",
          "48: }",
          "51: $jsfiles = array();",
          "52: $files = explode(',', $file);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50: if (!min_is_revision_valid_and_current($rev)) {",
          "52:     $rev = -1;",
          "53: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80: $etag = sha1($rev.implode(',', $jsfiles));",
          "84:     $candidate = $CFG->localcachedir.'/js/'.$etag;",
          "86:     if (file_exists($candidate)) {",
          "",
          "[Removed Lines]",
          "83: if ($rev > 0 and $rev < (time() + 60*60)) {",
          "",
          "[Added Lines]",
          "87: if ($rev > 0) {",
          "",
          "---------------"
        ],
        "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php": [
          "File: lib/tests/configonlylib_test.php -> lib/tests/configonlylib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "145:         $this->assertSame('/standardcore/./5/u/f1', min_get_slash_argument());",
          "146:     }",
          "147: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152:     public function test_min_get_minimum_version(): void {",
          "155:         $firstintroduced = 1621209600; // Equivalent to 20210517 00:00:00 GMT.",
          "156:         $this->assertGreaterThanOrEqual($firstintroduced, min_get_minimum_revision());",
          "157:     }",
          "164:     public function test_min_get_maximum_version(): void {",
          "168:         $this->assertGreaterThan(time(), min_get_maximum_revision());",
          "169:         $this->assertLessThanOrEqual(time() + 65, min_get_maximum_revision());",
          "170:     }",
          "178:     public function test_min_is_revision_valid_and_current(int $revision, bool $expected): void {",
          "179:         $this->assertEquals($expected, min_is_revision_valid_and_current($revision));",
          "180:     }",
          "187:     public function min_is_revision_valid_and_current_provider(): array {",
          "188:         return [",
          "189:             'Negative value' => [-1, false],",
          "190:             'Empty value' => [0, false],",
          "191:             'A time before the minimum accepted value' => [min_get_minimum_revision() - 1, false],",
          "192:             'The minimum accepted value' => [min_get_minimum_revision(), true],",
          "193:             'The current time' => [time(), true],",
          "198:             'A time in the future' => [time() + DAYSECS, false]",
          "199:         ];",
          "200:     }",
          "210:     public function test_min_is_revision_valid_and_current_close_proximity(): void {",
          "212:         $this->assertTrue(min_is_revision_valid_and_current(time() + 55));",
          "215:         $this->assertFalse(min_is_revision_valid_and_current(time() + 70));",
          "217:     }",
          "",
          "---------------"
        ],
        "theme/font.php||theme/font.php": [
          "File: theme/font.php -> theme/font.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     $font      = min_optional_param('font', '', 'RAW');",
          "50: }",
          "52: if (!$font) {",
          "53:     font_not_found();",
          "54: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: if (!min_is_revision_valid_and_current($rev)) {",
          "54:     $rev = -1;",
          "55: }",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     $usesvg    = (bool)min_optional_param('svg', '1', 'INT');",
          "59: }",
          "61: if (empty($component) or $component === 'moodle' or $component === 'core') {",
          "62:     $component = 'core';",
          "63: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: if (!min_is_revision_valid_and_current($rev)) {",
          "63:     $rev = -1;",
          "64: }",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:     $type      = min_optional_param('type', 'head', 'RAW');",
          "51: }",
          "53: if ($type !== 'head' and $type !== 'footer') {",
          "54:     header('HTTP/1.0 404 not found');",
          "55:     die('Theme was not found, sorry.');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53: if (!min_is_revision_valid_and_current($rev)) {",
          "55:     $rev = -1;",
          "56: }",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     $themesubrev = min_clean_param($themesubrev, 'INT');",
          "67: }",
          "70: if (!in_array($type, ['all', 'all-rtl', 'editor'])) {",
          "71:     css_send_css_not_found();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: if (!min_is_revision_valid_and_current($rev)) {",
          "73:     $rev = -1;",
          "74: }",
          "",
          "---------------"
        ],
        "theme/yui_combo.php||theme/yui_combo.php": [
          "File: theme/yui_combo.php -> theme/yui_combo.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:             continue;",
          "235:         }",
          "236:         $revision = (int)array_shift($bits);",
          "239:             $cache = false;",
          "240:         }",
          "241:         $frankenstyle = array_shift($bits);",
          "",
          "[Removed Lines]",
          "237:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "237:         if (!min_is_revision_valid_and_current($revision)) {",
          "239:             $revision = -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "281:             continue;",
          "282:         }",
          "283:         $revision = (int)array_shift($bits);",
          "286:             $cache = false;",
          "287:         }",
          "288:         $contentfile = \"$CFG->libdir/yuilib/gallery/\" . join('/', $bits);",
          "",
          "[Removed Lines]",
          "284:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "285:         if (!min_is_revision_valid_and_current($revision)) {",
          "287:             $revision = -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6f2fa6011eb87c88543f5569b0576ec179201651",
      "candidate_info": {
        "commit_hash": "6f2fa6011eb87c88543f5569b0576ec179201651",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6f2fa6011eb87c88543f5569b0576ec179201651",
        "files": [
          "lib/configonlylib.php",
          "lib/editor/tiny/lang.php",
          "lib/editor/tiny/loader.php",
          "lib/javascript.php",
          "lib/tests/configonlylib_test.php",
          "theme/font.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php",
          "theme/yui_combo.php"
        ],
        "message": "MDL-77846 core: Make endpoint revision number checks stricter\n\nIn some places we prevented cache poisoning, in others we did not. We\nalso did not place any restriction on the minimum value for a revision.\n\nThis change introduces a new set of functions for configonly endpoints\nwhich validates the revision numbers passed in. If the revision is\neither too old, or too new, it is rejected and the file content is not\ncached. The content is still served, but caching headers are not sent,\nand any local storage caching is prevented.\n\nThe current time is used as the maximum version, with 60 seconds added\nto allow for any clock skew between cluster nodes. Previously some\nlocations used one hour, but there should never be such a large clock\nskew on a correctly configured system.\n\nCo-authored-by: Andrew Nicols <andrew@nicols.co.uk>",
        "before_after_code_files": [
          "lib/configonlylib.php||lib/configonlylib.php",
          "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
          "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
          "lib/javascript.php||lib/javascript.php",
          "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
          "theme/font.php||theme/font.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php",
          "theme/yui_combo.php||theme/yui_combo.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
            "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ],
          "candidate": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
            "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/configonlylib.php||lib/configonlylib.php": [
          "File: lib/configonlylib.php -> lib/configonlylib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:     }",
          "206:     return $relativepath;",
          "207: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "216: function min_get_minimum_revision(): int {",
          "217:     static $timestamp = null;",
          "219:     if ($timestamp === null) {",
          "220:         global $CFG;",
          "221:         require(\"{$CFG->dirroot}/version.php\");",
          "223:         $datestring = floor($version / 100);",
          "225:         $year = intval(substr($datestring, 0, 4));",
          "226:         $month = intval(substr($datestring, 4, 2));",
          "227:         $day = intval(substr($datestring, 6, 2));",
          "229:         $timestamp = gmmktime(0, 0, 0, $month, $day, $year);",
          "230:     }",
          "232:     return $timestamp;",
          "233: }",
          "244: function min_get_maximum_revision(): int {",
          "245:     return time() + 60;",
          "246: }",
          "254: function min_is_revision_valid_and_current(int $revision): bool {",
          "256:     if ($revision <= 0) {",
          "257:         return false;",
          "258:     }",
          "260:     return $revision >= min_get_minimum_revision() && $revision <= min_get_maximum_revision();",
          "261: }",
          "",
          "---------------"
        ],
        "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php": [
          "File: lib/editor/tiny/lang.php -> lib/editor/tiny/lang.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:     protected function serve_file(): void {",
          "99:             if ($this->is_candidate_file_available()) {",
          "",
          "[Removed Lines]",
          "98:         if ($this->rev > 0) {",
          "",
          "[Added Lines]",
          "99:         if (min_is_revision_valid_and_current($this->rev)) {",
          "",
          "---------------"
        ],
        "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php": [
          "File: lib/editor/tiny/loader.php -> lib/editor/tiny/loader.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "115:     public function serve_file(): void {",
          "118:             if ($this->is_candidate_file_available()) {",
          "",
          "[Removed Lines]",
          "117:         if ($this->rev > 0) {",
          "",
          "[Added Lines]",
          "118:         if (min_is_revision_valid_and_current($this->rev)) {",
          "",
          "---------------"
        ],
        "lib/javascript.php||lib/javascript.php": [
          "File: lib/javascript.php -> lib/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     $file = min_optional_param('jsfile', '', 'RAW'); // 'file' would collide with URL rewriting!",
          "48: }",
          "51: $jsfiles = array();",
          "52: $files = explode(',', $file);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50: if (!min_is_revision_valid_and_current($rev)) {",
          "52:     $rev = -1;",
          "53: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80: $etag = sha1($rev.implode(',', $jsfiles));",
          "84:     $candidate = $CFG->localcachedir.'/js/'.$etag;",
          "86:     if (file_exists($candidate)) {",
          "",
          "[Removed Lines]",
          "83: if ($rev > 0 and $rev < (time() + 60*60)) {",
          "",
          "[Added Lines]",
          "87: if ($rev > 0) {",
          "",
          "---------------"
        ],
        "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php": [
          "File: lib/tests/configonlylib_test.php -> lib/tests/configonlylib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "145:         $this->assertSame('/standardcore/./5/u/f1', min_get_slash_argument());",
          "146:     }",
          "147: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152:     public function test_min_get_minimum_version(): void {",
          "155:         $firstintroduced = 1669593600; // Equivalent to 20221128 00:00:00 GMT.",
          "156:         $this->assertGreaterThanOrEqual($firstintroduced, min_get_minimum_revision());",
          "157:     }",
          "164:     public function test_min_get_maximum_version(): void {",
          "168:         $this->assertGreaterThan(time(), min_get_maximum_revision());",
          "169:         $this->assertLessThanOrEqual(time() + 65, min_get_maximum_revision());",
          "170:     }",
          "178:     public function test_min_is_revision_valid_and_current(int $revision, bool $expected): void {",
          "179:         $this->assertEquals($expected, min_is_revision_valid_and_current($revision));",
          "180:     }",
          "187:     public function min_is_revision_valid_and_current_provider(): array {",
          "188:         return [",
          "189:             'Negative value' => [-1, false],",
          "190:             'Empty value' => [0, false],",
          "191:             'A time before the minimum accepted value' => [min_get_minimum_revision() - 1, false],",
          "192:             'The minimum accepted value' => [min_get_minimum_revision(), true],",
          "193:             'The current time' => [time(), true],",
          "198:             'A time in the future' => [time() + DAYSECS, false]",
          "199:         ];",
          "200:     }",
          "210:     public function test_min_is_revision_valid_and_current_close_proximity(): void {",
          "212:         $this->assertTrue(min_is_revision_valid_and_current(time() + 55));",
          "215:         $this->assertFalse(min_is_revision_valid_and_current(time() + 70));",
          "217:     }",
          "",
          "---------------"
        ],
        "theme/font.php||theme/font.php": [
          "File: theme/font.php -> theme/font.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     $font      = min_optional_param('font', '', 'RAW');",
          "50: }",
          "52: if (!$font) {",
          "53:     font_not_found();",
          "54: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: if (!min_is_revision_valid_and_current($rev)) {",
          "54:     $rev = -1;",
          "55: }",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     $usesvg    = (bool)min_optional_param('svg', '1', 'INT');",
          "59: }",
          "61: if (empty($component) or $component === 'moodle' or $component === 'core') {",
          "62:     $component = 'core';",
          "63: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: if (!min_is_revision_valid_and_current($rev)) {",
          "63:     $rev = -1;",
          "64: }",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:     $type      = min_optional_param('type', 'head', 'RAW');",
          "51: }",
          "53: if ($type !== 'head' and $type !== 'footer') {",
          "54:     header('HTTP/1.0 404 not found');",
          "55:     die('Theme was not found, sorry.');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53: if (!min_is_revision_valid_and_current($rev)) {",
          "55:     $rev = -1;",
          "56: }",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     $themesubrev = min_clean_param($themesubrev, 'INT');",
          "67: }",
          "70: if (!in_array($type, ['all', 'all-rtl', 'editor', 'editor-rtl'])) {",
          "71:     css_send_css_not_found();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: if (!min_is_revision_valid_and_current($rev)) {",
          "73:     $rev = -1;",
          "74: }",
          "",
          "---------------"
        ],
        "theme/yui_combo.php||theme/yui_combo.php": [
          "File: theme/yui_combo.php -> theme/yui_combo.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:             continue;",
          "235:         }",
          "236:         $revision = (int)array_shift($bits);",
          "239:             $cache = false;",
          "240:         }",
          "241:         $frankenstyle = array_shift($bits);",
          "",
          "[Removed Lines]",
          "237:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "237:         if (!min_is_revision_valid_and_current($revision)) {",
          "239:             $revision = -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "281:             continue;",
          "282:         }",
          "283:         $revision = (int)array_shift($bits);",
          "286:             $cache = false;",
          "287:         }",
          "288:         $contentfile = \"$CFG->libdir/yuilib/gallery/\" . join('/', $bits);",
          "",
          "[Removed Lines]",
          "284:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "285:         if (!min_is_revision_valid_and_current($revision)) {",
          "287:             $revision = -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "61f082c4aa2048a315148d4ae6219b078c6b7540",
      "candidate_info": {
        "commit_hash": "61f082c4aa2048a315148d4ae6219b078c6b7540",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/61f082c4aa2048a315148d4ae6219b078c6b7540",
        "files": [
          "lib/configonlylib.php",
          "lib/editor/tiny/lang.php",
          "lib/editor/tiny/loader.php",
          "lib/javascript.php",
          "lib/tests/configonlylib_test.php",
          "theme/font.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php",
          "theme/yui_combo.php"
        ],
        "message": "MDL-77846 core: Make endpoint revision number checks stricter\n\nIn some places we prevented cache poisoning, in others we did not. We\nalso did not place any restriction on the minimum value for a revision.\n\nThis change introduces a new set of functions for configonly endpoints\nwhich validates the revision numbers passed in. If the revision is\neither too old, or too new, it is rejected and the file content is not\ncached. The content is still served, but caching headers are not sent,\nand any local storage caching is prevented.\n\nThe current time is used as the maximum version, with 60 seconds added\nto allow for any clock skew between cluster nodes. Previously some\nlocations used one hour, but there should never be such a large clock\nskew on a correctly configured system.\n\nCo-authored-by: Andrew Nicols <andrew@nicols.co.uk>",
        "before_after_code_files": [
          "lib/configonlylib.php||lib/configonlylib.php",
          "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
          "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
          "lib/javascript.php||lib/javascript.php",
          "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
          "theme/font.php||theme/font.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php",
          "theme/yui_combo.php||theme/yui_combo.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
            "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ],
          "candidate": [
            "lib/configonlylib.php||lib/configonlylib.php",
            "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php",
            "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php",
            "lib/javascript.php||lib/javascript.php",
            "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php",
            "theme/font.php||theme/font.php",
            "theme/image.php||theme/image.php",
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php",
            "theme/yui_combo.php||theme/yui_combo.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/configonlylib.php||lib/configonlylib.php": [
          "File: lib/configonlylib.php -> lib/configonlylib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:     }",
          "206:     return $relativepath;",
          "207: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "216: function min_get_minimum_revision(): int {",
          "217:     static $timestamp = null;",
          "219:     if ($timestamp === null) {",
          "220:         global $CFG;",
          "221:         require(\"{$CFG->dirroot}/version.php\");",
          "223:         $datestring = floor($version / 100);",
          "225:         $year = intval(substr($datestring, 0, 4));",
          "226:         $month = intval(substr($datestring, 4, 2));",
          "227:         $day = intval(substr($datestring, 6, 2));",
          "229:         $timestamp = gmmktime(0, 0, 0, $month, $day, $year);",
          "230:     }",
          "232:     return $timestamp;",
          "233: }",
          "244: function min_get_maximum_revision(): int {",
          "245:     return time() + 60;",
          "246: }",
          "254: function min_is_revision_valid_and_current(int $revision): bool {",
          "256:     if ($revision <= 0) {",
          "257:         return false;",
          "258:     }",
          "260:     return $revision >= min_get_minimum_revision() && $revision <= min_get_maximum_revision();",
          "261: }",
          "",
          "---------------"
        ],
        "lib/editor/tiny/lang.php||lib/editor/tiny/lang.php": [
          "File: lib/editor/tiny/lang.php -> lib/editor/tiny/lang.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:     protected function serve_file(): void {",
          "99:             if ($this->is_candidate_file_available()) {",
          "",
          "[Removed Lines]",
          "98:         if ($this->rev > 0) {",
          "",
          "[Added Lines]",
          "99:         if (min_is_revision_valid_and_current($this->rev)) {",
          "",
          "---------------"
        ],
        "lib/editor/tiny/loader.php||lib/editor/tiny/loader.php": [
          "File: lib/editor/tiny/loader.php -> lib/editor/tiny/loader.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "115:     public function serve_file(): void {",
          "118:             if ($this->is_candidate_file_available()) {",
          "",
          "[Removed Lines]",
          "117:         if ($this->rev > 0) {",
          "",
          "[Added Lines]",
          "118:         if (min_is_revision_valid_and_current($this->rev)) {",
          "",
          "---------------"
        ],
        "lib/javascript.php||lib/javascript.php": [
          "File: lib/javascript.php -> lib/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     $file = min_optional_param('jsfile', '', 'RAW'); // 'file' would collide with URL rewriting!",
          "48: }",
          "51: $jsfiles = array();",
          "52: $files = explode(',', $file);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50: if (!min_is_revision_valid_and_current($rev)) {",
          "52:     $rev = -1;",
          "53: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80: $etag = sha1($rev.implode(',', $jsfiles));",
          "84:     $candidate = $CFG->localcachedir.'/js/'.$etag;",
          "86:     if (file_exists($candidate)) {",
          "",
          "[Removed Lines]",
          "83: if ($rev > 0 and $rev < (time() + 60*60)) {",
          "",
          "[Added Lines]",
          "87: if ($rev > 0) {",
          "",
          "---------------"
        ],
        "lib/tests/configonlylib_test.php||lib/tests/configonlylib_test.php": [
          "File: lib/tests/configonlylib_test.php -> lib/tests/configonlylib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "145:         $this->assertSame('/standardcore/./5/u/f1', min_get_slash_argument());",
          "146:     }",
          "147: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152:     public function test_min_get_minimum_version(): void {",
          "155:         $firstintroduced = 1682294400; // Equivalent to 20230424 00:00:00 GMT.",
          "156:         $this->assertGreaterThanOrEqual($firstintroduced, min_get_minimum_revision());",
          "157:     }",
          "164:     public function test_min_get_maximum_version(): void {",
          "168:         $this->assertGreaterThan(time(), min_get_maximum_revision());",
          "169:         $this->assertLessThanOrEqual(time() + 65, min_get_maximum_revision());",
          "170:     }",
          "178:     public function test_min_is_revision_valid_and_current(int $revision, bool $expected): void {",
          "179:         $this->assertEquals($expected, min_is_revision_valid_and_current($revision));",
          "180:     }",
          "187:     public function min_is_revision_valid_and_current_provider(): array {",
          "188:         return [",
          "189:             'Negative value' => [-1, false],",
          "190:             'Empty value' => [0, false],",
          "191:             'A time before the minimum accepted value' => [min_get_minimum_revision() - 1, false],",
          "192:             'The minimum accepted value' => [min_get_minimum_revision(), true],",
          "193:             'The current time' => [time(), true],",
          "198:             'A time in the future' => [time() + DAYSECS, false]",
          "199:         ];",
          "200:     }",
          "210:     public function test_min_is_revision_valid_and_current_close_proximity(): void {",
          "212:         $this->assertTrue(min_is_revision_valid_and_current(time() + 55));",
          "215:         $this->assertFalse(min_is_revision_valid_and_current(time() + 70));",
          "217:     }",
          "",
          "---------------"
        ],
        "theme/font.php||theme/font.php": [
          "File: theme/font.php -> theme/font.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     $font      = min_optional_param('font', '', 'RAW');",
          "50: }",
          "52: if (!$font) {",
          "53:     font_not_found();",
          "54: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: if (!min_is_revision_valid_and_current($rev)) {",
          "54:     $rev = -1;",
          "55: }",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     $usesvg    = (bool)min_optional_param('svg', '1', 'INT');",
          "59: }",
          "61: if (empty($component) or $component === 'moodle' or $component === 'core') {",
          "62:     $component = 'core';",
          "63: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: if (!min_is_revision_valid_and_current($rev)) {",
          "63:     $rev = -1;",
          "64: }",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:     $type      = min_optional_param('type', 'head', 'RAW');",
          "51: }",
          "53: if ($type !== 'head' and $type !== 'footer') {",
          "54:     header('HTTP/1.0 404 not found');",
          "55:     die('Theme was not found, sorry.');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53: if (!min_is_revision_valid_and_current($rev)) {",
          "55:     $rev = -1;",
          "56: }",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     $themesubrev = min_clean_param($themesubrev, 'INT');",
          "67: }",
          "70: if (!in_array($type, ['all', 'all-rtl', 'editor', 'editor-rtl'])) {",
          "71:     css_send_css_not_found();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: if (!min_is_revision_valid_and_current($rev)) {",
          "73:     $rev = -1;",
          "74: }",
          "",
          "---------------"
        ],
        "theme/yui_combo.php||theme/yui_combo.php": [
          "File: theme/yui_combo.php -> theme/yui_combo.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "231:             continue;",
          "232:         }",
          "233:         $revision = (int)array_shift($bits);",
          "236:             $cache = false;",
          "237:         }",
          "238:         $frankenstyle = array_shift($bits);",
          "",
          "[Removed Lines]",
          "234:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "234:         if (!min_is_revision_valid_and_current($revision)) {",
          "236:             $revision = -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "278:             continue;",
          "279:         }",
          "280:         $revision = (int)array_shift($bits);",
          "283:             $cache = false;",
          "284:         }",
          "285:         $contentfile = \"$CFG->libdir/yuilib/gallery/\" . join('/', $bits);",
          "",
          "[Removed Lines]",
          "281:         if ($revision === -1) {",
          "",
          "[Added Lines]",
          "282:         if (!min_is_revision_valid_and_current($revision)) {",
          "284:             $revision = -1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}