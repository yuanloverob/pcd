{
  "cve_id": "CVE-2017-16792",
  "cve_desc": "Stored cross-site scripting (XSS) vulnerability in \"geminabox\" (Gem in a Box) before 0.13.10 allows attackers to inject arbitrary web script via the \"homepage\" value of a \".gemspec\" file, related to views/gem.erb and views/index.erb.",
  "repo": "geminabox/geminabox",
  "patch_hash": "f8429a9e364658459add170e4ebc7a5d3b4759e7",
  "patch_info": {
    "commit_hash": "f8429a9e364658459add170e4ebc7a5d3b4759e7",
    "repo": "geminabox/geminabox",
    "commit_url": "https://github.com/geminabox/geminabox/commit/f8429a9e364658459add170e4ebc7a5d3b4759e7",
    "files": [
      "lib/geminabox/server.rb",
      "views/gem.erb",
      "views/index.erb"
    ],
    "message": "Fix CVE-2017-16792 - Stored XSS\n\nReject Javascript Link",
    "before_after_code_files": [
      "lib/geminabox/server.rb||lib/geminabox/server.rb",
      "views/gem.erb||views/gem.erb",
      "views/index.erb||views/index.erb"
    ]
  },
  "patch_diff": {
    "lib/geminabox/server.rb||lib/geminabox/server.rb": [
      "File: lib/geminabox/server.rb -> lib/geminabox/server.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "307:     end",
      "309:     helpers do",
      "310:       def h(text)",
      "311:         Rack::Utils.escape_html(text)",
      "312:       end",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "310:       def href(text)",
      "311:         escaped_text = Rack::Utils.escape_html(text)",
      "312:         if escaped_text.start_with?('http://') || escaped_text.start_with?('https://')",
      "313:           escaped_text",
      "314:         else",
      "315:           '#'",
      "316:         end",
      "317:       end",
      "",
      "---------------"
    ],
    "views/gem.erb||views/gem.erb": [
      "File: views/gem.erb -> views/gem.erb",
      "--- Hunk 1 ---",
      "[Context before]",
      "27:           <%= spec.description %>",
      "28:           <br/>",
      "29:           <span class=\"author\">\u2013 <%= spec.authors.map do |author|",
      "31:           end.join(', ') %></span>",
      "32:         <% end %>",
      "33:         </p>",
      "",
      "[Removed Lines]",
      "30:             \"<a href='#{h(spec.homepage)}'>#{author}</a>\"",
      "",
      "[Added Lines]",
      "30:             \"<a href='#{href(spec.homepage)}'>#{author}</a>\"",
      "",
      "---------------"
    ],
    "views/index.erb||views/index.erb": [
      "File: views/index.erb -> views/index.erb",
      "--- Hunk 1 ---",
      "[Context before]",
      "46:               <%= spec.description %>",
      "47:               <br/>",
      "48:               <span class=\"author\">\u2013 <%= spec.authors.map do |author|",
      "50:               end.join(', ') %></span>",
      "51:             <% end %>",
      "52:           </p>",
      "",
      "[Removed Lines]",
      "49:                 \"<a href='#{h(spec.homepage)}'>#{author}</a>\"",
      "",
      "[Added Lines]",
      "49:                 \"<a href='#{href(spec.homepage)}'>#{author}</a>\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fe20879741f6c215fb69c94511ce43202f396eef",
      "candidate_info": {
        "commit_hash": "fe20879741f6c215fb69c94511ce43202f396eef",
        "repo": "geminabox/geminabox",
        "commit_url": "https://github.com/geminabox/geminabox/commit/fe20879741f6c215fb69c94511ce43202f396eef",
        "files": [
          "lib/geminabox/server.rb"
        ],
        "message": "Escape HTML with href a bit later\n\nBefore, `href(\"http://www.example/\")` would return `#`, as the escaped text starts with `http:&#x2F;&#x2F;` instead of `http://`",
        "before_after_code_files": [
          "lib/geminabox/server.rb||lib/geminabox/server.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb"
          ],
          "candidate": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/geminabox/server.rb||lib/geminabox/server.rb": [
          "File: lib/geminabox/server.rb -> lib/geminabox/server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "309:     helpers do",
          "310:       def href(text)",
          "314:         else",
          "315:           '#'",
          "316:         end",
          "",
          "[Removed Lines]",
          "311:         escaped_text = Rack::Utils.escape_html(text)",
          "312:         if escaped_text.start_with?('http://') || escaped_text.start_with?('https://')",
          "313:           escaped_text",
          "",
          "[Added Lines]",
          "311:         if text.start_with?('http://') || text.start_with?('https://')",
          "312:           Rack::Utils.escape_html(text)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ac3c946813a4e9a8aa8194ba8a88296a904e61b1",
      "candidate_info": {
        "commit_hash": "ac3c946813a4e9a8aa8194ba8a88296a904e61b1",
        "repo": "geminabox/geminabox",
        "commit_url": "https://github.com/geminabox/geminabox/commit/ac3c946813a4e9a8aa8194ba8a88296a904e61b1",
        "files": [
          "lib/geminabox/server.rb"
        ],
        "message": "Add nil check",
        "before_after_code_files": [
          "lib/geminabox/server.rb||lib/geminabox/server.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb"
          ],
          "candidate": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/geminabox/server.rb||lib/geminabox/server.rb": [
          "File: lib/geminabox/server.rb -> lib/geminabox/server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "309:     helpers do",
          "310:       def href(text)",
          "312:           Rack::Utils.escape_html(text)",
          "313:         else",
          "314:           '#'",
          "",
          "[Removed Lines]",
          "311:         if text.start_with?('http://') || text.start_with?('https://')",
          "",
          "[Added Lines]",
          "311:         if text && (text.start_with?('http://') || text.start_with?('https://'))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "99aaae196c4fc6ae0df28e186ca1e493ae658e02",
      "candidate_info": {
        "commit_hash": "99aaae196c4fc6ae0df28e186ca1e493ae658e02",
        "repo": "geminabox/geminabox",
        "commit_url": "https://github.com/geminabox/geminabox/commit/99aaae196c4fc6ae0df28e186ca1e493ae658e02",
        "files": [
          "lib/geminabox/server.rb",
          "views/gem.erb",
          "views/index.erb"
        ],
        "message": "Fix XSS & CSRF vulnerabilities - CVE-2017-14506\n\nspec.homepage and spec.email needs to be htmlescaped\n(others such as spec.authors are already escaped), and\nthe spec.homepage is used on geminabox view.",
        "before_after_code_files": [
          "lib/geminabox/server.rb||lib/geminabox/server.rb",
          "views/gem.erb||views/gem.erb",
          "views/index.erb||views/index.erb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb",
            "views/gem.erb||views/gem.erb",
            "views/index.erb||views/index.erb"
          ],
          "candidate": [
            "lib/geminabox/server.rb||lib/geminabox/server.rb",
            "views/gem.erb||views/gem.erb",
            "views/index.erb||views/index.erb"
          ]
        }
      },
      "candidate_diff": {
        "lib/geminabox/server.rb||lib/geminabox/server.rb": [
          "File: lib/geminabox/server.rb -> lib/geminabox/server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "297:     end",
          "299:     helpers do",
          "300:       def spec_for(gem_name, version, platform = default_platform)",
          "301:         filename = [gem_name, version]",
          "302:         filename.push(platform) if platform != default_platform",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "300:       def h(text)",
          "301:         Rack::Utils.escape_html(text)",
          "302:       end",
          "",
          "---------------"
        ],
        "views/gem.erb||views/gem.erb": [
          "File: views/gem.erb -> views/gem.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "27:           <%= spec.description %>",
          "28:           <br/>",
          "29:           <span class=\"author\">\u2013 <%= spec.authors.map do |author|",
          "31:           end.join(', ') %></span>",
          "32:         <% end %>",
          "33:         </p>",
          "",
          "[Removed Lines]",
          "30:             \"<a href='#{spec.homepage}'>#{author}</a>\"",
          "",
          "[Added Lines]",
          "30:             \"<a href='#{h(spec.homepage)}'>#{author}</a>\"",
          "",
          "---------------"
        ],
        "views/index.erb||views/index.erb": [
          "File: views/index.erb -> views/index.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "46:               <%= spec.description %>",
          "47:               <br/>",
          "48:               <span class=\"author\">\u2013 <%= spec.authors.map do |author|",
          "50:               end.join(', ') %></span>",
          "51:             <% end %>",
          "52:           </p>",
          "",
          "[Removed Lines]",
          "49:                 \"<a href='#{spec.homepage}'>#{author}</a>\"",
          "",
          "[Added Lines]",
          "49:                 \"<a href='#{h(spec.homepage)}'>#{author}</a>\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}