{
  "cve_id": "CVE-2021-3129",
  "cve_desc": "Ignition before 2.5.2, as used in Laravel and other products, allows unauthenticated remote attackers to execute arbitrary code because of insecure usage of file_get_contents() and file_put_contents(). This is exploitable on sites using debug mode with Laravel before 8.4.2.",
  "repo": "facade/ignition",
  "patch_hash": "11ffca14abd22db779d90b12e193f8000f6d184b",
  "patch_info": {
    "commit_hash": "11ffca14abd22db779d90b12e193f8000f6d184b",
    "repo": "facade/ignition",
    "commit_url": "https://github.com/facade/ignition/commit/11ffca14abd22db779d90b12e193f8000f6d184b",
    "files": [
      "src/Solutions/MakeViewVariableOptionalSolution.php"
    ],
    "message": "Fix MakeViewVariableOptionalSolution to disallow stream wrappers and files that do not end in .blade.php\n\nThis is already fixed in 2.5.2, See https://github.com/facade/ignition/pull/334\n\nI could not update to 2.5.2 due to some dependent package required php 7.3, currently clients site is running in php 7.2\n\nOn branch 2.4.1-branch\nChanges to be committed:\n\tmodified:   src/Solutions/MakeViewVariableOptionalSolution.php",
    "before_after_code_files": [
      "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
    ]
  },
  "patch_diff": {
    "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php": [
      "File: src/Solutions/MakeViewVariableOptionalSolution.php -> src/Solutions/MakeViewVariableOptionalSolution.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: use Facade\\IgnitionContracts\\RunnableSolution;",
      "6: use Illuminate\\Support\\Facades\\Blade;",
      "8: class MakeViewVariableOptionalSolution implements RunnableSolution",
      "9: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7: use Illuminate\\Support\\Str;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "70:         }",
      "71:     }",
      "73:     public function makeOptional(array $parameters = [])",
      "74:     {",
      "75:         $originalContents = file_get_contents($parameters['viewFile']);",
      "76:         $newContents = str_replace('$'.$parameters['variableName'], '$'.$parameters['variableName'].\" ?? ''\", $originalContents);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "74:     protected function isSafePath(string $path): bool",
      "75:     {",
      "76:         if (!Str::startsWith($path, ['/', './'])) {",
      "77:             return false;",
      "78:         }",
      "80:         if (!Str::endsWith($path, '.blade.php')) {",
      "81:             return false;",
      "82:         }",
      "84:         return true;",
      "85:     }",
      "89:         if (!$this->isSafePath($parameters['viewFile'])) {",
      "90:             return false;",
      "91:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e9738da2c3ef715e0ac6daa998b0e48b9c97ede5",
      "candidate_info": {
        "commit_hash": "e9738da2c3ef715e0ac6daa998b0e48b9c97ede5",
        "repo": "facade/ignition",
        "commit_url": "https://github.com/facade/ignition/commit/e9738da2c3ef715e0ac6daa998b0e48b9c97ede5",
        "files": [
          "src/Solutions/MakeViewVariableOptionalSolution.php"
        ],
        "message": "CVE-2021-3129 (#353)",
        "before_after_code_files": [
          "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
          ],
          "candidate": [
            "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php": [
          "File: src/Solutions/MakeViewVariableOptionalSolution.php -> src/Solutions/MakeViewVariableOptionalSolution.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Facade\\IgnitionContracts\\RunnableSolution;",
          "6: use Illuminate\\Support\\Facades\\Blade;",
          "8: class MakeViewVariableOptionalSolution implements RunnableSolution",
          "9: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: use Illuminate\\Support\\Str;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:         }",
          "72:     }",
          "74:     public function makeOptional(array $parameters = [])",
          "75:     {",
          "76:         $originalContents = file_get_contents($parameters['viewFile']);",
          "77:         $newContents = str_replace('$'.$parameters['variableName'], '$'.$parameters['variableName'].\" ?? ''\", $originalContents);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75:     protected function isSafePath(string $path): bool",
          "76:     {",
          "77:         if (!Str::startsWith($path, ['/', './'])) {",
          "78:             return false;",
          "79:         }",
          "80:         if (!Str::endsWith($path, '.blade.php')) {",
          "81:             return false;",
          "82:         }",
          "84:         return true;",
          "85:     }",
          "89:         if (!$this->isSafePath($parameters['viewFile'])) {",
          "90:             return false;",
          "91:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f2dc8ba18285a6d14b47cebcae36afe550b003e4",
      "candidate_info": {
        "commit_hash": "f2dc8ba18285a6d14b47cebcae36afe550b003e4",
        "repo": "facade/ignition",
        "commit_url": "https://github.com/facade/ignition/commit/f2dc8ba18285a6d14b47cebcae36afe550b003e4",
        "files": [
          "src/Solutions/MakeViewVariableOptionalSolution.php"
        ],
        "message": "Backport security for old PHP versions (#334)",
        "before_after_code_files": [
          "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
          ],
          "candidate": [
            "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php"
          ]
        }
      },
      "candidate_diff": {
        "src/Solutions/MakeViewVariableOptionalSolution.php||src/Solutions/MakeViewVariableOptionalSolution.php": [
          "File: src/Solutions/MakeViewVariableOptionalSolution.php -> src/Solutions/MakeViewVariableOptionalSolution.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Facade\\IgnitionContracts\\RunnableSolution;",
          "6: use Illuminate\\Support\\Facades\\Blade;",
          "8: class MakeViewVariableOptionalSolution implements RunnableSolution",
          "9: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: use Illuminate\\Support\\Str;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73:     public function makeOptional(array $parameters = [])",
          "74:     {",
          "75:         $originalContents = file_get_contents($parameters['viewFile']);",
          "76:         $newContents = str_replace('$'.$parameters['variableName'], '$'.$parameters['variableName'].\" ?? ''\", $originalContents);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76:         if (!$this->isSafePath($parameters['viewFile'])) {",
          "77:             return false;",
          "78:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "87:         return $newContents;",
          "88:     }",
          "90:     protected function generateExpectedTokens(array $originalTokens, string $variableName): array",
          "91:     {",
          "92:         $expectedTokens = [];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     protected function isSafePath(string $path): bool",
          "96:     {",
          "97:         if (!Str::startsWith($path, ['/', './'])) {",
          "98:             return false;",
          "99:         }",
          "101:         if (!Str::endsWith($path, '.blade.php')) {",
          "102:             return false;",
          "103:         }",
          "105:         return true;",
          "106:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}