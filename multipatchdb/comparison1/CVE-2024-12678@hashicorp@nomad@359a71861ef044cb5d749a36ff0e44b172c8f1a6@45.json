{
  "cve_id": "CVE-2024-12678",
  "cve_desc": "Nomad Community and Nomad Enterprise (\"Nomad\") allocations are vulnerable to privilege escalation within a namespace through unredacted workload identity tokens. This vulnerability, identified as CVE-2024-12678, is fixed in Nomad Community Edition 1.9.4 and Nomad Enterprise 1.9.4, 1.8.8, and 1.7.16.",
  "repo": "hashicorp/nomad",
  "patch_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
  "patch_info": {
    "commit_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "repo": "hashicorp/nomad",
    "commit_url": "https://github.com/hashicorp/nomad/commit/359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "files": [
      ".changelog/24683.txt",
      "command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go",
      "nomad/structs/structs.go"
    ],
    "message": "Backport of sec: fix alloc workload identity namespace permission into release/1.9.x (#24685)\n\nCo-authored-by: Deniz Onur Duzgun <59659739+dduzgun-security@users.noreply.github.com>",
    "before_after_code_files": [
      "command/agent/node_endpoint.go||command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go",
      "nomad/structs/structs.go||nomad/structs/structs.go"
    ]
  },
  "patch_diff": {
    "command/agent/node_endpoint.go||command/agent/node_endpoint.go": [
      "File: command/agent/node_endpoint.go -> command/agent/node_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "105:   out.Allocs = make([]*structs.Allocation, 0)",
      "106:  }",
      "107:  for _, alloc := range out.Allocs {",
      "108:   alloc.SetEventDisplayMessages()",
      "109:  }",
      "110:  return out.Allocs, nil",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "108:   alloc = alloc.Sanitize()",
      "",
      "---------------"
    ],
    "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go": [
      "File: nomad/alloc_endpoint.go -> nomad/alloc_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "172:    }",
      "176:    if out != nil {",
      "178:     if !aclObj.AllowClientOp() && !allowNsOp(aclObj, out.Namespace) {",
      "179:      return structs.NewErrUnknownAllocation(args.AllocID)",
      "",
      "[Removed Lines]",
      "175:    reply.Alloc = out",
      "",
      "[Added Lines]",
      "176:     out = out.Sanitize()",
      "177:     reply.Alloc = out",
      "",
      "---------------"
    ],
    "nomad/structs/structs.go||nomad/structs/structs.go": [
      "File: nomad/structs/structs.go -> nomad/structs/structs.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "11199:  return a.ID",
      "11200: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "11205: func (a *Allocation) Sanitize() *Allocation {",
      "11206:  if a == nil {",
      "11207:   return nil",
      "11208:  }",
      "11210:  if a.SignedIdentities == nil {",
      "11211:   return a",
      "11212:  }",
      "11214:  clean := a.Copy()",
      "11215:  clean.SignedIdentities = nil",
      "11216:  return clean",
      "11217: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3173cccb7f3dbbfe989a7bb8fc3cfc42f95c05d5",
      "candidate_info": {
        "commit_hash": "3173cccb7f3dbbfe989a7bb8fc3cfc42f95c05d5",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/3173cccb7f3dbbfe989a7bb8fc3cfc42f95c05d5",
        "files": [
          ".release/ci.hcl",
          "GNUmakefile",
          "client/structs/structs.generated.go",
          "nomad/structs/structs.generated.go",
          "version/version.go"
        ],
        "message": "Prepare for next release",
        "before_after_code_files": [
          ".release/ci.hcl||.release/ci.hcl",
          "client/structs/structs.generated.go||client/structs/structs.generated.go",
          "nomad/structs/structs.generated.go||nomad/structs/structs.generated.go",
          "version/version.go||version/version.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        ".release/ci.hcl||.release/ci.hcl": [
          "File: .release/ci.hcl -> .release/ci.hcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:   team = \"nomad\"",
          "9:   slack {",
          "11:   }",
          "13:   github {",
          "",
          "[Removed Lines]",
          "10:     notification_channel = \"CUYKT2A73\"",
          "",
          "[Added Lines]",
          "10:     notification_channel = \"C03B5EWFW01\"",
          "",
          "---------------"
        ],
        "client/structs/structs.generated.go||client/structs/structs.generated.go": [
          "File: client/structs/structs.generated.go -> client/structs/structs.generated.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "nomad/structs/structs.generated.go||nomad/structs/structs.generated.go": [
          "File: nomad/structs/structs.generated.go -> nomad/structs/structs.generated.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version/version.go||version/version.go": [
          "File: version/version.go -> version/version.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "19:  GitDescribe string",
          "30:  VersionMetadata = \"\"",
          "",
          "[Removed Lines]",
          "22:  Version = \"1.9.5\"",
          "27:  VersionPrerelease = \"\"",
          "",
          "[Added Lines]",
          "22:  Version = \"1.9.6\"",
          "27:  VersionPrerelease = \"dev\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "955a6dfb8059f50e9a0fa678dd6a0843ffcbf46d",
      "candidate_info": {
        "commit_hash": "955a6dfb8059f50e9a0fa678dd6a0843ffcbf46d",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/955a6dfb8059f50e9a0fa678dd6a0843ffcbf46d",
        "files": [
          "go.mod",
          "go.sum"
        ],
        "message": "backport of commit f4d2d1a306e6f86e5c0eca8059d9b9cb3826ce94 (#24745)\n\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "25:  github.com/containernetworking/cni v1.2.3",
          "26:  github.com/coreos/go-iptables v0.8.0",
          "27:  github.com/creack/pty v1.1.24",
          "29:  github.com/docker/cli v27.3.1+incompatible",
          "30:  github.com/docker/docker v27.3.1+incompatible",
          "31:  github.com/docker/go-connections v0.4.0",
          "",
          "[Removed Lines]",
          "28:  github.com/distribution/reference v0.5.0",
          "",
          "[Added Lines]",
          "28:  github.com/distribution/reference v0.6.0",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "377: github.com/digitalocean/godo v1.10.0/go.mod h1:h6faOIcZ8lWIwNQ+DN7b3CgX4Kwby5T+nbpNqkUIozU=",
          "378: github.com/dimchansky/utfbom v1.1.0 h1:FcM3g+nofKgUteL8dm/UpdRXNC9KmADgTpLKsu0TRo4=",
          "379: github.com/dimchansky/utfbom v1.1.0/go.mod h1:rO41eb7gLfo8SF1jd9F8HplJm1Fewwi4mQvIirEdv+8=",
          "382: github.com/dnaeon/go-vcr v1.0.1/go.mod h1:aBB1+wY4s93YsC3HHjMBMrwTj2R9FHDzUr9KyGc8n1E=",
          "383: github.com/dnaeon/go-vcr v1.1.0 h1:ReYa/UBrRyQdant9B4fNHGoCNKw6qh6P0fsdGmZpR7c=",
          "384: github.com/dnaeon/go-vcr v1.1.0/go.mod h1:M7tiix8f0r6mKKJ3Yq/kqU1OYf3MnfmBWVbPx/yU9ko=",
          "",
          "[Removed Lines]",
          "380: github.com/distribution/reference v0.5.0 h1:/FUIFXtfc/x2gpa5/VGfiGLuOIdYa1t65IKK2OFGvA0=",
          "381: github.com/distribution/reference v0.5.0/go.mod h1:BbU0aIcezP1/5jX/8MP0YiH4SdvB5Y4f/wlDRiLyi3E=",
          "",
          "[Added Lines]",
          "380: github.com/distribution/reference v0.6.0 h1:0IXCQ5g4/QMHHkarYzh5l+u8T3t73zM5QvfrDyIgxBk=",
          "381: github.com/distribution/reference v0.6.0/go.mod h1:BbU0aIcezP1/5jX/8MP0YiH4SdvB5Y4f/wlDRiLyi3E=",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0ff86de9a1e6a94af9010a7e5559a5bc3056f42f",
      "candidate_info": {
        "commit_hash": "0ff86de9a1e6a94af9010a7e5559a5bc3056f42f",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/0ff86de9a1e6a94af9010a7e5559a5bc3056f42f",
        "files": [
          "client/testing.go"
        ],
        "message": "test: ensure RPC only test client sets enterprise specific config (#24378)\n\nCo-authored-by: James Rasell <jrasell@users.noreply.github.com>",
        "before_after_code_files": [
          "client/testing.go||client/testing.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "client/testing.go||client/testing.go": [
          "File: client/testing.go -> client/testing.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "101:   cb(conf)",
          "102:  }",
          "105:  client.servers = servers.New(client.logger, client.shutdownCh, client)",
          "106:  client.registeredCh = make(chan struct{})",
          "107:  client.rpcServer = rpc.NewServer()",
          "",
          "[Removed Lines]",
          "104:  client := &Client{config: conf, logger: testlog.HCLogger(t), shutdownCh: make(chan struct{})}",
          "",
          "[Added Lines]",
          "104:  testLogger := testlog.HCLogger(t)",
          "106:  client := &Client{",
          "107:   config:           conf,",
          "108:   logger:           testLogger,",
          "109:   shutdownCh:       make(chan struct{}),",
          "110:   EnterpriseClient: newEnterpriseClient(testLogger),",
          "111:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "93d1d36fed0babb17736736d2d6f423c15c5aecb",
      "candidate_info": {
        "commit_hash": "93d1d36fed0babb17736736d2d6f423c15c5aecb",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/93d1d36fed0babb17736736d2d6f423c15c5aecb",
        "files": [
          ".changelog/24645.txt",
          "client/allocdir/fs_linux.go",
          "website/content/docs/concepts/filesystem.mdx"
        ],
        "message": "Backport of add noswap to secretdir tmpfs into release/1.9.x (#24782)\n\nCo-authored-by: Charles Z. <charleszaffery@gmail.com>",
        "before_after_code_files": [
          "client/allocdir/fs_linux.go||client/allocdir/fs_linux.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "client/allocdir/fs_linux.go||client/allocdir/fs_linux.go": [
          "File: client/allocdir/fs_linux.go -> client/allocdir/fs_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:   }",
          "75:   flags := uintptr(syscall.MS_NOEXEC)",
          "79:   }",
          "",
          "[Removed Lines]",
          "76:   options := fmt.Sprintf(\"size=%dm\", size)",
          "77:   if err := syscall.Mount(\"tmpfs\", dir, \"tmpfs\", flags, options); err != nil {",
          "78:    return os.NewSyscallError(\"mount\", err)",
          "",
          "[Added Lines]",
          "77:   options := fmt.Sprintf(\"size=%dm,noswap\", size)",
          "78:   err := syscall.Mount(\"tmpfs\", dir, \"tmpfs\", flags, options)",
          "79:   if err != nil {",
          "81:    options = fmt.Sprintf(\"size=%dm\", size)",
          "82:    if fallbackErr := syscall.Mount(\"tmpfs\", dir, \"tmpfs\", flags, options); fallbackErr != nil {",
          "83:     return os.NewSyscallError(\"mount\", fallbackErr)",
          "84:    }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3d06ea4b3863f39d8491119a918b0601cdaca92d",
      "candidate_info": {
        "commit_hash": "3d06ea4b3863f39d8491119a918b0601cdaca92d",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/3d06ea4b3863f39d8491119a918b0601cdaca92d",
        "files": [
          ".changelog/24973.txt",
          "ui/app/components/task-log.js",
          "ui/app/routes/allocations/allocation/task/logs.js"
        ],
        "message": "ui: Remove unrequired node read from task log streaming page (#24977)\n\nbackport of commit bfd5f3876190964ff24251ddb999ae854479b486\n\nCo-authored-by: James Rasell <jrasell@users.noreply.github.com>",
        "before_after_code_files": [
          "ui/app/components/task-log.js||ui/app/components/task-log.js",
          "ui/app/routes/allocations/allocation/task/logs.js||ui/app/routes/allocations/allocation/task/logs.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "ui/app/components/task-log.js||ui/app/components/task-log.js": [
          "File: ui/app/components/task-log.js -> ui/app/components/task-log.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: export default class TaskLog extends Component {",
          "26:   @service token;",
          "27:   @service userSettings;",
          "29:   allocation = null;",
          "30:   task = null;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28:   @service can;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:   @computed('allocation.{id,node.httpAddr}', 'useServer')",
          "52:   get logUrl() {",
          "54:     const allocation = this.get('allocation.id');",
          "56:     const url = `/v1/client/fs/logs/${allocation}`;",
          "58:   }",
          "60:   @computed('task', 'mode')",
          "",
          "[Removed Lines]",
          "53:     const address = this.get('allocation.node.httpAddr');",
          "57:     return this.useServer ? url : `//${address}${url}`;",
          "",
          "[Added Lines]",
          "53:     let address;",
          "55:     if (this.can.can('read client')) {",
          "56:       address = this.get('allocation.node.httpAddr');",
          "57:     }",
          "59:     return this.useServer ? url : address ? `//${address}${url}` : url;",
          "",
          "---------------"
        ],
        "ui/app/routes/allocations/allocation/task/logs.js||ui/app/routes/allocations/allocation/task/logs.js": [
          "File: ui/app/routes/allocations/allocation/task/logs.js -> ui/app/routes/allocations/allocation/task/logs.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: export default class LogsRoute extends Route {",
          "9:   model() {",
          "12:   }",
          "13: }",
          "",
          "[Removed Lines]",
          "10:     const task = super.model(...arguments);",
          "11:     return task && task.get('allocation.node').then(() => task);",
          "",
          "[Added Lines]",
          "10:     return super.model(...arguments);",
          "",
          "---------------"
        ]
      }
    }
  ]
}