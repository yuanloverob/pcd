{
  "cve_id": "CVE-2024-25983",
  "cve_desc": "Insufficient checks in a web service made it possible to add comments to the comments block on another user's dashboard when it was not otherwise available (e.g., on their profile page).",
  "repo": "moodle/moodle",
  "patch_hash": "4cae44dd0e9a7da47d08d9b75e0ebba0e4b422f4",
  "patch_info": {
    "commit_hash": "4cae44dd0e9a7da47d08d9b75e0ebba0e4b422f4",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/4cae44dd0e9a7da47d08d9b75e0ebba0e4b422f4",
    "files": [
      "blocks/comments/lib.php"
    ],
    "message": "MDL-78300 block: Determine if users can comment based on context",
    "before_after_code_files": [
      "blocks/comments/lib.php||blocks/comments/lib.php"
    ]
  },
  "patch_diff": {
    "blocks/comments/lib.php||blocks/comments/lib.php": [
      "File: blocks/comments/lib.php -> blocks/comments/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "61: function block_comments_comment_permissions($args) {",
      "63: }",
      "",
      "[Removed Lines]",
      "62:     return array('post'=>true, 'view'=>true);",
      "",
      "[Added Lines]",
      "62:     global $DB, $USER;",
      "64:     $canpost = $canview = true;",
      "66:     if ($args->context->contextlevel == CONTEXT_USER && $USER->id != $args->context->instanceid) {",
      "68:         $sqlparam = [",
      "69:             'blockname' => 'comments',",
      "70:             'parentcontextid' => $args->context->id,",
      "71:             'pagetypepattern' => 'user-profile',",
      "72:         ];",
      "75:         $canpost = $canview = $DB->record_exists_select(",
      "76:             'block_instances',",
      "77:             'blockname = :blockname AND parentcontextid = :parentcontextid AND pagetypepattern = :pagetypepattern',",
      "78:             $sqlparam,",
      "79:         );",
      "80:     }",
      "81:     return ['post' => $canpost, 'view' => $canview];",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5ea392de646db3396bf5f68c5618329bd1f68d58",
      "candidate_info": {
        "commit_hash": "5ea392de646db3396bf5f68c5618329bd1f68d58",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5ea392de646db3396bf5f68c5618329bd1f68d58",
        "files": [
          "blocks/comments/lib.php"
        ],
        "message": "MDL-78300 block: Determine if users can comment based on context",
        "before_after_code_files": [
          "blocks/comments/lib.php||blocks/comments/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ],
          "candidate": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "blocks/comments/lib.php||blocks/comments/lib.php": [
          "File: blocks/comments/lib.php -> blocks/comments/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: function block_comments_comment_permissions($args) {",
          "63: }",
          "",
          "[Removed Lines]",
          "62:     return array('post'=>true, 'view'=>true);",
          "",
          "[Added Lines]",
          "62:     global $DB, $USER;",
          "64:     $canpost = $canview = true;",
          "66:     if ($args->context->contextlevel == CONTEXT_USER && $USER->id != $args->context->instanceid) {",
          "68:         $sqlparam = [",
          "69:             'blockname' => 'comments',",
          "70:             'parentcontextid' => $args->context->id,",
          "71:             'pagetypepattern' => 'user-profile',",
          "72:         ];",
          "75:         $canpost = $canview = $DB->record_exists_select(",
          "76:             'block_instances',",
          "77:             'blockname = :blockname AND parentcontextid = :parentcontextid AND pagetypepattern = :pagetypepattern',",
          "78:             $sqlparam,",
          "79:         );",
          "80:     }",
          "81:     return ['post' => $canpost, 'view' => $canview];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d27862e2ca7b1d72d69b78230d1fa40455da5f18",
      "candidate_info": {
        "commit_hash": "d27862e2ca7b1d72d69b78230d1fa40455da5f18",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d27862e2ca7b1d72d69b78230d1fa40455da5f18",
        "files": [
          "blocks/comments/lib.php"
        ],
        "message": "MDL-78300 block: Determine if users can comment based on context",
        "before_after_code_files": [
          "blocks/comments/lib.php||blocks/comments/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ],
          "candidate": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "blocks/comments/lib.php||blocks/comments/lib.php": [
          "File: blocks/comments/lib.php -> blocks/comments/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: function block_comments_comment_permissions($args) {",
          "63: }",
          "",
          "[Removed Lines]",
          "62:     return array('post'=>true, 'view'=>true);",
          "",
          "[Added Lines]",
          "62:     global $DB, $USER;",
          "64:     $canpost = $canview = true;",
          "66:     if ($args->context->contextlevel == CONTEXT_USER && $USER->id != $args->context->instanceid) {",
          "68:         $sqlparam = [",
          "69:             'blockname' => 'comments',",
          "70:             'parentcontextid' => $args->context->id,",
          "71:             'pagetypepattern' => 'user-profile',",
          "72:         ];",
          "75:         $canpost = $canview = $DB->record_exists_select(",
          "76:             'block_instances',",
          "77:             'blockname = :blockname AND parentcontextid = :parentcontextid AND pagetypepattern = :pagetypepattern',",
          "78:             $sqlparam,",
          "79:         );",
          "80:     }",
          "81:     return ['post' => $canpost, 'view' => $canview];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9d97e933e8fe0b311a090a92f39fadfb1fe339e5",
      "candidate_info": {
        "commit_hash": "9d97e933e8fe0b311a090a92f39fadfb1fe339e5",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9d97e933e8fe0b311a090a92f39fadfb1fe339e5",
        "files": [
          "blocks/comments/lib.php"
        ],
        "message": "MDL-78300 block: Determine if users can comment based on context",
        "before_after_code_files": [
          "blocks/comments/lib.php||blocks/comments/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ],
          "candidate": [
            "blocks/comments/lib.php||blocks/comments/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "blocks/comments/lib.php||blocks/comments/lib.php": [
          "File: blocks/comments/lib.php -> blocks/comments/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: function block_comments_comment_permissions($args) {",
          "63: }",
          "",
          "[Removed Lines]",
          "62:     return array('post'=>true, 'view'=>true);",
          "",
          "[Added Lines]",
          "62:     global $DB, $USER;",
          "64:     $canpost = $canview = true;",
          "66:     if ($args->context->contextlevel == CONTEXT_USER && $USER->id != $args->context->instanceid) {",
          "68:         $sqlparam = [",
          "69:             'blockname' => 'comments',",
          "70:             'parentcontextid' => $args->context->id,",
          "71:             'pagetypepattern' => 'user-profile',",
          "72:         ];",
          "75:         $canpost = $canview = $DB->record_exists_select(",
          "76:             'block_instances',",
          "77:             'blockname = :blockname AND parentcontextid = :parentcontextid AND pagetypepattern = :pagetypepattern',",
          "78:             $sqlparam,",
          "79:         );",
          "80:     }",
          "81:     return ['post' => $canpost, 'view' => $canview];",
          "",
          "---------------"
        ]
      }
    }
  ]
}