{
  "cve_id": "CVE-2022-29253",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Starting with version 8.3-rc-1 and prior to versions 12.10.3 and 14.0, one can ask for any file located in the classloader using the template API and a path with \"..\" in it. The issue is patched in versions 14.0 and 13.10.3. There is no easy workaround for this issue.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "4917c8f355717bb636d763844528b1fe0f95e8e2",
  "patch_info": {
    "commit_hash": "4917c8f355717bb636d763844528b1fe0f95e8e2",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/4917c8f355717bb636d763844528b1fe0f95e8e2",
    "files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
    ],
    "message": "XWIKI-19349: Bad handling of classloader templates path resolution",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: import java.lang.reflect.Type;",
      "25: import java.net.URL;",
      "26: import java.nio.charset.StandardCharsets;",
      "27: import java.util.AbstractSet;",
      "28: import java.util.Arrays;",
      "29: import java.util.Collections;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27: import java.nio.file.Path;",
      "28: import java.nio.file.Paths;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "896:             : null;",
      "897:     }",
      "900:     {",
      "902:     }",
      "905:     {",
      "908:         URL url = classloader.getResource(templatePath);",
      "",
      "[Removed Lines]",
      "899:     private Template getClassloaderTemplate(String suffixPath, String templateName)",
      "901:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), suffixPath, templateName);",
      "904:     private Template getClassloaderTemplate(ClassLoader classloader, String suffixPath, String templateName)",
      "906:         String templatePath = suffixPath + templateName;",
      "",
      "[Added Lines]",
      "901:     private Template getClassloaderTemplate(String prefixPath, String templateName)",
      "903:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), prefixPath, templateName);",
      "906:     private Template getClassloaderTemplate(ClassLoader classloader, String prefixPath, String templateName)",
      "908:         String templatePath = prefixPath + templateName;",
      "911:         Path normalizedResource = Paths.get(templatePath).normalize();",
      "913:         if (!normalizedResource.startsWith(prefixPath)) {",
      "914:             this.logger.warn(\"Direct access to skin file [{}] refused. Possible break-in attempt!\", normalizedResource);",
      "916:             return null;",
      "917:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e92ce66267310ae402108af4882ee9668a0a75b9",
      "candidate_info": {
        "commit_hash": "e92ce66267310ae402108af4882ee9668a0a75b9",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/e92ce66267310ae402108af4882ee9668a0a75b9",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
        ],
        "message": "XWIKI-19349: Bad handling of classloader templates path resolution\n\n(cherry picked from commit 4917c8f355717bb636d763844528b1fe0f95e8e2)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: import java.lang.reflect.Type;",
          "26: import java.net.URL;",
          "27: import java.nio.charset.StandardCharsets;",
          "28: import java.util.AbstractSet;",
          "29: import java.util.ArrayList;",
          "30: import java.util.Arrays;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: import java.nio.file.Path;",
          "29: import java.nio.file.Paths;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "887:             ? new EnvironmentTemplate(new TemplateSkinResource(path, templateName, this.environment)) : null;",
          "888:     }",
          "891:     {",
          "893:     }",
          "896:     {",
          "899:         URL url = classloader.getResource(templatePath);",
          "",
          "[Removed Lines]",
          "890:     private Template getClassloaderTemplate(String suffixPath, String templateName)",
          "892:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), suffixPath, templateName);",
          "895:     private Template getClassloaderTemplate(ClassLoader classloader, String suffixPath, String templateName)",
          "897:         String templatePath = suffixPath + templateName;",
          "",
          "[Added Lines]",
          "892:     private Template getClassloaderTemplate(String prefixPath, String templateName)",
          "894:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), prefixPath, templateName);",
          "897:     private Template getClassloaderTemplate(ClassLoader classloader, String prefixPath, String templateName)",
          "899:         String templatePath = prefixPath + templateName;",
          "902:         Path normalizedResource = Paths.get(templatePath).normalize();",
          "904:         if (!normalizedResource.startsWith(prefixPath)) {",
          "905:             this.logger.warn(\"Direct access to skin file [{}] refused. Possible break-in attempt!\", normalizedResource);",
          "907:             return null;",
          "908:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cff3ce302141ec2861acb7a23c5761a214a2a3cc",
      "candidate_info": {
        "commit_hash": "cff3ce302141ec2861acb7a23c5761a214a2a3cc",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/cff3ce302141ec2861acb7a23c5761a214a2a3cc",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
        ],
        "message": "XWIKI-19349: Bad handling of classloader templates path resolution\n\n(cherry picked from commit 4917c8f355717bb636d763844528b1fe0f95e8e2)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/skin/AbstractResourceSkin.java"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/internal/template/InternalTemplateManager.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: import java.lang.reflect.Type;",
          "25: import java.net.URL;",
          "26: import java.nio.charset.StandardCharsets;",
          "27: import java.util.AbstractSet;",
          "28: import java.util.Arrays;",
          "29: import java.util.Collections;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: import java.nio.file.Path;",
          "28: import java.nio.file.Paths;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "896:             : null;",
          "897:     }",
          "900:     {",
          "902:     }",
          "905:     {",
          "908:         URL url = classloader.getResource(templatePath);",
          "",
          "[Removed Lines]",
          "899:     private Template getClassloaderTemplate(String suffixPath, String templateName)",
          "901:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), suffixPath, templateName);",
          "904:     private Template getClassloaderTemplate(ClassLoader classloader, String suffixPath, String templateName)",
          "906:         String templatePath = suffixPath + templateName;",
          "",
          "[Added Lines]",
          "901:     private Template getClassloaderTemplate(String prefixPath, String templateName)",
          "903:         return getClassloaderTemplate(Thread.currentThread().getContextClassLoader(), prefixPath, templateName);",
          "906:     private Template getClassloaderTemplate(ClassLoader classloader, String prefixPath, String templateName)",
          "908:         String templatePath = prefixPath + templateName;",
          "911:         Path normalizedResource = Paths.get(templatePath).normalize();",
          "913:         if (!normalizedResource.startsWith(prefixPath)) {",
          "914:             this.logger.warn(\"Direct access to skin file [{}] refused. Possible break-in attempt!\", normalizedResource);",
          "916:             return null;",
          "917:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}