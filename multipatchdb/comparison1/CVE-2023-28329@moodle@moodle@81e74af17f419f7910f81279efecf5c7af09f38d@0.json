{
  "cve_id": "CVE-2023-28329",
  "cve_desc": "Insufficient validation of profile field availability condition resulted in an SQL injection risk (by default only available to teachers and managers).",
  "repo": "moodle/moodle",
  "patch_hash": "81e74af17f419f7910f81279efecf5c7af09f38d",
  "patch_info": {
    "commit_hash": "81e74af17f419f7910f81279efecf5c7af09f38d",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/81e74af17f419f7910f81279efecf5c7af09f38d",
    "files": [
      "availability/condition/profile/classes/condition.php",
      "availability/condition/profile/classes/frontend.php",
      "availability/condition/profile/lang/en/availability_profile.php"
    ],
    "message": "MDL-77046 availability: validate profile field in condition.",
    "before_after_code_files": [
      "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
      "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
      "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
    ]
  },
  "patch_diff": {
    "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php": [
      "File: availability/condition/profile/classes/condition.php -> availability/condition/profile/classes/condition.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "197:                         $this->customfield);",
      "198:             }",
      "199:         } else {",
      "201:         }",
      "202:         $a = new \\stdClass();",
      "",
      "[Removed Lines]",
      "200:             $translatedfieldname = \\core_user\\fields::get_display_name($this->standardfield);",
      "",
      "[Added Lines]",
      "200:             $standardfields = self::get_standard_profile_fields();",
      "201:             if (array_key_exists($this->standardfield, $standardfields)) {",
      "202:                 $translatedfieldname = $standardfields[$this->standardfield];",
      "203:             } else {",
      "204:                 $translatedfieldname = get_string('missing', 'availability_profile', $this->standardfield);",
      "205:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "321:         return $fieldconditionmet;",
      "322:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "334:     public static function get_standard_profile_fields(): array {",
      "335:         return [",
      "336:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
      "337:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
      "338:             'email' => \\core_user\\fields::get_display_name('email'),",
      "339:             'city' => \\core_user\\fields::get_display_name('city'),",
      "340:             'country' => \\core_user\\fields::get_display_name('country'),",
      "341:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
      "342:             'institution' => \\core_user\\fields::get_display_name('institution'),",
      "343:             'department' => \\core_user\\fields::get_display_name('department'),",
      "344:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
      "345:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
      "346:             'address' => \\core_user\\fields::get_display_name('address'),",
      "347:         ];",
      "348:     }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "472:             $valuefield = 'data';",
      "473:             $default = $customfield->defaultdata;",
      "474:         } else {",
      "475:             $values = $DB->get_records_select('user', 'id ' . $sql, $params,",
      "476:                     '', 'id, '. $this->standardfield);",
      "477:             $valuefield = $this->standardfield;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "501:             $standardfields = self::get_standard_profile_fields();",
      "502:             if (!array_key_exists($this->standardfield, $standardfields)) {",
      "504:                 return [];",
      "505:             }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "595:                 $where = \"(ud.data IS NOT NULL AND $condition)\";",
      "596:             }",
      "597:         } else {",
      "598:             $tablesql = \"JOIN {user} u ON u.id = userids.id\";",
      "599:             list ($where, $mainparams) = $this->get_condition_sql(",
      "600:                     'u.' . $this->standardfield);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "629:             $standardfields = self::get_standard_profile_fields();",
      "630:             if (!array_key_exists($this->standardfield, $standardfields)) {",
      "632:                 return ['SELECT id FROM {user} WHERE 0 = 1', []];",
      "633:             }",
      "",
      "---------------"
    ],
    "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php": [
      "File: availability/condition/profile/classes/frontend.php -> availability/condition/profile/classes/frontend.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "43:     protected function get_javascript_init_params($course, \\cm_info $cm = null,",
      "44:             \\section_info $section = null) {",
      "59:         \\core_collator::asort($standardfields);",
      "",
      "[Removed Lines]",
      "46:         $standardfields = array(",
      "47:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
      "48:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
      "49:             'email' => \\core_user\\fields::get_display_name('email'),",
      "50:             'city' => \\core_user\\fields::get_display_name('city'),",
      "51:             'country' => \\core_user\\fields::get_display_name('country'),",
      "52:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
      "53:             'institution' => \\core_user\\fields::get_display_name('institution'),",
      "54:             'department' => \\core_user\\fields::get_display_name('department'),",
      "55:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
      "56:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
      "57:             'address' => \\core_user\\fields::get_display_name('address')",
      "58:         );",
      "",
      "[Added Lines]",
      "47:         $standardfields = condition::get_standard_profile_fields();",
      "",
      "---------------"
    ],
    "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php": [
      "File: availability/condition/profile/lang/en/availability_profile.php -> availability/condition/profile/lang/en/availability_profile.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39: $string['requires_notisequalto'] = 'Your <strong>{$a->field}</strong> is not <strong>{$a->value}</strong>';",
      "40: $string['requires_notstartswith'] = 'Your <strong>{$a->field}</strong> does not start with <strong>{$a->value}</strong>';",
      "41: $string['requires_startswith'] = 'Your <strong>{$a->field}</strong> starts with <strong>{$a->value}</strong>';",
      "43: $string['title'] = 'User profile';",
      "44: $string['op_contains'] = 'contains';",
      "45: $string['op_doesnotcontain'] = 'doesn\\'t contain';",
      "",
      "[Removed Lines]",
      "42: $string['missing'] = '(Missing custom field: {$a})';",
      "",
      "[Added Lines]",
      "42: $string['missing'] = '(Missing field: {$a})';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5a9cc6373333af98970ae2dec33624d56fd450bd",
      "candidate_info": {
        "commit_hash": "5a9cc6373333af98970ae2dec33624d56fd450bd",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5a9cc6373333af98970ae2dec33624d56fd450bd",
        "files": [
          "availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php"
        ],
        "message": "MDL-77046 availability: validate profile field in condition.",
        "before_after_code_files": [
          "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ],
          "candidate": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php": [
          "File: availability/condition/profile/classes/condition.php -> availability/condition/profile/classes/condition.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "197:                         $this->customfield);",
          "198:             }",
          "199:         } else {",
          "201:         }",
          "202:         $context = \\context_course::instance($course->id);",
          "203:         $a = new \\stdClass();",
          "",
          "[Removed Lines]",
          "200:             $translatedfieldname = get_user_field_name($this->standardfield);",
          "",
          "[Added Lines]",
          "200:             $standardfields = self::get_standard_profile_fields();",
          "201:             if (array_key_exists($this->standardfield, $standardfields)) {",
          "202:                 $translatedfieldname = $standardfields[$this->standardfield];",
          "203:             } else {",
          "204:                 $translatedfieldname = get_string('missing', 'availability_profile', $this->standardfield);",
          "205:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "321:         return $fieldconditionmet;",
          "322:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "334:     public static function get_standard_profile_fields(): array {",
          "335:         return [",
          "336:             'firstname' => get_user_field_name('firstname'),",
          "337:             'lastname' => get_user_field_name('lastname'),",
          "338:             'email' => get_user_field_name('email'),",
          "339:             'city' => get_user_field_name('city'),",
          "340:             'country' => get_user_field_name('country'),",
          "341:             'url' => get_user_field_name('url'),",
          "342:             'icq' => get_user_field_name('icq'),",
          "343:             'skype' => get_user_field_name('skype'),",
          "344:             'aim' => get_user_field_name('aim'),",
          "345:             'yahoo' => get_user_field_name('yahoo'),",
          "346:             'msn' => get_user_field_name('msn'),",
          "347:             'idnumber' => get_user_field_name('idnumber'),",
          "348:             'institution' => get_user_field_name('institution'),",
          "349:             'department' => get_user_field_name('department'),",
          "350:             'phone1' => get_user_field_name('phone1'),",
          "351:             'phone2' => get_user_field_name('phone2'),",
          "352:             'address' => get_user_field_name('address')",
          "353:         ];",
          "354:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "472:             $valuefield = 'data';",
          "473:             $default = $customfield->defaultdata;",
          "474:         } else {",
          "475:             $values = $DB->get_records_select('user', 'id ' . $sql, $params,",
          "476:                     '', 'id, '. $this->standardfield);",
          "477:             $valuefield = $this->standardfield;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "507:             $standardfields = self::get_standard_profile_fields();",
          "508:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "510:                 return [];",
          "511:             }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "595:                 $where = \"(ud.data IS NOT NULL AND $condition)\";",
          "596:             }",
          "597:         } else {",
          "598:             $tablesql = \"JOIN {user} u ON u.id = userids.id\";",
          "599:             list ($where, $mainparams) = $this->get_condition_sql(",
          "600:                     'u.' . $this->standardfield);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "635:             $standardfields = self::get_standard_profile_fields();",
          "636:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "638:                 return ['SELECT id FROM {user} WHERE 0 = 1', []];",
          "639:             }",
          "",
          "---------------"
        ],
        "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php": [
          "File: availability/condition/profile/classes/frontend.php -> availability/condition/profile/classes/frontend.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     protected function get_javascript_init_params($course, \\cm_info $cm = null,",
          "44:             \\section_info $section = null) {",
          "65:         \\core_collator::asort($standardfields);",
          "",
          "[Removed Lines]",
          "46:         $standardfields = array(",
          "47:             'firstname' => get_user_field_name('firstname'),",
          "48:             'lastname' => get_user_field_name('lastname'),",
          "49:             'email' => get_user_field_name('email'),",
          "50:             'city' => get_user_field_name('city'),",
          "51:             'country' => get_user_field_name('country'),",
          "52:             'url' => get_user_field_name('url'),",
          "53:             'icq' => get_user_field_name('icq'),",
          "54:             'skype' => get_user_field_name('skype'),",
          "55:             'aim' => get_user_field_name('aim'),",
          "56:             'yahoo' => get_user_field_name('yahoo'),",
          "57:             'msn' => get_user_field_name('msn'),",
          "58:             'idnumber' => get_user_field_name('idnumber'),",
          "59:             'institution' => get_user_field_name('institution'),",
          "60:             'department' => get_user_field_name('department'),",
          "61:             'phone1' => get_user_field_name('phone1'),",
          "62:             'phone2' => get_user_field_name('phone2'),",
          "63:             'address' => get_user_field_name('address')",
          "64:         );",
          "",
          "[Added Lines]",
          "47:         $standardfields = condition::get_standard_profile_fields();",
          "",
          "---------------"
        ],
        "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php": [
          "File: availability/condition/profile/lang/en/availability_profile.php -> availability/condition/profile/lang/en/availability_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: $string['requires_notisequalto'] = 'Your <strong>{$a->field}</strong> is not <strong>{$a->value}</strong>';",
          "40: $string['requires_notstartswith'] = 'Your <strong>{$a->field}</strong> does not start with <strong>{$a->value}</strong>';",
          "41: $string['requires_startswith'] = 'Your <strong>{$a->field}</strong> starts with <strong>{$a->value}</strong>';",
          "43: $string['title'] = 'User profile';",
          "44: $string['op_contains'] = 'contains';",
          "45: $string['op_doesnotcontain'] = 'doesn\\'t contain';",
          "",
          "[Removed Lines]",
          "42: $string['missing'] = '(Missing custom field: {$a})';",
          "",
          "[Added Lines]",
          "42: $string['missing'] = '(Missing field: {$a})';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "724c4fa373fe66788c864f02eab269629ff83eef",
      "candidate_info": {
        "commit_hash": "724c4fa373fe66788c864f02eab269629ff83eef",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/724c4fa373fe66788c864f02eab269629ff83eef",
        "files": [
          "availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php"
        ],
        "message": "MDL-77046 availability: validate profile field in condition.",
        "before_after_code_files": [
          "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ],
          "candidate": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php": [
          "File: availability/condition/profile/classes/condition.php -> availability/condition/profile/classes/condition.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "197:                         $this->customfield);",
          "198:             }",
          "199:         } else {",
          "201:         }",
          "202:         $a = new \\stdClass();",
          "",
          "[Removed Lines]",
          "200:             $translatedfieldname = \\core_user\\fields::get_display_name($this->standardfield);",
          "",
          "[Added Lines]",
          "200:             $standardfields = self::get_standard_profile_fields();",
          "201:             if (array_key_exists($this->standardfield, $standardfields)) {",
          "202:                 $translatedfieldname = $standardfields[$this->standardfield];",
          "203:             } else {",
          "204:                 $translatedfieldname = get_string('missing', 'availability_profile', $this->standardfield);",
          "205:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "321:         return $fieldconditionmet;",
          "322:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "334:     public static function get_standard_profile_fields(): array {",
          "335:         return [",
          "336:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "337:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "338:             'email' => \\core_user\\fields::get_display_name('email'),",
          "339:             'city' => \\core_user\\fields::get_display_name('city'),",
          "340:             'country' => \\core_user\\fields::get_display_name('country'),",
          "341:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "342:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "343:             'department' => \\core_user\\fields::get_display_name('department'),",
          "344:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "345:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "346:             'address' => \\core_user\\fields::get_display_name('address'),",
          "347:         ];",
          "348:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "472:             $valuefield = 'data';",
          "473:             $default = $customfield->defaultdata;",
          "474:         } else {",
          "475:             $values = $DB->get_records_select('user', 'id ' . $sql, $params,",
          "476:                     '', 'id, '. $this->standardfield);",
          "477:             $valuefield = $this->standardfield;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "501:             $standardfields = self::get_standard_profile_fields();",
          "502:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "504:                 return [];",
          "505:             }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "595:                 $where = \"(ud.data IS NOT NULL AND $condition)\";",
          "596:             }",
          "597:         } else {",
          "598:             $tablesql = \"JOIN {user} u ON u.id = userids.id\";",
          "599:             list ($where, $mainparams) = $this->get_condition_sql(",
          "600:                     'u.' . $this->standardfield);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "629:             $standardfields = self::get_standard_profile_fields();",
          "630:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "632:                 return ['SELECT id FROM {user} WHERE 0 = 1', []];",
          "633:             }",
          "",
          "---------------"
        ],
        "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php": [
          "File: availability/condition/profile/classes/frontend.php -> availability/condition/profile/classes/frontend.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     protected function get_javascript_init_params($course, \\cm_info $cm = null,",
          "44:             \\section_info $section = null) {",
          "59:         \\core_collator::asort($standardfields);",
          "",
          "[Removed Lines]",
          "46:         $standardfields = array(",
          "47:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "48:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "49:             'email' => \\core_user\\fields::get_display_name('email'),",
          "50:             'city' => \\core_user\\fields::get_display_name('city'),",
          "51:             'country' => \\core_user\\fields::get_display_name('country'),",
          "52:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "53:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "54:             'department' => \\core_user\\fields::get_display_name('department'),",
          "55:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "56:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "57:             'address' => \\core_user\\fields::get_display_name('address')",
          "58:         );",
          "",
          "[Added Lines]",
          "47:         $standardfields = condition::get_standard_profile_fields();",
          "",
          "---------------"
        ],
        "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php": [
          "File: availability/condition/profile/lang/en/availability_profile.php -> availability/condition/profile/lang/en/availability_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: $string['requires_notisequalto'] = 'Your <strong>{$a->field}</strong> is not <strong>{$a->value}</strong>';",
          "40: $string['requires_notstartswith'] = 'Your <strong>{$a->field}</strong> does not start with <strong>{$a->value}</strong>';",
          "41: $string['requires_startswith'] = 'Your <strong>{$a->field}</strong> starts with <strong>{$a->value}</strong>';",
          "43: $string['title'] = 'User profile';",
          "44: $string['op_contains'] = 'contains';",
          "45: $string['op_doesnotcontain'] = 'doesn\\'t contain';",
          "",
          "[Removed Lines]",
          "42: $string['missing'] = '(Missing custom field: {$a})';",
          "",
          "[Added Lines]",
          "42: $string['missing'] = '(Missing field: {$a})';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "90c5358680b20be249b2897c801a135c4b4a56d0",
      "candidate_info": {
        "commit_hash": "90c5358680b20be249b2897c801a135c4b4a56d0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/90c5358680b20be249b2897c801a135c4b4a56d0",
        "files": [
          "availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php"
        ],
        "message": "MDL-77046 availability: validate profile field in condition.",
        "before_after_code_files": [
          "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ],
          "candidate": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php": [
          "File: availability/condition/profile/classes/condition.php -> availability/condition/profile/classes/condition.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "197:                         $this->customfield);",
          "198:             }",
          "199:         } else {",
          "201:         }",
          "202:         $a = new \\stdClass();",
          "",
          "[Removed Lines]",
          "200:             $translatedfieldname = \\core_user\\fields::get_display_name($this->standardfield);",
          "",
          "[Added Lines]",
          "200:             $standardfields = self::get_standard_profile_fields();",
          "201:             if (array_key_exists($this->standardfield, $standardfields)) {",
          "202:                 $translatedfieldname = $standardfields[$this->standardfield];",
          "203:             } else {",
          "204:                 $translatedfieldname = get_string('missing', 'availability_profile', $this->standardfield);",
          "205:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "321:         return $fieldconditionmet;",
          "322:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "334:     public static function get_standard_profile_fields(): array {",
          "335:         return [",
          "336:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "337:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "338:             'email' => \\core_user\\fields::get_display_name('email'),",
          "339:             'city' => \\core_user\\fields::get_display_name('city'),",
          "340:             'country' => \\core_user\\fields::get_display_name('country'),",
          "341:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "342:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "343:             'department' => \\core_user\\fields::get_display_name('department'),",
          "344:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "345:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "346:             'address' => \\core_user\\fields::get_display_name('address'),",
          "347:         ];",
          "348:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "472:             $valuefield = 'data';",
          "473:             $default = $customfield->defaultdata;",
          "474:         } else {",
          "475:             $values = $DB->get_records_select('user', 'id ' . $sql, $params,",
          "476:                     '', 'id, '. $this->standardfield);",
          "477:             $valuefield = $this->standardfield;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "501:             $standardfields = self::get_standard_profile_fields();",
          "502:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "504:                 return [];",
          "505:             }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "595:                 $where = \"(ud.data IS NOT NULL AND $condition)\";",
          "596:             }",
          "597:         } else {",
          "598:             $tablesql = \"JOIN {user} u ON u.id = userids.id\";",
          "599:             list ($where, $mainparams) = $this->get_condition_sql(",
          "600:                     'u.' . $this->standardfield);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "629:             $standardfields = self::get_standard_profile_fields();",
          "630:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "632:                 return ['SELECT id FROM {user} WHERE 0 = 1', []];",
          "633:             }",
          "",
          "---------------"
        ],
        "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php": [
          "File: availability/condition/profile/classes/frontend.php -> availability/condition/profile/classes/frontend.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     protected function get_javascript_init_params($course, \\cm_info $cm = null,",
          "44:             \\section_info $section = null) {",
          "59:         \\core_collator::asort($standardfields);",
          "",
          "[Removed Lines]",
          "46:         $standardfields = array(",
          "47:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "48:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "49:             'email' => \\core_user\\fields::get_display_name('email'),",
          "50:             'city' => \\core_user\\fields::get_display_name('city'),",
          "51:             'country' => \\core_user\\fields::get_display_name('country'),",
          "52:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "53:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "54:             'department' => \\core_user\\fields::get_display_name('department'),",
          "55:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "56:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "57:             'address' => \\core_user\\fields::get_display_name('address')",
          "58:         );",
          "",
          "[Added Lines]",
          "47:         $standardfields = condition::get_standard_profile_fields();",
          "",
          "---------------"
        ],
        "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php": [
          "File: availability/condition/profile/lang/en/availability_profile.php -> availability/condition/profile/lang/en/availability_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: $string['requires_notisequalto'] = 'Your <strong>{$a->field}</strong> is not <strong>{$a->value}</strong>';",
          "40: $string['requires_notstartswith'] = 'Your <strong>{$a->field}</strong> does not start with <strong>{$a->value}</strong>';",
          "41: $string['requires_startswith'] = 'Your <strong>{$a->field}</strong> starts with <strong>{$a->value}</strong>';",
          "43: $string['title'] = 'User profile';",
          "44: $string['op_contains'] = 'contains';",
          "45: $string['op_doesnotcontain'] = 'doesn\\'t contain';",
          "",
          "[Removed Lines]",
          "42: $string['missing'] = '(Missing custom field: {$a})';",
          "",
          "[Added Lines]",
          "42: $string['missing'] = '(Missing field: {$a})';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fac46a19f78a36c38fffbfb26016f07e818b05c4",
      "candidate_info": {
        "commit_hash": "fac46a19f78a36c38fffbfb26016f07e818b05c4",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/fac46a19f78a36c38fffbfb26016f07e818b05c4",
        "files": [
          "availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php"
        ],
        "message": "MDL-77046 availability: validate profile field in condition.",
        "before_after_code_files": [
          "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
          "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
          "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ],
          "candidate": [
            "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php",
            "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php",
            "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "availability/condition/profile/classes/condition.php||availability/condition/profile/classes/condition.php": [
          "File: availability/condition/profile/classes/condition.php -> availability/condition/profile/classes/condition.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "197:                         $this->customfield);",
          "198:             }",
          "199:         } else {",
          "201:         }",
          "202:         $a = new \\stdClass();",
          "",
          "[Removed Lines]",
          "200:             $translatedfieldname = \\core_user\\fields::get_display_name($this->standardfield);",
          "",
          "[Added Lines]",
          "200:             $standardfields = self::get_standard_profile_fields();",
          "201:             if (array_key_exists($this->standardfield, $standardfields)) {",
          "202:                 $translatedfieldname = $standardfields[$this->standardfield];",
          "203:             } else {",
          "204:                 $translatedfieldname = get_string('missing', 'availability_profile', $this->standardfield);",
          "205:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "321:         return $fieldconditionmet;",
          "322:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "334:     public static function get_standard_profile_fields(): array {",
          "335:         return [",
          "336:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "337:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "338:             'email' => \\core_user\\fields::get_display_name('email'),",
          "339:             'city' => \\core_user\\fields::get_display_name('city'),",
          "340:             'country' => \\core_user\\fields::get_display_name('country'),",
          "341:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "342:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "343:             'department' => \\core_user\\fields::get_display_name('department'),",
          "344:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "345:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "346:             'address' => \\core_user\\fields::get_display_name('address'),",
          "347:         ];",
          "348:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "472:             $valuefield = 'data';",
          "473:             $default = $customfield->defaultdata;",
          "474:         } else {",
          "475:             $values = $DB->get_records_select('user', 'id ' . $sql, $params,",
          "476:                     '', 'id, '. $this->standardfield);",
          "477:             $valuefield = $this->standardfield;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "501:             $standardfields = self::get_standard_profile_fields();",
          "502:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "504:                 return [];",
          "505:             }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "595:                 $where = \"(ud.data IS NOT NULL AND $condition)\";",
          "596:             }",
          "597:         } else {",
          "598:             $tablesql = \"JOIN {user} u ON u.id = userids.id\";",
          "599:             list ($where, $mainparams) = $this->get_condition_sql(",
          "600:                     'u.' . $this->standardfield);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "629:             $standardfields = self::get_standard_profile_fields();",
          "630:             if (!array_key_exists($this->standardfield, $standardfields)) {",
          "632:                 return ['SELECT id FROM {user} WHERE 0 = 1', []];",
          "633:             }",
          "",
          "---------------"
        ],
        "availability/condition/profile/classes/frontend.php||availability/condition/profile/classes/frontend.php": [
          "File: availability/condition/profile/classes/frontend.php -> availability/condition/profile/classes/frontend.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     protected function get_javascript_init_params($course, \\cm_info $cm = null,",
          "44:             \\section_info $section = null) {",
          "59:         \\core_collator::asort($standardfields);",
          "",
          "[Removed Lines]",
          "46:         $standardfields = array(",
          "47:             'firstname' => \\core_user\\fields::get_display_name('firstname'),",
          "48:             'lastname' => \\core_user\\fields::get_display_name('lastname'),",
          "49:             'email' => \\core_user\\fields::get_display_name('email'),",
          "50:             'city' => \\core_user\\fields::get_display_name('city'),",
          "51:             'country' => \\core_user\\fields::get_display_name('country'),",
          "52:             'idnumber' => \\core_user\\fields::get_display_name('idnumber'),",
          "53:             'institution' => \\core_user\\fields::get_display_name('institution'),",
          "54:             'department' => \\core_user\\fields::get_display_name('department'),",
          "55:             'phone1' => \\core_user\\fields::get_display_name('phone1'),",
          "56:             'phone2' => \\core_user\\fields::get_display_name('phone2'),",
          "57:             'address' => \\core_user\\fields::get_display_name('address')",
          "58:         );",
          "",
          "[Added Lines]",
          "47:         $standardfields = condition::get_standard_profile_fields();",
          "",
          "---------------"
        ],
        "availability/condition/profile/lang/en/availability_profile.php||availability/condition/profile/lang/en/availability_profile.php": [
          "File: availability/condition/profile/lang/en/availability_profile.php -> availability/condition/profile/lang/en/availability_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: $string['requires_notisequalto'] = 'Your <strong>{$a->field}</strong> is not <strong>{$a->value}</strong>';",
          "40: $string['requires_notstartswith'] = 'Your <strong>{$a->field}</strong> does not start with <strong>{$a->value}</strong>';",
          "41: $string['requires_startswith'] = 'Your <strong>{$a->field}</strong> starts with <strong>{$a->value}</strong>';",
          "43: $string['title'] = 'User profile';",
          "44: $string['op_contains'] = 'contains';",
          "45: $string['op_doesnotcontain'] = 'doesn\\'t contain';",
          "",
          "[Removed Lines]",
          "42: $string['missing'] = '(Missing custom field: {$a})';",
          "",
          "[Added Lines]",
          "42: $string['missing'] = '(Missing field: {$a})';",
          "",
          "---------------"
        ]
      }
    }
  ]
}