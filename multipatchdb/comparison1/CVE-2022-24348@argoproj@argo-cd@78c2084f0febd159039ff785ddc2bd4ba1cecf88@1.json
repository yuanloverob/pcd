{
  "cve_id": "CVE-2022-24348",
  "cve_desc": "Argo CD before 2.1.9 and 2.2.x before 2.2.4 allows directory traversal related to Helm charts because of an error in helmTemplate in repository.go. For example, an attacker may be able to discover credentials stored in a YAML file.",
  "repo": "argoproj/argo-cd",
  "patch_hash": "78c2084f0febd159039ff785ddc2bd4ba1cecf88",
  "patch_info": {
    "commit_hash": "78c2084f0febd159039ff785ddc2bd4ba1cecf88",
    "repo": "argoproj/argo-cd",
    "commit_url": "https://github.com/argoproj/argo-cd/commit/78c2084f0febd159039ff785ddc2bd4ba1cecf88",
    "files": [
      "reposerver/repository/repository.go",
      "reposerver/repository/repository_test.go",
      "reposerver/repository/testdata/symlinks/bam",
      "reposerver/repository/testdata/symlinks/bar",
      "reposerver/repository/testdata/symlinks/baz",
      "reposerver/repository/testdata/symlinks/foo"
    ],
    "message": "Merge pull request from GHSA-63qx-x74g-jcr7\n\nSigned-off-by: jannfis <jann@mistrust.net>",
    "before_after_code_files": [
      "reposerver/repository/repository.go||reposerver/repository/repository.go",
      "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
    ]
  },
  "patch_diff": {
    "reposerver/repository/repository.go||reposerver/repository/repository.go": [
      "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "52:  \"github.com/argoproj/argo-cd/v2/util/io\"",
      "53:  \"github.com/argoproj/argo-cd/v2/util/ksonnet\"",
      "54:  \"github.com/argoproj/argo-cd/v2/util/kustomize\"",
      "56:  \"github.com/argoproj/argo-cd/v2/util/text\"",
      "57: )",
      "",
      "[Removed Lines]",
      "55:  \"github.com/argoproj/argo-cd/v2/util/security\"",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "66:  ociPrefix                      = \"oci://\"",
      "67: )",
      "70: type Service struct {",
      "71:  repoLock                  *repositoryLock",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "69: var allowedHelmRemoteProtocols = []string{\"http\", \"https\"}",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "554:  return ioutil.WriteFile(markerFile, []byte(\"marker\"), 0644)",
      "555: }",
      "557: func helmTemplate(appPath string, repoRoot string, env *v1alpha1.Env, q *apiclient.ManifestRequest, isLocal bool) ([]*unstructured.Unstructured, error) {",
      "558:  concurrencyAllowed := isConcurrencyAllowed(appPath)",
      "559:  if !concurrencyAllowed {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "562: func resolveSymbolicLinkRecursive(path string, maxDepth int) (string, error) {",
      "563:  resolved, err := os.Readlink(path)",
      "564:  if err != nil {",
      "566:   _, ok := err.(*os.PathError)",
      "567:   if ok {",
      "568:    return path, nil",
      "569:   }",
      "571:   return \"\", err",
      "572:  }",
      "574:  if maxDepth == 0 {",
      "575:   return \"\", fmt.Errorf(\"maximum nesting level reached\")",
      "576:  }",
      "578:  return resolveSymbolicLinkRecursive(resolved, maxDepth-1)",
      "579: }",
      "583: func isURLSchemeAllowed(scheme string, allowed []string) bool {",
      "584:  isAllowed := false",
      "585:  if len(allowed) > 0 {",
      "586:   for _, s := range allowed {",
      "587:    if strings.EqualFold(scheme, s) {",
      "588:     isAllowed = true",
      "589:     break",
      "590:    }",
      "591:   }",
      "592:  }",
      "595:  return isAllowed && scheme != \"\"",
      "596: }",
      "627: func resolveHelmValueFilePath(appPath, repoRoot, valueFile string, allowedURLSchemes []string) (resolvedPath string, isRemote bool, err error) {",
      "632:  resolveFailure := func(path string, err error) error {",
      "633:   log.Errorf(\"failed to resolve path '%s': %v\", path, err)",
      "634:   return fmt.Errorf(\"internal error: failed to resolve path. Check logs for more details\")",
      "635:  }",
      "639:  url, err := url.Parse(valueFile)",
      "640:  if err == nil {",
      "642:   if url.Scheme != \"\" {",
      "643:    if isURLSchemeAllowed(url.Scheme, allowedURLSchemes) {",
      "644:     return valueFile, true, nil",
      "645:    } else {",
      "646:     return \"\", false, fmt.Errorf(\"the URL scheme '%s' is not allowed\", url.Scheme)",
      "647:    }",
      "648:   }",
      "649:  }",
      "652:  absRepoPath, err := filepath.Abs(repoRoot)",
      "653:  if err != nil {",
      "654:   return \"\", false, resolveFailure(repoRoot, err)",
      "655:  }",
      "659:  path := valueFile",
      "660:  if !filepath.IsAbs(path) {",
      "661:   absWorkDir, err := filepath.Abs(appPath)",
      "662:   if err != nil {",
      "663:    return \"\", false, resolveFailure(repoRoot, err)",
      "664:   }",
      "665:   path = filepath.Join(absWorkDir, path)",
      "666:  } else {",
      "667:   path = filepath.Join(absRepoPath, path)",
      "668:  }",
      "671:  delinkedPath, err := resolveSymbolicLinkRecursive(path, 10)",
      "672:  if err != nil {",
      "673:   return \"\", false, resolveFailure(path, err)",
      "674:  }",
      "675:  path = delinkedPath",
      "678:  path, err = filepath.Abs(path)",
      "679:  if err != nil {",
      "680:   return \"\", false, resolveFailure(path, err)",
      "681:  }",
      "685:  requiredRootPath := absRepoPath",
      "686:  if !strings.HasSuffix(requiredRootPath, \"/\") {",
      "687:   requiredRootPath += \"/\"",
      "688:  }",
      "691:  if !strings.HasPrefix(path, requiredRootPath) {",
      "692:   return \"\", false, fmt.Errorf(\"value file '%s' resolved to outside repository root\", valueFile)",
      "693:  }",
      "695:  return path, false, nil",
      "697: }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "583:   }",
      "585:   for _, val := range appHelm.ValueFiles {",
      "611:     _, err = os.Stat(path)",
      "612:     if os.IsNotExist(err) {",
      "613:      if appHelm.IgnoreMissingValueFiles {",
      "",
      "[Removed Lines]",
      "588:    if _, err := url.ParseRequestURI(val); err != nil {",
      "591:     absRepoPath, err := filepath.Abs(repoRoot)",
      "592:     if err != nil {",
      "593:      return nil, err",
      "594:     }",
      "597:     path := val",
      "598:     if !filepath.IsAbs(path) {",
      "599:      absWorkDir, err := filepath.Abs(appPath)",
      "600:      if err != nil {",
      "601:       return nil, err",
      "602:      }",
      "603:      path = filepath.Join(absWorkDir, path)",
      "604:     }",
      "606:     _, err = security.EnforceToCurrentRoot(absRepoPath, path)",
      "607:     if err != nil {",
      "608:      return nil, err",
      "609:     }",
      "",
      "[Added Lines]",
      "730:    path, isRemote, err := resolveHelmValueFilePath(appPath, repoRoot, val, allowedHelmRemoteProtocols)",
      "731:    if err != nil {",
      "732:     return nil, err",
      "733:    }",
      "735:    if !isRemote {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "616:      }",
      "617:     }",
      "618:    }",
      "620:   }",
      "622:   if appHelm.Values != \"\" {",
      "",
      "[Removed Lines]",
      "619:    templateOpts.Values = append(templateOpts.Values, val)",
      "",
      "[Added Lines]",
      "745:    templateOpts.Values = append(templateOpts.Values, path)",
      "",
      "---------------"
    ],
    "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
      "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "754:  }",
      "755:  request := &apiclient.ManifestRequest{Repo: &argoappv1.Repository{}, ApplicationSource: source, NoCache: true}",
      "756:  _, err := service.GenerateManifest(context.Background(), request)",
      "758: }",
      "760: func TestGenerateHelmWithURL(t *testing.T) {",
      "",
      "[Removed Lines]",
      "757:  assert.Error(t, err, \"should be on or under current directory\")",
      "",
      "[Added Lines]",
      "757:  assert.Error(t, err)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "779: func TestGenerateHelmWithValuesDirectoryTraversalOutsideRepo(t *testing.T) {",
      "789:    },",
      "791:  })",
      "803:    },",
      "805:  })",
      "807: }",
      "",
      "[Removed Lines]",
      "780:  service := newService(\"../..\")",
      "781:  _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "782:   Repo:    &argoappv1.Repository{},",
      "783:   AppName: \"test\",",
      "784:   ApplicationSource: &argoappv1.ApplicationSource{",
      "785:    Path: \"./util/helm/testdata/redis\",",
      "786:    Helm: &argoappv1.ApplicationSourceHelm{",
      "787:     ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
      "788:     Values:     `cluster: {slaveCount: 2}`,",
      "790:   },",
      "792:  assert.Error(t, err, \"should be on or under current directory\")",
      "794:  service = newService(\"./testdata/my-chart\")",
      "795:  _, err = service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "796:   Repo:    &argoappv1.Repository{},",
      "797:   AppName: \"test\",",
      "798:   ApplicationSource: &argoappv1.ApplicationSource{",
      "799:    Path: \".\",",
      "800:    Helm: &argoappv1.ApplicationSourceHelm{",
      "801:     ValueFiles: []string{\"../my-chart-2/values.yaml\"},",
      "802:     Values:     `cluster: {slaveCount: 2}`,",
      "804:   },",
      "806:  assert.Error(t, err, \"should be on or under current directory\")",
      "",
      "[Added Lines]",
      "780:  t.Run(\"Values file with relative path pointing outside repo root\", func(t *testing.T) {",
      "781:   service := newService(\"../..\")",
      "782:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "783:    Repo:    &argoappv1.Repository{},",
      "784:    AppName: \"test\",",
      "785:    ApplicationSource: &argoappv1.ApplicationSource{",
      "786:     Path: \"./util/helm/testdata/redis\",",
      "787:     Helm: &argoappv1.ApplicationSourceHelm{",
      "788:      ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
      "789:      Values:     `cluster: {slaveCount: 2}`,",
      "790:     },",
      "792:   })",
      "793:   assert.Error(t, err)",
      "794:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "797:  t.Run(\"Values file with relative path pointing inside repo root\", func(t *testing.T) {",
      "798:   service := newService(\"./testdata/my-chart\")",
      "799:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "800:    Repo:    &argoappv1.Repository{},",
      "801:    AppName: \"test\",",
      "802:    ApplicationSource: &argoappv1.ApplicationSource{",
      "803:     Path: \".\",",
      "804:     Helm: &argoappv1.ApplicationSourceHelm{",
      "805:      ValueFiles: []string{\"../my-chart/my-chart-values.yaml\"},",
      "806:      Values:     `cluster: {slaveCount: 2}`,",
      "807:     },",
      "809:   })",
      "810:   assert.NoError(t, err)",
      "811:  })",
      "813:  t.Run(\"Values file with absolute path stays within repo root\", func(t *testing.T) {",
      "814:   service := newService(\"./testdata/my-chart\")",
      "815:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "816:    Repo:    &argoappv1.Repository{},",
      "817:    AppName: \"test\",",
      "818:    ApplicationSource: &argoappv1.ApplicationSource{",
      "819:     Path: \".\",",
      "820:     Helm: &argoappv1.ApplicationSourceHelm{",
      "821:      ValueFiles: []string{\"/my-chart-values.yaml\"},",
      "822:      Values:     `cluster: {slaveCount: 2}`,",
      "823:     },",
      "824:    },",
      "825:   })",
      "826:   assert.NoError(t, err)",
      "827:  })",
      "829:  t.Run(\"Values file with absolute path using back-references outside repo root\", func(t *testing.T) {",
      "830:   service := newService(\"./testdata/my-chart\")",
      "831:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "832:    Repo:    &argoappv1.Repository{},",
      "833:    AppName: \"test\",",
      "834:    ApplicationSource: &argoappv1.ApplicationSource{",
      "835:     Path: \".\",",
      "836:     Helm: &argoappv1.ApplicationSourceHelm{",
      "837:      ValueFiles: []string{\"/../../../my-chart-values.yaml\"},",
      "838:      Values:     `cluster: {slaveCount: 2}`,",
      "839:     },",
      "840:    },",
      "841:   })",
      "842:   assert.Error(t, err)",
      "843:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "844:  })",
      "846:  t.Run(\"Remote values file from forbidden protocol\", func(t *testing.T) {",
      "847:   service := newService(\"./testdata/my-chart\")",
      "848:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
      "849:    Repo:    &argoappv1.Repository{},",
      "850:    AppName: \"test\",",
      "851:    ApplicationSource: &argoappv1.ApplicationSource{",
      "852:     Path: \".\",",
      "853:     Helm: &argoappv1.ApplicationSourceHelm{",
      "854:      ValueFiles: []string{\"file://../../../../my-chart-values.yaml\"},",
      "855:      Values:     `cluster: {slaveCount: 2}`,",
      "856:     },",
      "857:    },",
      "858:   })",
      "859:   assert.Error(t, err)",
      "860:   assert.Contains(t, err.Error(), \"is not allowed\")",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1631:  assert.Equal(t, expectedResolveRevisionResponse, resolveRevisionResponse)",
      "1633: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1690: func Test_resolveSymlinkRecursive(t *testing.T) {",
      "1691:  cwd, err := os.Getwd()",
      "1692:  require.NoError(t, err)",
      "1693:  err = os.Chdir(\"testdata/symlinks\")",
      "1694:  require.NoError(t, err)",
      "1695:  defer func() {",
      "1696:   err := os.Chdir(cwd)",
      "1697:   if err != nil {",
      "1698:    panic(err)",
      "1699:   }",
      "1700:  }()",
      "1701:  t.Run(\"Resolve non-symlink\", func(t *testing.T) {",
      "1702:   r, err := resolveSymbolicLinkRecursive(\"foo\", 2)",
      "1703:   assert.NoError(t, err)",
      "1704:   assert.Equal(t, \"foo\", r)",
      "1705:  })",
      "1706:  t.Run(\"Successfully resolve symlink\", func(t *testing.T) {",
      "1707:   r, err := resolveSymbolicLinkRecursive(\"bar\", 2)",
      "1708:   assert.NoError(t, err)",
      "1709:   assert.Equal(t, \"foo\", r)",
      "1710:  })",
      "1711:  t.Run(\"Do not allow symlink at all\", func(t *testing.T) {",
      "1712:   r, err := resolveSymbolicLinkRecursive(\"bar\", 0)",
      "1713:   assert.Error(t, err)",
      "1714:   assert.Equal(t, \"\", r)",
      "1715:  })",
      "1716:  t.Run(\"Error because too nested symlink\", func(t *testing.T) {",
      "1717:   r, err := resolveSymbolicLinkRecursive(\"bam\", 2)",
      "1718:   assert.Error(t, err)",
      "1719:   assert.Equal(t, \"\", r)",
      "1720:  })",
      "1721:  t.Run(\"No such file or directory\", func(t *testing.T) {",
      "1722:   r, err := resolveSymbolicLinkRecursive(\"foobar\", 2)",
      "1723:   assert.NoError(t, err)",
      "1724:   assert.Equal(t, \"foobar\", r)",
      "1725:  })",
      "1726: }",
      "1728: func Test_isURLSchemeAllowed(t *testing.T) {",
      "1729:  type testdata struct {",
      "1730:   name     string",
      "1731:   scheme   string",
      "1732:   allowed  []string",
      "1733:   expected bool",
      "1734:  }",
      "1735:  var tts []testdata = []testdata{",
      "1736:   {",
      "1737:    name:     \"Allowed scheme matches\",",
      "1738:    scheme:   \"http\",",
      "1739:    allowed:  []string{\"http\", \"https\"},",
      "1740:    expected: true,",
      "1741:   },",
      "1742:   {",
      "1743:    name:     \"Allowed scheme matches only partially\",",
      "1744:    scheme:   \"http\",",
      "1745:    allowed:  []string{\"https\"},",
      "1746:    expected: false,",
      "1747:   },",
      "1748:   {",
      "1749:    name:     \"Scheme is not allowed\",",
      "1750:    scheme:   \"file\",",
      "1751:    allowed:  []string{\"http\", \"https\"},",
      "1752:    expected: false,",
      "1753:   },",
      "1754:   {",
      "1755:    name:     \"Empty scheme with valid allowances is forbidden\",",
      "1756:    scheme:   \"\",",
      "1757:    allowed:  []string{\"http\", \"https\"},",
      "1758:    expected: false,",
      "1759:   },",
      "1760:   {",
      "1761:    name:     \"Empty scheme with empty allowances is forbidden\",",
      "1762:    scheme:   \"\",",
      "1763:    allowed:  []string{},",
      "1764:    expected: false,",
      "1765:   },",
      "1766:   {",
      "1767:    name:     \"Some scheme with empty allowances is forbidden\",",
      "1768:    scheme:   \"file\",",
      "1769:    allowed:  []string{},",
      "1770:    expected: false,",
      "1771:   },",
      "1772:  }",
      "1773:  for _, tt := range tts {",
      "1774:   t.Run(tt.name, func(t *testing.T) {",
      "1775:    r := isURLSchemeAllowed(tt.scheme, tt.allowed)",
      "1776:    assert.Equal(t, tt.expected, r)",
      "1777:   })",
      "1778:  }",
      "1779: }",
      "1781: func Test_resolveHelmValueFilePath(t *testing.T) {",
      "1782:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
      "1783:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/bim.yaml\", allowedHelmRemoteProtocols)",
      "1784:   assert.NoError(t, err)",
      "1785:   assert.False(t, remote)",
      "1786:   assert.Equal(t, \"/foo/bar/baz/bim.yaml\", p)",
      "1787:  })",
      "1788:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
      "1789:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../bim.yaml\", allowedHelmRemoteProtocols)",
      "1790:   assert.NoError(t, err)",
      "1791:   assert.False(t, remote)",
      "1792:   assert.Equal(t, \"/foo/bim.yaml\", p)",
      "1793:  })",
      "1794:  t.Run(\"Error on path resolving outside repository root\", func(t *testing.T) {",
      "1795:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../../bim.yaml\", allowedHelmRemoteProtocols)",
      "1796:   assert.Error(t, err)",
      "1797:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "1798:   assert.False(t, remote)",
      "1799:   assert.Equal(t, \"\", p)",
      "1800:  })",
      "1801:  t.Run(\"Return verbatim URL\", func(t *testing.T) {",
      "1802:   url := \"https://some.where/foo,yaml\"",
      "1803:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
      "1804:   assert.NoError(t, err)",
      "1805:   assert.True(t, remote)",
      "1806:   assert.Equal(t, url, p)",
      "1807:  })",
      "1808:  t.Run(\"URL scheme not allowed\", func(t *testing.T) {",
      "1809:   url := \"file:///some.where/foo,yaml\"",
      "1810:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
      "1811:   assert.Error(t, err)",
      "1812:   assert.False(t, remote)",
      "1813:   assert.Equal(t, \"\", p)",
      "1814:  })",
      "1815:  t.Run(\"Implicit URL by absolute path\", func(t *testing.T) {",
      "1816:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
      "1817:   assert.NoError(t, err)",
      "1818:   assert.False(t, remote)",
      "1819:   assert.Equal(t, \"/foo/baz.yaml\", p)",
      "1820:  })",
      "1821:  t.Run(\"Relative app path\", func(t *testing.T) {",
      "1822:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
      "1823:   assert.NoError(t, err)",
      "1824:   assert.False(t, remote)",
      "1825:   assert.Equal(t, \"/foo/baz.yaml\", p)",
      "1826:  })",
      "1827:  t.Run(\"Relative repo path\", func(t *testing.T) {",
      "1828:   c, err := os.Getwd()",
      "1829:   require.NoError(t, err)",
      "1830:   p, remote, err := resolveHelmValueFilePath(\".\", \".\", \"baz.yaml\", allowedHelmRemoteProtocols)",
      "1831:   assert.NoError(t, err)",
      "1832:   assert.False(t, remote)",
      "1833:   assert.Equal(t, c+\"/baz.yaml\", p)",
      "1834:  })",
      "1835:  t.Run(\"Overlapping root prefix without trailing slash\", func(t *testing.T) {",
      "1836:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
      "1837:   assert.Error(t, err)",
      "1838:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "1839:   assert.False(t, remote)",
      "1840:   assert.Equal(t, \"\", p)",
      "1841:  })",
      "1842:  t.Run(\"Overlapping root prefix with trailing slash\", func(t *testing.T) {",
      "1843:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
      "1844:   assert.Error(t, err)",
      "1845:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "1846:   assert.False(t, remote)",
      "1847:   assert.Equal(t, \"\", p)",
      "1848:  })",
      "1849:  t.Run(\"Garbage input as values file\", func(t *testing.T) {",
      "1850:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"kfdj\\\\ks&&&321209.,---e32908923%$\u00a7!\\\"\", allowedHelmRemoteProtocols)",
      "1851:   assert.Error(t, err)",
      "1852:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "1853:   assert.False(t, remote)",
      "1854:   assert.Equal(t, \"\", p)",
      "1855:  })",
      "1856:  t.Run(\"NUL-byte path input as values file\", func(t *testing.T) {",
      "1857:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"\\000\", allowedHelmRemoteProtocols)",
      "1858:   assert.Error(t, err)",
      "1859:   assert.Contains(t, err.Error(), \"outside repository root\")",
      "1860:   assert.False(t, remote)",
      "1861:   assert.Equal(t, \"\", p)",
      "1862:  })",
      "1863: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "16b2fd3cc9cf7b76a224e2a4c6bcfd4c8bd8eed4",
      "candidate_info": {
        "commit_hash": "16b2fd3cc9cf7b76a224e2a4c6bcfd4c8bd8eed4",
        "repo": "argoproj/argo-cd",
        "commit_url": "https://github.com/argoproj/argo-cd/commit/16b2fd3cc9cf7b76a224e2a4c6bcfd4c8bd8eed4",
        "files": [
          "reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go",
          "reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet",
          "reposerver/repository/testdata/jsonnet-1/params.libsonnet",
          "reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet",
          "util/helm/helm.go",
          "util/helm/helm_test.go",
          "util/io/path/resolved.go",
          "util/io/path/resolved_test.go"
        ],
        "message": "fix: allow resolving repo root as jsonnet lib path (#11119)\n\nSigned-off-by: shuai-zh <shuaiz8023@gmail.com>\nSigned-off-by: Michael Crenshaw <350466+crenshaw-dev@users.noreply.github.com>\nCo-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>\nCo-authored-by: Michael Crenshaw <350466+crenshaw-dev@users.noreply.github.com>",
        "before_after_code_files": [
          "reposerver/repository/repository.go||reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go",
          "reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet||reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet",
          "reposerver/repository/testdata/jsonnet-1/params.libsonnet||reposerver/repository/testdata/jsonnet-1/params.libsonnet",
          "reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet||reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet",
          "util/helm/helm.go||util/helm/helm.go",
          "util/helm/helm_test.go||util/helm/helm_test.go",
          "util/io/path/resolved.go||util/io/path/resolved.go",
          "util/io/path/resolved_test.go||util/io/path/resolved_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ],
          "candidate": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ]
        }
      },
      "candidate_diff": {
        "reposerver/repository/repository.go||reposerver/repository/repository.go": [
          "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "856:   for _, val := range appHelm.ValueFiles {",
          "860:    if err != nil {",
          "861:     return nil, err",
          "862:    }",
          "",
          "[Removed Lines]",
          "859:    path, isRemote, err := pathutil.ResolveFilePath(appPath, repoRoot, env.Envsubst(val), q.GetValuesFileSchemes())",
          "",
          "[Added Lines]",
          "859:    path, isRemote, err := pathutil.ResolveValueFilePathOrUrl(appPath, repoRoot, env.Envsubst(val), q.GetValuesFileSchemes())",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "896:    }",
          "897:   }",
          "898:   for _, p := range appHelm.FileParameters {",
          "900:    if err != nil {",
          "901:     return nil, err",
          "902:    }",
          "",
          "[Removed Lines]",
          "899:    resolvedPath, _, err := pathutil.ResolveFilePath(appPath, repoRoot, env.Envsubst(p.Path), q.GetValuesFileSchemes())",
          "",
          "[Added Lines]",
          "899:    resolvedPath, _, err := pathutil.ResolveValueFilePathOrUrl(appPath, repoRoot, env.Envsubst(p.Path), q.GetValuesFileSchemes())",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1504:  jpaths := []string{appPath}",
          "1505:  for _, p := range sourceJsonnet.Libs {",
          "1508:   if err != nil {",
          "1509:    return nil, err",
          "1510:   }",
          "",
          "[Removed Lines]",
          "1507:   jpath, _, err := pathutil.ResolveFilePath(repoRoot, repoRoot, p, nil)",
          "",
          "[Added Lines]",
          "1507:   jpath, err := pathutil.ResolveFileOrDirectoryPath(repoRoot, repoRoot, p)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1747:   return err",
          "1748:  }",
          "1751:   if err := loadFileIntoIfExists(resolvedValuesPath, &res.Helm.Values); err != nil {",
          "1752:    return err",
          "1753:   }",
          "",
          "[Removed Lines]",
          "1750:  if resolvedValuesPath, _, err := pathutil.ResolveFilePath(appPath, repoRoot, \"values.yaml\", []string{}); err == nil {",
          "",
          "[Added Lines]",
          "1750:  if resolvedValuesPath, _, err := pathutil.ResolveValueFilePathOrUrl(appPath, repoRoot, \"values.yaml\", []string{}); err == nil {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1757:  var resolvedSelectedValueFiles []pathutil.ResolvedFilePath",
          "1759:  for _, file := range selectedValueFiles {",
          "1761:    resolvedSelectedValueFiles = append(resolvedSelectedValueFiles, resolvedFile)",
          "1762:   } else {",
          "1763:    log.Warnf(\"Values file %s is not allowed: %v\", file, err)",
          "",
          "[Removed Lines]",
          "1760:   if resolvedFile, _, err := pathutil.ResolveFilePath(appPath, repoRoot, file, q.GetValuesFileSchemes()); err == nil {",
          "",
          "[Added Lines]",
          "1760:   if resolvedFile, _, err := pathutil.ResolveValueFilePathOrUrl(appPath, repoRoot, file, q.GetValuesFileSchemes()); err == nil {",
          "",
          "---------------"
        ],
        "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
          "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:  assert.Equal(t, 2, len(res1.Manifests))",
          "343: }",
          "345: func TestGenerateJsonnetLibOutside(t *testing.T) {",
          "346:  service := newService(\".\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345: func TestGenerateJsonnetManifestInRootDir(t *testing.T) {",
          "346:  service := newService(\"testdata/jsonnet-1\")",
          "348:  q := apiclient.ManifestRequest{",
          "349:   Repo: &argoappv1.Repository{},",
          "350:   ApplicationSource: &argoappv1.ApplicationSource{",
          "351:    Path: \".\",",
          "352:    Directory: &argoappv1.ApplicationSourceDirectory{",
          "353:     Jsonnet: argoappv1.ApplicationSourceJsonnet{",
          "354:      ExtVars: []argoappv1.JsonnetVar{{Name: \"extVarString\", Value: \"extVarString\"}, {Name: \"extVarCode\", Value: \"\\\"extVarCode\\\"\", Code: true}},",
          "355:      TLAs:    []argoappv1.JsonnetVar{{Name: \"tlaString\", Value: \"tlaString\"}, {Name: \"tlaCode\", Value: \"\\\"tlaCode\\\"\", Code: true}},",
          "356:      Libs:    []string{\".\"},",
          "357:     },",
          "358:    },",
          "359:   },",
          "360:  }",
          "361:  res1, err := service.GenerateManifest(context.Background(), &q)",
          "362:  assert.Nil(t, err)",
          "363:  assert.Equal(t, 2, len(res1.Manifests))",
          "364: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "358:  }",
          "359:  _, err := service.GenerateManifest(context.Background(), &q)",
          "360:  require.Error(t, err)",
          "362: }",
          "364: func TestManifestGenErrorCacheByNumRequests(t *testing.T) {",
          "",
          "[Removed Lines]",
          "361:  require.Contains(t, err.Error(), \"value file '../../../testdata/jsonnet/vendor' resolved to outside repository root\")",
          "",
          "[Added Lines]",
          "382:  require.Contains(t, err.Error(), \"file '../../../testdata/jsonnet/vendor' resolved to outside repository root\")",
          "",
          "---------------"
        ],
        "reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet||reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet": [
          "File: reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet -> reposerver/repository/testdata/jsonnet-1/guestbook-ui.jsonnet",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: local service = import 'vendor/nested/service.libsonnet';",
          "2: local params = import 'params.libsonnet';",
          "4: function(tlaString, tlaCode)",
          "5:   [",
          "6:     service.new(params),",
          "7:     {",
          "8:       apiVersion: 'apps/v1beta2',",
          "9:       kind: 'Deployment',",
          "10:       metadata: {",
          "11:         name: params.name,",
          "12:       },",
          "13:       spec: {",
          "14:         replicas: params.replicas,",
          "15:         selector: {",
          "16:           matchLabels: {",
          "17:             app: params.name,",
          "18:           },",
          "19:         },",
          "20:         template: {",
          "21:           metadata: {",
          "22:             labels: {",
          "23:               app: params.name,",
          "24:               tlaString: tlaString,",
          "25:               tlaCode: tlaCode,",
          "26:               extVarString: std.extVar('extVarString'),",
          "27:               extVarCode: std.extVar('extVarCode'),",
          "28:             },",
          "29:           },",
          "30:           spec: {",
          "31:             containers: [",
          "32:               {",
          "33:                 image: params.image,",
          "34:                 name: params.name,",
          "35:                 ports: [",
          "36:                   {",
          "37:                     containerPort: params.containerPort,",
          "38:                   },",
          "39:                 ],",
          "40:               },",
          "41:             ],",
          "42:           },",
          "43:         },",
          "44:       },",
          "45:     },",
          "46:     null,",
          "47:   ]",
          "",
          "---------------"
        ],
        "reposerver/repository/testdata/jsonnet-1/params.libsonnet||reposerver/repository/testdata/jsonnet-1/params.libsonnet": [
          "File: reposerver/repository/testdata/jsonnet-1/params.libsonnet -> reposerver/repository/testdata/jsonnet-1/params.libsonnet",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {",
          "2:   containerPort: 80,",
          "3:   image: \"gcr.io/heptio-images/ks-guestbook-demo:0.2\",",
          "4:   name: \"guestbook-ui\",",
          "5:   replicas: 1,",
          "6:   servicePort: 80,",
          "7:   type: \"ClusterIP\",",
          "8: }",
          "",
          "---------------"
        ],
        "reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet||reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet": [
          "File: reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet -> reposerver/repository/testdata/jsonnet-1/vendor/nested/service.libsonnet",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: local new(params) = {",
          "2:   apiVersion: 'v1',",
          "3:   kind: 'Service',",
          "4:   metadata: {",
          "5:     name: params.name,",
          "6:   },",
          "7:   spec: {",
          "8:     ports: [",
          "9:       {",
          "10:         port: params.servicePort,",
          "11:         targetPort: params.containerPort,",
          "12:       },",
          "13:     ],",
          "14:     selector: {",
          "15:       app: params.name,",
          "16:     },",
          "17:     type: params.type,",
          "18:   },",
          "19: };",
          "21: {",
          "22:   new:: new,",
          "23: }",
          "",
          "---------------"
        ],
        "util/helm/helm.go||util/helm/helm.go": [
          "File: util/helm/helm.go -> util/helm/helm.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "133: func (h *helm) GetParameters(valuesFiles []pathutil.ResolvedFilePath, appPath, repoRoot string) (map[string]string, error) {",
          "134:  var values []string",
          "137:   out, err := h.cmd.inspectValues(\".\")",
          "138:   if err != nil {",
          "139:    return nil, err",
          "",
          "[Removed Lines]",
          "136:  if _, _, err := pathutil.ResolveFilePath(appPath, repoRoot, \"values.yaml\", []string{}); err == nil {",
          "",
          "[Added Lines]",
          "136:  if _, _, err := pathutil.ResolveValueFilePathOrUrl(appPath, repoRoot, \"values.yaml\", []string{}); err == nil {",
          "",
          "---------------"
        ],
        "util/helm/helm_test.go||util/helm/helm_test.go": [
          "File: util/helm/helm_test.go -> util/helm/helm_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:  require.NoError(t, err)",
          "60:  h, err := NewHelmApp(repoRootAbs, []HelmRepository{}, false, \"\", \"\", false)",
          "61:  assert.NoError(t, err)",
          "63:  require.NoError(t, err)",
          "64:  opts := TemplateOpts{",
          "65:   Name:   \"test\",",
          "",
          "[Removed Lines]",
          "62:  valuesPath, _, err := path.ResolveFilePath(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "[Added Lines]",
          "62:  valuesPath, _, err := path.ResolveValueFilePathOrUrl(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:  require.NoError(t, err)",
          "99:  h, err := NewHelmApp(repoRootAbs, nil, false, \"\", \"\", false)",
          "100:  assert.NoError(t, err)",
          "102:  require.NoError(t, err)",
          "103:  params, err := h.GetParameters([]path.ResolvedFilePath{valuesPath}, repoRootAbs, repoRootAbs)",
          "104:  assert.Nil(t, err)",
          "",
          "[Removed Lines]",
          "101:  valuesPath, _, err := path.ResolveFilePath(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "[Added Lines]",
          "101:  valuesPath, _, err := path.ResolveValueFilePathOrUrl(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "113:  require.NoError(t, err)",
          "114:  h, err := NewHelmApp(repoRootAbs, nil, false, \"\", \"\", false)",
          "115:  assert.NoError(t, err)",
          "117:  require.NoError(t, err)",
          "119:  require.NoError(t, err)",
          "120:  params, err := h.GetParameters([]path.ResolvedFilePath{valuesMissingPath, valuesProductionPath}, repoRootAbs, repoRootAbs)",
          "121:  assert.Nil(t, err)",
          "",
          "[Removed Lines]",
          "116:  valuesMissingPath, _, err := path.ResolveFilePath(repoRootAbs, repoRootAbs, \"values-missing.yaml\", nil)",
          "118:  valuesProductionPath, _, err := path.ResolveFilePath(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "[Added Lines]",
          "116:  valuesMissingPath, _, err := path.ResolveValueFilePathOrUrl(repoRootAbs, repoRootAbs, \"values-missing.yaml\", nil)",
          "118:  valuesProductionPath, _, err := path.ResolveValueFilePathOrUrl(repoRootAbs, repoRootAbs, \"values-production.yaml\", nil)",
          "",
          "---------------"
        ],
        "util/io/path/resolved.go||util/io/path/resolved.go": [
          "File: util/io/path/resolved.go -> util/io/path/resolved.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:  log \"github.com/sirupsen/logrus\"",
          "11: )",
          "15: type ResolvedFilePath string",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: type ResolvedFileOrDirectoryPath string",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "60:  return isAllowed && scheme != \"\"",
          "61: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: func resolveFailure(path string, err error) error {",
          "71:  log.Errorf(\"failed to resolve path '%s': %v\", path, err)",
          "72:  return fmt.Errorf(\"internal error: failed to resolve path. Check logs for more details\")",
          "73: }",
          "75: func ResolveFileOrDirectoryPath(appPath, repoRoot, dir string) (ResolvedFileOrDirectoryPath, error) {",
          "76:  path, err := resolveFileOrDirectory(appPath, repoRoot, dir, true)",
          "77:  if err != nil {",
          "78:   return \"\", err",
          "79:  }",
          "81:  return ResolvedFileOrDirectoryPath(path), nil",
          "82: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "102:  url, err := url.Parse(valueFile)",
          "",
          "[Removed Lines]",
          "91: func ResolveFilePath(appPath, repoRoot, valueFile string, allowedURLSchemes []string) (resolvedPath ResolvedFilePath, isRemote bool, err error) {",
          "95:  resolveFailure := func(path string, err error) error {",
          "96:   log.Errorf(\"failed to resolve path '%s': %v\", path, err)",
          "97:   return fmt.Errorf(\"internal error: failed to resolve path. Check logs for more details\")",
          "98:  }",
          "",
          "[Added Lines]",
          "112: func ResolveValueFilePathOrUrl(appPath, repoRoot, valueFile string, allowedURLSchemes []string) (resolvedPath ResolvedFilePath, isRemote bool, err error) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "111:   }",
          "112:  }",
          "115:  absRepoPath, err := filepath.Abs(repoRoot)",
          "116:  if err != nil {",
          "118:  }",
          "123:  if !filepath.IsAbs(path) {",
          "124:   absWorkDir, err := filepath.Abs(appPath)",
          "125:   if err != nil {",
          "127:   }",
          "128:   path = filepath.Join(absWorkDir, path)",
          "129:  } else {",
          "130:   path = filepath.Join(absRepoPath, path)",
          "131:  }",
          "134:  delinkedPath, err := resolveSymbolicLinkRecursive(path, 10)",
          "135:  if err != nil {",
          "137:  }",
          "138:  path = delinkedPath",
          "141:  path, err = filepath.Abs(path)",
          "142:  if err != nil {",
          "144:  }",
          "",
          "[Removed Lines]",
          "117:   return \"\", false, resolveFailure(repoRoot, err)",
          "122:  path := valueFile",
          "126:    return \"\", false, resolveFailure(repoRoot, err)",
          "136:   return \"\", false, resolveFailure(path, err)",
          "143:   return \"\", false, resolveFailure(path, err)",
          "",
          "[Added Lines]",
          "127:  path, err := resolveFileOrDirectory(appPath, repoRoot, valueFile, false)",
          "128:  if err != nil {",
          "129:   return \"\", false, err",
          "130:  }",
          "132:  return ResolvedFilePath(path), false, nil",
          "133: }",
          "135: func resolveFileOrDirectory(appPath string, repoRoot string, fileOrDirectory string, allowResolveToRoot bool) (string, error) {",
          "139:   return \"\", resolveFailure(repoRoot, err)",
          "144:  path := fileOrDirectory",
          "148:    return \"\", resolveFailure(repoRoot, err)",
          "158:   return \"\", resolveFailure(repoRoot, err)",
          "165:   return \"\", resolveFailure(repoRoot, err)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "150:   requiredRootPath += string(os.PathSeparator)",
          "151:  }",
          "156:  }",
          "159: }",
          "",
          "[Removed Lines]",
          "154:  if !strings.HasPrefix(path, requiredRootPath) {",
          "155:   return \"\", false, fmt.Errorf(\"value file '%s' resolved to outside repository root\", valueFile)",
          "158:  return ResolvedFilePath(path), false, nil",
          "",
          "[Added Lines]",
          "175:  resolvedToRoot := path+string(os.PathSeparator) == requiredRootPath",
          "176:  if resolvedToRoot {",
          "177:   if !allowResolveToRoot {",
          "178:    return \"\", resolveFailure(path, fmt.Errorf(\"path resolved to repository root, which is not allowed\"))",
          "179:   }",
          "180:  } else {",
          "182:   if !strings.HasPrefix(path, requiredRootPath) {",
          "183:    return \"\", fmt.Errorf(\"file '%s' resolved to outside repository root\", fileOrDirectory)",
          "184:   }",
          "187:  return path, nil",
          "",
          "---------------"
        ],
        "util/io/path/resolved_test.go||util/io/path/resolved_test.go": [
          "File: util/io/path/resolved_test.go -> util/io/path/resolved_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "99: func Test_resolveFilePath(t *testing.T) {",
          "100:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "102:   assert.NoError(t, err)",
          "103:   assert.False(t, remote)",
          "104:   assert.Equal(t, \"/foo/bar/baz/bim.yaml\", string(p))",
          "105:  })",
          "106:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "108:   assert.NoError(t, err)",
          "109:   assert.False(t, remote)",
          "110:   assert.Equal(t, \"/foo/bim.yaml\", string(p))",
          "111:  })",
          "112:  t.Run(\"Error on path resolving outside repository root\", func(t *testing.T) {",
          "114:   assert.Error(t, err)",
          "115:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "116:   assert.False(t, remote)",
          "",
          "[Removed Lines]",
          "101:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", \"baz/bim.yaml\", allowedRemoteProtocols)",
          "107:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", \"baz/../../bim.yaml\", allowedRemoteProtocols)",
          "113:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", \"baz/../../../bim.yaml\", allowedRemoteProtocols)",
          "",
          "[Added Lines]",
          "101:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", \"baz/bim.yaml\", allowedRemoteProtocols)",
          "107:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", \"baz/../../bim.yaml\", allowedRemoteProtocols)",
          "113:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", \"baz/../../../bim.yaml\", allowedRemoteProtocols)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "118:  })",
          "119:  t.Run(\"Return verbatim URL\", func(t *testing.T) {",
          "120:   url := \"https://some.where/foo,yaml\"",
          "122:   assert.NoError(t, err)",
          "123:   assert.True(t, remote)",
          "124:   assert.Equal(t, url, string(p))",
          "125:  })",
          "126:  t.Run(\"URL scheme not allowed\", func(t *testing.T) {",
          "127:   url := \"file:///some.where/foo,yaml\"",
          "129:   assert.Error(t, err)",
          "130:   assert.False(t, remote)",
          "131:   assert.Equal(t, \"\", string(p))",
          "132:  })",
          "133:  t.Run(\"Implicit URL by absolute path\", func(t *testing.T) {",
          "135:   assert.NoError(t, err)",
          "136:   assert.False(t, remote)",
          "137:   assert.Equal(t, \"/foo/baz.yaml\", string(p))",
          "138:  })",
          "139:  t.Run(\"Relative app path\", func(t *testing.T) {",
          "141:   assert.NoError(t, err)",
          "142:   assert.False(t, remote)",
          "143:   assert.Equal(t, \"/foo/baz.yaml\", string(p))",
          "",
          "[Removed Lines]",
          "121:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", url, allowedRemoteProtocols)",
          "128:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", url, allowedRemoteProtocols)",
          "134:   p, remote, err := ResolveFilePath(\"/foo/bar\", \"/foo\", \"/baz.yaml\", allowedRemoteProtocols)",
          "140:   p, remote, err := ResolveFilePath(\".\", \"/foo\", \"/baz.yaml\", allowedRemoteProtocols)",
          "",
          "[Added Lines]",
          "121:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", url, allowedRemoteProtocols)",
          "128:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", url, allowedRemoteProtocols)",
          "134:   p, remote, err := ResolveValueFilePathOrUrl(\"/foo/bar\", \"/foo\", \"/baz.yaml\", allowedRemoteProtocols)",
          "140:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \"/foo\", \"/baz.yaml\", allowedRemoteProtocols)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "145:  t.Run(\"Relative repo path\", func(t *testing.T) {",
          "146:   c, err := os.Getwd()",
          "147:   require.NoError(t, err)",
          "149:   assert.NoError(t, err)",
          "150:   assert.False(t, remote)",
          "151:   assert.Equal(t, c+\"/baz.yaml\", string(p))",
          "152:  })",
          "153:  t.Run(\"Overlapping root prefix without trailing slash\", func(t *testing.T) {",
          "155:   assert.Error(t, err)",
          "156:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "157:   assert.False(t, remote)",
          "158:   assert.Equal(t, \"\", string(p))",
          "159:  })",
          "160:  t.Run(\"Overlapping root prefix with trailing slash\", func(t *testing.T) {",
          "162:   assert.Error(t, err)",
          "163:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "164:   assert.False(t, remote)",
          "165:   assert.Equal(t, \"\", string(p))",
          "166:  })",
          "167:  t.Run(\"Garbage input as values file\", func(t *testing.T) {",
          "169:   assert.Error(t, err)",
          "170:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "171:   assert.False(t, remote)",
          "172:   assert.Equal(t, \"\", string(p))",
          "173:  })",
          "174:  t.Run(\"NUL-byte path input as values file\", func(t *testing.T) {",
          "176:   assert.Error(t, err)",
          "177:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "178:   assert.False(t, remote)",
          "179:   assert.Equal(t, \"\", string(p))",
          "180:  })",
          "181: }",
          "",
          "[Removed Lines]",
          "148:   p, remote, err := ResolveFilePath(\".\", \".\", \"baz.yaml\", allowedRemoteProtocols)",
          "154:   p, remote, err := ResolveFilePath(\".\", \"/foo\", \"../foo2/baz.yaml\", allowedRemoteProtocols)",
          "161:   p, remote, err := ResolveFilePath(\".\", \"/foo/\", \"../foo2/baz.yaml\", allowedRemoteProtocols)",
          "168:   p, remote, err := ResolveFilePath(\".\", \"/foo/\", \"kfdj\\\\ks&&&321209.,---e32908923%$\u00a7!\\\"\", allowedRemoteProtocols)",
          "175:   p, remote, err := ResolveFilePath(\".\", \"/foo/\", \"\\000\", allowedRemoteProtocols)",
          "",
          "[Added Lines]",
          "148:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \".\", \"baz.yaml\", allowedRemoteProtocols)",
          "154:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \"/foo\", \"../foo2/baz.yaml\", allowedRemoteProtocols)",
          "161:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \"/foo/\", \"../foo2/baz.yaml\", allowedRemoteProtocols)",
          "168:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \"/foo/\", \"kfdj\\\\ks&&&321209.,---e32908923%$\u00a7!\\\"\", allowedRemoteProtocols)",
          "175:   p, remote, err := ResolveValueFilePathOrUrl(\".\", \"/foo/\", \"\\000\", allowedRemoteProtocols)",
          "181:  t.Run(\"Resolve root path into absolute path - jsonnet library path\", func(t *testing.T) {",
          "182:   p, err := ResolveFileOrDirectoryPath(\"/foo\", \"/foo\", \"./\")",
          "183:   assert.NoError(t, err)",
          "184:   assert.Equal(t, \"/foo\", string(p))",
          "185:  })",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bb77664b6f0299bb332843bcd2524820c7ba1558",
      "candidate_info": {
        "commit_hash": "bb77664b6f0299bb332843bcd2524820c7ba1558",
        "repo": "argoproj/argo-cd",
        "commit_url": "https://github.com/argoproj/argo-cd/commit/bb77664b6f0299bb332843bcd2524820c7ba1558",
        "files": [
          "reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go",
          "reposerver/repository/testdata/my-chart/my-chart-link.yaml",
          "reposerver/repository/testdata/my-chart/my-chart-outside-link.yaml"
        ],
        "message": "fix: Resolve symlinked value files correctly (#8387)\n\n* fix: Resolve symlinked value files correctly\n\nSigned-off-by: jannfis <jann@mistrust.net>\n\n* fix: Resolve symlinked value files correctly\n\nSigned-off-by: jannfis <jann@mistrust.net>",
        "before_after_code_files": [
          "reposerver/repository/repository.go||reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ],
          "candidate": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ]
        }
      },
      "candidate_diff": {
        "reposerver/repository/repository.go||reposerver/repository/repository.go": [
          "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "575:   return \"\", fmt.Errorf(\"maximum nesting level reached\")",
          "576:  }",
          "578:  return resolveSymbolicLinkRecursive(resolved, maxDepth-1)",
          "579: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "580:  if !strings.HasPrefix(resolved, \"/\") {",
          "581:   basePath := filepath.Dir(path)",
          "582:   resolved = filepath.Join(basePath, resolved)",
          "583:  }",
          "",
          "---------------"
        ],
        "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
          "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "757:  assert.Error(t, err)",
          "758: }",
          "760: func TestGenerateHelmWithURL(t *testing.T) {",
          "761:  service := newService(\"../..\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "760: func TestHelmManifestFromChartRepoWithValueFileLinks(t *testing.T) {",
          "761:  t.Run(\"Valid symlink\", func(t *testing.T) {",
          "762:   service := newService(\"../..\")",
          "763:   source := &argoappv1.ApplicationSource{",
          "764:    Chart:          \"my-chart\",",
          "765:    TargetRevision: \">= 1.0.0\",",
          "766:    Helm: &argoappv1.ApplicationSourceHelm{",
          "767:     ValueFiles: []string{\"my-chart-link.yaml\"},",
          "768:    },",
          "769:   }",
          "770:   request := &apiclient.ManifestRequest{Repo: &argoappv1.Repository{}, ApplicationSource: source, NoCache: true}",
          "771:   _, err := service.GenerateManifest(context.Background(), request)",
          "772:   assert.NoError(t, err)",
          "773:  })",
          "774:  t.Run(\"Symlink pointing to outside\", func(t *testing.T) {",
          "775:   service := newService(\"../..\")",
          "776:   source := &argoappv1.ApplicationSource{",
          "777:    Chart:          \"my-chart\",",
          "778:    TargetRevision: \">= 1.0.0\",",
          "779:    Helm: &argoappv1.ApplicationSourceHelm{",
          "780:     ValueFiles: []string{\"my-chart-outside-link.yaml\"},",
          "781:    },",
          "782:   }",
          "783:   request := &apiclient.ManifestRequest{Repo: &argoappv1.Repository{}, ApplicationSource: source, NoCache: true}",
          "784:   _, err := service.GenerateManifest(context.Background(), request)",
          "785:   assert.Error(t, err)",
          "786:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "787:  })",
          "788: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1688: }",
          "1690: func Test_resolveSymlinkRecursive(t *testing.T) {",
          "1701:  t.Run(\"Resolve non-symlink\", func(t *testing.T) {",
          "1703:   assert.NoError(t, err)",
          "1705:  })",
          "1706:  t.Run(\"Successfully resolve symlink\", func(t *testing.T) {",
          "1708:   assert.NoError(t, err)",
          "1710:  })",
          "1711:  t.Run(\"Do not allow symlink at all\", func(t *testing.T) {",
          "1713:   assert.Error(t, err)",
          "1714:   assert.Equal(t, \"\", r)",
          "1715:  })",
          "1716:  t.Run(\"Error because too nested symlink\", func(t *testing.T) {",
          "1718:   assert.Error(t, err)",
          "1719:   assert.Equal(t, \"\", r)",
          "1720:  })",
          "1721:  t.Run(\"No such file or directory\", func(t *testing.T) {",
          "1723:   assert.NoError(t, err)",
          "1725:  })",
          "1726: }",
          "",
          "[Removed Lines]",
          "1691:  cwd, err := os.Getwd()",
          "1692:  require.NoError(t, err)",
          "1693:  err = os.Chdir(\"testdata/symlinks\")",
          "1694:  require.NoError(t, err)",
          "1695:  defer func() {",
          "1696:   err := os.Chdir(cwd)",
          "1697:   if err != nil {",
          "1698:    panic(err)",
          "1699:   }",
          "1700:  }()",
          "1702:   r, err := resolveSymbolicLinkRecursive(\"foo\", 2)",
          "1704:   assert.Equal(t, \"foo\", r)",
          "1707:   r, err := resolveSymbolicLinkRecursive(\"bar\", 2)",
          "1709:   assert.Equal(t, \"foo\", r)",
          "1712:   r, err := resolveSymbolicLinkRecursive(\"bar\", 0)",
          "1717:   r, err := resolveSymbolicLinkRecursive(\"bam\", 2)",
          "1722:   r, err := resolveSymbolicLinkRecursive(\"foobar\", 2)",
          "1724:   assert.Equal(t, \"foobar\", r)",
          "",
          "[Added Lines]",
          "1721:  testsDir, err := filepath.Abs(\"./testdata/symlinks\")",
          "1722:  if err != nil {",
          "1723:   panic(err)",
          "1724:  }",
          "1726:   r, err := resolveSymbolicLinkRecursive(testsDir+\"/foo\", 2)",
          "1728:   assert.Equal(t, testsDir+\"/foo\", r)",
          "1731:   r, err := resolveSymbolicLinkRecursive(testsDir+\"/bar\", 2)",
          "1733:   assert.Equal(t, testsDir+\"/foo\", r)",
          "1736:   r, err := resolveSymbolicLinkRecursive(testsDir+\"/bar\", 0)",
          "1741:   r, err := resolveSymbolicLinkRecursive(testsDir+\"/bam\", 2)",
          "1746:   r, err := resolveSymbolicLinkRecursive(testsDir+\"/foobar\", 2)",
          "1748:   assert.Equal(t, testsDir+\"/foobar\", r)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "73f80d7eb0a72168c778dd22dae8b2e641b176de",
      "candidate_info": {
        "commit_hash": "73f80d7eb0a72168c778dd22dae8b2e641b176de",
        "repo": "argoproj/argo-cd",
        "commit_url": "https://github.com/argoproj/argo-cd/commit/73f80d7eb0a72168c778dd22dae8b2e641b176de",
        "files": [
          "docs/user-guide/helm.md",
          "reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go"
        ],
        "message": "feat: Support environment variables in Helm value file paths (#10213)\n\n* Add env var support for value file paths\n\nSigned-off-by: Marius Sturm <marius.sturm@snyk.io>\n\n* Add note about env vars in value file path\n\nSigned-off-by: Marius Sturm <marius.sturm@snyk.io>\n\n* Fix yaml syntax\n\nSigned-off-by: Marius Sturm <marius.sturm@snyk.io>",
        "before_after_code_files": [
          "reposerver/repository/repository.go||reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ],
          "candidate": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ]
        }
      },
      "candidate_diff": {
        "reposerver/repository/repository.go||reposerver/repository/repository.go": [
          "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "776:   for _, val := range appHelm.ValueFiles {",
          "780:    if err != nil {",
          "781:     return nil, err",
          "782:    }",
          "",
          "[Removed Lines]",
          "779:    path, isRemote, err := pathutil.ResolveFilePath(appPath, repoRoot, val, q.GetValuesFileSchemes())",
          "",
          "[Added Lines]",
          "779:    path, isRemote, err := pathutil.ResolveFilePath(appPath, repoRoot, env.Envsubst(val), q.GetValuesFileSchemes())",
          "",
          "---------------"
        ],
        "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
          "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "770:  assert.NoError(t, err)",
          "771: }",
          "775: func TestGenerateHelmWithValuesDirectoryTraversal(t *testing.T) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "773: func TestGenerateHelmWithEnvVars(t *testing.T) {",
          "774:  service := newService(\"../../util/helm/testdata/redis\")",
          "776:  res, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "777:   Repo:    &argoappv1.Repository{},",
          "778:   AppName: \"production\",",
          "779:   ApplicationSource: &argoappv1.ApplicationSource{",
          "780:    Path: \".\",",
          "781:    Helm: &argoappv1.ApplicationSourceHelm{",
          "782:     ValueFiles: []string{\"values-$ARGOCD_APP_NAME.yaml\"},",
          "783:    },",
          "784:   },",
          "785:  })",
          "787:  assert.NoError(t, err)",
          "789:  replicasVerified := false",
          "790:  for _, src := range res.Manifests {",
          "791:   obj := unstructured.Unstructured{}",
          "792:   err = json.Unmarshal([]byte(src), &obj)",
          "793:   assert.NoError(t, err)",
          "795:   if obj.GetKind() == \"Deployment\" && obj.GetName() == \"production-redis-slave\" {",
          "796:    var dep v1.Deployment",
          "797:    err := runtime.DefaultUnstructuredConverter.FromUnstructured(obj.Object, &dep)",
          "798:    assert.NoError(t, err)",
          "799:    assert.Equal(t, int32(3), *dep.Spec.Replicas)",
          "800:    replicasVerified = true",
          "801:   }",
          "802:  }",
          "803:  assert.True(t, replicasVerified)",
          "804: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8139df898339c6eb497c072af4150c783ba9ba57",
      "candidate_info": {
        "commit_hash": "8139df898339c6eb497c072af4150c783ba9ba57",
        "repo": "argoproj/argo-cd",
        "commit_url": "https://github.com/argoproj/argo-cd/commit/8139df898339c6eb497c072af4150c783ba9ba57",
        "files": [
          "reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go",
          "reposerver/repository/testdata/symlinks/bam",
          "reposerver/repository/testdata/symlinks/bar",
          "reposerver/repository/testdata/symlinks/baz",
          "reposerver/repository/testdata/symlinks/foo"
        ],
        "message": "Merge pull request from GHSA-63qx-x74g-jcr7\n\nSigned-off-by: jannfis <jann@mistrust.net>",
        "before_after_code_files": [
          "reposerver/repository/repository.go||reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ],
          "candidate": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ]
        }
      },
      "candidate_diff": {
        "reposerver/repository/repository.go||reposerver/repository/repository.go": [
          "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:  \"github.com/argoproj/argo-cd/v2/util/io\"",
          "53:  \"github.com/argoproj/argo-cd/v2/util/ksonnet\"",
          "54:  \"github.com/argoproj/argo-cd/v2/util/kustomize\"",
          "56:  \"github.com/argoproj/argo-cd/v2/util/text\"",
          "57: )",
          "",
          "[Removed Lines]",
          "55:  \"github.com/argoproj/argo-cd/v2/util/security\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "66:  ociPrefix                      = \"oci://\"",
          "67: )",
          "70: type Service struct {",
          "71:  repoLock                  *repositoryLock",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "69: var allowedHelmRemoteProtocols = []string{\"http\", \"https\"}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "554:  return ioutil.WriteFile(markerFile, []byte(\"marker\"), 0644)",
          "555: }",
          "557: func helmTemplate(appPath string, repoRoot string, env *v1alpha1.Env, q *apiclient.ManifestRequest, isLocal bool) ([]*unstructured.Unstructured, error) {",
          "558:  concurrencyAllowed := isConcurrencyAllowed(appPath)",
          "559:  if !concurrencyAllowed {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562: func resolveSymbolicLinkRecursive(path string, maxDepth int) (string, error) {",
          "563:  resolved, err := os.Readlink(path)",
          "564:  if err != nil {",
          "566:   _, ok := err.(*os.PathError)",
          "567:   if ok {",
          "568:    return path, nil",
          "569:   }",
          "571:   return \"\", err",
          "572:  }",
          "574:  if maxDepth == 0 {",
          "575:   return \"\", fmt.Errorf(\"maximum nesting level reached\")",
          "576:  }",
          "578:  return resolveSymbolicLinkRecursive(resolved, maxDepth-1)",
          "579: }",
          "583: func isURLSchemeAllowed(scheme string, allowed []string) bool {",
          "584:  isAllowed := false",
          "585:  if len(allowed) > 0 {",
          "586:   for _, s := range allowed {",
          "587:    if strings.EqualFold(scheme, s) {",
          "588:     isAllowed = true",
          "589:     break",
          "590:    }",
          "591:   }",
          "592:  }",
          "595:  return isAllowed && scheme != \"\"",
          "596: }",
          "627: func resolveHelmValueFilePath(appPath, repoRoot, valueFile string, allowedURLSchemes []string) (resolvedPath string, isRemote bool, err error) {",
          "632:  resolveFailure := func(path string, err error) error {",
          "633:   log.Errorf(\"failed to resolve path '%s': %v\", path, err)",
          "634:   return fmt.Errorf(\"internal error: failed to resolve path. Check logs for more details\")",
          "635:  }",
          "639:  url, err := url.Parse(valueFile)",
          "640:  if err == nil {",
          "642:   if url.Scheme != \"\" {",
          "643:    if isURLSchemeAllowed(url.Scheme, allowedURLSchemes) {",
          "644:     return valueFile, true, nil",
          "645:    } else {",
          "646:     return \"\", false, fmt.Errorf(\"the URL scheme '%s' is not allowed\", url.Scheme)",
          "647:    }",
          "648:   }",
          "649:  }",
          "652:  absRepoPath, err := filepath.Abs(repoRoot)",
          "653:  if err != nil {",
          "654:   return \"\", false, resolveFailure(repoRoot, err)",
          "655:  }",
          "659:  path := valueFile",
          "660:  if !filepath.IsAbs(path) {",
          "661:   absWorkDir, err := filepath.Abs(appPath)",
          "662:   if err != nil {",
          "663:    return \"\", false, resolveFailure(repoRoot, err)",
          "664:   }",
          "665:   path = filepath.Join(absWorkDir, path)",
          "666:  } else {",
          "667:   path = filepath.Join(absRepoPath, path)",
          "668:  }",
          "671:  delinkedPath, err := resolveSymbolicLinkRecursive(path, 10)",
          "672:  if err != nil {",
          "673:   return \"\", false, resolveFailure(path, err)",
          "674:  }",
          "675:  path = delinkedPath",
          "678:  path, err = filepath.Abs(path)",
          "679:  if err != nil {",
          "680:   return \"\", false, resolveFailure(path, err)",
          "681:  }",
          "685:  requiredRootPath := absRepoPath",
          "686:  if !strings.HasSuffix(requiredRootPath, \"/\") {",
          "687:   requiredRootPath += \"/\"",
          "688:  }",
          "691:  if !strings.HasPrefix(path, requiredRootPath) {",
          "692:   return \"\", false, fmt.Errorf(\"value file '%s' resolved to outside repository root\", valueFile)",
          "693:  }",
          "695:  return path, false, nil",
          "697: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "583:   }",
          "585:   for _, val := range appHelm.ValueFiles {",
          "611:     _, err = os.Stat(path)",
          "612:     if os.IsNotExist(err) {",
          "613:      if appHelm.IgnoreMissingValueFiles {",
          "",
          "[Removed Lines]",
          "588:    if _, err := url.ParseRequestURI(val); err != nil {",
          "591:     absRepoPath, err := filepath.Abs(repoRoot)",
          "592:     if err != nil {",
          "593:      return nil, err",
          "594:     }",
          "597:     path := val",
          "598:     if !filepath.IsAbs(path) {",
          "599:      absWorkDir, err := filepath.Abs(appPath)",
          "600:      if err != nil {",
          "601:       return nil, err",
          "602:      }",
          "603:      path = filepath.Join(absWorkDir, path)",
          "604:     }",
          "606:     _, err = security.EnforceToCurrentRoot(absRepoPath, path)",
          "607:     if err != nil {",
          "608:      return nil, err",
          "609:     }",
          "",
          "[Added Lines]",
          "730:    path, isRemote, err := resolveHelmValueFilePath(appPath, repoRoot, val, allowedHelmRemoteProtocols)",
          "731:    if err != nil {",
          "732:     return nil, err",
          "733:    }",
          "735:    if !isRemote {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "616:      }",
          "617:     }",
          "618:    }",
          "620:   }",
          "622:   if appHelm.Values != \"\" {",
          "",
          "[Removed Lines]",
          "619:    templateOpts.Values = append(templateOpts.Values, val)",
          "",
          "[Added Lines]",
          "745:    templateOpts.Values = append(templateOpts.Values, path)",
          "",
          "---------------"
        ],
        "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
          "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "754:  }",
          "755:  request := &apiclient.ManifestRequest{Repo: &argoappv1.Repository{}, ApplicationSource: source, NoCache: true}",
          "756:  _, err := service.GenerateManifest(context.Background(), request)",
          "758: }",
          "760: func TestGenerateHelmWithURL(t *testing.T) {",
          "",
          "[Removed Lines]",
          "757:  assert.Error(t, err, \"should be on or under current directory\")",
          "",
          "[Added Lines]",
          "757:  assert.Error(t, err)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "779: func TestGenerateHelmWithValuesDirectoryTraversalOutsideRepo(t *testing.T) {",
          "789:    },",
          "791:  })",
          "803:    },",
          "805:  })",
          "807: }",
          "",
          "[Removed Lines]",
          "780:  service := newService(\"../..\")",
          "781:  _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "782:   Repo:    &argoappv1.Repository{},",
          "783:   AppName: \"test\",",
          "784:   ApplicationSource: &argoappv1.ApplicationSource{",
          "785:    Path: \"./util/helm/testdata/redis\",",
          "786:    Helm: &argoappv1.ApplicationSourceHelm{",
          "787:     ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
          "788:     Values:     `cluster: {slaveCount: 2}`,",
          "790:   },",
          "792:  assert.Error(t, err, \"should be on or under current directory\")",
          "794:  service = newService(\"./testdata/my-chart\")",
          "795:  _, err = service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "796:   Repo:    &argoappv1.Repository{},",
          "797:   AppName: \"test\",",
          "798:   ApplicationSource: &argoappv1.ApplicationSource{",
          "799:    Path: \".\",",
          "800:    Helm: &argoappv1.ApplicationSourceHelm{",
          "801:     ValueFiles: []string{\"../my-chart-2/values.yaml\"},",
          "802:     Values:     `cluster: {slaveCount: 2}`,",
          "804:   },",
          "806:  assert.Error(t, err, \"should be on or under current directory\")",
          "",
          "[Added Lines]",
          "780:  t.Run(\"Values file with relative path pointing outside repo root\", func(t *testing.T) {",
          "781:   service := newService(\"../..\")",
          "782:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "783:    Repo:    &argoappv1.Repository{},",
          "784:    AppName: \"test\",",
          "785:    ApplicationSource: &argoappv1.ApplicationSource{",
          "786:     Path: \"./util/helm/testdata/redis\",",
          "787:     Helm: &argoappv1.ApplicationSourceHelm{",
          "788:      ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
          "789:      Values:     `cluster: {slaveCount: 2}`,",
          "790:     },",
          "792:   })",
          "793:   assert.Error(t, err)",
          "794:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "797:  t.Run(\"Values file with relative path pointing inside repo root\", func(t *testing.T) {",
          "798:   service := newService(\"./testdata/my-chart\")",
          "799:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "800:    Repo:    &argoappv1.Repository{},",
          "801:    AppName: \"test\",",
          "802:    ApplicationSource: &argoappv1.ApplicationSource{",
          "803:     Path: \".\",",
          "804:     Helm: &argoappv1.ApplicationSourceHelm{",
          "805:      ValueFiles: []string{\"../my-chart/my-chart-values.yaml\"},",
          "806:      Values:     `cluster: {slaveCount: 2}`,",
          "807:     },",
          "809:   })",
          "810:   assert.NoError(t, err)",
          "811:  })",
          "813:  t.Run(\"Values file with absolute path stays within repo root\", func(t *testing.T) {",
          "814:   service := newService(\"./testdata/my-chart\")",
          "815:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "816:    Repo:    &argoappv1.Repository{},",
          "817:    AppName: \"test\",",
          "818:    ApplicationSource: &argoappv1.ApplicationSource{",
          "819:     Path: \".\",",
          "820:     Helm: &argoappv1.ApplicationSourceHelm{",
          "821:      ValueFiles: []string{\"/my-chart-values.yaml\"},",
          "822:      Values:     `cluster: {slaveCount: 2}`,",
          "823:     },",
          "824:    },",
          "825:   })",
          "826:   assert.NoError(t, err)",
          "827:  })",
          "829:  t.Run(\"Values file with absolute path using back-references outside repo root\", func(t *testing.T) {",
          "830:   service := newService(\"./testdata/my-chart\")",
          "831:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "832:    Repo:    &argoappv1.Repository{},",
          "833:    AppName: \"test\",",
          "834:    ApplicationSource: &argoappv1.ApplicationSource{",
          "835:     Path: \".\",",
          "836:     Helm: &argoappv1.ApplicationSourceHelm{",
          "837:      ValueFiles: []string{\"/../../../my-chart-values.yaml\"},",
          "838:      Values:     `cluster: {slaveCount: 2}`,",
          "839:     },",
          "840:    },",
          "841:   })",
          "842:   assert.Error(t, err)",
          "843:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "844:  })",
          "846:  t.Run(\"Remote values file from forbidden protocol\", func(t *testing.T) {",
          "847:   service := newService(\"./testdata/my-chart\")",
          "848:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "849:    Repo:    &argoappv1.Repository{},",
          "850:    AppName: \"test\",",
          "851:    ApplicationSource: &argoappv1.ApplicationSource{",
          "852:     Path: \".\",",
          "853:     Helm: &argoappv1.ApplicationSourceHelm{",
          "854:      ValueFiles: []string{\"file://../../../../my-chart-values.yaml\"},",
          "855:      Values:     `cluster: {slaveCount: 2}`,",
          "856:     },",
          "857:    },",
          "858:   })",
          "859:   assert.Error(t, err)",
          "860:   assert.Contains(t, err.Error(), \"is not allowed\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1631:  assert.Equal(t, expectedResolveRevisionResponse, resolveRevisionResponse)",
          "1633: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1690: func Test_resolveSymlinkRecursive(t *testing.T) {",
          "1691:  cwd, err := os.Getwd()",
          "1692:  require.NoError(t, err)",
          "1693:  err = os.Chdir(\"testdata/symlinks\")",
          "1694:  require.NoError(t, err)",
          "1695:  defer func() {",
          "1696:   err := os.Chdir(cwd)",
          "1697:   if err != nil {",
          "1698:    panic(err)",
          "1699:   }",
          "1700:  }()",
          "1701:  t.Run(\"Resolve non-symlink\", func(t *testing.T) {",
          "1702:   r, err := resolveSymbolicLinkRecursive(\"foo\", 2)",
          "1703:   assert.NoError(t, err)",
          "1704:   assert.Equal(t, \"foo\", r)",
          "1705:  })",
          "1706:  t.Run(\"Successfully resolve symlink\", func(t *testing.T) {",
          "1707:   r, err := resolveSymbolicLinkRecursive(\"bar\", 2)",
          "1708:   assert.NoError(t, err)",
          "1709:   assert.Equal(t, \"foo\", r)",
          "1710:  })",
          "1711:  t.Run(\"Do not allow symlink at all\", func(t *testing.T) {",
          "1712:   r, err := resolveSymbolicLinkRecursive(\"bar\", 0)",
          "1713:   assert.Error(t, err)",
          "1714:   assert.Equal(t, \"\", r)",
          "1715:  })",
          "1716:  t.Run(\"Error because too nested symlink\", func(t *testing.T) {",
          "1717:   r, err := resolveSymbolicLinkRecursive(\"bam\", 2)",
          "1718:   assert.Error(t, err)",
          "1719:   assert.Equal(t, \"\", r)",
          "1720:  })",
          "1721:  t.Run(\"No such file or directory\", func(t *testing.T) {",
          "1722:   r, err := resolveSymbolicLinkRecursive(\"foobar\", 2)",
          "1723:   assert.NoError(t, err)",
          "1724:   assert.Equal(t, \"foobar\", r)",
          "1725:  })",
          "1726: }",
          "1728: func Test_isURLSchemeAllowed(t *testing.T) {",
          "1729:  type testdata struct {",
          "1730:   name     string",
          "1731:   scheme   string",
          "1732:   allowed  []string",
          "1733:   expected bool",
          "1734:  }",
          "1735:  var tts []testdata = []testdata{",
          "1736:   {",
          "1737:    name:     \"Allowed scheme matches\",",
          "1738:    scheme:   \"http\",",
          "1739:    allowed:  []string{\"http\", \"https\"},",
          "1740:    expected: true,",
          "1741:   },",
          "1742:   {",
          "1743:    name:     \"Allowed scheme matches only partially\",",
          "1744:    scheme:   \"http\",",
          "1745:    allowed:  []string{\"https\"},",
          "1746:    expected: false,",
          "1747:   },",
          "1748:   {",
          "1749:    name:     \"Scheme is not allowed\",",
          "1750:    scheme:   \"file\",",
          "1751:    allowed:  []string{\"http\", \"https\"},",
          "1752:    expected: false,",
          "1753:   },",
          "1754:   {",
          "1755:    name:     \"Empty scheme with valid allowances is forbidden\",",
          "1756:    scheme:   \"\",",
          "1757:    allowed:  []string{\"http\", \"https\"},",
          "1758:    expected: false,",
          "1759:   },",
          "1760:   {",
          "1761:    name:     \"Empty scheme with empty allowances is forbidden\",",
          "1762:    scheme:   \"\",",
          "1763:    allowed:  []string{},",
          "1764:    expected: false,",
          "1765:   },",
          "1766:   {",
          "1767:    name:     \"Some scheme with empty allowances is forbidden\",",
          "1768:    scheme:   \"file\",",
          "1769:    allowed:  []string{},",
          "1770:    expected: false,",
          "1771:   },",
          "1772:  }",
          "1773:  for _, tt := range tts {",
          "1774:   t.Run(tt.name, func(t *testing.T) {",
          "1775:    r := isURLSchemeAllowed(tt.scheme, tt.allowed)",
          "1776:    assert.Equal(t, tt.expected, r)",
          "1777:   })",
          "1778:  }",
          "1779: }",
          "1781: func Test_resolveHelmValueFilePath(t *testing.T) {",
          "1782:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "1783:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/bim.yaml\", allowedHelmRemoteProtocols)",
          "1784:   assert.NoError(t, err)",
          "1785:   assert.False(t, remote)",
          "1786:   assert.Equal(t, \"/foo/bar/baz/bim.yaml\", p)",
          "1787:  })",
          "1788:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "1789:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../bim.yaml\", allowedHelmRemoteProtocols)",
          "1790:   assert.NoError(t, err)",
          "1791:   assert.False(t, remote)",
          "1792:   assert.Equal(t, \"/foo/bim.yaml\", p)",
          "1793:  })",
          "1794:  t.Run(\"Error on path resolving outside repository root\", func(t *testing.T) {",
          "1795:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../../bim.yaml\", allowedHelmRemoteProtocols)",
          "1796:   assert.Error(t, err)",
          "1797:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1798:   assert.False(t, remote)",
          "1799:   assert.Equal(t, \"\", p)",
          "1800:  })",
          "1801:  t.Run(\"Return verbatim URL\", func(t *testing.T) {",
          "1802:   url := \"https://some.where/foo,yaml\"",
          "1803:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
          "1804:   assert.NoError(t, err)",
          "1805:   assert.True(t, remote)",
          "1806:   assert.Equal(t, url, p)",
          "1807:  })",
          "1808:  t.Run(\"URL scheme not allowed\", func(t *testing.T) {",
          "1809:   url := \"file:///some.where/foo,yaml\"",
          "1810:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
          "1811:   assert.Error(t, err)",
          "1812:   assert.False(t, remote)",
          "1813:   assert.Equal(t, \"\", p)",
          "1814:  })",
          "1815:  t.Run(\"Implicit URL by absolute path\", func(t *testing.T) {",
          "1816:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
          "1817:   assert.NoError(t, err)",
          "1818:   assert.False(t, remote)",
          "1819:   assert.Equal(t, \"/foo/baz.yaml\", p)",
          "1820:  })",
          "1821:  t.Run(\"Relative app path\", func(t *testing.T) {",
          "1822:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
          "1823:   assert.NoError(t, err)",
          "1824:   assert.False(t, remote)",
          "1825:   assert.Equal(t, \"/foo/baz.yaml\", p)",
          "1826:  })",
          "1827:  t.Run(\"Relative repo path\", func(t *testing.T) {",
          "1828:   c, err := os.Getwd()",
          "1829:   require.NoError(t, err)",
          "1830:   p, remote, err := resolveHelmValueFilePath(\".\", \".\", \"baz.yaml\", allowedHelmRemoteProtocols)",
          "1831:   assert.NoError(t, err)",
          "1832:   assert.False(t, remote)",
          "1833:   assert.Equal(t, c+\"/baz.yaml\", p)",
          "1834:  })",
          "1835:  t.Run(\"Overlapping root prefix without trailing slash\", func(t *testing.T) {",
          "1836:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
          "1837:   assert.Error(t, err)",
          "1838:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1839:   assert.False(t, remote)",
          "1840:   assert.Equal(t, \"\", p)",
          "1841:  })",
          "1842:  t.Run(\"Overlapping root prefix with trailing slash\", func(t *testing.T) {",
          "1843:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
          "1844:   assert.Error(t, err)",
          "1845:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1846:   assert.False(t, remote)",
          "1847:   assert.Equal(t, \"\", p)",
          "1848:  })",
          "1849:  t.Run(\"Garbage input as values file\", func(t *testing.T) {",
          "1850:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"kfdj\\\\ks&&&321209.,---e32908923%$\u00a7!\\\"\", allowedHelmRemoteProtocols)",
          "1851:   assert.Error(t, err)",
          "1852:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1853:   assert.False(t, remote)",
          "1854:   assert.Equal(t, \"\", p)",
          "1855:  })",
          "1856:  t.Run(\"NUL-byte path input as values file\", func(t *testing.T) {",
          "1857:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"\\000\", allowedHelmRemoteProtocols)",
          "1858:   assert.Error(t, err)",
          "1859:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1860:   assert.False(t, remote)",
          "1861:   assert.Equal(t, \"\", p)",
          "1862:  })",
          "1863: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b7d9f0071b2ae5f490695b7c6e6655ffbadc0a1a",
      "candidate_info": {
        "commit_hash": "b7d9f0071b2ae5f490695b7c6e6655ffbadc0a1a",
        "repo": "argoproj/argo-cd",
        "commit_url": "https://github.com/argoproj/argo-cd/commit/b7d9f0071b2ae5f490695b7c6e6655ffbadc0a1a",
        "files": [
          "reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go",
          "reposerver/repository/testdata/symlinks/bam",
          "reposerver/repository/testdata/symlinks/bar",
          "reposerver/repository/testdata/symlinks/baz",
          "reposerver/repository/testdata/symlinks/foo"
        ],
        "message": "Merge pull request from GHSA-63qx-x74g-jcr7\n\nSigned-off-by: jannfis <jann@mistrust.net>",
        "before_after_code_files": [
          "reposerver/repository/repository.go||reposerver/repository/repository.go",
          "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ],
          "candidate": [
            "reposerver/repository/repository.go||reposerver/repository/repository.go",
            "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go"
          ]
        }
      },
      "candidate_diff": {
        "reposerver/repository/repository.go||reposerver/repository/repository.go": [
          "File: reposerver/repository/repository.go -> reposerver/repository/repository.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:  \"github.com/argoproj/argo-cd/v2/util/ksonnet\"",
          "50:  argokube \"github.com/argoproj/argo-cd/v2/util/kube\"",
          "51:  \"github.com/argoproj/argo-cd/v2/util/kustomize\"",
          "53:  \"github.com/argoproj/argo-cd/v2/util/text\"",
          "54: )",
          "",
          "[Removed Lines]",
          "52:  \"github.com/argoproj/argo-cd/v2/util/security\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "62:  ociPrefix                      = \"oci://\"",
          "63: )",
          "66: type Service struct {",
          "67:  repoLock                  *repositoryLock",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "65: var allowedHelmRemoteProtocols = []string{\"http\", \"https\"}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "544:  return ioutil.WriteFile(markerFile, []byte(\"marker\"), 0644)",
          "545: }",
          "547: func helmTemplate(appPath string, repoRoot string, env *v1alpha1.Env, q *apiclient.ManifestRequest, isLocal bool) ([]*unstructured.Unstructured, error) {",
          "548:  concurrencyAllowed := isConcurrencyAllowed(appPath)",
          "549:  if !concurrencyAllowed {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "552: func resolveSymbolicLinkRecursive(path string, maxDepth int) (string, error) {",
          "553:  resolved, err := os.Readlink(path)",
          "554:  if err != nil {",
          "556:   _, ok := err.(*os.PathError)",
          "557:   if ok {",
          "558:    return path, nil",
          "559:   }",
          "561:   return \"\", err",
          "562:  }",
          "564:  if maxDepth == 0 {",
          "565:   return \"\", fmt.Errorf(\"maximum nesting level reached\")",
          "566:  }",
          "568:  return resolveSymbolicLinkRecursive(resolved, maxDepth-1)",
          "569: }",
          "573: func isURLSchemeAllowed(scheme string, allowed []string) bool {",
          "574:  isAllowed := false",
          "575:  if len(allowed) > 0 {",
          "576:   for _, s := range allowed {",
          "577:    if strings.EqualFold(scheme, s) {",
          "578:     isAllowed = true",
          "579:     break",
          "580:    }",
          "581:   }",
          "582:  }",
          "585:  return isAllowed && scheme != \"\"",
          "586: }",
          "617: func resolveHelmValueFilePath(appPath, repoRoot, valueFile string, allowedURLSchemes []string) (resolvedPath string, isRemote bool, err error) {",
          "622:  resolveFailure := func(path string, err error) error {",
          "623:   log.Errorf(\"failed to resolve path '%s': %v\", path, err)",
          "624:   return fmt.Errorf(\"internal error: failed to resolve path. Check logs for more details\")",
          "625:  }",
          "629:  url, err := url.Parse(valueFile)",
          "630:  if err == nil {",
          "632:   if url.Scheme != \"\" {",
          "633:    if isURLSchemeAllowed(url.Scheme, allowedURLSchemes) {",
          "634:     return valueFile, true, nil",
          "635:    } else {",
          "636:     return \"\", false, fmt.Errorf(\"the URL scheme '%s' is not allowed\", url.Scheme)",
          "637:    }",
          "638:   }",
          "639:  }",
          "642:  absRepoPath, err := filepath.Abs(repoRoot)",
          "643:  if err != nil {",
          "644:   return \"\", false, resolveFailure(repoRoot, err)",
          "645:  }",
          "649:  path := valueFile",
          "650:  if !filepath.IsAbs(path) {",
          "651:   absWorkDir, err := filepath.Abs(appPath)",
          "652:   if err != nil {",
          "653:    return \"\", false, resolveFailure(repoRoot, err)",
          "654:   }",
          "655:   path = filepath.Join(absWorkDir, path)",
          "656:  } else {",
          "657:   path = filepath.Join(absRepoPath, path)",
          "658:  }",
          "661:  delinkedPath, err := resolveSymbolicLinkRecursive(path, 10)",
          "662:  if err != nil {",
          "663:   return \"\", false, resolveFailure(path, err)",
          "664:  }",
          "665:  path = delinkedPath",
          "668:  path, err = filepath.Abs(path)",
          "669:  if err != nil {",
          "670:   return \"\", false, resolveFailure(path, err)",
          "671:  }",
          "675:  requiredRootPath := absRepoPath",
          "676:  if !strings.HasSuffix(requiredRootPath, \"/\") {",
          "677:   requiredRootPath += \"/\"",
          "678:  }",
          "681:  if !strings.HasPrefix(path, requiredRootPath) {",
          "682:   return \"\", false, fmt.Errorf(\"value file '%s' resolved to outside repository root\", valueFile)",
          "683:  }",
          "685:  return path, false, nil",
          "687: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "572:   }",
          "574:   for _, val := range appHelm.ValueFiles {",
          "598:    }",
          "600:   }",
          "602:   if appHelm.Values != \"\" {",
          "",
          "[Removed Lines]",
          "576:    if _, err := url.ParseRequestURI(val); err != nil {",
          "579:     absRepoPath, err := filepath.Abs(repoRoot)",
          "580:     if err != nil {",
          "581:      return nil, err",
          "582:     }",
          "585:     path := val",
          "586:     if !filepath.IsAbs(path) {",
          "587:      absWorkDir, err := filepath.Abs(appPath)",
          "588:      if err != nil {",
          "589:       return nil, err",
          "590:      }",
          "591:      path = filepath.Join(absWorkDir, path)",
          "592:     }",
          "594:     _, err = security.EnforceToCurrentRoot(absRepoPath, path)",
          "595:     if err != nil {",
          "596:      return nil, err",
          "597:     }",
          "599:    templateOpts.Values = append(templateOpts.Values, val)",
          "",
          "[Added Lines]",
          "719:    path, _, err := resolveHelmValueFilePath(appPath, repoRoot, val, allowedHelmRemoteProtocols)",
          "720:    if err != nil {",
          "721:     return nil, err",
          "724:    templateOpts.Values = append(templateOpts.Values, path)",
          "",
          "---------------"
        ],
        "reposerver/repository/repository_test.go||reposerver/repository/repository_test.go": [
          "File: reposerver/repository/repository_test.go -> reposerver/repository/repository_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "726:  }",
          "727:  request := &apiclient.ManifestRequest{Repo: &argoappv1.Repository{}, ApplicationSource: source, NoCache: true}",
          "728:  _, err := service.GenerateManifest(context.Background(), request)",
          "730: }",
          "732: func TestGenerateHelmWithURL(t *testing.T) {",
          "",
          "[Removed Lines]",
          "729:  assert.Error(t, err, \"should be on or under current directory\")",
          "",
          "[Added Lines]",
          "729:  assert.Error(t, err)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "751: func TestGenerateHelmWithValuesDirectoryTraversalOutsideRepo(t *testing.T) {",
          "761:    },",
          "763:  })",
          "775:    },",
          "777:  })",
          "779: }",
          "",
          "[Removed Lines]",
          "752:  service := newService(\"../..\")",
          "753:  _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "754:   Repo:    &argoappv1.Repository{},",
          "755:   AppName: \"test\",",
          "756:   ApplicationSource: &argoappv1.ApplicationSource{",
          "757:    Path: \"./util/helm/testdata/redis\",",
          "758:    Helm: &argoappv1.ApplicationSourceHelm{",
          "759:     ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
          "760:     Values:     `cluster: {slaveCount: 2}`,",
          "762:   },",
          "764:  assert.Error(t, err, \"should be on or under current directory\")",
          "766:  service = newService(\"./testdata/my-chart\")",
          "767:  _, err = service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "768:   Repo:    &argoappv1.Repository{},",
          "769:   AppName: \"test\",",
          "770:   ApplicationSource: &argoappv1.ApplicationSource{",
          "771:    Path: \".\",",
          "772:    Helm: &argoappv1.ApplicationSourceHelm{",
          "773:     ValueFiles: []string{\"../my-chart-2/values.yaml\"},",
          "774:     Values:     `cluster: {slaveCount: 2}`,",
          "776:   },",
          "778:  assert.Error(t, err, \"should be on or under current directory\")",
          "",
          "[Added Lines]",
          "752:  t.Run(\"Values file with relative path pointing outside repo root\", func(t *testing.T) {",
          "753:   service := newService(\"../..\")",
          "754:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "755:    Repo:    &argoappv1.Repository{},",
          "756:    AppName: \"test\",",
          "757:    ApplicationSource: &argoappv1.ApplicationSource{",
          "758:     Path: \"./util/helm/testdata/redis\",",
          "759:     Helm: &argoappv1.ApplicationSourceHelm{",
          "760:      ValueFiles: []string{\"../../../../../minio/values.yaml\"},",
          "761:      Values:     `cluster: {slaveCount: 2}`,",
          "762:     },",
          "764:   })",
          "765:   assert.Error(t, err)",
          "766:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "769:  t.Run(\"Values file with relative path pointing inside repo root\", func(t *testing.T) {",
          "770:   service := newService(\"./testdata/my-chart\")",
          "771:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "772:    Repo:    &argoappv1.Repository{},",
          "773:    AppName: \"test\",",
          "774:    ApplicationSource: &argoappv1.ApplicationSource{",
          "775:     Path: \".\",",
          "776:     Helm: &argoappv1.ApplicationSourceHelm{",
          "777:      ValueFiles: []string{\"../my-chart/my-chart-values.yaml\"},",
          "778:      Values:     `cluster: {slaveCount: 2}`,",
          "779:     },",
          "781:   })",
          "782:   assert.NoError(t, err)",
          "783:  })",
          "785:  t.Run(\"Values file with absolute path stays within repo root\", func(t *testing.T) {",
          "786:   service := newService(\"./testdata/my-chart\")",
          "787:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "788:    Repo:    &argoappv1.Repository{},",
          "789:    AppName: \"test\",",
          "790:    ApplicationSource: &argoappv1.ApplicationSource{",
          "791:     Path: \".\",",
          "792:     Helm: &argoappv1.ApplicationSourceHelm{",
          "793:      ValueFiles: []string{\"/my-chart-values.yaml\"},",
          "794:      Values:     `cluster: {slaveCount: 2}`,",
          "795:     },",
          "796:    },",
          "797:   })",
          "798:   assert.NoError(t, err)",
          "799:  })",
          "801:  t.Run(\"Values file with absolute path using back-references outside repo root\", func(t *testing.T) {",
          "802:   service := newService(\"./testdata/my-chart\")",
          "803:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "804:    Repo:    &argoappv1.Repository{},",
          "805:    AppName: \"test\",",
          "806:    ApplicationSource: &argoappv1.ApplicationSource{",
          "807:     Path: \".\",",
          "808:     Helm: &argoappv1.ApplicationSourceHelm{",
          "809:      ValueFiles: []string{\"/../../../my-chart-values.yaml\"},",
          "810:      Values:     `cluster: {slaveCount: 2}`,",
          "811:     },",
          "812:    },",
          "813:   })",
          "814:   assert.Error(t, err)",
          "815:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "816:  })",
          "818:  t.Run(\"Remote values file from forbidden protocol\", func(t *testing.T) {",
          "819:   service := newService(\"./testdata/my-chart\")",
          "820:   _, err := service.GenerateManifest(context.Background(), &apiclient.ManifestRequest{",
          "821:    Repo:    &argoappv1.Repository{},",
          "822:    AppName: \"test\",",
          "823:    ApplicationSource: &argoappv1.ApplicationSource{",
          "824:     Path: \".\",",
          "825:     Helm: &argoappv1.ApplicationSourceHelm{",
          "826:      ValueFiles: []string{\"file://../../../../my-chart-values.yaml\"},",
          "827:      Values:     `cluster: {slaveCount: 2}`,",
          "828:     },",
          "829:    },",
          "830:   })",
          "831:   assert.Error(t, err)",
          "832:   assert.Contains(t, err.Error(), \"is not allowed\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1559:  assert.Equal(t, repos[0].Repo, repo1)",
          "1560:  assert.Equal(t, repos[1].Repo, repo2)",
          "1561: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1618: func Test_resolveSymlinkRecursive(t *testing.T) {",
          "1619:  cwd, err := os.Getwd()",
          "1620:  require.NoError(t, err)",
          "1621:  err = os.Chdir(\"testdata/symlinks\")",
          "1622:  require.NoError(t, err)",
          "1623:  defer func() {",
          "1624:   err := os.Chdir(cwd)",
          "1625:   if err != nil {",
          "1626:    panic(err)",
          "1627:   }",
          "1628:  }()",
          "1629:  t.Run(\"Resolve non-symlink\", func(t *testing.T) {",
          "1630:   r, err := resolveSymbolicLinkRecursive(\"foo\", 2)",
          "1631:   assert.NoError(t, err)",
          "1632:   assert.Equal(t, \"foo\", r)",
          "1633:  })",
          "1634:  t.Run(\"Successfully resolve symlink\", func(t *testing.T) {",
          "1635:   r, err := resolveSymbolicLinkRecursive(\"bar\", 2)",
          "1636:   assert.NoError(t, err)",
          "1637:   assert.Equal(t, \"foo\", r)",
          "1638:  })",
          "1639:  t.Run(\"Do not allow symlink at all\", func(t *testing.T) {",
          "1640:   r, err := resolveSymbolicLinkRecursive(\"bar\", 0)",
          "1641:   assert.Error(t, err)",
          "1642:   assert.Equal(t, \"\", r)",
          "1643:  })",
          "1644:  t.Run(\"Error because too nested symlink\", func(t *testing.T) {",
          "1645:   r, err := resolveSymbolicLinkRecursive(\"bam\", 2)",
          "1646:   assert.Error(t, err)",
          "1647:   assert.Equal(t, \"\", r)",
          "1648:  })",
          "1649:  t.Run(\"No such file or directory\", func(t *testing.T) {",
          "1650:   r, err := resolveSymbolicLinkRecursive(\"foobar\", 2)",
          "1651:   assert.NoError(t, err)",
          "1652:   assert.Equal(t, \"foobar\", r)",
          "1653:  })",
          "1654: }",
          "1656: func Test_isURLSchemeAllowed(t *testing.T) {",
          "1657:  type testdata struct {",
          "1658:   name     string",
          "1659:   scheme   string",
          "1660:   allowed  []string",
          "1661:   expected bool",
          "1662:  }",
          "1663:  var tts []testdata = []testdata{",
          "1664:   {",
          "1665:    name:     \"Allowed scheme matches\",",
          "1666:    scheme:   \"http\",",
          "1667:    allowed:  []string{\"http\", \"https\"},",
          "1668:    expected: true,",
          "1669:   },",
          "1670:   {",
          "1671:    name:     \"Allowed scheme matches only partially\",",
          "1672:    scheme:   \"http\",",
          "1673:    allowed:  []string{\"https\"},",
          "1674:    expected: false,",
          "1675:   },",
          "1676:   {",
          "1677:    name:     \"Scheme is not allowed\",",
          "1678:    scheme:   \"file\",",
          "1679:    allowed:  []string{\"http\", \"https\"},",
          "1680:    expected: false,",
          "1681:   },",
          "1682:   {",
          "1683:    name:     \"Empty scheme with valid allowances is forbidden\",",
          "1684:    scheme:   \"\",",
          "1685:    allowed:  []string{\"http\", \"https\"},",
          "1686:    expected: false,",
          "1687:   },",
          "1688:   {",
          "1689:    name:     \"Empty scheme with empty allowances is forbidden\",",
          "1690:    scheme:   \"\",",
          "1691:    allowed:  []string{},",
          "1692:    expected: false,",
          "1693:   },",
          "1694:   {",
          "1695:    name:     \"Some scheme with empty allowances is forbidden\",",
          "1696:    scheme:   \"file\",",
          "1697:    allowed:  []string{},",
          "1698:    expected: false,",
          "1699:   },",
          "1700:  }",
          "1701:  for _, tt := range tts {",
          "1702:   t.Run(tt.name, func(t *testing.T) {",
          "1703:    r := isURLSchemeAllowed(tt.scheme, tt.allowed)",
          "1704:    assert.Equal(t, tt.expected, r)",
          "1705:   })",
          "1706:  }",
          "1707: }",
          "1709: func Test_resolveHelmValueFilePath(t *testing.T) {",
          "1710:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "1711:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/bim.yaml\", allowedHelmRemoteProtocols)",
          "1712:   assert.NoError(t, err)",
          "1713:   assert.False(t, remote)",
          "1714:   assert.Equal(t, \"/foo/bar/baz/bim.yaml\", p)",
          "1715:  })",
          "1716:  t.Run(\"Resolve normal relative path into absolute path\", func(t *testing.T) {",
          "1717:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../bim.yaml\", allowedHelmRemoteProtocols)",
          "1718:   assert.NoError(t, err)",
          "1719:   assert.False(t, remote)",
          "1720:   assert.Equal(t, \"/foo/bim.yaml\", p)",
          "1721:  })",
          "1722:  t.Run(\"Error on path resolving outside repository root\", func(t *testing.T) {",
          "1723:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"baz/../../../bim.yaml\", allowedHelmRemoteProtocols)",
          "1724:   assert.Error(t, err)",
          "1725:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1726:   assert.False(t, remote)",
          "1727:   assert.Equal(t, \"\", p)",
          "1728:  })",
          "1729:  t.Run(\"Return verbatim URL\", func(t *testing.T) {",
          "1730:   url := \"https://some.where/foo,yaml\"",
          "1731:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
          "1732:   assert.NoError(t, err)",
          "1733:   assert.True(t, remote)",
          "1734:   assert.Equal(t, url, p)",
          "1735:  })",
          "1736:  t.Run(\"URL scheme not allowed\", func(t *testing.T) {",
          "1737:   url := \"file:///some.where/foo,yaml\"",
          "1738:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", url, allowedHelmRemoteProtocols)",
          "1739:   assert.Error(t, err)",
          "1740:   assert.False(t, remote)",
          "1741:   assert.Equal(t, \"\", p)",
          "1742:  })",
          "1743:  t.Run(\"Implicit URL by absolute path\", func(t *testing.T) {",
          "1744:   p, remote, err := resolveHelmValueFilePath(\"/foo/bar\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
          "1745:   assert.NoError(t, err)",
          "1746:   assert.False(t, remote)",
          "1747:   assert.Equal(t, \"/foo/baz.yaml\", p)",
          "1748:  })",
          "1749:  t.Run(\"Relative app path\", func(t *testing.T) {",
          "1750:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"/baz.yaml\", allowedHelmRemoteProtocols)",
          "1751:   assert.NoError(t, err)",
          "1752:   assert.False(t, remote)",
          "1753:   assert.Equal(t, \"/foo/baz.yaml\", p)",
          "1754:  })",
          "1755:  t.Run(\"Relative repo path\", func(t *testing.T) {",
          "1756:   c, err := os.Getwd()",
          "1757:   require.NoError(t, err)",
          "1758:   p, remote, err := resolveHelmValueFilePath(\".\", \".\", \"baz.yaml\", allowedHelmRemoteProtocols)",
          "1759:   assert.NoError(t, err)",
          "1760:   assert.False(t, remote)",
          "1761:   assert.Equal(t, c+\"/baz.yaml\", p)",
          "1762:  })",
          "1763:  t.Run(\"Overlapping root prefix without trailing slash\", func(t *testing.T) {",
          "1764:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
          "1765:   assert.Error(t, err)",
          "1766:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1767:   assert.False(t, remote)",
          "1768:   assert.Equal(t, \"\", p)",
          "1769:  })",
          "1770:  t.Run(\"Overlapping root prefix with trailing slash\", func(t *testing.T) {",
          "1771:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"../foo2/baz.yaml\", allowedHelmRemoteProtocols)",
          "1772:   assert.Error(t, err)",
          "1773:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1774:   assert.False(t, remote)",
          "1775:   assert.Equal(t, \"\", p)",
          "1776:  })",
          "1777:  t.Run(\"Garbage input as values file\", func(t *testing.T) {",
          "1778:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"kfdj\\\\ks&&&321209.,---e32908923%$\u00a7!\\\"\", allowedHelmRemoteProtocols)",
          "1779:   assert.Error(t, err)",
          "1780:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1781:   assert.False(t, remote)",
          "1782:   assert.Equal(t, \"\", p)",
          "1783:  })",
          "1784:  t.Run(\"NUL-byte path input as values file\", func(t *testing.T) {",
          "1785:   p, remote, err := resolveHelmValueFilePath(\".\", \"/foo/\", \"\\000\", allowedHelmRemoteProtocols)",
          "1786:   assert.Error(t, err)",
          "1787:   assert.Contains(t, err.Error(), \"outside repository root\")",
          "1788:   assert.False(t, remote)",
          "1789:   assert.Equal(t, \"\", p)",
          "1790:  })",
          "1791: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}