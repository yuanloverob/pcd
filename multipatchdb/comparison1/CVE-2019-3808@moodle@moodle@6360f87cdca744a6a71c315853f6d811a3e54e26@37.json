{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5a552ad6f3595a351b997f8d79f61566e9cb6008",
      "candidate_info": {
        "commit_hash": "5a552ad6f3595a351b997f8d79f61566e9cb6008",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5a552ad6f3595a351b997f8d79f61566e9cb6008",
        "files": [
          "lib/db/upgrade.php",
          "lib/moodlelib.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-66551-37' of git://github.com/lameze/moodle into MOODLE_37_STABLE",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/moodlelib.php||lib/moodlelib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3396:         upgrade_main_savepoint(true, 2019052001.12);",
          "3397:     }",
          "3399:     return true;",
          "3400: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3399:     if ($oldversion < 2019052001.13) {",
          "3401:         $sql = \"SELECT DISTINCT es.userid",
          "3402:                   FROM {event_subscriptions} es",
          "3403:              LEFT JOIN {user} u ON u.id = es.userid",
          "3404:                  WHERE u.deleted = 1 OR u.id IS NULL\";",
          "3405:         $deletedusers = $DB->get_field_sql($sql);",
          "3406:         if ($deletedusers) {",
          "3407:             list($sql, $params) = $DB->get_in_or_equal($deletedusers);",
          "3410:             $DB->execute(\"DELETE FROM {event_subscriptions} WHERE userid \" . $sql, $params);",
          "3411:         }",
          "3413:         upgrade_main_savepoint(true, 2019052001.13);",
          "3414:     }",
          "",
          "---------------"
        ],
        "lib/moodlelib.php||lib/moodlelib.php": [
          "File: lib/moodlelib.php -> lib/moodlelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4217:     $DB->delete_records('cohort_members', array('userid' => $user->id));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4217:     $DB->delete_records('event_subscriptions', ['userid' => $user->id]);",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052001.12;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2019052001.13;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b63a3b04b154990497bd58255b4ed579d37b432a",
      "candidate_info": {
        "commit_hash": "b63a3b04b154990497bd58255b4ed579d37b432a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b63a3b04b154990497bd58255b4ed579d37b432a",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018030800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180308)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018031600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180316)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "df4a17c7ed8c320f1369b9b8fdfd1af7de163e9c",
      "candidate_info": {
        "commit_hash": "df4a17c7ed8c320f1369b9b8fdfd1af7de163e9c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/df4a17c7ed8c320f1369b9b8fdfd1af7de163e9c",
        "files": [
          "admin/settings/subsystems.php",
          "lang/en/admin.php",
          "lib/db/upgrade.php",
          "message/externallib.php",
          "message/lib.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-64093_master' of git://github.com/markn86/moodle",
        "before_after_code_files": [
          "admin/settings/subsystems.php||admin/settings/subsystems.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "message/externallib.php||message/externallib.php",
          "message/lib.php||message/lib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/subsystems.php||admin/settings/subsystems.php": [
          "File: admin/settings/subsystems.php -> admin/settings/subsystems.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "21:         0)",
          "22:     );",
          "24:     $options = array(",
          "25:         DAYSECS => new lang_string('secondstotime86400'),",
          "26:         WEEKSECS => new lang_string('secondstotime604800'),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24:     $optionalsubsystems->add(new admin_setting_configcheckbox('messagingdefaultpressenter',",
          "25:         new lang_string('messagingdefaultpressenter', 'admin'),",
          "26:         new lang_string('configmessagingdefaultpressenter', 'admin'),",
          "27:         1)",
          "28:     );",
          "",
          "---------------"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "279: $string['configmaxevents'] = 'Events to Lookahead';",
          "280: $string['configmessaging'] = 'If enabled, users can send messages to other users on the site.';",
          "281: $string['configmessagingallowemailoverride'] = 'Allow users to have email message notifications sent to an email address other than the email address in their profile';",
          "282: $string['configmessagingdeletereadnotificationsdelay'] = 'Read notifications can be deleted to save space. How long after a notification is read can it be deleted?';",
          "283: $string['configmessagingdeleteallnotificationsdelay'] = 'Read and unread notifications can be deleted to save space. How long after a notification is created can it be deleted?';",
          "284: $string['configmessagingallusers'] = 'If enabled, users can view the list of all users on the site when selecting someone to message, and their message preferences include the option to accept messages from anyone on the site. If disabled, users can only view the list of users in their courses, and they have just two options in message preferences - to accept messages from their contacts only, or their contacts and anyone in their courses.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "282: $string['configmessagingdefaultpressenter'] = 'Whether \\'Use enter to send\\' is enabled by default in users\\' messaging settings.';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "772: $string['messaging'] = 'Enable messaging system';",
          "773: $string['messagingallowemailoverride'] = 'Notification email override';",
          "774: $string['messagingallusers'] = 'Allow site-wide messaging';",
          "775: $string['messagingdeletereadnotificationsdelay'] = 'Delete read notifications';",
          "776: $string['messagingdeleteallnotificationsdelay'] = 'Delete all notifications';",
          "777: $string['minpassworddigits'] = 'Digits';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "776: $string['messagingdefaultpressenter'] = 'Use enter to send enabled by default';",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2728:         upgrade_main_savepoint(true, 2019021500.01);",
          "2729:     }",
          "2731:     return true;",
          "2732: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2731:     if ($oldversion < 2019021500.02) {",
          "2733:         set_config('messagingdefaultpressenter', false);",
          "2736:         upgrade_main_savepoint(true, 2019021500.02);",
          "2737:     }",
          "",
          "---------------"
        ],
        "message/externallib.php||message/externallib.php": [
          "File: message/externallib.php -> message/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4162:     public static function get_user_message_preferences($userid = 0) {",
          "4165:         $params = self::validate_parameters(",
          "4166:             self::get_user_message_preferences_parameters(),",
          "",
          "[Removed Lines]",
          "4163:         global $PAGE;",
          "",
          "[Added Lines]",
          "4163:         global $CFG, $PAGE;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4190:         $renderer = $PAGE->get_renderer('core_message');",
          "4192:         $result = array(",
          "4193:             'warnings' => array(),",
          "4194:             'preferences' => $notificationlistoutput->export_for_template($renderer),",
          "4195:             'blocknoncontacts' => \\core_message\\api::get_user_privacy_messaging_preference($user->id),",
          "4197:         );",
          "4198:         return $result;",
          "4199:     }",
          "",
          "[Removed Lines]",
          "4196:             'entertosend' => get_user_preferences('message_entertosend', false, $user)",
          "",
          "[Added Lines]",
          "4192:         $entertosend = get_user_preferences('message_entertosend', $CFG->messagingdefaultpressenter, $user);",
          "4198:             'entertosend' => $entertosend",
          "",
          "---------------"
        ],
        "message/lib.php||message/lib.php": [
          "File: message/lib.php -> message/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "842:     }",
          "847:     return $renderer->render_from_template('core_message/message_drawer', [",
          "848:         'contactrequestcount' => $requestcount,",
          "",
          "[Removed Lines]",
          "845:     $entertosend = get_user_preferences('message_entertosend', false, $USER);",
          "",
          "[Added Lines]",
          "845:     $entertosend = get_user_preferences('message_entertosend', $CFG->messagingdefaultpressenter, $USER);",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019021500.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019021500.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0180369b27227357fbc815e4774bfa4241bcb537",
      "candidate_info": {
        "commit_hash": "0180369b27227357fbc815e4774bfa4241bcb537",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0180369b27227357fbc815e4774bfa4241bcb537",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018071300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180713)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018072000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180720)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f3507273e9f5eb05bb05c24f390d2fc8bf2dcf0a",
      "candidate_info": {
        "commit_hash": "f3507273e9f5eb05bb05c24f390d2fc8bf2dcf0a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f3507273e9f5eb05bb05c24f390d2fc8bf2dcf0a",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.8dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019060600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190530)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019060600.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190606)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}