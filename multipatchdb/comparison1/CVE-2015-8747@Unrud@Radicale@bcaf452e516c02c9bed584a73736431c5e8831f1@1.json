{
  "cve_id": "CVE-2015-8747",
  "cve_desc": "The multifilesystem storage backend in Radicale before 1.1 allows remote attackers to read or write to arbitrary files via a crafted component name.",
  "repo": "Unrud/Radicale",
  "patch_hash": "bcaf452e516c02c9bed584a73736431c5e8831f1",
  "patch_info": {
    "commit_hash": "bcaf452e516c02c9bed584a73736431c5e8831f1",
    "repo": "Unrud/Radicale",
    "commit_url": "https://github.com/Unrud/Radicale/commit/bcaf452e516c02c9bed584a73736431c5e8831f1",
    "files": [
      "radicale/storage/multifilesystem.py"
    ],
    "message": "Convert component names safely to filenames Component names are controlled by the user and without this checks access to arbitrary files is possible if the multifilesystem backend is used.",
    "before_after_code_files": [
      "radicale/storage/multifilesystem.py||radicale/storage/multifilesystem.py"
    ]
  },
  "patch_diff": {
    "radicale/storage/multifilesystem.py||radicale/storage/multifilesystem.py": [
      "File: radicale/storage/multifilesystem.py -> radicale/storage/multifilesystem.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "53:             name = (",
      "54:                 component.name if sys.version_info[0] >= 3 else",
      "55:                 component.name.encode(filesystem.FILESYSTEM_ENCODING))",
      "56:             filesystem_path = os.path.join(self._filesystem_path, name)",
      "57:             with filesystem.open(filesystem_path, \"w\") as fd:",
      "58:                 fd.write(text)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "56:             if not pathutils.is_safe_filesystem_path_component(name):",
      "57:                 log.LOGGER.debug(",
      "58:                     \"Can't tranlate name safely to filesystem, \"",
      "59:                     \"skipping component: %s\", name)",
      "60:                 continue",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "62:         os.remove(self._props_path)",
      "64:     def remove(self, name):",
      "65:         filesystem_path = os.path.join(self._filesystem_path, name)",
      "66:         if os.path.exists(filesystem_path):",
      "67:             os.remove(filesystem_path)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "70:         if not pathutils.is_safe_filesystem_path_component(name):",
      "71:             log.LOGGER.debug(",
      "72:                 \"Can't tranlate name safely to filesystem, \"",
      "73:                 \"skipping component: %s\", name)",
      "74:             return",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ee095a463d997eed30232e4a8e25ca3ef2acea1a",
      "candidate_info": {
        "commit_hash": "ee095a463d997eed30232e4a8e25ca3ef2acea1a",
        "repo": "Unrud/Radicale",
        "commit_url": "https://github.com/Unrud/Radicale/commit/ee095a463d997eed30232e4a8e25ca3ef2acea1a",
        "files": [
          "radicale/__init__.py"
        ],
        "message": "Improve URI sanitation The old implementation failed to sanitize URIs like \".\", \"..\", \"../..\" or \"//\"",
        "before_after_code_files": [
          "radicale/__init__.py||radicale/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/Kozea/Radicale/pull/343"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "radicale/__init__.py||radicale/__init__.py": [
          "File: radicale/__init__.py -> radicale/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "178:     @staticmethod",
          "179:     def sanitize_uri(uri):",
          "181:         uri = unquote(uri)",
          "182:         trailing_slash = \"/\" if uri.endswith(\"/\") else \"\"",
          "183:         uri = posixpath.normpath(uri)",
          "187:     def collect_allowed_items(self, items, user):",
          "188:         \"\"\"Get items from request that user is allowed to access.\"\"\"",
          "",
          "[Removed Lines]",
          "180:         \"\"\"Unquote and remove /../ to prevent access to other data.\"\"\"",
          "184:         trailing_slash = \"\" if uri == \"/\" else trailing_slash",
          "185:         return uri + trailing_slash",
          "",
          "[Added Lines]",
          "180:         \"\"\"Unquote and make absolute to prevent access to other data.\"\"\"",
          "184:         new_uri = \"/\"",
          "185:         for part in uri.split(\"/\"):",
          "186:             if not part or part in (\".\", \"..\"):",
          "187:                 continue",
          "188:             new_uri = posixpath.join(new_uri, part)",
          "189:         trailing_slash = \"\" if new_uri.endswith(\"/\") else trailing_slash",
          "190:         return new_uri + trailing_slash",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ed44830447224d13fb2d2639cf1297e41ec5c511",
      "candidate_info": {
        "commit_hash": "ed44830447224d13fb2d2639cf1297e41ec5c511",
        "repo": "Unrud/Radicale",
        "commit_url": "https://github.com/Unrud/Radicale/commit/ed44830447224d13fb2d2639cf1297e41ec5c511",
        "files": [
          "radicale/__init__.py"
        ],
        "message": "Error message if path not starting with prefix Before the program crashed implicitly",
        "before_after_code_files": [
          "radicale/__init__.py||radicale/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/Kozea/Radicale/pull/343"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "radicale/__init__.py||radicale/__init__.py": [
          "File: radicale/__init__.py -> radicale/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "265:             # Request path not starting with base_prefix, not allowed",
          "266:             log.LOGGER.debug(",
          "267:                 \"Path not starting with prefix: %s\", environ[\"PATH_INFO\"])",
          "270:         # Sanitize request URI",
          "271:         environ[\"PATH_INFO\"] = self.sanitize_uri(environ[\"PATH_INFO\"])",
          "",
          "[Removed Lines]",
          "268:             environ[\"PATH_INFO\"] = None",
          "",
          "[Added Lines]",
          "268:             status, headers, _ = NOT_ALLOWED",
          "269:             start_response(status, list(headers.items()))",
          "270:             return []",
          "",
          "---------------"
        ]
      }
    }
  ]
}