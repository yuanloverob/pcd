{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "327914160ffb82a5d57292af2140c3055db12c06",
      "candidate_info": {
        "commit_hash": "327914160ffb82a5d57292af2140c3055db12c06",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/327914160ffb82a5d57292af2140c3055db12c06",
        "files": [
          "config-dist.php",
          "lib/db/upgrade.php",
          "lib/upgrade.txt",
          "version.php"
        ],
        "message": "MDL-63214 message: Add setting to force enabling messagingallusers",
        "before_after_code_files": [
          "config-dist.php||config-dist.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "config-dist.php||config-dist.php": [
          "File: config-dist.php -> config-dist.php"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2337:         upgrade_main_savepoint(true, 2018091200.00);",
          "2338:     }",
          "2356:     if ($oldversion < 2018091700.01) {",
          "2358:         unset_config('messaginghidereadnotifications');",
          "",
          "[Removed Lines]",
          "2340:     if ($oldversion < 2018091400.01) {",
          "2341:         if (!isset($CFG->messagingallusers)) {",
          "2343:             if (isset($CFG->messaging)) {",
          "2344:                 set_config('messagingallusers', $CFG->messaging);",
          "2345:             } else {",
          "2348:                 set_config('messagingallusers', 1);",
          "2349:             }",
          "2350:         }",
          "2353:         upgrade_main_savepoint(true, 2018091400.01);",
          "2354:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2524:         upgrade_main_savepoint(true, 2018092800.03);",
          "2525:     }",
          "2527:     return true;",
          "2528: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2511:     if ($oldversion < 2018101100.01) {",
          "2512:         if (empty($CFG->keepmessagingallusersenabled)) {",
          "2516:             set_config('messagingallusers', false);",
          "2517:         } else {",
          "2521:             set_config('messagingallusers', true);",
          "2522:         }",
          "2525:         upgrade_main_savepoint(true, 2018101100.01);",
          "2526:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018101600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018101600.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6902f3914188aa2a3767624c5d9b8e6ac76d8a63",
      "candidate_info": {
        "commit_hash": "6902f3914188aa2a3767624c5d9b8e6ac76d8a63",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6902f3914188aa2a3767624c5d9b8e6ac76d8a63",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018091700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180914)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018092000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180920)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7bb22a298c4eebeafd1bb51f616867c8c1f19b07",
      "candidate_info": {
        "commit_hash": "7bb22a298c4eebeafd1bb51f616867c8c1f19b07",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/7bb22a298c4eebeafd1bb51f616867c8c1f19b07",
        "files": [
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-64307 core: set all individual conversations to enabled",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2874:         upgrade_main_savepoint(true, 2018120300.01);",
          "2875:     }",
          "2877:     return true;",
          "2878: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2877:     if ($oldversion < 2018120300.02) {",
          "2879:         $updatesql = \"UPDATE {message_conversations}",
          "2880:                          SET enabled = :enabled",
          "2881:                        WHERE type = :type\";",
          "2882:         $DB->execute($updatesql, ['enabled' => 1, 'type' => 1]);",
          "2884:         upgrade_main_savepoint(true, 2018120300.02);",
          "2885:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018120300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018120300.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0e133245ab5b1a4fd0037b2856f1554853bc8ae0",
      "candidate_info": {
        "commit_hash": "0e133245ab5b1a4fd0037b2856f1554853bc8ae0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0e133245ab5b1a4fd0037b2856f1554853bc8ae0",
        "files": [
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-64506 upgrade: Add upgrade steps to remove BS2 themes.",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2888:         upgrade_main_savepoint(true, 2019032900.01);",
          "2889:     }",
          "2891:     return true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2889:      }",
          "2891:     if ($oldversion < 2019040200.01) {",
          "2894:         $themes = array('theme_bootstrapbase' => 'bootstrapbase',",
          "2895:                 'theme_clean' => 'clean', 'theme_more' => 'more');",
          "2896:         foreach ($themes as $key => $theme) {",
          "2897:             if (check_dir_exists($CFG->dirroot . '/theme/' . $theme, false)) {",
          "2899:                 unset($themes[$key]);",
          "2900:             }",
          "2901:         }",
          "2903:         if (count($themes) > 0) {",
          "2904:             list($insql, $inparams) = $DB->get_in_or_equal($themes, SQL_PARAMS_NAMED);",
          "2907:             $DB->set_field_select('course', 'theme', 'classic', \"theme $insql\", $inparams);",
          "2908:             $DB->set_field_select('course_categories', 'theme', 'classic', \"theme $insql\", $inparams);",
          "2909:             $DB->set_field_select('user', 'theme', 'classic', \"theme $insql\", $inparams);",
          "2910:             $DB->set_field_select('mnet_host', 'theme', 'classic', \"theme $insql\", $inparams);",
          "2911:             $DB->set_field_select('cohort', 'theme', 'classic', \"theme $insql\", $inparams);",
          "2914:             if (in_array(get_config('core', 'theme'), $themes)) {",
          "2915:                 set_config('theme', 'classic');",
          "2916:             }",
          "2917:             if (in_array(get_config('core', 'thememobile'), $themes)) {",
          "2918:                 set_config('thememobile', 'classic');",
          "2919:             }",
          "2920:             if (in_array(get_config('core', 'themelegacy'), $themes)) {",
          "2921:                 set_config('themelegacy', 'classic');",
          "2922:             }",
          "2923:             if (in_array(get_config('core', 'themetablet'), $themes)) {",
          "2924:                 set_config('themetablet', 'classic');",
          "2925:             }",
          "2928:             foreach ($themes as $key => $theme) {",
          "2929:                 unset_all_config_for_plugin($key);",
          "2930:             }",
          "2931:         }",
          "2934:         upgrade_main_savepoint(true, 2019040200.01);",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019040200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019040200.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cbc3833d275e6c56a389a04c2cbbcb7871831a1e",
      "candidate_info": {
        "commit_hash": "cbc3833d275e6c56a389a04c2cbbcb7871831a1e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/cbc3833d275e6c56a389a04c2cbbcb7871831a1e",
        "files": [
          "admin/settings/subsystems.php",
          "lang/en/admin.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-63333 core: removed unused setting 'messaginghidereadnotifications'",
        "before_after_code_files": [
          "admin/settings/subsystems.php||admin/settings/subsystems.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/subsystems.php||admin/settings/subsystems.php": [
          "File: admin/settings/subsystems.php -> admin/settings/subsystems.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "16:     $optionalsubsystems->add(new admin_setting_configcheckbox('messaging', new lang_string('messaging', 'admin'), new lang_string('configmessaging','admin'), 1));",
          "20:     $options = array(DAYSECS=>new lang_string('secondstotime86400'), WEEKSECS=>new lang_string('secondstotime604800'), 2620800=>new lang_string('nummonths', 'moodle', 1), 15724800=>new lang_string('nummonths', 'moodle', 6),0=>new lang_string('never'));",
          "21:     $optionalsubsystems->add(new admin_setting_configselect('messagingdeletereadnotificationsdelay', new lang_string('messagingdeletereadnotificationsdelay', 'admin'), new lang_string('configmessagingdeletereadnotificationsdelay', 'admin'), 604800, $options));",
          "",
          "[Removed Lines]",
          "18:     $optionalsubsystems->add(new admin_setting_configcheckbox('messaginghidereadnotifications', new lang_string('messaginghidereadnotifications', 'admin'), new lang_string('configmessaginghidereadnotifications','admin'), 0));",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "274: $string['configmaxevents'] = 'Events to Lookahead';",
          "275: $string['configmessaging'] = 'Should the messaging system between site users be enabled?';",
          "276: $string['configmessagingallowemailoverride'] = 'Allow users to have email message notifications sent to an email address other than the email address in their profile';",
          "278: $string['configmessagingdeletereadnotificationsdelay'] = 'Read notifications can be deleted to save space. How long after a notification is read can it be deleted?';",
          "279: $string['configminpassworddigits'] = 'Passwords must have at least these many digits.';",
          "280: $string['configminpasswordlength'] = 'Passwords must be at least these many characters long.';",
          "",
          "[Removed Lines]",
          "277: $string['configmessaginghidereadnotifications'] = 'Hide read notifications of events like forum posts when viewing messaging history';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "747: $string['mediapluginyoutube'] = 'Enable YouTube links filter';",
          "748: $string['messaging'] = 'Enable messaging system';",
          "749: $string['messagingallowemailoverride'] = 'Notification email override';",
          "751: $string['messagingdeletereadnotificationsdelay'] = 'Delete read notifications';",
          "752: $string['minpassworddigits'] = 'Digits';",
          "753: $string['minpasswordlength'] = 'Password length';",
          "",
          "[Removed Lines]",
          "750: $string['messaginghidereadnotifications'] = 'Hide read notifications';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2336:         upgrade_main_savepoint(true, 2018091200.00);",
          "2337:     }",
          "2339:     return true;",
          "2340: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2339:     if ($oldversion < 2018091700.00) {",
          "2341:         unset_config('messaginghidereadnotifications');",
          "2344:         upgrade_main_savepoint(true, 2018091700.00);",
          "2345:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018091400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018091700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}