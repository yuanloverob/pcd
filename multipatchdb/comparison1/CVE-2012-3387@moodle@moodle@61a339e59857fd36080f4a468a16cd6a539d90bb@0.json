{
  "cve_id": "CVE-2012-3387",
  "cve_desc": "Moodle 2.3.x before 2.3.1 uses only a client-side check for whether references are permitted in a file upload, which allows remote authenticated users to bypass intended alias (aka shortcut) restrictions via a client that omits this check.",
  "repo": "moodle/moodle",
  "patch_hash": "61a339e59857fd36080f4a468a16cd6a539d90bb",
  "patch_info": {
    "commit_hash": "61a339e59857fd36080f4a468a16cd6a539d90bb",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/61a339e59857fd36080f4a468a16cd6a539d90bb",
    "files": [
      "mod/forum/lib.php",
      "mod/forum/post.php",
      "mod/forum/post_form.php"
    ],
    "message": "MDL-33948 mod_forum correctly passes files options to file_save_draft_area_files()",
    "before_after_code_files": [
      "mod/forum/lib.php||mod/forum/lib.php",
      "mod/forum/post.php||mod/forum/post.php",
      "mod/forum/post_form.php||mod/forum/post_form.php"
    ]
  },
  "patch_diff": {
    "mod/forum/lib.php||mod/forum/lib.php": [
      "File: mod/forum/lib.php -> mod/forum/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: require_once($CFG->libdir.'/filelib.php');",
      "28: require_once($CFG->libdir.'/eventslib.php');",
      "29: require_once($CFG->dirroot.'/user/selector/lib.php');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "30: require_once($CFG->dirroot.'/mod/forum/post_form.php');",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "99:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
      "100:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
      "103:             $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
      "104:         }",
      "105:     }",
      "",
      "[Removed Lines]",
      "102:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "103:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
      "104:                     mod_forum_post_form::attachment_options($forum), $post->message);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "196:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
      "197:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
      "200:         }",
      "202:         $post->subject       = $forum->name;",
      "",
      "[Removed Lines]",
      "199:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "201:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
      "202:                     mod_forum_post_form::editor_options(), $post->message);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "4231:     $info = file_get_draft_area_info($post->attachments);",
      "4232:     $present = ($info['filecount']>0) ? '1' : '';",
      "4235:     $DB->set_field('forum_posts', 'attachment', $present, array('id'=>$post->id));",
      "",
      "[Removed Lines]",
      "4233:     file_save_draft_area_files($post->attachments, $context->id, 'mod_forum', 'attachment', $post->id);",
      "",
      "[Added Lines]",
      "4236:     file_save_draft_area_files($post->attachments, $context->id, 'mod_forum', 'attachment', $post->id,",
      "4237:             mod_forum_post_form::attachment_options($forum));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "4262:     $post->attachment = \"\";",
      "4264:     $post->id = $DB->insert_record(\"forum_posts\", $post);",
      "4266:     $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
      "4267:     forum_add_attachment($post, $forum, $cm, $mform, $message);",
      "",
      "[Removed Lines]",
      "4265:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "4269:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id,",
      "4270:             mod_forum_post_form::editor_options(), $post->message);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "4308:         $discussion->timestart = $post->timestart;",
      "4309:         $discussion->timeend   = $post->timeend;",
      "4310:     }",
      "4312:     $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
      "4314:     $DB->update_record('forum_discussions', $discussion);",
      "",
      "[Removed Lines]",
      "4311:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "4316:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id,",
      "4317:             mod_forum_post_form::editor_options(), $post->message);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "4372:     if (!empty($cm->id) && !empty($discussion->itemid)) {   // In \"single simple discussions\" this may not exist yet",
      "4373:         $context = get_context_instance(CONTEXT_MODULE, $cm->id);",
      "4375:         $DB->set_field('forum_posts', 'message', $text, array('id'=>$post->id));",
      "4376:     }",
      "",
      "[Removed Lines]",
      "4374:         $text = file_save_draft_area_files($discussion->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "4380:         $text = file_save_draft_area_files($discussion->itemid, $context->id, 'mod_forum', 'post', $post->id,",
      "4381:                 mod_forum_post_form::editor_options(), $post->message);",
      "",
      "---------------"
    ],
    "mod/forum/post.php||mod/forum/post.php": [
      "File: mod/forum/post.php -> mod/forum/post.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "510: $mform_post = new mod_forum_post_form('post.php', array('course'=>$course, 'cm'=>$cm, 'coursecontext'=>$coursecontext, 'modcontext'=>$modcontext, 'forum'=>$forum, 'post'=>$post));",
      "512: $draftitemid = file_get_submitted_draft_itemid('attachments');",
      "",
      "[Removed Lines]",
      "513: file_prepare_draft_area($draftitemid, $modcontext->id, 'mod_forum', 'attachment', empty($post->id)?null:$post->id);",
      "",
      "[Added Lines]",
      "513: file_prepare_draft_area($draftitemid, $modcontext->id, 'mod_forum', 'attachment', empty($post->id)?null:$post->id, mod_forum_post_form::attachment_options($forum));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "550: }",
      "552: $draftid_editor = file_get_submitted_draft_itemid('message');",
      "554: $mform_post->set_data(array(        'attachments'=>$draftitemid,",
      "555:                                     'general'=>$heading,",
      "556:                                     'subject'=>$post->subject,",
      "",
      "[Removed Lines]",
      "553: $currenttext = file_prepare_draft_area($draftid_editor, $modcontext->id, 'mod_forum', 'post', empty($post->id) ? null : $post->id, array('subdirs'=>true), $post->message);",
      "",
      "[Added Lines]",
      "553: $currenttext = file_prepare_draft_area($draftid_editor, $modcontext->id, 'mod_forum', 'post', empty($post->id) ? null : $post->id, mod_forum_post_form::editor_options(), $post->message);",
      "",
      "---------------"
    ],
    "mod/forum/post_form.php||mod/forum/post_form.php": [
      "File: mod/forum/post_form.php -> mod/forum/post_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: class mod_forum_post_form extends moodleform {",
      "32:     function definition() {",
      "34:         global $CFG;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "38:     public static function attachment_options($forum) {",
      "39:         global $COURSE, $PAGE, $CFG;",
      "40:         $maxbytes = get_user_max_upload_file_size($PAGE->context, $CFG->maxbytes, $COURSE->maxbytes, $forum->maxbytes);",
      "41:         return array(",
      "42:             'subdirs' => 0,",
      "43:             'maxbytes' => $maxbytes,",
      "44:             'maxfiles' => $forum->maxattachments,",
      "45:             'accepted_types' => '*',",
      "46:             'return_types' => FILE_INTERNAL",
      "47:         );",
      "48:     }",
      "55:     public static function editor_options() {",
      "56:         global $COURSE, $PAGE, $CFG;",
      "58:         $maxbytes = get_user_max_upload_file_size($PAGE->context, $CFG->maxbytes, $COURSE->maxbytes);",
      "59:         return array(",
      "60:             'maxfiles' => EDITOR_UNLIMITED_FILES,",
      "61:             'maxbytes' => $maxbytes,",
      "62:             'trusttext'=> true,",
      "63:             'return_types'=> FILE_INTERNAL | FILE_EXTERNAL",
      "64:         );",
      "65:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "40:         $modcontext    = $this->_customdata['modcontext'];",
      "41:         $forum         = $this->_customdata['forum'];",
      "42:         $post          = $this->_customdata['post'];",
      "51:         $mform->addElement('header', 'general', '');//fill in the data depending on page params later using set_data",
      "52:         $mform->addElement('text', 'subject', get_string('subject', 'forum'), 'size=\"48\"');",
      "",
      "[Removed Lines]",
      "44:         if ($forum->maxbytes == '0') {",
      "45:             $forum->maxbytes = $course->maxbytes;",
      "46:         }",
      "48:         $editoroptions = array('maxfiles' => EDITOR_UNLIMITED_FILES, 'trusttext'=>true,",
      "49:             'context'=>$modcontext, 'return_types'=>FILE_INTERNAL | FILE_EXTERNAL);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "54:         $mform->addRule('subject', get_string('required'), 'required', null, 'client');",
      "55:         $mform->addRule('subject', get_string('maximumchars', '', 255), 'maxlength', 255, 'client');",
      "58:         $mform->setType('message', PARAM_RAW);",
      "59:         $mform->addRule('message', get_string('required'), 'required', null, 'client');",
      "",
      "[Removed Lines]",
      "57:         $mform->addElement('editor', 'message', get_string('message', 'forum'), null, $editoroptions);",
      "",
      "[Added Lines]",
      "85:         $mform->addElement('editor', 'message', get_string('message', 'forum'), null, self::editor_options());",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "82:             }",
      "84:         if (!empty($forum->maxattachments) && $forum->maxbytes != 1 && has_capability('mod/forum:createattachment', $modcontext))  {  //  1 = No attachments at all",
      "91:             $mform->addHelpButton('attachments', 'attachment', 'forum');",
      "92:         }",
      "",
      "[Removed Lines]",
      "85:             $mform->addElement('filemanager', 'attachments', get_string('attachment', 'forum'), null,",
      "86:                 array('subdirs'=>0,",
      "87:                       'maxbytes'=>$forum->maxbytes,",
      "88:                       'maxfiles'=>$forum->maxattachments,",
      "89:                       'accepted_types'=>'*',",
      "90:                       'return_types'=>FILE_INTERNAL));",
      "",
      "[Added Lines]",
      "113:             $mform->addElement('filemanager', 'attachments', get_string('attachment', 'forum'), null, self::attachment_options($forum));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a11aa38e80c3751b4107a4a87d7838c26a63b437",
      "candidate_info": {
        "commit_hash": "a11aa38e80c3751b4107a4a87d7838c26a63b437",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a11aa38e80c3751b4107a4a87d7838c26a63b437",
        "files": [
          "mod/forum/lib.php"
        ],
        "message": "MDL-37111 copy first post files in single type forum using intro options\n\nThis patch also removed the delete button from the first post in single\ndiscussion type forum.\n\nEdit button in the first post leads to the forum edit page now, this should\nprevent other problems throwing first post and intro out of sync.",
        "before_after_code_files": [
          "mod/forum/lib.php||mod/forum/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/lib.php||mod/forum/lib.php"
          ],
          "candidate": [
            "mod/forum/lib.php||mod/forum/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:         $discussion->id = forum_add_discussion($discussion, null, $message);",
          "98:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "100:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "101:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "105:             $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
          "106:         }",
          "107:     }",
          "",
          "[Removed Lines]",
          "103:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "104:                     mod_forum_post_form::attachment_options($forum), $post->message);",
          "",
          "[Added Lines]",
          "103:             $options = array('subdirs'=>true); // Use the same options as intro field!",
          "104:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, $options, $post->message);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "187:         $cm         = get_coursemodule_from_instance('forum', $forum->id);",
          "188:         $modcontext = context_module::instance($cm->id, MUST_EXIST);",
          "199:         $post->subject       = $forum->name;",
          "200:         $post->message       = $forum->intro;",
          "201:         $post->messageformat = $forum->introformat;",
          "202:         $post->messagetrust  = trusttext_trusted($modcontext);",
          "203:         $post->modified      = $forum->timemodified;",
          "206:         $DB->update_record('forum_posts', $post);",
          "207:         $discussion->name = $forum->name;",
          "",
          "[Removed Lines]",
          "190:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "192:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "193:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "195:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "196:                     mod_forum_post_form::editor_options(), $post->message);",
          "197:         }",
          "204:         $post->userid        = $USER->id;    // MDL-18599, so that current teacher can take ownership of activities",
          "",
          "[Added Lines]",
          "190:         $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "196:         $post->userid        = $USER->id;    // MDL-18599, so that current teacher can take ownership of activities.",
          "198:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "200:             $options = array('subdirs'=>true); // Use the same options as intro field!",
          "201:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, $options, $post->message);",
          "202:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3327:     if (!$post->parent && $forum->type == 'news' && $discussion->timestart > time()) {",
          "3328:         $age = 0;",
          "3329:     }",
          "3331:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('edit'=>$post->id)), 'text'=>$str->edit);",
          "3332:     }",
          "",
          "[Removed Lines]",
          "3330:     if (($ownpost && $age < $CFG->maxeditingtime) || $cm->cache->caps['mod/forum:editanypost']) {",
          "",
          "[Added Lines]",
          "3329:     if ($forum->type == 'single' and $discussion->firstpost == $post->id) {",
          "3330:         if (has_capability('moodle/course:manageactivities', $modcontext)) {",
          "3332:             $commands[] = array('url'=>new moodle_url('/course/modedit.php', array('update'=>$cm->id, 'sesskey'=>sesskey(), 'return'=>1)), 'text'=>$str->edit);",
          "3333:         }",
          "3334:     } else if (($ownpost && $age < $CFG->maxeditingtime) || $cm->cache->caps['mod/forum:editanypost']) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3335:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('prune'=>$post->id)), 'text'=>$str->prune, 'title'=>$str->pruneheading);",
          "3336:     }",
          "3339:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('delete'=>$post->id)), 'text'=>$str->delete);",
          "3340:     }",
          "",
          "[Removed Lines]",
          "3338:     if (($ownpost && $age < $CFG->maxeditingtime && $cm->cache->caps['mod/forum:deleteownpost']) || $cm->cache->caps['mod/forum:deleteanypost']) {",
          "",
          "[Added Lines]",
          "3342:     if ($forum->type == 'single' and $discussion->firstpost == $post->id) {",
          "3344:     } else if (($ownpost && $age < $CFG->maxeditingtime && $cm->cache->caps['mod/forum:deleteownpost']) || $cm->cache->caps['mod/forum:deleteanypost']) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "599e7fe00675ab5576daa313adedfd2013733cfa",
      "candidate_info": {
        "commit_hash": "599e7fe00675ab5576daa313adedfd2013733cfa",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/599e7fe00675ab5576daa313adedfd2013733cfa",
        "files": [
          "mod/forum/lib.php"
        ],
        "message": "MDL-37111 copy first post files in single type forum using intro options\n\nThis patch also removed the delete button from the first post in single\ndiscussion type forum.\n\nEdit button in the first post leads to the forum edit page now, this should\nprevent other problems throwing first post and intro out of sync.",
        "before_after_code_files": [
          "mod/forum/lib.php||mod/forum/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/lib.php||mod/forum/lib.php"
          ],
          "candidate": [
            "mod/forum/lib.php||mod/forum/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:         $discussion->id = forum_add_discussion($discussion, null, $message);",
          "98:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "100:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "101:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "105:             $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
          "106:         }",
          "107:     }",
          "",
          "[Removed Lines]",
          "103:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "104:                     mod_forum_post_form::attachment_options($forum), $post->message);",
          "",
          "[Added Lines]",
          "103:             $options = array('subdirs'=>true); // Use the same options as intro field!",
          "104:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, $options, $post->message);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "187:         $cm         = get_coursemodule_from_instance('forum', $forum->id);",
          "188:         $modcontext = context_module::instance($cm->id, MUST_EXIST);",
          "199:         $post->subject       = $forum->name;",
          "200:         $post->message       = $forum->intro;",
          "201:         $post->messageformat = $forum->introformat;",
          "202:         $post->messagetrust  = trusttext_trusted($modcontext);",
          "203:         $post->modified      = $forum->timemodified;",
          "206:         $DB->update_record('forum_posts', $post);",
          "207:         $discussion->name = $forum->name;",
          "",
          "[Removed Lines]",
          "190:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "192:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "193:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "195:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "196:                     mod_forum_post_form::editor_options(), $post->message);",
          "197:         }",
          "204:         $post->userid        = $USER->id;    // MDL-18599, so that current teacher can take ownership of activities",
          "",
          "[Added Lines]",
          "190:         $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "196:         $post->userid        = $USER->id;    // MDL-18599, so that current teacher can take ownership of activities.",
          "198:         if ($mform and $draftid = file_get_submitted_draft_itemid('introeditor')) {",
          "200:             $options = array('subdirs'=>true); // Use the same options as intro field!",
          "201:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, $options, $post->message);",
          "202:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3327:     if (!$post->parent && $forum->type == 'news' && $discussion->timestart > time()) {",
          "3328:         $age = 0;",
          "3329:     }",
          "3331:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('edit'=>$post->id)), 'text'=>$str->edit);",
          "3332:     }",
          "",
          "[Removed Lines]",
          "3330:     if (($ownpost && $age < $CFG->maxeditingtime) || $cm->cache->caps['mod/forum:editanypost']) {",
          "",
          "[Added Lines]",
          "3329:     if ($forum->type == 'single' and $discussion->firstpost == $post->id) {",
          "3330:         if (has_capability('moodle/course:manageactivities', $modcontext)) {",
          "3332:             $commands[] = array('url'=>new moodle_url('/course/modedit.php', array('update'=>$cm->id, 'sesskey'=>sesskey(), 'return'=>1)), 'text'=>$str->edit);",
          "3333:         }",
          "3334:     } else if (($ownpost && $age < $CFG->maxeditingtime) || $cm->cache->caps['mod/forum:editanypost']) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3335:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('prune'=>$post->id)), 'text'=>$str->prune, 'title'=>$str->pruneheading);",
          "3336:     }",
          "3339:         $commands[] = array('url'=>new moodle_url('/mod/forum/post.php', array('delete'=>$post->id)), 'text'=>$str->delete);",
          "3340:     }",
          "",
          "[Removed Lines]",
          "3338:     if (($ownpost && $age < $CFG->maxeditingtime && $cm->cache->caps['mod/forum:deleteownpost']) || $cm->cache->caps['mod/forum:deleteanypost']) {",
          "",
          "[Added Lines]",
          "3342:     if ($forum->type == 'single' and $discussion->firstpost == $post->id) {",
          "3344:     } else if (($ownpost && $age < $CFG->maxeditingtime && $cm->cache->caps['mod/forum:deleteownpost']) || $cm->cache->caps['mod/forum:deleteanypost']) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dff8438e5080f3bc4a9243bdd14139cfa39e2abe",
      "candidate_info": {
        "commit_hash": "dff8438e5080f3bc4a9243bdd14139cfa39e2abe",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/dff8438e5080f3bc4a9243bdd14139cfa39e2abe",
        "files": [
          "mod/forum/lib.php",
          "mod/forum/post.php",
          "mod/forum/post_form.php"
        ],
        "message": "MDL-33948 mod_forum correctly passes files options to file_save_draft_area_files()",
        "before_after_code_files": [
          "mod/forum/lib.php||mod/forum/lib.php",
          "mod/forum/post.php||mod/forum/post.php",
          "mod/forum/post_form.php||mod/forum/post_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/post.php||mod/forum/post.php",
            "mod/forum/post_form.php||mod/forum/post_form.php"
          ],
          "candidate": [
            "mod/forum/lib.php||mod/forum/lib.php",
            "mod/forum/post.php||mod/forum/post.php",
            "mod/forum/post_form.php||mod/forum/post_form.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/forum/lib.php||mod/forum/lib.php": [
          "File: mod/forum/lib.php -> mod/forum/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: require_once($CFG->libdir.'/filelib.php');",
          "28: require_once($CFG->libdir.'/eventslib.php');",
          "29: require_once($CFG->dirroot.'/user/selector/lib.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: require_once($CFG->dirroot.'/mod/forum/post_form.php');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "99:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "100:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "103:             $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
          "104:         }",
          "105:     }",
          "",
          "[Removed Lines]",
          "102:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "103:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "104:                     mod_forum_post_form::attachment_options($forum), $post->message);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "196:             $discussion = $DB->get_record('forum_discussions', array('id'=>$discussion->id), '*', MUST_EXIST);",
          "197:             $post = $DB->get_record('forum_posts', array('id'=>$discussion->firstpost), '*', MUST_EXIST);",
          "200:         }",
          "202:         $post->subject       = $forum->name;",
          "",
          "[Removed Lines]",
          "199:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "201:             $post->message = file_save_draft_area_files($draftid, $modcontext->id, 'mod_forum', 'post', $post->id,",
          "202:                     mod_forum_post_form::editor_options(), $post->message);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "4231:     $info = file_get_draft_area_info($post->attachments);",
          "4232:     $present = ($info['filecount']>0) ? '1' : '';",
          "4235:     $DB->set_field('forum_posts', 'attachment', $present, array('id'=>$post->id));",
          "",
          "[Removed Lines]",
          "4233:     file_save_draft_area_files($post->attachments, $context->id, 'mod_forum', 'attachment', $post->id);",
          "",
          "[Added Lines]",
          "4236:     file_save_draft_area_files($post->attachments, $context->id, 'mod_forum', 'attachment', $post->id,",
          "4237:             mod_forum_post_form::attachment_options($forum));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "4262:     $post->attachment = \"\";",
          "4264:     $post->id = $DB->insert_record(\"forum_posts\", $post);",
          "4266:     $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
          "4267:     forum_add_attachment($post, $forum, $cm, $mform, $message);",
          "",
          "[Removed Lines]",
          "4265:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "4269:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id,",
          "4270:             mod_forum_post_form::editor_options(), $post->message);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "4308:         $discussion->timestart = $post->timestart;",
          "4309:         $discussion->timeend   = $post->timeend;",
          "4310:     }",
          "4312:     $DB->set_field('forum_posts', 'message', $post->message, array('id'=>$post->id));",
          "4314:     $DB->update_record('forum_discussions', $discussion);",
          "",
          "[Removed Lines]",
          "4311:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "4316:     $post->message = file_save_draft_area_files($post->itemid, $context->id, 'mod_forum', 'post', $post->id,",
          "4317:             mod_forum_post_form::editor_options(), $post->message);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "4372:     if (!empty($cm->id) && !empty($discussion->itemid)) {   // In \"single simple discussions\" this may not exist yet",
          "4373:         $context = get_context_instance(CONTEXT_MODULE, $cm->id);",
          "4375:         $DB->set_field('forum_posts', 'message', $text, array('id'=>$post->id));",
          "4376:     }",
          "",
          "[Removed Lines]",
          "4374:         $text = file_save_draft_area_files($discussion->itemid, $context->id, 'mod_forum', 'post', $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "4380:         $text = file_save_draft_area_files($discussion->itemid, $context->id, 'mod_forum', 'post', $post->id,",
          "4381:                 mod_forum_post_form::editor_options(), $post->message);",
          "",
          "---------------"
        ],
        "mod/forum/post.php||mod/forum/post.php": [
          "File: mod/forum/post.php -> mod/forum/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "510: $mform_post = new mod_forum_post_form('post.php', array('course'=>$course, 'cm'=>$cm, 'coursecontext'=>$coursecontext, 'modcontext'=>$modcontext, 'forum'=>$forum, 'post'=>$post));",
          "512: $draftitemid = file_get_submitted_draft_itemid('attachments');",
          "",
          "[Removed Lines]",
          "513: file_prepare_draft_area($draftitemid, $modcontext->id, 'mod_forum', 'attachment', empty($post->id)?null:$post->id);",
          "",
          "[Added Lines]",
          "513: file_prepare_draft_area($draftitemid, $modcontext->id, 'mod_forum', 'attachment', empty($post->id)?null:$post->id, mod_forum_post_form::attachment_options($forum));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "550: }",
          "552: $draftid_editor = file_get_submitted_draft_itemid('message');",
          "554: $mform_post->set_data(array(        'attachments'=>$draftitemid,",
          "555:                                     'general'=>$heading,",
          "556:                                     'subject'=>$post->subject,",
          "",
          "[Removed Lines]",
          "553: $currenttext = file_prepare_draft_area($draftid_editor, $modcontext->id, 'mod_forum', 'post', empty($post->id) ? null : $post->id, array('subdirs'=>true), $post->message);",
          "",
          "[Added Lines]",
          "553: $currenttext = file_prepare_draft_area($draftid_editor, $modcontext->id, 'mod_forum', 'post', empty($post->id) ? null : $post->id, mod_forum_post_form::editor_options(), $post->message);",
          "",
          "---------------"
        ],
        "mod/forum/post_form.php||mod/forum/post_form.php": [
          "File: mod/forum/post_form.php -> mod/forum/post_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: class mod_forum_post_form extends moodleform {",
          "32:     function definition() {",
          "34:         global $CFG;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     public static function attachment_options($forum) {",
          "39:         global $COURSE, $PAGE, $CFG;",
          "40:         $maxbytes = get_user_max_upload_file_size($PAGE->context, $CFG->maxbytes, $COURSE->maxbytes, $forum->maxbytes);",
          "41:         return array(",
          "42:             'subdirs' => 0,",
          "43:             'maxbytes' => $maxbytes,",
          "44:             'maxfiles' => $forum->maxattachments,",
          "45:             'accepted_types' => '*',",
          "46:             'return_types' => FILE_INTERNAL",
          "47:         );",
          "48:     }",
          "55:     public static function editor_options() {",
          "56:         global $COURSE, $PAGE, $CFG;",
          "58:         $maxbytes = get_user_max_upload_file_size($PAGE->context, $CFG->maxbytes, $COURSE->maxbytes);",
          "59:         return array(",
          "60:             'maxfiles' => EDITOR_UNLIMITED_FILES,",
          "61:             'maxbytes' => $maxbytes,",
          "62:             'trusttext'=> true,",
          "63:             'return_types'=> FILE_INTERNAL | FILE_EXTERNAL",
          "64:         );",
          "65:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "40:         $modcontext    = $this->_customdata['modcontext'];",
          "41:         $forum         = $this->_customdata['forum'];",
          "42:         $post          = $this->_customdata['post'];",
          "51:         $mform->addElement('header', 'general', '');//fill in the data depending on page params later using set_data",
          "52:         $mform->addElement('text', 'subject', get_string('subject', 'forum'), 'size=\"48\"');",
          "",
          "[Removed Lines]",
          "44:         if ($forum->maxbytes == '0') {",
          "45:             $forum->maxbytes = $course->maxbytes;",
          "46:         }",
          "48:         $editoroptions = array('maxfiles' => EDITOR_UNLIMITED_FILES, 'trusttext'=>true,",
          "49:             'context'=>$modcontext, 'return_types'=>FILE_INTERNAL | FILE_EXTERNAL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "54:         $mform->addRule('subject', get_string('required'), 'required', null, 'client');",
          "55:         $mform->addRule('subject', get_string('maximumchars', '', 255), 'maxlength', 255, 'client');",
          "58:         $mform->setType('message', PARAM_RAW);",
          "59:         $mform->addRule('message', get_string('required'), 'required', null, 'client');",
          "",
          "[Removed Lines]",
          "57:         $mform->addElement('editor', 'message', get_string('message', 'forum'), null, $editoroptions);",
          "",
          "[Added Lines]",
          "85:         $mform->addElement('editor', 'message', get_string('message', 'forum'), null, self::editor_options());",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "82:             }",
          "84:         if (!empty($forum->maxattachments) && $forum->maxbytes != 1 && has_capability('mod/forum:createattachment', $modcontext))  {  //  1 = No attachments at all",
          "91:             $mform->addHelpButton('attachments', 'attachment', 'forum');",
          "92:         }",
          "",
          "[Removed Lines]",
          "85:             $mform->addElement('filemanager', 'attachments', get_string('attachment', 'forum'), null,",
          "86:                 array('subdirs'=>0,",
          "87:                       'maxbytes'=>$forum->maxbytes,",
          "88:                       'maxfiles'=>$forum->maxattachments,",
          "89:                       'accepted_types'=>'*',",
          "90:                       'return_types'=>FILE_INTERNAL));",
          "",
          "[Added Lines]",
          "113:             $mform->addElement('filemanager', 'attachments', get_string('attachment', 'forum'), null, self::attachment_options($forum));",
          "",
          "---------------"
        ]
      }
    }
  ]
}