{
  "cve_id": "CVE-2023-31287",
  "cve_desc": "An issue was discovered in Serenity Serene (and StartSharp) before 6.7.0. Password reset links are sent by email. A link contains a token that is used to reset the password. This token remains valid even after the password reset and can be used a second time to change the password of the corresponding user. The token expires only 3 hours after issuance and is sent as a query parameter when resetting. An attacker with access to the browser history can thus use the token again to change the password in order to take over the account.",
  "repo": "serenity-is/Serenity",
  "patch_hash": "11b9d267f840513d04b4f4d4876de7823a6e48d2",
  "patch_info": {
    "commit_hash": "11b9d267f840513d04b4f4d4876de7823a6e48d2",
    "repo": "serenity-is/Serenity",
    "commit_url": "https://github.com/serenity-is/Serenity/commit/11b9d267f840513d04b4f4d4876de7823a6e48d2",
    "files": [
      "CHANGELOG.md",
      "build/Package.Build.props"
    ],
    "message": ":up: 6.7.0",
    "before_after_code_files": [
      "build/Package.Build.props||build/Package.Build.props"
    ]
  },
  "patch_diff": {
    "build/Package.Build.props||build/Package.Build.props": [
      "File: build/Package.Build.props -> build/Package.Build.props",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: <Project>",
      "2:   <PropertyGroup>",
      "4:   </PropertyGroup>",
      "5: </Project>",
      "",
      "[Removed Lines]",
      "3:     <Version>6.6.6</Version>",
      "",
      "[Added Lines]",
      "3:     <Version>6.7.0</Version>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "20b77b65710ef77c3a54245d2f0fb3e732215d39",
      "candidate_info": {
        "commit_hash": "20b77b65710ef77c3a54245d2f0fb3e732215d39",
        "repo": "serenity-is/Serenity",
        "commit_url": "https://github.com/serenity-is/Serenity/commit/20b77b65710ef77c3a54245d2f0fb3e732215d39",
        "files": [
          "CHANGELOG.md",
          "build/Package.Build.props"
        ],
        "message": ":up: 6.8.2",
        "before_after_code_files": [
          "build/Package.Build.props||build/Package.Build.props"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "build/Package.Build.props||build/Package.Build.props"
          ],
          "candidate": [
            "build/Package.Build.props||build/Package.Build.props"
          ]
        }
      },
      "candidate_diff": {
        "build/Package.Build.props||build/Package.Build.props": [
          "File: build/Package.Build.props -> build/Package.Build.props",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <Project>",
          "2:   <PropertyGroup>",
          "4:   </PropertyGroup>",
          "5: </Project>",
          "",
          "[Removed Lines]",
          "3:     <Version>6.8.1</Version>",
          "",
          "[Added Lines]",
          "3:     <Version>6.8.2</Version>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d7e9eaa9fe358eafdff9cc8a740ac58878c27d37",
      "candidate_info": {
        "commit_hash": "d7e9eaa9fe358eafdff9cc8a740ac58878c27d37",
        "repo": "serenity-is/Serenity",
        "commit_url": "https://github.com/serenity-is/Serenity/commit/d7e9eaa9fe358eafdff9cc8a740ac58878c27d37",
        "files": [
          "CHANGELOG.md",
          "build/Package.Build.props"
        ],
        "message": ":up: 8.0.4",
        "before_after_code_files": [
          "build/Package.Build.props||build/Package.Build.props"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "build/Package.Build.props||build/Package.Build.props"
          ],
          "candidate": [
            "build/Package.Build.props||build/Package.Build.props"
          ]
        }
      },
      "candidate_diff": {
        "build/Package.Build.props||build/Package.Build.props": [
          "File: build/Package.Build.props -> build/Package.Build.props",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <Project>",
          "2:   <PropertyGroup>",
          "4:   </PropertyGroup>",
          "5: </Project>",
          "",
          "[Removed Lines]",
          "3:     <Version>8.0.3</Version>",
          "",
          "[Added Lines]",
          "3:     <Version>8.0.4</Version>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5859afe38f8289fa9c4791a46828f4882fae777a",
      "candidate_info": {
        "commit_hash": "5859afe38f8289fa9c4791a46828f4882fae777a",
        "repo": "serenity-is/Serenity",
        "commit_url": "https://github.com/serenity-is/Serenity/commit/5859afe38f8289fa9c4791a46828f4882fae777a",
        "files": [
          "build/Package.Build.props"
        ],
        "message": ":up: 6.3.1",
        "before_after_code_files": [
          "build/Package.Build.props||build/Package.Build.props"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "build/Package.Build.props||build/Package.Build.props"
          ],
          "candidate": [
            "build/Package.Build.props||build/Package.Build.props"
          ]
        }
      },
      "candidate_diff": {
        "build/Package.Build.props||build/Package.Build.props": [
          "File: build/Package.Build.props -> build/Package.Build.props",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <Project>",
          "2:   <PropertyGroup>",
          "4:   </PropertyGroup>",
          "5: </Project>",
          "",
          "[Removed Lines]",
          "3:     <Version>6.3.0</Version>",
          "",
          "[Added Lines]",
          "3:     <Version>6.3.1</Version>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5af3513439a03a99be84b96c0473702eb63ca084",
      "candidate_info": {
        "commit_hash": "5af3513439a03a99be84b96c0473702eb63ca084",
        "repo": "serenity-is/Serenity",
        "commit_url": "https://github.com/serenity-is/Serenity/commit/5af3513439a03a99be84b96c0473702eb63ca084",
        "files": [
          "CHANGELOG.md",
          "build/Package.Build.props"
        ],
        "message": ":up: 6.5.3",
        "before_after_code_files": [
          "build/Package.Build.props||build/Package.Build.props"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "build/Package.Build.props||build/Package.Build.props"
          ],
          "candidate": [
            "build/Package.Build.props||build/Package.Build.props"
          ]
        }
      },
      "candidate_diff": {
        "build/Package.Build.props||build/Package.Build.props": [
          "File: build/Package.Build.props -> build/Package.Build.props",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <Project>",
          "2:   <PropertyGroup>",
          "4:   </PropertyGroup>",
          "5: </Project>",
          "",
          "[Removed Lines]",
          "3:     <Version>6.5.2</Version>",
          "",
          "[Added Lines]",
          "3:     <Version>6.5.3</Version>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "524195abf4051b349afca2c0bfb8dc04680bc240",
      "candidate_info": {
        "commit_hash": "524195abf4051b349afca2c0bfb8dc04680bc240",
        "repo": "serenity-is/Serenity",
        "commit_url": "https://github.com/serenity-is/Serenity/commit/524195abf4051b349afca2c0bfb8dc04680bc240",
        "files": [
          "CHANGELOG.md",
          "build/Package.Build.props",
          "src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs",
          "src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs",
          "src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs",
          "src/Serenity.Net.Core/Helpers/StringHelper.cs",
          "src/Serenity.Net.Services/Upload/UploadFormatting.cs",
          "src/Serenity.Net.Web/Upload/FileUploadBehavior.cs",
          "src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs",
          "src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs",
          "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs",
          "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs"
        ],
        "message": "renamed ISanitizeFilenamePlaceholder to IFilenameFormatSanitizer and made it possible to inject it via DI",
        "before_after_code_files": [
          "build/Package.Build.props||build/Package.Build.props",
          "src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs||src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs",
          "src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs||src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs",
          "src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs||src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs",
          "src/Serenity.Net.Core/Helpers/StringHelper.cs||src/Serenity.Net.Core/Helpers/StringHelper.cs",
          "src/Serenity.Net.Services/Upload/UploadFormatting.cs||src/Serenity.Net.Services/Upload/UploadFormatting.cs",
          "src/Serenity.Net.Web/Upload/FileUploadBehavior.cs||src/Serenity.Net.Web/Upload/FileUploadBehavior.cs",
          "src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs||src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs",
          "src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs||src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs",
          "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs||tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs",
          "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs||tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "build/Package.Build.props||build/Package.Build.props"
          ],
          "candidate": [
            "build/Package.Build.props||build/Package.Build.props"
          ]
        }
      },
      "candidate_diff": {
        "build/Package.Build.props||build/Package.Build.props": [
          "File: build/Package.Build.props -> build/Package.Build.props",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <Project>",
          "2:   <PropertyGroup>",
          "4:   </PropertyGroup>",
          "5: </Project>",
          "",
          "[Removed Lines]",
          "3:     <Version>6.4.0</Version>",
          "",
          "[Added Lines]",
          "3:     <Version>6.4.1</Version>",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs||src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs": [
          "File: src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs -> src/Serenity.Net.Core/ComponentModel/Upload/DefaultFilenameFormatSanitizer.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: \ufeffnamespace Serenity.ComponentModel;",
          "6: public class DefaultFilenameFormatSanitizer : IFilenameFormatSanitizer",
          "7: {",
          "11:     public static readonly IFilenameFormatSanitizer Instance = new DefaultFilenameFormatSanitizer();",
          "22:     public virtual string SanitizePlaceholder(string _, string value)",
          "23:     {",
          "24:         value = StringHelper.SanitizeFilename((value ?? \"\").Replace('\\\\', '/'));",
          "25:         value = value.Replace(\"..\", \"_\", StringComparison.Ordinal);",
          "26:         if (string.IsNullOrWhiteSpace(value))",
          "27:             value = \"_\";",
          "28:         while (value.EndsWith(\".\", StringComparison.Ordinal))",
          "29:             value = value[..^1] + \"_\";",
          "30:         return value;",
          "31:     }",
          "40:     public virtual string SanitizeResult(string result)",
          "41:     {",
          "42:         if (string.IsNullOrEmpty(result))",
          "43:             return result;",
          "45:         result = result.Replace('\\\\', '/');",
          "47:         while (result.IndexOf(\"//\", StringComparison.Ordinal) >= 0)",
          "48:             result = result.Replace(\"//\", \"/_/\", StringComparison.Ordinal);",
          "50:         return result;",
          "51:     }",
          "52: }",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs||src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs": [
          "File: src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs -> src/Serenity.Net.Core/ComponentModel/Upload/IFilenameFormatSanitizer.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: \ufeffnamespace Serenity.ComponentModel;",
          "10: public interface IFilenameFormatSanitizer",
          "11: {",
          "17:     string SanitizePlaceholder(string key, string value);",
          "25:     string SanitizeResult(string result);",
          "26: }",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs||src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs": [
          "File: src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs -> src/Serenity.Net.Core/ComponentModel/Upload/ISanitizeFilenamePlaceholder.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Core/Helpers/StringHelper.cs||src/Serenity.Net.Core/Helpers/StringHelper.cs": [
          "File: src/Serenity.Net.Core/Helpers/StringHelper.cs -> src/Serenity.Net.Core/Helpers/StringHelper.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: \ufeffusing System.Collections;",
          "3: namespace Serenity",
          "4: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: using System.IO;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "300:         }",
          "309:         {",
          "319:         }",
          "",
          "[Removed Lines]",
          "308:         public static string SanitizeFilename(string s)",
          "310:             if (s == null)",
          "311:                 throw new ArgumentNullException(\"s\");",
          "313:             s = RemoveDiacritics(s);",
          "314:             s = s.Replace(\"/\", \"_\");",
          "315:             s = s.Replace(\":\", \"_\");",
          "316:             s = s.Replace(\"&\", \"_\");",
          "317:             s = s.Replace(\"\u0131\", \"i\");",
          "318:             return s.TrimToEmpty();",
          "",
          "[Added Lines]",
          "306:         public static readonly Regex InvalidFilenameCharsRegex =",
          "307:             new ($\"[{Regex.Escape(new string(Path.GetInvalidFileNameChars()))}]\",",
          "308:                 RegexOptions.Singleline | RegexOptions.Compiled | RegexOptions.CultureInvariant);",
          "318:         public static string SanitizeFilename(string filename,",
          "319:             string replacement = \"_\", bool removeDiacritics = true)",
          "320:         {",
          "321:             if (filename == null)",
          "322:                 throw new ArgumentNullException(nameof(filename));",
          "324:             if (removeDiacritics)",
          "325:             {",
          "326:                 RemoveDiacritics(filename);",
          "327:                 filename = filename.Replace(\"\u0131\", \"i\");",
          "328:             }",
          "330:             filename = InvalidFilenameCharsRegex.Replace(filename, replacement);",
          "332:             return filename.TrimToEmpty();",
          "333:         }",
          "338:         public static readonly Regex InvalidPathCharsRegex =",
          "339:             new($\"[{Regex.Escape(new string(Path.GetInvalidPathChars()))}]\",",
          "340:                 RegexOptions.Singleline | RegexOptions.Compiled | RegexOptions.CultureInvariant);",
          "350:         public static string SanitizeFilePath(string filename,",
          "351:             string replacement = \"_\", bool removeDiacritics = true)",
          "353:             if (filename == null)",
          "354:                 throw new ArgumentNullException(nameof(filename));",
          "356:             if (removeDiacritics)",
          "357:             {",
          "358:                 RemoveDiacritics(filename);",
          "359:                 filename = filename.Replace(\"\u0131\", \"i\");",
          "360:             }",
          "362:             filename = InvalidPathCharsRegex.Replace(filename, replacement);",
          "364:             return filename.TrimToEmpty();",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Services/Upload/UploadFormatting.cs||src/Serenity.Net.Services/Upload/UploadFormatting.cs": [
          "File: src/Serenity.Net.Services/Upload/UploadFormatting.cs -> src/Serenity.Net.Services/Upload/UploadFormatting.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:             return value + \" \" + suffix;",
          "89:         }",
          "113:     }",
          "114: }",
          "",
          "[Removed Lines]",
          "99:         public static string SanitizePlaceholder(string value)",
          "100:         {",
          "101:             value = StringHelper.SanitizeFilename(value ?? \"\");",
          "102:             value = value.Replace('\\\\', '_')",
          "103:                 .Replace(\"..\", \"_\", StringComparison.Ordinal);",
          "105:             if (string.IsNullOrWhiteSpace(value))",
          "106:                 value = \"_\";",
          "108:             while (value.EndsWith(\".\", StringComparison.Ordinal))",
          "109:                 value = value[..^1] + \"_\";",
          "111:             return value;",
          "112:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Web/Upload/FileUploadBehavior.cs||src/Serenity.Net.Web/Upload/FileUploadBehavior.cs": [
          "File: src/Serenity.Net.Web/Upload/FileUploadBehavior.cs -> src/Serenity.Net.Web/Upload/FileUploadBehavior.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: \ufeffusing Serenity.Web;",
          "2: using System.IO;",
          "3: using System;",
          "5: namespace Serenity.Services",
          "6: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4: using Serenity.ComponentModel;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "18:         private const string SplittedFormat = \"{1:00000}/{0:00000000}_{2}\";",
          "19:         private readonly IUploadValidator uploadValidator;",
          "20:         private readonly IImageProcessor imageProcessor;",
          "22:         private StringField originalNameField;",
          "23:         private Dictionary<string, Field> replaceFields;",
          "",
          "[Removed Lines]",
          "21:         private readonly IUploadStorage storage;",
          "",
          "[Added Lines]",
          "22:         private readonly IUploadStorage storage;",
          "23:         private readonly IFilenameFormatSanitizer formatSanitizer;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "32:         public FileUploadBehavior(IUploadValidator uploadValidator, IImageProcessor imageProcessor,",
          "34:         {",
          "35:             this.uploadValidator = uploadValidator ?? throw new ArgumentNullException(nameof(uploadValidator));",
          "36:             this.imageProcessor = imageProcessor ?? throw new ArgumentNullException(nameof(imageProcessor));",
          "38:         }",
          "",
          "[Removed Lines]",
          "33:             IUploadStorage storage)",
          "37:             this.storage = storage ?? throw new ArgumentNullException(nameof(storage));",
          "",
          "[Added Lines]",
          "36:             IUploadStorage storage,",
          "37:             IFilenameFormatSanitizer formatSanitizer = null)",
          "41:             this.storage = storage ?? throw new ArgumentNullException(nameof(storage));",
          "42:             this.formatSanitizer = formatSanitizer ?? DefaultFilenameFormatSanitizer.Instance;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "132:             return replaceFields;",
          "133:         }",
          "136:             Dictionary<string, Field> replaceFields,",
          "137:             ISaveRequestHandler handler,",
          "139:         {",
          "140:             if (replaceFields == null)",
          "143:             var row = handler.Row;",
          "",
          "[Removed Lines]",
          "135:         internal static string ProcessReplaceFields(string s,",
          "138:             ISanitizeFilenamePlaceholder sanitizePlaceholder)",
          "141:                 return s;",
          "",
          "[Added Lines]",
          "139:         internal static string ProcessReplaceFields(string s,",
          "142:             IFilenameFormatSanitizer formatSanitizer)",
          "144:             var result = s;",
          "147:                 return result;",
          "149:             if (formatSanitizer is null)",
          "150:                 throw new ArgumentNullException(nameof(formatSanitizer));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "169:             foreach (var p in replaceFields)",
          "170:             {",
          "171:                 var val = p.Value.AsObject(row);",
          "174:                 var colon = p.Key.IndexOf(\":\", StringComparison.Ordinal);",
          "175:                 if (colon >= 0)",
          "177:                 else",
          "186:             }",
          "192:         }",
          "",
          "[Removed Lines]",
          "172:                 string str;",
          "176:                     str = string.Format(CultureInfo.InvariantCulture, string.Concat(\"{0:\", p.Key.AsSpan(colon + 1, p.Key.Length - colon - 2), \"}\"), val);",
          "178:                     str = Convert.ToString(val ?? \"\", CultureInfo.InvariantCulture);",
          "180:                 if (sanitizePlaceholder != null)",
          "181:                     str = sanitizePlaceholder.Sanitize(p.Key, str);",
          "182:                 else",
          "183:                     str = UploadFormatting.SanitizePlaceholder(str);",
          "185:                 s = s.Replace(p.Key, str, StringComparison.Ordinal);",
          "188:             while (s.IndexOf(\"//\", StringComparison.Ordinal) > 0)",
          "189:                 s = s.Replace(\"//\", \"/_/\", StringComparison.Ordinal);",
          "191:             return s;",
          "",
          "[Added Lines]",
          "181:                 string value;",
          "185:                     value = string.Format(CultureInfo.InvariantCulture, string.Concat(\"{0:\", p.Key.AsSpan(colon + 1, p.Key.Length - colon - 2), \"}\"), val);",
          "187:                     value = Convert.ToString(val ?? \"\", CultureInfo.InvariantCulture);",
          "189:                 value = formatSanitizer.SanitizePlaceholder(p.Key, value);",
          "191:                 result = result.Replace(p.Key, value, StringComparison.Ordinal);",
          "194:             result = formatSanitizer.SanitizeResult(result);",
          "196:             return result;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "302:             var copyResult = storage.CopyTemporaryFile(new CopyTemporaryFileOptions",
          "303:             {",
          "304:                 Format = fileNameFormat,",
          "307:                 TemporaryFile = newFilename,",
          "308:                 EntityId = idField.AsObject(handler.Row),",
          "309:                 FilesToDelete = filesToDelete,",
          "",
          "[Removed Lines]",
          "305:                 PostFormat = s => ProcessReplaceFields(s, replaceFields, handler,",
          "306:                     editorAttr as ISanitizeFilenamePlaceholder),",
          "",
          "[Added Lines]",
          "310:                 PostFormat = s => ProcessReplaceFields(s, replaceFields, handler,",
          "311:                     editorAttr as IFilenameFormatSanitizer ?? formatSanitizer),",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs||src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs": [
          "File: src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs -> src/Serenity.Net.Web/Upload/MultipleFileUploadBehavior.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "15:         private string fileNameFormat;",
          "16:         private const string SplittedFormat = \"{1:00000}/{0:00000000}_{2}\";",
          "17:         private Dictionary<string, Field> replaceFields;",
          "18:         private readonly IUploadValidator uploadValidator;",
          "19:         private readonly IImageProcessor imageProcessor;",
          "20:         private readonly IUploadStorage storage;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "18:         private readonly IFilenameFormatSanitizer formatSanitizer;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "29:         public MultipleFileUploadBehavior(IUploadValidator uploadValidator, IImageProcessor imageProcessor,",
          "31:         {",
          "32:             this.uploadValidator = uploadValidator ?? throw new ArgumentNullException(nameof(uploadValidator));",
          "33:             this.imageProcessor = imageProcessor ?? throw new ArgumentNullException(nameof(imageProcessor));",
          "34:             this.storage = storage ?? throw new ArgumentNullException(nameof(storage));",
          "35:         }",
          "",
          "[Removed Lines]",
          "30:             IUploadStorage storage)",
          "",
          "[Added Lines]",
          "32:             IUploadStorage storage,",
          "33:             IFilenameFormatSanitizer formatSanitizer = null)",
          "38:             this.formatSanitizer = formatSanitizer ?? DefaultFilenameFormatSanitizer.Instance;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "191:                 {",
          "192:                     Format = fileNameFormat,",
          "193:                     PostFormat = s => FileUploadBehavior.ProcessReplaceFields(s, replaceFields, handler,",
          "195:                     TemporaryFile = filename,",
          "196:                     EntityId = idField.AsObject(handler.Row),",
          "197:                     FilesToDelete = filesToDelete,",
          "",
          "[Removed Lines]",
          "194:                         editorAttr as ISanitizeFilenamePlaceholder),",
          "",
          "[Added Lines]",
          "198:                         editorAttr as IFilenameFormatSanitizer ?? formatSanitizer),",
          "",
          "---------------"
        ],
        "src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs||src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs": [
          "File: src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs -> src/Serenity.Net.Web/Upload/UploadServiceCollectionExtensions.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "22:                 throw new ArgumentNullException(nameof(collection));",
          "24:             collection.AddOptions();",
          "25:             collection.TryAddSingleton<IUploadStorage, DefaultUploadStorage>();",
          "26:             collection.TryAddSingleton<IUploadValidator, DefaultUploadValidator>();",
          "27:             collection.TryAddSingleton<IImageProcessor, DefaultImageProcessor>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25:             collection.TryAddSingleton<IFilenameFormatSanitizer, DefaultFilenameFormatSanitizer>();",
          "",
          "---------------"
        ],
        "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs||tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs": [
          "File: tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs -> tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.TestRows.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "129:             set => fields.ImageUploadEditorCopyToHistory[this] = value;",
          "130:         }",
          "132:         public class RowFields : RowFieldsBase",
          "133:         {",
          "134:             public Int32Field Id;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "132:         public string Empty",
          "133:         {",
          "134:             get => fields.Empty[this];",
          "135:             set => fields.Empty[this] = value;",
          "136:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "144:             public StringField ImageUploadEditorOriginalNameIntegerField;",
          "145:             public StringField ImageUploadEditorOriginalNameNoField;",
          "146:             public StringField ImageUploadEditorCopyToHistory;",
          "147:         }",
          "148:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "153:             public StringField Empty;",
          "",
          "---------------"
        ],
        "tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs||tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs": [
          "File: tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs -> tests/Serenity.Net.Web.Tests/UploadBehaviors/FileUploadBehaviorTests.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: using SixLabors.ImageSharp.Formats;",
          "4: using SixLabors.ImageSharp.Formats.Png;",
          "5: using SixLabors.ImageSharp.PixelFormats;",
          "6: using MockFileData = System.IO.Abstractions.TestingHelpers.MockFileData;",
          "8: namespace Serenity.Tests.Web;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6: using System.Text.RegularExpressions;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1091:         Assert.Equal(\"a-test-\\\\_\\\\.jpg\", processResult);",
          "1092:     }",
          "1095:     {",
          "1096:         isUpdate ??= foreignFieldQueryResults == null;",
          "",
          "[Removed Lines]",
          "1094:     private string TestProcessReplaceFields(string fileNameFormat, IDictionary<string, object> foreignFieldQueryResults = null, TestIIdRow  row = null, bool? isUpdate = null)",
          "",
          "[Added Lines]",
          "1095:     private class IgnoreSlashEmptySanitizer : IFilenameFormatSanitizer",
          "1096:     {",
          "1097:         public string SanitizePlaceholder(string key, string value)",
          "1098:         {",
          "1099:             value = StringHelper.SanitizeFilePath((value ?? \"\").Replace('\\\\', '/'));",
          "1100:             value = value.Replace(\"..\", \"_\", StringComparison.Ordinal);",
          "1101:             return value;",
          "1102:         }",
          "1104:         public string SanitizeResult(string result)",
          "1105:         {",
          "1106:             if (string.IsNullOrEmpty(result))",
          "1107:                 return result;",
          "1109:             result = result.Replace('\\\\', '/');",
          "1111:             while (result.Contains(\"//\"))",
          "1112:                 result = result.Replace(\"//\", \"/\", StringComparison.Ordinal);",
          "1114:             return result;",
          "1115:         }",
          "1116:     }",
          "1118:     [Fact]",
          "1119:     public void ProcessReplaceFields_Uses_Registered_IgnoreSlashSanitizer()",
          "1120:     {",
          "1121:         var processResult = TestProcessReplaceFields(\"x/|Name|/|Empty|/y\", row: new TestIIdRow",
          "1122:         {",
          "1123:             Name = \"a/b/c/d\"",
          "1124:         }, sanitizer: new IgnoreSlashEmptySanitizer());",
          "1126:         Assert.Equal(\"x/a/b/c/d/y.jpg\", processResult);",
          "1127:     }",
          "1129:     private string TestProcessReplaceFields(string fileNameFormat, IDictionary<string, object> foreignFieldQueryResults = null, TestIIdRow  row = null, bool? isUpdate = null,",
          "1130:         IFilenameFormatSanitizer sanitizer = null)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1100:             Id = isUpdate.Value ? 1234: null",
          "1101:         };",
          "1158:     }",
          "1160:     private static byte[] CreateImage(int width, int height, IImageFormat format = null, Configuration configuration = null, Rgba32? color = null)",
          "",
          "[Removed Lines]",
          "1103:         row.StringFieldImageUploadEditor ??= \"temporary/new.jpg\";",
          "1105:         row.GetFields().StringFieldImageUploadEditor.GetAttribute<ImageUploadEditorAttribute>()",
          "1106:             .FilenameFormat = fileNameFormat;",
          "1108:         var mockUploadStorage = (MockUploadStorage)MockUploadStorage.Create();",
          "1109:         var mockFileSystem = (MockFileSystem)mockUploadStorage.MockFileSystem;",
          "1111:         var sut = new FileUploadBehavior(new MockUploadValidator(), new MockImageProcessor(), mockUploadStorage)",
          "1112:         {",
          "1113:             Target = TestIIdRow.Fields.StringFieldImageUploadEditor",
          "1114:         };",
          "1116:         mockFileSystem.AddFile(row.StringFieldImageUploadEditor, new MockFileData(CreateImage(1000, 1000)));",
          "1118:         sut.ActivateFor(row);",
          "1120:         var dbConnection = new MockDbConnection();",
          "1121:         dbConnection.OnExecuteReader(command =>",
          "1122:         {",
          "1123:             var selectFields = MockDbDataReader.ParseSelectFieldAliases(command.CommandText).ToList();",
          "1124:             var retRow = new TestIIdRow();",
          "1126:             foreach (var field in selectFields)",
          "1127:             {",
          "1128:                 object value = field + \"_value\";",
          "1130:                 if (foreignFieldQueryResults?.TryGetValue(field, out var dictValue) == true)",
          "1131:                     value = dictValue;",
          "1133:                 retRow[field] = value;",
          "1134:             }",
          "1136:             return new MockDbDataReader(command.CommandText, retRow);",
          "1137:         });",
          "1139:         var uow = new MockUnitOfWork(dbConnection);",
          "1140:         var requestHandler = new MockSaveHandler<TestIIdRow>",
          "1141:         {",
          "1142:             IsCreate = !isUpdate.Value,",
          "1143:             IsUpdate = isUpdate.Value,",
          "1144:             Old = isUpdate.Value ? new TestIIdRow { Id = 1234 } : null,",
          "1145:             Row = row,",
          "1146:             UnitOfWork = uow,",
          "1147:             Connection = uow.Connection",
          "1148:         };",
          "1150:         sut.OnBeforeSave(requestHandler);",
          "1151:         if (!isUpdate.Value)",
          "1152:             row.Id = 1234;",
          "1153:         sut.OnAfterSave(requestHandler);",
          "1154:         uow.Commit();",
          "1156:         var file = Assert.Single(mockFileSystem.AllFiles);",
          "1157:         return file[mockFileSystem.Path.GetPathRoot(file).Length..]; // remove drive letter",
          "",
          "[Added Lines]",
          "1139:         row.StringFieldImageUploadEditor ??= \"temporary/new.jpg\";",
          "1141:         var attr = row.GetFields().StringFieldImageUploadEditor.GetAttribute<ImageUploadEditorAttribute>();",
          "1142:         var oldFormat = attr.FilenameFormat;",
          "1143:         try",
          "1144:         {",
          "1145:             attr.FilenameFormat = fileNameFormat;",
          "1147:             var mockUploadStorage = (MockUploadStorage)MockUploadStorage.Create();",
          "1148:             var mockFileSystem = (MockFileSystem)mockUploadStorage.MockFileSystem;",
          "1150:             var sut = new FileUploadBehavior(new MockUploadValidator(), new MockImageProcessor(), mockUploadStorage,",
          "1151:                 formatSanitizer: sanitizer)",
          "1152:             {",
          "1153:                 Target = TestIIdRow.Fields.StringFieldImageUploadEditor",
          "1154:             };",
          "1156:             mockFileSystem.AddFile(row.StringFieldImageUploadEditor, new MockFileData(CreateImage(1000, 1000)));",
          "1158:             sut.ActivateFor(row);",
          "1160:             var dbConnection = new MockDbConnection();",
          "1161:             dbConnection.OnExecuteReader(command =>",
          "1162:             {",
          "1163:                 var selectFields = MockDbDataReader.ParseSelectFieldAliases(command.CommandText).ToList();",
          "1164:                 var retRow = new TestIIdRow();",
          "1166:                 foreach (var field in selectFields)",
          "1167:                 {",
          "1168:                     object value = field + \"_value\";",
          "1170:                     if (foreignFieldQueryResults?.TryGetValue(field, out var dictValue) == true)",
          "1171:                         value = dictValue;",
          "1173:                     retRow[field] = value;",
          "1174:                 }",
          "1176:                 return new MockDbDataReader(command.CommandText, retRow);",
          "1177:             });",
          "1179:             var uow = new MockUnitOfWork(dbConnection);",
          "1180:             var requestHandler = new MockSaveHandler<TestIIdRow>",
          "1181:             {",
          "1182:                 IsCreate = !isUpdate.Value,",
          "1183:                 IsUpdate = isUpdate.Value,",
          "1184:                 Old = isUpdate.Value ? new TestIIdRow { Id = 1234 } : null,",
          "1185:                 Row = row,",
          "1186:                 UnitOfWork = uow,",
          "1187:                 Connection = uow.Connection",
          "1188:             };",
          "1190:             sut.OnBeforeSave(requestHandler);",
          "1191:             if (!isUpdate.Value)",
          "1192:                 row.Id = 1234;",
          "1193:             sut.OnAfterSave(requestHandler);",
          "1194:             uow.Commit();",
          "1196:             var file = Assert.Single(mockFileSystem.AllFiles);",
          "1197:             return file[mockFileSystem.Path.GetPathRoot(file).Length..].Replace('\\\\', '/'); // remove drive letter",
          "1198:         }",
          "1199:         finally",
          "1200:         {",
          "1201:             attr.FilenameFormat = oldFormat;",
          "1202:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}