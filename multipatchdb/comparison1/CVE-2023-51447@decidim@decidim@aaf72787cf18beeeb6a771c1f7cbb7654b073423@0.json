{
  "cve_id": "CVE-2023-51447",
  "cve_desc": "Decidim is a participatory democracy framework. Starting in version 0.27.0 and prior to versions 0.27.5 and 0.28.0, the dynamic file upload feature is subject to potential cross-site scripting attacks in case the attacker manages to modify the file names of the records being uploaded to the server. This appears in sections where the user controls the file upload dialogs themselves and has the technical knowledge to change the file names through the dynamic upload endpoint. Therefore I believe it would require the attacker to control the whole session of the particular user but in any case, this needs to be fixed. Successful exploit of this vulnerability would require the user to have successfully uploaded a file blob to the server with a malicious file name and then have the possibility to direct the other user to the edit page of the record where the attachment is attached. The users are able to craft the direct upload requests themselves controlling the file name that gets stored to the database. The attacker is able to change the filename e.g. to `<svg onload=alert('XSS')>` if they know how to craft these requests themselves. And then enter the returned blob ID to the form inputs manually by modifying the edit page source. Versions 0.27.5 and 0.28.0 contain a patch for this issue. As a workaround, disable dynamic uploads for the instance, e.g. from proposals.",
  "repo": "decidim/decidim",
  "patch_hash": "aaf72787cf18beeeb6a771c1f7cbb7654b073423",
  "patch_info": {
    "commit_hash": "aaf72787cf18beeeb6a771c1f7cbb7654b073423",
    "repo": "decidim/decidim",
    "commit_url": "https://github.com/decidim/decidim/commit/aaf72787cf18beeeb6a771c1f7cbb7654b073423",
    "files": [
      "decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "decidim-core/app/packs/src/decidim/utilities/text.js",
      "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "decidim-proposals/spec/system/edit_proposal_spec.rb"
    ],
    "message": "Fix issues with the file uploader input display (#11612)",
    "before_after_code_files": [
      "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js",
      "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
    ]
  },
  "patch_diff": {
    "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb": [
      "File: decidim-core/app/cells/decidim/upload_modal_cell.rb -> decidim-core/app/cells/decidim/upload_modal_cell.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "159:     end",
      "161:     def truncated_file_name_for(attachment, max_length = 31)",
      "165:       name = File.basename(filename, File.extname(filename))",
      "167:     end",
      "169:     def file_name_for(attachment)",
      "171:     end",
      "173:     def determine_filename(attachment)",
      "",
      "[Removed Lines]",
      "162:       filename = file_name_for(attachment)",
      "163:       return filename if filename.length <= max_length",
      "166:       name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")",
      "170:       determine_filename(attachment)",
      "",
      "[Added Lines]",
      "162:       filename = determine_filename(attachment)",
      "163:       return decidim_html_escape(filename).html_safe if filename.length <= max_length",
      "166:       decidim_html_escape(name.truncate(max_length, omission: \"...#{name.last((max_length / 2) - 3)}#{File.extname(filename)}\")).html_safe",
      "170:       decidim_html_escape(determine_filename(attachment)).html_safe",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js": [
      "File: decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: import { Uploader } from \"src/decidim/direct_uploads/redesigned_uploader\";",
      "2: import icon from \"src/decidim/redesigned_icon\";",
      "3: import { truncateFilename } from \"src/decidim/direct_uploads/upload_utility\";",
      "5: const STATUS = {",
      "6:   VALIDATED: \"validated\",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: import { escapeHtml, escapeQuotes } from \"src/decidim/utilities/text\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "166:   createUploadItem(file, errors, opts = {}) {",
      "167:     const okTemplate = `",
      "168:       <img src=\"\" alt=\"${file.name}\" />",
      "170:     `",
      "172:     const errorTemplate = `",
      "173:       <div>${icon(\"error-warning-line\")}</div>",
      "174:       <div>",
      "176:         <span>${this.locales.validation_error}</span>",
      "177:         <ul>${errors.map((error) => `<li>${error}</li>`).join(\"\\n\")}</ul>",
      "178:       </div>",
      "",
      "[Removed Lines]",
      "169:       <span>${truncateFilename(file.name)}</span>",
      "175:         <span>${truncateFilename(file.name)}</span>",
      "",
      "[Added Lines]",
      "170:       <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "176:         <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "183:       <div>",
      "184:         <div>",
      "185:           <label>${this.locales.filename}</label>",
      "187:         </div>",
      "188:         <div>",
      "189:           <label>${this.locales.title}</label>",
      "191:         </div>",
      "192:       </div>",
      "193:     `",
      "",
      "[Removed Lines]",
      "186:           <span>${truncateFilename(file.name)}</span>",
      "190:           <input class=\"sm\" type=\"text\" value=\"${opts.title || truncateFilename(file.name)}\" />",
      "",
      "[Added Lines]",
      "187:           <span>${escapeHtml(truncateFilename(file.name))}</span>",
      "191:           <input class=\"sm\" type=\"text\" value=\"${escapeQuotes(opts.title || truncateFilename(file.name))}\" />",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "212:       ? `data-attachment-id=\"${opts.attachmentId}\"`",
      "213:       : \"\"",
      "214:     const fullTemplate = `",
      "216:         <div data-template=\"${template}\">",
      "217:           ${content.trim()}",
      "218:           <button>${this.locales.remove}</button>",
      "",
      "[Removed Lines]",
      "215:       <li ${attachmentId} data-filename=\"${file.name}\" data-state=\"${state}\">",
      "",
      "[Added Lines]",
      "216:       <li ${attachmentId} data-filename=\"${escapeQuotes(file.name)}\" data-state=\"${state}\">",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "248:   }",
      "250:   setProgressBar(name, value) {",
      "252:   }",
      "254:   updateAddAttachmentsButton() {",
      "",
      "[Removed Lines]",
      "251:     this.uploadItems.querySelector(`[data-filename=\"${name}\"] progress`).value = value",
      "",
      "[Added Lines]",
      "252:     this.uploadItems.querySelector(`[data-filename=\"${escapeQuotes(name)}\"] progress`).value = value",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
      "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: import { Uploader } from \"src/decidim/direct_uploads/uploader\";",
      "2: import { truncateFilename, checkTitles, createHiddenInput } from \"src/decidim/direct_uploads/upload_utility\";",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3: import { escapeHtml } from \"src/decidim/utilities/text\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71:         const attachmentDetails = document.createElement(\"div\");",
      "72:         attachmentDetails.classList.add(\"attachment-details\");",
      "74:         const titleAndFileNameSpan = document.createElement(\"span\");",
      "75:         titleAndFileNameSpan.style.display = \"none\";",
      "76:         attachmentDetails.appendChild(titleAndFileNameSpan);",
      "",
      "[Removed Lines]",
      "73:         attachmentDetails.dataset.filename = file.name;",
      "",
      "[Added Lines]",
      "74:         attachmentDetails.dataset.filename = escapeHtml(file.name);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "85:         if (this.options.titled) {",
      "86:           const hiddenTitleField = createHiddenInput(\"hidden-title\", `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]`, title);",
      "88:           attachmentDetails.appendChild(hiddenTitleField);",
      "89:         } else {",
      "91:         }",
      "93:         if (!this.options.multiple) {",
      "",
      "[Removed Lines]",
      "87:           titleAndFileNameSpan.innerHTML = `${title} (${file.name})`;",
      "90:           titleAndFileNameSpan.innerHTML = file.name;",
      "",
      "[Added Lines]",
      "88:           titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${file.name})`);",
      "91:           titleAndFileNameSpan.innerHTML = escapeHtml(file.name);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "127:   createUploadItem(fileName, title, state) {",
      "128:     const wrapper = document.createElement(\"div\");",
      "129:     wrapper.classList.add(\"upload-item\");",
      "132:     const firstRow = document.createElement(\"div\");",
      "133:     const secondRow = document.createElement(\"div\");",
      "",
      "[Removed Lines]",
      "130:     wrapper.setAttribute(\"data-filename\", fileName);",
      "",
      "[Added Lines]",
      "131:     wrapper.setAttribute(\"data-filename\", escapeHtml(fileName));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "144:       fileNameSpanClasses.push(\"small-12\");",
      "145:     }",
      "146:     fileNameSpan.classList.add(...fileNameSpanClasses);",
      "149:     const progressBar = document.createElement(\"div\");",
      "150:     progressBar.classList.add(\"progress-bar\");",
      "",
      "[Removed Lines]",
      "147:     fileNameSpan.innerHTML = truncateFilename(fileName);",
      "",
      "[Added Lines]",
      "148:     fileNameSpan.innerHTML = escapeHtml(truncateFilename(fileName));",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "179:     removeButton.innerHTML = `&times; ${this.locales.remove}`;",
      "180:     removeButton.addEventListener((\"click\"), (event) => {",
      "181:       event.preventDefault();",
      "184:       this.updateDropZone();",
      "185:     })",
      "187:     const titleAndFileNameSpan = document.createElement(\"span\");",
      "188:     titleAndFileNameSpan.classList.add(\"columns\", \"small-5\", \"title-and-filename-span\");",
      "191:     firstRow.appendChild(fileNameSpan);",
      "192:     secondRow.appendChild(progressBarWrapper);",
      "",
      "[Removed Lines]",
      "182:       const item = this.uploadItems.querySelector(`[data-filename='${fileName}']`);",
      "183:       this.trashCan.append(item);",
      "189:     titleAndFileNameSpan.innerHTML = `${title} (${truncateFilename(fileName)})`;",
      "",
      "[Added Lines]",
      "183:       this.trashCan.append(wrapper);",
      "189:     titleAndFileNameSpan.innerHTML = escapeHtml(`${title} (${truncateFilename(fileName)})`);",
      "",
      "---------------"
    ],
    "decidim-core/app/packs/src/decidim/utilities/text.js||decidim-core/app/packs/src/decidim/utilities/text.js": [
      "File: decidim-core/app/packs/src/decidim/utilities/text.js -> decidim-core/app/packs/src/decidim/utilities/text.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: export const escapeHtml = (text) => {",
      "2:   if (!text) {",
      "3:     return \"\";",
      "4:   }",
      "6:   const el = document.createElement(\"div\");",
      "7:   el.appendChild(document.createTextNode(text));",
      "8:   return el.innerHTML;",
      "9: }",
      "11: export const escapeQuotes = (text) => {",
      "12:   if (!text) {",
      "13:     return \"\";",
      "14:   }",
      "16:   return text.replace(/\"/g, \"&quot;\");",
      "17: }",
      "",
      "---------------"
    ],
    "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb": [
      "File: decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb -> decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "147:         expect(details).to have_content(\"#{attachments[0].title[\"en\"]} (#{filename})\")",
      "148:       end",
      "149:     end",
      "150:   end",
      "152:   context \"when multiple attachments are present\" do",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "151:     context \"when there is rich content in the filename\" do",
      "152:       let(:blob) { ActiveStorage::Blob.find_signed(attachments.first) }",
      "154:       before do",
      "155:         blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
      "156:       end",
      "158:       it \"escapes the truncated filename\" do",
      "159:         expect(my_cell.send(:truncated_file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
      "160:       end",
      "162:       it \"escapes the filename\" do",
      "163:         expect(my_cell.send(:file_name_for, attachments.first)).to eq(\"&lt;svg onload=alert(&#39;ALERT&#39;)&gt;.pdf\")",
      "164:       end",
      "165:     end",
      "",
      "---------------"
    ],
    "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb": [
      "File: decidim-proposals/spec/system/edit_proposal_spec.rb -> decidim-proposals/spec/system/edit_proposal_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "110:             expect(translated(Decidim::Attachment.find_by(attached_to_id: proposal.id, content_type: \"application/pdf\").title)).to eq(attachment_file_title)",
      "111:           end",
      "112:         end",
      "113:       end",
      "115:       context \"with multiple images\", :slow do",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "114:         context \"with problematic file titles\" do",
      "115:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
      "116:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
      "118:           before do",
      "119:             document.update!(title: { en: \"<svg onload=alert('ALERT')>.pdf\" })",
      "120:             photo.update!(title: { en: \"<svg onload=alert('ALERT')>.jpg\" })",
      "121:           end",
      "123:           it \"displays them correctly on the edit form\" do",
      "124:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
      "125:             click_link \"Edit proposal\"",
      "126:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
      "127:             click_button(\"Edit documents\")",
      "128:             within \"[data-dialog]\" do",
      "129:               click_button(\"Next\")",
      "130:             end",
      "131:             click_button(\"Send\")",
      "132:             expect(page).to have_content(\"Proposal successfully updated.\")",
      "133:           end",
      "134:         end",
      "136:         context \"with problematic file names\" do",
      "137:           let!(:photo) { create(:attachment, :with_image, weight: 0, attached_to: proposal) }",
      "138:           let!(:document) { create(:attachment, :with_pdf, weight: 1, attached_to: proposal) }",
      "140:           before do",
      "141:             document.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.pdf\")",
      "142:             photo.file.blob.update!(filename: \"<svg onload=alert('ALERT')>.jpg\")",
      "143:           end",
      "145:           it \"displays them correctly on the edit form\" do",
      "146:             # With problematic code, should raise Selenium::WebDriver::Error::UnexpectedAlertOpenError",
      "147:             click_link \"Edit proposal\"",
      "148:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
      "149:             click_button(\"Edit documents\")",
      "150:             within \"[data-dialog]\" do",
      "151:               click_button(\"Next\")",
      "152:             end",
      "153:             click_button(\"Send\")",
      "154:             expect(page).to have_content(\"Proposal successfully updated.\")",
      "155:           end",
      "156:         end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dcc68632dbe900afc6c6eaa0231aa963147ab2df",
      "candidate_info": {
        "commit_hash": "dcc68632dbe900afc6c6eaa0231aa963147ab2df",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/dcc68632dbe900afc6c6eaa0231aa963147ab2df",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ],
        "message": "Fix flaky with accessibility errors in Direct Uploads (#12756)\n\n* Fix a11y error in 'Select file' button\n\nError fixed\n\n>  Attribute \u201cdisabled\u201d not allowed on element \u201clabel\u201d at this point.\n\nThis also fixes a focus problem: you can't focus a label by default in\nHTML.\n\n* Fix a11y error in img\n\nError fixed\n\n> Bad value \u201c\u201d for attribute \u201csrc\u201d on element \u201cimg\u201d: Must be non-empty.\n\n* Fix a11y error in src img with base64 value\n\nError fixed\n\n> Bad value  for attribute \u201csrc\u201d on element \u201cimg\u201d: Expected a token\ncharacter or \u201c/\u201d but saw \u201c;\u201d instead.\n\nThe problem is that we're generating this src:\n\nMind that the MIME type is invalid.",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ],
          "candidate": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/modal.erb -> decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:             <%= icon \"upload-cloud-2-line\", class: \"w-8 h-8 text-gray fill-current\" %>",
          "38:             <%= t(\"decidim.forms.upload_help.dropzone\") %>",
          "39:           </span>",
          "41:             <span><%= t(\"decidim.forms.upload.select_file\") %></span>",
          "42:             <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "44:         </div>",
          "45:       </div>",
          "46:     </div>",
          "",
          "[Removed Lines]",
          "40:           <label class=\"button button__sm button__secondary\" for=\"files-<%= modal_id %>\">",
          "43:           </label>",
          "",
          "[Added Lines]",
          "40:           <button class=\"button button__sm button__secondary\" data-select-file-button>",
          "43:           </button>",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "67:     const template = `",
          "68:       <div ${attachmentIdOrHiddenField} data-filename=\"${escapeQuotes(file.name)}\" data-title=\"${escapeQuotes(title)}\">",
          "70:         <span>${escapeHtml(title)} (${escapeHtml(truncateFilename(file.name))})</span>",
          "71:         ${hidden}",
          "72:       </div>",
          "",
          "[Removed Lines]",
          "69:         ${(/image/).test(file.type) && `<div><img src=\"\" alt=\"${escapeQuotes(file.name)}\" /></div>` || \"\"}",
          "",
          "[Added Lines]",
          "69:         ${(/image/).test(file.type) && `<div><img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" /></div>` || \"\"}",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "122:     if (src) {",
          "123:       buffer = await fetch(src).then((res) => res.arrayBuffer())",
          "127:     }",
          "129:     const file = new File([buffer], element.dataset.filename, { type })",
          "",
          "[Removed Lines]",
          "126:       type = \"image\"",
          "",
          "[Added Lines]",
          "126:       type = \"image/*\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "155:     this.saveButton.disabled = Array.from(files).filter(({ dataset: { state } }) => state === STATUS.ERROR).length > 0;",
          "158:     const continueUpload = !files.length || this.options.multiple",
          "159:     this.input.disabled = !continueUpload",
          "160:     if (continueUpload) {",
          "161:       this.emptyItems.classList.remove(\"is-disabled\");",
          "163:     } else {",
          "164:       this.emptyItems.classList.add(\"is-disabled\");",
          "166:     }",
          "167:   }",
          "169:   createUploadItem(file, errors, opts = {}) {",
          "170:     const okTemplate = `",
          "172:       <span>${escapeHtml(truncateFilename(file.name))}</span>",
          "173:     `",
          "",
          "[Removed Lines]",
          "162:       this.emptyItems.querySelector(\"label\").removeAttribute(\"disabled\");",
          "165:       this.emptyItems.querySelector(\"label\").setAttribute(\"disabled\", true);",
          "171:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "[Added Lines]",
          "157:     const dataSelectFileButton = this.emptyItems.querySelector(\"[data-select-file-button]\");",
          "164:       dataSelectFileButton.removeAttribute(\"disabled\");",
          "167:       dataSelectFileButton.disabled = true;",
          "170:     dataSelectFileButton.addEventListener(\"click\", () => this.input.click());",
          "175:       <img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "182:     `",
          "184:     const titleTemplate = `",
          "186:       <div>",
          "187:         <div>",
          "188:           <label>${this.locales.filename}</label>",
          "",
          "[Removed Lines]",
          "185:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "[Added Lines]",
          "189:       <img src=\"data:,\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "09e1e38386bb2af1b125d311e39fda9479ac94b3",
      "candidate_info": {
        "commit_hash": "09e1e38386bb2af1b125d311e39fda9479ac94b3",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/09e1e38386bb2af1b125d311e39fda9479ac94b3",
        "files": [
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ],
        "message": "Fix further issues with the redesigned file uploader file name display (#11741)",
        "before_after_code_files": [
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ],
          "candidate": [
            "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_field.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import UploadModal from \"src/decidim/direct_uploads/upload_modal\";",
          "2: import { truncateFilename } from \"src/decidim/direct_uploads/upload_utility\";",
          "4: const updateModalTitle = (modal) => {",
          "5:   if (modal.uploadItems.children.length === 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: import { escapeHtml, escapeQuotes } from \"src/decidim/utilities/text\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "54:       const titleValue = modal.modal.querySelectorAll('input[type=\"text\"]')[ix].value",
          "56:       const titleField = `${modal.options.resourceName}[${modal.options.addAttribute}][${ix}][title]`",
          "59:       title = titleValue",
          "60:     }",
          "",
          "[Removed Lines]",
          "57:       hidden += `<input type=\"hidden\" name=\"${titleField}\" value=\"${titleValue}\" />`",
          "",
          "[Added Lines]",
          "58:       hidden += `<input type=\"hidden\" name=\"${titleField}\" value=\"${escapeQuotes(titleValue)}\" />`",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "64:       : `data-hidden-field=\"${file.hiddenField}\"`",
          "66:     const template = `",
          "70:         ${hidden}",
          "71:       </div>",
          "72:     `",
          "",
          "[Removed Lines]",
          "67:       <div ${attachmentIdOrHiddenField} data-filename=\"${file.name}\" data-title=\"${title}\">",
          "68:         ${(/image/).test(file.type) && `<div><img src=\"\" alt=\"${file.name}\" /></div>` || \"\"}",
          "69:         <span>${title} (${truncateFilename(file.name)})</span>",
          "",
          "[Added Lines]",
          "68:       <div ${attachmentIdOrHiddenField} data-filename=\"${escapeQuotes(file.name)}\" data-title=\"${escapeQuotes(title)}\">",
          "69:         ${(/image/).test(file.type) && `<div><img src=\"\" alt=\"${escapeQuotes(file.name)}\" /></div>` || \"\"}",
          "70:         <span>${escapeHtml(title)} (${escapeHtml(truncateFilename(file.name))})</span>",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_modal.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "169:   createUploadItem(file, errors, opts = {}) {",
          "170:     const okTemplate = `",
          "172:       <span>${escapeHtml(truncateFilename(file.name))}</span>",
          "173:     `",
          "",
          "[Removed Lines]",
          "171:       <img src=\"\" alt=\"${file.name}\" />",
          "",
          "[Added Lines]",
          "171:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "182:     `",
          "184:     const titleTemplate = `",
          "186:       <div>",
          "187:         <div>",
          "188:           <label>${this.locales.filename}</label>",
          "",
          "[Removed Lines]",
          "185:       <img src=\"\" alt=\"${file.name}\" />",
          "",
          "[Added Lines]",
          "185:       <img src=\"\" alt=\"${escapeQuotes(file.name)}\" />",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "df15d0f62c2b3caf2ac1713f57c5c8b37c8c4310",
      "candidate_info": {
        "commit_hash": "df15d0f62c2b3caf2ac1713f57c5c8b37c8c4310",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/df15d0f62c2b3caf2ac1713f57c5c8b37c8c4310",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal/files.erb",
          "decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb",
          "decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/cells/decidim/upload_modal/show.erb",
          "decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/app/controllers/decidim/profiles_controller.rb",
          "decidim-core/app/helpers/decidim/modal_helper.rb",
          "decidim-core/app/helpers/decidim/redesign_helper.rb",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js",
          "decidim-core/app/packs/src/decidim/index.js",
          "decidim-core/app/packs/src/decidim/redesigned_index.js",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss",
          "decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss",
          "decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb",
          "decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb",
          "decidim-core/config/locales/en.yml",
          "decidim-core/lib/decidim/form_builder.rb",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "decidim-core/spec/lib/form_builder_spec.rb",
          "decidim-proposals/spec/system/proposals_fields_spec.rb",
          "decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb"
        ],
        "message": "Redesign: upload modal (#9858)\n\n* prepare update-modal cell\n\n* clean conversations modal as of the shared styles\n\n* shared html styles for modals\n\n* workaround: redesign_enabled? not working on cells called from helper\n\n* full refactor upload modal files\n\n* fix linters\n\n* fix styles dropzone\n\n* handle asynchronous validations\n\n* general fixes and new casuistics\n\n* fix dragover highlight & remove files on cancel\n\n* update dropzone when errors\n\n* add space to files\n\n* Prepare button to open login modal to work with redesigned and legacy layouts\n\n* Split upload modal cell in legacy and redesigned versions and allow to call it passing a redesign option\n\n* Call upload method passing the redesigned option based on the context\n\n* Fix linter offense\n\n* Normalize locale file\n\n* eslint consistent-return\n\n* eslint consistent-return\n\n* Update test\n\n* move action button to the right if it's the only child\n\n* rearrangement frontend libraries\n\n* fix upload modal after redesigned assets\n\n* remove current image block (fix removal error)\n\n* preview image\n\n* good version files.erb\n\n* Fix external_link initialization in legacy design index.js\n\n* Force flaky test\n\n* Fix attachment blob call\n\n* Remove unused attachment label method\n\n* Display default image if defined and no uploaded attachments\n\n* Update test\n\n* Update selector in test\n\n* Revert \"Force flaky test\"\n\nThis reverts commit 075f6eb77d46193d0977d37d1e8e7942e08ca3c4.\n\n* Improve deprecation after redesign documentation in js file\n\n* overflow dropzone auto\n\n* disabled form submit when there are erorrs on the files\n\n* reset dropzone on cancel\n\n* pass argument multiple\n\n* update translation\n\n* better looking responsive\n\n* disable save only when errors & mark as removable\n\n* include logic to remove the current uploaded item\n\n* Delegate redesign_enabled? to template in form builder\n\n* fixes frontend upload modal\n\n* Fix form_builder spec to take redesign into account\n\n* avoid drag flickering on webkit browsers\n\n* Avoid errors in determine_filename when attachment class is ActionDispatch::Http::UploadedFile\n\n* avoid string commas in errors array\n\nCo-authored-by: Eduardo Martinez Echevarria <eduardomech@gmail.com>",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal/files.erb||decidim-core/app/cells/decidim/upload_modal/files.erb",
          "decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb||decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb",
          "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/app/cells/decidim/upload_modal/show.erb||decidim-core/app/cells/decidim/upload_modal/show.erb",
          "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/app/controllers/decidim/profiles_controller.rb||decidim-core/app/controllers/decidim/profiles_controller.rb",
          "decidim-core/app/helpers/decidim/modal_helper.rb||decidim-core/app/helpers/decidim/modal_helper.rb",
          "decidim-core/app/helpers/decidim/redesign_helper.rb||decidim-core/app/helpers/decidim/redesign_helper.rb",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js",
          "decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js",
          "decidim-core/app/packs/src/decidim/index.js||decidim-core/app/packs/src/decidim/index.js",
          "decidim-core/app/packs/src/decidim/redesigned_index.js||decidim-core/app/packs/src/decidim/redesigned_index.js",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss",
          "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss",
          "decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss||decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss",
          "decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb||decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb",
          "decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb||decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb",
          "decidim-core/lib/decidim/form_builder.rb||decidim-core/lib/decidim/form_builder.rb",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "decidim-core/spec/lib/form_builder_spec.rb||decidim-core/spec/lib/form_builder_spec.rb",
          "decidim-proposals/spec/system/proposals_fields_spec.rb||decidim-proposals/spec/system/proposals_fields_spec.rb",
          "decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb||decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
          ],
          "candidate": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal/files.erb||decidim-core/app/cells/decidim/upload_modal/files.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/files.erb -> decidim-core/app/cells/decidim/upload_modal/files.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "5:       <% attachments.each do |attachment| %>",
          "6:         <% next if attachment.is_a? Array %>",
          "8:         <div class=\"attachment-details\" data-title=\"<%= title_for(attachment) %>\" data-filename=\"<%= file_name_for(attachment) %>\" data-state=\"uploaded\">",
          "9:           <% if has_title? %>",
          "10:             <span><%= title_for(attachment) %> (<%= truncated_file_name_for(attachment) %>)</span>",
          "11:             <%= form.hidden_field attribute, multiple: true, value: attachment.id, id: attachment.id %>",
          "",
          "[Removed Lines]",
          "1: <div class=\"dynamic-uploads <%= with_title %> upload-container-for-<%= attribute %>\">",
          "2:   <%= tag.strong label unless has_title? %>",
          "3:   <div class=\"<%= actions_wrapper_class %>\">",
          "4:     <div class=\"active-uploads\">",
          "",
          "[Added Lines]",
          "1: <div class=\"upload-modal__files-container upload-container-for-<%= attribute %> <%= with_title %>\">",
          "2:   <div>",
          "3:     <%= tag.label label %>",
          "5:     <% if attachments.blank? && !has_title? && uploader_default_image_path(attribute).present? %>",
          "6:       <%= image_tag uploader_default_image_path(attribute) %>",
          "7:     <% end %>",
          "9:     <div class=\"active-uploads upload-modal__files\" data-active-uploads>",
          "14:           <div>",
          "15:             <% if file_attachment_path(attachments.first) && blob(attachments.first).image? %>",
          "16:               <%= image_tag(file_attachment_path(attachments.first), alt: attribute) %>",
          "17:             <% elsif uploader_default_image_path(attribute).present? %>",
          "18:               <%= image_tag uploader_default_image_path(attribute) %>",
          "19:             <% end %>",
          "20:           </div>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19:         </div>",
          "20:       <% end %>",
          "21:     </div>",
          "41:   </div>",
          "52: </div>",
          "",
          "[Removed Lines]",
          "22:     <%= tag.button button_label,",
          "23:       id: button_id,",
          "24:       name: attribute,",
          "25:       class: button_class,",
          "26:       type: \"button\",",
          "27:       data: {",
          "28:         open: modal_id,",
          "29:         upload: {",
          "30:           add_attribute: add_attribute,",
          "31:           resource_name: resource_name,",
          "32:           resource_class: resource_class,",
          "33:           optional: optional,",
          "34:           max_file_size: max_file_size,",
          "35:           multiple: multiple,",
          "36:           titled: has_title?,",
          "37:           form_object_class: form_object_class",
          "38:         }.transform_keys { |key| key.to_s.camelize(:lower) }",
          "39:       } %>",
          "40:     <%= input_validation_field unless optional %>",
          "43:   <% if !has_title? && file_attachment_path(attachments.first) && blob(attachments.first).image? %>",
          "44:     <strong><%= attachment_label %></strong>",
          "45:     <%= link_to image_tag(file_attachment_path(attachments.first), alt: attribute), file_attachment_path(attachments.first) %>",
          "46:   <% elsif !has_title? && uploader_default_image_path(attribute).present? %>",
          "47:       <span><%= t(\"default_image\", scope: \"decidim.forms\") %></span>",
          "48:       <%= link_to uploader_default_image_path(attribute) do %>",
          "49:         <%= image_tag uploader_default_image_path(attribute) %>",
          "50:       <% end %>",
          "51:   <% end %>",
          "",
          "[Added Lines]",
          "36:   <%= tag.button button_label,",
          "37:     id: button_id,",
          "38:     name: attribute,",
          "39:     class: button_class,",
          "40:     type: \"button\",",
          "41:     data: {",
          "42:       modal_open_key => modal_id,",
          "43:       upload: {",
          "44:         add_attribute: add_attribute,",
          "45:         resource_name: resource_name,",
          "46:         resource_class: resource_class,",
          "47:         optional: optional,",
          "48:         max_file_size: max_file_size,",
          "49:         multiple: multiple,",
          "50:         titled: has_title?,",
          "51:         form_object_class: form_object_class",
          "52:       }.transform_keys { |key| key.to_s.camelize(:lower) }",
          "53:     } %>",
          "55:   <%= input_validation_field unless optional %>",
          "",
          "---------------"
        ],
        "decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb||decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb -> decidim-core/app/cells/decidim/upload_modal/legacy_modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <div class=\"reveal upload-modal\" id=\"<%= modal_id %>\" data-reveal>",
          "2:   <div class=\"reveal__header\">",
          "3:     <h3 class=\"reveal__title\" data-addlabel=\"<%= button_label %>\" data-editlabel=\"<%= button_edit_label %>\"><%= label %></h3>",
          "4:     <button class=\"close-button\" data-close aria-label=\"<%= t(\"layouts.decidim.upload_modal.close_modal\") %>\"",
          "5:       type=\"button\">",
          "6:       <span aria-hidden=\"true\">&times;</span>",
          "7:     </button>",
          "8:   </div>",
          "10:   <div class=\"help\">",
          "11:     <span><%= explanation %></span>",
          "12:     <ul>",
          "13:       <% help_messages.each do |message| %>",
          "14:         <li><%= message %></li>",
          "15:       <% end %>",
          "16:     </ul>",
          "17:   </div>",
          "18:   <div class=\"row dropzone-container\" data-name=\"<%= attribute %>\">",
          "19:     <%= tag.div class: \"upload-items\", data: {",
          "20:         locales: {",
          "21:           error: t(\"decidim.forms.upload.labels.error\"),",
          "22:           title_required: t(\"decidim.forms.upload.labels.title_required\"),",
          "23:           file_size_too_large: t(\"decidim.forms.upload.labels.file_size_too_large\", megabytes: (max_file_size_mb)),",
          "24:           remove: t(\"decidim.forms.upload.labels.remove\"),",
          "25:           title: t(\"decidim.forms.upload.labels.title\"),",
          "26:           uploaded: t(\"decidim.forms.upload.labels.uploaded\"),",
          "27:           validating: t(\"decidim.forms.upload.labels.validating\"),",
          "28:           validation_error: t(\"decidim.forms.upload.labels.validation_error\")",
          "29:         }",
          "30:       } %>",
          "31:     <label class=\"dropzone\">",
          "32:       <%= form.file_field add_attribute,",
          "33:         id: nil,",
          "34:         class: \"hide\",",
          "35:         label: false,",
          "36:         multiple: true,",
          "37:         direct_upload: true,",
          "38:         data: { direct_upload_url: direct_upload_url } %>",
          "39:       <span><%= t(\"decidim.forms.upload_help.dropzone\") %></span>",
          "40:     </label>",
          "41:   </div>",
          "43:   <div class=\"row columns reveal__content\">",
          "44:     <div class=\"text-center\">",
          "45:       <button class=\"button add-file-<%= attribute %>\" data-close><%= t(\"decidim.forms.upload.labels.save\") %></button>",
          "46:       <button class=\"link cancel-attachment margin-left-1\" data-close><%= t(\"decidim.forms.upload.labels.cancel\") %></button>",
          "47:     </div>",
          "48:   </div>",
          "49: </div>",
          "",
          "---------------"
        ],
        "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/modal.erb -> decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "20:         locales: {",
          "21:           error: t(\"decidim.forms.upload.labels.error\"),",
          "22:           title_required: t(\"decidim.forms.upload.labels.title_required\"),",
          "23:           file_size_too_large: t(\"decidim.forms.upload.labels.file_size_too_large\", megabytes: (max_file_size_mb)),",
          "24:           remove: t(\"decidim.forms.upload.labels.remove\"),",
          "25:           title: t(\"decidim.forms.upload.labels.title\"),",
          "",
          "[Removed Lines]",
          "1: <div class=\"reveal upload-modal\" id=\"<%= modal_id %>\" data-reveal>",
          "2:   <div class=\"reveal__header\">",
          "3:     <h3 class=\"reveal__title\" data-addlabel=\"<%= button_label %>\" data-editlabel=\"<%= button_edit_label %>\"><%= label %></h3>",
          "4:     <button class=\"close-button\" data-close aria-label=\"<%= t(\"layouts.decidim.upload_modal.close_modal\") %>\"",
          "5:       type=\"button\">",
          "6:       <span aria-hidden=\"true\">&times;</span>",
          "7:     </button>",
          "8:   </div>",
          "10:   <div class=\"help\">",
          "11:     <span><%= explanation %></span>",
          "12:     <ul>",
          "13:       <% help_messages.each do |message| %>",
          "14:         <li><%= message %></li>",
          "15:       <% end %>",
          "16:     </ul>",
          "17:   </div>",
          "18:   <div class=\"row dropzone-container\" data-name=\"<%= attribute %>\">",
          "19:     <%= tag.div class: \"upload-items\", data: {",
          "",
          "[Added Lines]",
          "1: <%= decidim_modal id: modal_id, class: \"upload-modal\" do %>",
          "2: <div data-dialog-container>",
          "3:   <%= icon \"upload-cloud-2-line\" %>",
          "4:   <h2 id=\"dialog-title-<%= modal_id %>\" data-dialog-title data-addlabel=\"<%= button_label %>\" data-editlabel=\"<%= button_edit_label %>\"><%= label %></h2>",
          "5:   <div>",
          "6:     <div data-name=\"<%= attribute %>\" class=\"upload-modal__dropzone-container\" data-dropzone>",
          "7:       <%= form.file_field add_attribute,",
          "8:         id: \"files-#{modal_id}\",",
          "9:         label: false,",
          "10:         required: false,",
          "11:         multiple: multiple,",
          "12:         direct_upload: true,",
          "13:         hidden: true,",
          "14:         data: { direct_upload_url: direct_upload_url } %>",
          "16:       <%= tag.ul id: \"dropzone-items\", class: \"upload-modal__dropzone\", hidden: true, data: {",
          "20:           filename: t(\"decidim.forms.upload.labels.filename\"),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28:           validation_error: t(\"decidim.forms.upload.labels.validation_error\")",
          "29:         }",
          "30:       } %>",
          "47:     </div>",
          "48:   </div>",
          "49: </div>",
          "",
          "[Removed Lines]",
          "31:     <label class=\"dropzone\">",
          "32:       <%= form.file_field add_attribute,",
          "33:         id: nil,",
          "34:         class: \"hide\",",
          "35:         label: false,",
          "36:         multiple: true,",
          "37:         direct_upload: true,",
          "38:         data: { direct_upload_url: direct_upload_url } %>",
          "39:       <span><%= t(\"decidim.forms.upload_help.dropzone\") %></span>",
          "40:     </label>",
          "41:   </div>",
          "43:   <div class=\"row columns reveal__content\">",
          "44:     <div class=\"text-center\">",
          "45:       <button class=\"button add-file-<%= attribute %>\" data-close><%= t(\"decidim.forms.upload.labels.save\") %></button>",
          "46:       <button class=\"link cancel-attachment margin-left-1\" data-close><%= t(\"decidim.forms.upload.labels.cancel\") %></button>",
          "",
          "[Added Lines]",
          "30:       <div id=\"dropzone-no-items\" class=\"upload-modal__dropzone\">",
          "31:         <div class=\"upload-modal__dropzone-placeholder\">",
          "32:           <span>",
          "33:             <%= icon \"upload-cloud-2-line\", class: \"w-8 h-8 text-gray fill-current\" %>",
          "34:             <%= t(\"decidim.forms.upload_help.dropzone\") %>",
          "35:           </span>",
          "36:           <label class=\"button button__sm button__secondary\" for=\"files-<%= modal_id %>\">",
          "37:             <span><%= t(\"decidim.forms.upload.select_file\") %></span>",
          "38:             <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "39:           </label>",
          "40:         </div>",
          "41:       </div>",
          "42:     </div>",
          "44:     <div class=\"upload-modal__text\">",
          "45:       <span id=\"dialog-desc-<%= modal_id %>\" class=\"sr-only\"><%= explanation %></span>",
          "46:       <ul>",
          "47:         <% help_messages.each do |message| %>",
          "48:           <li><%= message %></li>",
          "49:         <% end %>",
          "50:       </ul>",
          "54: <div data-dialog-actions>",
          "55:   <button type=\"button\" class=\"button button__sm md:button__lg button__transparent-secondary\" data-dropzone-cancel data-dialog-close=\"<%= modal_id %>\">",
          "56:     <%= t(\"decidim.shared.confirm_modal.cancel\") %>",
          "57:   </button>",
          "58:   <button type=\"button\" class=\"button button__sm md:button__lg button__secondary\" data-dropzone-save data-dialog-close=\"<%= modal_id %>\" disabled>",
          "59:     <%= t(\"next\", scope: \"decidim.messaging.conversations.index\") %>",
          "60:     <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "61:   </button>",
          "62: </div>",
          "63: <% end %>",
          "",
          "---------------"
        ],
        "decidim-core/app/cells/decidim/upload_modal/show.erb||decidim-core/app/cells/decidim/upload_modal/show.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/show.erb -> decidim-core/app/cells/decidim/upload_modal/show.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <%= render :files %>",
          "",
          "[Removed Lines]",
          "3: <%= render :modal %>",
          "",
          "[Added Lines]",
          "3: <%= render redesign_enabled? ? :modal : :legacy_modal %>",
          "",
          "---------------"
        ],
        "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb": [
          "File: decidim-core/app/cells/decidim/upload_modal_cell.rb -> decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: module Decidim",
          "4:   # This cell creates the necessary elements for dynamic uploads.",
          "5:   class UploadModalCell < Decidim::ViewModel",
          "6:     include Cell::ViewModel::Partial",
          "7:     include ERB::Util",
          "9:     alias form model",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:     include LayoutHelper",
          "9:     include Decidim::RedesignHelper",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "17:     private",
          "19:     def button_id",
          "20:       prefix = form.object_name.present? ? \"#{form.object_name}_\" : \"\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21:     # REDESIGN_PENDING: Remove once redesign is done. This cell is called from",
          "22:     # a form builder method and from there the context of controller is not",
          "23:     # available",
          "24:     def redesign_enabled?",
          "25:       return super if context.present? && context[:controller].present?",
          "27:       options[:redesigned]",
          "28:     end",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "23:     end",
          "25:     def button_class",
          "29:     end",
          "31:     def label",
          "",
          "[Removed Lines]",
          "26:       \"button small hollow add-field add-file\" if has_title?",
          "28:       \"button small add-file\"",
          "",
          "[Added Lines]",
          "37:       if redesign_enabled?",
          "38:         options[:button_class] || \"\"",
          "39:       else",
          "40:         \"button small hollow add-field add-file\" if has_title?",
          "42:         \"button small add-file\"",
          "43:       end",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "106:       \"with-title\" if has_title?",
          "107:     end",
          "115:     def help_messages",
          "116:       Array(options[:help])",
          "117:     end",
          "",
          "[Removed Lines]",
          "109:     def attachment_label",
          "110:       return I18n.t(\"current_image\", scope: \"decidim.forms\") if attachments.count.positive? && file_attachment_path(attachments.first).present?",
          "112:       I18n.t(\"default_image\", scope: \"decidim.forms\")",
          "113:     end",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "155:     def determine_filename(attachment)",
          "156:       return attachment.filename.to_s if attachment.is_a? ActiveStorage::Blob",
          "157:       return blob(attachment).filename.to_s if blob(attachment).present?",
          "159:       attachment.url.split(\"/\").last",
          "160:     end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:       return attachment.original_filename.to_s.presence || attachhment.path.split(\"/\").last if attachment.is_a? ActionDispatch::Http::UploadedFile",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "164:       return Rails.application.routes.url_helpers.rails_blob_url(attachment, only_path: true) if attachment.is_a? ActiveStorage::Blob",
          "166:       if attachment.try(:attached?)",
          "168:         return attachment_path if attachment_path.present?",
          "169:       end",
          "",
          "[Removed Lines]",
          "167:         attachment_path = Rails.application.routes.url_helpers&.rails_blob_url(attachment.blob, only_path: true)",
          "",
          "[Added Lines]",
          "177:         attachment_path = Rails.application.routes.url_helpers&.rails_blob_url(blob(attachment), only_path: true)",
          "",
          "---------------"
        ],
        "decidim-core/app/controllers/decidim/profiles_controller.rb||decidim-core/app/controllers/decidim/profiles_controller.rb": [
          "File: decidim-core/app/controllers/decidim/profiles_controller.rb -> decidim-core/app/controllers/decidim/profiles_controller.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:     helper Decidim::Messaging::ConversationHelper",
          "13:     before_action :ensure_profile_holder",
          "14:     before_action :ensure_profile_holder_is_a_group, only: [:members]",
          "",
          "[Removed Lines]",
          "11:     helper_method :profile_holder, :active_content",
          "",
          "[Added Lines]",
          "11:     helper_method :profile_holder, :active_content, :context_menu",
          "",
          "---------------"
        ],
        "decidim-core/app/helpers/decidim/modal_helper.rb||decidim-core/app/helpers/decidim/modal_helper.rb": [
          "File: decidim-core/app/helpers/decidim/modal_helper.rb -> decidim-core/app/helpers/decidim/modal_helper.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "15:     def decidim_modal(opts = {}, &)",
          "16:       opts[:closable] = true unless opts.has_key?(:closable)",
          "17:       button = opts[:closable] == false ? \"\" : content_tag(:button, \"&times\".html_safe, type: :button, data: { dialog_close: opts[:id] || \"\", dialog_closable: \"\" })",
          "22:         end",
          "23:       end",
          "24:     end",
          "",
          "[Removed Lines]",
          "18:       content_tag(:div, data: { dialog: opts[:id] || \"\" }) do",
          "19:         content_tag(:div, class: opts[:class]) do",
          "20:           button +",
          "21:             yield.html_safe",
          "",
          "[Added Lines]",
          "18:       content = opts[:remote].nil? ? button + capture(&).html_safe : icon(\"loader-3-line\")",
          "19:       content_tag(:div, id: opts[:id], data: { dialog: opts[:id] || \"\" }) do",
          "20:         content_tag(:div, id: \"#{opts[:id]}-content\", class: opts[:class]) do",
          "21:           content",
          "",
          "---------------"
        ],
        "decidim-core/app/helpers/decidim/redesign_helper.rb||decidim-core/app/helpers/decidim/redesign_helper.rb": [
          "File: decidim-core/app/helpers/decidim/redesign_helper.rb -> decidim-core/app/helpers/decidim/redesign_helper.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:       redesigned_name",
          "12:     end",
          "13:   end",
          "14: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14:     # REDESIGN_PENDING: When redesign enabled for all the controllers this",
          "15:     # method will be unnecessary and the dialog-open key should be used",
          "16:     # directly instead of calling this",
          "17:     def modal_open_key",
          "18:       redesign_enabled? ? \"dialog-open\" : \"open\"",
          "19:     end",
          "21:     def data_modal_open_key",
          "22:       \"data-#{modal_open_key}\"",
          "23:     end",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js -> decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_field.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import UploadModal from \"src/decidim/direct_uploads/redesigned_upload_modal\";",
          "2: import { truncateFilename } from \"src/decidim/direct_uploads/upload_utility\";",
          "4: const updateModalTitle = (modal) => {",
          "5:   if (modal.uploadItems.children.length === 0) {",
          "6:     modal.modalTitle.innerHTML = modal.modalTitle.dataset.addlabel;",
          "7:   } else {",
          "8:     modal.modalTitle.innerHTML = modal.modalTitle.dataset.editlabel;",
          "9:   }",
          "10:   modal.updateDropZone();",
          "11: }",
          "13: const updateActiveUploads = (modal) => {",
          "14:   const files = document.querySelector(\"[data-active-uploads]\")",
          "17:   files.textContent = \"\"",
          "20:   const [removeFiles, addFiles] = [modal.items.filter(({ removable }) => removable), modal.items.filter(({ removable }) => !removable)]",
          "22:   addFiles.forEach((file) => {",
          "23:     let title = truncateFilename(file.name, 19)",
          "25:     let hidden = `<input type=\"hidden\" name=\"${file.hiddenField.name}\" value=\"${file.hiddenField.value}\" />`",
          "26:     if (modal.options.titled) {",
          "27:       const value = modal.modal.querySelector('input[type=\"text\"]').value",
          "28:       title = `${value} (${truncateFilename(file.name)})`",
          "29:       hidden += `<input type=\"hidden\" name=\"${file.hiddenTitle.name}\" value=\"${value}\" />`",
          "30:     }",
          "32:     const template = `",
          "33:       <div data-filename=\"${file.name}\" data-title=\"${title}\">",
          "34:         <div><img src=\"\" alt=\"${file.name}\" /></div>",
          "35:         <span>${title}</span>",
          "36:         ${hidden}",
          "37:       </div>",
          "38:     `",
          "40:     const div = document.createElement(\"div\")",
          "41:     div.innerHTML = template.trim()",
          "43:     const container = div.firstChild",
          "45:     modal.autoloadImage(container, file)",
          "47:     files.appendChild(container)",
          "48:   });",
          "50:   removeFiles.forEach(() => {",
          "51:     const div = document.createElement(\"div\")",
          "52:     div.innerHTML = `<input name='${modal.options.resourceName}[remove_${modal.button.name}]' type=\"hidden\" value=\"true\">`",
          "53:     files.appendChild(div.firstChild)",
          "54:   })",
          "56:   modal.updateAddAttachmentsButton();",
          "57: }",
          "59: const highlightDropzone = (modal) => {",
          "60:   modal.emptyItems.classList.add(\"is-dragover\")",
          "61:   modal.uploadItems.classList.add(\"is-dragover\")",
          "62: }",
          "64: const resetDropzone = (modal) => {",
          "65:   modal.emptyItems.classList.remove(\"is-dragover\")",
          "66:   modal.uploadItems.classList.remove(\"is-dragover\")",
          "67: }",
          "71: document.addEventListener(\"DOMContentLoaded\", () => {",
          "72:   const attachmentButtons = document.querySelectorAll(\"button[data-upload]\");",
          "74:   attachmentButtons.forEach((attachmentButton) => {",
          "75:     const modal = new UploadModal(attachmentButton);",
          "78:     const files = document.querySelector(\"[data-active-uploads]\");",
          "79:     [...files.children].forEach((child) => modal.preloadFiles(child));",
          "82:     modal.input.addEventListener(\"change\", (event) => modal.uploadFiles(event.target.files));",
          "85:     modal.button.addEventListener(\"click\", (event) => event.preventDefault() || updateModalTitle(modal));",
          "88:     modal.dropZone.addEventListener(\"dragover\", (event) => event.preventDefault() || highlightDropzone(modal));",
          "89:     modal.dropZone.addEventListener(\"dragleave\", () => resetDropzone(modal));",
          "91:     modal.dropZone.addEventListener(\"drop\", (event) => event.preventDefault() || resetDropzone(modal) || modal.uploadFiles(event.dataTransfer.files));",
          "94:     modal.saveButton.addEventListener(\"click\", (event) => event.preventDefault() || updateActiveUploads(modal));",
          "96:     modal.cancelButton.addEventListener(\"click\", (event) => event.preventDefault() || modal.cleanAllFiles());",
          "97:   })",
          "98: })",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js -> decidim-core/app/packs/src/decidim/direct_uploads/redesigned_upload_modal.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import { Uploader } from \"src/decidim/direct_uploads/redesigned_uploader\";",
          "2: import icon from \"src/decidim/redesigned_icon\";",
          "3: import { truncateFilename } from \"src/decidim/direct_uploads/upload_utility\";",
          "5: const STATUS = {",
          "6:   VALIDATED: \"validated\",",
          "7:   ERROR: \"error\"",
          "8: }",
          "12: export default class UploadModal {",
          "13:   constructor(button, options = {}) {",
          "15:     this.button = button;",
          "19:     let providedOptions = {};",
          "20:     try {",
          "30:       providedOptions = JSON.parse(button.dataset.upload);",
          "31:     } catch (_e) {",
          "33:     }",
          "35:     this.options = Object.assign(providedOptions, options)",
          "37:     this.modal = document.querySelector(`#${button.dataset.dialogOpen}`);",
          "38:     this.saveButton = this.modal.querySelector(\"button[data-dropzone-save]\");",
          "39:     this.cancelButton = this.modal.querySelector(\"button[data-dropzone-cancel]\");",
          "40:     this.modalTitle = this.modal.querySelector(\"[data-dialog-title]\");",
          "41:     this.dropZone = this.modal.querySelector(\"[data-dropzone]\");",
          "43:     this.emptyItems = this.modal.querySelector(\"#dropzone-no-items\");",
          "44:     this.uploadItems = this.modal.querySelector(\"#dropzone-items\");",
          "45:     this.input = this.dropZone.querySelector(\"input\");",
          "46:     this.items = []",
          "48:     this.attachmentCounter = 0;",
          "49:     this.locales = JSON.parse(this.uploadItems.dataset.locales);",
          "51:     this.updateDropZone();",
          "52:   }",
          "54:   uploadFiles(files) {",
          "55:     if (this.options.multiple) {",
          "56:       Array.from(files).forEach((file) => this.uploadFile(file))",
          "57:     } else if (!this.uploadItems.children.length) {",
          "58:       this.uploadFile(files[0])",
          "59:     }",
          "60:   }",
          "62:   uploadFile(file) {",
          "63:     const uploader = new Uploader(this, {",
          "64:       file: file,",
          "65:       url: this.input.dataset.directUploadUrl,",
          "66:       attachmentName: file.name",
          "67:     });",
          "69:     const item = this.createUploadItem(file, uploader.errors)",
          "72:     this.uploadItems.appendChild(item);",
          "74:     if (uploader.errors.length) {",
          "75:       this.updateDropZone();",
          "76:     } else {",
          "77:       uploader.upload.create((error, blob) => {",
          "78:         if (error) {",
          "79:           uploader.errors = [error]",
          "80:         } else {",
          "82:           let name = `${this.options.resourceName}[${this.options.addAttribute}]`",
          "83:           if (this.options.titled) {",
          "84:             const ordinalNumber = this.getOrdinalNumber();",
          "86:             name = `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][file]`",
          "87:             file.hiddenTitle = { name: `${this.options.resourceName}[${this.options.addAttribute}][${ordinalNumber}][title]` }",
          "88:           }",
          "90:           file.hiddenField = { value: blob.signed_id, name }",
          "93:           uploader.validate(blob.signed_id).then(() => {",
          "94:             if (uploader.errors.length) {",
          "95:               this.uploadItems.replaceChild(this.createUploadItem(file, uploader.errors, { value: 100 }), item)",
          "96:             } else {",
          "98:               this.items.push(file)",
          "99:               this.autoloadImage(item, file)",
          "100:             }",
          "102:             this.updateDropZone();",
          "103:           });",
          "104:         }",
          "105:       });",
          "106:     }",
          "107:   }",
          "109:   autoloadImage(container, file) {",
          "110:     const reader = new FileReader();",
          "111:     reader.readAsDataURL(file);",
          "112:     reader.onload = ({ target: { result }}) => {",
          "113:       const img = container.querySelector(\"img\")",
          "114:       img.src = result",
          "115:     }",
          "116:   }",
          "118:   preloadFiles(element) {",
          "120:     const { src } = element.querySelector(\"img\")",
          "121:     return fetch(src).",
          "122:       then((res) => res.arrayBuffer()).",
          "123:       then((buffer) => {",
          "124:         const file = new File([buffer], element.dataset.filename)",
          "125:         const item = this.createUploadItem(file, [], { value: 100 })",
          "127:         this.items.push(file)",
          "128:         this.uploadItems.appendChild(item);",
          "129:         this.autoloadImage(item, file)",
          "130:       })",
          "131:   }",
          "133:   getOrdinalNumber() {",
          "134:     const nextOrdinalNumber = this.attachmentCounter;",
          "135:     this.attachmentCounter += 1;",
          "136:     return nextOrdinalNumber;",
          "137:   }",
          "139:   updateDropZone() {",
          "142:     const { children: files } = this.uploadItems",
          "143:     const inputHasFiles = files.length > 0",
          "144:     this.uploadItems.hidden = !inputHasFiles;",
          "147:     this.saveButton.disabled = Array.from(files).filter(({ dataset: { state } }) => state === STATUS.ERROR).length > 0;",
          "150:     const continueUpload = !files.length || this.options.multiple",
          "151:     this.input.disabled = !continueUpload",
          "152:     if (continueUpload) {",
          "153:       this.emptyItems.classList.remove(\"is-disabled\");",
          "154:       this.emptyItems.querySelector(\"label\").removeAttribute(\"disabled\");",
          "155:     } else {",
          "156:       this.emptyItems.classList.add(\"is-disabled\");",
          "157:       this.emptyItems.querySelector(\"label\").setAttribute(\"disabled\", true);",
          "158:     }",
          "159:   }",
          "161:   createUploadItem(file, errors, opts = {}) {",
          "162:     const okTemplate = `",
          "163:       <div><img src=\"\" alt=\"${file.name}\" /></div>",
          "164:       <span>${truncateFilename(file.name)}</span>",
          "165:     `",
          "167:     const errorTemplate = `",
          "168:       <div>${icon(\"error-warning-line\")}</div>",
          "169:       <div>",
          "170:         <span>${truncateFilename(file.name)}</span>",
          "171:         <span>${this.locales.validation_error}</span>",
          "172:         <ul>${errors.map((error) => `<li>${error}</li>`).join(\"\\n\")}</ul>",
          "173:       </div>",
          "174:     `",
          "176:     const titleTemplate = `",
          "177:       <div><img src=\"\" alt=\"${file.name}\" /></div>",
          "178:       <div>",
          "179:         <div>",
          "180:           <label>${this.locales.filename}</label>",
          "181:           <span>${truncateFilename(file.name)}</span>",
          "182:         </div>",
          "183:         <div>",
          "184:           <label>${this.locales.title}</label>",
          "185:           <input class=\"sm\" type=\"text\" placeholder=\"${truncateFilename(file.name)}\" />",
          "186:         </div>",
          "187:       </div>",
          "188:     `",
          "190:     let state = STATUS.VALIDATED",
          "191:     let content = okTemplate",
          "192:     let template = \"ok\"",
          "194:     if (errors.length) {",
          "195:       state = STATUS.ERROR",
          "196:       content = errorTemplate",
          "197:       template = \"error\"",
          "198:     }",
          "200:     if (!errors.length && this.options.titled) {",
          "201:       content = titleTemplate",
          "202:       template = \"titled\"",
          "203:     }",
          "205:     const fullTemplate = `",
          "206:       <li data-filename=\"${file.name}\" data-state=\"${state}\">",
          "207:         <div data-template=\"${template}\">",
          "208:           ${content.trim()}",
          "209:           <button>${this.locales.remove}</button>",
          "210:         </div>",
          "211:         <progress max=\"100\" value=\"${opts.value || 0}\"></progress>",
          "212:       </li>`",
          "214:     const div = document.createElement(\"div\")",
          "215:     div.innerHTML = fullTemplate.trim()",
          "217:     const container = div.firstChild",
          "220:     container.querySelector(\"button\").addEventListener(\"click\", this.handleButtonClick.bind(this))",
          "222:     return container;",
          "223:   }",
          "225:   handleButtonClick({ currentTarget }) {",
          "226:     const item = currentTarget.closest(\"[data-filename]\")",
          "227:     const { filename } = item.dataset",
          "230:     item.remove();",
          "233:     const ix = this.items.findIndex(({ name }) => name === filename)",
          "234:     if (ix > -1) {",
          "235:       this.items[ix].removable = true",
          "236:     }",
          "238:     this.updateDropZone();",
          "239:   }",
          "241:   setProgressBar(name, value) {",
          "242:     this.uploadItems.querySelector(`[data-filename=\"${name}\"] progress`).value = value",
          "243:   }",
          "245:   updateAddAttachmentsButton() {",
          "246:     if (this.uploadItems.children.length === 0) {",
          "247:       this.button.innerHTML = this.modalTitle.dataset.addlabel;",
          "248:     } else {",
          "249:       this.button.innerHTML = this.modalTitle.dataset.editlabel;",
          "250:     }",
          "251:   }",
          "253:   cleanAllFiles() {",
          "254:     this.items = []",
          "255:     this.uploadItems.textContent = \"\"",
          "256:     this.updateDropZone();",
          "257:   }",
          "258: }",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js||decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js -> decidim-core/app/packs/src/decidim/direct_uploads/redesigned_uploader.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import { DirectUpload } from \"@rails/activestorage\";",
          "3: export class Uploader {",
          "4:   constructor(modal, options) {",
          "5:     this.modal = modal;",
          "6:     this.options = options;",
          "7:     this.validationSent = false;",
          "8:     this.errors = []",
          "10:     if (modal.options.maxFileSize && options.file.size > modal.options.maxFileSize) {",
          "11:       this.errors = [modal.locales.file_size_too_large]",
          "12:     } else {",
          "13:       this.upload = new DirectUpload(options.file, options.url, this);",
          "14:     }",
          "15:   }",
          "17:   validate(blobId) {",
          "18:     const callback = (data) => {",
          "19:       let errors = []",
          "20:       for (const [, value] of Object.entries(data)) {",
          "21:         errors = errors.concat(value);",
          "22:       }",
          "24:       if (errors.length) {",
          "25:         this.errors = errors;",
          "26:       }",
          "27:     }",
          "29:     if (!this.validationSent) {",
          "30:       let property = this.modal.options.addAttribute;",
          "31:       if (this.modal.options.titled) {",
          "32:         property = \"file\"",
          "33:       }",
          "34:       const params = new URLSearchParams({",
          "35:         resourceClass: this.modal.options.resourceClass,",
          "36:         property: property,",
          "37:         blob: blobId,",
          "38:         formClass: this.modal.options.formObjectClass",
          "39:       });",
          "41:       return fetch(`/upload_validations?${params.toString()}`, {",
          "42:         method: \"POST\",",
          "43:         headers: {",
          "44:           \"Content-Type\": \"application/json\",",
          "45:           \"X-CSRF-Token\": $(\"meta[name=csrf-token]\").attr(\"content\")",
          "46:         }",
          "47:       }).",
          "48:         then((response) => response.json()).",
          "49:         then((data) => {",
          "50:           this.validationSent = true;",
          "51:           callback(data);",
          "52:         });",
          "53:     }",
          "55:     return Promise.resolve()",
          "56:   }",
          "60:   directUploadWillStoreFileWithXHR(request) {",
          "61:     request.upload.addEventListener(\"progress\", ({ loaded, total }) => this.modal.setProgressBar(this.options.attachmentName, Math.floor(loaded / total * 100)));",
          "62:   }",
          "63: }",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js||decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js": [
          "File: decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js -> decidim-core/app/packs/src/decidim/direct_uploads/upload_utility.js"
        ],
        "decidim-core/app/packs/src/decidim/index.js||decidim-core/app/packs/src/decidim/index.js": [
          "File: decidim-core/app/packs/src/decidim/index.js -> decidim-core/app/packs/src/decidim/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: import fixDropdownMenus from \"src/decidim/dropdowns_menus\"",
          "6: import createQuillEditor from \"src/decidim/editor\"",
          "7: import Configuration from \"src/decidim/configuration\"",
          "9: import updateExternalDomainLinks from \"src/decidim/external_domain_warning\"",
          "10: import scrollToLastChild from \"src/decidim/scroll_to_last_child\"",
          "12: import FormValidator from \"src/decidim/form_validator\"",
          "13: import DataPicker from \"src/decidim/data_picker\"",
          "14: import FormFilterComponent from \"src/decidim/form_filter\"",
          "",
          "[Removed Lines]",
          "8: import ExternalLink from \"src/decidim/redesigned_external_link\"",
          "11: import InputCharacterCounter, { createCharacterCounter } from \"src/decidim/redesigned_input_character_counter\"",
          "",
          "[Added Lines]",
          "8: import ExternalLink from \"src/decidim/external_link\"",
          "11: import InputCharacterCounter, { createCharacterCounter } from \"src/decidim/input_character_counter\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73:     createQuillEditor(container);",
          "74:   });",
          "79:   $(\"input[type='text'], textarea, .editor>input[type='hidden']\").each((_i, elem) => {",
          "",
          "[Removed Lines]",
          "76:   document.querySelectorAll(\"a[target=\\\"_blank\\\"]:not([data-external-link=\\\"false\\\"])\").forEach((elem) => new ExternalLink(elem))",
          "",
          "[Added Lines]",
          "76:   $('a[target=\"_blank\"]').each((_i, elem) => {",
          "77:     const $link = $(elem);",
          "78:     $link.data(\"external-link\", new ExternalLink($link));",
          "79:   });",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/src/decidim/redesigned_index.js||decidim-core/app/packs/src/decidim/redesigned_index.js": [
          "File: decidim-core/app/packs/src/decidim/redesigned_index.js -> decidim-core/app/packs/src/decidim/redesigned_index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "60: import \"./identity_selector_dialog\"",
          "61: import \"./gallery\"",
          "65: import formDatePicker from \"./form_datepicker\"",
          "",
          "[Removed Lines]",
          "62: import \"./direct_uploads/upload_field\"",
          "",
          "[Added Lines]",
          "62: import \"./direct_uploads/redesigned_upload_field\"",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss": [
          "File: decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss -> decidim-core/app/packs/stylesheets/decidim/_redesigned_conversations.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:   }",
          "90:   &__modal{",
          "99:     &-results{",
          "100:       @apply mb-20 flex flex-wrap gap-x-8 gap-y-4;",
          "101:     }",
          "",
          "[Removed Lines]",
          "91:     &-container{",
          "92:       @apply flex items-start gap-2 last:[&>*]:grow last:[&>*]:pr-6;",
          "93:     }",
          "95:     &-title{",
          "96:       @apply text-2xl text-black font-semibold;",
          "97:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "126:         @apply flex items-center gap-1;",
          "127:       }",
          "128:     }",
          "133:   }",
          "134: }",
          "",
          "[Removed Lines]",
          "130:     &-actions{",
          "131:       @apply flex justify-between items-center;",
          "132:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss": [
          "File: decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss -> decidim-core/app/packs/stylesheets/decidim/_redesigned_modal.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: [data-dialog]{",
          "2:   @apply invisible opacity-0 fixed z-50 inset-0 bg-[rgba(0,0,0,0.25)] transition duration-300;",
          "6:   }",
          "8:   &[aria-hidden=\"false\"]{",
          "",
          "[Removed Lines]",
          "4:   >*{",
          "5:     @apply absolute inset-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] lg:max-w-[900px] h-fit p-6 bg-white z-50 rounded shadow-[0_4px_6px_rgba(211,211,211,0.25)];",
          "",
          "[Added Lines]",
          "4:   & > *{",
          "5:     @apply absolute inset-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] lg:max-w-[900px] max-h-screen h-fit overflow-y-auto p-6 bg-white z-50 rounded shadow-[0_4px_6px_rgba(211,211,211,0.25)];",
          "7:     & > svg:only-child{",
          "8:       @apply w-8 h-8 mx-auto text-gray-2 fill-current animate-spin;",
          "9:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "12:   [data-dialog-closable]{",
          "13:     @apply absolute top-4 right-4 text-2xl text-secondary outline-none;",
          "14:   }",
          "15: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20:   [data-dialog-container]{",
          "21:     @apply flex items-start gap-2 last:[&>*]:grow last:[&>*]:pr-6;",
          "23:     > svg{",
          "24:       @apply w-6 h-6 text-gray fill-current flex-none;",
          "25:     }",
          "26:   }",
          "28:   [data-dialog-title]{",
          "29:     @apply text-2xl text-black font-semibold;",
          "30:   }",
          "32:   [data-dialog-actions]{",
          "33:     @apply flex justify-between items-center only:[&>*]:ml-auto;",
          "34:   }",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss||decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss": [
          "File: decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss -> decidim-core/app/packs/stylesheets/decidim/_redesigned_modal_update.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: .upload-modal{",
          "2:   &__dropzone{",
          "3:     @apply bg-background px-5 py-6 rounded max-h-[50vh] overflow-y-auto border-2 border-transparent;",
          "5:     &[hidden] + &:last-child{",
          "6:       @apply py-14;",
          "7:     }",
          "9:     &-container{",
          "10:       @apply mt-4 md:mt-12 space-y-4;",
          "11:     }",
          "13:     &-placeholder{",
          "14:       @apply w-full flex flex-col md:flex-row items-center justify-between gap-4 font-semibold text-gray-2 text-md [&>span]:inline-flex [&>span]:items-center [&>span]:gap-2;",
          "15:     }",
          "17:     &.is-dragover:not(.is-disabled):last-child{",
          "18:       @apply border-2 border-secondary border-dashed bg-background-4 [&_*]:pointer-events-none;",
          "19:     }",
          "21:     [data-filename]{",
          "22:       @apply w-full flex flex-col gap-4;",
          "24:       [data-template]{",
          "25:         @apply grow flex flex-col md:flex-row items-center justify-start gap-6;",
          "27:         > *:first-child{",
          "28:           @apply w-24 flex-none flex justify-center;",
          "29:         }",
          "31:         span{",
          "32:           @apply text-gray-2 text-sm;",
          "33:         }",
          "34:       }",
          "36:       [data-template=\"error\"]{",
          "37:         svg{",
          "38:           @apply w-16 h-16 text-primary fill-current;",
          "39:         }",
          "41:         span:nth-child(2){",
          "42:           @apply text-primary font-semibold;",
          "43:         }",
          "45:         li{",
          "46:           @apply text-gray-2 text-sm;",
          "47:         }",
          "48:       }",
          "50:       [data-template=\"error\"] div:not(:first-child){",
          "51:         @apply flex flex-col gap-2 [&_label]:font-semibold;",
          "52:       }",
          "54:       [data-template=\"titled\"] div:not(:first-child){",
          "55:         @apply flex items-stretch gap-12 [&>div]:flex [&>div]:flex-col [&>div]:gap-2 [&_label]:font-semibold;",
          "56:       }",
          "58:       img{",
          "59:         @apply h-full object-cover;",
          "60:       }",
          "62:       button{",
          "63:         @apply w-full md:w-auto md:ml-auto button button__sm button__transparent-primary;",
          "64:       }",
          "66:       progress{",
          "67:         @apply w-full h-1 appearance-none rounded-full overflow-hidden;",
          "69:         &::-webkit-progress-value{",
          "70:           @apply bg-success;",
          "71:         }",
          "73:         &::-webkit-progress-bar{",
          "74:           @apply bg-white;",
          "75:         }",
          "77:         &::-moz-progress-bar{",
          "78:           @apply bg-success;",
          "79:         }",
          "80:       }",
          "82:       [data-template=\"error\"] + progress{",
          "83:         &::-webkit-progress-value{",
          "84:           @apply bg-alert;",
          "85:         }",
          "87:         &::-moz-progress-bar{",
          "88:           @apply bg-alert;",
          "89:         }",
          "90:       }",
          "92:       & + [data-filename]{",
          "93:         @apply mt-6;",
          "94:       }",
          "96:       &:only-child progress{",
          "97:         @apply h-4 rounded;",
          "98:       }",
          "99:     }",
          "100:   }",
          "102:   &__text{",
          "103:     @apply text-sm text-gray-2 mt-4 mb-8 md:mb-20;",
          "105:     ul,",
          "106:     ol{",
          "107:       @apply list-disc pl-4;",
          "108:     }",
          "109:   }",
          "111:   &__files{",
          "112:     @apply mt-1 space-y-4;",
          "114:     > *{",
          "115:       @apply flex flex-col gap-2;",
          "117:       div{",
          "118:         @apply w-full rounded bg-background flex items-center justify-center py-4 [&_img]:object-cover [&_img]:h-[200px];",
          "119:       }",
          "121:       span{",
          "122:         @apply text-sm text-gray-2 mx-auto;",
          "123:       }",
          "124:     }",
          "125:   }",
          "126: }",
          "",
          "---------------"
        ],
        "decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss||decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss": [
          "File: decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss -> decidim-core/app/packs/stylesheets/decidim/redesigned_application.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "44:   @import \"stylesheets/decidim/redesigned_drawer.scss\";",
          "45:   @import \"stylesheets/decidim/redesigned_drawer_metadata.scss\";",
          "46:   @import \"stylesheets/decidim/redesigned_modal.scss\";",
          "47: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:   @import \"stylesheets/decidim/redesigned_modal_update.scss\";",
          "",
          "---------------"
        ],
        "decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb||decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb": [
          "File: decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb -> decidim-core/app/views/decidim/messaging/conversations/_add_conversation_users.html.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:   <div>",
          "5:     <div class=\"form__wrapper gap-1 js-multiple-mentions\" data-name=\"recipient_id[]\" data-multiple=\"true\">",
          "6:       <label for=\"add_conversation_users\">",
          "7:         <%= t(\"decidim.metrics.participants.title\") %>",
          "",
          "[Removed Lines]",
          "1: <div class=\"conversation__modal-container\">",
          "2:   <%= icon \"question-answer-line\", class: \"w-6 h-6 text-gray fill-current flex-none\" %>",
          "4:     <h2 id=\"dialog-title-conversation\" class=\"conversation__modal-title\"><%= t(\".modal_title\") %></h2>",
          "",
          "[Added Lines]",
          "1: <div data-dialog-container>",
          "2:   <%= icon \"question-answer-line\" %>",
          "4:     <h2 id=\"dialog-title-conversation\" data-dialog-title><%= t(\".modal_title\") %></h2>",
          "",
          "---------------"
        ],
        "decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb||decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb": [
          "File: decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb -> decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:   <%= decidim_form_for(@form, url: conversations_check_multiple_url, html: { class: \"form\", id: nil }) do |f| %>",
          "8:     <%= render \"add_conversation_users\", object: f, locals: { title: \"new title\" } %>",
          "11:       <button type=\"button\" class=\"button button__sm md:button__lg button__transparent-secondary\" data-dialog-close=\"conversation\">",
          "12:         <%= t(\"decidim.shared.confirm_modal.cancel\") %>",
          "13:       </button>",
          "",
          "[Removed Lines]",
          "10:     <div class=\"conversation__modal-actions\">",
          "",
          "[Added Lines]",
          "10:     <div data-dialog-actions>",
          "",
          "---------------"
        ],
        "decidim-core/lib/decidim/form_builder.rb||decidim-core/lib/decidim/form_builder.rb": [
          "File: decidim-core/lib/decidim/form_builder.rb -> decidim-core/lib/decidim/form_builder.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "461:       max_file_size = options[:max_file_size] || max_file_size(object, attribute)",
          "462:       button_label = options[:button_label] || choose_button_label(attribute)",
          "463:       help_messages = options[:help] || upload_help(object, attribute, options)",
          "465:       options = {",
          "466:         attribute:,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "464:       redesigned = @template.redesign_enabled?",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "473:         help: help_messages,",
          "474:         label: label_for(attribute),",
          "475:         button_label:,",
          "477:       }.merge(options)",
          "479:       ::Decidim::ViewModel.cell(",
          "",
          "[Removed Lines]",
          "476:         button_edit_label: I18n.t(\"decidim.forms.upload.labels.replace\")",
          "",
          "[Added Lines]",
          "477:         button_edit_label: I18n.t(\"decidim.forms.upload.labels.replace\"),",
          "478:         redesigned:",
          "",
          "---------------"
        ],
        "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb": [
          "File: decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb -> decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:       resource_name:,",
          "31:       attachments:,",
          "32:       optional:,",
          "34:     }",
          "35:   end",
          "36:   let(:attribute) { \"dummy_attribute\" }",
          "",
          "[Removed Lines]",
          "33:       titled:",
          "",
          "[Added Lines]",
          "33:       titled:,",
          "34:       redesigned:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "38:   let(:attachments) { [] }",
          "39:   let(:optional) { true }",
          "40:   let(:titled) { false }",
          "42:   before do",
          "43:     allow(Decidim::FileValidatorHumanizer).to receive(:new).and_return(file_validation_humanizer)",
          "44:   end",
          "48:   end",
          "52:   end",
          "56:   end",
          "58:   context \"when file is required\" do",
          "",
          "[Removed Lines]",
          "46:   it \"renders the open button\" do",
          "47:     expect(subject).to have_css(\".add-file[type='button']\")",
          "50:   it \"renders modal\" do",
          "51:     expect(subject).to have_css(\".upload-modal\")",
          "54:   it \"renders dropzone\" do",
          "55:     expect(subject).to have_css(\".dropzone\")",
          "",
          "[Added Lines]",
          "42:   let(:redesigned) { false }",
          "44:   shared_examples \"a not redesigned cell\" do",
          "45:     it \"renders the open button\" do",
          "46:       expect(subject).to have_css(\".add-file[type='button']\")",
          "47:     end",
          "49:     it \"renders modal\" do",
          "50:       expect(subject).to have_css(\".upload-modal\")",
          "51:     end",
          "53:     it \"renders dropzone\" do",
          "54:       expect(subject).to have_css(\".dropzone\")",
          "55:     end",
          "56:   end",
          "58:   shared_examples \"a redesigned cell\" do",
          "59:     it \"renders the open button\" do",
          "60:       expect(subject).to have_css(\"[data-upload][type='button']\")",
          "61:     end",
          "63:     it \"renders modal\" do",
          "64:       expect(subject).to have_css(\".upload-modal\")",
          "65:     end",
          "67:     it \"renders dropzone\" do",
          "68:       expect(subject).to have_css(\"[data-dropzone]\")",
          "69:     end",
          "70:   end",
          "76:   context \"without redesigned option\" do",
          "77:     let(:options) do",
          "78:       {",
          "79:         attribute:,",
          "80:         resource_name:,",
          "81:         attachments:,",
          "82:         optional:,",
          "83:         titled:",
          "84:       }",
          "85:     end",
          "87:     it_behaves_like \"a not redesigned cell\"",
          "90:   context \"with redesigned option disabled\" do",
          "91:     it_behaves_like \"a not redesigned cell\"",
          "94:   context \"with redesigned option enabled\" do",
          "95:     let(:redesigned) { true }",
          "97:     it_behaves_like \"a redesigned cell\"",
          "",
          "---------------"
        ],
        "decidim-core/spec/lib/form_builder_spec.rb||decidim-core/spec/lib/form_builder_spec.rb": [
          "File: decidim-core/spec/lib/form_builder_spec.rb -> decidim-core/spec/lib/form_builder_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:     let(:available_locales) { %w(ca en de-CH) }",
          "10:     let(:uploader) { Decidim::ApplicationUploader }",
          "11:     let(:organization) { create(:organization) }",
          "13:     let(:resource) do",
          "14:       klass = Class.new do",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12:     let(:redesign_enabled?) { false }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77:     before do",
          "78:       allow(Decidim).to receive(:available_locales).and_return available_locales",
          "79:       allow(I18n.config).to receive(:enforce_available_locales).and_return(false)",
          "80:     end",
          "82:     describe \"#editor\" do",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:       allow(helper).to receive(:redesign_enabled?).and_return(redesign_enabled?)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "720:           let(:file) { nil }",
          "721:           let(:uploader) { Decidim::AvatarUploader }",
          "725:           end",
          "726:         end",
          "728:         context \"and it is present\" do",
          "729:           let(:present?) { true }",
          "735:           it \"renders an image with the current file url\" do",
          "736:             expect(parsed.css(\"img[src=\\\"#{url}\\\"]\")).not_to be_empty",
          "737:           end",
          "",
          "[Removed Lines]",
          "723:           it \"renders the 'Default image' label\" do",
          "724:             expect(output).to include(\"Default image\")",
          "731:           it \"renders the 'Current image' label\" do",
          "732:             expect(output).to include(\"Current image\")",
          "733:           end",
          "",
          "[Added Lines]",
          "725:           it \"renders an image with the default url\" do",
          "726:             expect(parsed.css(\"img[src=\\\"#{resource.attached_uploader.default_url}\\\"]\")).not_to be_empty",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "768:         let(:present?) { true }",
          "770:         it \"renders the add file button\" do",
          "772:         end",
          "773:       end",
          "",
          "[Removed Lines]",
          "771:           expect(parsed.css(\"button.add-file\")).not_to be_empty",
          "",
          "[Added Lines]",
          "769:           expect(parsed.css(\"button[data-upload]\")).not_to be_empty",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/proposals_fields_spec.rb||decidim-proposals/spec/system/proposals_fields_spec.rb": [
          "File: decidim-proposals/spec/system/proposals_fields_spec.rb -> decidim-proposals/spec/system/proposals_fields_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "352:               # See that the images are in correct positions and remove the card",
          "353:               # image.",
          "355:                 expect(page).to have_content(\"city.jpeg\")",
          "356:               end",
          "358:                 expect(page).to have_content(\"city2.jpeg\")",
          "359:                 expect(page).to have_content(\"city3.jpeg\")",
          "360:               end",
          "363:                 click_button \"Edit image\"",
          "364:               end",
          "365:               within \".upload-modal\" do",
          "",
          "[Removed Lines]",
          "354:               within \".dynamic-uploads.upload-container-for-photos .active-uploads\" do",
          "357:               within \".dynamic-uploads.upload-container-for-documents .active-uploads\" do",
          "362:               within \".dynamic-uploads.upload-container-for-photos\" do",
          "",
          "[Added Lines]",
          "354:               within \".upload-container-for-photos .active-uploads\" do",
          "357:               within \".upload-container-for-documents .active-uploads\" do",
          "362:               within \".upload-container-for-photos\" do",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "378:               # See that the card image is now empty and the two other images",
          "379:               # are still in the documents container as they should.",
          "381:                 expect(page).not_to have_selector(\".attachment-details\")",
          "382:               end",
          "384:                 expect(page).to have_content(\"city2.jpeg\")",
          "385:                 expect(page).to have_content(\"city3.jpeg\")",
          "386:               end",
          "",
          "[Removed Lines]",
          "380:               within \".dynamic-uploads.upload-container-for-photos .active-uploads\" do",
          "383:               within \".dynamic-uploads.upload-container-for-documents .active-uploads\" do",
          "",
          "[Added Lines]",
          "380:               within \".upload-container-for-photos .active-uploads\" do",
          "383:               within \".upload-container-for-documents .active-uploads\" do",
          "",
          "---------------"
        ],
        "decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb||decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb": [
          "File: decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb -> decidim-verifications/app/views/decidim/verifications/id_documents/authorizations/_form.html.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:   </div>",
          "12:   <% if using_online? %>",
          "16:   <% end %>",
          "18:   <%= form.hidden_field :verification_type, value: verification_type %>",
          "",
          "[Removed Lines]",
          "13:     <div class=\"field\">",
          "14:       <%= form.upload :verification_attachment %>",
          "15:     </div>",
          "",
          "[Added Lines]",
          "13:     <%= form.upload :verification_attachment, button_class: \"button button__lg button__transparent-secondary verification__upload-button\" %>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "547a5659b20998ecab3fcfde3f230c8e243ca0d1",
      "candidate_info": {
        "commit_hash": "547a5659b20998ecab3fcfde3f230c8e243ca0d1",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/547a5659b20998ecab3fcfde3f230c8e243ca0d1",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
        ],
        "message": "Fix double parentheses in the titled upload modal with existing attachment (#10221)",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
          ],
          "candidate": [
            "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb",
            "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal_cell.rb||decidim-core/app/cells/decidim/upload_modal_cell.rb": [
          "File: decidim-core/app/cells/decidim/upload_modal_cell.rb -> decidim-core/app/cells/decidim/upload_modal_cell.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "150:     end",
          "152:     def file_name_for(attachment)",
          "158:     end",
          "160:     def determine_filename(attachment)",
          "",
          "[Removed Lines]",
          "153:       filename = determine_filename(attachment)",
          "155:       return \"(#{filename})\" if has_title?",
          "157:       filename",
          "",
          "[Added Lines]",
          "153:       determine_filename(attachment)",
          "",
          "---------------"
        ],
        "decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb||decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb": [
          "File: decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb -> decidim-core/spec/cells/decidim/upload_modal_cell_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:   context \"when attachment is present\" do",
          "117:     let(:filename) { \"Exampledocument.pdf\" }",
          "120:     it \"renders the attachments\" do",
          "121:       expect(subject).to have_css(\".attachment-details\")",
          "",
          "[Removed Lines]",
          "118:     let(:attachments) { [upload_test_file(Decidim::Dev.test_file(filename, \"application/pdf\"))] }",
          "",
          "[Added Lines]",
          "118:     let(:file) { Decidim::Dev.test_file(filename, \"application/pdf\") }",
          "119:     let(:attachments) { [upload_test_file(file)] }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "129:         expect(subject).to have_selector(\"img[alt='#{attribute}']\")",
          "130:       end",
          "131:     end",
          "132:   end",
          "133: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "134:     context \"when attachment is titled\" do",
          "135:       let(:attachments) { [create(:attachment, file:)] }",
          "136:       let(:titled) { true }",
          "138:       before do",
          "139:         allow(form).to receive(:hidden_field).and_return(",
          "140:           %(<input type=\"hidden\" name=\"#{attribute}[]\" value=\"#{attachments[0].id}\">)",
          "141:         )",
          "142:       end",
          "144:       it \"renders the attachments\" do",
          "145:         expect(subject).to have_css(\".attachment-details\")",
          "146:         expect(subject).to have_selector(\"[data-filename='#{filename}']\")",
          "148:         details = subject.find(\".attachment-details\")",
          "149:         expect(details).to have_content(\"#{attachments[0].title[\"en\"]} (#{filename})\")",
          "150:       end",
          "151:     end",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b297797bb55da6dc850c7b8b75b9b11c3ef8e884",
      "candidate_info": {
        "commit_hash": "b297797bb55da6dc850c7b8b75b9b11c3ef8e884",
        "repo": "decidim/decidim",
        "commit_url": "https://github.com/decidim/decidim/commit/b297797bb55da6dc850c7b8b75b9b11c3ef8e884",
        "files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-core/config/locales/en.yml",
          "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb",
          "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb"
        ],
        "message": "Label changes on Save button in Modals (#13047)\n\n* updates to styling and i18n changes made on accountaility\n\n* missing translations\n\n* updated the dynamic attach condition for save value\n\n* updated specs to include string change from Next to Save\n\n* rspec updated in participatory processes\n\n* Update decidim-core/app/cells/decidim/upload_modal/modal.erb\n\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>\n\n* Update decidim-core/app/cells/decidim/user_conversations/new_conversation_button.erb\n\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>\n\n* Update decidim-core/app/views/decidim/messaging/conversations/_new_conversation_button.html.erb\n\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>\n\n* updated yml file\n\n* updated yml file\n\n* push updates to test\n\n* Update decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb\n\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>\n\n---------\n\nCo-authored-by: Andr\u00e9s Pereira de Lucena <andreslucena@users.noreply.github.com>",
        "before_after_code_files": [
          "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb||decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb||decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb||decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb",
          "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb||decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ],
          "candidate": [
            "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "decidim-core/app/cells/decidim/upload_modal/modal.erb||decidim-core/app/cells/decidim/upload_modal/modal.erb": [
          "File: decidim-core/app/cells/decidim/upload_modal/modal.erb -> decidim-core/app/cells/decidim/upload_modal/modal.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     <%= t(\"decidim.shared.confirm_modal.cancel\") %>",
          "61:   </button>",
          "62:   <button type=\"button\" class=\"button button__sm md:button__lg button__secondary\" data-dropzone-save data-dialog-close=\"<%= modal_id %>\" disabled>",
          "65:   </button>",
          "66: </div>",
          "67: <% end %>",
          "",
          "[Removed Lines]",
          "63:     <%= t(\"next\", scope: \"decidim.messaging.conversations.index\") %>",
          "64:     <%= icon \"arrow-right-line\", class: \"fill-current\" %>",
          "",
          "[Added Lines]",
          "63:     <%= t(\"save\", scope: \"decidim.forms.upload.labels\") %>",
          "",
          "---------------"
        ],
        "decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb||decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb": [
          "File: decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb -> decidim-dev/lib/decidim/dev/test/rspec_support/dynamic_attach.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "23:           expect(page).to have_content(filename.first(12)) if front_interface",
          "24:         end",
          "25:         all(title_input(front_interface)).last.set(options[:title]) if options.has_key?(:title)",
          "27:       end",
          "28:     end",
          "",
          "[Removed Lines]",
          "26:         click_on(front_interface ? \"Next\" : \"Save\") unless options[:keep_modal_open]",
          "",
          "[Added Lines]",
          "26:         click_on(\"Save\") unless options[:keep_modal_open]",
          "",
          "---------------"
        ],
        "decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb||decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb": [
          "File: decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb -> decidim-participatory_processes/spec/system/admin/admin_manages_participatory_process_groups_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "137:       end",
          "139:       click_on \"Remove\"",
          "142:       click_on \"Update\"",
          "",
          "[Removed Lines]",
          "140:       click_on \"Next\"",
          "",
          "[Added Lines]",
          "140:       click_on \"Save\"",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb||decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb": [
          "File: decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb -> decidim-proposals/spec/system/admin/admin_edits_proposal_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "105:         find(\"input#proposal_attachment_delete_file\").set(true)",
          "106:         click_on(\"Replace\")",
          "107:         click_on(\"Remove\")",
          "109:         dynamically_attach_file(:proposal_attachment_file, Decidim::Dev.asset(\"city.jpeg\"))",
          "111:         click_on(\"Update\")",
          "",
          "[Removed Lines]",
          "108:         click_on(\"Next\")",
          "",
          "[Added Lines]",
          "108:         click_on(\"Save\")",
          "",
          "---------------"
        ],
        "decidim-proposals/spec/system/edit_proposal_spec.rb||decidim-proposals/spec/system/edit_proposal_spec.rb": [
          "File: decidim-proposals/spec/system/edit_proposal_spec.rb -> decidim-proposals/spec/system/edit_proposal_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:             within \"[data-filename='Exampledocument.pdf']\" do",
          "77:               click_on(\"Remove\")",
          "78:             end",
          "80:           end",
          "82:           click_on \"Send\"",
          "",
          "[Removed Lines]",
          "79:             click_on \"Next\"",
          "",
          "[Added Lines]",
          "79:             click_on \"Save\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "101:               within \"[data-filename='Exampledocument.pdf']\" do",
          "102:                 find(\"input[type='text']\").set(attachment_file_title)",
          "103:               end",
          "105:             end",
          "106:             click_on \"Send\"",
          "107:             expect(page).to have_css(\"[data-alert-box].success\")",
          "",
          "[Removed Lines]",
          "104:               click_on \"Next\"",
          "",
          "[Added Lines]",
          "104:               click_on \"Save\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "126:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "127:             click_on(\"Edit documents\")",
          "128:             within \"[data-dialog]\" do",
          "130:             end",
          "131:             click_on(\"Send\")",
          "132:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "",
          "[Removed Lines]",
          "129:               click_on(\"Next\")",
          "",
          "[Added Lines]",
          "129:               click_on(\"Save\")",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "148:             expect(page).to have_content(\"Required fields are marked with an asterisk\")",
          "149:             click_on(\"Edit documents\")",
          "150:             within \"[data-dialog]\" do",
          "152:             end",
          "153:             click_on(\"Send\")",
          "154:             expect(page).to have_content(\"Proposal successfully updated.\")",
          "",
          "[Removed Lines]",
          "151:               click_on(\"Next\")",
          "",
          "[Added Lines]",
          "151:               click_on(\"Save\")",
          "",
          "---------------"
        ],
        "decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb||decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb": [
          "File: decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb -> decidim-verifications/spec/system/id_documents/id_document_online_upload_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     )",
          "40:     expect(page).to have_content(\"Validation error!\")",
          "42:   end",
          "44:   private",
          "",
          "[Removed Lines]",
          "41:     expect(page).to have_css(\"button[disabled]\", text: \"Next\")",
          "",
          "[Added Lines]",
          "41:     expect(page).to have_css(\"button[disabled]\", text: \"Save\")",
          "",
          "---------------"
        ]
      }
    }
  ]
}