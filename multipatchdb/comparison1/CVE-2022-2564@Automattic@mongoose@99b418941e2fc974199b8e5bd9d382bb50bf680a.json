{
  "cve_id": "CVE-2022-2564",
  "cve_desc": "Prototype Pollution in GitHub repository automattic/mongoose prior to 6.4.6.",
  "repo": "Automattic/mongoose",
  "patch_hash": "99b418941e2fc974199b8e5bd9d382bb50bf680a",
  "patch_info": {
    "commit_hash": "99b418941e2fc974199b8e5bd9d382bb50bf680a",
    "repo": "Automattic/mongoose",
    "commit_url": "https://github.com/Automattic/mongoose/commit/99b418941e2fc974199b8e5bd9d382bb50bf680a",
    "files": [
      "lib/schema.js",
      "test/schema.test.js"
    ],
    "message": "Merge pull request #12297 from shubanker/issue/prototype-pollution-5.x-patch\n\nCVE-2022-2564 vulnerability for version 5.x",
    "before_after_code_files": [
      "lib/schema.js||lib/schema.js",
      "test/schema.test.js||test/schema.test.js"
    ]
  },
  "patch_diff": {
    "lib/schema.js||lib/schema.js": [
      "File: lib/schema.js -> lib/schema.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "478:   const keys = Object.keys(obj);",
      "480:   for (const key of keys) {",
      "481:     const fullPath = prefix + key;",
      "483:     if (obj[key] == null) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "481:     if (utils.specialProperties.has(key)) {",
      "482:       continue;",
      "483:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "663:   let fullPath = '';",
      "665:   for (const sub of subpaths) {",
      "666:     fullPath = fullPath += (fullPath.length > 0 ? '.' : '') + sub;",
      "667:     if (!branch[sub]) {",
      "668:       this.nested[fullPath] = true;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "670:     if (utils.specialProperties.has(sub)) {",
      "671:       throw new Error('Cannot set special property `' + sub + '` on a schema');",
      "672:     }",
      "",
      "---------------"
    ],
    "test/schema.test.js||test/schema.test.js": [
      "File: test/schema.test.js -> test/schema.test.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "2682:     assert.equal(TestSchema.path('testprop.$*').instance, 'Number');",
      "2683:     assert.equal(TestSchema.path('testprop.$*').options.ref, 'OtherModel');",
      "2684:   });",
      "2685: });",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2686:   it('disallows setting special properties with `add()` or constructor (gh-12085)', function() {",
      "2687:     const maliciousPayload = '{\"__proto__.toString\": \"Number\"}';",
      "2689:     assert.throws(() => {",
      "2690:       mongoose.Schema(JSON.parse(maliciousPayload));",
      "2691:     }, /__proto__/);",
      "2693:     assert.ok({}.toString());",
      "2694:   });",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6a197316564742c0422309e1b5fecfa4faec126e",
      "candidate_info": {
        "commit_hash": "6a197316564742c0422309e1b5fecfa4faec126e",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/6a197316564742c0422309e1b5fecfa4faec126e",
        "files": [
          "lib/schema.js",
          "test/schema.test.js"
        ],
        "message": "fix(schema): disallow setting __proto__ when creating schema with dotted properties\n\nFix #12085",
        "before_after_code_files": [
          "lib/schema.js||lib/schema.js",
          "test/schema.test.js||test/schema.test.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/Automattic/mongoose/pull/12297"
        ],
        "olp_code_files": {
          "patch": [
            "lib/schema.js||lib/schema.js",
            "test/schema.test.js||test/schema.test.js"
          ],
          "candidate": [
            "lib/schema.js||lib/schema.js",
            "test/schema.test.js||test/schema.test.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/schema.js||lib/schema.js": [
          "File: lib/schema.js -> lib/schema.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "478:   const keys = Object.keys(obj);",
          "480:   for (const key of keys) {",
          "481:     const fullPath = prefix + key;",
          "483:     if (obj[key] == null) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "481:     if (utils.specialProperties.has(key)) {",
          "482:       continue;",
          "483:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "663:   let fullPath = '';",
          "665:   for (const sub of subpaths) {",
          "666:     fullPath = fullPath += (fullPath.length > 0 ? '.' : '') + sub;",
          "667:     if (!branch[sub]) {",
          "668:       this.nested[fullPath] = true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "670:     if (utils.specialProperties.has(sub)) {",
          "671:       throw new Error('Cannot set special property `' + sub + '` on a schema');",
          "672:     }",
          "",
          "---------------"
        ],
        "test/schema.test.js||test/schema.test.js": [
          "File: test/schema.test.js -> test/schema.test.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "2682:     assert.equal(TestSchema.path('testprop.$*').instance, 'Number');",
          "2683:     assert.equal(TestSchema.path('testprop.$*').options.ref, 'OtherModel');",
          "2684:   });",
          "2685: });",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2686:   it('disallows setting special properties with `add()` or constructor (gh-12085)', async function() {",
          "2687:     const maliciousPayload = '{\"__proto__.toString\": \"Number\"}';",
          "2689:     assert.throws(() => {",
          "2690:       mongoose.Schema(JSON.parse(maliciousPayload));",
          "2691:     }, /__proto__/);",
          "2693:     assert.ok({}.toString());",
          "2694:   });",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5eb11dd5d434ba24ea10d19e5eb2054a276bb22e",
      "candidate_info": {
        "commit_hash": "5eb11dd5d434ba24ea10d19e5eb2054a276bb22e",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/5eb11dd5d434ba24ea10d19e5eb2054a276bb22e",
        "files": [
          "test/schema.test.js"
        ],
        "message": "made function non async",
        "before_after_code_files": [
          "test/schema.test.js||test/schema.test.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/Automattic/mongoose/pull/12297"
        ],
        "olp_code_files": {
          "patch": [
            "test/schema.test.js||test/schema.test.js"
          ],
          "candidate": [
            "test/schema.test.js||test/schema.test.js"
          ]
        }
      },
      "candidate_diff": {
        "test/schema.test.js||test/schema.test.js": [
          "File: test/schema.test.js -> test/schema.test.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "2682:     assert.equal(TestSchema.path('testprop.$*').instance, 'Number');",
          "2683:     assert.equal(TestSchema.path('testprop.$*').options.ref, 'OtherModel');",
          "2684:   });",
          "2687:     const maliciousPayload = '{\"__proto__.toString\": \"Number\"}';",
          "2689:     assert.throws(() => {",
          "",
          "[Removed Lines]",
          "2686:   it('disallows setting special properties with `add()` or constructor (gh-12085)', async function() {",
          "",
          "[Added Lines]",
          "2686:   it('disallows setting special properties with `add()` or constructor (gh-12085)', function() {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a1144dc0220929de0e9b7faf93d793c10e77f094",
      "candidate_info": {
        "commit_hash": "a1144dc0220929de0e9b7faf93d793c10e77f094",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/a1144dc0220929de0e9b7faf93d793c10e77f094",
        "files": [
          ".github/workflows/test.yml"
        ],
        "message": "test: run node 7 tests with upgraded npm re: #12297",
        "before_after_code_files": []
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {}
    },
    {
      "candidate_hash": "4d813fa01bb9170f4e0a91d0f3f5234bc163d501",
      "candidate_info": {
        "commit_hash": "4d813fa01bb9170f4e0a91d0f3f5234bc163d501",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/4d813fa01bb9170f4e0a91d0f3f5234bc163d501",
        "files": [
          "package.json"
        ],
        "message": "test: fix @types/node version in tests re: #12297",
        "before_after_code_files": []
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {}
    },
    {
      "candidate_hash": "dfc4ad750bf91ae5743ed8dce676bf5a96041a6d",
      "candidate_info": {
        "commit_hash": "dfc4ad750bf91ae5743ed8dce676bf5a96041a6d",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/dfc4ad750bf91ae5743ed8dce676bf5a96041a6d",
        "files": [
          ".github/workflows/test.yml"
        ],
        "message": "test: try upgrading npm for node v4 tests re: #12297",
        "before_after_code_files": []
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {}
    }
  ]
}