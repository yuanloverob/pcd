{
  "cve_id": "CVE-2024-43400",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. It is possible for a user without Script or Programming rights to craft a URL pointing to a page with arbitrary JavaScript. This requires social engineer to trick a user to follow the URL. This has been patched in XWiki 14.10.21, 15.5.5, 15.10.6 and 16.0.0.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "27eca8423fc1ad177518077a733076821268509c",
  "patch_info": {
    "commit_hash": "27eca8423fc1ad177518077a733076821268509c",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/27eca8423fc1ad177518077a733076821268509c",
    "files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
    ],
    "message": "XWIKI-21810: Improve suggest URL escaping in StringClass\n\n(cherry picked from commit ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc)",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: package com.xpn.xwiki.objects.classes;",
      "22: import org.apache.ecs.xhtml.input;",
      "23: import org.xwiki.xml.XMLUtils;",
      "25: import com.xpn.xwiki.XWiki;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: import java.util.LinkedHashMap;",
      "23: import java.util.Map;",
      "26: import org.xwiki.velocity.tools.EscapeTool;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "30: import com.xpn.xwiki.objects.StringProperty;",
      "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
      "33: public class StringClass extends PropertyClass",
      "34: {",
      "35:     private static final long serialVersionUID = 1L;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "89:     }",
      "91:     @Override",
      "93:     {",
      "94:         input input = new input();",
      "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
      "",
      "[Removed Lines]",
      "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
      "",
      "[Added Lines]",
      "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
      "99:         XWikiContext context)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "105:         input.setDisabled(isDisabled());",
      "107:         if (isPicker()) {",
      "122:         }",
      "125:     }",
      "127:     @Override",
      "",
      "[Removed Lines]",
      "108:             input.setClass(\"suggested\");",
      "109:             String path = \"\";",
      "110:             XWiki xwiki = context.getWiki();",
      "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
      "113:             String classname = this.getObject().getName();",
      "114:             String fieldname = this.getName();",
      "115:             String secondCol = \"-\", firstCol = \"-\";",
      "117:             String script =",
      "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
      "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
      "120:             String varname = \"\\\"input\\\"\";",
      "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
      "124:         buffer.append(input.toString());",
      "",
      "[Added Lines]",
      "115:             displayPickerEdit(input);",
      "117:         buffer.append(input);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
      "134:         }",
      "135:     }",
      "136: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "130:     private void displayPickerEdit(input input)",
      "131:     {",
      "132:         input.setClass(\"suggested\");",
      "133:         XWikiContext xWikiContext = getXWikiContext();",
      "134:         XWiki xwiki = xWikiContext.getWiki();",
      "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
      "136:         StringBuilder stringBuilder = new StringBuilder();",
      "137:         stringBuilder.append(path);",
      "138:         stringBuilder.append('?');",
      "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
      "140:         stringBuilder.append('&');",
      "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
      "142:             escapeJavaScript(stringBuilder.toString())));",
      "143:     }",
      "145:     private Map<String, String> getParametersMap()",
      "146:     {",
      "147:         String dash = \"-\";",
      "150:         Map<String, String> parameters = new LinkedHashMap<>();",
      "151:         parameters.put(\"xpage\", \"suggest\");",
      "152:         parameters.put(\"classname\", getObject().getName());",
      "153:         parameters.put(\"fieldname\", getName());",
      "154:         parameters.put(\"firCol\", dash);",
      "155:         parameters.put(\"secCol\", dash);",
      "156:         return parameters;",
      "157:     }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package com.xpn.xwiki.objects.classes;",
      "22: import org.junit.jupiter.api.Test;",
      "23: import org.mockito.Mock;",
      "24: import org.xwiki.model.reference.DocumentReference;",
      "26: import com.xpn.xwiki.XWikiContext;",
      "27: import com.xpn.xwiki.test.MockitoOldcore;",
      "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
      "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
      "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
      "31: import com.xpn.xwiki.web.XWikiURLFactory;",
      "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "34: import static org.mockito.Mockito.when;",
      "41: @OldcoreTest",
      "42: @XWikiDocumentFilterUtilsComponentList",
      "43: class StringClassTest",
      "44: {",
      "45:     @InjectMockitoOldcore",
      "46:     private MockitoOldcore oldCore;",
      "48:     @Mock",
      "49:     private XWikiURLFactory urlFactory;",
      "51:     @Test",
      "52:     void displayEdit()",
      "53:     {",
      "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
      "55:         xWikiContext.setURLFactory(this.urlFactory);",
      "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
      "58:         String fieldName = \"test\";",
      "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
      "60:         String pageName = \"WebHome\";",
      "61:         StringClass stringClass = new StringClass();",
      "62:         stringClass.setPicker(true);",
      "63:         BaseClass baseClass = new BaseClass();",
      "64:         stringClass.setObject(baseClass);",
      "65:         baseClass.setDocumentReference(",
      "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
      "67:         stringClass.setName(fieldName);",
      "68:         StringBuffer stringBuffer = new StringBuffer();",
      "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
      "70:             xWikiContext);",
      "71:         assertEquals(\"<input \"",
      "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
      "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
      "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
      "75:             + \"size='30' \"",
      "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
      "77:             + \"class='suggested' \"",
      "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
      "79:             + \"type='text'/>\", stringBuffer.toString());",
      "80:     }",
      "81: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7134dcd2296fa0d086eb519c676599405f1897a0",
      "candidate_info": {
        "commit_hash": "7134dcd2296fa0d086eb519c676599405f1897a0",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/7134dcd2296fa0d086eb519c676599405f1897a0",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ],
        "message": "XWIKI-21810: Improve suggest URL escaping in StringClass\n\n(cherry picked from commit ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.apache.ecs.xhtml.input;",
          "23: import org.xwiki.xml.XMLUtils;",
          "25: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.LinkedHashMap;",
          "23: import java.util.Map;",
          "26: import org.xwiki.velocity.tools.EscapeTool;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30: import com.xpn.xwiki.objects.StringProperty;",
          "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
          "33: public class StringClass extends PropertyClass",
          "34: {",
          "35:     private static final long serialVersionUID = 1L;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     @Override",
          "93:     {",
          "94:         input input = new input();",
          "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
          "",
          "[Removed Lines]",
          "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
          "",
          "[Added Lines]",
          "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
          "99:         XWikiContext context)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:         input.setDisabled(isDisabled());",
          "107:         if (isPicker()) {",
          "122:         }",
          "125:     }",
          "127:     @Override",
          "",
          "[Removed Lines]",
          "108:             input.setClass(\"suggested\");",
          "109:             String path = \"\";",
          "110:             XWiki xwiki = context.getWiki();",
          "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
          "113:             String classname = this.getObject().getName();",
          "114:             String fieldname = this.getName();",
          "115:             String secondCol = \"-\", firstCol = \"-\";",
          "117:             String script =",
          "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
          "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
          "120:             String varname = \"\\\"input\\\"\";",
          "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
          "124:         buffer.append(input.toString());",
          "",
          "[Added Lines]",
          "115:             displayPickerEdit(input);",
          "117:         buffer.append(input);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
          "134:         }",
          "135:     }",
          "136: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     private void displayPickerEdit(input input)",
          "131:     {",
          "132:         input.setClass(\"suggested\");",
          "133:         XWikiContext xWikiContext = getXWikiContext();",
          "134:         XWiki xwiki = xWikiContext.getWiki();",
          "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
          "136:         StringBuilder stringBuilder = new StringBuilder();",
          "137:         stringBuilder.append(path);",
          "138:         stringBuilder.append('?');",
          "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
          "140:         stringBuilder.append('&');",
          "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
          "142:             escapeJavaScript(stringBuilder.toString())));",
          "143:     }",
          "145:     private Map<String, String> getParametersMap()",
          "146:     {",
          "147:         String dash = \"-\";",
          "150:         Map<String, String> parameters = new LinkedHashMap<>();",
          "151:         parameters.put(\"xpage\", \"suggest\");",
          "152:         parameters.put(\"classname\", getObject().getName());",
          "153:         parameters.put(\"fieldname\", getName());",
          "154:         parameters.put(\"firCol\", dash);",
          "155:         parameters.put(\"secCol\", dash);",
          "156:         return parameters;",
          "157:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.junit.jupiter.api.Test;",
          "23: import org.mockito.Mock;",
          "24: import org.xwiki.model.reference.DocumentReference;",
          "26: import com.xpn.xwiki.XWikiContext;",
          "27: import com.xpn.xwiki.test.MockitoOldcore;",
          "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
          "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "31: import com.xpn.xwiki.web.XWikiURLFactory;",
          "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "34: import static org.mockito.Mockito.when;",
          "41: @OldcoreTest",
          "42: @XWikiDocumentFilterUtilsComponentList",
          "43: class StringClassTest",
          "44: {",
          "45:     @InjectMockitoOldcore",
          "46:     private MockitoOldcore oldCore;",
          "48:     @Mock",
          "49:     private XWikiURLFactory urlFactory;",
          "51:     @Test",
          "52:     void displayEdit()",
          "53:     {",
          "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
          "55:         xWikiContext.setURLFactory(this.urlFactory);",
          "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
          "58:         String fieldName = \"test\";",
          "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
          "60:         String pageName = \"WebHome\";",
          "61:         StringClass stringClass = new StringClass();",
          "62:         stringClass.setPicker(true);",
          "63:         BaseClass baseClass = new BaseClass();",
          "64:         stringClass.setObject(baseClass);",
          "65:         baseClass.setDocumentReference(",
          "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
          "67:         stringClass.setName(fieldName);",
          "68:         StringBuffer stringBuffer = new StringBuffer();",
          "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
          "70:             xWikiContext);",
          "71:         assertEquals(\"<input \"",
          "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
          "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
          "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
          "75:             + \"size='30' \"",
          "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "77:             + \"class='suggested' \"",
          "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "79:             + \"type='text'/>\", stringBuffer.toString());",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7f209c75b1c727fc2c88f570e2a488c6f866b1fe",
      "candidate_info": {
        "commit_hash": "7f209c75b1c727fc2c88f570e2a488c6f866b1fe",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/7f209c75b1c727fc2c88f570e2a488c6f866b1fe",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ],
        "message": "XWIKI-21810: Improve suggest URL escaping in StringClass\n\n(cherry picked from commit ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.apache.ecs.xhtml.input;",
          "23: import org.xwiki.xml.XMLUtils;",
          "25: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.LinkedHashMap;",
          "23: import java.util.Map;",
          "26: import org.xwiki.velocity.tools.EscapeTool;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30: import com.xpn.xwiki.objects.StringProperty;",
          "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
          "33: public class StringClass extends PropertyClass",
          "34: {",
          "35:     private static final long serialVersionUID = 1L;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     @Override",
          "93:     {",
          "94:         input input = new input();",
          "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
          "",
          "[Removed Lines]",
          "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
          "",
          "[Added Lines]",
          "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
          "99:         XWikiContext context)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:         input.setDisabled(isDisabled());",
          "107:         if (isPicker()) {",
          "122:         }",
          "125:     }",
          "127:     @Override",
          "",
          "[Removed Lines]",
          "108:             input.setClass(\"suggested\");",
          "109:             String path = \"\";",
          "110:             XWiki xwiki = context.getWiki();",
          "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
          "113:             String classname = this.getObject().getName();",
          "114:             String fieldname = this.getName();",
          "115:             String secondCol = \"-\", firstCol = \"-\";",
          "117:             String script =",
          "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
          "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
          "120:             String varname = \"\\\"input\\\"\";",
          "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
          "124:         buffer.append(input.toString());",
          "",
          "[Added Lines]",
          "115:             displayPickerEdit(input);",
          "117:         buffer.append(input);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
          "134:         }",
          "135:     }",
          "136: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     private void displayPickerEdit(input input)",
          "131:     {",
          "132:         input.setClass(\"suggested\");",
          "133:         XWikiContext xWikiContext = getXWikiContext();",
          "134:         XWiki xwiki = xWikiContext.getWiki();",
          "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
          "136:         StringBuilder stringBuilder = new StringBuilder();",
          "137:         stringBuilder.append(path);",
          "138:         stringBuilder.append('?');",
          "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
          "140:         stringBuilder.append('&');",
          "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
          "142:             escapeJavaScript(stringBuilder.toString())));",
          "143:     }",
          "145:     private Map<String, String> getParametersMap()",
          "146:     {",
          "147:         String dash = \"-\";",
          "150:         Map<String, String> parameters = new LinkedHashMap<>();",
          "151:         parameters.put(\"xpage\", \"suggest\");",
          "152:         parameters.put(\"classname\", getObject().getName());",
          "153:         parameters.put(\"fieldname\", getName());",
          "154:         parameters.put(\"firCol\", dash);",
          "155:         parameters.put(\"secCol\", dash);",
          "156:         return parameters;",
          "157:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.junit.jupiter.api.Test;",
          "23: import org.mockito.Mock;",
          "24: import org.xwiki.model.reference.DocumentReference;",
          "26: import com.xpn.xwiki.XWikiContext;",
          "27: import com.xpn.xwiki.test.MockitoOldcore;",
          "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
          "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "31: import com.xpn.xwiki.web.XWikiURLFactory;",
          "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "34: import static org.mockito.Mockito.when;",
          "41: @OldcoreTest",
          "42: @XWikiDocumentFilterUtilsComponentList",
          "43: class StringClassTest",
          "44: {",
          "45:     @InjectMockitoOldcore",
          "46:     private MockitoOldcore oldCore;",
          "48:     @Mock",
          "49:     private XWikiURLFactory urlFactory;",
          "51:     @Test",
          "52:     void displayEdit()",
          "53:     {",
          "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
          "55:         xWikiContext.setURLFactory(this.urlFactory);",
          "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
          "58:         String fieldName = \"test\";",
          "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
          "60:         String pageName = \"WebHome\";",
          "61:         StringClass stringClass = new StringClass();",
          "62:         stringClass.setPicker(true);",
          "63:         BaseClass baseClass = new BaseClass();",
          "64:         stringClass.setObject(baseClass);",
          "65:         baseClass.setDocumentReference(",
          "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
          "67:         stringClass.setName(fieldName);",
          "68:         StringBuffer stringBuffer = new StringBuffer();",
          "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
          "70:             xWikiContext);",
          "71:         assertEquals(\"<input \"",
          "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
          "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
          "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
          "75:             + \"size='30' \"",
          "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "77:             + \"class='suggested' \"",
          "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "79:             + \"type='text'/>\", stringBuffer.toString());",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c52c4b01473983ea1b6617f0118de4feb66943a6",
      "candidate_info": {
        "commit_hash": "c52c4b01473983ea1b6617f0118de4feb66943a6",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/c52c4b01473983ea1b6617f0118de4feb66943a6",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ],
        "message": "XWIKI-21810: Improve suggest URL escaping in StringClass\n\n(cherry picked from commit ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.apache.ecs.xhtml.input;",
          "23: import org.xwiki.xml.XMLUtils;",
          "25: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.LinkedHashMap;",
          "23: import java.util.Map;",
          "26: import org.xwiki.velocity.tools.EscapeTool;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30: import com.xpn.xwiki.objects.StringProperty;",
          "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
          "33: public class StringClass extends PropertyClass",
          "34: {",
          "35:     private static final long serialVersionUID = 1L;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     @Override",
          "93:     {",
          "94:         input input = new input();",
          "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
          "",
          "[Removed Lines]",
          "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
          "",
          "[Added Lines]",
          "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
          "99:         XWikiContext context)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:         input.setDisabled(isDisabled());",
          "107:         if (isPicker()) {",
          "122:         }",
          "125:     }",
          "127:     @Override",
          "",
          "[Removed Lines]",
          "108:             input.setClass(\"suggested\");",
          "109:             String path = \"\";",
          "110:             XWiki xwiki = context.getWiki();",
          "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
          "113:             String classname = this.getObject().getName();",
          "114:             String fieldname = this.getName();",
          "115:             String secondCol = \"-\", firstCol = \"-\";",
          "117:             String script =",
          "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
          "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
          "120:             String varname = \"\\\"input\\\"\";",
          "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
          "124:         buffer.append(input.toString());",
          "",
          "[Added Lines]",
          "115:             displayPickerEdit(input);",
          "117:         buffer.append(input);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
          "134:         }",
          "135:     }",
          "136: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     private void displayPickerEdit(input input)",
          "131:     {",
          "132:         input.setClass(\"suggested\");",
          "133:         XWikiContext xWikiContext = getXWikiContext();",
          "134:         XWiki xwiki = xWikiContext.getWiki();",
          "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
          "136:         StringBuilder stringBuilder = new StringBuilder();",
          "137:         stringBuilder.append(path);",
          "138:         stringBuilder.append('?');",
          "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
          "140:         stringBuilder.append('&');",
          "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
          "142:             escapeJavaScript(stringBuilder.toString())));",
          "143:     }",
          "145:     private Map<String, String> getParametersMap()",
          "146:     {",
          "147:         String dash = \"-\";",
          "150:         Map<String, String> parameters = new LinkedHashMap<>();",
          "151:         parameters.put(\"xpage\", \"suggest\");",
          "152:         parameters.put(\"classname\", getObject().getName());",
          "153:         parameters.put(\"fieldname\", getName());",
          "154:         parameters.put(\"firCol\", dash);",
          "155:         parameters.put(\"secCol\", dash);",
          "156:         return parameters;",
          "157:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.junit.jupiter.api.Test;",
          "23: import org.mockito.Mock;",
          "24: import org.xwiki.model.reference.DocumentReference;",
          "26: import com.xpn.xwiki.XWikiContext;",
          "27: import com.xpn.xwiki.test.MockitoOldcore;",
          "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
          "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "31: import com.xpn.xwiki.web.XWikiURLFactory;",
          "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "34: import static org.mockito.Mockito.when;",
          "41: @OldcoreTest",
          "42: @XWikiDocumentFilterUtilsComponentList",
          "43: class StringClassTest",
          "44: {",
          "45:     @InjectMockitoOldcore",
          "46:     private MockitoOldcore oldCore;",
          "48:     @Mock",
          "49:     private XWikiURLFactory urlFactory;",
          "51:     @Test",
          "52:     void displayEdit()",
          "53:     {",
          "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
          "55:         xWikiContext.setURLFactory(this.urlFactory);",
          "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
          "58:         String fieldName = \"test\";",
          "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
          "60:         String pageName = \"WebHome\";",
          "61:         StringClass stringClass = new StringClass();",
          "62:         stringClass.setPicker(true);",
          "63:         BaseClass baseClass = new BaseClass();",
          "64:         stringClass.setObject(baseClass);",
          "65:         baseClass.setDocumentReference(",
          "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
          "67:         stringClass.setName(fieldName);",
          "68:         StringBuffer stringBuffer = new StringBuffer();",
          "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
          "70:             xWikiContext);",
          "71:         assertEquals(\"<input \"",
          "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
          "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
          "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
          "75:             + \"size='30' \"",
          "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "77:             + \"class='suggested' \"",
          "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "79:             + \"type='text'/>\", stringBuffer.toString());",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "27eca8423fc1ad177518077a733076821268509c",
      "candidate_info": {
        "commit_hash": "27eca8423fc1ad177518077a733076821268509c",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/27eca8423fc1ad177518077a733076821268509c",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ],
        "message": "XWIKI-21810: Improve suggest URL escaping in StringClass\n\n(cherry picked from commit ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.apache.ecs.xhtml.input;",
          "23: import org.xwiki.xml.XMLUtils;",
          "25: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.LinkedHashMap;",
          "23: import java.util.Map;",
          "26: import org.xwiki.velocity.tools.EscapeTool;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30: import com.xpn.xwiki.objects.StringProperty;",
          "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
          "33: public class StringClass extends PropertyClass",
          "34: {",
          "35:     private static final long serialVersionUID = 1L;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     @Override",
          "93:     {",
          "94:         input input = new input();",
          "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
          "",
          "[Removed Lines]",
          "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
          "",
          "[Added Lines]",
          "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
          "99:         XWikiContext context)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:         input.setDisabled(isDisabled());",
          "107:         if (isPicker()) {",
          "122:         }",
          "125:     }",
          "127:     @Override",
          "",
          "[Removed Lines]",
          "108:             input.setClass(\"suggested\");",
          "109:             String path = \"\";",
          "110:             XWiki xwiki = context.getWiki();",
          "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
          "113:             String classname = this.getObject().getName();",
          "114:             String fieldname = this.getName();",
          "115:             String secondCol = \"-\", firstCol = \"-\";",
          "117:             String script =",
          "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
          "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
          "120:             String varname = \"\\\"input\\\"\";",
          "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
          "124:         buffer.append(input.toString());",
          "",
          "[Added Lines]",
          "115:             displayPickerEdit(input);",
          "117:         buffer.append(input);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
          "134:         }",
          "135:     }",
          "136: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     private void displayPickerEdit(input input)",
          "131:     {",
          "132:         input.setClass(\"suggested\");",
          "133:         XWikiContext xWikiContext = getXWikiContext();",
          "134:         XWiki xwiki = xWikiContext.getWiki();",
          "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
          "136:         StringBuilder stringBuilder = new StringBuilder();",
          "137:         stringBuilder.append(path);",
          "138:         stringBuilder.append('?');",
          "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
          "140:         stringBuilder.append('&');",
          "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
          "142:             escapeJavaScript(stringBuilder.toString())));",
          "143:     }",
          "145:     private Map<String, String> getParametersMap()",
          "146:     {",
          "147:         String dash = \"-\";",
          "150:         Map<String, String> parameters = new LinkedHashMap<>();",
          "151:         parameters.put(\"xpage\", \"suggest\");",
          "152:         parameters.put(\"classname\", getObject().getName());",
          "153:         parameters.put(\"fieldname\", getName());",
          "154:         parameters.put(\"firCol\", dash);",
          "155:         parameters.put(\"secCol\", dash);",
          "156:         return parameters;",
          "157:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.junit.jupiter.api.Test;",
          "23: import org.mockito.Mock;",
          "24: import org.xwiki.model.reference.DocumentReference;",
          "26: import com.xpn.xwiki.XWikiContext;",
          "27: import com.xpn.xwiki.test.MockitoOldcore;",
          "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
          "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "31: import com.xpn.xwiki.web.XWikiURLFactory;",
          "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "34: import static org.mockito.Mockito.when;",
          "41: @OldcoreTest",
          "42: @XWikiDocumentFilterUtilsComponentList",
          "43: class StringClassTest",
          "44: {",
          "45:     @InjectMockitoOldcore",
          "46:     private MockitoOldcore oldCore;",
          "48:     @Mock",
          "49:     private XWikiURLFactory urlFactory;",
          "51:     @Test",
          "52:     void displayEdit()",
          "53:     {",
          "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
          "55:         xWikiContext.setURLFactory(this.urlFactory);",
          "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
          "58:         String fieldName = \"test\";",
          "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
          "60:         String pageName = \"WebHome\";",
          "61:         StringClass stringClass = new StringClass();",
          "62:         stringClass.setPicker(true);",
          "63:         BaseClass baseClass = new BaseClass();",
          "64:         stringClass.setObject(baseClass);",
          "65:         baseClass.setDocumentReference(",
          "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
          "67:         stringClass.setName(fieldName);",
          "68:         StringBuffer stringBuffer = new StringBuffer();",
          "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
          "70:             xWikiContext);",
          "71:         assertEquals(\"<input \"",
          "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
          "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
          "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
          "75:             + \"size='30' \"",
          "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "77:             + \"class='suggested' \"",
          "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "79:             + \"type='text'/>\", stringBuffer.toString());",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc",
      "candidate_info": {
        "commit_hash": "ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/ec18f3ab4e9463749cfe43c29d481a6a7bb5a3cc",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ],
        "message": "XWIKI-21810: Improve suggest URL escaping in StringClass",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/objects/classes/StringClass.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.apache.ecs.xhtml.input;",
          "23: import org.xwiki.xml.XMLUtils;",
          "25: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.LinkedHashMap;",
          "23: import java.util.Map;",
          "26: import org.xwiki.velocity.tools.EscapeTool;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "30: import com.xpn.xwiki.objects.StringProperty;",
          "31: import com.xpn.xwiki.objects.meta.PropertyMetaClass;",
          "33: public class StringClass extends PropertyClass",
          "34: {",
          "35:     private static final long serialVersionUID = 1L;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: import static org.apache.commons.lang.StringEscapeUtils.escapeJavaScript;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     @Override",
          "93:     {",
          "94:         input input = new input();",
          "95:         input.setAttributeFilter(new XMLAttributeValueFilter());",
          "",
          "[Removed Lines]",
          "92:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object, XWikiContext context)",
          "",
          "[Added Lines]",
          "98:     public void displayEdit(StringBuffer buffer, String name, String prefix, BaseCollection object,",
          "99:         XWikiContext context)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:         input.setDisabled(isDisabled());",
          "107:         if (isPicker()) {",
          "122:         }",
          "125:     }",
          "127:     @Override",
          "",
          "[Removed Lines]",
          "108:             input.setClass(\"suggested\");",
          "109:             String path = \"\";",
          "110:             XWiki xwiki = context.getWiki();",
          "111:             path = xwiki.getURL(\"Main.WebHome\", \"view\", context);",
          "113:             String classname = this.getObject().getName();",
          "114:             String fieldname = this.getName();",
          "115:             String secondCol = \"-\", firstCol = \"-\";",
          "117:             String script =",
          "118:                 \"\\\"\" + path + \"?xpage=suggest&classname=\" + classname + \"&fieldname=\" + fieldname + \"&firCol=\"",
          "119:                     + firstCol + \"&secCol=\" + secondCol + \"&\\\"\";",
          "120:             String varname = \"\\\"input\\\"\";",
          "121:             input.setOnFocus(\"new ajaxSuggest(this, {script:\" + script + \", varname:\" + varname + \"} )\");",
          "124:         buffer.append(input.toString());",
          "",
          "[Added Lines]",
          "115:             displayPickerEdit(input);",
          "117:         buffer.append(input);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:             buffer.append(XMLUtils.escapeElementText(property.toText()));",
          "134:         }",
          "135:     }",
          "136: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     private void displayPickerEdit(input input)",
          "131:     {",
          "132:         input.setClass(\"suggested\");",
          "133:         XWikiContext xWikiContext = getXWikiContext();",
          "134:         XWiki xwiki = xWikiContext.getWiki();",
          "135:         String path = xwiki.getURL(\"Main.WebHome\", \"view\", xWikiContext);",
          "136:         StringBuilder stringBuilder = new StringBuilder();",
          "137:         stringBuilder.append(path);",
          "138:         stringBuilder.append('?');",
          "139:         stringBuilder.append(new EscapeTool().url(getParametersMap()));",
          "140:         stringBuilder.append('&');",
          "141:         input.setOnFocus(String.format(\"new ajaxSuggest(this, {script:\\\"%s\\\", varname:\\\"input\\\"} )\",",
          "142:             escapeJavaScript(stringBuilder.toString())));",
          "143:     }",
          "145:     private Map<String, String> getParametersMap()",
          "146:     {",
          "147:         String dash = \"-\";",
          "150:         Map<String, String> parameters = new LinkedHashMap<>();",
          "151:         parameters.put(\"xpage\", \"suggest\");",
          "152:         parameters.put(\"classname\", getObject().getName());",
          "153:         parameters.put(\"fieldname\", getName());",
          "154:         parameters.put(\"firCol\", dash);",
          "155:         parameters.put(\"secCol\", dash);",
          "156:         return parameters;",
          "157:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/objects/classes/StringClassTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package com.xpn.xwiki.objects.classes;",
          "22: import org.junit.jupiter.api.Test;",
          "23: import org.mockito.Mock;",
          "24: import org.xwiki.model.reference.DocumentReference;",
          "26: import com.xpn.xwiki.XWikiContext;",
          "27: import com.xpn.xwiki.test.MockitoOldcore;",
          "28: import com.xpn.xwiki.test.component.XWikiDocumentFilterUtilsComponentList;",
          "29: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "30: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "31: import com.xpn.xwiki.web.XWikiURLFactory;",
          "33: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "34: import static org.mockito.Mockito.when;",
          "41: @OldcoreTest",
          "42: @XWikiDocumentFilterUtilsComponentList",
          "43: class StringClassTest",
          "44: {",
          "45:     @InjectMockitoOldcore",
          "46:     private MockitoOldcore oldCore;",
          "48:     @Mock",
          "49:     private XWikiURLFactory urlFactory;",
          "51:     @Test",
          "52:     void displayEdit()",
          "53:     {",
          "54:         XWikiContext xWikiContext = this.oldCore.getXWikiContext();",
          "55:         xWikiContext.setURLFactory(this.urlFactory);",
          "56:         when(this.oldCore.getSpyXWiki().getURL(\"Main.WebHome\", \"view\", xWikiContext)).thenReturn(\"/a/b\");",
          "58:         String fieldName = \"test\";",
          "59:         String spaceName = \"\\\" + alert(1) + \\\"\";",
          "60:         String pageName = \"WebHome\";",
          "61:         StringClass stringClass = new StringClass();",
          "62:         stringClass.setPicker(true);",
          "63:         BaseClass baseClass = new BaseClass();",
          "64:         stringClass.setObject(baseClass);",
          "65:         baseClass.setDocumentReference(",
          "66:             new DocumentReference(this.oldCore.getXWikiContext().getWikiId(), spaceName, pageName));",
          "67:         stringClass.setName(fieldName);",
          "68:         StringBuffer stringBuffer = new StringBuffer();",
          "69:         stringClass.displayEdit(stringBuffer, fieldName, spaceName + \".\" + pageName + \"_0_\", baseClass,",
          "70:             xWikiContext);",
          "71:         assertEquals(\"<input \"",
          "72:             + \"onfocus='new ajaxSuggest(this, &#123;script:&#34;\\\\/a\\\\/b?xpage=suggest&#38;\"",
          "73:             + \"classname=%22%20%2B%20alert%281%29%20%2B%20%22.WebHome&#38;fieldname=test&#38;firCol=-&#38;\"",
          "74:             + \"secCol=-&#38;&#34;, varname:&#34;input&#34;} )' \"",
          "75:             + \"size='30' \"",
          "76:             + \"id='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "77:             + \"class='suggested' \"",
          "78:             + \"name='&#34; + alert(1) + &#34;.WebHome_0_test' \"",
          "79:             + \"type='text'/>\", stringBuffer.toString());",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}