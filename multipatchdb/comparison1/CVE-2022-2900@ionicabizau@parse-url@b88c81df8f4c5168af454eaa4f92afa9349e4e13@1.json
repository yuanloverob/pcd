{
  "cve_id": "CVE-2022-2900",
  "cve_desc": "Server-Side Request Forgery (SSRF) in GitHub repository ionicabizau/parse-url prior to 8.1.0.",
  "repo": "ionicabizau/parse-url",
  "patch_hash": "b88c81df8f4c5168af454eaa4f92afa9349e4e13",
  "patch_info": {
    "commit_hash": "b88c81df8f4c5168af454eaa4f92afa9349e4e13",
    "repo": "ionicabizau/parse-url",
    "commit_url": "https://github.com/ionicabizau/parse-url/commit/b88c81df8f4c5168af454eaa4f92afa9349e4e13",
    "files": [
      "lib/index.js",
      "test/index.js"
    ],
    "message": "Throw if url is invalid. Add a length limit.",
    "before_after_code_files": [
      "lib/index.js||lib/index.js",
      "test/index.js||test/index.js"
    ]
  },
  "patch_diff": {
    "lib/index.js||lib/index.js": [
      "File: lib/index.js -> lib/index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "36: const parseUrl = (url, normalize = false) => {",
      "39:     const GIT_RE = /(^(git@|http(s)?:\\/\\/)([\\w\\.\\-@]+)(\\/|:))(([\\~,\\.\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
      "43:         err.subject_url = url",
      "44:         throw err",
      "45:     }",
      "47:     if (normalize) {",
      "48:         if (typeof normalize !== \"object\") {",
      "49:             normalize = {",
      "",
      "[Removed Lines]",
      "41:     if (typeof url !== \"string\" || !url.trim()) {",
      "42:         const err = new Error(\"Invalid url.\")",
      "",
      "[Added Lines]",
      "42:     const throwErr = msg => {",
      "43:         const err = new Error(msg)",
      "48:     if (typeof url !== \"string\" || !url.trim()) {",
      "49:         throwErr(\"Invalid url.\")",
      "50:     }",
      "52:     if (url.length > parseUrl.MAX_INPUT_LENGTH) {",
      "53:         throwErr(\"Input exceeds maximum length. If needed, change the value of parseUrl.MAX_INPUT_LENGTH.\")",
      "54:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "56:     const parsed = parsePath(url)",
      "60:         const matched  = parsed.href.match(GIT_RE)",
      "61:         if (matched) {",
      "62:             parsed.protocols = [\"ssh\"]",
      "",
      "[Removed Lines]",
      "59:     if (parsed.protocol === \"file\") {",
      "",
      "[Added Lines]",
      "68:     if (parsed.parse_failed) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "65:             parsed.host = matched[4]",
      "66:             parsed.user = \"git\"",
      "67:             parsed.pathname = `/${matched[6]}`",
      "68:         }",
      "69:     }",
      "71:     return parsed;",
      "72: }",
      "74: export default parseUrl;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "77:             parsed.parse_failed = false",
      "78:         } else {",
      "79:             throwErr(\"URL parsing failed.\")",
      "86: parseUrl.MAX_INPUT_LENGTH = 2048",
      "",
      "---------------"
    ],
    "test/index.js||test/index.js": [
      "File: test/index.js -> test/index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "17:           , hash: \"\"",
      "18:           , search: \"\"",
      "19:           , query: {}",
      "20:         }",
      "21:     ]",
      "22:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "32:           , hash: \"\"",
      "33:           , search: \"\"",
      "34:           , query: {}",
      "35:         }",
      "36:     ]",
      "37:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "36:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "47:           , hash: \"some-hash?foo=bar\"",
      "48:           , search: \"\"",
      "49:           , query: {}",
      "50:         }",
      "51:     ]",
      "52:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "52:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "62:           , hash: \"\"",
      "63:           , search: \"\"",
      "64:           , query: {}",
      "65:         }",
      "66:     ]",
      "67:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "68:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "77:           , hash: \"\"",
      "78:           , search: \"\"",
      "79:           , query: {}",
      "80:         }",
      "81:     ]",
      "82:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "84:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "92:           , hash: \"\"",
      "93:           , search: \"\"",
      "94:           , query: {}",
      "95:         }",
      "96:     ]",
      "97:   , [",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "100:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "107:           , hash: \"http://a:1:1\"",
      "108:           , search: \"\"",
      "109:           , query: {}",
      "110:         }",
      "111:     ]",
      "112:   , [",
      "113:         [\"git@github.my-enterprise.com:my-org/my-repo.git\", false],",
      "114:         {",
      "115:             protocols: [ 'ssh' ]",
      "126:         }",
      "127:     ]",
      "128:   , [",
      "",
      "[Removed Lines]",
      "116:             , protocol: 'ssh'",
      "117:             , port: ''",
      "118:             , resource: 'github.my-enterprise.com'",
      "119:             , host: 'github.my-enterprise.com'",
      "120:             , user: 'git'",
      "121:             , password: ''",
      "122:             , pathname: '/my-org/my-repo.git'",
      "123:             , hash: ''",
      "124:             , search: ''",
      "125:             , query: {}",
      "",
      "[Added Lines]",
      "116:           , parse_failed: false",
      "123:           , protocol: 'ssh'",
      "124:           , port: ''",
      "125:           , resource: 'github.my-enterprise.com'",
      "126:           , host: 'github.my-enterprise.com'",
      "127:           , user: 'git'",
      "128:           , password: ''",
      "129:           , pathname: '/my-org/my-repo.git'",
      "130:           , hash: ''",
      "131:           , search: ''",
      "132:           , query: {}",
      "133:           , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "138:         , hash: \"\"",
      "139:         , search: \"\"",
      "140:         , query: {}",
      "141:       }",
      "142:   ]",
      "143: ];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "149:         , parse_failed: false",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "165:             parseUrl(\"\")",
      "166:         }).toThrow(/invalid url/i)",
      "167:     })",
      "168: });",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "178:     test.should(\"throw if url is too long\", () => {",
      "179:         parseUrl.MAX_INPUT_LENGTH = 10",
      "180:         test.expect(() => {",
      "181:             parseUrl(\"https://domain.com/\")",
      "182:         }).toThrow(/input exceeds maximum length/i)",
      "183:     })",
      "185:     test.should(\"throw if url is invalid\", () => {",
      "186:         test.expect(() => {",
      "187:             parseUrl(\"foo\")",
      "188:         }).toThrow(/url parsing failed/i)",
      "189:     })",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d98fd46520edef5d938b3623cf75a479dfffd47d",
      "candidate_info": {
        "commit_hash": "d98fd46520edef5d938b3623cf75a479dfffd47d",
        "repo": "ionicabizau/parse-url",
        "commit_url": "https://github.com/ionicabizau/parse-url/commit/d98fd46520edef5d938b3623cf75a479dfffd47d",
        "files": [
          "lib/index.js",
          "test/index.js"
        ],
        "message": "Merge branch 'allow-hyphens-in-git-urls' of github.com:crenshaw-dev/parse-url into new-version",
        "before_after_code_files": [
          "lib/index.js||lib/index.js",
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/index.js||lib/index.js": [
          "File: lib/index.js -> lib/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "36: const parseUrl = (url, normalize = false) => {",
          "41:     if (typeof url !== \"string\" || !url.trim()) {",
          "42:         const err = new Error(\"Invalid url.\")",
          "",
          "[Removed Lines]",
          "39:     const GIT_RE = /(^(git@|http(s)?:\\/\\/)([\\w\\.@]+)(\\/|:))(([\\~,\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
          "",
          "[Added Lines]",
          "39:     const GIT_RE = /(^(git@|http(s)?:\\/\\/)([\\w\\.\\-@]+)(\\/|:))(([\\~,\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
          "",
          "---------------"
        ],
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "109:           , query: {}",
          "110:         }",
          "111:     ]",
          "112: ];",
          "114: tester.describe(\"check urls\", test => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "112:   , [",
          "113:         [\"git@github.my-enterprise.com:my-org/my-repo.git\", false],",
          "114:         {",
          "115:             protocols: [ 'ssh' ]",
          "116:             , protocol: 'ssh'",
          "117:             , port: ''",
          "118:             , resource: 'github.my-enterprise.com'",
          "119:             , host: 'github.my-enterprise.com'",
          "120:             , user: 'git'",
          "121:             , password: ''",
          "122:             , pathname: '/my-org/my-repo.git'",
          "123:             , hash: ''",
          "124:             , search: ''",
          "125:             , query: {}",
          "126:         }",
          "127:     ]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ff27e1bedfb7c11b311510cf23e73e045f6983b7",
      "candidate_info": {
        "commit_hash": "ff27e1bedfb7c11b311510cf23e73e045f6983b7",
        "repo": "ionicabizau/parse-url",
        "commit_url": "https://github.com/ionicabizau/parse-url/commit/ff27e1bedfb7c11b311510cf23e73e045f6983b7",
        "files": [
          "test/index.js"
        ],
        "message": "test",
        "before_after_code_files": [
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:           , query: {}",
          "89:         }",
          "90:     ]",
          "91: ];",
          "93: tester.describe(\"check urls\", test => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   , [",
          "92:         [\"file:///etc/passwd?#http://a:1:1\", false]",
          "93:       , {",
          "94:             protocols: [ \"file\" ]",
          "95:           , protocol: \"file\"",
          "96:           , port: \"\"",
          "97:           , resource: \"\"",
          "98:           , user: \"\"",
          "99:           , pathname: \"/etc/passwd\"",
          "100:           , hash: \"http://a:1:1\"",
          "101:           , search: \"\"",
          "102:           , query: {}",
          "103:         }",
          "104:     ]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "21c72ab9412228eea753e2abc48f8962707b1fe3",
      "candidate_info": {
        "commit_hash": "21c72ab9412228eea753e2abc48f8962707b1fe3",
        "repo": "ionicabizau/parse-url",
        "commit_url": "https://github.com/ionicabizau/parse-url/commit/21c72ab9412228eea753e2abc48f8962707b1fe3",
        "files": [
          "lib/index.js",
          "package.json",
          "test/index.js"
        ],
        "message": "Refactor codebase, upgrade dependencies",
        "before_after_code_files": [
          "lib/index.js||lib/index.js",
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/index.js||lib/index.js": [
          "File: lib/index.js -> lib/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "36:     if (typeof url !== \"string\" || !url.trim()) {",
          "37:         throw new Error(\"Invalid url.\")",
          "38:     }",
          "39:     if (normalize) {",
          "40:         if (typeof normalize !== \"object\") {",
          "41:             normalize = {",
          "",
          "[Removed Lines]",
          "35: function parseUrl(url, normalize = false) {",
          "",
          "[Added Lines]",
          "37: const parseUrl = (url, normalize = false) => {",
          "40:     const GIT_RE = /((git@|http(s)?:\\/\\/)([\\w\\.@]+)(\\/|:))(([\\~,\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44:         }",
          "45:         url = normalizeUrl(url, normalize)",
          "46:     }",
          "47:     const parsed = parsePath(url)",
          "48:     return parsed;",
          "49: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:     if (parsed.protocol === \"file\") {",
          "59:         const matched  = parsed.href.match(GIT_RE)",
          "60:         if (matched) {",
          "61:             parsed.protocols = [\"ssh\"]",
          "62:             parsed.protocol = \"ssh\"",
          "63:             parsed.resource = matched[4]",
          "64:             parsed.user = \"git\"",
          "65:             parsed.pathname = `/${matched[6]}`",
          "66:         }",
          "67:     }",
          "",
          "---------------"
        ],
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: const parseUrl = require(\"../lib\")",
          "3:     , tester = require(\"tester\")",
          "4:     , normalizeUrl = require(\"normalize-url\")",
          "6:     ;",
          "8: const INPUTS = [",
          "",
          "[Removed Lines]",
          "5:     , qs = require(\"querystring\")",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "11:       , {",
          "12:             protocols: [ \"http\" ]",
          "13:           , protocol: \"http\"",
          "15:           , resource: \"ionicabizau.net\"",
          "16:           , user: \"\"",
          "17:           , pathname: \"/blog\"",
          "18:           , hash: \"\"",
          "19:           , search: \"\"",
          "20:         }",
          "21:     ]",
          "22:   , [",
          "",
          "[Removed Lines]",
          "14:           , port: null",
          "",
          "[Added Lines]",
          "13:           , port: \"\"",
          "19:           , query: {}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "24:       , {",
          "25:             protocols: [\"http\"]",
          "26:           , protocol: \"http\"",
          "28:           , resource: \"ionicabizau.net\"",
          "29:           , user: \"\"",
          "30:           , pathname: \"/foo.js\"",
          "31:           , hash: \"\"",
          "32:           , search: \"\"",
          "33:         }",
          "34:     ]",
          "35:   , [",
          "",
          "[Removed Lines]",
          "27:           , port: null",
          "",
          "[Added Lines]",
          "27:           , port: \"\"",
          "33:           , query: {}",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "37:       , {",
          "38:             protocols: [\"http\"]",
          "39:           , protocol: \"http\"",
          "41:           , resource: \"domain.com\"",
          "42:           , user: \"\"",
          "43:           , pathname: \"/path/name\"",
          "44:           , hash: \"some-hash?foo=bar\"",
          "45:           , search: \"\"",
          "46:         }",
          "47:     ]",
          "48:   , [",
          "",
          "[Removed Lines]",
          "40:           , port: null",
          "",
          "[Added Lines]",
          "41:           , port: \"\"",
          "47:           , query: {}",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "50:       , {",
          "51:             protocols: [\"git\", \"ssh\"]",
          "52:           , protocol: \"git\"",
          "54:           , resource: \"host.xz\"",
          "55:           , user: \"git\"",
          "56:           , pathname: \"/path/name.git\"",
          "57:           , hash: \"\"",
          "58:           , search: \"\"",
          "59:         }",
          "60:     ]",
          "61:   , [",
          "62:         [\"git@github.com:IonicaBizau/git-stats.git\", false]",
          "63:       , {",
          "65:           , protocol: \"ssh\"",
          "67:           , resource: \"github.com\"",
          "68:           , user: \"git\"",
          "69:           , pathname: \"/IonicaBizau/git-stats.git\"",
          "70:           , hash: \"\"",
          "71:           , search: \"\"",
          "72:         }",
          "73:     ]",
          "74:   , [",
          "",
          "[Removed Lines]",
          "53:           , port: null",
          "64:             protocols: []",
          "66:           , port: null",
          "",
          "[Added Lines]",
          "55:           , port: \"\"",
          "61:           , query: {}",
          "67:             protocols: [\"ssh\"]",
          "69:           , port: \"\"",
          "75:           , query: {}",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "76:       , {",
          "77:             protocols: [ \"http\" ]",
          "78:           , protocol: \"http\"",
          "80:           , resource: \"ionicabizau.net\"",
          "81:           , user: \"\"",
          "82:           , pathname: \"/with-true-normalize\"",
          "83:           , hash: \"\"",
          "84:           , search: \"\"",
          "85:         }",
          "86:     ]",
          "87: ];",
          "",
          "[Removed Lines]",
          "79:           , port: null",
          "",
          "[Added Lines]",
          "83:           , port: \"\"",
          "89:           , query: {}",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "91:         let url = Array.isArray(c[0]) ? c[0][0] : c[0]",
          "92:         test.should(\"support \" + url, () => {",
          "93:             const res = parseUrl(url, c[0][1] !== false);",
          "94:             if (c[0][1] !== false) {",
          "95:                 url = normalizeUrl(url, {",
          "96:                     stripHash: false",
          "97:                 })",
          "98:             }",
          "101:             test.expect(res).toEqual(c[1]);",
          "102:         });",
          "103:     });",
          "",
          "[Removed Lines]",
          "99:             c[1].query = qs.parse(c[1].search)",
          "100:             c[1].href = url",
          "",
          "[Added Lines]",
          "106:             c[1].href = c[1].href || url",
          "107:             c[1].password = c[1].password || \"\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7e6b549aba847a033bb9fd3f9a0e303948e3f1ce",
      "candidate_info": {
        "commit_hash": "7e6b549aba847a033bb9fd3f9a0e303948e3f1ce",
        "repo": "ionicabizau/parse-url",
        "commit_url": "https://github.com/ionicabizau/parse-url/commit/7e6b549aba847a033bb9fd3f9a0e303948e3f1ce",
        "files": [
          "lib/index.js",
          "test/index.js"
        ],
        "message": "fix: support hyphens in git@ URLs (#50)",
        "before_after_code_files": [
          "lib/index.js||lib/index.js",
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/index.js||lib/index.js": [
          "File: lib/index.js -> lib/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: const parseUrl = (url, normalize = false) => {",
          "42:     if (typeof url !== \"string\" || !url.trim()) {",
          "43:         const err = new Error(\"Invalid url.\")",
          "",
          "[Removed Lines]",
          "40:     const GIT_RE = /((git@|http(s)?:\\/\\/)([\\w\\.@]+)(\\/|:))(([\\~,\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
          "",
          "[Added Lines]",
          "40:     const GIT_RE = /((git@|http(s)?:\\/\\/)([\\w\\.\\-@]+)(\\/|:))(([\\~,\\w,\\-,\\_,\\/]+)(.git){0,1}((\\/){0,1}))/",
          "",
          "---------------"
        ],
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:           , query: {}",
          "89:         }",
          "90:     ]",
          "91: ];",
          "93: tester.describe(\"check urls\", test => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   , [",
          "92:         [\"git@github.my-enterprise.com:my-org/my-repo.git\", false],",
          "93:         {",
          "94:             protocols: [ 'ssh' ]",
          "95:             , protocol: 'ssh'",
          "96:             , port: ''",
          "97:             , resource: 'github.my-enterprise.com'",
          "98:             , user: 'git'",
          "99:             , password: ''",
          "100:             , pathname: '/my-org/my-repo.git'",
          "101:             , hash: ''",
          "102:             , search: ''",
          "103:             , query: {}",
          "104:         }",
          "105:     ]",
          "",
          "---------------"
        ]
      }
    }
  ]
}