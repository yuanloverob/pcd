{
  "cve_id": "CVE-2022-36105",
  "cve_desc": "TYPO3 is an open source PHP based web content management system released under the GNU GPL. It has been discovered that observing response time during user authentication (backend and frontend) can be used to distinguish between existing and non-existing user accounts. Extension authors of 3rd party TYPO3 extensions providing a custom authentication service should check if the extension is affected by the described problem. Affected extensions must implement new `MimicServiceInterface::mimicAuthUser`, which simulates corresponding times regular processing would usually take. Update to TYPO3 version 7.6.58 ELTS, 8.7.48 ELTS, 9.5.37 ELTS, 10.4.32 or 11.5.16 that fix this problem. There are no known workarounds for this issue.",
  "repo": "TYPO3/typo3",
  "patch_hash": "f0fc9c4cd7c38207c30dd158de53ee5d9d6f41a2",
  "patch_info": {
    "commit_hash": "f0fc9c4cd7c38207c30dd158de53ee5d9d6f41a2",
    "repo": "TYPO3/typo3",
    "commit_url": "https://github.com/TYPO3/typo3/commit/f0fc9c4cd7c38207c30dd158de53ee5d9d6f41a2",
    "files": [
      "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
      "typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
      "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
    ],
    "message": "[SECURITY] Mitigate timing discrepancies during user authentication\n\nObserving response time during user authentication can be used to\ndistinguish between existing and non-existing user accounts. This\nchange introduces `MimicServiceInterface::mimicAuthUser` -  to be\nimplemented by 3rd party authentication services - which simulates\ncorresponding times regular processing would usually take.\n\nResolves: #98217\nReleases: main, 11.5, 10.4\nChange-Id: I143ae0d3877dffe6f2decbb3f0cf8c9d9cb6ca0b\nSecurity-Bulletin: TYPO3-CORE-SA-2022-007\nSecurity-References: CVE-2022-36105\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/75710\nTested-by: Oliver Hader <oliver.hader@typo3.org>\nReviewed-by: Oliver Hader <oliver.hader@typo3.org>",
    "before_after_code_files": [
      "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
      "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
      "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
    ]
  },
  "patch_diff": {
    "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php": [
      "File: typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php -> typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "590:                     break;",
      "591:                 }",
      "592:             }",
      "593:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "595:         } elseif ($activeLogin) {",
      "596:             $subType = 'authUser' . $this->loginType;",
      "597:             foreach ($this->getAuthServices($subType, $loginData, $authInfo) as $serviceObj) {",
      "598:                 if ($serviceObj instanceof MimicServiceInterface && $serviceObj->mimicAuthUser() === false) {",
      "599:                     break;",
      "600:                 }",
      "601:             }",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php": [
      "File: typo3/sysext/core/Classes/Authentication/AuthenticationService.php -> typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: {",
      "",
      "[Removed Lines]",
      "31: class AuthenticationService extends AbstractAuthenticationService",
      "",
      "[Added Lines]",
      "31: class AuthenticationService extends AbstractAuthenticationService implements MimicServiceInterface",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "174:         return 200;",
      "175:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "181:     public function mimicAuthUser(): bool",
      "182:     {",
      "183:         try {",
      "184:             $hashFactory = GeneralUtility::makeInstance(PasswordHashFactory::class);",
      "185:             $defaultHashInstance = $hashFactory->getDefaultHashInstance($this->pObj->loginType);",
      "186:             $defaultHashInstance->getHashedPassword(random_bytes(10));",
      "187:         } catch (\\Exception $exception) {",
      "189:         }",
      "190:         return false;",
      "191:     }",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php": [
      "File: typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php -> typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: declare(strict_types=1);",
      "18: namespace TYPO3\\CMS\\Core\\Authentication;",
      "20: interface MimicServiceInterface",
      "21: {",
      "34:     public function mimicAuthUser(): bool;",
      "35: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "84285835413fdbe035509c9a064ae7affa81b3e8",
      "candidate_info": {
        "commit_hash": "84285835413fdbe035509c9a064ae7affa81b3e8",
        "repo": "TYPO3/typo3",
        "commit_url": "https://github.com/TYPO3/typo3/commit/84285835413fdbe035509c9a064ae7affa81b3e8",
        "files": [
          "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
          "typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
          "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
        ],
        "message": "[SECURITY] Mitigate timing discrepancies during user authentication\n\nObserving response time during user authentication can be used to\ndistinguish between existing and non-existing user accounts. This\nchange introduces `MimicServiceInterface::mimicAuthUser` -  to be\nimplemented by 3rd party authentication services - which simulates\ncorresponding times regular processing would usually take.\n\nResolves: #98217\nReleases: main, 11.5, 10.4\nChange-Id: I143ae0d3877dffe6f2decbb3f0cf8c9d9cb6ca0b\nSecurity-Bulletin: TYPO3-CORE-SA-2022-007\nSecurity-References: CVE-2022-36105\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/75704\nTested-by: Oliver Hader <oliver.hader@typo3.org>\nReviewed-by: Oliver Hader <oliver.hader@typo3.org>",
        "before_after_code_files": [
          "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
          "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
          "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
            "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
            "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
          ],
          "candidate": [
            "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
            "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
            "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php"
          ]
        }
      },
      "candidate_diff": {
        "typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php||typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php": [
          "File: typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php -> typo3/sysext/core/Classes/Authentication/AbstractUserAuthentication.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "711:                     break;",
          "712:                 }",
          "713:             }",
          "714:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "716:         } elseif ($activeLogin) {",
          "717:             $subType = 'authUser' . $this->loginType;",
          "718:             foreach ($this->getAuthServices($subType, $loginData, $authInfo) as $serviceObj) {",
          "719:                 if ($serviceObj instanceof MimicServiceInterface && $serviceObj->mimicAuthUser() === false) {",
          "720:                     break;",
          "721:                 }",
          "722:             }",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Authentication/AuthenticationService.php||typo3/sysext/core/Classes/Authentication/AuthenticationService.php": [
          "File: typo3/sysext/core/Classes/Authentication/AuthenticationService.php -> typo3/sysext/core/Classes/Authentication/AuthenticationService.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: {",
          "",
          "[Removed Lines]",
          "32: class AuthenticationService extends AbstractAuthenticationService",
          "",
          "[Added Lines]",
          "32: class AuthenticationService extends AbstractAuthenticationService implements MimicServiceInterface",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "193:         return 200;",
          "194:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "200:     public function mimicAuthUser(): bool",
          "201:     {",
          "202:         try {",
          "203:             $hashFactory = GeneralUtility::makeInstance(PasswordHashFactory::class);",
          "204:             $defaultHashInstance = $hashFactory->getDefaultHashInstance($this->pObj->loginType);",
          "205:             $defaultHashInstance->getHashedPassword(random_bytes(10));",
          "206:         } catch (\\Exception $exception) {",
          "208:         }",
          "209:         return false;",
          "210:     }",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php||typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php": [
          "File: typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php -> typo3/sysext/core/Classes/Authentication/MimicServiceInterface.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: declare(strict_types=1);",
          "18: namespace TYPO3\\CMS\\Core\\Authentication;",
          "20: interface MimicServiceInterface",
          "21: {",
          "34:     public function mimicAuthUser(): bool;",
          "35: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}