{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "448bd578d8e74f823c83b360ae174db9ae36e31e",
      "candidate_info": {
        "commit_hash": "448bd578d8e74f823c83b360ae174db9ae36e31e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/448bd578d8e74f823c83b360ae174db9ae36e31e",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.6dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018102300.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181023)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018102700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181027)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5b9f7fd70771e9a17405b55e840d6ea8942f8f1",
      "candidate_info": {
        "commit_hash": "c5b9f7fd70771e9a17405b55e840d6ea8942f8f1",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c5b9f7fd70771e9a17405b55e840d6ea8942f8f1",
        "files": [
          "course/format/weeks/lib.php",
          "course/lib.php",
          "course/tests/courselib_test.php",
          "lang/en/cache.php",
          "lib/db/caches.php",
          "lib/enrollib.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-66144-master' of https://github.com/ryanwyllie/moodle",
        "before_after_code_files": [
          "course/format/weeks/lib.php||course/format/weeks/lib.php",
          "course/lib.php||course/lib.php",
          "course/tests/courselib_test.php||course/tests/courselib_test.php",
          "lang/en/cache.php||lang/en/cache.php",
          "lib/db/caches.php||lib/db/caches.php",
          "lib/enrollib.php||lib/enrollib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "course/format/weeks/lib.php||course/format/weeks/lib.php": [
          "File: course/format/weeks/lib.php -> course/format/weeks/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: defined('MOODLE_INTERNAL') || die();",
          "27: require_once($CFG->dirroot. '/course/format/lib.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: require_once($CFG->dirroot. '/course/lib.php');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "365:     public function get_section_dates($section, $startdate = false) {",
          "367:         if ($startdate === false) {",
          "368:             $course = $this->get_course();",
          "370:         }",
          "372:         if (is_object($section)) {",
          "",
          "[Removed Lines]",
          "369:             $startdate = $course->startdate;",
          "",
          "[Added Lines]",
          "367:         global $USER;",
          "371:             $userdates = course_get_course_dates_for_user_id($course, $USER->id);",
          "372:             $startdate = $userdates['start'];",
          "",
          "---------------"
        ],
        "course/lib.php||course/lib.php": [
          "File: course/lib.php -> course/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4675:     return $recentcourses;",
          "4676: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4708: function course_get_course_dates_for_user_ids(stdClass $course, array $userids): array {",
          "4709:     if (empty($course->relativedatesmode)) {",
          "4712:         return array_reduce($userids, function($carry, $userid) use ($course) {",
          "4713:             $carry[$userid] = [",
          "4714:                 'start' => $course->startdate,",
          "4715:                 'startoffset' => 0",
          "4716:             ];",
          "4717:             return $carry;",
          "4718:         }, []);",
          "4719:     }",
          "4722:     $cache = cache::make('core', 'course_user_dates');",
          "4723:     $dates = [];",
          "4724:     $uncacheduserids = [];",
          "4727:     foreach ($userids as $userid) {",
          "4728:         $cachekey = \"{$course->id}_{$userid}\";",
          "4729:         $cachedvalue = $cache->get($cachekey);",
          "4731:         if ($cachedvalue === false) {",
          "4734:             $uncacheduserids[] = $userid;",
          "4735:         } else {",
          "4736:             [$start, $startoffset] = $cachedvalue;",
          "4737:             $dates[$userid] = [",
          "4738:                 'start' => $start,",
          "4739:                 'startoffset' => $startoffset",
          "4740:             ];",
          "4741:         }",
          "4742:     }",
          "4744:     if (!empty($uncacheduserids)) {",
          "4748:         $enrolments = enrol_get_course_users($course->id, false, $uncacheduserids);",
          "4750:         foreach ($uncacheduserids as $userid) {",
          "4752:             $enrolment = array_reduce(array_values($enrolments), function($carry, $enrolment) use ($userid) {",
          "4755:                 if (",
          "4756:                     $enrolment->uestatus == ENROL_USER_ACTIVE &&",
          "4757:                     $enrolment->estatus == ENROL_INSTANCE_ENABLED &&",
          "4758:                     $enrolment->id == $userid",
          "4759:                 ) {",
          "4760:                     if (is_null($carry)) {",
          "4762:                         $carry = $enrolment;",
          "4763:                     } else {",
          "4766:                         $carry = $carry->uetimestart < $enrolment->uetimestart ? $carry : $enrolment;",
          "4767:                     }",
          "4768:                 }",
          "4770:                 return $carry;",
          "4771:             }, null);",
          "4773:             if ($enrolment) {",
          "4776:                 $start = $course->startdate > $enrolment->uetimestart ? $course->startdate : $enrolment->uetimestart;",
          "4777:                 $startoffset = $start - $course->startdate;",
          "4778:             } else {",
          "4780:                 $start = $course->startdate;",
          "4781:                 $startoffset = 0;",
          "4782:             }",
          "4784:             $dates[$userid] = [",
          "4785:                 'start' => $start,",
          "4786:                 'startoffset' => $startoffset",
          "4787:             ];",
          "4789:             $cachekey = \"{$course->id}_{$userid}\";",
          "4790:             $cache->set($cachekey, [$start, $startoffset]);",
          "4791:         }",
          "4792:     }",
          "4794:     return $dates;",
          "4795: }",
          "4825: function course_get_course_dates_for_user_id(stdClass $course, int $userid): array {",
          "4826:     return (course_get_course_dates_for_user_ids($course, [$userid]))[$userid];",
          "4827: }",
          "",
          "---------------"
        ],
        "course/tests/courselib_test.php||course/tests/courselib_test.php": [
          "File: course/tests/courselib_test.php -> course/tests/courselib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5206:         $this->assertCount(3, $result);",
          "5207:         $this->assertArrayNotHasKey($courses[0]->id, $result);",
          "5208:     }",
          "5209: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5213:     public function get_course_get_course_dates_for_user_ids_test_cases() {",
          "5214:         $now = time();",
          "5215:         $pastcoursestart = $now - 100;",
          "5216:         $futurecoursestart = $now + 100;",
          "5218:         return [",
          "5219:             'future course start fixed no users enrolled' => [",
          "5220:                 'relativedatemode' => false,",
          "5221:                 'coursestart' => $futurecoursestart,",
          "5222:                 'usercount' => 2,",
          "5223:                 'enrolmentmethods' => [",
          "5224:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5225:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5226:                 ],",
          "5227:                 'enrolled' => [[], []],",
          "5228:                 'expected' => [",
          "5229:                     [",
          "5230:                         'start' => $futurecoursestart,",
          "5231:                         'startoffset' => 0",
          "5232:                     ],",
          "5233:                     [",
          "5234:                         'start' => $futurecoursestart,",
          "5235:                         'startoffset' => 0",
          "5236:                     ]",
          "5237:                 ]",
          "5238:             ],",
          "5239:             'future course start fixed 1 users enrolled future' => [",
          "5240:                 'relativedatemode' => false,",
          "5241:                 'coursestart' => $futurecoursestart,",
          "5242:                 'usercount' => 2,",
          "5243:                 'enrolmentmethods' => [",
          "5244:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5245:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5246:                 ],",
          "5247:                 'enrolled' => [",
          "5249:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5251:                     []",
          "5252:                 ],",
          "5253:                 'expected' => [",
          "5254:                     [",
          "5255:                         'start' => $futurecoursestart,",
          "5256:                         'startoffset' => 0",
          "5257:                     ],",
          "5258:                     [",
          "5259:                         'start' => $futurecoursestart,",
          "5260:                         'startoffset' => 0",
          "5261:                     ]",
          "5262:                 ]",
          "5263:             ],",
          "5264:             'future course start fixed 1 users enrolled past' => [",
          "5265:                 'relativedatemode' => false,",
          "5266:                 'coursestart' => $futurecoursestart,",
          "5267:                 'usercount' => 2,",
          "5268:                 'enrolmentmethods' => [",
          "5269:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5270:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5271:                 ],",
          "5272:                 'enrolled' => [",
          "5274:                     ['manual' => [$futurecoursestart - 10, ENROL_USER_ACTIVE]],",
          "5276:                     []",
          "5277:                 ],",
          "5278:                 'expected' => [",
          "5279:                     [",
          "5280:                         'start' => $futurecoursestart,",
          "5281:                         'startoffset' => 0",
          "5282:                     ],",
          "5283:                     [",
          "5284:                         'start' => $futurecoursestart,",
          "5285:                         'startoffset' => 0",
          "5286:                     ]",
          "5287:                 ]",
          "5288:             ],",
          "5289:             'future course start fixed 2 users enrolled future' => [",
          "5290:                 'relativedatemode' => false,",
          "5291:                 'coursestart' => $futurecoursestart,",
          "5292:                 'usercount' => 2,",
          "5293:                 'enrolmentmethods' => [",
          "5294:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5295:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5296:                 ],",
          "5297:                 'enrolled' => [",
          "5299:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5301:                     ['manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]]",
          "5302:                 ],",
          "5303:                 'expected' => [",
          "5304:                     [",
          "5305:                         'start' => $futurecoursestart,",
          "5306:                         'startoffset' => 0",
          "5307:                     ],",
          "5308:                     [",
          "5309:                         'start' => $futurecoursestart,",
          "5310:                         'startoffset' => 0",
          "5311:                     ]",
          "5312:                 ]",
          "5313:             ],",
          "5314:             'future course start fixed 2 users enrolled past' => [",
          "5315:                 'relativedatemode' => false,",
          "5316:                 'coursestart' => $futurecoursestart,",
          "5317:                 'usercount' => 2,",
          "5318:                 'enrolmentmethods' => [",
          "5319:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5320:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5321:                 ],",
          "5322:                 'enrolled' => [",
          "5324:                     ['manual' => [$futurecoursestart - 10, ENROL_USER_ACTIVE]],",
          "5326:                     ['manual' => [$futurecoursestart - 20, ENROL_USER_ACTIVE]]",
          "5327:                 ],",
          "5328:                 'expected' => [",
          "5329:                     [",
          "5330:                         'start' => $futurecoursestart,",
          "5331:                         'startoffset' => 0",
          "5332:                     ],",
          "5333:                     [",
          "5334:                         'start' => $futurecoursestart,",
          "5335:                         'startoffset' => 0",
          "5336:                     ]",
          "5337:                 ]",
          "5338:             ],",
          "5339:             'future course start fixed 2 users enrolled mixed' => [",
          "5340:                 'relativedatemode' => false,",
          "5341:                 'coursestart' => $futurecoursestart,",
          "5342:                 'usercount' => 2,",
          "5343:                 'enrolmentmethods' => [",
          "5344:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5345:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5346:                 ],",
          "5347:                 'enrolled' => [",
          "5349:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5351:                     ['manual' => [$futurecoursestart - 20, ENROL_USER_ACTIVE]]",
          "5352:                 ],",
          "5353:                 'expected' => [",
          "5354:                     [",
          "5355:                         'start' => $futurecoursestart,",
          "5356:                         'startoffset' => 0",
          "5357:                     ],",
          "5358:                     [",
          "5359:                         'start' => $futurecoursestart,",
          "5360:                         'startoffset' => 0",
          "5361:                     ]",
          "5362:                 ]",
          "5363:             ],",
          "5364:             'future course start fixed 2 users enrolled 2 methods' => [",
          "5365:                 'relativedatemode' => false,",
          "5366:                 'coursestart' => $futurecoursestart,",
          "5367:                 'usercount' => 2,",
          "5368:                 'enrolmentmethods' => [",
          "5369:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5370:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5371:                 ],",
          "5372:                 'enrolled' => [",
          "5374:                     [",
          "5375:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5376:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5377:                     ],",
          "5379:                     [",
          "5380:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5381:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5382:                     ]",
          "5383:                 ],",
          "5384:                 'expected' => [",
          "5385:                     [",
          "5386:                         'start' => $futurecoursestart,",
          "5387:                         'startoffset' => 0",
          "5388:                     ],",
          "5389:                     [",
          "5390:                         'start' => $futurecoursestart,",
          "5391:                         'startoffset' => 0",
          "5392:                     ]",
          "5393:                 ]",
          "5394:             ],",
          "5395:             'future course start fixed 2 users enrolled 2 methods 1 disabled' => [",
          "5396:                 'relativedatemode' => false,",
          "5397:                 'coursestart' => $futurecoursestart,",
          "5398:                 'usercount' => 2,",
          "5399:                 'enrolmentmethods' => [",
          "5400:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "5401:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5402:                 ],",
          "5403:                 'enrolled' => [",
          "5405:                     [",
          "5406:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5407:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5408:                     ],",
          "5410:                     [",
          "5411:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5412:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5413:                     ]",
          "5414:                 ],",
          "5415:                 'expected' => [",
          "5416:                     [",
          "5417:                         'start' => $futurecoursestart,",
          "5418:                         'startoffset' => 0",
          "5419:                     ],",
          "5420:                     [",
          "5421:                         'start' => $futurecoursestart,",
          "5422:                         'startoffset' => 0",
          "5423:                     ]",
          "5424:                 ]",
          "5425:             ],",
          "5426:             'future course start fixed 2 users enrolled 2 methods 2 disabled' => [",
          "5427:                 'relativedatemode' => false,",
          "5428:                 'coursestart' => $futurecoursestart,",
          "5429:                 'usercount' => 2,",
          "5430:                 'enrolmentmethods' => [",
          "5431:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "5432:                     ['self', ENROL_INSTANCE_DISABLED]",
          "5433:                 ],",
          "5434:                 'enrolled' => [",
          "5436:                     [",
          "5437:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5438:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5439:                     ],",
          "5441:                     [",
          "5442:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5443:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5444:                     ]",
          "5445:                 ],",
          "5446:                 'expected' => [",
          "5447:                     [",
          "5448:                         'start' => $futurecoursestart,",
          "5449:                         'startoffset' => 0",
          "5450:                     ],",
          "5451:                     [",
          "5452:                         'start' => $futurecoursestart,",
          "5453:                         'startoffset' => 0",
          "5454:                     ]",
          "5455:                 ]",
          "5456:             ],",
          "5457:             'future course start fixed 2 users enrolled 2 methods 0 disabled 1 user suspended' => [",
          "5458:                 'relativedatemode' => false,",
          "5459:                 'coursestart' => $futurecoursestart,",
          "5460:                 'usercount' => 2,",
          "5461:                 'enrolmentmethods' => [",
          "5462:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5463:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5464:                 ],",
          "5465:                 'enrolled' => [",
          "5467:                     [",
          "5468:                         'manual' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED],",
          "5469:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5470:                     ],",
          "5472:                     [",
          "5473:                         'manual' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED],",
          "5474:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5475:                     ]",
          "5476:                 ],",
          "5477:                 'expected' => [",
          "5478:                     [",
          "5479:                         'start' => $futurecoursestart,",
          "5480:                         'startoffset' => 0",
          "5481:                     ],",
          "5482:                     [",
          "5483:                         'start' => $futurecoursestart,",
          "5484:                         'startoffset' => 0",
          "5485:                     ]",
          "5486:                 ]",
          "5487:             ],",
          "5488:             'future course start fixed 2 users enrolled 2 methods 0 disabled 2 user suspended' => [",
          "5489:                 'relativedatemode' => false,",
          "5490:                 'coursestart' => $futurecoursestart,",
          "5491:                 'usercount' => 2,",
          "5492:                 'enrolmentmethods' => [",
          "5493:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5494:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5495:                 ],",
          "5496:                 'enrolled' => [",
          "5498:                     [",
          "5499:                         'manual' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED],",
          "5500:                         'self' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED]",
          "5501:                     ],",
          "5503:                     [",
          "5504:                         'manual' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED],",
          "5505:                         'self' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED]",
          "5506:                     ]",
          "5507:                 ],",
          "5508:                 'expected' => [",
          "5509:                     [",
          "5510:                         'start' => $futurecoursestart,",
          "5511:                         'startoffset' => 0",
          "5512:                     ],",
          "5513:                     [",
          "5514:                         'start' => $futurecoursestart,",
          "5515:                         'startoffset' => 0",
          "5516:                     ]",
          "5517:                 ]",
          "5518:             ],",
          "5519:             'future course start relative no users enrolled' => [",
          "5520:                 'relativedatemode' => true,",
          "5521:                 'coursestart' => $futurecoursestart,",
          "5522:                 'usercount' => 2,",
          "5523:                 'enrolmentmethods' => [",
          "5524:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5525:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5526:                 ],",
          "5527:                 'enrolled' => [[], []],",
          "5528:                 'expected' => [",
          "5529:                     [",
          "5530:                         'start' => $futurecoursestart,",
          "5531:                         'startoffset' => 0",
          "5532:                     ],",
          "5533:                     [",
          "5534:                         'start' => $futurecoursestart,",
          "5535:                         'startoffset' => 0",
          "5536:                     ]",
          "5537:                 ]",
          "5538:             ],",
          "5539:             'future course start relative 1 users enrolled future' => [",
          "5540:                 'relativedatemode' => true,",
          "5541:                 'coursestart' => $futurecoursestart,",
          "5542:                 'usercount' => 2,",
          "5543:                 'enrolmentmethods' => [",
          "5544:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5545:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5546:                 ],",
          "5547:                 'enrolled' => [",
          "5549:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5551:                     []",
          "5552:                 ],",
          "5553:                 'expected' => [",
          "5554:                     [",
          "5555:                         'start' => $futurecoursestart + 10,",
          "5556:                         'startoffset' => 10",
          "5557:                     ],",
          "5558:                     [",
          "5559:                         'start' => $futurecoursestart,",
          "5560:                         'startoffset' => 0",
          "5561:                     ]",
          "5562:                 ]",
          "5563:             ],",
          "5564:             'future course start relative 1 users enrolled past' => [",
          "5565:                 'relativedatemode' => true,",
          "5566:                 'coursestart' => $futurecoursestart,",
          "5567:                 'usercount' => 2,",
          "5568:                 'enrolmentmethods' => [",
          "5569:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5570:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5571:                 ],",
          "5572:                 'enrolled' => [",
          "5574:                     ['manual' => [$futurecoursestart - 10, ENROL_USER_ACTIVE]],",
          "5576:                     []",
          "5577:                 ],",
          "5578:                 'expected' => [",
          "5579:                     [",
          "5580:                         'start' => $futurecoursestart,",
          "5581:                         'startoffset' => 0",
          "5582:                     ],",
          "5583:                     [",
          "5584:                         'start' => $futurecoursestart,",
          "5585:                         'startoffset' => 0",
          "5586:                     ]",
          "5587:                 ]",
          "5588:             ],",
          "5589:             'future course start relative 2 users enrolled future' => [",
          "5590:                 'relativedatemode' => true,",
          "5591:                 'coursestart' => $futurecoursestart,",
          "5592:                 'usercount' => 2,",
          "5593:                 'enrolmentmethods' => [",
          "5594:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5595:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5596:                 ],",
          "5597:                 'enrolled' => [",
          "5599:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5601:                     ['manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]]",
          "5602:                 ],",
          "5603:                 'expected' => [",
          "5604:                     [",
          "5605:                         'start' => $futurecoursestart + 10,",
          "5606:                         'startoffset' => 10",
          "5607:                     ],",
          "5608:                     [",
          "5609:                         'start' => $futurecoursestart + 20,",
          "5610:                         'startoffset' => 20",
          "5611:                     ]",
          "5612:                 ]",
          "5613:             ],",
          "5614:             'future course start relative 2 users enrolled past' => [",
          "5615:                 'relativedatemode' => true,",
          "5616:                 'coursestart' => $futurecoursestart,",
          "5617:                 'usercount' => 2,",
          "5618:                 'enrolmentmethods' => [",
          "5619:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5620:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5621:                 ],",
          "5622:                 'enrolled' => [",
          "5624:                     ['manual' => [$futurecoursestart - 10, ENROL_USER_ACTIVE]],",
          "5626:                     ['manual' => [$futurecoursestart - 20, ENROL_USER_ACTIVE]]",
          "5627:                 ],",
          "5628:                 'expected' => [",
          "5629:                     [",
          "5630:                         'start' => $futurecoursestart,",
          "5631:                         'startoffset' => 0",
          "5632:                     ],",
          "5633:                     [",
          "5634:                         'start' => $futurecoursestart,",
          "5635:                         'startoffset' => 0",
          "5636:                     ]",
          "5637:                 ]",
          "5638:             ],",
          "5639:             'future course start relative 2 users enrolled mixed' => [",
          "5640:                 'relativedatemode' => true,",
          "5641:                 'coursestart' => $futurecoursestart,",
          "5642:                 'usercount' => 2,",
          "5643:                 'enrolmentmethods' => [",
          "5644:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5645:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5646:                 ],",
          "5647:                 'enrolled' => [",
          "5649:                     ['manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]],",
          "5651:                     ['manual' => [$futurecoursestart - 20, ENROL_USER_ACTIVE]]",
          "5652:                 ],",
          "5653:                 'expected' => [",
          "5654:                     [",
          "5655:                         'start' => $futurecoursestart + 10,",
          "5656:                         'startoffset' => 10",
          "5657:                     ],",
          "5658:                     [",
          "5659:                         'start' => $futurecoursestart,",
          "5660:                         'startoffset' => 0",
          "5661:                     ]",
          "5662:                 ]",
          "5663:             ],",
          "5664:             'future course start relative 2 users enrolled 2 methods' => [",
          "5665:                 'relativedatemode' => true,",
          "5666:                 'coursestart' => $futurecoursestart,",
          "5667:                 'usercount' => 2,",
          "5668:                 'enrolmentmethods' => [",
          "5669:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5670:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5671:                 ],",
          "5672:                 'enrolled' => [",
          "5674:                     [",
          "5675:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5676:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5677:                     ],",
          "5679:                     [",
          "5680:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5681:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5682:                     ]",
          "5683:                 ],",
          "5684:                 'expected' => [",
          "5685:                     [",
          "5686:                         'start' => $futurecoursestart + 10,",
          "5687:                         'startoffset' => 10",
          "5688:                     ],",
          "5689:                     [",
          "5690:                         'start' => $futurecoursestart + 10,",
          "5691:                         'startoffset' => 10",
          "5692:                     ]",
          "5693:                 ]",
          "5694:             ],",
          "5695:             'future course start relative 2 users enrolled 2 methods 1 disabled' => [",
          "5696:                 'relativedatemode' => true,",
          "5697:                 'coursestart' => $futurecoursestart,",
          "5698:                 'usercount' => 2,",
          "5699:                 'enrolmentmethods' => [",
          "5700:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "5701:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5702:                 ],",
          "5703:                 'enrolled' => [",
          "5705:                     [",
          "5706:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5707:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5708:                     ],",
          "5710:                     [",
          "5711:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5712:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5713:                     ]",
          "5714:                 ],",
          "5715:                 'expected' => [",
          "5716:                     [",
          "5717:                         'start' => $futurecoursestart + 20,",
          "5718:                         'startoffset' => 20",
          "5719:                     ],",
          "5720:                     [",
          "5721:                         'start' => $futurecoursestart + 10,",
          "5722:                         'startoffset' => 10",
          "5723:                     ]",
          "5724:                 ]",
          "5725:             ],",
          "5726:             'future course start relative 2 users enrolled 2 methods 2 disabled' => [",
          "5727:                 'relativedatemode' => true,",
          "5728:                 'coursestart' => $futurecoursestart,",
          "5729:                 'usercount' => 2,",
          "5730:                 'enrolmentmethods' => [",
          "5731:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "5732:                     ['self', ENROL_INSTANCE_DISABLED]",
          "5733:                 ],",
          "5734:                 'enrolled' => [",
          "5736:                     [",
          "5737:                         'manual' => [$futurecoursestart + 10, ENROL_USER_ACTIVE],",
          "5738:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5739:                     ],",
          "5741:                     [",
          "5742:                         'manual' => [$futurecoursestart + 20, ENROL_USER_ACTIVE],",
          "5743:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5744:                     ]",
          "5745:                 ],",
          "5746:                 'expected' => [",
          "5747:                     [",
          "5748:                         'start' => $futurecoursestart,",
          "5749:                         'startoffset' => 0",
          "5750:                     ],",
          "5751:                     [",
          "5752:                         'start' => $futurecoursestart,",
          "5753:                         'startoffset' => 0",
          "5754:                     ]",
          "5755:                 ]",
          "5756:             ],",
          "5757:             'future course start relative 2 users enrolled 2 methods 0 disabled 1 user suspended' => [",
          "5758:                 'relativedatemode' => true,",
          "5759:                 'coursestart' => $futurecoursestart,",
          "5760:                 'usercount' => 2,",
          "5761:                 'enrolmentmethods' => [",
          "5762:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5763:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5764:                 ],",
          "5765:                 'enrolled' => [",
          "5767:                     [",
          "5768:                         'manual' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED],",
          "5769:                         'self' => [$futurecoursestart + 20, ENROL_USER_ACTIVE]",
          "5770:                     ],",
          "5772:                     [",
          "5773:                         'manual' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED],",
          "5774:                         'self' => [$futurecoursestart + 10, ENROL_USER_ACTIVE]",
          "5775:                     ]",
          "5776:                 ],",
          "5777:                 'expected' => [",
          "5778:                     [",
          "5779:                         'start' => $futurecoursestart + 20,",
          "5780:                         'startoffset' => 20",
          "5781:                     ],",
          "5782:                     [",
          "5783:                         'start' => $futurecoursestart + 10,",
          "5784:                         'startoffset' => 10",
          "5785:                     ]",
          "5786:                 ]",
          "5787:             ],",
          "5788:             'future course start relative 2 users enrolled 2 methods 0 disabled 2 user suspended' => [",
          "5789:                 'relativedatemode' => true,",
          "5790:                 'coursestart' => $futurecoursestart,",
          "5791:                 'usercount' => 2,",
          "5792:                 'enrolmentmethods' => [",
          "5793:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5794:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5795:                 ],",
          "5796:                 'enrolled' => [",
          "5798:                     [",
          "5799:                         'manual' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED],",
          "5800:                         'self' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED]",
          "5801:                     ],",
          "5803:                     [",
          "5804:                         'manual' => [$futurecoursestart + 20, ENROL_USER_SUSPENDED],",
          "5805:                         'self' => [$futurecoursestart + 10, ENROL_USER_SUSPENDED]",
          "5806:                     ]",
          "5807:                 ],",
          "5808:                 'expected' => [",
          "5809:                     [",
          "5810:                         'start' => $futurecoursestart,",
          "5811:                         'startoffset' => 0",
          "5812:                     ],",
          "5813:                     [",
          "5814:                         'start' => $futurecoursestart,",
          "5815:                         'startoffset' => 0",
          "5816:                     ]",
          "5817:                 ]",
          "5818:             ],",
          "5821:             'past course start fixed no users enrolled' => [",
          "5822:                 'relativedatemode' => false,",
          "5823:                 'coursestart' => $pastcoursestart,",
          "5824:                 'usercount' => 2,",
          "5825:                 'enrolmentmethods' => [",
          "5826:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5827:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5828:                 ],",
          "5829:                 'enrolled' => [[], []],",
          "5830:                 'expected' => [",
          "5831:                     [",
          "5832:                         'start' => $pastcoursestart,",
          "5833:                         'startoffset' => 0",
          "5834:                     ],",
          "5835:                     [",
          "5836:                         'start' => $pastcoursestart,",
          "5837:                         'startoffset' => 0",
          "5838:                     ]",
          "5839:                 ]",
          "5840:             ],",
          "5841:             'past course start fixed 1 users enrolled future' => [",
          "5842:                 'relativedatemode' => false,",
          "5843:                 'coursestart' => $pastcoursestart,",
          "5844:                 'usercount' => 2,",
          "5845:                 'enrolmentmethods' => [",
          "5846:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5847:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5848:                 ],",
          "5849:                 'enrolled' => [",
          "5851:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "5853:                     []",
          "5854:                 ],",
          "5855:                 'expected' => [",
          "5856:                     [",
          "5857:                         'start' => $pastcoursestart,",
          "5858:                         'startoffset' => 0",
          "5859:                     ],",
          "5860:                     [",
          "5861:                         'start' => $pastcoursestart,",
          "5862:                         'startoffset' => 0",
          "5863:                     ]",
          "5864:                 ]",
          "5865:             ],",
          "5866:             'past course start fixed 1 users enrolled past' => [",
          "5867:                 'relativedatemode' => false,",
          "5868:                 'coursestart' => $pastcoursestart,",
          "5869:                 'usercount' => 2,",
          "5870:                 'enrolmentmethods' => [",
          "5871:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5872:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5873:                 ],",
          "5874:                 'enrolled' => [",
          "5876:                     ['manual' => [$pastcoursestart - 10, ENROL_USER_ACTIVE]],",
          "5878:                     []",
          "5879:                 ],",
          "5880:                 'expected' => [",
          "5881:                     [",
          "5882:                         'start' => $pastcoursestart,",
          "5883:                         'startoffset' => 0",
          "5884:                     ],",
          "5885:                     [",
          "5886:                         'start' => $pastcoursestart,",
          "5887:                         'startoffset' => 0",
          "5888:                     ]",
          "5889:                 ]",
          "5890:             ],",
          "5891:             'past course start fixed 2 users enrolled future' => [",
          "5892:                 'relativedatemode' => false,",
          "5893:                 'coursestart' => $pastcoursestart,",
          "5894:                 'usercount' => 2,",
          "5895:                 'enrolmentmethods' => [",
          "5896:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5897:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5898:                 ],",
          "5899:                 'enrolled' => [",
          "5901:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "5903:                     ['manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]]",
          "5904:                 ],",
          "5905:                 'expected' => [",
          "5906:                     [",
          "5907:                         'start' => $pastcoursestart,",
          "5908:                         'startoffset' => 0",
          "5909:                     ],",
          "5910:                     [",
          "5911:                         'start' => $pastcoursestart,",
          "5912:                         'startoffset' => 0",
          "5913:                     ]",
          "5914:                 ]",
          "5915:             ],",
          "5916:             'past course start fixed 2 users enrolled past' => [",
          "5917:                 'relativedatemode' => false,",
          "5918:                 'coursestart' => $pastcoursestart,",
          "5919:                 'usercount' => 2,",
          "5920:                 'enrolmentmethods' => [",
          "5921:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5922:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5923:                 ],",
          "5924:                 'enrolled' => [",
          "5926:                     ['manual' => [$pastcoursestart - 10, ENROL_USER_ACTIVE]],",
          "5928:                     ['manual' => [$pastcoursestart - 20, ENROL_USER_ACTIVE]]",
          "5929:                 ],",
          "5930:                 'expected' => [",
          "5931:                     [",
          "5932:                         'start' => $pastcoursestart,",
          "5933:                         'startoffset' => 0",
          "5934:                     ],",
          "5935:                     [",
          "5936:                         'start' => $pastcoursestart,",
          "5937:                         'startoffset' => 0",
          "5938:                     ]",
          "5939:                 ]",
          "5940:             ],",
          "5941:             'past course start fixed 2 users enrolled mixed' => [",
          "5942:                 'relativedatemode' => false,",
          "5943:                 'coursestart' => $pastcoursestart,",
          "5944:                 'usercount' => 2,",
          "5945:                 'enrolmentmethods' => [",
          "5946:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5947:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5948:                 ],",
          "5949:                 'enrolled' => [",
          "5951:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "5953:                     ['manual' => [$pastcoursestart - 20, ENROL_USER_ACTIVE]]",
          "5954:                 ],",
          "5955:                 'expected' => [",
          "5956:                     [",
          "5957:                         'start' => $pastcoursestart,",
          "5958:                         'startoffset' => 0",
          "5959:                     ],",
          "5960:                     [",
          "5961:                         'start' => $pastcoursestart,",
          "5962:                         'startoffset' => 0",
          "5963:                     ]",
          "5964:                 ]",
          "5965:             ],",
          "5966:             'past course start fixed 2 users enrolled 2 methods' => [",
          "5967:                 'relativedatemode' => false,",
          "5968:                 'coursestart' => $pastcoursestart,",
          "5969:                 'usercount' => 2,",
          "5970:                 'enrolmentmethods' => [",
          "5971:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "5972:                     ['self', ENROL_INSTANCE_ENABLED]",
          "5973:                 ],",
          "5974:                 'enrolled' => [",
          "5976:                     [",
          "5977:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "5978:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "5979:                     ],",
          "5981:                     [",
          "5982:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "5983:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "5984:                     ]",
          "5985:                 ],",
          "5986:                 'expected' => [",
          "5987:                     [",
          "5988:                         'start' => $pastcoursestart,",
          "5989:                         'startoffset' => 0",
          "5990:                     ],",
          "5991:                     [",
          "5992:                         'start' => $pastcoursestart,",
          "5993:                         'startoffset' => 0",
          "5994:                     ]",
          "5995:                 ]",
          "5996:             ],",
          "5997:             'past course start fixed 2 users enrolled 2 methods 1 disabled' => [",
          "5998:                 'relativedatemode' => false,",
          "5999:                 'coursestart' => $pastcoursestart,",
          "6000:                 'usercount' => 2,",
          "6001:                 'enrolmentmethods' => [",
          "6002:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "6003:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6004:                 ],",
          "6005:                 'enrolled' => [",
          "6007:                     [",
          "6008:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "6009:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6010:                     ],",
          "6012:                     [",
          "6013:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "6014:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6015:                     ]",
          "6016:                 ],",
          "6017:                 'expected' => [",
          "6018:                     [",
          "6019:                         'start' => $pastcoursestart,",
          "6020:                         'startoffset' => 0",
          "6021:                     ],",
          "6022:                     [",
          "6023:                         'start' => $pastcoursestart,",
          "6024:                         'startoffset' => 0",
          "6025:                     ]",
          "6026:                 ]",
          "6027:             ],",
          "6028:             'past course start fixed 2 users enrolled 2 methods 2 disabled' => [",
          "6029:                 'relativedatemode' => false,",
          "6030:                 'coursestart' => $pastcoursestart,",
          "6031:                 'usercount' => 2,",
          "6032:                 'enrolmentmethods' => [",
          "6033:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "6034:                     ['self', ENROL_INSTANCE_DISABLED]",
          "6035:                 ],",
          "6036:                 'enrolled' => [",
          "6038:                     [",
          "6039:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "6040:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6041:                     ],",
          "6043:                     [",
          "6044:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "6045:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6046:                     ]",
          "6047:                 ],",
          "6048:                 'expected' => [",
          "6049:                     [",
          "6050:                         'start' => $pastcoursestart,",
          "6051:                         'startoffset' => 0",
          "6052:                     ],",
          "6053:                     [",
          "6054:                         'start' => $pastcoursestart,",
          "6055:                         'startoffset' => 0",
          "6056:                     ]",
          "6057:                 ]",
          "6058:             ],",
          "6059:             'past course start fixed 2 users enrolled 2 methods 0 disabled 1 user suspended' => [",
          "6060:                 'relativedatemode' => false,",
          "6061:                 'coursestart' => $pastcoursestart,",
          "6062:                 'usercount' => 2,",
          "6063:                 'enrolmentmethods' => [",
          "6064:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6065:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6066:                 ],",
          "6067:                 'enrolled' => [",
          "6069:                     [",
          "6070:                         'manual' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED],",
          "6071:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6072:                     ],",
          "6074:                     [",
          "6075:                         'manual' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED],",
          "6076:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6077:                     ]",
          "6078:                 ],",
          "6079:                 'expected' => [",
          "6080:                     [",
          "6081:                         'start' => $pastcoursestart,",
          "6082:                         'startoffset' => 0",
          "6083:                     ],",
          "6084:                     [",
          "6085:                         'start' => $pastcoursestart,",
          "6086:                         'startoffset' => 0",
          "6087:                     ]",
          "6088:                 ]",
          "6089:             ],",
          "6090:             'past course start fixed 2 users enrolled 2 methods 0 disabled 2 user suspended' => [",
          "6091:                 'relativedatemode' => false,",
          "6092:                 'coursestart' => $pastcoursestart,",
          "6093:                 'usercount' => 2,",
          "6094:                 'enrolmentmethods' => [",
          "6095:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6096:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6097:                 ],",
          "6098:                 'enrolled' => [",
          "6100:                     [",
          "6101:                         'manual' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED],",
          "6102:                         'self' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED]",
          "6103:                     ],",
          "6105:                     [",
          "6106:                         'manual' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED],",
          "6107:                         'self' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED]",
          "6108:                     ]",
          "6109:                 ],",
          "6110:                 'expected' => [",
          "6111:                     [",
          "6112:                         'start' => $pastcoursestart,",
          "6113:                         'startoffset' => 0",
          "6114:                     ],",
          "6115:                     [",
          "6116:                         'start' => $pastcoursestart,",
          "6117:                         'startoffset' => 0",
          "6118:                     ]",
          "6119:                 ]",
          "6120:             ],",
          "6121:             'past course start relative no users enrolled' => [",
          "6122:                 'relativedatemode' => true,",
          "6123:                 'coursestart' => $pastcoursestart,",
          "6124:                 'usercount' => 2,",
          "6125:                 'enrolmentmethods' => [",
          "6126:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6127:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6128:                 ],",
          "6129:                 'enrolled' => [[], []],",
          "6130:                 'expected' => [",
          "6131:                     [",
          "6132:                         'start' => $pastcoursestart,",
          "6133:                         'startoffset' => 0",
          "6134:                     ],",
          "6135:                     [",
          "6136:                         'start' => $pastcoursestart,",
          "6137:                         'startoffset' => 0",
          "6138:                     ]",
          "6139:                 ]",
          "6140:             ],",
          "6141:             'past course start relative 1 users enrolled future' => [",
          "6142:                 'relativedatemode' => true,",
          "6143:                 'coursestart' => $pastcoursestart,",
          "6144:                 'usercount' => 2,",
          "6145:                 'enrolmentmethods' => [",
          "6146:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6147:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6148:                 ],",
          "6149:                 'enrolled' => [",
          "6151:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "6153:                     []",
          "6154:                 ],",
          "6155:                 'expected' => [",
          "6156:                     [",
          "6157:                         'start' => $pastcoursestart + 10,",
          "6158:                         'startoffset' => 10",
          "6159:                     ],",
          "6160:                     [",
          "6161:                         'start' => $pastcoursestart,",
          "6162:                         'startoffset' => 0",
          "6163:                     ]",
          "6164:                 ]",
          "6165:             ],",
          "6166:             'past course start relative 1 users enrolled past' => [",
          "6167:                 'relativedatemode' => true,",
          "6168:                 'coursestart' => $pastcoursestart,",
          "6169:                 'usercount' => 2,",
          "6170:                 'enrolmentmethods' => [",
          "6171:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6172:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6173:                 ],",
          "6174:                 'enrolled' => [",
          "6176:                     ['manual' => [$pastcoursestart - 10, ENROL_USER_ACTIVE]],",
          "6178:                     []",
          "6179:                 ],",
          "6180:                 'expected' => [",
          "6181:                     [",
          "6182:                         'start' => $pastcoursestart,",
          "6183:                         'startoffset' => 0",
          "6184:                     ],",
          "6185:                     [",
          "6186:                         'start' => $pastcoursestart,",
          "6187:                         'startoffset' => 0",
          "6188:                     ]",
          "6189:                 ]",
          "6190:             ],",
          "6191:             'past course start relative 2 users enrolled future' => [",
          "6192:                 'relativedatemode' => true,",
          "6193:                 'coursestart' => $pastcoursestart,",
          "6194:                 'usercount' => 2,",
          "6195:                 'enrolmentmethods' => [",
          "6196:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6197:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6198:                 ],",
          "6199:                 'enrolled' => [",
          "6201:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "6203:                     ['manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]]",
          "6204:                 ],",
          "6205:                 'expected' => [",
          "6206:                     [",
          "6207:                         'start' => $pastcoursestart + 10,",
          "6208:                         'startoffset' => 10",
          "6209:                     ],",
          "6210:                     [",
          "6211:                         'start' => $pastcoursestart + 20,",
          "6212:                         'startoffset' => 20",
          "6213:                     ]",
          "6214:                 ]",
          "6215:             ],",
          "6216:             'past course start relative 2 users enrolled past' => [",
          "6217:                 'relativedatemode' => true,",
          "6218:                 'coursestart' => $pastcoursestart,",
          "6219:                 'usercount' => 2,",
          "6220:                 'enrolmentmethods' => [",
          "6221:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6222:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6223:                 ],",
          "6224:                 'enrolled' => [",
          "6226:                     ['manual' => [$pastcoursestart - 10, ENROL_USER_ACTIVE]],",
          "6228:                     ['manual' => [$pastcoursestart - 20, ENROL_USER_ACTIVE]]",
          "6229:                 ],",
          "6230:                 'expected' => [",
          "6231:                     [",
          "6232:                         'start' => $pastcoursestart,",
          "6233:                         'startoffset' => 0",
          "6234:                     ],",
          "6235:                     [",
          "6236:                         'start' => $pastcoursestart,",
          "6237:                         'startoffset' => 0",
          "6238:                     ]",
          "6239:                 ]",
          "6240:             ],",
          "6241:             'past course start relative 2 users enrolled mixed' => [",
          "6242:                 'relativedatemode' => true,",
          "6243:                 'coursestart' => $pastcoursestart,",
          "6244:                 'usercount' => 2,",
          "6245:                 'enrolmentmethods' => [",
          "6246:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6247:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6248:                 ],",
          "6249:                 'enrolled' => [",
          "6251:                     ['manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]],",
          "6253:                     ['manual' => [$pastcoursestart - 20, ENROL_USER_ACTIVE]]",
          "6254:                 ],",
          "6255:                 'expected' => [",
          "6256:                     [",
          "6257:                         'start' => $pastcoursestart + 10,",
          "6258:                         'startoffset' => 10",
          "6259:                     ],",
          "6260:                     [",
          "6261:                         'start' => $pastcoursestart,",
          "6262:                         'startoffset' => 0",
          "6263:                     ]",
          "6264:                 ]",
          "6265:             ],",
          "6266:             'past course start relative 2 users enrolled 2 methods' => [",
          "6267:                 'relativedatemode' => true,",
          "6268:                 'coursestart' => $pastcoursestart,",
          "6269:                 'usercount' => 2,",
          "6270:                 'enrolmentmethods' => [",
          "6271:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6272:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6273:                 ],",
          "6274:                 'enrolled' => [",
          "6276:                     [",
          "6277:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "6278:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6279:                     ],",
          "6281:                     [",
          "6282:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "6283:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6284:                     ]",
          "6285:                 ],",
          "6286:                 'expected' => [",
          "6287:                     [",
          "6288:                         'start' => $pastcoursestart + 10,",
          "6289:                         'startoffset' => 10",
          "6290:                     ],",
          "6291:                     [",
          "6292:                         'start' => $pastcoursestart + 10,",
          "6293:                         'startoffset' => 10",
          "6294:                     ]",
          "6295:                 ]",
          "6296:             ],",
          "6297:             'past course start relative 2 users enrolled 2 methods 1 disabled' => [",
          "6298:                 'relativedatemode' => true,",
          "6299:                 'coursestart' => $pastcoursestart,",
          "6300:                 'usercount' => 2,",
          "6301:                 'enrolmentmethods' => [",
          "6302:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "6303:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6304:                 ],",
          "6305:                 'enrolled' => [",
          "6307:                     [",
          "6308:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "6309:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6310:                     ],",
          "6312:                     [",
          "6313:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "6314:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6315:                     ]",
          "6316:                 ],",
          "6317:                 'expected' => [",
          "6318:                     [",
          "6319:                         'start' => $pastcoursestart + 20,",
          "6320:                         'startoffset' => 20",
          "6321:                     ],",
          "6322:                     [",
          "6323:                         'start' => $pastcoursestart + 10,",
          "6324:                         'startoffset' => 10",
          "6325:                     ]",
          "6326:                 ]",
          "6327:             ],",
          "6328:             'past course start relative 2 users enrolled 2 methods 2 disabled' => [",
          "6329:                 'relativedatemode' => true,",
          "6330:                 'coursestart' => $pastcoursestart,",
          "6331:                 'usercount' => 2,",
          "6332:                 'enrolmentmethods' => [",
          "6333:                     ['manual', ENROL_INSTANCE_DISABLED],",
          "6334:                     ['self', ENROL_INSTANCE_DISABLED]",
          "6335:                 ],",
          "6336:                 'enrolled' => [",
          "6338:                     [",
          "6339:                         'manual' => [$pastcoursestart + 10, ENROL_USER_ACTIVE],",
          "6340:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6341:                     ],",
          "6343:                     [",
          "6344:                         'manual' => [$pastcoursestart + 20, ENROL_USER_ACTIVE],",
          "6345:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6346:                     ]",
          "6347:                 ],",
          "6348:                 'expected' => [",
          "6349:                     [",
          "6350:                         'start' => $pastcoursestart,",
          "6351:                         'startoffset' => 0",
          "6352:                     ],",
          "6353:                     [",
          "6354:                         'start' => $pastcoursestart,",
          "6355:                         'startoffset' => 0",
          "6356:                     ]",
          "6357:                 ]",
          "6358:             ],",
          "6359:             'past course start relative 2 users enrolled 2 methods 0 disabled 1 user suspended' => [",
          "6360:                 'relativedatemode' => true,",
          "6361:                 'coursestart' => $pastcoursestart,",
          "6362:                 'usercount' => 2,",
          "6363:                 'enrolmentmethods' => [",
          "6364:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6365:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6366:                 ],",
          "6367:                 'enrolled' => [",
          "6369:                     [",
          "6370:                         'manual' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED],",
          "6371:                         'self' => [$pastcoursestart + 20, ENROL_USER_ACTIVE]",
          "6372:                     ],",
          "6374:                     [",
          "6375:                         'manual' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED],",
          "6376:                         'self' => [$pastcoursestart + 10, ENROL_USER_ACTIVE]",
          "6377:                     ]",
          "6378:                 ],",
          "6379:                 'expected' => [",
          "6380:                     [",
          "6381:                         'start' => $pastcoursestart + 20,",
          "6382:                         'startoffset' => 20",
          "6383:                     ],",
          "6384:                     [",
          "6385:                         'start' => $pastcoursestart + 10,",
          "6386:                         'startoffset' => 10",
          "6387:                     ]",
          "6388:                 ]",
          "6389:             ],",
          "6390:             'past course start relative 2 users enrolled 2 methods 0 disabled 2 user suspended' => [",
          "6391:                 'relativedatemode' => true,",
          "6392:                 'coursestart' => $pastcoursestart,",
          "6393:                 'usercount' => 2,",
          "6394:                 'enrolmentmethods' => [",
          "6395:                     ['manual', ENROL_INSTANCE_ENABLED],",
          "6396:                     ['self', ENROL_INSTANCE_ENABLED]",
          "6397:                 ],",
          "6398:                 'enrolled' => [",
          "6400:                     [",
          "6401:                         'manual' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED],",
          "6402:                         'self' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED]",
          "6403:                     ],",
          "6405:                     [",
          "6406:                         'manual' => [$pastcoursestart + 20, ENROL_USER_SUSPENDED],",
          "6407:                         'self' => [$pastcoursestart + 10, ENROL_USER_SUSPENDED]",
          "6408:                     ]",
          "6409:                 ],",
          "6410:                 'expected' => [",
          "6411:                     [",
          "6412:                         'start' => $pastcoursestart,",
          "6413:                         'startoffset' => 0",
          "6414:                     ],",
          "6415:                     [",
          "6416:                         'start' => $pastcoursestart,",
          "6417:                         'startoffset' => 0",
          "6418:                     ]",
          "6419:                 ]",
          "6420:             ]",
          "6421:         ];",
          "6422:     }",
          "6435:     public function test_course_get_course_dates_for_user_ids(",
          "6436:         $relativedatemode,",
          "6437:         $coursestart,",
          "6438:         $usercount,",
          "6439:         $enrolmentmethods,",
          "6440:         $enrolled,",
          "6441:         $expected",
          "6442:     ) {",
          "6443:         global $DB;",
          "6444:         $this->resetAfterTest();",
          "6446:         $generator = $this->getDataGenerator();",
          "6447:         $course  = $generator->create_course(['startdate' => $coursestart]);",
          "6448:         $course->relativedatesmode = $relativedatemode;",
          "6449:         $users = [];",
          "6451:         for ($i = 0; $i < $usercount; $i++) {",
          "6452:             $users[] = $generator->create_user();",
          "6453:         }",
          "6455:         foreach ($enrolmentmethods as [$type, $status]) {",
          "6456:             $record = $DB->get_record('enrol', ['courseid' => $course->id, 'enrol' => $type]);",
          "6457:             $plugin = enrol_get_plugin($type);",
          "6458:             if ($record->status != $status) {",
          "6459:                 $plugin->update_status($record, $status);",
          "6460:             }",
          "6461:         }",
          "6463:         foreach ($enrolled as $index => $enrolconfig) {",
          "6464:             $user = $users[$index];",
          "6465:             foreach ($enrolconfig as $type => [$starttime, $status]) {",
          "6466:                 $generator->enrol_user($user->id, $course->id, 'student', $type, $starttime, 0, $status);",
          "6467:             }",
          "6468:         }",
          "6470:         $userids = array_map(function($user) {",
          "6471:             return $user->id;",
          "6472:         }, $users);",
          "6473:         $actual = course_get_course_dates_for_user_ids($course, $userids);",
          "6475:         foreach ($expected as $index => $exp) {",
          "6476:             $userid = $userids[$index];",
          "6477:             $act = $actual[$userid];",
          "6479:             $this->assertEquals($exp['start'], $act['start']);",
          "6480:             $this->assertEquals($exp['startoffset'], $act['startoffset']);",
          "6481:         }",
          "6482:     }",
          "6488:     public function test_course_get_course_dates_for_user_ids_multiple_calls() {",
          "6489:         $this->resetAfterTest();",
          "6491:         $generator = $this->getDataGenerator();",
          "6492:         $now = time();",
          "6493:         $coursestart = $now - 1000;",
          "6494:         $course  = $generator->create_course(['startdate' => $coursestart]);",
          "6495:         $course->relativedatesmode = true;",
          "6496:         $user1 = $generator->create_user();",
          "6497:         $user2 = $generator->create_user();",
          "6498:         $user1start = $coursestart + 100;",
          "6499:         $user2start = $coursestart + 200;",
          "6501:         $generator->enrol_user($user1->id, $course->id, 'student', 'manual', $user1start);",
          "6502:         $generator->enrol_user($user2->id, $course->id, 'student', 'manual', $user2start);",
          "6504:         $result = course_get_course_dates_for_user_ids($course, [$user1->id]);",
          "6505:         $this->assertEquals($user1start, $result[$user1->id]['start']);",
          "6507:         $result = course_get_course_dates_for_user_ids($course, [$user1->id, $user2->id]);",
          "6508:         $this->assertEquals($user1start, $result[$user1->id]['start']);",
          "6509:         $this->assertEquals($user2start, $result[$user2->id]['start']);",
          "6511:         $result = course_get_course_dates_for_user_ids($course, [$user2->id]);",
          "6512:         $this->assertEquals($user2start, $result[$user2->id]['start']);",
          "6513:     }",
          "",
          "---------------"
        ],
        "lang/en/cache.php||lang/en/cache.php": [
          "File: lang/en/cache.php -> lang/en/cache.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: $string['cachedef_coursecompletion'] = 'Course completion status';",
          "47: $string['cachedef_coursecontacts'] = 'List of course contacts';",
          "48: $string['cachedef_coursemodinfo'] = 'Accumulated information about modules and sections for each course';",
          "49: $string['cachedef_completion'] = 'Activity completion status';",
          "50: $string['cachedef_databasemeta'] = 'Database meta information';",
          "51: $string['cachedef_eventinvalidation'] = 'Event invalidation';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "49: $string['cachedef_course_user_dates'] = 'The user dates for courses set to relative dates mode';",
          "",
          "---------------"
        ],
        "lib/db/caches.php||lib/db/caches.php": [
          "File: lib/db/caches.php -> lib/db/caches.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "400:         'simplekeys' => true,",
          "401:         'staticacceleration' => true",
          "402:     ],",
          "403: );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "405:     'course_user_dates' => [",
          "406:         'mode' => cache_store::MODE_REQUEST,",
          "407:         'simplekeys' => true,",
          "408:         'simpledata' => true,",
          "409:         'staticacceleration' => true",
          "410:     ],",
          "",
          "---------------"
        ],
        "lib/enrollib.php||lib/enrollib.php": [
          "File: lib/enrollib.php -> lib/enrollib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1665:     $sql = \"SELECT ue.id AS ueid, ue.status AS uestatus, ue.enrolid AS ueenrolid, ue.timestart AS uetimestart,",
          "1666:              ue.timeend AS uetimeend, ue.modifierid AS uemodifierid, ue.timecreated AS uetimecreated,",
          "1668:              u.* FROM {user_enrolments} ue",
          "1669:               JOIN {enrol} e ON e.id = ue.enrolid",
          "1670:               JOIN {user} u ON ue.userid = u.id",
          "",
          "[Removed Lines]",
          "1667:              ue.timemodified AS uetimemodified,",
          "",
          "[Added Lines]",
          "1667:              ue.timemodified AS uetimemodified, e.status AS estatus,",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019072200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019072200.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "383aec8a01942b09326119e4c2119aa982925312",
      "candidate_info": {
        "commit_hash": "383aec8a01942b09326119e4c2119aa982925312",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/383aec8a01942b09326119e4c2119aa982925312",
        "files": [
          "version.php"
        ],
        "message": "weekly on-sync release 3.8dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190520)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019052000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190524)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2bd26607512c36aeb17b2e788fa7e985788ca777",
      "candidate_info": {
        "commit_hash": "2bd26607512c36aeb17b2e788fa7e985788ca777",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/2bd26607512c36aeb17b2e788fa7e985788ca777",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.5dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018032900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180329)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018040500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5dev (Build: 20180405)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "78e07cbcf0b19409e63870946701e6f06c4eb4b7",
      "candidate_info": {
        "commit_hash": "78e07cbcf0b19409e63870946701e6f06c4eb4b7",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/78e07cbcf0b19409e63870946701e6f06c4eb4b7",
        "files": [
          "blocks/recentlyaccesseditems/amd/build/main.min.js",
          "blocks/recentlyaccesseditems/amd/build/repository.min.js",
          "blocks/recentlyaccesseditems/amd/src/main.js",
          "blocks/recentlyaccesseditems/amd/src/repository.js",
          "blocks/recentlyaccesseditems/block_recentlyaccesseditems.php",
          "blocks/recentlyaccesseditems/classes/external.php",
          "blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php",
          "blocks/recentlyaccesseditems/classes/helper.php",
          "blocks/recentlyaccesseditems/classes/observer.php",
          "blocks/recentlyaccesseditems/classes/output/main.php",
          "blocks/recentlyaccesseditems/classes/output/renderer.php",
          "blocks/recentlyaccesseditems/classes/privacy/provider.php",
          "blocks/recentlyaccesseditems/db/access.php",
          "blocks/recentlyaccesseditems/db/events.php",
          "blocks/recentlyaccesseditems/db/install.xml",
          "blocks/recentlyaccesseditems/db/services.php",
          "blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php",
          "blocks/recentlyaccesseditems/pix/items.svg",
          "blocks/recentlyaccesseditems/templates/main.mustache",
          "blocks/recentlyaccesseditems/templates/no-items.mustache",
          "blocks/recentlyaccesseditems/templates/placeholder-item.mustache",
          "blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache",
          "blocks/recentlyaccesseditems/templates/view-cards.mustache",
          "blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature",
          "blocks/recentlyaccesseditems/tests/externallib_test.php",
          "blocks/recentlyaccesseditems/tests/observer_test.php",
          "blocks/recentlyaccesseditems/version.php",
          "lib/classes/plugin_manager.php",
          "theme/boost/scss/moodle/blocks.scss",
          "theme/boost/style/moodle.css",
          "theme/bootstrapbase/less/moodle/blocks.less",
          "theme/bootstrapbase/style/moodle.css",
          "version.php"
        ],
        "message": "MDL-63063 recentlyaccesseditems: fully contained block",
        "before_after_code_files": [
          "blocks/recentlyaccesseditems/amd/src/main.js||blocks/recentlyaccesseditems/amd/src/main.js",
          "blocks/recentlyaccesseditems/amd/src/repository.js||blocks/recentlyaccesseditems/amd/src/repository.js",
          "blocks/recentlyaccesseditems/block_recentlyaccesseditems.php||blocks/recentlyaccesseditems/block_recentlyaccesseditems.php",
          "blocks/recentlyaccesseditems/classes/external.php||blocks/recentlyaccesseditems/classes/external.php",
          "blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php||blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php",
          "blocks/recentlyaccesseditems/classes/helper.php||blocks/recentlyaccesseditems/classes/helper.php",
          "blocks/recentlyaccesseditems/classes/observer.php||blocks/recentlyaccesseditems/classes/observer.php",
          "blocks/recentlyaccesseditems/classes/output/main.php||blocks/recentlyaccesseditems/classes/output/main.php",
          "blocks/recentlyaccesseditems/classes/output/renderer.php||blocks/recentlyaccesseditems/classes/output/renderer.php",
          "blocks/recentlyaccesseditems/classes/privacy/provider.php||blocks/recentlyaccesseditems/classes/privacy/provider.php",
          "blocks/recentlyaccesseditems/db/access.php||blocks/recentlyaccesseditems/db/access.php",
          "blocks/recentlyaccesseditems/db/events.php||blocks/recentlyaccesseditems/db/events.php",
          "blocks/recentlyaccesseditems/db/services.php||blocks/recentlyaccesseditems/db/services.php",
          "blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php||blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php",
          "blocks/recentlyaccesseditems/templates/main.mustache||blocks/recentlyaccesseditems/templates/main.mustache",
          "blocks/recentlyaccesseditems/templates/no-items.mustache||blocks/recentlyaccesseditems/templates/no-items.mustache",
          "blocks/recentlyaccesseditems/templates/placeholder-item.mustache||blocks/recentlyaccesseditems/templates/placeholder-item.mustache",
          "blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache||blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache",
          "blocks/recentlyaccesseditems/templates/view-cards.mustache||blocks/recentlyaccesseditems/templates/view-cards.mustache",
          "blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature||blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature",
          "blocks/recentlyaccesseditems/tests/externallib_test.php||blocks/recentlyaccesseditems/tests/externallib_test.php",
          "blocks/recentlyaccesseditems/tests/observer_test.php||blocks/recentlyaccesseditems/tests/observer_test.php",
          "blocks/recentlyaccesseditems/version.php||blocks/recentlyaccesseditems/version.php",
          "lib/classes/plugin_manager.php||lib/classes/plugin_manager.php",
          "theme/boost/scss/moodle/blocks.scss||theme/boost/scss/moodle/blocks.scss",
          "theme/boost/style/moodle.css||theme/boost/style/moodle.css",
          "theme/bootstrapbase/less/moodle/blocks.less||theme/bootstrapbase/less/moodle/blocks.less",
          "theme/bootstrapbase/style/moodle.css||theme/bootstrapbase/style/moodle.css",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "blocks/recentlyaccesseditems/amd/src/main.js||blocks/recentlyaccesseditems/amd/src/main.js": [
          "File: blocks/recentlyaccesseditems/amd/src/main.js -> blocks/recentlyaccesseditems/amd/src/main.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: define(",
          "27:     [",
          "28:         'jquery',",
          "29:         'block_recentlyaccesseditems/repository',",
          "30:         'core/templates',",
          "31:         'core/notification'",
          "32:     ],",
          "33:     function(",
          "34:         $,",
          "35:         Repository,",
          "36:         Templates,",
          "37:         Notification",
          "38:     ) {",
          "40:         var NUM_ITEMS = 9;",
          "42:         var SELECTORS = {",
          "43:             CARDDECK_CONTAINER: '[data-region=\"recentlyaccesseditems-view\"]',",
          "44:             CARDDECK: '[data-region=\"recentlyaccesseditems-view-content\"]',",
          "45:         };",
          "54:         var getRecentItems = function(limit) {",
          "55:             return Repository.getRecentItems(limit);",
          "56:         };",
          "66:         var renderItems = function(root, items) {",
          "67:             if (items.length > 0) {",
          "68:                 return Templates.render('block_recentlyaccesseditems/view-cards', {",
          "69:                     items: items",
          "70:                 });",
          "71:             } else {",
          "72:                 var noitemsimgurl = root.attr('data-noitemsimgurl');",
          "73:                 return Templates.render('block_recentlyaccesseditems/no-items', {",
          "74:                     noitemsimgurl: noitemsimgurl",
          "75:                 });",
          "76:             }",
          "77:         };",
          "84:         var init = function(root) {",
          "85:             root = $(root);",
          "87:             var itemsContainer = root.find(SELECTORS.CARDDECK_CONTAINER);",
          "88:             var itemsContent = root.find(SELECTORS.CARDDECK);",
          "90:             var itemsPromise = getRecentItems(NUM_ITEMS);",
          "92:             itemsPromise.then(function(items) {",
          "93:                 var pageContentPromise = renderItems(itemsContainer, items);",
          "95:                 pageContentPromise.then(function(html, js) {",
          "96:                     return Templates.replaceNodeContents(itemsContent, html, js);",
          "97:                 }).catch(Notification.exception);",
          "98:                 return itemsPromise;",
          "99:             }).catch(Notification.exception);",
          "100:         };",
          "102:         return {",
          "103:             init: init",
          "104:         };",
          "105:     });",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/amd/src/repository.js||blocks/recentlyaccesseditems/amd/src/repository.js": [
          "File: blocks/recentlyaccesseditems/amd/src/repository.js -> blocks/recentlyaccesseditems/amd/src/repository.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: define(['core/ajax'], function(Ajax) {",
          "33:     var getRecentItems = function(limit) {",
          "34:         var args = {};",
          "35:         if (typeof limit !== 'undefined') {",
          "36:             args.limit = limit;",
          "37:         }",
          "38:         var request = {",
          "39:             methodname: 'block_recentlyaccesseditems_get_recent_items',",
          "40:             args: args",
          "41:         };",
          "42:         return Ajax.call([request])[0];",
          "43:     };",
          "44:     return {",
          "45:         getRecentItems: getRecentItems",
          "46:     };",
          "47: });",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/block_recentlyaccesseditems.php||blocks/recentlyaccesseditems/block_recentlyaccesseditems.php": [
          "File: blocks/recentlyaccesseditems/block_recentlyaccesseditems.php -> blocks/recentlyaccesseditems/block_recentlyaccesseditems.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: defined('MOODLE_INTERNAL') || die();",
          "31: class block_recentlyaccesseditems extends block_base {",
          "35:     public function init() {",
          "36:         $this->title = get_string('pluginname', 'block_recentlyaccesseditems');",
          "37:     }",
          "44:     public function get_content() {",
          "45:         if (isset($this->content)) {",
          "46:             return $this->content;",
          "47:         }",
          "48:         $renderable = new block_recentlyaccesseditems\\output\\main();",
          "49:         $renderer = $this->page->get_renderer('block_recentlyaccesseditems');",
          "51:         $this->content = new stdClass();",
          "52:         $this->content->text = $renderer->render($renderable);",
          "53:         $this->content->footer = '';",
          "54:         return $this->content;",
          "55:     }",
          "62:     public function applicable_formats() {",
          "63:         return array('my' => true);",
          "64:     }",
          "65: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/external.php||blocks/recentlyaccesseditems/classes/external.php": [
          "File: blocks/recentlyaccesseditems/classes/external.php -> blocks/recentlyaccesseditems/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace block_recentlyaccesseditems;",
          "25: defined('MOODLE_INTERNAL') || die();",
          "27: require_once(\"$CFG->libdir/externallib.php\");",
          "29: use block_recentlyaccesseditems\\external\\recentlyaccesseditems_item_exporter;",
          "30: use external_api;",
          "31: use external_function_parameters;",
          "32: use external_value;",
          "33: use external_multiple_structure;",
          "34: use context_user;",
          "35: use context_module;",
          "44: class external extends external_api {",
          "50:     public static function get_recent_items_parameters() {",
          "51:         return new external_function_parameters(",
          "52:                 array(",
          "53:                         'limit' => new external_value(PARAM_INT, 'result set limit', VALUE_DEFAULT, 0)",
          "54:                 )",
          "55:         );",
          "56:     }",
          "65:     public static function get_recent_items(int $limit = 0) {",
          "66:         global $USER, $PAGE;",
          "68:         $userid = $USER->id;",
          "70:         if ($userid != $USER->id) {",
          "71:             return array();",
          "72:         }",
          "74:         $params = self::validate_parameters(self::get_recent_items_parameters(),",
          "75:             array(",
          "76:                 'limit' => $limit,",
          "77:             )",
          "78:         );",
          "80:         $limit = $params['limit'];",
          "82:         self::validate_context(context_user::instance($userid));",
          "84:         $items = helper::get_recent_items($limit);",
          "86:         $renderer = $PAGE->get_renderer('core');",
          "87:         $recentitems = array_map(function($item) use ($renderer) {",
          "88:             $context = context_module::instance($item->cmid);",
          "89:             $exporter = new recentlyaccesseditems_item_exporter($item, ['context' => $context]);",
          "90:             return $exporter->export($renderer);",
          "91:         }, $items);",
          "93:         return $recentitems;",
          "94:     }",
          "102:     public static function get_recent_items_returns() {",
          "103:         return new external_multiple_structure(recentlyaccesseditems_item_exporter::get_read_structure(),",
          "104:                 'The most recently accessed activities/resources by the logged user');",
          "105:     }",
          "106: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php||blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php": [
          "File: blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php -> blocks/recentlyaccesseditems/classes/external/recentlyaccesseditems_item_exporter.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: namespace block_recentlyaccesseditems\\external;",
          "24: defined('MOODLE_INTERNAL') || die();",
          "26: use renderer_base;",
          "27: use moodle_url;",
          "35: class recentlyaccesseditems_item_exporter extends \\core\\external\\exporter {",
          "40:     protected static function define_related() {",
          "42:         return array('context' => '\\\\context');",
          "43:     }",
          "51:     protected function get_other_values(renderer_base $output) {",
          "52:         global $OUTPUT;",
          "54:         return array(",
          "55:                 'viewurl' => (new moodle_url('/mod/'.$this->data->modname.'/view.php',",
          "56:                         array('id' => $this->data->cmid)))->out(false),",
          "57:                 'courseviewurl' => (new moodle_url('/course/view.php', array('id' => $this->data->courseid)))->out(false),",
          "58:                 'icon' => $OUTPUT->image_icon('icon', get_string('pluginname', $this->data->modname), $this->data->modname)",
          "59:         );",
          "60:     }",
          "67:     public static function define_properties() {",
          "68:         return array(",
          "69:             'id' => array(",
          "70:                 'type' => PARAM_INT,",
          "71:             ),",
          "72:             'courseid' => array(",
          "73:                 'type' => PARAM_INT,",
          "74:             ),",
          "75:             'cmid' => array(",
          "76:                 'type' => PARAM_INT,",
          "77:             ),",
          "78:             'userid' => array(",
          "79:                 'type' => PARAM_INT,",
          "80:             ),",
          "81:             'modname' => array(",
          "82:                 'type' => PARAM_TEXT,",
          "83:             ),",
          "84:             'name' => array(",
          "85:                     'type' => PARAM_TEXT,",
          "86:             ),",
          "87:             'coursename' => array(",
          "88:                 'type' => PARAM_TEXT,",
          "89:             ),",
          "90:             'timeaccess' => array(",
          "91:                 'type' => PARAM_INT,",
          "92:             )",
          "93:         );",
          "94:     }",
          "101:     public static function define_other_properties() {",
          "102:         return array(",
          "103:             'viewurl' => array(",
          "104:                 'type' => PARAM_TEXT,",
          "105:             ),",
          "106:             'courseviewurl' => array(",
          "107:                     'type' => PARAM_URL,",
          "108:             ),",
          "109:             'icon' => array(",
          "110:                 'type' => PARAM_RAW,",
          "111:             )",
          "112:         );",
          "113:     }",
          "114: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/helper.php||blocks/recentlyaccesseditems/classes/helper.php": [
          "File: blocks/recentlyaccesseditems/classes/helper.php -> blocks/recentlyaccesseditems/classes/helper.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace block_recentlyaccesseditems;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "36: class helper {",
          "43:     public static function get_recent_items(int $limit = 0) {",
          "44:         global $USER, $DB;",
          "46:         $userid = $USER->id;",
          "48:         $courses = array();",
          "49:         $recentitems = array();",
          "51:         if (!isloggedin() or \\core\\session\\manager::is_loggedinas() or isguestuser()) {",
          "53:             return $recentitems;",
          "54:         }",
          "57:         $sort = 'timeaccess DESC';",
          "59:         $paramsql = array('userid' => $userid);",
          "60:         $records = $DB->get_records('block_recentlyaccesseditems', $paramsql, $sort);",
          "61:         $order = 0;",
          "64:         foreach ($records as $record) {",
          "65:             $courses[$record->courseid][$order++] = $record;",
          "66:         }",
          "69:         foreach ($courses as $key => $items) {",
          "70:             $modinfo = get_fast_modinfo($key);",
          "71:             foreach ($items as $key => $item) {",
          "73:                 if (!$modinfo->cms[$item->cmid]->uservisible) {",
          "74:                     continue;",
          "75:                 }",
          "76:                 $item->modname = $modinfo->cms[$item->cmid]->modname;",
          "77:                 $item->name = $modinfo->cms[$item->cmid]->name;",
          "78:                 $item->coursename = get_course_display_name_for_list($modinfo->get_course());",
          "79:                 $recentitems[$key] = $item;",
          "80:             }",
          "81:         }",
          "83:         ksort($recentitems);",
          "86:         if (!$limit) {",
          "87:             $limit = count($recentitems);",
          "88:         }",
          "89:         $recentitems = array_slice($recentitems, 0, $limit);",
          "91:         return $recentitems;",
          "92:     }",
          "93: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/observer.php||blocks/recentlyaccesseditems/classes/observer.php": [
          "File: blocks/recentlyaccesseditems/classes/observer.php -> blocks/recentlyaccesseditems/classes/observer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace block_recentlyaccesseditems;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "38: class observer {",
          "43:     private static $table = 'block_recentlyaccesseditems';",
          "53:     public static function store(\\core\\event\\base $event) {",
          "54:         global $DB;",
          "56:         if (!isloggedin() or \\core\\session\\manager::is_loggedinas() or isguestuser()) {",
          "58:             return;",
          "59:         }",
          "61:         $conditions = [",
          "62:             'userid' => $event->userid",
          "63:         ];",
          "65:         $records = $DB->get_records(self::$table, $conditions, \"timeaccess DESC\");",
          "67:         foreach ($records as $record) {",
          "68:             if (($record->userid == $event->userid) && ($record->cmid == $event->contextinstanceid)) {",
          "69:                 $conditions = [",
          "70:                         'userid' => $event->userid,",
          "71:                         'cmid' => $event->contextinstanceid",
          "72:                 ];",
          "73:                 $DB->set_field(self::$table, 'timeaccess', $event->timecreated, $conditions);",
          "74:                 return;",
          "75:             }",
          "76:         }",
          "78:         if (count($records) >= 9) {",
          "79:             $conditions = [",
          "80:                     'id' => end($records)->id,",
          "81:             ];",
          "82:             $DB->delete_records(self::$table, $conditions);",
          "83:         }",
          "85:         $eventdata = new \\stdClass();",
          "87:         $eventdata->cmid = $event->contextinstanceid;",
          "88:         $eventdata->timeaccess = $event->timecreated;",
          "89:         $eventdata->courseid = $event->courseid;",
          "90:         $eventdata->userid = $event->userid;",
          "92:         $DB->insert_record(self::$table, $eventdata);",
          "93:     }",
          "100:     public static function remove(\\core\\event\\base $event) {",
          "101:         global $DB;",
          "103:         $DB->delete_records(self::$table, array('cmid' => $event->contextinstanceid));",
          "104:     }",
          "105: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/output/main.php||blocks/recentlyaccesseditems/classes/output/main.php": [
          "File: blocks/recentlyaccesseditems/classes/output/main.php -> blocks/recentlyaccesseditems/classes/output/main.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace block_recentlyaccesseditems\\output;",
          "25: defined('MOODLE_INTERNAL') || die();",
          "27: use renderable;",
          "28: use renderer_base;",
          "29: use templatable;",
          "38: class main implements renderable, templatable {",
          "45:     public function export_for_template(renderer_base $output) {",
          "47:         $noitemsimgurl = $output->image_url('items', 'block_recentlyaccesseditems')->out();",
          "49:         return [",
          "50:             'noitemsimgurl' => $noitemsimgurl",
          "51:         ];",
          "52:     }",
          "53: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/output/renderer.php||blocks/recentlyaccesseditems/classes/output/renderer.php": [
          "File: blocks/recentlyaccesseditems/classes/output/renderer.php -> blocks/recentlyaccesseditems/classes/output/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: namespace block_recentlyaccesseditems\\output;",
          "25: defined('MOODLE_INTERNAL') || die;",
          "27: use plugin_renderer_base;",
          "36: class renderer extends plugin_renderer_base {",
          "43:     public function render_recentlyaccesseditems(renderer_base $main) {",
          "44:         return $this->render_from_template('block_recentlyaccesseditems/main', $main->export_for_template($this));",
          "45:     }",
          "46: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/classes/privacy/provider.php||blocks/recentlyaccesseditems/classes/privacy/provider.php": [
          "File: blocks/recentlyaccesseditems/classes/privacy/provider.php -> blocks/recentlyaccesseditems/classes/privacy/provider.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace block_recentlyaccesseditems\\privacy;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use \\core_privacy\\local\\metadata\\collection;",
          "30: use \\core_privacy\\local\\request\\transform;",
          "31: use \\core_privacy\\local\\request\\contextlist;",
          "32: use \\core_privacy\\local\\request\\approved_contextlist;",
          "33: use \\core_privacy\\local\\request\\writer;",
          "42: class provider implements \\core_privacy\\local\\metadata\\provider, \\core_privacy\\local\\request\\subsystem\\provider {",
          "50:     public static function get_metadata(collection $collection) : collection {",
          "51:         $recentitems = [",
          "52:                 'userid' => 'privacy:metadata:userid',",
          "53:                 'courseid' => 'privacy:metadata:courseid',",
          "54:                 'cmid' => 'privacy:metadata:cmid',",
          "55:                 'timeaccess' => 'privacy:metadata:timeaccess'",
          "56:         ];",
          "58:         $collection->add_database_table('block_recentlyaccesseditems', $recentitems,",
          "59:                 'privacy:metadata:block_recentlyaccesseditemstablesummary');",
          "61:         return $collection;",
          "62:     }",
          "70:     public static function get_contexts_for_userid(int $userid) : contextlist {",
          "71:         $params = ['userid' => $userid, 'contextuser' => CONTEXT_USER];",
          "72:         $sql = \"SELECT id",
          "73:                   FROM {context}",
          "74:                  WHERE instanceid = :userid and contextlevel = :contextuser\";",
          "75:         $contextlist = new contextlist();",
          "76:         $contextlist->add_from_sql($sql, $params);",
          "77:         return $contextlist;",
          "78:     }",
          "85:     public static function export_user_data(approved_contextlist $contextlist) {",
          "86:         $context = $contextlist->current();",
          "87:         $user = \\core_user::get_user($contextlist->get_user()->id);",
          "88:         static::export_recentitems($user->id, $context);",
          "89:     }",
          "97:     protected static function export_recentitems(int $userid, \\context $context) {",
          "98:         global $DB;",
          "99:         $sql = \"SELECT ra.id, c.fullname, ra.timeaccess, m.name, ra.cmid",
          "100:                   FROM {block_recentlyaccesseditems} ra",
          "101:                   JOIN {course} c ON c.id = ra.courseid",
          "102:                   JOIN {course_modules} cm on cm.id = ra.cmid",
          "103:                   JOIN {modules} m ON m.id = cm.module",
          "104:                  WHERE ra.userid = :userid\";",
          "106:         $params = ['userid' => $userid];",
          "107:         $records = $DB->get_records_sql($sql, $params);",
          "108:         if (!empty($records)) {",
          "109:             $recentitems = (object) array_map(function($record) use($context) {",
          "110:                 return [",
          "111:                         'course_name' => format_string($record->fullname, true, ['context' => $context]),",
          "112:                         'module_name' => format_string($record->name),",
          "113:                         'timeaccess' => transform::datetime($record->timeaccess)",
          "114:                 ];",
          "115:             }, $records);",
          "116:             writer::with_context($context)->export_data([get_string('privacy:recentlyaccesseditemspath',",
          "117:                     'block_recentlyaccesseditems')], $recentitems);",
          "118:         }",
          "119:     }",
          "126:     public static function delete_data_for_all_users_in_context(\\context $context) {",
          "127:         global $DB;",
          "130:         if ($context->contextlevel == CONTEXT_USER) {",
          "132:             $DB->delete_records('block_recentlyaccesseditems', ['userid' => $context->instanceid]);",
          "133:         }",
          "134:     }",
          "141:     public static function delete_data_for_user(approved_contextlist $contextlist) {",
          "142:         global $DB;",
          "144:         foreach ($contextlist as $context) {",
          "146:             if ($context->contextlevel == CONTEXT_USER && $contextlist->get_user()->id == $context->instanceid) {",
          "147:                 $DB->delete_records('block_recentlyaccesseditems', ['userid' => $context->instanceid]);",
          "148:             }",
          "149:         }",
          "150:     }",
          "151: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/db/access.php||blocks/recentlyaccesseditems/db/access.php": [
          "File: blocks/recentlyaccesseditems/db/access.php -> blocks/recentlyaccesseditems/db/access.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: defined('MOODLE_INTERNAL') || die();",
          "24: $capabilities = array(",
          "25:         'block/recentlyaccesseditems:myaddinstance' => array(",
          "26:                 'captype' => 'write',",
          "27:                 'contextlevel' => CONTEXT_SYSTEM,",
          "28:                 'archetypes' => array(",
          "29:                         'user' => CAP_ALLOW",
          "30:                 ),",
          "31:                 'clonepermissionsfrom' => 'moodle/my:manageblocks'",
          "32:         ),",
          "33:         'block/recentlyaccesseditems:addinstance' => array(",
          "34:                 'captype' => 'write',",
          "35:                 'contextlevel' => CONTEXT_BLOCK,",
          "36:                 'archetypes' => array(",
          "37:                         'manager' => CAP_ALLOW",
          "38:                 ),",
          "39:                 'clonepermissionsfrom' => 'moodle/site:manageblocks'",
          "40:         )",
          "41: );",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/db/events.php||blocks/recentlyaccesseditems/db/events.php": [
          "File: blocks/recentlyaccesseditems/db/events.php -> blocks/recentlyaccesseditems/db/events.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "26: defined('MOODLE_INTERNAL') || die();",
          "28: $observers = array (",
          "29:     array(",
          "30:             'eventname'   => '\\core\\event\\course_module_viewed',",
          "31:             'callback'    => 'block_recentlyaccesseditems\\observer::store',",
          "32:     ),",
          "33:     array(",
          "34:             'eventname'   => '\\core\\event\\course_module_deleted',",
          "35:             'callback'    => 'block_recentlyaccesseditems\\observer::remove'",
          "36:     ),",
          "37: );",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/db/services.php||blocks/recentlyaccesseditems/db/services.php": [
          "File: blocks/recentlyaccesseditems/db/services.php -> blocks/recentlyaccesseditems/db/services.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "26: defined('MOODLE_INTERNAL') || die();",
          "28: $functions = array(",
          "29:     'block_recentlyaccesseditems_get_recent_items' => array(",
          "30:         'classname' => 'block_recentlyaccesseditems\\external',",
          "31:         'methodname' => 'get_recent_items',",
          "32:         'classpath' => '',",
          "33:         'description' => 'List of items a user has accessed most recently.',",
          "34:         'type' => 'read',",
          "35:         'ajax' => true,",
          "36:         'services' => array(MOODLE_OFFICIAL_MOBILE_SERVICE),",
          "37:     ),",
          "38: );",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php||blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php": [
          "File: blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php -> blocks/recentlyaccesseditems/lang/en/block_recentlyaccesseditems.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: $string['noitems'] = 'No recent items';",
          "24: $string['pluginname'] = 'Recently accessed items';",
          "25: $string['privacy:metadata:cmid'] = 'The course module id';",
          "26: $string['privacy:metadata:courseid'] = 'Course the item belongs to';",
          "27: $string['privacy:metadata:block_recentlyaccesseditemstablesummary'] = 'Information about the last time a user accessed an item.';",
          "28: $string['privacy:metadata:timeaccess'] = 'The time of the last access to the item by the user.';",
          "29: $string['privacy:metadata:userid'] = 'User who accessed the item';",
          "30: $string['privacy:recentlyaccesseditemspath'] = 'Recently accessed items';",
          "31: $string['recentlyaccesseditems:addinstance'] = 'Add a new recently accessed items block';",
          "32: $string['recentlyaccesseditems:myaddinstance'] = 'Add a new recently accessed items block to Dashboard';",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/templates/main.mustache||blocks/recentlyaccesseditems/templates/main.mustache": [
          "File: blocks/recentlyaccesseditems/templates/main.mustache -> blocks/recentlyaccesseditems/templates/main.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template block_recentlyaccesseditems/main",
          "20:     This template renders the main content area for the Recently accessed itemes block.",
          "22:     Example context (json):",
          "23:     {}",
          "24: }}",
          "26: <div id=\"block-recentlyaccesseditems-{{uniqid}}\" class=\"block-  recentlyaccesseditems\" data-region=\"recentlyaccesseditems\">",
          "27:     <div class=\"container-fluid p-0\">",
          "28:         {{> block_recentlyaccesseditems/recentlyaccesseditems-view }}",
          "29:     </div>",
          "30: </div>",
          "31: {{#js}}",
          "32: require(",
          "33: [",
          "34:     'jquery',",
          "35:     'block_recentlyaccesseditems/main',",
          "36: ],",
          "37: function(",
          "38:     $,",
          "39:     Main",
          "40: ) {",
          "41:     var root = $('#block-recentlyaccesseditems-{{uniqid}}');",
          "43:     Main.init(root);",
          "44: });",
          "45: {{/js}}",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/templates/no-items.mustache||blocks/recentlyaccesseditems/templates/no-items.mustache": [
          "File: blocks/recentlyaccesseditems/templates/no-items.mustache -> blocks/recentlyaccesseditems/templates/no-items.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template block_recentlyaccesseditems/no-items",
          "20:     This template renders the no items message.",
          "22:     Example context (json):",
          "23:     {",
          "24:         \"noitemsimgurl\": \"https://moodlesite/theme/image.php/boost/block_recentlyaccesseditems/1535727318/items\"",
          "25:     }",
          "26: }}",
          "27: <div class=\"text-center mt-3\" data-region=\"empty-message\">",
          "28:     <img class=\"empty-placeholder-image-lg\"",
          "29:         src=\"{{noitemsimgurl}}\"",
          "30:         alt=\"{{#str}} noitems, block_recentlyaccesseditems {{/str}}\"",
          "31:         role=\"presentation\"",
          "32:     >",
          "33:     <p class=\"text-muted mt-3\">{{#str}} noitems, block_recentlyaccesseditems {{/str}}</p>",
          "34: </div>",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/templates/placeholder-item.mustache||blocks/recentlyaccesseditems/templates/placeholder-item.mustache": [
          "File: blocks/recentlyaccesseditems/templates/placeholder-item.mustache -> blocks/recentlyaccesseditems/templates/placeholder-item.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template block_recentlyaccesseditems/placeholder-item",
          "20:     This template renders a card item loading placeholder for the Recently accessed items block.",
          "22:     Example context (json):",
          "23:     {}",
          "24: }}",
          "25: <div class=\"card-body course-info-container\">",
          "26:     <div class=\"d-flex flex-row align-items-center\" style=\"height: 32px\">",
          "27:         <div class=\"bg-pulse-grey rounded-circle\" style=\"height: 32px; width: 32px;\"></div>",
          "28:         <div class=\"w-100 line-height-3 ml-1\">",
          "29:                 <div class=\"bg-pulse-grey w-100\" style=\"height: 15px;\"></div>",
          "30:                 <div class=\"bg-pulse-grey w-75 mt-1\" style=\"height: 10px;\"></div>",
          "31:         </div>",
          "32:     </div>",
          "33: </div>",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache||blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache": [
          "File: blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache -> blocks/recentlyaccesseditems/templates/recentlyaccesseditems-view.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template block_recentlyaccesseditems/recentlyaccesseditems-view",
          "20:     This template renders the items view for the Recently accessed items block.",
          "22:     Example context (json):",
          "23:     {",
          "24:         \"noitemsimgurl\": \"https://moodlesite/theme/image.php/boost/block_recentactivities/1535727318/items\"",
          "25:     }",
          "26: }}",
          "27: <div id=\"recentlyaccesseditems-view-{{uniqid}}\"",
          "28:      data-region=\"recentlyaccesseditems-view\"",
          "29:      data-noitemsimgurl=\"{{noitemsimgurl}}\">",
          "30:     <div data-region=\"recentlyaccesseditems-view-content\">",
          "31:         <div data-region=\"recentlyaccesseditems-loading-placeholder\">",
          "32:             <div class=\"card-deck dashboard-card-deck\">",
          "33:                 {{> block_recentlyaccesseditems/placeholder-item }}",
          "34:                 {{> block_recentlyaccesseditems/placeholder-item }}",
          "35:                 {{> block_recentlyaccesseditems/placeholder-item }}",
          "36:             </div>",
          "37:         </div>",
          "38:     </div>",
          "39: </div>",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/templates/view-cards.mustache||blocks/recentlyaccesseditems/templates/view-cards.mustache": [
          "File: blocks/recentlyaccesseditems/templates/view-cards.mustache -> blocks/recentlyaccesseditems/templates/view-cards.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public Licensebllsdsadfasfd",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template block_recentlyaccesseditems/view-cards",
          "20:     This template renders the items cards of the Recently accessed items block.",
          "22:     Example context (json):",
          "23:     {",
          "24:         \"items\": [",
          "25:             {",
          "26:                 \"cmid\": 64,",
          "27:                 \"courseid\": 2,",
          "28:                 \"coursename\": \"Course\",",
          "29:                 \"courseviewurl\": \"https://moodlesite/course/view.php?id=2\",",
          "30:                 \"icon\": \"<img class=\\\"icon\\\" alt=\\\"Forum\\\" title=\\\"Forum\\\" src=\\\"http://moodlesite/theme/image.php/boost/forum/1539858121/icon\\\" />\",",
          "31:                 \"name\": \"Assignment due 1\",",
          "32:                 \"id\": 17,",
          "33:                 \"modname\": \"Forum\",",
          "34:                 \"name\": \"Forum\",",
          "35:                 \"timeaccess\": 1539848498,",
          "36:                 \"userid\": 2,",
          "37:                 \"viewurl\": \"http://moodlesite/mod/forum?id=64\"",
          "38:             }",
          "39:         ]",
          "40:     }",
          "41: }}",
          "43: <div class=\"card-deck dashboard-card-deck\" role=\"list\">",
          "44:     {{#items}}",
          "45:         <a",
          "46:                 class=\"card dashboard-card py-2 pl-0 pr-0\"",
          "47:                 href=\"{{{viewurl}}}\"",
          "48:                 title=\"{{name}}\"",
          "49:         >",
          "50:             <div class=\"card-body course-info-container\">",
          "51:                 <div class=\"d-flex\">",
          "52:                     <div class=\"icon-size-4 d-flex align-self-center\">",
          "53:                         {{{icon}}}",
          "54:                     </div>",
          "55:                     <div class=\"w-100 line-height-3 text-truncate\">",
          "56:                         <h6 class=\"mb-0\">{{{name}}}</h6>",
          "57:                         <small class=\"text-muted m-b-0\">{{{coursename}}}</small>",
          "58:                     </div>",
          "59:                 </div>",
          "60:             </div>",
          "61:         </a>",
          "62:     {{/items}}",
          "63: </div>",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature||blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature": [
          "File: blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature -> blocks/recentlyaccesseditems/tests/behat/block_recentlyaccesseditems_dashboard.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @block @block_recentlyaccesseditems @javascript",
          "2: Feature: The recently accessed items block allows users to easily access their most recently visited items",
          "3:   In order to access the most recent items accessed",
          "4:   As a user",
          "5:   I can use the recently accessed items block in my dashboard",
          "7:   Background:",
          "8:     Given the following \"users\" exist:",
          "9:       | username | firstname | lastname | email                |",
          "10:       | student1 | Student   | 1        | student1@example.com |",
          "11:     And the following \"courses\" exist:",
          "12:       | fullname | shortname |",
          "13:       | Course 1 | C1        |",
          "14:       | Course 2 | C2        |",
          "15:     And the following \"course enrolments\" exist:",
          "16:       | user     | course | role    |",
          "17:       | student1 | C1     | student |",
          "18:       | student1 | C2     | student |",
          "19:     And I log in as \"admin\"",
          "20:     And I am on \"Course 1\" course homepage",
          "21:     And I turn editing mode on",
          "22:     And I add a \"Forum\" to section \"1\" and I fill the form with:",
          "23:       | Forum name | Test forum name |",
          "24:       | Forum type | Standard forum for general use |",
          "25:       | Description | Test forum description |",
          "26:     And I log out",
          "27:     And I log in as \"student1\"",
          "28:     When I press \"Customise this page\"",
          "29:     And I add the \"Recently accessed items\" block",
          "31:   Scenario: User has not accessed any item",
          "32:     Then I should see \"No recent items\" in the \"Recently accessed items\" \"block\"",
          "34:   Scenario: User has accessed some items",
          "35:     Given I am on \"Course 1\" course homepage",
          "36:     When  I follow \"Test forum name\"",
          "37:     And I follow \"Dashboard\" in the user menu",
          "38:     Then I should see \"Test forum name\" in the \"Recently accessed items\" \"block\"",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/tests/externallib_test.php||blocks/recentlyaccesseditems/tests/externallib_test.php": [
          "File: blocks/recentlyaccesseditems/tests/externallib_test.php -> blocks/recentlyaccesseditems/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: global $CFG;",
          "31: require_once($CFG->dirroot . '/webservice/tests/helpers.php');",
          "42: class block_recentlyaccesseditems_externallib_testcase extends externallib_advanced_testcase {",
          "47:     public function test_get_recent_items() {",
          "49:         $this->resetAfterTest();",
          "50:         $generator = $this->getDataGenerator();",
          "53:         $courses = array();",
          "54:         for ($i = 1; $i < 4; $i++) {",
          "55:             $courses[] = $generator->create_course();",
          "56:         };",
          "59:         $student = $generator->create_user();",
          "60:         $teacher = $generator->create_user();",
          "63:         foreach ($courses as $course) {",
          "64:             $generator->enrol_user($student->id, $course->id, 'student');",
          "65:             $forum[] = $this->getDataGenerator()->create_module('forum', array('course' => $course));",
          "66:             $glossary[] = $this->getDataGenerator()->create_module('glossary', array('course' => $course));",
          "67:             $chat[] = $this->getDataGenerator()->create_module('chat', array('course' => $course));",
          "68:         }",
          "69:         $generator->enrol_user($teacher->id, $courses[0]->id, 'teacher');",
          "71:         $this->setUser($student);",
          "74:         $result = \\block_recentlyaccesseditems\\external::get_recent_items();",
          "75:         $this->assertCount(0, $result);",
          "78:         foreach ($forum as $module) {",
          "79:             $event = \\mod_forum\\event\\course_module_viewed::create(array('context' => context_module::instance($module->cmid),",
          "80:                     'objectid' => $module->id));",
          "81:             $event->trigger();",
          "82:             $this->waitForSecond();",
          "83:         }",
          "86:         $result = \\block_recentlyaccesseditems\\external::get_recent_items();",
          "87:         $this->assertCount(count($forum), $result);",
          "90:         foreach ($chat as $module) {",
          "91:             $event = \\mod_chat\\event\\course_module_viewed::create(array('context' => context_module::instance($module->cmid),",
          "92:                     'objectid' => $module->id));",
          "93:             $event->trigger();",
          "94:             $this->waitForSecond();",
          "95:         }",
          "98:         $result = \\block_recentlyaccesseditems\\external::get_recent_items();",
          "99:         $this->assertCount((count($forum) + count($chat)), $result);",
          "100:         foreach ($result as $key => $record) {",
          "101:             if ($key == 0) {",
          "102:                 continue;",
          "103:             }",
          "104:             $this->assertTrue($record->timeaccess < $result[$key - 1]->timeaccess);",
          "105:         }",
          "106:     }",
          "107: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/tests/observer_test.php||blocks/recentlyaccesseditems/tests/observer_test.php": [
          "File: blocks/recentlyaccesseditems/tests/observer_test.php -> blocks/recentlyaccesseditems/tests/observer_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "26: defined('MOODLE_INTERNAL') || die();",
          "28: global $CFG;",
          "29: require_once($CFG->dirroot . '/mod/assign/tests/generator.php');",
          "39: class block_recentlyaccesseditems_observer_testcase extends advanced_testcase {",
          "40:     use mod_assign_test_generator;",
          "45:     public function setUp() {",
          "46:         global $DB;",
          "48:         $this->resetAfterTest();",
          "49:         $this->setAdminUser();",
          "52:         $this->table = \"block_recentlyaccesseditems\";",
          "55:         $this->course = $this->getDataGenerator()->create_course();",
          "58:         $this->student = self::getDataGenerator()->create_user();",
          "59:         $this->teacher = self::getDataGenerator()->create_user();",
          "62:         $this->studentrole = $DB->get_record('role', array('shortname' => 'student'));",
          "63:         $this->teacherrole = $DB->get_record('role', array('shortname' => 'editingteacher'));",
          "64:         $this->getDataGenerator()->enrol_user($this->student->id, $this->course->id, $this->studentrole->id, 'manual');",
          "65:         $this->getDataGenerator()->enrol_user($this->teacher->id, $this->course->id, $this->teacherrole->id, 'manual');",
          "68:         $this->forum = $this->getDataGenerator()->create_module('forum', array('course' => $this->course));",
          "69:         $this->glossary = $this->getDataGenerator()->create_module('glossary', array('course' => $this->course));",
          "70:         $this->chat = $this->getDataGenerator()->create_module('chat', array('course' => $this->course));",
          "71:     }",
          "78:     public function test_item_view_recorded_testcase() {",
          "79:         global $DB;",
          "82:         $records = $DB->count_records($this->table, array());",
          "83:         $this->assertEquals(0, $records);",
          "86:         $this->setUser($this->teacher);",
          "87:         $event = \\mod_forum\\event\\course_module_viewed::create(array('context' => context_module::instance($this->forum->cmid),",
          "88:                 'objectid' => $this->forum->id));",
          "89:         $event->trigger();",
          "92:         $this->setUser($this->student);",
          "93:         $event1 = \\mod_chat\\event\\course_module_viewed::create(array('context' => context_module::instance($this->chat->cmid),",
          "94:                 'objectid' => $this->chat->id));",
          "95:         $event1->trigger();",
          "97:         $records = $DB->count_records($this->table, array('userid' => $this->teacher->id, 'courseid' => $this->course->id,",
          "98:                 'cmid' => $this->forum->cmid));",
          "99:         $this->assertEquals(1, $records);",
          "101:         $records = $DB->count_records($this->table, array('userid' => $this->student->id, 'courseid' => $this->course->id, 'cmid' =>",
          "102:                 $this->chat->cmid));",
          "103:         $this->assertEquals(1, $records);",
          "105:         $this->waitForSecond();",
          "107:         $event2 = \\mod_chat\\event\\course_module_viewed::create(array('context' => context_module::instance($this->chat->cmid),",
          "108:                 'objectid' => $this->chat->id));",
          "109:         $event2->trigger();",
          "111:         $records = $DB->get_records($this->table, array('userid' => $this->student->id, 'courseid' => $this->course->id, 'cmid' =>",
          "112:                 $this->chat->cmid));",
          "113:         $this->assertCount(1, $records);",
          "114:         $this->assertEquals($event2->timecreated, array_shift($records)->timeaccess);",
          "116:     }",
          "123:     public function test_item_delete_record_testcase() {",
          "124:         global $DB;",
          "127:         $records = $DB->count_records($this->table, array());",
          "128:         $this->assertEquals(0, $records);",
          "131:         $this->setUser($this->teacher);",
          "132:         $event = \\mod_forum\\event\\course_module_viewed::create(array('context' => context_module::instance($this->forum->cmid),",
          "133:                 'objectid' => $this->forum->id));",
          "134:         $event->trigger();",
          "137:         $event = \\mod_chat\\event\\course_module_viewed::create(array('context' => context_module::instance($this->chat->cmid),",
          "138:                 'objectid' => $this->chat->id));",
          "139:         $event->trigger();",
          "142:         $this->setUser($this->student);",
          "143:         $event = \\mod_chat\\event\\course_module_viewed::create(array('context' => context_module::instance($this->chat->cmid),",
          "144:                 'objectid' => $this->chat->id));",
          "145:         $event->trigger();",
          "148:         $event = \\mod_forum\\event\\course_module_viewed::create(array('context' => context_module::instance($this->forum->cmid),",
          "149:                 'objectid' => $this->forum->id));",
          "150:         $event->trigger();",
          "152:         $records = $DB->count_records($this->table, array('cmid' => $this->forum->cmid));",
          "153:         $this->assertEquals(2, $records);",
          "154:         course_delete_module($this->forum->cmid);",
          "155:         $records = $DB->count_records($this->table, array('cmid' => $this->forum->cmid));",
          "156:         $this->assertEquals(0, $records);",
          "157:         $records = $DB->count_records($this->table, array('cmid' => $this->chat->cmid));",
          "158:         $this->assertEquals(2, $records);",
          "159:     }",
          "160: }",
          "",
          "---------------"
        ],
        "blocks/recentlyaccesseditems/version.php||blocks/recentlyaccesseditems/version.php": [
          "File: blocks/recentlyaccesseditems/version.php -> blocks/recentlyaccesseditems/version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "23: defined('MOODLE_INTERNAL') || die();",
          "25: $plugin->version   = 2018101705;            // The current plugin version (Date: YYYYMMDDXX).",
          "26: $plugin->requires  = 2018101900;            // Requires this Moodle version.",
          "27: $plugin->component = 'block_recentlyaccesseditems'; // Full name of the plugin (used for diagnostics).",
          "",
          "---------------"
        ],
        "lib/classes/plugin_manager.php||lib/classes/plugin_manager.php": [
          "File: lib/classes/plugin_manager.php -> lib/classes/plugin_manager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1718:                 'feedback', 'globalsearch', 'glossary_random', 'html',",
          "1719:                 'login', 'lp', 'mentees', 'mnet_hosts', 'myoverview', 'myprofile',",
          "1720:                 'navigation', 'news_items', 'online_users', 'participants',",
          "1722:                 'rss_client', 'search_forums', 'section_links',",
          "1723:                 'selfcompletion', 'settings', 'site_main_menu',",
          "1724:                 'social_activities', 'tag_flickr', 'tag_youtube', 'tags', 'timeline'",
          "",
          "[Removed Lines]",
          "1721:                 'private_files', 'quiz_results', 'recent_activity',",
          "",
          "[Added Lines]",
          "1721:                 'private_files', 'quiz_results', 'recent_activity', 'recentlyaccesseditems',",
          "",
          "---------------"
        ],
        "theme/boost/scss/moodle/blocks.scss||theme/boost/scss/moodle/blocks.scss": [
          "File: theme/boost/scss/moodle/blocks.scss -> theme/boost/scss/moodle/blocks.scss",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:     background-size: cover;",
          "117: }",
          "119: .dashboard-card-deck .dashboard-card {",
          "120:     margin-bottom: $card-gutter;",
          "121:     flex-basis: 100%;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119: [data-region=\"blocks-column\"] {",
          "120:     .block_recentlyaccesseditems {",
          "121:         .dashboard-card-deck {",
          "122:             height: unset;",
          "123:         }",
          "124:     }",
          "125: }",
          "127: .block_recentlyaccesseditems {",
          "128:     [data-region=\"recentlyaccesseditems-view-content\"] {",
          "129:         overflow-x: hidden;",
          "130:     }",
          "131:     .dashboard-card {",
          "132:         height: 75px;",
          "133:     }",
          "134:     .dashboard-card-deck {",
          "135:         @include media-breakpoint-up(sm) {",
          "136:             height: 75px;",
          "137:             overflow: hidden;",
          "138:         }",
          "139:     }",
          "140:     .course-info-container {",
          "141:         padding: 0.8rem;",
          "142:     }",
          "143:     .empty-placeholder-image-lg {",
          "144:         height: 125px;",
          "145:     }",
          "146:     a,",
          "147:     a:hover {",
          "148:         text-decoration: none;",
          "149:         color: unset;",
          "150:     }",
          "151:     .block-controls ~ .content {",
          "152:         margin-top: 2rem !important;",
          "153:     }",
          "154: }",
          "",
          "---------------"
        ],
        "theme/boost/style/moodle.css||theme/boost/style/moodle.css": [
          "File: theme/boost/style/moodle.css -> theme/boost/style/moodle.css",
          "--- Hunk 1 ---",
          "[Context before]",
          "11167:   background-position: center;",
          "11168:   background-size: cover; }",
          "11170: .dashboard-card-deck .dashboard-card {",
          "11171:   margin-bottom: 0.5rem;",
          "11172:   flex-basis: 100%;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11170: [data-region=\"blocks-column\"] .block_recentlyaccesseditems .dashboard-card-deck {",
          "11171:   height: unset; }",
          "11173: .block_recentlyaccesseditems [data-region=\"recentlyaccesseditems-view-content\"] {",
          "11174:   overflow-x: hidden; }",
          "11176: .block_recentlyaccesseditems .dashboard-card {",
          "11177:   height: 75px; }",
          "11179: @media (min-width: 576px) {",
          "11180:   .block_recentlyaccesseditems .dashboard-card-deck {",
          "11181:     height: 75px;",
          "11182:     overflow: hidden; } }",
          "11184: .block_recentlyaccesseditems .course-info-container {",
          "11185:   padding: 0.8rem; }",
          "11187: .block_recentlyaccesseditems .empty-placeholder-image-lg {",
          "11188:   height: 125px; }",
          "11190: .block_recentlyaccesseditems a,",
          "11191: .block_recentlyaccesseditems a:hover {",
          "11192:   text-decoration: none;",
          "11193:   color: unset; }",
          "11195: .block_recentlyaccesseditems .block-controls ~ .content {",
          "11196:   margin-top: 2rem !important; }",
          "",
          "---------------"
        ],
        "theme/bootstrapbase/less/moodle/blocks.less||theme/bootstrapbase/less/moodle/blocks.less": [
          "File: theme/bootstrapbase/less/moodle/blocks.less -> theme/bootstrapbase/less/moodle/blocks.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "387:     }",
          "388: }",
          "390: .dashboard-card-deck {",
          "391:     box-sizing: border-box;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "390: .block_recentlyaccesseditems {",
          "391:     [data-region=\"recentlyaccesseditems-view-content\"] {",
          "392:         overflow-x: hidden;",
          "393:     }",
          "394:     .dashboard-card {",
          "395:         height: 75px;",
          "396:     }",
          "397:     .dashboard-card-deck {",
          "398:         @media (min-width: 576px) {",
          "399:             height: 75px;",
          "400:             overflow: hidden;",
          "401:         }",
          "402:     }",
          "403:     .empty-placeholder-image-lg {",
          "404:         height: 125px;",
          "405:     }",
          "406:     .course-info-container {",
          "407:         flex: 1 1 auto;",
          "408:         padding: 0.8rem;",
          "409:     }",
          "410:     .icon-size-4 .icon {",
          "411:         height: auto;",
          "412:         width: auto;",
          "413:         background-image: unset;",
          "414:         box-sizing: unset;",
          "415:     }",
          "416:     .icon-size-4 {",
          "417:         background-image: unset;",
          "418:         height: unset;",
          "419:         width: unset;",
          "420:     }",
          "421:     .ml-1 {",
          "422:         margin-left: 10px;",
          "423:     }",
          "424:     h6 {",
          "425:         font-size: .9375rem;",
          "426:         margin-bottom: 0;",
          "427:     }",
          "428:     a,",
          "429:     a:hover {",
          "430:         text-decoration: none;",
          "431:         color: unset;",
          "432:     }",
          "433: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "425: }",
          "427: @media (min-width: 768px) {",
          "429:         margin: 0;",
          "430:         .dashboard-card {",
          "431:             flex-basis: 100%;",
          "432:             margin-left: 0;",
          "",
          "[Removed Lines]",
          "428:     #block-region-side-post .dashboard-card-deck {",
          "",
          "[Added Lines]",
          "473:     #block-region-side-post .dashboard-card-deck,",
          "474:     #block-region-side-pre .dashboard-card-deck {",
          "476:         height: unset;",
          "",
          "---------------"
        ],
        "theme/bootstrapbase/style/moodle.css||theme/bootstrapbase/style/moodle.css": [
          "File: theme/bootstrapbase/style/moodle.css -> theme/bootstrapbase/style/moodle.css",
          "--- Hunk 1 ---",
          "[Context before]",
          "16597:     max-height: 7rem;",
          "16598:   }",
          "16599: }",
          "16600: .dashboard-card-deck {",
          "16601:   box-sizing: border-box;",
          "16602:   display: flex;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "16600: .block_recentlyaccesseditems [data-region=\"recentlyaccesseditems-view-content\"] {",
          "16601:   overflow-x: hidden;",
          "16602: }",
          "16603: .block_recentlyaccesseditems .dashboard-card {",
          "16604:   height: 75px;",
          "16605: }",
          "16606: @media (min-width: 576px) {",
          "16607:   .block_recentlyaccesseditems .dashboard-card-deck {",
          "16608:     height: 75px;",
          "16609:     overflow: hidden;",
          "16610:   }",
          "16611: }",
          "16612: .block_recentlyaccesseditems .empty-placeholder-image-lg {",
          "16613:   height: 125px;",
          "16614: }",
          "16615: .block_recentlyaccesseditems .course-info-container {",
          "16616:   flex: 1 1 auto;",
          "16617:   padding: 0.8rem;",
          "16618: }",
          "16619: .block_recentlyaccesseditems .icon-size-4 .icon {",
          "16620:   height: auto;",
          "16621:   width: auto;",
          "16622:   background-image: unset;",
          "16623:   box-sizing: unset;",
          "16624: }",
          "16625: .block_recentlyaccesseditems .icon-size-4 {",
          "16626:   background-image: unset;",
          "16627:   height: unset;",
          "16628:   width: unset;",
          "16629: }",
          "16630: .block_recentlyaccesseditems .ml-1 {",
          "16631:   margin-left: 10px;",
          "16632: }",
          "16633: .block_recentlyaccesseditems h6 {",
          "16634:   font-size: .9375rem;",
          "16635:   margin-bottom: 0;",
          "16636: }",
          "16637: .block_recentlyaccesseditems a,",
          "16638: .block_recentlyaccesseditems a:hover {",
          "16639:   text-decoration: none;",
          "16640:   color: unset;",
          "16641: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "16634:   }",
          "16635: }",
          "16636: @media (min-width: 768px) {",
          "16638:     margin: 0;",
          "16639:   }",
          "16641:     flex-basis: 100%;",
          "16642:     margin-left: 0;",
          "16643:     margin-right: 0;",
          "",
          "[Removed Lines]",
          "16637:   #block-region-side-post .dashboard-card-deck {",
          "16640:   #block-region-side-post .dashboard-card-deck .dashboard-card {",
          "",
          "[Added Lines]",
          "16679:   #block-region-side-post .dashboard-card-deck,",
          "16680:   #block-region-side-pre .dashboard-card-deck {",
          "16682:     height: unset;",
          "16684:   #block-region-side-post .dashboard-card-deck .dashboard-card,",
          "16685:   #block-region-side-pre .dashboard-card-deck .dashboard-card {",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018103000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181027)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018103100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181031)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}