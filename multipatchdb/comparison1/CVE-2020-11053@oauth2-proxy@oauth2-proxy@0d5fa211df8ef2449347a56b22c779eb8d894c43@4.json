{
  "cve_id": "CVE-2020-11053",
  "cve_desc": "In OAuth2 Proxy before 5.1.1, there is an open redirect vulnerability. Users can provide a redirect address for the proxy to send the authenticated user to at the end of the authentication flow. This is expected to be the original URL that the user was trying to access. This redirect URL is checked within the proxy and validated before redirecting the user to prevent malicious actors providing redirects to potentially harmful sites. However, by crafting a redirect URL with HTML encoded whitespace characters the validation could be bypassed and allow a redirect to any URL provided. This has been patched in 5.1.1.",
  "repo": "oauth2-proxy/oauth2-proxy",
  "patch_hash": "0d5fa211df8ef2449347a56b22c779eb8d894c43",
  "patch_info": {
    "commit_hash": "0d5fa211df8ef2449347a56b22c779eb8d894c43",
    "repo": "oauth2-proxy/oauth2-proxy",
    "commit_url": "https://github.com/oauth2-proxy/oauth2-proxy/commit/0d5fa211df8ef2449347a56b22c779eb8d894c43",
    "files": [
      "oauthproxy.go",
      "oauthproxy_test.go"
    ],
    "message": "Merge pull request from GHSA-j7px-6hwj-hpjg",
    "before_after_code_files": [
      "oauthproxy.go||oauthproxy.go",
      "oauthproxy_test.go||oauthproxy_test.go"
    ]
  },
  "patch_diff": {
    "oauthproxy.go||oauthproxy.go": [
      "File: oauthproxy.go -> oauthproxy.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "57: var (",
      "59:  ErrNeedsLogin = errors.New(\"redirect to login page\")",
      "60: )",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "63:  invalidRedirectRegex = regexp.MustCompile(`^/(\\s|\\v)?(/|\\\\)`)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "579: func (p *OAuthProxy) IsValidRedirect(redirect string) bool {",
      "580:  switch {",
      "582:   return true",
      "583:  case strings.HasPrefix(redirect, \"http://\") || strings.HasPrefix(redirect, \"https://\"):",
      "584:   redirectURL, err := url.Parse(redirect)",
      "",
      "[Removed Lines]",
      "581:  case strings.HasPrefix(redirect, \"/\") && !strings.HasPrefix(redirect, \"//\") && !strings.HasPrefix(redirect, \"/\\\\\"):",
      "",
      "[Added Lines]",
      "585:  case strings.HasPrefix(redirect, \"/\") && !strings.HasPrefix(redirect, \"//\") && !invalidRedirectRegex.MatchString(redirect):",
      "",
      "---------------"
    ],
    "oauthproxy_test.go||oauthproxy_test.go": [
      "File: oauthproxy_test.go -> oauthproxy_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "322:    Redirect:       \"http://a.sub.anyport.bar:8081/redirect\",",
      "323:    ExpectedResult: true,",
      "324:   },",
      "325:  }",
      "327:  for _, tc := range testCases {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "325:   {",
      "326:    Desc:           \"openRedirect1\",",
      "327:    Redirect:       \"/\\\\evil.com\",",
      "328:    ExpectedResult: false,",
      "329:   },",
      "330:   {",
      "331:    Desc:           \"openRedirectSpace1\",",
      "332:    Redirect:       \"/ /evil.com\",",
      "333:    ExpectedResult: false,",
      "334:   },",
      "335:   {",
      "336:    Desc:           \"openRedirectSpace2\",",
      "337:    Redirect:       \"/ \\\\evil.com\",",
      "338:    ExpectedResult: false,",
      "339:   },",
      "340:   {",
      "341:    Desc:           \"openRedirectTab1\",",
      "342:    Redirect:       \"/\\t/evil.com\",",
      "343:    ExpectedResult: false,",
      "344:   },",
      "345:   {",
      "346:    Desc:           \"openRedirectTab2\",",
      "347:    Redirect:       \"/\\t\\\\evil.com\",",
      "348:    ExpectedResult: false,",
      "349:   },",
      "350:   {",
      "351:    Desc:           \"openRedirectVerticalTab1\",",
      "352:    Redirect:       \"/\\v/evil.com\",",
      "353:    ExpectedResult: false,",
      "354:   },",
      "355:   {",
      "356:    Desc:           \"openRedirectVerticalTab2\",",
      "357:    Redirect:       \"/\\v\\\\evil.com\",",
      "358:    ExpectedResult: false,",
      "359:   },",
      "360:   {",
      "361:    Desc:           \"openRedirectNewLine1\",",
      "362:    Redirect:       \"/\\n/evil.com\",",
      "363:    ExpectedResult: false,",
      "364:   },",
      "365:   {",
      "366:    Desc:           \"openRedirectNewLine2\",",
      "367:    Redirect:       \"/\\n\\\\evil.com\",",
      "368:    ExpectedResult: false,",
      "369:   },",
      "370:   {",
      "371:    Desc:           \"openRedirectCarriageReturn1\",",
      "372:    Redirect:       \"/\\r/evil.com\",",
      "373:    ExpectedResult: false,",
      "374:   },",
      "375:   {",
      "376:    Desc:           \"openRedirectCarriageReturn2\",",
      "377:    Redirect:       \"/\\r\\\\evil.com\",",
      "378:    ExpectedResult: false,",
      "379:   },",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f5f13481761accdeaacc789fc5ba2be7df1b07ed",
      "candidate_info": {
        "commit_hash": "f5f13481761accdeaacc789fc5ba2be7df1b07ed",
        "repo": "oauth2-proxy/oauth2-proxy",
        "commit_url": "https://github.com/oauth2-proxy/oauth2-proxy/commit/f5f13481761accdeaacc789fc5ba2be7df1b07ed",
        "files": [
          "oauthproxy.go",
          "oauthproxy_test.go"
        ],
        "message": "Merge pull request from GHSA-j7px-6hwj-hpjg",
        "before_after_code_files": [
          "oauthproxy.go||oauthproxy.go",
          "oauthproxy_test.go||oauthproxy_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "oauthproxy.go||oauthproxy.go",
            "oauthproxy_test.go||oauthproxy_test.go"
          ],
          "candidate": [
            "oauthproxy.go||oauthproxy.go",
            "oauthproxy_test.go||oauthproxy_test.go"
          ]
        }
      },
      "candidate_diff": {
        "oauthproxy.go||oauthproxy.go": [
          "File: oauthproxy.go -> oauthproxy.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "57: var (",
          "59:  ErrNeedsLogin = errors.New(\"redirect to login page\")",
          "60: )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "63:  invalidRedirectRegex = regexp.MustCompile(`^/(\\s|\\v)?(/|\\\\)`)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "572: func (p *OAuthProxy) IsValidRedirect(redirect string) bool {",
          "573:  switch {",
          "575:   return true",
          "576:  case strings.HasPrefix(redirect, \"http://\") || strings.HasPrefix(redirect, \"https://\"):",
          "577:   redirectURL, err := url.Parse(redirect)",
          "",
          "[Removed Lines]",
          "574:  case strings.HasPrefix(redirect, \"/\") && !strings.HasPrefix(redirect, \"//\") && !strings.HasPrefix(redirect, \"/\\\\\"):",
          "",
          "[Added Lines]",
          "578:  case strings.HasPrefix(redirect, \"/\") && !strings.HasPrefix(redirect, \"//\") && !invalidRedirectRegex.MatchString(redirect):",
          "",
          "---------------"
        ],
        "oauthproxy_test.go||oauthproxy_test.go": [
          "File: oauthproxy_test.go -> oauthproxy_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "323:    Redirect:       \"http://a.sub.anyport.bar:8081/redirect\",",
          "324:    ExpectedResult: true,",
          "325:   },",
          "326:  }",
          "328:  for _, tc := range testCases {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "326:   {",
          "327:    Desc:           \"openRedirect1\",",
          "328:    Redirect:       \"/\\\\evil.com\",",
          "329:    ExpectedResult: false,",
          "330:   },",
          "331:   {",
          "332:    Desc:           \"openRedirectSpace1\",",
          "333:    Redirect:       \"/ /evil.com\",",
          "334:    ExpectedResult: false,",
          "335:   },",
          "336:   {",
          "337:    Desc:           \"openRedirectSpace2\",",
          "338:    Redirect:       \"/ \\\\evil.com\",",
          "339:    ExpectedResult: false,",
          "340:   },",
          "341:   {",
          "342:    Desc:           \"openRedirectTab1\",",
          "343:    Redirect:       \"/\\t/evil.com\",",
          "344:    ExpectedResult: false,",
          "345:   },",
          "346:   {",
          "347:    Desc:           \"openRedirectTab2\",",
          "348:    Redirect:       \"/\\t\\\\evil.com\",",
          "349:    ExpectedResult: false,",
          "350:   },",
          "351:   {",
          "352:    Desc:           \"openRedirectVerticalTab1\",",
          "353:    Redirect:       \"/\\v/evil.com\",",
          "354:    ExpectedResult: false,",
          "355:   },",
          "356:   {",
          "357:    Desc:           \"openRedirectVerticalTab2\",",
          "358:    Redirect:       \"/\\v\\\\evil.com\",",
          "359:    ExpectedResult: false,",
          "360:   },",
          "361:   {",
          "362:    Desc:           \"openRedirectNewLine1\",",
          "363:    Redirect:       \"/\\n/evil.com\",",
          "364:    ExpectedResult: false,",
          "365:   },",
          "366:   {",
          "367:    Desc:           \"openRedirectNewLine2\",",
          "368:    Redirect:       \"/\\n\\\\evil.com\",",
          "369:    ExpectedResult: false,",
          "370:   },",
          "371:   {",
          "372:    Desc:           \"openRedirectCarriageReturn1\",",
          "373:    Redirect:       \"/\\r/evil.com\",",
          "374:    ExpectedResult: false,",
          "375:   },",
          "376:   {",
          "377:    Desc:           \"openRedirectCarriageReturn2\",",
          "378:    Redirect:       \"/\\r\\\\evil.com\",",
          "379:    ExpectedResult: false,",
          "380:   },",
          "",
          "---------------"
        ]
      }
    }
  ]
}