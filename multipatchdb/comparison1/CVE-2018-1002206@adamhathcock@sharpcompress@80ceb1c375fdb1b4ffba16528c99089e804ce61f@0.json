{
  "cve_id": "CVE-2018-1002206",
  "cve_desc": "SharpCompress before 0.21.0 is vulnerable to directory traversal, allowing attackers to write to arbitrary files via a ../ (dot dot slash) in a Zip archive entry that is mishandled during extraction. This vulnerability is also known as 'Zip-Slip'.",
  "repo": "adamhathcock/sharpcompress",
  "patch_hash": "80ceb1c375fdb1b4ffba16528c99089e804ce61f",
  "patch_info": {
    "commit_hash": "80ceb1c375fdb1b4ffba16528c99089e804ce61f",
    "repo": "adamhathcock/sharpcompress",
    "commit_url": "https://github.com/adamhathcock/sharpcompress/commit/80ceb1c375fdb1b4ffba16528c99089e804ce61f",
    "files": [
      "src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
      "tests/SharpCompress.Test/Zip/ZipArchiveTests.cs",
      "tests/TestArchives/Archives/Zip.Evil.zip"
    ],
    "message": "fix: prevent extracting archived files outside of target path\n\nThis PR is meant to fix an arbitrary file write vulnerability, that can be\nachieved using a specially crafted zip archive, that holds path traversal\nfilenames. When the filename gets concatenated to the target extraction\ndirectory, the final path ends up outside of the target folder.\n\nA sample malicious zip file named Zip.Evil.zip was used,\nand when running the code below, resulted in the creation of C:/Temp/evil.txt\noutside of the intended target directory.\n\nThere are various possible ways to avoid this issue, some include checking\nfor .. (dot dot) characters in the filename, but the best solution in our\nopinion is to check if the final target filename, starts with the target\nfolder (after both are resolved to their absolute path).\n\nStay secure,\nSnyk Team",
    "before_after_code_files": [
      "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
      "tests/SharpCompress.Test/Zip/ZipArchiveTests.cs||tests/SharpCompress.Test/Zip/ZipArchiveTests.cs"
    ]
  },
  "patch_diff": {
    "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs": [
      "File: src/SharpCompress/Archives/IArchiveEntryExtensions.cs -> src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
      "--- Hunk 1 ---",
      "[Context before]",
      "48:         {",
      "49:             string destinationFileName;",
      "50:             string file = Path.GetFileName(entry.Key);",
      "52:             options = options ?? new ExtractionOptions()",
      "53:                                  {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "51:             string fullDestinationDirectoryPath = Path.GetFullPath(destinationDirectory);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "58:             if (options.ExtractFullPath)",
      "59:             {",
      "60:                 string folder = Path.GetDirectoryName(entry.Key);",
      "62:                 if (!Directory.Exists(destdir))",
      "63:                 {",
      "64:                     Directory.CreateDirectory(destdir);",
      "65:                 }",
      "66:                 destinationFileName = Path.Combine(destdir, file);",
      "67:             }",
      "68:             else",
      "69:             {",
      "71:             }",
      "72:             if (!entry.IsDirectory)",
      "73:             {",
      "74:                 entry.WriteToFile(destinationFileName, options);",
      "75:             }",
      "76:         }",
      "",
      "[Removed Lines]",
      "61:                 string destdir = Path.Combine(destinationDirectory, folder);",
      "70:                 destinationFileName = Path.Combine(destinationDirectory, file);",
      "",
      "[Added Lines]",
      "62:                 string destdir = Path.GetFullPath(",
      "63:                                     Path.Combine(fullDestinationDirectoryPath, folder)",
      "64:                                  );",
      "68:                     if (!destdir.StartsWith(fullDestinationDirectoryPath))",
      "69:                     {",
      "70:                         throw new ExtractionException(\"Entry is trying to create a directory outside of the destination directory.\");",
      "71:                     }",
      "79:                 destinationFileName = Path.Combine(fullDestinationDirectoryPath, file);",
      "84:                 destinationFileName = Path.GetFullPath(destinationFileName);",
      "86:                 if (!destinationFileName.StartsWith(fullDestinationDirectoryPath))",
      "87:                 {",
      "88:                     throw new ExtractionException(\"Entry is trying to write a file outside of the destination directory.\");",
      "89:                 }",
      "",
      "---------------"
    ],
    "tests/SharpCompress.Test/Zip/ZipArchiveTests.cs||tests/SharpCompress.Test/Zip/ZipArchiveTests.cs": [
      "File: tests/SharpCompress.Test/Zip/ZipArchiveTests.cs -> tests/SharpCompress.Test/Zip/ZipArchiveTests.cs",
      "--- Hunk 1 ---",
      "[Context before]",
      "433:                     }",
      "434:                 }",
      "435:             }",
      "437:         }",
      "439:         class NonSeekableMemoryStream : MemoryStream",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "436:         }",
      "438:         [Fact]",
      "439:         public void Zip_Evil_Throws_Exception()",
      "440:         {",
      "441:             Exception expectedExcetpion = null;",
      "442:             string zipFile = Path.Combine(TEST_ARCHIVES_PATH, \"Zip.Evil.zip\");",
      "444:             try",
      "445:             {",
      "446:                 using (var archive = ZipArchive.Open(zipFile))",
      "447:                 {",
      "448:                     foreach (var entry in archive.Entries.Where(entry => !entry.IsDirectory))",
      "449:                     {",
      "450:                         entry.WriteToDirectory(SCRATCH_FILES_PATH, new ExtractionOptions()",
      "451:                         {",
      "452:                             ExtractFullPath = true,",
      "453:                             Overwrite = true",
      "454:                         });",
      "455:                     }",
      "456:                 }",
      "457:             }",
      "458:             catch (Exception ex)",
      "459:             {",
      "460:                 expectedExcetpion = ex;",
      "461:             }",
      "463:             Assert.NotEqual(expectedExcetpion, null);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e37e8bdadc534190068048ff6cecea6f0744cab7",
      "candidate_info": {
        "commit_hash": "e37e8bdadc534190068048ff6cecea6f0744cab7",
        "repo": "adamhathcock/sharpcompress",
        "commit_url": "https://github.com/adamhathcock/sharpcompress/commit/e37e8bdadc534190068048ff6cecea6f0744cab7",
        "files": [
          "src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
          "src/SharpCompress/Archives/IArchiveExtensions.cs",
          "src/SharpCompress/Common/ExtractionMethods.cs",
          "src/SharpCompress/Common/ExtractionOptions.cs",
          "src/SharpCompress/Readers/IReaderExtensions.cs"
        ],
        "message": "Move path handling for extraction to be common\n\nReader and Archive now share more extraction logic",
        "before_after_code_files": [
          "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
          "src/SharpCompress/Archives/IArchiveExtensions.cs||src/SharpCompress/Archives/IArchiveExtensions.cs",
          "src/SharpCompress/Common/ExtractionMethods.cs||src/SharpCompress/Common/ExtractionMethods.cs",
          "src/SharpCompress/Readers/ExtractionOptions.cs||src/SharpCompress/Common/ExtractionOptions.cs",
          "src/SharpCompress/Readers/IReaderExtensions.cs||src/SharpCompress/Readers/IReaderExtensions.cs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs"
          ],
          "candidate": [
            "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs"
          ]
        }
      },
      "candidate_diff": {
        "src/SharpCompress/Archives/IArchiveEntryExtensions.cs||src/SharpCompress/Archives/IArchiveEntryExtensions.cs": [
          "File: src/SharpCompress/Archives/IArchiveEntryExtensions.cs -> src/SharpCompress/Archives/IArchiveEntryExtensions.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: \ufeffusing System.IO;",
          "2: using SharpCompress.Common;",
          "3: using SharpCompress.IO;",
          "6: namespace SharpCompress.Archives",
          "7: {",
          "",
          "[Removed Lines]",
          "4: using SharpCompress.Readers;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "46:         public static void WriteToDirectory(this IArchiveEntry entry, string destinationDirectory,",
          "47:                                             ExtractionOptions options = null)",
          "48:         {",
          "93:         }",
          "",
          "[Removed Lines]",
          "49:             string destinationFileName;",
          "50:             string file = Path.GetFileName(entry.Key);",
          "51:             string fullDestinationDirectoryPath = Path.GetFullPath(destinationDirectory);",
          "53:             options = options ?? new ExtractionOptions()",
          "54:                                  {",
          "55:                                      Overwrite = true",
          "56:                                  };",
          "59:             if (options.ExtractFullPath)",
          "60:             {",
          "61:                 string folder = Path.GetDirectoryName(entry.Key);",
          "62:                 string destdir = Path.GetFullPath(",
          "63:                                     Path.Combine(fullDestinationDirectoryPath, folder)",
          "64:                                  );",
          "66:                 if (!Directory.Exists(destdir))",
          "67:                 {",
          "68:                     if (!destdir.StartsWith(fullDestinationDirectoryPath))",
          "69:                     {",
          "70:                         throw new ExtractionException(\"Entry is trying to create a directory outside of the destination directory.\");",
          "71:                     }",
          "73:                     Directory.CreateDirectory(destdir);",
          "74:                 }",
          "75:                 destinationFileName = Path.Combine(destdir, file);",
          "76:             }",
          "77:             else",
          "78:             {",
          "79:                 destinationFileName = Path.Combine(fullDestinationDirectoryPath, file);",
          "80:             }",
          "82:             if (!entry.IsDirectory)",
          "83:             {",
          "84:                 destinationFileName = Path.GetFullPath(destinationFileName);",
          "86:                 if (!destinationFileName.StartsWith(fullDestinationDirectoryPath))",
          "87:                 {",
          "88:                     throw new ExtractionException(\"Entry is trying to write a file outside of the destination directory.\");",
          "89:                 }",
          "91:                 entry.WriteToFile(destinationFileName, options);",
          "92:             }",
          "",
          "[Added Lines]",
          "48:             ExtractionMethods.WriteEntryToDirectory(entry, destinationDirectory, options,",
          "49:                                               entry.WriteToFile);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "98:         public static void WriteToFile(this IArchiveEntry entry, string destinationFileName,",
          "99:                                        ExtractionOptions options = null)",
          "100:         {",
          "118:         }",
          "119: #endif",
          "120:     }",
          "",
          "[Removed Lines]",
          "101:             FileMode fm = FileMode.Create;",
          "102:             options = options ?? new ExtractionOptions()",
          "103:             {",
          "104:                 Overwrite = true",
          "105:             };",
          "108:             if (!options.Overwrite)",
          "109:             {",
          "110:                 fm = FileMode.CreateNew;",
          "111:             }",
          "112:             using (FileStream fs = File.Open(destinationFileName, fm))",
          "113:             {",
          "114:                 entry.WriteTo(fs);",
          "115:             }",
          "117:             entry.PreserveExtractionOptions(destinationFileName, options);",
          "",
          "[Added Lines]",
          "59:             ExtractionMethods.WriteEntryToFile(entry, destinationFileName, options,",
          "60:                                                (x, fm) =>",
          "61:                                                {",
          "62:                                                    using (FileStream fs = File.Open(destinationFileName, fm))",
          "63:                                                    {",
          "64:                                                        entry.WriteTo(fs);",
          "65:                                                    }",
          "66:                                                });",
          "",
          "---------------"
        ],
        "src/SharpCompress/Archives/IArchiveExtensions.cs||src/SharpCompress/Archives/IArchiveExtensions.cs": [
          "File: src/SharpCompress/Archives/IArchiveExtensions.cs -> src/SharpCompress/Archives/IArchiveExtensions.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: \ufeff#if !NO_FILE",
          "2: using System.Linq;",
          "5: #endif",
          "",
          "[Removed Lines]",
          "3: using SharpCompress.Readers;",
          "",
          "[Added Lines]",
          "3: using SharpCompress.Common;",
          "",
          "---------------"
        ],
        "src/SharpCompress/Common/ExtractionMethods.cs||src/SharpCompress/Common/ExtractionMethods.cs": [
          "File: src/SharpCompress/Common/ExtractionMethods.cs -> src/SharpCompress/Common/ExtractionMethods.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: \ufeff#if !NO_FILE",
          "2: using System;",
          "3: using System.IO;",
          "4: #endif",
          "6: namespace SharpCompress.Common",
          "7: {",
          "8:     internal static class ExtractionMethods",
          "9:     {",
          "11: #if !NO_FILE",
          "15:         public static void WriteEntryToDirectory(IEntry entry, string destinationDirectory,",
          "16:                                                  ExtractionOptions options, Action<string, ExtractionOptions> write)",
          "17:         {",
          "18:             string destinationFileName;",
          "19:             string file = Path.GetFileName(entry.Key);",
          "20:             string fullDestinationDirectoryPath = Path.GetFullPath(destinationDirectory);",
          "22:             options = options ?? new ExtractionOptions()",
          "23:                                  {",
          "24:                                      Overwrite = true",
          "25:                                  };",
          "27:             if (options.ExtractFullPath)",
          "28:             {",
          "29:                 string folder = Path.GetDirectoryName(entry.Key);",
          "30:                 string destdir = Path.GetFullPath(",
          "31:                                                   Path.Combine(fullDestinationDirectoryPath, folder)",
          "32:                                                  );",
          "34:                 if (!Directory.Exists(destdir))",
          "35:                 {",
          "36:                     if (!destdir.StartsWith(fullDestinationDirectoryPath))",
          "37:                     {",
          "38:                         throw new ExtractionException(\"Entry is trying to create a directory outside of the destination directory.\");",
          "39:                     }",
          "41:                     Directory.CreateDirectory(destdir);",
          "42:                 }",
          "43:                 destinationFileName = Path.Combine(destdir, file);",
          "44:             }",
          "45:             else",
          "46:             {",
          "47:                 destinationFileName = Path.Combine(fullDestinationDirectoryPath, file);",
          "49:             }",
          "51:             if (!entry.IsDirectory)",
          "52:             {",
          "53:                 destinationFileName = Path.GetFullPath(destinationFileName);",
          "55:                 if (!destinationFileName.StartsWith(fullDestinationDirectoryPath))",
          "56:                 {",
          "57:                     throw new ExtractionException(\"Entry is trying to write a file outside of the destination directory.\");",
          "58:                 }",
          "59:                 write(destinationFileName, options);",
          "60:             }",
          "61:             else if (options.ExtractFullPath && !Directory.Exists(destinationFileName))",
          "62:             {",
          "63:                 Directory.CreateDirectory(destinationFileName);",
          "64:             }",
          "65:         }",
          "67:         public static void WriteEntryToFile(IEntry entry, string destinationFileName,",
          "68:                                             ExtractionOptions options,",
          "69:                                             Action<string, FileMode> openAndWrite)",
          "70:         {",
          "71:             FileMode fm = FileMode.Create;",
          "72:             options = options ?? new ExtractionOptions()",
          "73:                                  {",
          "74:                                      Overwrite = true",
          "75:                                  };",
          "77:             if (!options.Overwrite)",
          "78:             {",
          "79:                 fm = FileMode.CreateNew;",
          "80:             }",
          "82:             openAndWrite(destinationFileName, fm);",
          "83:             entry.PreserveExtractionOptions(destinationFileName, options);",
          "84:         }",
          "85: #endif",
          "86:     }",
          "87: }",
          "",
          "---------------"
        ],
        "src/SharpCompress/Readers/ExtractionOptions.cs||src/SharpCompress/Common/ExtractionOptions.cs": [
          "File: src/SharpCompress/Readers/ExtractionOptions.cs -> src/SharpCompress/Common/ExtractionOptions.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: {",
          "3:     public class ExtractionOptions",
          "4:     {",
          "",
          "[Removed Lines]",
          "1: \ufeffnamespace SharpCompress.Readers",
          "",
          "[Added Lines]",
          "1: \ufeffnamespace SharpCompress.Common",
          "",
          "---------------"
        ],
        "src/SharpCompress/Readers/IReaderExtensions.cs||src/SharpCompress/Readers/IReaderExtensions.cs": [
          "File: src/SharpCompress/Readers/IReaderExtensions.cs -> src/SharpCompress/Readers/IReaderExtensions.cs",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:         public static void WriteEntryToDirectory(this IReader reader, string destinationDirectory,",
          "43:                                                  ExtractionOptions options = null)",
          "44:         {",
          "75:         }",
          "",
          "[Removed Lines]",
          "45:             string destinationFileName = string.Empty;",
          "46:             string file = Path.GetFileName(reader.Entry.Key);",
          "47:             options = options ?? new ExtractionOptions()",
          "48:                       {",
          "49:                           Overwrite = true",
          "50:                       };",
          "52:             if (options.ExtractFullPath)",
          "53:             {",
          "54:                 string folder = Path.GetDirectoryName(reader.Entry.Key);",
          "55:                 string destdir = Path.Combine(destinationDirectory, folder);",
          "56:                 if (!Directory.Exists(destdir))",
          "57:                 {",
          "58:                     Directory.CreateDirectory(destdir);",
          "59:                 }",
          "60:                 destinationFileName = Path.Combine(destdir, file);",
          "61:             }",
          "62:             else",
          "63:             {",
          "64:                 destinationFileName = Path.Combine(destinationDirectory, file);",
          "65:             }",
          "67:             if (!reader.Entry.IsDirectory)",
          "68:             {",
          "69:                 reader.WriteEntryToFile(destinationFileName, options);",
          "70:             }",
          "71:             else if (options.ExtractFullPath && !Directory.Exists(destinationFileName))",
          "72:             {",
          "73:                 Directory.CreateDirectory(destinationFileName);",
          "74:             }",
          "",
          "[Added Lines]",
          "45:             ExtractionMethods.WriteEntryToDirectory(reader.Entry, destinationDirectory, options,",
          "46:                                               reader.WriteEntryToFile);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:         public static void WriteEntryToFile(this IReader reader, string destinationFileName,",
          "81:                                             ExtractionOptions options = null)",
          "82:         {",
          "98:         }",
          "99: #endif",
          "100:     }",
          "",
          "[Removed Lines]",
          "83:             FileMode fm = FileMode.Create;",
          "84:             options = options ?? new ExtractionOptions()",
          "85:             {",
          "86:                 Overwrite = true",
          "87:             };",
          "89:             if (!options.Overwrite)",
          "90:             {",
          "91:                 fm = FileMode.CreateNew;",
          "92:             }",
          "93:             using (FileStream fs = File.Open(destinationFileName, fm))",
          "94:             {",
          "95:                 reader.WriteEntryTo(fs);",
          "96:             }",
          "97:             reader.Entry.PreserveExtractionOptions(destinationFileName, options);",
          "",
          "[Added Lines]",
          "55:             ExtractionMethods.WriteEntryToFile(reader.Entry, destinationFileName, options,",
          "56:                                                (x, fm) =>",
          "57:                                                {",
          "58:                                                    using (FileStream fs = File.Open(destinationFileName, fm))",
          "59:                                                    {",
          "60:                                                        reader.WriteEntryTo(fs);",
          "61:                                                    }",
          "62:                                                });",
          "",
          "---------------"
        ]
      }
    }
  ]
}