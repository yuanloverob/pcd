{
  "cve_id": "CVE-2024-32964",
  "cve_desc": "Lobe Chat is a chatbot framework that supports speech synthesis, multimodal, and extensible Function Call plugin system. Prior to 0.150.6, lobe-chat had an unauthorized Server-Side Request Forgery vulnerability in the /api/proxy endpoint. An attacker can construct malicious requests to cause Server-Side Request Forgery without logging in, attack intranet services, and leak sensitive information.",
  "repo": "lobehub/lobe-chat",
  "patch_hash": "465665a735556669ee30446c7ea9049a20cc7c37",
  "patch_info": {
    "commit_hash": "465665a735556669ee30446c7ea9049a20cc7c37",
    "repo": "lobehub/lobe-chat",
    "commit_url": "https://github.com/lobehub/lobe-chat/commit/465665a735556669ee30446c7ea9049a20cc7c37",
    "files": [
      "package.json",
      "src/app/api/proxy/route.ts"
    ],
    "message": "\ud83d\udc1b fix: fix `/api/proxy` internal proxy attack (#2255)",
    "before_after_code_files": [
      "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts"
    ]
  },
  "patch_diff": {
    "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts": [
      "File: src/app/api/proxy/route.ts -> src/app/api/proxy/route.ts",
      "--- Hunk 1 ---",
      "[Context before]",
      "6: export const POST = async (req: Request) => {",
      "11:   return new Response(res.body, { headers: res.headers });",
      "12: };",
      "",
      "[Removed Lines]",
      "1: export const runtime = 'edge';",
      "7:   const url = await req.text();",
      "9:   const res = await fetch(url);",
      "",
      "[Added Lines]",
      "1: import { isPrivate } from 'ip';",
      "2: import { NextResponse } from 'next/server';",
      "3: import dns from 'node:dns';",
      "4: import { promisify } from 'node:util';",
      "6: const lookupAsync = promisify(dns.lookup);",
      "8: export const runtime = 'nodejs';",
      "14:   const url = new URL(await req.text());",
      "15:   let address;",
      "17:   try {",
      "18:     const lookupResult = await lookupAsync(url.hostname);",
      "19:     address = lookupResult.address;",
      "20:   } catch (err) {",
      "21:     console.error(`${url.hostname} DNS parser error:`, err);",
      "23:     return NextResponse.json({ error: 'DNS parser error' }, { status: 504 });",
      "24:   }",
      "26:   const isInternalHost = isPrivate(address);",
      "28:   if (isInternalHost)",
      "29:     return NextResponse.json({ error: 'Not support internal host proxy' }, { status: 400 });",
      "31:   const res = await fetch(url.toString());",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6bb547fa7226a3ad279425b45845ef6d5e06e464",
      "candidate_info": {
        "commit_hash": "6bb547fa7226a3ad279425b45845ef6d5e06e464",
        "repo": "lobehub/lobe-chat",
        "commit_url": "https://github.com/lobehub/lobe-chat/commit/6bb547fa7226a3ad279425b45845ef6d5e06e464",
        "files": [
          "src/app/api/plugins/route.ts",
          "src/app/api/proxy/route.ts",
          "src/pages/api/plugins.ts"
        ],
        "message": "\ud83d\udc1b fix: try with node mode plugins",
        "before_after_code_files": [
          "src/app/api/plugins/route.ts||src/app/api/plugins/route.ts",
          "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts",
          "src/pages/api/plugins.ts||src/pages/api/plugins.ts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts"
          ],
          "candidate": [
            "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts"
          ]
        }
      },
      "candidate_diff": {
        "src/app/api/plugins/route.ts||src/app/api/plugins/route.ts": [
          "File: src/app/api/plugins/route.ts -> src/app/api/plugins/route.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import { createGatewayOnEdgeRuntime } from '@lobehub/chat-plugins-gateway';",
          "3: import { PLUGINS_INDEX_URL } from '@/const/url';",
          "5: export const POST = createGatewayOnEdgeRuntime({ pluginsIndexUrl: PLUGINS_INDEX_URL });",
          "",
          "---------------"
        ],
        "src/app/api/proxy/route.ts||src/app/api/proxy/route.ts": [
          "File: src/app/api/proxy/route.ts -> src/app/api/proxy/route.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: export const runtime = 'edge';",
          "",
          "---------------"
        ],
        "src/pages/api/plugins.ts||src/pages/api/plugins.ts": [
          "File: src/pages/api/plugins.ts -> src/pages/api/plugins.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}