{
  "cve_id": "CVE-2021-45456",
  "cve_desc": "Apache kylin checks the legitimacy of the project before executing some commands with the project name passed in by the user. There is a mismatch between what is being checked and what is being used as the shell command argument in DiagnosisService. This may cause an illegal project name to pass the check and perform the following steps, resulting in a command injection vulnerability. This issue affects Apache Kylin 4.0.0.",
  "repo": "apache/kylin",
  "patch_hash": "f4daf14dde99b934c92ce2c832509f24342bc845",
  "patch_info": {
    "commit_hash": "f4daf14dde99b934c92ce2c832509f24342bc845",
    "repo": "apache/kylin",
    "commit_url": "https://github.com/apache/kylin/commit/f4daf14dde99b934c92ce2c832509f24342bc845",
    "files": [
      "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java",
      "server/src/main/webapp/WEB-INF/web.xml"
    ],
    "message": "test fix",
    "before_after_code_files": [
      "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java||core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java||core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java||core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java||server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java"
    ]
  },
  "patch_diff": {
    "core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java||core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java": [
      "File: core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java -> core-common/src/main/java/org/apache/kylin/common/KylinConfigBase.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "3403:     public String getKerberosPrincipal() {",
      "3404:         return getOptional(\"kylin.kerberos.principal\");",
      "3405:     }",
      "3406: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3407:     public String getEncryptCipherIvSpec() {",
      "3408:         return getOptional(\"kylin.security.encrypt.cipher.ivSpec\", \"AAAAAAAAAAAAAAAA\");",
      "3409:     }",
      "",
      "---------------"
    ],
    "core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java||core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java": [
      "File: core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java -> core-common/src/main/java/org/apache/kylin/common/util/EncryptUtil.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "25: import java.security.NoSuchAlgorithmException;",
      "27: import org.apache.commons.codec.binary.Base64;",
      "29: import javax.crypto.Cipher;",
      "30: import javax.crypto.NoSuchPaddingException;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "28: import org.apache.kylin.common.KylinConfig;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "42:             InvalidKeyException, NoSuchPaddingException, NoSuchAlgorithmException, UnsupportedEncodingException {",
      "43:         Cipher cipher = Cipher.getInstance(\"AES/CFB/PKCS5Padding\");",
      "44:         final SecretKeySpec secretKey = new SecretKeySpec(key, \"AES\");",
      "46:         cipher.init(cipherMode, secretKey, ivSpec);",
      "47:         return cipher;",
      "48:     }",
      "",
      "[Removed Lines]",
      "45:         IvParameterSpec ivSpec = new IvParameterSpec(\"AAAAAAAAAAAAAAAA\".getBytes(\"UTF-8\"));",
      "",
      "[Added Lines]",
      "46:         IvParameterSpec ivSpec = new IvParameterSpec(KylinConfig.getInstanceFromEnv().getEncryptCipherIvSpec().getBytes(\"UTF-8\"));",
      "",
      "---------------"
    ],
    "core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java||core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java": [
      "File: core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java -> core-common/src/test/java/org/apache/kylin/common/util/EncryptUtilTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: package org.apache.kylin.common.util;",
      "21: import org.junit.Assert;",
      "22: import org.junit.Test;",
      "26:     @Test",
      "27:     public void testAESEncrypt(){",
      "",
      "[Removed Lines]",
      "24: public class EncryptUtilTest {",
      "",
      "[Added Lines]",
      "21: import org.junit.After;",
      "23: import org.junit.Before;",
      "26: public class EncryptUtilTest extends LocalFileMetadataTestCase {",
      "27:     @Before",
      "28:     public void setUp() throws Exception {",
      "29:         this.createTestMetadata();",
      "30:     }",
      "32:     @After",
      "33:     public void after() throws Exception {",
      "34:         this.cleanupTestMetadata();",
      "35:     }",
      "",
      "---------------"
    ],
    "server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java||server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java": [
      "File: server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java -> server-base/src/main/java/org/apache/kylin/rest/service/DiagnosisService.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "87:     public String dumpProjectDiagnosisInfo(String project, File exportPath) throws IOException {",
      "88:         Message msg = MsgPicker.getMsg();",
      "89:         ProjectInstance projectInstance =",
      "90:                 ProjectManager.getInstance(KylinConfig.getInstanceFromEnv())",
      "92:         if (null == projectInstance) {",
      "93:             throw new BadRequestException(",
      "95:         }",
      "96:         aclEvaluate.checkProjectOperationPermission(projectInstance);",
      "98:         runDiagnosisCLI(args);",
      "99:         return getDiagnosisPackageName(exportPath);",
      "100:     }",
      "",
      "[Removed Lines]",
      "91:                         .getProject(ValidateUtil.convertStringToBeAlphanumericUnderscore(project));",
      "94:                     String.format(Locale.ROOT, msg.getDIAG_PROJECT_NOT_FOUND(), project));",
      "97:         String[] args = { project, exportPath.getAbsolutePath() };",
      "",
      "[Added Lines]",
      "89:         String projectName = ValidateUtil.convertStringToBeAlphanumericUnderscore(project);",
      "92:                         .getProject(projectName);",
      "95:                     String.format(Locale.ROOT, msg.getDIAG_PROJECT_NOT_FOUND(), projectName));",
      "98:         String[] args = { projectName, exportPath.getAbsolutePath() };",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ba3348039f2e39f4262d80792a7aa2fbc14604aa",
      "candidate_info": {
        "commit_hash": "ba3348039f2e39f4262d80792a7aa2fbc14604aa",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/ba3348039f2e39f4262d80792a7aa2fbc14604aa",
        "files": [
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java"
        ],
        "message": "force delete spark deployMode in NSparkLocalStep",
        "before_after_code_files": [
          "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java||kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java -> kylin-spark-project/kylin-spark-engine/src/main/java/org/apache/kylin/engine/spark/job/NSparkLocalStep.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: public class NSparkLocalStep extends NSparkExecutable {",
          "29:     private final static String[] excludedSparkConf = new String[] {\"spark.executor.cores\",",
          "30:             \"spark.executor.memoryOverhead\", \"spark.executor.extraJavaOptions\",",
          "33:     @Override",
          "34:     protected Set<String> getMetadataDumpList(KylinConfig config) {",
          "",
          "[Removed Lines]",
          "31:             \"spark.executor.instances\", \"spark.executor.memory\", \"spark.executor.extraClassPath\"};",
          "",
          "[Added Lines]",
          "31:             \"spark.executor.instances\", \"spark.executor.memory\", \"spark.executor.extraClassPath\",",
          "32:             \"spark.submit.deployMode\"};",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7abab14aad868e092f0479a600aa6002c04985f3",
      "candidate_info": {
        "commit_hash": "7abab14aad868e092f0479a600aa6002c04985f3",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/7abab14aad868e092f0479a600aa6002c04985f3",
        "files": [
          "webapp/app/js/controllers/cubes.js",
          "webapp/app/less/app.less",
          "webapp/app/partials/jobs/job_refresh.html"
        ],
        "message": "KYLIN-4550 Provide advanced refresh interface inside the refresh panel\n\n(cherry picked from commit 571466a7aa9a6ba4d91a5e588543c1ee8fea3508)",
        "before_after_code_files": [
          "webapp/app/js/controllers/cubes.js||webapp/app/js/controllers/cubes.js",
          "webapp/app/less/app.less||webapp/app/less/app.less",
          "webapp/app/partials/jobs/job_refresh.html||webapp/app/partials/jobs/job_refresh.html"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "webapp/app/js/controllers/cubes.js||webapp/app/js/controllers/cubes.js": [
          "File: webapp/app/js/controllers/cubes.js -> webapp/app/js/controllers/cubes.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "848:     endTime: 0",
          "849:   };",
          "850:   $scope.message = \"\";",
          "851:   var startTime;",
          "852:   if(cube.segments.length == 0){",
          "853:     startTime = (!!cube.detail.partition_date_start)?cube.detail.partition_date_start:0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "851:   $scope.refreshType = 'normal';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "948:   $scope.cancel = function () {",
          "949:     $modalInstance.dismiss('cancel');",
          "950:   };",
          "951: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "953:   $scope.getAdvRefreshTimeOptions = function(status) {",
          "954:     if ('start' === status) {",
          "955:       var startTimeOptions = [];",
          "956:       var lastInd = $scope.cube.segments.length - 1;",
          "957:       angular.forEach($scope.cube.segments, function(segment, ind) {",
          "958:         startTimeOptions.push(segment.date_range_start);",
          "959:         if (lastInd == ind) {",
          "960:           startTimeOptions.push(segment.date_range_end);",
          "961:         }",
          "962:       });",
          "963:       return startTimeOptions;",
          "964:     } else if ('end' === status) {",
          "965:       var endTimeOptions = [];",
          "966:       angular.forEach($scope.cube.segments, function(segment, ind) {",
          "967:         endTimeOptions.push(segment.date_range_end);",
          "968:       });",
          "969:       return endTimeOptions;",
          "970:     }",
          "971:   };",
          "972:   $scope.advRefreshStartTimeOptions = $scope.getAdvRefreshTimeOptions('start');",
          "973:   $scope.advRefreshEndTimeOptions = $scope.getAdvRefreshTimeOptions('end');",
          "974:   $scope.endTimeTypeCustomize = false;",
          "976:   $scope.changeEndTimeDisplay = function() {",
          "977:     $scope.endTimeTypeCustomize = !$scope.endTimeTypeCustomize;",
          "978:   };",
          "980:   $scope.setDateRange = function($view, $dates) {",
          "981:     var minDate = $scope.cube.segments[$scope.cube.segments.length-1].date_range_end;",
          "983:     angular.forEach($dates, function(date) {",
          "984:       var utcDateValue = date.utcDateValue;",
          "985:       date.selectable = utcDateValue >= minDate; // && utcDateValue <= maxDate;",
          "986:     });",
          "987:   };",
          "989:   $scope.changeRefreshType = function (type) {",
          "990:     $scope.refreshType = type;",
          "991:     if (type ==='normal') {",
          "992:       $scope.jobBuildRequest.buildType = 'REFRESH';",
          "993:     } else if (type === 'advance'){",
          "994:       $scope.jobBuildRequest.buildType = 'BUILD';",
          "995:     }",
          "996:   }",
          "",
          "---------------"
        ],
        "webapp/app/less/app.less||webapp/app/less/app.less": [
          "File: webapp/app/less/app.less -> webapp/app/less/app.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "1170: }",
          "1171: .pagination{",
          "1172:   cursor: pointer;",
          "",
          "[Removed Lines]",
          "1173: }",
          "",
          "[Added Lines]",
          "1175: .adv-refresh-customized-on {",
          "1176:   position: relative;",
          "1177:   bottom: 10px;",
          "1178:   color:#438eb9;",
          "1179:   cursor:pointer;",
          "1180:   font-size:18px;",
          "1181: }",
          "1182: .adv-refresh-customized-off {",
          "1183:   position: relative;",
          "1184:   top: 2px;",
          "1185:   color:#438eb9;",
          "1186:   cursor:pointer;",
          "1187:   font-size:18px;",
          "1188: }",
          "",
          "---------------"
        ],
        "webapp/app/partials/jobs/job_refresh.html||webapp/app/partials/jobs/job_refresh.html": [
          "File: webapp/app/partials/jobs/job_refresh.html -> webapp/app/partials/jobs/job_refresh.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "20:     <div class=\"modal-header\">",
          "21:         <h4 tooltip=\"refresh\">CUBE REFRESH CONFIRM</h4>",
          "22:     </div>",
          "71:                     </table>",
          "76:             </div>",
          "78:         </div>",
          "84:             </div>",
          "86:         </div>",
          "87:     </div>",
          "89:     <div class=\"modal-footer\">",
          "",
          "[Removed Lines]",
          "23:     <div class=\"modal-body\" style=\"background-color: white\">",
          "24:         <div ng-if=\"metaModel.model.partition_desc.partition_date_column\" class=\"row\">",
          "25:             <div class=\"col-md-2\"></div>",
          "26:             <div class=\"col-md-8\">",
          "27:                 <div ng-if=\"!!!(cube.segments) || cube.segments.length == 0\">",
          "28:                     <span class=\"text-info\">No Segment to refresh.</span>",
          "29:                 </div>",
          "30:                 <div ng-if=\"cube.segments.length > 0\" class=\"row\">",
          "31:                     <table class=\"table table-striped list\" >",
          "32:                         <tbody>",
          "33:                         <tr>",
          "34:                             <td>PARTITION DATE COLUMN</td>",
          "35:                             <td>{{metaModel.model.partition_desc.partition_date_column}}</td>",
          "36:                         </tr>",
          "37:                         <tr>",
          "38:                             <td>REFRESH SEGMENT</td>",
          "39:                             <td>",
          "40:                                 <select ng-model=\"selectedSegment\"",
          "41:                                         ng-init=\"selectedSegment=cube.segments[0];segmentSelected(selectedSegment);\"",
          "42:                                         ng-options=\"segment as segment.name for segment in cube.segments\"",
          "43:                                         ng-change=\"segmentSelected(selectedSegment)\">",
          "44:                                 </select>",
          "45:                             </td>",
          "46:                         </tr>",
          "47:                         <tr>",
          "48:                             <td>SEGMENT DETAIL</td>",
          "49:                             <td>",
          "50:                                 <table class=\"table table-condensed\">",
          "51:                                     <tr>",
          "52:                                         <td>Start Date (Include)</td>",
          "53:                                         <td>{{selectedSegment.date_range_start |  reverseToGMT0}}</td>",
          "54:                                     </tr>",
          "55:                                     <tr>",
          "56:                                         <td>End Date (Exclude)</td>",
          "57:                                         <td>{{selectedSegment.date_range_end |  reverseToGMT0}}</td>",
          "58:                                     </tr>",
          "59:                                     <tr>",
          "60:                                         <td>Last build Time</td>",
          "61:                                         <td>{{selectedSegment.last_build_time | utcToConfigTimeZone}}</td>",
          "62:                                     </tr>",
          "63:                                     <tr>",
          "64:                                         <td>Last build ID</td>",
          "65:                                         <td>{{selectedSegment.last_build_job_id}}</td>",
          "66:                                     </tr>",
          "67:                                 </table>",
          "68:                             </td>",
          "69:                         </tr>",
          "70:                         </tbody>",
          "72:                 </div>",
          "73:                 <div ng-if=\"message\">",
          "74:                     <span class=\"text-warning\">{{message}}</span>",
          "75:                 </div>",
          "77:             <div class=\"col-md-2\"></div>",
          "80:         <div ng-if=\"!metaModel.model.partition_desc.partition_date_column\" class=\"row\">",
          "81:             <div class=\"col-md-2\"></div>",
          "82:             <div class=\"col-md-8\">",
          "83:                 <span>No partition date column defined. If you want to rebuild the cube, please click \"Build\".</span>",
          "85:             <div class=\"col-md-2\"></div>",
          "",
          "[Added Lines]",
          "23:     <div class=\"modal-body\">",
          "24:       <div ng-if=\"metaModel.model.partition_desc.partition_date_column\" class=\"nav-tabs-custom\" style=\"box-shadow:none\">",
          "25:         <ul class=\"nav nav-tabs\" style=\"margin-bottom: 40px\">",
          "26:           <li class=\"{{(!refreshType || refreshType=='normal')? 'active':''}}\">",
          "27:             <a href=\"\" ng-click=\"changeRefreshType('normal')\">Refresh</a>",
          "28:           </li>",
          "29:           <li class=\"{{refreshType=='advance'? 'active':''}}\">",
          "30:             <a href=\"\" ng-click=\"changeRefreshType('advance')\">Advance Refresh</a>",
          "31:           </li>",
          "32:         </ul>",
          "33:         <!-- Refresh -->",
          "34:         <div ng-if=\"!refreshType || refreshType=='normal'\" class=\"row\">",
          "35:           <div class=\"col-md-2\"></div>",
          "36:           <div class=\"col-md-8\">",
          "37:             <div ng-if=\"!!!(cube.segments) || cube.segments.length == 0\">",
          "38:               <span class=\"text-info\">No Segment to refresh.</span>",
          "39:             </div>",
          "40:             <div ng-if=\"cube.segments.length > 0\" class=\"row\">",
          "41:               <table class=\"table table-striped list\" >",
          "42:                 <tbody>",
          "43:                 <tr>",
          "44:                   <td>PARTITION DATE COLUMN</td>",
          "45:                   <td>{{metaModel.model.partition_desc.partition_date_column}}</td>",
          "46:                 </tr>",
          "47:                 <tr>",
          "48:                   <td>REFRESH SEGMENT</td>",
          "49:                   <td>",
          "50:                     <select ng-model=\"selectedSegment\"",
          "51:                             ng-init=\"selectedSegment=cube.segments[0];segmentSelected(selectedSegment);\"",
          "52:                             ng-options=\"segment as segment.name for segment in cube.segments\"",
          "53:                             ng-change=\"segmentSelected(selectedSegment)\">",
          "54:                     </select>",
          "55:                   </td>",
          "56:                 </tr>",
          "57:                 <tr>",
          "58:                   <td>SEGMENT DETAIL</td>",
          "59:                   <td>",
          "60:                     <table class=\"table table-condensed\">",
          "61:                       <tr>",
          "62:                         <td>Start Date (Include)</td>",
          "63:                         <td>{{selectedSegment.date_range_start |  reverseToGMT0}}</td>",
          "64:                       </tr>",
          "65:                       <tr>",
          "66:                         <td>End Date (Exclude)</td>",
          "67:                         <td>{{selectedSegment.date_range_end |  reverseToGMT0}}</td>",
          "68:                       </tr>",
          "69:                       <tr>",
          "70:                         <td>Last build Time</td>",
          "71:                         <td>{{selectedSegment.last_build_time | utcToConfigTimeZone}}</td>",
          "72:                       </tr>",
          "73:                       <tr>",
          "74:                         <td>Last build ID</td>",
          "75:                         <td>{{selectedSegment.last_build_job_id}}</td>",
          "76:                       </tr>",
          "78:                   </td>",
          "79:                 </tr>",
          "80:                 </tbody>",
          "81:               </table>",
          "82:             </div>",
          "83:             <div ng-if=\"message\">",
          "84:               <span class=\"text-warning\">{{message}}</span>",
          "86:           </div>",
          "87:           <div class=\"col-md-2\"></div>",
          "90:         <!-- Adv Refresh -->",
          "91:         <div ng-if=\"refreshType=='advance'\" class=\"row\">",
          "92:           <div class=\"col-md-2\"></div>",
          "93:           <div class=\"col-md-8\">",
          "94:             <div ng-if=\"!!!(cube.segments) || cube.segments.length == 0\">",
          "95:               <span class=\"text-info\">No Segment to refresh.</span>",
          "96:             </div>",
          "97:             <div ng-if=\"cube.segments.length > 0\" class=\"row\">",
          "98:               <table class=\"table table-striped list\" ng-if=\"(cube.segments|filter: {status: 'NEW'}).length == 0\">",
          "99:                 <tbody>",
          "100:                 <tr>",
          "101:                   <td>PARTITION DATE COLUMN</td>",
          "102:                   <td>{{metaModel.model.partition_desc.partition_date_column}}</td>",
          "103:                 </tr>",
          "104:                 <tr>",
          "105:                   <td>START DATE</td>",
          "106:                   <td>",
          "107:                     <select ng-model=\"jobBuildRequest.startTime\"",
          "108:                             ng-init=\"jobBuildRequest.endTime=advRefreshStartTimeOptions[0];\"",
          "109:                             ng-options=\"startTimeOption | reverseToGMT0 for startTimeOption in advRefreshStartTimeOptions\">",
          "110:                     </select>",
          "111:                   </td>",
          "112:                 </tr>",
          "113:                 <tr>",
          "114:                   <td width=\"30%;\">END DATE</td>",
          "115:                   <td width=\"70%;\">",
          "116:                     <select ng-if=\"!endTimeTypeCustomize\" ng-model=\"jobBuildRequest.endTime\"",
          "117:                             ng-options=\"endTimeOption | reverseToGMT0 for endTimeOption in advRefreshEndTimeOptions\">",
          "118:                     </select>",
          "119:                     <div class=\"dropdown\" style=\"width:200px; display:inline-block;\" ng-if=\"endTimeTypeCustomize\">",
          "120:                       <a class=\"dropdown-toggle\" id=\"dropdown2\" role=\"button\" data-toggle=\"dropdown\" data-target=\"#\" href=\"#\">",
          "121:                         <div class=\"input-group\"><input type=\"text\" class=\"form-control\" date-timepicker-timezone readonly data-ng-model=\"jobBuildRequest.endTime\" ng-change=\"changeEndTime('customize')\" timezone=\"{{cube.model.partition_desc.partition_time_zone}}\">",
          "122:                           <span class=\"input-group-addon\"><i class=\"glyphicon glyphicon-calendar\"></i></span>",
          "123:                         </div>",
          "124:                       </a>",
          "125:                       <ul class=\"dropdown-menu\" role=\"menu\" aria-labelledby=\"dLabel\">",
          "126:                         <datetimepicker  data-ng-model=\"jobBuildRequest.endTime\" data-datetimepicker-config=\"{ dropdownSelector: '#dropdown2' }\" data-before-render=\"setDateRange($view, $dates)\" data-on-set-time=\"formatEndTime(newDate, oldDate)\"/>",
          "127:                       </ul>",
          "128:                     </div>",
          "129:                     <i class=\"fa\" ng-class=\"{'fa-calendar adv-refresh-customized-off': !endTimeTypeCustomize, 'fa-list adv-refresh-customized-on': endTimeTypeCustomize}\"  ng-click=\"changeEndTimeDisplay()\"></i>",
          "130:                   </td>",
          "131:                 </tr>",
          "132:                 </tbody>",
          "133:               </table>",
          "135:               <div ng-if=\"(cube.segments|filter: {status: 'NEW'}).length > 0\">",
          "136:                 <span class=\"text-warning\">There exists a build request of this cube, the job may be running or error. If you need a new build, please wait for its complete or discard it.</span>",
          "137:               </div>",
          "138:             </div>",
          "139:             <div ng-if=\"message\">",
          "140:               <span class=\"text-warning\">{{message}}</span>",
          "142:           </div>",
          "143:           <div class=\"col-md-2\"></div>",
          "144:         </div>",
          "145:       </div>",
          "146:       <div ng-if=\"!metaModel.model.partition_desc.partition_date_column\" class=\"row\">",
          "147:         <div class=\"col-md-2\"></div>",
          "148:         <div class=\"col-md-8\">",
          "149:           <span>No partition date column defined. If you want to rebuild the cube, please click \"Build\".</span>",
          "151:         <div class=\"col-md-2\"></div>",
          "152:       </div>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1402d96b39a09c6ed9c04f4a9ca2fbd18ee4c401",
      "candidate_info": {
        "commit_hash": "1402d96b39a09c6ed9c04f4a9ca2fbd18ee4c401",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/1402d96b39a09c6ed9c04f4a9ca2fbd18ee4c401",
        "files": [
          "core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java"
        ],
        "message": "Fix mvn install error",
        "before_after_code_files": [
          "core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java||core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java||core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java": [
          "File: core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java -> core-common/src/main/java/org/apache/kylin/common/util/StringUtil.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "220:         return a == null ? b == null : a.equals(b);",
          "221:     }",
          "223: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "223:     public static boolean isEmpty(String str) {",
          "224:         return str == null || str.length() == 0;",
          "225:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8f8bab94ed46ad81b45c3522125d7ab020f0e66f",
      "candidate_info": {
        "commit_hash": "8f8bab94ed46ad81b45c3522125d7ab020f0e66f",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/8f8bab94ed46ad81b45c3522125d7ab020f0e66f",
        "files": [
          "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala"
        ],
        "message": "KYLIN-4889, fix master match error when getting master_app_url",
        "before_after_code_files": [
          "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala||kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala||kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala": [
          "File: kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala -> kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/spark/sql/SparderContext.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "173:                   .toString)",
          "174:               initMonitorEnv()",
          "175:               master match {",
          "177:                   master_app_url = \"http://localhost:\" + sparkSession.sparkContext.getConf",
          "178:                     .get(\"spark.ui.port\", \"4040\")",
          "179:                 case _ =>",
          "",
          "[Removed Lines]",
          "176:                 case \"true\" =>",
          "",
          "[Added Lines]",
          "176:                 case mode: String if mode.startsWith(\"local\") =>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "df6dd4726a90fdabb4dc4e04daacbee8f206b782",
      "candidate_info": {
        "commit_hash": "df6dd4726a90fdabb4dc4e04daacbee8f206b782",
        "repo": "apache/kylin",
        "commit_url": "https://github.com/apache/kylin/commit/df6dd4726a90fdabb4dc4e04daacbee8f206b782",
        "files": [
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala",
          "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java"
        ],
        "message": "KYLIN-5067 Skip snapshot build when dimension table's kind is LOOKUP",
        "before_after_code_files": [
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala",
          "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala",
          "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java||kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/kylin/pull/1893",
          "https://github.com/apache/kylin/pull/2018",
          "https://github.com/apache/kylin/pull/2125",
          "https://github.com/apache/kylin/pull/2033",
          "https://github.com/apache/kylin/pull/2112",
          "https://github.com/apache/kylin/pull/2115",
          "https://github.com/apache/kylin/pull/1865",
          "https://github.com/apache/kylin/pull/1913",
          "https://github.com/apache/kylin/pull/2135"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala -> kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CreateFlatTable.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "46:     val ccCols = seg.allColumns.filter(_.isInstanceOf[ComputedColumnDesc]).toSet",
          "47:     var rootFactDataset = generateTableDataset(seg.factTable, ccCols.toSeq, ss, seg.project)",
          "50:     rootFactDataset = applyPartitionCondition(seg, rootFactDataset)",
          "52:     (needJoin, needEncode) match {",
          "",
          "[Removed Lines]",
          "49:     logInfo(s\"Create flattable need join lookup tables $needJoin, need encode cols $needEncode\")",
          "",
          "[Added Lines]",
          "49:     logInfo(s\"Create flat table need join lookup tables $needJoin, need encode cols $needEncode\")",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala -> kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/builder/CubeSnapshotBuilder.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "189:     joinDescs.foreach {",
          "190:       joinDesc =>",
          "191:         val tableInfo = joinDesc.lookupTable",
          "199:         }",
          "200:     }",
          "201:   }",
          "",
          "[Removed Lines]",
          "192:         val lookupTableName = tableInfo.tableName",
          "193:         val df = ss.table(tableInfo)",
          "194:         val countColumn = df.count()",
          "195:         val lookupTablePKS = joinDesc.PKS.map(lookupTablePK => lookupTablePK.columnName)",
          "196:         val countDistinctColumn = df.agg(countDistinct(lookupTablePKS.head, lookupTablePKS.tail: _*)).collect().map(_.getLong(0)).head",
          "197:         if (countColumn != countDistinctColumn) {",
          "198:           throw new IllegalStateException(s\"Failed to build lookup table ${lookupTableName} snapshot for Dup key found, key= ${lookupTablePKS.mkString(\",\")}\")",
          "",
          "[Added Lines]",
          "193:         if (seg.snapshotTables.exists(t => t.identity.equals(tableInfo.identity))) {",
          "194:           val lookupTableName = tableInfo.tableName",
          "195:           val df = ss.table(tableInfo)",
          "196:           val countColumn = df.count()",
          "197:           val lookupTablePKS = joinDesc.PKS.map(lookupTablePK => lookupTablePK.columnName)",
          "198:           val countDistinctColumn = df.agg(countDistinct(lookupTablePKS.head, lookupTablePKS.tail: _*)).collect().map(_.getLong(0)).head",
          "199:           if (countColumn != countDistinctColumn) {",
          "200:             throw new IllegalStateException(s\"Failed to build lookup table ${lookupTableName} snapshot for Dup key found, key= ${lookupTablePKS.mkString(\",\")}\")",
          "201:           }",
          "202:         } else {",
          "203:           logInfo(\"Skip check duplicate primary key on table : \" + tableInfo.identity)",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala||kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala": [
          "File: kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala -> kylin-spark-project/kylin-spark-engine/src/main/scala/org/apache/kylin/engine/spark/job/ParentSourceChooser.scala",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:   def decideFlatTableSource(entity: LayoutEntity): Unit = {",
          "77:     if (flatTableSource == null) {",
          "",
          "[Removed Lines]",
          "78:       if (needEncoding) {",
          "",
          "[Added Lines]",
          "78:       if (segInfo.snapshotTables.nonEmpty && needEncoding) {",
          "",
          "---------------"
        ],
        "kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java||kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java": [
          "File: kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java -> kylin-spark-project/kylin-spark-query/src/main/scala/org/apache/kylin/storage/spark/HadoopFileStorageQuery.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:         dimensionsD.addAll(groupsD);",
          "85:         dimensionsD.addAll(otherDimsD);",
          "86:         Cuboid cuboid = findCuboid(cubeInstance, dimensionsD, metrics);",
          "87:         context.setCuboid(cuboid);",
          "88:         return new GTCubeStorageQueryRequest(cuboid, dimensionsD, groupsD, null, null, null,",
          "89:                 metrics, null, null, null, context);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87:         log.info(\"For OLAPContext {}, need cuboid {}, hit cuboid {}, level diff is {}.\", olapContext.id, cuboid.getInputID() , cuboid.getId(), Long.bitCount(cuboid.getInputID() ^ cuboid.getId()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}