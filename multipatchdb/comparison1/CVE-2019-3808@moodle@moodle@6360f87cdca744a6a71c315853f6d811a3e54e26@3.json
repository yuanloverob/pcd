{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b5b112f62cbb104af365a06024edc1544baf335a",
      "candidate_info": {
        "commit_hash": "b5b112f62cbb104af365a06024edc1544baf335a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b5b112f62cbb104af365a06024edc1544baf335a",
        "files": [
          "lib/db/messages.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-64314 messaging: Web notifications for insights",
        "before_after_code_files": [
          "lib/db/messages.php||lib/db/messages.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/messages.php||lib/db/messages.php": [
          "File: lib/db/messages.php -> lib/db/messages.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:     'insights' => array (",
          "108:     ),",
          "",
          "[Removed Lines]",
          "107:          'capability'  => 'moodle/analytics:listinsights'",
          "",
          "[Added Lines]",
          "107:         'defaults' => [",
          "108:             'popup' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDIN + MESSAGE_DEFAULT_LOGGEDOFF,",
          "109:             'email' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDOFF,",
          "110:         ]",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2719:         upgrade_main_savepoint(true, 2019011801.03);",
          "2720:     }",
          "2722:     return true;",
          "2723: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2722:     if ($oldversion < 2019021500.01) {",
          "2723:         $insights = $DB->get_record('message_providers', ['component' => 'moodle', 'name' => 'insights']);",
          "2724:         $insights->capability = null;",
          "2725:         $DB->update_record('message_providers', $insights);",
          "2726:         upgrade_main_savepoint(true, 2019021500.01);",
          "2727:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019021500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019021500.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ef65b8a85564ec260ddc0ebc17bf87cb74e57e3",
      "candidate_info": {
        "commit_hash": "6ef65b8a85564ec260ddc0ebc17bf87cb74e57e3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6ef65b8a85564ec260ddc0ebc17bf87cb74e57e3",
        "files": [
          "admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-61669-master' of git://github.com/jleyva/moodle",
        "before_after_code_files": [
          "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php": [
          "File: admin/tool/mobile/classes/api.php -> admin/tool/mobile/classes/api.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "277:             $settings->tool_mobile_customlangstrings = get_config('tool_mobile', 'customlangstrings');",
          "278:             $settings->tool_mobile_disabledfeatures = get_config('tool_mobile', 'disabledfeatures');",
          "279:             $settings->tool_mobile_custommenuitems = get_config('tool_mobile', 'custommenuitems');",
          "280:         }",
          "282:         return $settings;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "280:             $settings->tool_mobile_apppolicy = get_config('tool_mobile', 'apppolicy');",
          "",
          "---------------"
        ],
        "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php": [
          "File: admin/tool/mobile/lang/en/tool_mobile.php -> admin/tool/mobile/lang/en/tool_mobile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: $string['adodbdebugwarning'] = 'ADOdb debugging is enabled. It should be disabled in the external database authentication or external database enrolment plugin settings.';",
          "26: $string['androidappid'] = 'Android app\\'s unique identifier';",
          "27: $string['androidappid_desc'] = 'This setting may be left as default unless you have a custom Android app.';",
          "28: $string['autologinkeygenerationlockout'] = 'Auto-login key generation is blocked. You need to wait 6 minutes between requests.';",
          "29: $string['autologinnotallowedtoadmins'] = 'Auto-login is not allowed for site admins.';",
          "30: $string['cachedef_plugininfo'] = 'This stores the list of plugins with mobile addons';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: $string['apppolicy'] = 'App policy URL';",
          "29: $string['apppolicy_help'] = 'The URL of a policy for app users which is listed on the About page in the app. If the field is left empty, the site policy URL will be used instead.';",
          "",
          "---------------"
        ],
        "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php": [
          "File: admin/tool/mobile/settings.php -> admin/tool/mobile/settings.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:                 new lang_string('configenablemobilewebservice', 'admin', $enablemobiledoclink), $default));",
          "44:     }",
          "46:     $ADMIN->add('mobileapp', $temp);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     $temp->add(new admin_setting_configtext('tool_mobile/apppolicy', new lang_string('apppolicy', 'tool_mobile'),",
          "47:         new lang_string('apppolicy_help', 'tool_mobile'), '', PARAM_URL));",
          "",
          "---------------"
        ],
        "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php": [
          "File: admin/tool/mobile/tests/externallib_test.php -> admin/tool/mobile/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "173:             array('name' => 'tool_mobile_customlangstrings', 'value' => ''),",
          "174:             array('name' => 'tool_mobile_disabledfeatures', 'value' => ''),",
          "175:             array('name' => 'tool_mobile_custommenuitems', 'value' => ''),",
          "176:         );",
          "177:         $this->assertCount(0, $result['warnings']);",
          "178:         $this->assertEquals($expected, $result['settings']);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "176:             array('name' => 'tool_mobile_apppolicy', 'value' => ''),",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018042500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018042500.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "01aa126848377b5a17c0b57f3b81d1ab430dad86",
      "candidate_info": {
        "commit_hash": "01aa126848377b5a17c0b57f3b81d1ab430dad86",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/01aa126848377b5a17c0b57f3b81d1ab430dad86",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.8dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019103100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191031)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019110500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191105)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e26d40e343a0aa50f86fd796efdd32bb141b031e",
      "candidate_info": {
        "commit_hash": "e26d40e343a0aa50f86fd796efdd32bb141b031e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e26d40e343a0aa50f86fd796efdd32bb141b031e",
        "files": [
          "mod/assign/classes/event/course_module_viewed.php",
          "mod/assign/locallib.php",
          "mod/assign/tests/events_test.php",
          "version.php"
        ],
        "message": "MDL-53035 mod_assign: add course_module_viewed event",
        "before_after_code_files": [
          "mod/assign/classes/event/course_module_viewed.php||mod/assign/classes/event/course_module_viewed.php",
          "mod/assign/locallib.php||mod/assign/locallib.php",
          "mod/assign/tests/events_test.php||mod/assign/tests/events_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/assign/classes/event/course_module_viewed.php||mod/assign/classes/event/course_module_viewed.php": [
          "File: mod/assign/classes/event/course_module_viewed.php -> mod/assign/classes/event/course_module_viewed.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace mod_assign\\event;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: global $CFG;",
          "39: class course_module_viewed extends \\core\\event\\course_module_viewed {",
          "44:     protected function init() {",
          "45:         $this->data['crud'] = 'r';",
          "46:         $this->data['edulevel'] = self::LEVEL_PARTICIPATING;",
          "47:         $this->data['objecttable'] = 'assign';",
          "48:     }",
          "53:     public static function get_objectid_mapping() {",
          "54:         return array('db' => 'assign', 'restore' => 'assign');",
          "55:     }",
          "56: }",
          "",
          "---------------"
        ],
        "mod/assign/locallib.php||mod/assign/locallib.php": [
          "File: mod/assign/locallib.php -> mod/assign/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "8754:     }",
          "8761:     public function set_module_viewed() {",
          "8762:         $completion = new completion_info($this->get_course());",
          "8763:         $completion->set_module_viewed($this->get_course_module());",
          "8764:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8766:         $assigninstance = $this->get_instance();",
          "8767:         $event = \\mod_assign\\event\\course_module_viewed::create(array(",
          "8768:                 'objectid' => $assigninstance->id,",
          "8769:                 'context' => $this->get_context()",
          "8770:         ));",
          "8772:         $event->add_record_snapshot('assign', $assigninstance);",
          "8773:         $event->trigger();",
          "",
          "---------------"
        ],
        "mod/assign/tests/events_test.php||mod/assign/tests/events_test.php": [
          "File: mod/assign/tests/events_test.php -> mod/assign/tests/events_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1323:         $this->assertEquals(context_module::instance($cm->id), $event->get_context());",
          "1324:         $this->assertEventContextNotUsed($event);",
          "1325:     }",
          "1326: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1330:     public function test_course_module_viewed() {",
          "1331:         $this->resetAfterTest();",
          "1333:         $course = $this->getDataGenerator()->create_course();",
          "1334:         $assign = $this->create_instance($course);",
          "1336:         $context = $assign->get_context();",
          "1338:         $params = array(",
          "1339:             'context' => $context,",
          "1340:             'objectid' => $assign->get_instance()->id",
          "1341:         );",
          "1343:         $event = \\mod_assign\\event\\course_module_viewed::create($params);",
          "1346:         $sink = $this->redirectEvents();",
          "1347:         $event->trigger();",
          "1348:         $events = $sink->get_events();",
          "1349:         $this->assertCount(1, $events);",
          "1350:         $event = reset($events);",
          "1353:         $this->assertInstanceOf('\\mod_assign\\event\\course_module_viewed', $event);",
          "1354:         $this->assertEquals($context, $event->get_context());",
          "1355:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018110700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018110700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a672f021eaf0640c6f3b0094839c8c4fd3b2df7a",
      "candidate_info": {
        "commit_hash": "a672f021eaf0640c6f3b0094839c8c4fd3b2df7a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a672f021eaf0640c6f3b0094839c8c4fd3b2df7a",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.8dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019083000.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190830)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019090500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190905)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}