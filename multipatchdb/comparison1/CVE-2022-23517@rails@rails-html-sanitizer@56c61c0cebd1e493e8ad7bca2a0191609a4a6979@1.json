{
  "cve_id": "CVE-2022-23517",
  "cve_desc": "rails-html-sanitizer is responsible for sanitizing HTML fragments in Rails applications. Certain configurations of rails-html-sanitizer < 1.4.4 use an inefficient regular expression that is susceptible to excessive backtracking when attempting to sanitize certain SVG attributes. This may lead to a denial of service through CPU resource consumption. This issue has been patched in version 1.4.4.",
  "repo": "rails/rails-html-sanitizer",
  "patch_hash": "56c61c0cebd1e493e8ad7bca2a0191609a4a6979",
  "patch_info": {
    "commit_hash": "56c61c0cebd1e493e8ad7bca2a0191609a4a6979",
    "repo": "rails/rails-html-sanitizer",
    "commit_url": "https://github.com/rails/rails-html-sanitizer/commit/56c61c0cebd1e493e8ad7bca2a0191609a4a6979",
    "files": [
      "lib/rails/html/scrubbers.rb",
      "test/sanitizer_test.rb"
    ],
    "message": "fix: replace slow regex attribute check with Loofah method\n\nwhich uses the Crass parser",
    "before_after_code_files": [
      "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
      "test/sanitizer_test.rb||test/sanitizer_test.rb"
    ]
  },
  "patch_diff": {
    "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb": [
      "File: lib/rails/html/scrubbers.rb -> lib/rails/html/scrubbers.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "146:             attr_node.remove",
      "147:           end",
      "148:         end",
      "149:         if Loofah::HTML5::SafeList::SVG_ATTR_VAL_ALLOWS_REF.include?(attr_name)",
      "151:         end",
      "152:         if Loofah::HTML5::SafeList::SVG_ALLOW_LOCAL_HREF.include?(node.name) && attr_name == 'xlink:href' && attr_node.value =~ /^\\s*[^#\\s].*/m",
      "153:           attr_node.remove",
      "154:         end",
      "",
      "[Removed Lines]",
      "150:           attr_node.value = attr_node.value.gsub(/url\\s*\\(\\s*[^#\\s][^)]+?\\)/m, ' ') if attr_node.value",
      "",
      "[Added Lines]",
      "151:           Loofah::HTML5::Scrub.scrub_attribute_that_allows_local_ref(attr_node)",
      "",
      "---------------"
    ],
    "test/sanitizer_test.rb||test/sanitizer_test.rb": [
      "File: test/sanitizer_test.rb -> test/sanitizer_test.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "606:     refute_includes(sanitized, \"style\")",
      "607:   end",
      "609: protected",
      "611:   def xpath_sanitize(input, options = {})",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "609:   def test_scrubbing_svg_attr_values_that_allow_ref",
      "610:     input = %Q(<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>)",
      "611:     expected = %Q(<div fill=\"yellow #fff\">hey</div>)",
      "612:     actual = scope_allowed_attributes %w(fill) do",
      "613:       safe_list_sanitize(input)",
      "614:     end",
      "616:     assert_equal(expected, actual)",
      "617:   end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f03c34c0e0dd04a165e9f0dd8ebe75f182aea906",
      "candidate_info": {
        "commit_hash": "f03c34c0e0dd04a165e9f0dd8ebe75f182aea906",
        "repo": "rails/rails-html-sanitizer",
        "commit_url": "https://github.com/rails/rails-html-sanitizer/commit/f03c34c0e0dd04a165e9f0dd8ebe75f182aea906",
        "files": [
          "test/sanitizer_test.rb"
        ],
        "message": "test: reorganize sanitizer tests\n\ncreate a new test class for each sanitizer",
        "before_after_code_files": [
          "test/sanitizer_test.rb||test/sanitizer_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ],
          "candidate": [
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "test/sanitizer_test.rb||test/sanitizer_test.rb": [
          "File: test/sanitizer_test.rb -> test/sanitizer_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: #  In many other cases, it's because the parser used by Nokogiri on JRuby (xerces+nekohtml) parses",
          "21: #  slightly differently than libxml2 in edge cases.",
          "22: #",
          "47:   class XpathRemovalTestSanitizer < Rails::Html::Sanitizer",
          "48:     def sanitize(html, options = {})",
          "49:       fragment = Loofah.fragment(html)",
          "",
          "[Removed Lines]",
          "23: class SanitizersTest < Minitest::Test",
          "24:   def test_sanitizer_sanitize_raises_not_implemented_error",
          "25:     assert_raises NotImplementedError do",
          "26:       Rails::Html::Sanitizer.new.sanitize(\"asdf\")",
          "27:     end",
          "28:   end",
          "30:   def test_sanitize_nested_script",
          "31:     assert_equal '&lt;script&gt;alert(\"XSS\");&lt;/script&gt;', safe_list_sanitize('<script><script></script>alert(\"XSS\");<script><</script>/</script><script>script></script>', tags: %w(em))",
          "32:   end",
          "34:   def test_sanitize_nested_script_in_style",
          "35:     input = '<style><script></style>alert(\"XSS\");<style><</style>/</style><style>script></style>'",
          "36:     result = safe_list_sanitize(input, tags: %w(em))",
          "37:     acceptable_results = [",
          "38:       # libxml2",
          "39:       %{&lt;script&gt;alert(\"XSS\");&lt;/script&gt;},",
          "40:       # xerces+neko. unavoidable double-escaping, see loofah/docs/2022-10-decision-on-cdata-nodes.md",
          "41:       %{&amp;lt;script&amp;gt;alert(\\\"XSS\\\");&amp;lt;&amp;lt;/style&amp;gt;/script&amp;gt;},",
          "42:     ]",
          "44:     assert_includes(acceptable_results, result)",
          "45:   end",
          "",
          "[Added Lines]",
          "23: module TestRailsSanitizers",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:     end",
          "52:   end",
          "67:     end",
          "93:   end",
          "189:   end",
          "223:   end",
          "283:     end",
          "294:     end",
          "325:     end",
          "332:     end",
          "339:     end",
          "346:     end",
          "385:     end",
          "391:     end",
          "400:     end",
          "456:     end",
          "555:     end",
          "566:     end",
          "631:     end",
          "643:     end",
          "667:       end",
          "668:     end",
          "678:     end",
          "778:       actual = safe_list_sanitize(input)",
          "779:       assert_equal(expected, actual)",
          "783:       actual = safe_list_sanitize(input)",
          "784:       assert_equal(expected, actual)",
          "785:     end",
          "829:     end",
          "946:       end",
          "948:   end",
          "949: end",
          "",
          "[Removed Lines]",
          "54:   def test_remove_xpaths_removes_an_xpath",
          "55:     html = %(<h1>hello <script>code!</script></h1>)",
          "56:     assert_equal %(<h1>hello </h1>), xpath_sanitize(html, xpaths: %w(.//script))",
          "57:   end",
          "59:   def test_remove_xpaths_removes_all_occurrences_of_xpath",
          "60:     html = %(<section><header><script>code!</script></header><p>hello <script>code!</script></p></section>)",
          "61:     assert_equal %(<section><header></header><p>hello </p></section>), xpath_sanitize(html, xpaths: %w(.//script))",
          "62:   end",
          "64:   def test_remove_xpaths_called_with_faulty_xpath",
          "65:     assert_raises Nokogiri::XML::XPath::SyntaxError do",
          "66:       xpath_sanitize(\"<h1>hello<h1>\", xpaths: %w(..faulty_xpath))",
          "68:   end",
          "70:   def test_remove_xpaths_called_with_xpath_string",
          "71:     assert_equal \"\", xpath_sanitize(\"<a></a>\", xpaths: \".//a\")",
          "72:   end",
          "74:   def test_remove_xpaths_called_with_enumerable_xpaths",
          "75:     assert_equal \"\", xpath_sanitize(\"<a><span></span></a>\", xpaths: %w(.//a .//span))",
          "76:   end",
          "78:   def test_strip_tags_with_quote",
          "79:     input = '<\" <img src=\"trollface.gif\" onload=\"alert(1)\"> hi'",
          "80:     result = full_sanitize(input)",
          "81:     acceptable_results = [",
          "82:       # libxml2 >= 2.9.14 and xerces+neko",
          "83:       %{&lt;\"  hi},",
          "84:       # other libxml2",
          "85:       %{ hi},",
          "86:     ]",
          "88:     assert_includes(acceptable_results, result)",
          "89:   end",
          "91:   def test_strip_invalid_html",
          "92:     assert_equal \"&lt;&lt;\", full_sanitize(\"<<<bad html\")",
          "95:   def test_strip_nested_tags",
          "96:     expected = \"Wei&lt;a onclick='alert(document.cookie);'/&gt;rdos\"",
          "97:     input = \"Wei<<a>a onclick='alert(document.cookie);'</a>/>rdos\"",
          "98:     assert_equal expected, full_sanitize(input)",
          "99:   end",
          "101:   def test_strip_tags_multiline",
          "102:     expected = %{This is a test.\\n\\n\\n\\nIt no longer contains any HTML.\\n}",
          "103:     input = %{<h1>This is <b>a <a href=\"\" target=\"_blank\">test</a></b>.</h1>\\n\\n<!-- it has a comment -->\\n\\n<p>It no <b>longer <strong>contains <em>any <strike>HTML</strike></em>.</strong></b></p>\\n}",
          "105:     assert_equal expected, full_sanitize(input)",
          "106:   end",
          "108:   def test_remove_unclosed_tags",
          "109:     input = \"This is <-- not\\n a comment here.\"",
          "110:     result = full_sanitize(input)",
          "111:     acceptable_results = [",
          "112:       # libxml2 >= 2.9.14 and xerces+neko",
          "113:       %{This is &lt;-- not\\n a comment here.},",
          "114:       # other libxml2",
          "115:       %{This is },",
          "116:     ]",
          "118:     assert_includes(acceptable_results, result)",
          "119:   end",
          "121:   def test_strip_cdata",
          "122:     input = \"This has a <![CDATA[<section>]]> here.\"",
          "123:     result = full_sanitize(input)",
          "124:     acceptable_results = [",
          "125:       # libxml2 = 2.9.14",
          "126:       %{This has a &lt;![CDATA[]]&gt; here.},",
          "127:       # other libxml2",
          "128:       %{This has a ]]&gt; here.},",
          "129:       # xerces+neko",
          "130:       %{This has a  here.},",
          "131:     ]",
          "133:     assert_includes(acceptable_results, result)",
          "134:   end",
          "136:   def test_strip_unclosed_cdata",
          "137:     input = \"This has an unclosed <![CDATA[<section>]] here...\"",
          "139:     result = safe_list_sanitize(input)",
          "141:     acceptable_results = [",
          "142:       # libxml2 = 2.9.14",
          "143:       %{This has an unclosed &lt;![CDATA[]] here...},",
          "144:       # other libxml2",
          "145:       %{This has an unclosed ]] here...},",
          "146:       # xerces+neko",
          "147:       %{This has an unclosed }",
          "148:     ]",
          "150:     assert_includes(acceptable_results, result)",
          "151:   end",
          "153:   def test_strip_blank_string",
          "154:     assert_nil full_sanitize(nil)",
          "155:     assert_equal \"\", full_sanitize(\"\")",
          "156:     assert_equal \"   \", full_sanitize(\"   \")",
          "157:   end",
          "159:   def test_strip_tags_with_plaintext",
          "160:     assert_equal \"Don't touch me\", full_sanitize(\"Don't touch me\")",
          "161:   end",
          "163:   def test_strip_tags_with_tags",
          "164:     assert_equal \"This is a test.\", full_sanitize(\"<p>This <u>is<u> a <a href='test.html'><strong>test</strong></a>.</p>\")",
          "165:   end",
          "167:   def test_escape_tags_with_many_open_quotes",
          "168:     assert_equal \"&lt;&lt;\", full_sanitize(\"<<<bad html>\")",
          "169:   end",
          "171:   def test_strip_tags_with_sentence",
          "172:     assert_equal \"This is a test.\", full_sanitize(\"This is a test.\")",
          "173:   end",
          "175:   def test_strip_tags_with_comment",
          "176:     assert_equal \"This has a  here.\", full_sanitize(\"This has a <!-- comment --> here.\")",
          "177:   end",
          "179:   def test_strip_tags_with_frozen_string",
          "180:     assert_equal \"Frozen string with no tags\", full_sanitize(\"Frozen string with no tags\")",
          "181:   end",
          "183:   def test_full_sanitize_respect_html_escaping_of_the_given_string",
          "184:     assert_equal 'test\\r\\nstring', full_sanitize('test\\r\\nstring')",
          "185:     assert_equal \"&amp;\", full_sanitize(\"&\")",
          "186:     assert_equal \"&amp;\", full_sanitize(\"&amp;\")",
          "187:     assert_equal \"&amp;amp;\", full_sanitize(\"&amp;amp;\")",
          "188:     assert_equal \"omg &lt;script&gt;BOM&lt;/script&gt;\", full_sanitize(\"omg &lt;script&gt;BOM&lt;/script&gt;\")",
          "191:   def test_strip_links_with_tags_in_tags",
          "192:     expected = \"&lt;a href='hello'&gt;all <b>day</b> long&lt;/a&gt;\"",
          "193:     input = \"<<a>a href='hello'>all <b>day</b> long<</A>/a>\"",
          "194:     assert_equal expected, link_sanitize(input)",
          "195:   end",
          "197:   def test_strip_links_with_unclosed_tags",
          "198:     assert_equal \"\", link_sanitize(\"<a<a\")",
          "199:   end",
          "201:   def test_strip_links_with_plaintext",
          "202:     assert_equal \"Don't touch me\", link_sanitize(\"Don't touch me\")",
          "203:   end",
          "205:   def test_strip_links_with_line_feed_and_uppercase_tag",
          "206:     assert_equal \"on my mind\\nall day long\", link_sanitize(\"<a href='almost'>on my mind</a>\\n<A href='almost'>all day long</A>\")",
          "207:   end",
          "209:   def test_strip_links_leaves_nonlink_tags",
          "210:     assert_equal \"My mind\\nall <b>day</b> long\", link_sanitize(\"<a href='almost'>My mind</a>\\n<A href='almost'>all <b>day</b> long</A>\")",
          "211:   end",
          "213:   def test_strip_links_with_links",
          "214:     assert_equal \"0wn3d\", link_sanitize(\"<a href='http://www.rubyonrails.com/'><a href='http://www.rubyonrails.com/' onlclick='steal()'>0wn3d</a></a>\")",
          "215:   end",
          "217:   def test_strip_links_with_linkception",
          "218:     assert_equal \"Magic\", link_sanitize(\"<a href='http://www.rubyonrails.com/'>Mag<a href='http://www.ruby-lang.org/'>ic\")",
          "219:   end",
          "221:   def test_sanitize_form",
          "222:     assert_sanitized \"<form action=\\\"/foo/bar\\\" method=\\\"post\\\"><input></form>\", \"\"",
          "225:   def test_sanitize_plaintext",
          "226:     # note that the `plaintext` tag has been deprecated since HTML 2",
          "227:     # https://developer.mozilla.org/en-US/docs/Web/HTML/Element/plaintext",
          "228:     input = \"<plaintext><span>foo</span></plaintext>\"",
          "229:     result = safe_list_sanitize(input)",
          "230:     acceptable_results = [",
          "231:       # libxml2",
          "232:       \"<span>foo</span>\",",
          "233:       # xerces+nekohtml-unit",
          "234:       \"&lt;span&gt;foo&lt;/span&gt;&lt;/plaintext&gt;\",",
          "235:       # xerces+cyberneko",
          "236:       \"&lt;span&gt;foo&lt;/span&gt;\"",
          "237:     ]",
          "239:     assert_includes(acceptable_results, result)",
          "240:   end",
          "242:   def test_sanitize_script",
          "243:     assert_sanitized \"a b c<script language=\\\"Javascript\\\">blah blah blah</script>d e f\", \"a b cblah blah blahd e f\"",
          "244:   end",
          "246:   def test_sanitize_js_handlers",
          "247:     raw = %{onthis=\"do that\" <a href=\"#\" onclick=\"hello\" name=\"foo\" onbogus=\"remove me\">hello</a>}",
          "248:     assert_sanitized raw, %{onthis=\"do that\" <a href=\"#\" name=\"foo\">hello</a>}",
          "249:   end",
          "251:   def test_sanitize_javascript_href",
          "252:     raw = %{href=\"javascript:bang\" <a href=\"javascript:bang\" name=\"hello\">foo</a>, <span href=\"javascript:bang\">bar</span>}",
          "253:     assert_sanitized raw, %{href=\"javascript:bang\" <a name=\"hello\">foo</a>, <span>bar</span>}",
          "254:   end",
          "256:   def test_sanitize_image_src",
          "257:     raw = %{src=\"javascript:bang\" <img src=\"javascript:bang\" width=\"5\">foo</img>, <span src=\"javascript:bang\">bar</span>}",
          "258:     assert_sanitized raw, %{src=\"javascript:bang\" <img width=\"5\">foo, <span>bar</span>}",
          "259:   end",
          "261:   def test_should_allow_anchors",
          "262:     assert_sanitized %(<a href=\"foo\" onclick=\"bar\"><script>baz</script></a>), %(<a href=\\\"foo\\\">baz</a>)",
          "263:   end",
          "265:   def test_video_poster_sanitization",
          "266:     scope_allowed_tags(%w(video)) do",
          "267:       scope_allowed_attributes %w(src poster) do",
          "268:         expected = if RUBY_PLATFORM == \"java\"",
          "269:           # xerces+nekohtml alphabetizes the attributes! FML.",
          "270:           %(<video poster=\"posterimage.jpg\" src=\"videofile.ogg\"></video>)",
          "271:         else",
          "272:           %(<video src=\"videofile.ogg\" poster=\"posterimage.jpg\"></video>)",
          "273:         end",
          "274:         assert_sanitized(",
          "275:           %(<video src=\"videofile.ogg\" autoplay  poster=\"posterimage.jpg\"></video>),",
          "276:           expected,",
          "277:         )",
          "278:         assert_sanitized(",
          "279:           %(<video src=\"videofile.ogg\" poster=javascript:alert(1)></video>),",
          "280:           %(<video src=\"videofile.ogg\"></video>),",
          "281:         )",
          "282:       end",
          "284:   end",
          "286:   # RFC 3986, sec 4.2",
          "287:   def test_allow_colons_in_path_component",
          "288:     assert_sanitized \"<a href=\\\"./this:that\\\">foo</a>\"",
          "289:   end",
          "291:   %w(src width height alt).each do |img_attr|",
          "292:     define_method \"test_should_allow_image_#{img_attr}_attribute\" do",
          "293:       assert_sanitized %(<img #{img_attr}=\"foo\" onclick=\"bar\" />), %(<img #{img_attr}=\"foo\">)",
          "295:   end",
          "297:   def test_lang_and_xml_lang",
          "298:     # https://html.spec.whatwg.org/multipage/dom.html#the-lang-and-xml:lang-attributes",
          "299:     #",
          "300:     # 3.2.6.2 The lang and xml:lang attributes",
          "301:     #",
          "302:     # ... Authors must not use the lang attribute in the XML namespace on HTML elements in HTML",
          "303:     # documents. To ease migration to and from XML, authors may specify an attribute in no namespace",
          "304:     # with no prefix and with the literal localname \"xml:lang\" on HTML elements in HTML documents,",
          "305:     # but such attributes must only be specified if a lang attribute in no namespace is also",
          "306:     # specified, and both attributes must have the same value when compared in an ASCII",
          "307:     # case-insensitive manner.",
          "308:     input = expected = \"<div lang=\\\"en\\\" xml:lang=\\\"en\\\">foo</div>\"",
          "309:     assert_sanitized(input, expected)",
          "310:   end",
          "312:   def test_should_handle_non_html",
          "313:     assert_sanitized \"abc\"",
          "314:   end",
          "316:   def test_should_handle_blank_text",
          "317:     assert_nil(safe_list_sanitize(nil))",
          "318:     assert_equal(\"\", safe_list_sanitize(\"\"))",
          "319:     assert_equal(\"   \", safe_list_sanitize(\"   \"))",
          "320:   end",
          "322:   def test_setting_allowed_tags_affects_sanitization",
          "323:     scope_allowed_tags %w(u) do |sanitizer|",
          "324:       assert_equal \"<u></u>\", sanitizer.sanitize(\"<a><u></u></a>\")",
          "326:   end",
          "328:   def test_setting_allowed_attributes_affects_sanitization",
          "329:     scope_allowed_attributes %w(foo) do |sanitizer|",
          "330:       input = '<a foo=\"hello\" bar=\"world\"></a>'",
          "331:       assert_equal '<a foo=\"hello\"></a>', sanitizer.sanitize(input)",
          "333:   end",
          "335:   def test_custom_tags_overrides_allowed_tags",
          "336:     scope_allowed_tags %(u) do |sanitizer|",
          "337:       input = \"<a><u></u></a>\"",
          "338:       assert_equal \"<a></a>\", sanitizer.sanitize(input, tags: %w(a))",
          "340:   end",
          "342:   def test_custom_attributes_overrides_allowed_attributes",
          "343:     scope_allowed_attributes %(foo) do |sanitizer|",
          "344:       input = '<a foo=\"hello\" bar=\"world\"></a>'",
          "345:       assert_equal '<a bar=\"world\"></a>', sanitizer.sanitize(input, attributes: %w(bar))",
          "347:   end",
          "349:   def test_should_allow_prune",
          "350:     sanitizer = Rails::Html::SafeListSanitizer.new(prune: true)",
          "351:     text = \"<u>leave me <b>now</b></u>\"",
          "352:     assert_equal \"<u>leave me </u>\", sanitizer.sanitize(text, tags: %w(u))",
          "353:   end",
          "355:   def test_should_allow_custom_tags",
          "356:     text = \"<u>foo</u>\"",
          "357:     assert_equal text, safe_list_sanitize(text, tags: %w(u))",
          "358:   end",
          "360:   def test_should_allow_only_custom_tags",
          "361:     text = \"<u>foo</u> with <i>bar</i>\"",
          "362:     assert_equal \"<u>foo</u> with bar\", safe_list_sanitize(text, tags: %w(u))",
          "363:   end",
          "365:   def test_should_allow_custom_tags_with_attributes",
          "366:     text = %(<blockquote cite=\"http://example.com/\">foo</blockquote>)",
          "367:     assert_equal text, safe_list_sanitize(text)",
          "368:   end",
          "370:   def test_should_allow_custom_tags_with_custom_attributes",
          "371:     text = %(<blockquote foo=\"bar\">Lorem ipsum</blockquote>)",
          "372:     assert_equal text, safe_list_sanitize(text, attributes: [\"foo\"])",
          "373:   end",
          "375:   def test_scrub_style_if_style_attribute_option_is_passed",
          "376:     input = '<p style=\"color: #000; background-image: url(http://www.ragingplatypus.com/i/cam-full.jpg);\"></p>'",
          "377:     actual = safe_list_sanitize(input, attributes: %w(style))",
          "379:     assert_includes(['<p style=\"color: #000;\"></p>', '<p style=\"color:#000;\"></p>'], actual)",
          "380:   end",
          "382:   def test_should_raise_argument_error_if_tags_is_not_enumerable",
          "383:     assert_raises ArgumentError do",
          "384:       safe_list_sanitize(\"<a>some html</a>\", tags: \"foo\")",
          "386:   end",
          "388:   def test_should_raise_argument_error_if_attributes_is_not_enumerable",
          "389:     assert_raises ArgumentError do",
          "390:       safe_list_sanitize(\"<a>some html</a>\", attributes: \"foo\")",
          "392:   end",
          "394:   def test_should_not_accept_non_loofah_inheriting_scrubber",
          "395:     scrubber = Object.new",
          "396:     def scrubber.scrub(node); node.name = \"h1\"; end",
          "398:     assert_raises Loofah::ScrubberNotFound do",
          "399:       safe_list_sanitize(\"<a>some html</a>\", scrubber: scrubber)",
          "401:   end",
          "403:   def test_should_accept_loofah_inheriting_scrubber",
          "404:     scrubber = Loofah::Scrubber.new",
          "405:     def scrubber.scrub(node); node.replace(\"<h1>#{node.inner_html}</h1>\"); end",
          "407:     html = \"<script>hello!</script>\"",
          "408:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "409:   end",
          "411:   def test_should_accept_loofah_scrubber_that_wraps_a_block",
          "412:     scrubber = Loofah::Scrubber.new { |node| node.replace(\"<h1>#{node.inner_html}</h1>\") }",
          "413:     html = \"<script>hello!</script>\"",
          "414:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "415:   end",
          "417:   def test_custom_scrubber_takes_precedence_over_other_options",
          "418:     scrubber = Loofah::Scrubber.new { |node| node.replace(\"<h1>#{node.inner_html}</h1>\") }",
          "419:     html = \"<script>hello!</script>\"",
          "420:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber, tags: [\"foo\"])",
          "421:   end",
          "423:   def test_should_strip_src_attribute_in_img_with_bad_protocols",
          "424:     assert_sanitized %(<img src=\"javascript:bang\" title=\"1\">), %(<img title=\"1\">)",
          "425:   end",
          "427:   def test_should_strip_href_attribute_in_a_with_bad_protocols",
          "428:     assert_sanitized %(<a href=\"javascript:bang\" title=\"1\">boo</a>), %(<a title=\"1\">boo</a>)",
          "429:   end",
          "431:   def test_should_block_script_tag",
          "432:     assert_sanitized %(<SCRIPT\\nSRC=http://ha.ckers.org/xss.js></SCRIPT>), \"\"",
          "433:   end",
          "435:   def test_should_not_fall_for_xss_image_hack_with_uppercase_tags",
          "436:     assert_sanitized %(<IMG \"\"\"><SCRIPT>alert(\"XSS\")</SCRIPT>\">), %(<img>alert(\"XSS\")\"&gt;)",
          "437:   end",
          "439:   [%(<IMG SRC=\"javascript:alert('XSS');\">),",
          "440:    %(<IMG SRC=javascript:alert('XSS')>),",
          "441:    %(<IMG SRC=JaVaScRiPt:alert('XSS')>),",
          "442:    %(<IMG SRC=javascript:alert(&quot;XSS&quot;)>),",
          "443:    %(<IMG SRC=javascript:alert(String.fromCharCode(88,83,83))>),",
          "444:    %(<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>),",
          "445:    %(<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>),",
          "446:    %(<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>),",
          "447:    %(<IMG SRC=\"jav\\tascript:alert('XSS');\">),",
          "448:    %(<IMG SRC=\"jav&#x09;ascript:alert('XSS');\">),",
          "449:    %(<IMG SRC=\"jav&#x0A;ascript:alert('XSS');\">),",
          "450:    %(<IMG SRC=\"jav&#x0D;ascript:alert('XSS');\">),",
          "451:    %(<IMG SRC=\" &#14;  javascript:alert('XSS');\">),",
          "452:    %(<IMG SRC=\"javascript&#x3a;alert('XSS');\">),",
          "453:    %(<IMG SRC=`javascript:alert(\"RSnake says, 'XSS'\")`>)].each do |img_hack|",
          "454:     define_method \"test_should_not_fall_for_xss_image_hack_#{img_hack}\" do",
          "455:       assert_sanitized img_hack, \"<img>\"",
          "457:   end",
          "459:   def test_should_sanitize_tag_broken_up_by_null",
          "460:     input = %(<SCR\\0IPT>alert(\\\"XSS\\\")</SCR\\0IPT>)",
          "461:     result = safe_list_sanitize(input)",
          "462:     acceptable_results = [",
          "463:       # libxml2",
          "464:       \"\",",
          "465:       # xerces+neko",
          "466:       'alert(\"XSS\")',",
          "467:     ]",
          "469:     assert_includes(acceptable_results, result)",
          "470:   end",
          "472:   def test_should_sanitize_invalid_script_tag",
          "473:     assert_sanitized %(<SCRIPT/XSS SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>), \"\"",
          "474:   end",
          "476:   def test_should_sanitize_script_tag_with_multiple_open_brackets",
          "477:     assert_sanitized %(<<SCRIPT>alert(\"XSS\");//<</SCRIPT>), \"&lt;alert(\\\"XSS\\\");//&lt;\"",
          "478:   end",
          "480:   def test_should_sanitize_script_tag_with_multiple_open_brackets_2",
          "481:     input = %(<iframe src=http://ha.ckers.org/scriptlet.html\\n<a)",
          "482:     result = safe_list_sanitize(input)",
          "483:     acceptable_results = [",
          "484:       # libxml2",
          "485:       \"\",",
          "486:       # xerces+neko",
          "487:       \"&lt;a\",",
          "488:     ]",
          "490:     assert_includes(acceptable_results, result)",
          "491:   end",
          "493:   def test_should_sanitize_unclosed_script",
          "494:     assert_sanitized %(<SCRIPT SRC=http://ha.ckers.org/xss.js?<B>), \"\"",
          "495:   end",
          "497:   def test_should_sanitize_half_open_scripts",
          "498:     assert_sanitized %(<IMG SRC=\"javascript:alert('XSS')\"), \"<img>\"",
          "499:   end",
          "501:   def test_should_not_fall_for_ridiculous_hack",
          "502:     img_hack = %(<IMG\\nSRC\\n=\\n\"\\nj\\na\\nv\\na\\ns\\nc\\nr\\ni\\np\\nt\\n:\\na\\nl\\ne\\nr\\nt\\n(\\n'\\nX\\nS\\nS\\n'\\n)\\n\"\\n>)",
          "503:     assert_sanitized img_hack, \"<img>\"",
          "504:   end",
          "506:   def test_should_sanitize_attributes",
          "507:     assert_sanitized(",
          "508:       %(<SPAN title=\"'><script>alert()</script>\">blah</SPAN>),",
          "509:       %(<span title=\"'&gt;&lt;script&gt;alert()&lt;/script&gt;\">blah</span>),",
          "510:     )",
          "511:   end",
          "513:   def test_should_sanitize_illegal_style_properties",
          "514:     raw      = %(display:block; position:absolute; left:0; top:0; width:100%; height:100%; z-index:1; background-color:black; background-image:url(http://www.ragingplatypus.com/i/cam-full.jpg); background-x:center; background-y:center; background-repeat:repeat;)",
          "515:     expected = %(display:block;width:100%;height:100%;background-color:black;background-x:center;background-y:center;)",
          "516:     assert_equal expected, sanitize_css(raw)",
          "517:   end",
          "519:   def test_should_sanitize_with_trailing_space",
          "520:     raw = \"display:block; \"",
          "521:     expected = \"display:block;\"",
          "522:     assert_equal expected, sanitize_css(raw)",
          "523:   end",
          "525:   def test_should_sanitize_xul_style_attributes",
          "526:     raw = %(-moz-binding:url('http://ha.ckers.org/xssmoz.xml#xss'))",
          "527:     assert_equal \"\", sanitize_css(raw)",
          "528:   end",
          "530:   def test_should_sanitize_invalid_tag_names",
          "531:     assert_sanitized(%(a b c<script/XSS src=\"http://ha.ckers.org/xss.js\"></script>d e f), \"a b cd e f\")",
          "532:   end",
          "534:   def test_should_sanitize_non_alpha_and_non_digit_characters_in_tags",
          "535:     assert_sanitized('<a onclick!#$%&()*~+-_.,:;?@[/|\\]^`=alert(\"XSS\")>foo</a>', \"<a>foo</a>\")",
          "536:   end",
          "538:   def test_should_sanitize_invalid_tag_names_in_single_tags",
          "539:     assert_sanitized('<img/src=\"http://ha.ckers.org/xss.js\"/>', \"<img>\")",
          "540:   end",
          "542:   def test_should_sanitize_img_dynsrc_lowsrc",
          "543:     assert_sanitized(%(<img lowsrc=\"javascript:alert('XSS')\" />), \"<img>\")",
          "544:   end",
          "546:   def test_should_sanitize_div_background_image_unicode_encoded",
          "547:     [",
          "548:       convert_to_css_hex(\"url(javascript:alert(1))\", false),",
          "549:       convert_to_css_hex(\"url(javascript:alert(1))\", true),",
          "550:       convert_to_css_hex(\"url(https://example.com)\", false),",
          "551:       convert_to_css_hex(\"url(https://example.com)\", true),",
          "552:     ].each do |propval|",
          "553:       raw = \"background-image:\" + propval",
          "554:       assert_empty(sanitize_css(raw))",
          "556:   end",
          "558:   def test_should_allow_div_background_image_unicode_encoded_safe_functions",
          "559:     [",
          "560:       convert_to_css_hex(\"rgb(255,0,0)\", false),",
          "561:       convert_to_css_hex(\"rgb(255,0,0)\", true),",
          "562:     ].each do |propval|",
          "563:       raw = \"background-image:\" + propval",
          "565:       assert_includes(sanitize_css(raw), \"background-image\")",
          "567:   end",
          "569:   def test_should_sanitize_div_style_expression",
          "570:     raw = %(width: expression(alert('XSS'));)",
          "571:     assert_equal \"\", sanitize_css(raw)",
          "572:   end",
          "574:   def test_should_sanitize_across_newlines",
          "575:     raw = %(\\nwidth:\\nexpression(alert('XSS'));\\n)",
          "576:     assert_equal \"\", sanitize_css(raw)",
          "577:   end",
          "579:   def test_should_sanitize_img_vbscript",
          "580:     assert_sanitized %(<img src='vbscript:msgbox(\"XSS\")' />), \"<img>\"",
          "581:   end",
          "583:   def test_should_sanitize_cdata_section",
          "584:     input = \"<![CDATA[<span>section</span>]]>\"",
          "585:     result = safe_list_sanitize(input)",
          "586:     acceptable_results = [",
          "587:       # libxml2 = 2.9.14",
          "588:       %{&lt;![CDATA[<span>section</span>]]&gt;},",
          "589:       # other libxml2",
          "590:       %{section]]&gt;},",
          "591:       # xerces+neko",
          "592:       \"\",",
          "593:     ]",
          "595:     assert_includes(acceptable_results, result)",
          "596:   end",
          "598:   def test_should_sanitize_unterminated_cdata_section",
          "599:     input = \"<![CDATA[<span>neverending...\"",
          "600:     result = safe_list_sanitize(input)",
          "602:     acceptable_results = [",
          "603:       # libxml2 = 2.9.14",
          "604:       %{&lt;![CDATA[<span>neverending...</span>},",
          "605:       # other libxml2",
          "606:       %{neverending...},",
          "607:       # xerces+neko",
          "608:       \"\"",
          "609:     ]",
          "611:     assert_includes(acceptable_results, result)",
          "612:   end",
          "614:   def test_should_not_mangle_urls_with_ampersand",
          "615:     assert_sanitized %{<a href=\\\"http://www.domain.com?var1=1&amp;var2=2\\\">my link</a>}",
          "616:   end",
          "618:   def test_should_sanitize_neverending_attribute",
          "619:     # note that assert_dom_equal chokes in this case! so avoid using assert_sanitized",
          "620:     assert_equal(\"<span class=\\\"\\\\\\\"></span>\", safe_list_sanitize(\"<span class=\\\"\\\\\\\">\"))",
          "621:   end",
          "623:   [",
          "624:     %(<a href=\"javascript&#x3a;alert('XSS');\">),",
          "625:     %(<a href=\"javascript&#x003a;alert('XSS');\">),",
          "626:     %(<a href=\"javascript&#x3A;alert('XSS');\">),",
          "627:     %(<a href=\"javascript&#x003A;alert('XSS');\">)",
          "628:   ].each_with_index do |enc_hack, i|",
          "629:     define_method \"test_x03a_handling_#{i + 1}\" do",
          "630:       assert_sanitized enc_hack, \"<a></a>\"",
          "632:   end",
          "634:   def test_x03a_legitimate",
          "635:     assert_sanitized %(<a href=\"http&#x3a;//legit\">asdf</a>), %(<a href=\"http://legit\">asdf</a>)",
          "636:     assert_sanitized %(<a href=\"http&#x3A;//legit\">asdf</a>), %(<a href=\"http://legit\">asdf</a>)",
          "637:   end",
          "639:   def test_sanitize_ascii_8bit_string",
          "640:     safe_list_sanitize(\"<a>hello</a>\".encode(\"ASCII-8BIT\")).tap do |sanitized|",
          "641:       assert_equal \"<a>hello</a>\", sanitized",
          "642:       assert_equal Encoding::UTF_8, sanitized.encoding",
          "644:   end",
          "646:   def test_sanitize_data_attributes",
          "647:     assert_sanitized %(<a href=\"/blah\" data-method=\"post\">foo</a>), %(<a href=\"/blah\">foo</a>)",
          "648:     assert_sanitized %(<a data-remote=\"true\" data-type=\"script\" data-method=\"get\" data-cross-domain=\"true\" href=\"attack.js\">Launch the missiles</a>), %(<a href=\"attack.js\">Launch the missiles</a>)",
          "649:   end",
          "651:   def test_allow_data_attribute_if_requested",
          "652:     text = %(<a data-foo=\"foo\">foo</a>)",
          "653:     assert_equal %(<a data-foo=\"foo\">foo</a>), safe_list_sanitize(text, attributes: [\"data-foo\"])",
          "654:   end",
          "656:   # https://developer.mozilla.org/en-US/docs/Glossary/Void_element",
          "657:   VOID_ELEMENTS = %w[area base br col embed hr img input keygen link meta param source track wbr]",
          "659:   %w(strong em b i p code pre tt samp kbd var sub",
          "660:      sup dfn cite big small address hr br div span h1 h2 h3 h4 h5 h6 ul ol li dl dt dd abbr",
          "661:      acronym a img blockquote del ins time).each do |tag_name|",
          "662:     define_method \"test_default_safelist_should_allow_#{tag_name}\" do",
          "663:       if VOID_ELEMENTS.include?(tag_name)",
          "664:         assert_sanitized(\"<#{tag_name}>\")",
          "665:       else",
          "666:         assert_sanitized(\"<#{tag_name}>foo</#{tag_name}>\")",
          "669:   end",
          "671:   def test_datetime_attribute",
          "672:     assert_sanitized(\"<time datetime=\\\"2023-01-01\\\">Today</time>\")",
          "673:   end",
          "675:   def test_abbr_attribute",
          "676:     scope_allowed_tags(%w(table tr th td)) do",
          "677:       assert_sanitized(%(<table><tr><td abbr=\"UK\">United Kingdom</td></tr></table>))",
          "679:   end",
          "681:   def test_uri_escaping_of_href_attr_in_a_tag_in_safe_list_sanitizer",
          "682:     skip if RUBY_VERSION < \"2.3\"",
          "684:     html = %{<a href='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "686:     text = safe_list_sanitize(html)",
          "688:     acceptable_results = [",
          "689:       # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "690:       %{<a href=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "691:       # system libxml2",
          "692:       %{<a href=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "693:       # xerces+neko",
          "694:       %{<a href=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "695:     ]",
          "697:     assert_includes(acceptable_results, text)",
          "698:   end",
          "700:   def test_uri_escaping_of_src_attr_in_a_tag_in_safe_list_sanitizer",
          "701:     skip if RUBY_VERSION < \"2.3\"",
          "703:     html = %{<a src='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "705:     text = safe_list_sanitize(html)",
          "707:     acceptable_results = [",
          "708:       # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "709:       %{<a src=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "710:       # system libxml2",
          "711:       %{<a src=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "712:       # xerces+neko",
          "713:       %{<a src=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "714:     ]",
          "716:     assert_includes(acceptable_results, text)",
          "717:   end",
          "719:   def test_uri_escaping_of_name_attr_in_a_tag_in_safe_list_sanitizer",
          "720:     skip if RUBY_VERSION < \"2.3\"",
          "722:     html = %{<a name='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "724:     text = safe_list_sanitize(html)",
          "726:     acceptable_results = [",
          "727:       # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "728:       %{<a name=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "729:       # system libxml2",
          "730:       %{<a name=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "731:       # xerces+neko",
          "732:       %{<a name=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "733:     ]",
          "735:     assert_includes(acceptable_results, text)",
          "736:   end",
          "738:   def test_uri_escaping_of_name_action_in_a_tag_in_safe_list_sanitizer",
          "739:     skip if RUBY_VERSION < \"2.3\"",
          "741:     html = %{<a action='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "743:     text = safe_list_sanitize(html, attributes: [\"action\"])",
          "745:     acceptable_results = [",
          "746:       # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "747:       %{<a action=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "748:       # system libxml2",
          "749:       %{<a action=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "750:       # xerces+neko",
          "751:       %{<a action=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "752:     ]",
          "754:     assert_includes(acceptable_results, text)",
          "755:   end",
          "757:   def test_exclude_node_type_processing_instructions",
          "758:     input = \"<div>text</div><?div content><b>text</b>\"",
          "759:     result = safe_list_sanitize(input)",
          "760:     acceptable_results = [",
          "761:       # jruby cyberneko (nokogiri < 1.14.0)",
          "762:       \"<div>text</div>\",",
          "763:       # everything else",
          "764:       \"<div>text</div><b>text</b>\",",
          "765:     ]",
          "767:     assert_includes(acceptable_results, result)",
          "768:   end",
          "770:   def test_exclude_node_type_comment",
          "771:     assert_equal(\"<div>text</div><b>text</b>\", safe_list_sanitize(\"<div>text</div><!-- comment --><b>text</b>\"))",
          "772:   end",
          "774:   %w[text/plain text/css image/png image/gif image/jpeg].each do |mediatype|",
          "775:     define_method \"test_mediatype_#{mediatype}_allowed\" do",
          "776:       input = %Q(<img src=\"data:#{mediatype};base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "777:       expected = input",
          "781:       input = %Q(<img src=\"DATA:#{mediatype};base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "782:       expected = input",
          "786:   end",
          "788:   def test_mediatype_text_html_disallowed",
          "789:     input = '<img src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "790:     expected = \"<img>\"",
          "791:     actual = safe_list_sanitize(input)",
          "792:     assert_equal(expected, actual)",
          "794:     input = '<img src=\"DATA:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "795:     expected = \"<img>\"",
          "796:     actual = safe_list_sanitize(input)",
          "797:     assert_equal(expected, actual)",
          "798:   end",
          "800:   def test_mediatype_image_svg_xml_disallowed",
          "801:     input = '<img src=\"data:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "802:     expected = \"<img>\"",
          "803:     actual = safe_list_sanitize(input)",
          "804:     assert_equal(expected, actual)",
          "806:     input = '<img src=\"DATA:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "807:     expected = \"<img>\"",
          "808:     actual = safe_list_sanitize(input)",
          "809:     assert_equal(expected, actual)",
          "810:   end",
          "812:   def test_mediatype_other_disallowed",
          "813:     input = '<a href=\"data:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "814:     expected = \"<a>foo</a>\"",
          "815:     actual = safe_list_sanitize(input)",
          "816:     assert_equal(expected, actual)",
          "818:     input = '<a href=\"DATA:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "819:     expected = \"<a>foo</a>\"",
          "820:     actual = safe_list_sanitize(input)",
          "821:     assert_equal(expected, actual)",
          "822:   end",
          "824:   def test_scrubbing_svg_attr_values_that_allow_ref",
          "825:     input = '<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>'",
          "826:     expected = '<div fill=\"yellow #fff\">hey</div>'",
          "827:     actual = scope_allowed_attributes %w(fill) do",
          "828:       safe_list_sanitize(input)",
          "831:     assert_equal(expected, actual)",
          "832:   end",
          "834:   def test_style_with_css_payload",
          "835:     input, tags = \"<style>div > span { background: \\\"red\\\"; }</style>\", [\"style\"]",
          "836:     expected = \"<style>div &gt; span { background: \\\"red\\\"; }</style>\"",
          "837:     actual = safe_list_sanitize(input, tags: tags)",
          "839:     assert_equal(expected, actual)",
          "840:   end",
          "842:   def test_combination_of_select_and_style_with_css_payload",
          "843:     input, tags = \"<select><style>div > span { background: \\\"red\\\"; }</style></select>\", [\"select\", \"style\"]",
          "844:     expected = \"<select><style>div &gt; span { background: \\\"red\\\"; }</style></select>\"",
          "845:     actual = safe_list_sanitize(input, tags: tags)",
          "847:     assert_equal(expected, actual)",
          "848:   end",
          "850:   def test_combination_of_select_and_style_with_script_payload",
          "851:     input, tags = \"<select><style><script>alert(1)</script></style></select>\", [\"select\", \"style\"]",
          "852:     expected = \"<select><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></select>\"",
          "853:     actual = safe_list_sanitize(input, tags: tags)",
          "855:     assert_equal(expected, actual)",
          "856:   end",
          "858:   def test_combination_of_svg_and_style_with_script_payload",
          "859:     input, tags = \"<svg><style><script>alert(1)</script></style></svg>\", [\"svg\", \"style\"]",
          "860:     expected = \"<svg><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></svg>\"",
          "861:     actual = safe_list_sanitize(input, tags: tags)",
          "863:     assert_equal(expected, actual)",
          "864:   end",
          "866:   def test_combination_of_math_and_style_with_img_payload",
          "867:     input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\"]",
          "868:     expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "869:     actual = safe_list_sanitize(input, tags: tags)",
          "871:     assert_equal(expected, actual)",
          "872:   end",
          "874:   def test_combination_of_math_and_style_with_img_payload_2",
          "875:     input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\", \"img\"]",
          "876:     expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "877:     actual = safe_list_sanitize(input, tags: tags)",
          "879:     assert_equal(expected, actual)",
          "880:   end",
          "882:   def test_combination_of_svg_and_style_with_img_payload",
          "883:     input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\"]",
          "884:     expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "885:     actual = safe_list_sanitize(input, tags: tags)",
          "887:     assert_equal(expected, actual)",
          "888:   end",
          "890:   def test_combination_of_svg_and_style_with_img_payload_2",
          "891:     input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\", \"img\"]",
          "892:     expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "893:     actual = safe_list_sanitize(input, tags: tags)",
          "895:     assert_equal(expected, actual)",
          "896:   end",
          "898: protected",
          "899:   def xpath_sanitize(input, options = {})",
          "900:     XpathRemovalTestSanitizer.new.sanitize(input, options)",
          "901:   end",
          "903:   def full_sanitize(input, options = {})",
          "904:     Rails::Html::FullSanitizer.new.sanitize(input, options)",
          "905:   end",
          "907:   def link_sanitize(input, options = {})",
          "908:     Rails::Html::LinkSanitizer.new.sanitize(input, options)",
          "909:   end",
          "911:   def safe_list_sanitize(input, options = {})",
          "912:     Rails::Html::SafeListSanitizer.new.sanitize(input, options)",
          "913:   end",
          "915:   def assert_sanitized(input, expected = nil)",
          "916:     assert_equal((expected || input), safe_list_sanitize(input))",
          "917:   end",
          "919:   def sanitize_css(input)",
          "920:     Rails::Html::SafeListSanitizer.new.sanitize_css(input)",
          "921:   end",
          "923:   def scope_allowed_tags(tags)",
          "924:     old_tags = Rails::Html::SafeListSanitizer.allowed_tags",
          "925:     Rails::Html::SafeListSanitizer.allowed_tags = tags",
          "926:     yield Rails::Html::SafeListSanitizer.new",
          "927:   ensure",
          "928:     Rails::Html::SafeListSanitizer.allowed_tags = old_tags",
          "929:   end",
          "931:   def scope_allowed_attributes(attributes)",
          "932:     old_attributes = Rails::Html::SafeListSanitizer.allowed_attributes",
          "933:     Rails::Html::SafeListSanitizer.allowed_attributes = attributes",
          "934:     yield Rails::Html::SafeListSanitizer.new",
          "935:   ensure",
          "936:     Rails::Html::SafeListSanitizer.allowed_attributes = old_attributes",
          "937:   end",
          "939:   # note that this is used for testing CSS hex encoding: \\\\[0-9a-f]{1,6}",
          "940:   def convert_to_css_hex(string, escape_parens = false)",
          "941:     string.chars.map do |c|",
          "942:       if !escape_parens && (c == \"(\" || c == \")\")",
          "943:         c",
          "944:       else",
          "945:         format('\\00%02X', c.ord)",
          "947:     end.join",
          "",
          "[Added Lines]",
          "31:   class BaseSanitizerTest < Minitest::Test",
          "32:     def test_sanitizer_sanitize_raises_not_implemented_error",
          "33:       assert_raises NotImplementedError do",
          "34:         Rails::Html::Sanitizer.new.sanitize(\"asdf\")",
          "35:       end",
          "36:     end",
          "38:     def test_remove_xpaths_removes_an_xpath",
          "39:       html = %(<h1>hello <script>code!</script></h1>)",
          "40:       assert_equal %(<h1>hello </h1>), xpath_sanitize(html, xpaths: %w(.//script))",
          "41:     end",
          "43:     def test_remove_xpaths_removes_all_occurrences_of_xpath",
          "44:       html = %(<section><header><script>code!</script></header><p>hello <script>code!</script></p></section>)",
          "45:       assert_equal %(<section><header></header><p>hello </p></section>), xpath_sanitize(html, xpaths: %w(.//script))",
          "48:     def test_remove_xpaths_called_with_faulty_xpath",
          "49:       assert_raises Nokogiri::XML::XPath::SyntaxError do",
          "50:         xpath_sanitize(\"<h1>hello<h1>\", xpaths: %w(..faulty_xpath))",
          "51:       end",
          "52:     end",
          "54:     def test_remove_xpaths_called_with_xpath_string",
          "55:       assert_equal \"\", xpath_sanitize(\"<a></a>\", xpaths: \".//a\")",
          "56:     end",
          "58:     def test_remove_xpaths_called_with_enumerable_xpaths",
          "59:       assert_equal \"\", xpath_sanitize(\"<a><span></span></a>\", xpaths: %w(.//a .//span))",
          "60:     end",
          "62:     protected",
          "63:       def xpath_sanitize(input, options = {})",
          "64:         XpathRemovalTestSanitizer.new.sanitize(input, options)",
          "65:       end",
          "68:   class FullSanitizerTest < Minitest::Test",
          "69:     def test_strip_tags_with_quote",
          "70:       input = '<\" <img src=\"trollface.gif\" onload=\"alert(1)\"> hi'",
          "71:       result = full_sanitize(input)",
          "72:       acceptable_results = [",
          "73:         # libxml2 >= 2.9.14 and xerces+neko",
          "74:         %{&lt;\"  hi},",
          "75:         # other libxml2",
          "76:         %{ hi},",
          "77:       ]",
          "79:       assert_includes(acceptable_results, result)",
          "80:     end",
          "82:     def test_strip_invalid_html",
          "83:       assert_equal \"&lt;&lt;\", full_sanitize(\"<<<bad html\")",
          "84:     end",
          "86:     def test_strip_nested_tags",
          "87:       expected = \"Wei&lt;a onclick='alert(document.cookie);'/&gt;rdos\"",
          "88:       input = \"Wei<<a>a onclick='alert(document.cookie);'</a>/>rdos\"",
          "89:       assert_equal expected, full_sanitize(input)",
          "90:     end",
          "92:     def test_strip_tags_multiline",
          "93:       expected = %{This is a test.\\n\\n\\n\\nIt no longer contains any HTML.\\n}",
          "94:       input = %{<h1>This is <b>a <a href=\"\" target=\"_blank\">test</a></b>.</h1>\\n\\n<!-- it has a comment -->\\n\\n<p>It no <b>longer <strong>contains <em>any <strike>HTML</strike></em>.</strong></b></p>\\n}",
          "96:       assert_equal expected, full_sanitize(input)",
          "97:     end",
          "99:     def test_remove_unclosed_tags",
          "100:       input = \"This is <-- not\\n a comment here.\"",
          "101:       result = full_sanitize(input)",
          "102:       acceptable_results = [",
          "103:         # libxml2 >= 2.9.14 and xerces+neko",
          "104:         %{This is &lt;-- not\\n a comment here.},",
          "105:         # other libxml2",
          "106:         %{This is },",
          "107:       ]",
          "109:       assert_includes(acceptable_results, result)",
          "110:     end",
          "112:     def test_strip_cdata",
          "113:       input = \"This has a <![CDATA[<section>]]> here.\"",
          "114:       result = full_sanitize(input)",
          "115:       acceptable_results = [",
          "116:         # libxml2 = 2.9.14",
          "117:         %{This has a &lt;![CDATA[]]&gt; here.},",
          "118:         # other libxml2",
          "119:         %{This has a ]]&gt; here.},",
          "120:         # xerces+neko",
          "121:         %{This has a  here.},",
          "122:       ]",
          "124:       assert_includes(acceptable_results, result)",
          "125:     end",
          "127:     def test_strip_blank_string",
          "128:       assert_nil full_sanitize(nil)",
          "129:       assert_equal \"\", full_sanitize(\"\")",
          "130:       assert_equal \"   \", full_sanitize(\"   \")",
          "131:     end",
          "133:     def test_strip_tags_with_plaintext",
          "134:       assert_equal \"Don't touch me\", full_sanitize(\"Don't touch me\")",
          "135:     end",
          "137:     def test_strip_tags_with_tags",
          "138:       assert_equal \"This is a test.\", full_sanitize(\"<p>This <u>is<u> a <a href='test.html'><strong>test</strong></a>.</p>\")",
          "139:     end",
          "141:     def test_escape_tags_with_many_open_quotes",
          "142:       assert_equal \"&lt;&lt;\", full_sanitize(\"<<<bad html>\")",
          "143:     end",
          "145:     def test_strip_tags_with_sentence",
          "146:       assert_equal \"This is a test.\", full_sanitize(\"This is a test.\")",
          "147:     end",
          "149:     def test_strip_tags_with_comment",
          "150:       assert_equal \"This has a  here.\", full_sanitize(\"This has a <!-- comment --> here.\")",
          "151:     end",
          "153:     def test_strip_tags_with_frozen_string",
          "154:       assert_equal \"Frozen string with no tags\", full_sanitize(\"Frozen string with no tags\")",
          "155:     end",
          "157:     def test_full_sanitize_respect_html_escaping_of_the_given_string",
          "158:       assert_equal 'test\\r\\nstring', full_sanitize('test\\r\\nstring')",
          "159:       assert_equal \"&amp;\", full_sanitize(\"&\")",
          "160:       assert_equal \"&amp;\", full_sanitize(\"&amp;\")",
          "161:       assert_equal \"&amp;amp;\", full_sanitize(\"&amp;amp;\")",
          "162:       assert_equal \"omg &lt;script&gt;BOM&lt;/script&gt;\", full_sanitize(\"omg &lt;script&gt;BOM&lt;/script&gt;\")",
          "163:     end",
          "165:     protected",
          "166:       def full_sanitize(input, options = {})",
          "167:         Rails::Html::FullSanitizer.new.sanitize(input, options)",
          "168:       end",
          "171:   class LinkSanitizerTest < Minitest::Test",
          "172:     def test_strip_links_with_tags_in_tags",
          "173:       expected = \"&lt;a href='hello'&gt;all <b>day</b> long&lt;/a&gt;\"",
          "174:       input = \"<<a>a href='hello'>all <b>day</b> long<</A>/a>\"",
          "175:       assert_equal expected, link_sanitize(input)",
          "176:     end",
          "178:     def test_strip_links_with_unclosed_tags",
          "179:       assert_equal \"\", link_sanitize(\"<a<a\")",
          "180:     end",
          "182:     def test_strip_links_with_plaintext",
          "183:       assert_equal \"Don't touch me\", link_sanitize(\"Don't touch me\")",
          "184:     end",
          "186:     def test_strip_links_with_line_feed_and_uppercase_tag",
          "187:       assert_equal \"on my mind\\nall day long\", link_sanitize(\"<a href='almost'>on my mind</a>\\n<A href='almost'>all day long</A>\")",
          "188:     end",
          "190:     def test_strip_links_leaves_nonlink_tags",
          "191:       assert_equal \"My mind\\nall <b>day</b> long\", link_sanitize(\"<a href='almost'>My mind</a>\\n<A href='almost'>all <b>day</b> long</A>\")",
          "192:     end",
          "194:     def test_strip_links_with_links",
          "195:       assert_equal \"0wn3d\", link_sanitize(\"<a href='http://www.rubyonrails.com/'><a href='http://www.rubyonrails.com/' onlclick='steal()'>0wn3d</a></a>\")",
          "196:     end",
          "198:     def test_strip_links_with_linkception",
          "199:       assert_equal \"Magic\", link_sanitize(\"<a href='http://www.rubyonrails.com/'>Mag<a href='http://www.ruby-lang.org/'>ic\")",
          "200:     end",
          "202:     protected",
          "203:       def link_sanitize(input, options = {})",
          "204:         Rails::Html::LinkSanitizer.new.sanitize(input, options)",
          "205:       end",
          "208:   class SafeListSanitizerTest < Minitest::Test",
          "209:     def test_sanitize_nested_script",
          "210:       assert_equal '&lt;script&gt;alert(\"XSS\");&lt;/script&gt;', safe_list_sanitize('<script><script></script>alert(\"XSS\");<script><</script>/</script><script>script></script>', tags: %w(em))",
          "211:     end",
          "213:     def test_sanitize_nested_script_in_style",
          "214:       input = '<style><script></style>alert(\"XSS\");<style><</style>/</style><style>script></style>'",
          "215:       result = safe_list_sanitize(input, tags: %w(em))",
          "216:       acceptable_results = [",
          "217:         # libxml2",
          "218:         %{&lt;script&gt;alert(\"XSS\");&lt;/script&gt;},",
          "219:         # xerces+neko. unavoidable double-escaping, see loofah/docs/2022-10-decision-on-cdata-nodes.md",
          "220:         %{&amp;lt;script&amp;gt;alert(\\\"XSS\\\");&amp;lt;&amp;lt;/style&amp;gt;/script&amp;gt;},",
          "221:       ]",
          "223:       assert_includes(acceptable_results, result)",
          "224:     end",
          "226:     def test_strip_unclosed_cdata",
          "227:       input = \"This has an unclosed <![CDATA[<section>]] here...\"",
          "229:       result = safe_list_sanitize(input)",
          "231:       acceptable_results = [",
          "232:         # libxml2 = 2.9.14",
          "233:         %{This has an unclosed &lt;![CDATA[]] here...},",
          "234:         # other libxml2",
          "235:         %{This has an unclosed ]] here...},",
          "236:         # xerces+neko",
          "237:         %{This has an unclosed }",
          "238:       ]",
          "240:       assert_includes(acceptable_results, result)",
          "241:     end",
          "243:     def test_sanitize_form",
          "244:       assert_sanitized \"<form action=\\\"/foo/bar\\\" method=\\\"post\\\"><input></form>\", \"\"",
          "247:     def test_sanitize_plaintext",
          "248:       # note that the `plaintext` tag has been deprecated since HTML 2",
          "249:       # https://developer.mozilla.org/en-US/docs/Web/HTML/Element/plaintext",
          "250:       input = \"<plaintext><span>foo</span></plaintext>\"",
          "251:       result = safe_list_sanitize(input)",
          "252:       acceptable_results = [",
          "253:         # libxml2",
          "254:         \"<span>foo</span>\",",
          "255:         # xerces+nekohtml-unit",
          "256:         \"&lt;span&gt;foo&lt;/span&gt;&lt;/plaintext&gt;\",",
          "257:         # xerces+cyberneko",
          "258:         \"&lt;span&gt;foo&lt;/span&gt;\"",
          "259:       ]",
          "261:       assert_includes(acceptable_results, result)",
          "262:     end",
          "264:     def test_sanitize_script",
          "265:       assert_sanitized \"a b c<script language=\\\"Javascript\\\">blah blah blah</script>d e f\", \"a b cblah blah blahd e f\"",
          "268:     def test_sanitize_js_handlers",
          "269:       raw = %{onthis=\"do that\" <a href=\"#\" onclick=\"hello\" name=\"foo\" onbogus=\"remove me\">hello</a>}",
          "270:       assert_sanitized raw, %{onthis=\"do that\" <a href=\"#\" name=\"foo\">hello</a>}",
          "271:     end",
          "273:     def test_sanitize_javascript_href",
          "274:       raw = %{href=\"javascript:bang\" <a href=\"javascript:bang\" name=\"hello\">foo</a>, <span href=\"javascript:bang\">bar</span>}",
          "275:       assert_sanitized raw, %{href=\"javascript:bang\" <a name=\"hello\">foo</a>, <span>bar</span>}",
          "276:     end",
          "278:     def test_sanitize_image_src",
          "279:       raw = %{src=\"javascript:bang\" <img src=\"javascript:bang\" width=\"5\">foo</img>, <span src=\"javascript:bang\">bar</span>}",
          "280:       assert_sanitized raw, %{src=\"javascript:bang\" <img width=\"5\">foo, <span>bar</span>}",
          "281:     end",
          "283:     def test_should_allow_anchors",
          "284:       assert_sanitized %(<a href=\"foo\" onclick=\"bar\"><script>baz</script></a>), %(<a href=\\\"foo\\\">baz</a>)",
          "287:     def test_video_poster_sanitization",
          "288:       scope_allowed_tags(%w(video)) do",
          "289:         scope_allowed_attributes %w(src poster) do",
          "290:           expected = if RUBY_PLATFORM == \"java\"",
          "291:             # xerces+nekohtml alphabetizes the attributes! FML.",
          "292:             %(<video poster=\"posterimage.jpg\" src=\"videofile.ogg\"></video>)",
          "293:           else",
          "294:             %(<video src=\"videofile.ogg\" poster=\"posterimage.jpg\"></video>)",
          "295:           end",
          "296:           assert_sanitized(",
          "297:             %(<video src=\"videofile.ogg\" autoplay  poster=\"posterimage.jpg\"></video>),",
          "298:             expected,",
          "299:           )",
          "300:           assert_sanitized(",
          "301:             %(<video src=\"videofile.ogg\" poster=javascript:alert(1)></video>),",
          "302:             %(<video src=\"videofile.ogg\"></video>),",
          "303:           )",
          "304:         end",
          "305:       end",
          "308:     # RFC 3986, sec 4.2",
          "309:     def test_allow_colons_in_path_component",
          "310:       assert_sanitized \"<a href=\\\"./this:that\\\">foo</a>\"",
          "313:     %w(src width height alt).each do |img_attr|",
          "314:       define_method \"test_should_allow_image_#{img_attr}_attribute\" do",
          "315:         assert_sanitized %(<img #{img_attr}=\"foo\" onclick=\"bar\" />), %(<img #{img_attr}=\"foo\">)",
          "316:       end",
          "319:     def test_lang_and_xml_lang",
          "320:       # https://html.spec.whatwg.org/multipage/dom.html#the-lang-and-xml:lang-attributes",
          "321:       #",
          "322:       # 3.2.6.2 The lang and xml:lang attributes",
          "323:       #",
          "324:       # ... Authors must not use the lang attribute in the XML namespace on HTML elements in HTML",
          "325:       # documents. To ease migration to and from XML, authors may specify an attribute in no namespace",
          "326:       # with no prefix and with the literal localname \"xml:lang\" on HTML elements in HTML documents,",
          "327:       # but such attributes must only be specified if a lang attribute in no namespace is also",
          "328:       # specified, and both attributes must have the same value when compared in an ASCII",
          "329:       # case-insensitive manner.",
          "330:       input = expected = \"<div lang=\\\"en\\\" xml:lang=\\\"en\\\">foo</div>\"",
          "331:       assert_sanitized(input, expected)",
          "332:     end",
          "334:     def test_should_handle_non_html",
          "335:       assert_sanitized \"abc\"",
          "336:     end",
          "338:     def test_should_handle_blank_text",
          "339:       assert_nil(safe_list_sanitize(nil))",
          "340:       assert_equal(\"\", safe_list_sanitize(\"\"))",
          "341:       assert_equal(\"   \", safe_list_sanitize(\"   \"))",
          "342:     end",
          "344:     def test_setting_allowed_tags_affects_sanitization",
          "345:       scope_allowed_tags %w(u) do |sanitizer|",
          "346:         assert_equal \"<u></u>\", sanitizer.sanitize(\"<a><u></u></a>\")",
          "347:       end",
          "348:     end",
          "350:     def test_setting_allowed_attributes_affects_sanitization",
          "351:       scope_allowed_attributes %w(foo) do |sanitizer|",
          "352:         input = '<a foo=\"hello\" bar=\"world\"></a>'",
          "353:         assert_equal '<a foo=\"hello\"></a>', sanitizer.sanitize(input)",
          "354:       end",
          "355:     end",
          "357:     def test_custom_tags_overrides_allowed_tags",
          "358:       scope_allowed_tags %(u) do |sanitizer|",
          "359:         input = \"<a><u></u></a>\"",
          "360:         assert_equal \"<a></a>\", sanitizer.sanitize(input, tags: %w(a))",
          "361:       end",
          "362:     end",
          "364:     def test_custom_attributes_overrides_allowed_attributes",
          "365:       scope_allowed_attributes %(foo) do |sanitizer|",
          "366:         input = '<a foo=\"hello\" bar=\"world\"></a>'",
          "367:         assert_equal '<a bar=\"world\"></a>', sanitizer.sanitize(input, attributes: %w(bar))",
          "368:       end",
          "369:     end",
          "371:     def test_should_allow_prune",
          "372:       sanitizer = Rails::Html::SafeListSanitizer.new(prune: true)",
          "373:       text = \"<u>leave me <b>now</b></u>\"",
          "374:       assert_equal \"<u>leave me </u>\", sanitizer.sanitize(text, tags: %w(u))",
          "377:     def test_should_allow_custom_tags",
          "378:       text = \"<u>foo</u>\"",
          "379:       assert_equal text, safe_list_sanitize(text, tags: %w(u))",
          "382:     def test_should_allow_only_custom_tags",
          "383:       text = \"<u>foo</u> with <i>bar</i>\"",
          "384:       assert_equal \"<u>foo</u> with bar\", safe_list_sanitize(text, tags: %w(u))",
          "385:     end",
          "387:     def test_should_allow_custom_tags_with_attributes",
          "388:       text = %(<blockquote cite=\"http://example.com/\">foo</blockquote>)",
          "389:       assert_equal text, safe_list_sanitize(text)",
          "392:     def test_should_allow_custom_tags_with_custom_attributes",
          "393:       text = %(<blockquote foo=\"bar\">Lorem ipsum</blockquote>)",
          "394:       assert_equal text, safe_list_sanitize(text, attributes: [\"foo\"])",
          "395:     end",
          "397:     def test_scrub_style_if_style_attribute_option_is_passed",
          "398:       input = '<p style=\"color: #000; background-image: url(http://www.ragingplatypus.com/i/cam-full.jpg);\"></p>'",
          "399:       actual = safe_list_sanitize(input, attributes: %w(style))",
          "401:       assert_includes(['<p style=\"color: #000;\"></p>', '<p style=\"color:#000;\"></p>'], actual)",
          "402:     end",
          "404:     def test_should_raise_argument_error_if_tags_is_not_enumerable",
          "405:       assert_raises ArgumentError do",
          "406:         safe_list_sanitize(\"<a>some html</a>\", tags: \"foo\")",
          "407:       end",
          "408:     end",
          "410:     def test_should_raise_argument_error_if_attributes_is_not_enumerable",
          "411:       assert_raises ArgumentError do",
          "412:         safe_list_sanitize(\"<a>some html</a>\", attributes: \"foo\")",
          "413:       end",
          "414:     end",
          "416:     def test_should_not_accept_non_loofah_inheriting_scrubber",
          "417:       scrubber = Object.new",
          "418:       def scrubber.scrub(node); node.name = \"h1\"; end",
          "420:       assert_raises Loofah::ScrubberNotFound do",
          "421:         safe_list_sanitize(\"<a>some html</a>\", scrubber: scrubber)",
          "422:       end",
          "423:     end",
          "425:     def test_should_accept_loofah_inheriting_scrubber",
          "426:       scrubber = Loofah::Scrubber.new",
          "427:       def scrubber.scrub(node); node.replace(\"<h1>#{node.inner_html}</h1>\"); end",
          "429:       html = \"<script>hello!</script>\"",
          "430:       assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "433:     def test_should_accept_loofah_scrubber_that_wraps_a_block",
          "434:       scrubber = Loofah::Scrubber.new { |node| node.replace(\"<h1>#{node.inner_html}</h1>\") }",
          "435:       html = \"<script>hello!</script>\"",
          "436:       assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "437:     end",
          "439:     def test_custom_scrubber_takes_precedence_over_other_options",
          "440:       scrubber = Loofah::Scrubber.new { |node| node.replace(\"<h1>#{node.inner_html}</h1>\") }",
          "441:       html = \"<script>hello!</script>\"",
          "442:       assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber, tags: [\"foo\"])",
          "443:     end",
          "445:     def test_should_strip_src_attribute_in_img_with_bad_protocols",
          "446:       assert_sanitized %(<img src=\"javascript:bang\" title=\"1\">), %(<img title=\"1\">)",
          "447:     end",
          "449:     def test_should_strip_href_attribute_in_a_with_bad_protocols",
          "450:       assert_sanitized %(<a href=\"javascript:bang\" title=\"1\">boo</a>), %(<a title=\"1\">boo</a>)",
          "451:     end",
          "453:     def test_should_block_script_tag",
          "454:       assert_sanitized %(<SCRIPT\\nSRC=http://ha.ckers.org/xss.js></SCRIPT>), \"\"",
          "455:     end",
          "457:     def test_should_not_fall_for_xss_image_hack_with_uppercase_tags",
          "458:       assert_sanitized %(<IMG \"\"\"><SCRIPT>alert(\"XSS\")</SCRIPT>\">), %(<img>alert(\"XSS\")\"&gt;)",
          "459:     end",
          "461:     [%(<IMG SRC=\"javascript:alert('XSS');\">),",
          "462:      %(<IMG SRC=javascript:alert('XSS')>),",
          "463:      %(<IMG SRC=JaVaScRiPt:alert('XSS')>),",
          "464:      %(<IMG SRC=javascript:alert(&quot;XSS&quot;)>),",
          "465:      %(<IMG SRC=javascript:alert(String.fromCharCode(88,83,83))>),",
          "466:      %(<IMG SRC=&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#97;&#108;&#101;&#114;&#116;&#40;&#39;&#88;&#83;&#83;&#39;&#41;>),",
          "467:      %(<IMG SRC=&#0000106&#0000097&#0000118&#0000097&#0000115&#0000099&#0000114&#0000105&#0000112&#0000116&#0000058&#0000097&#0000108&#0000101&#0000114&#0000116&#0000040&#0000039&#0000088&#0000083&#0000083&#0000039&#0000041>),",
          "468:      %(<IMG SRC=&#x6A&#x61&#x76&#x61&#x73&#x63&#x72&#x69&#x70&#x74&#x3A&#x61&#x6C&#x65&#x72&#x74&#x28&#x27&#x58&#x53&#x53&#x27&#x29>),",
          "469:      %(<IMG SRC=\"jav\\tascript:alert('XSS');\">),",
          "470:      %(<IMG SRC=\"jav&#x09;ascript:alert('XSS');\">),",
          "471:      %(<IMG SRC=\"jav&#x0A;ascript:alert('XSS');\">),",
          "472:      %(<IMG SRC=\"jav&#x0D;ascript:alert('XSS');\">),",
          "473:      %(<IMG SRC=\" &#14;  javascript:alert('XSS');\">),",
          "474:      %(<IMG SRC=\"javascript&#x3a;alert('XSS');\">),",
          "475:      %(<IMG SRC=`javascript:alert(\"RSnake says, 'XSS'\")`>)].each do |img_hack|",
          "476:       define_method \"test_should_not_fall_for_xss_image_hack_#{img_hack}\" do",
          "477:         assert_sanitized img_hack, \"<img>\"",
          "478:       end",
          "479:     end",
          "481:     def test_should_sanitize_tag_broken_up_by_null",
          "482:       input = %(<SCR\\0IPT>alert(\\\"XSS\\\")</SCR\\0IPT>)",
          "483:       result = safe_list_sanitize(input)",
          "484:       acceptable_results = [",
          "485:         # libxml2",
          "486:         \"\",",
          "487:         # xerces+neko",
          "488:         'alert(\"XSS\")',",
          "489:       ]",
          "491:       assert_includes(acceptable_results, result)",
          "492:     end",
          "494:     def test_should_sanitize_invalid_script_tag",
          "495:       assert_sanitized %(<SCRIPT/XSS SRC=\"http://ha.ckers.org/xss.js\"></SCRIPT>), \"\"",
          "496:     end",
          "498:     def test_should_sanitize_script_tag_with_multiple_open_brackets",
          "499:       assert_sanitized %(<<SCRIPT>alert(\"XSS\");//<</SCRIPT>), \"&lt;alert(\\\"XSS\\\");//&lt;\"",
          "500:     end",
          "502:     def test_should_sanitize_script_tag_with_multiple_open_brackets_2",
          "503:       input = %(<iframe src=http://ha.ckers.org/scriptlet.html\\n<a)",
          "504:       result = safe_list_sanitize(input)",
          "505:       acceptable_results = [",
          "506:         # libxml2",
          "507:         \"\",",
          "508:         # xerces+neko",
          "509:         \"&lt;a\",",
          "510:       ]",
          "512:       assert_includes(acceptable_results, result)",
          "513:     end",
          "515:     def test_should_sanitize_unclosed_script",
          "516:       assert_sanitized %(<SCRIPT SRC=http://ha.ckers.org/xss.js?<B>), \"\"",
          "517:     end",
          "519:     def test_should_sanitize_half_open_scripts",
          "520:       assert_sanitized %(<IMG SRC=\"javascript:alert('XSS')\"), \"<img>\"",
          "521:     end",
          "523:     def test_should_not_fall_for_ridiculous_hack",
          "524:       img_hack = %(<IMG\\nSRC\\n=\\n\"\\nj\\na\\nv\\na\\ns\\nc\\nr\\ni\\np\\nt\\n:\\na\\nl\\ne\\nr\\nt\\n(\\n'\\nX\\nS\\nS\\n'\\n)\\n\"\\n>)",
          "525:       assert_sanitized img_hack, \"<img>\"",
          "526:     end",
          "528:     def test_should_sanitize_attributes",
          "529:       assert_sanitized(",
          "530:         %(<SPAN title=\"'><script>alert()</script>\">blah</SPAN>),",
          "531:         %(<span title=\"'&gt;&lt;script&gt;alert()&lt;/script&gt;\">blah</span>),",
          "532:       )",
          "533:     end",
          "535:     def test_should_sanitize_invalid_tag_names",
          "536:       assert_sanitized(%(a b c<script/XSS src=\"http://ha.ckers.org/xss.js\"></script>d e f), \"a b cd e f\")",
          "539:     def test_should_sanitize_non_alpha_and_non_digit_characters_in_tags",
          "540:       assert_sanitized('<a onclick!#$%&()*~+-_.,:;?@[/|\\]^`=alert(\"XSS\")>foo</a>', \"<a>foo</a>\")",
          "541:     end",
          "543:     def test_should_sanitize_invalid_tag_names_in_single_tags",
          "544:       assert_sanitized('<img/src=\"http://ha.ckers.org/xss.js\"/>', \"<img>\")",
          "547:     def test_should_sanitize_img_dynsrc_lowsrc",
          "548:       assert_sanitized(%(<img lowsrc=\"javascript:alert('XSS')\" />), \"<img>\")",
          "549:     end",
          "551:     def test_should_sanitize_img_vbscript",
          "552:       assert_sanitized %(<img src='vbscript:msgbox(\"XSS\")' />), \"<img>\"",
          "553:     end",
          "555:     def test_should_sanitize_cdata_section",
          "556:       input = \"<![CDATA[<span>section</span>]]>\"",
          "557:       result = safe_list_sanitize(input)",
          "558:       acceptable_results = [",
          "559:         # libxml2 = 2.9.14",
          "560:         %{&lt;![CDATA[<span>section</span>]]&gt;},",
          "561:         # other libxml2",
          "562:         %{section]]&gt;},",
          "563:         # xerces+neko",
          "564:         \"\",",
          "565:       ]",
          "567:       assert_includes(acceptable_results, result)",
          "568:     end",
          "570:     def test_should_sanitize_unterminated_cdata_section",
          "571:       input = \"<![CDATA[<span>neverending...\"",
          "572:       result = safe_list_sanitize(input)",
          "574:       acceptable_results = [",
          "575:         # libxml2 = 2.9.14",
          "576:         %{&lt;![CDATA[<span>neverending...</span>},",
          "577:         # other libxml2",
          "578:         %{neverending...},",
          "579:         # xerces+neko",
          "580:         \"\"",
          "581:       ]",
          "583:       assert_includes(acceptable_results, result)",
          "584:     end",
          "586:     def test_should_not_mangle_urls_with_ampersand",
          "587:       assert_sanitized %{<a href=\\\"http://www.domain.com?var1=1&amp;var2=2\\\">my link</a>}",
          "588:     end",
          "590:     def test_should_sanitize_neverending_attribute",
          "591:       # note that assert_dom_equal chokes in this case! so avoid using assert_sanitized",
          "592:       assert_equal(\"<span class=\\\"\\\\\\\"></span>\", safe_list_sanitize(\"<span class=\\\"\\\\\\\">\"))",
          "593:     end",
          "595:     [",
          "596:       %(<a href=\"javascript&#x3a;alert('XSS');\">),",
          "597:       %(<a href=\"javascript&#x003a;alert('XSS');\">),",
          "598:       %(<a href=\"javascript&#x3A;alert('XSS');\">),",
          "599:       %(<a href=\"javascript&#x003A;alert('XSS');\">)",
          "600:     ].each_with_index do |enc_hack, i|",
          "601:       define_method \"test_x03a_handling_#{i + 1}\" do",
          "602:         assert_sanitized enc_hack, \"<a></a>\"",
          "603:       end",
          "604:     end",
          "606:     def test_x03a_legitimate",
          "607:       assert_sanitized %(<a href=\"http&#x3a;//legit\">asdf</a>), %(<a href=\"http://legit\">asdf</a>)",
          "608:       assert_sanitized %(<a href=\"http&#x3A;//legit\">asdf</a>), %(<a href=\"http://legit\">asdf</a>)",
          "611:     def test_sanitize_ascii_8bit_string",
          "612:       safe_list_sanitize(\"<a>hello</a>\".encode(\"ASCII-8BIT\")).tap do |sanitized|",
          "613:         assert_equal \"<a>hello</a>\", sanitized",
          "614:         assert_equal Encoding::UTF_8, sanitized.encoding",
          "615:       end",
          "616:     end",
          "618:     def test_sanitize_data_attributes",
          "619:       assert_sanitized %(<a href=\"/blah\" data-method=\"post\">foo</a>), %(<a href=\"/blah\">foo</a>)",
          "620:       assert_sanitized %(<a data-remote=\"true\" data-type=\"script\" data-method=\"get\" data-cross-domain=\"true\" href=\"attack.js\">Launch the missiles</a>), %(<a href=\"attack.js\">Launch the missiles</a>)",
          "623:     def test_allow_data_attribute_if_requested",
          "624:       text = %(<a data-foo=\"foo\">foo</a>)",
          "625:       assert_equal %(<a data-foo=\"foo\">foo</a>), safe_list_sanitize(text, attributes: [\"data-foo\"])",
          "626:     end",
          "628:     # https://developer.mozilla.org/en-US/docs/Glossary/Void_element",
          "629:     VOID_ELEMENTS = %w[area base br col embed hr img input keygen link meta param source track wbr]",
          "631:     %w(strong em b i p code pre tt samp kbd var sub",
          "632:        sup dfn cite big small address hr br div span h1 h2 h3 h4 h5 h6 ul ol li dl dt dd abbr",
          "633:        acronym a img blockquote del ins time).each do |tag_name|",
          "634:       define_method \"test_default_safelist_should_allow_#{tag_name}\" do",
          "635:         if VOID_ELEMENTS.include?(tag_name)",
          "636:           assert_sanitized(\"<#{tag_name}>\")",
          "637:         else",
          "638:           assert_sanitized(\"<#{tag_name}>foo</#{tag_name}>\")",
          "639:         end",
          "643:     def test_datetime_attribute",
          "644:       assert_sanitized(\"<time datetime=\\\"2023-01-01\\\">Today</time>\")",
          "645:     end",
          "647:     def test_abbr_attribute",
          "648:       scope_allowed_tags(%w(table tr th td)) do",
          "649:         assert_sanitized(%(<table><tr><td abbr=\"UK\">United Kingdom</td></tr></table>))",
          "650:       end",
          "653:     def test_uri_escaping_of_href_attr_in_a_tag_in_safe_list_sanitizer",
          "654:       skip if RUBY_VERSION < \"2.3\"",
          "656:       html = %{<a href='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "658:       text = safe_list_sanitize(html)",
          "660:       acceptable_results = [",
          "661:         # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "662:         %{<a href=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "663:         # system libxml2",
          "664:         %{<a href=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "665:         # xerces+neko",
          "666:         %{<a href=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "667:       ]",
          "669:       assert_includes(acceptable_results, text)",
          "670:     end",
          "672:     def test_uri_escaping_of_src_attr_in_a_tag_in_safe_list_sanitizer",
          "673:       skip if RUBY_VERSION < \"2.3\"",
          "675:       html = %{<a src='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "677:       text = safe_list_sanitize(html)",
          "679:       acceptable_results = [",
          "680:         # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "681:         %{<a src=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "682:         # system libxml2",
          "683:         %{<a src=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "684:         # xerces+neko",
          "685:         %{<a src=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "686:       ]",
          "688:       assert_includes(acceptable_results, text)",
          "689:     end",
          "691:     def test_uri_escaping_of_name_attr_in_a_tag_in_safe_list_sanitizer",
          "692:       skip if RUBY_VERSION < \"2.3\"",
          "694:       html = %{<a name='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "696:       text = safe_list_sanitize(html)",
          "698:       acceptable_results = [",
          "699:         # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "700:         %{<a name=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "701:         # system libxml2",
          "702:         %{<a name=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "703:         # xerces+neko",
          "704:         %{<a name=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>}",
          "705:       ]",
          "707:       assert_includes(acceptable_results, text)",
          "708:     end",
          "710:     def test_uri_escaping_of_name_action_in_a_tag_in_safe_list_sanitizer",
          "711:       skip if RUBY_VERSION < \"2.3\"",
          "713:       html = %{<a action='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "715:       text = safe_list_sanitize(html, attributes: [\"action\"])",
          "717:       acceptable_results = [",
          "718:         # nokogiri's vendored+patched libxml2 (0002-Update-entities-to-remove-handling-of-ssi.patch)",
          "719:         %{<a action=\"examp&lt;!--%22%20unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "720:         # system libxml2",
          "721:         %{<a action=\"examp<!--%22%20unsafeattr=foo()>-->le.com\">test</a>},",
          "722:         # xerces+neko",
          "723:         %{<a action=\"examp&lt;!--%22 unsafeattr=foo()&gt;--&gt;le.com\">test</a>},",
          "724:       ]",
          "726:       assert_includes(acceptable_results, text)",
          "727:     end",
          "729:     def test_exclude_node_type_processing_instructions",
          "730:       input = \"<div>text</div><?div content><b>text</b>\"",
          "731:       result = safe_list_sanitize(input)",
          "732:       acceptable_results = [",
          "733:         # jruby cyberneko (nokogiri < 1.14.0)",
          "734:         \"<div>text</div>\",",
          "735:         # everything else",
          "736:         \"<div>text</div><b>text</b>\",",
          "737:       ]",
          "739:       assert_includes(acceptable_results, result)",
          "740:     end",
          "742:     def test_exclude_node_type_comment",
          "743:       assert_equal(\"<div>text</div><b>text</b>\", safe_list_sanitize(\"<div>text</div><!-- comment --><b>text</b>\"))",
          "744:     end",
          "746:     %w[text/plain text/css image/png image/gif image/jpeg].each do |mediatype|",
          "747:       define_method \"test_mediatype_#{mediatype}_allowed\" do",
          "748:         input = %Q(<img src=\"data:#{mediatype};base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "749:         expected = input",
          "750:         actual = safe_list_sanitize(input)",
          "751:         assert_equal(expected, actual)",
          "753:         input = %Q(<img src=\"DATA:#{mediatype};base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "754:         expected = input",
          "755:         actual = safe_list_sanitize(input)",
          "756:         assert_equal(expected, actual)",
          "757:       end",
          "758:     end",
          "760:     def test_mediatype_text_html_disallowed",
          "761:       input = '<img src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "762:       expected = \"<img>\"",
          "766:       input = '<img src=\"DATA:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "767:       expected = \"<img>\"",
          "772:     def test_mediatype_image_svg_xml_disallowed",
          "773:       input = '<img src=\"data:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "774:       expected = \"<img>\"",
          "775:       actual = safe_list_sanitize(input)",
          "776:       assert_equal(expected, actual)",
          "778:       input = '<img src=\"DATA:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "779:       expected = \"<img>\"",
          "780:       actual = safe_list_sanitize(input)",
          "781:       assert_equal(expected, actual)",
          "782:     end",
          "784:     def test_mediatype_other_disallowed",
          "785:       input = '<a href=\"data:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "786:       expected = \"<a>foo</a>\"",
          "787:       actual = safe_list_sanitize(input)",
          "788:       assert_equal(expected, actual)",
          "790:       input = '<a href=\"DATA:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "791:       expected = \"<a>foo</a>\"",
          "792:       actual = safe_list_sanitize(input)",
          "793:       assert_equal(expected, actual)",
          "794:     end",
          "796:     def test_scrubbing_svg_attr_values_that_allow_ref",
          "797:       input = '<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>'",
          "798:       expected = '<div fill=\"yellow #fff\">hey</div>'",
          "799:       actual = scope_allowed_attributes %w(fill) do",
          "800:         safe_list_sanitize(input)",
          "801:       end",
          "803:       assert_equal(expected, actual)",
          "804:     end",
          "806:     def test_style_with_css_payload",
          "807:       input, tags = \"<style>div > span { background: \\\"red\\\"; }</style>\", [\"style\"]",
          "808:       expected = \"<style>div &gt; span { background: \\\"red\\\"; }</style>\"",
          "809:       actual = safe_list_sanitize(input, tags: tags)",
          "811:       assert_equal(expected, actual)",
          "814:     def test_combination_of_select_and_style_with_css_payload",
          "815:       input, tags = \"<select><style>div > span { background: \\\"red\\\"; }</style></select>\", [\"select\", \"style\"]",
          "816:       expected = \"<select><style>div &gt; span { background: \\\"red\\\"; }</style></select>\"",
          "817:       actual = safe_list_sanitize(input, tags: tags)",
          "819:       assert_equal(expected, actual)",
          "820:     end",
          "822:     def test_combination_of_select_and_style_with_script_payload",
          "823:       input, tags = \"<select><style><script>alert(1)</script></style></select>\", [\"select\", \"style\"]",
          "824:       expected = \"<select><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></select>\"",
          "825:       actual = safe_list_sanitize(input, tags: tags)",
          "827:       assert_equal(expected, actual)",
          "828:     end",
          "830:     def test_combination_of_svg_and_style_with_script_payload",
          "831:       input, tags = \"<svg><style><script>alert(1)</script></style></svg>\", [\"svg\", \"style\"]",
          "832:       expected = \"<svg><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></svg>\"",
          "833:       actual = safe_list_sanitize(input, tags: tags)",
          "835:       assert_equal(expected, actual)",
          "836:     end",
          "838:     def test_combination_of_math_and_style_with_img_payload",
          "839:       input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\"]",
          "840:       expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "841:       actual = safe_list_sanitize(input, tags: tags)",
          "843:       assert_equal(expected, actual)",
          "844:     end",
          "846:     def test_combination_of_math_and_style_with_img_payload_2",
          "847:       input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\", \"img\"]",
          "848:       expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "849:       actual = safe_list_sanitize(input, tags: tags)",
          "851:       assert_equal(expected, actual)",
          "852:     end",
          "854:     def test_combination_of_svg_and_style_with_img_payload",
          "855:       input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\"]",
          "856:       expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "857:       actual = safe_list_sanitize(input, tags: tags)",
          "859:       assert_equal(expected, actual)",
          "860:     end",
          "862:     def test_combination_of_svg_and_style_with_img_payload_2",
          "863:       input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\", \"img\"]",
          "864:       expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "865:       actual = safe_list_sanitize(input, tags: tags)",
          "867:       assert_equal(expected, actual)",
          "868:     end",
          "870:     def test_should_sanitize_illegal_style_properties",
          "871:       raw      = %(display:block; position:absolute; left:0; top:0; width:100%; height:100%; z-index:1; background-color:black; background-image:url(http://www.ragingplatypus.com/i/cam-full.jpg); background-x:center; background-y:center; background-repeat:repeat;)",
          "872:       expected = %(display:block;width:100%;height:100%;background-color:black;background-x:center;background-y:center;)",
          "873:       assert_equal expected, sanitize_css(raw)",
          "874:     end",
          "876:     def test_should_sanitize_with_trailing_space",
          "877:       raw = \"display:block; \"",
          "878:       expected = \"display:block;\"",
          "879:       assert_equal expected, sanitize_css(raw)",
          "880:     end",
          "882:     def test_should_sanitize_xul_style_attributes",
          "883:       raw = %(-moz-binding:url('http://ha.ckers.org/xssmoz.xml#xss'))",
          "884:       assert_equal \"\", sanitize_css(raw)",
          "885:     end",
          "887:     def test_should_sanitize_div_background_image_unicode_encoded",
          "888:       [",
          "889:         convert_to_css_hex(\"url(javascript:alert(1))\", false),",
          "890:         convert_to_css_hex(\"url(javascript:alert(1))\", true),",
          "891:         convert_to_css_hex(\"url(https://example.com)\", false),",
          "892:         convert_to_css_hex(\"url(https://example.com)\", true),",
          "893:       ].each do |propval|",
          "894:         raw = \"background-image:\" + propval",
          "895:         assert_empty(sanitize_css(raw))",
          "896:       end",
          "897:     end",
          "899:     def test_should_allow_div_background_image_unicode_encoded_safe_functions",
          "900:       [",
          "901:         convert_to_css_hex(\"rgb(255,0,0)\", false),",
          "902:         convert_to_css_hex(\"rgb(255,0,0)\", true),",
          "903:       ].each do |propval|",
          "904:         raw = \"background-image:\" + propval",
          "906:         assert_includes(sanitize_css(raw), \"background-image\")",
          "907:       end",
          "908:     end",
          "910:     def test_should_sanitize_div_style_expression",
          "911:       raw = %(width: expression(alert('XSS'));)",
          "912:       assert_equal \"\", sanitize_css(raw)",
          "913:     end",
          "915:     def test_should_sanitize_across_newlines",
          "916:       raw = %(\\nwidth:\\nexpression(alert('XSS'));\\n)",
          "917:       assert_equal \"\", sanitize_css(raw)",
          "918:     end",
          "920:     protected",
          "921:       def safe_list_sanitize(input, options = {})",
          "922:         Rails::Html::SafeListSanitizer.new.sanitize(input, options)",
          "923:       end",
          "925:       def assert_sanitized(input, expected = nil)",
          "926:         assert_equal((expected || input), safe_list_sanitize(input))",
          "927:       end",
          "929:       def scope_allowed_tags(tags)",
          "930:         old_tags = Rails::Html::SafeListSanitizer.allowed_tags",
          "931:         Rails::Html::SafeListSanitizer.allowed_tags = tags",
          "932:         yield Rails::Html::SafeListSanitizer.new",
          "933:       ensure",
          "934:         Rails::Html::SafeListSanitizer.allowed_tags = old_tags",
          "935:       end",
          "937:       def scope_allowed_attributes(attributes)",
          "938:         old_attributes = Rails::Html::SafeListSanitizer.allowed_attributes",
          "939:         Rails::Html::SafeListSanitizer.allowed_attributes = attributes",
          "940:         yield Rails::Html::SafeListSanitizer.new",
          "941:       ensure",
          "942:         Rails::Html::SafeListSanitizer.allowed_attributes = old_attributes",
          "943:       end",
          "945:       def sanitize_css(input)",
          "946:         Rails::HTML4::SafeListSanitizer.new.sanitize_css(input)",
          "947:       end",
          "949:       # note that this is used for testing CSS hex encoding: \\\\[0-9a-f]{1,6}",
          "950:       def convert_to_css_hex(string, escape_parens = false)",
          "951:         string.chars.map do |c|",
          "952:           if !escape_parens && (c == \"(\" || c == \")\")",
          "953:             c",
          "954:           else",
          "955:             format('\\00%02X', c.ord)",
          "956:           end",
          "957:         end.join",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "53f740934ad9ae3ed2e0fc90f3715ff2678147e6",
      "candidate_info": {
        "commit_hash": "53f740934ad9ae3ed2e0fc90f3715ff2678147e6",
        "repo": "rails/rails-html-sanitizer",
        "commit_url": "https://github.com/rails/rails-html-sanitizer/commit/53f740934ad9ae3ed2e0fc90f3715ff2678147e6",
        "files": [
          "test/sanitizer_test.rb"
        ],
        "message": "test: fix tests to accommodate HTML5 parser behavior\n\nThis feels pretty good, not gonna lie. The majority of tests that\nneeded to change were the ones related to the CDATA node issues:\n\nhttps://github.com/flavorjones/loofah/blob/main/docs/2022-10-decision-on-cdata-nodes.md\n\nand I'm happy to see everything working as expected.",
        "before_after_code_files": [
          "test/sanitizer_test.rb||test/sanitizer_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ],
          "candidate": [
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "test/sanitizer_test.rb||test/sanitizer_test.rb": [
          "File: test/sanitizer_test.rb -> test/sanitizer_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "553:     end",
          "555:     def test_should_sanitize_half_open_scripts",
          "557:     end",
          "559:     def test_should_not_fall_for_ridiculous_hack",
          "",
          "[Removed Lines]",
          "556:       assert_sanitized %(<IMG SRC=\"javascript:alert('XSS')\"), \"<img>\"",
          "",
          "[Added Lines]",
          "556:       input = %(<IMG SRC=\"javascript:alert('XSS')\")",
          "557:       result = safe_list_sanitize(input)",
          "558:       acceptable_results = [",
          "559:         # libxml2",
          "560:         \"<img>\",",
          "561:         # libgumbo",
          "562:         \"\",",
          "563:       ]",
          "565:       assert_includes(acceptable_results, result)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "562:     end",
          "564:     def test_should_sanitize_attributes",
          "567:         %(<span title=\"'&gt;&lt;script&gt;alert()&lt;/script&gt;\">blah</span>),",
          "569:     end",
          "571:     def test_should_sanitize_invalid_tag_names",
          "",
          "[Removed Lines]",
          "565:       assert_sanitized(",
          "566:         %(<SPAN title=\"'><script>alert()</script>\">blah</SPAN>),",
          "568:       )",
          "",
          "[Added Lines]",
          "574:       input = %(<SPAN title=\"'><script>alert()</script>\">blah</SPAN>)",
          "575:       result = safe_list_sanitize(input)",
          "576:       acceptable_results = [",
          "577:         # libxml2",
          "579:         # libgumbo",
          "580:         # this looks scary, but it's fine. for a more detailed analysis check out:",
          "581:         # https://github.com/discourse/discourse/pull/21522#issuecomment-1545697968",
          "582:         %(<span title=\"'><script>alert()</script>\">blah</span>)",
          "583:       ]",
          "585:       assert_includes(acceptable_results, result)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "577:     end",
          "579:     def test_should_sanitize_invalid_tag_names_in_single_tags",
          "581:     end",
          "583:     def test_should_sanitize_img_dynsrc_lowsrc",
          "",
          "[Removed Lines]",
          "580:       assert_sanitized('<img/src=\"http://ha.ckers.org/xss.js\"/>', \"<img>\")",
          "",
          "[Added Lines]",
          "597:       input = %(<img/src=\"http://ha.ckers.org/xss.js\"/>)",
          "598:       result = safe_list_sanitize(input)",
          "599:       acceptable_results = [",
          "600:         # libxml2",
          "601:         \"<img>\",",
          "602:         # libgumbo",
          "603:         %(<img src=\"http://ha.ckers.org/xss.js\">),",
          "604:       ]",
          "606:       assert_includes(acceptable_results, result)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "842:     def test_style_with_css_payload",
          "843:       input, tags = \"<style>div > span { background: \\\"red\\\"; }</style>\", [\"style\"]",
          "845:       actual = safe_list_sanitize(input, tags: tags)",
          "848:     end",
          "850:     def test_combination_of_select_and_style_with_css_payload",
          "851:       input, tags = \"<select><style>div > span { background: \\\"red\\\"; }</style></select>\", [\"select\", \"style\"]",
          "853:       actual = safe_list_sanitize(input, tags: tags)",
          "856:     end",
          "858:     def test_combination_of_select_and_style_with_script_payload",
          "859:       input, tags = \"<select><style><script>alert(1)</script></style></select>\", [\"select\", \"style\"]",
          "861:       actual = safe_list_sanitize(input, tags: tags)",
          "864:     end",
          "866:     def test_combination_of_svg_and_style_with_script_payload",
          "867:       input, tags = \"<svg><style><script>alert(1)</script></style></svg>\", [\"svg\", \"style\"]",
          "869:       actual = safe_list_sanitize(input, tags: tags)",
          "872:     end",
          "874:     def test_combination_of_math_and_style_with_img_payload",
          "875:       input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\"]",
          "877:       actual = safe_list_sanitize(input, tags: tags)",
          "880:     end",
          "882:     def test_combination_of_math_and_style_with_img_payload_2",
          "883:       input, tags = \"<math><style><img src=x onerror=alert(1)></style></math>\", [\"math\", \"style\", \"img\"]",
          "885:       actual = safe_list_sanitize(input, tags: tags)",
          "888:     end",
          "890:     def test_combination_of_svg_and_style_with_img_payload",
          "891:       input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\"]",
          "893:       actual = safe_list_sanitize(input, tags: tags)",
          "896:     end",
          "898:     def test_combination_of_svg_and_style_with_img_payload_2",
          "899:       input, tags = \"<svg><style><img src=x onerror=alert(1)></style></svg>\", [\"svg\", \"style\", \"img\"]",
          "901:       actual = safe_list_sanitize(input, tags: tags)",
          "904:     end",
          "906:     def test_should_sanitize_illegal_style_properties",
          "",
          "[Removed Lines]",
          "844:       expected = \"<style>div &gt; span { background: \\\"red\\\"; }</style>\"",
          "847:       assert_equal(expected, actual)",
          "852:       expected = \"<select><style>div &gt; span { background: \\\"red\\\"; }</style></select>\"",
          "855:       assert_equal(expected, actual)",
          "860:       expected = \"<select><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></select>\"",
          "863:       assert_equal(expected, actual)",
          "868:       expected = \"<svg><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></svg>\"",
          "871:       assert_equal(expected, actual)",
          "876:       expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "879:       assert_equal(expected, actual)",
          "884:       expected = \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\"",
          "887:       assert_equal(expected, actual)",
          "892:       expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "895:       assert_equal(expected, actual)",
          "900:       expected = \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\"",
          "903:       assert_equal(expected, actual)",
          "",
          "[Added Lines]",
          "871:       acceptable_results = [",
          "872:         # libxml2",
          "873:         \"<style>div &gt; span { background: \\\"red\\\"; }</style>\",",
          "874:         # libgumbo",
          "875:         \"<style>div > span { background: \\\"red\\\"; }</style>\",",
          "876:       ]",
          "878:       assert_includes(acceptable_results, actual)",
          "884:       acceptable_results = [",
          "885:         # libxml2",
          "886:         \"<select><style>div &gt; span { background: \\\"red\\\"; }</style></select>\",",
          "887:         # libgumbo",
          "888:         \"<select>div &gt; span { background: \\\"red\\\"; }</select>\",",
          "889:       ]",
          "891:       assert_includes(acceptable_results, actual)",
          "897:       acceptable_results = [",
          "898:         # libxml2",
          "899:         \"<select><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></select>\",",
          "900:         # libgumbo",
          "901:         \"<select>alert(1)</select>\",",
          "902:       ]",
          "904:       assert_includes(acceptable_results, actual)",
          "910:       acceptable_results = [",
          "911:         # libxml2",
          "912:         \"<svg><style>&lt;script&gt;alert(1)&lt;/script&gt;</style></svg>\",",
          "913:         # libgumbo",
          "914:         \"<svg><style>alert(1)</style></svg>\"",
          "915:       ]",
          "917:       assert_includes(acceptable_results, actual)",
          "923:       acceptable_results = [",
          "924:         # libxml2",
          "925:         \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\",",
          "926:         # libgumbo",
          "927:         \"<math><style></style></math>\",",
          "928:       ]",
          "930:       assert_includes(acceptable_results, actual)",
          "936:       acceptable_results = [",
          "937:         # libxml2",
          "938:         \"<math><style>&lt;img src=x onerror=alert(1)&gt;</style></math>\",",
          "939:         # libgumbo",
          "940:         \"<math><style></style></math><img src=\\\"x\\\">\",",
          "941:       ]",
          "943:       assert_includes(acceptable_results, actual)",
          "949:       acceptable_results = [",
          "950:         # libxml2",
          "951:         \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\",",
          "952:         # libgumbo",
          "953:         \"<svg><style></style></svg>\",",
          "954:       ]",
          "956:       assert_includes(acceptable_results, actual)",
          "962:       acceptable_results = [",
          "963:         # libxml2",
          "964:         \"<svg><style>&lt;img src=x onerror=alert(1)&gt;</style></svg>\",",
          "965:         # libgumbo",
          "966:         \"<svg><style></style></svg><img src=\\\"x\\\">\",",
          "967:       ]",
          "969:       assert_includes(acceptable_results, actual)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "293903d251cff58a0c9a123c91409a2a457974fa",
      "candidate_info": {
        "commit_hash": "293903d251cff58a0c9a123c91409a2a457974fa",
        "repo": "rails/rails-html-sanitizer",
        "commit_url": "https://github.com/rails/rails-html-sanitizer/commit/293903d251cff58a0c9a123c91409a2a457974fa",
        "files": [
          "Gemfile",
          "Rakefile",
          "lib/rails-html-sanitizer.rb",
          "lib/rails/html/sanitizer.rb",
          "lib/rails/html/sanitizer/version.rb",
          "lib/rails/html/scrubbers.rb",
          "rails-html-sanitizer.gemspec",
          "test/sanitizer_test.rb",
          "test/scrubbers_test.rb"
        ],
        "message": "style(rubocop): correct all warnings",
        "before_after_code_files": [
          "lib/rails-html-sanitizer.rb||lib/rails-html-sanitizer.rb",
          "lib/rails/html/sanitizer.rb||lib/rails/html/sanitizer.rb",
          "lib/rails/html/sanitizer/version.rb||lib/rails/html/sanitizer/version.rb",
          "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
          "rails-html-sanitizer.gemspec||rails-html-sanitizer.gemspec",
          "test/sanitizer_test.rb||test/sanitizer_test.rb",
          "test/scrubbers_test.rb||test/scrubbers_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ],
          "candidate": [
            "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/rails-html-sanitizer.rb||lib/rails-html-sanitizer.rb": [
          "File: lib/rails-html-sanitizer.rb -> lib/rails-html-sanitizer.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: require \"rails/html/sanitizer/version\"",
          "2: require \"loofah\"",
          "3: require \"rails/html/scrubbers\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------"
        ],
        "lib/rails/html/sanitizer.rb||lib/rails/html/sanitizer.rb": [
          "File: lib/rails/html/sanitizer.rb -> lib/rails/html/sanitizer.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: module Rails",
          "2:   module Html",
          "3:     XPATHS_TO_REMOVE = %w{.//script .//form comment()}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "8:       end",
          "10:       private",
          "20:     end",
          "22:     # === Rails::Html::FullSanitizer",
          "",
          "[Removed Lines]",
          "12:       def remove_xpaths(node, xpaths)",
          "13:         node.xpath(*xpaths).remove",
          "14:         node",
          "15:       end",
          "17:       def properly_encode(fragment, options)",
          "18:         fragment.xml? ? fragment.to_xml(options) : fragment.to_html(options)",
          "19:       end",
          "",
          "[Added Lines]",
          "13:         def remove_xpaths(node, xpaths)",
          "14:           node.xpath(*xpaths).remove",
          "15:           node",
          "16:         end",
          "18:         def properly_encode(fragment, options)",
          "19:           fragment.xml? ? fragment.to_xml(options) : fragment.to_html(options)",
          "20:         end",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "35:         remove_xpaths(loofah_fragment, XPATHS_TO_REMOVE)",
          "36:         loofah_fragment.scrub!(TextOnlyScrubber.new)",
          "39:       end",
          "40:     end",
          "",
          "[Removed Lines]",
          "38:         properly_encode(loofah_fragment, encoding: 'UTF-8')",
          "",
          "[Added Lines]",
          "39:         properly_encode(loofah_fragment, encoding: \"UTF-8\")",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "132:           loofah_fragment.scrub!(:strip)",
          "133:         end",
          "136:       end",
          "138:       def sanitize_css(style_string)",
          "",
          "[Removed Lines]",
          "135:         properly_encode(loofah_fragment, encoding: 'UTF-8')",
          "",
          "[Added Lines]",
          "136:         properly_encode(loofah_fragment, encoding: \"UTF-8\")",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "140:       end",
          "142:       private",
          "151:     end",
          "153:     WhiteListSanitizer = SafeListSanitizer",
          "",
          "[Removed Lines]",
          "144:       def allowed_tags(options)",
          "145:         options[:tags] || self.class.allowed_tags",
          "146:       end",
          "148:       def allowed_attributes(options)",
          "149:         options[:attributes] || self.class.allowed_attributes",
          "150:       end",
          "",
          "[Added Lines]",
          "144:         def allowed_tags(options)",
          "145:           options[:tags] || self.class.allowed_tags",
          "146:         end",
          "148:         def allowed_attributes(options)",
          "149:           options[:attributes] || self.class.allowed_attributes",
          "150:         end",
          "",
          "---------------"
        ],
        "lib/rails/html/sanitizer/version.rb||lib/rails/html/sanitizer/version.rb": [
          "File: lib/rails/html/sanitizer/version.rb -> lib/rails/html/sanitizer/version.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: module Rails",
          "2:   module Html",
          "3:     class Sanitizer",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------"
        ],
        "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb": [
          "File: lib/rails/html/scrubbers.rb -> lib/rails/html/scrubbers.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: module Rails",
          "2:   module Html",
          "3:     # === Rails::Html::PermitScrubber",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77:       end",
          "79:       protected",
          "98:         end",
          "111:           end",
          "116:         end",
          "125:         end",
          "131:         end",
          "158:     end",
          "160:     # === Rails::Html::TargetScrubber",
          "",
          "[Removed Lines]",
          "81:       def allowed_node?(node)",
          "82:         @tags.include?(node.name)",
          "83:       end",
          "85:       def skip_node?(node)",
          "86:         node.text?",
          "87:       end",
          "89:       def scrub_attribute?(name)",
          "90:         !@attributes.include?(name)",
          "91:       end",
          "93:       def keep_node?(node)",
          "94:         if @tags",
          "95:           allowed_node?(node)",
          "96:         else",
          "97:           Loofah::HTML5::Scrub.allowed_element?(node.name)",
          "99:       end",
          "101:       def scrub_node(node)",
          "102:         node.before(node.children) unless prune # strip",
          "103:         node.remove",
          "104:       end",
          "106:       def scrub_attributes(node)",
          "107:         if @attributes",
          "108:           node.attribute_nodes.each do |attr|",
          "109:             attr.remove if scrub_attribute?(attr.name)",
          "110:             scrub_attribute(node, attr)",
          "113:           scrub_css_attribute(node)",
          "114:         else",
          "115:           Loofah::HTML5::Scrub.scrub_attributes(node)",
          "117:       end",
          "119:       def scrub_css_attribute(node)",
          "120:         if Loofah::HTML5::Scrub.respond_to?(:scrub_css_attribute)",
          "121:           Loofah::HTML5::Scrub.scrub_css_attribute(node)",
          "122:         else",
          "123:           style = node.attributes['style']",
          "124:           style.value = Loofah::HTML5::Scrub.scrub_css(style.value) if style",
          "126:       end",
          "128:       def validate!(var, name)",
          "129:         if var && !var.is_a?(Enumerable)",
          "130:           raise ArgumentError, \"You should pass :#{name} as an Enumerable\"",
          "132:         var",
          "133:       end",
          "135:       def scrub_attribute(node, attr_node)",
          "136:         attr_name = if attr_node.namespace",
          "137:                       \"#{attr_node.namespace.prefix}:#{attr_node.node_name}\"",
          "138:                     else",
          "139:                       attr_node.node_name",
          "140:                     end",
          "142:         if Loofah::HTML5::SafeList::ATTR_VAL_IS_URI.include?(attr_name)",
          "143:           return if Loofah::HTML5::Scrub.scrub_uri_attribute(attr_node)",
          "144:         end",
          "146:         if Loofah::HTML5::SafeList::SVG_ATTR_VAL_ALLOWS_REF.include?(attr_name)",
          "147:           Loofah::HTML5::Scrub.scrub_attribute_that_allows_local_ref(attr_node)",
          "148:         end",
          "150:         if Loofah::HTML5::SafeList::SVG_ALLOW_LOCAL_HREF.include?(node.name) && attr_name == 'xlink:href' && attr_node.value =~ /^\\s*[^#\\s].*/m",
          "151:           attr_node.remove",
          "152:         end",
          "154:         node.remove_attribute(attr_node.name) if attr_name == 'src' && attr_node.value !~ /[^[:space:]]/",
          "156:         Loofah::HTML5::Scrub.force_correct_attribute_escaping! node",
          "157:       end",
          "",
          "[Added Lines]",
          "82:         def allowed_node?(node)",
          "83:           @tags.include?(node.name)",
          "84:         end",
          "86:         def skip_node?(node)",
          "87:           node.text?",
          "88:         end",
          "90:         def scrub_attribute?(name)",
          "91:           !@attributes.include?(name)",
          "92:         end",
          "94:         def keep_node?(node)",
          "95:           if @tags",
          "96:             allowed_node?(node)",
          "97:           else",
          "98:             Loofah::HTML5::Scrub.allowed_element?(node.name)",
          "99:           end",
          "100:         end",
          "102:         def scrub_node(node)",
          "103:           node.before(node.children) unless prune # strip",
          "104:           node.remove",
          "107:         def scrub_attributes(node)",
          "108:           if @attributes",
          "109:             node.attribute_nodes.each do |attr|",
          "110:               attr.remove if scrub_attribute?(attr.name)",
          "111:               scrub_attribute(node, attr)",
          "112:             end",
          "114:             scrub_css_attribute(node)",
          "115:           else",
          "116:             Loofah::HTML5::Scrub.scrub_attributes(node)",
          "120:         def scrub_css_attribute(node)",
          "121:           if Loofah::HTML5::Scrub.respond_to?(:scrub_css_attribute)",
          "122:             Loofah::HTML5::Scrub.scrub_css_attribute(node)",
          "123:           else",
          "124:             style = node.attributes[\"style\"]",
          "125:             style.value = Loofah::HTML5::Scrub.scrub_css(style.value) if style",
          "126:           end",
          "129:         def validate!(var, name)",
          "130:           if var && !var.is_a?(Enumerable)",
          "131:             raise ArgumentError, \"You should pass :#{name} as an Enumerable\"",
          "132:           end",
          "133:           var",
          "136:         def scrub_attribute(node, attr_node)",
          "137:           attr_name = if attr_node.namespace",
          "138:             \"#{attr_node.namespace.prefix}:#{attr_node.node_name}\"",
          "139:           else",
          "140:             attr_node.node_name",
          "141:           end",
          "143:           if Loofah::HTML5::SafeList::ATTR_VAL_IS_URI.include?(attr_name)",
          "144:             return if Loofah::HTML5::Scrub.scrub_uri_attribute(attr_node)",
          "145:           end",
          "147:           if Loofah::HTML5::SafeList::SVG_ATTR_VAL_ALLOWS_REF.include?(attr_name)",
          "148:             Loofah::HTML5::Scrub.scrub_attribute_that_allows_local_ref(attr_node)",
          "149:           end",
          "151:           if Loofah::HTML5::SafeList::SVG_ALLOW_LOCAL_HREF.include?(node.name) && attr_name == \"xlink:href\" && attr_node.value =~ /^\\s*[^#\\s].*/m",
          "152:             attr_node.remove",
          "153:           end",
          "155:           node.remove_attribute(attr_node.name) if attr_name == \"src\" && attr_node.value !~ /[^[:space:]]/",
          "157:           Loofah::HTML5::Scrub.force_correct_attribute_escaping! node",
          "158:         end",
          "",
          "---------------"
        ],
        "rails-html-sanitizer.gemspec||rails-html-sanitizer.gemspec": [
          "File: rails-html-sanitizer.gemspec -> rails-html-sanitizer.gemspec",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: # coding: utf-8",
          "3: $LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)",
          "6: Gem::Specification.new do |spec|",
          "7:   spec.name          = \"rails-html-sanitizer\"",
          "8:   spec.version       = Rails::Html::Sanitizer::VERSION",
          "9:   spec.authors       = [\"Rafael Mendon\u00e7a Fran\u00e7a\", \"Kasper Timm Hansen\"]",
          "10:   spec.email         = [\"rafaelmfranca@gmail.com\", \"kaspth@gmail.com\"]",
          "13:   spec.homepage      = \"https://github.com/rails/rails-html-sanitizer\"",
          "14:   spec.license       = \"MIT\"",
          "16:   spec.required_ruby_version = \">= 2.5.0\"",
          "19:     \"bug_tracker_uri\"   => \"https://github.com/rails/rails-html-sanitizer/issues\",",
          "20:     \"changelog_uri\"     => \"https://github.com/rails/rails-html-sanitizer/blob/v#{spec.version}/CHANGELOG.md\",",
          "21:     \"documentation_uri\" => \"https://www.rubydoc.info/gems/rails-html-sanitizer/#{spec.version}\",",
          "",
          "[Removed Lines]",
          "2: lib = File.expand_path('../lib', __FILE__)",
          "4: require 'rails/html/sanitizer/version'",
          "11:   spec.description   = %q{HTML sanitization for Rails applications}",
          "12:   spec.summary       = %q{This gem is responsible to sanitize HTML fragments in Rails applications.}",
          "18:   spec.metadata      = {",
          "",
          "[Added Lines]",
          "2: # frozen_string_literal: true",
          "4: lib = File.expand_path(\"../lib\", __FILE__)",
          "6: require \"rails/html/sanitizer/version\"",
          "13:   spec.description   = \"HTML sanitization for Rails applications\"",
          "14:   spec.summary       = \"This gem is responsible to sanitize HTML fragments in Rails applications.\"",
          "20:   spec.metadata = {",
          "",
          "---------------"
        ],
        "test/sanitizer_test.rb||test/sanitizer_test.rb": [
          "File: test/sanitizer_test.rb -> test/sanitizer_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: require \"minitest/autorun\"",
          "2: require \"rails-html-sanitizer\"",
          "3: require \"rails/dom/testing/assertions/dom_assertions\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "10:   def test_sanitizer_sanitize_raises_not_implemented_error",
          "11:     assert_raises NotImplementedError do",
          "13:     end",
          "14:   end",
          "",
          "[Removed Lines]",
          "12:       Rails::Html::Sanitizer.new.sanitize('')",
          "",
          "[Added Lines]",
          "14:       Rails::Html::Sanitizer.new.sanitize(\"\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "41:   def test_remove_xpaths_called_with_faulty_xpath",
          "42:     assert_raises Nokogiri::XML::XPath::SyntaxError do",
          "44:     end",
          "45:   end",
          "47:   def test_remove_xpaths_called_with_xpath_string",
          "49:   end",
          "51:   def test_remove_xpaths_called_with_enumerable_xpaths",
          "53:   end",
          "55:   def test_strip_tags_with_quote",
          "",
          "[Removed Lines]",
          "43:       xpath_sanitize('<h1>hello<h1>', xpaths: %w(..faulty_xpath))",
          "48:     assert_equal '', xpath_sanitize('<a></a>', xpaths: './/a')",
          "52:     assert_equal '', xpath_sanitize('<a><span></span></a>', xpaths: %w(.//a .//span))",
          "",
          "[Added Lines]",
          "45:       xpath_sanitize(\"<h1>hello<h1>\", xpaths: %w(..faulty_xpath))",
          "50:     assert_equal \"\", xpath_sanitize(\"<a></a>\", xpaths: \".//a\")",
          "54:     assert_equal \"\", xpath_sanitize(\"<a><span></span></a>\", xpaths: %w(.//a .//span))",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "120:   end",
          "122:   def test_strip_tags_with_frozen_string",
          "124:   end",
          "126:   def test_full_sanitize_respect_html_escaping_of_the_given_string",
          "127:     assert_equal 'test\\r\\nstring', full_sanitize('test\\r\\nstring')",
          "132:   end",
          "134:   def test_strip_links_with_tags_in_tags",
          "",
          "[Removed Lines]",
          "123:     assert_equal \"Frozen string with no tags\", full_sanitize(\"Frozen string with no tags\".freeze)",
          "128:     assert_equal '&amp;', full_sanitize('&')",
          "129:     assert_equal '&amp;', full_sanitize('&amp;')",
          "130:     assert_equal '&amp;amp;', full_sanitize('&amp;amp;')",
          "131:     assert_equal 'omg &lt;script&gt;BOM&lt;/script&gt;', full_sanitize('omg &lt;script&gt;BOM&lt;/script&gt;')",
          "",
          "[Added Lines]",
          "125:     assert_equal \"Frozen string with no tags\", full_sanitize(\"Frozen string with no tags\")",
          "130:     assert_equal \"&amp;\", full_sanitize(\"&\")",
          "131:     assert_equal \"&amp;\", full_sanitize(\"&amp;\")",
          "132:     assert_equal \"&amp;amp;\", full_sanitize(\"&amp;amp;\")",
          "133:     assert_equal \"omg &lt;script&gt;BOM&lt;/script&gt;\", full_sanitize(\"omg &lt;script&gt;BOM&lt;/script&gt;\")",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "162:   end",
          "164:   def test_sanitize_form",
          "166:   end",
          "168:   def test_sanitize_plaintext",
          "",
          "[Removed Lines]",
          "165:     assert_sanitized \"<form action=\\\"/foo/bar\\\" method=\\\"post\\\"><input></form>\", ''",
          "",
          "[Added Lines]",
          "167:     assert_sanitized \"<form action=\\\"/foo/bar\\\" method=\\\"post\\\"><input></form>\", \"\"",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "222:   end",
          "224:   def test_should_handle_non_html",
          "226:   end",
          "228:   def test_should_handle_blank_text",
          "230:   end",
          "232:   def test_setting_allowed_tags_affects_sanitization",
          "233:     scope_allowed_tags %w(u) do |sanitizer|",
          "235:     end",
          "236:   end",
          "",
          "[Removed Lines]",
          "225:     assert_sanitized 'abc'",
          "229:     [nil, '', '   '].each { |blank| assert_sanitized blank }",
          "234:       assert_equal '<u></u>', sanitizer.sanitize('<a><u></u></a>')",
          "",
          "[Added Lines]",
          "227:     assert_sanitized \"abc\"",
          "231:     [nil, \"\", \"   \"].each { |blank| assert_sanitized blank }",
          "236:       assert_equal \"<u></u>\", sanitizer.sanitize(\"<a><u></u></a>\")",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "245:   def test_custom_tags_overrides_allowed_tags",
          "246:     scope_allowed_tags %(u) do |sanitizer|",
          "249:     end",
          "250:   end",
          "",
          "[Removed Lines]",
          "247:       input = '<a><u></u></a>'",
          "248:       assert_equal '<a></a>', sanitizer.sanitize(input, tags: %w(a))",
          "",
          "[Added Lines]",
          "249:       input = \"<a><u></u></a>\"",
          "250:       assert_equal \"<a></a>\", sanitizer.sanitize(input, tags: %w(a))",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "259:   def test_should_allow_prune",
          "260:     sanitizer = Rails::Html::SafeListSanitizer.new(prune: true)",
          "262:     assert_equal \"<u>leave me </u>\", sanitizer.sanitize(text, tags: %w(u))",
          "263:   end",
          "",
          "[Removed Lines]",
          "261:     text = '<u>leave me <b>now</b></u>'",
          "",
          "[Added Lines]",
          "263:     text = \"<u>leave me <b>now</b></u>\"",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "280:   def test_should_allow_custom_tags_with_custom_attributes",
          "281:     text = %(<blockquote foo=\"bar\">Lorem ipsum</blockquote>)",
          "283:   end",
          "285:   def test_scrub_style_if_style_attribute_option_is_passed",
          "",
          "[Removed Lines]",
          "282:     assert_equal text, safe_list_sanitize(text, attributes: ['foo'])",
          "",
          "[Added Lines]",
          "284:     assert_equal text, safe_list_sanitize(text, attributes: [\"foo\"])",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "291:   def test_should_raise_argument_error_if_tags_is_not_enumerable",
          "292:     assert_raises ArgumentError do",
          "294:     end",
          "295:   end",
          "297:   def test_should_raise_argument_error_if_attributes_is_not_enumerable",
          "298:     assert_raises ArgumentError do",
          "300:     end",
          "301:   end",
          "303:   def test_should_not_accept_non_loofah_inheriting_scrubber",
          "304:     scrubber = Object.new",
          "307:     assert_raises Loofah::ScrubberNotFound do",
          "309:     end",
          "310:   end",
          "312:   def test_should_accept_loofah_inheriting_scrubber",
          "313:     scrubber = Loofah::Scrubber.new",
          "316:     html = \"<script>hello!</script>\"",
          "317:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "318:   end",
          "320:   def test_should_accept_loofah_scrubber_that_wraps_a_block",
          "322:     html = \"<script>hello!</script>\"",
          "323:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber)",
          "324:   end",
          "326:   def test_custom_scrubber_takes_precedence_over_other_options",
          "328:     html = \"<script>hello!</script>\"",
          "330:   end",
          "332:   [%w(img src), %w(a href)].each do |(tag, attr)|",
          "",
          "[Removed Lines]",
          "293:       safe_list_sanitize('<a>some html</a>', tags: 'foo')",
          "299:       safe_list_sanitize('<a>some html</a>', attributes: 'foo')",
          "305:     def scrubber.scrub(node); node.name = 'h1'; end",
          "308:       safe_list_sanitize('<a>some html</a>', scrubber: scrubber)",
          "314:     def scrubber.scrub(node); node.name = 'h1'; end",
          "321:     scrubber = Loofah::Scrubber.new { |node| node.name = 'h1' }",
          "327:     scrubber = Loofah::Scrubber.new { |node| node.name = 'h1' }",
          "329:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber, tags: ['foo'])",
          "",
          "[Added Lines]",
          "295:       safe_list_sanitize(\"<a>some html</a>\", tags: \"foo\")",
          "301:       safe_list_sanitize(\"<a>some html</a>\", attributes: \"foo\")",
          "307:     def scrubber.scrub(node); node.name = \"h1\"; end",
          "310:       safe_list_sanitize(\"<a>some html</a>\", scrubber: scrubber)",
          "316:     def scrubber.scrub(node); node.name = \"h1\"; end",
          "323:     scrubber = Loofah::Scrubber.new { |node| node.name = \"h1\" }",
          "329:     scrubber = Loofah::Scrubber.new { |node| node.name = \"h1\" }",
          "331:     assert_equal \"<h1>hello!</h1>\", safe_list_sanitize(html, scrubber: scrubber, tags: [\"foo\"])",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "408:   def test_should_sanitize_xul_style_attributes",
          "409:     raw = %(-moz-binding:url('http://ha.ckers.org/xssmoz.xml#xss'))",
          "411:   end",
          "413:   def test_should_sanitize_invalid_tag_names",
          "",
          "[Removed Lines]",
          "410:     assert_equal '', sanitize_css(raw)",
          "",
          "[Added Lines]",
          "412:     assert_equal \"\", sanitize_css(raw)",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "451:   def test_should_sanitize_div_style_expression",
          "452:     raw = %(width: expression(alert('XSS'));)",
          "454:   end",
          "456:   def test_should_sanitize_across_newlines",
          "457:     raw = %(\\nwidth:\\nexpression(alert('XSS'));\\n)",
          "459:   end",
          "461:   def test_should_sanitize_img_vbscript",
          "463:   end",
          "465:   def test_should_sanitize_cdata_section",
          "",
          "[Removed Lines]",
          "453:     assert_equal '', sanitize_css(raw)",
          "458:     assert_equal '', sanitize_css(raw)",
          "462:     assert_sanitized %(<img src='vbscript:msgbox(\"XSS\")' />), '<img />'",
          "",
          "[Added Lines]",
          "455:     assert_equal \"\", sanitize_css(raw)",
          "460:     assert_equal \"\", sanitize_css(raw)",
          "464:     assert_sanitized %(<img src='vbscript:msgbox(\"XSS\")' />), \"<img />\"",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "475:   end",
          "477:   def test_should_not_mangle_urls_with_ampersand",
          "479:   end",
          "481:   def test_should_sanitize_neverending_attribute",
          "",
          "[Removed Lines]",
          "478:      assert_sanitized %{<a href=\\\"http://www.domain.com?var1=1&amp;var2=2\\\">my link</a>}",
          "",
          "[Added Lines]",
          "480:     assert_sanitized %{<a href=\\\"http://www.domain.com?var1=1&amp;var2=2\\\">my link</a>}",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "488:     %(<a href=\"javascript&#x3A;alert('XSS');\">),",
          "489:     %(<a href=\"javascript&#x003A;alert('XSS');\">)",
          "490:   ].each_with_index do |enc_hack, i|",
          "492:       assert_sanitized enc_hack, \"<a>\"",
          "493:     end",
          "494:   end",
          "",
          "[Removed Lines]",
          "491:     define_method \"test_x03a_handling_#{i+1}\" do",
          "",
          "[Added Lines]",
          "493:     define_method \"test_x03a_handling_#{i + 1}\" do",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "499:   end",
          "501:   def test_sanitize_ascii_8bit_string",
          "504:       assert_equal Encoding::UTF_8, sanitized.encoding",
          "505:     end",
          "506:   end",
          "",
          "[Removed Lines]",
          "502:     safe_list_sanitize('<a>hello</a>'.encode('ASCII-8BIT')).tap do |sanitized|",
          "503:       assert_equal '<a>hello</a>', sanitized",
          "",
          "[Added Lines]",
          "504:     safe_list_sanitize(\"<a>hello</a>\".encode(\"ASCII-8BIT\")).tap do |sanitized|",
          "505:       assert_equal \"<a>hello</a>\", sanitized",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "513:   def test_allow_data_attribute_if_requested",
          "514:     text = %(<a data-foo=\"foo\">foo</a>)",
          "516:   end",
          "518:   def test_uri_escaping_of_href_attr_in_a_tag_in_safe_list_sanitizer",
          "",
          "[Removed Lines]",
          "515:     assert_equal %(<a data-foo=\"foo\">foo</a>), safe_list_sanitize(text, attributes: ['data-foo'])",
          "",
          "[Added Lines]",
          "517:     assert_equal %(<a data-foo=\"foo\">foo</a>), safe_list_sanitize(text, attributes: [\"data-foo\"])",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "569:     html = %{<a action='examp<!--\" unsafeattr=foo()>-->le.com'>test</a>}",
          "573:     acceptable_results = [",
          "574:       # nokogiri w/vendored+patched libxml2",
          "",
          "[Removed Lines]",
          "571:     text = safe_list_sanitize(html, attributes: ['action'])",
          "",
          "[Added Lines]",
          "573:     text = safe_list_sanitize(html, attributes: [\"action\"])",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "602:   end",
          "604:   def test_mediatype_text_html_disallowed",
          "607:     actual = safe_list_sanitize(input)",
          "608:     assert_equal(expected, actual)",
          "612:     actual = safe_list_sanitize(input)",
          "613:     assert_equal(expected, actual)",
          "614:   end",
          "616:   def test_mediatype_image_svg_xml_disallowed",
          "619:     actual = safe_list_sanitize(input)",
          "620:     assert_equal(expected, actual)",
          "624:     actual = safe_list_sanitize(input)",
          "625:     assert_equal(expected, actual)",
          "626:   end",
          "628:   def test_mediatype_other_disallowed",
          "631:     actual = safe_list_sanitize(input)",
          "632:     assert_equal(expected, actual)",
          "636:     actual = safe_list_sanitize(input)",
          "637:     assert_equal(expected, actual)",
          "638:   end",
          "640:   def test_scrubbing_svg_attr_values_that_allow_ref",
          "643:     actual = scope_allowed_attributes %w(fill) do",
          "644:       safe_list_sanitize(input)",
          "645:     end",
          "",
          "[Removed Lines]",
          "605:     input = %q(<img src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "606:     expected = %q(<img>)",
          "610:     input = %q(<img src=\"DATA:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "611:     expected = %q(<img>)",
          "617:     input = %q(<img src=\"data:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "618:     expected = %q(<img>)",
          "622:     input = %q(<img src=\"DATA:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">)",
          "623:     expected = %q(<img>)",
          "629:     input = %q(<a href=\"data:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>)",
          "630:     expected = %q(<a>foo</a>)",
          "634:     input = %q(<a href=\"DATA:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>)",
          "635:     expected = %q(<a>foo</a>)",
          "641:     input = %Q(<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>)",
          "642:     expected = %Q(<div fill=\"yellow #fff\">hey</div>)",
          "",
          "[Added Lines]",
          "607:     input = '<img src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "608:     expected = \"<img>\"",
          "612:     input = '<img src=\"DATA:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "613:     expected = \"<img>\"",
          "619:     input = '<img src=\"data:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "620:     expected = \"<img>\"",
          "624:     input = '<img src=\"DATA:image/svg+xml;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">'",
          "625:     expected = \"<img>\"",
          "631:     input = '<a href=\"data:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "632:     expected = \"<a>foo</a>\"",
          "636:     input = '<a href=\"DATA:foo;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=\">foo</a>'",
          "637:     expected = \"<a>foo</a>\"",
          "643:     input = '<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>'",
          "644:     expected = '<div fill=\"yellow #fff\">hey</div>'",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "754:   end",
          "756:   # note that this is used for testing CSS hex encoding: \\\\[0-9a-f]{1,6}",
          "758:     string.chars.map do |c|",
          "759:       if !escape_parens && (c == \"(\" || c == \")\")",
          "760:         c",
          "",
          "[Removed Lines]",
          "757:   def convert_to_css_hex(string, escape_parens=false)",
          "",
          "[Added Lines]",
          "758:   def convert_to_css_hex(string, escape_parens = false)",
          "",
          "---------------"
        ],
        "test/scrubbers_test.rb||test/scrubbers_test.rb": [
          "File: test/scrubbers_test.rb -> test/scrubbers_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: require \"minitest/autorun\"",
          "2: require \"rails-html-sanitizer\"",
          "4: class ScrubberTest < Minitest::Test",
          "5:   protected",
          "7:     def assert_scrubbed(html, expected = html)",
          "8:       output = Loofah.scrub_fragment(html, @scrubber).to_s",
          "9:       assert_equal expected, output",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # frozen_string_literal: true",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "38:   end",
          "40:   def test_default_scrub_behavior",
          "42:   end",
          "44:   def test_default_scrub_removes_comments",
          "47:   end",
          "49:   def test_default_scrub_removes_processing_instructions",
          "52:   end",
          "54:   def test_default_attributes_removal_behavior",
          "56:   end",
          "58:   def test_leaves_supplied_tags",
          "59:     @scrubber.tags = %w(a)",
          "61:   end",
          "63:   def test_leaves_only_supplied_tags",
          "65:     @scrubber.tags = %w(tag)",
          "67:   end",
          "69:   def test_prunes_tags",
          "70:     @scrubber = Rails::Html::PermitScrubber.new(prune: true)",
          "71:     @scrubber.tags = %w(tag)",
          "74:   end",
          "76:   def test_leaves_comments_when_supplied_as_tag",
          "77:     @scrubber.tags = %w(div comment)",
          "80:   end",
          "82:   def test_leaves_only_supplied_tags_nested",
          "84:     @scrubber.tags = %w(tag)",
          "86:   end",
          "88:   def test_leaves_supplied_attributes",
          "",
          "[Removed Lines]",
          "41:     assert_scrubbed '<tag>hello</tag>', 'hello'",
          "45:     assert_scrubbed('<div>one</div><!-- two --><span>three</span>',",
          "46:                     '<div>one</div><span>three</span>')",
          "50:     assert_scrubbed('<div>one</div><?div two><span>three</span>',",
          "51:                     '<div>one</div><span>three</span>')",
          "55:     assert_scrubbed '<p cooler=\"hello\">hello</p>', '<p>hello</p>'",
          "60:     assert_scrubbed '<a>hello</a>'",
          "64:     html = '<tag>leave me <span>now</span></tag>'",
          "66:     assert_scrubbed html, '<tag>leave me now</tag>'",
          "72:     html = '<tag>leave me <span>now</span></tag>'",
          "73:     assert_scrubbed html, '<tag>leave me </tag>'",
          "78:     assert_scrubbed('<div>one</div><!-- two --><span>three</span>',",
          "79:                     '<div>one</div><!-- two -->three')",
          "83:     html = '<tag>leave <em>me <span>now</span></em></tag>'",
          "85:     assert_scrubbed html, '<tag>leave me now</tag>'",
          "",
          "[Added Lines]",
          "41:     assert_scrubbed \"<tag>hello</tag>\", \"hello\"",
          "45:     assert_scrubbed(\"<div>one</div><!-- two --><span>three</span>\",",
          "46:                     \"<div>one</div><span>three</span>\")",
          "50:     assert_scrubbed(\"<div>one</div><?div two><span>three</span>\",",
          "51:                     \"<div>one</div><span>three</span>\")",
          "55:     assert_scrubbed '<p cooler=\"hello\">hello</p>', \"<p>hello</p>\"",
          "60:     assert_scrubbed \"<a>hello</a>\"",
          "64:     html = \"<tag>leave me <span>now</span></tag>\"",
          "66:     assert_scrubbed html, \"<tag>leave me now</tag>\"",
          "72:     html = \"<tag>leave me <span>now</span></tag>\"",
          "73:     assert_scrubbed html, \"<tag>leave me </tag>\"",
          "78:     assert_scrubbed(\"<div>one</div><!-- two --><span>three</span>\",",
          "79:                     \"<div>one</div><!-- two -->three\")",
          "83:     html = \"<tag>leave <em>me <span>now</span></em></tag>\"",
          "85:     assert_scrubbed html, \"<tag>leave me now</tag>\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "109:   end",
          "111:   def test_leaves_text",
          "113:   end",
          "115:   def test_skips_text_nodes",
          "117:   end",
          "119:   def test_tags_accessor_validation",
          "120:     e = assert_raises(ArgumentError) do",
          "122:     end",
          "124:     assert_equal \"You should pass :tags as an Enumerable\", e.message",
          "",
          "[Removed Lines]",
          "112:     assert_scrubbed('some text')",
          "116:     assert_node_skipped('some text')",
          "121:       @scrubber.tags = 'tag'",
          "",
          "[Added Lines]",
          "112:     assert_scrubbed(\"some text\")",
          "116:     assert_node_skipped(\"some text\")",
          "121:       @scrubber.tags = \"tag\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "128:   def test_attributes_accessor_validation",
          "129:     e = assert_raises(ArgumentError) do",
          "131:     end",
          "133:     assert_equal \"You should pass :attributes as an Enumerable\", e.message",
          "",
          "[Removed Lines]",
          "130:       @scrubber.attributes = 'cooler'",
          "",
          "[Added Lines]",
          "130:       @scrubber.attributes = \"cooler\"",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "143:   def test_targeting_tags_removes_only_them",
          "144:     @scrubber.tags = %w(a h1)",
          "147:   end",
          "149:   def test_targeting_tags_removes_only_them_nested",
          "150:     @scrubber.tags = %w(a)",
          "153:   end",
          "155:   def test_targeting_attributes_removes_only_them",
          "",
          "[Removed Lines]",
          "145:     html = '<script></script><a></a><h1></h1>'",
          "146:     assert_scrubbed html, '<script></script>'",
          "151:     html = '<tag><a><tag><a></a></tag></a></tag>'",
          "152:     assert_scrubbed html, '<tag><tag></tag></tag>'",
          "",
          "[Added Lines]",
          "145:     html = \"<script></script><a></a><h1></h1>\"",
          "146:     assert_scrubbed html, \"<script></script>\"",
          "151:     html = \"<tag><a><tag><a></a></tag></a></tag>\"",
          "152:     assert_scrubbed html, \"<tag><tag></tag></tag>\"",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "168:   def test_prunes_tags",
          "169:     @scrubber = Rails::Html::TargetScrubber.new(prune: true)",
          "170:     @scrubber.tags = %w(span)",
          "173:   end",
          "174: end",
          "",
          "[Removed Lines]",
          "171:     html = '<tag>leave me <span>now</span></tag>'",
          "172:     assert_scrubbed html, '<tag>leave me </tag>'",
          "",
          "[Added Lines]",
          "171:     html = \"<tag>leave me <span>now</span></tag>\"",
          "172:     assert_scrubbed html, \"<tag>leave me </tag>\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "179:   end",
          "181:   def test_removes_all_tags_and_keep_the_content",
          "183:   end",
          "185:   def test_skips_text_nodes",
          "187:   end",
          "188: end",
          "",
          "[Removed Lines]",
          "182:     assert_scrubbed '<tag>hello</tag>', 'hello'",
          "186:     assert_node_skipped('some text')",
          "",
          "[Added Lines]",
          "182:     assert_scrubbed \"<tag>hello</tag>\", \"hello\"",
          "186:     assert_node_skipped(\"some text\")",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "199:   end",
          "201:   def test_returns_stop_from_scrub_if_scrub_node_does",
          "203:   end",
          "204: end",
          "",
          "[Removed Lines]",
          "202:     assert_scrub_stopped '<script>remove me</script>'",
          "",
          "[Added Lines]",
          "202:     assert_scrub_stopped \"<script>remove me</script>\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f0e33477a0557dbdbefc3e470c7df3a64efb002a",
      "candidate_info": {
        "commit_hash": "f0e33477a0557dbdbefc3e470c7df3a64efb002a",
        "repo": "rails/rails-html-sanitizer",
        "commit_url": "https://github.com/rails/rails-html-sanitizer/commit/f0e33477a0557dbdbefc3e470c7df3a64efb002a",
        "files": [
          "lib/rails/html/scrubbers.rb",
          "test/sanitizer_test.rb"
        ],
        "message": "fix: replace slow regex attribute check with Loofah method\n\nwhich uses the Crass parser",
        "before_after_code_files": [
          "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
          "test/sanitizer_test.rb||test/sanitizer_test.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ],
          "candidate": [
            "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb",
            "test/sanitizer_test.rb||test/sanitizer_test.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/rails/html/scrubbers.rb||lib/rails/html/scrubbers.rb": [
          "File: lib/rails/html/scrubbers.rb -> lib/rails/html/scrubbers.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "145:             attr_node.remove",
          "146:           end",
          "147:         end",
          "148:         if Loofah::HTML5::SafeList::SVG_ATTR_VAL_ALLOWS_REF.include?(attr_name)",
          "150:         end",
          "151:         if Loofah::HTML5::SafeList::SVG_ALLOW_LOCAL_HREF.include?(node.name) && attr_name == 'xlink:href' && attr_node.value =~ /^\\s*[^#\\s].*/m",
          "152:           attr_node.remove",
          "153:         end",
          "",
          "[Removed Lines]",
          "149:           attr_node.value = attr_node.value.gsub(/url\\s*\\(\\s*[^#\\s][^)]+?\\)/m, ' ') if attr_node.value",
          "",
          "[Added Lines]",
          "150:           Loofah::HTML5::Scrub.scrub_attribute_that_allows_local_ref(attr_node)",
          "",
          "---------------"
        ],
        "test/sanitizer_test.rb||test/sanitizer_test.rb": [
          "File: test/sanitizer_test.rb -> test/sanitizer_test.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "600:     refute_includes(sanitized, \"style\")",
          "601:   end",
          "603: protected",
          "605:   def xpath_sanitize(input, options = {})",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "603:   def test_scrubbing_svg_attr_values_that_allow_ref",
          "604:     input = %Q(<div fill=\"yellow url(http://bad.com/) #fff\">hey</div>)",
          "605:     expected = %Q(<div fill=\"yellow #fff\">hey</div>)",
          "606:     actual = scope_allowed_attributes %w(fill) do",
          "607:       safe_list_sanitize(input)",
          "608:     end",
          "610:     assert_equal(expected, actual)",
          "611:   end",
          "",
          "---------------"
        ]
      }
    }
  ]
}