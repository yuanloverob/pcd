{
  "cve_id": "CVE-2021-3943",
  "cve_desc": "A flaw was found in Moodle in versions 3.11 to 3.11.3, 3.10 to 3.10.7, 3.9 to 3.9.10 and earlier unsupported versions. A remote code execution risk when restoring backup files was identified.",
  "repo": "moodle/moodle",
  "patch_hash": "58e8ad852f9e75c8158e5bee02c273383f7d9865",
  "patch_info": {
    "commit_hash": "58e8ad852f9e75c8158e5bee02c273383f7d9865",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/58e8ad852f9e75c8158e5bee02c273383f7d9865",
    "files": [
      "backup/moodle2/restore_block_task.class.php",
      "backup/moodle2/restore_stepslib.php",
      "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
      "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
      "blocks/html/backup/moodle2/restore_html_block_task.class.php",
      "blocks/html/classes/search/content.php",
      "blocks/html/edit_form.php",
      "blocks/html/lib.php",
      "blocks/moodleblock.class.php",
      "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
      "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
      "blocks/rss_client/edit_form.php",
      "blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
    ],
    "message": "MDL-70823 blocks: safer unserializing during block restore.",
    "before_after_code_files": [
      "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
      "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
      "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
      "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
      "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
      "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
      "blocks/html/edit_form.php||blocks/html/edit_form.php",
      "blocks/html/lib.php||blocks/html/lib.php",
      "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
      "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
      "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
      "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
      "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
    ]
  },
  "patch_diff": {
    "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php": [
      "File: backup/moodle2/restore_block_task.class.php -> backup/moodle2/restore_block_task.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "163:     abstract public function get_configdata_encoded_attributes();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "171:     protected function decode_configdata(string $configdata): stdClass {",
      "172:         return unserialize_object(base64_decode($configdata));",
      "173:     }",
      "",
      "---------------"
    ],
    "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php": [
      "File: backup/moodle2/restore_stepslib.php -> backup/moodle2/restore_stepslib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "4307:         if ($attrstotransform = $this->task->get_configdata_encoded_attributes()) {",
      "4309:             foreach ($configdata as $attribute => $value) {",
      "4310:                 if (in_array($attribute, $attrstotransform)) {",
      "4311:                     $configdata[$attribute] = $this->contentprocessor->process_cdata($value);",
      "",
      "[Removed Lines]",
      "4308:             $configdata = (array)unserialize(base64_decode($data->configdata));",
      "",
      "[Added Lines]",
      "4308:             $configdata = (array) unserialize_object(base64_decode($data->configdata));",
      "",
      "---------------"
    ],
    "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php": [
      "File: blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php -> blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "73:         $blockid = $this->get_blockid();",
      "75:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
      "77:             if (!empty($config->activityparentid)) {",
      "79:                 if ($mapping = restore_dbops::get_backup_ids_record($this->get_restoreid(),",
      "",
      "[Removed Lines]",
      "76:             $config = unserialize(base64_decode($configdata));",
      "",
      "[Added Lines]",
      "76:             $config = $this->decode_configdata($configdata);",
      "",
      "---------------"
    ],
    "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php": [
      "File: blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php -> blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "60:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
      "62:             if (!empty($config->glossary)) {",
      "63:                 if ($glossarymap = restore_dbops::get_backup_ids_record($this->get_restoreid(), 'glossary', $config->glossary)) {",
      "",
      "[Removed Lines]",
      "61:             $config = unserialize(base64_decode($configdata));",
      "",
      "[Added Lines]",
      "61:             $config = $this->decode_configdata($configdata);",
      "",
      "---------------"
    ],
    "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php": [
      "File: blocks/html/backup/moodle2/restore_html_block_task.class.php -> blocks/html/backup/moodle2/restore_html_block_task.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "82:     }",
      "84:     protected function preprocess_field($field) {",
      "86:         return isset($this->configdata->text) ? $this->configdata->text : '';",
      "87:     }",
      "",
      "[Removed Lines]",
      "85:         $this->configdata = unserialize(base64_decode($field));",
      "",
      "[Added Lines]",
      "85:         $this->configdata = unserialize_object(base64_decode($field));",
      "",
      "---------------"
    ],
    "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php": [
      "File: blocks/html/classes/search/content.php -> blocks/html/classes/search/content.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "43:                 $this->componentname, $this->areaname);",
      "49:         $content = content_to_text($data->text, $data->format);",
      "",
      "[Removed Lines]",
      "46:         $data = unserialize(base64_decode($record->configdata));",
      "",
      "[Added Lines]",
      "46:         $data = unserialize_object(base64_decode($record->configdata));",
      "",
      "---------------"
    ],
    "blocks/html/edit_form.php||blocks/html/edit_form.php": [
      "File: blocks/html/edit_form.php -> blocks/html/edit_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:     }",
      "53:     function set_data($defaults) {",
      "55:             $text = $this->block->config->text;",
      "56:             $draftid_editor = file_get_submitted_draft_itemid('config_text');",
      "57:             if (empty($text)) {",
      "",
      "[Removed Lines]",
      "54:         if (!empty($this->block->config) && is_object($this->block->config)) {",
      "",
      "[Added Lines]",
      "54:         if (!empty($this->block->config) && !empty($this->block->config->text)) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "61:             }",
      "62:             $defaults->config_text['text'] = file_prepare_draft_area($draftid_editor, $this->block->context->id, 'block_html', 'content', 0, array('subdirs'=>true), $currenttext);",
      "63:             $defaults->config_text['itemid'] = $draftid_editor;",
      "65:         } else {",
      "66:             $text = '';",
      "67:         }",
      "",
      "[Removed Lines]",
      "64:             $defaults->config_text['format'] = $this->block->config->format;",
      "",
      "[Added Lines]",
      "64:             $defaults->config_text['format'] = $this->block->config->format ?? FORMAT_MOODLE;",
      "",
      "---------------"
    ],
    "blocks/html/lib.php||blocks/html/lib.php": [
      "File: blocks/html/lib.php -> blocks/html/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "100:     $instances = $DB->get_recordset('block_instances', array('blockname' => 'html'));",
      "101:     foreach ($instances as $instance) {",
      "104:         if (isset($config->text) and is_string($config->text)) {",
      "105:             $config->text = str_replace($search, $replace, $config->text);",
      "106:             $DB->update_record('block_instances', ['id' => $instance->id,",
      "",
      "[Removed Lines]",
      "103:         $config = unserialize(base64_decode($instance->configdata));",
      "",
      "[Added Lines]",
      "103:         $config = unserialize_object(base64_decode($instance->configdata));",
      "",
      "---------------"
    ],
    "blocks/moodleblock.class.php||blocks/moodleblock.class.php": [
      "File: blocks/moodleblock.class.php -> blocks/moodleblock.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "471:     function _load_instance($instance, $page) {",
      "472:         if (!empty($instance->configdata)) {",
      "474:         }",
      "475:         $this->instance = $instance;",
      "476:         $this->context = context_block::instance($instance->id);",
      "",
      "[Removed Lines]",
      "473:             $this->config = unserialize(base64_decode($instance->configdata));",
      "",
      "[Added Lines]",
      "473:             $this->config = unserialize_object(base64_decode($instance->configdata));",
      "",
      "---------------"
    ],
    "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php": [
      "File: blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "37:         $block = $DB->get_record('block_instances', array('id' => $this->task->get_blockid()));",
      "41:         if (!empty($config->rssid)) {",
      "42:             $feedids = $config->rssid;",
      "",
      "[Removed Lines]",
      "39:         $config = unserialize(base64_decode($block->configdata));",
      "",
      "[Added Lines]",
      "39:         $config = unserialize_object(base64_decode($block->configdata));",
      "",
      "---------------"
    ],
    "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php": [
      "File: blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "77:         $configdata = $DB->get_field('block_instances', 'configdata', array('id' => $this->task->get_blockid()));",
      "84:         $config->rssid = $feedsarr;",
      "",
      "[Removed Lines]",
      "79:         $config = unserialize(base64_decode($configdata));",
      "80:         if (empty($config)) {",
      "81:             $config = new stdClass();",
      "82:         }",
      "",
      "[Added Lines]",
      "79:         $config = unserialize_object(base64_decode($configdata));",
      "",
      "---------------"
    ],
    "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php": [
      "File: blocks/rss_client/edit_form.php -> blocks/rss_client/edit_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "50:         $insql = '';",
      "51:         $params = array('userid' => $USER->id);",
      "55:             $insql = \"OR id $insql \";",
      "56:             $params += $inparams;",
      "57:         }",
      "",
      "[Removed Lines]",
      "52:         $rssconfig = unserialize(base64_decode($this->block->instance->configdata));",
      "53:         if ($rssconfig && !empty($rssconfig->rssid)) {",
      "54:             list($insql, $inparams) = $DB->get_in_or_equal($rssconfig->rssid, SQL_PARAMS_NAMED);",
      "",
      "[Added Lines]",
      "52:         if (!empty($this->block->config) && !empty($this->block->config->rssid)) {",
      "53:             list($insql, $inparams) = $DB->get_in_or_equal($this->block->config->rssid, SQL_PARAMS_NAMED);",
      "",
      "---------------"
    ],
    "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php": [
      "File: blocks/tags/backup/moodle2/restore_tags_block_task.class.php -> blocks/tags/backup/moodle2/restore_tags_block_task.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "59:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
      "61:             $changed = false;",
      "62:             if (!empty($config->tagcoll) && $config->tagcoll > 1 && !$this->is_samesite()) {",
      "63:                 $config->tagcoll = 0;",
      "",
      "[Removed Lines]",
      "60:             $config = unserialize(base64_decode($configdata));",
      "",
      "[Added Lines]",
      "60:             $config = $this->decode_configdata($configdata);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f18f500a115b85ea0f2d41857bcece9f065fa2e8",
      "candidate_info": {
        "commit_hash": "f18f500a115b85ea0f2d41857bcece9f065fa2e8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f18f500a115b85ea0f2d41857bcece9f065fa2e8",
        "files": [
          "backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php",
          "blocks/html/lib.php",
          "blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ],
        "message": "MDL-70823 blocks: safer unserializing during block restore.",
        "before_after_code_files": [
          "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php||blocks/html/edit_form.php",
          "blocks/html/lib.php||blocks/html/lib.php",
          "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ],
          "candidate": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ]
        }
      },
      "candidate_diff": {
        "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php": [
          "File: backup/moodle2/restore_block_task.class.php -> backup/moodle2/restore_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "163:     abstract public function get_configdata_encoded_attributes();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "171:     protected function decode_configdata(string $configdata): stdClass {",
          "172:         return unserialize_object(base64_decode($configdata));",
          "173:     }",
          "",
          "---------------"
        ],
        "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php": [
          "File: backup/moodle2/restore_stepslib.php -> backup/moodle2/restore_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4207:         if ($attrstotransform = $this->task->get_configdata_encoded_attributes()) {",
          "4209:             foreach ($configdata as $attribute => $value) {",
          "4210:                 if (in_array($attribute, $attrstotransform)) {",
          "4211:                     $configdata[$attribute] = $this->contentprocessor->process_cdata($value);",
          "",
          "[Removed Lines]",
          "4208:             $configdata = (array)unserialize(base64_decode($data->configdata));",
          "",
          "[Added Lines]",
          "4208:             $configdata = (array) unserialize_object(base64_decode($data->configdata));",
          "",
          "---------------"
        ],
        "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php": [
          "File: blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php -> blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:         $blockid = $this->get_blockid();",
          "75:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "77:             if (!empty($config->activityparentid)) {",
          "79:                 if ($mapping = restore_dbops::get_backup_ids_record($this->get_restoreid(),",
          "",
          "[Removed Lines]",
          "76:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "76:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php": [
          "File: blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php -> blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "62:             if (!empty($config->glossary)) {",
          "63:                 if ($glossarymap = restore_dbops::get_backup_ids_record($this->get_restoreid(), 'glossary', $config->glossary)) {",
          "",
          "[Removed Lines]",
          "61:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "61:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php": [
          "File: blocks/html/backup/moodle2/restore_html_block_task.class.php -> blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:     }",
          "84:     protected function preprocess_field($field) {",
          "86:         return isset($this->configdata->text) ? $this->configdata->text : '';",
          "87:     }",
          "",
          "[Removed Lines]",
          "85:         $this->configdata = unserialize(base64_decode($field));",
          "",
          "[Added Lines]",
          "85:         $this->configdata = unserialize_object(base64_decode($field));",
          "",
          "---------------"
        ],
        "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php": [
          "File: blocks/html/classes/search/content.php -> blocks/html/classes/search/content.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:                 $this->componentname, $this->areaname);",
          "49:         $content = content_to_text($data->text, $data->format);",
          "",
          "[Removed Lines]",
          "46:         $data = unserialize(base64_decode($record->configdata));",
          "",
          "[Added Lines]",
          "46:         $data = unserialize_object(base64_decode($record->configdata));",
          "",
          "---------------"
        ],
        "blocks/html/edit_form.php||blocks/html/edit_form.php": [
          "File: blocks/html/edit_form.php -> blocks/html/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     }",
          "53:     function set_data($defaults) {",
          "55:             $text = $this->block->config->text;",
          "56:             $draftid_editor = file_get_submitted_draft_itemid('config_text');",
          "57:             if (empty($text)) {",
          "",
          "[Removed Lines]",
          "54:         if (!empty($this->block->config) && is_object($this->block->config)) {",
          "",
          "[Added Lines]",
          "54:         if (!empty($this->block->config) && !empty($this->block->config->text)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:             }",
          "62:             $defaults->config_text['text'] = file_prepare_draft_area($draftid_editor, $this->block->context->id, 'block_html', 'content', 0, array('subdirs'=>true), $currenttext);",
          "63:             $defaults->config_text['itemid'] = $draftid_editor;",
          "65:         } else {",
          "66:             $text = '';",
          "67:         }",
          "",
          "[Removed Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format;",
          "",
          "[Added Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format ?? FORMAT_MOODLE;",
          "",
          "---------------"
        ],
        "blocks/html/lib.php||blocks/html/lib.php": [
          "File: blocks/html/lib.php -> blocks/html/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:     $instances = $DB->get_recordset('block_instances', array('blockname' => 'html'));",
          "101:     foreach ($instances as $instance) {",
          "104:         if (isset($config->text) and is_string($config->text)) {",
          "105:             $config->text = str_replace($search, $replace, $config->text);",
          "106:             $DB->update_record('block_instances', ['id' => $instance->id,",
          "",
          "[Removed Lines]",
          "103:         $config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "103:         $config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/moodleblock.class.php||blocks/moodleblock.class.php": [
          "File: blocks/moodleblock.class.php -> blocks/moodleblock.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "471:     function _load_instance($instance, $page) {",
          "472:         if (!empty($instance->configdata)) {",
          "474:         }",
          "475:         $this->instance = $instance;",
          "476:         $this->context = context_block::instance($instance->id);",
          "",
          "[Removed Lines]",
          "473:             $this->config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "473:             $this->config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php": [
          "File: blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php -> blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         if (!empty($configdata)) {",
          "71:             $config->activityparent = 'quiz';",
          "72:             $config->activityparentid = 0;",
          "73:             $config->gradeformat = isset($config->gradeformat) ? $config->gradeformat : 1;",
          "",
          "[Removed Lines]",
          "70:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "69:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         $block = $DB->get_record('block_instances', array('id' => $this->task->get_blockid()));",
          "41:         if (!empty($config->rssid)) {",
          "42:             $feedids = $config->rssid;",
          "",
          "[Removed Lines]",
          "39:         $config = unserialize(base64_decode($block->configdata));",
          "",
          "[Added Lines]",
          "39:         $config = unserialize_object(base64_decode($block->configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "77:         $configdata = $DB->get_field('block_instances', 'configdata', array('id' => $this->task->get_blockid()));",
          "84:         $config->rssid = $feedsarr;",
          "",
          "[Removed Lines]",
          "79:         $config = unserialize(base64_decode($configdata));",
          "80:         if (empty($config)) {",
          "81:             $config = new stdClass();",
          "82:         }",
          "",
          "[Added Lines]",
          "79:         $config = unserialize_object(base64_decode($configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php": [
          "File: blocks/rss_client/edit_form.php -> blocks/rss_client/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:         $insql = '';",
          "51:         $params = array('userid' => $USER->id);",
          "55:             $insql = \"OR id $insql \";",
          "56:             $params += $inparams;",
          "57:         }",
          "",
          "[Removed Lines]",
          "52:         $rssconfig = unserialize(base64_decode($this->block->instance->configdata));",
          "53:         if ($rssconfig && !empty($rssconfig->rssid)) {",
          "54:             list($insql, $inparams) = $DB->get_in_or_equal($rssconfig->rssid, SQL_PARAMS_NAMED);",
          "",
          "[Added Lines]",
          "52:         if (!empty($this->block->config) && !empty($this->block->config->rssid)) {",
          "53:             list($insql, $inparams) = $DB->get_in_or_equal($this->block->config->rssid, SQL_PARAMS_NAMED);",
          "",
          "---------------"
        ],
        "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php": [
          "File: blocks/tags/backup/moodle2/restore_tags_block_task.class.php -> blocks/tags/backup/moodle2/restore_tags_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "61:             $changed = false;",
          "62:             if (!empty($config->tagcoll) && $config->tagcoll > 1 && !$this->is_samesite()) {",
          "63:                 $config->tagcoll = 0;",
          "",
          "[Removed Lines]",
          "60:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "60:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4010ec81f4ef06fda59f2517ffbf4a9115c1827",
      "candidate_info": {
        "commit_hash": "c4010ec81f4ef06fda59f2517ffbf4a9115c1827",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c4010ec81f4ef06fda59f2517ffbf4a9115c1827",
        "files": [
          "backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php",
          "blocks/html/lib.php",
          "blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ],
        "message": "MDL-70823 blocks: safer unserializing during block restore.",
        "before_after_code_files": [
          "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php||blocks/html/edit_form.php",
          "blocks/html/lib.php||blocks/html/lib.php",
          "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ],
          "candidate": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ]
        }
      },
      "candidate_diff": {
        "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php": [
          "File: backup/moodle2/restore_block_task.class.php -> backup/moodle2/restore_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "163:     abstract public function get_configdata_encoded_attributes();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "171:     protected function decode_configdata(string $configdata): stdClass {",
          "172:         return unserialize_object(base64_decode($configdata));",
          "173:     }",
          "",
          "---------------"
        ],
        "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php": [
          "File: backup/moodle2/restore_stepslib.php -> backup/moodle2/restore_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4198:         if ($attrstotransform = $this->task->get_configdata_encoded_attributes()) {",
          "4200:             foreach ($configdata as $attribute => $value) {",
          "4201:                 if (in_array($attribute, $attrstotransform)) {",
          "4202:                     $configdata[$attribute] = $this->contentprocessor->process_cdata($value);",
          "",
          "[Removed Lines]",
          "4199:             $configdata = (array)unserialize(base64_decode($data->configdata));",
          "",
          "[Added Lines]",
          "4199:             $configdata = (array) unserialize_object(base64_decode($data->configdata));",
          "",
          "---------------"
        ],
        "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php": [
          "File: blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php -> blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:         $blockid = $this->get_blockid();",
          "75:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "77:             if (!empty($config->activityparentid)) {",
          "79:                 if ($mapping = restore_dbops::get_backup_ids_record($this->get_restoreid(),",
          "",
          "[Removed Lines]",
          "76:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "76:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php": [
          "File: blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php -> blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "62:             if (!empty($config->glossary)) {",
          "63:                 if ($glossarymap = restore_dbops::get_backup_ids_record($this->get_restoreid(), 'glossary', $config->glossary)) {",
          "",
          "[Removed Lines]",
          "61:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "61:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php": [
          "File: blocks/html/backup/moodle2/restore_html_block_task.class.php -> blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:     }",
          "84:     protected function preprocess_field($field) {",
          "86:         return isset($this->configdata->text) ? $this->configdata->text : '';",
          "87:     }",
          "",
          "[Removed Lines]",
          "85:         $this->configdata = unserialize(base64_decode($field));",
          "",
          "[Added Lines]",
          "85:         $this->configdata = unserialize_object(base64_decode($field));",
          "",
          "---------------"
        ],
        "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php": [
          "File: blocks/html/classes/search/content.php -> blocks/html/classes/search/content.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:                 $this->componentname, $this->areaname);",
          "49:         $content = content_to_text($data->text, $data->format);",
          "",
          "[Removed Lines]",
          "46:         $data = unserialize(base64_decode($record->configdata));",
          "",
          "[Added Lines]",
          "46:         $data = unserialize_object(base64_decode($record->configdata));",
          "",
          "---------------"
        ],
        "blocks/html/edit_form.php||blocks/html/edit_form.php": [
          "File: blocks/html/edit_form.php -> blocks/html/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     }",
          "53:     function set_data($defaults) {",
          "55:             $text = $this->block->config->text;",
          "56:             $draftid_editor = file_get_submitted_draft_itemid('config_text');",
          "57:             if (empty($text)) {",
          "",
          "[Removed Lines]",
          "54:         if (!empty($this->block->config) && is_object($this->block->config)) {",
          "",
          "[Added Lines]",
          "54:         if (!empty($this->block->config) && !empty($this->block->config->text)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:             }",
          "62:             $defaults->config_text['text'] = file_prepare_draft_area($draftid_editor, $this->block->context->id, 'block_html', 'content', 0, array('subdirs'=>true), $currenttext);",
          "63:             $defaults->config_text['itemid'] = $draftid_editor;",
          "65:         } else {",
          "66:             $text = '';",
          "67:         }",
          "",
          "[Removed Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format;",
          "",
          "[Added Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format ?? FORMAT_MOODLE;",
          "",
          "---------------"
        ],
        "blocks/html/lib.php||blocks/html/lib.php": [
          "File: blocks/html/lib.php -> blocks/html/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:     $instances = $DB->get_recordset('block_instances', array('blockname' => 'html'));",
          "101:     foreach ($instances as $instance) {",
          "104:         if (isset($config->text) and is_string($config->text)) {",
          "105:             $config->text = str_replace($search, $replace, $config->text);",
          "106:             $DB->update_record('block_instances', ['id' => $instance->id,",
          "",
          "[Removed Lines]",
          "103:         $config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "103:         $config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/moodleblock.class.php||blocks/moodleblock.class.php": [
          "File: blocks/moodleblock.class.php -> blocks/moodleblock.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "471:     function _load_instance($instance, $page) {",
          "472:         if (!empty($instance->configdata)) {",
          "474:         }",
          "475:         $this->instance = $instance;",
          "476:         $this->context = context_block::instance($instance->id);",
          "",
          "[Removed Lines]",
          "473:             $this->config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "473:             $this->config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php": [
          "File: blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php -> blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         if (!empty($configdata)) {",
          "71:             $config->activityparent = 'quiz';",
          "72:             $config->activityparentid = 0;",
          "73:             $config->gradeformat = isset($config->gradeformat) ? $config->gradeformat : 1;",
          "",
          "[Removed Lines]",
          "70:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "69:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         $block = $DB->get_record('block_instances', array('id' => $this->task->get_blockid()));",
          "41:         if (!empty($config->rssid)) {",
          "42:             $feedids = $config->rssid;",
          "",
          "[Removed Lines]",
          "39:         $config = unserialize(base64_decode($block->configdata));",
          "",
          "[Added Lines]",
          "39:         $config = unserialize_object(base64_decode($block->configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "77:         $configdata = $DB->get_field('block_instances', 'configdata', array('id' => $this->task->get_blockid()));",
          "84:         $config->rssid = $feedsarr;",
          "",
          "[Removed Lines]",
          "79:         $config = unserialize(base64_decode($configdata));",
          "80:         if (empty($config)) {",
          "81:             $config = new stdClass();",
          "82:         }",
          "",
          "[Added Lines]",
          "79:         $config = unserialize_object(base64_decode($configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php": [
          "File: blocks/rss_client/edit_form.php -> blocks/rss_client/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:         $insql = '';",
          "51:         $params = array('userid' => $USER->id);",
          "55:             $insql = \"OR id $insql \";",
          "56:             $params += $inparams;",
          "57:         }",
          "",
          "[Removed Lines]",
          "52:         $rssconfig = unserialize(base64_decode($this->block->instance->configdata));",
          "53:         if ($rssconfig && !empty($rssconfig->rssid)) {",
          "54:             list($insql, $inparams) = $DB->get_in_or_equal($rssconfig->rssid, SQL_PARAMS_NAMED);",
          "",
          "[Added Lines]",
          "52:         if (!empty($this->block->config) && !empty($this->block->config->rssid)) {",
          "53:             list($insql, $inparams) = $DB->get_in_or_equal($this->block->config->rssid, SQL_PARAMS_NAMED);",
          "",
          "---------------"
        ],
        "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php": [
          "File: blocks/tags/backup/moodle2/restore_tags_block_task.class.php -> blocks/tags/backup/moodle2/restore_tags_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "61:             $changed = false;",
          "62:             if (!empty($config->tagcoll) && $config->tagcoll > 1 && !$this->is_samesite()) {",
          "63:                 $config->tagcoll = 0;",
          "",
          "[Removed Lines]",
          "60:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "60:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "294fa223c95dc5dec215ad3de50c281f2e715fb0",
      "candidate_info": {
        "commit_hash": "294fa223c95dc5dec215ad3de50c281f2e715fb0",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/294fa223c95dc5dec215ad3de50c281f2e715fb0",
        "files": [
          "backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php",
          "blocks/html/lib.php",
          "blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ],
        "message": "MDL-70823 blocks: safer unserializing during block restore.",
        "before_after_code_files": [
          "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
          "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
          "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
          "blocks/html/edit_form.php||blocks/html/edit_form.php",
          "blocks/html/lib.php||blocks/html/lib.php",
          "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
          "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
          "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ],
          "candidate": [
            "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php",
            "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php",
            "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
            "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
            "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php",
            "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php",
            "blocks/html/edit_form.php||blocks/html/edit_form.php",
            "blocks/html/lib.php||blocks/html/lib.php",
            "blocks/moodleblock.class.php||blocks/moodleblock.class.php",
            "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
            "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
            "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php",
            "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php"
          ]
        }
      },
      "candidate_diff": {
        "backup/moodle2/restore_block_task.class.php||backup/moodle2/restore_block_task.class.php": [
          "File: backup/moodle2/restore_block_task.class.php -> backup/moodle2/restore_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "163:     abstract public function get_configdata_encoded_attributes();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "171:     protected function decode_configdata(string $configdata): stdClass {",
          "172:         return unserialize_object(base64_decode($configdata));",
          "173:     }",
          "",
          "---------------"
        ],
        "backup/moodle2/restore_stepslib.php||backup/moodle2/restore_stepslib.php": [
          "File: backup/moodle2/restore_stepslib.php -> backup/moodle2/restore_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4307:         if ($attrstotransform = $this->task->get_configdata_encoded_attributes()) {",
          "4309:             foreach ($configdata as $attribute => $value) {",
          "4310:                 if (in_array($attribute, $attrstotransform)) {",
          "4311:                     $configdata[$attribute] = $this->contentprocessor->process_cdata($value);",
          "",
          "[Removed Lines]",
          "4308:             $configdata = (array)unserialize(base64_decode($data->configdata));",
          "",
          "[Added Lines]",
          "4308:             $configdata = (array) unserialize_object(base64_decode($data->configdata));",
          "",
          "---------------"
        ],
        "blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php||blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php": [
          "File: blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php -> blocks/activity_results/backup/moodle2/restore_activity_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:         $blockid = $this->get_blockid();",
          "75:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "77:             if (!empty($config->activityparentid)) {",
          "79:                 if ($mapping = restore_dbops::get_backup_ids_record($this->get_restoreid(),",
          "",
          "[Removed Lines]",
          "76:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "76:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php||blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php": [
          "File: blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php -> blocks/glossary_random/backup/moodle2/restore_glossary_random_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "62:             if (!empty($config->glossary)) {",
          "63:                 if ($glossarymap = restore_dbops::get_backup_ids_record($this->get_restoreid(), 'glossary', $config->glossary)) {",
          "",
          "[Removed Lines]",
          "61:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "61:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/html/backup/moodle2/restore_html_block_task.class.php||blocks/html/backup/moodle2/restore_html_block_task.class.php": [
          "File: blocks/html/backup/moodle2/restore_html_block_task.class.php -> blocks/html/backup/moodle2/restore_html_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:     }",
          "84:     protected function preprocess_field($field) {",
          "86:         return isset($this->configdata->text) ? $this->configdata->text : '';",
          "87:     }",
          "",
          "[Removed Lines]",
          "85:         $this->configdata = unserialize(base64_decode($field));",
          "",
          "[Added Lines]",
          "85:         $this->configdata = unserialize_object(base64_decode($field));",
          "",
          "---------------"
        ],
        "blocks/html/classes/search/content.php||blocks/html/classes/search/content.php": [
          "File: blocks/html/classes/search/content.php -> blocks/html/classes/search/content.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:                 $this->componentname, $this->areaname);",
          "49:         $content = content_to_text($data->text, $data->format);",
          "",
          "[Removed Lines]",
          "46:         $data = unserialize(base64_decode($record->configdata));",
          "",
          "[Added Lines]",
          "46:         $data = unserialize_object(base64_decode($record->configdata));",
          "",
          "---------------"
        ],
        "blocks/html/edit_form.php||blocks/html/edit_form.php": [
          "File: blocks/html/edit_form.php -> blocks/html/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     }",
          "53:     function set_data($defaults) {",
          "55:             $text = $this->block->config->text;",
          "56:             $draftid_editor = file_get_submitted_draft_itemid('config_text');",
          "57:             if (empty($text)) {",
          "",
          "[Removed Lines]",
          "54:         if (!empty($this->block->config) && is_object($this->block->config)) {",
          "",
          "[Added Lines]",
          "54:         if (!empty($this->block->config) && !empty($this->block->config->text)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "61:             }",
          "62:             $defaults->config_text['text'] = file_prepare_draft_area($draftid_editor, $this->block->context->id, 'block_html', 'content', 0, array('subdirs'=>true), $currenttext);",
          "63:             $defaults->config_text['itemid'] = $draftid_editor;",
          "65:         } else {",
          "66:             $text = '';",
          "67:         }",
          "",
          "[Removed Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format;",
          "",
          "[Added Lines]",
          "64:             $defaults->config_text['format'] = $this->block->config->format ?? FORMAT_MOODLE;",
          "",
          "---------------"
        ],
        "blocks/html/lib.php||blocks/html/lib.php": [
          "File: blocks/html/lib.php -> blocks/html/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:     $instances = $DB->get_recordset('block_instances', array('blockname' => 'html'));",
          "101:     foreach ($instances as $instance) {",
          "104:         if (isset($config->text) and is_string($config->text)) {",
          "105:             $config->text = str_replace($search, $replace, $config->text);",
          "106:             $DB->update_record('block_instances', ['id' => $instance->id,",
          "",
          "[Removed Lines]",
          "103:         $config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "103:         $config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/moodleblock.class.php||blocks/moodleblock.class.php": [
          "File: blocks/moodleblock.class.php -> blocks/moodleblock.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "471:     function _load_instance($instance, $page) {",
          "472:         if (!empty($instance->configdata)) {",
          "474:         }",
          "475:         $this->instance = $instance;",
          "476:         $this->context = context_block::instance($instance->id);",
          "",
          "[Removed Lines]",
          "473:             $this->config = unserialize(base64_decode($instance->configdata));",
          "",
          "[Added Lines]",
          "473:             $this->config = unserialize_object(base64_decode($instance->configdata));",
          "",
          "---------------"
        ],
        "blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php||blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php": [
          "File: blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php -> blocks/quiz_results/backup/moodle2/restore_quiz_results_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         if (!empty($configdata)) {",
          "71:             $config->activityparent = 'quiz';",
          "72:             $config->activityparentid = 0;",
          "73:             $config->gradeformat = isset($config->gradeformat) ? $config->gradeformat : 1;",
          "",
          "[Removed Lines]",
          "70:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "69:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/backup_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:         $block = $DB->get_record('block_instances', array('id' => $this->task->get_blockid()));",
          "41:         if (!empty($config->rssid)) {",
          "42:             $feedids = $config->rssid;",
          "",
          "[Removed Lines]",
          "39:         $config = unserialize(base64_decode($block->configdata));",
          "",
          "[Added Lines]",
          "39:         $config = unserialize_object(base64_decode($block->configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php||blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php": [
          "File: blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php -> blocks/rss_client/backup/moodle2/restore_rss_client_stepslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "77:         $configdata = $DB->get_field('block_instances', 'configdata', array('id' => $this->task->get_blockid()));",
          "84:         $config->rssid = $feedsarr;",
          "",
          "[Removed Lines]",
          "79:         $config = unserialize(base64_decode($configdata));",
          "80:         if (empty($config)) {",
          "81:             $config = new stdClass();",
          "82:         }",
          "",
          "[Added Lines]",
          "79:         $config = unserialize_object(base64_decode($configdata));",
          "",
          "---------------"
        ],
        "blocks/rss_client/edit_form.php||blocks/rss_client/edit_form.php": [
          "File: blocks/rss_client/edit_form.php -> blocks/rss_client/edit_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:         $insql = '';",
          "51:         $params = array('userid' => $USER->id);",
          "55:             $insql = \"OR id $insql \";",
          "56:             $params += $inparams;",
          "57:         }",
          "",
          "[Removed Lines]",
          "52:         $rssconfig = unserialize(base64_decode($this->block->instance->configdata));",
          "53:         if ($rssconfig && !empty($rssconfig->rssid)) {",
          "54:             list($insql, $inparams) = $DB->get_in_or_equal($rssconfig->rssid, SQL_PARAMS_NAMED);",
          "",
          "[Added Lines]",
          "52:         if (!empty($this->block->config) && !empty($this->block->config->rssid)) {",
          "53:             list($insql, $inparams) = $DB->get_in_or_equal($this->block->config->rssid, SQL_PARAMS_NAMED);",
          "",
          "---------------"
        ],
        "blocks/tags/backup/moodle2/restore_tags_block_task.class.php||blocks/tags/backup/moodle2/restore_tags_block_task.class.php": [
          "File: blocks/tags/backup/moodle2/restore_tags_block_task.class.php -> blocks/tags/backup/moodle2/restore_tags_block_task.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         if ($configdata = $DB->get_field('block_instances', 'configdata', array('id' => $blockid))) {",
          "61:             $changed = false;",
          "62:             if (!empty($config->tagcoll) && $config->tagcoll > 1 && !$this->is_samesite()) {",
          "63:                 $config->tagcoll = 0;",
          "",
          "[Removed Lines]",
          "60:             $config = unserialize(base64_decode($configdata));",
          "",
          "[Added Lines]",
          "60:             $config = $this->decode_configdata($configdata);",
          "",
          "---------------"
        ]
      }
    }
  ]
}