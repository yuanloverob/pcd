{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "078699a1a5117470335ef2e5f89e7b9b04ca34b6",
      "candidate_info": {
        "commit_hash": "078699a1a5117470335ef2e5f89e7b9b04ca34b6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/078699a1a5117470335ef2e5f89e7b9b04ca34b6",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.7+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019052000.02;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7+ (Build: 20190530)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019052000.03;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7+ (Build: 20190606)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4b0cf053dc924fe505c8c8f2f29bd8ee3b628b11",
      "candidate_info": {
        "commit_hash": "4b0cf053dc924fe505c8c8f2f29bd8ee3b628b11",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4b0cf053dc924fe505c8c8f2f29bd8ee3b628b11",
        "files": [
          "lib/classes/oauth2/api.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-64206 core: updated FB logo URL",
        "before_after_code_files": [
          "lib/classes/oauth2/api.php||lib/classes/oauth2/api.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/classes/oauth2/api.php||lib/classes/oauth2/api.php": [
          "File: lib/classes/oauth2/api.php -> lib/classes/oauth2/api.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:         $record = (object) [",
          "88:             'name' => 'Facebook',",
          "90:             'baseurl' => '',",
          "91:             'loginscopes' => 'public_profile email',",
          "92:             'loginscopesoffline' => 'public_profile email',",
          "",
          "[Removed Lines]",
          "89:             'image' => 'https://facebookbrand.com/wp-content/themes/fb-branding/prj-fb-branding/assets/images/fb-art.png',",
          "",
          "[Added Lines]",
          "89:             'image' => 'https://facebookbrand.com/wp-content/uploads/2016/05/flogo_rgb_hex-brc-site-250.png',",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2854:         upgrade_main_savepoint(true, 2018112000.00);",
          "2855:     }",
          "2857:     return true;",
          "2858: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2857:     if ($oldversion < 2018120300.01) {",
          "2859:         $oldurl = 'https://facebookbrand.com/wp-content/themes/fb-branding/prj-fb-branding/assets/images/fb-art.png';",
          "2860:         $newurl = 'https://facebookbrand.com/wp-content/uploads/2016/05/flogo_rgb_hex-brc-site-250.png';",
          "2862:         $updatesql = \"UPDATE {oauth2_issuer}",
          "2863:                          SET image = :newimage",
          "2864:                        WHERE image = :oldimage\";",
          "2865:         $params = [",
          "2866:             'newimage' => $newurl,",
          "2867:             'oldimage' => $oldurl",
          "2868:         ];",
          "2869:         $DB->execute($updatesql, $params);",
          "2871:         upgrade_main_savepoint(true, 2018120300.01);",
          "2872:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018120300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018120300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6e2e63457efc2a5f2ef93d981c39a728f4470cb3",
      "candidate_info": {
        "commit_hash": "6e2e63457efc2a5f2ef93d981c39a728f4470cb3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6e2e63457efc2a5f2ef93d981c39a728f4470cb3",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018083100.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180831)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018090700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180907)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ce93b0f99709ff0c8e9d549c6244d7a81c2891e8",
      "candidate_info": {
        "commit_hash": "ce93b0f99709ff0c8e9d549c6244d7a81c2891e8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ce93b0f99709ff0c8e9d549c6244d7a81c2891e8",
        "files": [
          "version.php"
        ],
        "message": "MDL-64855 version: Bump for the new setting",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019041300.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019041300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8350978aa150a16fe95b2f5ef569c012244a4b3a",
      "candidate_info": {
        "commit_hash": "8350978aa150a16fe95b2f5ef569c012244a4b3a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8350978aa150a16fe95b2f5ef569c012244a4b3a",
        "files": [
          "lib/db/services.php",
          "message/externallib.php",
          "version.php"
        ],
        "message": "MDL-63303 message: add get_member_info external function",
        "before_after_code_files": [
          "lib/db/services.php||lib/db/services.php",
          "message/externallib.php||message/externallib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/services.php||lib/db/services.php": [
          "File: lib/db/services.php -> lib/db/services.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1105:         'services' => array(MOODLE_OFFICIAL_MOBILE_SERVICE),",
          "1106:         'ajax' => true,",
          "1107:     ),",
          "1108:     'core_message_get_unread_conversations_count' => array(",
          "1109:         'classname' => 'core_message_external',",
          "1110:         'methodname' => 'get_unread_conversations_count',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1108:     'core_message_get_member_info' => array(",
          "1109:         'classname' => 'core_message_external',",
          "1110:         'methodname' => 'get_member_info',",
          "1111:         'classpath' => 'message/externallib.php',",
          "1112:         'description' => 'Retrieve a user message profiles',",
          "1113:         'type' => 'read',",
          "1114:         'services' => array(MOODLE_OFFICIAL_MOBILE_SERVICE),",
          "1115:         'ajax' => true,",
          "1116:     ),",
          "",
          "---------------"
        ],
        "message/externallib.php||message/externallib.php": [
          "File: message/externallib.php -> message/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3953:     public static function unset_favourite_conversations_returns() {",
          "3954:         return new external_warnings();",
          "3955:     }",
          "3956: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3962:     public static function get_member_info_parameters() {",
          "3963:         return new external_function_parameters(",
          "3964:             array(",
          "3965:                 'referenceuserid' => new external_value(PARAM_INT, 'id of the user'),",
          "3966:                 'userids' => new external_multiple_structure(",
          "3967:                     new external_value(PARAM_INT, 'id of members to get')",
          "3968:                 ),",
          "3969:                 'includecontactrequests' => new external_value(PARAM_BOOL, 'include contact requests in response', VALUE_DEFAULT, false),",
          "3970:                 'includeprivacyinfo' => new external_value(PARAM_BOOL, 'include privacy info in response', VALUE_DEFAULT, false)",
          "3971:             )",
          "3972:         );",
          "3973:     }",
          "3986:     public static function get_member_info(",
          "3987:         int $referenceuserid,",
          "3988:         array $userids,",
          "3989:         bool $includecontactrequests = false,",
          "3990:         bool $includeprivacyinfo = false",
          "3991:     ) {",
          "3992:         global $CFG, $USER;",
          "3995:         if (empty($CFG->messaging)) {",
          "3996:             throw new moodle_exception('disabled', 'message');",
          "3997:         }",
          "3998:         $params = [",
          "3999:             'referenceuserid' => $referenceuserid,",
          "4000:             'userids' => $userids,",
          "4001:             'includecontactrequests' => $includecontactrequests,",
          "4002:             'includeprivacyinfo' => $includeprivacyinfo",
          "4003:         ];",
          "4004:         $params = self::validate_parameters(self::get_member_info_parameters(), $params);",
          "4005:         $systemcontext = context_system::instance();",
          "4006:         self::validate_context($systemcontext);",
          "4008:         if (($USER->id != $referenceuserid) && !has_capability('moodle/site:readallmessages', $systemcontext)) {",
          "4009:             throw new moodle_exception('You do not have permission to perform this action.');",
          "4010:         }",
          "4012:         return \\core_message\\helper::get_member_info(",
          "4013:             $params['referenceuserid'],",
          "4014:             $params['userids'],",
          "4015:             $params['includecontactrequests'],",
          "4016:             $params['includeprivacyinfo']",
          "4017:         );",
          "4018:     }",
          "4025:     public static function get_member_info_returns() {",
          "4026:         return new external_multiple_structure(",
          "4027:             self::get_conversation_member_structure(true)",
          "4028:         );",
          "4029:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111301.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018111301.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}