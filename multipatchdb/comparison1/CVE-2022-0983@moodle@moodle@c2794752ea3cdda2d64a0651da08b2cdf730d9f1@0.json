{
  "cve_id": "CVE-2022-0983",
  "cve_desc": "An SQL injection risk was identified in Badges code relating to configuring criteria. Access to the relevant capability was limited to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "c2794752ea3cdda2d64a0651da08b2cdf730d9f1",
  "patch_info": {
    "commit_hash": "c2794752ea3cdda2d64a0651da08b2cdf730d9f1",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/c2794752ea3cdda2d64a0651da08b2cdf730d9f1",
    "files": [
      "badges/criteria/award_criteria_profile.php"
    ],
    "message": "MDL-74074 badges: Ensure profile criteria exists before completion check",
    "before_after_code_files": [
      "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
    ]
  },
  "patch_diff": {
    "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php": [
      "File: badges/criteria/award_criteria_profile.php -> badges/criteria/award_criteria_profile.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39:     public $required_param = 'field';",
      "40:     public $optional_params = array();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "47:     protected $allowed_default_fields = [",
      "48:         'firstname',",
      "49:         'lastname',",
      "50:         'email',",
      "51:         'address',",
      "52:         'phone1',",
      "53:         'phone2',",
      "54:         'department',",
      "55:         'institution',",
      "56:         'description',",
      "57:         'picture',",
      "58:         'city',",
      "59:         'country',",
      "60:     ];",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "50:         $none = true;",
      "51:         $existing = array();",
      "52:         $missing = array();",
      "59:         $cfields = array_filter(profile_get_custom_fields(), function($field) {",
      "",
      "[Removed Lines]",
      "55:         $dfields = array('firstname', 'lastname', 'email', 'address', 'phone1', 'phone2',",
      "56:                          'department', 'institution', 'description', 'picture', 'city', 'country');",
      "",
      "[Added Lines]",
      "73:         $dfields = $this->allowed_default_fields;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "230:                 $join .= \" LEFT JOIN {user_info_data} uid{$idx} ON uid{$idx}.userid = u.id AND uid{$idx}.fieldid = :fieldid{$idx} \";",
      "231:                 $params[\"fieldid{$idx}\"] = $param['field'];",
      "232:                 $whereparts[] = \"uid{$idx}.id IS NOT NULL\";",
      "235:                 if ($param['field'] == 'picture') {",
      "237:                     $whereparts[] = \"u.{$param['field']} != 0\";",
      "",
      "[Removed Lines]",
      "233:             } else {",
      "",
      "[Added Lines]",
      "250:             } else if (in_array($param['field'], $this->allowed_default_fields)) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a2d230777fbf937b856c3bdab30fb17689f67065",
      "candidate_info": {
        "commit_hash": "a2d230777fbf937b856c3bdab30fb17689f67065",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a2d230777fbf937b856c3bdab30fb17689f67065",
        "files": [
          "badges/criteria/award_criteria_profile.php"
        ],
        "message": "MDL-74074 badges: Ensure profile criteria exists before completion check",
        "before_after_code_files": [
          "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ],
          "candidate": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php": [
          "File: badges/criteria/award_criteria_profile.php -> badges/criteria/award_criteria_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:     public $required_param = 'field';",
          "40:     public $optional_params = array();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:     protected $allowed_default_fields = [",
          "48:         'firstname',",
          "49:         'lastname',",
          "50:         'email',",
          "51:         'address',",
          "52:         'phone1',",
          "53:         'phone2',",
          "54:         'department',",
          "55:         'institution',",
          "56:         'description',",
          "57:         'picture',",
          "58:         'city',",
          "59:         'country',",
          "60:     ];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "50:         $none = true;",
          "51:         $existing = array();",
          "52:         $missing = array();",
          "59:         $cfields = array_filter(profile_get_custom_fields(), function($field) {",
          "",
          "[Removed Lines]",
          "55:         $dfields = array('firstname', 'lastname', 'email', 'address', 'phone1', 'phone2',",
          "56:                          'department', 'institution', 'description', 'picture', 'city', 'country');",
          "",
          "[Added Lines]",
          "73:         $dfields = $this->allowed_default_fields;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "230:                 $join .= \" LEFT JOIN {user_info_data} uid{$idx} ON uid{$idx}.userid = u.id AND uid{$idx}.fieldid = :fieldid{$idx} \";",
          "231:                 $params[\"fieldid{$idx}\"] = $param['field'];",
          "232:                 $whereparts[] = \"uid{$idx}.id IS NOT NULL\";",
          "235:                 if ($param['field'] == 'picture') {",
          "237:                     $whereparts[] = \"u.{$param['field']} != 0\";",
          "",
          "[Removed Lines]",
          "233:             } else {",
          "",
          "[Added Lines]",
          "250:             } else if (in_array($param['field'], $this->allowed_default_fields)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5f1b314b503ea75864749c2ee9bc2f9700ee9bfd",
      "candidate_info": {
        "commit_hash": "5f1b314b503ea75864749c2ee9bc2f9700ee9bfd",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5f1b314b503ea75864749c2ee9bc2f9700ee9bfd",
        "files": [
          "badges/criteria/award_criteria_profile.php"
        ],
        "message": "MDL-74074 badges: Ensure profile criteria exists before completion check",
        "before_after_code_files": [
          "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ],
          "candidate": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php": [
          "File: badges/criteria/award_criteria_profile.php -> badges/criteria/award_criteria_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:     public $required_param = 'field';",
          "40:     public $optional_params = array();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:     protected $allowed_default_fields = [",
          "48:         'firstname',",
          "49:         'lastname',",
          "50:         'email',",
          "51:         'address',",
          "52:         'phone1',",
          "53:         'phone2',",
          "54:         'icq',",
          "55:         'skype',",
          "56:         'yahoo',",
          "57:         'aim',",
          "58:         'msn',",
          "59:         'department',",
          "60:         'institution',",
          "61:         'description',",
          "62:         'picture',",
          "63:         'city',",
          "64:         'url',",
          "65:         'country',",
          "66:     ];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49:         $none = true;",
          "50:         $existing = array();",
          "51:         $missing = array();",
          "57:         $sql = \"SELECT uf.id as fieldid, uf.name as name, ic.id as categoryid, ic.name as categoryname, uf.datatype",
          "58:                 FROM {user_info_field} uf",
          "",
          "[Removed Lines]",
          "54:         $dfields = array('firstname', 'lastname', 'email', 'address', 'phone1', 'phone2', 'icq', 'skype', 'yahoo',",
          "55:                          'aim', 'msn', 'department', 'institution', 'description', 'picture', 'city', 'url', 'country');",
          "",
          "[Added Lines]",
          "78:         $dfields = $this->allowed_default_fields;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "228:                 $join .= \" LEFT JOIN {user_info_data} uid{$idx} ON uid{$idx}.userid = u.id AND uid{$idx}.fieldid = :fieldid{$idx} \";",
          "229:                 $params[\"fieldid{$idx}\"] = $param['field'];",
          "230:                 $whereparts[] = \"uid{$idx}.id IS NOT NULL\";",
          "233:                 if ($param['field'] == 'picture') {",
          "235:                     $whereparts[] = \"u.{$param['field']} != 0\";",
          "",
          "[Removed Lines]",
          "231:             } else {",
          "",
          "[Added Lines]",
          "254:             } else if (in_array($param['field'], $this->allowed_default_fields)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6b670477f7832ef4febfd8e89982f67ec22d72c8",
      "candidate_info": {
        "commit_hash": "6b670477f7832ef4febfd8e89982f67ec22d72c8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6b670477f7832ef4febfd8e89982f67ec22d72c8",
        "files": [
          "badges/criteria/award_criteria_profile.php"
        ],
        "message": "MDL-74074 badges: Ensure profile criteria exists before completion check",
        "before_after_code_files": [
          "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ],
          "candidate": [
            "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/criteria/award_criteria_profile.php||badges/criteria/award_criteria_profile.php": [
          "File: badges/criteria/award_criteria_profile.php -> badges/criteria/award_criteria_profile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:     public $required_param = 'field';",
          "40:     public $optional_params = array();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:     protected $allowed_default_fields = [",
          "48:         'firstname',",
          "49:         'lastname',",
          "50:         'email',",
          "51:         'address',",
          "52:         'phone1',",
          "53:         'phone2',",
          "54:         'icq',",
          "55:         'skype',",
          "56:         'yahoo',",
          "57:         'aim',",
          "58:         'msn',",
          "59:         'department',",
          "60:         'institution',",
          "61:         'description',",
          "62:         'picture',",
          "63:         'city',",
          "64:         'url',",
          "65:         'country',",
          "66:     ];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49:         $none = true;",
          "50:         $existing = array();",
          "51:         $missing = array();",
          "57:         $sql = \"SELECT uf.id as fieldid, uf.name as name, ic.id as categoryid, ic.name as categoryname, uf.datatype",
          "58:                 FROM {user_info_field} uf",
          "",
          "[Removed Lines]",
          "54:         $dfields = array('firstname', 'lastname', 'email', 'address', 'phone1', 'phone2', 'icq', 'skype', 'yahoo',",
          "55:                          'aim', 'msn', 'department', 'institution', 'description', 'picture', 'city', 'url', 'country');",
          "",
          "[Added Lines]",
          "78:         $dfields = $this->allowed_default_fields;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "228:                 $join .= \" LEFT JOIN {user_info_data} uid{$idx} ON uid{$idx}.userid = u.id AND uid{$idx}.fieldid = :fieldid{$idx} \";",
          "229:                 $params[\"fieldid{$idx}\"] = $param['field'];",
          "230:                 $whereparts[] = \"uid{$idx}.id IS NOT NULL\";",
          "233:                 if ($param['field'] == 'picture') {",
          "235:                     $whereparts[] = \"u.{$param['field']} != 0\";",
          "",
          "[Removed Lines]",
          "231:             } else {",
          "",
          "[Added Lines]",
          "254:             } else if (in_array($param['field'], $this->allowed_default_fields)) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}