{
  "cve_id": "CVE-2024-12678",
  "cve_desc": "Nomad Community and Nomad Enterprise (\"Nomad\") allocations are vulnerable to privilege escalation within a namespace through unredacted workload identity tokens. This vulnerability, identified as CVE-2024-12678, is fixed in Nomad Community Edition 1.9.4 and Nomad Enterprise 1.9.4, 1.8.8, and 1.7.16.",
  "repo": "hashicorp/nomad",
  "patch_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
  "patch_info": {
    "commit_hash": "359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "repo": "hashicorp/nomad",
    "commit_url": "https://github.com/hashicorp/nomad/commit/359a71861ef044cb5d749a36ff0e44b172c8f1a6",
    "files": [
      ".changelog/24683.txt",
      "command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go",
      "nomad/structs/structs.go"
    ],
    "message": "Backport of sec: fix alloc workload identity namespace permission into release/1.9.x (#24685)\n\nCo-authored-by: Deniz Onur Duzgun <59659739+dduzgun-security@users.noreply.github.com>",
    "before_after_code_files": [
      "command/agent/node_endpoint.go||command/agent/node_endpoint.go",
      "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go",
      "nomad/structs/structs.go||nomad/structs/structs.go"
    ]
  },
  "patch_diff": {
    "command/agent/node_endpoint.go||command/agent/node_endpoint.go": [
      "File: command/agent/node_endpoint.go -> command/agent/node_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "105:   out.Allocs = make([]*structs.Allocation, 0)",
      "106:  }",
      "107:  for _, alloc := range out.Allocs {",
      "108:   alloc.SetEventDisplayMessages()",
      "109:  }",
      "110:  return out.Allocs, nil",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "108:   alloc = alloc.Sanitize()",
      "",
      "---------------"
    ],
    "nomad/alloc_endpoint.go||nomad/alloc_endpoint.go": [
      "File: nomad/alloc_endpoint.go -> nomad/alloc_endpoint.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "172:    }",
      "176:    if out != nil {",
      "178:     if !aclObj.AllowClientOp() && !allowNsOp(aclObj, out.Namespace) {",
      "179:      return structs.NewErrUnknownAllocation(args.AllocID)",
      "",
      "[Removed Lines]",
      "175:    reply.Alloc = out",
      "",
      "[Added Lines]",
      "176:     out = out.Sanitize()",
      "177:     reply.Alloc = out",
      "",
      "---------------"
    ],
    "nomad/structs/structs.go||nomad/structs/structs.go": [
      "File: nomad/structs/structs.go -> nomad/structs/structs.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "11199:  return a.ID",
      "11200: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "11205: func (a *Allocation) Sanitize() *Allocation {",
      "11206:  if a == nil {",
      "11207:   return nil",
      "11208:  }",
      "11210:  if a.SignedIdentities == nil {",
      "11211:   return a",
      "11212:  }",
      "11214:  clean := a.Copy()",
      "11215:  clean.SignedIdentities = nil",
      "11216:  return clean",
      "11217: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5eb85b745baddaaab280a13c5cdff6d547d5ec8a",
      "candidate_info": {
        "commit_hash": "5eb85b745baddaaab280a13c5cdff6d547d5ec8a",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/5eb85b745baddaaab280a13c5cdff6d547d5ec8a",
        "files": [
          ".changelog/24538.txt",
          "drivers/shared/executor/utils.go"
        ],
        "message": "backport of commit 4e2d9675e7308db3557a273230a1bc5d19f53cce (#24577)\n\nCo-authored-by: Michael Smithhisler <michael.smithhisler@hashicorp.com>",
        "before_after_code_files": [
          "drivers/shared/executor/utils.go||drivers/shared/executor/utils.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/shared/executor/utils.go||drivers/shared/executor/utils.go": [
          "File: drivers/shared/executor/utils.go -> drivers/shared/executor/utils.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:   AllowedProtocols: []plugin.Protocol{plugin.ProtocolGRPC},",
          "85:   Logger:           logger.Named(\"executor\"),",
          "86:  }",
          "88: }",
          "90: func newExecutorClient(config *plugin.ClientConfig, logger hclog.Logger) (Executor, *plugin.Client, error) {",
          "",
          "[Removed Lines]",
          "87:  return newExecutorClient(config, logger)",
          "",
          "[Added Lines]",
          "91:  exec, pluginClient, err := newExecutorClient(config, logger)",
          "92:  if err != nil {",
          "93:   return nil, nil, err",
          "94:  }",
          "95:  if _, err := exec.Version(); err != nil {",
          "96:   return nil, nil, err",
          "97:  }",
          "98:  return exec, pluginClient, nil",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1eede4eda90b1cdbb0694d35ccf2afb02091c6d6",
      "candidate_info": {
        "commit_hash": "1eede4eda90b1cdbb0694d35ccf2afb02091c6d6",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/1eede4eda90b1cdbb0694d35ccf2afb02091c6d6",
        "files": [
          "go.mod",
          "go.sum"
        ],
        "message": "backport of commit e87cf9d4b907b7cb4b76f583874d137f1f24f231 (#25133)\n\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "134:  golang.org/x/mod v0.22.0",
          "135:  golang.org/x/sync v0.10.0",
          "136:  golang.org/x/sys v0.29.0",
          "138:  google.golang.org/grpc v1.69.4",
          "139:  google.golang.org/protobuf v1.36.3",
          "140:  gopkg.in/tomb.v1 v1.0.0-20141024135613-dd632973f1e7",
          "",
          "[Removed Lines]",
          "137:  golang.org/x/time v0.9.0",
          "",
          "[Added Lines]",
          "137:  golang.org/x/time v0.10.0",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "2112: golang.org/x/time v0.0.0-20220922220347-f3bd1da661af/go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW/OXSQhTDSoE431IQ=",
          "2113: golang.org/x/time v0.1.0/go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW/OXSQhTDSoE431IQ=",
          "2114: golang.org/x/time v0.3.0/go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW/OXSQhTDSoE431IQ=",
          "2117: golang.org/x/tools v0.0.0-20180525024113-a5b4c53f6e8b/go.mod h1:n7NCudcB/nEzxVGmLbDWY5pfWTLqBcC2KZ6jyYvM4mQ=",
          "2118: golang.org/x/tools v0.0.0-20180917221912-90fa682c2a6e/go.mod h1:n7NCudcB/nEzxVGmLbDWY5pfWTLqBcC2KZ6jyYvM4mQ=",
          "2119: golang.org/x/tools v0.0.0-20181011042414-1f849cf54d09/go.mod h1:n7NCudcB/nEzxVGmLbDWY5pfWTLqBcC2KZ6jyYvM4mQ=",
          "",
          "[Removed Lines]",
          "2115: golang.org/x/time v0.9.0 h1:EsRrnYcQiGH+5FfbgvV4AP7qEZstoyrHB0DzarOQ4ZY=",
          "2116: golang.org/x/time v0.9.0/go.mod h1:3BpzKBy/shNhVucY/MWOyx10tF3SFh9QdLuxbVysPQM=",
          "",
          "[Added Lines]",
          "2115: golang.org/x/time v0.10.0 h1:3usCWA8tQn0L8+hFJQNgzpWbd89begxN66o1Ojdn5L4=",
          "2116: golang.org/x/time v0.10.0/go.mod h1:3BpzKBy/shNhVucY/MWOyx10tF3SFh9QdLuxbVysPQM=",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "832b1b87532f5c1e0827942816d4be68cf73bba4",
      "candidate_info": {
        "commit_hash": "832b1b87532f5c1e0827942816d4be68cf73bba4",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/832b1b87532f5c1e0827942816d4be68cf73bba4",
        "files": [
          ".release/ci.hcl",
          "client/structs/structs.generated.go",
          "nomad/structs/structs.generated.go",
          "version/version.go"
        ],
        "message": "Prepare for next release",
        "before_after_code_files": [
          ".release/ci.hcl||.release/ci.hcl",
          "client/structs/structs.generated.go||client/structs/structs.generated.go",
          "nomad/structs/structs.generated.go||nomad/structs/structs.generated.go",
          "version/version.go||version/version.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        ".release/ci.hcl||.release/ci.hcl": [
          "File: .release/ci.hcl -> .release/ci.hcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:   team = \"nomad\"",
          "9:   slack {",
          "11:   }",
          "13:   github {",
          "",
          "[Removed Lines]",
          "10:     notification_channel = \"CUYKT2A73\"",
          "",
          "[Added Lines]",
          "10:     notification_channel = \"C03B5EWFW01\"",
          "",
          "---------------"
        ],
        "client/structs/structs.generated.go||client/structs/structs.generated.go": [
          "File: client/structs/structs.generated.go -> client/structs/structs.generated.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "nomad/structs/structs.generated.go||nomad/structs/structs.generated.go": [
          "File: nomad/structs/structs.generated.go -> nomad/structs/structs.generated.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version/version.go||version/version.go": [
          "File: version/version.go -> version/version.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "19:  GitDescribe string",
          "30:  VersionMetadata = \"\"",
          "",
          "[Removed Lines]",
          "22:  Version = \"1.9.0\"",
          "27:  VersionPrerelease = \"\"",
          "",
          "[Added Lines]",
          "22:  Version = \"1.9.1\"",
          "27:  VersionPrerelease = \"dev\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9bccd8177a6fcad3fc9971523174bb8aaaa4d7e7",
      "candidate_info": {
        "commit_hash": "9bccd8177a6fcad3fc9971523174bb8aaaa4d7e7",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/9bccd8177a6fcad3fc9971523174bb8aaaa4d7e7",
        "files": [
          "go.mod",
          "go.sum"
        ],
        "message": "chore(deps): bump go.etcd.io/bbolt from 1.3.9 to 1.3.11 (#25035)\n\nbackport of commit d9e2cb23b9af3fbf7e172d3547b004a25fa9cff2\n\nCo-authored-by: dependabot[bot] <49699333+dependabot[bot]@users.noreply.github.com>",
        "before_after_code_files": [
          "go.mod||go.mod",
          "go.sum||go.sum"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "go.mod||go.mod": [
          "File: go.mod -> go.mod",
          "--- Hunk 1 ---",
          "[Context before]",
          "129:  github.com/stretchr/testify v1.10.0",
          "130:  github.com/zclconf/go-cty v1.16.0",
          "131:  github.com/zclconf/go-cty-yaml v1.1.0",
          "133:  go.uber.org/goleak v1.2.1",
          "134:  golang.org/x/crypto v0.32.0",
          "135:  golang.org/x/mod v0.22.0",
          "",
          "[Removed Lines]",
          "132:  go.etcd.io/bbolt v1.3.9",
          "",
          "[Added Lines]",
          "132:  go.etcd.io/bbolt v1.3.11",
          "",
          "---------------"
        ],
        "go.sum||go.sum": [
          "File: go.sum -> go.sum",
          "--- Hunk 1 ---",
          "[Context before]",
          "1676: github.com/zclconf/go-cty-yaml v1.1.0/go.mod h1:9YLUH4g7lOhVWqUbctnVlZ5KLpg7JAprQNgxSZ1Gyxs=",
          "1677: github.com/zeebo/assert v1.3.0/go.mod h1:Pq9JiuJQpG8JLJdtkwrJESF0Foym2/D9XMU5ciN/wJ0=",
          "1678: github.com/zeebo/xxh3 v1.0.2/go.mod h1:5NWz9Sef7zIDm2JHfFlcQvNekmcEl9ekUZQQKCYaDcA=",
          "1681: go.opencensus.io v0.21.0/go.mod h1:mSImk1erAIZhrmZN+AvHh14ztQfjbGwt4TtuofqLduU=",
          "1682: go.opencensus.io v0.22.0/go.mod h1:+kGneAE2xo2IficOXnaByMWTGM9T73dGwxeWcUqIpI8=",
          "1683: go.opencensus.io v0.22.2/go.mod h1:yxeiOL68Rb0Xd1ddK5vPZ/oVn4vY4Ynel7k9FzqtOIw=",
          "",
          "[Removed Lines]",
          "1679: go.etcd.io/bbolt v1.3.9 h1:8x7aARPEXiXbHmtUwAIv7eV2fQFHrLLavdiJ3uzJXoI=",
          "1680: go.etcd.io/bbolt v1.3.9/go.mod h1:zaO32+Ti0PK1ivdPtgMESzuzL2VPoIG1PCQNvOdo/dE=",
          "",
          "[Added Lines]",
          "1679: go.etcd.io/bbolt v1.3.11 h1:yGEzV1wPz2yVCLsD8ZAiGHhHVlczyC9d1rP43/VCRJ0=",
          "1680: go.etcd.io/bbolt v1.3.11/go.mod h1:dksAq7YMXoljX0xu6VF5DMZGbhYYoLUalEiSySYAS4I=",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b6615ad2d19b523303f48ca326f54f20d38cf044",
      "candidate_info": {
        "commit_hash": "b6615ad2d19b523303f48ca326f54f20d38cf044",
        "repo": "hashicorp/nomad",
        "commit_url": "https://github.com/hashicorp/nomad/commit/b6615ad2d19b523303f48ca326f54f20d38cf044",
        "files": [
          "nomad/heartbeat.go",
          "nomad/heartbeat_test.go",
          "nomad/reporting/reporting_ce.go",
          "nomad/server.go"
        ],
        "message": "reporting: Update server to accommodate new enterprise reporting (#24932)\n\nbackport of commit 739e5ed6ee302fd11158e9c224f7934a73edc2ca\n\nCo-authored-by: James Rasell <jrasell@users.noreply.github.com>",
        "before_after_code_files": [
          "nomad/heartbeat.go||nomad/heartbeat.go",
          "nomad/heartbeat_test.go||nomad/heartbeat_test.go",
          "nomad/reporting/reporting_ce.go||nomad/reporting/reporting_ce.go",
          "nomad/server.go||nomad/server.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/hashicorp/nomad/pull/25471"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "nomad/heartbeat.go||nomad/heartbeat.go": [
          "File: nomad/heartbeat.go -> nomad/heartbeat.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "251:  return nil",
          "252: }",
          "256: func (h *nodeHeartbeater) heartbeatStats() {",
          "257:  for {",
          "258:   select {",
          "259:   case <-time.After(5 * time.Second):",
          "263:    metrics.SetGauge([]string{\"nomad\", \"heartbeat\", \"active\"}, float32(num))",
          "265:   case <-h.srv.shutdownCh:",
          "",
          "[Removed Lines]",
          "260:    h.heartbeatTimersLock.Lock()",
          "261:    num := len(h.heartbeatTimers)",
          "262:    h.heartbeatTimersLock.Unlock()",
          "",
          "[Added Lines]",
          "260:    num := h.getHeartbeatTimerNum()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "267:   }",
          "268:  }",
          "269: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "272: func (h *nodeHeartbeater) getHeartbeatTimerNum() int {",
          "273:  h.heartbeatTimersLock.Lock()",
          "274:  defer h.heartbeatTimersLock.Unlock()",
          "275:  return len(h.heartbeatTimers)",
          "276: }",
          "",
          "---------------"
        ],
        "nomad/heartbeat_test.go||nomad/heartbeat_test.go": [
          "File: nomad/heartbeat_test.go -> nomad/heartbeat_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "8:  \"testing\"",
          "9:  \"time\"",
          "11:  memdb \"github.com/hashicorp/go-memdb\"",
          "12:  msgpackrpc \"github.com/hashicorp/net-rpc-msgpackrpc/v2\"",
          "13:  \"github.com/hashicorp/nomad/ci\"",
          "14:  \"github.com/hashicorp/nomad/helper/pointer\"",
          "15:  \"github.com/hashicorp/nomad/nomad/mock\"",
          "16:  \"github.com/hashicorp/nomad/nomad/structs\"",
          "17:  \"github.com/hashicorp/nomad/testutil\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11:  \"github.com/hashicorp/go-hclog\"",
          "16:  \"github.com/hashicorp/nomad/helper/uuid\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "423:   })",
          "424:  }",
          "425: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "429: func Test_nodeHeartbeater_getHeartbeatTimerNum(t *testing.T) {",
          "430:  ci.Parallel(t)",
          "432:  nodeHeartbeat := &nodeHeartbeater{logger: hclog.NewNullLogger()}",
          "436:  nodeIDs := []string{",
          "437:   uuid.Generate(),",
          "438:   uuid.Generate(),",
          "439:   uuid.Generate(),",
          "440:   uuid.Generate(),",
          "441:   uuid.Generate(),",
          "442:  }",
          "447:  for _, nodeID := range nodeIDs {",
          "448:   nodeHeartbeat.resetHeartbeatTimerLocked(nodeID, 10*time.Minute)",
          "449:  }",
          "451:  must.Eq(t, 5, nodeHeartbeat.getHeartbeatTimerNum())",
          "455:  must.NoError(t, nodeHeartbeat.clearHeartbeatTimer(nodeIDs[0]))",
          "456:  must.NoError(t, nodeHeartbeat.clearHeartbeatTimer(nodeIDs[2]))",
          "458:  must.Eq(t, 3, nodeHeartbeat.getHeartbeatTimerNum())",
          "461:  must.NoError(t, nodeHeartbeat.clearAllHeartbeatTimers())",
          "462:  must.Eq(t, 0, nodeHeartbeat.getHeartbeatTimerNum())",
          "463: }",
          "",
          "---------------"
        ],
        "nomad/reporting/reporting_ce.go||nomad/reporting/reporting_ce.go": [
          "File: nomad/reporting/reporting_ce.go -> nomad/reporting/reporting_ce.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: package reporting",
          "",
          "[Removed Lines]",
          "8: type Manager struct {",
          "9: }",
          "",
          "[Added Lines]",
          "8: type Manager struct{}",
          "",
          "---------------"
        ],
        "nomad/server.go||nomad/server.go": [
          "File: nomad/server.go -> nomad/server.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "36:  \"github.com/hashicorp/nomad/helper/codec\"",
          "37:  \"github.com/hashicorp/nomad/helper/goruntime\"",
          "38:  \"github.com/hashicorp/nomad/helper/group\"",
          "40:  \"github.com/hashicorp/nomad/helper/pool\"",
          "41:  \"github.com/hashicorp/nomad/helper/tlsutil\"",
          "42:  \"github.com/hashicorp/nomad/lib/auth/oidc\"",
          "",
          "[Removed Lines]",
          "39:  \"github.com/hashicorp/nomad/helper/iterator\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2186:  return s.config.BootstrapExpect == 1",
          "2187: }",
          "",
          "[Removed Lines]",
          "2189: func (s *Server) GetClientNodesCount() (int, error) {",
          "2190:  stateSnapshot, err := s.State().Snapshot()",
          "2191:  if err != nil {",
          "2192:   return 0, err",
          "2193:  }",
          "2195:  iter, err := stateSnapshot.Nodes(nil)",
          "2196:  if err != nil {",
          "2197:   return 0, err",
          "2198:  }",
          "2200:  return iterator.Len(iter), nil",
          "2201: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}