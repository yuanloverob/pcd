{
  "cve_id": "CVE-2022-21661",
  "cve_desc": "WordPress is a free and open-source content management system written in PHP and paired with a MariaDB database. Due to improper sanitization in WP_Query, there can be cases where SQL injection is possible through plugins or themes that use it in a certain way. This has been patched in WordPress version 5.8.3. Older affected versions are also fixed via security release, that go back till 3.7.37. We strongly recommend that you keep auto-updates enabled. There are no known workarounds for this vulnerability.",
  "repo": "WordPress/wordpress-develop",
  "patch_hash": "17efac8c8ec64555eff5cf51a3eff81e06317214",
  "patch_info": {
    "commit_hash": "17efac8c8ec64555eff5cf51a3eff81e06317214",
    "repo": "WordPress/wordpress-develop",
    "commit_url": "https://github.com/WordPress/wordpress-develop/commit/17efac8c8ec64555eff5cf51a3eff81e06317214",
    "files": [
      "src/wp-includes/class-wp-tax-query.php"
    ],
    "message": "Query: Improve sanitization within `WP_Tax_Query`.\n\nMerges [52454] to the 5.8 branch.\nProps dd32, xknown, peterwilsoncc, ehtis.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/5.8@52459 602fd350-edb4-49c9-b593-d223f7449a82",
    "before_after_code_files": [
      "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
    ]
  },
  "patch_diff": {
    "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
      "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "556:    return;",
      "557:   }",
      "561:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
      "562:    $this->transform_query( $query, 'term_id' );",
      "",
      "[Removed Lines]",
      "559:   $query['terms'] = array_unique( (array) $query['terms'] );",
      "",
      "[Added Lines]",
      "559:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
      "560:    $query['terms'] = array_unique( (array) $query['terms'] );",
      "561:   } else {",
      "562:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
      "563:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "af692934a392b855e868f818b8be5eaf65d9f297",
      "candidate_info": {
        "commit_hash": "af692934a392b855e868f818b8be5eaf65d9f297",
        "repo": "WordPress/wordpress-develop",
        "commit_url": "https://github.com/WordPress/wordpress-develop/commit/af692934a392b855e868f818b8be5eaf65d9f297",
        "files": [
          "src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php",
          "src/wp-includes/post.php"
        ],
        "message": "Grouped backports to the 4.4 branch.\n\n- Query: Improve sanitization within `WP_Tax_Query`.\n- Query: Improve sanitization within `WP_Meta_Query`.\n- Upgrade/Install: Avoid using `unserialize()` unnecessarily.\n- Formatting: Correctly encode ASCII characters in post slugs.\n\nMerges [52454-52457] to the 4.4 branch.\nProps vortfu, dd32, ehtis, zieladam, whyisjake, xknown, peterwilsoncc, desrosj, iandunn.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/4.4@52479 602fd350-edb4-49c9-b593-d223f7449a82",
        "before_after_code_files": [
          "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php||src/wp-includes/formatting.php",
          "src/wp-includes/post.php||src/wp-includes/post.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ],
          "candidate": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ]
        }
      },
      "candidate_diff": {
        "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php": [
          "File: src/wp-admin/includes/upgrade.php -> src/wp-admin/includes/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1216:   $start = 0;",
          "1217:   while( $rows = $wpdb->get_results( \"SELECT option_name, option_value FROM $wpdb->options ORDER BY option_id LIMIT $start, 20\" ) ) {",
          "1218:    foreach ( $rows as $row ) {",
          "1221:      $value = stripslashes( $value );",
          "1222:     if ( $value !== $row->option_value ) {",
          "1223:      update_option( $row->option_name, $value );",
          "",
          "[Removed Lines]",
          "1219:     $value = $row->option_value;",
          "1220:     if ( !@unserialize( $value ) )",
          "",
          "[Added Lines]",
          "1219:     $value = maybe_unserialize( $row->option_value );",
          "1220:     if ( $value === $row->option_value )",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php": [
          "File: src/wp-includes/class-wp-meta-query.php -> src/wp-includes/class-wp-meta-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "713:    $clause_compare  = strtoupper( $clause['compare'] );",
          "714:    $sibling_compare = strtoupper( $sibling['compare'] );",
          "715:    if ( in_array( $clause_compare, $compatible_compares ) && in_array( $sibling_compare, $compatible_compares ) ) {",
          "717:     break;",
          "718:    }",
          "719:   }",
          "",
          "[Removed Lines]",
          "716:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "716:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
          "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "545:    if ( in_array( strtoupper( $sibling['operator'] ), $compatible_operators ) ) {",
          "547:     break;",
          "548:    }",
          "549:   }",
          "",
          "[Removed Lines]",
          "546:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "546:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "573:    return;",
          "574:   }",
          "578:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
          "579:    $this->transform_query( $query, 'term_id' );",
          "",
          "[Removed Lines]",
          "576:   $query['terms'] = array_unique( (array) $query['terms'] );",
          "",
          "[Added Lines]",
          "576:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
          "577:    $query['terms'] = array_unique( (array) $query['terms'] );",
          "578:   } else {",
          "579:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
          "580:   }",
          "",
          "---------------"
        ],
        "src/wp-includes/formatting.php||src/wp-includes/formatting.php": [
          "File: src/wp-includes/formatting.php -> src/wp-includes/formatting.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1073:  $unicode        = '';",
          "1074:  $values         = array();",
          "1075:  $num_octets     = 1;",
          "",
          "[Removed Lines]",
          "1072: function utf8_uri_encode( $utf8_string, $length = 0 ) {",
          "",
          "[Added Lines]",
          "1074: function utf8_uri_encode( $utf8_string, $length = 0, $encode_ascii_characters = false ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1084:   $value = ord( $utf8_string[ $i ] );",
          "1086:   if ( $value < 128 ) {",
          "1088:     break;",
          "1089:    }",
          "1092:   } else {",
          "1093:    if ( count( $values ) == 0 ) {",
          "1094:     if ( $value < 224 ) {",
          "",
          "[Removed Lines]",
          "1087:    if ( $length && ( $unicode_length >= $length ) ) {",
          "1090:    $unicode .= chr( $value );",
          "1091:    $unicode_length++;",
          "",
          "[Added Lines]",
          "1089:    $char                = chr( $value );",
          "1090:    $encoded_char        = $encode_ascii_characters ? rawurlencode( $char ) : $char;",
          "1091:    $encoded_char_length = strlen( $encoded_char );",
          "1092:    if ( $length && ( $unicode_length + $encoded_char_length ) > $length ) {",
          "1095:    $unicode        .= $encoded_char;",
          "1096:    $unicode_length += $encoded_char_length;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "4848:   #dashboard-widgets .hndle .postbox-title-action { float: right; line-height: 1.2; }",
          "4849:  </style>';",
          "4850: }",
          "",
          "[Removed Lines]",
          "4851: add_action( 'admin_print_styles-index.php', '_wp_441_dashboard_display_configure_links_css' );",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/wp-includes/post.php||src/wp-includes/post.php": [
          "File: src/wp-includes/post.php -> src/wp-includes/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3688:   if ( $decoded_slug === $slug )",
          "3689:    $slug = substr( $slug, 0, $length );",
          "3690:   else",
          "3692:  }",
          "3694:  return rtrim( $slug, '-' );",
          "",
          "[Removed Lines]",
          "3691:    $slug = utf8_uri_encode( $decoded_slug, $length );",
          "",
          "[Added Lines]",
          "3691:    $slug = utf8_uri_encode( $decoded_slug, $length, true );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "01caa722065617d8b5dd06ffb01c09713d7fe40f",
      "candidate_info": {
        "commit_hash": "01caa722065617d8b5dd06ffb01c09713d7fe40f",
        "repo": "WordPress/wordpress-develop",
        "commit_url": "https://github.com/WordPress/wordpress-develop/commit/01caa722065617d8b5dd06ffb01c09713d7fe40f",
        "files": [
          "src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php",
          "src/wp-includes/post.php"
        ],
        "message": "Grouped backports to the 4.7 branch.\n\n- Query: Improve sanitization within `WP_Tax_Query`.\n- Query: Improve sanitization within `WP_Meta_Query`.\n- Upgrade/Install: Avoid using `unserialize()` unnecessarily.\n- Formatting: Correctly encode ASCII characters in post slugs.\n\nMerges [52454-52457] to the 4.7 branch.\nProps vortfu, dd32, ehtis, zieladam, whyisjake, xknown, peterwilsoncc, desrosj, iandunn.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/4.7@52476 602fd350-edb4-49c9-b593-d223f7449a82",
        "before_after_code_files": [
          "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php||src/wp-includes/formatting.php",
          "src/wp-includes/post.php||src/wp-includes/post.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ],
          "candidate": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ]
        }
      },
      "candidate_diff": {
        "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php": [
          "File: src/wp-admin/includes/upgrade.php -> src/wp-admin/includes/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1245:   $start = 0;",
          "1246:   while( $rows = $wpdb->get_results( \"SELECT option_name, option_value FROM $wpdb->options ORDER BY option_id LIMIT $start, 20\" ) ) {",
          "1247:    foreach ( $rows as $row ) {",
          "1250:      $value = stripslashes( $value );",
          "1251:     if ( $value !== $row->option_value ) {",
          "1252:      update_option( $row->option_name, $value );",
          "",
          "[Removed Lines]",
          "1248:     $value = $row->option_value;",
          "1249:     if ( !@unserialize( $value ) )",
          "",
          "[Added Lines]",
          "1248:     $value = maybe_unserialize( $row->option_value );",
          "1249:     if ( $value === $row->option_value )",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php": [
          "File: src/wp-includes/class-wp-meta-query.php -> src/wp-includes/class-wp-meta-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "717:    $clause_compare  = strtoupper( $clause['compare'] );",
          "718:    $sibling_compare = strtoupper( $sibling['compare'] );",
          "719:    if ( in_array( $clause_compare, $compatible_compares ) && in_array( $sibling_compare, $compatible_compares ) ) {",
          "721:     break;",
          "722:    }",
          "723:   }",
          "",
          "[Removed Lines]",
          "720:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "720:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
          "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "545:    if ( in_array( strtoupper( $sibling['operator'] ), $compatible_operators ) ) {",
          "547:     break;",
          "548:    }",
          "549:   }",
          "",
          "[Removed Lines]",
          "546:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "546:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "573:    return;",
          "574:   }",
          "578:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
          "579:    $this->transform_query( $query, 'term_id' );",
          "",
          "[Removed Lines]",
          "576:   $query['terms'] = array_unique( (array) $query['terms'] );",
          "",
          "[Added Lines]",
          "576:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
          "577:    $query['terms'] = array_unique( (array) $query['terms'] );",
          "578:   } else {",
          "579:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
          "580:   }",
          "",
          "---------------"
        ],
        "src/wp-includes/formatting.php||src/wp-includes/formatting.php": [
          "File: src/wp-includes/formatting.php -> src/wp-includes/formatting.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1079:  $unicode        = '';",
          "1080:  $values         = array();",
          "1081:  $num_octets     = 1;",
          "",
          "[Removed Lines]",
          "1078: function utf8_uri_encode( $utf8_string, $length = 0 ) {",
          "",
          "[Added Lines]",
          "1080: function utf8_uri_encode( $utf8_string, $length = 0, $encode_ascii_characters = false ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1090:   $value = ord( $utf8_string[ $i ] );",
          "1092:   if ( $value < 128 ) {",
          "1094:     break;",
          "1095:    }",
          "1098:   } else {",
          "1099:    if ( count( $values ) == 0 ) {",
          "1100:     if ( $value < 224 ) {",
          "",
          "[Removed Lines]",
          "1093:    if ( $length && ( $unicode_length >= $length ) ) {",
          "1096:    $unicode .= chr( $value );",
          "1097:    $unicode_length++;",
          "",
          "[Added Lines]",
          "1095:    $char                = chr( $value );",
          "1096:    $encoded_char        = $encode_ascii_characters ? rawurlencode( $char ) : $char;",
          "1097:    $encoded_char_length = strlen( $encoded_char );",
          "1098:    if ( $length && ( $unicode_length + $encoded_char_length ) > $length ) {",
          "1101:    $unicode        .= $encoded_char;",
          "1102:    $unicode_length += $encoded_char_length;",
          "",
          "---------------"
        ],
        "src/wp-includes/post.php||src/wp-includes/post.php": [
          "File: src/wp-includes/post.php -> src/wp-includes/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3817:   if ( $decoded_slug === $slug )",
          "3818:    $slug = substr( $slug, 0, $length );",
          "3819:   else",
          "3821:  }",
          "3823:  return rtrim( $slug, '-' );",
          "",
          "[Removed Lines]",
          "3820:    $slug = utf8_uri_encode( $decoded_slug, $length );",
          "",
          "[Added Lines]",
          "3820:    $slug = utf8_uri_encode( $decoded_slug, $length, true );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fdb98e45dd1f193613e83c00443d0d9918939133",
      "candidate_info": {
        "commit_hash": "fdb98e45dd1f193613e83c00443d0d9918939133",
        "repo": "WordPress/wordpress-develop",
        "commit_url": "https://github.com/WordPress/wordpress-develop/commit/fdb98e45dd1f193613e83c00443d0d9918939133",
        "files": [
          "src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php",
          "src/wp-includes/post.php"
        ],
        "message": "Grouped backports to the 4.6 branch.\n\n- Query: Improve sanitization within `WP_Tax_Query`.\n- Query: Improve sanitization within `WP_Meta_Query`.\n- Upgrade/Install: Avoid using `unserialize()` unnecessarily.\n- Formatting: Correctly encode ASCII characters in post slugs.\n\nMerges [52454-52457] to the 4.6 branch.\nProps vortfu, dd32, ehtis, zieladam, whyisjake, xknown, peterwilsoncc, desrosj, iandunn.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/4.6@52477 602fd350-edb4-49c9-b593-d223f7449a82",
        "before_after_code_files": [
          "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php||src/wp-includes/formatting.php",
          "src/wp-includes/post.php||src/wp-includes/post.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ],
          "candidate": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ]
        }
      },
      "candidate_diff": {
        "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php": [
          "File: src/wp-admin/includes/upgrade.php -> src/wp-admin/includes/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1242:   $start = 0;",
          "1243:   while( $rows = $wpdb->get_results( \"SELECT option_name, option_value FROM $wpdb->options ORDER BY option_id LIMIT $start, 20\" ) ) {",
          "1244:    foreach ( $rows as $row ) {",
          "1247:      $value = stripslashes( $value );",
          "1248:     if ( $value !== $row->option_value ) {",
          "1249:      update_option( $row->option_name, $value );",
          "",
          "[Removed Lines]",
          "1245:     $value = $row->option_value;",
          "1246:     if ( !@unserialize( $value ) )",
          "",
          "[Added Lines]",
          "1245:     $value = maybe_unserialize( $row->option_value );",
          "1246:     if ( $value === $row->option_value )",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php": [
          "File: src/wp-includes/class-wp-meta-query.php -> src/wp-includes/class-wp-meta-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "717:    $clause_compare  = strtoupper( $clause['compare'] );",
          "718:    $sibling_compare = strtoupper( $sibling['compare'] );",
          "719:    if ( in_array( $clause_compare, $compatible_compares ) && in_array( $sibling_compare, $compatible_compares ) ) {",
          "721:     break;",
          "722:    }",
          "723:   }",
          "",
          "[Removed Lines]",
          "720:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "720:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
          "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "545:    if ( in_array( strtoupper( $sibling['operator'] ), $compatible_operators ) ) {",
          "547:     break;",
          "548:    }",
          "549:   }",
          "",
          "[Removed Lines]",
          "546:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "546:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "573:    return;",
          "574:   }",
          "578:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
          "579:    $this->transform_query( $query, 'term_id' );",
          "",
          "[Removed Lines]",
          "576:   $query['terms'] = array_unique( (array) $query['terms'] );",
          "",
          "[Added Lines]",
          "576:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
          "577:    $query['terms'] = array_unique( (array) $query['terms'] );",
          "578:   } else {",
          "579:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
          "580:   }",
          "",
          "---------------"
        ],
        "src/wp-includes/formatting.php||src/wp-includes/formatting.php": [
          "File: src/wp-includes/formatting.php -> src/wp-includes/formatting.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1073:  $unicode        = '';",
          "1074:  $values         = array();",
          "1075:  $num_octets     = 1;",
          "",
          "[Removed Lines]",
          "1072: function utf8_uri_encode( $utf8_string, $length = 0 ) {",
          "",
          "[Added Lines]",
          "1074: function utf8_uri_encode( $utf8_string, $length = 0, $encode_ascii_characters = false ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1084:   $value = ord( $utf8_string[ $i ] );",
          "1086:   if ( $value < 128 ) {",
          "1088:     break;",
          "1089:    }",
          "1092:   } else {",
          "1093:    if ( count( $values ) == 0 ) {",
          "1094:     if ( $value < 224 ) {",
          "",
          "[Removed Lines]",
          "1087:    if ( $length && ( $unicode_length >= $length ) ) {",
          "1090:    $unicode .= chr( $value );",
          "1091:    $unicode_length++;",
          "",
          "[Added Lines]",
          "1089:    $char                = chr( $value );",
          "1090:    $encoded_char        = $encode_ascii_characters ? rawurlencode( $char ) : $char;",
          "1091:    $encoded_char_length = strlen( $encoded_char );",
          "1092:    if ( $length && ( $unicode_length + $encoded_char_length ) > $length ) {",
          "1095:    $unicode        .= $encoded_char;",
          "1096:    $unicode_length += $encoded_char_length;",
          "",
          "---------------"
        ],
        "src/wp-includes/post.php||src/wp-includes/post.php": [
          "File: src/wp-includes/post.php -> src/wp-includes/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3712:   if ( $decoded_slug === $slug )",
          "3713:    $slug = substr( $slug, 0, $length );",
          "3714:   else",
          "3716:  }",
          "3718:  return rtrim( $slug, '-' );",
          "",
          "[Removed Lines]",
          "3715:    $slug = utf8_uri_encode( $decoded_slug, $length );",
          "",
          "[Added Lines]",
          "3715:    $slug = utf8_uri_encode( $decoded_slug, $length, true );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8f28287248e23be70ba15f633237ab5cf5a8cdbd",
      "candidate_info": {
        "commit_hash": "8f28287248e23be70ba15f633237ab5cf5a8cdbd",
        "repo": "WordPress/wordpress-develop",
        "commit_url": "https://github.com/WordPress/wordpress-develop/commit/8f28287248e23be70ba15f633237ab5cf5a8cdbd",
        "files": [
          "src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php",
          "src/wp-includes/post.php"
        ],
        "message": "Grouped backports to the 5.7 branch.\n\n- Query: Improve sanitization within `WP_Tax_Query`.\n- Query: Improve sanitization within `WP_Meta_Query`.\n- Upgrade/Install: Avoid using `unserialize()` unnecessarily.\n- Formatting: Correctly encode ASCII characters in post slugs.\n\nMerges [52454-52457] to the 5.7 branch.\nProps vortfu, dd32, ehtis, zieladam, whyisjake, xknown, peterwilsoncc, desrosj, iandunn.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/5.7@52466 602fd350-edb4-49c9-b593-d223f7449a82",
        "before_after_code_files": [
          "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php||src/wp-includes/formatting.php",
          "src/wp-includes/post.php||src/wp-includes/post.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ],
          "candidate": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ]
        }
      },
      "candidate_diff": {
        "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php": [
          "File: src/wp-admin/includes/upgrade.php -> src/wp-admin/includes/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1658:   $start = 0;",
          "1659:   while ( $rows = $wpdb->get_results( \"SELECT option_name, option_value FROM $wpdb->options ORDER BY option_id LIMIT $start, 20\" ) ) {",
          "1660:    foreach ( $rows as $row ) {",
          "1663:      $value = stripslashes( $value );",
          "1664:     }",
          "1665:     if ( $value !== $row->option_value ) {",
          "",
          "[Removed Lines]",
          "1661:     $value = $row->option_value;",
          "1662:     if ( ! @unserialize( $value ) ) {",
          "",
          "[Added Lines]",
          "1661:     $value = maybe_unserialize( $row->option_value );",
          "1662:     if ( $value === $row->option_value ) {",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php": [
          "File: src/wp-includes/class-wp-meta-query.php -> src/wp-includes/class-wp-meta-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "812:    $clause_compare  = strtoupper( $clause['compare'] );",
          "813:    $sibling_compare = strtoupper( $sibling['compare'] );",
          "814:    if ( in_array( $clause_compare, $compatible_compares, true ) && in_array( $sibling_compare, $compatible_compares, true ) ) {",
          "816:     break;",
          "817:    }",
          "818:   }",
          "",
          "[Removed Lines]",
          "815:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "815:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
          "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "529:    if ( in_array( strtoupper( $sibling['operator'] ), $compatible_operators, true ) ) {",
          "531:     break;",
          "532:    }",
          "533:   }",
          "",
          "[Removed Lines]",
          "530:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "530:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "556:    return;",
          "557:   }",
          "561:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
          "562:    $this->transform_query( $query, 'term_id' );",
          "",
          "[Removed Lines]",
          "559:   $query['terms'] = array_unique( (array) $query['terms'] );",
          "",
          "[Added Lines]",
          "559:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
          "560:    $query['terms'] = array_unique( (array) $query['terms'] );",
          "561:   } else {",
          "562:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
          "563:   }",
          "",
          "---------------"
        ],
        "src/wp-includes/formatting.php||src/wp-includes/formatting.php": [
          "File: src/wp-includes/formatting.php -> src/wp-includes/formatting.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1147:  $unicode        = '';",
          "1148:  $values         = array();",
          "1149:  $num_octets     = 1;",
          "",
          "[Removed Lines]",
          "1146: function utf8_uri_encode( $utf8_string, $length = 0 ) {",
          "",
          "[Added Lines]",
          "1148: function utf8_uri_encode( $utf8_string, $length = 0, $encode_ascii_characters = false ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1158:   $value = ord( $utf8_string[ $i ] );",
          "1160:   if ( $value < 128 ) {",
          "1162:     break;",
          "1163:    }",
          "1166:   } else {",
          "1167:    if ( count( $values ) == 0 ) {",
          "1168:     if ( $value < 224 ) {",
          "",
          "[Removed Lines]",
          "1161:    if ( $length && ( $unicode_length >= $length ) ) {",
          "1164:    $unicode .= chr( $value );",
          "1165:    $unicode_length++;",
          "",
          "[Added Lines]",
          "1163:    $char                = chr( $value );",
          "1164:    $encoded_char        = $encode_ascii_characters ? rawurlencode( $char ) : $char;",
          "1165:    $encoded_char_length = strlen( $encoded_char );",
          "1166:    if ( $length && ( $unicode_length + $encoded_char_length ) > $length ) {",
          "1169:    $unicode        .= $encoded_char;",
          "1170:    $unicode_length += $encoded_char_length;",
          "",
          "---------------"
        ],
        "src/wp-includes/post.php||src/wp-includes/post.php": [
          "File: src/wp-includes/post.php -> src/wp-includes/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4840:   if ( $decoded_slug === $slug ) {",
          "4841:    $slug = substr( $slug, 0, $length );",
          "4842:   } else {",
          "4844:   }",
          "4845:  }",
          "",
          "[Removed Lines]",
          "4843:    $slug = utf8_uri_encode( $decoded_slug, $length );",
          "",
          "[Added Lines]",
          "4843:    $slug = utf8_uri_encode( $decoded_slug, $length, true );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "05979a4da3d01251c592f1ccd6929ac98c0cda63",
      "candidate_info": {
        "commit_hash": "05979a4da3d01251c592f1ccd6929ac98c0cda63",
        "repo": "WordPress/wordpress-develop",
        "commit_url": "https://github.com/WordPress/wordpress-develop/commit/05979a4da3d01251c592f1ccd6929ac98c0cda63",
        "files": [
          "src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php",
          "src/wp-includes/post.php"
        ],
        "message": "Grouped backports to the 5.1 branch.\n\n- Query: Improve sanitization within `WP_Tax_Query`.\n- Query: Improve sanitization within `WP_Meta_Query`.\n- Upgrade/Install: Avoid using `unserialize()` unnecessarily.\n- Formatting: Correctly encode ASCII characters in post slugs.\n\nMerges [52454-52457] to the 5.1 branch.\nProps vortfu, dd32, ehtis, zieladam, whyisjake, xknown, peterwilsoncc, desrosj, iandunn.\n\ngit-svn-id: https://develop.svn.wordpress.org/branches/5.1@52472 602fd350-edb4-49c9-b593-d223f7449a82",
        "before_after_code_files": [
          "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php",
          "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php",
          "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php",
          "src/wp-includes/formatting.php||src/wp-includes/formatting.php",
          "src/wp-includes/post.php||src/wp-includes/post.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ],
          "candidate": [
            "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php"
          ]
        }
      },
      "candidate_diff": {
        "src/wp-admin/includes/upgrade.php||src/wp-admin/includes/upgrade.php": [
          "File: src/wp-admin/includes/upgrade.php -> src/wp-admin/includes/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1591:   $start = 0;",
          "1592:   while ( $rows = $wpdb->get_results( \"SELECT option_name, option_value FROM $wpdb->options ORDER BY option_id LIMIT $start, 20\" ) ) {",
          "1593:    foreach ( $rows as $row ) {",
          "1596:      $value = stripslashes( $value );",
          "1597:     }",
          "1598:     if ( $value !== $row->option_value ) {",
          "",
          "[Removed Lines]",
          "1594:     $value = $row->option_value;",
          "1595:     if ( ! @unserialize( $value ) ) {",
          "",
          "[Added Lines]",
          "1594:     $value = maybe_unserialize( $row->option_value );",
          "1595:     if ( $value === $row->option_value ) {",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-meta-query.php||src/wp-includes/class-wp-meta-query.php": [
          "File: src/wp-includes/class-wp-meta-query.php -> src/wp-includes/class-wp-meta-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "731:    $clause_compare  = strtoupper( $clause['compare'] );",
          "732:    $sibling_compare = strtoupper( $sibling['compare'] );",
          "733:    if ( in_array( $clause_compare, $compatible_compares ) && in_array( $sibling_compare, $compatible_compares ) ) {",
          "735:     break;",
          "736:    }",
          "737:   }",
          "",
          "[Removed Lines]",
          "734:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "734:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------"
        ],
        "src/wp-includes/class-wp-tax-query.php||src/wp-includes/class-wp-tax-query.php": [
          "File: src/wp-includes/class-wp-tax-query.php -> src/wp-includes/class-wp-tax-query.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "528:    if ( in_array( strtoupper( $sibling['operator'] ), $compatible_operators ) ) {",
          "530:     break;",
          "531:    }",
          "532:   }",
          "",
          "[Removed Lines]",
          "529:     $alias = $sibling['alias'];",
          "",
          "[Added Lines]",
          "529:     $alias = preg_replace( '/\\W/', '_', $sibling['alias'] );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "555:    return;",
          "556:   }",
          "560:   if ( is_taxonomy_hierarchical( $query['taxonomy'] ) && $query['include_children'] ) {",
          "561:    $this->transform_query( $query, 'term_id' );",
          "",
          "[Removed Lines]",
          "558:   $query['terms'] = array_unique( (array) $query['terms'] );",
          "",
          "[Added Lines]",
          "558:   if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {",
          "559:    $query['terms'] = array_unique( (array) $query['terms'] );",
          "560:   } else {",
          "561:    $query['terms'] = wp_parse_id_list( $query['terms'] );",
          "562:   }",
          "",
          "---------------"
        ],
        "src/wp-includes/formatting.php||src/wp-includes/formatting.php": [
          "File: src/wp-includes/formatting.php -> src/wp-includes/formatting.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1159:  $unicode        = '';",
          "1160:  $values         = array();",
          "1161:  $num_octets     = 1;",
          "",
          "[Removed Lines]",
          "1158: function utf8_uri_encode( $utf8_string, $length = 0 ) {",
          "",
          "[Added Lines]",
          "1160: function utf8_uri_encode( $utf8_string, $length = 0, $encode_ascii_characters = false ) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1170:   $value = ord( $utf8_string[ $i ] );",
          "1172:   if ( $value < 128 ) {",
          "1174:     break;",
          "1175:    }",
          "1178:   } else {",
          "1179:    if ( count( $values ) == 0 ) {",
          "1180:     if ( $value < 224 ) {",
          "",
          "[Removed Lines]",
          "1173:    if ( $length && ( $unicode_length >= $length ) ) {",
          "1176:    $unicode .= chr( $value );",
          "1177:    $unicode_length++;",
          "",
          "[Added Lines]",
          "1175:    $char                = chr( $value );",
          "1176:    $encoded_char        = $encode_ascii_characters ? rawurlencode( $char ) : $char;",
          "1177:    $encoded_char_length = strlen( $encoded_char );",
          "1178:    if ( $length && ( $unicode_length + $encoded_char_length ) > $length ) {",
          "1181:    $unicode        .= $encoded_char;",
          "1182:    $unicode_length += $encoded_char_length;",
          "",
          "---------------"
        ],
        "src/wp-includes/post.php||src/wp-includes/post.php": [
          "File: src/wp-includes/post.php -> src/wp-includes/post.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4297:   if ( $decoded_slug === $slug ) {",
          "4298:    $slug = substr( $slug, 0, $length );",
          "4299:   } else {",
          "4301:   }",
          "4302:  }",
          "",
          "[Removed Lines]",
          "4300:    $slug = utf8_uri_encode( $decoded_slug, $length );",
          "",
          "[Added Lines]",
          "4300:    $slug = utf8_uri_encode( $decoded_slug, $length, true );",
          "",
          "---------------"
        ]
      }
    }
  ]
}