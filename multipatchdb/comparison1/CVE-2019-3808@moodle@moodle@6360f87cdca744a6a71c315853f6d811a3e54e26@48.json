{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dc71a8b50e27c621d50e8d3681f92a155d2c74de",
      "candidate_info": {
        "commit_hash": "dc71a8b50e27c621d50e8d3681f92a155d2c74de",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/dc71a8b50e27c621d50e8d3681f92a155d2c74de",
        "files": [
          "version.php"
        ],
        "message": "Moodle release 3.5rc1",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '35';                       // This version's branch.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018051200.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5beta+ (Build: 20180512)'; // Human-friendly version name",
          "39: $maturity = MATURITY_BETA;             // This version's maturity level.",
          "",
          "[Added Lines]",
          "32: $version  = 2018051500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.5rc1 (Build: 20180515)'; // Human-friendly version name",
          "39: $maturity = MATURITY_RC;             // This version's maturity level.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "01acb1ea90fe448c87c8e7d3bdca69219e6f04a3",
      "candidate_info": {
        "commit_hash": "01acb1ea90fe448c87c8e7d3bdca69219e6f04a3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/01acb1ea90fe448c87c8e7d3bdca69219e6f04a3",
        "files": [
          "version.php"
        ],
        "message": "Moodle release 3.6beta",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev+ (Build: 20181116)'; // Human-friendly version name",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Added Lines]",
          "32: $version  = 2018111800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6beta (Build: 20181118)'; // Human-friendly version name",
          "39: $maturity = MATURITY_BETA;             // This version's maturity level.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ec1078469d63afda6ecc74b871fbdc9de6adc48",
      "candidate_info": {
        "commit_hash": "6ec1078469d63afda6ecc74b871fbdc9de6adc48",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6ec1078469d63afda6ecc74b871fbdc9de6adc48",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.8dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019092700.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev (Build: 20190927)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019100400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191004)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f5583e97185ed57bb47ffe6ee0cbf36730775645",
      "candidate_info": {
        "commit_hash": "f5583e97185ed57bb47ffe6ee0cbf36730775645",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f5583e97185ed57bb47ffe6ee0cbf36730775645",
        "files": [
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-66599 analytics: New index for analytics_used_analysables",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3536:         upgrade_main_savepoint(true, 2019083000.04);",
          "3537:     }",
          "3539:     return true;",
          "3540: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3539:     if ($oldversion < 2019090500.01) {",
          "3542:         $table = new xmldb_table('analytics_used_analysables');",
          "3543:         $index = new xmldb_index('analysableid', XMLDB_INDEX_NOTUNIQUE, ['analysableid']);",
          "3546:         if (!$dbman->index_exists($table, $index)) {",
          "3547:             $dbman->add_index($table, $index);",
          "3548:         }",
          "3551:         upgrade_main_savepoint(true, 2019090500.01);",
          "3552:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019090500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019090500.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1e9016d8d85a9cbfc4802ccc55d14c983ddd0d17",
      "candidate_info": {
        "commit_hash": "1e9016d8d85a9cbfc4802ccc55d14c983ddd0d17",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1e9016d8d85a9cbfc4802ccc55d14c983ddd0d17",
        "files": [
          "admin/settings/plugins.php",
          "auth/classes/digital_consent.php",
          "auth/classes/external.php",
          "auth/classes/form/verify_age_location_form.php",
          "auth/classes/output/digital_minor_page.php",
          "auth/classes/output/verify_age_location_page.php",
          "auth/tests/behat/validateagedigitalconsentmap.feature",
          "auth/tests/behat/verifyageofconsent.feature",
          "auth/tests/digital_consent_test.php",
          "lang/en/admin.php",
          "lang/en/cache.php",
          "lang/en/error.php",
          "lang/en/moodle.php",
          "lib/adminlib.php",
          "lib/db/caches.php",
          "lib/db/services.php",
          "lib/outputrenderers.php",
          "lib/templates/auth_digital_minor_page.mustache",
          "lib/templates/auth_verify_age_location_page.mustache",
          "login/digital_minor.php",
          "login/signup.php",
          "login/verify_age_location.php",
          "theme/boost/templates/core/auth_digital_minor_page.mustache",
          "theme/boost/templates/core/auth_verify_age_location_page.mustache",
          "version.php"
        ],
        "message": "Merge branch 'MDL-61423-master' of git://github.com/mihailges/moodle",
        "before_after_code_files": [
          "admin/settings/plugins.php||admin/settings/plugins.php",
          "auth/classes/digital_consent.php||auth/classes/digital_consent.php",
          "auth/classes/external.php||auth/classes/external.php",
          "auth/classes/form/verify_age_location_form.php||auth/classes/form/verify_age_location_form.php",
          "auth/classes/output/digital_minor_page.php||auth/classes/output/digital_minor_page.php",
          "auth/classes/output/verify_age_location_page.php||auth/classes/output/verify_age_location_page.php",
          "auth/tests/behat/validateagedigitalconsentmap.feature||auth/tests/behat/validateagedigitalconsentmap.feature",
          "auth/tests/behat/verifyageofconsent.feature||auth/tests/behat/verifyageofconsent.feature",
          "auth/tests/digital_consent_test.php||auth/tests/digital_consent_test.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lang/en/cache.php||lang/en/cache.php",
          "lang/en/error.php||lang/en/error.php",
          "lang/en/moodle.php||lang/en/moodle.php",
          "lib/adminlib.php||lib/adminlib.php",
          "lib/db/caches.php||lib/db/caches.php",
          "lib/db/services.php||lib/db/services.php",
          "lib/outputrenderers.php||lib/outputrenderers.php",
          "lib/templates/auth_digital_minor_page.mustache||lib/templates/auth_digital_minor_page.mustache",
          "lib/templates/auth_verify_age_location_page.mustache||lib/templates/auth_verify_age_location_page.mustache",
          "login/digital_minor.php||login/digital_minor.php",
          "login/signup.php||login/signup.php",
          "login/verify_age_location.php||login/verify_age_location.php",
          "theme/boost/templates/core/auth_digital_minor_page.mustache||theme/boost/templates/core/auth_digital_minor_page.mustache",
          "theme/boost/templates/core/auth_verify_age_location_page.mustache||theme/boost/templates/core/auth_verify_age_location_page.mustache",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/plugins.php||admin/settings/plugins.php": [
          "File: admin/settings/plugins.php -> admin/settings/plugins.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:     $temp->add($setting);",
          "124:     $ADMIN->add('authsettings', $temp);",
          "126:     $temp = new admin_externalpage('authtestsettings', get_string('testsettings', 'core_auth'), new moodle_url(\"/auth/test_settings.php\"), 'moodle/site:config', true);",
          "127:     $ADMIN->add('authsettings', $temp);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     $options = array(",
          "127:         0 => get_string('no'),",
          "128:         1 => get_string('yes')",
          "129:     );",
          "130:     $url = new moodle_url('/admin/settings.php?section=supportcontact');",
          "131:     $url = $url->out();",
          "132:     $setting = new admin_setting_configselect('agedigitalconsentverification',",
          "133:         new lang_string('agedigitalconsentverification', 'admin'),",
          "134:         new lang_string('agedigitalconsentverification_desc', 'admin', $url), 0, $options);",
          "135:     $setting->set_force_ltr(true);",
          "136:     $temp->add($setting);",
          "138:     $setting = new admin_setting_agedigitalconsentmap('agedigitalconsentmap',",
          "139:         new lang_string('ageofdigitalconsentmap', 'admin'),",
          "140:         new lang_string('ageofdigitalconsentmap_desc', 'admin'),",
          "142:         implode(PHP_EOL, [",
          "143:             '*, 16',",
          "144:             'AT, 14',",
          "145:             'CZ, 13',",
          "146:             'DE, 14',",
          "147:             'DK, 13',",
          "148:             'ES, 13',",
          "149:             'FI, 15',",
          "150:             'GB, 13',",
          "151:             'HU, 14',",
          "152:             'IE, 13',",
          "153:             'LT, 16',",
          "154:             'LU, 16',",
          "155:             'NL, 16',",
          "156:             'PL, 13',",
          "157:             'SE, 13',",
          "158:         ]),",
          "159:         PARAM_RAW",
          "160:     );",
          "161:     $temp->add($setting);",
          "",
          "---------------"
        ],
        "auth/classes/digital_consent.php||auth/classes/digital_consent.php": [
          "File: auth/classes/digital_consent.php -> auth/classes/digital_consent.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace core_auth;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "35: class digital_consent {",
          "42:     public static function is_age_digital_consent_verification_enabled() {",
          "43:         global $CFG;",
          "45:         return !empty($CFG->agedigitalconsentverification);",
          "46:     }",
          "55:     public static function is_minor($age, $country) {",
          "56:         global $CFG;",
          "58:         $ageconsentmap = $CFG->agedigitalconsentmap;",
          "59:         $agedigitalconsentmap = self::parse_age_digital_consent_map($ageconsentmap);",
          "61:         return array_key_exists($country, $agedigitalconsentmap) ?",
          "62:             $age < $agedigitalconsentmap[$country] : $age < $agedigitalconsentmap['*'];",
          "63:     }",
          "71:     public static function parse_age_digital_consent_map($ageconsentmap) {",
          "73:         $ageconsentmapparsed = array();",
          "74:         $countries = get_string_manager()->get_list_of_countries();",
          "75:         $isdefaultvaluepresent = false;",
          "76:         $lines = preg_split('/\\r|\\n/', $ageconsentmap, -1, PREG_SPLIT_NO_EMPTY);",
          "77:         foreach ($lines as $line) {",
          "78:             $arr = explode(\",\", $line);",
          "80:             if (count($arr) != 2) {",
          "81:                 throw new \\moodle_exception('agedigitalconsentmapinvalidcomma', 'error', '', $line);",
          "82:             }",
          "83:             $country = trim($arr[0]);",
          "84:             $age = trim($arr[1]);",
          "86:             if ($country == \"*\") {",
          "87:                 $isdefaultvaluepresent = true;",
          "88:             }",
          "90:             if ($country !== \"*\" && !array_key_exists($country, $countries)) {",
          "91:                 throw new \\moodle_exception('agedigitalconsentmapinvalidcountry', 'error', '', $country);",
          "92:             }",
          "94:             if (!is_numeric($age)) {",
          "95:                 throw new \\moodle_exception('agedigitalconsentmapinvalidage', 'error', '', $age);",
          "96:             }",
          "97:             $ageconsentmapparsed[$country] = $age;",
          "98:         }",
          "100:         if (!$isdefaultvaluepresent) {",
          "101:             throw new \\moodle_exception('agedigitalconsentmapinvaliddefault');",
          "102:         }",
          "104:         return $ageconsentmapparsed;",
          "105:     }",
          "106: }",
          "",
          "---------------"
        ],
        "auth/classes/external.php||auth/classes/external.php": [
          "File: auth/classes/external.php -> auth/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "215:             )",
          "216:         );",
          "217:     }",
          "218: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "225:     public static function is_minor_parameters() {",
          "226:         return new external_function_parameters(",
          "227:             array(",
          "228:                 'age' => new external_value(PARAM_INT, 'Age'),",
          "229:                 'country' => new external_value(PARAM_ALPHA, 'Country of residence'),",
          "230:             )",
          "231:         );",
          "232:     }",
          "243:     public static function is_minor($age, $country) {",
          "244:         global $CFG, $PAGE;",
          "245:         require_once($CFG->dirroot . '/login/lib.php');",
          "247:         $params = self::validate_parameters(",
          "248:             self::is_minor_parameters(),",
          "249:             array(",
          "250:                 'age' => $age,",
          "251:                 'country' => $country,",
          "252:             )",
          "253:         );",
          "255:         if (!array_key_exists($params['country'], get_string_manager()->get_list_of_countries())) {",
          "256:             throw new invalid_parameter_exception('Invalid value for country parameter (value: '.",
          "257:                 $params['country'] .')');",
          "258:         }",
          "260:         $context = context_system::instance();",
          "261:         $PAGE->set_context($context);",
          "264:         if (!\\core_auth\\digital_consent::is_age_digital_consent_verification_enabled()) {",
          "265:             throw new moodle_exception('nopermissions', 'error', '',",
          "266:                 get_string('agelocationverificationdisabled', 'error'));",
          "267:         }",
          "269:         $status = \\core_auth\\digital_consent::is_minor($params['age'], $params['country']);",
          "271:         return array(",
          "272:             'status' => $status",
          "273:         );",
          "274:     }",
          "282:     public static function is_minor_returns() {",
          "283:         return new external_single_structure(",
          "284:             array(",
          "285:                 'status' => new external_value(PARAM_BOOL, 'True if the user is considered to be a digital minor,",
          "286:                     false if not')",
          "287:             )",
          "288:         );",
          "289:     }",
          "",
          "---------------"
        ],
        "auth/classes/form/verify_age_location_form.php||auth/classes/form/verify_age_location_form.php": [
          "File: auth/classes/form/verify_age_location_form.php -> auth/classes/form/verify_age_location_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace core_auth\\form;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: require_once($CFG->libdir.'/formslib.php');",
          "31: use moodleform;",
          "39: class verify_age_location_form extends moodleform {",
          "43:     public function definition() {",
          "44:         global $CFG;",
          "46:         $mform = $this->_form;",
          "48:         $mform->addElement('text', 'age', get_string('whatisyourage'), array('optional'  => false));",
          "49:         $mform->setType('age', PARAM_RAW);",
          "50:         $mform->addRule('age', null, 'required', null, 'client');",
          "51:         $mform->addRule('age', null, 'numeric', null, 'client');",
          "53:         $countries = get_string_manager()->get_list_of_countries();",
          "54:         $defaultcountry[''] = get_string('selectacountry');",
          "55:         $countries = array_merge($defaultcountry, $countries);",
          "56:         $mform->addElement('select', 'country', get_string('wheredoyoulive'), $countries);",
          "57:         $mform->addRule('country', null, 'required', null, 'client');",
          "58:         $mform->setDefault('country', $CFG->country);",
          "60:         $this->add_action_buttons(true, get_string('proceed'));",
          "61:     }",
          "62: }",
          "",
          "---------------"
        ],
        "auth/classes/output/digital_minor_page.php||auth/classes/output/digital_minor_page.php": [
          "File: auth/classes/output/digital_minor_page.php -> auth/classes/output/digital_minor_page.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace core_auth\\output;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use renderable;",
          "30: use renderer_base;",
          "31: use templatable;",
          "39: class digital_minor_page implements renderable, templatable {",
          "47:     public function export_for_template(renderer_base $output) {",
          "48:         global $SITE, $CFG;",
          "50:         $sitename = format_string($SITE->fullname);",
          "51:         $supportname = $CFG->supportname;",
          "52:         $supportemail = $CFG->supportemail;",
          "54:         $context = [",
          "55:             'sitename' => $sitename,",
          "56:             'supportname' => $supportname,",
          "57:             'supportemail' => $supportemail,",
          "58:             'homelink' => new \\moodle_url('/')",
          "59:         ];",
          "61:         return $context;",
          "62:     }",
          "63: }",
          "",
          "---------------"
        ],
        "auth/classes/output/verify_age_location_page.php||auth/classes/output/verify_age_location_page.php": [
          "File: auth/classes/output/verify_age_location_page.php -> auth/classes/output/verify_age_location_page.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: namespace core_auth\\output;",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use renderable;",
          "30: use renderer_base;",
          "31: use templatable;",
          "33: require_once($CFG->libdir.'/formslib.php');",
          "41: class verify_age_location_page implements renderable, templatable {",
          "44:     protected $form;",
          "47:     protected $errormessage;",
          "55:     public function __construct($form, $errormessage = null) {",
          "56:         $this->form = $form;",
          "57:         $this->errormessage = $errormessage;",
          "58:     }",
          "66:     public function export_for_template(renderer_base $output) {",
          "67:         global $SITE;",
          "69:         $sitename = format_string($SITE->fullname);",
          "70:         $formhtml = $this->form->render();",
          "71:         $error = $this->errormessage;",
          "73:         $context = [",
          "74:             'sitename' => $sitename,",
          "75:             'formhtml' => $formhtml,",
          "76:             'error'    => $error",
          "77:         ];",
          "79:         return $context;",
          "80:     }",
          "81: }",
          "",
          "---------------"
        ],
        "auth/tests/behat/validateagedigitalconsentmap.feature||auth/tests/behat/validateagedigitalconsentmap.feature": [
          "File: auth/tests/behat/validateagedigitalconsentmap.feature -> auth/tests/behat/validateagedigitalconsentmap.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @core @verify_age_location",
          "2: Feature: Test validation of 'Age of digital consent' setting.",
          "3:   In order to set the 'Age of digital consent' setting",
          "4:   As an admin",
          "5:   I need to provide valid data and valid format",
          "7:   Background:",
          "8:     Given I log in as \"admin\"",
          "9:     And I navigate to \"Manage authentication\" node in \"Site administration > Plugins > Authentication\"",
          "11:   Scenario: Admin provides valid value for 'Age of digital consent'.",
          "12:     Given I set the field \"s__agedigitalconsentmap\" to multiline:",
          "13:     \"\"\"",
          "15:     AT, 14",
          "16:     BE, 14",
          "17:     \"\"\"",
          "18:     When I press \"Save changes\"",
          "19:     Then I should see \"Changes saved\"",
          "20:     And I should not see \"Some settings were not changed due to an error.\"",
          "21:     And I should not see \"The digital age of consent is not valid:\"",
          "23:   Scenario: Admin provides invalid format for 'Age of digital consent'.",
          "24:     # Try to set a value with missing space separator",
          "25:     Given I set the field \"s__agedigitalconsentmap\" to multiline:",
          "26:     \"\"\"",
          "28:     AT, 14",
          "29:     BE, 14",
          "30:     \"\"\"",
          "31:     When I press \"Save changes\"",
          "32:     Then I should not see \"Changes saved\"",
          "33:     And I should see \"Some settings were not changed due to an error.\"",
          "34:     And I should see \"The digital age of consent is not valid: \\\"*16\\\" has more or less than one comma separator.\"",
          "35:     # Try to set a value with missing default age of consent",
          "36:     When I set the field \"s__agedigitalconsentmap\" to multiline:",
          "37:     \"\"\"",
          "38:     AT, 14",
          "39:     BE, 14",
          "40:     \"\"\"",
          "41:     And I press \"Save changes\"",
          "42:     Then I should not see \"Changes saved\"",
          "43:     And I should see \"Some settings were not changed due to an error.\"",
          "44:     And I should see \"The digital age of consent is not valid: Default (*) value is missing.\"",
          "46:   Scenario: Admin provides invalid age of consent or country for 'Age of digital consent'.",
          "47:     # Try to set a value containing invalid age of consent",
          "48:     Given I set the field \"s__agedigitalconsentmap\" to multiline:",
          "49:     \"\"\"",
          "51:     AT, age",
          "52:     BE, 14",
          "53:     \"\"\"",
          "54:     When I press \"Save changes\"",
          "55:     Then I should not see \"Changes saved\"",
          "56:     And I should see \"Some settings were not changed due to an error.\"",
          "57:     And I should see \"The digital age of consent is not valid: \\\"age\\\" is not a valid value for age.\"",
          "58:     # Try to set a value containing invalid country",
          "59:     When I set the field \"s__agedigitalconsentmap\" to multiline:",
          "60:     \"\"\"",
          "62:     COUNTRY, 14",
          "63:     BE, 14",
          "64:     \"\"\"",
          "65:     And I press \"Save changes\"",
          "66:     Then I should not see \"Changes saved\"",
          "67:     And I should see \"Some settings were not changed due to an error.\"",
          "68:     And I should see \"The digital age of consent is not valid: \\\"COUNTRY\\\" is not a valid value for country.\"",
          "",
          "---------------"
        ],
        "auth/tests/behat/verifyageofconsent.feature||auth/tests/behat/verifyageofconsent.feature": [
          "File: auth/tests/behat/verifyageofconsent.feature -> auth/tests/behat/verifyageofconsent.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: @core @verify_age_location",
          "2: Feature: Test the 'Digital age of consent verification' feature works.",
          "3:   In order to self-register on the site",
          "4:   As an user",
          "5:   I need be to be over the age of digital consent",
          "7:   Background:",
          "8:     Given the following config values are set as admin:",
          "9:       | registerauth | email |",
          "10:       | agedigitalconsentverification | 1 |",
          "12:   Scenario: User that is not considered a digital minor attempts to self-register on the site.",
          "13:     # Try to access the sign up page.",
          "14:     Given I am on homepage",
          "15:     When I click on \"Log in\" \"link\" in the \".logininfo\" \"css_element\"",
          "16:     And I press \"Create new account\"",
          "17:     Then I should see \"Age and location verification\"",
          "18:     When I set the field \"What is your age?\" to \"16\"",
          "19:     And I set the field \"In which country do you live?\" to \"DZ\"",
          "20:     And I press \"Proceed\"",
          "21:     Then I should see \"New account\"",
          "22:     And I should see \"Choose your username and password\"",
          "23:     # Try to access the sign up page again.",
          "24:     When I press \"Cancel\"",
          "25:     And I press \"Create new account\"",
          "26:     Then I should see \"New account\"",
          "27:     And I should see \"Choose your username and password\"",
          "29:   Scenario: User that is considered a digital minor attempts to self-register on the site.",
          "30:     # Try to access the sign up page.",
          "31:     Given I am on homepage",
          "32:     When I click on \"Log in\" \"link\" in the \".logininfo\" \"css_element\"",
          "33:     And I press \"Create new account\"",
          "34:     Then I should see \"Age and location verification\"",
          "35:     When I set the field \"What is your age?\" to \"12\"",
          "36:     And I set the field \"In which country do you live?\" to \"AT\"",
          "37:     And I press \"Proceed\"",
          "38:     Then I should see \"You are considered to be a digital minor.\"",
          "39:     And I should see \"To create an account on this site please have your parent/guardian contact the following person.\"",
          "40:     # Try to access the sign up page again.",
          "41:     When I click on \"Back to the site home\" \"link\"",
          "42:     And I click on \"Log in\" \"link\" in the \".logininfo\" \"css_element\"",
          "43:     And I press \"Create new account\"",
          "44:     Then I should see \"You are considered to be a digital minor.\"",
          "45:     And I should see \"To create an account on this site please have your parent/guardian contact the following person.\"",
          "",
          "---------------"
        ],
        "auth/tests/digital_consent_test.php||auth/tests/digital_consent_test.php": [
          "File: auth/tests/digital_consent_test.php -> auth/tests/digital_consent_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "25: defined('MOODLE_INTERNAL') || die();",
          "34: class core_auth_digital_consent_testcase extends advanced_testcase {",
          "36:     public function test_is_age_digital_consent_verification_enabled() {",
          "37:         global $CFG;",
          "38:         $this->resetAfterTest();",
          "41:         $CFG->agedigitalconsentverification = 0;",
          "43:         $isenabled = \\core_auth\\digital_consent::is_age_digital_consent_verification_enabled();",
          "44:         $this->assertFalse($isenabled);",
          "45:     }",
          "47:     public function test_is_minor() {",
          "48:         global $CFG;",
          "49:         $this->resetAfterTest();",
          "51:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "52:             '*, 16',",
          "53:             'AT, 14',",
          "54:             'CZ, 13',",
          "55:             'DE, 14',",
          "56:             'DK, 13',",
          "57:         ]);",
          "58:         $CFG->agedigitalconsentmap = $agedigitalconsentmap;",
          "60:         $usercountry1 = 'DK';",
          "61:         $usercountry2 = 'AU';",
          "62:         $userage1 = 12;",
          "63:         $userage2 = 14;",
          "64:         $userage3 = 16;",
          "67:         $isminor = \\core_auth\\digital_consent::is_minor($userage1, $usercountry1);",
          "68:         $this->assertTrue($isminor);",
          "70:         $isminor = \\core_auth\\digital_consent::is_minor($userage2, $usercountry1);",
          "71:         $this->assertFalse($isminor);",
          "73:         $isminor = \\core_auth\\digital_consent::is_minor($userage2, $usercountry2);",
          "74:         $this->assertTrue($isminor);",
          "76:         $isminor = \\core_auth\\digital_consent::is_minor($userage3, $usercountry2);",
          "77:         $this->assertFalse($isminor);",
          "78:     }",
          "80:     public function test_parse_age_digital_consent_map_valid_format() {",
          "83:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "84:             '*, 16',",
          "85:             'AT, 14',",
          "86:             'BE, 13'",
          "87:         ]);",
          "89:         $ageconsentmapparsed = \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "91:         $this->assertEquals([",
          "92:             '*' => 16,",
          "93:             'AT' => 14,",
          "94:             'BE' => 13",
          "95:         ], $ageconsentmapparsed",
          "96:         );",
          "97:     }",
          "99:     public function test_parse_age_digital_consent_map_invalid_format_missing_spaces() {",
          "102:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "103:             '*, 16',",
          "104:             'AT14',",
          "105:         ]);",
          "107:         $this->expectException('moodle_exception');",
          "108:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvalidcomma', 'error', 'AT14'));",
          "110:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "111:     }",
          "113:     public function test_parse_age_digital_consent_map_invalid_format_missing_default_value() {",
          "116:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "117:             'BE, 16',",
          "118:             'AT, 14'",
          "119:         ]);",
          "121:         $this->expectException('moodle_exception');",
          "122:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvaliddefault', 'error'));",
          "124:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "125:     }",
          "127:     public function test_parse_age_digital_consent_map_invalid_format_invalid_country() {",
          "130:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "131:             '*, 16',",
          "132:             'TEST, 14'",
          "133:         ]);",
          "135:         $this->expectException('moodle_exception');",
          "136:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvalidcountry', 'error', 'TEST'));",
          "138:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "139:     }",
          "141:     public function test_parse_age_digital_consent_map_invalid_format_invalid_age_string() {",
          "144:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "145:             '*, 16',",
          "146:             'AT, ten'",
          "147:         ]);",
          "149:         $this->expectException('moodle_exception');",
          "150:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvalidage', 'error', 'ten'));",
          "152:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "153:     }",
          "155:     public function test_parse_age_digital_consent_map_invalid_format_missing_age() {",
          "158:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "159:             '*, 16',",
          "160:             'AT, '",
          "161:         ]);",
          "163:         $this->expectException('moodle_exception');",
          "164:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvalidage', 'error', ''));",
          "166:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "167:     }",
          "169:     public function test_parse_age_digital_consent_map_invalid_format_missing_country() {",
          "172:         $agedigitalconsentmap = implode(PHP_EOL, [",
          "173:             '*, 16',",
          "174:             ', 12'",
          "175:         ]);",
          "177:         $this->expectException('moodle_exception');",
          "178:         $this->expectExceptionMessage(get_string('agedigitalconsentmapinvalidcountry', 'error', ''));",
          "180:         \\core_auth\\digital_consent::parse_age_digital_consent_map($agedigitalconsentmap);",
          "181:     }",
          "182: }",
          "",
          "---------------"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: $string['adminseesallevents'] = 'Administrators see all events';",
          "40: $string['adminseesownevents'] = 'Administrators are just like other users';",
          "41: $string['advancedfeatures'] = 'Advanced features';",
          "42: $string['allcountrycodes'] = 'All country codes';",
          "43: $string['allowattachments'] = 'Allow attachments';",
          "44: $string['allowbeforeblock'] = 'Allowed list will be processed first';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: $string['agedigitalconsentverification'] = 'Digital age of consent verification';",
          "43: $string['agedigitalconsentverification_desc'] = 'Enables verification of the digital age of consent before displaying the sign-up page for self-registration users. This protects your site from minors signing up without parental/guardian consent. <a target=\"_blank\" href=\"{$a}\">Support contact</a> details are provided to minors for further assistance.';",
          "44: $string['ageofdigitalconsentmap'] = 'Digital age of consent';",
          "45: $string['ageofdigitalconsentmap_desc'] = 'The default digital age of consent, and the age in any country where it differs from the default, may be specified here. Enter each age on a new line with format: country code, age (separated by a comma). The default age is indicated by * in place of the country code. Country codes are as specified in ISO 3166-2.';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "617: $string['installsessionerror'] = 'Can not initialise PHP session, please verify that your browser accepts cookies.';",
          "618: $string['intlrecommended'] = 'Intl extension is used to improve internationalization support, such as locale aware sorting.';",
          "619: $string['intlrequired'] = 'Intl extension is required to improve internationalization support, such as locale aware sorting and international domain names.';",
          "620: $string['invalidforgottenpasswordurl'] = 'The forgotten password URL is not a valid URL.';",
          "621: $string['invalidsection'] = 'Invalid section.';",
          "622: $string['invaliduserchangeme'] = 'Username \"changeme\" is reserved -- you cannot create an account with it.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "624: $string['invalidagedigitalconsent'] = 'The digital age of consent is not valid: {$a}';",
          "",
          "---------------"
        ],
        "lang/en/cache.php||lang/en/cache.php": [
          "File: lang/en/cache.php -> lang/en/cache.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "62: $string['cachedef_observers'] = 'Event observers';",
          "63: $string['cachedef_plugin_functions'] = 'Plugins available callbacks';",
          "64: $string['cachedef_plugin_manager'] = 'Plugin info manager';",
          "65: $string['cachedef_postprocessedcss'] = 'Post processed CSS';",
          "66: $string['cachedef_tagindexbuilder'] = 'Search results for tagged items';",
          "67: $string['cachedef_questiondata'] = 'Question definitions';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "65: $string['cachedef_presignup'] = 'Pre sign-up data for particular unregistered user';",
          "",
          "---------------"
        ],
        "lang/en/error.php||lang/en/error.php": [
          "File: lang/en/error.php -> lang/en/error.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: $string['activityisscheduledfordeletion'] = 'Activity deletion in progress...';",
          "26: $string['authnotexisting'] = 'The autorization plugin doesn\\'t exist';",
          "27: $string['backupcontainexternal'] = 'This backup file contains external Moodle Network Hosts that are not configured locally';",
          "28: $string['backuptablefail'] = 'Backup tables could NOT be set up successfully!';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: $string['agedigitalconsentmapinvalidage'] = '\"{$a}\" is not a valid value for age.';",
          "27: $string['agedigitalconsentmapinvalidcomma'] = '\"{$a}\" has more or less than one comma separator.';",
          "28: $string['agedigitalconsentmapinvalidcountry'] = '\"{$a}\" is not a valid value for country.';",
          "29: $string['agedigitalconsentmapinvaliddefault'] = 'Default (*) value is missing.';",
          "30: $string['agelocationverificationdisabled'] = 'Age and location verification disabled';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "177: $string['confirmsesskeybad'] = 'Sorry, but your session key could not be confirmed to carry out this action.  This security feature prevents against accidental or malicious execution of important functions in your name.  Please make sure you really wanted to execute this function.';",
          "178: $string['couldnotassignrole'] = 'A serious but unspecified error occurred while trying to assign a role to you';",
          "179: $string['couldnotupdatenoexistinguser'] = 'Cannot update the user - user doesn\\'t exist';",
          "180: $string['countriesphpempty'] = 'Error: The file countries.php in language pack {$a} is empty or missing.';",
          "181: $string['coursedoesnotbelongtocategory'] = 'The course doesn\\'t belong to this category';",
          "182: $string['courseformatnotfound'] = 'The course format \\'{$a}\\' doesn\\'t exist or is not recognized';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "185: $string['couldnotverifyagedigitalconsent'] = 'An error occurred while trying to verify the age of digital consent.<br />Please contact administrator.';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "578: $string['usernotupdatednotexists'] = 'User not updated - does not exist';",
          "579: $string['userquotalimit'] = 'You have reached your file quota limit.';",
          "580: $string['userselectortoomany'] = 'user_selector got more than one selected user, even though multiselect is false.';",
          "581: $string['wrongcall'] = 'This script is called wrongly';",
          "582: $string['wrongcontextid'] = 'Context ID was incorrect (cannot find it)';",
          "583: $string['wrongdestpath'] = 'Wrong destination path';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "587: $string['verifyagedigitalconsentnotpossible'] = 'Sorry, digital age consent verification is not possible at this time.';",
          "",
          "---------------"
        ],
        "lang/en/moodle.php||lang/en/moodle.php": [
          "File: lang/en/moodle.php -> lang/en/moodle.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "119: $string['afterresource'] = 'After resource \"{$a}\"';",
          "120: $string['aftersection'] = 'After section \"{$a}\"';",
          "121: $string['again'] = 'again';",
          "122: $string['aimid'] = 'AIM ID';",
          "123: $string['ajaxuse'] = 'AJAX and Javascript';",
          "124: $string['all'] = 'All';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "122: $string['agelocationverification'] = 'Age and location verification';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "170: $string['back'] = 'Back';",
          "171: $string['backto'] = 'Back to {$a}';",
          "172: $string['backtocourselisting'] = 'Back to course listing';",
          "173: $string['backtopageyouwereon'] = 'Back to the page you were on';",
          "174: $string['backtoparticipants'] = 'Back to participants list';",
          "175: $string['backup'] = 'Backup';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "174: $string['backtohome'] = 'Back to the site home';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "267: $string['confirmednot'] = 'Your registration has not yet been confirmed!';",
          "268: $string['confirmcheckfull'] = 'Are you absolutely sure you want to confirm {$a} ?';",
          "269: $string['confirmcoursemove'] = 'Are you sure you want to move this course ({$a->course}) into this category ({$a->category})?';",
          "270: $string['content'] = 'Content';",
          "271: $string['continue'] = 'Continue';",
          "272: $string['continuetocourse'] = 'Click here to enter your course';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "272: $string['considereddigitalminor'] = 'You are considered to be a digital minor.';",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "498: $string['deselectall'] = 'Deselect all';",
          "499: $string['detailedless'] = 'Less detailed';",
          "500: $string['detailedmore'] = 'More detailed';",
          "501: $string['directory'] = 'Directory';",
          "502: $string['disable'] = 'Disable';",
          "503: $string['disabledcomments'] = 'Comments are disabled';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "504: $string['digitalminor'] = 'Digital minor';",
          "505: $string['digitalminor_desc'] = 'To create an account on this site please have your parent/guardian contact the following person.';",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "794: $string['expandall'] = 'Expand all';",
          "795: $string['expandcategory'] = 'Expand {$a}';",
          "796: $string['explanation'] = 'Explanation';",
          "797: $string['extendperiod'] = 'Extended period';",
          "798: $string['failedloginattempts'] = '{$a->attempts} failed logins since your last login';",
          "799: $string['feedback'] = 'Feedback';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "802: $string['explanationdigitalminor'] = 'This information is required to determine if your age is over the digital age of consent. This is the age when an individual can consent to terms and conditions and their data being legally stored and processed.';",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1547: $string['privatefiles'] = 'Private files';",
          "1548: $string['private_files_handler'] = 'Store attachments to an e-mail in the user\\'s private files storage space.';",
          "1549: $string['private_files_handler_name'] = 'Email to Private files';",
          "1550: $string['profile'] = 'Profile';",
          "1551: $string['profilenotshown'] = 'This profile description will not be shown until this person is enrolled in at least one course.';",
          "1552: $string['publicprofile'] = 'Public profile';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1556: $string['proceed'] = 'Proceed';",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2102:   {$a->profileurl}';",
          "2103: $string['whatforlink'] = 'What do you want to do with the link?';",
          "2104: $string['whatforpage'] = 'What do you want to do with the text?';",
          "2105: $string['whattocallzip'] = 'What do you want to call the zip file?';",
          "2106: $string['whattodo'] = 'What to do';",
          "2107: $string['windowclosing'] = 'This window should close automatically. If not, please close it now.';",
          "2108: $string['withchosenfiles'] = 'With chosen files';",
          "2109: $string['withdisablednote'] = '{$a} (disabled)';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2112: $string['whatisyourage'] = 'What is your age?';",
          "2115: $string['wheredoyoulive'] = 'In which country do you live?';",
          "2116: $string['whyisthisrequired'] = 'Why is this required?';",
          "",
          "---------------"
        ],
        "lib/adminlib.php||lib/adminlib.php": [
          "File: lib/adminlib.php -> lib/adminlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "10579:         return true;",
          "10580:     }",
          "10581: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10589: class admin_setting_agedigitalconsentmap extends admin_setting_configtextarea {",
          "10602:     public function __construct($name, $visiblename, $description, $defaultsetting, $paramtype = PARAM_RAW,",
          "10603:                                 $cols = '60', $rows = '8') {",
          "10604:         parent::__construct($name, $visiblename, $description, $defaultsetting, $paramtype, $cols, $rows);",
          "10606:         $this->set_force_ltr(false);",
          "10607:     }",
          "10615:     public function validate($data) {",
          "10616:         if (empty($data)) {",
          "10617:             return true;",
          "10618:         }",
          "10620:         try {",
          "10621:             \\core_auth\\digital_consent::parse_age_digital_consent_map($data);",
          "10622:         } catch (\\moodle_exception $e) {",
          "10623:             return get_string('invalidagedigitalconsent', 'admin', $e->getMessage());",
          "10624:         }",
          "10626:         return true;",
          "10627:     }",
          "10628: }",
          "",
          "---------------"
        ],
        "lib/db/caches.php||lib/db/caches.php": [
          "File: lib/db/caches.php -> lib/db/caches.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "362:         'simpledata' => true,",
          "363:         'staticacceleration' => true,",
          "364:     ),",
          "365: );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "369:     'presignup' => array(",
          "370:         'mode' => cache_store::MODE_SESSION,",
          "371:         'simplekeys' => true,",
          "372:         'simpledata' => true,",
          "373:         'ttl' => 1800,",
          "374:     ),",
          "",
          "---------------"
        ],
        "lib/db/services.php||lib/db/services.php": [
          "File: lib/db/services.php -> lib/db/services.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:         'ajax'          => true,",
          "51:         'loginrequired' => false,",
          "52:     ),",
          "53:     'core_badges_get_user_badges' => array(",
          "54:         'classname'     => 'core_badges_external',",
          "55:         'methodname'    => 'get_user_badges',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "53:     'core_auth_is_minor' => array(",
          "54:         'classname'   => 'core_auth_external',",
          "55:         'methodname'  => 'is_minor',",
          "56:         'description' => 'Requests a check if a user is a digital minor.',",
          "57:         'type'        => 'read',",
          "58:         'loginrequired' => false,",
          "59:     ),",
          "",
          "---------------"
        ],
        "lib/outputrenderers.php||lib/outputrenderers.php": [
          "File: lib/outputrenderers.php -> lib/outputrenderers.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4451:         return $this->render_from_template('core/signup_form_layout', $context);",
          "4452:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4460:     protected function render_verify_age_location_page($page) {",
          "4461:         $context = $page->export_for_template($this);",
          "4463:         return $this->render_from_template('core/auth_verify_age_location_page', $context);",
          "4464:     }",
          "4472:     protected function render_digital_minor_page($page) {",
          "4473:         $context = $page->export_for_template($this);",
          "4475:         return $this->render_from_template('core/auth_digital_minor_page', $context);",
          "4476:     }",
          "",
          "---------------"
        ],
        "lib/templates/auth_digital_minor_page.mustache||lib/templates/auth_digital_minor_page.mustache": [
          "File: lib/templates/auth_digital_minor_page.mustache -> lib/templates/auth_digital_minor_page.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_auth/output/digital_minor_page",
          "20:     Example context (json):",
          "21:     {",
          "22:         \"logourl\": \"https://moodle.org/logo/moodle-logo.svg\",",
          "23:         \"sitename\": \"Site name\",",
          "24:         \"supportname\": \"John Doe\",",
          "25:         \"supportemail\": \"johndoe@example.com\",",
          "26:         \"homelink\": \"/\"",
          "27:     }",
          "28: }}",
          "29: <h3>{{#str}}considereddigitalminor{{/str}}</h3>",
          "30: <p class=\"m-b-0\">{{#str}}digitalminor_desc{{/str}}</p>",
          "31: <div class=\"p-t-1 p-b-1\">",
          "32:     <p class=\"m-b-0\">{{{supportname}}}</p>",
          "33:     <p class=\"m-b-0\">{{{supportemail}}}</p>",
          "34: </div>",
          "35: <div class=\"backlink\">",
          "36:     <a href=\"{{homelink}}\">{{#str}}backtohome{{/str}}</a>",
          "37: </div>",
          "",
          "---------------"
        ],
        "lib/templates/auth_verify_age_location_page.mustache||lib/templates/auth_verify_age_location_page.mustache": [
          "File: lib/templates/auth_verify_age_location_page.mustache -> lib/templates/auth_verify_age_location_page.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_auth/output/verify_age_location_page",
          "20:     Example context (json):",
          "21:     {",
          "22:         \"logourl\": \"https://moodle.org/logo/moodle-logo.svg\",",
          "23:         \"sitename\": \"Site name\",",
          "24:         \"error\": \"Error message\",",
          "25:         \"formhtml\": \"(Form html would go here)\"",
          "26:     }",
          "27: }}",
          "28: {{#error}}",
          "29:     <div class=\"alert alert-danger\" role=\"alert\">",
          "30:         {{{error}}}",
          "31:     </div>",
          "32: {{/error}}",
          "33: <h3>{{#str}}agelocationverification{{/str}}</h3>",
          "34: {{{formhtml}}}",
          "35: <hr>",
          "36: <h3>{{#str}}whyisthisrequired{{/str}}</h3>",
          "37: <p >{{#str}}explanationdigitalminor{{/str}}</p>",
          "",
          "---------------"
        ],
        "login/digital_minor.php||login/digital_minor.php": [
          "File: login/digital_minor.php -> login/digital_minor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "26: require('../config.php');",
          "27: require_once($CFG->libdir . '/authlib.php');",
          "29: $authplugin = signup_is_enabled();",
          "31: if (!$authplugin || !\\core_auth\\digital_consent::is_age_digital_consent_verification_enabled()) {",
          "33:     redirect(new moodle_url('/'), get_string('verifyagedigitalconsentnotpossible', 'error'));",
          "34: }",
          "36: $PAGE->set_context(context_system::instance());",
          "37: $PAGE->set_url($CFG->wwwroot.'/login/digital_minor.php');",
          "39: if (isloggedin() and !isguestuser()) {",
          "41:     redirect(new moodle_url('/'), get_string('cannotsignup', 'error', fullname($USER)));",
          "42: }",
          "44: $cache = cache::make('core', 'presignup');",
          "45: $isminor = $cache->get('isminor');",
          "46: if ($isminor !== 'yes') {",
          "48:     redirect(new moodle_url('/login/index.php'));",
          "49: }",
          "51: $PAGE->navbar->add(get_string('login'));",
          "52: $PAGE->navbar->add(get_string('digitalminor'));",
          "54: $PAGE->set_pagelayout('login');",
          "55: $PAGE->set_title(get_string('digitalminor'));",
          "56: $sitename = format_string($SITE->fullname);",
          "57: $PAGE->set_heading($sitename);",
          "59: $page = new \\core_auth\\output\\digital_minor_page();",
          "61: echo $OUTPUT->header();",
          "62: echo $OUTPUT->render($page);",
          "63: echo $OUTPUT->footer();",
          "",
          "---------------"
        ],
        "login/signup.php||login/signup.php": [
          "File: login/signup.php -> login/signup.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     exit;",
          "61: }",
          "65: core_login_pre_signup_requests();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64: if (\\core_auth\\digital_consent::is_age_digital_consent_verification_enabled()) {",
          "65:     $cache = cache::make('core', 'presignup');",
          "66:     $isminor = $cache->get('isminor');",
          "67:     if ($isminor === false) {",
          "69:         redirect(new moodle_url('/login/verify_age_location.php'));",
          "70:     } else if ($isminor === 'yes') {",
          "72:         redirect(new moodle_url('/login/digital_minor.php'));",
          "73:     }",
          "74: }",
          "",
          "---------------"
        ],
        "login/verify_age_location.php||login/verify_age_location.php": [
          "File: login/verify_age_location.php -> login/verify_age_location.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "26: require('../config.php');",
          "27: require_once($CFG->libdir . '/authlib.php');",
          "29: $authplugin = signup_is_enabled();",
          "31: if (!$authplugin || !\\core_auth\\digital_consent::is_age_digital_consent_verification_enabled()) {",
          "33:     redirect(new moodle_url('/'), get_string('verifyagedigitalconsentnotpossible', 'error'));",
          "34: }",
          "36: $PAGE->set_context(context_system::instance());",
          "37: $PAGE->set_url(new moodle_url('/login/verify_age_location.php'));",
          "39: if (isloggedin() and !isguestuser()) {",
          "41:     redirect(new moodle_url('/'), get_string('cannotsignup', 'error', fullname($USER)));",
          "42: }",
          "44: $cache = cache::make('core', 'presignup');",
          "45: $isminor = $cache->get('isminor');",
          "46: if ($isminor === 'yes') {",
          "48:     redirect(new moodle_url('/login/digital_minor.php'));",
          "49: } else if ($isminor === 'no') {",
          "51:     redirect(new moodle_url('/login/signup.php'));",
          "52: }",
          "54: $PAGE->navbar->add(get_string('login'));",
          "55: $PAGE->navbar->add(get_string('agelocationverification'));",
          "57: $PAGE->set_pagelayout('login');",
          "58: $PAGE->set_title(get_string('agelocationverification'));",
          "59: $sitename = format_string($SITE->fullname);",
          "60: $PAGE->set_heading($sitename);",
          "62: $mform = new \\core_auth\\form\\verify_age_location_form();",
          "63: $page = new \\core_auth\\output\\verify_age_location_page($mform);",
          "65: if ($mform->is_cancelled()) {",
          "66:     redirect(new moodle_url('/login/index.php'));",
          "67: } else if ($data = $mform->get_data()) {",
          "68:     try {",
          "69:         $isminor = \\core_auth\\digital_consent::is_minor($data->age, $data->country);",
          "70:         cache::make('core', 'presignup')->set('isminor', $isminor ? 'yes' : 'no');",
          "71:         if ($isminor) {",
          "72:             redirect(new moodle_url('/login/digital_minor.php'));",
          "73:         } else {",
          "74:             redirect(new moodle_url('/login/signup.php'));",
          "75:         }",
          "76:     } catch (moodle_exception $e) {",
          "78:         $errormessage = get_string('couldnotverifyagedigitalconsent', 'error');",
          "79:         $page = new \\core_auth\\output\\verify_age_location_page($mform, $errormessage);",
          "80:         echo $OUTPUT->header();",
          "81:         echo $OUTPUT->render($page);",
          "82:         echo $OUTPUT->footer();",
          "83:     }",
          "84: } else {",
          "85:     echo $OUTPUT->header();",
          "86:     echo $OUTPUT->render($page);",
          "87:     echo $OUTPUT->footer();",
          "88: }",
          "",
          "---------------"
        ],
        "theme/boost/templates/core/auth_digital_minor_page.mustache||theme/boost/templates/core/auth_digital_minor_page.mustache": [
          "File: theme/boost/templates/core/auth_digital_minor_page.mustache -> theme/boost/templates/core/auth_digital_minor_page.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_auth/output/digital_minor_page",
          "20:     Example context (json):",
          "21:     {",
          "22:         \"logourl\": \"https://moodle.org/logo/moodle-logo.svg\",",
          "23:         \"sitename\": \"Site name\",",
          "24:         \"supportname\": \"John Doe\",",
          "25:         \"supportemail\": \"johndoe@example.com\",",
          "26:         \"homelink\": \"/\"",
          "27:     }",
          "28: }}",
          "29: <div class=\"container-fluid\">",
          "30:     <div class=\"row\">",
          "31:         <div class=\"col-md-8 push-md-2 col-xl-6 push-xl-3\">",
          "32:             <div class=\"card\">",
          "33:                 <div class=\"card-block\">",
          "34:                     <div class=\"card-title text-xs-center\">",
          "35:                         {{#logourl}}",
          "36:                             <h2><img src=\"{{logourl}}\" title=\"{{sitename}}\" alt=\"{{sitename}}\"/></h2>",
          "37:                         {{/logourl}}",
          "38:                         {{^logourl}}",
          "39:                             <h2>{{sitename}}</h2>",
          "40:                         {{/logourl}}",
          "41:                         <hr>",
          "42:                     </div>",
          "43:                      <div class=\"card-title\">",
          "44:                         <h3>{{#str}}considereddigitalminor{{/str}}</h3>",
          "45:                     </div>",
          "46:                     <div class=\"p-t-1 p-b-2\">",
          "47:                         <p>{{#str}}digitalminor_desc{{/str}}</p>",
          "48:                         <p class=\"m-b-0\">{{{supportname}}}</p>",
          "49:                         <p class=\"m-b-0\">{{{supportemail}}}</p>",
          "50:                     </div>",
          "51:                     <div class=\"backlink\">",
          "52:                         <a href=\"{{homelink}}\">{{#str}}backtohome{{/str}}</a>",
          "53:                     </div>",
          "54:                 </div>",
          "55:             </div>",
          "56:         </div>",
          "57:     </div>",
          "58: </div>",
          "",
          "---------------"
        ],
        "theme/boost/templates/core/auth_verify_age_location_page.mustache||theme/boost/templates/core/auth_verify_age_location_page.mustache": [
          "File: theme/boost/templates/core/auth_verify_age_location_page.mustache -> theme/boost/templates/core/auth_verify_age_location_page.mustache",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: {{!",
          "2:     This file is part of Moodle - http://moodle.org/",
          "4:     Moodle is free software: you can redistribute it and/or modify",
          "5:     it under the terms of the GNU General Public License as published by",
          "6:     the Free Software Foundation, either version 3 of the License, or",
          "7:     (at your option) any later version.",
          "9:     Moodle is distributed in the hope that it will be useful,",
          "10:     but WITHOUT ANY WARRANTY; without even the implied warranty of",
          "11:     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the",
          "12:     GNU General Public License for more details.",
          "14:     You should have received a copy of the GNU General Public License",
          "15:     along with Moodle.  If not, see <http://www.gnu.org/licenses/>.",
          "16: }}",
          "17: {{!",
          "18:     @template core_auth/output/verify_age_location_page",
          "20:     Example context (json):",
          "21:     {",
          "22:         \"logourl\": \"https://moodle.org/logo/moodle-logo.svg\",",
          "23:         \"sitename\": \"Site name\",",
          "24:         \"error\": \"Error message\",",
          "25:         \"formhtml\": \"(Form html would go here)\"",
          "26:     }",
          "27: }}",
          "28: <div class=\"container-fluid\">",
          "29:     <div class=\"row\">",
          "30:         <div class=\"col-md-8 push-md-2 col-xl-6 push-xl-3\">",
          "31:             <div class=\"card\">",
          "32:                 <div class=\"card-block\">",
          "33:                     <div class=\"card-title text-xs-center\">",
          "34:                         {{#logourl}}",
          "35:                             <h2><img src=\"{{logourl}}\" title=\"{{sitename}}\" alt=\"{{sitename}}\"/></h2>",
          "36:                         {{/logourl}}",
          "37:                         {{^logourl}}",
          "38:                             <h2>{{sitename}}</h2>",
          "39:                         {{/logourl}}",
          "40:                         <hr>",
          "41:                     </div>",
          "42:                     {{#error}}",
          "43:                         <div class=\"alert alert-danger\" role=\"alert\">",
          "44:                             {{{error}}}",
          "45:                         </div>",
          "46:                     {{/error}}",
          "47:                     <div class=\"card-title\">",
          "48:                         <h3>{{#str}}agelocationverification{{/str}}</h3>",
          "49:                     </div>",
          "50:                     <div class=\"m-t-2 m-b-2\">",
          "51:                         {{{formhtml}}}",
          "52:                     </div>",
          "53:                     <hr>",
          "54:                     <div class=\"card-title\">",
          "55:                         <h3>{{#str}}whyisthisrequired{{/str}}</h3>",
          "56:                     </div>",
          "57:                     <div class=\"m-t-1\">",
          "58:                         <p >{{#str}}explanationdigitalminor{{/str}}</p>",
          "59:                     </div>",
          "60:                 </div>",
          "61:             </div>",
          "62:         </div>",
          "63:     </div>",
          "64: </div>",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018022800.03;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018022800.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}