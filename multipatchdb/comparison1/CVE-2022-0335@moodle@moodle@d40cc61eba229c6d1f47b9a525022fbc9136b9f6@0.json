{
  "cve_id": "CVE-2022-0335",
  "cve_desc": "A flaw was found in Moodle in versions 3.11 to 3.11.4, 3.10 to 3.10.8, 3.9 to 3.9.11 and earlier unsupported versions. The \"delete badge alignment\" functionality did not include the necessary token check to prevent a CSRF risk.",
  "repo": "moodle/moodle",
  "patch_hash": "d40cc61eba229c6d1f47b9a525022fbc9136b9f6",
  "patch_info": {
    "commit_hash": "d40cc61eba229c6d1f47b9a525022fbc9136b9f6",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/d40cc61eba229c6d1f47b9a525022fbc9136b9f6",
    "files": [
      "badges/alignment_action.php",
      "badges/renderer.php"
    ],
    "message": "MDL-72367 badges: require sesskey to remove badge alignment.",
    "before_after_code_files": [
      "badges/alignment_action.php||badges/alignment_action.php",
      "badges/renderer.php||badges/renderer.php"
    ]
  },
  "patch_diff": {
    "badges/alignment_action.php||badges/alignment_action.php": [
      "File: badges/alignment_action.php -> badges/alignment_action.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "25: require_once(__DIR__ . '/../config.php');",
      "26: require_once($CFG->libdir . '/badgeslib.php');",
      "29: $badgeid = required_param('id', PARAM_INT); // Badge ID.",
      "32: require_login();",
      "33: $return = new moodle_url('/badges/alignment.php', array('id' => $badgeid));",
      "",
      "[Removed Lines]",
      "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Related badge ID.",
      "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Remove.",
      "",
      "[Added Lines]",
      "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Alignment ID.",
      "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Action to perform.",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "36: require_capability('moodle/badges:configuredetails', $context);",
      "38: if ($action == 'remove') {",
      "39:     $badge->delete_alignment($alignmentid);",
      "40: }",
      "41: redirect($return);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39:     require_sesskey();",
      "",
      "---------------"
    ],
    "badges/renderer.php||badges/renderer.php": [
      "File: badges/renderer.php -> badges/renderer.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1062:             );",
      "1063:             if (!$currentbadge->is_active() && !$currentbadge->is_locked()) {",
      "1064:                 $delete = $this->output->action_icon(",
      "1072:                 $edit = $this->output->action_icon(",
      "1073:                     new moodle_url('alignment.php',",
      "1074:                         array(",
      "",
      "[Removed Lines]",
      "1065:                     new moodle_url('alignment_action.php',",
      "1066:                         array(",
      "1067:                             'id' => $currentbadge->id,",
      "1068:                             'alignmentid' => $item->id,",
      "1069:                             'action' => 'remove'",
      "1070:                         )",
      "1071:                     ), new pix_icon('t/delete', get_string('delete')));",
      "",
      "[Added Lines]",
      "1065:                     new moodle_url('/badges/alignment_action.php', [",
      "1066:                         'id' => $currentbadge->id,",
      "1067:                         'alignmentid' => $item->id,",
      "1068:                         'sesskey' => sesskey(),",
      "1069:                         'action' => 'remove'",
      "1070:                     ]),",
      "1071:                     new pix_icon('t/delete', get_string('delete'))",
      "1072:                 );",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "46e45e7a649c5a042a1e4ef96b9aa6936ce78aaf",
      "candidate_info": {
        "commit_hash": "46e45e7a649c5a042a1e4ef96b9aa6936ce78aaf",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/46e45e7a649c5a042a1e4ef96b9aa6936ce78aaf",
        "files": [
          "badges/alignment_action.php",
          "badges/renderer.php"
        ],
        "message": "MDL-72367 badges: require sesskey to remove badge alignment.",
        "before_after_code_files": [
          "badges/alignment_action.php||badges/alignment_action.php",
          "badges/renderer.php||badges/renderer.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ],
          "candidate": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/alignment_action.php||badges/alignment_action.php": [
          "File: badges/alignment_action.php -> badges/alignment_action.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: require_once(__DIR__ . '/../config.php');",
          "26: require_once($CFG->libdir . '/badgeslib.php');",
          "29: $badgeid = required_param('id', PARAM_INT); // Badge ID.",
          "32: require_login();",
          "33: $return = new moodle_url('/badges/alignment.php', array('id' => $badgeid));",
          "",
          "[Removed Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Related badge ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Remove.",
          "",
          "[Added Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Alignment ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Action to perform.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "36: require_capability('moodle/badges:configuredetails', $context);",
          "38: if ($action == 'remove') {",
          "39:     $badge->delete_alignment($alignmentid);",
          "40: }",
          "41: redirect($return);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:     require_sesskey();",
          "",
          "---------------"
        ],
        "badges/renderer.php||badges/renderer.php": [
          "File: badges/renderer.php -> badges/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1337:             );",
          "1338:             if (!$currentbadge->is_active() && !$currentbadge->is_locked()) {",
          "1339:                 $delete = $this->output->action_icon(",
          "1347:                 $edit = $this->output->action_icon(",
          "1348:                     new moodle_url('alignment.php',",
          "1349:                         array(",
          "",
          "[Removed Lines]",
          "1340:                     new moodle_url('alignment_action.php',",
          "1341:                         array(",
          "1342:                             'id' => $currentbadge->id,",
          "1343:                             'alignmentid' => $item->id,",
          "1344:                             'action' => 'remove'",
          "1345:                         )",
          "1346:                     ), new pix_icon('t/delete', get_string('delete')));",
          "",
          "[Added Lines]",
          "1340:                     new moodle_url('/badges/alignment_action.php', [",
          "1341:                         'id' => $currentbadge->id,",
          "1342:                         'alignmentid' => $item->id,",
          "1343:                         'sesskey' => sesskey(),",
          "1344:                         'action' => 'remove'",
          "1345:                     ]),",
          "1346:                     new pix_icon('t/delete', get_string('delete'))",
          "1347:                 );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eda7d884baf5e8f41677ffa87c8d92555eae72bf",
      "candidate_info": {
        "commit_hash": "eda7d884baf5e8f41677ffa87c8d92555eae72bf",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/eda7d884baf5e8f41677ffa87c8d92555eae72bf",
        "files": [
          "badges/alignment_action.php",
          "badges/renderer.php"
        ],
        "message": "MDL-72367 badges: require sesskey to remove badge alignment.",
        "before_after_code_files": [
          "badges/alignment_action.php||badges/alignment_action.php",
          "badges/renderer.php||badges/renderer.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ],
          "candidate": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/alignment_action.php||badges/alignment_action.php": [
          "File: badges/alignment_action.php -> badges/alignment_action.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: require_once(__DIR__ . '/../config.php');",
          "26: require_once($CFG->libdir . '/badgeslib.php');",
          "29: $badgeid = required_param('id', PARAM_INT); // Badge ID.",
          "32: require_login();",
          "33: $return = new moodle_url('/badges/alignment.php', array('id' => $badgeid));",
          "",
          "[Removed Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Related badge ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Remove.",
          "",
          "[Added Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Alignment ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Action to perform.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "36: require_capability('moodle/badges:configuredetails', $context);",
          "38: if ($action == 'remove') {",
          "39:     $badge->delete_alignment($alignmentid);",
          "40: }",
          "41: redirect($return);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:     require_sesskey();",
          "",
          "---------------"
        ],
        "badges/renderer.php||badges/renderer.php": [
          "File: badges/renderer.php -> badges/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1339:             );",
          "1340:             if (!$currentbadge->is_active() && !$currentbadge->is_locked()) {",
          "1341:                 $delete = $this->output->action_icon(",
          "1349:                 $edit = $this->output->action_icon(",
          "1350:                     new moodle_url('alignment.php',",
          "1351:                         array(",
          "",
          "[Removed Lines]",
          "1342:                     new moodle_url('alignment_action.php',",
          "1343:                         array(",
          "1344:                             'id' => $currentbadge->id,",
          "1345:                             'alignmentid' => $item->id,",
          "1346:                             'action' => 'remove'",
          "1347:                         )",
          "1348:                     ), new pix_icon('t/delete', get_string('delete')));",
          "",
          "[Added Lines]",
          "1342:                     new moodle_url('/badges/alignment_action.php', [",
          "1343:                         'id' => $currentbadge->id,",
          "1344:                         'alignmentid' => $item->id,",
          "1345:                         'sesskey' => sesskey(),",
          "1346:                         'action' => 'remove'",
          "1347:                     ]),",
          "1348:                     new pix_icon('t/delete', get_string('delete'))",
          "1349:                 );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f91f38f54e8c697e653e136e3e8fca36accc5e8",
      "candidate_info": {
        "commit_hash": "3f91f38f54e8c697e653e136e3e8fca36accc5e8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/3f91f38f54e8c697e653e136e3e8fca36accc5e8",
        "files": [
          "badges/alignment_action.php",
          "badges/renderer.php"
        ],
        "message": "MDL-72367 badges: require sesskey to remove badge alignment.",
        "before_after_code_files": [
          "badges/alignment_action.php||badges/alignment_action.php",
          "badges/renderer.php||badges/renderer.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ],
          "candidate": [
            "badges/alignment_action.php||badges/alignment_action.php",
            "badges/renderer.php||badges/renderer.php"
          ]
        }
      },
      "candidate_diff": {
        "badges/alignment_action.php||badges/alignment_action.php": [
          "File: badges/alignment_action.php -> badges/alignment_action.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: require_once(__DIR__ . '/../config.php');",
          "26: require_once($CFG->libdir . '/badgeslib.php');",
          "29: $badgeid = required_param('id', PARAM_INT); // Badge ID.",
          "32: require_login();",
          "33: $return = new moodle_url('/badges/alignment.php', array('id' => $badgeid));",
          "",
          "[Removed Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Related badge ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Remove.",
          "",
          "[Added Lines]",
          "28: $alignmentid = required_param('alignmentid', PARAM_INT); // Alignment ID.",
          "30: $action = optional_param('action', 'remove', PARAM_TEXT); // Action to perform.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "36: require_capability('moodle/badges:configuredetails', $context);",
          "38: if ($action == 'remove') {",
          "39:     $badge->delete_alignment($alignmentid);",
          "40: }",
          "41: redirect($return);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:     require_sesskey();",
          "",
          "---------------"
        ],
        "badges/renderer.php||badges/renderer.php": [
          "File: badges/renderer.php -> badges/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1338:             );",
          "1339:             if (!$currentbadge->is_active() && !$currentbadge->is_locked()) {",
          "1340:                 $delete = $this->output->action_icon(",
          "1348:                 $edit = $this->output->action_icon(",
          "1349:                     new moodle_url('alignment.php',",
          "1350:                         array(",
          "",
          "[Removed Lines]",
          "1341:                     new moodle_url('alignment_action.php',",
          "1342:                         array(",
          "1343:                             'id' => $currentbadge->id,",
          "1344:                             'alignmentid' => $item->id,",
          "1345:                             'action' => 'remove'",
          "1346:                         )",
          "1347:                     ), new pix_icon('t/delete', get_string('delete')));",
          "",
          "[Added Lines]",
          "1341:                     new moodle_url('/badges/alignment_action.php', [",
          "1342:                         'id' => $currentbadge->id,",
          "1343:                         'alignmentid' => $item->id,",
          "1344:                         'sesskey' => sesskey(),",
          "1345:                         'action' => 'remove'",
          "1346:                     ]),",
          "1347:                     new pix_icon('t/delete', get_string('delete'))",
          "1348:                 );",
          "",
          "---------------"
        ]
      }
    }
  ]
}