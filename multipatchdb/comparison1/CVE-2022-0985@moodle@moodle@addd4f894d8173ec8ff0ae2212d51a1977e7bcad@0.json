{
  "cve_id": "CVE-2022-0985",
  "cve_desc": "Insufficient capability checks could allow users with the moodle/site:uploadusers capability to delete users, without having the necessary moodle/user:delete capability.",
  "repo": "moodle/moodle",
  "patch_hash": "addd4f894d8173ec8ff0ae2212d51a1977e7bcad",
  "patch_info": {
    "commit_hash": "addd4f894d8173ec8ff0ae2212d51a1977e7bcad",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/addd4f894d8173ec8ff0ae2212d51a1977e7bcad",
    "files": [
      "admin/tool/uploaduser/classes/process.php",
      "admin/tool/uploaduser/user_form.php"
    ],
    "message": "MDL-72972 tool_uploaduser: observe capability to delete users.",
    "before_after_code_files": [
      "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
      "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
    ]
  },
  "patch_diff": {
    "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php": [
      "File: admin/tool/uploaduser/classes/process.php -> admin/tool/uploaduser/classes/process.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: defined('MOODLE_INTERNAL') || die();",
      "29: use tool_uploaduser\\local\\field_value_validators;",
      "31: require_once($CFG->dirroot.'/user/profile/lib.php');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29: use context_system;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "552:         if (!empty($user->deleted)) {",
      "554:                 $this->usersskipped++;",
      "555:                 $this->upt->track('status', get_string('usernotdeletedoff', 'error'), 'warning');",
      "556:                 return;",
      "",
      "[Removed Lines]",
      "553:             if (!$this->get_allow_deletes() or $remoteuser) {",
      "",
      "[Added Lines]",
      "554:             if (!$this->get_allow_deletes() or $remoteuser or",
      "555:                     !has_capability('moodle/user:delete', context_system::instance())) {",
      "",
      "---------------"
    ],
    "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
      "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "148:         $mform->addElement('selectyesno', 'uuallowdeletes', get_string('allowdeletes', 'tool_uploaduser'));",
      "149:         $mform->setDefault('uuallowdeletes', 0);",
      "150:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDNEW);",
      "151:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDINC);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "151:         if (!has_capability('moodle/user:delete', context_system::instance())) {",
      "152:             $mform->hardFreeze('uuallowdeletes');",
      "153:             $mform->setConstant('uuallowdeletes', 0);",
      "154:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "861b56413f6c733a475d6e49f6dade927a689509",
      "candidate_info": {
        "commit_hash": "861b56413f6c733a475d6e49f6dade927a689509",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/861b56413f6c733a475d6e49f6dade927a689509",
        "files": [
          "admin/tool/uploaduser/index.php",
          "admin/tool/uploaduser/user_form.php"
        ],
        "message": "MDL-72972 tool_uploaduser: observe capability to delete users.",
        "before_after_code_files": [
          "admin/tool/uploaduser/index.php||admin/tool/uploaduser/index.php",
          "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ],
          "candidate": [
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/uploaduser/index.php||admin/tool/uploaduser/index.php": [
          "File: admin/tool/uploaduser/index.php -> admin/tool/uploaduser/index.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "410:         if (!empty($user->deleted)) {",
          "412:                 $usersskipped++;",
          "413:                 $upt->track('status', $strusernotdeletedoff, 'warning');",
          "414:                 continue;",
          "",
          "[Removed Lines]",
          "411:             if (!$allowdeletes or $remoteuser) {",
          "",
          "[Added Lines]",
          "411:             if (!$allowdeletes or $remoteuser or !has_capability('moodle/user:delete', context_system::instance())) {",
          "",
          "---------------"
        ],
        "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
          "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "136:         $mform->addElement('selectyesno', 'uuallowdeletes', get_string('allowdeletes', 'tool_uploaduser'));",
          "137:         $mform->setDefault('uuallowdeletes', 0);",
          "138:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDNEW);",
          "139:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDINC);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "139:         if (!has_capability('moodle/user:delete', context_system::instance())) {",
          "140:             $mform->hardFreeze('uuallowdeletes');",
          "141:             $mform->setConstant('uuallowdeletes', 0);",
          "142:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4a625b5b78a176abe8ee5a8d6edc40ca4b2c0d8e",
      "candidate_info": {
        "commit_hash": "4a625b5b78a176abe8ee5a8d6edc40ca4b2c0d8e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4a625b5b78a176abe8ee5a8d6edc40ca4b2c0d8e",
        "files": [
          "admin/tool/uploaduser/classes/process.php",
          "admin/tool/uploaduser/user_form.php"
        ],
        "message": "MDL-72972 tool_uploaduser: observe capability to delete users.",
        "before_after_code_files": [
          "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
          "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ],
          "candidate": [
            "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php": [
          "File: admin/tool/uploaduser/classes/process.php -> admin/tool/uploaduser/classes/process.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use tool_uploaduser\\local\\field_value_validators;",
          "31: require_once($CFG->dirroot.'/user/profile/lib.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: use context_system;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "556:         if (!empty($user->deleted)) {",
          "558:                 $this->usersskipped++;",
          "559:                 $this->upt->track('status', get_string('usernotdeletedoff', 'error'), 'warning');",
          "560:                 return;",
          "",
          "[Removed Lines]",
          "557:             if (!$this->get_allow_deletes() or $remoteuser) {",
          "",
          "[Added Lines]",
          "558:             if (!$this->get_allow_deletes() or $remoteuser or",
          "559:                     !has_capability('moodle/user:delete', context_system::instance())) {",
          "",
          "---------------"
        ],
        "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
          "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "148:         $mform->addElement('selectyesno', 'uuallowdeletes', get_string('allowdeletes', 'tool_uploaduser'));",
          "149:         $mform->setDefault('uuallowdeletes', 0);",
          "150:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDNEW);",
          "151:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDINC);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "151:         if (!has_capability('moodle/user:delete', context_system::instance())) {",
          "152:             $mform->hardFreeze('uuallowdeletes');",
          "153:             $mform->setConstant('uuallowdeletes', 0);",
          "154:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c653a49fe3549e2e767a807f85ce4125ed803245",
      "candidate_info": {
        "commit_hash": "c653a49fe3549e2e767a807f85ce4125ed803245",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/c653a49fe3549e2e767a807f85ce4125ed803245",
        "files": [
          "admin/tool/uploaduser/classes/process.php",
          "admin/tool/uploaduser/user_form.php"
        ],
        "message": "MDL-72972 tool_uploaduser: observe capability to delete users.",
        "before_after_code_files": [
          "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
          "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ],
          "candidate": [
            "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php",
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/uploaduser/classes/process.php||admin/tool/uploaduser/classes/process.php": [
          "File: admin/tool/uploaduser/classes/process.php -> admin/tool/uploaduser/classes/process.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die();",
          "29: use tool_uploaduser\\local\\field_value_validators;",
          "31: require_once($CFG->dirroot.'/user/profile/lib.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: use context_system;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "552:         if (!empty($user->deleted)) {",
          "554:                 $this->usersskipped++;",
          "555:                 $this->upt->track('status', get_string('usernotdeletedoff', 'error'), 'warning');",
          "556:                 return;",
          "",
          "[Removed Lines]",
          "553:             if (!$this->get_allow_deletes() or $remoteuser) {",
          "",
          "[Added Lines]",
          "554:             if (!$this->get_allow_deletes() or $remoteuser or",
          "555:                     !has_capability('moodle/user:delete', context_system::instance())) {",
          "",
          "---------------"
        ],
        "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
          "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "148:         $mform->addElement('selectyesno', 'uuallowdeletes', get_string('allowdeletes', 'tool_uploaduser'));",
          "149:         $mform->setDefault('uuallowdeletes', 0);",
          "150:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDNEW);",
          "151:         $mform->hideIf('uuallowdeletes', 'uutype', 'eq', UU_USER_ADDINC);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "151:         if (!has_capability('moodle/user:delete', context_system::instance())) {",
          "152:             $mform->hardFreeze('uuallowdeletes');",
          "153:             $mform->setConstant('uuallowdeletes', 0);",
          "154:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}