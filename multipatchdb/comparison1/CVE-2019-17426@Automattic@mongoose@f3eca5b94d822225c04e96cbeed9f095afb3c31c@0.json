{
  "cve_id": "CVE-2019-17426",
  "cve_desc": "Automattic Mongoose through 5.7.4 allows attackers to bypass access control (in some applications) because any query object with a _bsontype attribute is ignored. For example, adding \"_bsontype\":\"a\" can sometimes interfere with a query filter. NOTE: this CVE is about Mongoose's failure to work around this _bsontype special case that exists in older versions of the bson parser (aka the mongodb/js-bson project).",
  "repo": "Automattic/mongoose",
  "patch_hash": "f3eca5b94d822225c04e96cbeed9f095afb3c31c",
  "patch_info": {
    "commit_hash": "f3eca5b94d822225c04e96cbeed9f095afb3c31c",
    "repo": "Automattic/mongoose",
    "commit_url": "https://github.com/Automattic/mongoose/commit/f3eca5b94d822225c04e96cbeed9f095afb3c31c",
    "files": [
      "lib/cast.js"
    ],
    "message": "fix(query): delete top-level `_bsontype` property in queries to prevent silent empty queries\n\nFix #8222",
    "before_after_code_files": [
      "lib/cast.js||lib/cast.js"
    ]
  },
  "patch_diff": {
    "lib/cast.js||lib/cast.js": [
      "File: lib/cast.js -> lib/cast.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "27:     throw new Error('Query filter must be an object, got an array ', util.inspect(obj));",
      "28:   }",
      "30:   const paths = Object.keys(obj);",
      "31:   let i = paths.length;",
      "32:   let _keys;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "32:   if (obj.hasOwnProperty('_bsontype')) {",
      "33:     delete obj._bsontype;",
      "34:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cc10e0dc441f469330c1af2822d171fcd6fa8f89",
      "candidate_info": {
        "commit_hash": "cc10e0dc441f469330c1af2822d171fcd6fa8f89",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/cc10e0dc441f469330c1af2822d171fcd6fa8f89",
        "files": [
          "test/query.test.js"
        ],
        "message": "test(query): repro #8222",
        "before_after_code_files": [
          "test/query.test.js||test/query.test.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/query.test.js||test/query.test.js": [
          "File: test/query.test.js -> test/query.test.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "3550:       });",
          "3551:     });",
          "3552:   });",
          "3553: });",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3554:   it('query with top-level _bsontype (gh-8222)', function() {",
          "3555:     const userSchema = Schema({ token: String });",
          "3556:     const User = db.model('gh8222', userSchema);",
          "3558:     return User.create({ token: 'rightToken' }).",
          "3559:       then(() => User.findOne({ token: 'wrongToken', _bsontype: 'a' })).",
          "3560:       then(doc => assert.ok(!doc));",
          "3561:   });",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b03faf5ceec529c13b17684b8bf250b2b451b060",
      "candidate_info": {
        "commit_hash": "b03faf5ceec529c13b17684b8bf250b2b451b060",
        "repo": "Automattic/mongoose",
        "commit_url": "https://github.com/Automattic/mongoose/commit/b03faf5ceec529c13b17684b8bf250b2b451b060",
        "files": [
          "lib/cast.js"
        ],
        "message": "fix(query): allow findOne(objectid) and find(objectid)\n\nFix #8268",
        "before_after_code_files": [
          "lib/cast.js||lib/cast.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/cast.js||lib/cast.js"
          ],
          "candidate": [
            "lib/cast.js||lib/cast.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/cast.js||lib/cast.js": [
          "File: lib/cast.js -> lib/cast.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "28:   }",
          "33:     delete obj._bsontype;",
          "34:   }",
          "",
          "[Removed Lines]",
          "32:   if (obj.hasOwnProperty('_bsontype')) {",
          "",
          "[Added Lines]",
          "34:   if (obj.hasOwnProperty('_bsontype') && obj._bsontype !== 'ObjectID') {",
          "",
          "---------------"
        ]
      }
    }
  ]
}