{
  "cve_id": "CVE-2024-11079",
  "cve_desc": "A flaw was found in Ansible-Core. This vulnerability allows attackers to bypass unsafe content protections using the hostvars object to reference and execute templated content. This issue can lead to arbitrary code execution if remote data or module outputs are improperly templated within playbooks.",
  "repo": "ansible/ansible",
  "patch_hash": "70e83e72b43e05e57eb42a6d52d01a4d9768f510",
  "patch_info": {
    "commit_hash": "70e83e72b43e05e57eb42a6d52d01a4d9768f510",
    "repo": "ansible/ansible",
    "commit_url": "https://github.com/ansible/ansible/commit/70e83e72b43e05e57eb42a6d52d01a4d9768f510",
    "files": [
      "changelogs/fragments/unsafe_hostvars_fix.yml",
      "lib/ansible/template/__init__.py",
      "lib/ansible/template/native_helpers.py",
      "lib/ansible/vars/hostvars.py",
      "test/integration/targets/template/cve-2024-11079.yml",
      "test/integration/targets/template/runme.sh"
    ],
    "message": "Fix CVE-2024-11079 hostvars unsafe context (#84339) (#84353)\n\nFix to preserve an unsafe variable when accessing through an\nintermediary variable from hostvars.\n\n(cherry picked from commit 2936b80dbbc7efb889934aeec80f6142c10266ce)",
    "before_after_code_files": [
      "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
      "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
      "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
      "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
    ]
  },
  "patch_diff": {
    "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py": [
      "File: lib/ansible/template/__init__.py -> lib/ansible/template/__init__.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "49: from ansible.module_utils.common.text.converters import to_native, to_text, to_bytes",
      "50: from ansible.module_utils.common.collections import is_sequence",
      "51: from ansible.plugins.loader import filter_loader, lookup_loader, test_loader",
      "53: from ansible.template.template import AnsibleJ2Template",
      "54: from ansible.template.vars import AnsibleJ2Vars",
      "55: from ansible.utils.display import Display",
      "",
      "[Removed Lines]",
      "52: from ansible.template.native_helpers import ansible_native_concat, ansible_eval_concat, ansible_concat",
      "",
      "[Added Lines]",
      "52: from ansible.template.native_helpers import AnsibleUndefined, ansible_native_concat, ansible_eval_concat, ansible_concat",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "329:     return _update_wrapper(wrapper, func)",
      "361: class AnsibleContext(Context):",
      "362:     '''",
      "363:     A custom context, which intercepts resolve_or_missing() calls and sets a flag",
      "",
      "[Removed Lines]",
      "332: class AnsibleUndefined(StrictUndefined):",
      "333:     '''",
      "334:     A custom Undefined class, which returns further Undefined objects on access,",
      "335:     rather than throwing an exception.",
      "336:     '''",
      "337:     def __getattr__(self, name):",
      "338:         if name == '__UNSAFE__':",
      "339:             # AnsibleUndefined should never be assumed to be unsafe",
      "340:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
      "341:             raise AttributeError(name)",
      "342:         # Return original Undefined object to preserve the first failure context",
      "343:         return self",
      "345:     def __getitem__(self, key):",
      "346:         # Return original Undefined object to preserve the first failure context",
      "347:         return self",
      "349:     def __repr__(self):",
      "350:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
      "351:             self._undefined_hint,",
      "352:             self._undefined_obj,",
      "353:             self._undefined_name",
      "354:         )",
      "356:     def __contains__(self, item):",
      "357:         # Return original Undefined object to preserve the first failure context",
      "358:         return self",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py": [
      "File: lib/ansible/template/native_helpers.py -> lib/ansible/template/native_helpers.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "9: import ast",
      "10: from itertools import islice, chain",
      "11: from types import GeneratorType",
      "13: from ansible.module_utils.common.text.converters import to_text",
      "14: from ansible.module_utils.six import string_types",
      "15: from ansible.parsing.yaml.objects import AnsibleVaultEncryptedUnicode",
      "16: from ansible.utils.native_jinja import NativeJinjaText",
      "19: _JSON_MAP = {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "10: from collections.abc import Mapping",
      "14: from ansible.module_utils.common.collections import is_sequence",
      "19: from ansible.utils.unsafe_proxy import wrap_var",
      "20: import ansible.module_utils.compat.typing as t",
      "22: from jinja2.runtime import StrictUndefined",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "30:         return ast.Constant(value=_JSON_MAP[node.id])",
      "33: def ansible_eval_concat(nodes):",
      "34:     \"\"\"Return a string of concatenated compiled nodes. Throw an undefined error",
      "35:     if any of the nodes is undefined.",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39: def _is_unsafe(value: t.Any) -> bool:",
      "40:     \"\"\"",
      "41:     Our helper function, which will also recursively check dict and",
      "42:     list entries due to the fact that they may be repr'd and contain",
      "43:     a key or value which contains jinja2 syntax and would otherwise",
      "44:     lose the AnsibleUnsafe value.",
      "45:     \"\"\"",
      "46:     to_check = [value]",
      "47:     seen = set()",
      "49:     while True:",
      "50:         if not to_check:",
      "51:             break",
      "53:         val = to_check.pop(0)",
      "54:         val_id = id(val)",
      "56:         if val_id in seen:",
      "57:             continue",
      "58:         seen.add(val_id)",
      "60:         if isinstance(val, AnsibleUndefined):",
      "61:             continue",
      "62:         if isinstance(val, Mapping):",
      "63:             to_check.extend(val.keys())",
      "64:             to_check.extend(val.values())",
      "65:         elif is_sequence(val):",
      "66:             to_check.extend(val)",
      "67:         elif getattr(val, '__UNSAFE__', False):",
      "68:             return True",
      "70:     return False",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "45:     if not head:",
      "46:         return ''",
      "48:     if len(head) == 1:",
      "49:         out = head[0]",
      "51:         if isinstance(out, NativeJinjaText):",
      "52:             return out",
      "54:         out = to_text(out)",
      "55:     else:",
      "56:         if isinstance(nodes, GeneratorType):",
      "57:             nodes = chain(head, nodes)",
      "60:     # if this looks like a dictionary, list or bool, convert it to such",
      "61:     if out.startswith(('{', '[')) or out in ('True', 'False'):",
      "",
      "[Removed Lines]",
      "58:         out = ''.join([to_text(v) for v in nodes])",
      "",
      "[Added Lines]",
      "88:     unsafe = False",
      "96:         unsafe = _is_unsafe(out)",
      "102:         out_values = []",
      "103:         for v in nodes:",
      "104:             if not unsafe and _is_unsafe(v):",
      "105:                 unsafe = True",
      "107:             out_values.append(to_text(v))",
      "109:         out = ''.join(out_values)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "70:         except (TypeError, ValueError, SyntaxError, MemoryError):",
      "71:             pass",
      "73:     return out",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "124:     if unsafe:",
      "125:         out = wrap_var(out)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "81:     Used in Templar.template() when jinja2_native=False and convert_data=False.",
      "82:     \"\"\"",
      "86: def ansible_native_concat(nodes):",
      "",
      "[Removed Lines]",
      "83:     return ''.join([to_text(v) for v in nodes])",
      "",
      "[Added Lines]",
      "137:     unsafe = False",
      "138:     values = []",
      "139:     for v in nodes:",
      "140:         if not unsafe and _is_unsafe(v):",
      "141:             unsafe = True",
      "143:         values.append(to_text(v))",
      "145:     out = ''.join(values)",
      "146:     if unsafe:",
      "147:         out = wrap_var(out)",
      "149:     return out",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "97:     if not head:",
      "98:         return None",
      "100:     if len(head) == 1:",
      "101:         out = head[0]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "166:     unsafe = False",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "117:         # short-circuit literal_eval for anything other than strings",
      "118:         if not isinstance(out, string_types):",
      "119:             return out",
      "120:     else:",
      "121:         if isinstance(nodes, GeneratorType):",
      "122:             nodes = chain(head, nodes)",
      "125:     try:",
      "126:         evaled = ast.literal_eval(",
      "",
      "[Removed Lines]",
      "123:         out = ''.join([to_text(v) for v in nodes])",
      "",
      "[Added Lines]",
      "189:         unsafe = _is_unsafe(out)",
      "195:         out_values = []",
      "196:         for v in nodes:",
      "197:             if not unsafe and _is_unsafe(v):",
      "198:                 unsafe = True",
      "200:             out_values.append(to_text(v))",
      "202:         out = ''.join(out_values)",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "130:             ast.parse(out, mode='eval')",
      "131:         )",
      "132:     except (TypeError, ValueError, SyntaxError, MemoryError):",
      "133:         return out",
      "135:     if isinstance(evaled, string_types):",
      "136:         quote = out[0]",
      "139:     return evaled",
      "",
      "[Removed Lines]",
      "137:         return f'{quote}{evaled}{quote}'",
      "",
      "[Added Lines]",
      "212:         if unsafe:",
      "213:             out = wrap_var(out)",
      "219:         evaled = f'{quote}{evaled}{quote}'",
      "221:     if unsafe:",
      "222:         evaled = wrap_var(evaled)",
      "227: class AnsibleUndefined(StrictUndefined):",
      "228:     \"\"\"",
      "229:     A custom Undefined class, which returns further Undefined objects on access,",
      "230:     rather than throwing an exception.",
      "231:     \"\"\"",
      "232:     def __getattr__(self, name):",
      "233:         if name == '__UNSAFE__':",
      "234:             # AnsibleUndefined should never be assumed to be unsafe",
      "235:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
      "236:             raise AttributeError(name)",
      "237:         # Return original Undefined object to preserve the first failure context",
      "238:         return self",
      "240:     def __getitem__(self, key):",
      "241:         # Return original Undefined object to preserve the first failure context",
      "242:         return self",
      "244:     def __repr__(self):",
      "245:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
      "246:             self._undefined_hint,",
      "247:             self._undefined_obj,",
      "248:             self._undefined_name",
      "249:         )",
      "251:     def __contains__(self, item):",
      "252:         # Return original Undefined object to preserve the first failure context",
      "253:         return self",
      "",
      "---------------"
    ],
    "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py": [
      "File: lib/ansible/vars/hostvars.py -> lib/ansible/vars/hostvars.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "94:         return self._find_host(host_name) is not None",
      "96:     def __iter__(self):",
      "100:     def __len__(self):",
      "103:     def __repr__(self):",
      "104:         out = {}",
      "",
      "[Removed Lines]",
      "97:         for host in self._inventory.hosts:",
      "98:             yield host",
      "101:         return len(self._inventory.hosts)",
      "",
      "[Added Lines]",
      "97:         # include implicit localhost only if it has variables set",
      "98:         yield from self._inventory.hosts | {'localhost': self._inventory.localhost} if self._inventory.localhost else {}",
      "101:         # include implicit localhost only if it has variables set",
      "102:         return len(self._inventory.hosts) + (1 if self._inventory.localhost else 0)",
      "",
      "---------------"
    ],
    "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh": [
      "File: test/integration/targets/template/runme.sh -> test/integration/targets/template/runme.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "41: # ensure unsafe is preserved, even with extra newlines",
      "42: ansible-playbook unsafe.yml -v \"$@\"",
      "44: # ensure Jinja2 overrides from a template are used",
      "45: ansible-playbook template_overrides.yml -v \"$@\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "44: # CVE 2024-11079",
      "45: ANSIBLE_JINJA2_NATIVE=true ansible-playbook cve-2024-11079.yml -v \"$@\"",
      "46: ANSIBLE_JINJA2_NATIVE=false ansible-playbook cve-2024-11079.yml -v \"$@\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2936b80dbbc7efb889934aeec80f6142c10266ce",
      "candidate_info": {
        "commit_hash": "2936b80dbbc7efb889934aeec80f6142c10266ce",
        "repo": "ansible/ansible",
        "commit_url": "https://github.com/ansible/ansible/commit/2936b80dbbc7efb889934aeec80f6142c10266ce",
        "files": [
          "changelogs/fragments/unsafe_hostvars_fix.yml",
          "lib/ansible/template/__init__.py",
          "lib/ansible/template/native_helpers.py",
          "lib/ansible/vars/hostvars.py",
          "test/integration/targets/template/cve-2024-11079.yml",
          "test/integration/targets/template/runme.sh"
        ],
        "message": "Fix CVE-2024-11079 hostvars unsafe context (#84339)\n\nFix to preserve an unsafe variable when accessing through an\nintermediary variable from hostvars.",
        "before_after_code_files": [
          "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
          "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
          "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
          "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
            "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
            "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
            "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
          ],
          "candidate": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
            "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
            "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
            "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
          ]
        }
      },
      "candidate_diff": {
        "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py": [
          "File: lib/ansible/template/__init__.py -> lib/ansible/template/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "48: from ansible.module_utils.common.text.converters import to_native, to_text, to_bytes",
          "49: from ansible.module_utils.common.collections import is_sequence",
          "50: from ansible.plugins.loader import filter_loader, lookup_loader, test_loader",
          "52: from ansible.template.template import AnsibleJ2Template",
          "53: from ansible.template.vars import AnsibleJ2Vars",
          "54: from ansible.utils.display import Display",
          "",
          "[Removed Lines]",
          "51: from ansible.template.native_helpers import ansible_native_concat, ansible_eval_concat, ansible_concat",
          "",
          "[Added Lines]",
          "51: from ansible.template.native_helpers import AnsibleUndefined, ansible_native_concat, ansible_eval_concat, ansible_concat",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "312:     return functools.update_wrapper(wrapper, func)",
          "344: class AnsibleContext(Context):",
          "345:     '''",
          "346:     A custom context, which intercepts resolve_or_missing() calls and sets a flag",
          "",
          "[Removed Lines]",
          "315: class AnsibleUndefined(StrictUndefined):",
          "316:     '''",
          "317:     A custom Undefined class, which returns further Undefined objects on access,",
          "318:     rather than throwing an exception.",
          "319:     '''",
          "320:     def __getattr__(self, name):",
          "321:         if name == '__UNSAFE__':",
          "322:             # AnsibleUndefined should never be assumed to be unsafe",
          "323:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
          "324:             raise AttributeError(name)",
          "325:         # Return original Undefined object to preserve the first failure context",
          "326:         return self",
          "328:     def __getitem__(self, key):",
          "329:         # Return original Undefined object to preserve the first failure context",
          "330:         return self",
          "332:     def __repr__(self):",
          "333:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
          "334:             self._undefined_hint,",
          "335:             self._undefined_obj,",
          "336:             self._undefined_name",
          "337:         )",
          "339:     def __contains__(self, item):",
          "340:         # Return original Undefined object to preserve the first failure context",
          "341:         return self",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py": [
          "File: lib/ansible/template/native_helpers.py -> lib/ansible/template/native_helpers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: import ast",
          "8: from itertools import islice, chain",
          "9: from types import GeneratorType",
          "11: from ansible.module_utils.common.text.converters import to_text",
          "12: from ansible.module_utils.six import string_types",
          "13: from ansible.parsing.yaml.objects import AnsibleVaultEncryptedUnicode",
          "14: from ansible.utils.native_jinja import NativeJinjaText",
          "17: _JSON_MAP = {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: from collections.abc import Mapping",
          "12: from ansible.module_utils.common.collections import is_sequence",
          "17: from ansible.utils.unsafe_proxy import wrap_var",
          "18: import ansible.module_utils.compat.typing as t",
          "20: from jinja2.runtime import StrictUndefined",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28:         return ast.Constant(value=_JSON_MAP[node.id])",
          "31: def ansible_eval_concat(nodes):",
          "32:     \"\"\"Return a string of concatenated compiled nodes. Throw an undefined error",
          "33:     if any of the nodes is undefined.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: def _is_unsafe(value: t.Any) -> bool:",
          "38:     \"\"\"",
          "39:     Our helper function, which will also recursively check dict and",
          "40:     list entries due to the fact that they may be repr'd and contain",
          "41:     a key or value which contains jinja2 syntax and would otherwise",
          "42:     lose the AnsibleUnsafe value.",
          "43:     \"\"\"",
          "44:     to_check = [value]",
          "45:     seen = set()",
          "47:     while True:",
          "48:         if not to_check:",
          "49:             break",
          "51:         val = to_check.pop(0)",
          "52:         val_id = id(val)",
          "54:         if val_id in seen:",
          "55:             continue",
          "56:         seen.add(val_id)",
          "58:         if isinstance(val, AnsibleUndefined):",
          "59:             continue",
          "60:         if isinstance(val, Mapping):",
          "61:             to_check.extend(val.keys())",
          "62:             to_check.extend(val.values())",
          "63:         elif is_sequence(val):",
          "64:             to_check.extend(val)",
          "65:         elif getattr(val, '__UNSAFE__', False):",
          "66:             return True",
          "68:     return False",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "43:     if not head:",
          "44:         return ''",
          "46:     if len(head) == 1:",
          "47:         out = head[0]",
          "49:         if isinstance(out, NativeJinjaText):",
          "50:             return out",
          "52:         out = to_text(out)",
          "53:     else:",
          "54:         if isinstance(nodes, GeneratorType):",
          "55:             nodes = chain(head, nodes)",
          "58:     # if this looks like a dictionary, list or bool, convert it to such",
          "59:     if out.startswith(('{', '[')) or out in ('True', 'False'):",
          "",
          "[Removed Lines]",
          "56:         out = ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "86:     unsafe = False",
          "94:         unsafe = _is_unsafe(out)",
          "100:         out_values = []",
          "101:         for v in nodes:",
          "102:             if not unsafe and _is_unsafe(v):",
          "103:                 unsafe = True",
          "105:             out_values.append(to_text(v))",
          "107:         out = ''.join(out_values)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "68:         except (TypeError, ValueError, SyntaxError, MemoryError):",
          "69:             pass",
          "71:     return out",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "122:     if unsafe:",
          "123:         out = wrap_var(out)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "79:     Used in Templar.template() when jinja2_native=False and convert_data=False.",
          "80:     \"\"\"",
          "84: def ansible_native_concat(nodes):",
          "",
          "[Removed Lines]",
          "81:     return ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "135:     unsafe = False",
          "136:     values = []",
          "137:     for v in nodes:",
          "138:         if not unsafe and _is_unsafe(v):",
          "139:             unsafe = True",
          "141:         values.append(to_text(v))",
          "143:     out = ''.join(values)",
          "144:     if unsafe:",
          "145:         out = wrap_var(out)",
          "147:     return out",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "95:     if not head:",
          "96:         return None",
          "98:     if len(head) == 1:",
          "99:         out = head[0]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "164:     unsafe = False",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "115:         # short-circuit literal_eval for anything other than strings",
          "116:         if not isinstance(out, string_types):",
          "117:             return out",
          "118:     else:",
          "119:         if isinstance(nodes, GeneratorType):",
          "120:             nodes = chain(head, nodes)",
          "123:     try:",
          "124:         evaled = ast.literal_eval(",
          "",
          "[Removed Lines]",
          "121:         out = ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "187:         unsafe = _is_unsafe(out)",
          "193:         out_values = []",
          "194:         for v in nodes:",
          "195:             if not unsafe and _is_unsafe(v):",
          "196:                 unsafe = True",
          "198:             out_values.append(to_text(v))",
          "200:         out = ''.join(out_values)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "128:             ast.parse(out, mode='eval')",
          "129:         )",
          "130:     except (TypeError, ValueError, SyntaxError, MemoryError):",
          "131:         return out",
          "133:     if isinstance(evaled, string_types):",
          "134:         quote = out[0]",
          "137:     return evaled",
          "",
          "[Removed Lines]",
          "135:         return f'{quote}{evaled}{quote}'",
          "",
          "[Added Lines]",
          "210:         if unsafe:",
          "211:             out = wrap_var(out)",
          "217:         evaled = f'{quote}{evaled}{quote}'",
          "219:     if unsafe:",
          "220:         evaled = wrap_var(evaled)",
          "225: class AnsibleUndefined(StrictUndefined):",
          "226:     \"\"\"",
          "227:     A custom Undefined class, which returns further Undefined objects on access,",
          "228:     rather than throwing an exception.",
          "229:     \"\"\"",
          "230:     def __getattr__(self, name):",
          "231:         if name == '__UNSAFE__':",
          "232:             # AnsibleUndefined should never be assumed to be unsafe",
          "233:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
          "234:             raise AttributeError(name)",
          "235:         # Return original Undefined object to preserve the first failure context",
          "236:         return self",
          "238:     def __getitem__(self, key):",
          "239:         # Return original Undefined object to preserve the first failure context",
          "240:         return self",
          "242:     def __repr__(self):",
          "243:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
          "244:             self._undefined_hint,",
          "245:             self._undefined_obj,",
          "246:             self._undefined_name",
          "247:         )",
          "249:     def __contains__(self, item):",
          "250:         # Return original Undefined object to preserve the first failure context",
          "251:         return self",
          "",
          "---------------"
        ],
        "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py": [
          "File: lib/ansible/vars/hostvars.py -> lib/ansible/vars/hostvars.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:         return self._find_host(host_name) is not None",
          "94:     def __iter__(self):",
          "97:     def __len__(self):",
          "100:     def __repr__(self):",
          "101:         out = {}",
          "",
          "[Removed Lines]",
          "95:         yield from self._inventory.hosts",
          "98:         return len(self._inventory.hosts)",
          "",
          "[Added Lines]",
          "95:         # include implicit localhost only if it has variables set",
          "96:         yield from self._inventory.hosts | {'localhost': self._inventory.localhost} if self._inventory.localhost else {}",
          "99:         # include implicit localhost only if it has variables set",
          "100:         return len(self._inventory.hosts) + (1 if self._inventory.localhost else 0)",
          "",
          "---------------"
        ],
        "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh": [
          "File: test/integration/targets/template/runme.sh -> test/integration/targets/template/runme.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: # ensure unsafe is preserved, even with extra newlines",
          "42: ansible-playbook unsafe.yml -v \"$@\"",
          "44: # ensure Jinja2 overrides from a template are used",
          "45: ansible-playbook template_overrides.yml -v \"$@\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: # CVE 2024-11079",
          "45: ANSIBLE_JINJA2_NATIVE=true ansible-playbook cve-2024-11079.yml -v \"$@\"",
          "46: ANSIBLE_JINJA2_NATIVE=false ansible-playbook cve-2024-11079.yml -v \"$@\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "98774d15d7748ebaaaf2e83942cc7e8d39f7280e",
      "candidate_info": {
        "commit_hash": "98774d15d7748ebaaaf2e83942cc7e8d39f7280e",
        "repo": "ansible/ansible",
        "commit_url": "https://github.com/ansible/ansible/commit/98774d15d7748ebaaaf2e83942cc7e8d39f7280e",
        "files": [
          "changelogs/fragments/unsafe_hostvars_fix.yml",
          "lib/ansible/template/__init__.py",
          "lib/ansible/template/native_helpers.py",
          "lib/ansible/vars/hostvars.py",
          "test/integration/targets/template/cve-2024-11079.yml",
          "test/integration/targets/template/runme.sh"
        ],
        "message": "Fix CVE-2024-11079 hostvars unsafe context (#84339) (#84354)\n\nFix to preserve an unsafe variable when accessing through an\nintermediary variable from hostvars.\n\n(cherry picked from commit 2936b80dbbc7efb889934aeec80f6142c10266ce)",
        "before_after_code_files": [
          "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
          "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
          "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
          "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
            "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
            "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
            "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
          ],
          "candidate": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
            "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py",
            "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py",
            "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh"
          ]
        }
      },
      "candidate_diff": {
        "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py": [
          "File: lib/ansible/template/__init__.py -> lib/ansible/template/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "48: from ansible.module_utils.common.text.converters import to_native, to_text, to_bytes",
          "49: from ansible.module_utils.common.collections import is_sequence",
          "50: from ansible.plugins.loader import filter_loader, lookup_loader, test_loader",
          "52: from ansible.template.template import AnsibleJ2Template",
          "53: from ansible.template.vars import AnsibleJ2Vars",
          "54: from ansible.utils.display import Display",
          "",
          "[Removed Lines]",
          "51: from ansible.template.native_helpers import ansible_native_concat, ansible_eval_concat, ansible_concat",
          "",
          "[Added Lines]",
          "51: from ansible.template.native_helpers import AnsibleUndefined, ansible_native_concat, ansible_eval_concat, ansible_concat",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "312:     return functools.update_wrapper(wrapper, func)",
          "344: class AnsibleContext(Context):",
          "345:     '''",
          "346:     A custom context, which intercepts resolve_or_missing() calls and sets a flag",
          "",
          "[Removed Lines]",
          "315: class AnsibleUndefined(StrictUndefined):",
          "316:     '''",
          "317:     A custom Undefined class, which returns further Undefined objects on access,",
          "318:     rather than throwing an exception.",
          "319:     '''",
          "320:     def __getattr__(self, name):",
          "321:         if name == '__UNSAFE__':",
          "322:             # AnsibleUndefined should never be assumed to be unsafe",
          "323:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
          "324:             raise AttributeError(name)",
          "325:         # Return original Undefined object to preserve the first failure context",
          "326:         return self",
          "328:     def __getitem__(self, key):",
          "329:         # Return original Undefined object to preserve the first failure context",
          "330:         return self",
          "332:     def __repr__(self):",
          "333:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
          "334:             self._undefined_hint,",
          "335:             self._undefined_obj,",
          "336:             self._undefined_name",
          "337:         )",
          "339:     def __contains__(self, item):",
          "340:         # Return original Undefined object to preserve the first failure context",
          "341:         return self",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/ansible/template/native_helpers.py||lib/ansible/template/native_helpers.py": [
          "File: lib/ansible/template/native_helpers.py -> lib/ansible/template/native_helpers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: import ast",
          "8: from itertools import islice, chain",
          "9: from types import GeneratorType",
          "11: from ansible.module_utils.common.text.converters import to_text",
          "12: from ansible.module_utils.six import string_types",
          "13: from ansible.parsing.yaml.objects import AnsibleVaultEncryptedUnicode",
          "14: from ansible.utils.native_jinja import NativeJinjaText",
          "17: _JSON_MAP = {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: from collections.abc import Mapping",
          "12: from ansible.module_utils.common.collections import is_sequence",
          "17: from ansible.utils.unsafe_proxy import wrap_var",
          "18: import ansible.module_utils.compat.typing as t",
          "20: from jinja2.runtime import StrictUndefined",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28:         return ast.Constant(value=_JSON_MAP[node.id])",
          "31: def ansible_eval_concat(nodes):",
          "32:     \"\"\"Return a string of concatenated compiled nodes. Throw an undefined error",
          "33:     if any of the nodes is undefined.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: def _is_unsafe(value: t.Any) -> bool:",
          "38:     \"\"\"",
          "39:     Our helper function, which will also recursively check dict and",
          "40:     list entries due to the fact that they may be repr'd and contain",
          "41:     a key or value which contains jinja2 syntax and would otherwise",
          "42:     lose the AnsibleUnsafe value.",
          "43:     \"\"\"",
          "44:     to_check = [value]",
          "45:     seen = set()",
          "47:     while True:",
          "48:         if not to_check:",
          "49:             break",
          "51:         val = to_check.pop(0)",
          "52:         val_id = id(val)",
          "54:         if val_id in seen:",
          "55:             continue",
          "56:         seen.add(val_id)",
          "58:         if isinstance(val, AnsibleUndefined):",
          "59:             continue",
          "60:         if isinstance(val, Mapping):",
          "61:             to_check.extend(val.keys())",
          "62:             to_check.extend(val.values())",
          "63:         elif is_sequence(val):",
          "64:             to_check.extend(val)",
          "65:         elif getattr(val, '__UNSAFE__', False):",
          "66:             return True",
          "68:     return False",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "43:     if not head:",
          "44:         return ''",
          "46:     if len(head) == 1:",
          "47:         out = head[0]",
          "49:         if isinstance(out, NativeJinjaText):",
          "50:             return out",
          "52:         out = to_text(out)",
          "53:     else:",
          "54:         if isinstance(nodes, GeneratorType):",
          "55:             nodes = chain(head, nodes)",
          "58:     # if this looks like a dictionary, list or bool, convert it to such",
          "59:     if out.startswith(('{', '[')) or out in ('True', 'False'):",
          "",
          "[Removed Lines]",
          "56:         out = ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "86:     unsafe = False",
          "94:         unsafe = _is_unsafe(out)",
          "100:         out_values = []",
          "101:         for v in nodes:",
          "102:             if not unsafe and _is_unsafe(v):",
          "103:                 unsafe = True",
          "105:             out_values.append(to_text(v))",
          "107:         out = ''.join(out_values)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "68:         except (TypeError, ValueError, SyntaxError, MemoryError):",
          "69:             pass",
          "71:     return out",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "122:     if unsafe:",
          "123:         out = wrap_var(out)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "79:     Used in Templar.template() when jinja2_native=False and convert_data=False.",
          "80:     \"\"\"",
          "84: def ansible_native_concat(nodes):",
          "",
          "[Removed Lines]",
          "81:     return ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "135:     unsafe = False",
          "136:     values = []",
          "137:     for v in nodes:",
          "138:         if not unsafe and _is_unsafe(v):",
          "139:             unsafe = True",
          "141:         values.append(to_text(v))",
          "143:     out = ''.join(values)",
          "144:     if unsafe:",
          "145:         out = wrap_var(out)",
          "147:     return out",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "95:     if not head:",
          "96:         return None",
          "98:     if len(head) == 1:",
          "99:         out = head[0]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "164:     unsafe = False",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "115:         # short-circuit literal_eval for anything other than strings",
          "116:         if not isinstance(out, string_types):",
          "117:             return out",
          "118:     else:",
          "119:         if isinstance(nodes, GeneratorType):",
          "120:             nodes = chain(head, nodes)",
          "123:     try:",
          "124:         evaled = ast.literal_eval(",
          "",
          "[Removed Lines]",
          "121:         out = ''.join([to_text(v) for v in nodes])",
          "",
          "[Added Lines]",
          "187:         unsafe = _is_unsafe(out)",
          "193:         out_values = []",
          "194:         for v in nodes:",
          "195:             if not unsafe and _is_unsafe(v):",
          "196:                 unsafe = True",
          "198:             out_values.append(to_text(v))",
          "200:         out = ''.join(out_values)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "128:             ast.parse(out, mode='eval')",
          "129:         )",
          "130:     except (TypeError, ValueError, SyntaxError, MemoryError):",
          "131:         return out",
          "133:     if isinstance(evaled, string_types):",
          "134:         quote = out[0]",
          "137:     return evaled",
          "",
          "[Removed Lines]",
          "135:         return f'{quote}{evaled}{quote}'",
          "",
          "[Added Lines]",
          "210:         if unsafe:",
          "211:             out = wrap_var(out)",
          "217:         evaled = f'{quote}{evaled}{quote}'",
          "219:     if unsafe:",
          "220:         evaled = wrap_var(evaled)",
          "225: class AnsibleUndefined(StrictUndefined):",
          "226:     \"\"\"",
          "227:     A custom Undefined class, which returns further Undefined objects on access,",
          "228:     rather than throwing an exception.",
          "229:     \"\"\"",
          "230:     def __getattr__(self, name):",
          "231:         if name == '__UNSAFE__':",
          "232:             # AnsibleUndefined should never be assumed to be unsafe",
          "233:             # This prevents ``hasattr(val, '__UNSAFE__')`` from evaluating to ``True``",
          "234:             raise AttributeError(name)",
          "235:         # Return original Undefined object to preserve the first failure context",
          "236:         return self",
          "238:     def __getitem__(self, key):",
          "239:         # Return original Undefined object to preserve the first failure context",
          "240:         return self",
          "242:     def __repr__(self):",
          "243:         return 'AnsibleUndefined(hint={0!r}, obj={1!r}, name={2!r})'.format(",
          "244:             self._undefined_hint,",
          "245:             self._undefined_obj,",
          "246:             self._undefined_name",
          "247:         )",
          "249:     def __contains__(self, item):",
          "250:         # Return original Undefined object to preserve the first failure context",
          "251:         return self",
          "",
          "---------------"
        ],
        "lib/ansible/vars/hostvars.py||lib/ansible/vars/hostvars.py": [
          "File: lib/ansible/vars/hostvars.py -> lib/ansible/vars/hostvars.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:         return self._find_host(host_name) is not None",
          "94:     def __iter__(self):",
          "97:     def __len__(self):",
          "100:     def __repr__(self):",
          "101:         out = {}",
          "",
          "[Removed Lines]",
          "95:         yield from self._inventory.hosts",
          "98:         return len(self._inventory.hosts)",
          "",
          "[Added Lines]",
          "95:         # include implicit localhost only if it has variables set",
          "96:         yield from self._inventory.hosts | {'localhost': self._inventory.localhost} if self._inventory.localhost else {}",
          "99:         # include implicit localhost only if it has variables set",
          "100:         return len(self._inventory.hosts) + (1 if self._inventory.localhost else 0)",
          "",
          "---------------"
        ],
        "test/integration/targets/template/runme.sh||test/integration/targets/template/runme.sh": [
          "File: test/integration/targets/template/runme.sh -> test/integration/targets/template/runme.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: # ensure unsafe is preserved, even with extra newlines",
          "42: ansible-playbook unsafe.yml -v \"$@\"",
          "44: # ensure Jinja2 overrides from a template are used",
          "45: ansible-playbook template_overrides.yml -v \"$@\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: # CVE 2024-11079",
          "45: ANSIBLE_JINJA2_NATIVE=true ansible-playbook cve-2024-11079.yml -v \"$@\"",
          "46: ANSIBLE_JINJA2_NATIVE=false ansible-playbook cve-2024-11079.yml -v \"$@\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "270b39f6ff02511a2199505161218cbd1a5ae34f",
      "candidate_info": {
        "commit_hash": "270b39f6ff02511a2199505161218cbd1a5ae34f",
        "repo": "ansible/ansible",
        "commit_url": "https://github.com/ansible/ansible/commit/270b39f6ff02511a2199505161218cbd1a5ae34f",
        "files": [
          "changelogs/fragments/cve-2023-5764.yml",
          "lib/ansible/module_utils/common/json.py",
          "lib/ansible/parsing/yaml/dumper.py",
          "lib/ansible/playbook/conditional.py",
          "lib/ansible/playbook/task.py",
          "lib/ansible/plugins/action/assert.py",
          "lib/ansible/plugins/callback/__init__.py",
          "lib/ansible/plugins/filter/core.py",
          "lib/ansible/plugins/lookup/first_found.py",
          "lib/ansible/template/__init__.py",
          "lib/ansible/utils/unsafe_proxy.py",
          "test/integration/targets/ansible-galaxy-collection-scm/tasks/scm_dependency_deduplication.yml",
          "test/integration/targets/ansible-vault/roles/test_vault_embedded/tasks/main.yml",
          "test/integration/targets/ansible-vault/roles/test_vault_file_encrypted_embedded/tasks/main.yml",
          "test/integration/targets/apt_repository/tasks/apt.yml",
          "test/integration/targets/assert/assert.out.nested_tmpl.stderr",
          "test/integration/targets/assert/assert.out.nested_tmpl.stdout",
          "test/integration/targets/assert/assert.out.quiet.stderr",
          "test/integration/targets/assert/assert.out.quiet.stdout",
          "test/integration/targets/assert/nested_tmpl.yml",
          "test/integration/targets/assert/quiet.yml",
          "test/integration/targets/assert/runme.sh",
          "test/integration/targets/command_shell/tasks/main.yml",
          "test/integration/targets/copy/tasks/tests.yml",
          "test/integration/targets/debug/runme.sh",
          "test/integration/targets/debug/unsafe.yml",
          "test/integration/targets/expect/tasks/main.yml",
          "test/integration/targets/file/tasks/main.yml",
          "test/integration/targets/file/tasks/state_link.yml",
          "test/integration/targets/find/tasks/main.yml",
          "test/integration/targets/find/tasks/mode.yml",
          "test/integration/targets/gathering_facts/test_gathering_facts.yml",
          "test/integration/targets/git/tasks/depth.yml",
          "test/integration/targets/git/tasks/localmods.yml",
          "test/integration/targets/git/tasks/submodules.yml",
          "test/integration/targets/incidental_vyos_config/tests/cli/check_config.yaml",
          "test/integration/targets/incidental_vyos_lldp_interfaces/tests/cli/deleted.yaml",
          "test/integration/targets/incidental_vyos_lldp_interfaces/tests/cli/merged.yaml",
          "test/integration/targets/incidental_vyos_lldp_interfaces/tests/cli/overridden.yaml",
          "test/integration/targets/incidental_vyos_lldp_interfaces/tests/cli/replaced.yaml",
          "test/integration/targets/include_vars/tasks/main.yml",
          "test/integration/targets/lookup_first_found/tasks/main.yml",
          "test/integration/targets/lookup_ini/test_lookup_properties.yml",
          "test/integration/targets/lookup_subelements/tasks/main.yml",
          "test/integration/targets/loop_control/inner.yml",
          "test/integration/targets/module_precedence/modules_test_multiple_roles.yml",
          "test/integration/targets/module_precedence/modules_test_multiple_roles_reverse_order.yml",
          "test/integration/targets/module_precedence/multiple_roles/bar/tasks/main.yml",
          "test/integration/targets/module_precedence/multiple_roles/foo/tasks/main.yml",
          "test/integration/targets/script/tasks/main.yml",
          "test/integration/targets/slurp/tasks/main.yml",
          "test/integration/targets/template/tasks/main.yml",
          "test/integration/targets/unarchive/tasks/test_missing_binaries.yml",
          "test/integration/targets/unarchive/tasks/test_mode.yml",
          "test/integration/targets/unarchive/tasks/test_unprivileged_user.yml",
          "test/integration/targets/unarchive/tasks/test_zip.yml",
          "test/integration/targets/wait_for/tasks/main.yml",
          "test/units/parsing/yaml/test_dumper.py"
        ],
        "message": "Ensure that unsafe is more difficult to lose [stable-2.16] (#82293)\n\n* Ensure that unsafe is more difficult to lose\n\n* Add Task.untemplated_args, and switch assert over to use it\n* Don't use re in first_found, switch to using native string methods\n* If nested templating results in unsafe, just error, don't continue\n\n* ci_complete",
        "before_after_code_files": [
          "lib/ansible/module_utils/common/json.py||lib/ansible/module_utils/common/json.py",
          "lib/ansible/parsing/yaml/dumper.py||lib/ansible/parsing/yaml/dumper.py",
          "lib/ansible/playbook/conditional.py||lib/ansible/playbook/conditional.py",
          "lib/ansible/playbook/task.py||lib/ansible/playbook/task.py",
          "lib/ansible/plugins/action/assert.py||lib/ansible/plugins/action/assert.py",
          "lib/ansible/plugins/callback/__init__.py||lib/ansible/plugins/callback/__init__.py",
          "lib/ansible/plugins/filter/core.py||lib/ansible/plugins/filter/core.py",
          "lib/ansible/plugins/lookup/first_found.py||lib/ansible/plugins/lookup/first_found.py",
          "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py",
          "lib/ansible/utils/unsafe_proxy.py||lib/ansible/utils/unsafe_proxy.py",
          "test/integration/targets/assert/assert.out.nested_tmpl.stderr||test/integration/targets/assert/assert.out.nested_tmpl.stderr",
          "test/integration/targets/assert/assert.out.nested_tmpl.stdout||test/integration/targets/assert/assert.out.nested_tmpl.stdout",
          "test/integration/targets/assert/runme.sh||test/integration/targets/assert/runme.sh",
          "test/integration/targets/debug/runme.sh||test/integration/targets/debug/runme.sh",
          "test/units/parsing/yaml/test_dumper.py||test/units/parsing/yaml/test_dumper.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py"
          ],
          "candidate": [
            "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py"
          ]
        }
      },
      "candidate_diff": {
        "lib/ansible/module_utils/common/json.py||lib/ansible/module_utils/common/json.py": [
          "File: lib/ansible/module_utils/common/json.py -> lib/ansible/module_utils/common/json.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:     Used in ``AnsibleJSONEncoder.iterencode``",
          "31:     \"\"\"",
          "32:     if _is_unsafe(value):",
          "34:     elif is_sequence(value):",
          "35:         value = [_preprocess_unsafe_encode(v) for v in value]",
          "36:     elif isinstance(value, Mapping):",
          "",
          "[Removed Lines]",
          "33:         value = {'__ansible_unsafe': to_text(value, errors='surrogate_or_strict', nonstring='strict')}",
          "",
          "[Added Lines]",
          "33:         value = {'__ansible_unsafe': to_text(value._strip_unsafe(), errors='surrogate_or_strict', nonstring='strict')}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "63:                 value = {'__ansible_vault': to_text(o._ciphertext, errors='surrogate_or_strict', nonstring='strict')}",
          "64:         elif getattr(o, '__UNSAFE__', False):",
          "65:             # unsafe object, this will never be triggered, see ``AnsibleJSONEncoder.iterencode``",
          "67:         elif isinstance(o, Mapping):",
          "68:             # hostvars and other objects",
          "69:             value = dict(o)",
          "",
          "[Removed Lines]",
          "66:             value = {'__ansible_unsafe': to_text(o, errors='surrogate_or_strict', nonstring='strict')}",
          "",
          "[Added Lines]",
          "66:             value = {'__ansible_unsafe': to_text(o._strip_unsafe(), errors='surrogate_or_strict', nonstring='strict')}",
          "",
          "---------------"
        ],
        "lib/ansible/parsing/yaml/dumper.py||lib/ansible/parsing/yaml/dumper.py": [
          "File: lib/ansible/parsing/yaml/dumper.py -> lib/ansible/parsing/yaml/dumper.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: from ansible.module_utils.six import text_type, binary_type",
          "25: from ansible.module_utils.common.yaml import SafeDumper",
          "26: from ansible.parsing.yaml.objects import AnsibleUnicode, AnsibleSequence, AnsibleMapping, AnsibleVaultEncryptedUnicode",
          "28: from ansible.template import AnsibleUndefined",
          "29: from ansible.vars.hostvars import HostVars, HostVarsVars",
          "30: from ansible.vars.manager import VarsWithSources",
          "",
          "[Removed Lines]",
          "27: from ansible.utils.unsafe_proxy import AnsibleUnsafeText, AnsibleUnsafeBytes, NativeJinjaUnsafeText, NativeJinjaText",
          "",
          "[Added Lines]",
          "27: from ansible.utils.unsafe_proxy import AnsibleUnsafeText, AnsibleUnsafeBytes, NativeJinjaUnsafeText, NativeJinjaText, _is_unsafe",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49: def represent_unicode(self, data):",
          "50:     return yaml.representer.SafeRepresenter.represent_str(self, text_type(data))",
          "53: def represent_binary(self, data):",
          "54:     return yaml.representer.SafeRepresenter.represent_binary(self, binary_type(data))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "50:     if _is_unsafe(data):",
          "51:         data = data._strip_unsafe()",
          "56:     if _is_unsafe(data):",
          "57:         data = data._strip_unsafe()",
          "",
          "---------------"
        ],
        "lib/ansible/playbook/conditional.py||lib/ansible/playbook/conditional.py": [
          "File: lib/ansible/playbook/conditional.py -> lib/ansible/playbook/conditional.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import typing as t",
          "25: from ansible.module_utils.common.text.converters import to_native",
          "26: from ansible.playbook.attribute import FieldAttribute",
          "27: from ansible.template import Templar",
          "",
          "[Removed Lines]",
          "24: from ansible.errors import AnsibleError, AnsibleUndefinedVariable",
          "",
          "[Added Lines]",
          "24: from ansible.errors import AnsibleError, AnsibleUndefinedVariable, AnsibleTemplateError",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "102:                     return False",
          "104:             # If the result of the first-pass template render (to resolve inline templates) is marked unsafe,",
          "109:             # NOTE The spaces around True and False are intentional to short-circuit literal_eval for",
          "110:             #      jinja2_native=False and avoid its expensive calls.",
          "111:             return templar.template(",
          "112:                 \"{%% if %s %%} True {%% else %%} False {%% endif %%}\" % conditional,",
          "114:         except AnsibleUndefinedVariable as e:",
          "115:             raise AnsibleUndefinedVariable(\"error while evaluating conditional (%s): %s\" % (original, e))",
          "",
          "[Removed Lines]",
          "105:             # explicitly disable lookups on the final pass to prevent evaluation of untrusted content in the",
          "106:             # constructed template.",
          "107:             disable_lookups = hasattr(conditional, '__UNSAFE__')",
          "113:                 disable_lookups=disable_lookups).strip() == \"True\"",
          "",
          "[Added Lines]",
          "105:             # explicitly fail since the next templating operation would never evaluate",
          "106:             if hasattr(conditional, '__UNSAFE__'):",
          "107:                 raise AnsibleTemplateError('Conditional is marked as unsafe, and cannot be evaluated.')",
          "113:             ).strip() == \"True\"",
          "",
          "---------------"
        ],
        "lib/ansible/playbook/task.py||lib/ansible/playbook/task.py": [
          "File: lib/ansible/playbook/task.py -> lib/ansible/playbook/task.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "290:         super(Task, self).post_validate(templar)",
          "292:     def _post_validate_loop(self, attr, value, templar):",
          "293:         '''",
          "294:         Override post validation for the loop field, which is templated",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "292:     def _post_validate_args(self, attr, value, templar):",
          "293:         # smuggle an untemplated copy of the task args for actions that need more control over the templating of their",
          "294:         # input (eg, debug's var/msg, assert's \"that\" conditional expressions)",
          "295:         self.untemplated_args = value",
          "297:         # now recursively template the args dict",
          "298:         args = templar.template(value)",
          "300:         # FIXME: could we just nuke this entirely and/or wrap it up in ModuleArgsParser or something?",
          "301:         if '_variable_params' in args:",
          "302:             variable_params = args.pop('_variable_params')",
          "303:             if isinstance(variable_params, dict):",
          "304:                 if C.INJECT_FACTS_AS_VARS:",
          "305:                     display.warning(\"Using a variable for a task's 'args' is unsafe in some situations \"",
          "306:                                     \"(see https://docs.ansible.com/ansible/devel/reference_appendices/faq.html#argsplat-unsafe)\")",
          "307:                 variable_params.update(args)",
          "308:                 args = variable_params",
          "309:             else:",
          "310:                 # if we didn't get a dict, it means there's garbage remaining after k=v parsing, just give up",
          "311:                 # see https://github.com/ansible/ansible/issues/79862",
          "312:                 raise AnsibleError(f\"invalid or malformed argument: '{variable_params}'\")",
          "314:         return args",
          "",
          "---------------"
        ],
        "lib/ansible/plugins/action/assert.py||lib/ansible/plugins/action/assert.py": [
          "File: lib/ansible/plugins/action/assert.py -> lib/ansible/plugins/action/assert.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:         quiet = boolean(self._task.args.get('quiet', False), strict=False)",
          "67:         # make sure the 'that' items are a list",
          "69:         if not isinstance(thats, list):",
          "70:             thats = [thats]",
          "",
          "[Removed Lines]",
          "68:         thats = self._task.args['that']",
          "",
          "[Added Lines]",
          "67:         # directly access 'that' via untemplated args from the task so we can intelligently trust embedded",
          "68:         # templates and preserve the original inputs/locations for better messaging on assert failures and",
          "69:         # errors.",
          "70:         # FIXME: even in devel, things like `that: item` don't always work properly (truthy string value",
          "71:         # is not really an embedded expression)",
          "72:         # we could fix that by doing direct var lookups on the inputs",
          "73:         # FIXME: some form of this code should probably be shared between debug, assert, and",
          "74:         # Task.post_validate, since they",
          "75:         # have a lot of overlapping needs",
          "76:         try:",
          "77:             thats = self._task.untemplated_args['that']",
          "78:         except KeyError:",
          "79:             # in the case of \"we got our entire args dict from a template\", we can just consult the",
          "80:             # post-templated dict (the damage has likely already been done for embedded templates anyway)",
          "81:             thats = self._task.args['that']",
          "83:         # FIXME: this is a case where we only want to resolve indirections, NOT recurse containers",
          "84:         # (and even then, the leaf-most expression being wrapped is at least suboptimal",
          "85:         # (since its expression will be \"eaten\").",
          "86:         if isinstance(thats, str):",
          "87:             thats = self._templar.template(thats)",
          "",
          "---------------"
        ],
        "lib/ansible/plugins/callback/__init__.py||lib/ansible/plugins/callback/__init__.py": [
          "File: lib/ansible/plugins/callback/__init__.py -> lib/ansible/plugins/callback/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "38: from ansible.plugins import AnsiblePlugin",
          "39: from ansible.utils.color import stringc",
          "40: from ansible.utils.display import Display",
          "42: from ansible.vars.clean import strip_internal_keys, module_response_deepcopy",
          "44: import yaml",
          "",
          "[Removed Lines]",
          "41: from ansible.utils.unsafe_proxy import AnsibleUnsafeText, NativeJinjaUnsafeText",
          "",
          "[Added Lines]",
          "41: from ansible.utils.unsafe_proxy import AnsibleUnsafeText, NativeJinjaUnsafeText, _is_unsafe",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "114: def _pretty_represent_str(self, data):",
          "115:     \"\"\"Uses block style for multi-line strings\"\"\"",
          "116:     data = text_type(data)",
          "117:     if _should_use_block(data):",
          "118:         style = '|'",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116:     if _is_unsafe(data):",
          "117:         data = data._strip_unsafe()",
          "",
          "---------------"
        ],
        "lib/ansible/plugins/filter/core.py||lib/ansible/plugins/filter/core.py": [
          "File: lib/ansible/plugins/filter/core.py -> lib/ansible/plugins/filter/core.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: from ansible.utils.encrypt import do_encrypt, PASSLIB_AVAILABLE",
          "38: from ansible.utils.hashing import md5s, checksum_s",
          "39: from ansible.utils.unicode import unicode_wrap",
          "40: from ansible.utils.vars import merge_hash",
          "42: display = Display()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: from ansible.utils.unsafe_proxy import _is_unsafe",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "215:         # The ``text_type`` call here strips any custom",
          "216:         # string wrapper class, so that CSafeLoader can",
          "217:         # read the data",
          "218:         return yaml_load(text_type(to_text(data, errors='surrogate_or_strict')))",
          "219:     return data",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "219:         if _is_unsafe(data):",
          "220:             data = data._strip_unsafe()",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "224:         # The ``text_type`` call here strips any custom",
          "225:         # string wrapper class, so that CSafeLoader can",
          "226:         # read the data",
          "227:         return yaml_load_all(text_type(to_text(data, errors='surrogate_or_strict')))",
          "228:     return data",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "230:         if _is_unsafe(data):",
          "231:             data = data._strip_unsafe()",
          "",
          "---------------"
        ],
        "lib/ansible/plugins/lookup/first_found.py||lib/ansible/plugins/lookup/first_found.py": [
          "File: lib/ansible/plugins/lookup/first_found.py -> lib/ansible/plugins/lookup/first_found.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "139:     elements: path",
          "140: \"\"\"",
          "141: import os",
          "144: from collections.abc import Mapping, Sequence",
          "",
          "[Removed Lines]",
          "142: import re",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "150: from ansible.plugins.lookup import LookupBase",
          "153: def _split_on(terms, spliters=','):",
          "154:     termlist = []",
          "155:     if isinstance(terms, string_types):",
          "157:     else:",
          "158:         # added since options will already listify",
          "159:         for t in terms:",
          "",
          "[Removed Lines]",
          "156:         termlist = re.split(r'[%s]' % ''.join(map(re.escape, spliters)), terms)",
          "",
          "[Added Lines]",
          "152: def _splitter(value, chars):",
          "153:     chars = set(chars)",
          "154:     v = ''",
          "155:     for c in value:",
          "156:         if c in chars:",
          "157:             yield v",
          "158:             v = ''",
          "159:             continue",
          "160:         v += c",
          "161:     yield v",
          "167:         termlist = list(_splitter(terms, spliters))",
          "",
          "---------------"
        ],
        "lib/ansible/template/__init__.py||lib/ansible/template/__init__.py": [
          "File: lib/ansible/template/__init__.py -> lib/ansible/template/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: from numbers import Number",
          "32: from traceback import format_exc",
          "35: from jinja2.loaders import FileSystemLoader",
          "36: from jinja2.nativetypes import NativeEnvironment",
          "37: from jinja2.runtime import Context, StrictUndefined",
          "",
          "[Removed Lines]",
          "34: from jinja2.exceptions import TemplateSyntaxError, UndefinedError",
          "",
          "[Added Lines]",
          "34: from jinja2.exceptions import TemplateSyntaxError, UndefinedError, SecurityError",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "55: from ansible.utils.display import Display",
          "56: from ansible.utils.listify import listify_lookup_plugin_terms",
          "57: from ansible.utils.native_jinja import NativeJinjaText",
          "60: display = Display()",
          "",
          "[Removed Lines]",
          "58: from ansible.utils.unsafe_proxy import to_unsafe_text, wrap_var",
          "",
          "[Added Lines]",
          "58: from ansible.utils.unsafe_proxy import to_unsafe_text, wrap_var, AnsibleUnsafeText, AnsibleUnsafeBytes, NativeJinjaUnsafeText",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "365:     flag is checked post-templating, and (when set) will result in the",
          "366:     final templated result being wrapped in AnsibleUnsafe.",
          "367:     '''",
          "368:     def __init__(self, *args, **kwargs):",
          "369:         super(AnsibleContext, self).__init__(*args, **kwargs)",
          "370:         self.unsafe = False",
          "372:     def _is_unsafe(self, val):",
          "373:         '''",
          "374:         Our helper function, which will also recursively check dict and",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "368:     _disallowed_callables = frozenset({",
          "369:         AnsibleUnsafeText._strip_unsafe.__qualname__,",
          "370:         AnsibleUnsafeBytes._strip_unsafe.__qualname__,",
          "371:         NativeJinjaUnsafeText._strip_unsafe.__qualname__,",
          "372:     })",
          "378:     def call(self, obj, *args, **kwargs):",
          "379:         if getattr(obj, '__qualname__', None) in self._disallowed_callables or obj in self._disallowed_callables:",
          "380:             raise SecurityError(f\"{obj!r} is not safely callable\")",
          "381:         return super().call(obj, *args, **kwargs)",
          "",
          "---------------"
        ],
        "lib/ansible/utils/unsafe_proxy.py||lib/ansible/utils/unsafe_proxy.py": [
          "File: lib/ansible/utils/unsafe_proxy.py -> lib/ansible/utils/unsafe_proxy.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "71: class AnsibleUnsafeBytes(binary_type, AnsibleUnsafe):",
          "77: class AnsibleUnsafeText(text_type, AnsibleUnsafe):",
          "83: class NativeJinjaUnsafeText(NativeJinjaText, AnsibleUnsafeText):",
          "",
          "[Removed Lines]",
          "72:     def decode(self, *args, **kwargs):",
          "73:         \"\"\"Wrapper method to ensure type conversions maintain unsafe context\"\"\"",
          "74:         return AnsibleUnsafeText(super(AnsibleUnsafeBytes, self).decode(*args, **kwargs))",
          "78:     def encode(self, *args, **kwargs):",
          "79:         \"\"\"Wrapper method to ensure type conversions maintain unsafe context\"\"\"",
          "80:         return AnsibleUnsafeBytes(super(AnsibleUnsafeText, self).encode(*args, **kwargs))",
          "",
          "[Added Lines]",
          "72:     def _strip_unsafe(self):",
          "73:         return super().__bytes__()",
          "75:     def __str__(self, /):  # pylint: disable=invalid-str-returned",
          "76:         return self.encode()",
          "78:     def __bytes__(self, /):  # pylint: disable=invalid-bytes-returned",
          "79:         return self",
          "81:     def __repr__(self, /):  # pylint: disable=invalid-repr-returned",
          "82:         return AnsibleUnsafeText(super().__repr__())",
          "84:     def __format__(self, format_spec, /):  # pylint: disable=invalid-format-returned",
          "85:         return self.__class__(super().__format__(format_spec))",
          "87:     def __getitem__(self, key, /):",
          "88:         return self.__class__(super().__getitem__(key))",
          "90:     def __iter__(self, /):",
          "91:         cls = self.__class__",
          "92:         return (cls(c) for c in super().__iter__())",
          "94:     def __reversed__(self, /):",
          "95:         return self[::-1]",
          "97:     def __add__(self, value, /):",
          "98:         return self.__class__(super().__add__(value))",
          "100:     def __radd__(self, value, /):",
          "101:         return self.__class__(value.__add__(self))",
          "103:     def __mul__(self, value, /):",
          "104:         return self.__class__(super().__mul__(value))",
          "106:     __rmul__ = __mul__",
          "108:     def __mod__(self, value, /):",
          "109:         return self.__class__(super().__mod__(value))",
          "111:     def __rmod__(self, value, /):",
          "112:         return self.__class__(super().__rmod__(value))",
          "114:     def capitalize(self, /):",
          "115:         return self.__class__(super().capitalize())",
          "117:     def casefold(self, /):",
          "118:         return self.__class__(super().casefold())",
          "120:     def center(self, width, fillchar=b' ', /):",
          "121:         return self.__class__(super().center(width, fillchar))",
          "123:     def decode(self, /, encoding='utf-8', errors='strict'):",
          "124:         return AnsibleUnsafeText(super().decode(encoding=encoding, errors=errors))",
          "126:     def removeprefix(self, prefix, /):",
          "127:         return self.__class__(super().removeprefix(prefix))",
          "129:     def removesuffix(self, suffix, /):",
          "130:         return self.__class__(super().removesuffix(suffix))",
          "132:     def expandtabs(self, /, tabsize=8):",
          "133:         return self.__class__(super().expandtabs(tabsize))",
          "135:     def format(self, /, *args, **kwargs):",
          "136:         return self.__class__(super().format(*args, **kwargs))",
          "138:     def format_map(self, mapping, /):",
          "139:         return self.__class__(super().format_map(mapping))",
          "141:     def join(self, iterable_of_bytes, /):",
          "142:         return self.__class__(super().join(iterable_of_bytes))",
          "144:     def ljust(self, width, fillchar=b' ', /):",
          "145:         return self.__class__(super().ljust(width, fillchar))",
          "147:     def lower(self, /):",
          "148:         return self.__class__(super().lower())",
          "150:     def lstrip(self, bytes=None, /):",
          "151:         return self.__class__(super().lstrip(bytes))",
          "153:     def partition(self, sep, /):",
          "154:         cls = self.__class__",
          "155:         return tuple(cls(e) for e in super().partition(sep))",
          "157:     def replace(self, old, new, count=-1, /):",
          "158:         return self.__class__(super().replace(old, new, count))",
          "160:     def rjust(self, width, fillchar=b' ', /):",
          "161:         return self.__class__(super().rjust(width, fillchar))",
          "163:     def rpartition(self, sep, /):",
          "164:         cls = self.__class__",
          "165:         return tuple(cls(e) for e in super().rpartition(sep))",
          "167:     def rstrip(self, bytes=None, /):",
          "168:         return self.__class__(super().rstrip(bytes))",
          "170:     def split(self, /, sep=None, maxsplit=-1):",
          "171:         cls = self.__class__",
          "172:         return [cls(e) for e in super().split(sep=sep, maxsplit=maxsplit)]",
          "174:     def rsplit(self, /, sep=None, maxsplit=-1):",
          "175:         cls = self.__class__",
          "176:         return [cls(e) for e in super().rsplit(sep=sep, maxsplit=maxsplit)]",
          "178:     def splitlines(self, /, keepends=False):",
          "179:         cls = self.__class__",
          "180:         return [cls(e) for e in super().splitlines(keepends=keepends)]",
          "182:     def strip(self, bytes=None, /):",
          "183:         return self.__class__(super().strip(bytes))",
          "185:     def swapcase(self, /):",
          "186:         return self.__class__(super().swapcase())",
          "188:     def title(self, /):",
          "189:         return self.__class__(super().title())",
          "191:     def translate(self, table, /, delete=b''):",
          "192:         return self.__class__(super().translate(table, delete=delete))",
          "194:     def upper(self, /):",
          "195:         return self.__class__(super().upper())",
          "197:     def zfill(self, width, /):",
          "198:         return self.__class__(super().zfill(width))",
          "202:     # def __getattribute__(self, name):",
          "203:     #     print(f'attr: {name}')",
          "204:     #     return object.__getattribute__(self, name)",
          "206:     def _strip_unsafe(self, /):",
          "207:         return super().__str__()",
          "209:     def __str__(self, /):  # pylint: disable=invalid-str-returned",
          "210:         return self",
          "212:     def __repr__(self, /):  # pylint: disable=invalid-repr-returned",
          "213:         return self.__class__(super().__repr__())",
          "215:     def __format__(self, format_spec, /):  # pylint: disable=invalid-format-returned",
          "216:         return self.__class__(super().__format__(format_spec))",
          "218:     def __getitem__(self, key, /):",
          "219:         return self.__class__(super().__getitem__(key))",
          "221:     def __iter__(self, /):",
          "222:         cls = self.__class__",
          "223:         return (cls(c) for c in super().__iter__())",
          "225:     def __reversed__(self, /):",
          "226:         return self[::-1]",
          "228:     def __add__(self, value, /):",
          "229:         return self.__class__(super().__add__(value))",
          "231:     def __radd__(self, value, /):",
          "232:         return self.__class__(value.__add__(self))",
          "234:     def __mul__(self, value, /):",
          "235:         return self.__class__(super().__mul__(value))",
          "237:     __rmul__ = __mul__",
          "239:     def __mod__(self, value, /):",
          "240:         return self.__class__(super().__mod__(value))",
          "242:     def __rmod__(self, value, /):",
          "243:         return self.__class__(super().__rmod__(value))",
          "245:     def capitalize(self, /):",
          "246:         return self.__class__(super().capitalize())",
          "248:     def casefold(self, /):",
          "249:         return self.__class__(super().casefold())",
          "251:     def center(self, width, fillchar=' ', /):",
          "252:         return self.__class__(super().center(width, fillchar))",
          "254:     def encode(self, /, encoding='utf-8', errors='strict'):",
          "255:         return AnsibleUnsafeBytes(super().encode(encoding=encoding, errors=errors))",
          "257:     def removeprefix(self, prefix, /):",
          "258:         return self.__class__(super().removeprefix(prefix))",
          "260:     def removesuffix(self, suffix, /):",
          "261:         return self.__class__(super().removesuffix(suffix))",
          "263:     def expandtabs(self, /, tabsize=8):",
          "264:         return self.__class__(super().expandtabs(tabsize))",
          "266:     def format(self, /, *args, **kwargs):",
          "267:         return self.__class__(super().format(*args, **kwargs))",
          "269:     def format_map(self, mapping, /):",
          "270:         return self.__class__(super().format_map(mapping))",
          "272:     def join(self, iterable, /):",
          "273:         return self.__class__(super().join(iterable))",
          "275:     def ljust(self, width, fillchar=' ', /):",
          "276:         return self.__class__(super().ljust(width, fillchar))",
          "278:     def lower(self, /):",
          "279:         return self.__class__(super().lower())",
          "281:     def lstrip(self, chars=None, /):",
          "282:         return self.__class__(super().lstrip(chars))",
          "284:     def partition(self, sep, /):",
          "285:         cls = self.__class__",
          "286:         return tuple(cls(e) for e in super().partition(sep))",
          "288:     def replace(self, old, new, count=-1, /):",
          "289:         return self.__class__(super().replace(old, new, count))",
          "291:     def rjust(self, width, fillchar=' ', /):",
          "292:         return self.__class__(super().rjust(width, fillchar))",
          "294:     def rpartition(self, sep, /):",
          "295:         cls = self.__class__",
          "296:         return tuple(cls(e) for e in super().rpartition(sep))",
          "298:     def rstrip(self, chars=None, /):",
          "299:         return self.__class__(super().rstrip(chars))",
          "301:     def split(self, /, sep=None, maxsplit=-1):",
          "302:         cls = self.__class__",
          "303:         return [cls(e) for e in super().split(sep=sep, maxsplit=maxsplit)]",
          "305:     def rsplit(self, /, sep=None, maxsplit=-1):",
          "306:         cls = self.__class__",
          "307:         return [cls(e) for e in super().rsplit(sep=sep, maxsplit=maxsplit)]",
          "309:     def splitlines(self, /, keepends=False):",
          "310:         cls = self.__class__",
          "311:         return [cls(e) for e in super().splitlines(keepends=keepends)]",
          "313:     def strip(self, chars=None, /):",
          "314:         return self.__class__(super().strip(chars))",
          "316:     def swapcase(self, /):",
          "317:         return self.__class__(super().swapcase())",
          "319:     def title(self, /):",
          "320:         return self.__class__(super().title())",
          "322:     def translate(self, table, /):",
          "323:         return self.__class__(super().translate(table))",
          "325:     def upper(self, /):",
          "326:         return self.__class__(super().upper())",
          "328:     def zfill(self, width, /):",
          "329:         return self.__class__(super().zfill(width))",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "127: def to_unsafe_text(*args, **kwargs):",
          "128:     return wrap_var(to_text(*args, **kwargs))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "380: def _is_unsafe(obj):",
          "381:     return getattr(obj, '__UNSAFE__', False) is True",
          "",
          "---------------"
        ],
        "test/integration/targets/assert/assert.out.nested_tmpl.stderr||test/integration/targets/assert/assert.out.nested_tmpl.stderr": [
          "File: test/integration/targets/assert/assert.out.nested_tmpl.stderr -> test/integration/targets/assert/assert.out.nested_tmpl.stderr",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: + ansible-playbook -i localhost, -c local nested_tmpl.yml",
          "2: ++ set +x",
          "3: [WARNING]: conditional statements should not include jinja2 templating",
          "4: delimiters such as {{ }} or {% %}. Found: \"{{ foo }}\" == \"bar\"",
          "",
          "---------------"
        ],
        "test/integration/targets/assert/assert.out.nested_tmpl.stdout||test/integration/targets/assert/assert.out.nested_tmpl.stdout": [
          "File: test/integration/targets/assert/assert.out.nested_tmpl.stdout -> test/integration/targets/assert/assert.out.nested_tmpl.stdout",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: PLAY [localhost] ***************************************************************",
          "4: TASK [assert] ******************************************************************",
          "5: ok: [localhost] => {",
          "6:     \"changed\": false,",
          "7:     \"msg\": \"All assertions passed\"",
          "8: }",
          "10: PLAY RECAP *********************************************************************",
          "11: localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0",
          "",
          "---------------"
        ],
        "test/integration/targets/assert/runme.sh||test/integration/targets/assert/runme.sh": [
          "File: test/integration/targets/assert/runme.sh -> test/integration/targets/assert/runme.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "45:    fi",
          "46: }",
          "50: ORIGFILE=\"${BASEFILE}\"",
          "51: OUTFILE=\"${BASEFILE}.new\"",
          "",
          "[Removed Lines]",
          "48: BASEFILE=assert_quiet.out",
          "",
          "[Added Lines]",
          "48: BASEFILE=assert.out",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "69: export ANSIBLE_RETRY_FILES_ENABLED=0",
          "71: run_test quiet",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "72: run_test nested_tmpl",
          "",
          "---------------"
        ],
        "test/integration/targets/debug/runme.sh||test/integration/targets/debug/runme.sh": [
          "File: test/integration/targets/debug/runme.sh -> test/integration/targets/debug/runme.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: # ensure debug does not set top level vars when looking at ansible_facts",
          "20: ansible-playbook nosetfacts.yml \"$@\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: ansible-playbook unsafe.yml \"$@\"",
          "",
          "---------------"
        ],
        "test/units/parsing/yaml/test_dumper.py||test/units/parsing/yaml/test_dumper.py": [
          "File: test/units/parsing/yaml/test_dumper.py -> test/units/parsing/yaml/test_dumper.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: from ansible.parsing.yaml import dumper, objects",
          "28: from ansible.parsing.yaml.loader import AnsibleLoader",
          "29: from ansible.template import AnsibleUndefined",
          "32: from units.mock.yaml_helper import YamlTestUtils",
          "33: from units.mock.vault_helper import TextVaultSecret",
          "",
          "[Removed Lines]",
          "30: from ansible.utils.unsafe_proxy import AnsibleUnsafeText, AnsibleUnsafeBytes",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "68:     def test_bytes(self):",
          "69:         b_text = u'tr\u00e9ma'.encode('utf-8')",
          "73:         stream = self._build_stream(yaml_out)",
          "74:         loader = self._loader(stream)",
          "",
          "[Removed Lines]",
          "70:         unsafe_object = AnsibleUnsafeBytes(b_text)",
          "71:         yaml_out = self._dump_string(unsafe_object, dumper=self.dumper)",
          "",
          "[Added Lines]",
          "69:         yaml_out = self._dump_string(b_text, dumper=self.dumper)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "82:     def test_unicode(self):",
          "83:         u_text = u'n\u00f6el'",
          "87:         stream = self._build_stream(yaml_out)",
          "88:         loader = self._loader(stream)",
          "",
          "[Removed Lines]",
          "84:         unsafe_object = AnsibleUnsafeText(u_text)",
          "85:         yaml_out = self._dump_string(unsafe_object, dumper=self.dumper)",
          "",
          "[Added Lines]",
          "82:         yaml_out = self._dump_string(u_text, dumper=self.dumper)",
          "",
          "---------------"
        ]
      }
    }
  ]
}