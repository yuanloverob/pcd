{
  "cve_id": "CVE-2023-34049",
  "cve_desc": "The Salt-SSH pre-flight option copies the script to the target at a predictable path, which allows an attacker to force Salt-SSH to run their script. If an attacker has access to the target VM and knows the path to the pre-flight script before it runs they can ensure Salt-SSH runs their script with the privileges of the user running Salt-SSH.\u00a0Do not make the copy path on the target predictable and ensure we check return codes of the scp command if the copy fails.",
  "repo": "saltstack/salt",
  "patch_hash": "7a14112f2a16ce70e3c3e1862c92e37af5f2c7a4",
  "patch_info": {
    "commit_hash": "7a14112f2a16ce70e3c3e1862c92e37af5f2c7a4",
    "repo": "saltstack/salt",
    "commit_url": "https://github.com/saltstack/salt/commit/7a14112f2a16ce70e3c3e1862c92e37af5f2c7a4",
    "files": [
      "changelog/cve-2023-34049.security.md",
      "salt/client/ssh/__init__.py",
      "tests/pytests/unit/client/ssh/test_single.py",
      "tests/pytests/unit/client/ssh/test_ssh.py"
    ],
    "message": "Fix CVE-2023-34049",
    "before_after_code_files": [
      "salt/client/ssh/__init__.py||salt/client/ssh/__init__.py",
      "tests/pytests/unit/client/ssh/test_single.py||tests/pytests/unit/client/ssh/test_single.py",
      "tests/pytests/unit/client/ssh/test_ssh.py||tests/pytests/unit/client/ssh/test_ssh.py"
    ]
  },
  "patch_diff": {
    "salt/client/ssh/__init__.py||salt/client/ssh/__init__.py": [
      "File: salt/client/ssh/__init__.py -> salt/client/ssh/__init__.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "11: import logging",
      "12: import multiprocessing",
      "13: import os",
      "14: import queue",
      "15: import re",
      "16: import shlex",
      "17: import subprocess",
      "18: import sys",
      "19: import tarfile",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14: import pathlib",
      "18: import shutil",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "467:             if target.get(\"passwd\", False) or self.opts[\"ssh_passwd\"]:",
      "468:                 self._key_deploy_run(host, target, False)",
      "469:             return ret",
      "471:             target = self.targets[host]",
      "472:             # permission denied, attempt to auto deploy ssh key",
      "473:             print(",
      "",
      "[Removed Lines]",
      "470:         if ret[host].get(\"stderr\", \"\").count(\"Permission denied\"):",
      "",
      "[Added Lines]",
      "472:         stderr = ret[host].get(\"stderr\", \"\")",
      "473:         # -failed to upload file- is detecting scp errors",
      "474:         # Errors to ignore when Permission denied is in the stderr. For example",
      "475:         # scp can get a permission denied on the target host, but they where",
      "476:         # able to accurate authenticate against the box",
      "477:         ignore_err = [\"failed to upload file\"]",
      "478:         check_err = [x for x in ignore_err if stderr.count(x)]",
      "479:         if \"Permission denied\" in stderr and not check_err:",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1007:         \"\"\"",
      "1008:         Run our pre_flight script before running any ssh commands",
      "1009:         \"\"\"",
      "1016:     def check_thin_dir(self):",
      "1017:         \"\"\"",
      "",
      "[Removed Lines]",
      "1010:         script = os.path.join(tempfile.gettempdir(), self.ssh_pre_file)",
      "1012:         self.shell.send(self.ssh_pre_flight, script)",
      "1014:         return self.execute_script(script, script_args=self.ssh_pre_flight_args)",
      "",
      "[Added Lines]",
      "1019:         with tempfile.NamedTemporaryFile() as temp:",
      "1020:             # ensure we use copyfile to not copy the file attributes",
      "1021:             # we want to ensure we use the perms set by the secure",
      "1022:             # NamedTemporaryFile",
      "1023:             try:",
      "1024:                 shutil.copyfile(self.ssh_pre_flight, temp.name)",
      "1025:             except OSError as err:",
      "1026:                 return (",
      "1027:                     \"\",",
      "1028:                     f\"Could not copy pre flight script {self.ssh_pre_flight} to temporary path\",",
      "1029:                     1,",
      "1030:                 )",
      "1031:             target_script = f\".{pathlib.Path(temp.name).name}\"",
      "1032:             log.trace(f\"Copying the pre flight script {self.ssh_pre_file} to target\")",
      "1033:             stdout, stderr, retcode = self.shell.send(temp.name, target_script)",
      "1034:             if retcode != 0:",
      "1035:                 # We could not copy the script to the target",
      "1036:                 log.error(",
      "1037:                     f\"Could not copy the pre flight script {self.ssh_pre_file} to target\"",
      "1038:                 )",
      "1039:                 return stdout, stderr, retcode",
      "1041:             log.trace(f\"Executing the pre flight script {self.ssh_pre_file} on target\")",
      "1042:             return self.execute_script(",
      "1043:                 target_script, script_args=self.ssh_pre_flight_args",
      "1044:             )",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1388:             return self.shell.exec_cmd(cmd_str)",
      "1390:         # Write the shim to a temporary file in the default temp directory",
      "1394:             shim_tmp_file.write(salt.utils.stringutils.to_bytes(cmd_str))",
      "1396:         # Copy shim to target system, under $HOME/.<randomized name>",
      "1400:         if self.winrm:",
      "1401:             target_shim_file = saltwinshell.get_target_shim_file(self, target_shim_file)",
      "1404:         # Remove our shim file",
      "1405:         try:",
      "",
      "[Removed Lines]",
      "1391:         with tempfile.NamedTemporaryFile(",
      "1392:             mode=\"w+b\", prefix=\"shim_\", delete=False",
      "1393:         ) as shim_tmp_file:",
      "1397:         target_shim_file = \".{}.{}\".format(",
      "1398:             binascii.hexlify(os.urandom(6)).decode(\"ascii\"), extension",
      "1399:         )",
      "1402:         self.shell.send(shim_tmp_file.name, target_shim_file, makedirs=True)",
      "",
      "[Added Lines]",
      "1421:         with tempfile.NamedTemporaryFile(mode=\"w+b\", delete=False) as shim_tmp_file:",
      "1425:         target_shim_file = f\".{pathlib.Path(shim_tmp_file.name).name}\"",
      "1429:         stdout, stderr, retcode = self.shell.send(",
      "1430:             shim_tmp_file.name, target_shim_file, makedirs=True",
      "1431:         )",
      "1432:         if retcode != 0:",
      "1433:             log.error(f\"Could not copy the shim script to target\")",
      "1434:             return stdout, stderr, retcode",
      "",
      "---------------"
    ],
    "tests/pytests/unit/client/ssh/test_single.py||tests/pytests/unit/client/ssh/test_single.py": [
      "File: tests/pytests/unit/client/ssh/test_single.py -> tests/pytests/unit/client/ssh/test_single.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "2: import re",
      "4: from textwrap import dedent",
      "6: import pytest",
      "",
      "[Removed Lines]",
      "1: import os",
      "3: import tempfile",
      "",
      "[Added Lines]",
      "1: import logging",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "16: from salt.client import ssh",
      "17: from tests.support.mock import MagicMock, call, patch",
      "20: @pytest.fixture",
      "21: def opts(tmp_path):",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "18: log = logging.getLogger(__name__)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "242:         assert ret == cmd_ret",
      "245: def test_execute_script(opts, target, tmp_path):",
      "246:     \"\"\"",
      "247:     test Single.execute_script()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "246: def test_run_ssh_pre_flight(opts, target, tmp_path):",
      "247:     \"\"\"",
      "248:     test Single.run_ssh_pre_flight function",
      "249:     \"\"\"",
      "250:     target[\"ssh_pre_flight\"] = str(tmp_path / \"script.sh\")",
      "251:     single = ssh.Single(",
      "252:         opts,",
      "253:         opts[\"argv\"],",
      "254:         \"localhost\",",
      "255:         mods={},",
      "256:         fsclient=None,",
      "257:         thin=salt.utils.thin.thin_path(opts[\"cachedir\"]),",
      "258:         mine=False,",
      "260:     )",
      "262:     cmd_ret = (\"Success\", \"\", 0)",
      "263:     mock_flight = MagicMock(return_value=cmd_ret)",
      "264:     mock_cmd = MagicMock(return_value=cmd_ret)",
      "265:     patch_flight = patch(\"salt.client.ssh.Single.run_ssh_pre_flight\", mock_flight)",
      "266:     patch_cmd = patch(\"salt.client.ssh.Single.cmd_block\", mock_cmd)",
      "267:     patch_exec_cmd = patch(",
      "268:         \"salt.client.ssh.shell.Shell.exec_cmd\", return_value=(\"\", \"\", 1)",
      "269:     )",
      "270:     patch_os = patch(\"os.path.exists\", side_effect=[True])",
      "272:     with patch_os, patch_flight, patch_cmd, patch_exec_cmd:",
      "273:         ret = single.run()",
      "274:         mock_cmd.assert_called()",
      "275:         mock_flight.assert_called()",
      "276:         assert ret == cmd_ret",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "273:         ] == mock_cmd.call_args_list",
      "277:     \"\"\"",
      "278:     test Single.shim_cmd()",
      "279:     \"\"\"",
      "",
      "[Removed Lines]",
      "276: def test_shim_cmd(opts, target):",
      "",
      "[Added Lines]",
      "310: def test_shim_cmd(opts, target, tmp_path):",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "295:     patch_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_cmd)",
      "296:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", return_value=(\"\", \"\", 0))",
      "297:     patch_rand = patch(\"os.urandom\", return_value=b\"5\\xd9l\\xca\\xc2\\xff\")",
      "300:         ret = single.shim_cmd(cmd_str=\"echo test\")",
      "301:         assert ret == exp_ret",
      "302:         assert [",
      "305:         ] == mock_cmd.call_args_list",
      "309:     \"\"\"",
      "311:     \"\"\"",
      "313:     single = ssh.Single(",
      "314:         opts,",
      "315:         opts[\"argv\"],",
      "",
      "[Removed Lines]",
      "299:     with patch_cmd, patch_rand, patch_send:",
      "303:             call(\"/bin/sh '.35d96ccac2ff.py'\"),",
      "304:             call(\"rm '.35d96ccac2ff.py'\"),",
      "308: def test_run_ssh_pre_flight(opts, target, tmp_path):",
      "310:     test Single.run_ssh_pre_flight",
      "312:     target[\"ssh_pre_flight\"] = str(tmp_path / \"script.sh\")",
      "",
      "[Added Lines]",
      "332:     tmp_file = tmp_path / \"tmp_file\"",
      "333:     mock_tmp = MagicMock()",
      "334:     patch_tmp = patch(\"tempfile.NamedTemporaryFile\", mock_tmp)",
      "335:     mock_tmp.return_value.__enter__.return_value.name = tmp_file",
      "337:     with patch_cmd, patch_tmp, patch_send:",
      "341:             call(f\"/bin/sh '.{tmp_file.name}'\"),",
      "342:             call(f\"rm '.{tmp_file.name}'\"),",
      "346: def test_shim_cmd_copy_fails(opts, target, caplog):",
      "348:     test Single.shim_cmd() when copying the file fails",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "320:         mine=False,",
      "321:         winrm=False,",
      "322:         tty=True,",
      "324:     )",
      "328:     patch_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_cmd)",
      "332:     )",
      "335:         ret = single.run_ssh_pre_flight()",
      "343: @pytest.mark.skip_on_windows(reason=\"SSH_PY_SHIM not set on windows\")",
      "",
      "[Removed Lines]",
      "326:     exp_ret = (\"Success\", \"\", 0)",
      "327:     mock_cmd = MagicMock(return_value=exp_ret)",
      "329:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", return_value=exp_ret)",
      "330:     exp_tmp = os.path.join(",
      "331:         tempfile.gettempdir(), os.path.basename(target[\"ssh_pre_flight\"])",
      "334:     with patch_cmd, patch_send:",
      "336:         assert ret == exp_ret",
      "337:         assert [",
      "338:             call(\"/bin/sh '{}'\".format(exp_tmp)),",
      "339:             call(\"rm '{}'\".format(exp_tmp)),",
      "340:         ] == mock_cmd.call_args_list",
      "",
      "[Added Lines]",
      "363:     ret_cmd = (\"Success\", \"\", 0)",
      "364:     mock_cmd = MagicMock(return_value=ret_cmd)",
      "366:     ret_send = (\"\", \"General error in file copy\", 1)",
      "367:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", return_value=ret_send)",
      "368:     patch_rand = patch(\"os.urandom\", return_value=b\"5\\xd9l\\xca\\xc2\\xff\")",
      "370:     with patch_cmd, patch_rand, patch_send:",
      "371:         ret = single.shim_cmd(cmd_str=\"echo test\")",
      "372:         assert ret == ret_send",
      "373:         assert \"Could not copy the shim script to target\" in caplog.text",
      "374:         mock_cmd.assert_not_called()",
      "377: def test_run_ssh_pre_flight_no_connect(opts, target, tmp_path, caplog):",
      "378:     \"\"\"",
      "379:     test Single.run_ssh_pre_flight when you",
      "380:     cannot connect to the target",
      "381:     \"\"\"",
      "382:     pre_flight = tmp_path / \"script.sh\"",
      "383:     pre_flight.write_text(\"\")",
      "384:     target[\"ssh_pre_flight\"] = str(pre_flight)",
      "385:     single = ssh.Single(",
      "386:         opts,",
      "387:         opts[\"argv\"],",
      "388:         \"localhost\",",
      "389:         mods={},",
      "390:         fsclient=None,",
      "391:         thin=salt.utils.thin.thin_path(opts[\"cachedir\"]),",
      "392:         mine=False,",
      "393:         winrm=False,",
      "394:         tty=True,",
      "396:     )",
      "397:     mock_exec_cmd = MagicMock(return_value=(\"\", \"\", 1))",
      "398:     patch_exec_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_exec_cmd)",
      "399:     tmp_file = tmp_path / \"tmp_file\"",
      "400:     mock_tmp = MagicMock()",
      "401:     patch_tmp = patch(\"tempfile.NamedTemporaryFile\", mock_tmp)",
      "402:     mock_tmp.return_value.__enter__.return_value.name = tmp_file",
      "403:     ret_send = (",
      "404:         \"\",",
      "405:         \"ssh: connect to host 192.168.1.186 port 22: No route to host\\nscp: Connection closed\\n\",",
      "406:         255,",
      "407:     )",
      "408:     send_mock = MagicMock(return_value=ret_send)",
      "409:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", send_mock)",
      "411:     with caplog.at_level(logging.TRACE):",
      "412:         with patch_send, patch_exec_cmd, patch_tmp:",
      "413:             ret = single.run_ssh_pre_flight()",
      "414:     assert f\"Copying the pre flight script {pre_flight.name}\" in caplog.text",
      "415:     assert (",
      "416:         f\"Could not copy the pre flight script {pre_flight.name} to target\"",
      "417:         in caplog.text",
      "418:     )",
      "419:     assert ret == ret_send",
      "420:     assert send_mock.call_args_list[0][0][0] == tmp_file",
      "421:     target_script = send_mock.call_args_list[0][0][1]",
      "422:     assert re.search(r\".[a-z0-9]+\", target_script)",
      "423:     mock_exec_cmd.assert_not_called()",
      "426: def test_run_ssh_pre_flight_permission_denied(opts, target, tmp_path):",
      "427:     \"\"\"",
      "428:     test Single.run_ssh_pre_flight when you",
      "429:     cannot copy script to the target due to",
      "430:     a permission denied error",
      "431:     \"\"\"",
      "432:     pre_flight = tmp_path / \"script.sh\"",
      "433:     pre_flight.write_text(\"\")",
      "434:     target[\"ssh_pre_flight\"] = str(pre_flight)",
      "435:     single = ssh.Single(",
      "436:         opts,",
      "437:         opts[\"argv\"],",
      "438:         \"localhost\",",
      "439:         mods={},",
      "440:         fsclient=None,",
      "441:         thin=salt.utils.thin.thin_path(opts[\"cachedir\"]),",
      "442:         mine=False,",
      "443:         winrm=False,",
      "444:         tty=True,",
      "446:     )",
      "447:     mock_exec_cmd = MagicMock(return_value=(\"\", \"\", 1))",
      "448:     patch_exec_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_exec_cmd)",
      "449:     tmp_file = tmp_path / \"tmp_file\"",
      "450:     mock_tmp = MagicMock()",
      "451:     patch_tmp = patch(\"tempfile.NamedTemporaryFile\", mock_tmp)",
      "452:     mock_tmp.return_value.__enter__.return_value.name = tmp_file",
      "453:     ret_send = (",
      "454:         \"\",",
      "455:         'scp: dest open \"/tmp/preflight.sh\": Permission denied\\nscp: failed to upload file /etc/salt/preflight.sh to /tmp/preflight.sh\\n',",
      "456:         255,",
      "458:     send_mock = MagicMock(return_value=ret_send)",
      "459:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", send_mock)",
      "461:     with patch_send, patch_exec_cmd, patch_tmp:",
      "463:     assert ret == ret_send",
      "464:     assert send_mock.call_args_list[0][0][0] == tmp_file",
      "465:     target_script = send_mock.call_args_list[0][0][1]",
      "466:     assert re.search(r\".[a-z0-9]+\", target_script)",
      "467:     mock_exec_cmd.assert_not_called()",
      "470: def test_run_ssh_pre_flight_connect(opts, target, tmp_path, caplog):",
      "471:     \"\"\"",
      "472:     test Single.run_ssh_pre_flight when you",
      "473:     can connect to the target",
      "474:     \"\"\"",
      "475:     pre_flight = tmp_path / \"script.sh\"",
      "476:     pre_flight.write_text(\"\")",
      "477:     target[\"ssh_pre_flight\"] = str(pre_flight)",
      "478:     single = ssh.Single(",
      "479:         opts,",
      "480:         opts[\"argv\"],",
      "481:         \"localhost\",",
      "482:         mods={},",
      "483:         fsclient=None,",
      "484:         thin=salt.utils.thin.thin_path(opts[\"cachedir\"]),",
      "485:         mine=False,",
      "486:         winrm=False,",
      "487:         tty=True,",
      "489:     )",
      "490:     ret_exec_cmd = (\"\", \"\", 1)",
      "491:     mock_exec_cmd = MagicMock(return_value=ret_exec_cmd)",
      "492:     patch_exec_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_exec_cmd)",
      "493:     tmp_file = tmp_path / \"tmp_file\"",
      "494:     mock_tmp = MagicMock()",
      "495:     patch_tmp = patch(\"tempfile.NamedTemporaryFile\", mock_tmp)",
      "496:     mock_tmp.return_value.__enter__.return_value.name = tmp_file",
      "497:     ret_send = (",
      "498:         \"\",",
      "499:         \"\\rroot@192.168.1.187's password: \\n\\rpreflight.sh 0%    0 0.0KB/s   --:-- ETA\\rpreflight.sh 100%   20     2.7KB/s   00:00 \\n\",",
      "500:         0,",
      "501:     )",
      "502:     send_mock = MagicMock(return_value=ret_send)",
      "503:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", send_mock)",
      "505:     with caplog.at_level(logging.TRACE):",
      "506:         with patch_send, patch_exec_cmd, patch_tmp:",
      "507:             ret = single.run_ssh_pre_flight()",
      "509:     assert f\"Executing the pre flight script {pre_flight.name} on target\" in caplog.text",
      "510:     assert ret == ret_exec_cmd",
      "511:     assert send_mock.call_args_list[0][0][0] == tmp_file",
      "512:     target_script = send_mock.call_args_list[0][0][1]",
      "513:     assert re.search(r\".[a-z0-9]+\", target_script)",
      "514:     mock_exec_cmd.assert_called()",
      "517: def test_run_ssh_pre_flight_shutil_fails(opts, target, tmp_path):",
      "518:     \"\"\"",
      "519:     test Single.run_ssh_pre_flight when cannot",
      "520:     copyfile with shutil",
      "521:     \"\"\"",
      "522:     pre_flight = tmp_path / \"script.sh\"",
      "523:     pre_flight.write_text(\"\")",
      "524:     target[\"ssh_pre_flight\"] = str(pre_flight)",
      "525:     single = ssh.Single(",
      "526:         opts,",
      "527:         opts[\"argv\"],",
      "528:         \"localhost\",",
      "529:         mods={},",
      "530:         fsclient=None,",
      "531:         thin=salt.utils.thin.thin_path(opts[\"cachedir\"]),",
      "532:         mine=False,",
      "533:         winrm=False,",
      "534:         tty=True,",
      "536:     )",
      "537:     ret_exec_cmd = (\"\", \"\", 1)",
      "538:     mock_exec_cmd = MagicMock(return_value=ret_exec_cmd)",
      "539:     patch_exec_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_exec_cmd)",
      "540:     tmp_file = tmp_path / \"tmp_file\"",
      "541:     mock_tmp = MagicMock()",
      "542:     patch_tmp = patch(\"tempfile.NamedTemporaryFile\", mock_tmp)",
      "543:     mock_tmp.return_value.__enter__.return_value.name = tmp_file",
      "544:     send_mock = MagicMock()",
      "545:     mock_shutil = MagicMock(side_effect=IOError(\"Permission Denied\"))",
      "546:     patch_shutil = patch(\"shutil.copyfile\", mock_shutil)",
      "547:     patch_send = patch(\"salt.client.ssh.shell.Shell.send\", send_mock)",
      "549:     with patch_send, patch_exec_cmd, patch_tmp, patch_shutil:",
      "550:         ret = single.run_ssh_pre_flight()",
      "552:     assert ret == (",
      "553:         \"\",",
      "554:         f\"Could not copy pre flight script {pre_flight} to temporary path\",",
      "555:         1,",
      "556:     )",
      "557:     mock_exec_cmd.assert_not_called()",
      "558:     send_mock.assert_not_called()",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "434:     and script successfully runs",
      "435:     \"\"\"",
      "436:     opts[\"ssh_run_pre_flight\"] = True",
      "439:     if test_opts[0] is not None:",
      "440:         target[\"ssh_pre_flight_args\"] = test_opts[0]",
      "",
      "[Removed Lines]",
      "437:     target[\"ssh_pre_flight\"] = str(tmp_path / \"script.sh\")",
      "",
      "[Added Lines]",
      "655:     pre_flight_script = tmp_path / \"script.sh\"",
      "656:     pre_flight_script.write_text(\"\")",
      "657:     target[\"ssh_pre_flight\"] = str(pre_flight_script)",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "456:     mock_exec_cmd = MagicMock(return_value=(\"\", \"\", 0))",
      "457:     patch_cmd = patch(\"salt.client.ssh.Single.cmd_block\", mock_cmd)",
      "458:     patch_exec_cmd = patch(\"salt.client.ssh.shell.Shell.exec_cmd\", mock_exec_cmd)",
      "460:     patch_os = patch(\"os.path.exists\", side_effect=[True])",
      "462:     with patch_os, patch_cmd, patch_exec_cmd, patch_shell_send:",
      "469: @pytest.mark.slow_test",
      "",
      "[Removed Lines]",
      "459:     patch_shell_send = patch(\"salt.client.ssh.shell.Shell.send\", return_value=None)",
      "463:         ret = single.run()",
      "464:         assert mock_exec_cmd.mock_calls[0].args[",
      "465:             0",
      "466:         ] == \"/bin/sh '/tmp/script.sh'{}\".format(expected_args)",
      "",
      "[Added Lines]",
      "679:     patch_shell_send = patch(",
      "680:         \"salt.client.ssh.shell.Shell.send\", return_value=(\"\", \"\", 0)",
      "681:     )",
      "685:         single.run()",
      "686:         script_args = mock_exec_cmd.mock_calls[0].args[0]",
      "687:         assert re.search(r\"\\/bin\\/sh '.[a-z0-9]+\", script_args)",
      "",
      "---------------"
    ],
    "tests/pytests/unit/client/ssh/test_ssh.py||tests/pytests/unit/client/ssh/test_ssh.py": [
      "File: tests/pytests/unit/client/ssh/test_ssh.py -> tests/pytests/unit/client/ssh/test_ssh.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "339:     with patch(\"salt.roster.get_roster_file\", MagicMock(return_value=roster)):",
      "340:         ssh_obj = client._prep_ssh(**ssh_opts)",
      "341:         assert ssh_obj.opts.get(\"extra_filerefs\", None) == \"salt://foobar\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "344: def test_key_deploy_permission_denied_scp(tmp_path, opts):",
      "345:     \"\"\"",
      "346:     test \"key_deploy\" function when",
      "347:     permission denied authentication error",
      "348:     when attempting to use scp to copy file",
      "349:     to target",
      "350:     \"\"\"",
      "351:     host = \"localhost\"",
      "352:     passwd = \"password\"",
      "353:     usr = \"ssh-usr\"",
      "354:     opts[\"ssh_user\"] = usr",
      "355:     opts[\"tgt\"] = host",
      "357:     ssh_ret = {",
      "358:         host: {",
      "359:             \"stdout\": \"\\rroot@192.168.1.187's password: \\n\\rroot@192.168.1.187's password: \\n\\rroot@192.168.1.187's password: \\n\",",
      "360:             \"stderr\": \"Permission denied, please try again.\\nPermission denied, please try again.\\nroot@192.168.1.187: Permission denied (publickey,gssapi-keyex,gssapi-with-micimport pudb; pu.dbassword).\\nscp: Connection closed\\n\",",
      "361:             \"retcode\": 255,",
      "362:         }",
      "363:     }",
      "364:     key_run_ret = {",
      "365:         \"localhost\": {",
      "366:             \"jid\": \"20230922155652279959\",",
      "367:             \"return\": \"test\",",
      "368:             \"retcode\": 0,",
      "369:             \"id\": \"test\",",
      "370:             \"fun\": \"cmd.run\",",
      "371:             \"fun_args\": [\"echo test\"],",
      "372:         }",
      "373:     }",
      "374:     patch_roster_file = patch(\"salt.roster.get_roster_file\", MagicMock(return_value=\"\"))",
      "375:     with patch_roster_file:",
      "376:         client = ssh.SSH(opts)",
      "377:     patch_input = patch(\"builtins.input\", side_effect=[\"y\"])",
      "378:     patch_getpass = patch(\"getpass.getpass\", return_value=[\"password\"])",
      "379:     mock_key_run = MagicMock(return_value=key_run_ret)",
      "380:     patch_key_run = patch(\"salt.client.ssh.SSH._key_deploy_run\", mock_key_run)",
      "381:     with patch_input, patch_getpass, patch_key_run:",
      "382:         ret = client.key_deploy(host, ssh_ret)",
      "383:     assert mock_key_run.call_args_list[0][0] == (",
      "384:         host,",
      "385:         {\"passwd\": [passwd], \"host\": host, \"user\": usr},",
      "386:         True,",
      "387:     )",
      "388:     assert ret == key_run_ret",
      "389:     assert mock_key_run.call_count == 1",
      "392: def test_key_deploy_permission_denied_file_scp(tmp_path, opts):",
      "393:     \"\"\"",
      "394:     test \"key_deploy\" function when permission denied",
      "395:     due to not having access to copy the file to the target",
      "396:     We do not want to deploy the key, because this is not",
      "397:     an authentication to the target error.",
      "398:     \"\"\"",
      "399:     host = \"localhost\"",
      "400:     passwd = \"password\"",
      "401:     usr = \"ssh-usr\"",
      "402:     opts[\"ssh_user\"] = usr",
      "403:     opts[\"tgt\"] = host",
      "405:     mock_key_run = MagicMock(return_value=False)",
      "406:     patch_key_run = patch(\"salt.client.ssh.SSH._key_deploy_run\", mock_key_run)",
      "408:     ssh_ret = {",
      "409:         \"localhost\": {",
      "410:             \"stdout\": \"\",",
      "411:             \"stderr\": 'scp: dest open \"/tmp/preflight.sh\": Permission denied\\nscp: failed to upload file /etc/salt/preflight.sh to /tmp/preflight.sh\\n',",
      "412:             \"retcode\": 1,",
      "413:         }",
      "414:     }",
      "415:     patch_roster_file = patch(\"salt.roster.get_roster_file\", MagicMock(return_value=\"\"))",
      "416:     with patch_roster_file:",
      "417:         client = ssh.SSH(opts)",
      "418:     ret = client.key_deploy(host, ssh_ret)",
      "419:     assert ret == ssh_ret",
      "420:     assert mock_key_run.call_count == 0",
      "423: def test_key_deploy_no_permission_denied(tmp_path, opts):",
      "424:     \"\"\"",
      "425:     test \"key_deploy\" function when no permission denied",
      "426:     is returned",
      "427:     \"\"\"",
      "428:     host = \"localhost\"",
      "429:     passwd = \"password\"",
      "430:     usr = \"ssh-usr\"",
      "431:     opts[\"ssh_user\"] = usr",
      "432:     opts[\"tgt\"] = host",
      "434:     mock_key_run = MagicMock(return_value=False)",
      "435:     patch_key_run = patch(\"salt.client.ssh.SSH._key_deploy_run\", mock_key_run)",
      "436:     ssh_ret = {",
      "437:         \"localhost\": {",
      "438:             \"jid\": \"20230922161937998385\",",
      "439:             \"return\": \"test\",",
      "440:             \"retcode\": 0,",
      "441:             \"id\": \"test\",",
      "442:             \"fun\": \"cmd.run\",",
      "443:             \"fun_args\": [\"echo test\"],",
      "444:         }",
      "445:     }",
      "446:     patch_roster_file = patch(\"salt.roster.get_roster_file\", MagicMock(return_value=\"\"))",
      "447:     with patch_roster_file:",
      "448:         client = ssh.SSH(opts)",
      "449:     ret = client.key_deploy(host, ssh_ret)",
      "450:     assert ret == ssh_ret",
      "451:     assert mock_key_run.call_count == 0",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "963f1ce6691870e7e7076e53b75c990ed17b519e",
      "candidate_info": {
        "commit_hash": "963f1ce6691870e7e7076e53b75c990ed17b519e",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/963f1ce6691870e7e7076e53b75c990ed17b519e",
        "files": [
          "tests/pytests/unit/modules/test_aptpkg.py",
          "tests/pytests/unit/modules/test_linux_sysctl.py",
          "tests/pytests/unit/modules/test_win_ip.py",
          "tests/pytests/unit/test_master.py",
          "tests/pytests/unit/utils/event/test_event.py",
          "tests/unit/modules/test_nilrt_ip.py",
          "tests/unit/netapi/rest_tornado/test_saltnado.py"
        ],
        "message": "Fix mock calls\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/unit/modules/test_aptpkg.py||tests/pytests/unit/modules/test_aptpkg.py",
          "tests/pytests/unit/modules/test_linux_sysctl.py||tests/pytests/unit/modules/test_linux_sysctl.py",
          "tests/pytests/unit/modules/test_win_ip.py||tests/pytests/unit/modules/test_win_ip.py",
          "tests/pytests/unit/test_master.py||tests/pytests/unit/test_master.py",
          "tests/pytests/unit/utils/event/test_event.py||tests/pytests/unit/utils/event/test_event.py",
          "tests/unit/modules/test_nilrt_ip.py||tests/unit/modules/test_nilrt_ip.py",
          "tests/unit/netapi/rest_tornado/test_saltnado.py||tests/unit/netapi/rest_tornado/test_saltnado.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/unit/modules/test_aptpkg.py||tests/pytests/unit/modules/test_aptpkg.py": [
          "File: tests/pytests/unit/modules/test_aptpkg.py -> tests/pytests/unit/modules/test_aptpkg.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1298:     ]",
          "1300:     cmd_mock = MagicMock(side_effect=cmd_side_effect)",
          "1302:         call(",
          "1303:             [\"dpkg\", \"-l\", \"python\"],",
          "1306:             output_loglevel=\"quiet\",",
          "1307:             python_shell=True,",
          "1308:             username=\"Darth Vader\",",
          "1309:         ),",
          "1313:     with patch.dict(",
          "1314:         aptpkg.__salt__,",
          "",
          "[Removed Lines]",
          "1301:     cmd_call = (",
          "1304:             env={},",
          "1305:             ignore_retcode=False,",
          "1310:     )",
          "1311:     expected_calls = [cmd_call * 5]",
          "",
          "[Added Lines]",
          "1301:     cmd_call = [",
          "1306:             env={},",
          "1307:             ignore_retcode=False,",
          "1310:     ]",
          "1311:     expected_calls = cmd_call * 5",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1329:             # We should attempt to call the cmd 5 times",
          "1330:             assert cmd_mock.call_count == 5",
          "1334: def test_services_need_restart_checkrestart_missing():",
          "",
          "[Removed Lines]",
          "1331:             cmd_mock.has_calls(expected_calls)",
          "",
          "[Added Lines]",
          "1331:             cmd_mock.assert_has_calls(expected_calls)",
          "",
          "---------------"
        ],
        "tests/pytests/unit/modules/test_linux_sysctl.py||tests/pytests/unit/modules/test_linux_sysctl.py": [
          "File: tests/pytests/unit/modules/test_linux_sysctl.py -> tests/pytests/unit/modules/test_linux_sysctl.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "215:         ):",
          "216:             with pytest.raises(CommandExecutionError):",
          "217:                 linux_sysctl.persist(\"net.ipv4.ip_forward\", 42, config=None)",
          "221: def test_persist_no_conf_success():",
          "",
          "[Removed Lines]",
          "218:     fopen_mock.called_once()",
          "",
          "[Added Lines]",
          "218:     fopen_mock.assert_called_once()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "353:     \"\"\"",
          "354:     config = str(tmp_path / \"existing_sysctl_with_spaces.conf\")",
          "355:     value = \"|/usr/share/kdump-tools/dump-core %p %s %t %e\"",
          "357:     with fopen(config, \"w\", encoding=\"utf-8\") as config_file:",
          "358:         config_file.write(config_file_content)",
          "359:     mock_run = MagicMock(return_value=value)",
          "",
          "[Removed Lines]",
          "356:     config_file_content = \"kernel.core_pattern = {}\\n\".format(value)",
          "",
          "[Added Lines]",
          "356:     config_file_content = f\"kernel.core_pattern = {value}\\n\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "383:     \"\"\"",
          "384:     config = str(tmp_path / \"existing_sysctl_with_spaces.conf\")",
          "385:     value = \"|/usr/share/kdump-tools/dump-core %p %s %t %e\"",
          "387:     with fopen(config, \"w\", encoding=\"utf-8\") as config_file:",
          "388:         config_file.write(config_file_content)",
          "389:     mock_run = MagicMock(return_value=\"\")",
          "",
          "[Removed Lines]",
          "386:     config_file_content = \"kernel.core_pattern = {}\\n\".format(value)",
          "",
          "[Added Lines]",
          "386:     config_file_content = f\"kernel.core_pattern = {value}\\n\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "451:     assert os.path.isfile(config)",
          "452:     with fopen(config, encoding=\"utf-8\") as config_file:",
          "453:         written = config_file.read()",
          "457: def test_persist_value_with_spaces_new_file(tmp_path):",
          "",
          "[Removed Lines]",
          "454:     assert written == \"kernel.core_pattern = {}\\n\".format(value)",
          "",
          "[Added Lines]",
          "454:     assert written == f\"kernel.core_pattern = {value}\\n\"",
          "",
          "---------------"
        ],
        "tests/pytests/unit/modules/test_win_ip.py||tests/pytests/unit/modules/test_win_ip.py": [
          "File: tests/pytests/unit/modules/test_win_ip.py -> tests/pytests/unit/modules/test_win_ip.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:     ):",
          "152:         assert win_ip.enable(\"Ethernet\")",
          "155:         [",
          "156:             \"netsh\",",
          "157:             \"interface\",",
          "",
          "[Removed Lines]",
          "154:     mock_cmd.called_once_with(",
          "",
          "[Added Lines]",
          "154:     mock_cmd.assert_called_once_with(",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:     ):",
          "181:         assert win_ip.disable(\"Ethernet\")",
          "184:         [",
          "185:             \"netsh\",",
          "186:             \"interface\",",
          "",
          "[Removed Lines]",
          "183:     mock_cmd.called_once_with(",
          "",
          "[Added Lines]",
          "183:     mock_cmd.assert_called_once_with(",
          "",
          "---------------"
        ],
        "tests/pytests/unit/test_master.py||tests/pytests/unit/test_master.py": [
          "File: tests/pytests/unit/test_master.py -> tests/pytests/unit/test_master.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:         end = time.time()",
          "61:         # Interval is equal to timeout so the _do_update method will be called",
          "62:         # one time.",
          "64:         # Timeout is 1 second",
          "65:         duration = end - start",
          "66:         if duration > 2 and salt.utils.platform.spawning_platform():",
          "",
          "[Removed Lines]",
          "63:         update.called_once()",
          "",
          "[Added Lines]",
          "63:         update.assert_called_once()",
          "",
          "---------------"
        ],
        "tests/pytests/unit/utils/event/test_event.py||tests/pytests/unit/utils/event/test_event.py": [
          "File: tests/pytests/unit/utils/event/test_event.py -> tests/pytests/unit/utils/event/test_event.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "38: def _assert_got_event(evt, data, msg=None, expected_failure=False):",
          "39:     assert evt is not None, msg",
          "40:     for key in data:",
          "42:         assertMsg = \"{0}: Key {1} value mismatch, {2} != {3}\"",
          "43:         assertMsg = assertMsg.format(msg, key, data[key], evt[key])",
          "44:         if not expected_failure:",
          "",
          "[Removed Lines]",
          "41:         assert key in evt, \"{}: Key {} missing\".format(msg, key)",
          "",
          "[Added Lines]",
          "41:         assert key in evt, f\"{msg}: Key {key} missing\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59:         :10",
          "60:     ]",
          "61:     with salt.utils.event.MinionEvent(opts, listen=False) as me:",
          "66: def test_minion_event_tcp_ipc_mode():",
          "",
          "[Removed Lines]",
          "62:         assert me.puburi == str(sock_dir / \"minion_event_{}_pub.ipc\".format(id_hash))",
          "63:         assert me.pulluri == str(sock_dir / \"minion_event_{}_pull.ipc\".format(id_hash))",
          "",
          "[Added Lines]",
          "62:         assert me.puburi == str(sock_dir / f\"minion_event_{id_hash}_pub.ipc\")",
          "63:         assert me.pulluri == str(sock_dir / f\"minion_event_{id_hash}_pull.ipc\")",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "73: def test_minion_event_no_id(sock_dir):",
          "74:     with salt.utils.event.MinionEvent(dict(sock_dir=str(sock_dir)), listen=False) as me:",
          "75:         id_hash = hashlib.sha256(salt.utils.stringutils.to_bytes(\"\")).hexdigest()[:10]",
          "80: @pytest.mark.slow_test",
          "",
          "[Removed Lines]",
          "76:         assert me.puburi == str(sock_dir / \"minion_event_{}_pub.ipc\".format(id_hash))",
          "77:         assert me.pulluri == str(sock_dir / \"minion_event_{}_pull.ipc\".format(id_hash))",
          "",
          "[Added Lines]",
          "76:         assert me.puburi == str(sock_dir / f\"minion_event_{id_hash}_pub.ipc\")",
          "77:         assert me.pulluri == str(sock_dir / f\"minion_event_{id_hash}_pull.ipc\")",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "256:     with eventpublisher_process(str(sock_dir)):",
          "257:         with salt.utils.event.MasterEvent(str(sock_dir), listen=True) as me:",
          "258:             for i in range(500):",
          "260:                 evt = me.get_event(tag=\"testevents\")",
          "264: @pytest.mark.slow_test",
          "",
          "[Removed Lines]",
          "259:                 me.fire_event({\"data\": \"{}\".format(i)}, \"testevents\")",
          "261:                 _assert_got_event(evt, {\"data\": \"{}\".format(i)}, \"Event {}\".format(i))",
          "",
          "[Added Lines]",
          "259:                 me.fire_event({\"data\": f\"{i}\"}, \"testevents\")",
          "261:                 _assert_got_event(evt, {\"data\": f\"{i}\"}, f\"Event {i}\")",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "268:         with salt.utils.event.MasterEvent(str(sock_dir), listen=True) as me:",
          "269:             # Must not exceed zmq HWM",
          "270:             for i in range(500):",
          "272:             for i in range(500):",
          "273:                 evt = me.get_event(tag=\"testevents\")",
          "277: # Test the fire_master function. As it wraps the underlying fire_event,",
          "",
          "[Removed Lines]",
          "271:                 me.fire_event({\"data\": \"{}\".format(i)}, \"testevents\")",
          "274:                 _assert_got_event(evt, {\"data\": \"{}\".format(i)}, \"Event {}\".format(i))",
          "",
          "[Added Lines]",
          "271:                 me.fire_event({\"data\": f\"{i}\"}, \"testevents\")",
          "274:                 _assert_got_event(evt, {\"data\": f\"{i}\"}, f\"Event {i}\")",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "300:     event = SaltEvent(node=None)",
          "301:     with patch.object(event, \"pusher\") as mock_pusher:",
          "302:         with patch.object(",
          "304:         ) as mock_log_debug:",
          "305:             mock_pusher.connect.side_effect = (",
          "306:                 salt.ext.tornado.iostream.StreamClosedError",
          "",
          "[Removed Lines]",
          "303:             salt.utils.event.log, \"debug\", auto_spec=True",
          "",
          "[Added Lines]",
          "303:             salt.utils.event.log, \"debug\", autospec=True",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "317:     event = SaltEvent(node=None)",
          "318:     with patch.object(event, \"pusher\") as mock_pusher:",
          "319:         with patch.object(",
          "321:         ) as mock_log_debug:",
          "322:             with patch.object(",
          "324:             ) as mock_log_error:",
          "325:                 mock_pusher.connect.side_effect = error",
          "326:                 event.connect_pull()",
          "",
          "[Removed Lines]",
          "320:             salt.utils.event.log, \"debug\", auto_spec=True",
          "323:                 salt.utils.event.log, \"error\", auto_spec=True",
          "",
          "[Added Lines]",
          "320:             salt.utils.event.log, \"debug\", autospec=True",
          "323:                 salt.utils.event.log, \"error\", autospec=True",
          "",
          "---------------"
        ],
        "tests/unit/modules/test_nilrt_ip.py||tests/unit/modules/test_nilrt_ip.py": [
          "File: tests/unit/modules/test_nilrt_ip.py -> tests/unit/modules/test_nilrt_ip.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "28:                 \"salt.modules.nilrt_ip._change_dhcp_config\", return_value=True",
          "29:             ) as change_dhcp_config_mock:",
          "30:                 assert nilrt_ip._change_state(\"test_interface\", \"down\")",
          "33:     def test_change_state_up_state(self):",
          "34:         \"\"\"",
          "",
          "[Removed Lines]",
          "31:                 assert change_dhcp_config_mock.called_with(\"test_interface\", False)",
          "",
          "[Added Lines]",
          "31:                 change_dhcp_config_mock.assert_called_with(\"test_interface\", False)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "42:                 \"salt.modules.nilrt_ip._change_dhcp_config\", return_value=True",
          "43:             ) as change_dhcp_config_mock:",
          "44:                 assert nilrt_ip._change_state(\"test_interface\", \"up\")",
          "47:     def test_set_static_all_with_dns(self):",
          "48:         \"\"\"",
          "",
          "[Removed Lines]",
          "45:                 assert change_dhcp_config_mock.called_with(\"test_interface\")",
          "",
          "[Added Lines]",
          "45:                 change_dhcp_config_mock.assert_called_with(\"test_interface\")",
          "",
          "---------------"
        ],
        "tests/unit/netapi/rest_tornado/test_saltnado.py||tests/unit/netapi/rest_tornado/test_saltnado.py": [
          "File: tests/unit/netapi/rest_tornado/test_saltnado.py -> tests/unit/netapi/rest_tornado/test_saltnado.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "647:         with patch.object(",
          "648:             self.handler.application.event_listener,",
          "649:             \"get_event\",",
          "651:             side_effect=fancy_get_event,",
          "652:         ), patch.dict(",
          "653:             self.handler.application.opts,",
          "",
          "[Removed Lines]",
          "650:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "698:         with patch.object(",
          "699:             self.handler.application.event_listener,",
          "700:             \"get_event\",",
          "702:             side_effect=fancy_get_event,",
          "703:         ), patch.object(",
          "704:             self.handler,",
          "",
          "[Removed Lines]",
          "701:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "729:                 {",
          "730:                     \"tag\": \"fnord\",",
          "731:                     \"data\": {",
          "734:                     },",
          "735:                 }",
          "736:             )",
          "",
          "[Removed Lines]",
          "732:                         \"return\": \"return from fnord {}\".format(i),",
          "733:                         \"id\": \"fnord {}\".format(i),",
          "",
          "[Added Lines]",
          "730:                         \"return\": f\"return from fnord {i}\",",
          "731:                         \"id\": f\"fnord {i}\",",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "760:         with patch.object(",
          "761:             self.handler.application.event_listener,",
          "762:             \"get_event\",",
          "764:             side_effect=fancy_get_event,",
          "765:         ), patch.object(",
          "766:             self.handler,",
          "",
          "[Removed Lines]",
          "763:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "794:                 {",
          "795:                     \"tag\": \"fnord\",",
          "796:                     \"data\": {",
          "799:                     },",
          "800:                 }",
          "801:             )",
          "",
          "[Removed Lines]",
          "797:                         \"return\": \"return from fnord {}\".format(i),",
          "798:                         \"id\": \"fnord {}\".format(i),",
          "",
          "[Added Lines]",
          "794:                         \"return\": f\"return from fnord {i}\",",
          "795:                         \"id\": f\"fnord {i}\",",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "820:         with patch.object(",
          "821:             self.handler.application.event_listener,",
          "822:             \"get_event\",",
          "824:             side_effect=fancy_get_event,",
          "825:         ), patch.dict(",
          "826:             self.handler.application.opts,",
          "",
          "[Removed Lines]",
          "823:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "843:         completed_events = [salt.ext.tornado.gen.Future() for _ in range(10)]",
          "844:         events_by_id = {}",
          "845:         for i, event in enumerate(completed_events):",
          "847:             events_by_id[id_] = event",
          "848:             event.set_result(",
          "849:                 {",
          "850:                     \"tag\": \"fnord\",",
          "852:                 }",
          "853:             )",
          "854:         expected_result = {",
          "",
          "[Removed Lines]",
          "846:             id_ = \"fnord {}\".format(i)",
          "851:                     \"data\": {\"return\": \"return from {}\".format(id_), \"id\": id_},",
          "",
          "[Added Lines]",
          "842:             id_ = f\"fnord {i}\"",
          "847:                     \"data\": {\"return\": f\"return from {id_}\", \"id\": id_},",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "878:         with patch.object(",
          "879:             self.handler.application.event_listener,",
          "880:             \"get_event\",",
          "882:             side_effect=fancy_get_event,",
          "883:         ), patch.dict(",
          "884:             self.handler.application.opts,",
          "",
          "[Removed Lines]",
          "881:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "904:         events_by_id = {}",
          "905:         # Setup some real-enough looking return data",
          "906:         for i, event in enumerate(completed_events):",
          "908:             events_by_id[id_] = event",
          "909:             event.set_result(",
          "910:                 {",
          "911:                     \"tag\": \"fnord\",",
          "913:                 }",
          "914:             )",
          "915:         # Hard coded instead of dynamic to avoid potentially writing a test",
          "",
          "[Removed Lines]",
          "907:             id_ = \"fnord {}\".format(i)",
          "912:                     \"data\": {\"return\": \"return from {}\".format(id_), \"id\": id_},",
          "",
          "[Added Lines]",
          "902:             id_ = f\"fnord {i}\"",
          "907:                     \"data\": {\"return\": f\"return from {id_}\", \"id\": id_},",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "971:         with patch.object(",
          "972:             self.handler.application.event_listener,",
          "973:             \"get_event\",",
          "975:             side_effect=fancy_get_event,",
          "976:         ), patch.object(",
          "977:             self.handler,",
          "",
          "[Removed Lines]",
          "974:             autospec=True,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d295e24f4354d62a6c53b9f6f99696b987eb15a1",
      "candidate_info": {
        "commit_hash": "d295e24f4354d62a6c53b9f6f99696b987eb15a1",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/d295e24f4354d62a6c53b9f6f99696b987eb15a1",
        "files": [
          "tests/pytests/unit/states/test_file.py"
        ],
        "message": "Switch to the correct fixture usage\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/unit/states/test_file.py||tests/pytests/unit/states/test_file.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/unit/states/test_file.py||tests/pytests/unit/states/test_file.py": [
          "File: tests/pytests/unit/states/test_file.py -> tests/pytests/unit/states/test_file.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: from tests.support.mock import MagicMock, call, create_autospec, patch",
          "13:         file: {",
          "14:             \"__opts__\": {\"test\": False},",
          "15:             \"__env__\": \"base\",",
          "16:         }",
          "17:     }",
          "23: def fake_remove():",
          "24:     fake_remove_mod = create_autospec(filemod.remove)",
          "25:     with patch.dict(file.__salt__, {\"file.remove\": fake_remove_mod}):",
          "",
          "[Removed Lines]",
          "10: @pytest.fixture(autouse=True)",
          "11: def setup_loader(request):",
          "12:     setup_loader_modules = {",
          "18:     with pytest.helpers.loader_mock(request, setup_loader_modules) as loader_mock:",
          "19:         yield loader_mock",
          "22: @pytest.fixture()",
          "",
          "[Added Lines]",
          "10: @pytest.fixture",
          "11: def configure_loader_modules(minion_opts):",
          "12:     return {",
          "20: @pytest.fixture",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "be3d892fc94e04fabbd4ffd4618346f3cfdbb795",
      "candidate_info": {
        "commit_hash": "be3d892fc94e04fabbd4ffd4618346f3cfdbb795",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/be3d892fc94e04fabbd4ffd4618346f3cfdbb795",
        "files": [
          "requirements/static/ci/common.in",
          "requirements/static/ci/py3.10/cloud.txt",
          "requirements/static/ci/py3.10/darwin.txt",
          "requirements/static/ci/py3.10/freebsd.txt",
          "requirements/static/ci/py3.10/lint.txt",
          "requirements/static/ci/py3.10/linux.txt",
          "requirements/static/ci/py3.10/windows.txt",
          "requirements/static/ci/py3.7/cloud.txt",
          "requirements/static/ci/py3.7/freebsd.txt",
          "requirements/static/ci/py3.7/lint.txt",
          "requirements/static/ci/py3.7/linux.txt",
          "requirements/static/ci/py3.7/windows.txt",
          "requirements/static/ci/py3.8/cloud.txt",
          "requirements/static/ci/py3.8/freebsd.txt",
          "requirements/static/ci/py3.8/lint.txt",
          "requirements/static/ci/py3.8/linux.txt",
          "requirements/static/ci/py3.8/windows.txt",
          "requirements/static/ci/py3.9/cloud.txt",
          "requirements/static/ci/py3.9/darwin.txt",
          "requirements/static/ci/py3.9/freebsd.txt",
          "requirements/static/ci/py3.9/lint.txt",
          "requirements/static/ci/py3.9/linux.txt",
          "requirements/static/ci/py3.9/windows.txt"
        ],
        "message": "Remove `docker` from `requirements/static/ci/common.in`\n\nIt was wrongly added whew resolving conflicts while merging forward\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "requirements/static/ci/common.in||requirements/static/ci/common.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "requirements/static/ci/common.in||requirements/static/ci/common.in": [
          "File: requirements/static/ci/common.in -> requirements/static/ci/common.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: clustershell",
          "15: croniter>=0.3.0,!=0.3.22\"; sys_platform != 'win32'",
          "16: dnspython",
          "18: etcd3-py==0.1.6",
          "19: gitpython>=3.1.37",
          "20: jmespath",
          "",
          "[Removed Lines]",
          "17: docker",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f7142cbc97afc64cd87b9311efa473b5c250fffe",
      "candidate_info": {
        "commit_hash": "f7142cbc97afc64cd87b9311efa473b5c250fffe",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/f7142cbc97afc64cd87b9311efa473b5c250fffe",
        "files": [
          "tests/pytests/functional/channel/test_server.py"
        ],
        "message": "Try a few times before raising the error\n\nSigned-off-by: Pedro Algarvio <palgarvio@vmware.com>",
        "before_after_code_files": [
          "tests/pytests/functional/channel/test_server.py||tests/pytests/functional/channel/test_server.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/pytests/functional/channel/test_server.py||tests/pytests/functional/channel/test_server.py": [
          "File: tests/pytests/functional/channel/test_server.py -> tests/pytests/functional/channel/test_server.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:     req_server_channel.post_fork(handle_payload, io_loop=io_loop)",
          "167:     if master_config[\"transport\"] == \"zeromq\":",
          "174:     pub_channel = salt.channel.client.AsyncPubChannel.factory(minion_config)",
          "175:     received = []",
          "",
          "[Removed Lines]",
          "168:         p = Path(str(master_config[\"sock_dir\"])) / \"workers.ipc\"",
          "169:         mode = os.lstat(p).st_mode",
          "170:         assert bool(os.lstat(p).st_mode & stat.S_IRUSR)",
          "171:         assert not bool(os.lstat(p).st_mode & stat.S_IRGRP)",
          "172:         assert not bool(os.lstat(p).st_mode & stat.S_IROTH)",
          "",
          "[Added Lines]",
          "168:         time.sleep(1)",
          "169:         attempts = 5",
          "170:         while True:",
          "171:             try:",
          "172:                 p = Path(str(master_config[\"sock_dir\"])) / \"workers.ipc\"",
          "173:                 mode = os.lstat(p).st_mode",
          "174:                 assert bool(os.lstat(p).st_mode & stat.S_IRUSR)",
          "175:                 assert not bool(os.lstat(p).st_mode & stat.S_IRGRP)",
          "176:                 assert not bool(os.lstat(p).st_mode & stat.S_IROTH)",
          "177:                 break",
          "178:             except FileNotFoundError as exc:",
          "179:                 if not attempts:",
          "180:                     raise exc from None",
          "181:                 attempts -= 1",
          "182:                 time.sleep(2.5)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "90135124c0323d2254d83f16687403f317e5920a",
      "candidate_info": {
        "commit_hash": "90135124c0323d2254d83f16687403f317e5920a",
        "repo": "saltstack/salt",
        "commit_url": "https://github.com/saltstack/salt/commit/90135124c0323d2254d83f16687403f317e5920a",
        "files": [
          "pkg/tests/support/helpers.py"
        ],
        "message": "Fix urls for macos/windows non-classic pre-relenv packages",
        "before_after_code_files": [
          "pkg/tests/support/helpers.py||pkg/tests/support/helpers.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/saltstack/salt/pull/65482"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "pkg/tests/support/helpers.py||pkg/tests/support/helpers.py": [
          "File: pkg/tests/support/helpers.py -> pkg/tests/support/helpers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "756:             if not self.classic:",
          "757:                 if not relenv:",
          "760:                 else:",
          "761:                     if self.file_ext == \"msi\":",
          "762:                         win_pkg = (",
          "",
          "[Removed Lines]",
          "758:                     win_pkg = f\"salt-{self.prev_version}-windows-amd64.{self.file_ext}\"",
          "759:                     win_pkg_url = f\"https://repo.saltproject.io/salt/py3/windows/{self.prev_version}/{win_pkg}\"",
          "",
          "[Added Lines]",
          "758:                     win_pkg = f\"salt-{self.prev_version}-{pkg_version}-windows-amd64.{self.file_ext}\"",
          "759:                     win_pkg_url = f\"https://repo.saltproject.io/salt/py3/windows/{major_ver}/{win_pkg}\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "803:                 mac_pkg_url = f\"https://repo.saltproject.io/osx/{mac_pkg}\"",
          "804:             else:",
          "805:                 if not relenv:",
          "808:                 else:",
          "809:                     mac_pkg = f\"salt-{self.prev_version}-py3-x86_64.pkg\"",
          "810:                     mac_pkg_url = f\"https://repo.saltproject.io/salt/py3/macos/{major_ver}/{mac_pkg}\"",
          "",
          "[Removed Lines]",
          "806:                     mac_pkg = f\"salt-{self.prev_version}-macos-x86_64.pkg\"",
          "807:                     mac_pkg_url = f\"https://repo.saltproject.io/salt/py3/macos/{self.prev_version}/{mac_pkg}\"",
          "",
          "[Added Lines]",
          "806:                     mac_pkg = f\"salt-{self.prev_version}-{pkg_version}-macos-x86_64.pkg\"",
          "807:                     mac_pkg_url = f\"https://repo.saltproject.io/salt/py3/macos/{major_ver}/{mac_pkg}\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}