{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bf25fb166c3024cdd1532f36a4f1702466b5c834",
      "candidate_info": {
        "commit_hash": "bf25fb166c3024cdd1532f36a4f1702466b5c834",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bf25fb166c3024cdd1532f36a4f1702466b5c834",
        "files": [
          "admin/settings/analytics.php",
          "admin/settings/subsystems.php",
          "admin/tool/analytics/classes/output/renderer.php",
          "admin/tool/analytics/classes/task/predict_models.php",
          "admin/tool/analytics/classes/task/train_models.php",
          "admin/tool/analytics/cli/enable_model.php",
          "admin/tool/analytics/cli/evaluate_model.php",
          "admin/tool/analytics/createmodel.php",
          "admin/tool/analytics/importmodel.php",
          "admin/tool/analytics/model.php",
          "admin/tool/analytics/restoredefault.php",
          "admin/tool/analytics/settings.php",
          "analytics/classes/manager.php",
          "lang/en/admin.php",
          "lang/en/analytics.php",
          "lib/classes/task/analytics_cleanup_task.php",
          "report/insights/action.php",
          "report/insights/classes/output/renderer.php",
          "report/insights/done.php",
          "report/insights/insights.php",
          "report/insights/lib.php",
          "report/insights/prediction.php",
          "report/insights/settings.php",
          "version.php"
        ],
        "message": "MDL-65585 analytics: Global on/off switch",
        "before_after_code_files": [
          "admin/settings/analytics.php||admin/settings/analytics.php",
          "admin/settings/subsystems.php||admin/settings/subsystems.php",
          "admin/tool/analytics/classes/output/renderer.php||admin/tool/analytics/classes/output/renderer.php",
          "admin/tool/analytics/classes/task/predict_models.php||admin/tool/analytics/classes/task/predict_models.php",
          "admin/tool/analytics/classes/task/train_models.php||admin/tool/analytics/classes/task/train_models.php",
          "admin/tool/analytics/cli/enable_model.php||admin/tool/analytics/cli/enable_model.php",
          "admin/tool/analytics/cli/evaluate_model.php||admin/tool/analytics/cli/evaluate_model.php",
          "admin/tool/analytics/createmodel.php||admin/tool/analytics/createmodel.php",
          "admin/tool/analytics/importmodel.php||admin/tool/analytics/importmodel.php",
          "admin/tool/analytics/model.php||admin/tool/analytics/model.php",
          "admin/tool/analytics/restoredefault.php||admin/tool/analytics/restoredefault.php",
          "admin/tool/analytics/settings.php||admin/tool/analytics/settings.php",
          "analytics/classes/manager.php||analytics/classes/manager.php",
          "lang/en/admin.php||lang/en/admin.php",
          "lang/en/analytics.php||lang/en/analytics.php",
          "lib/classes/task/analytics_cleanup_task.php||lib/classes/task/analytics_cleanup_task.php",
          "report/insights/action.php||report/insights/action.php",
          "report/insights/classes/output/renderer.php||report/insights/classes/output/renderer.php",
          "report/insights/done.php||report/insights/done.php",
          "report/insights/insights.php||report/insights/insights.php",
          "report/insights/lib.php||report/insights/lib.php",
          "report/insights/prediction.php||report/insights/prediction.php",
          "report/insights/settings.php||report/insights/settings.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/settings/analytics.php||admin/settings/analytics.php": [
          "File: admin/settings/analytics.php -> admin/settings/analytics.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: defined('MOODLE_INTERNAL') || die();",
          "29:     $settings = new admin_settingpage('analyticssite', new lang_string('analyticssiteinfo', 'analytics'));",
          "30:     $ADMIN->add('analytics', $settings);",
          "",
          "[Removed Lines]",
          "27: if ($hassiteconfig) {",
          "",
          "[Added Lines]",
          "27: if ($hassiteconfig && \\core_analytics\\manager::is_analytics_enabled()) {",
          "",
          "---------------"
        ],
        "admin/settings/subsystems.php||admin/settings/subsystems.php": [
          "File: admin/settings/subsystems.php -> admin/settings/subsystems.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     $optionalsubsystems->add(new admin_setting_configcheckbox('allowstealth', new lang_string('allowstealthmodules'),",
          "50:         new lang_string('allowstealthmodules_help'), 0, 1, 0));",
          "51: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:     $optionalsubsystems->add(new admin_setting_configcheckbox('enableanalytics', new lang_string('enableanalytics', 'admin'),",
          "53:         new lang_string('configenableanalytics', 'admin'), 1, 1, 0));",
          "",
          "---------------"
        ],
        "admin/tool/analytics/classes/output/renderer.php||admin/tool/analytics/classes/output/renderer.php": [
          "File: admin/tool/analytics/classes/output/renderer.php -> admin/tool/analytics/classes/output/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "229:         $data = $invalidanalysables->export_for_template($this);",
          "230:         return parent::render_from_template('tool_analytics/invalid_analysables', $data);",
          "231:     }",
          "232: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "238:     public function render_analytics_disabled() {",
          "239:         global $OUTPUT, $PAGE, $FULLME;",
          "241:         $PAGE->set_url($FULLME);",
          "242:         $PAGE->set_title(get_string('pluginname', 'tool_analytics'));",
          "243:         $PAGE->set_heading(get_string('pluginname', 'tool_analytics'));",
          "245:         $output = $OUTPUT->header();",
          "246:         $output .= $OUTPUT->notification(get_string('analyticsdisabled', 'analytics'), \\core\\output\\notification::NOTIFY_INFO);",
          "247:         $output .= \\html_writer::tag('a', get_string('continue'), ['class' => 'btn btn-primary',",
          "248:             'href' => (new \\moodle_url('/'))->out()]);",
          "249:         $output .= $OUTPUT->footer();",
          "251:         return $output;",
          "252:     }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/classes/task/predict_models.php||admin/tool/analytics/classes/task/predict_models.php": [
          "File: admin/tool/analytics/classes/task/predict_models.php -> admin/tool/analytics/classes/task/predict_models.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:     public function execute() {",
          "53:         global $OUTPUT, $PAGE;",
          "55:         $models = \\core_analytics\\manager::get_all_models(true, true);",
          "56:         if (!$models) {",
          "57:             mtrace(get_string('errornoenabledandtrainedmodels', 'tool_analytics'));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:         if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "56:             mtrace(get_string('analyticsdisabled', 'analytics'));",
          "57:             return;",
          "58:         }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/classes/task/train_models.php||admin/tool/analytics/classes/task/train_models.php": [
          "File: admin/tool/analytics/classes/task/train_models.php -> admin/tool/analytics/classes/task/train_models.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:     public function execute() {",
          "53:         global $OUTPUT, $PAGE;",
          "55:         $models = \\core_analytics\\manager::get_all_models(true);",
          "56:         if (!$models) {",
          "57:             mtrace(get_string('errornoenabledmodels', 'tool_analytics'));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:         if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "56:             mtrace(get_string('analyticsdisabled', 'analytics'));",
          "57:             return;",
          "58:         }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/cli/enable_model.php||admin/tool/analytics/cli/enable_model.php": [
          "File: admin/tool/analytics/cli/enable_model.php -> admin/tool/analytics/cli/enable_model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "57:     exit(0);",
          "58: }",
          "60: if ($options['list'] || $options['modelid'] === false) {",
          "61:     \\tool_analytics\\clihelper::list_models();",
          "62:     exit(0);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "60: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "61:     echo get_string('analyticsdisabled', 'analytics') . PHP_EOL;",
          "62:     exit(0);",
          "63: }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/cli/evaluate_model.php||admin/tool/analytics/cli/evaluate_model.php": [
          "File: admin/tool/analytics/cli/evaluate_model.php -> admin/tool/analytics/cli/evaluate_model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "67:     exit(0);",
          "68: }",
          "70: if ($options['list']) {",
          "71:     \\tool_analytics\\clihelper::list_models();",
          "72:     exit(0);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "71:     echo get_string('analyticsdisabled', 'analytics') . PHP_EOL;",
          "72:     exit(0);",
          "73: }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/createmodel.php||admin/tool/analytics/createmodel.php": [
          "File: admin/tool/analytics/createmodel.php -> admin/tool/analytics/createmodel.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: require_login();",
          "28: \\core_analytics\\manager::check_can_manage_models();",
          "30: $returnurl = new \\moodle_url('/admin/tool/analytics/index.php');",
          "31: $url = new \\moodle_url('/admin/tool/analytics/createmodel.php');",
          "32: $title = get_string('createmodel', 'tool_analytics');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "31:     $PAGE->set_context(\\context_system::instance());",
          "32:     $renderer = $PAGE->get_renderer('tool_analytics');",
          "33:     echo $renderer->render_analytics_disabled();",
          "34:     exit(0);",
          "35: }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/importmodel.php||admin/tool/analytics/importmodel.php": [
          "File: admin/tool/analytics/importmodel.php -> admin/tool/analytics/importmodel.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: require_login();",
          "28: \\core_analytics\\manager::check_can_manage_models();",
          "30: $returnurl = new \\moodle_url('/admin/tool/analytics/index.php');",
          "31: $url = new \\moodle_url('/admin/tool/analytics/importmodel.php');",
          "32: $title = get_string('importmodel', 'tool_analytics');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "31:     $PAGE->set_context(\\context_system::instance());",
          "32:     $renderer = $PAGE->get_renderer('tool_analytics');",
          "33:     echo $renderer->render_analytics_disabled();",
          "34:     exit(0);",
          "35: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "57: echo $OUTPUT->header();",
          "58: $form->display();",
          "",
          "[Removed Lines]",
          "59: echo $OUTPUT->footer();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "admin/tool/analytics/model.php||admin/tool/analytics/model.php": [
          "File: admin/tool/analytics/model.php -> admin/tool/analytics/model.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: $model = new \\core_analytics\\model($id);",
          "34: \\core_analytics\\manager::check_can_manage_models();",
          "36: $returnurl = new \\moodle_url('/admin/tool/analytics/index.php');",
          "37: $params = array('id' => $id, 'action' => $action);",
          "38: $url = new \\moodle_url('/admin/tool/analytics/model.php', $params);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "37:     $PAGE->set_context(\\context_system::instance());",
          "38:     $renderer = $PAGE->get_renderer('tool_analytics');",
          "39:     echo $renderer->render_analytics_disabled();",
          "40:     exit(0);",
          "41: }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/restoredefault.php||admin/tool/analytics/restoredefault.php": [
          "File: admin/tool/analytics/restoredefault.php -> admin/tool/analytics/restoredefault.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: require_login();",
          "28: \\core_analytics\\manager::check_can_manage_models();",
          "30: $confirmed = optional_param('confirmed', false, PARAM_BOOL);",
          "31: $restoreids = optional_param_array('restoreid', [], PARAM_ALPHANUM);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "31:     $PAGE->set_context(\\context_system::instance());",
          "32:     $renderer = $PAGE->get_renderer('tool_analytics');",
          "33:     echo $renderer->render_analytics_disabled();",
          "34:     exit(0);",
          "35: }",
          "",
          "---------------"
        ],
        "admin/tool/analytics/settings.php||admin/tool/analytics/settings.php": [
          "File: admin/tool/analytics/settings.php -> admin/tool/analytics/settings.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "27: $ADMIN->add('analytics', new admin_externalpage('analyticmodels', get_string('analyticmodels', 'tool_analytics'),",
          "28:     \"$CFG->wwwroot/$CFG->admin/tool/analytics/index.php\", 'moodle/analytics:managemodels'));",
          "",
          "[Added Lines]",
          "27: if (\\core_analytics\\manager::is_analytics_enabled()) {",
          "28:     $ADMIN->add('analytics', new admin_externalpage('analyticmodels', get_string('analyticmodels', 'tool_analytics'),",
          "29:         \"$CFG->wwwroot/$CFG->admin/tool/analytics/index.php\", 'moodle/analytics:managemodels'));",
          "30: }",
          "",
          "---------------"
        ],
        "analytics/classes/manager.php||analytics/classes/manager.php": [
          "File: analytics/classes/manager.php -> analytics/classes/manager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "99:         }",
          "100:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "107:     public static function is_analytics_enabled(): bool {",
          "108:         global $CFG;",
          "110:         if (isset($CFG->enableanalytics)) {",
          "111:             return $CFG->enableanalytics;",
          "112:         }",
          "115:         return true;",
          "116:     }",
          "",
          "---------------"
        ],
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "209: $string['configdeleteincompleteusers'] = 'After this period, any account without the first name, last name or email field filled in is deleted.';",
          "210: $string['configdeleteunconfirmed'] = 'For certain authentication methods, such as email-based self-registration, users must confirm their account within a certain time. After this period, any old unconfirmed accounts are deleted.';",
          "211: $string['configdenyemailaddresses'] = 'To deny email addresses from particular domains list them here in the same way.  All other domains will be accepted. To deny subdomains add the domain with a preceding \\'.\\'. eg <strong>hotmail.com yahoo.co.uk .live.com</strong>';",
          "212: $string['configenableblogs'] = 'This switch provides all site users with their own blog.';",
          "213: $string['configenabledevicedetection'] = 'Enables detection of mobiles, smartphones, tablets or default devices (desktop PCs, laptops, etc) for the application of themes and other features.';",
          "214: $string['configdisableuserimages'] = 'Disable the ability for users to change user profile images.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "212: $string['configenableanalytics'] = 'Analytics models, such as \\'Students at risk of dropping out\\' or \\'Upcoming activities due\\', can generate predictions, send insight notifications and offer further actions such as messaging users.';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "514: $string['emoticonsreset'] = 'Reset emoticons setting to default values';",
          "515: $string['emptysettingvalue'] = 'Empty';",
          "516: $string['enableactivitychooser'] = 'Enable activity chooser';",
          "517: $string['enableblogs'] = 'Enable blogs';",
          "518: $string['enablecalendarexport'] = 'Enable calendar export';",
          "519: $string['enablecomments'] = 'Enable comments';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "518: $string['enableanalytics'] = 'Analytics';",
          "",
          "---------------"
        ],
        "lang/en/analytics.php||lang/en/analytics.php": [
          "File: lang/en/analytics.php -> lang/en/analytics.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: $string['analysablenotvalidfortarget'] = 'Analysable {$a->analysableid} is not valid for this target: {$a->result}';",
          "27: $string['analysisinprogress'] = 'Still being analysed by a previous execution';",
          "28: $string['analytics'] = 'Analytics';",
          "29: $string['analyticslogstore'] = 'Log store used for analytics';",
          "30: $string['analyticslogstore_help'] = 'The log store that will be used by the analytics API to read users\\' activity.';",
          "31: $string['analyticssettings'] = 'Analytics settings';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: $string['analyticsdisabled'] = 'Analytics is disabled. You can enable it in \"Site administration > Advanced features\".';",
          "",
          "---------------"
        ],
        "lib/classes/task/analytics_cleanup_task.php||lib/classes/task/analytics_cleanup_task.php": [
          "File: lib/classes/task/analytics_cleanup_task.php -> lib/classes/task/analytics_cleanup_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:     public function execute() {",
          "53:         $models = \\core_analytics\\manager::cleanup();",
          "54:     }",
          "55: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:         if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "55:             mtrace(get_string('analyticsdisabled', 'analytics'));",
          "56:             return;",
          "57:         }",
          "",
          "---------------"
        ],
        "report/insights/action.php||report/insights/action.php": [
          "File: report/insights/action.php -> report/insights/action.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: $actionname = required_param('action', PARAM_ALPHANUMEXT);",
          "29: $forwardurl = required_param('forwardurl', PARAM_LOCALURL);",
          "31: list($model, $prediction, $context) = \\core_analytics\\manager::get_prediction($predictionid, true);",
          "32: if ($context->contextlevel < CONTEXT_COURSE) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "32:     $PAGE->set_context(\\context_system::instance());",
          "33:     $renderer = $PAGE->get_renderer('report_insights');",
          "34:     echo $renderer->render_analytics_disabled();",
          "35:     exit(0);",
          "36: }",
          "",
          "---------------"
        ],
        "report/insights/classes/output/renderer.php||report/insights/classes/output/renderer.php": [
          "File: report/insights/classes/output/renderer.php -> report/insights/classes/output/renderer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "122:         return $output;",
          "123:     }",
          "124: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     public function render_analytics_disabled() {",
          "131:         global $OUTPUT, $PAGE, $FULLME;",
          "133:         $PAGE->set_url($FULLME);",
          "134:         $PAGE->set_title(get_string('pluginname', 'report_insights'));",
          "135:         $PAGE->set_heading(get_string('pluginname', 'report_insights'));",
          "137:         $output = $OUTPUT->header();",
          "138:         $output .= $OUTPUT->notification(get_string('analyticsdisabled', 'analytics'), \\core\\output\\notification::NOTIFY_INFO);",
          "139:         $output .= \\html_writer::tag('a', get_string('continue'), ['class' => 'btn btn-primary',",
          "140:             'href' => (new \\moodle_url('/'))->out()]);",
          "141:         $output .= $OUTPUT->footer();",
          "143:         return $output;",
          "144:     }",
          "",
          "---------------"
        ],
        "report/insights/done.php||report/insights/done.php": [
          "File: report/insights/done.php -> report/insights/done.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: $PAGE->set_pagelayout('popup');",
          "32: $PAGE->set_context(\\context_system::instance());",
          "33: $PAGE->set_title(get_site()->fullname);",
          "34: $PAGE->set_url(new \\moodle_url('/report/insights/done.php'));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "35:     $renderer = $PAGE->get_renderer('report_insights');",
          "36:     echo $renderer->render_analytics_disabled();",
          "37:     exit(0);",
          "38: }",
          "",
          "---------------"
        ],
        "report/insights/insights.php||report/insights/insights.php": [
          "File: report/insights/insights.php -> report/insights/insights.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:     $PAGE->set_context($context);",
          "42: }",
          "44: \\core_analytics\\manager::check_can_list_insights($context);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "45:     $renderer = $PAGE->get_renderer('report_insights');",
          "46:     echo $renderer->render_analytics_disabled();",
          "47:     exit(0);",
          "48: }",
          "",
          "---------------"
        ],
        "report/insights/lib.php||report/insights/lib.php": [
          "File: report/insights/lib.php -> report/insights/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: function report_insights_extend_navigation_course($navigation, $course, $context) {",
          "39:         $modelids = \\core_analytics\\manager::cached_models_with_insights($context);",
          "40:         if (!empty($modelids)) {",
          "",
          "[Removed Lines]",
          "37:     if (has_capability('moodle/analytics:listinsights', $context)) {",
          "",
          "[Added Lines]",
          "37:     if (\\core_analytics\\manager::is_analytics_enabled() && has_capability('moodle/analytics:listinsights', $context)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59: function report_insights_myprofile_navigation(core_user\\output\\myprofile\\tree $tree, $user, $iscurrentuser, $course) {",
          "70:         }",
          "71:     }",
          "72: }",
          "",
          "[Removed Lines]",
          "61:     $context = \\context_user::instance($user->id);",
          "62:     if (\\core_analytics\\manager::check_can_list_insights($context, true)) {",
          "64:         $modelids = \\core_analytics\\manager::cached_models_with_insights($context);",
          "65:         if (!empty($modelids)) {",
          "66:             $url = new moodle_url('/report/insights/insights.php', array('contextid' => $context->id));",
          "67:             $node = new core_user\\output\\myprofile\\node('reports', 'insights', get_string('insights', 'report_insights'),",
          "68:                 null, $url);",
          "69:             $tree->add_node($node);",
          "",
          "[Added Lines]",
          "61:     if (\\core_analytics\\manager::is_analytics_enabled()) {",
          "62:         $context = \\context_user::instance($user->id);",
          "63:         if (\\core_analytics\\manager::check_can_list_insights($context, true)) {",
          "65:             $modelids = \\core_analytics\\manager::cached_models_with_insights($context);",
          "66:             if (!empty($modelids)) {",
          "67:                 $url = new moodle_url('/report/insights/insights.php', array('contextid' => $context->id));",
          "68:                 $node = new core_user\\output\\myprofile\\node('reports', 'insights', get_string('insights', 'report_insights'),",
          "69:                     null, $url);",
          "70:                 $tree->add_node($node);",
          "71:             }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "81: function report_insights_extend_navigation_category_settings($navigation, $context) {",
          "85:         $modelids = \\core_analytics\\manager::cached_models_with_insights($context);",
          "86:         if (!empty($modelids)) {",
          "",
          "[Removed Lines]",
          "83:     if (has_capability('moodle/analytics:listinsights', $context)) {",
          "",
          "[Added Lines]",
          "85:     if (\\core_analytics\\manager::is_analytics_enabled() && has_capability('moodle/analytics:listinsights', $context)) {",
          "",
          "---------------"
        ],
        "report/insights/prediction.php||report/insights/prediction.php": [
          "File: report/insights/prediction.php -> report/insights/prediction.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: $predictionid = required_param('id', PARAM_INT);",
          "30: list($model, $prediction, $context) = \\core_analytics\\manager::get_prediction($predictionid, true);",
          "31: if ($context->contextlevel < CONTEXT_COURSE) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: if (!\\core_analytics\\manager::is_analytics_enabled()) {",
          "31:     $PAGE->set_context(\\context_system::instance());",
          "32:     $renderer = $PAGE->get_renderer('report_insights');",
          "33:     echo $renderer->render_analytics_disabled();",
          "34:     exit(0);",
          "35: }",
          "",
          "---------------"
        ],
        "report/insights/settings.php||report/insights/settings.php": [
          "File: report/insights/settings.php -> report/insights/settings.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: defined('MOODLE_INTERNAL') || die;",
          "",
          "[Removed Lines]",
          "30: $ADMIN->add('reports', new admin_externalpage('reportinsights', get_string('insights', 'report_insights'),",
          "31:         $CFG->wwwroot . \"/report/insights/insights.php?contextid=\" . SYSCONTEXTID, 'moodle/analytics:listinsights'));",
          "34: $settings = null;",
          "",
          "[Added Lines]",
          "29: if (\\core_analytics\\manager::is_analytics_enabled()) {",
          "31:     $ADMIN->add('reports', new admin_externalpage('reportinsights', get_string('insights', 'report_insights'),",
          "32:             $CFG->wwwroot . \"/report/insights/insights.php?contextid=\" . SYSCONTEXTID, 'moodle/analytics:listinsights'));",
          "35:     $settings = null;",
          "36: }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019100800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019100800.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "33a388eff737c049786ee42d7430db549568471c",
      "candidate_info": {
        "commit_hash": "33a388eff737c049786ee42d7430db549568471c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/33a388eff737c049786ee42d7430db549568471c",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.7dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018120301.03;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev (Build: 20181210)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018121400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7dev (Build: 20181214)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81bbf426f6fde2ad6bc4736fb8f3e719ec9179ce",
      "candidate_info": {
        "commit_hash": "81bbf426f6fde2ad6bc4736fb8f3e719ec9179ce",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/81bbf426f6fde2ad6bc4736fb8f3e719ec9179ce",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018092700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180920)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018092700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180927)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d15b5340ccafa01801f6ffb20dbeab4fe04c1449",
      "candidate_info": {
        "commit_hash": "d15b5340ccafa01801f6ffb20dbeab4fe04c1449",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d15b5340ccafa01801f6ffb20dbeab4fe04c1449",
        "files": [
          "lang/en/admin.php",
          "lib/classes/task/question_cron_task.php",
          "lib/classes/task/question_preview_cleanup_task.php",
          "lib/classes/task/question_stats_cleanup_task.php",
          "lib/db/tasks.php",
          "lib/db/upgrade.php",
          "question/engine/bank.php",
          "question/engine/statisticslib.php",
          "question/previewlib.php",
          "question/tests/previewlib_test.php",
          "question/upgrade.txt",
          "version.php"
        ],
        "message": "Merge branch 'MDL-65050-master' of git://github.com/lameze/moodle",
        "before_after_code_files": [
          "lang/en/admin.php||lang/en/admin.php",
          "lib/classes/task/question_cron_task.php||lib/classes/task/question_cron_task.php",
          "lib/classes/task/question_preview_cleanup_task.php||lib/classes/task/question_preview_cleanup_task.php",
          "lib/classes/task/question_stats_cleanup_task.php||lib/classes/task/question_stats_cleanup_task.php",
          "lib/db/tasks.php||lib/db/tasks.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "question/engine/bank.php||question/engine/bank.php",
          "question/engine/statisticslib.php||question/engine/statisticslib.php",
          "question/previewlib.php||question/previewlib.php",
          "question/tests/previewlib_test.php||question/tests/previewlib_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lang/en/admin.php||lang/en/admin.php": [
          "File: lang/en/admin.php -> lang/en/admin.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1243: $string['taskplagiarismcron'] = 'Background processing for legacy cron in plagiarism plugins';",
          "1244: $string['taskportfoliocron'] = 'Background processing for portfolio plugins';",
          "1245: $string['taskprocessing'] = 'Task processing';",
          "1247: $string['taskrefreshsystemtokens'] = 'Refresh OAuth tokens for service accounts';",
          "1248: $string['taskregistrationcron'] = 'Site registration';",
          "1249: $string['tasksendfailedloginnotifications'] = 'Send failed login notifications';",
          "",
          "[Removed Lines]",
          "1246: $string['taskquestioncron'] = 'Background processing for question engine';",
          "",
          "[Added Lines]",
          "1246: $string['taskquestioncron'] = 'Background processing for cleaning up the old question previews';",
          "1247: $string['taskquestionstatscleanupcron'] = 'Background processing for cleaning up the old question statistics cache';",
          "",
          "---------------"
        ],
        "lib/classes/task/question_cron_task.php||lib/classes/task/question_cron_task.php": [
          "File: lib/classes/task/question_cron_task.php -> lib/classes/task/question_cron_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/classes/task/question_preview_cleanup_task.php||lib/classes/task/question_preview_cleanup_task.php": [
          "File: lib/classes/task/question_preview_cleanup_task.php -> lib/classes/task/question_preview_cleanup_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace core\\task;",
          "32: class question_preview_cleanup_task extends scheduled_task {",
          "39:     public function get_name() {",
          "40:         return get_string('taskquestioncron', 'admin');",
          "41:     }",
          "47:     public function execute() {",
          "50:         $lastmodifiedcutoff = time() - DAYSECS;",
          "52:         mtrace(\"\\n  Cleaning up old question previews...\", '');",
          "53:         $oldpreviews = new \\qubaid_join('{question_usages} quba', 'quba.id',",
          "54:             'quba.component = :qubacomponent",
          "55:                     AND NOT EXISTS (",
          "56:                         SELECT 1",
          "57:                           FROM {question_attempts}      subq_qa",
          "58:                           JOIN {question_attempt_steps} subq_qas ON subq_qas.questionattemptid = subq_qa.id",
          "59:                           JOIN {question_usages}        subq_qu  ON subq_qu.id = subq_qa.questionusageid",
          "60:                          WHERE subq_qa.questionusageid = quba.id",
          "61:                            AND subq_qu.component = :qubacomponent2",
          "62:                            AND (subq_qa.timemodified > :qamodifiedcutoff",
          "63:                                     OR subq_qas.timecreated > :stepcreatedcutoff)",
          "64:                     )",
          "65:             ',",
          "66:             ['qubacomponent' => 'core_question_preview', 'qubacomponent2' => 'core_question_preview',",
          "67:                 'qamodifiedcutoff' => $lastmodifiedcutoff, 'stepcreatedcutoff' => $lastmodifiedcutoff]);",
          "69:         \\question_engine::delete_questions_usage_by_activities($oldpreviews);",
          "70:         mtrace('done.');",
          "71:     }",
          "73: }",
          "",
          "---------------"
        ],
        "lib/classes/task/question_stats_cleanup_task.php||lib/classes/task/question_stats_cleanup_task.php": [
          "File: lib/classes/task/question_stats_cleanup_task.php -> lib/classes/task/question_stats_cleanup_task.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "24: namespace core\\task;",
          "26: defined('MOODLE_INTERNAL') || die();",
          "34: class question_stats_cleanup_task extends scheduled_task {",
          "41:     public function get_name() {",
          "42:         return get_string('taskquestionstatscleanupcron', 'admin');",
          "43:     }",
          "48:     public function execute() {",
          "49:         global $DB;",
          "51:         mtrace(\"\\n  Cleaning up old question statistics cache records...\", '');",
          "53:         $expiretime = time() - 5 * HOURSECS;",
          "54:         $DB->delete_records_select('question_statistics', 'timemodified < ?', [$expiretime]);",
          "55:         $responseanlysisids = $DB->get_records_select_menu('question_response_analysis',",
          "56:             'timemodified < ?',",
          "57:             [$expiretime],",
          "58:             'id',",
          "59:             'id, id AS id2');",
          "60:         $DB->delete_records_list('question_response_analysis', 'id', $responseanlysisids);",
          "61:         $DB->delete_records_list('question_response_count', 'analysisid', $responseanlysisids);",
          "63:         mtrace('done.');",
          "64:     }",
          "65: }",
          "",
          "---------------"
        ],
        "lib/db/tasks.php||lib/db/tasks.php": [
          "File: lib/db/tasks.php -> lib/db/tasks.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "213:         'month' => '*'",
          "214:     ),",
          "215:     array(",
          "217:         'blocking' => 0,",
          "218:         'minute' => '*',",
          "219:         'hour' => '*',",
          "",
          "[Removed Lines]",
          "216:         'classname' => 'core\\task\\question_cron_task',",
          "",
          "[Added Lines]",
          "216:         'classname' => 'core\\task\\question_preview_cleanup_task',",
          "217:         'blocking' => 0,",
          "218:         'minute' => '*',",
          "219:         'hour' => '*',",
          "220:         'day' => '*',",
          "221:         'dayofweek' => '*',",
          "222:         'month' => '*'",
          "223:     ),",
          "224:     array(",
          "225:         'classname' => 'core\\task\\question_stats_cleanup_task',",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2947:         upgrade_main_savepoint(true, 2019032900.00);",
          "2948:     }",
          "2950:     return true;",
          "2951: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2950:     if ($oldversion < 2019032900.01) {",
          "2951:         $sql = \"UPDATE {task_scheduled}",
          "2952:                    SET classname = ?",
          "2953:                  WHERE component = ?",
          "2954:                    AND classname = ?\";",
          "2955:         $DB->execute($sql, [",
          "2956:             '\\core\\task\\question_preview_cleanup_task',",
          "2957:             'moodle',",
          "2958:             '\\core\\task\\question_cron_task'",
          "2959:         ]);",
          "2962:         upgrade_main_savepoint(true, 2019032900.01);",
          "2963:     }",
          "",
          "---------------"
        ],
        "question/engine/bank.php||question/engine/bank.php": [
          "File: question/engine/bank.php -> question/engine/bank.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "408:         return self::$fractionoptionsfull;",
          "409:     }",
          "",
          "[Removed Lines]",
          "414:     public static function cron() {",
          "415:         global $CFG;",
          "418:         require_once($CFG->dirroot . '/question/previewlib.php');",
          "419:         question_preview_cron();",
          "422:         require_once($CFG->dirroot . '/question/engine/statisticslib.php');",
          "423:         question_usage_statistics_cron();",
          "424:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "question/engine/statisticslib.php||question/engine/statisticslib.php": [
          "File: question/engine/statisticslib.php -> question/engine/statisticslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "question/previewlib.php||question/previewlib.php": [
          "File: question/previewlib.php -> question/previewlib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "327:     redirect(question_preview_url($questionid, $displayoptions->behaviour,",
          "328:             $displayoptions->maxmark, $displayoptions, $displayoptions->variant, $context));",
          "329: }",
          "",
          "[Removed Lines]",
          "335: function question_preview_cron() {",
          "336:     $maxage = 24*60*60; // We delete previews that have not been touched for 24 hours.",
          "337:     $lastmodifiedcutoff = time() - $maxage;",
          "339:     mtrace(\"\\n  Cleaning up old question previews...\", '');",
          "340:     $oldpreviews = new qubaid_join('{question_usages} quba', 'quba.id',",
          "341:             'quba.component = :qubacomponent",
          "342:                     AND NOT EXISTS (",
          "343:                         SELECT 1",
          "344:                           FROM {question_attempts}      subq_qa",
          "345:                           JOIN {question_attempt_steps} subq_qas ON subq_qas.questionattemptid = subq_qa.id",
          "346:                           JOIN {question_usages}        subq_qu  ON subq_qu.id = subq_qa.questionusageid",
          "347:                          WHERE subq_qa.questionusageid = quba.id",
          "348:                            AND subq_qu.component = :qubacomponent2",
          "349:                            AND (subq_qa.timemodified > :qamodifiedcutoff",
          "350:                                     OR subq_qas.timecreated > :stepcreatedcutoff)",
          "351:                     )",
          "352:             ',",
          "353:             array('qubacomponent' => 'core_question_preview', 'qubacomponent2' => 'core_question_preview',",
          "354:                 'qamodifiedcutoff' => $lastmodifiedcutoff, 'stepcreatedcutoff' => $lastmodifiedcutoff));",
          "356:     question_engine::delete_questions_usage_by_activities($oldpreviews);",
          "357:     mtrace('done.');",
          "358: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "question/tests/previewlib_test.php||question/tests/previewlib_test.php": [
          "File: question/tests/previewlib_test.php -> question/tests/previewlib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019032900.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019032900.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6e8235c7d3957120f16f5b9d4df8ef1ec82558b5",
      "candidate_info": {
        "commit_hash": "6e8235c7d3957120f16f5b9d4df8ef1ec82558b5",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6e8235c7d3957120f16f5b9d4df8ef1ec82558b5",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018072500.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180720)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018072700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180727)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    }
  ]
}