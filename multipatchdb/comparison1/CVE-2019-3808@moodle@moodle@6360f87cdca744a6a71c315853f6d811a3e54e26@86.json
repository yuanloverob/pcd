{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5d61b3b331a87109fa53f6751340c8e11bc796a9",
      "candidate_info": {
        "commit_hash": "5d61b3b331a87109fa53f6751340c8e11bc796a9",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5d61b3b331a87109fa53f6751340c8e11bc796a9",
        "files": [
          "lib/db/messages.php",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-65219 message: default disable contact request notifications for web\n\nSet the default state to disabled for message contact request\nnotifications for the web process. The user is notified about contact\nrequests in the message drawer so it's unnecessary to also generate\na notification in the notification popover for them.",
        "before_after_code_files": [
          "lib/db/messages.php||lib/db/messages.php",
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/messages.php||lib/db/messages.php": [
          "File: lib/db/messages.php -> lib/db/messages.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "122:     'messagecontactrequests' => [",
          "123:         'defaults' => [",
          "125:             'email' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDOFF,",
          "126:             'airnotifier' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDIN + MESSAGE_DEFAULT_LOGGEDOFF,",
          "127:         ]",
          "",
          "[Removed Lines]",
          "124:             'popup' => MESSAGE_PERMITTED + MESSAGE_DEFAULT_LOGGEDIN + MESSAGE_DEFAULT_LOGGEDOFF,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3416:         upgrade_main_savepoint(true, 2019070400.01);",
          "3417:     }",
          "3419:     return true;",
          "3420: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3419:     if ($oldversion < 2019071800.01) {",
          "3421:         $oldloggedinconfig = get_config('message', 'message_provider_moodle_messagecontactrequests_loggedin');",
          "3422:         $oldloggedoffconfig = get_config('message', 'message_provider_moodle_messagecontactrequests_loggedoff');",
          "3423:         $newloggedinconfig = implode(',', array_filter(explode(',', $oldloggedinconfig), function($value) {",
          "3424:             return $value != 'popup';",
          "3425:         }));",
          "3426:         $newloggedoffconfig = implode(',', array_filter(explode(',', $oldloggedoffconfig), function($value) {",
          "3427:             return $value != 'popup';",
          "3428:         }));",
          "3429:         set_config('message_provider_moodle_messagecontactrequests_loggedin', $newloggedinconfig, 'message');",
          "3430:         set_config('message_provider_moodle_messagecontactrequests_loggedoff', $newloggedoffconfig, 'message');",
          "3432:         upgrade_main_savepoint(true, 2019071800.01);",
          "3433:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019071800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019071800.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cfde0b8d38061f370a5c21523c2188aca5a7160d",
      "candidate_info": {
        "commit_hash": "cfde0b8d38061f370a5c21523c2188aca5a7160d",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/cfde0b8d38061f370a5c21523c2188aca5a7160d",
        "files": [
          "lib/db/access.php",
          "version.php"
        ],
        "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
        "before_after_code_files": [
          "lib/db/access.php||lib/db/access.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ],
          "candidate": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/access.php||lib/db/access.php": [
          "File: lib/db/access.php -> lib/db/access.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1103:     ),",
          "1105:     'moodle/course:managegroups' => array(",
          "1107:         'captype' => 'write',",
          "1108:         'contextlevel' => CONTEXT_COURSE,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1106:         'riskbitmask' => RISK_XSS,",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2017111306.06;              // 20171113      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2017111306.07;              // 20171113      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9ca8ccbefc3e1f56621c866f3af69bdb6cc98a15",
      "candidate_info": {
        "commit_hash": "9ca8ccbefc3e1f56621c866f3af69bdb6cc98a15",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9ca8ccbefc3e1f56621c866f3af69bdb6cc98a15",
        "files": [
          "lib/db/access.php",
          "version.php"
        ],
        "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
        "before_after_code_files": [
          "lib/db/access.php||lib/db/access.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ],
          "candidate": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/access.php||lib/db/access.php": [
          "File: lib/db/access.php -> lib/db/access.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1113:     ),",
          "1115:     'moodle/course:managegroups' => array(",
          "1117:         'captype' => 'write',",
          "1118:         'contextlevel' => CONTEXT_COURSE,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1116:         'riskbitmask' => RISK_XSS,",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018051703.12;              // 20180517      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2018051703.13;              // 20180517      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "279df86c7f706c8e35f90f5b18e3fcfaa20d2f6e",
      "candidate_info": {
        "commit_hash": "279df86c7f706c8e35f90f5b18e3fcfaa20d2f6e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/279df86c7f706c8e35f90f5b18e3fcfaa20d2f6e",
        "files": [
          "lib/db/access.php",
          "version.php"
        ],
        "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
        "before_after_code_files": [
          "lib/db/access.php||lib/db/access.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ],
          "candidate": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/access.php||lib/db/access.php": [
          "File: lib/db/access.php -> lib/db/access.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1123:     ),",
          "1125:     'moodle/course:managegroups' => array(",
          "1127:         'captype' => 'write',",
          "1128:         'contextlevel' => CONTEXT_COURSE,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1126:         'riskbitmask' => RISK_XSS,",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018120301.05;              // 20181203      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2018120301.06;              // 20181203      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3d2783690da2281e5e360c40961cd6846e1dbbb8",
      "candidate_info": {
        "commit_hash": "3d2783690da2281e5e360c40961cd6846e1dbbb8",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/3d2783690da2281e5e360c40961cd6846e1dbbb8",
        "files": [
          "lib/db/access.php",
          "version.php"
        ],
        "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
        "before_after_code_files": [
          "lib/db/access.php||lib/db/access.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ],
          "candidate": [
            "lib/db/access.php||lib/db/access.php",
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/access.php||lib/db/access.php": [
          "File: lib/db/access.php -> lib/db/access.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1069:     ),",
          "1071:     'moodle/course:managegroups' => array(",
          "1073:         'captype' => 'write',",
          "1074:         'contextlevel' => CONTEXT_COURSE,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1072:         'riskbitmask' => RISK_XSS,",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2016052315.01;              // 20160523      = branching date YYYYMMDD - do not modify!",
          "",
          "[Added Lines]",
          "32: $version  = 2016052315.02;              // 20160523      = branching date YYYYMMDD - do not modify!",
          "",
          "---------------"
        ]
      }
    }
  ]
}