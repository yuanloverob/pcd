{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4bf08f5b4dc24843c0398932e5278985c249d583",
      "candidate_info": {
        "commit_hash": "4bf08f5b4dc24843c0398932e5278985c249d583",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/4bf08f5b4dc24843c0398932e5278985c249d583",
        "files": [
          "admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/classes/external.php",
          "admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php",
          "version.php"
        ],
        "message": "MDL-66775 tool_mobile: New force minimum app version setting",
        "before_after_code_files": [
          "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/classes/external.php||admin/tool/mobile/classes/external.php",
          "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php": [
          "File: admin/tool/mobile/classes/api.php -> admin/tool/mobile/classes/api.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "177:             'langmenu' => $CFG->langmenu,",
          "178:             'langlist' => $CFG->langlist,",
          "179:             'locale' => $CFG->locale,",
          "180:         );",
          "182:         $typeoflogin = get_config('tool_mobile', 'typeoflogin');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "180:             'tool_mobile_minimumversion' => get_config('tool_mobile', 'minimumversion'),",
          "",
          "---------------"
        ],
        "admin/tool/mobile/classes/external.php||admin/tool/mobile/classes/external.php": [
          "File: admin/tool/mobile/classes/external.php -> admin/tool/mobile/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "179:                 'langmenu' => new external_value(PARAM_INT, 'Whether the language menu should be displayed.', VALUE_OPTIONAL),",
          "180:                 'langlist' => new external_value(PARAM_RAW, 'Languages on language menu.', VALUE_OPTIONAL),",
          "181:                 'locale' => new external_value(PARAM_RAW, 'Sitewide locale.', VALUE_OPTIONAL),",
          "182:                 'warnings' => new external_warnings(),",
          "183:             )",
          "184:         );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "182:                 'tool_mobile_minimumversion' => new external_value(PARAM_NOTAGS, 'Minimum required version to access.',",
          "183:                     VALUE_OPTIONAL),",
          "",
          "---------------"
        ],
        "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php": [
          "File: admin/tool/mobile/lang/en/tool_mobile.php -> admin/tool/mobile/lang/en/tool_mobile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "75: $string['logininthebrowser'] = 'Via a browser window (for SSO plugins)';",
          "76: $string['loginintheembeddedbrowser'] = 'Via an embedded browser (for SSO plugins)';",
          "77: $string['mainmenu'] = 'Main menu';",
          "78: $string['mobileapp'] = 'Mobile app';",
          "79: $string['mobileappconnected'] = 'Mobile app connected';",
          "80: $string['mobileappenabled'] = 'This site has mobile app access enabled.<br /><a href=\"{$a}\">Download the mobile app</a>.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78: $string['minimumversion'] = 'Require users to upgrade their apps to the minimum version indicated. Those using previous versions of the app will not be able to access to the site. This works since app version 3.8.0 onward.';",
          "79: $string['minimumversion_key'] = 'Minimum app version required';",
          "",
          "---------------"
        ],
        "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php": [
          "File: admin/tool/mobile/settings.php -> admin/tool/mobile/settings.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:                     new lang_string('forcedurlscheme_key', 'tool_mobile'),",
          "66:                     new lang_string('forcedurlscheme', 'tool_mobile'), 'moodlemobile', PARAM_ALPHANUM));",
          "68:         $ADMIN->add('mobileapp', $temp);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:         $temp->add(new admin_setting_configtext('tool_mobile/minimumversion',",
          "69:                     new lang_string('minimumversion_key', 'tool_mobile'),",
          "70:                     new lang_string('minimumversion', 'tool_mobile'), '', PARAM_NOTAGS));",
          "",
          "---------------"
        ],
        "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php": [
          "File: admin/tool/mobile/tests/externallib_test.php -> admin/tool/mobile/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:             'langmenu' => $CFG->langmenu,",
          "96:             'langlist' => $CFG->langlist,",
          "97:             'locale' => $CFG->locale,",
          "98:             'warnings' => array()",
          "99:         );",
          "100:         $this->assertEquals($expected, $result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "98:             'tool_mobile_minimumversion' => '',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111:         set_config('autolang', 1);",
          "112:         set_config('lang', 'a_b');  // Set invalid lang.",
          "113:         set_config('disabledfeatures', 'myoverview', 'tool_mobile');",
          "115:         list($authinstructions, $notusedformat) = external_format_text($authinstructions, FORMAT_MOODLE, $context->id);",
          "116:         $expected['registerauth'] = 'email';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "115:         set_config('minimumversion', '3.8.0', 'tool_mobile');",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123:         $expected['autolang'] = '1';",
          "124:         $expected['lang'] = ''; // Expect empty because it was set to an invalid lang.",
          "125:         $expected['tool_mobile_disabledfeatures'] = 'myoverview';",
          "127:         if ($logourl = $OUTPUT->get_logo_url()) {",
          "128:             $expected['logourl'] = $logourl->out(false);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128:         $expected['tool_mobile_minimumversion'] = '3.8.0';",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019092700.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019092700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "89457b26d192c06325bb6782b85d1025dafbefe9",
      "candidate_info": {
        "commit_hash": "89457b26d192c06325bb6782b85d1025dafbefe9",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/89457b26d192c06325bb6782b85d1025dafbefe9",
        "files": [
          "version.php"
        ],
        "message": "Moodle release 3.7",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '37';                       // This version's branch.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019051600.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.7rc2 (Build: 20190516)'; // Human-friendly version name",
          "39: $maturity = MATURITY_RC;             // This version's maturity level.",
          "",
          "[Added Lines]",
          "32: $version  = 2019052000.00;              // 20190520      = branching date YYYYMMDD - do not modify!",
          "36: $release  = '3.7 (Build: 20190520)'; // Human-friendly version name",
          "39: $maturity = MATURITY_STABLE;             // This version's maturity level.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cd1bdc79464eb12f2c77f1cabd211eb27e0dd0c6",
      "candidate_info": {
        "commit_hash": "cd1bdc79464eb12f2c77f1cabd211eb27e0dd0c6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/cd1bdc79464eb12f2c77f1cabd211eb27e0dd0c6",
        "files": [
          "lib/db/upgrade.php",
          "lib/moodlelib.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-66551-master' of git://github.com/lameze/moodle",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "lib/moodlelib.php||lib/moodlelib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3519:         upgrade_main_savepoint(true, 2019083000.02);",
          "3520:     }",
          "3522:     return true;",
          "3523: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3522:     if ($oldversion < 2019083000.04) {",
          "3524:         $sql = \"SELECT DISTINCT es.userid",
          "3525:                   FROM {event_subscriptions} es",
          "3526:              LEFT JOIN {user} u ON u.id = es.userid",
          "3527:                  WHERE u.deleted = 1 OR u.id IS NULL\";",
          "3528:         $deletedusers = $DB->get_field_sql($sql);",
          "3529:         if ($deletedusers) {",
          "3530:             list($sql, $params) = $DB->get_in_or_equal($deletedusers);",
          "3533:             $DB->execute(\"DELETE FROM {event_subscriptions} WHERE userid \" . $sql, $params);",
          "3534:         }",
          "3536:         upgrade_main_savepoint(true, 2019083000.04);",
          "3537:     }",
          "",
          "---------------"
        ],
        "lib/moodlelib.php||lib/moodlelib.php": [
          "File: lib/moodlelib.php -> lib/moodlelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4251:     $DB->delete_records('cohort_members', array('userid' => $user->id));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4251:     $DB->delete_records('event_subscriptions', ['userid' => $user->id]);",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019083000.03;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019083000.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d842d9a90a76c1b3393d409f74e74eed385d4c65",
      "candidate_info": {
        "commit_hash": "d842d9a90a76c1b3393d409f74e74eed385d4c65",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d842d9a90a76c1b3393d409f74e74eed385d4c65",
        "files": [
          "lib/db/install.xml",
          "lib/db/upgrade.php",
          "version.php"
        ],
        "message": "MDL-63211 core: added new database tables\n\nAllow NULL values for timecreated in both message_contacts\nand message_users_blocked because there is existing data\nthat has no timecreated value associated with it.",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2399:         upgrade_main_savepoint(true, 2018092100.04);",
          "2400:     }",
          "2402:     return true;",
          "2403: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2403:     if ($oldversion < 2018092800.00) {",
          "2405:         $table = new xmldb_table('message_contacts');",
          "2408:         $index = new xmldb_index('userid-contactid', XMLDB_INDEX_UNIQUE, ['userid', 'contactid']);",
          "2409:         if ($dbman->index_exists($table, $index)) {",
          "2410:             $dbman->drop_index($table, $index);",
          "2411:         }",
          "2414:         $field = new xmldb_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'id');",
          "2415:         $dbman->change_field_default($table, $field);",
          "2417:         $field = new xmldb_field('contactid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'userid');",
          "2418:         $dbman->change_field_default($table, $field);",
          "2421:         $key = new xmldb_key('userid', XMLDB_KEY_FOREIGN, ['userid'], 'user', ['id']);",
          "2422:         $dbman->add_key($table, $key);",
          "2424:         $key = new xmldb_key('contactid', XMLDB_KEY_FOREIGN, ['contactid'], 'user', ['id']);",
          "2425:         $dbman->add_key($table, $key);",
          "2428:         if (!$dbman->index_exists($table, $index)) {",
          "2429:             $dbman->add_index($table, $index);",
          "2430:         }",
          "2433:         $field = new xmldb_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, null, null, null, 'blocked');",
          "2434:         if (!$dbman->field_exists($table, $field)) {",
          "2435:             $dbman->add_field($table, $field);",
          "2436:         }",
          "2439:         $table = new xmldb_table('message_contact_requests');",
          "2440:         $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null, null);",
          "2441:         $table->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'id');",
          "2442:         $table->add_field('requesteduserid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'userid');",
          "2443:         $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'requesteduserid');",
          "2445:         $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id'], null, null);",
          "2446:         $table->add_key('userid', XMLDB_KEY_FOREIGN, ['userid'], 'user', ['id']);",
          "2447:         $table->add_key('requesteduserid', XMLDB_KEY_FOREIGN, ['requesteduserid'], 'user', ['id']);",
          "2449:         $table->add_index('userid-requesteduserid', XMLDB_INDEX_UNIQUE, ['userid', 'requesteduserid']);",
          "2451:         if (!$dbman->table_exists($table)) {",
          "2452:             $dbman->create_table($table);",
          "2453:         }",
          "2456:         $table = new xmldb_table('message_users_blocked');",
          "2457:         $table->add_field('id', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, XMLDB_SEQUENCE, null, null);",
          "2458:         $table->add_field('userid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'id');",
          "2459:         $table->add_field('blockeduserid', XMLDB_TYPE_INTEGER, '10', null, XMLDB_NOTNULL, null, null, 'userid');",
          "2461:         $table->add_field('timecreated', XMLDB_TYPE_INTEGER, '10', null, null, null, null, 'blockeduserid');",
          "2463:         $table->add_key('primary', XMLDB_KEY_PRIMARY, ['id'], null, null);",
          "2464:         $table->add_key('userid', XMLDB_KEY_FOREIGN, ['userid'], 'user', ['id']);",
          "2465:         $table->add_key('blockeduserid', XMLDB_KEY_FOREIGN, ['blockeduserid'], 'user', ['id']);",
          "2467:         $table->add_index('userid-blockeduserid', XMLDB_INDEX_UNIQUE, ['userid', 'blockeduserid']);",
          "2469:         if (!$dbman->table_exists($table)) {",
          "2470:             $dbman->create_table($table);",
          "2471:         }",
          "2473:         upgrade_main_savepoint(true, 2018092800.00);",
          "2474:     }",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018092700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018092800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1c96922da587ed098fa0dd1feba30d6301e747e7",
      "candidate_info": {
        "commit_hash": "1c96922da587ed098fa0dd1feba30d6301e747e7",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1c96922da587ed098fa0dd1feba30d6301e747e7",
        "files": [
          "lib/setuplib.php",
          "version.php"
        ],
        "message": "MDL-31355 core: Bump $lastmajordbchanges to trigger upgrade immediately",
        "before_after_code_files": [
          "lib/setuplib.php||lib/setuplib.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setuplib.php||lib/setuplib.php": [
          "File: lib/setuplib.php -> lib/setuplib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1408: function is_major_upgrade_required() {",
          "1409:     global $CFG;",
          "1412:     $required = empty($CFG->version);",
          "1413:     $required = $required || (float)$CFG->version < $lastmajordbchanges;",
          "",
          "[Removed Lines]",
          "1410:     $lastmajordbchanges = 2019032900.00;",
          "",
          "[Added Lines]",
          "1410:     $lastmajordbchanges = 2019041000.01;",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019041000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019041000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}