{
  "cve_id": "CVE-2022-1996",
  "cve_desc": "Authorization Bypass Through User-Controlled Key in GitHub repository emicklei/go-restful prior to v3.8.0.",
  "repo": "emicklei/go-restful",
  "patch_hash": "fd3c327a379ce08c68ef18765bdc925f5d9bad10",
  "patch_info": {
    "commit_hash": "fd3c327a379ce08c68ef18765bdc925f5d9bad10",
    "repo": "emicklei/go-restful",
    "commit_url": "https://github.com/emicklei/go-restful/commit/fd3c327a379ce08c68ef18765bdc925f5d9bad10",
    "files": [
      "cors_filter.go",
      "cors_filter_test.go"
    ],
    "message": "use exact matching of allowed domain entries, issue #489 (#493)\n\n* use exact matching of allowed domain entries, issue #489\n\n* update doc, add testcases from PR conversation\n\n* introduce AllowedDomainFunc #489\n\n* more tests, fix doc\n\n* lowercase origin before checking cors",
    "before_after_code_files": [
      "cors_filter.go||cors_filter.go",
      "cors_filter_test.go||cors_filter_test.go"
    ]
  },
  "patch_diff": {
    "cors_filter.go||cors_filter.go": [
      "File: cors_filter.go -> cors_filter.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: type CrossOriginResourceSharing struct {",
      "24:  AllowedMethods []string",
      "25:  MaxAge         int // number of seconds before requiring new Options request",
      "26:  CookiesAllowed bool",
      "",
      "[Removed Lines]",
      "21:  ExposeHeaders  []string // list of Header names",
      "22:  AllowedHeaders []string // list of Header names",
      "23:  AllowedDomains []string // list of allowed values for Http Origin. An allowed value can be a regular expression to support subdomain matching. If empty all are allowed.",
      "",
      "[Added Lines]",
      "21:  ExposeHeaders []string // list of Header names",
      "25:  AllowedHeaders []string",
      "30:  AllowedDomains []string",
      "34:  AllowedDomainFunc func(origin string) bool",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "119:  if len(origin) == 0 {",
      "120:   return false",
      "121:  }",
      "122:  if len(c.AllowedDomains) == 0 {",
      "123:   return true",
      "124:  }",
      "127:  for _, domain := range c.AllowedDomains {",
      "131:   }",
      "132:  }",
      "149:  }",
      "152: }",
      "154: func (c CrossOriginResourceSharing) setAllowOriginHeader(req *Request, resp *Response) {",
      "",
      "[Removed Lines]",
      "126:  allowed := false",
      "128:   if domain == origin {",
      "129:    allowed = true",
      "130:    break",
      "134:  if !allowed {",
      "135:   if len(c.allowedOriginPatterns) == 0 {",
      "137:    allowedOriginRegexps, err := compileRegexps(c.AllowedDomains)",
      "138:    if err != nil {",
      "139:     return false",
      "140:    }",
      "141:    c.allowedOriginPatterns = allowedOriginRegexps",
      "142:   }",
      "144:   for _, pattern := range c.allowedOriginPatterns {",
      "145:    if allowed = pattern.MatchString(origin); allowed {",
      "146:     break",
      "147:    }",
      "148:   }",
      "151:  return allowed",
      "",
      "[Added Lines]",
      "135:  lowerOrigin := strings.ToLower(origin)",
      "137:   if c.AllowedDomainFunc != nil {",
      "138:    return c.AllowedDomainFunc(lowerOrigin)",
      "139:   }",
      "145:   if domain == \".*\" || strings.ToLower(domain) == lowerOrigin {",
      "146:    return true",
      "149:  if c.AllowedDomainFunc != nil {",
      "150:   return c.AllowedDomainFunc(origin)",
      "152:  return false",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "190:  }",
      "191:  return false",
      "192: }",
      "",
      "[Removed Lines]",
      "195: func compileRegexps(regexpStrings []string) ([]*regexp.Regexp, error) {",
      "196:  regexps := []*regexp.Regexp{}",
      "197:  for _, regexpStr := range regexpStrings {",
      "198:   r, err := regexp.Compile(regexpStr)",
      "199:   if err != nil {",
      "200:    return regexps, err",
      "201:   }",
      "202:   regexps = append(regexps, r)",
      "203:  }",
      "204:  return regexps, nil",
      "205: }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "cors_filter_test.go||cors_filter_test.go": [
      "File: cors_filter_test.go -> cors_filter_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "120:   DefaultContainer.Dispatch(httpWriter, httpRequest)",
      "121:   actual := httpWriter.Header().Get(HEADER_AccessControlAllowOrigin)",
      "122:   if actual != each.origin && each.allowed {",
      "124:   }",
      "125:   if actual == each.origin && !each.allowed {",
      "127:   }",
      "128:  }",
      "129: }",
      "",
      "[Removed Lines]",
      "123:    t.Fatal(\"expected to be accepted\")",
      "126:    t.Fatal(\"did not expect to be accepted\")",
      "",
      "[Added Lines]",
      "123:    t.Error(\"expected to be accepted\", each)",
      "126:    t.Error(\"did not expect to be accepted\")",
      "131: func TestCORSFilter_AllowedDomainFunc(t *testing.T) {",
      "132:  cors := CrossOriginResourceSharing{",
      "133:   AllowedDomains: []string{\"here\", \"there\"},",
      "134:   AllowedDomainFunc: func(origin string) bool {",
      "135:    return \"where\" == origin",
      "136:   },",
      "137:  }",
      "138:  if got, want := cors.isOriginAllowed(\"here\"), true; got != want {",
      "139:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "140:  }",
      "141:  if got, want := cors.isOriginAllowed(\"HERE\"), true; got != want {",
      "142:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "143:  }",
      "144:  if got, want := cors.isOriginAllowed(\"there\"), true; got != want {",
      "145:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "146:  }",
      "147:  if got, want := cors.isOriginAllowed(\"where\"), true; got != want {",
      "148:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "149:  }",
      "150:  if got, want := cors.isOriginAllowed(\"nowhere\"), false; got != want {",
      "151:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "152:  }",
      "154:  cors.AllowedDomains = []string{}",
      "155:  if got, want := cors.isOriginAllowed(\"here\"), false; got != want {",
      "156:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "157:  }",
      "158:  if got, want := cors.isOriginAllowed(\"where\"), true; got != want {",
      "159:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "160:  }",
      "162:  if got, want := cors.isOriginAllowed(\"\"), false; got != want {",
      "163:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
      "164:  }",
      "165: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "926662532deb450272956c7bc573978464aae74e",
      "candidate_info": {
        "commit_hash": "926662532deb450272956c7bc573978464aae74e",
        "repo": "emicklei/go-restful",
        "commit_url": "https://github.com/emicklei/go-restful/commit/926662532deb450272956c7bc573978464aae74e",
        "files": [
          "cors_filter.go",
          "cors_filter_test.go"
        ],
        "message": "use exact matching of allowed domain entries, issue #489 (#493) (#503)\n\n* use exact matching of allowed domain entries, issue #489\n\n* update doc, add testcases from PR conversation\n\n* introduce AllowedDomainFunc #489\n\n* more tests, fix doc\n\n* lowercase origin before checking cors\n\nCo-authored-by: Ernest Micklei <ernest.micklei@gmail.com>",
        "before_after_code_files": [
          "cors_filter.go||cors_filter.go",
          "cors_filter_test.go||cors_filter_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "cors_filter.go||cors_filter.go",
            "cors_filter_test.go||cors_filter_test.go"
          ],
          "candidate": [
            "cors_filter.go||cors_filter.go",
            "cors_filter_test.go||cors_filter_test.go"
          ]
        }
      },
      "candidate_diff": {
        "cors_filter.go||cors_filter.go": [
          "File: cors_filter.go -> cors_filter.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: type CrossOriginResourceSharing struct {",
          "24:  AllowedMethods []string",
          "25:  MaxAge         int // number of seconds before requiring new Options request",
          "26:  CookiesAllowed bool",
          "",
          "[Removed Lines]",
          "21:  ExposeHeaders  []string // list of Header names",
          "22:  AllowedHeaders []string // list of Header names",
          "23:  AllowedDomains []string // list of allowed values for Http Origin. An allowed value can be a regular expression to support subdomain matching. If empty all are allowed.",
          "",
          "[Added Lines]",
          "21:  ExposeHeaders []string // list of Header names",
          "25:  AllowedHeaders []string",
          "30:  AllowedDomains []string",
          "34:  AllowedDomainFunc func(origin string) bool",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "119:  if len(origin) == 0 {",
          "120:   return false",
          "121:  }",
          "122:  if len(c.AllowedDomains) == 0 {",
          "123:   return true",
          "124:  }",
          "127:  for _, domain := range c.AllowedDomains {",
          "131:   }",
          "132:  }",
          "149:  }",
          "152: }",
          "154: func (c CrossOriginResourceSharing) setAllowOriginHeader(req *Request, resp *Response) {",
          "",
          "[Removed Lines]",
          "126:  allowed := false",
          "128:   if domain == origin {",
          "129:    allowed = true",
          "130:    break",
          "134:  if !allowed {",
          "135:   if len(c.allowedOriginPatterns) == 0 {",
          "137:    allowedOriginRegexps, err := compileRegexps(c.AllowedDomains)",
          "138:    if err != nil {",
          "139:     return false",
          "140:    }",
          "141:    c.allowedOriginPatterns = allowedOriginRegexps",
          "142:   }",
          "144:   for _, pattern := range c.allowedOriginPatterns {",
          "145:    if allowed = pattern.MatchString(origin); allowed {",
          "146:     break",
          "147:    }",
          "148:   }",
          "151:  return allowed",
          "",
          "[Added Lines]",
          "135:  lowerOrigin := strings.ToLower(origin)",
          "137:   if c.AllowedDomainFunc != nil {",
          "138:    return c.AllowedDomainFunc(lowerOrigin)",
          "139:   }",
          "145:   if domain == \".*\" || strings.ToLower(domain) == lowerOrigin {",
          "146:    return true",
          "149:  if c.AllowedDomainFunc != nil {",
          "150:   return c.AllowedDomainFunc(origin)",
          "152:  return false",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "190:  }",
          "191:  return false",
          "192: }",
          "",
          "[Removed Lines]",
          "195: func compileRegexps(regexpStrings []string) ([]*regexp.Regexp, error) {",
          "196:  regexps := []*regexp.Regexp{}",
          "197:  for _, regexpStr := range regexpStrings {",
          "198:   r, err := regexp.Compile(regexpStr)",
          "199:   if err != nil {",
          "200:    return regexps, err",
          "201:   }",
          "202:   regexps = append(regexps, r)",
          "203:  }",
          "204:  return regexps, nil",
          "205: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "cors_filter_test.go||cors_filter_test.go": [
          "File: cors_filter_test.go -> cors_filter_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "120:   DefaultContainer.Dispatch(httpWriter, httpRequest)",
          "121:   actual := httpWriter.Header().Get(HEADER_AccessControlAllowOrigin)",
          "122:   if actual != each.origin && each.allowed {",
          "124:   }",
          "125:   if actual == each.origin && !each.allowed {",
          "127:   }",
          "128:  }",
          "129: }",
          "",
          "[Removed Lines]",
          "123:    t.Fatal(\"expected to be accepted\")",
          "126:    t.Fatal(\"did not expect to be accepted\")",
          "",
          "[Added Lines]",
          "123:    t.Error(\"expected to be accepted\", each)",
          "126:    t.Error(\"did not expect to be accepted\")",
          "131: func TestCORSFilter_AllowedDomainFunc(t *testing.T) {",
          "132:  cors := CrossOriginResourceSharing{",
          "133:   AllowedDomains: []string{\"here\", \"there\"},",
          "134:   AllowedDomainFunc: func(origin string) bool {",
          "135:    return \"where\" == origin",
          "136:   },",
          "137:  }",
          "138:  if got, want := cors.isOriginAllowed(\"here\"), true; got != want {",
          "139:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "140:  }",
          "141:  if got, want := cors.isOriginAllowed(\"HERE\"), true; got != want {",
          "142:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "143:  }",
          "144:  if got, want := cors.isOriginAllowed(\"there\"), true; got != want {",
          "145:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "146:  }",
          "147:  if got, want := cors.isOriginAllowed(\"where\"), true; got != want {",
          "148:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "149:  }",
          "150:  if got, want := cors.isOriginAllowed(\"nowhere\"), false; got != want {",
          "151:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "152:  }",
          "154:  cors.AllowedDomains = []string{}",
          "155:  if got, want := cors.isOriginAllowed(\"here\"), false; got != want {",
          "156:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "157:  }",
          "158:  if got, want := cors.isOriginAllowed(\"where\"), true; got != want {",
          "159:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "160:  }",
          "162:  if got, want := cors.isOriginAllowed(\"\"), false; got != want {",
          "163:   t.Errorf(\"got [%v:%T] want [%v:%T]\", got, got, want, want)",
          "164:  }",
          "165: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}