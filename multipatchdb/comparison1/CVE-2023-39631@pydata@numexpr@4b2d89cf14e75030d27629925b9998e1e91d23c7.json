{
  "cve_id": "CVE-2023-39631",
  "cve_desc": "An issue in LanChain-ai Langchain v.0.0.245 allows a remote attacker to execute arbitrary code via the evaluate function in the numexpr library.",
  "repo": "pydata/numexpr",
  "patch_hash": "4b2d89cf14e75030d27629925b9998e1e91d23c7",
  "patch_info": {
    "commit_hash": "4b2d89cf14e75030d27629925b9998e1e91d23c7",
    "repo": "pydata/numexpr",
    "commit_url": "https://github.com/pydata/numexpr/commit/4b2d89cf14e75030d27629925b9998e1e91d23c7",
    "files": [
      "numexpr/necompiler.py",
      "numexpr/tests/test_numexpr.py"
    ],
    "message": "Add in protections against call to `eval(expression)`",
    "before_after_code_files": [
      "numexpr/necompiler.py||numexpr/necompiler.py",
      "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
    ]
  },
  "patch_diff": {
    "numexpr/necompiler.py||numexpr/necompiler.py": [
      "File: numexpr/necompiler.py -> numexpr/necompiler.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "13: import sys",
      "14: import numpy",
      "15: import threading",
      "17: is_cpu_amd_intel = False # DEPRECATION WARNING: WILL BE REMOVED IN FUTURE RELEASE",
      "18: from numexpr import interpreter, expressions, use_vml",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "16: import re",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "259:     def __str__(self):",
      "260:         return 'Immediate(%d)' % (self.node.value,)",
      "263: def stringToExpression(s, types, context):",
      "264:     \"\"\"Given a string, convert it to a tree of ExpressionNode's.",
      "265:     \"\"\"",
      "266:     old_ctx = expressions._context.get_current_context()",
      "267:     try:",
      "268:         expressions._context.set_new_context(context)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "263: _forbidden_re = re.compile('[\\;[\\:]|__')",
      "267:     # sanitize the string for obvious attack vectors that NumExpr cannot",
      "268:     # parse into its homebrew AST. This is to protect the call to `eval` below.",
      "269:     # We forbid `;`, `:`. `[` and `__`",
      "270:     # We would like to forbid `.` but it is both a reference and decimal point.",
      "271:     if _forbidden_re.search(s) is not None:",
      "272:         raise ValueError(f'Expression {s} has forbidden control characters.')",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "612:     Returns a `NumExpr` object containing the compiled function.",
      "613:     \"\"\"",
      "617:     # In that case _frame_depth is wrong (it should be 2) but it doesn't matter",
      "618:     # since it will not be used (because truediv='auto' has already been",
      "619:     # translated to either True or False).",
      "",
      "[Removed Lines]",
      "614:     # NumExpr can be called either directly by the end-user, in which case",
      "615:     # kwargs need to be sanitized by getContext, or by evaluate,",
      "616:     # in which case kwargs are in already sanitized.",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "758: _names_cache = CacheDict(256)",
      "759: _numexpr_cache = CacheDict(256)",
      "760: _numexpr_last = {}",
      "762: evaluate_lock = threading.Lock()",
      "764: # MAYBE: decorate this function to add attributes instead of having the",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "769: _numexpr_sanity = set()",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "861:              out: numpy.ndarray = None,",
      "862:              order: str = 'K',",
      "863:              casting: str = 'safe',",
      "866:     \"\"\"",
      "867:     Evaluate a simple array expression element-wise using the virtual machine.",
      "",
      "[Removed Lines]",
      "864:              _frame_depth: int=3,",
      "",
      "[Added Lines]",
      "872:              _frame_depth: int = 3,",
      "",
      "---------------"
    ],
    "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
      "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "373:         a1 = array([1., 2., 3.])",
      "374:         b1 = array([4., 5., 6.])",
      "375:         c1 = array([7., 8., 9.])",
      "378:         assert_array_equal(x, array([86., 124., 168.]))",
      "380:     def test_validate(self):",
      "",
      "[Removed Lines]",
      "376:         x = evaluate(\"2*a + 3*b*c\", local_dict={'a': a1, 'b': b1, 'c': c1})",
      "377:         x = re_evaluate()",
      "",
      "[Added Lines]",
      "376:         local_dict={'a': a1, 'b': b1, 'c': c1}",
      "377:         x = evaluate(\"2*a + 3*b*c\", local_dict=local_dict)",
      "378:         x = re_evaluate(local_dict=local_dict)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "400:         a1 = array([1., 2., 3.])",
      "401:         b1 = array([4., 5., 6.])",
      "402:         c1 = array([7., 8., 9.])",
      "404:         assert(retval is None)",
      "406:         assert_array_equal(x, array([86., 124., 168.]))",
      "408:     # Test for issue #22",
      "",
      "[Removed Lines]",
      "403:         retval = validate(\"2*a + 3*b*c\", local_dict={'a': a1, 'b': b1, 'c': c1})",
      "405:         x = re_evaluate()",
      "",
      "[Added Lines]",
      "404:         local_dict={'a': a1, 'b': b1, 'c': c1}",
      "405:         retval = validate(\"2*a + 3*b*c\", local_dict=local_dict)",
      "407:         x = re_evaluate(local_dict=local_dict)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "502:         a = arange(3)",
      "503:         try:",
      "504:             evaluate(\"a < [0, 0, 0]\")",
      "506:             pass",
      "507:         else:",
      "508:             self.fail()",
      "510:     def test_disassemble(self):",
      "511:         assert_equal(disassemble(NumExpr(",
      "512:             \"where(m, a, -1)\", [('m', bool), ('a', float)])),",
      "",
      "[Removed Lines]",
      "505:         except TypeError:",
      "",
      "[Added Lines]",
      "507:         except (ValueError, TypeError):",
      "508:             pass",
      "509:         else:",
      "510:             self.fail()",
      "512:     def test_forbidden_tokens(self):",
      "513:         # Forbid dunder",
      "514:         try:",
      "515:             evaluate('__builtins__')",
      "516:         except ValueError:",
      "517:             pass",
      "518:         else:",
      "519:             self.fail()",
      "521:         # Forbid colon for lambda funcs",
      "522:         try:",
      "523:             evaluate('lambda x: x')",
      "524:         except ValueError:",
      "525:             pass",
      "526:         else:",
      "527:             self.fail()",
      "529:         # Forbid indexing",
      "530:         try:",
      "531:             evaluate('locals()[]')",
      "532:         except ValueError:",
      "537:         # Forbid semicolon",
      "538:         try:",
      "539:             evaluate('import os; os.cpu_count()')",
      "540:         except ValueError:",
      "541:             pass",
      "542:         else:",
      "543:             self.fail()",
      "545:         # I struggle to come up with cases for our ban on `'` and `\"`",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4f46368b45d3c749dccca3e5f5c65615a8f107c8",
      "candidate_info": {
        "commit_hash": "4f46368b45d3c749dccca3e5f5c65615a8f107c8",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/4f46368b45d3c749dccca3e5f5c65615a8f107c8",
        "files": [
          "numexpr/necompiler.py"
        ],
        "message": "allow digits after .",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "266: _flow_pat = r'[\\;\\[\\:]'",
          "267: _dunder_pat = r'__[\\w]+__'",
          "269: _blacklist_re = re.compile(f'{_flow_pat}|{_dunder_pat}|{_attr_pat}')",
          "271: def stringToExpression(s, types, context, sanitize: bool=True):",
          "",
          "[Removed Lines]",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|[eE]?[+-]?\\d+)\\b)'",
          "",
          "[Added Lines]",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|\\d*[eE]?[+-]?\\d+)\\b)'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "21ff376a0853aff6aea63343c6010d6434917319",
      "candidate_info": {
        "commit_hash": "21ff376a0853aff6aea63343c6010d6434917319",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/21ff376a0853aff6aea63343c6010d6434917319",
        "files": [
          "numexpr/necompiler.py"
        ],
        "message": "Add a `validate(...)` function that can be used to sansitize the expression and variables before starting the virtual machine.",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: #  rights to use.",
          "9: ####################################################################",
          "11: import __future__",
          "12: import sys",
          "13: import numpy",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11: from typing import Optional, Dict",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "527: ]",
          "531:     d = kwargs.copy()",
          "532:     context = {}",
          "533:     for name, allowed, default in context_info:",
          "",
          "[Removed Lines]",
          "530: def getContext(kwargs, frame_depth=1):",
          "",
          "[Added Lines]",
          "531: def getContext(kwargs, _frame_depth=1):",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "536:             context[name] = value",
          "537:         else:",
          "538:             raise ValueError(\"'%s' must be one of %s\" % (name, allowed))",
          "540:     if d:",
          "541:         raise ValueError(\"Unknown keyword argument '%s'\" % d.popitem()[0])",
          "542:     if context['truediv'] == 'auto':",
          "544:         context['truediv'] = caller_globals.get('division', None) == __future__.division",
          "546:     return context",
          "",
          "[Removed Lines]",
          "543:         caller_globals = sys._getframe(frame_depth + 1).f_globals",
          "",
          "[Added Lines]",
          "544:         caller_globals = sys._getframe(_frame_depth + 1).f_globals",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "614:     # NumExpr can be called either directly by the end-user, in which case",
          "615:     # kwargs need to be sanitized by getContext, or by evaluate,",
          "616:     # in which case kwargs are in already sanitized.",
          "618:     # since it will not be used (because truediv='auto' has already been",
          "619:     # translated to either True or False).",
          "622:     threeAddrProgram, inputsig, tempsig, constants, input_names = precompile(ex, signature, context)",
          "623:     program = compileThreeAddrForm(threeAddrProgram)",
          "624:     return interpreter.NumExpr(inputsig.encode('ascii'),",
          "",
          "[Removed Lines]",
          "617:     # In that case frame_depth is wrong (it should be 2) but it doesn't matter",
          "621:     context = getContext(kwargs, frame_depth=1)",
          "",
          "[Added Lines]",
          "618:     # In that case _frame_depth is wrong (it should be 2) but it doesn't matter",
          "621:     _frame_depth = 1",
          "622:     context = getContext(kwargs, _frame_depth=_frame_depth)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "718:     return [a.value for a in input_order], ex_uses_vml",
          "722:     \"\"\"",
          "723:     Get the arguments based on the names.",
          "724:     \"\"\"",
          "727:     clear_local_dict = False",
          "728:     if local_dict is None:",
          "",
          "[Removed Lines]",
          "721: def getArguments(names, local_dict=None, global_dict=None):",
          "725:     call_frame = sys._getframe(2)",
          "",
          "[Added Lines]",
          "722: def getArguments(names, local_dict=None, global_dict=None, _frame_depth: int=2):",
          "726:     call_frame = sys._getframe(_frame_depth)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "762: evaluate_lock = threading.Lock()",
          "766:     \"\"\"",
          "774:     Parameters",
          "775:     ----------",
          "778:         A dictionary that replaces the local operands in current frame.",
          "781:         A dictionary that replaces the global operands in current frame.",
          "784:         An existing array where the outcome is going to be stored.  Care is",
          "785:         required so that this array has the same shape and type than the",
          "786:         actual outcome of the computation.  Useful for avoiding unnecessary",
          "787:         new array allocations.",
          "790:         Controls the iteration order for operands. 'C' means C order, 'F'",
          "791:         means Fortran order, 'A' means 'F' order if all the arrays are",
          "792:         Fortran contiguous, 'C' order otherwise, and 'K' means as close to",
          "",
          "[Removed Lines]",
          "764: def evaluate(ex, local_dict=None, global_dict=None,",
          "765:              out=None, order='K', casting='safe', **kwargs):",
          "767:     Evaluate a simple array expression element-wise, using the new iterator.",
          "769:     ex is a string forming an expression, like \"2*a+3*b\". The values for \"a\"",
          "770:     and \"b\" will by default be taken from the calling function's frame",
          "771:     (through use of sys._getframe()). Alternatively, they can be specifed",
          "772:     using the 'local_dict' or 'global_dict' arguments.",
          "777:     local_dict : dictionary, optional",
          "780:     global_dict : dictionary, optional",
          "783:     out : NumPy array, optional",
          "789:     order : {'C', 'F', 'A', or 'K'}, optional",
          "",
          "[Added Lines]",
          "765: # MAYBE: decorate this function to add attributes instead of having the",
          "766: # _numexpr_last dictionary?",
          "767: def validate(ex: str,",
          "768:              local_dict: Optional[Dict] = None,",
          "769:              global_dict: Optional[Dict] = None,",
          "770:              out: numpy.ndarray = None,",
          "771:              order: str = 'K',",
          "772:              casting: str = 'safe',",
          "773:              _frame_depth: int = 2,",
          "776:     Returns",
          "780:     ex: str",
          "781:         a string forming an expression, like \"2*a+3*b\". The values for \"a\"",
          "782:         and \"b\" will by default be taken from the calling function's frame",
          "783:         (through use of sys._getframe()). Alternatively, they can be specified",
          "784:         using the 'local_dict' or 'global_dict' arguments.",
          "786:     local_dict: dictionary, optional",
          "789:     global_dict: dictionary, optional",
          "792:     out: NumPy array, optional",
          "798:     order: {'C', 'F', 'A', or 'K'}, optional",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "794:         efficient computations, typically 'K'eep order (the default) is",
          "795:         desired.",
          "798:         Controls what kind of data casting may occur when making a copy or",
          "799:         buffering.  Setting this to 'unsafe' is not recommended, as it can",
          "800:         adversely affect accumulations.",
          "",
          "[Removed Lines]",
          "797:     casting : {'no', 'equiv', 'safe', 'same_kind', 'unsafe'}, optional",
          "",
          "[Added Lines]",
          "806:     casting: {'no', 'equiv', 'safe', 'same_kind', 'unsafe'}, optional",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "806:             like float64 to float32, are allowed.",
          "808:     \"\"\"",
          "809:     global _numexpr_last",
          "827:     try:",
          "839:     \"\"\"",
          "840:     Re-evaluate the previous executed array expression without any check.",
          "",
          "[Removed Lines]",
          "810:     if not isinstance(ex, str):",
          "811:         raise ValueError(\"must specify expression as a string\")",
          "813:     # Get the names for this expression",
          "814:     context = getContext(kwargs, frame_depth=1)",
          "815:     expr_key = (ex, tuple(sorted(context.items())))",
          "816:     if expr_key not in _names_cache:",
          "817:         _names_cache[expr_key] = getExprNames(ex, context)",
          "818:     names, ex_uses_vml = _names_cache[expr_key]",
          "819:     arguments = getArguments(names, local_dict, global_dict)",
          "821:     # Create a signature",
          "822:     signature = [(name, getType(arg)) for (name, arg) in",
          "823:                  zip(names, arguments)]",
          "825:     # Look up numexpr if possible.",
          "826:     numexpr_key = expr_key + (tuple(signature),)",
          "828:         compiled_ex = _numexpr_cache[numexpr_key]",
          "829:     except KeyError:",
          "830:         compiled_ex = _numexpr_cache[numexpr_key] = NumExpr(ex, signature, **context)",
          "831:     kwargs = {'out': out, 'order': order, 'casting': casting,",
          "832:               'ex_uses_vml': ex_uses_vml}",
          "833:     _numexpr_last = dict(ex=compiled_ex, argnames=names, kwargs=kwargs)",
          "834:     with evaluate_lock:",
          "835:         return compiled_ex(*arguments, **kwargs)",
          "838: def re_evaluate(local_dict=None):",
          "",
          "[Added Lines]",
          "818:     _frame_depth: int",
          "819:         The calling frame depth. Unless you are a NumExpr developer you should",
          "820:         not set this value.",
          "826:         if not isinstance(ex, str):",
          "827:             raise ValueError(\"must specify expression as a string\")",
          "829:         # Get the names for this expression",
          "830:         context = getContext(kwargs)",
          "831:         expr_key = (ex, tuple(sorted(context.items())))",
          "832:         if expr_key not in _names_cache:",
          "833:             _names_cache[expr_key] = getExprNames(ex, context)",
          "834:         names, ex_uses_vml = _names_cache[expr_key]",
          "835:         arguments = getArguments(names, local_dict, global_dict, _frame_depth=_frame_depth)",
          "837:         # Create a signature",
          "838:         signature = [(name, getType(arg)) for (name, arg) in",
          "839:                     zip(names, arguments)]",
          "841:         # Look up numexpr if possible.",
          "842:         numexpr_key = expr_key + (tuple(signature),)",
          "843:         try:",
          "844:             compiled_ex = _numexpr_cache[numexpr_key]",
          "845:         except KeyError:",
          "846:             compiled_ex = _numexpr_cache[numexpr_key] = NumExpr(ex, signature, **context)",
          "847:         kwargs = {'out': out, 'order': order, 'casting': casting,",
          "848:                 'ex_uses_vml': ex_uses_vml}",
          "849:         _numexpr_last = dict(ex=compiled_ex, argnames=names, kwargs=kwargs)",
          "850:         # with evaluate_lock:",
          "851:         #     return compiled_ex(*arguments, **kwargs)",
          "852:     except Exception as e:",
          "853:         return e",
          "854:     return None",
          "856: def evaluate(ex: str,",
          "857:              local_dict: Optional[Dict] = None,",
          "858:              global_dict: Optional[Dict] = None,",
          "859:              out: numpy.ndarray = None,",
          "860:              order: str = 'K',",
          "861:              casting: str = 'safe',",
          "862:              _frame_depth: int=3,",
          "864:     \"\"\"",
          "865:     Evaluate a simple array expression element-wise using the virtual machine.",
          "867:     Parameters",
          "868:     ----------",
          "869:     ex: str",
          "870:         a string forming an expression, like \"2*a+3*b\". The values for \"a\"",
          "871:         and \"b\" will by default be taken from the calling function's frame",
          "872:         (through use of sys._getframe()). Alternatively, they can be specified",
          "873:         using the 'local_dict' or 'global_dict' arguments.",
          "875:     local_dict: dictionary, optional",
          "876:         A dictionary that replaces the local operands in current frame.",
          "878:     global_dict: dictionary, optional",
          "879:         A dictionary that replaces the global operands in current frame.",
          "881:     out: NumPy array, optional",
          "882:         An existing array where the outcome is going to be stored.  Care is",
          "883:         required so that this array has the same shape and type than the",
          "884:         actual outcome of the computation.  Useful for avoiding unnecessary",
          "885:         new array allocations.",
          "887:     order: {'C', 'F', 'A', or 'K'}, optional",
          "888:         Controls the iteration order for operands. 'C' means C order, 'F'",
          "889:         means Fortran order, 'A' means 'F' order if all the arrays are",
          "890:         Fortran contiguous, 'C' order otherwise, and 'K' means as close to",
          "891:         the order the array elements appear in memory as possible.  For",
          "892:         efficient computations, typically 'K'eep order (the default) is",
          "893:         desired.",
          "895:     casting: {'no', 'equiv', 'safe', 'same_kind', 'unsafe'}, optional",
          "896:         Controls what kind of data casting may occur when making a copy or",
          "897:         buffering.  Setting this to 'unsafe' is not recommended, as it can",
          "898:         adversely affect accumulations.",
          "904:             like float64 to float32, are allowed.",
          "907:     _frame_depth: int",
          "908:         The calling frame depth. Unless you are a NumExpr developer you should",
          "909:         not set this value.",
          "910:     \"\"\"",
          "911:     # We could avoid code duplication if we called validate and then re_evaluate",
          "912:     # here, but they we have difficulties with the `sys.getframe(2)` call in",
          "913:     # `getArguments`",
          "914:     e = validate(ex, local_dict=local_dict, global_dict=global_dict,",
          "915:                  out=out, order=order, casting=casting,",
          "916:                  _frame_depth=_frame_depth, **kwargs)",
          "917:     if e is None:",
          "918:         return re_evaluate(local_dict=local_dict, _frame_depth=_frame_depth)",
          "919:     else:",
          "920:         raise e",
          "926: def re_evaluate(local_dict: Optional[Dict] = None,",
          "927:                 _frame_depth: int=2) -> numpy.ndarray:",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "846:     Parameters",
          "847:     ----------",
          "850:         A dictionary that replaces the local operands in current frame.",
          "852:     \"\"\"",
          "853:     try:",
          "854:         compiled_ex = _numexpr_last['ex']",
          "855:     except KeyError:",
          "857:     argnames = _numexpr_last['argnames']",
          "859:     kwargs = _numexpr_last['kwargs']",
          "860:     with evaluate_lock:",
          "861:         return compiled_ex(*args, **kwargs)",
          "",
          "[Removed Lines]",
          "849:     local_dict : dictionary, optional",
          "856:         raise RuntimeError(\"not a previous evaluate() execution found\")",
          "858:     args = getArguments(argnames, local_dict)",
          "",
          "[Added Lines]",
          "937:     local_dict: dictionary, optional",
          "939:     _frame_depth: int",
          "940:         The calling frame depth. Unless you are a NumExpr developer you should",
          "941:         not set this value.",
          "943:     global _numexpr_last",
          "948:         raise RuntimeError(\"A previous evaluate() execution was not found, please call `validate` or `evaluate` once before `re_evaluate`\")",
          "950:     args = getArguments(argnames, local_dict, _frame_depth=_frame_depth)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "74d597398ba3c379c196e469d40f516de110eaa5",
      "candidate_info": {
        "commit_hash": "74d597398ba3c379c196e469d40f516de110eaa5",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/74d597398ba3c379c196e469d40f516de110eaa5",
        "files": [
          "numexpr/__init__.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Adding tests for `validate` and noticed that `re_evaluate` tests using `local_dict` argument are flawed and do not actually work",
        "before_after_code_files": [
          "numexpr/__init__.py||numexpr/__init__.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/__init__.py||numexpr/__init__.py": [
          "File: numexpr/__init__.py -> numexpr/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: import os, os.path",
          "32: import platform",
          "33: from numexpr.expressions import E",
          "36: from numexpr.utils import (_init_num_threads,",
          "37:     get_vml_version, set_vml_accuracy_mode, set_vml_num_threads,",
          "",
          "[Removed Lines]",
          "34: from numexpr.necompiler import NumExpr, disassemble, evaluate, re_evaluate",
          "",
          "[Added Lines]",
          "34: from numexpr.necompiler import (NumExpr, disassemble, evaluate, re_evaluate,",
          "35:     validate)",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: from numpy import shape, allclose, array_equal, ravel, isnan, isinf",
          "33: import numexpr",
          "35: from numexpr.expressions import ConstantNode",
          "37: import unittest",
          "",
          "[Removed Lines]",
          "34: from numexpr import E, NumExpr, evaluate, re_evaluate, disassemble, use_vml",
          "",
          "[Added Lines]",
          "34: from numexpr import E, NumExpr, evaluate, re_evaluate, validate, disassemble, use_vml",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "370:         assert_array_equal(x, array([86., 124., 168.]))",
          "372:     def test_re_evaluate_dict(self):",
          "373:         a = array([1., 2., 3.])",
          "374:         b = array([4., 5., 6.])",
          "375:         c = array([7., 8., 9.])",
          "377:         x = re_evaluate()",
          "378:         assert_array_equal(x, array([86., 124., 168.]))",
          "",
          "[Removed Lines]",
          "376:         x = evaluate(\"2*a + 3*b*c\", local_dict={'a': a, 'b': b, 'c': c})",
          "",
          "[Added Lines]",
          "373:         a1 = array([1., 2., 3.])",
          "374:         b1 = array([4., 5., 6.])",
          "375:         c1 = array([7., 8., 9.])",
          "376:         x = evaluate(\"2*a + 3*b*c\", local_dict={'a': a1, 'b': b1, 'c': c1})",
          "377:         x = re_evaluate()",
          "378:         assert_array_equal(x, array([86., 124., 168.]))",
          "380:     def test_validate(self):",
          "384:         retval = validate(\"2*a + 3*b*c\")",
          "385:         assert(retval is None)",
          "386:         x = re_evaluate()",
          "387:         assert_array_equal(x, array([86., 124., 168.]))",
          "389:     def test_validate_missing_var(self):",
          "390:         a = array([1., 2., 3.])",
          "391:         b = array([4., 5., 6.])",
          "392:         retval = validate(\"2*a + 3*b*c\")",
          "393:         assert(isinstance(retval, KeyError))",
          "395:     def test_validate_syntax(self):",
          "396:         retval = validate(\"2+\")",
          "397:         assert(isinstance(retval, SyntaxError))",
          "399:     def test_validate_dict(self):",
          "400:         a1 = array([1., 2., 3.])",
          "401:         b1 = array([4., 5., 6.])",
          "402:         c1 = array([7., 8., 9.])",
          "403:         retval = validate(\"2*a + 3*b*c\", local_dict={'a': a1, 'b': b1, 'c': c1})",
          "404:         assert(retval is None)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9b380aef71e2c7b8cdafd0e5f209f72ffc682b9f",
      "candidate_info": {
        "commit_hash": "9b380aef71e2c7b8cdafd0e5f209f72ffc682b9f",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/9b380aef71e2c7b8cdafd0e5f209f72ffc682b9f",
        "files": [
          "numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Add santize=True kwarg to `stringToExpression` and allow numbers with scientific notation",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "264: _flow_pat = r'[\\;\\[\\:]'",
          "265: _dunder_pat = r'__[\\w]+__'",
          "267: _blacklist_re = re.compile(f'{_flow_pat}|{_dunder_pat}|{_attr_pat}')",
          "270:     \"\"\"Given a string, convert it to a tree of ExpressionNode's.",
          "271:     \"\"\"",
          "272:     # sanitize the string for obvious attack vectors that NumExpr cannot",
          "",
          "[Removed Lines]",
          "266: _attr_pat = r'\\.\\b(?!(real|imag|\\d+)\\b)'",
          "269: def stringToExpression(s, types, context, sanitize: bool):",
          "",
          "[Added Lines]",
          "266: _attr_pat = r'\\.\\b(?!(real|imag|[eE]?[+-]?\\d+)\\b)'",
          "269: def stringToExpression(s, types, context, sanitize: bool=True):",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "509:         else:",
          "510:             self.fail()",
          "513:         # Forbid dunder",
          "514:         try:",
          "515:             evaluate('__builtins__')",
          "",
          "[Removed Lines]",
          "512:     def test_forbidden_tokens(self):",
          "",
          "[Added Lines]",
          "512:     def test_blacklist_tokens(self):",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "559:         else:",
          "560:             self.fail()",
          "563:         a = 3.0",
          "565:         evaluate('2.+a')",
          "567:         # pass .real and .imag",
          "568:         c = 2.5 + 1.5j",
          "569:         evaluate('c.real')",
          "570:         evaluate('c.imag')",
          "572:     def test_no_sanitize(self):",
          "573:         try: # Errors on compile() after eval()",
          "",
          "[Removed Lines]",
          "562:         # Pass decimal points",
          "564:         evaluate('a*2.')",
          "",
          "[Added Lines]",
          "562:         # Pass decimal points including scientific notation",
          "564:         evaluate('a*2e-5')",
          "565:         evaluate('a*2e+5')",
          "566:         evaluate('a*2E-5')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "71e4f7520b1409ff8c2d24412320b96f1f948996",
      "candidate_info": {
        "commit_hash": "71e4f7520b1409ff8c2d24412320b96f1f948996",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/71e4f7520b1409ff8c2d24412320b96f1f948996",
        "files": [
          "numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Add support for `NUMEXPR_SANITIZE=0` environment variable to turn off sanitization of evaluated strings.",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: from typing import Optional, Dict",
          "12: import __future__",
          "13: import sys",
          "15: import threading",
          "16: import re",
          "18: is_cpu_amd_intel = False # DEPRECATION WARNING: WILL BE REMOVED IN FUTURE RELEASE",
          "19: from numexpr import interpreter, expressions, use_vml",
          "20: from numexpr.utils import CacheDict",
          "",
          "[Removed Lines]",
          "14: import numpy",
          "",
          "[Added Lines]",
          "14: import os",
          "18: import numpy",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "784:              order: str = 'K',",
          "785:              casting: str = 'safe',",
          "786:              _frame_depth: int = 2,",
          "789:     r\"\"\"",
          "790:     Validate a NumExpr expression with the given `local_dict` or `locals()`.",
          "",
          "[Removed Lines]",
          "787:              sanitize: bool = True,",
          "",
          "[Added Lines]",
          "789:              sanitize: Optional[bool] = None,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "832:             like float64 to float32, are allowed.",
          "836:         Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "837:         potentially dangerous on unsanitized inputs. As such, NumExpr by default",
          "838:         performs simple sanitization, banning the character ':;[', the",
          "839:         dunder '__[\\w+]__', and attribute access to all but '.real' and '.imag'.",
          "841:     _frame_depth: int",
          "842:         The calling frame depth. Unless you are a NumExpr developer you should",
          "",
          "[Removed Lines]",
          "835:     sanitize: bool",
          "",
          "[Added Lines]",
          "837:     sanitize: Optional[bool]",
          "843:         Using `None` defaults to `True` unless the environment variable",
          "844:         `NUMEXPR_SANITIZE=0` is set, in which case the default is `False`.",
          "845:         Nominally this can be set via `os.environ` before `import numexpr`.",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "853:         if not isinstance(ex, str):",
          "854:             raise ValueError(\"must specify expression as a string\")",
          "856:         # Get the names for this expression",
          "857:         context = getContext(kwargs)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "862:         if sanitize is None:",
          "863:             if 'NUMEXPR_SANITIZE' in os.environ:",
          "864:                 sanitize = bool(int(os.environ['NUMEXPR_SANITIZE']))",
          "865:             else:",
          "866:                 sanitize = True",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "884:              out: numpy.ndarray = None,",
          "885:              order: str = 'K',",
          "886:              casting: str = 'safe',",
          "888:              _frame_depth: int = 3,",
          "890:     r\"\"\"",
          "",
          "[Removed Lines]",
          "887:              sanitize: bool = True,",
          "",
          "[Added Lines]",
          "899:              sanitize: Optional[bool] = None,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "936:         performs simple sanitization, banning the character ':;[', the",
          "937:         dunder '__[\\w+]__', and attribute access to all but '.real' and '.imag'.",
          "939:     _frame_depth: int",
          "940:         The calling frame depth. Unless you are a NumExpr developer you should",
          "941:         not set this value.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "951:         Using `None` defaults to `True` unless the environment variable",
          "952:         `NUMEXPR_SANITIZE=0` is set, in which case the default is `False`.",
          "953:         Nominally this can be set via `os.environ` before `import numexpr`.",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "509:         else:",
          "510:             self.fail()",
          "575:     def test_no_sanitize(self):",
          "",
          "[Removed Lines]",
          "512:     def test_blacklist_tokens(self):",
          "513:         # Forbid dunder",
          "514:         try:",
          "515:             evaluate('__builtins__')",
          "516:         except ValueError:",
          "517:             pass",
          "518:         else:",
          "519:             self.fail()",
          "521:         # Forbid colon for lambda funcs",
          "522:         try:",
          "523:             evaluate('lambda x: x')",
          "524:         except ValueError:",
          "525:             pass",
          "526:         else:",
          "527:             self.fail()",
          "529:         # Forbid indexing",
          "530:         try:",
          "531:             evaluate('locals()[\"evaluate\"]')",
          "532:         except ValueError:",
          "533:             pass",
          "534:         else:",
          "535:             self.fail()",
          "537:         # Forbid semicolon",
          "538:         try:",
          "539:             evaluate('import os;')",
          "540:         except ValueError:",
          "541:             pass",
          "542:         else:",
          "543:             self.fail()",
          "545:         # Attribute access with spaces",
          "546:         try:",
          "547:             evaluate('os. cpu_count()')",
          "548:         except ValueError:",
          "549:             pass",
          "550:         else:",
          "551:             self.fail()",
          "553:         # Attribute access with funny unicode characters that eval translates",
          "554:         # into ASCII.",
          "555:         try:",
          "556:             evaluate(\"(3+1).\u1d47it_length()\")",
          "557:         except ValueError:",
          "558:             pass",
          "559:         else:",
          "560:             self.fail()",
          "562:         # Pass decimal points including scientific notation",
          "563:         a = 3.0",
          "564:         evaluate('a*2e-5')",
          "565:         evaluate('a*2e+5')",
          "566:         evaluate('a*2E-5')",
          "567:         evaluate('2.+a')",
          "569:         # pass .real and .imag",
          "570:         c = 2.5 + 1.5j",
          "571:         evaluate('c.real')",
          "572:         evaluate('c.imag')",
          "",
          "[Added Lines]",
          "512:     def test_sanitize(self):",
          "513:         with _environment('NUMEXPR_SANITIZE', '1'):",
          "514:             print('Sanitize')",
          "515:             # Forbid dunder",
          "516:             try:",
          "517:                 evaluate('__builtins__')",
          "518:             except ValueError:",
          "519:                 pass",
          "520:             else:",
          "521:                 self.fail()",
          "523:             # Forbid colon for lambda funcs",
          "524:             try:",
          "525:                 evaluate('lambda x: x')",
          "526:             except ValueError:",
          "527:                 pass",
          "528:             else:",
          "529:                 self.fail()",
          "531:             # Forbid indexing",
          "532:             try:",
          "533:                 evaluate('locals()[\"evaluate\"]')",
          "534:             except ValueError:",
          "535:                 pass",
          "536:             else:",
          "537:                 self.fail()",
          "539:             # Forbid semicolon",
          "540:             try:",
          "541:                 evaluate('import os;')",
          "542:             except ValueError:",
          "543:                 pass",
          "544:             else:",
          "545:                 self.fail()",
          "547:             # Attribute access with spaces",
          "548:             try:",
          "549:                 evaluate('os. cpu_count()')",
          "550:             except ValueError:",
          "551:                 pass",
          "552:             else:",
          "553:                 self.fail()",
          "555:             # Attribute access with funny unicode characters that eval translates",
          "556:             # into ASCII.",
          "557:             try:",
          "558:                 evaluate(\"(3+1).\u1d47it_length()\")",
          "559:             except ValueError:",
          "560:                 pass",
          "561:             else:",
          "562:                 self.fail()",
          "564:             # Pass decimal points including scientific notation",
          "565:             a = 3.0",
          "566:             evaluate('a*2.e-5')",
          "567:             evaluate('a*2.e+5')",
          "568:             evaluate('a*2e-5')",
          "569:             evaluate('a*2e+5')",
          "570:             evaluate('a*2E-5')",
          "571:             evaluate('2.+a')",
          "573:             # pass .real and .imag",
          "574:             c = 2.5 + 1.5j",
          "575:             evaluate('c.real')",
          "576:             evaluate('c.imag')",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "580:         else:",
          "581:             self.fail()",
          "583:     def test_disassemble(self):",
          "584:         assert_equal(disassemble(NumExpr(",
          "585:             \"where(m, a, -1)\", [('m', bool), ('a', float)])),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "587:         with _environment('NUMEXPR_SANITIZE', '0'):",
          "588:             try: # Errors on compile() after eval()",
          "589:                 evaluate('import os;', sanitize=None)",
          "590:             except SyntaxError:",
          "591:                 pass",
          "592:             else:",
          "593:                 self.fail()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "58fbb6fcca476db0d06b7a8638fb2d869137115b",
      "candidate_info": {
        "commit_hash": "58fbb6fcca476db0d06b7a8638fb2d869137115b",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/58fbb6fcca476db0d06b7a8638fb2d869137115b",
        "files": [
          "numexpr/necompiler.py"
        ],
        "message": "sanitization: reduce unnecessary rejections",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "266: _flow_pat = r'[\\;\\[\\:]'",
          "269: _blacklist_re = re.compile(f'{_flow_pat}|{_dunder_pat}|{_attr_pat}')",
          "271: def stringToExpression(s, types, context, sanitize: bool=True):",
          "",
          "[Removed Lines]",
          "267: _dunder_pat = r'__[\\w]+__'",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|[eE]?[+-]?\\d+)\\b)'",
          "",
          "[Added Lines]",
          "267: _dunder_pat = r'(^|[^\\w])__[\\w]+__($|[^\\w])'",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|\\d*[eE]?[+-]?\\d+)\\b)'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "397cc98359301d0e7b96aaa6d3c79419d1d4f189",
      "candidate_info": {
        "commit_hash": "397cc98359301d0e7b96aaa6d3c79419d1d4f189",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/397cc98359301d0e7b96aaa6d3c79419d1d4f189",
        "files": [
          "numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Add in argument to validate/evaluate for whether to sanitize or not; also improves blacklist to only match proper dunders and not '__' and also better matching against unicode",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "261:         return 'Immediate(%d)' % (self.node.value,)",
          "266:     \"\"\"Given a string, convert it to a tree of ExpressionNode's.",
          "267:     \"\"\"",
          "268:     # sanitize the string for obvious attack vectors that NumExpr cannot",
          "269:     # parse into its homebrew AST. This is to protect the call to `eval` below.",
          "270:     # We forbid `;`, `:`. `[` and `__`, and attribute access via '.'.",
          "271:     # We cannot ban `.real` or `.imag` however...",
          "276:     old_ctx = expressions._context.get_current_context()",
          "277:     try:",
          "",
          "[Removed Lines]",
          "264: _forbidden_re = re.compile('[\\;[\\:]|__|\\.[abcdefghjklmnopqstuvwxyzA-Z_]')",
          "265: def stringToExpression(s, types, context):",
          "272:     no_whitespace = re.sub(r'\\s+', '', s)",
          "273:     if _forbidden_re.search(no_whitespace) is not None:",
          "274:         raise ValueError(f'Expression {s} has forbidden control characters.')",
          "",
          "[Added Lines]",
          "264: _flow_pat = r'[\\;\\[\\:]'",
          "265: _dunder_pat = r'__[\\w]+__'",
          "266: _attr_pat = r'\\.\\b(?!(real|imag|\\d+)\\b)'",
          "267: _blacklist_re = re.compile(f'{_flow_pat}|{_dunder_pat}|{_attr_pat}')",
          "269: def stringToExpression(s, types, context, sanitize: bool):",
          "276:     if sanitize:",
          "277:         no_whitespace = re.sub(r'\\s+', '', s)",
          "278:         if _blacklist_re.search(no_whitespace) is not None:",
          "279:             raise ValueError(f'Expression {s} has forbidden control characters.')",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "558:     return context",
          "562:     \"\"\"",
          "563:     Compile the expression to an intermediate form.",
          "564:     \"\"\"",
          "",
          "[Removed Lines]",
          "561: def precompile(ex, signature=(), context={}):",
          "",
          "[Added Lines]",
          "566: def precompile(ex, signature=(), context={}, sanitize: bool=True):",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "566:     input_order = [name for (name, type_) in signature]",
          "568:     if isinstance(ex, str):",
          "571:     # the AST is like the expression, but the node objects don't have",
          "572:     # any odd interpretations",
          "",
          "[Removed Lines]",
          "569:         ex = stringToExpression(ex, types, context)",
          "",
          "[Added Lines]",
          "574:         ex = stringToExpression(ex, types, context, sanitize)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "612:     return threeAddrProgram, signature, tempsig, constants, input_names",
          "616:     \"\"\"",
          "617:     Compile an expression built using E.<variable> variables to a function.",
          "",
          "[Removed Lines]",
          "615: def NumExpr(ex, signature=(), **kwargs):",
          "",
          "[Added Lines]",
          "620: def NumExpr(ex,  signature=(), sanitize: bool=True, **kwargs):",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "629:     # translated to either True or False).",
          "630:     _frame_depth = 1",
          "631:     context = getContext(kwargs, _frame_depth=_frame_depth)",
          "633:     program = compileThreeAddrForm(threeAddrProgram)",
          "634:     return interpreter.NumExpr(inputsig.encode('ascii'),",
          "635:                                tempsig.encode('ascii'),",
          "",
          "[Removed Lines]",
          "632:     threeAddrProgram, inputsig, tempsig, constants, input_names = precompile(ex, signature, context)",
          "",
          "[Added Lines]",
          "637:     threeAddrProgram, inputsig, tempsig, constants, input_names = precompile(ex, signature, context, sanitize=sanitize)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "710:     raise ValueError(\"unknown type %s\" % a.dtype.name)",
          "715:     ast = expressionToAST(ex)",
          "716:     input_order = getInputOrder(ast, None)",
          "717:     #try to figure out if vml operations are used by expression",
          "",
          "[Removed Lines]",
          "713: def getExprNames(text, context):",
          "714:     ex = stringToExpression(text, {}, context)",
          "",
          "[Added Lines]",
          "718: def getExprNames(text, context, sanitize: bool=True):",
          "719:     ex = stringToExpression(text, {}, context, sanitize)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "779:              order: str = 'K',",
          "780:              casting: str = 'safe',",
          "781:              _frame_depth: int = 2,",
          "783:     \"\"\"",
          "784:     Validate a NumExpr expression with the given `local_dict` or `locals()`.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "787:              sanitize: bool = True,",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "826:             like float64 to float32, are allowed.",
          "829:     _frame_depth: int",
          "830:         The calling frame depth. Unless you are a NumExpr developer you should",
          "831:         not set this value.",
          "833:     Note",
          "834:     ----",
          "839:     \"\"\"",
          "840:     global _numexpr_last",
          "",
          "[Removed Lines]",
          "835:     Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "836:     potentially dangerous on unsanitized inputs. As such, NumExpr does some",
          "837:     sanitization, banning the character ':;[', the dunder '__', and attribute",
          "838:     access to all but '.r' for real and '.i' for imag access to complex numbers.",
          "",
          "[Added Lines]",
          "835:     sanitize: bool",
          "836:         Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "837:         potentially dangerous on unsanitized inputs. As such, NumExpr by default",
          "838:         performs simple sanitization, banning the character ':;[', the",
          "839:         dunder '__[\\w+]__', and attribute access to all but '.real' and '.imag'.",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "848:         context = getContext(kwargs)",
          "849:         expr_key = (ex, tuple(sorted(context.items())))",
          "850:         if expr_key not in _names_cache:",
          "852:         names, ex_uses_vml = _names_cache[expr_key]",
          "853:         arguments = getArguments(names, local_dict, global_dict, _frame_depth=_frame_depth)",
          "",
          "[Removed Lines]",
          "851:             _names_cache[expr_key] = getExprNames(ex, context)",
          "",
          "[Added Lines]",
          "860:             _names_cache[expr_key] = getExprNames(ex, context, sanitize=sanitize)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "861:         try:",
          "862:             compiled_ex = _numexpr_cache[numexpr_key]",
          "863:         except KeyError:",
          "865:         kwargs = {'out': out, 'order': order, 'casting': casting,",
          "866:                 'ex_uses_vml': ex_uses_vml}",
          "867:         _numexpr_last = dict(ex=compiled_ex, argnames=names, kwargs=kwargs)",
          "",
          "[Removed Lines]",
          "864:             compiled_ex = _numexpr_cache[numexpr_key] = NumExpr(ex, signature, **context)",
          "",
          "[Added Lines]",
          "873:             compiled_ex = _numexpr_cache[numexpr_key] = NumExpr(ex, signature, sanitize=sanitize, **context)",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "875:              out: numpy.ndarray = None,",
          "876:              order: str = 'K',",
          "877:              casting: str = 'safe',",
          "878:              _frame_depth: int = 3,",
          "880:     \"\"\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "887:              sanitize: bool = True,",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "920:             like float64 to float32, are allowed.",
          "923:     _frame_depth: int",
          "924:         The calling frame depth. Unless you are a NumExpr developer you should",
          "925:         not set this value.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "933:     sanitize: bool",
          "934:         Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "935:         potentially dangerous on unsanitized inputs. As such, NumExpr by default",
          "936:         performs simple sanitization, banning the character ':;[', the",
          "937:         dunder '__[\\w+]__', and attribute access to all but '.real' and '.imag'.",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "936:     # `getArguments`",
          "937:     e = validate(ex, local_dict=local_dict, global_dict=global_dict,",
          "938:                  out=out, order=order, casting=casting,",
          "940:     if e is None:",
          "941:         return re_evaluate(local_dict=local_dict, _frame_depth=_frame_depth)",
          "942:     else:",
          "",
          "[Removed Lines]",
          "939:                  _frame_depth=_frame_depth, **kwargs)",
          "",
          "[Added Lines]",
          "955:                  _frame_depth=_frame_depth, sanitize=sanitize, **kwargs)",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "529:         # Forbid indexing",
          "530:         try:",
          "532:         except ValueError:",
          "533:             pass",
          "534:         else:",
          "",
          "[Removed Lines]",
          "531:             evaluate('locals()[]')",
          "",
          "[Added Lines]",
          "531:             evaluate('locals()[\"evaluate\"]')",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "542:         else:",
          "543:             self.fail()",
          "546:         try:",
          "548:         except ValueError:",
          "549:             pass",
          "550:         else:",
          "551:             self.fail()",
          "554:         a = 3.0",
          "555:         evaluate('a*2.')",
          "556:         evaluate('2.+a')",
          "564:     def test_disassemble(self):",
          "565:         assert_equal(disassemble(NumExpr(",
          "",
          "[Removed Lines]",
          "545:         # Attribute access",
          "547:             evaluate('os.cpucount()')",
          "553:         # But decimal point must pass",
          "",
          "[Added Lines]",
          "545:         # Attribute access with spaces",
          "547:             evaluate('os. cpu_count()')",
          "553:         # Attribute access with funny unicode characters that eval translates",
          "554:         # into ASCII.",
          "555:         try:",
          "556:             evaluate(\"(3+1).\u1d47it_length()\")",
          "557:         except ValueError:",
          "558:             pass",
          "559:         else:",
          "560:             self.fail()",
          "562:         # Pass decimal points",
          "567:         # pass .real and .imag",
          "568:         c = 2.5 + 1.5j",
          "569:         evaluate('c.real')",
          "570:         evaluate('c.imag')",
          "572:     def test_no_sanitize(self):",
          "573:         try: # Errors on compile() after eval()",
          "574:             evaluate('import os;', sanitize=False)",
          "575:         except SyntaxError:",
          "576:             pass",
          "577:         else:",
          "578:             self.fail()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bf9d34a907442bd134fa330e8c1b6bbc336a67a8",
      "candidate_info": {
        "commit_hash": "bf9d34a907442bd134fa330e8c1b6bbc336a67a8",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/bf9d34a907442bd134fa330e8c1b6bbc336a67a8",
        "files": [
          "numexpr/necompiler.py"
        ],
        "message": "fix sanitizer forbid usage of \\d+.\\d*j",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "266: _flow_pat = r'[\\;\\[\\:]'",
          "267: _dunder_pat = r'(^|[^\\w])__[\\w]+__($|[^\\w])'",
          "269: _blacklist_re = re.compile(f'{_flow_pat}|{_dunder_pat}|{_attr_pat}')",
          "271: def stringToExpression(s, types, context, sanitize: bool=True):",
          "",
          "[Removed Lines]",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|\\d*[eE]?[+-]?\\d+)\\b)'",
          "",
          "[Added Lines]",
          "268: _attr_pat = r'\\.\\b(?!(real|imag|(\\d*[eE]?[+-]?\\d+)|\\d*j)\\b)'",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "275:     # parse into its homebrew AST. This is to protect the call to `eval` below.",
          "276:     # We forbid `;`, `:`. `[` and `__`, and attribute access via '.'.",
          "277:     # We cannot ban `.real` or `.imag` however...",
          "278:     if sanitize:",
          "279:         no_whitespace = re.sub(r'\\s+', '', s)",
          "280:         if _blacklist_re.search(no_whitespace) is not None:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "278:     # We also cannot ban `.\\d*j`, where `\\d*` is some digits (or none), e.g. 1.5j, 1.j",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "00b035c78ca5ac209b58b56b5dcc99596cac423c",
      "candidate_info": {
        "commit_hash": "00b035c78ca5ac209b58b56b5dcc99596cac423c",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/00b035c78ca5ac209b58b56b5dcc99596cac423c",
        "files": [
          "ANNOUNCE.rst",
          "RELEASE_NOTES.rst",
          "doc/user_guide.rst",
          "numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Make more difficult sanitize of the expression string before eval",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "260:     def __str__(self):",
          "261:         return 'Immediate(%d)' % (self.node.value,)",
          "264: def stringToExpression(s, types, context):",
          "265:     \"\"\"Given a string, convert it to a tree of ExpressionNode's.",
          "266:     \"\"\"",
          "267:     # sanitize the string for obvious attack vectors that NumExpr cannot",
          "268:     # parse into its homebrew AST. This is to protect the call to `eval` below.",
          "272:         raise ValueError(f'Expression {s} has forbidden control characters.')",
          "274:     old_ctx = expressions._context.get_current_context()",
          "",
          "[Removed Lines]",
          "263: _forbidden_re = re.compile('[\\;[\\:]|__')",
          "269:     # We forbid `;`, `:`. `[` and `__`",
          "270:     # We would like to forbid `.` but it is both a reference and decimal point.",
          "271:     if _forbidden_re.search(s) is not None:",
          "",
          "[Added Lines]",
          "264: _forbidden_re = re.compile('[\\;[\\:]|__|\\.[abcdefghjklmnopqstuvwxyzA-Z_]')",
          "270:     # We forbid `;`, `:`. `[` and `__`, and attribute access via '.'.",
          "271:     # We cannot ban `.real` or `.imag` however...",
          "272:     no_whitespace = re.sub(r'\\s+', '', s)",
          "273:     if _forbidden_re.search(no_whitespace) is not None:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "766: _names_cache = CacheDict(256)",
          "767: _numexpr_cache = CacheDict(256)",
          "768: _numexpr_last = {}",
          "770: evaluate_lock = threading.Lock()",
          "772: # MAYBE: decorate this function to add attributes instead of having the",
          "",
          "[Removed Lines]",
          "769: _numexpr_sanity = set()",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "828:     _frame_depth: int",
          "829:         The calling frame depth. Unless you are a NumExpr developer you should",
          "830:         not set this value.",
          "831:     \"\"\"",
          "832:     global _numexpr_last",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "833:     Note",
          "834:     ----",
          "835:     Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "836:     potentially dangerous on unsanitized inputs. As such, NumExpr does some",
          "837:     sanitization, banning the character ':;[', the dunder '__', and attribute",
          "838:     access to all but '.r' for real and '.i' for imag access to complex numbers.",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "857:         kwargs = {'out': out, 'order': order, 'casting': casting,",
          "858:                 'ex_uses_vml': ex_uses_vml}",
          "859:         _numexpr_last = dict(ex=compiled_ex, argnames=names, kwargs=kwargs)",
          "862:     except Exception as e:",
          "863:         return e",
          "864:     return None",
          "",
          "[Removed Lines]",
          "860:         # with evaluate_lock:",
          "861:         #     return compiled_ex(*arguments, **kwargs)",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "918:         The calling frame depth. Unless you are a NumExpr developer you should",
          "919:         not set this value.",
          "922:     \"\"\"",
          "923:     # We could avoid code duplication if we called validate and then re_evaluate",
          "924:     # here, but they we have difficulties with the `sys.getframe(2)` call in",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "927:     Note",
          "928:     ----",
          "929:     Both `validate` and by extension `evaluate` call `eval(ex)`, which is",
          "930:     potentially dangerous on unsanitized inputs. As such, NumExpr does some",
          "931:     sanitization, banning the character ':;[', the dunder '__', and attribute",
          "932:     access to all but '.r' for real and '.i' for imag access to complex numbers.",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "537:         # Forbid semicolon",
          "538:         try:",
          "540:         except ValueError:",
          "541:             pass",
          "542:         else:",
          "543:             self.fail()",
          "",
          "[Removed Lines]",
          "539:             evaluate('import os; os.cpu_count()')",
          "545:         # I struggle to come up with cases for our ban on `'` and `\"`",
          "",
          "[Added Lines]",
          "539:             evaluate('import os;')",
          "545:         # Attribute access",
          "546:         try:",
          "547:             evaluate('os.cpucount()')",
          "548:         except ValueError:",
          "549:             pass",
          "550:         else:",
          "551:             self.fail()",
          "553:         # But decimal point must pass",
          "554:         a = 3.0",
          "555:         evaluate('a*2.')",
          "556:         evaluate('2.+a')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e894e08371195e69e92c797f46a2aeafdbe8f9a7",
      "candidate_info": {
        "commit_hash": "e894e08371195e69e92c797f46a2aeafdbe8f9a7",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/e894e08371195e69e92c797f46a2aeafdbe8f9a7",
        "files": [
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "Fix some warnings with modern pytest",
        "before_after_code_files": [
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "319:     def test_locals_clears_globals(self):",
          "320:         # Check for issue #313, whereby clearing f_locals also clear f_globals",
          "322:         # executing code in a child frame.",
          "323:         script = r';'.join([",
          "324:                 r\"import numexpr as ne\",",
          "",
          "[Removed Lines]",
          "321:         # if in the top-frame. This cannot be done inside `unittest` as it is always",
          "",
          "[Added Lines]",
          "321:         # if in the top-frame. This cannot be done inside `unittest` as it is always",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "334:             ])",
          "335:         # Raises CalledProcessError on a non-normal exit",
          "336:         check = subprocess.check_call([sys.executable, '-c', script])",
          "338:         # a requirement.",
          "",
          "[Removed Lines]",
          "337:         # Ideally this test should also be done against ipython but it's not",
          "",
          "[Added Lines]",
          "337:         # Ideally this test should also be done against ipython but it's not",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "521:                 self.fail()",
          "523:             # Forbid colon for lambda funcs",
          "525:                 evaluate('lambda x: x')",
          "526:             except ValueError:",
          "527:                 pass",
          "",
          "[Removed Lines]",
          "524:             try:",
          "",
          "[Added Lines]",
          "524:             try:",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "605:     def test_disassemble(self):",
          "606:         assert_equal(disassemble(NumExpr(",
          "607:             \"where(m, a, -1)\", [('m', bool), ('a', float)])),",
          "609:              [b'noop', None, None, None]])",
          "611:     def test_constant_deduplication(self):",
          "",
          "[Removed Lines]",
          "608:             [[b'where_fbff', b'r0', b'r1[m]', b'r2[a]', b'c3[-1.0]'],",
          "",
          "[Added Lines]",
          "608:             [[b'where_fbff', b'r0', b'r1[m]', b'r2[a]', b'c3[-1.0]'],",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "624:         assert_equal(ConstantNode(numpy.float32(1)).astKind, \"float\")",
          "625:         assert_equal(ConstantNode(numpy.float32(\"nan\")).astKind, \"float\")",
          "626:         assert_equal(ConstantNode(numpy.float32(3)).value.dtype, numpy.dtype(\"float32\"))",
          "628:                            numpy.array(1, dtype=\"float32\"))",
          "630:     def test_unaligned_singleton(self):",
          "632:         # aligned or not.",
          "633:         a = np.empty(5, dtype=np.uint8)[1:].view(np.int32)",
          "634:         evaluate('3', out=a)",
          "635:         assert_equal(a, 3)",
          "637:     def test_negative_mod(self):",
          "639:         # actually remainder op, and hence different from Python modulus.",
          "640:         a = np.array([-500, -135, 0, 0, 135, 500], dtype=np.int32)",
          "641:         n = np.array([-360, -360, -360, 360, 360, 360], dtype=np.int32)",
          "",
          "[Removed Lines]",
          "627:         assert_array_equal(NumExpr(ConstantNode(numpy.float32(1))).run(),",
          "631:         # Test for issue #397 whether singletons outputs assigned to consts must be",
          "638:         # Test for issue #413, modulus of negative integers. C modulus is",
          "",
          "[Added Lines]",
          "627:         assert_array_equal(NumExpr(ConstantNode(numpy.float32(1))).run(),",
          "631:         # Test for issue #397 whether singletons outputs assigned to consts must be",
          "638:         # Test for issue #413, modulus of negative integers. C modulus is",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "650:     def test_negative_power_scalar(self):",
          "651:         # Test for issue #428, where the power is negative and the base is an",
          "652:         # integer. This was running afoul in the precomputation in `expressions.py:pow_op()`",
          "654:         out_i = evaluate('base ** -1.0')",
          "655:         assert_equal(out_i, np.power(base, -1.0))",
          "658:         out_l = evaluate('base ** -1.0')",
          "659:         assert_equal(out_l, np.power(base, -1.0))",
          "",
          "[Removed Lines]",
          "653:         base = np.array([-2, -1, 0, 1, 2, 3], dtype=np.int32)",
          "657:         base = np.array([-2, -1, 0, 1, 2, 3], dtype=np.int64)",
          "",
          "[Added Lines]",
          "653:         base = np.array([-2, -1, 1, 2, 3], dtype=np.int32)",
          "657:         base = np.array([-2, -1, 1, 2, 3], dtype=np.int64)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "878:                                     expr == '(a+1) ** -1'):",
          "879:                             continue",
          "888: class test_int64(TestCase):",
          "",
          "[Removed Lines]",
          "881:                         m = make_test_method(a, a2, b, c, d, e, x,",
          "882:                                              expr, test_scalar, dtype,",
          "883:                                              optimization, exact,",
          "884:                                              section_name)",
          "885:                         yield m",
          "",
          "[Added Lines]",
          "881:                         make_test_method(a, a2, b, c, d, e, x,",
          "882:                                          expr, test_scalar, dtype,",
          "883:                                          optimization, exact,",
          "884:                                          section_name)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1120: # Test cases for the threading configuration",
          "1121: class test_threading_config(TestCase):",
          "1122:     def test_max_threads_unset(self):",
          "1124:         # re-initialize the threadpool",
          "1125:         script = '\\n'.join([",
          "1126:                 \"import os\",",
          "",
          "[Removed Lines]",
          "1123:         # Has to be done in a subprocess as `importlib.reload` doesn't let us",
          "",
          "[Added Lines]",
          "1122:         # Has to be done in a subprocess as `importlib.reload` doesn't let us",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1132:         subprocess.check_call([sys.executable, '-c', script])",
          "1134:     def test_max_threads_set(self):",
          "1136:         # re-initialize the threadpool",
          "1137:         script = '\\n'.join([",
          "1138:                 \"import os\",",
          "",
          "[Removed Lines]",
          "1135:         # Has to be done in a subprocess as `importlib.reload` doesn't let us",
          "",
          "[Added Lines]",
          "1134:         # Has to be done in a subprocess as `importlib.reload` doesn't let us",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1247:     (sysname, nodename, release, os_version, machine, processor) = platform.uname()",
          "1248:     print('Platform:          %s-%s-%s' % (sys.platform, machine, os_version))",
          "1249:     try:",
          "1251:         # with a try block",
          "1252:         cpu_info = cpu.info[0]",
          "1253:         print('CPU vendor:        %s' % cpu_info.get('VendorIdentifier', ''))",
          "",
          "[Removed Lines]",
          "1250:         # cpuinfo doesn't work on OSX well it seems, so protect these outputs",
          "",
          "[Added Lines]",
          "1249:         # cpuinfo doesn't work on OSX well it seems, so protect these outputs",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7d20bf6af9fa66adea275637ddf30b8b3f06a147",
      "candidate_info": {
        "commit_hash": "7d20bf6af9fa66adea275637ddf30b8b3f06a147",
        "repo": "pydata/numexpr",
        "commit_url": "https://github.com/pydata/numexpr/commit/7d20bf6af9fa66adea275637ddf30b8b3f06a147",
        "files": [
          "numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py"
        ],
        "message": "fix sanitizer forbid colon within quotes",
        "before_after_code_files": [
          "numexpr/necompiler.py||numexpr/necompiler.py",
          "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ],
          "candidate": [
            "numexpr/necompiler.py||numexpr/necompiler.py",
            "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py"
          ]
        }
      },
      "candidate_diff": {
        "numexpr/necompiler.py||numexpr/necompiler.py": [
          "File: numexpr/necompiler.py -> numexpr/necompiler.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "278:     # We also cannot ban `.\\d*j`, where `\\d*` is some digits (or none), e.g. 1.5j, 1.j",
          "279:     if sanitize:",
          "280:         no_whitespace = re.sub(r'\\s+', '', s)",
          "282:             raise ValueError(f'Expression {s} has forbidden control characters.')",
          "284:     old_ctx = expressions._context.get_current_context()",
          "",
          "[Removed Lines]",
          "281:         if _blacklist_re.search(no_whitespace) is not None:",
          "",
          "[Added Lines]",
          "281:         skip_quotes = re.sub(r'(\\'[^\\']*\\')', '', no_whitespace)",
          "282:         if _blacklist_re.search(skip_quotes) is not None:",
          "",
          "---------------"
        ],
        "numexpr/tests/test_numexpr.py||numexpr/tests/test_numexpr.py": [
          "File: numexpr/tests/test_numexpr.py -> numexpr/tests/test_numexpr.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "576:             evaluate('c.real')",
          "577:             evaluate('c.imag')",
          "580:     def test_no_sanitize(self):",
          "581:         try: # Errors on compile() after eval()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "579:             # pass imaginary unit j",
          "580:             evaluate('1.5j')",
          "581:             evaluate('3.j')",
          "583:             # pass forbidden characters within quotes",
          "584:             x = np.array(['a', 'b'], dtype=bytes)",
          "585:             evaluate(\"x == 'b:'\")",
          "",
          "---------------"
        ]
      }
    }
  ]
}