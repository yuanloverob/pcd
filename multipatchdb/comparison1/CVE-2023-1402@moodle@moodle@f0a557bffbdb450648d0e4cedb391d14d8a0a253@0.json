{
  "cve_id": "CVE-2023-1402",
  "cve_desc": "The course participation report required additional checks to prevent roles being displayed which the user did not have access to view.",
  "repo": "moodle/moodle",
  "patch_hash": "f0a557bffbdb450648d0e4cedb391d14d8a0a253",
  "patch_info": {
    "commit_hash": "f0a557bffbdb450648d0e4cedb391d14d8a0a253",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/f0a557bffbdb450648d0e4cedb391d14d8a0a253",
    "files": [
      "report/participation/locallib.php",
      "report/participation/tests/behat/filter_participation.feature"
    ],
    "message": "MDL-75517 report_participation: filter report by viewable roles only.",
    "before_after_code_files": [
      "report/participation/locallib.php||report/participation/locallib.php",
      "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
    ]
  },
  "patch_diff": {
    "report/participation/locallib.php||report/participation/locallib.php": [
      "File: report/participation/locallib.php -> report/participation/locallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "190:     $actionoptions = report_participation_get_action_options();",
      "193:     $context = context_course::instance($course->id);",
      "194:     $roles = get_roles_used_in_context($context);",
      "195:     $guestrole = get_guest_role();",
      "199:     $modinfo = get_fast_modinfo($course);",
      "",
      "[Removed Lines]",
      "196:     $roles[$guestrole->id] = $guestrole;",
      "197:     $roleoptions = role_fix_names($roles, $context, ROLENAME_ALIAS, true);",
      "",
      "[Added Lines]",
      "194:     $rolesviewable = get_viewable_roles($context);",
      "197:     $roleoptions = array_intersect_key($rolesviewable, $roles) + [",
      "198:         $guestrole->id => role_get_name($guestrole, $context),",
      "199:     ];",
      "",
      "---------------"
    ],
    "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature": [
      "File: report/participation/tests/behat/filter_participation.feature -> report/participation/tests/behat/filter_participation.feature",
      "--- Hunk 1 ---",
      "[Context before]",
      "10:       | Course 1 | C1 | 0 | 1 |",
      "11:     And the following \"users\" exist:",
      "12:       | username | firstname | lastname | email |",
      "13:       | teacher1 | Teacher | 1 | teacher1@example.com |",
      "14:       | student1 | Student | 1 | student1@example.com |",
      "15:     And the following \"course enrolments\" exist:",
      "16:       | user | course | role |",
      "17:       | teacher1 | C1 | editingteacher |",
      "18:       | student1 | C1 | student |",
      "19:     And the following \"activity\" exists:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:       | manager1 | Manager | 1 | manager1@example.com |",
      "18:       | manager1 | C1 | manager |",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "82:     And I set the field \"roleid\" to \"Student\"",
      "83:     And I press \"Go\"",
      "84:     Then I should see \"Yes (1)\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "88:   @javascript",
      "89:   Scenario Outline: Filter participation report by viewable roles",
      "90:     Given I am on the \"Course 1\" course page logged in as \"teacher1\"",
      "91:     When I navigate to \"Reports\" in current page administration",
      "92:     And I click on \"Course participation\" \"link\"",
      "93:     # Teacher role cannot see Manager by default.",
      "94:     Then \"Manager\" \"option\" should not exist in the \"Show only\" \"select\"",
      "95:     And I set the following fields to these values:",
      "96:       | Activity module | Test book name |",
      "97:       | Show only       | <role>         |",
      "98:     And I press \"Go\"",
      "99:     And I should see \"<uservisible>\" in the \"reporttable\" \"table\"",
      "100:     And I should not see \"<usernonvisible>\" in the \"reporttable\" \"table\"",
      "101:     Examples:",
      "102:       | role    | uservisible | usernonvisible |",
      "103:       | Student | Student 1   | Teacher 1      |",
      "104:       | Teacher | Teacher 1   | Student 1      |",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "98bbce70119f4e0035027ee106a90aaeb3545fa7",
      "candidate_info": {
        "commit_hash": "98bbce70119f4e0035027ee106a90aaeb3545fa7",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/98bbce70119f4e0035027ee106a90aaeb3545fa7",
        "files": [
          "report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature"
        ],
        "message": "MDL-75517 report_participation: filter report by viewable roles only.",
        "before_after_code_files": [
          "report/participation/locallib.php||report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ],
          "candidate": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ]
        }
      },
      "candidate_diff": {
        "report/participation/locallib.php||report/participation/locallib.php": [
          "File: report/participation/locallib.php -> report/participation/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "190:     $actionoptions = report_participation_get_action_options();",
          "193:     $context = context_course::instance($course->id);",
          "194:     $roles = get_roles_used_in_context($context);",
          "195:     $guestrole = get_guest_role();",
          "199:     $modinfo = get_fast_modinfo($course);",
          "",
          "[Removed Lines]",
          "196:     $roles[$guestrole->id] = $guestrole;",
          "197:     $roleoptions = role_fix_names($roles, $context, ROLENAME_ALIAS, true);",
          "",
          "[Added Lines]",
          "194:     $rolesviewable = get_viewable_roles($context);",
          "197:     $roleoptions = array_intersect_key($rolesviewable, $roles) + [",
          "198:         $guestrole->id => role_get_name($guestrole, $context),",
          "199:     ];",
          "",
          "---------------"
        ],
        "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature": [
          "File: report/participation/tests/behat/filter_participation.feature -> report/participation/tests/behat/filter_participation.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:       | Course 1 | C1 | 0 | 1 |",
          "11:     And the following \"users\" exist:",
          "12:       | username | firstname | lastname | email |",
          "13:       | teacher1 | Teacher | 1 | teacher1@example.com |",
          "14:       | student1 | Student | 1 | student1@example.com |",
          "15:     And the following \"course enrolments\" exist:",
          "16:       | user | course | role |",
          "17:       | teacher1 | C1 | editingteacher |",
          "18:       | student1 | C1 | student |",
          "19:     And the following \"activity\" exists:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13:       | manager1 | Manager | 1 | manager1@example.com |",
          "18:       | manager1 | C1 | manager |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "79:     And I set the field \"roleid\" to \"Student\"",
          "80:     And I press \"Go\"",
          "81:     Then I should see \"Yes (1)\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85:   @javascript",
          "86:   Scenario Outline: Filter participation report by viewable roles",
          "87:     Given I am on the \"Course 1\" course page logged in as \"teacher1\"",
          "88:     When I navigate to \"Reports > Course participation\" in current page administration",
          "89:     # Teacher role cannot see Manager by default.",
          "90:     Then \"Manager\" \"option\" should not exist in the \"Show only\" \"select\"",
          "91:     And I set the following fields to these values:",
          "92:       | Activity module | Test book name |",
          "93:       | Show only       | <role>         |",
          "94:     And I press \"Go\"",
          "95:     And I should see \"<uservisible>\" in the \"reporttable\" \"table\"",
          "96:     And I should not see \"<usernonvisible>\" in the \"reporttable\" \"table\"",
          "97:     Examples:",
          "98:       | role    | uservisible | usernonvisible |",
          "99:       | Student | Student 1   | Teacher 1      |",
          "100:       | Teacher | Teacher 1   | Student 1      |",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9a6fdc2aeb4ff789f91da2d2c0fb76a7e2de3e78",
      "candidate_info": {
        "commit_hash": "9a6fdc2aeb4ff789f91da2d2c0fb76a7e2de3e78",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9a6fdc2aeb4ff789f91da2d2c0fb76a7e2de3e78",
        "files": [
          "report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature"
        ],
        "message": "MDL-75517 report_participation: filter report by viewable roles only.",
        "before_after_code_files": [
          "report/participation/locallib.php||report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ],
          "candidate": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ]
        }
      },
      "candidate_diff": {
        "report/participation/locallib.php||report/participation/locallib.php": [
          "File: report/participation/locallib.php -> report/participation/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "190:     $actionoptions = report_participation_get_action_options();",
          "193:     $context = context_course::instance($course->id);",
          "194:     $roles = get_roles_used_in_context($context);",
          "195:     $guestrole = get_guest_role();",
          "199:     $modinfo = get_fast_modinfo($course);",
          "",
          "[Removed Lines]",
          "196:     $roles[$guestrole->id] = $guestrole;",
          "197:     $roleoptions = role_fix_names($roles, $context, ROLENAME_ALIAS, true);",
          "",
          "[Added Lines]",
          "194:     $rolesviewable = get_viewable_roles($context);",
          "197:     $roleoptions = array_intersect_key($rolesviewable, $roles) + [",
          "198:         $guestrole->id => role_get_name($guestrole, $context),",
          "199:     ];",
          "",
          "---------------"
        ],
        "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature": [
          "File: report/participation/tests/behat/filter_participation.feature -> report/participation/tests/behat/filter_participation.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:       | Course 1 | C1 | 0 | 1 |",
          "11:     And the following \"users\" exist:",
          "12:       | username | firstname | lastname | email |",
          "13:       | teacher1 | Teacher | 1 | teacher1@example.com |",
          "14:       | student1 | Student | 1 | student1@example.com |",
          "15:     And the following \"course enrolments\" exist:",
          "16:       | user | course | role |",
          "17:       | teacher1 | C1 | editingteacher |",
          "18:       | student1 | C1 | student |",
          "19:     And the following \"activity\" exists:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13:       | manager1 | Manager | 1 | manager1@example.com |",
          "18:       | manager1 | C1 | manager |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82:     And I set the field \"roleid\" to \"Student\"",
          "83:     And I press \"Go\"",
          "84:     Then I should see \"Yes (1)\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "88:   @javascript",
          "89:   Scenario Outline: Filter participation report by viewable roles",
          "90:     Given I am on the \"Course 1\" course page logged in as \"teacher1\"",
          "91:     When I navigate to \"Reports\" in current page administration",
          "92:     And I click on \"Course participation\" \"link\"",
          "93:     # Teacher role cannot see Manager by default.",
          "94:     Then \"Manager\" \"option\" should not exist in the \"Show only\" \"select\"",
          "95:     And I set the following fields to these values:",
          "96:       | Activity module | Test book name |",
          "97:       | Show only       | <role>         |",
          "98:     And I press \"Go\"",
          "99:     And I should see \"<uservisible>\" in the \"reporttable\" \"table\"",
          "100:     And I should not see \"<usernonvisible>\" in the \"reporttable\" \"table\"",
          "101:     Examples:",
          "102:       | role    | uservisible | usernonvisible |",
          "103:       | Student | Student 1   | Teacher 1      |",
          "104:       | Teacher | Teacher 1   | Student 1      |",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d4389e4a0e95812e23edaf97548e50a02aad1140",
      "candidate_info": {
        "commit_hash": "d4389e4a0e95812e23edaf97548e50a02aad1140",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d4389e4a0e95812e23edaf97548e50a02aad1140",
        "files": [
          "report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature"
        ],
        "message": "MDL-75517 report_participation: filter report by viewable roles only.",
        "before_after_code_files": [
          "report/participation/locallib.php||report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ],
          "candidate": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ]
        }
      },
      "candidate_diff": {
        "report/participation/locallib.php||report/participation/locallib.php": [
          "File: report/participation/locallib.php -> report/participation/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "190:     $actionoptions = report_participation_get_action_options();",
          "193:     $context = context_course::instance($course->id);",
          "194:     $roles = get_roles_used_in_context($context);",
          "195:     $guestrole = get_guest_role();",
          "199:     $modinfo = get_fast_modinfo($course);",
          "",
          "[Removed Lines]",
          "196:     $roles[$guestrole->id] = $guestrole;",
          "197:     $roleoptions = role_fix_names($roles, $context, ROLENAME_ALIAS, true);",
          "",
          "[Added Lines]",
          "194:     $rolesviewable = get_viewable_roles($context);",
          "197:     $roleoptions = array_intersect_key($rolesviewable, $roles) + [",
          "198:         $guestrole->id => role_get_name($guestrole, $context),",
          "199:     ];",
          "",
          "---------------"
        ],
        "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature": [
          "File: report/participation/tests/behat/filter_participation.feature -> report/participation/tests/behat/filter_participation.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:       | Course 1 | C1 | 0 | 1 |",
          "11:     And the following \"users\" exist:",
          "12:       | username | firstname | lastname | email |",
          "13:       | teacher1 | Teacher | 1 | teacher1@example.com |",
          "14:       | student1 | Student | 1 | student1@example.com |",
          "15:     And the following \"course enrolments\" exist:",
          "16:       | user | course | role |",
          "17:       | teacher1 | C1 | editingteacher |",
          "18:       | student1 | C1 | student |",
          "19:     And the following \"activity\" exists:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13:       | manager1 | Manager | 1 | manager1@example.com |",
          "18:       | manager1 | C1 | manager |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "78:     And I set the field \"roleid\" to \"Student\"",
          "79:     And I press \"Go\"",
          "80:     Then I should see \"Yes (1)\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "84:   @javascript",
          "85:   Scenario Outline: Filter participation report by viewable roles",
          "86:     Given I am on the \"Course 1\" course page logged in as \"teacher1\"",
          "87:     When I navigate to \"Reports > Course participation\" in current page administration",
          "88:     # Teacher role cannot see Manager by default.",
          "89:     Then \"Manager\" \"option\" should not exist in the \"Show only\" \"select\"",
          "90:     And I set the following fields to these values:",
          "91:       | Activity module | Test book name |",
          "92:       | Show only       | <role>         |",
          "93:     And I press \"Go\"",
          "94:     And I should see \"<uservisible>\" in the \"reporttable\" \"table\"",
          "95:     And I should not see \"<usernonvisible>\" in the \"reporttable\" \"table\"",
          "96:     Examples:",
          "97:       | role    | uservisible | usernonvisible |",
          "98:       | Student | Student 1   | Teacher 1      |",
          "99:       | Teacher | Teacher 1   | Student 1      |",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b946c528b0b2071fb5c11f26db78a75e0a39084c",
      "candidate_info": {
        "commit_hash": "b946c528b0b2071fb5c11f26db78a75e0a39084c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/b946c528b0b2071fb5c11f26db78a75e0a39084c",
        "files": [
          "report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature"
        ],
        "message": "MDL-75517 report_participation: filter report by viewable roles only.",
        "before_after_code_files": [
          "report/participation/locallib.php||report/participation/locallib.php",
          "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ],
          "candidate": [
            "report/participation/locallib.php||report/participation/locallib.php",
            "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature"
          ]
        }
      },
      "candidate_diff": {
        "report/participation/locallib.php||report/participation/locallib.php": [
          "File: report/participation/locallib.php -> report/participation/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "190:     $actionoptions = report_participation_get_action_options();",
          "193:     $context = context_course::instance($course->id);",
          "194:     $roles = get_roles_used_in_context($context);",
          "195:     $guestrole = get_guest_role();",
          "199:     $modinfo = get_fast_modinfo($course);",
          "",
          "[Removed Lines]",
          "196:     $roles[$guestrole->id] = $guestrole;",
          "197:     $roleoptions = role_fix_names($roles, $context, ROLENAME_ALIAS, true);",
          "",
          "[Added Lines]",
          "194:     $rolesviewable = get_viewable_roles($context);",
          "197:     $roleoptions = array_intersect_key($rolesviewable, $roles) + [",
          "198:         $guestrole->id => role_get_name($guestrole, $context),",
          "199:     ];",
          "",
          "---------------"
        ],
        "report/participation/tests/behat/filter_participation.feature||report/participation/tests/behat/filter_participation.feature": [
          "File: report/participation/tests/behat/filter_participation.feature -> report/participation/tests/behat/filter_participation.feature",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:       | Course 1 | C1 | 0 | 1 |",
          "11:     And the following \"users\" exist:",
          "12:       | username | firstname | lastname | email |",
          "13:       | teacher1 | Teacher | 1 | teacher1@example.com |",
          "14:       | student1 | Student | 1 | student1@example.com |",
          "15:     And the following \"course enrolments\" exist:",
          "16:       | user | course | role |",
          "17:       | teacher1 | C1 | editingteacher |",
          "18:       | student1 | C1 | student |",
          "19:     And the following \"activity\" exists:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13:       | manager1 | Manager | 1 | manager1@example.com |",
          "18:       | manager1 | C1 | manager |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82:     And I set the field \"roleid\" to \"Student\"",
          "83:     And I press \"Go\"",
          "84:     Then I should see \"Yes (1)\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "88:   @javascript",
          "89:   Scenario Outline: Filter participation report by viewable roles",
          "90:     Given I am on the \"Course 1\" course page logged in as \"teacher1\"",
          "91:     When I navigate to \"Reports\" in current page administration",
          "92:     And I click on \"Course participation\" \"link\"",
          "93:     # Teacher role cannot see Manager by default.",
          "94:     Then \"Manager\" \"option\" should not exist in the \"Show only\" \"select\"",
          "95:     And I set the following fields to these values:",
          "96:       | Activity module | Test book name |",
          "97:       | Show only       | <role>         |",
          "98:     And I press \"Go\"",
          "99:     And I should see \"<uservisible>\" in the \"reporttable\" \"table\"",
          "100:     And I should not see \"<usernonvisible>\" in the \"reporttable\" \"table\"",
          "101:     Examples:",
          "102:       | role    | uservisible | usernonvisible |",
          "103:       | Student | Student 1   | Teacher 1      |",
          "104:       | Teacher | Teacher 1   | Student 1      |",
          "",
          "---------------"
        ]
      }
    }
  ]
}