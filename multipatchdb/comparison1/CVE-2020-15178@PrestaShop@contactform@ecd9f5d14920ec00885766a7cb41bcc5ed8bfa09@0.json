{
  "cve_id": "CVE-2020-15178",
  "cve_desc": "In PrestaShop contactform module (prestashop/contactform) before version 4.3.0, an attacker is able to inject JavaScript while using the contact form. The `message` field was incorrectly unescaped, possibly allowing attackers to execute arbitrary JavaScript in a victim's browser.",
  "repo": "PrestaShop/contactform",
  "patch_hash": "ecd9f5d14920ec00885766a7cb41bcc5ed8bfa09",
  "patch_info": {
    "commit_hash": "ecd9f5d14920ec00885766a7cb41bcc5ed8bfa09",
    "repo": "PrestaShop/contactform",
    "commit_url": "https://github.com/PrestaShop/contactform/commit/ecd9f5d14920ec00885766a7cb41bcc5ed8bfa09",
    "files": [
      "contactform.php"
    ],
    "message": "Merge pull request from GHSA-95hx-62rh-gg96\n\nDo not unescape form message data",
    "before_after_code_files": [
      "contactform.php||contactform.php"
    ]
  },
  "patch_diff": {
    "contactform.php||contactform.php": [
      "File: contactform.php -> contactform.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "317:             }",
      "318:         }",
      "319:         $this->contact['contacts'] = $this->getTemplateVarContact();",
      "321:         $this->contact['allow_file_upload'] = (bool) Configuration::get('PS_CUSTOMER_SERVICE_FILE_UPLOAD');",
      "323:         if (!(bool)Configuration::isCatalogMode()) {",
      "",
      "[Removed Lines]",
      "320:         $this->contact['message'] = html_entity_decode(Tools::getValue('message'));",
      "",
      "[Added Lines]",
      "320:         $this->contact['message'] = Tools::getValue('message');",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "388:     {",
      "389:         $orders = [];",
      "392:             && isset($this->context->customer)",
      "394:             $customer_orders = Order::getCustomerOrders($this->context->customer->id);",
      "396:             foreach ($customer_orders as $customer_order) {",
      "",
      "[Removed Lines]",
      "391:         if (!isset($this->customer_thread['id_order'])",
      "393:             && $this->context->customer->isLogged()) {",
      "",
      "[Added Lines]",
      "391:         if (empty($this->customer_thread['id_order'])",
      "393:             && $this->context->customer->isLogged()",
      "394:         ) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "401:                     $orders[$customer_order['id_order']]['products'] = $myOrder->getProducts();",
      "402:                 }",
      "403:             }",
      "405:             $myOrder = new Order($this->customer_thread['id_order']);",
      "407:             if (Validate::isLoadedObject($myOrder)) {",
      "",
      "[Removed Lines]",
      "404:         } elseif (isset($this->customer_thread['id_order']) && (int)$this->customer_thread['id_order'] > 0) {",
      "",
      "[Added Lines]",
      "405:         } elseif (isset($this->customer_thread['id_order']) && (int) $this->customer_thread['id_order'] > 0) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "411:             }",
      "412:         }",
      "415:             $id_order = isset($this->customer_thread['id_order']) ?",
      "417:                       0;",
      "419:             $orders[$id_order]['products'][(int)$this->customer_thread['id_product']] = $this->context->controller->objectPresenter->present(",
      "421:             );",
      "422:         }",
      "",
      "[Removed Lines]",
      "414:         if (isset($this->customer_thread['id_product'])) {",
      "416:                       (int)$this->customer_thread['id_order'] :",
      "420:                 new Product((int)$this->customer_thread['id_product'])",
      "",
      "[Added Lines]",
      "415:         if (!empty($this->customer_thread['id_product'])) {",
      "417:                       (int) $this->customer_thread['id_order'] :",
      "421:                 new Product((int) $this->customer_thread['id_product'])",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "586:                     '{lastname}' => '',",
      "587:                     '{order_name}' => '-',",
      "588:                     '{attached_file}' => '-',",
      "590:                     '{email}' =>  $from,",
      "591:                     '{product_name}' => '',",
      "592:                 ];",
      "",
      "[Removed Lines]",
      "589:                     '{message}' => Tools::nl2br(Tools::stripslashes($message)),",
      "",
      "[Added Lines]",
      "590:                     '{message}' => Tools::nl2br(Tools::htmlentitiesUTF8(Tools::stripslashes($message))),",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "aa3c77923734854bb7168f30db43544e42638202",
      "candidate_info": {
        "commit_hash": "aa3c77923734854bb7168f30db43544e42638202",
        "repo": "PrestaShop/contactform",
        "commit_url": "https://github.com/PrestaShop/contactform/commit/aa3c77923734854bb7168f30db43544e42638202",
        "files": [
          "contactform.php"
        ],
        "message": "Do not unescape form message data",
        "before_after_code_files": [
          "contactform.php||contactform.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/PrestaShop/contactform/pull/50"
        ],
        "olp_code_files": {
          "patch": [
            "contactform.php||contactform.php"
          ],
          "candidate": [
            "contactform.php||contactform.php"
          ]
        }
      },
      "candidate_diff": {
        "contactform.php||contactform.php": [
          "File: contactform.php -> contactform.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "317:             }",
          "318:         }",
          "319:         $this->contact['contacts'] = $this->getTemplateVarContact();",
          "321:         $this->contact['allow_file_upload'] = (bool) Configuration::get('PS_CUSTOMER_SERVICE_FILE_UPLOAD');",
          "323:         if (!(bool)Configuration::isCatalogMode()) {",
          "",
          "[Removed Lines]",
          "320:         $this->contact['message'] = html_entity_decode(Tools::getValue('message'));",
          "",
          "[Added Lines]",
          "320:         $this->contact['message'] = Tools::getValue('message');",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "388:     {",
          "389:         $orders = [];",
          "392:             && isset($this->context->customer)",
          "394:             $customer_orders = Order::getCustomerOrders($this->context->customer->id);",
          "396:             foreach ($customer_orders as $customer_order) {",
          "",
          "[Removed Lines]",
          "391:         if (!isset($this->customer_thread['id_order'])",
          "393:             && $this->context->customer->isLogged()) {",
          "",
          "[Added Lines]",
          "391:         if (empty($this->customer_thread['id_order'])",
          "393:             && $this->context->customer->isLogged()",
          "394:         ) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "401:                     $orders[$customer_order['id_order']]['products'] = $myOrder->getProducts();",
          "402:                 }",
          "403:             }",
          "405:             $myOrder = new Order($this->customer_thread['id_order']);",
          "407:             if (Validate::isLoadedObject($myOrder)) {",
          "",
          "[Removed Lines]",
          "404:         } elseif (isset($this->customer_thread['id_order']) && (int)$this->customer_thread['id_order'] > 0) {",
          "",
          "[Added Lines]",
          "405:         } elseif (isset($this->customer_thread['id_order']) && (int) $this->customer_thread['id_order'] > 0) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "411:             }",
          "412:         }",
          "415:             $id_order = isset($this->customer_thread['id_order']) ?",
          "417:                       0;",
          "419:             $orders[$id_order]['products'][(int)$this->customer_thread['id_product']] = $this->context->controller->objectPresenter->present(",
          "421:             );",
          "422:         }",
          "",
          "[Removed Lines]",
          "414:         if (isset($this->customer_thread['id_product'])) {",
          "416:                       (int)$this->customer_thread['id_order'] :",
          "420:                 new Product((int)$this->customer_thread['id_product'])",
          "",
          "[Added Lines]",
          "415:         if (!empty($this->customer_thread['id_product'])) {",
          "417:                       (int) $this->customer_thread['id_order'] :",
          "421:                 new Product((int) $this->customer_thread['id_product'])",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "584:                 $var_list = [",
          "585:                     '{order_name}' => '-',",
          "586:                     '{attached_file}' => '-',",
          "588:                     '{email}' =>  $from,",
          "589:                     '{product_name}' => '',",
          "590:                 ];",
          "",
          "[Removed Lines]",
          "587:                     '{message}' => Tools::nl2br(Tools::stripslashes($message)),",
          "",
          "[Added Lines]",
          "588:                     '{message}' => Tools::nl2br(Tools::htmlentitiesUTF8(Tools::stripslashes($message))),",
          "",
          "---------------"
        ]
      }
    }
  ]
}