{
  "cve_id": "CVE-2017-5594",
  "cve_desc": "An issue was discovered in Pagekit CMS before 1.0.11. In this vulnerability the remote attacker is able to reset the registered user's password, when the debug toolbar is enabled. The password is successfully recovered using this exploit. The SecureLayer7 ID is SL7_PGKT_01.",
  "repo": "pagekit/pagekit",
  "patch_hash": "e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
  "patch_info": {
    "commit_hash": "e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
    "repo": "pagekit/pagekit",
    "commit_url": "https://github.com/pagekit/pagekit/commit/e0454f9c037c427a5ff76a57e78dbf8cc00c268b",
    "files": [
      "CHANGELOG.md",
      "app/system/config.php",
      "app/system/modules/settings/app/components/system.vue",
      "app/system/modules/user/src/Controller/ResetPasswordController.php",
      "app/system/modules/user/views/reset-confirm.php"
    ],
    "message": "Merge branch 'release/1.0.11'",
    "before_after_code_files": [
      "app/system/config.php||app/system/config.php",
      "app/system/modules/settings/app/components/system.vue||app/system/modules/settings/app/components/system.vue",
      "app/system/modules/user/src/Controller/ResetPasswordController.php||app/system/modules/user/src/Controller/ResetPasswordController.php",
      "app/system/modules/user/views/reset-confirm.php||app/system/modules/user/views/reset-confirm.php"
    ]
  },
  "patch_diff": {
    "app/system/config.php||app/system/config.php": [
      "File: app/system/config.php -> app/system/config.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5:     'application' => [",
      "9:     ],",
      "",
      "[Removed Lines]",
      "7:         'version' => '1.0.10'",
      "",
      "[Added Lines]",
      "7:         'version' => '1.0.11'",
      "",
      "---------------"
    ],
    "app/system/modules/settings/app/components/system.vue||app/system/modules/settings/app/components/system.vue": [
      "File: app/system/modules/settings/app/components/system.vue -> app/system/modules/settings/app/components/system.vue",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:                 <label><input type=\"checkbox\" value=\"1\" v-model=\"$root.config.debug.enabled\" :disabled=\"!sqlite\"> {{ 'Enable debug toolbar' | trans }}</label>",
      "35:             </p>",
      "36:             <p class=\"uk-form-help-block\" v-if=\"!sqlite\">{{ 'Please enable the SQLite database extension.' | trans }}</p>",
      "37:         </div>",
      "38:     </div>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "37:             <p class=\"uk-form-help-block\" v-if=\"$root.config.application.debug || $root.config.debug.enabled\">{{ 'Please note that enabling debug mode or toolbar has serious security implications.' | trans }}</p>",
      "",
      "---------------"
    ],
    "app/system/modules/user/src/Controller/ResetPasswordController.php||app/system/modules/user/src/Controller/ResetPasswordController.php": [
      "File: app/system/modules/user/src/Controller/ResetPasswordController.php -> app/system/modules/user/src/Controller/ResetPasswordController.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:                 throw new Exception(__('Your account has not been activated or is blocked.'));",
      "52:             }",
      "58:             try {",
      "",
      "[Removed Lines]",
      "54:             $user->activation = App::get('auth.random')->generateString(32);",
      "56:             $url = App::url('@user/resetpassword/confirm', ['user' => $user->username, 'key' => $user->activation], 0);",
      "",
      "[Added Lines]",
      "54:             $key = App::get('auth.random')->generateString(32);",
      "55:             $url = App::url('@user/resetpassword/confirm', compact('key'), 0);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "67:                 throw new Exception(__('Unable to send confirmation link.'));",
      "68:             }",
      "70:             $user->save();",
      "72:             App::message()->success(__('Check your email for the confirmation link.'));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "69:             $user->activation = $key;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "85:     }",
      "91:     {",
      "93:             App::abort(400, __('Invalid key.'));",
      "94:         }",
      "97:             App::abort(400, __('Your account has not been activated or is blocked.'));",
      "98:         }",
      "",
      "[Removed Lines]",
      "90:     public function confirmAction($username = \"\", $activation = \"\")",
      "92:         if (empty($username) || empty($activation) || !$user = User::where(compact('username', 'activation'))->first()) {",
      "96:         if ($user->isBlocked()) {",
      "",
      "[Added Lines]",
      "90:     public function confirmAction($activation = '', $password = '')",
      "92:         if ($activation and $user = User::where(compact('activation'))->first()) {",
      "94:             App::session()->set('activation', [",
      "95:                 'key' => $activation,",
      "96:                 'user' => $user->id,",
      "97:             ]);",
      "99:             $user->activation = null;",
      "100:             $user->save();",
      "101:         }",
      "103:         if (!$data = App::session()->get('activation') or $data['key'] != $activation) {",
      "107:         if (!$user = User::find($data['user']) or $user->isBlocked()) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "105:                     throw new Exception(__('Invalid token. Please try again.'));",
      "106:                 }",
      "110:                 if (empty($password)) {",
      "111:                     throw new Exception(__('Enter password.'));",
      "112:                 }",
      "",
      "[Removed Lines]",
      "108:                 $password = App::request()->request->get('password');",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "115:                     throw new Exception(__('Invalid password.'));",
      "116:                 }",
      "119:                 $user->activation = null;",
      "120:                 $user->save();",
      "122:                 App::message()->success(__('Your password has been reset.'));",
      "124:                 return App::redirect('@user/login');",
      "",
      "[Removed Lines]",
      "118:                 $user->password = App::get('auth.password')->hash($password);",
      "",
      "[Added Lines]",
      "128:                 $user->password = App::get('auth.password')->hash($password);",
      "131:                 App::session()->remove('activation');",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "133:                 'title' => __('Reset Confirm'),",
      "134:                 'name' => 'system/user/reset-confirm.php'",
      "135:             ],",
      "137:             'activation' => $activation,",
      "138:             'error' => isset($error) ? $error : ''",
      "139:         ];",
      "",
      "[Removed Lines]",
      "136:             'username' => $username,",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "app/system/modules/user/views/reset-confirm.php||app/system/modules/user/views/reset-confirm.php": [
      "File: app/system/modules/user/views/reset-confirm.php -> app/system/modules/user/views/reset-confirm.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: <?php $view->script('uikit-form-password') ?>",
      "5:     <?php if($error): ?>",
      "6:     <div class=\"uk-alert uk-alert-danger\">",
      "",
      "[Removed Lines]",
      "3: <form class=\"pk-user pk-user-reset uk-form uk-form-stacked uk-width-medium-1-2 uk-width-large-1-3 uk-container-center\" action=\"<?= $view->url('@user/resetpassword/confirm', ['user' => $username, 'key' => $activation]) ?>\" method=\"post\">",
      "",
      "[Added Lines]",
      "3: <form class=\"pk-user pk-user-reset uk-form uk-form-stacked uk-width-medium-1-2 uk-width-large-1-3 uk-container-center\" action=\"<?= $view->url('@user/resetpassword/confirm', ['key' => $activation]) ?>\" method=\"post\">",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9318f6d9b841fc7846e920964bbf9d6f1f7a1b5e",
      "candidate_info": {
        "commit_hash": "9318f6d9b841fc7846e920964bbf9d6f1f7a1b5e",
        "repo": "pagekit/pagekit",
        "commit_url": "https://github.com/pagekit/pagekit/commit/9318f6d9b841fc7846e920964bbf9d6f1f7a1b5e",
        "files": [
          "app/console/src/Commands/BuildCommand.php"
        ],
        "message": "build - ignore source maps",
        "before_after_code_files": [
          "app/console/src/Commands/BuildCommand.php||app/console/src/Commands/BuildCommand.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/pagekit/pagekit/pull/912"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "app/console/src/Commands/BuildCommand.php||app/console/src/Commands/BuildCommand.php": [
          "File: app/console/src/Commands/BuildCommand.php -> app/console/src/Commands/BuildCommand.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28:     protected $excludes = [",
          "30:         '^app\\/assets\\/[^\\/]+\\/(dist\\/vue-.+\\.js|dist\\/jquery\\.js|lodash\\.js)',",
          "31:         '^app\\/assets\\/(jquery|vue)\\/(src|perf|external)',",
          "32:         '^app\\/vendor\\/lusitanian\\/oauth\\/examples',",
          "",
          "[Removed Lines]",
          "29:         '^(tmp|config\\.php|pagekit.+\\.zip|pagekit.db)',",
          "",
          "[Added Lines]",
          "29:         '^(tmp|config\\.php|pagekit.+\\.zip|pagekit.db|.+\\.map)',",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "655bb84a5a6e666e2185c0c5d3135b39ae2ff777",
      "candidate_info": {
        "commit_hash": "655bb84a5a6e666e2185c0c5d3135b39ae2ff777",
        "repo": "pagekit/pagekit",
        "commit_url": "https://github.com/pagekit/pagekit/commit/655bb84a5a6e666e2185c0c5d3135b39ae2ff777",
        "files": [
          "app/modules/view/src/Helper/ScriptHelper.php"
        ],
        "message": "add support for script tag attributes 'defer' and 'async'",
        "before_after_code_files": [
          "app/modules/view/src/Helper/ScriptHelper.php||app/modules/view/src/Helper/ScriptHelper.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/pagekit/pagekit/pull/912"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "app/modules/view/src/Helper/ScriptHelper.php||app/modules/view/src/Helper/ScriptHelper.php": [
          "File: app/modules/view/src/Helper/ScriptHelper.php -> app/modules/view/src/Helper/ScriptHelper.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:         foreach ($this->scripts as $script) {",
          "72:             if ($source = $script->getSource()) {",
          "74:             } elseif ($content = $script->getContent()) {",
          "75:                 $output .= sprintf(\"        <script>%s</script>\\n\", $content);",
          "76:             }",
          "",
          "[Removed Lines]",
          "73:                 $output .= sprintf(\"        <script src=\\\"%s\\\"></script>\\n\", $source);",
          "",
          "[Added Lines]",
          "74:                 $attributes = '';",
          "75:                 foreach (['async', 'defer'] as $attribute) {",
          "76:                     $attributes .= $script->getOption($attribute) ? ' ' . $attribute : '';",
          "77:                 }",
          "79:                 $output .= sprintf(\"        <script src=\\\"%s\\\"%s></script>\\n\", $source, $attributes);",
          "",
          "---------------"
        ]
      }
    }
  ]
}