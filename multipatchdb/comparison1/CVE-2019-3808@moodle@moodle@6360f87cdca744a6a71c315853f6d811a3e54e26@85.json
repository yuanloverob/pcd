{
  "cve_id": "CVE-2019-3808",
  "cve_desc": "A flaw was found in Moodle versions 3.6 to 3.6.1, 3.5 to 3.5.3, 3.4 to 3.4.6, 3.1 to 3.1.15 and earlier unsupported versions. The 'manage groups' capability did not have the 'XSS risk' flag assigned to it, but does have that access in certain places. Note that the capability is intended for use by trusted users, and is only assigned to teachers and managers by default.",
  "repo": "moodle/moodle",
  "patch_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
  "patch_info": {
    "commit_hash": "6360f87cdca744a6a71c315853f6d811a3e54e26",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/6360f87cdca744a6a71c315853f6d811a3e54e26",
    "files": [
      "lib/db/access.php",
      "version.php"
    ],
    "message": "MDL-64395 groups: Added XSS Risk to the manage groups capability",
    "before_after_code_files": [
      "lib/db/access.php||lib/db/access.php",
      "version.php||version.php"
    ]
  },
  "patch_diff": {
    "lib/db/access.php||lib/db/access.php": [
      "File: lib/db/access.php -> lib/db/access.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1123:     ),",
      "1125:     'moodle/course:managegroups' => array(",
      "1127:         'captype' => 'write',",
      "1128:         'contextlevel' => CONTEXT_COURSE,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1126:         'riskbitmask' => RISK_XSS,",
      "",
      "---------------"
    ],
    "version.php||version.php": [
      "File: version.php -> version.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: defined('MOODLE_INTERNAL') || die();",
      "",
      "[Removed Lines]",
      "32: $version  = 2018122000.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "[Added Lines]",
      "32: $version  = 2018122000.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5b4ca9eb5b12f3df982219504f3f1cef813c0a1d",
      "candidate_info": {
        "commit_hash": "5b4ca9eb5b12f3df982219504f3f1cef813c0a1d",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5b4ca9eb5b12f3df982219504f3f1cef813c0a1d",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018051700.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180524)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018053100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180531)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d7699706da7f438008c2137c5fb71826d1e22c1e",
      "candidate_info": {
        "commit_hash": "d7699706da7f438008c2137c5fb71826d1e22c1e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d7699706da7f438008c2137c5fb71826d1e22c1e",
        "files": [
          "version.php"
        ],
        "message": "on-demand release 3.8dev+",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '38';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2019102500.04;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191025)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2019103000.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.8dev+ (Build: 20191030)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6b036d04cf7fdfd996e22fade02f4e269d27e70e",
      "candidate_info": {
        "commit_hash": "6b036d04cf7fdfd996e22fade02f4e269d27e70e",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/6b036d04cf7fdfd996e22fade02f4e269d27e70e",
        "files": [
          "lib/db/upgrade.php",
          "message/classes/api.php",
          "version.php"
        ],
        "message": "MDL-63692 core_message: Fix the context for favourite conversations\n\nThe converation favourites were previously set in the system context\nwhich is not right, as they should be stored:\n- In the conversation context when defined.\n- In the user context, when contextid is null (that means is an\nindividual conversation).",
        "before_after_code_files": [
          "lib/db/upgrade.php||lib/db/upgrade.php",
          "message/classes/api.php||message/classes/api.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/db/upgrade.php||lib/db/upgrade.php": [
          "File: lib/db/upgrade.php -> lib/db/upgrade.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2784:         upgrade_main_savepoint(true, 2018111300.01);",
          "2785:     }",
          "2787:     return true;",
          "2788: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2787:     if ($oldversion < 2018111300.02) {",
          "2789:         $sql = \"SELECT f.*, mc.contextid as conversationctx",
          "2790:                   FROM {favourite} f",
          "2791:                   JOIN {message_conversations} mc",
          "2792:                     ON mc.id = f.itemid\";",
          "2793:         $favouritedconversations = $DB->get_records_sql($sql);",
          "2794:         foreach ($favouritedconversations as $fc) {",
          "2795:             if (empty($fc->conversationctx)) {",
          "2796:                 $conversationidctx = \\context_user::instance($fc->userid)->id;",
          "2797:             } else {",
          "2798:                 $conversationidctx = $fc->conversationctx;",
          "2799:             }",
          "2801:             $DB->set_field('favourite', 'contextid', $conversationidctx, ['id' => $fc->id]);",
          "2802:         }",
          "2804:         upgrade_main_savepoint(true, 2018111300.02);",
          "2805:     }",
          "",
          "---------------"
        ],
        "message/classes/api.php||message/classes/api.php": [
          "File: message/classes/api.php -> message/classes/api.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "786:     public static function set_favourite_conversation(int $conversationid, int $userid) : favourite {",
          "787:         if (!self::is_user_in_conversation($userid, $conversationid)) {",
          "788:             throw new \\moodle_exception(\"Conversation doesn't exist or user is not a member\");",
          "789:         }",
          "792:     }",
          "",
          "[Removed Lines]",
          "790:         $ufservice = \\core_favourites\\service_factory::get_service_for_user_context(\\context_user::instance($userid));",
          "791:         return $ufservice->create_favourite('core_message', 'message_conversations', $conversationid, \\context_system::instance());",
          "",
          "[Added Lines]",
          "787:         global $DB;",
          "793:         $conversation = $DB->get_record('message_conversations', ['id' => $conversationid]);",
          "794:         $userctx = \\context_user::instance($userid);",
          "795:         if (empty($conversation->contextid)) {",
          "797:             $conversationctx = $userctx;",
          "798:         } else {",
          "800:             $conversationctx = \\context::instance_by_id($conversation->contextid);",
          "801:         }",
          "803:         $ufservice = \\core_favourites\\service_factory::get_service_for_user_context($userctx);",
          "804:         return $ufservice->create_favourite('core_message', 'message_conversations', $conversationid, $conversationctx);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "801:     public static function unset_favourite_conversation(int $conversationid, int $userid) {",
          "804:     }",
          "",
          "[Removed Lines]",
          "802:         $ufservice = \\core_favourites\\service_factory::get_service_for_user_context(\\context_user::instance($userid));",
          "803:         $ufservice->delete_favourite('core_message', 'message_conversations', $conversationid, \\context_system::instance());",
          "",
          "[Added Lines]",
          "815:         global $DB;",
          "818:         $conversation = $DB->get_records('message_conversations', ['id' => $conversationid]);",
          "819:         $userctx = \\context_user::instance($userid);",
          "820:         if (empty($conversation->contextid)) {",
          "822:             $conversationctx = $userctx;",
          "823:         } else {",
          "825:             $conversationctx = \\context::instance_by_id($conversation->contextid);",
          "826:         }",
          "828:         $ufservice = \\core_favourites\\service_factory::get_service_for_user_context($userctx);",
          "829:         $ufservice->delete_favourite('core_message', 'message_conversations', $conversationid, $conversationctx);",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2018111300.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2018111300.02;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f61ee4e857a894a5b8b69516b00be88ae499964b",
      "candidate_info": {
        "commit_hash": "f61ee4e857a894a5b8b69516b00be88ae499964b",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/f61ee4e857a894a5b8b69516b00be88ae499964b",
        "files": [
          "version.php"
        ],
        "message": "weekly release 3.6dev",
        "before_after_code_files": [
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "38: $branch   = '36';                       // This version's branch.",
          "39: $maturity = MATURITY_ALPHA;             // This version's maturity level.",
          "",
          "[Removed Lines]",
          "32: $version  = 2018062100.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180621)'; // Human-friendly version name",
          "",
          "[Added Lines]",
          "32: $version  = 2018062800.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "36: $release  = '3.6dev (Build: 20180628)'; // Human-friendly version name",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9ee83d1d98491704037e5f8a557a2dbcedfe0999",
      "candidate_info": {
        "commit_hash": "9ee83d1d98491704037e5f8a557a2dbcedfe0999",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/9ee83d1d98491704037e5f8a557a2dbcedfe0999",
        "files": [
          "admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/classes/external.php",
          "admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php",
          "version.php"
        ],
        "message": "Merge branch 'MDL-66775-master' of git://github.com/jleyva/moodle",
        "before_after_code_files": [
          "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php",
          "admin/tool/mobile/classes/external.php||admin/tool/mobile/classes/external.php",
          "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php",
          "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php",
          "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php",
          "version.php||version.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.php||version.php"
          ],
          "candidate": [
            "version.php||version.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/mobile/classes/api.php||admin/tool/mobile/classes/api.php": [
          "File: admin/tool/mobile/classes/api.php -> admin/tool/mobile/classes/api.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "177:             'langmenu' => $CFG->langmenu,",
          "178:             'langlist' => $CFG->langlist,",
          "179:             'locale' => $CFG->locale,",
          "180:         );",
          "182:         $typeoflogin = get_config('tool_mobile', 'typeoflogin');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "180:             'tool_mobile_minimumversion' => get_config('tool_mobile', 'minimumversion'),",
          "181:             'tool_mobile_iosappid' => get_config('tool_mobile', 'iosappid'),",
          "182:             'tool_mobile_androidappid' => get_config('tool_mobile', 'androidappid'),",
          "183:             'tool_mobile_setuplink' => clean_param(get_config('tool_mobile', 'setuplink'), PARAM_URL),",
          "",
          "---------------"
        ],
        "admin/tool/mobile/classes/external.php||admin/tool/mobile/classes/external.php": [
          "File: admin/tool/mobile/classes/external.php -> admin/tool/mobile/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "179:                 'langmenu' => new external_value(PARAM_INT, 'Whether the language menu should be displayed.', VALUE_OPTIONAL),",
          "180:                 'langlist' => new external_value(PARAM_RAW, 'Languages on language menu.', VALUE_OPTIONAL),",
          "181:                 'locale' => new external_value(PARAM_RAW, 'Sitewide locale.', VALUE_OPTIONAL),",
          "182:                 'warnings' => new external_warnings(),",
          "183:             )",
          "184:         );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "182:                 'tool_mobile_minimumversion' => new external_value(PARAM_NOTAGS, 'Minimum required version to access.',",
          "183:                     VALUE_OPTIONAL),",
          "184:                 'tool_mobile_iosappid' => new external_value(PARAM_ALPHANUM, 'iOS app\\'s unique identifier.',",
          "185:                     VALUE_OPTIONAL),",
          "186:                 'tool_mobile_androidappid' => new external_value(PARAM_NOTAGS, 'Android app\\'s unique identifier.',",
          "187:                     VALUE_OPTIONAL),",
          "188:                 'tool_mobile_setuplink' => new external_value(PARAM_URL, 'App download page.', VALUE_OPTIONAL),",
          "",
          "---------------"
        ],
        "admin/tool/mobile/lang/en/tool_mobile.php||admin/tool/mobile/lang/en/tool_mobile.php": [
          "File: admin/tool/mobile/lang/en/tool_mobile.php -> admin/tool/mobile/lang/en/tool_mobile.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "75: $string['logininthebrowser'] = 'Via a browser window (for SSO plugins)';",
          "76: $string['loginintheembeddedbrowser'] = 'Via an embedded browser (for SSO plugins)';",
          "77: $string['mainmenu'] = 'Main menu';",
          "78: $string['mobileapp'] = 'Mobile app';",
          "79: $string['mobileappconnected'] = 'Mobile app connected';",
          "80: $string['mobileappenabled'] = 'This site has mobile app access enabled.<br /><a href=\"{$a}\">Download the mobile app</a>.';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78: $string['minimumversion'] = 'Require users to upgrade their apps to the minimum version indicated. Those using previous versions of the app will not be able to access to the site. This works since app version 3.8.0 onward.';",
          "79: $string['minimumversion_key'] = 'Minimum app version required';",
          "",
          "---------------"
        ],
        "admin/tool/mobile/settings.php||admin/tool/mobile/settings.php": [
          "File: admin/tool/mobile/settings.php -> admin/tool/mobile/settings.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:                     new lang_string('forcedurlscheme_key', 'tool_mobile'),",
          "66:                     new lang_string('forcedurlscheme', 'tool_mobile'), 'moodlemobile', PARAM_ALPHANUM));",
          "68:         $ADMIN->add('mobileapp', $temp);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:         $temp->add(new admin_setting_configtext('tool_mobile/minimumversion',",
          "69:                     new lang_string('minimumversion_key', 'tool_mobile'),",
          "70:                     new lang_string('minimumversion', 'tool_mobile'), '', PARAM_NOTAGS));",
          "",
          "---------------"
        ],
        "admin/tool/mobile/tests/externallib_test.php||admin/tool/mobile/tests/externallib_test.php": [
          "File: admin/tool/mobile/tests/externallib_test.php -> admin/tool/mobile/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:             'langmenu' => $CFG->langmenu,",
          "96:             'langlist' => $CFG->langlist,",
          "97:             'locale' => $CFG->locale,",
          "98:             'warnings' => array()",
          "99:         );",
          "100:         $this->assertEquals($expected, $result);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "98:             'tool_mobile_minimumversion' => '',",
          "99:             'tool_mobile_iosappid' => get_config('tool_mobile', 'iosappid'),",
          "100:             'tool_mobile_androidappid' => get_config('tool_mobile', 'androidappid'),",
          "101:             'tool_mobile_setuplink' => get_config('tool_mobile', 'setuplink'),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111:         set_config('autolang', 1);",
          "112:         set_config('lang', 'a_b');  // Set invalid lang.",
          "113:         set_config('disabledfeatures', 'myoverview', 'tool_mobile');",
          "115:         list($authinstructions, $notusedformat) = external_format_text($authinstructions, FORMAT_MOODLE, $context->id);",
          "116:         $expected['registerauth'] = 'email';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "118:         set_config('minimumversion', '3.8.0', 'tool_mobile');",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123:         $expected['autolang'] = '1';",
          "124:         $expected['lang'] = ''; // Expect empty because it was set to an invalid lang.",
          "125:         $expected['tool_mobile_disabledfeatures'] = 'myoverview';",
          "127:         if ($logourl = $OUTPUT->get_logo_url()) {",
          "128:             $expected['logourl'] = $logourl->out(false);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "131:         $expected['tool_mobile_minimumversion'] = '3.8.0';",
          "",
          "---------------"
        ],
        "version.php||version.php": [
          "File: version.php -> version.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: defined('MOODLE_INTERNAL') || die();",
          "",
          "[Removed Lines]",
          "32: $version  = 2019100400.00;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "[Added Lines]",
          "32: $version  = 2019100400.01;              // YYYYMMDD      = weekly release date of this DEV branch.",
          "",
          "---------------"
        ]
      }
    }
  ]
}