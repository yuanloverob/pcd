{
  "cve_id": "CVE-2021-20279",
  "cve_desc": "The ID number user profile field required additional sanitizing to prevent a stored XSS risk in moodle before 3.10.2, 3.9.5, 3.8.8, 3.5.17.",
  "repo": "moodle/moodle",
  "patch_hash": "a7e0ba1e71205ccb0a73dedee414f1a167ee2ed7",
  "patch_info": {
    "commit_hash": "a7e0ba1e71205ccb0a73dedee414f1a167ee2ed7",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/a7e0ba1e71205ccb0a73dedee414f1a167ee2ed7",
    "files": [
      "admin/tool/uploaduser/user_form.php",
      "blocks/activity_results/block_activity_results.php",
      "grade/report/user/externallib.php",
      "lib/myprofilelib.php"
    ],
    "message": "MDL-65552 user: escape idnumber field on output.\n\nThis commit also corrects parameter definition of the field to\nmatch core_user.",
    "before_after_code_files": [
      "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php",
      "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php",
      "grade/report/user/externallib.php||grade/report/user/externallib.php",
      "lib/myprofilelib.php||lib/myprofilelib.php"
    ]
  },
  "patch_diff": {
    "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
      "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "305:         $mform->setAdvanced('url');",
      "307:         $mform->addElement('text', 'idnumber', get_string('idnumber'), 'maxlength=\"255\" size=\"25\"');",
      "309:         $mform->setForceLtr('idnumber');",
      "311:         $mform->addElement('text', 'institution', get_string('institution'), 'maxlength=\"255\" size=\"25\"');",
      "",
      "[Removed Lines]",
      "308:         $mform->setType('idnumber', PARAM_NOTAGS);",
      "",
      "[Added Lines]",
      "308:         $mform->setType('idnumber', core_user::get_property_type('idnumber'));",
      "",
      "---------------"
    ],
    "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php": [
      "File: blocks/activity_results/block_activity_results.php -> blocks/activity_results/block_activity_results.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "512:                 $fields = implode(',', $fields);",
      "513:                 $users = $DB->get_records_list('user', 'id', $userids, '', $fields);",
      "516:                 if ($activity->gradetype == GRADE_TYPE_SCALE) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "516:                 $extrafields = get_extra_user_fields($this->context);",
      "517:                 $canviewidnumber = (array_search('idnumber', $extrafields) !== false);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "537:                     }",
      "538:                     $this->content->text .= '</h6></caption><colgroup class=\"number\" />';",
      "539:                     $this->content->text .= '<colgroup class=\"name\" /><colgroup class=\"grade\" /><tbody>';",
      "540:                     foreach ($best as $userid => $gradeid) {",
      "541:                         switch ($nameformat) {",
      "542:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ID:",
      "544:                             break;",
      "545:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ANON:",
      "546:                                 $thisname = get_string('user');",
      "",
      "[Removed Lines]",
      "543:                                 $thisname = get_string('user').' '.$users[$userid]->idnumber;",
      "",
      "[Added Lines]",
      "548:                                 $thisname = get_string('user');",
      "549:                                 if ($canviewidnumber) {",
      "550:                                     $thisname .= ' ' . s($users[$userid]->idnumber);",
      "551:                                 }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "603:                     foreach ($worst as $userid => $gradeid) {",
      "604:                         switch ($nameformat) {",
      "605:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ID:",
      "607:                             break;",
      "608:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ANON:",
      "609:                                 $thisname = get_string('user');",
      "",
      "[Removed Lines]",
      "606:                                 $thisname = get_string('user').' '.$users[$userid]->idnumber;",
      "",
      "[Added Lines]",
      "614:                                 $thisname = get_string('user');",
      "615:                                 if ($canviewidnumber) {",
      "616:                                     $thisname .= ' ' . s($users[$userid]->idnumber);",
      "617:                                 };",
      "",
      "---------------"
    ],
    "grade/report/user/externallib.php||grade/report/user/externallib.php": [
      "File: grade/report/user/externallib.php -> grade/report/user/externallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "480:                             'courseid' => new external_value(PARAM_INT, 'course id'),",
      "481:                             'userid'   => new external_value(PARAM_INT, 'user id'),",
      "482:                             'userfullname' => new external_value(PARAM_TEXT, 'user fullname'),",
      "484:                             'maxdepth'   => new external_value(PARAM_INT, 'table max depth (needed for printing it)'),",
      "485:                             'gradeitems' => new external_multiple_structure(",
      "486:                                 new external_single_structure(",
      "",
      "[Removed Lines]",
      "483:                             'useridnumber' => new external_value(PARAM_TEXT, 'user idnumber'),",
      "",
      "[Added Lines]",
      "483:                             'useridnumber' => new external_value(",
      "484:                                 core_user::get_property_type('idnumber'), 'user idnumber'),",
      "",
      "---------------"
    ],
    "lib/myprofilelib.php||lib/myprofilelib.php": [
      "File: lib/myprofilelib.php -> lib/myprofilelib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "220:     if (isset($identityfields['idnumber']) && $user->idnumber) {",
      "221:         $node = new core_user\\output\\myprofile\\node('contact', 'idnumber', get_string('idnumber'), null, null,",
      "223:         $tree->add_node($node);",
      "224:     }",
      "",
      "[Removed Lines]",
      "222:             $user->idnumber);",
      "",
      "[Added Lines]",
      "222:             s($user->idnumber));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bee5d9d27e016b3ee9aff5c13b6ea705c650980b",
      "candidate_info": {
        "commit_hash": "bee5d9d27e016b3ee9aff5c13b6ea705c650980b",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/bee5d9d27e016b3ee9aff5c13b6ea705c650980b",
        "files": [
          "admin/tool/uploaduser/user_form.php",
          "blocks/activity_results/block_activity_results.php",
          "grade/report/user/externallib.php",
          "lib/myprofilelib.php"
        ],
        "message": "MDL-65552 user: escape idnumber field on output.\n\nThis commit also corrects parameter definition of the field to\nmatch core_user.",
        "before_after_code_files": [
          "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php",
          "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php",
          "grade/report/user/externallib.php||grade/report/user/externallib.php",
          "lib/myprofilelib.php||lib/myprofilelib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php",
            "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php",
            "grade/report/user/externallib.php||grade/report/user/externallib.php",
            "lib/myprofilelib.php||lib/myprofilelib.php"
          ],
          "candidate": [
            "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php",
            "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php",
            "grade/report/user/externallib.php||grade/report/user/externallib.php",
            "lib/myprofilelib.php||lib/myprofilelib.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/tool/uploaduser/user_form.php||admin/tool/uploaduser/user_form.php": [
          "File: admin/tool/uploaduser/user_form.php -> admin/tool/uploaduser/user_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "305:         $mform->setAdvanced('url');",
          "307:         $mform->addElement('text', 'idnumber', get_string('idnumber'), 'maxlength=\"255\" size=\"25\"');",
          "309:         $mform->setForceLtr('idnumber');",
          "311:         $mform->addElement('text', 'institution', get_string('institution'), 'maxlength=\"255\" size=\"25\"');",
          "",
          "[Removed Lines]",
          "308:         $mform->setType('idnumber', PARAM_NOTAGS);",
          "",
          "[Added Lines]",
          "308:         $mform->setType('idnumber', core_user::get_property_type('idnumber'));",
          "",
          "---------------"
        ],
        "blocks/activity_results/block_activity_results.php||blocks/activity_results/block_activity_results.php": [
          "File: blocks/activity_results/block_activity_results.php -> blocks/activity_results/block_activity_results.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "512:                 $fields = implode(',', $fields);",
          "513:                 $users = $DB->get_records_list('user', 'id', $userids, '', $fields);",
          "516:                 if ($activity->gradetype == GRADE_TYPE_SCALE) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "516:                 $extrafields = get_extra_user_fields($this->context);",
          "517:                 $canviewidnumber = (array_search('idnumber', $extrafields) !== false);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "537:                     }",
          "538:                     $this->content->text .= '</h6></caption><colgroup class=\"number\" />';",
          "539:                     $this->content->text .= '<colgroup class=\"name\" /><colgroup class=\"grade\" /><tbody>';",
          "540:                     foreach ($best as $userid => $gradeid) {",
          "541:                         switch ($nameformat) {",
          "542:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ID:",
          "544:                             break;",
          "545:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ANON:",
          "546:                                 $thisname = get_string('user');",
          "",
          "[Removed Lines]",
          "543:                                 $thisname = get_string('user').' '.$users[$userid]->idnumber;",
          "",
          "[Added Lines]",
          "548:                                 $thisname = get_string('user');",
          "549:                                 if ($canviewidnumber) {",
          "550:                                     $thisname .= ' ' . s($users[$userid]->idnumber);",
          "551:                                 }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "603:                     foreach ($worst as $userid => $gradeid) {",
          "604:                         switch ($nameformat) {",
          "605:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ID:",
          "607:                             break;",
          "608:                             case B_ACTIVITYRESULTS_NAME_FORMAT_ANON:",
          "609:                                 $thisname = get_string('user');",
          "",
          "[Removed Lines]",
          "606:                                 $thisname = get_string('user').' '.$users[$userid]->idnumber;",
          "",
          "[Added Lines]",
          "614:                                 $thisname = get_string('user');",
          "615:                                 if ($canviewidnumber) {",
          "616:                                     $thisname .= ' ' . s($users[$userid]->idnumber);",
          "617:                                 };",
          "",
          "---------------"
        ],
        "grade/report/user/externallib.php||grade/report/user/externallib.php": [
          "File: grade/report/user/externallib.php -> grade/report/user/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "480:                             'courseid' => new external_value(PARAM_INT, 'course id'),",
          "481:                             'userid'   => new external_value(PARAM_INT, 'user id'),",
          "482:                             'userfullname' => new external_value(PARAM_TEXT, 'user fullname'),",
          "484:                             'maxdepth'   => new external_value(PARAM_INT, 'table max depth (needed for printing it)'),",
          "485:                             'gradeitems' => new external_multiple_structure(",
          "486:                                 new external_single_structure(",
          "",
          "[Removed Lines]",
          "483:                             'useridnumber' => new external_value(PARAM_TEXT, 'user idnumber'),",
          "",
          "[Added Lines]",
          "483:                             'useridnumber' => new external_value(",
          "484:                                 core_user::get_property_type('idnumber'), 'user idnumber'),",
          "",
          "---------------"
        ],
        "lib/myprofilelib.php||lib/myprofilelib.php": [
          "File: lib/myprofilelib.php -> lib/myprofilelib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "210:     if (isset($identityfields['idnumber']) && $user->idnumber) {",
          "211:         $node = new core_user\\output\\myprofile\\node('contact', 'idnumber', get_string('idnumber'), null, null,",
          "213:         $tree->add_node($node);",
          "214:     }",
          "",
          "[Removed Lines]",
          "212:             $user->idnumber);",
          "",
          "[Added Lines]",
          "212:             s($user->idnumber));",
          "",
          "---------------"
        ]
      }
    }
  ]
}