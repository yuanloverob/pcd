{
  "cve_id": "CVE-2022-0282",
  "cve_desc": "Cross-site Scripting in Packagist microweber/microweber prior to 1.2.11.\n\n",
  "repo": "microweber/microweber",
  "patch_hash": "51b5a4e3ef01e587797c0109159a8ad9d2bac77a",
  "patch_info": {
    "commit_hash": "51b5a4e3ef01e587797c0109159a8ad9d2bac77a",
    "repo": "microweber/microweber",
    "commit_url": "https://github.com/microweber/microweber/commit/51b5a4e3ef01e587797c0109159a8ad9d2bac77a",
    "files": [
      "src/MicroweberPackages/Comment/Models/Comment.php",
      "src/MicroweberPackages/Comment/Models/CommentsCrud.php",
      "src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php",
      "userfiles/modules/comments/src/Controllers/Admin.php"
    ],
    "message": "fix comments xss",
    "before_after_code_files": [
      "src/MicroweberPackages/Comment/Models/Comment.php||src/MicroweberPackages/Comment/Models/Comment.php",
      "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php",
      "src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php||src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php",
      "userfiles/modules/comments/src/Controllers/Admin.php||userfiles/modules/comments/src/Controllers/Admin.php"
    ]
  },
  "patch_diff": {
    "src/MicroweberPackages/Comment/Models/Comment.php||src/MicroweberPackages/Comment/Models/Comment.php": [
      "File: src/MicroweberPackages/Comment/Models/Comment.php -> src/MicroweberPackages/Comment/Models/Comment.php"
    ],
    "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php": [
      "File: src/MicroweberPackages/Comment/Models/CommentsCrud.php -> src/MicroweberPackages/Comment/Models/CommentsCrud.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "54:                 if (isset($item['comment_body']) and ($item['comment_body'] != '')) {",
      "55:                     $surl = site_url();",
      "56:                     $item['comment_body'] = str_replace('{SITE_URL}', $surl, $item['comment_body']);",
      "58:                 }",
      "60:                 if (isset($params['single'])) {",
      "",
      "[Removed Lines]",
      "57:                     $comments[$i]['comment_body'] = $item['comment_body']; // mw()->format->autolink($item['comment_body']);",
      "",
      "[Added Lines]",
      "57:                     $comments[$i]['comment_body'] = htmlentities($item['comment_body']);",
      "",
      "---------------"
    ],
    "src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php||src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php": [
      "File: src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php -> src/MicroweberPackages/Comment/resources/views/admin/comments/comment_item.blade.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "55:                         </h6>",
      "57:                     <div class=\"mb-3\">",
      "59:                         <span class=\"js-comment-body-textarea\" style=\"display: none;\">",
      "60:                             <small class=\"text-muted\">Comment:</small>",
      "62:                         </span>",
      "63:                     </div>",
      "",
      "[Removed Lines]",
      "58:                         <div class=\"js-comment-body-text\"><?php print $comment['comment_body']; ?></div>",
      "61:                             <textarea name=\"comment_body\" class=\"form-control\"><?php print $comment['comment_body']; ?></textarea>",
      "",
      "[Added Lines]",
      "58:                         <div class=\"js-comment-body-text\">{{ $comment['comment_body'] }}</div>",
      "61:                             <textarea name=\"comment_body\" class=\"form-control\">{{ $comment['comment_body'] }}</textarea>",
      "",
      "---------------"
    ],
    "userfiles/modules/comments/src/Controllers/Admin.php||userfiles/modules/comments/src/Controllers/Admin.php": [
      "File: userfiles/modules/comments/src/Controllers/Admin.php -> userfiles/modules/comments/src/Controllers/Admin.php"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bdf1565dc42346c8bc0a73f3a53242973737fcd0",
      "candidate_info": {
        "commit_hash": "bdf1565dc42346c8bc0a73f3a53242973737fcd0",
        "repo": "microweber/microweber",
        "commit_url": "https://github.com/microweber/microweber/commit/bdf1565dc42346c8bc0a73f3a53242973737fcd0",
        "files": [
          "src/MicroweberPackages/App/Managers/UpdateManager.php",
          "src/MicroweberPackages/Comment/Models/CommentsCrud.php",
          "src/MicroweberPackages/Install/Http/Controllers/InstallController.php",
          "src/MicroweberPackages/Package/tests/PackageManagerTest.php"
        ],
        "message": "fix package manager unit test",
        "before_after_code_files": [
          "src/MicroweberPackages/App/Managers/UpdateManager.php||src/MicroweberPackages/App/Managers/UpdateManager.php",
          "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php",
          "src/MicroweberPackages/Install/Http/Controllers/InstallController.php||src/MicroweberPackages/Install/Http/Controllers/InstallController.php",
          "src/MicroweberPackages/Package/tests/PackageManagerTest.php||src/MicroweberPackages/Package/tests/PackageManagerTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php"
          ],
          "candidate": [
            "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php"
          ]
        }
      },
      "candidate_diff": {
        "src/MicroweberPackages/App/Managers/UpdateManager.php||src/MicroweberPackages/App/Managers/UpdateManager.php": [
          "File: src/MicroweberPackages/App/Managers/UpdateManager.php -> src/MicroweberPackages/App/Managers/UpdateManager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: namespace MicroweberPackages\\App\\Managers;",
          "5: use Illuminate\\Support\\Facades\\Config;",
          "7: use MicroweberPackages\\Package\\MicroweberComposerClient;",
          "9: if (defined('INI_SYSTEM_CHECK_DISABLED') == false) {",
          "",
          "[Removed Lines]",
          "6: use MicroweberPackages\\Package\\ComposerUpdate;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/MicroweberPackages/Comment/Models/CommentsCrud.php||src/MicroweberPackages/Comment/Models/CommentsCrud.php": [
          "File: src/MicroweberPackages/Comment/Models/CommentsCrud.php -> src/MicroweberPackages/Comment/Models/CommentsCrud.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "62:                     $comment_body = $clearInput->onlyTags($comment_body);",
          "64:                     $pq = \\phpQuery::newDocument($comment_body);",
          "66:                     $comment_body = $pq->htmlOuter();",
          "68:                     $comments[$i]['comment_body'] = $comment_body;",
          "",
          "[Removed Lines]",
          "65:                     $pq->find('a')->attr('rel','nofollow ugc');",
          "",
          "[Added Lines]",
          "65:                     $pq->find('a')",
          "66:                         ->attr('rel','nofollow ugc')",
          "67:                         ->attr('target','_blank');",
          "",
          "---------------"
        ],
        "src/MicroweberPackages/Install/Http/Controllers/InstallController.php||src/MicroweberPackages/Install/Http/Controllers/InstallController.php": [
          "File: src/MicroweberPackages/Install/Http/Controllers/InstallController.php -> src/MicroweberPackages/Install/Http/Controllers/InstallController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: use MicroweberPackages\\Translation\\TranslationPackageInstallHelper;",
          "18: use MicroweberPackages\\User\\Models\\User;",
          "19: use MicroweberPackages\\Utils\\Http\\Http;",
          "21: use MicroweberPackages\\View\\View;",
          "22: use MicroweberPackages\\Install;",
          "",
          "[Removed Lines]",
          "20: use MicroweberPackages\\Package\\ComposerUpdate;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/MicroweberPackages/Package/tests/PackageManagerTest.php||src/MicroweberPackages/Package/tests/PackageManagerTest.php": [
          "File: src/MicroweberPackages/Package/tests/PackageManagerTest.php -> src/MicroweberPackages/Package/tests/PackageManagerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: class PackageManagerTest extends \\MicroweberPackages\\Core\\tests\\TestCase",
          "5: {",
          "9:     public $skip = false;",
          "11:     public function __construct()",
          "",
          "[Removed Lines]",
          "6:     public $repos = [",
          "7:         [\"type\" => \"composer\", \"url\" => \"https://packages-phpunit.microweberapi.com/\"]",
          "8:     ];",
          "",
          "[Added Lines]",
          "6:     public $repoUrl = 'https://packages-phpunit.microweberapi.com/';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "21:         if ($this->skip) {",
          "22:             $this->markTestSkipped('Skipping package manager test for this server configuration!');",
          "23:         }",
          "36:         $this->assertNotEmpty($results);",
          "37:     }",
          "",
          "[Removed Lines]",
          "25:         $params= [];",
          "26:         $params['keyword'] = 'dream';",
          "28:         $runner = new \\MicroweberPackages\\Package\\ComposerUpdate($this->_getComposerPath());",
          "30:         $runner->setRepos($this->repos);",
          "31:         $runner->setTargetPath($this->_getTargetPath());",
          "32:         $runner->setComposerHome(dirname(__DIR__) . '/cache');",
          "34:         $results = $runner->searchPackages($params);",
          "",
          "[Added Lines]",
          "23:         $params = [];",
          "24:         $params['require_name'] = 'microweber-templates/dream';",
          "26:         $runner = new \\MicroweberPackages\\Package\\MicroweberComposerClient();",
          "27:         $runner->packageServers = [$this->repoUrl];",
          "29:         $results = $runner->search($params);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "42:             $this->markTestSkipped('Skipping package manager test for this server configuration!');",
          "43:         }",
          "47:         $require_name = \"microweber-templates/dream\";",
          "48:         $params['require_name'] = $require_name;",
          "60:         $this->assertNotEmpty($results);",
          "61:         $this->assertEquals($results[\"error\"], \"Please confirm installation\");",
          "",
          "[Removed Lines]",
          "50:         $runner = new \\MicroweberPackages\\Package\\ComposerUpdate($this->_getComposerPath());",
          "53:         $runner->setRepos($this->repos);",
          "54:         $runner->setTargetPath($this->_getTargetPath());",
          "55:         $runner->setComposerHome(dirname(__DIR__) . '/cache');",
          "57:         $results = $runner->installPackageByName($params);",
          "",
          "[Added Lines]",
          "43:         $runner = new \\MicroweberPackages\\Package\\MicroweberComposerClient();",
          "44:         $runner->packageServers = [$this->repoUrl];",
          "46:         $results = $runner->requestInstall($params);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "63:         $this->assertNotEmpty($results[\"form_data_module_params\"][\"confirm_key\"]);",
          "84:     }",
          "86:     private function isOnline()",
          "",
          "[Removed Lines]",
          "74:     }",
          "76:     private function _getComposerPath()",
          "77:     {",
          "78:         return dirname(__DIR__) . '/';",
          "79:     }",
          "81:     private function _getTargetPath()",
          "82:     {",
          "83:         return dirname(__DIR__);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "98:             return true;",
          "99:         }",
          "102:     }",
          "",
          "[Removed Lines]",
          "103: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}