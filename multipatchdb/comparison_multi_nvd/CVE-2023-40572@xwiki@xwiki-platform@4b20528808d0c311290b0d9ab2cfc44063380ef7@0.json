{
  "cve_id": "CVE-2023-40572",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The create action is vulnerable to a CSRF attack, allowing script and thus remote code execution when targeting a user with script/programming right, thus compromising the confidentiality, integrity and availability of the whole XWiki installation. When a user with script right views this image and a log message `ERROR foo - Script executed!` appears in the log, the XWiki installation is vulnerable. This has been patched in XWiki 14.10.9 and 15.4RC1 by requiring a CSRF token for the actual page creation.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "4b20528808d0c311290b0d9ab2cfc44063380ef7",
  "patch_info": {
    "commit_hash": "4b20528808d0c311290b0d9ab2cfc44063380ef7",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/4b20528808d0c311290b0d9ab2cfc44063380ef7",
    "files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
    ],
    "message": "XWIKI-20849: Require a CSRF token in the create action",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "23: import java.util.Locale;",
      "24: import java.util.Map;",
      "26: import javax.inject.Named;",
      "27: import javax.inject.Provider;",
      "28: import javax.inject.Singleton;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "26: import javax.inject.Inject;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "97:     private static final String LOCAL_SERIALIZER_HINT = \"local\";",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "100:     @Inject",
      "101:     private CSRFToken csrf;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "185:         checkRights(newDocumentReference.getLastSpaceReference(), context);",
      "188:         XWikiDocument newDocument = context.getWiki().getDocument(newDocumentReference, context);",
      "189:         if (handler.isDocumentAlreadyExisting(newDocument) || handler.isDocumentPathTooLong(newDocumentReference)",
      "191:             return CREATE_TEMPLATE;",
      "192:         }",
      "",
      "[Removed Lines]",
      "190:             || !this.isEntityReferenceNameValid(newDocumentReference)) {",
      "",
      "[Added Lines]",
      "195:             || !this.isEntityReferenceNameValid(newDocumentReference)",
      "196:             || !this.csrf.isTokenValid(context.getRequest().getParameter(\"form_token\")))",
      "197:         {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "334:             redirectParams += \"&title=\" + Util.encodeURI(title, null);",
      "335:         }",
      "340:         return redirectParams;",
      "341:     }",
      "",
      "[Removed Lines]",
      "337:         CSRFToken csrf = Utils.getComponent(CSRFToken.class);",
      "338:         redirectParams += \"&form_token=\" + Util.encodeURI(csrf.getToken(), null);",
      "",
      "[Added Lines]",
      "344:         redirectParams += \"&form_token=\" + Util.encodeURI(this.csrf.getToken(), null);",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "72: @OldcoreTest",
      "73: class CreateActionTest",
      "74: {",
      "75:     @InjectMockitoOldcore",
      "76:     MockitoOldcore oldcore;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "75:     private static final String CSRF_TOKEN_VALUE = \"token4234343\";",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "125:         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");",
      "127:         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);",
      "128:     }",
      "130:     @Test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "131:         when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);",
      "132:         when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);",
      "133:         when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "137:         when(document.isNew()).thenReturn(true);",
      "138:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "139:         context.setDoc(document);",
      "144:         String result = action.render(context);",
      "",
      "[Removed Lines]",
      "140:         String csrfTokenValue = \"token42\";",
      "141:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "149:         assertNull(result);",
      "151:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "153:             null, \"xwiki\",",
      "154:             context);",
      "155:     }",
      "157:     @Test",
      "158:     void newDocumentButNonTerminalFromURL() throws Exception",
      "159:     {",
      "",
      "[Removed Lines]",
      "152:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "156:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "161:     @Test",
      "162:     void newDocumentFromURLWithInvalidToken() throws Exception",
      "163:     {",
      "165:         DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");",
      "166:         XWikiDocument document = mock(XWikiDocument.class);",
      "167:         when(document.getDocumentReference()).thenReturn(documentReference);",
      "168:         when(document.isNew()).thenReturn(true);",
      "169:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "170:         this.context.setDoc(document);",
      "173:         when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");",
      "176:         String result = this.action.render(this.context);",
      "182:         assertEquals(\"create\", result);",
      "185:         verify(this.csrfToken).isTokenValid(\"fakeToken\");",
      "188:         verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),",
      "189:             any(XWikiContext.class));",
      "190:     }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "164:         when(document.isNew()).thenReturn(true);",
      "165:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "166:         context.setDoc(document);",
      "171:         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");",
      "",
      "[Removed Lines]",
      "167:         String csrfTokenValue = \"token432\";",
      "168:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "179:         assertNull(result);",
      "181:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "183:             \"xwiki\", context);",
      "184:     }",
      "",
      "[Removed Lines]",
      "182:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
      "",
      "[Added Lines]",
      "215:         verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);",
      "218:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "216:         when(document.isNew()).thenReturn(true);",
      "217:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "218:         context.setDoc(document);",
      "223:         String result = action.render(context);",
      "",
      "[Removed Lines]",
      "219:         String csrfTokenValue = \"token4234\";",
      "220:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "231:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
      "233:             context);",
      "234:     }",
      "",
      "[Removed Lines]",
      "232:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "266:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "243:         when(document.isNew()).thenReturn(true);",
      "244:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "245:         context.setDoc(document);",
      "250:         String result = action.render(context);",
      "",
      "[Removed Lines]",
      "246:         String csrfTokenValue = \"token34342\";",
      "247:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "259:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "261:             \"xwiki\", context);",
      "262:     }",
      "",
      "[Removed Lines]",
      "260:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
      "",
      "[Added Lines]",
      "292:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "271:         when(document.isNew()).thenReturn(true);",
      "272:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "273:         context.setDoc(document);",
      "278:         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");",
      "",
      "[Removed Lines]",
      "274:         String csrfTokenValue = \"token4234343\";",
      "275:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "289:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "291:             context);",
      "292:     }",
      "",
      "[Removed Lines]",
      "290:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "320:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "355:         when(document.isNew()).thenReturn(false);",
      "356:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "357:         context.setDoc(document);",
      "362:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");",
      "",
      "[Removed Lines]",
      "358:         String csrfTokenValue = \"token424345\";",
      "359:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 14 ---",
      "[Context before]",
      "374:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "376:             \"xwiki\", context);",
      "377:     }",
      "",
      "[Removed Lines]",
      "375:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
      "",
      "[Added Lines]",
      "403:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
      "",
      "---------------",
      "--- Hunk 15 ---",
      "[Context before]",
      "386:         when(document.isNew()).thenReturn(false);",
      "387:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "388:         context.setDoc(document);",
      "393:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");",
      "",
      "[Removed Lines]",
      "389:         String csrfTokenValue = \"token42124343\";",
      "390:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 16 ---",
      "[Context before]",
      "405:         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",",
      "407:             \"xwiki\", context);",
      "408:     }",
      "",
      "[Removed Lines]",
      "406:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,",
      "",
      "[Added Lines]",
      "432:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,",
      "",
      "---------------",
      "--- Hunk 17 ---",
      "[Context before]",
      "417:         when(document.isNew()).thenReturn(false);",
      "418:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "419:         context.setDoc(document);",
      "424:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");",
      "",
      "[Removed Lines]",
      "420:         String csrfTokenValue = \"token424334466\";",
      "421:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 18 ---",
      "[Context before]",
      "437:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "439:             context);",
      "440:     }",
      "",
      "[Removed Lines]",
      "438:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "462:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 19 ---",
      "[Context before]",
      "449:         when(document.isNew()).thenReturn(false);",
      "450:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "451:         context.setDoc(document);",
      "456:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");",
      "",
      "[Removed Lines]",
      "452:         String csrfTokenValue = \"token429988\";",
      "453:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 20 ---",
      "[Context before]",
      "469:         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",",
      "471:             context);",
      "472:     }",
      "",
      "[Removed Lines]",
      "470:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "492:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 21 ---",
      "[Context before]",
      "581:         when(document.isNew()).thenReturn(false);",
      "582:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "583:         context.setDoc(document);",
      "588:         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");",
      "",
      "[Removed Lines]",
      "584:         String csrfTokenValue = \"token42009\";",
      "585:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 22 ---",
      "[Context before]",
      "599:         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",",
      "601:             context);",
      "602:     }",
      "",
      "[Removed Lines]",
      "600:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "620:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 23 ---",
      "[Context before]",
      "615:         when(document.isNew()).thenReturn(false);",
      "616:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "617:         context.setDoc(document);",
      "622:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
      "",
      "[Removed Lines]",
      "618:         String csrfTokenValue = \"token4233311\";",
      "619:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 24 ---",
      "[Context before]",
      "634:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "636:             context);",
      "637:     }",
      "",
      "[Removed Lines]",
      "635:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "653:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 25 ---",
      "[Context before]",
      "646:         when(document.isNew()).thenReturn(false);",
      "647:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "648:         context.setDoc(document);",
      "653:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");",
      "",
      "[Removed Lines]",
      "649:         String csrfTokenValue = \"token422112455\";",
      "650:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 26 ---",
      "[Context before]",
      "666:         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",",
      "668:             context);",
      "669:     }",
      "",
      "[Removed Lines]",
      "667:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "683:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 27 ---",
      "[Context before]",
      "678:         when(document.isNew()).thenReturn(false);",
      "679:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "680:         context.setDoc(document);",
      "685:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
      "",
      "[Removed Lines]",
      "681:         String csrfTokenValue = \"token42778900\";",
      "682:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 28 ---",
      "[Context before]",
      "697:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
      "699:             context);",
      "700:     }",
      "",
      "[Removed Lines]",
      "698:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "712:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 29 ---",
      "[Context before]",
      "709:         when(document.isNew()).thenReturn(false);",
      "710:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "711:         context.setDoc(document);",
      "716:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
      "",
      "[Removed Lines]",
      "712:         String csrfTokenValue = \"token4344119982\";",
      "713:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 30 ---",
      "[Context before]",
      "730:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
      "732:             context);",
      "733:     }",
      "",
      "[Removed Lines]",
      "731:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "743:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 31 ---",
      "[Context before]",
      "742:         when(document.isNew()).thenReturn(false);",
      "743:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "744:         context.setDoc(document);",
      "749:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");",
      "",
      "[Removed Lines]",
      "745:         String csrfTokenValue = \"token425553\";",
      "746:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 32 ---",
      "[Context before]",
      "762:         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",",
      "764:             \"xwiki\", context);",
      "765:     }",
      "",
      "[Removed Lines]",
      "763:             \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,",
      "",
      "[Added Lines]",
      "773:             \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
      "",
      "---------------",
      "--- Hunk 33 ---",
      "[Context before]",
      "901:         when(document.isNew()).thenReturn(false);",
      "902:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "903:         context.setDoc(document);",
      "908:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "904:         String csrfTokenValue = \"token42008766\";",
      "905:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 34 ---",
      "[Context before]",
      "926:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "928:             context);",
      "929:     }",
      "",
      "[Removed Lines]",
      "927:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
      "",
      "[Added Lines]",
      "935:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
      "",
      "---------------",
      "--- Hunk 35 ---",
      "[Context before]",
      "977:         when(document.isNew()).thenReturn(false);",
      "978:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "979:         context.setDoc(document);",
      "984:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "980:         String csrfTokenValue = \"token4221098\";",
      "981:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 36 ---",
      "[Context before]",
      "1006:         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",",
      "1008:             null, \"xwiki\", context);",
      "1009:     }",
      "",
      "[Removed Lines]",
      "1007:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1013:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 37 ---",
      "[Context before]",
      "1132:         when(document.isNew()).thenReturn(true);",
      "1133:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1134:         context.setDoc(document);",
      "1139:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1135:         String csrfTokenValue = \"token42988733\";",
      "1136:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 38 ---",
      "[Context before]",
      "1157:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1159:             null, \"xwiki\", context);",
      "1160:     }",
      "",
      "[Removed Lines]",
      "1158:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1162:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 39 ---",
      "[Context before]",
      "1169:         when(document.isNew()).thenReturn(true);",
      "1170:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1171:         context.setDoc(document);",
      "1176:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1172:         String csrfTokenValue = \"token4222113555\";",
      "1173:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 40 ---",
      "[Context before]",
      "1195:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1197:             null, \"xwiki\", context);",
      "1198:     }",
      "",
      "[Removed Lines]",
      "1196:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1198:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 41 ---",
      "[Context before]",
      "1207:         when(document.isNew()).thenReturn(true);",
      "1208:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1209:         context.setDoc(document);",
      "1214:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1210:         String csrfTokenValue = \"token4200983331\";",
      "1211:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 42 ---",
      "[Context before]",
      "1232:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1234:             null, \"xwiki\", context);",
      "1235:     }",
      "",
      "[Removed Lines]",
      "1233:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1233:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 43 ---",
      "[Context before]",
      "1244:         when(document.isNew()).thenReturn(true);",
      "1245:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1246:         context.setDoc(document);",
      "1251:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1247:         String csrfTokenValue = \"token42234456\";",
      "1248:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 44 ---",
      "[Context before]",
      "1270:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1272:             null, \"xwiki\", context);",
      "1273:     }",
      "",
      "[Removed Lines]",
      "1271:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1269:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 45 ---",
      "[Context before]",
      "1283:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1285:         context.setDoc(document);",
      "1290:         String templateDocumentFullName = \"XWiki.MyTemplate\";",
      "",
      "[Removed Lines]",
      "1286:         String csrfTokenValue = \"token4298833\";",
      "1287:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 46 ---",
      "[Context before]",
      "1309:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1311:             null, \"xwiki\", context);",
      "1312:     }",
      "",
      "[Removed Lines]",
      "1310:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1306:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 47 ---",
      "[Context before]",
      "1321:         when(document.isNew()).thenReturn(false);",
      "1322:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1323:         context.setDoc(document);",
      "1328:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1324:         String csrfTokenValue = \"token4244112\";",
      "1325:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 48 ---",
      "[Context before]",
      "1349:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1351:             null, \"xwiki\", context);",
      "1352:     }",
      "",
      "[Removed Lines]",
      "1350:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1344:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 49 ---",
      "[Context before]",
      "1361:         when(document.isNew()).thenReturn(false);",
      "1362:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1363:         context.setDoc(document);",
      "1368:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1364:         String csrfTokenValue = \"token422555987\";",
      "1365:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 50 ---",
      "[Context before]",
      "1390:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1392:             null, \"xwiki\", context);",
      "1393:     }",
      "",
      "[Removed Lines]",
      "1391:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1383:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 51 ---",
      "[Context before]",
      "1402:         when(document.isNew()).thenReturn(false);",
      "1403:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1404:         context.setDoc(document);",
      "1409:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1405:         String csrfTokenValue = \"token424111553\";",
      "1406:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 52 ---",
      "[Context before]",
      "1430:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1432:             null, \"xwiki\", context);",
      "1433:     }",
      "",
      "[Removed Lines]",
      "1431:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1421:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 53 ---",
      "[Context before]",
      "1442:         when(document.isNew()).thenReturn(false);",
      "1443:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1444:         context.setDoc(document);",
      "1449:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1445:         String csrfTokenValue = \"token42008733\";",
      "1446:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 54 ---",
      "[Context before]",
      "1471:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1473:             null, \"xwiki\", context);",
      "1474:     }",
      "",
      "[Removed Lines]",
      "1472:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1460:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 55 ---",
      "[Context before]",
      "1483:         when(document.isNew()).thenReturn(true);",
      "1484:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1485:         context.setDoc(document);",
      "1490:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1486:         String csrfTokenValue = \"token423366\";",
      "1487:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 56 ---",
      "[Context before]",
      "1509:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1511:             null, \"xwiki\", context);",
      "1512:     }",
      "",
      "[Removed Lines]",
      "1510:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1496:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 57 ---",
      "[Context before]",
      "1522:         when(document.isNew()).thenReturn(true);",
      "1523:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1524:         context.setDoc(document);",
      "1529:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1525:         String csrfTokenValue = \"token4265677398\";",
      "1526:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 58 ---",
      "[Context before]",
      "1549:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1551:             null, \"xwiki\", context);",
      "1552:     }",
      "",
      "[Removed Lines]",
      "1550:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1534:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 59 ---",
      "[Context before]",
      "1561:         when(document.isNew()).thenReturn(false);",
      "1562:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1563:         context.setDoc(document);",
      "1568:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1564:         String csrfTokenValue = \"token421198337\";",
      "1565:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 60 ---",
      "[Context before]",
      "1589:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
      "1591:             null, \"xwiki\", context);",
      "1592:     }",
      "",
      "[Removed Lines]",
      "1590:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1572:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------",
      "--- Hunk 61 ---",
      "[Context before]",
      "1601:         when(document.isNew()).thenReturn(false);",
      "1602:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
      "1603:         context.setDoc(document);",
      "1608:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
      "",
      "[Removed Lines]",
      "1604:         String csrfTokenValue = \"token429866333\";",
      "1605:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 62 ---",
      "[Context before]",
      "1629:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
      "1631:             null, \"xwiki\", context);",
      "1632:     }",
      "",
      "[Removed Lines]",
      "1630:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
      "",
      "[Added Lines]",
      "1610:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
      "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "--- Hunk 1 ---",
      "[Context before]",
      "276:   ## By the past, it was \"xwiki/create.js\" which created this field, but it was causing problems when the user sent the",
      "277:   ## form before the JavaScript code was executed.",
      "278:   <input type=\"hidden\" name=\"templateprovider\" id=\"templateprovider\" value=\"\" />",
      "280:   <div class='row'>",
      "281:     ## Hide the first column when displayed in an AJAX call by clicking on a Wanted Link (because we know the target",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "279:   <input type=\"hidden\" name=\"form_token\" value=\"$!{escapetool.xml($services.csrf.getToken())}\"/>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "45e46c11fa4e15ee08f1589e9402e8cfa1bef601",
      "candidate_info": {
        "commit_hash": "45e46c11fa4e15ee08f1589e9402e8cfa1bef601",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/45e46c11fa4e15ee08f1589e9402e8cfa1bef601",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
        ],
        "message": "XWIKI-20849: Require a CSRF token in the create action\n\n(cherry picked from commit 4b20528808d0c311290b0d9ab2cfc44063380ef7)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: import java.util.Locale;",
          "24: import java.util.Map;",
          "26: import javax.inject.Named;",
          "27: import javax.inject.Provider;",
          "28: import javax.inject.Singleton;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: import javax.inject.Inject;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "97:     private static final String LOCAL_SERIALIZER_HINT = \"local\";",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "100:     @Inject",
          "101:     private CSRFToken csrf;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "185:         checkRights(newDocumentReference.getLastSpaceReference(), context);",
          "188:         XWikiDocument newDocument = context.getWiki().getDocument(newDocumentReference, context);",
          "189:         if (handler.isDocumentAlreadyExisting(newDocument) || handler.isDocumentPathTooLong(newDocumentReference)",
          "191:             return CREATE_TEMPLATE;",
          "192:         }",
          "",
          "[Removed Lines]",
          "190:             || !this.isEntityReferenceNameValid(newDocumentReference)) {",
          "",
          "[Added Lines]",
          "195:             || !this.isEntityReferenceNameValid(newDocumentReference)",
          "196:             || !this.csrf.isTokenValid(context.getRequest().getParameter(\"form_token\")))",
          "197:         {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "334:             redirectParams += \"&title=\" + Util.encodeURI(title, null);",
          "335:         }",
          "340:         return redirectParams;",
          "341:     }",
          "",
          "[Removed Lines]",
          "337:         CSRFToken csrf = Utils.getComponent(CSRFToken.class);",
          "338:         redirectParams += \"&form_token=\" + Util.encodeURI(csrf.getToken(), null);",
          "",
          "[Added Lines]",
          "344:         redirectParams += \"&form_token=\" + Util.encodeURI(this.csrf.getToken(), null);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "72: @OldcoreTest",
          "73: class CreateActionTest",
          "74: {",
          "75:     @InjectMockitoOldcore",
          "76:     MockitoOldcore oldcore;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75:     private static final String CSRF_TOKEN_VALUE = \"token4234343\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "125:         when(this.mockRequest.get(\"type\")).thenReturn(\"plain\");",
          "127:         this.oldcore.getMocker().registerMockComponent(ObservationManager.class);",
          "128:     }",
          "130:     @Test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "131:         when(this.csrfToken.getToken()).thenReturn(CSRF_TOKEN_VALUE);",
          "132:         when(this.csrfToken.isTokenValid(CSRF_TOKEN_VALUE)).thenReturn(true);",
          "133:         when(this.mockRequest.getParameter(\"form_token\")).thenReturn(CSRF_TOKEN_VALUE);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "137:         when(document.isNew()).thenReturn(true);",
          "138:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "139:         context.setDoc(document);",
          "144:         String result = action.render(context);",
          "",
          "[Removed Lines]",
          "140:         String csrfTokenValue = \"token42\";",
          "141:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "149:         assertNull(result);",
          "151:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "153:             null, \"xwiki\",",
          "154:             context);",
          "155:     }",
          "157:     @Test",
          "158:     void newDocumentButNonTerminalFromURL() throws Exception",
          "159:     {",
          "",
          "[Removed Lines]",
          "152:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "156:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "161:     @Test",
          "162:     void newDocumentFromURLWithInvalidToken() throws Exception",
          "163:     {",
          "165:         DocumentReference documentReference = new DocumentReference(\"xwiki\", Arrays.asList(\"X\"), \"Y\");",
          "166:         XWikiDocument document = mock(XWikiDocument.class);",
          "167:         when(document.getDocumentReference()).thenReturn(documentReference);",
          "168:         when(document.isNew()).thenReturn(true);",
          "169:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "170:         this.context.setDoc(document);",
          "173:         when(this.mockRequest.getParameter(\"form_token\")).thenReturn(\"fakeToken\");",
          "176:         String result = this.action.render(this.context);",
          "182:         assertEquals(\"create\", result);",
          "185:         verify(this.csrfToken).isTokenValid(\"fakeToken\");",
          "188:         verify(this.mockURLFactory, never()).createURL(any(), any(), any(), any(), any(), any(),",
          "189:             any(XWikiContext.class));",
          "190:     }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "164:         when(document.isNew()).thenReturn(true);",
          "165:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "166:         context.setDoc(document);",
          "171:         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"nonterminal\");",
          "",
          "[Removed Lines]",
          "167:         String csrfTokenValue = \"token432\";",
          "168:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "179:         assertNull(result);",
          "181:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "183:             \"xwiki\", context);",
          "184:     }",
          "",
          "[Removed Lines]",
          "182:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
          "",
          "[Added Lines]",
          "215:         verify(this.csrfToken).isTokenValid(CSRF_TOKEN_VALUE);",
          "218:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "216:         when(document.isNew()).thenReturn(true);",
          "217:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "218:         context.setDoc(document);",
          "223:         String result = action.render(context);",
          "",
          "[Removed Lines]",
          "219:         String csrfTokenValue = \"token4234\";",
          "220:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "231:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
          "233:             context);",
          "234:     }",
          "",
          "[Removed Lines]",
          "232:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "266:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "243:         when(document.isNew()).thenReturn(true);",
          "244:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "245:         context.setDoc(document);",
          "250:         String result = action.render(context);",
          "",
          "[Removed Lines]",
          "246:         String csrfTokenValue = \"token34342\";",
          "247:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "259:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "261:             \"xwiki\", context);",
          "262:     }",
          "",
          "[Removed Lines]",
          "260:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
          "",
          "[Added Lines]",
          "292:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "271:         when(document.isNew()).thenReturn(true);",
          "272:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "273:         context.setDoc(document);",
          "278:         when(mockRequest.getParameter(\"tocreate\")).thenReturn(\"terminal\");",
          "",
          "[Removed Lines]",
          "274:         String csrfTokenValue = \"token4234343\";",
          "275:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "289:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "291:             context);",
          "292:     }",
          "",
          "[Removed Lines]",
          "290:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "320:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "355:         when(document.isNew()).thenReturn(false);",
          "356:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "357:         context.setDoc(document);",
          "362:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");",
          "",
          "[Removed Lines]",
          "358:         String csrfTokenValue = \"token424345\";",
          "359:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "374:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "376:             \"xwiki\", context);",
          "377:     }",
          "",
          "[Removed Lines]",
          "375:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null,",
          "",
          "[Added Lines]",
          "403:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "386:         when(document.isNew()).thenReturn(false);",
          "387:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "388:         context.setDoc(document);",
          "393:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");",
          "",
          "[Removed Lines]",
          "389:         String csrfTokenValue = \"token42124343\";",
          "390:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "405:         verify(mockURLFactory).createURL(\"X.Y.Z\", \"WebHome\", \"edit\",",
          "407:             \"xwiki\", context);",
          "408:     }",
          "",
          "[Removed Lines]",
          "406:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null,",
          "",
          "[Added Lines]",
          "432:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null,",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "417:         when(document.isNew()).thenReturn(false);",
          "418:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "419:         context.setDoc(document);",
          "424:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X\");",
          "",
          "[Removed Lines]",
          "420:         String csrfTokenValue = \"token424334466\";",
          "421:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "437:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "439:             context);",
          "440:     }",
          "",
          "[Removed Lines]",
          "438:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "462:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "449:         when(document.isNew()).thenReturn(false);",
          "450:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "451:         context.setDoc(document);",
          "456:         when(mockRequest.getParameter(\"spaceReference\")).thenReturn(\"X.Y\");",
          "",
          "[Removed Lines]",
          "452:         String csrfTokenValue = \"token429988\";",
          "453:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "469:         verify(mockURLFactory).createURL(\"X.Y\", \"Z\", \"edit\",",
          "471:             context);",
          "472:     }",
          "",
          "[Removed Lines]",
          "470:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "492:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "581:         when(document.isNew()).thenReturn(false);",
          "582:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "583:         context.setDoc(document);",
          "588:         when(mockRequest.getParameter(\"name\")).thenReturn(\"Y\");",
          "",
          "[Removed Lines]",
          "584:         String csrfTokenValue = \"token42009\";",
          "585:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "599:         verify(mockURLFactory).createURL(\"Y\", \"WebHome\", \"edit\",",
          "601:             context);",
          "602:     }",
          "",
          "[Removed Lines]",
          "600:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "620:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "615:         when(document.isNew()).thenReturn(false);",
          "616:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "617:         context.setDoc(document);",
          "622:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
          "",
          "[Removed Lines]",
          "618:         String csrfTokenValue = \"token4233311\";",
          "619:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "634:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "636:             context);",
          "637:     }",
          "",
          "[Removed Lines]",
          "635:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "653:             \"template=&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "646:         when(document.isNew()).thenReturn(false);",
          "647:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "648:         context.setDoc(document);",
          "653:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");",
          "",
          "[Removed Lines]",
          "649:         String csrfTokenValue = \"token422112455\";",
          "650:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "666:         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"Z\", \"edit\",",
          "668:             context);",
          "669:     }",
          "",
          "[Removed Lines]",
          "667:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "683:             \"template=&parent=Main.WebHome&title=Z&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "678:         when(document.isNew()).thenReturn(false);",
          "679:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "680:         context.setDoc(document);",
          "685:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
          "",
          "[Removed Lines]",
          "681:         String csrfTokenValue = \"token42778900\";",
          "682:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "697:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
          "699:             context);",
          "700:     }",
          "",
          "[Removed Lines]",
          "698:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "712:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "709:         when(document.isNew()).thenReturn(false);",
          "710:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "711:         context.setDoc(document);",
          "716:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X\");",
          "",
          "[Removed Lines]",
          "712:         String csrfTokenValue = \"token4344119982\";",
          "713:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "730:         verify(mockURLFactory).createURL(\"X\", \"WebHome\", \"edit\",",
          "732:             context);",
          "733:     }",
          "",
          "[Removed Lines]",
          "731:             \"template=&parent=Main.WebHome&title=X&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "743:             \"template=&parent=Main.WebHome&title=X&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 31 ---",
          "[Context before]",
          "742:         when(document.isNew()).thenReturn(false);",
          "743:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "744:         context.setDoc(document);",
          "749:         when(mockRequest.getParameter(\"space\")).thenReturn(\"X.Y\");",
          "",
          "[Removed Lines]",
          "745:         String csrfTokenValue = \"token425553\";",
          "746:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 32 ---",
          "[Context before]",
          "762:         verify(mockURLFactory).createURL(\"X\\\\.Y\", \"WebHome\", \"edit\",",
          "764:             \"xwiki\", context);",
          "765:     }",
          "",
          "[Removed Lines]",
          "763:             \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + csrfTokenValue, null,",
          "",
          "[Added Lines]",
          "773:             \"template=&parent=Main.WebHome&title=X.Y&form_token=\" + CSRF_TOKEN_VALUE, null,",
          "",
          "---------------",
          "--- Hunk 33 ---",
          "[Context before]",
          "901:         when(document.isNew()).thenReturn(false);",
          "902:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "903:         context.setDoc(document);",
          "908:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "904:         String csrfTokenValue = \"token42008766\";",
          "905:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 34 ---",
          "[Context before]",
          "926:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "928:             context);",
          "929:     }",
          "",
          "[Removed Lines]",
          "927:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue, null, \"xwiki\",",
          "",
          "[Added Lines]",
          "935:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE, null, \"xwiki\",",
          "",
          "---------------",
          "--- Hunk 35 ---",
          "[Context before]",
          "977:         when(document.isNew()).thenReturn(false);",
          "978:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "979:         context.setDoc(document);",
          "984:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "980:         String csrfTokenValue = \"token4221098\";",
          "981:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 36 ---",
          "[Context before]",
          "1006:         verify(mockURLFactory).createURL(\"X.Y.Z.W\", \"WebHome\", \"edit\",",
          "1008:             null, \"xwiki\", context);",
          "1009:     }",
          "",
          "[Removed Lines]",
          "1007:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1013:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=W&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 37 ---",
          "[Context before]",
          "1132:         when(document.isNew()).thenReturn(true);",
          "1133:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1134:         context.setDoc(document);",
          "1139:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1135:         String csrfTokenValue = \"token42988733\";",
          "1136:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 38 ---",
          "[Context before]",
          "1157:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1159:             null, \"xwiki\", context);",
          "1160:     }",
          "",
          "[Removed Lines]",
          "1158:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1162:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 39 ---",
          "[Context before]",
          "1169:         when(document.isNew()).thenReturn(true);",
          "1170:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1171:         context.setDoc(document);",
          "1176:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1172:         String csrfTokenValue = \"token4222113555\";",
          "1173:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 40 ---",
          "[Context before]",
          "1195:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1197:             null, \"xwiki\", context);",
          "1198:     }",
          "",
          "[Removed Lines]",
          "1196:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1198:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 41 ---",
          "[Context before]",
          "1207:         when(document.isNew()).thenReturn(true);",
          "1208:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1209:         context.setDoc(document);",
          "1214:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1210:         String csrfTokenValue = \"token4200983331\";",
          "1211:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 42 ---",
          "[Context before]",
          "1232:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1234:             null, \"xwiki\", context);",
          "1235:     }",
          "",
          "[Removed Lines]",
          "1233:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1233:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 43 ---",
          "[Context before]",
          "1244:         when(document.isNew()).thenReturn(true);",
          "1245:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1246:         context.setDoc(document);",
          "1251:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1247:         String csrfTokenValue = \"token42234456\";",
          "1248:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 44 ---",
          "[Context before]",
          "1270:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1272:             null, \"xwiki\", context);",
          "1273:     }",
          "",
          "[Removed Lines]",
          "1271:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1269:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 45 ---",
          "[Context before]",
          "1283:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1285:         context.setDoc(document);",
          "1290:         String templateDocumentFullName = \"XWiki.MyTemplate\";",
          "",
          "[Removed Lines]",
          "1286:         String csrfTokenValue = \"token4298833\";",
          "1287:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 46 ---",
          "[Context before]",
          "1309:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1311:             null, \"xwiki\", context);",
          "1312:     }",
          "",
          "[Removed Lines]",
          "1310:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1306:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 47 ---",
          "[Context before]",
          "1321:         when(document.isNew()).thenReturn(false);",
          "1322:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1323:         context.setDoc(document);",
          "1328:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1324:         String csrfTokenValue = \"token4244112\";",
          "1325:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 48 ---",
          "[Context before]",
          "1349:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1351:             null, \"xwiki\", context);",
          "1352:     }",
          "",
          "[Removed Lines]",
          "1350:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1344:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 49 ---",
          "[Context before]",
          "1361:         when(document.isNew()).thenReturn(false);",
          "1362:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1363:         context.setDoc(document);",
          "1368:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1364:         String csrfTokenValue = \"token422555987\";",
          "1365:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 50 ---",
          "[Context before]",
          "1390:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1392:             null, \"xwiki\", context);",
          "1393:     }",
          "",
          "[Removed Lines]",
          "1391:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1383:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 51 ---",
          "[Context before]",
          "1402:         when(document.isNew()).thenReturn(false);",
          "1403:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1404:         context.setDoc(document);",
          "1409:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1405:         String csrfTokenValue = \"token424111553\";",
          "1406:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 52 ---",
          "[Context before]",
          "1430:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1432:             null, \"xwiki\", context);",
          "1433:     }",
          "",
          "[Removed Lines]",
          "1431:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1421:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 53 ---",
          "[Context before]",
          "1442:         when(document.isNew()).thenReturn(false);",
          "1443:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1444:         context.setDoc(document);",
          "1449:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1445:         String csrfTokenValue = \"token42008733\";",
          "1446:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 54 ---",
          "[Context before]",
          "1471:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1473:             null, \"xwiki\", context);",
          "1474:     }",
          "",
          "[Removed Lines]",
          "1472:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1460:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 55 ---",
          "[Context before]",
          "1483:         when(document.isNew()).thenReturn(true);",
          "1484:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1485:         context.setDoc(document);",
          "1490:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1486:         String csrfTokenValue = \"token423366\";",
          "1487:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 56 ---",
          "[Context before]",
          "1509:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1511:             null, \"xwiki\", context);",
          "1512:     }",
          "",
          "[Removed Lines]",
          "1510:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1496:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 57 ---",
          "[Context before]",
          "1522:         when(document.isNew()).thenReturn(true);",
          "1523:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1524:         context.setDoc(document);",
          "1529:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1525:         String csrfTokenValue = \"token4265677398\";",
          "1526:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 58 ---",
          "[Context before]",
          "1549:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1551:             null, \"xwiki\", context);",
          "1552:     }",
          "",
          "[Removed Lines]",
          "1550:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1534:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 59 ---",
          "[Context before]",
          "1561:         when(document.isNew()).thenReturn(false);",
          "1562:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1563:         context.setDoc(document);",
          "1568:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1564:         String csrfTokenValue = \"token421198337\";",
          "1565:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 60 ---",
          "[Context before]",
          "1589:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "1591:             null, \"xwiki\", context);",
          "1592:     }",
          "",
          "[Removed Lines]",
          "1590:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1572:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------",
          "--- Hunk 61 ---",
          "[Context before]",
          "1601:         when(document.isNew()).thenReturn(false);",
          "1602:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "1603:         context.setDoc(document);",
          "1608:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "1604:         String csrfTokenValue = \"token429866333\";",
          "1605:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 62 ---",
          "[Context before]",
          "1629:         verify(mockURLFactory).createURL(\"X\", \"Y\", \"edit\",",
          "1631:             null, \"xwiki\", context);",
          "1632:     }",
          "",
          "[Removed Lines]",
          "1630:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "1610:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "--- Hunk 1 ---",
          "[Context before]",
          "276:   ## By the past, it was \"xwiki/create.js\" which created this field, but it was causing problems when the user sent the",
          "277:   ## form before the JavaScript code was executed.",
          "278:   <input type=\"hidden\" name=\"templateprovider\" id=\"templateprovider\" value=\"\" />",
          "280:   <div class='row'>",
          "281:     ## Hide the first column when displayed in an AJAX call by clicking on a Wanted Link (because we know the target",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "279:   <input type=\"hidden\" name=\"form_token\" value=\"$!{escapetool.xml($services.csrf.getToken())}\"/>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fafbd9c8323586f09cd435fecaf275cf40d92a30",
      "candidate_info": {
        "commit_hash": "fafbd9c8323586f09cd435fecaf275cf40d92a30",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/fafbd9c8323586f09cd435fecaf275cf40d92a30",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
        ],
        "message": "XWIKI-20849: Require a CSRF token in the create action\n\n* Re-use the CSRF token from the request for the redirect",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     private static final String LOCAL_SERIALIZER_HINT = \"local\";",
          "100:     @Inject",
          "101:     private CSRFToken csrf;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:     private static final String FORM_TOKEN_PARAMETER = \"form_token\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "193:         XWikiDocument newDocument = context.getWiki().getDocument(newDocumentReference, context);",
          "194:         if (handler.isDocumentAlreadyExisting(newDocument) || handler.isDocumentPathTooLong(newDocumentReference)",
          "195:             || !this.isEntityReferenceNameValid(newDocumentReference)",
          "197:         {",
          "198:             return CREATE_TEMPLATE;",
          "199:         }",
          "",
          "[Removed Lines]",
          "196:             || !this.csrf.isTokenValid(context.getRequest().getParameter(\"form_token\")))",
          "",
          "[Added Lines]",
          "201:             || !this.csrf.isTokenValid(context.getRequest().getParameter(FORM_TOKEN_PARAMETER)))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "264:             action = actionOnCreate == ActionOnCreate.SAVE_AND_VIEW ? \"save\" : getEditMode(template, context);",
          "265:         }",
          "269:         String redirectURL = newDocument.getURL(action, redirectParams, context);",
          "270:         redirectURL = context.getResponse().encodeRedirectURL(redirectURL);",
          "271:         if (context.getRequest().getParameterMap().containsKey(\"ajax\")) {",
          "",
          "[Removed Lines]",
          "268:         String redirectParams = getRedirectParameters(parent, title, template, actionOnCreate);",
          "",
          "[Added Lines]",
          "273:         String formToken = context.getRequest().getParameter(FORM_TOKEN_PARAMETER);",
          "276:         String redirectParams = getRedirectParameters(parent, title, template, actionOnCreate, formToken);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "325:         xwiki.saveDocument(newDocument, context);",
          "326:     }",
          "329:     {",
          "330:         if (actionOnCreate == ActionOnCreate.SAVE_AND_EDIT) {",
          "",
          "[Removed Lines]",
          "328:     private String getRedirectParameters(String parent, String title, String template, ActionOnCreate actionOnCreate)",
          "",
          "[Added Lines]",
          "336:     private String getRedirectParameters(String parent, String title, String template, ActionOnCreate actionOnCreate,",
          "337:         String formToken)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "341:             redirectParams += \"&title=\" + Util.encodeURI(title, null);",
          "342:         }",
          "346:         return redirectParams;",
          "347:     }",
          "",
          "[Removed Lines]",
          "344:         redirectParams += \"&form_token=\" + Util.encodeURI(this.csrf.getToken(), null);",
          "",
          "[Added Lines]",
          "353:         redirectParams += \"&form_token=\" + Util.encodeURI(formToken, null);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "946:         when(document.isNew()).thenReturn(false);",
          "947:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "948:         context.setDoc(document);",
          "953:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "949:         String csrfTokenValue = \"token42557783\";",
          "950:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "973:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "975:             null, \"xwiki\", context);",
          "976:     }",
          "",
          "[Removed Lines]",
          "974:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "972:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "95f35aa0c20514da5a806e38d92ed350acaac4b1",
      "candidate_info": {
        "commit_hash": "95f35aa0c20514da5a806e38d92ed350acaac4b1",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/95f35aa0c20514da5a806e38d92ed350acaac4b1",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
        ],
        "message": "XWIKI-20849: Require a CSRF token in the create action\n\n* Re-use the CSRF token from the request for the redirect\n\n(cherry picked from commit fafbd9c8323586f09cd435fecaf275cf40d92a30)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/CreateAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     private static final String LOCAL_SERIALIZER_HINT = \"local\";",
          "100:     @Inject",
          "101:     private CSRFToken csrf;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:     private static final String FORM_TOKEN_PARAMETER = \"form_token\";",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "193:         XWikiDocument newDocument = context.getWiki().getDocument(newDocumentReference, context);",
          "194:         if (handler.isDocumentAlreadyExisting(newDocument) || handler.isDocumentPathTooLong(newDocumentReference)",
          "195:             || !this.isEntityReferenceNameValid(newDocumentReference)",
          "197:         {",
          "198:             return CREATE_TEMPLATE;",
          "199:         }",
          "",
          "[Removed Lines]",
          "196:             || !this.csrf.isTokenValid(context.getRequest().getParameter(\"form_token\")))",
          "",
          "[Added Lines]",
          "201:             || !this.csrf.isTokenValid(context.getRequest().getParameter(FORM_TOKEN_PARAMETER)))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "264:             action = actionOnCreate == ActionOnCreate.SAVE_AND_VIEW ? \"save\" : getEditMode(template, context);",
          "265:         }",
          "269:         String redirectURL = newDocument.getURL(action, redirectParams, context);",
          "270:         redirectURL = context.getResponse().encodeRedirectURL(redirectURL);",
          "271:         if (context.getRequest().getParameterMap().containsKey(\"ajax\")) {",
          "",
          "[Removed Lines]",
          "268:         String redirectParams = getRedirectParameters(parent, title, template, actionOnCreate);",
          "",
          "[Added Lines]",
          "273:         String formToken = context.getRequest().getParameter(FORM_TOKEN_PARAMETER);",
          "276:         String redirectParams = getRedirectParameters(parent, title, template, actionOnCreate, formToken);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "325:         xwiki.saveDocument(newDocument, context);",
          "326:     }",
          "329:     {",
          "330:         if (actionOnCreate == ActionOnCreate.SAVE_AND_EDIT) {",
          "",
          "[Removed Lines]",
          "328:     private String getRedirectParameters(String parent, String title, String template, ActionOnCreate actionOnCreate)",
          "",
          "[Added Lines]",
          "336:     private String getRedirectParameters(String parent, String title, String template, ActionOnCreate actionOnCreate,",
          "337:         String formToken)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "341:             redirectParams += \"&title=\" + Util.encodeURI(title, null);",
          "342:         }",
          "346:         return redirectParams;",
          "347:     }",
          "",
          "[Removed Lines]",
          "344:         redirectParams += \"&form_token=\" + Util.encodeURI(this.csrf.getToken(), null);",
          "",
          "[Added Lines]",
          "353:         redirectParams += \"&form_token=\" + Util.encodeURI(formToken, null);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/web/CreateActionTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "946:         when(document.isNew()).thenReturn(false);",
          "947:         when(document.getLocalReferenceMaxLength()).thenReturn(255);",
          "948:         context.setDoc(document);",
          "953:         String templateProviderFullName = \"XWiki.MyTemplateProvider\";",
          "",
          "[Removed Lines]",
          "949:         String csrfTokenValue = \"token42557783\";",
          "950:         when(this.csrfToken.getToken()).thenReturn(csrfTokenValue);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "973:         verify(mockURLFactory).createURL(\"X.Y\", \"WebHome\", \"edit\",",
          "975:             null, \"xwiki\", context);",
          "976:     }",
          "",
          "[Removed Lines]",
          "974:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + csrfTokenValue,",
          "",
          "[Added Lines]",
          "972:             \"template=XWiki.MyTemplate&parent=Main.WebHome&title=Y&form_token=\" + CSRF_TOKEN_VALUE,",
          "",
          "---------------"
        ]
      }
    }
  ]
}