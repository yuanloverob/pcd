{
  "cve_id": "CVE-2018-1000077",
  "cve_desc": "RubyGems version Ruby 2.2 series: 2.2.9 and earlier, Ruby 2.3 series: 2.3.6 and earlier, Ruby 2.4 series: 2.4.3 and earlier, Ruby 2.5 series: 2.5.0 and earlier, prior to trunk revision 62422 contains a Improper Input Validation vulnerability in ruby gems specification homepage attribute that can result in a malicious gem could set an invalid homepage URL. This vulnerability appears to have been fixed in 2.7.6.",
  "repo": "rubygems/rubygems",
  "patch_hash": "feadefc2d351dcb95d6492f5ad17ebca546eb964",
  "patch_info": {
    "commit_hash": "feadefc2d351dcb95d6492f5ad17ebca546eb964",
    "repo": "rubygems/rubygems",
    "commit_url": "https://github.com/rubygems/rubygems/commit/feadefc2d351dcb95d6492f5ad17ebca546eb964",
    "files": [
      "lib/rubygems/specification.rb",
      "test/rubygems/test_gem_specification.rb"
    ],
    "message": "Enforce URL validation on spec homepage attribute",
    "before_after_code_files": [
      "lib/rubygems/specification.rb||lib/rubygems/specification.rb",
      "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb"
    ]
  },
  "patch_diff": {
    "lib/rubygems/specification.rb||lib/rubygems/specification.rb": [
      "File: lib/rubygems/specification.rb -> lib/rubygems/specification.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "15: require 'rubygems/stub_specification'",
      "16: require 'rubygems/util/list'",
      "17: require 'stringio'",
      "19: ##",
      "20: # The Specification class contains the information for a Gem.  Typically",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "18: require 'uri'",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2822:       raise Gem::InvalidSpecificationException, \"#{lazy} is not a summary\"",
      "2823:     end",
      "2829:     end",
      "2831:     # Warnings",
      "",
      "[Removed Lines]",
      "2825:     if homepage and not homepage.empty? and",
      "2826:        homepage !~ /\\A[a-z][a-z\\d+.-]*:/i then",
      "2827:       raise Gem::InvalidSpecificationException,",
      "2828:             \"\\\"#{homepage}\\\" is not a URI\"",
      "",
      "[Added Lines]",
      "2826:     # Make sure a homepage is valid HTTP/HTTPS URI",
      "2827:     if homepage and not homepage.empty?",
      "2828:       begin",
      "2829:         homepage_uri = URI.parse(homepage)",
      "2830:         unless [URI::HTTP, URI::HTTPS].member? homepage_uri.class",
      "2831:           raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a URI\"",
      "2832:         end",
      "2833:       rescue URI::InvalidURIError",
      "2834:         raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a URI\"",
      "2835:       end",
      "",
      "---------------"
    ],
    "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb": [
      "File: test/rubygems/test_gem_specification.rb -> test/rubygems/test_gem_specification.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "2887:       end",
      "2889:       assert_equal '\"over at my cool site\" is not a URI', e.message",
      "2890:     end",
      "2891:   end",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2891:       @a1.homepage = 'ftp://rubygems.org'",
      "2893:       e = assert_raises Gem::InvalidSpecificationException do",
      "2894:         @a1.validate",
      "2895:       end",
      "2897:       assert_equal '\"ftp://rubygems.org\" is not a URI', e.message",
      "2899:       @a1.homepage = 'http://rubygems.org'",
      "2901:       assert_equal true, @a1.validate",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "21872ae44b41e229cf417b8431f0e4247480b646",
      "candidate_info": {
        "commit_hash": "21872ae44b41e229cf417b8431f0e4247480b646",
        "repo": "rubygems/rubygems",
        "commit_url": "https://github.com/rubygems/rubygems/commit/21872ae44b41e229cf417b8431f0e4247480b646",
        "files": [
          "lib/rubygems/specification.rb",
          "test/rubygems/test_gem_specification.rb"
        ],
        "message": "Improve exception message for invalid HTTP URIs",
        "before_after_code_files": [
          "lib/rubygems/specification.rb||lib/rubygems/specification.rb",
          "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/rubygems/specification.rb||lib/rubygems/specification.rb",
            "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb"
          ],
          "candidate": [
            "lib/rubygems/specification.rb||lib/rubygems/specification.rb",
            "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/rubygems/specification.rb||lib/rubygems/specification.rb": [
          "File: lib/rubygems/specification.rb -> lib/rubygems/specification.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "2828:       begin",
          "2829:         homepage_uri = URI.parse(homepage)",
          "2830:         unless [URI::HTTP, URI::HTTPS].member? homepage_uri.class",
          "2832:         end",
          "2833:       rescue URI::InvalidURIError",
          "2835:       end",
          "2836:     end",
          "",
          "[Removed Lines]",
          "2831:           raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a URI\"",
          "2834:         raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a URI\"",
          "",
          "[Added Lines]",
          "2831:           raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a valid HTTP URI\"",
          "2834:         raise Gem::InvalidSpecificationException, \"\\\"#{homepage}\\\" is not a valid HTTP URI\"",
          "",
          "---------------"
        ],
        "test/rubygems/test_gem_specification.rb||test/rubygems/test_gem_specification.rb": [
          "File: test/rubygems/test_gem_specification.rb -> test/rubygems/test_gem_specification.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "2886:         @a1.validate",
          "2887:       end",
          "2891:       @a1.homepage = 'ftp://rubygems.org'",
          "",
          "[Removed Lines]",
          "2889:       assert_equal '\"over at my cool site\" is not a URI', e.message",
          "",
          "[Added Lines]",
          "2889:       assert_equal '\"over at my cool site\" is not a valid HTTP URI', e.message",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2894:         @a1.validate",
          "2895:       end",
          "2899:       @a1.homepage = 'http://rubygems.org'",
          "2900:       assert_equal true, @a1.validate",
          "",
          "[Removed Lines]",
          "2897:       assert_equal '\"ftp://rubygems.org\" is not a URI', e.message",
          "",
          "[Added Lines]",
          "2897:       assert_equal '\"ftp://rubygems.org\" is not a valid HTTP URI', e.message",
          "",
          "---------------"
        ]
      }
    }
  ]
}