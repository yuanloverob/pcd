{
  "cve_id": "CVE-2023-29200",
  "cve_desc": "Contao is an open source content management system. Prior to versions 4.9.40, 4.13.21, and 5.1.4, logged in users can list arbitrary system files in the file manager by manipulating the Ajax request. However, it is not possible to read the contents of these files. Users should update to Contao 4.9.40, 4.13.21 or 5.1.4 to receive a patch. There are no known workarounds.",
  "repo": "contao/contao",
  "patch_hash": "6f3e705f4ff23f4419563d09d8485793569f31df",
  "patch_info": {
    "commit_hash": "6f3e705f4ff23f4419563d09d8485793569f31df",
    "repo": "contao/contao",
    "commit_url": "https://github.com/contao/contao/commit/6f3e705f4ff23f4419563d09d8485793569f31df",
    "files": [
      "core-bundle/src/Resources/contao/drivers/DC_Folder.php"
    ],
    "message": "Merge pull request from GHSA-fp7q-xhhw-6rj3",
    "before_after_code_files": [
      "core-bundle/src/Resources/contao/drivers/DC_Folder.php||core-bundle/src/Resources/contao/drivers/DC_Folder.php"
    ]
  },
  "patch_diff": {
    "core-bundle/src/Resources/contao/drivers/DC_Folder.php||core-bundle/src/Resources/contao/drivers/DC_Folder.php": [
      "File: core-bundle/src/Resources/contao/drivers/DC_Folder.php -> core-bundle/src/Resources/contao/drivers/DC_Folder.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "2525:    return '';",
      "2526:   }",
      "2529:   $objSession = System::getContainer()->get('session');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2528:   $this->isValid($strFolder);",
      "2530:   if (!is_dir($this->strRootDir . '/' . $strFolder) || !$this->isMounted($strFolder))",
      "2531:   {",
      "2532:    throw new AccessDeniedException('Folder \"' . $strFolder . '\" is not mounted or cannot be found.');",
      "2533:   }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2947:    return false;",
      "2948:   }",
      "2951:   {",
      "2952:    return true;",
      "2953:   }",
      "",
      "[Removed Lines]",
      "2950:   if (empty($this->arrFilemounts))",
      "",
      "[Added Lines]",
      "2957:   if (empty($this->arrFilemounts) && !\\is_array($GLOBALS['TL_DCA'][$this->strTable]['list']['sorting']['root']) && $GLOBALS['TL_DCA'][$this->strTable]['list']['sorting']['root'] !== false)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f0bea8048d667cc0906a9da1e88e8d5af0c2e92",
      "candidate_info": {
        "commit_hash": "0f0bea8048d667cc0906a9da1e88e8d5af0c2e92",
        "repo": "contao/contao",
        "commit_url": "https://github.com/contao/contao/commit/0f0bea8048d667cc0906a9da1e88e8d5af0c2e92",
        "files": [
          "core-bundle/src/Resources/contao/config/constants.php"
        ],
        "message": "Update the constants.php file",
        "before_after_code_files": [
          "core-bundle/src/Resources/contao/config/constants.php||core-bundle/src/Resources/contao/config/constants.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/contao/contao/pull/6009"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core-bundle/src/Resources/contao/config/constants.php||core-bundle/src/Resources/contao/config/constants.php": [
          "File: core-bundle/src/Resources/contao/config/constants.php -> core-bundle/src/Resources/contao/config/constants.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: define('VERSION', '4.9');",
          "14: define('LONG_TERM_SUPPORT', true);",
          "",
          "[Removed Lines]",
          "13: define('BUILD', '40');",
          "",
          "[Added Lines]",
          "13: define('BUILD', '41');",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d71fc03b7bb5ede976b9b403f3ff66f2b1d3a3bd",
      "candidate_info": {
        "commit_hash": "d71fc03b7bb5ede976b9b403f3ff66f2b1d3a3bd",
        "repo": "contao/contao",
        "commit_url": "https://github.com/contao/contao/commit/d71fc03b7bb5ede976b9b403f3ff66f2b1d3a3bd",
        "files": [
          "core-bundle/src/EventListener/InsecureInstallationListener.php",
          "core-bundle/src/Resources/config/listener.yml",
          "core-bundle/tests/EventListener/InsecureInstallationListenerTest.php",
          "manager-bundle/src/Command/GenerateAppSecretCommand.php",
          "manager-bundle/src/Composer/ScriptHandler.php",
          "manager-bundle/src/Resources/config/commands.yml",
          "manager-bundle/tests/Command/GenerateAppSecretCommandTest.php"
        ],
        "message": "Merge pull request from GHSA-r432-x252-9pgv\n\n* implement command to generate APP_SECRET\n\n* add tests\n\n* update test\n\n* merge with 4.9\n\n* use the same logic ans in 4.13/5\n\n* use kernel.secret and fix CS\n\n* change wording\n\n* cs\n\n* fix tests\n\n* Apply suggestions from code review\n\nCo-authored-by: Martin Ausw\u00f6ger <martin@auswoeger.com>\n\n---------\n\nCo-authored-by: Leo Feyer <1192057+leofeyer@users.noreply.github.com>\nCo-authored-by: Martin Ausw\u00f6ger <martin@auswoeger.com>",
        "before_after_code_files": [
          "core-bundle/src/EventListener/InsecureInstallationListener.php||core-bundle/src/EventListener/InsecureInstallationListener.php",
          "core-bundle/tests/EventListener/InsecureInstallationListenerTest.php||core-bundle/tests/EventListener/InsecureInstallationListenerTest.php",
          "manager-bundle/src/Command/GenerateAppSecretCommand.php||manager-bundle/src/Command/GenerateAppSecretCommand.php",
          "manager-bundle/src/Composer/ScriptHandler.php||manager-bundle/src/Composer/ScriptHandler.php",
          "manager-bundle/tests/Command/GenerateAppSecretCommandTest.php||manager-bundle/tests/Command/GenerateAppSecretCommandTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/contao/contao/pull/6009"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core-bundle/src/EventListener/InsecureInstallationListener.php||core-bundle/src/EventListener/InsecureInstallationListener.php": [
          "File: core-bundle/src/EventListener/InsecureInstallationListener.php -> core-bundle/src/EventListener/InsecureInstallationListener.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: class InsecureInstallationListener",
          "22: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26:     private $secret;",
          "28:     public function __construct($secret)",
          "29:     {",
          "30:         $this->secret = $secret;",
          "31:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "35:         }",
          "40:         }",
          "43:     }",
          "44: }",
          "",
          "[Removed Lines]",
          "38:         if ('' === $request->getBasePath()) {",
          "39:             return;",
          "42:         throw new InsecureInstallationException('Your installation is not secure. Please set the document root to the /web subfolder.');",
          "",
          "[Added Lines]",
          "48:         if ('' !== $request->getBasePath()) {",
          "49:             throw new InsecureInstallationException('Your installation is not secure. Please set the document root to the /web subfolder.');",
          "53:         if (empty($this->secret) || 'ThisTokenIsNotSoSecretChangeIt' === $this->secret) {",
          "54:             throw new InsecureInstallationException('Your installation is not secure. Please set the \"secret\" in your parameters.yml or \"APP_SECRET\" in your .env.local.');",
          "55:         }",
          "",
          "---------------"
        ],
        "core-bundle/tests/EventListener/InsecureInstallationListenerTest.php||core-bundle/tests/EventListener/InsecureInstallationListenerTest.php": [
          "File: core-bundle/tests/EventListener/InsecureInstallationListenerTest.php -> core-bundle/tests/EventListener/InsecureInstallationListenerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: class InsecureInstallationListenerTest extends TestCase",
          "24: {",
          "25:     public function testThrowsAnExceptionIfTheDocumentRootIsInsecure(): void",
          "26:     {",
          "29:         $this->expectException(InsecureInstallationException::class);",
          "31:         $listener($this->getResponseEvent($this->getRequest()));",
          "32:     }",
          "35:     {",
          "36:         $request = $this->getRequest();",
          "37:         $request->server->set('REQUEST_URI', '/index.php?do=test');",
          "38:         $request->server->set('SCRIPT_FILENAME', $this->getTempDir().'/index.php');",
          "41:         $listener($this->getResponseEvent($request));",
          "43:         $this->addToAssertionCount(1); // does not throw an exception",
          "",
          "[Removed Lines]",
          "27:         $listener = new InsecureInstallationListener();",
          "34:     public function testDoesNotThrowAnExceptionIfTheDocumentRootIsSecure(): void",
          "40:         $listener = new InsecureInstallationListener();",
          "",
          "[Added Lines]",
          "25:     private const DEFAULT_SECRET = 'ThisTokenIsNotSoSecretChangeIt';",
          "26:     private const PSEUDO_SECRET = '0123456789abcdefghijklmnopqrstuv';",
          "30:         $listener = new InsecureInstallationListener(self::PSEUDO_SECRET);",
          "32:         $this->expectException(InsecureInstallationException::class);",
          "34:         $listener($this->getResponseEvent($this->getRequest()));",
          "35:     }",
          "37:     public function testThrowsAnExceptionIfTheSecretIsInsecure(): void",
          "38:     {",
          "39:         $request = $this->getRequest();",
          "40:         $request->server->set('REQUEST_URI', '/index.php?do=test');",
          "41:         $request->server->set('SCRIPT_FILENAME', $this->getTempDir().'/index.php');",
          "43:         $listener = new InsecureInstallationListener(self::DEFAULT_SECRET);",
          "50:     public function testDoesNotThrowAnExceptionIfTheDocumentRootAndSecretIsSecure(): void",
          "56:         $listener = new InsecureInstallationListener(self::PSEUDO_SECRET);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "48:         $request = $this->getRequest();",
          "49:         $request->server->set('REMOTE_ADDR', '127.0.0.1');",
          "52:         $listener($this->getResponseEvent($request));",
          "54:         $this->addToAssertionCount(1); // does not throw an exception",
          "",
          "[Removed Lines]",
          "51:         $listener = new InsecureInstallationListener();",
          "",
          "[Added Lines]",
          "67:         $listener = new InsecureInstallationListener(self::DEFAULT_SECRET);",
          "",
          "---------------"
        ],
        "manager-bundle/src/Command/GenerateAppSecretCommand.php||manager-bundle/src/Command/GenerateAppSecretCommand.php": [
          "File: manager-bundle/src/Command/GenerateAppSecretCommand.php -> manager-bundle/src/Command/GenerateAppSecretCommand.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: declare(strict_types=1);",
          "13: namespace Contao\\ManagerBundle\\Command;",
          "15: use Contao\\ManagerBundle\\Dotenv\\DotenvDumper;",
          "16: use Symfony\\Component\\Console\\Command\\Command;",
          "17: use Symfony\\Component\\Console\\Exception\\InvalidOptionException;",
          "18: use Symfony\\Component\\Console\\Input\\InputInterface;",
          "19: use Symfony\\Component\\Console\\Input\\InputOption;",
          "20: use Symfony\\Component\\Console\\Output\\OutputInterface;",
          "21: use Symfony\\Component\\Console\\Style\\SymfonyStyle;",
          "22: use Symfony\\Component\\Filesystem\\Filesystem;",
          "23: use Webmozart\\PathUtil\\Path;",
          "30: class GenerateAppSecretCommand extends Command",
          "31: {",
          "32:     protected static $defaultName = 'contao:generate-app-secret';",
          "37:     private $projectDir;",
          "42:     private $kernelSecret;",
          "44:     public function __construct(string $projectDir, ?string $kernelSecret)",
          "45:     {",
          "46:         parent::__construct();",
          "48:         $this->projectDir = $projectDir;",
          "49:         $this->kernelSecret = $kernelSecret;",
          "50:     }",
          "52:     protected function configure(): void",
          "53:     {",
          "54:         $this",
          "55:             ->addOption('force', 'f', InputOption::VALUE_NONE, 'Forces the generation of the APP_SECRET')",
          "56:             ->addOption('length', 'l', InputOption::VALUE_REQUIRED, 'Length of the generated APP_SECRET', 64)",
          "57:             ->setDescription('Generates an APP_SECRET in the .env.local file')",
          "58:         ;",
          "59:     }",
          "61:     protected function execute(InputInterface $input, OutputInterface $output): int",
          "62:     {",
          "63:         $io = new SymfonyStyle($input, $output);",
          "64:         $force = (bool) $input->getOption('force');",
          "66:         if (!empty($this->kernelSecret) && 'ThisTokenIsNotSoSecretChangeIt' !== $this->kernelSecret && !$force) {",
          "67:             $io->note('Secret is already set.');",
          "69:             return 0;",
          "70:         }",
          "72:         $length = (int) ceil((int) $input->getOption('length') / 2);",
          "74:         if ($length <= 0) {",
          "75:             throw new InvalidOptionException('Length must be greater than zero!');",
          "76:         }",
          "78:         $filesystem = new Filesystem();",
          "80:         $dotenv = new DotenvDumper(Path::join($this->projectDir, '.env.local'), $filesystem);",
          "81:         $dotenv->setParameter('APP_SECRET', bin2hex(random_bytes($length)));",
          "82:         $dotenv->dump();",
          "84:         $io->success('An APP_SECRET was generated and written to your .env.local file.');",
          "86:         if (!$filesystem->exists($envPath = Path::join($this->projectDir, '.env'))) {",
          "87:             $filesystem->touch($envPath);",
          "89:             $io->note('An empty .env file was created.');",
          "90:         }",
          "92:         return 0;",
          "93:     }",
          "94: }",
          "",
          "---------------"
        ],
        "manager-bundle/src/Composer/ScriptHandler.php||manager-bundle/src/Composer/ScriptHandler.php": [
          "File: manager-bundle/src/Composer/ScriptHandler.php -> manager-bundle/src/Composer/ScriptHandler.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:         $webDir = self::getWebDir($event);",
          "32:         static::purgeCacheFolder($event->getIO());",
          "33:         static::executeCommand(['contao:install-web-dir'], $event);",
          "34:         static::executeCommand(['cache:clear', '--no-warmup'], $event);",
          "35:         static::executeCommand(['cache:clear', '--no-warmup'], $event, 'dev');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33:         static::executeCommand(['contao:generate-app-secret'], $event);",
          "",
          "---------------"
        ],
        "manager-bundle/tests/Command/GenerateAppSecretCommandTest.php||manager-bundle/tests/Command/GenerateAppSecretCommandTest.php": [
          "File: manager-bundle/tests/Command/GenerateAppSecretCommandTest.php -> manager-bundle/tests/Command/GenerateAppSecretCommandTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: declare(strict_types=1);",
          "13: namespace Contao\\ManagerBundle\\Tests\\Command;",
          "15: use Contao\\ManagerBundle\\Command\\GenerateAppSecretCommand;",
          "16: use Contao\\TestCase\\ContaoTestCase;",
          "17: use Symfony\\Component\\Console\\Exception\\InvalidOptionException;",
          "18: use Symfony\\Component\\Console\\Tester\\CommandTester;",
          "19: use Symfony\\Component\\Dotenv\\Dotenv;",
          "20: use Symfony\\Component\\Filesystem\\Filesystem;",
          "21: use Webmozart\\PathUtil\\Path;",
          "23: class GenerateAppSecretCommandTest extends ContaoTestCase",
          "24: {",
          "25:     private const DEFAULT_SECRET = 'ThisTokenIsNotSoSecretChangeIt';",
          "27:     private static Filesystem $filesystem;",
          "28:     private static string $tempDir;",
          "29:     private static string $envPath;",
          "30:     private static string $envLocalPath;",
          "32:     public static function setUpBeforeClass(): void",
          "33:     {",
          "34:         parent::setUpBeforeClass();",
          "36:         self::$filesystem = new Filesystem();",
          "37:         self::$tempDir = self::getTempDir();",
          "38:         self::$envPath = Path::join(self::$tempDir, '.env');",
          "39:         self::$envLocalPath = Path::join(self::$tempDir, '.env.local');",
          "40:     }",
          "42:     protected function tearDown(): void",
          "43:     {",
          "44:         parent::tearDown();",
          "46:         self::$filesystem->remove(self::$envPath);",
          "47:         self::$filesystem->remove(self::$envLocalPath);",
          "48:         unset($_SERVER['APP_SECRET']);",
          "49:     }",
          "51:     public function testNameAndArguments(): void",
          "52:     {",
          "53:         $command = $this->getCommand();",
          "55:         $this->assertSame('contao:generate-app-secret', $command->getName());",
          "56:         $this->assertTrue($command->getDefinition()->hasOption('force'));",
          "57:         $this->assertTrue($command->getDefinition()->hasOption('length'));",
          "58:     }",
          "60:     public function testGeneratesEnvFiles(): void",
          "61:     {",
          "62:         $this->assertFileNotExists(self::$envPath);",
          "63:         $this->assertFileNotExists(self::$envLocalPath);",
          "65:         $tester = $this->getCommandTester();",
          "66:         $tester->execute([]);",
          "68:         $this->assertFileExists(self::$envPath);",
          "69:         $this->assertFileExists(self::$envLocalPath);",
          "70:     }",
          "72:     public function testGeneratesAppSecret(): void",
          "73:     {",
          "74:         $this->assertFileNotExists(self::$envLocalPath);",
          "76:         $tester = $this->getCommandTester();",
          "77:         $tester->execute([]);",
          "79:         $this->assertFileExists(self::$envLocalPath);",
          "81:         $envVars = (new Dotenv())->parse(file_get_contents(self::$envLocalPath), '.env.local');",
          "83:         $this->assertArrayHasKey('APP_SECRET', $envVars);",
          "84:         $this->assertTrue(64 === \\strlen($envVars['APP_SECRET']));",
          "85:     }",
          "87:     public function testDoesNotGenerateAppSecretIfDefined(): void",
          "88:     {",
          "89:         $this->assertFileNotExists(self::$envLocalPath);",
          "91:         $tester = $this->getCommandTester('foobar');",
          "92:         $tester->execute([]);",
          "94:         $this->assertFileNotExists(self::$envLocalPath);",
          "95:         $this->assertStringContainsString('Secret is already set.', $tester->getDisplay(true));",
          "96:     }",
          "98:     public function testForcesTheGenerationOfTheAppSecret(): void",
          "99:     {",
          "100:         $_SERVER['APP_SECRET'] = 'foobar';",
          "101:         $this->assertFileNotExists(self::$envLocalPath);",
          "103:         $tester = $this->getCommandTester();",
          "104:         $tester->execute(['--force' => true]);",
          "106:         $this->assertFileExists(self::$envLocalPath);",
          "108:         $envVars = (new Dotenv())->parse(file_get_contents(self::$envLocalPath), '.env.local');",
          "110:         $this->assertArrayHasKey('APP_SECRET', $envVars);",
          "111:         $this->assertTrue(64 === \\strlen($envVars['APP_SECRET']));",
          "112:     }",
          "114:     public function testSetsLengthOfAppSecret(): void",
          "115:     {",
          "116:         $this->assertFileNotExists(self::$envLocalPath);",
          "118:         $tester = $this->getCommandTester();",
          "119:         $tester->execute(['--length' => 64]);",
          "121:         $this->assertFileExists(self::$envLocalPath);",
          "123:         $envVars = (new Dotenv())->parse(file_get_contents(self::$envLocalPath), '.env.local');",
          "125:         $this->assertArrayHasKey('APP_SECRET', $envVars);",
          "126:         $this->assertTrue(64 === \\strlen($envVars['APP_SECRET']));",
          "127:     }",
          "129:     public function testThrowsExceptionIfInvalidLengthGiven(): void",
          "130:     {",
          "131:         $tester = $this->getCommandTester();",
          "133:         $this->expectException(InvalidOptionException::class);",
          "135:         $tester->execute(['--length' => 0]);",
          "136:     }",
          "138:     private function getCommand(string $secret = self::DEFAULT_SECRET): GenerateAppSecretCommand",
          "139:     {",
          "140:         return new GenerateAppSecretCommand(self::$tempDir, $secret);",
          "141:     }",
          "143:     private function getCommandTester(string $secret = self::DEFAULT_SECRET): CommandTester",
          "144:     {",
          "145:         return new CommandTester($this->getCommand($secret));",
          "146:     }",
          "147: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cba5703813e36b28894fcce10f731043ef04bbb3",
      "candidate_info": {
        "commit_hash": "cba5703813e36b28894fcce10f731043ef04bbb3",
        "repo": "contao/contao",
        "commit_url": "https://github.com/contao/contao/commit/cba5703813e36b28894fcce10f731043ef04bbb3",
        "files": [
          "CHANGELOG.md",
          "CONTRIBUTORS.md",
          "core-bundle/src/Resources/contao/config/constants.php"
        ],
        "message": "Update the changelog",
        "before_after_code_files": [
          "core-bundle/src/Resources/contao/config/constants.php||core-bundle/src/Resources/contao/config/constants.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/contao/contao/pull/6009"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core-bundle/src/Resources/contao/config/constants.php||core-bundle/src/Resources/contao/config/constants.php": [
          "File: core-bundle/src/Resources/contao/config/constants.php -> core-bundle/src/Resources/contao/config/constants.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: define('VERSION', '4.9');",
          "14: define('LONG_TERM_SUPPORT', true);",
          "",
          "[Removed Lines]",
          "13: define('BUILD', '39');",
          "",
          "[Added Lines]",
          "13: define('BUILD', '40');",
          "",
          "---------------"
        ]
      }
    }
  ]
}