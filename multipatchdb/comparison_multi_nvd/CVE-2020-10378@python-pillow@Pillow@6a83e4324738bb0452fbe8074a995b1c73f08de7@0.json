{
  "cve_id": "CVE-2020-10378",
  "cve_desc": "In libImaging/PcxDecode.c in Pillow before 7.1.0, an out-of-bounds read can occur when reading PCX files where state->shuffle is instructed to read beyond state->buffer.",
  "repo": "python-pillow/Pillow",
  "patch_hash": "6a83e4324738bb0452fbe8074a995b1c73f08de7",
  "patch_info": {
    "commit_hash": "6a83e4324738bb0452fbe8074a995b1c73f08de7",
    "repo": "python-pillow/Pillow",
    "commit_url": "https://github.com/python-pillow/Pillow/commit/6a83e4324738bb0452fbe8074a995b1c73f08de7",
    "files": [
      "src/libImaging/PcxDecode.c"
    ],
    "message": "Fix OOB Access on PcxDecode.c",
    "before_after_code_files": [
      "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c"
    ]
  },
  "patch_diff": {
    "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c": [
      "File: src/libImaging/PcxDecode.c -> src/libImaging/PcxDecode.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "22:     UINT8 n;",
      "23:     UINT8* ptr;",
      "29:         state->errcode = IMAGING_CODEC_OVERRUN;",
      "30:         return -1;",
      "31:     }",
      "",
      "[Removed Lines]",
      "25:     if (strcmp(im->mode, \"1\") == 0 && state->xsize > state->bytes * 8) {",
      "26:         state->errcode = IMAGING_CODEC_OVERRUN;",
      "27:         return -1;",
      "28:     } else if (strcmp(im->mode, \"P\") == 0 && state->xsize > state->bytes) {",
      "",
      "[Added Lines]",
      "25:     if ((state->xsize * state->bits + 7) / 8 > state->bytes) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "124f4bb591e16212605d0e41c413ed53e242cba2",
      "candidate_info": {
        "commit_hash": "124f4bb591e16212605d0e41c413ed53e242cba2",
        "repo": "python-pillow/Pillow",
        "commit_url": "https://github.com/python-pillow/Pillow/commit/124f4bb591e16212605d0e41c413ed53e242cba2",
        "files": [
          "Tests/images/01r_00.pcx",
          "Tests/test_image.py"
        ],
        "message": "Tests for PCX OOB Access",
        "before_after_code_files": [
          "Tests/test_image.py||Tests/test_image.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/python-pillow/Pillow/pull/4506"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Tests/test_image.py||Tests/test_image.py": [
          "File: Tests/test_image.py -> Tests/test_image.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "638:             assert test_module.PILLOW_VERSION > \"7.0.0\"",
          "640:     def test_overrun(self):",
          "641:         for file in [",
          "642:             \"fli_overrun.bin\",",
          "643:             \"sgi_overrun.bin\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "641:         \"\"\" For overrun completeness, test as:",
          "642:         `valgrind pytest -qq Tests/test_image.py::TestImage::test_overrun | grep decode.c`",
          "643:         \"\"\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "645:             \"sgi_overrun_expandrow2.bin\",",
          "646:             \"pcx_overrun.bin\",",
          "647:             \"pcx_overrun2.bin\",",
          "648:         ]:",
          "649:             with Image.open(os.path.join(\"Tests/images\", file)) as im:",
          "650:                 try:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "651:             \"01r_00.pcx\",",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ada137eba5b605fd5aeff619c33bbf0e53af26ee",
      "candidate_info": {
        "commit_hash": "ada137eba5b605fd5aeff619c33bbf0e53af26ee",
        "repo": "python-pillow/Pillow",
        "commit_url": "https://github.com/python-pillow/Pillow/commit/ada137eba5b605fd5aeff619c33bbf0e53af26ee",
        "files": [
          "Tests/test_image.py"
        ],
        "message": "Fix Flake8",
        "before_after_code_files": [
          "Tests/test_image.py||Tests/test_image.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/python-pillow/Pillow/pull/4506"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Tests/test_image.py||Tests/test_image.py": [
          "File: Tests/test_image.py -> Tests/test_image.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "640:     def test_overrun(self):",
          "641:         \"\"\" For overrun completeness, test as:",
          "643:         \"\"\"",
          "644:         for file in [",
          "645:             \"fli_overrun.bin\",",
          "",
          "[Removed Lines]",
          "642:         `valgrind pytest -qq Tests/test_image.py::TestImage::test_overrun | grep decode.c`",
          "",
          "[Added Lines]",
          "642:         valgrind pytest -qq Tests/test_image.py::TestImage::test_overrun | grep decode.c",
          "",
          "---------------"
        ]
      }
    }
  ]
}