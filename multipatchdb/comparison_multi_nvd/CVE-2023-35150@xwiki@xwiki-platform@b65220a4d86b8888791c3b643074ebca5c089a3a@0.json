{
  "cve_id": "CVE-2023-35150",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Starting in version 2.40m-2 and prior to versions 14.4.8, 14.10.4, and 15.0, any user with view rights on any document can execute code with programming rights, leading to remote code execution by crafting an url with a dangerous payload. The problem has been patched in XWiki 15.0, 14.10.4 and 14.4.8.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "b65220a4d86b8888791c3b643074ebca5c089a3a",
  "patch_info": {
    "commit_hash": "b65220a4d86b8888791c3b643074ebca5c089a3a",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/b65220a4d86b8888791c3b643074ebca5c089a3a",
    "files": [
      "xwiki-platform-core/pom.xml",
      "xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java",
      "xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-index/pom.xml",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/pom.xml",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/checkstyle/checkstyle-suppressions.xml",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/DefaultLinksTaskConsumer.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/DefaultTasksManager.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TaskExecutor.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TasksStore.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/jmx/JMXTasks.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/jmx/JMXTasksMBean.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/listener/LinksUpdateListener.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/migration/R140300001XWIKI19571DataMigration.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/internal/DefaultLinksTaskConsumerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/internal/DefaultTasksManagerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/internal/TaskExecutorTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/internal/TasksStoreTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/internal/listener/LinksUpdateListenerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/migration/R140300001XWIKI19571DataMigrationTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/pom.xml",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/checkstyle/checkstyle-suppressions.xml",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/DefaultLinksTaskConsumer.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/DefaultTasksManager.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TaskExecutor.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TasksStore.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/jmx/JMXTasks.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/jmx/JMXTasksMBean.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/listener/LinksUpdateListener.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300001XWIKI19571DataMigration.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/DefaultLinksTaskConsumerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/DefaultTasksManagerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/TaskExecutorTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/TasksStoreTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/listener/LinksUpdateListenerTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300001XWIKI19571DataMigrationTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationCommon.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationConfig.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationGuestActions.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationMailClass.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationMemberActions.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/main/resources/Invitation/InvitationMembersCommon.xml",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java",
      "xwiki-platform-core/xwiki-platform-minimaldependencies/pom.xml",
      "xwiki-platform-core/xwiki-platform-oldcore/pom.xml",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java",
      "xwiki-platform-tools/xwiki-platform-tool-packager-plugin/pom.xml"
    ],
    "message": "XWIKI-20285: Improve escaping of the Invitation Application\n\n- Introduce an internal role (DefaultXARExtensionIndex) to know if a document is provided by an extension\n- Split index-api to index-api/index-default to be able to use the api in oldcore\n- Fix the escaping in invitation-ui\n- Provide an automatic fix during upgrade for potential escaping issues in generated code",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java||xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java",
      "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java",
      "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java||xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java": [
      "File: xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java -> xwiki-platform-core/xwiki-platform-extension/xwiki-platform-extension-handlers/xwiki-platform-extension-handler-xar/src/main/java/org/xwiki/extension/xar/internal/DefaultXARExtensionIndex.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.extension.xar.internal;",
      "22: import javax.inject.Inject;",
      "23: import javax.inject.Named;",
      "24: import javax.inject.Singleton;",
      "26: import org.xwiki.component.annotation.Component;",
      "27: import org.xwiki.extension.repository.InstalledExtensionRepository;",
      "28: import org.xwiki.extension.xar.internal.handler.XarExtensionHandler;",
      "29: import org.xwiki.extension.xar.internal.repository.XarInstalledExtensionRepository;",
      "30: import org.xwiki.internal.extension.XARExtensionIndex;",
      "31: import org.xwiki.model.reference.DocumentReference;",
      "42: @Component",
      "43: @Singleton",
      "44: public class DefaultXARExtensionIndex implements XARExtensionIndex",
      "45: {",
      "46:     @Inject",
      "47:     @Named(XarExtensionHandler.TYPE)",
      "48:     private InstalledExtensionRepository installedXARs;",
      "50:     @Override",
      "51:     public boolean isExtensionDocument(DocumentReference documentReference)",
      "52:     {",
      "53:         return !((XarInstalledExtensionRepository) this.installedXARs).getXarInstalledExtensions(documentReference)",
      "54:             .isEmpty();",
      "55:     }",
      "56: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java": [
      "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/TaskConsumerScriptService.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: import javax.inject.Inject;",
      "25: import javax.inject.Named;",
      "27: import javax.inject.Singleton;",
      "29: import org.xwiki.component.annotation.Component;",
      "30: import org.xwiki.script.service.ScriptService;",
      "31: import org.xwiki.stability.Unstable;",
      "",
      "[Removed Lines]",
      "26: import javax.inject.Provider;",
      "33: import com.xpn.xwiki.XWikiContext;",
      "",
      "[Added Lines]",
      "31: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "48:     private TaskManager taskManager;",
      "50:     @Inject",
      "56:     public Map<String, Long> getQueueSizePerType()",
      "57:     {",
      "59:     }",
      "60: }",
      "",
      "[Removed Lines]",
      "51:     private Provider<XWikiContext> xcontextProvider;",
      "58:         return this.taskManager.getQueueSizePerType(this.xcontextProvider.get().getWikiId());",
      "",
      "[Added Lines]",
      "49:     private WikiDescriptorManager wikiDescriptorManager;",
      "56:         return this.taskManager.getQueueSizePerType(this.wikiDescriptorManager.getCurrentWikiId());",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java": [
      "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/TaskConsumerScriptServiceTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: import java.util.Map;",
      "26: import org.junit.jupiter.api.BeforeEach;",
      "27: import org.junit.jupiter.api.Test;",
      "29: import org.xwiki.test.junit5.mockito.ComponentTest;",
      "30: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
      "31: import org.xwiki.test.junit5.mockito.MockComponent;",
      "35: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "36: import static org.mockito.Mockito.when;",
      "",
      "[Removed Lines]",
      "24: import javax.inject.Provider;",
      "28: import org.mockito.Mock;",
      "33: import com.xpn.xwiki.XWikiContext;",
      "",
      "[Added Lines]",
      "29: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "51:     private TaskManager taskManager;",
      "53:     @MockComponent",
      "59:     @BeforeEach",
      "60:     void setUp()",
      "61:     {",
      "64:     }",
      "66:     @Test",
      "",
      "[Removed Lines]",
      "54:     private Provider<XWikiContext> xcontextProvider;",
      "56:     @Mock",
      "57:     private XWikiContext xcontext;",
      "62:         when(this.xcontextProvider.get()).thenReturn(this.xcontext);",
      "63:         when(this.xcontext.getWikiId()).thenReturn(\"xwiki\");",
      "",
      "[Added Lines]",
      "50:     private WikiDescriptorManager wikiDescriptorManager;",
      "56:         when(this.wikiDescriptorManager.getCurrentWikiId()).thenReturn(\"xwiki\");",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java": [
      "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/TaskApplicationReadyListener.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: import org.xwiki.bridge.event.ApplicationReadyEvent;",
      "28: import org.xwiki.component.annotation.Component;",
      "29: import org.xwiki.component.phase.Initializable;",
      "31: import org.xwiki.index.TaskManager;",
      "32: import org.xwiki.observation.AbstractEventListener;",
      "33: import org.xwiki.observation.event.Event;",
      "",
      "[Removed Lines]",
      "30: import org.xwiki.component.phase.InitializationException;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "73:     }",
      "75:     @Override",
      "77:     {",
      "",
      "[Removed Lines]",
      "76:     public void initialize() throws InitializationException",
      "",
      "[Added Lines]",
      "75:     public void initialize()",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java": [
      "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: import java.util.List;",
      "25: import javax.inject.Named;",
      "27: import javax.inject.Singleton;",
      "29: import org.xwiki.component.annotation.Component;",
      "31: import org.xwiki.query.Query;",
      "32: import org.xwiki.query.QueryException;",
      "35: import com.xpn.xwiki.XWikiContext;",
      "36: import com.xpn.xwiki.store.migration.DataMigrationException;",
      "37: import com.xpn.xwiki.store.migration.XWikiDBVersion;",
      "40: import static org.xwiki.index.internal.DefaultLinksTaskConsumer.LINKS_TASK_TYPE;",
      "",
      "[Removed Lines]",
      "24: import javax.inject.Inject;",
      "26: import javax.inject.Provider;",
      "30: import org.xwiki.index.TaskManager;",
      "33: import org.xwiki.query.QueryManager;",
      "38: import com.xpn.xwiki.store.migration.hibernate.HibernateDataMigration;",
      "",
      "[Added Lines]",
      "28: import org.xwiki.internal.migration.AbstractDocumentsMigration;",
      "32: import com.xpn.xwiki.XWiki;",
      "34: import com.xpn.xwiki.doc.XWikiDocument;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "50: @Component",
      "51: @Singleton",
      "52: @Named(R140300000XWIKI19614DataMigration.HINT)",
      "53: @Deprecated(since = \"14.8RC1\")",
      "55: {",
      "59:     public static final String HINT = \"R140300000XWIKI19614\";",
      "70:     @Override",
      "71:     public String getName()",
      "72:     {",
      "",
      "[Removed Lines]",
      "54: public class R140300000XWIKI19614DataMigration implements HibernateDataMigration",
      "61:     @Inject",
      "62:     private QueryManager queryManager;",
      "64:     @Inject",
      "65:     private TaskManager taskManager;",
      "67:     @Inject",
      "68:     private Provider<XWikiContext> contextProvider;",
      "",
      "[Added Lines]",
      "51: public class R140300000XWIKI19614DataMigration extends AbstractDocumentsMigration",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "86:     }",
      "88:     @Override",
      "90:     {",
      "93:         if (context.getWiki().hasBacklinks(context)) {",
      "95:             try {",
      "102:             } catch (QueryException e) {",
      "103:                 throw new DataMigrationException(",
      "105:             }",
      "106:         }",
      "107:     }",
      "109:     @Override",
      "111:     {",
      "113:     }",
      "115:     @Override",
      "117:     {",
      "127:     }",
      "128: }",
      "",
      "[Removed Lines]",
      "89:     public void migrate() throws DataMigrationException",
      "91:         XWikiContext context = this.contextProvider.get();",
      "94:             String wikiId = context.getWikiId();",
      "96:                 List<Long> ids =",
      "97:                     this.queryManager.createQuery(\"SELECT doc.id FROM XWikiDocument doc\", Query.HQL).setWiki(wikiId)",
      "98:                         .execute();",
      "99:                 for (Long id : ids) {",
      "100:                     this.taskManager.addTask(wikiId, id, LINKS_TASK_TYPE);",
      "101:                 }",
      "104:                     String.format(\"Failed retrieve the list of all the documents for wiki [%s].\", wikiId), e);",
      "110:     public boolean shouldExecute(XWikiDBVersion startupVersion)",
      "112:         return true;",
      "116:     public String getPreHibernateLiquibaseChangeLog()",
      "119:         return null;",
      "120:     }",
      "122:     @Override",
      "123:     public String getLiquibaseChangeLog()",
      "124:     {",
      "126:         return null;",
      "",
      "[Added Lines]",
      "77:     protected String getTaskType()",
      "78:     {",
      "79:         return LINKS_TASK_TYPE;",
      "80:     }",
      "82:     @Override",
      "83:     protected List<String> selectDocuments() throws DataMigrationException",
      "85:         List<String> documents;",
      "86:         XWikiContext context = getXWikiContext();",
      "87:         XWiki wiki = getXWikiContext().getWiki();",
      "90:                 documents = wiki.getStore().getQueryManager()",
      "91:                     .createQuery(\"SELECT doc.fullName FROM XWikiDocument doc\", Query.HQL)",
      "92:                     .setWiki(context.getWikiId())",
      "93:                     .execute();",
      "96:                     String.format(\"Failed retrieve the list of all the documents for wiki [%s].\", wiki.getName()), e);",
      "98:         } else {",
      "99:             documents = List.of();",
      "101:         return documents;",
      "105:     protected void logBeforeQueuingTask(XWikiDocument document)",
      "111:     protected void logBeforeQueuingTasks(List<XWikiDocument> documents)",
      "113:         XWikiContext context = getXWikiContext();",
      "114:         if (context.getWiki().hasBacklinks(context)) {",
      "115:             super.logBeforeQueuingTasks(documents);",
      "116:         } else {",
      "117:             this.logger.info(\"Skipped because backlinks are not supported on [{}]\", context.getWikiId());",
      "118:         }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java": [
      "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-api/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: import java.util.List;",
      "26: import org.junit.jupiter.api.BeforeEach;",
      "27: import org.junit.jupiter.api.Test;",
      "28: import org.mockito.Mock;",
      "29: import org.xwiki.index.TaskManager;",
      "30: import org.xwiki.query.Query;",
      "31: import org.xwiki.query.QueryException;",
      "32: import org.xwiki.query.QueryManager;",
      "33: import org.xwiki.test.junit5.mockito.ComponentTest;",
      "34: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
      "35: import org.xwiki.test.junit5.mockito.MockComponent;",
      "37: import com.xpn.xwiki.XWiki;",
      "38: import com.xpn.xwiki.XWikiContext;",
      "39: import com.xpn.xwiki.store.migration.DataMigrationException;",
      "40: import com.xpn.xwiki.store.migration.hibernate.HibernateDataMigration;",
      "42: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "43: import static org.junit.jupiter.api.Assertions.assertThrows;",
      "44: import static org.mockito.ArgumentMatchers.any;",
      "45: import static org.mockito.Mockito.verify;",
      "46: import static org.mockito.Mockito.verifyNoInteractions;",
      "47: import static org.mockito.Mockito.when;",
      "",
      "[Removed Lines]",
      "24: import javax.inject.Provider;",
      "",
      "[Added Lines]",
      "26: import org.junit.jupiter.api.extension.RegisterExtension;",
      "28: import org.xwiki.context.Execution;",
      "29: import org.xwiki.context.ExecutionContext;",
      "31: import org.xwiki.model.reference.DocumentReference;",
      "32: import org.xwiki.model.reference.DocumentReferenceResolver;",
      "36: import org.xwiki.test.LogLevel;",
      "37: import org.xwiki.test.junit5.LogCaptureExtension;",
      "44: import com.xpn.xwiki.doc.XWikiDocument;",
      "45: import com.xpn.xwiki.store.XWikiStoreInterface;",
      "49: import ch.qos.logback.classic.Level;",
      "54: import static org.mockito.Mockito.mock;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "58:     @InjectMockComponents(role = HibernateDataMigration.class)",
      "59:     private R140300000XWIKI19614DataMigration migration;",
      "62:     private QueryManager queryManager;",
      "64:     @MockComponent",
      "65:     private TaskManager taskManager;",
      "67:     @MockComponent",
      "70:     @Mock",
      "71:     private XWikiContext context;",
      "",
      "[Removed Lines]",
      "61:     @MockComponent",
      "68:     private Provider<XWikiContext> contextProvider;",
      "",
      "[Added Lines]",
      "71:     @Mock",
      "78:     private Execution execution;",
      "80:     @MockComponent",
      "81:     private DocumentReferenceResolver<String> resolver;",
      "83:     @RegisterExtension",
      "84:     LogCaptureExtension logCapture = new LogCaptureExtension(LogLevel.INFO);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "79:     @BeforeEach",
      "80:     void setUp() throws Exception",
      "81:     {",
      "83:         when(this.context.getWiki()).thenReturn(this.wiki);",
      "84:         when(this.context.getWikiId()).thenReturn(\"wiki1\");",
      "86:             Query.HQL)).thenReturn(this.query);",
      "87:         when(this.query.setWiki(any())).thenReturn(this.query);",
      "88:     }",
      "",
      "[Removed Lines]",
      "82:         when(this.contextProvider.get()).thenReturn(this.context);",
      "85:         when(this.queryManager.createQuery(\"SELECT doc.id FROM XWikiDocument doc\",",
      "",
      "[Added Lines]",
      "98:         ExecutionContext executionContext = mock(ExecutionContext.class);",
      "99:         XWikiStoreInterface xWikiStoreInterface = mock(XWikiStoreInterface.class);",
      "101:         when(this.execution.getContext()).thenReturn(executionContext);",
      "102:         when(executionContext.getProperty(\"xwikicontext\")).thenReturn(this.context);",
      "104:         when(this.wiki.getName()).thenReturn(\"wiki1\");",
      "106:         when(this.wiki.getStore()).thenReturn(xWikiStoreInterface);",
      "107:         when(xWikiStoreInterface.getQueryManager()).thenReturn(this.queryManager);",
      "109:         when(this.queryManager.createQuery(\"SELECT doc.fullName FROM XWikiDocument doc\",",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "90:     @Test",
      "91:     void migrate() throws Exception",
      "92:     {",
      "93:         when(this.wiki.hasBacklinks(this.context)).thenReturn(true);",
      "97:         this.migration.migrate();",
      "99:         verify(this.query).setWiki(\"wiki1\");",
      "101:         verify(this.taskManager).addTask(\"wiki1\", 43L, \"links\");",
      "102:     }",
      "104:     @Test",
      "",
      "[Removed Lines]",
      "95:         when(this.query.execute()).thenReturn(List.of(42L, 43L));",
      "100:         verify(this.taskManager).addTask(\"wiki1\", 42L,  \"links\");",
      "",
      "[Added Lines]",
      "117:         DocumentReference doc42 = new DocumentReference(\"xwiki\", \"XWiki\", \"Doc42\");",
      "118:         DocumentReference doc43 = new DocumentReference(\"xwiki\", \"XWiki\", \"Doc43\");",
      "119:         XWikiDocument xWikiDocument42 = mock(XWikiDocument.class);",
      "120:         XWikiDocument xWikiDocument43 = mock(XWikiDocument.class);",
      "124:         when(this.query.execute()).thenReturn(List.of(\"xwiki.XWiki.Doc42\", \"xwiki.XWiki.Doc43\"));",
      "125:         when(this.resolver.resolve(\"xwiki.XWiki.Doc42\")).thenReturn(doc42);",
      "126:         when(this.resolver.resolve(\"xwiki.XWiki.Doc43\")).thenReturn(doc43);",
      "127:         when(this.wiki.getDocument(doc42, this.context)).thenReturn(xWikiDocument42);",
      "128:         when(this.wiki.getDocument(doc43, this.context)).thenReturn(xWikiDocument43);",
      "129:         when(xWikiDocument42.getId()).thenReturn(42L);",
      "130:         when(xWikiDocument43.getId()).thenReturn(43L);",
      "135:         verify(this.taskManager).addTask(\"wiki1\", 42L, \"links\");",
      "138:         assertEquals(\"[2] documents queued to task [links]\", this.logCapture.getMessage(0));",
      "139:         assertEquals(Level.INFO, this.logCapture.getLogEvent(0).getLevel());",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "111:         DataMigrationException queryException =",
      "112:             assertThrows(DataMigrationException.class, () -> this.migration.migrate());",
      "117:         verify(this.query).setWiki(\"wiki1\");",
      "118:         verifyNoInteractions(this.taskManager);",
      "",
      "[Removed Lines]",
      "114:         assertEquals(\"Failed retrieve the list of all the documents for wiki [wiki1].\", queryException.getMessage());",
      "115:         assertEquals(QueryException.class, queryException.getCause().getClass());",
      "",
      "[Added Lines]",
      "152:         assertEquals(\"Data migration R140300000XWIKI19614 failed\", queryException.getMessage());",
      "153:         assertEquals(\"Failed retrieve the list of all the documents for wiki [wiki1].\",",
      "154:             queryException.getCause().getMessage());",
      "155:         assertEquals(DataMigrationException.class, queryException.getCause().getClass());",
      "156:         assertEquals(QueryException.class, queryException.getCause().getCause().getClass());",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "125:         this.migration.migrate();",
      "126:         verifyNoInteractions(this.queryManager);",
      "127:         verifyNoInteractions(this.taskManager);",
      "128:     }",
      "129: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "169:         assertEquals(\"Skipped because backlinks are not supported on [wiki1]\", this.logCapture.getMessage(0));",
      "170:         assertEquals(Level.INFO, this.logCapture.getLogEvent(0).getLevel());",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationCommonPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "89:     void testEq0() throws Exception",
      "90:     {",
      "91:         this.context.setDoc(this.xwiki.getDocument(",
      "94:         DocumentReference invitationCommonReference = new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationCommon\");",
      "95:         Document document = Jsoup.parse(loadPage(invitationCommonReference).getRenderedContent(this.context));",
      "97:             document.selectFirst(\".infomessage\").text());",
      "98:     }",
      "",
      "[Removed Lines]",
      "92:             new DocumentReference(\"xwiki\", \"<script>console.log</script>\", \"InvitationCommon\"), this.context));",
      "96:         assertEquals(\"xe.invitation.internalDocument [<script>console\\\\.log</script>.WebHome]\",",
      "",
      "[Added Lines]",
      "92:             new DocumentReference(\"xwiki\", \"]]  {{noscript/}}\", \"InvitationCommon\"), this.context));",
      "96:         assertEquals(\"xe.invitation.internalDocument []] {{noscript/}}.WebHome]\",",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationConfigPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.invitation;",
      "22: import org.jsoup.Jsoup;",
      "23: import org.jsoup.nodes.Document;",
      "24: import org.jsoup.nodes.Element;",
      "25: import org.junit.jupiter.api.Test;",
      "26: import org.xwiki.model.reference.DocumentReference;",
      "27: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "28: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "29: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "30: import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;",
      "31: import org.xwiki.test.annotation.ComponentList;",
      "32: import org.xwiki.test.page.HTML50ComponentList;",
      "33: import org.xwiki.test.page.PageTest;",
      "34: import org.xwiki.test.page.TestNoScriptMacro;",
      "35: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "37: import com.xpn.xwiki.doc.XWikiDocument;",
      "39: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "49: @HTML50ComponentList",
      "50: @XWikiSyntax21ComponentList",
      "51: @RenderingScriptServiceComponentList",
      "52: @ComponentList({",
      "53:     InfoMessageMacro.class,",
      "54:     TestNoScriptMacro.class,",
      "56:     DefaultExtendedRenderingConfiguration.class,",
      "57:     RenderingConfigClassDocumentConfigurationSource.class,",
      "59: })",
      "60: class InvitationConfigPageTest extends PageTest",
      "61: {",
      "62:     private static final DocumentReference INVITATION_CONFIG_DOCUMENT_REFERENCE =",
      "63:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationConfig\");",
      "65:     @Test",
      "66:     void escapeInfoMessageInternalDocumentParameter() throws Exception",
      "67:     {",
      "68:         XWikiDocument invitationGuestActionsDocument = loadPage(INVITATION_CONFIG_DOCUMENT_REFERENCE);",
      "71:         this.context.setDoc(",
      "72:             this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"]] {{noscript/}}\", \"Page\"), this.context));",
      "74:         Document document = Jsoup.parse(invitationGuestActionsDocument.getRenderedContent(this.context));",
      "75:         Element infomessage = document.selectFirst(\".infomessage\");",
      "76:         assertEquals(\"xe.invitation.internalDocument [Invitation.WebHome]\", infomessage.text());",
      "77:     }",
      "78: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationGuestActionsPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.invitation;",
      "22: import org.jsoup.Jsoup;",
      "23: import org.jsoup.nodes.Document;",
      "24: import org.jsoup.nodes.Element;",
      "25: import org.junit.jupiter.api.BeforeEach;",
      "26: import org.junit.jupiter.api.Test;",
      "27: import org.xwiki.model.reference.DocumentReference;",
      "28: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "29: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "30: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "31: import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;",
      "32: import org.xwiki.test.annotation.ComponentList;",
      "33: import org.xwiki.test.page.HTML50ComponentList;",
      "34: import org.xwiki.test.page.PageTest;",
      "35: import org.xwiki.test.page.TestNoScriptMacro;",
      "36: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "38: import com.xpn.xwiki.doc.XWikiDocument;",
      "40: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "50: @HTML50ComponentList",
      "51: @XWikiSyntax21ComponentList",
      "52: @RenderingScriptServiceComponentList",
      "53: @ComponentList({",
      "54:     InfoMessageMacro.class,",
      "55:     TestNoScriptMacro.class,",
      "57:     DefaultExtendedRenderingConfiguration.class,",
      "58:     RenderingConfigClassDocumentConfigurationSource.class,",
      "60: })",
      "61: class InvitationGuestActionsPageTest extends PageTest",
      "62: {",
      "63:     private static final DocumentReference INVITATION_COMMON_DOCUMENT_REFERENCE =",
      "64:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationCommon\");",
      "66:     private static final DocumentReference INVITATION_GUEST_ACTIONS_DOCUMENT_REFERENCE =",
      "67:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationGuestActions\");",
      "69:     @BeforeEach",
      "70:     void setUp() throws Exception",
      "71:     {",
      "72:         loadPage(INVITATION_COMMON_DOCUMENT_REFERENCE);",
      "73:     }",
      "75:     @Test",
      "76:     void escapeInfoMessageInternalDocumentParameter() throws Exception",
      "77:     {",
      "78:         XWikiDocument invitationGuestActionsDocument = loadPage(INVITATION_GUEST_ACTIONS_DOCUMENT_REFERENCE);",
      "81:         this.context.setDoc(",
      "82:             this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"]] {{noscript/}}\", \"Page\"), this.context));",
      "84:         Document document = Jsoup.parse(invitationGuestActionsDocument.getRenderedContent(this.context));",
      "85:         Element infomessage = document.selectFirst(\".infomessage\");",
      "86:         assertEquals(\"xe.invitation.internalDocument []] {{noscript/}}.WebHome]\", infomessage.text());",
      "87:     }",
      "88: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMailClassPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.invitation;",
      "22: import org.jsoup.Jsoup;",
      "23: import org.jsoup.nodes.Document;",
      "24: import org.jsoup.nodes.Element;",
      "25: import org.junit.jupiter.api.Test;",
      "26: import org.xwiki.model.reference.DocumentReference;",
      "27: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "28: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "29: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "30: import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;",
      "31: import org.xwiki.test.annotation.ComponentList;",
      "32: import org.xwiki.test.page.HTML50ComponentList;",
      "33: import org.xwiki.test.page.PageTest;",
      "34: import org.xwiki.test.page.TestNoScriptMacro;",
      "35: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "37: import com.xpn.xwiki.doc.XWikiDocument;",
      "39: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "49: @HTML50ComponentList",
      "50: @XWikiSyntax21ComponentList",
      "51: @RenderingScriptServiceComponentList",
      "52: @ComponentList({",
      "53:     InfoMessageMacro.class,",
      "54:     TestNoScriptMacro.class,",
      "56:     DefaultExtendedRenderingConfiguration.class,",
      "57:     RenderingConfigClassDocumentConfigurationSource.class,",
      "59: })",
      "60: class InvitationMailClassPageTest extends PageTest",
      "61: {",
      "62:     private static final DocumentReference INVITATION_MAIL_CLASS_DOCUMENT_REFERENCE =",
      "63:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationMailClass\");",
      "65:     @Test",
      "66:     void escapeInfoMessageInternalDocumentParameter() throws Exception",
      "67:     {",
      "68:         XWikiDocument invitationGuestActionsDocument = loadPage(INVITATION_MAIL_CLASS_DOCUMENT_REFERENCE);",
      "71:         this.context.setDoc(",
      "72:             this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"]] {{noscript/}}\", \"Page\"), this.context));",
      "74:         Document document = Jsoup.parse(invitationGuestActionsDocument.getRenderedContent(this.context));",
      "75:         Element infomessage = document.selectFirst(\".infomessage\");",
      "76:         assertEquals(\"xe.invitation.internalDocument []] {{noscript/}}.WebHome]\", infomessage.text());",
      "77:     }",
      "78: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMemberActionsPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.invitation;",
      "22: import org.jsoup.Jsoup;",
      "23: import org.jsoup.nodes.Document;",
      "24: import org.jsoup.nodes.Element;",
      "25: import org.junit.jupiter.api.BeforeEach;",
      "26: import org.junit.jupiter.api.Test;",
      "27: import org.xwiki.model.reference.DocumentReference;",
      "28: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "29: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "30: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "31: import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;",
      "32: import org.xwiki.test.annotation.ComponentList;",
      "33: import org.xwiki.test.page.HTML50ComponentList;",
      "34: import org.xwiki.test.page.PageTest;",
      "35: import org.xwiki.test.page.TestNoScriptMacro;",
      "36: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "38: import com.xpn.xwiki.doc.XWikiDocument;",
      "40: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "50: @HTML50ComponentList",
      "51: @XWikiSyntax21ComponentList",
      "52: @RenderingScriptServiceComponentList",
      "53: @ComponentList({",
      "54:     InfoMessageMacro.class,",
      "55:     TestNoScriptMacro.class,",
      "57:     DefaultExtendedRenderingConfiguration.class,",
      "58:     RenderingConfigClassDocumentConfigurationSource.class,",
      "60: })",
      "61: class InvitationMemberActionsPageTest extends PageTest",
      "62: {",
      "63:     private static final DocumentReference INVITATION_COMMON_DOCUMENT_REFERENCE =",
      "64:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationCommon\");",
      "66:     private static final DocumentReference INVITATION_MEMBER_ACTIONS_DOCUMENT_REFERENCE =",
      "67:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationMemberActions\");",
      "69:     @BeforeEach",
      "70:     void setUp() throws Exception",
      "71:     {",
      "72:         loadPage(INVITATION_COMMON_DOCUMENT_REFERENCE);",
      "73:     }",
      "75:     @Test",
      "76:     void escapeInfoMessageInternalDocumentParameter() throws Exception",
      "77:     {",
      "78:         XWikiDocument invitationGuestActionsDocument = loadPage(INVITATION_MEMBER_ACTIONS_DOCUMENT_REFERENCE);",
      "81:         this.context.setUserReference(new DocumentReference(\"xwiki\", \"XWiki\", \"U1\"));",
      "84:         this.context.setDoc(",
      "85:             this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"]] {{noscript/}}\", \"Page\"), this.context));",
      "87:         Document document = Jsoup.parse(invitationGuestActionsDocument.getRenderedContent(this.context));",
      "88:         Element infomessage = document.selectFirst(\".infomessage\");",
      "89:         assertEquals(\"xe.invitation.internalDocument []] {{noscript/}}.WebHome]\", infomessage.text());",
      "90:     }",
      "91: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java||xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java -> xwiki-platform-core/xwiki-platform-invitation/xwiki-platform-invitation-ui/src/test/java/org/xwiki/invitation/InvitationMembersCommonPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.invitation;",
      "22: import org.jsoup.Jsoup;",
      "23: import org.jsoup.nodes.Document;",
      "24: import org.junit.jupiter.api.Test;",
      "25: import org.xwiki.model.reference.DocumentReference;",
      "26: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "27: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "28: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "29: import org.xwiki.rendering.internal.macro.message.InfoMessageMacro;",
      "30: import org.xwiki.test.annotation.ComponentList;",
      "31: import org.xwiki.test.page.HTML50ComponentList;",
      "32: import org.xwiki.test.page.PageTest;",
      "33: import org.xwiki.test.page.TestNoScriptMacro;",
      "34: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "36: import com.xpn.xwiki.doc.XWikiDocument;",
      "38: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "48: @HTML50ComponentList",
      "49: @XWikiSyntax21ComponentList",
      "50: @RenderingScriptServiceComponentList",
      "51: @ComponentList({",
      "52:     InfoMessageMacro.class,",
      "53:     TestNoScriptMacro.class,",
      "55:     DefaultExtendedRenderingConfiguration.class,",
      "56:     RenderingConfigClassDocumentConfigurationSource.class,",
      "58: })",
      "59: class InvitationMembersCommonPageTest extends PageTest",
      "60: {",
      "61:     private static final DocumentReference INVITATION_MEMBER_COMMON_DOCUMENT_REFERENCE =",
      "62:         new DocumentReference(\"xwiki\", \"Invitation\", \"InvitationMembersCommon\");",
      "64:     @Test",
      "65:     void escapeInfoMessageInternalDocumentParameter() throws Exception",
      "66:     {",
      "67:         XWikiDocument invitationGuestActionsDocument = loadPage(INVITATION_MEMBER_COMMON_DOCUMENT_REFERENCE);",
      "70:         this.context.setUserReference(new DocumentReference(\"xwiki\", \"XWiki\", \"U1\"));",
      "73:         this.context.setDoc(",
      "74:             this.xwiki.getDocument(new DocumentReference(\"xwiki\", \"]] {{noscript/}}\", \"InvitationMembersCommon\"),",
      "75:                 this.context));",
      "77:         Document document = Jsoup.parse(invitationGuestActionsDocument.getRenderedContent(this.context));",
      "78:         assertEquals(\"xe.invitation.internalDocument []] {{noscript/}}.WebHome]\",",
      "79:             document.selectFirst(\".infomessage\").text());",
      "80:     }",
      "81: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/extension/XARExtensionIndex.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.extension;",
      "22: import org.xwiki.component.annotation.Role;",
      "23: import org.xwiki.model.reference.DocumentReference;",
      "33: @Role",
      "34: public interface XARExtensionIndex",
      "35: {",
      "40:     boolean isExtensionDocument(DocumentReference documentReference);",
      "41: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.migration;",
      "22: import java.util.List;",
      "23: import java.util.Optional;",
      "25: import javax.inject.Inject;",
      "27: import org.slf4j.Logger;",
      "28: import org.xwiki.index.TaskManager;",
      "29: import org.xwiki.model.reference.DocumentReferenceResolver;",
      "31: import com.xpn.xwiki.XWikiContext;",
      "32: import com.xpn.xwiki.XWikiException;",
      "33: import com.xpn.xwiki.doc.XWikiDocument;",
      "34: import com.xpn.xwiki.store.migration.DataMigrationException;",
      "35: import com.xpn.xwiki.store.migration.hibernate.AbstractHibernateDataMigration;",
      "37: import static java.util.stream.Collectors.toList;",
      "52: public abstract class AbstractDocumentsMigration extends AbstractHibernateDataMigration",
      "53: {",
      "54:     @Inject",
      "55:     protected Logger logger;",
      "57:     @Inject",
      "58:     protected DocumentReferenceResolver<String> documentReferenceResolver;",
      "60:     @Inject",
      "61:     private TaskManager taskManager;",
      "63:     @Override",
      "64:     protected void hibernateMigrate() throws DataMigrationException",
      "65:     {",
      "66:         List<XWikiDocument> documents = selectDocuments()",
      "67:             .stream()",
      "68:             .map(this::convert)",
      "69:             .filter(Optional::isPresent)",
      "70:             .map(Optional::get)",
      "71:             .collect(toList());",
      "72:         logBeforeQueuingTasks(documents);",
      "73:         for (XWikiDocument document : documents) {",
      "74:             logBeforeQueuingTask(document);",
      "75:             this.taskManager.addTask(this.getXWikiContext().getWikiId(), document.getId(), getTaskType());",
      "76:         }",
      "77:     }",
      "79:     private Optional<XWikiDocument> convert(String documentReference)",
      "80:     {",
      "81:         XWikiContext context = getXWikiContext();",
      "82:         try {",
      "83:             return Optional.of(",
      "84:                 context.getWiki().getDocument(this.documentReferenceResolver.resolve(documentReference), context));",
      "85:         } catch (XWikiException e) {",
      "86:             this.logger.error(\"Failed to resolve [{}]\", documentReference, e);",
      "87:             return Optional.empty();",
      "88:         }",
      "89:     }",
      "94:     protected abstract String getTaskType();",
      "99:     protected abstract List<String> selectDocuments() throws DataMigrationException;",
      "106:     protected void logBeforeQueuingTasks(List<XWikiDocument> documents)",
      "107:     {",
      "108:         this.logger.info(\"[{}] documents queued to task [{}]\", documents.size(), getTaskType());",
      "109:     }",
      "116:     protected void logBeforeQueuingTask(XWikiDocument document)",
      "117:     {",
      "118:         this.logger.info(\"document [{}] queued to task [{}]\", document, getTaskType());",
      "119:     }",
      "120: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixer.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.migration;",
      "22: import java.util.Objects;",
      "23: import java.util.Optional;",
      "24: import java.util.regex.Pattern;",
      "26: import javax.inject.Singleton;",
      "28: import org.xwiki.component.annotation.Component;",
      "29: import org.xwiki.rendering.syntax.Syntax;",
      "31: import static java.util.regex.Matcher.quoteReplacement;",
      "43: @Component(roles = InvitationInternalDocumentParameterEscapingFixer.class)",
      "44: @Singleton",
      "45: public class InvitationInternalDocumentParameterEscapingFixer",
      "46: {",
      "47:     private static final Pattern PATTERN = Pattern.compile(\"(\\\\{\\\\{info}}\"",
      "48:         + \"\\\\$services\\\\.localization\\\\.render\\\\('xe\\\\.invitation\\\\.internalDocument', \\\\[)(\\\"[^\\\"]+\\\")(]\\\\)\\\\\"",
      "49:         + \"{\\\\{/info}})\");",
      "56:     public Optional<String> fix(String content, Syntax syntax)",
      "57:     {",
      "58:         String escapedContent = PATTERN.matcher(content).replaceAll(matchResult -> {",
      "59:             if (matchResult.group(2).contains(\"services.rendering.escape\")) {",
      "60:                 return matchResult.group();",
      "61:             } else {",
      "64:                 String format = String.format(\"%s$services.rendering.escape(%s, '%s')%s\", matchResult.group(1),",
      "65:                     matchResult.group(2), syntax.toIdString(), matchResult.group(3));",
      "66:                 return quoteReplacement(format);",
      "67:             }",
      "68:         });",
      "70:         if (Objects.equals(escapedContent, content)) {",
      "71:             return Optional.empty();",
      "72:         } else {",
      "73:             return Optional.of(escapedContent);",
      "74:         }",
      "75:     }",
      "76: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingTaskConsumer.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.migration;",
      "22: import java.util.List;",
      "24: import javax.inject.Inject;",
      "25: import javax.inject.Named;",
      "26: import javax.inject.Provider;",
      "27: import javax.inject.Singleton;",
      "29: import org.slf4j.Logger;",
      "30: import org.xwiki.component.annotation.Component;",
      "31: import org.xwiki.index.IndexException;",
      "32: import org.xwiki.index.TaskConsumer;",
      "33: import org.xwiki.model.reference.DocumentReference;",
      "34: import org.xwiki.rendering.syntax.Syntax;",
      "36: import com.xpn.xwiki.XWikiContext;",
      "37: import com.xpn.xwiki.XWikiException;",
      "38: import com.xpn.xwiki.doc.XWikiDocument;",
      "51: @Component",
      "52: @Singleton",
      "53: @Named(InvitationInternalDocumentParameterEscapingTaskConsumer.HINT)",
      "54: public class InvitationInternalDocumentParameterEscapingTaskConsumer implements TaskConsumer",
      "55: {",
      "59:     public static final String HINT = \"internal-document-parameter-escaping\";",
      "61:     @Inject",
      "62:     private Logger logger;",
      "64:     @Inject",
      "65:     private Provider<XWikiContext> contextProvider;",
      "67:     @Inject",
      "68:     private InvitationInternalDocumentParameterEscapingFixer invitationInternalDocumentParameterEscapingFixer;",
      "70:     @Override",
      "71:     public void consume(DocumentReference documentReference, String version) throws IndexException",
      "72:     {",
      "73:         try {",
      "74:             XWikiContext context = this.contextProvider.get();",
      "75:             task(context.getWiki().getDocument(documentReference, context));",
      "76:         } catch (XWikiException e) {",
      "77:             throw new IndexException(String.format(\"Failed to resolve document [%s]\", documentReference), e);",
      "78:         }",
      "79:     }",
      "81:     private void task(XWikiDocument document)",
      "82:     {",
      "83:         Syntax syntax = document.getSyntax();",
      "84:         if (List.of(Syntax.XWIKI_2_1, Syntax.XWIKI_2_0).contains(syntax)) {",
      "85:             try {",
      "86:                 this.invitationInternalDocumentParameterEscapingFixer.fix(document.getContent(), document.getSyntax())",
      "87:                     .ifPresent(content -> {",
      "88:                         document.setContent(content);",
      "89:                         try {",
      "90:                             XWikiContext context = this.contextProvider.get();",
      "91:                             context.getWiki().saveDocument(document, \"Automatic bad escaping fix.\", true, context);",
      "92:                             this.logger.info(\"[{}] successfully fixed.\", document);",
      "93:                         } catch (XWikiException e) {",
      "94:                             this.logger.error(\"Failed to save document [{}]\", document, e);",
      "95:                         }",
      "96:                     });",
      "97:             } catch (Exception e) {",
      "98:                 this.logger.error(\"Unexpected error while fixing [{}]\", document, e);",
      "99:             }",
      "100:         } else {",
      "101:             this.logger.warn(",
      "102:                 \"[{}] skipped because escaping for syntax [{}] is not supported. It is advised to review this file.\",",
      "103:                 document, syntax);",
      "104:         }",
      "105:     }",
      "106: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.migration;",
      "22: import java.util.List;",
      "23: import java.util.stream.Collectors;",
      "25: import javax.inject.Inject;",
      "26: import javax.inject.Named;",
      "27: import javax.inject.Singleton;",
      "29: import org.xwiki.component.annotation.Component;",
      "30: import org.xwiki.internal.extension.XARExtensionIndex;",
      "31: import org.xwiki.query.QueryException;",
      "33: import com.xpn.xwiki.XWiki;",
      "34: import com.xpn.xwiki.store.migration.DataMigrationException;",
      "35: import com.xpn.xwiki.store.migration.XWikiDBVersion;",
      "37: import static org.xwiki.query.Query.XWQL;",
      "48: @Component",
      "49: @Named(\"R150000000XWIKI20285\")",
      "50: @Singleton",
      "51: public class R150000000XWIKI20285DataMigration extends AbstractDocumentsMigration",
      "52: {",
      "53:     @Inject",
      "54:     private XARExtensionIndex installedXARs;",
      "56:     @Override",
      "57:     public String getDescription()",
      "58:     {",
      "59:         return \"Patch the InvitationConfig documents with improper escaping.\";",
      "60:     }",
      "62:     @Override",
      "63:     public XWikiDBVersion getVersion()",
      "64:     {",
      "65:         return new XWikiDBVersion(150000000);",
      "66:     }",
      "68:     @Override",
      "69:     protected String getTaskType()",
      "70:     {",
      "71:         return InvitationInternalDocumentParameterEscapingTaskConsumer.HINT;",
      "72:     }",
      "74:     @Override",
      "75:     protected List<String> selectDocuments() throws DataMigrationException",
      "76:     {",
      "77:         XWiki wiki = getXWikiContext().getWiki();",
      "78:         try {",
      "82:             return wiki.getStore().getQueryManager()",
      "83:                 .createQuery(\"where doc.content \"",
      "84:                     + \"like '%{{info}}%services.localization.render%xe.invitation.internalDocument%{{/info}}%'\", XWQL)",
      "85:                 .<String>execute()",
      "86:                 .stream()",
      "89:                 .filter(documentReference -> !this.installedXARs.isExtensionDocument(",
      "90:                     this.documentReferenceResolver.resolve(documentReference)))",
      "91:                 .collect(Collectors.toList());",
      "92:         } catch (QueryException e) {",
      "93:             throw new DataMigrationException(",
      "94:                 String.format(\"Failed retrieve the list of all the documents for wiki [%s].\", wiki.getName()), e);",
      "95:         }",
      "96:     }",
      "97: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/org/xwiki/internal/migration/InvitationInternalDocumentParameterEscapingFixerTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.internal.migration;",
      "22: import java.util.Optional;",
      "23: import java.util.stream.Stream;",
      "25: import org.junit.jupiter.params.ParameterizedTest;",
      "26: import org.junit.jupiter.params.provider.Arguments;",
      "27: import org.junit.jupiter.params.provider.MethodSource;",
      "28: import org.xwiki.rendering.syntax.Syntax;",
      "29: import org.xwiki.test.junit5.mockito.ComponentTest;",
      "30: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
      "32: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "39: @ComponentTest",
      "40: class InvitationInternalDocumentParameterEscapingFixerTest",
      "41: {",
      "42:     @InjectMockComponents",
      "43:     private InvitationInternalDocumentParameterEscapingFixer fixer;",
      "45:     public static Stream<Arguments> fixSource()",
      "46:     {",
      "47:         return Stream.of(",
      "48:             Arguments.of(",
      "49:                 \"nothing to change 1\\n\"",
      "50:                     + \"{{info}}$services.localization.render('xe.invitation.internalDocument', [$noChange]){{/info}}\"",
      "51:                     + \"nothing to change 2\\n\"",
      "52:                     + \"{{info}}$services.localization.render('xe.invitation.internalDocument', [\\\"$change\\\"]){{/info}}\"",
      "53:                     + \"nothing to change 3\",",
      "54:                 Optional.of(",
      "55:                     \"nothing to change 1\\n\"",
      "56:                         + \"{{info}}$services.localization.render('xe.invitation.internalDocument', [$noChange]){{/info}}nothing to change 2\\n\"",
      "57:                         + \"{{info}}$services.localization.render('xe.invitation.internalDocument', [$services.rendering.escape(\\\"$change\\\", 'xwiki/2.1')]){{/info}}nothing to change 3\"",
      "58:                 )",
      "59:             ),",
      "60:             Arguments.of(",
      "61:                 \"nothing to change 1\\n\"",
      "62:                     + \"{{info}}$services.localization.render('xe.invitation.internalDocument', [$noChange]){{/info}}\"",
      "63:                     + \"nothing to change 2\\n\"",
      "64:                     + \"nothing to change 3\",",
      "65:                 Optional.empty()",
      "66:             )",
      "67:         );",
      "68:     }",
      "70:     @ParameterizedTest",
      "71:     @MethodSource(\"fixSource\")",
      "72:     void fix(String value, Optional<String> expected)",
      "73:     {",
      "74:         assertEquals(expected, this.fixer.fix(value, Syntax.XWIKI_2_1));",
      "75:     }",
      "76: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f4a29d272343e556c6ad3c7ded63bb40410d3b0",
      "candidate_info": {
        "commit_hash": "0f4a29d272343e556c6ad3c7ded63bb40410d3b0",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/0f4a29d272343e556c6ad3c7ded63bb40410d3b0",
        "files": [
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
        ],
        "message": "XWIKI-21089: AbstractDocumentsMigration memory footprint is too large (#2240)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.index.internal.migration;",
          "22: import java.util.List;",
          "24: import javax.inject.Named;",
          "25: import javax.inject.Singleton;",
          "27: import org.xwiki.component.annotation.Component;",
          "28: import org.xwiki.internal.migration.AbstractDocumentsMigration;",
          "29: import org.xwiki.query.Query;",
          "30: import org.xwiki.query.QueryException;",
          "32: import com.xpn.xwiki.XWiki;",
          "33: import com.xpn.xwiki.XWikiContext;",
          "35: import com.xpn.xwiki.store.migration.DataMigrationException;",
          "36: import com.xpn.xwiki.store.migration.XWikiDBVersion;",
          "",
          "[Removed Lines]",
          "34: import com.xpn.xwiki.doc.XWikiDocument;",
          "",
          "[Added Lines]",
          "23: import java.util.stream.Collectors;",
          "30: import org.xwiki.model.reference.DocumentReference;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "81:     }",
          "83:     @Override",
          "85:     {",
          "87:         XWikiContext context = getXWikiContext();",
          "88:         XWiki wiki = getXWikiContext().getWiki();",
          "89:         if (context.getWiki().hasBacklinks(context)) {",
          "90:             try {",
          "93:                     .setWiki(context.getWikiId())",
          "95:             } catch (QueryException e) {",
          "96:                 throw new DataMigrationException(",
          "97:                     String.format(\"Failed retrieve the list of all the documents for wiki [%s].\", wiki.getName()), e);",
          "",
          "[Removed Lines]",
          "84:     protected List<String> selectDocuments() throws DataMigrationException",
          "86:         List<String> documents;",
          "91:                 documents = wiki.getStore().getQueryManager()",
          "92:                     .createQuery(\"SELECT doc.fullName FROM XWikiDocument doc\", Query.HQL)",
          "94:                     .execute();",
          "",
          "[Added Lines]",
          "85:     protected List<DocumentReference> selectDocuments() throws DataMigrationException",
          "87:         List<DocumentReference> documents;",
          "92:                 documents = wiki.getStore()",
          "93:                     .getQueryManager()",
          "94:                     .createQuery(\"SELECT doc.fullName, doc.language FROM XWikiDocument doc\", Query.HQL)",
          "96:                     .<Object[]>execute()",
          "97:                     .stream()",
          "98:                     .flatMap(",
          "99:                         array -> resolveDocumentReference(String.valueOf(array[0]), String.valueOf(array[1])).stream())",
          "100:                     .collect(Collectors.toList());",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "103:     }",
          "105:     @Override",
          "107:     {",
          "109:     }",
          "111:     @Override",
          "113:     {",
          "114:         XWikiContext context = getXWikiContext();",
          "115:         if (context.getWiki().hasBacklinks(context)) {",
          "",
          "[Removed Lines]",
          "106:     protected void logBeforeQueuingTask(XWikiDocument document)",
          "112:     protected void logBeforeQueuingTasks(List<XWikiDocument> documents)",
          "",
          "[Added Lines]",
          "112:     protected void logBeforeQueuingTask(DocumentReference documentReference)",
          "118:     protected void logBeforeQueuingTasks(List<DocumentReference> documents)",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java": [
          "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "44: import com.xpn.xwiki.XWiki;",
          "45: import com.xpn.xwiki.XWikiContext;",
          "47: import com.xpn.xwiki.store.XWikiStoreInterface;",
          "48: import com.xpn.xwiki.store.migration.DataMigrationException;",
          "49: import com.xpn.xwiki.store.migration.hibernate.HibernateDataMigration;",
          "",
          "[Removed Lines]",
          "46: import com.xpn.xwiki.doc.XWikiDocument;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109:         when(this.wiki.getStore()).thenReturn(xWikiStoreInterface);",
          "110:         when(xWikiStoreInterface.getQueryManager()).thenReturn(this.queryManager);",
          "113:             Query.HQL)).thenReturn(this.query);",
          "114:         when(this.query.setWiki(any())).thenReturn(this.query);",
          "115:     }",
          "",
          "[Removed Lines]",
          "112:         when(this.queryManager.createQuery(\"SELECT doc.fullName FROM XWikiDocument doc\",",
          "",
          "[Added Lines]",
          "111:         when(this.queryManager.createQuery(\"SELECT doc.fullName, doc.language FROM XWikiDocument doc\",",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "119:     {",
          "120:         DocumentReference doc42 = new DocumentReference(\"xwiki\", \"XWiki\", \"Doc42\");",
          "121:         DocumentReference doc43 = new DocumentReference(\"xwiki\", \"XWiki\", \"Doc43\");",
          "125:         when(this.wiki.hasBacklinks(this.context)).thenReturn(true);",
          "135:         this.migration.migrate();",
          "137:         verify(this.query).setWiki(\"wiki1\");",
          "141:         assertEquals(\"[2] documents queued to task [links]\", this.logCapture.getMessage(0));",
          "142:         assertEquals(Level.INFO, this.logCapture.getLogEvent(0).getLevel());",
          "",
          "[Removed Lines]",
          "122:         XWikiDocument xWikiDocument42 = mock(XWikiDocument.class);",
          "123:         XWikiDocument xWikiDocument43 = mock(XWikiDocument.class);",
          "127:         when(this.query.execute()).thenReturn(List.of(\"xwiki.XWiki.Doc42\", \"xwiki.XWiki.Doc43\"));",
          "128:         when(this.resolver.resolve(\"xwiki.XWiki.Doc42\")).thenReturn(doc42);",
          "129:         when(this.resolver.resolve(\"xwiki.XWiki.Doc43\")).thenReturn(doc43);",
          "130:         when(this.wiki.getDocument(doc42, this.context)).thenReturn(xWikiDocument42);",
          "131:         when(this.wiki.getDocument(doc43, this.context)).thenReturn(xWikiDocument43);",
          "132:         when(xWikiDocument42.getId()).thenReturn(42L);",
          "133:         when(xWikiDocument43.getId()).thenReturn(43L);",
          "138:         verify(this.taskManager).addTask(\"wiki1\", 42L, \"links\");",
          "139:         verify(this.taskManager).addTask(\"wiki1\", 43L, \"links\");",
          "",
          "[Added Lines]",
          "124:         when(this.query.execute()).thenReturn(List.of(",
          "125:             new String[] { \"XWiki.Doc42\", \"\" },",
          "126:             new String[] { \"XWiki.Doc43\", \"fr\" }",
          "127:         ));",
          "128:         when(this.resolver.resolve(\"XWiki.Doc42\")).thenReturn(doc42);",
          "129:         when(this.resolver.resolve(\"XWiki.Doc43\")).thenReturn(doc43);",
          "134:         verify(this.taskManager).addTask(\"wiki1\", -7672023672109484185L, \"links\");",
          "135:         verify(this.taskManager).addTask(\"wiki1\", -3303915339101339304L, \"links\");",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.internal.migration;",
          "22: import java.util.List;",
          "23: import java.util.Optional;",
          "25: import javax.inject.Inject;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23: import java.util.Locale;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28: import org.slf4j.Logger;",
          "29: import org.xwiki.index.TaskManager;",
          "30: import org.xwiki.model.reference.DocumentReferenceResolver;",
          "34: import com.xpn.xwiki.doc.XWikiDocument;",
          "35: import com.xpn.xwiki.store.migration.DataMigrationException;",
          "36: import com.xpn.xwiki.store.migration.hibernate.AbstractHibernateDataMigration;",
          "",
          "[Removed Lines]",
          "32: import com.xpn.xwiki.XWikiContext;",
          "33: import com.xpn.xwiki.XWikiException;",
          "38: import static java.util.stream.Collectors.toList;",
          "",
          "[Added Lines]",
          "31: import org.xwiki.model.reference.DocumentReference;",
          "38: import static org.apache.commons.lang3.exception.ExceptionUtils.getRootCauseMessage;",
          "39: import static org.xwiki.localization.LocaleUtils.toLocale;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "65:     @Override",
          "66:     protected void hibernateMigrate() throws DataMigrationException",
          "67:     {",
          "90:         }",
          "91:     }",
          "",
          "[Removed Lines]",
          "68:         List<XWikiDocument> documents = selectDocuments()",
          "69:             .stream()",
          "70:             .map(this::convert)",
          "71:             .filter(Optional::isPresent)",
          "72:             .map(Optional::get)",
          "73:             .collect(toList());",
          "74:         logBeforeQueuingTasks(documents);",
          "75:         for (XWikiDocument document : documents) {",
          "76:             logBeforeQueuingTask(document);",
          "77:             this.taskManager.addTask(this.getXWikiContext().getWikiId(), document.getId(), getTaskType());",
          "78:         }",
          "79:     }",
          "81:     private Optional<XWikiDocument> convert(String documentReference)",
          "82:     {",
          "83:         XWikiContext context = getXWikiContext();",
          "84:         try {",
          "85:             return Optional.of(",
          "86:                 context.getWiki().getDocument(this.documentReferenceResolver.resolve(documentReference), context));",
          "87:         } catch (XWikiException e) {",
          "88:             this.logger.error(\"Failed to resolve [{}]\", documentReference, e);",
          "89:             return Optional.empty();",
          "",
          "[Added Lines]",
          "69:         List<DocumentReference> selectedDocuments = selectDocuments();",
          "70:         logBeforeQueuingTasks(selectedDocuments);",
          "72:         for (DocumentReference documentReference : selectedDocuments) {",
          "73:             logBeforeQueuingTask(documentReference);",
          "74:             this.taskManager.addTask(getXWikiContext().getWikiId(), new XWikiDocument(documentReference).getId(),",
          "75:                 getTaskType());",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "109:     {",
          "110:         this.logger.info(\"[{}] documents queued to task [{}]\", documents.size(), getTaskType());",
          "111:     }",
          "",
          "[Removed Lines]",
          "101:     protected abstract List<String> selectDocuments() throws DataMigrationException;",
          "108:     protected void logBeforeQueuingTasks(List<XWikiDocument> documents)",
          "",
          "[Added Lines]",
          "90:     protected abstract List<DocumentReference> selectDocuments() throws DataMigrationException;",
          "100:     protected void logBeforeQueuingTasks(List<DocumentReference> documents)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "119:     {",
          "121:     }",
          "122: }",
          "",
          "[Removed Lines]",
          "118:     protected void logBeforeQueuingTask(XWikiDocument document)",
          "120:         this.logger.info(\"document [{}] queued to task [{}]\", document, getTaskType());",
          "",
          "[Added Lines]",
          "113:     protected void logBeforeQueuingTask(DocumentReference documentReference)",
          "114:     {",
          "115:         this.logger.info(\"document [{}] queued to task [{}]\", documentReference, getTaskType());",
          "116:     }",
          "129:     protected Optional<DocumentReference> resolveDocumentReference(String documentReference, String localeStr)",
          "130:     {",
          "131:         Optional<DocumentReference> optionalDocumentReference = parseLocale(localeStr)",
          "132:             .map(locale -> new DocumentReference(this.documentReferenceResolver.resolve(documentReference), locale));",
          "133:         if (optionalDocumentReference.isEmpty()) {",
          "134:             this.logger.warn(\"Failed to resolve document reference [{}] with locale [{}]\", documentReference,",
          "135:                 localeStr);",
          "136:         }",
          "137:         return optionalDocumentReference;",
          "138:     }",
          "147:     private Optional<Locale> parseLocale(String locale)",
          "149:         try {",
          "150:             return Optional.ofNullable(toLocale(locale));",
          "151:         } catch (IllegalArgumentException e) {",
          "152:             this.logger.debug(\"Unable to resolve locale [{}]. Cause: [{}]\", locale, getRootCauseMessage(e));",
          "153:             return Optional.empty();",
          "154:         }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: import org.xwiki.component.annotation.Component;",
          "30: import org.xwiki.internal.extension.XARExtensionIndex;",
          "31: import org.xwiki.query.QueryException;",
          "33: import com.xpn.xwiki.XWiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: import org.xwiki.model.reference.DocumentReference;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73:     }",
          "75:     @Override",
          "77:     {",
          "78:         XWiki wiki = getXWikiContext().getWiki();",
          "79:         try {",
          "",
          "[Removed Lines]",
          "76:     protected List<String> selectDocuments() throws DataMigrationException",
          "",
          "[Added Lines]",
          "77:     protected List<DocumentReference> selectDocuments() throws DataMigrationException",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "83:             return wiki.getStore().getQueryManager()",
          "85:                     + \"like '%{{info}}%services.localization.render%xe.invitation.internalDocument%{{/info}}%'\", XWQL)",
          "87:                 .stream()",
          "92:                 .collect(Collectors.toList());",
          "93:         } catch (QueryException e) {",
          "94:             throw new DataMigrationException(",
          "",
          "[Removed Lines]",
          "84:                 .createQuery(\"where doc.content \"",
          "86:                 .<String>execute()",
          "90:                 .filter(documentReference -> !this.installedXARs.isExtensionDocument(",
          "91:                     this.documentReferenceResolver.resolve(documentReference)))",
          "",
          "[Added Lines]",
          "85:                 .createQuery(\"select doc.fullName, doc.language from Document doc where doc.content \"",
          "87:                 .<Object[]>execute()",
          "89:                 .flatMap(array -> resolveDocumentReference(String.valueOf(array[0]), String.valueOf(array[1])).stream())",
          "92:                 .filter(documentReference -> !this.installedXARs.isExtensionDocument(documentReference))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5c57b1f6085f9ada9506a5ce27bcba6e4993c296",
      "candidate_info": {
        "commit_hash": "5c57b1f6085f9ada9506a5ce27bcba6e4993c296",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/5c57b1f6085f9ada9506a5ce27bcba6e4993c296",
        "files": [
          "xwiki-platform-core/pom.xml",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/resources/META-INF/components.txt",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
        ],
        "message": "XWIKI-21091: AbstractDocumentsMigration is not resolving the document references against the current wiki (#2241)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigration.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/main/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import java.util.List;",
          "",
          "[Removed Lines]",
          "20: package org.xwiki.index.migration;",
          "",
          "[Added Lines]",
          "20: package org.xwiki.index.internal.migration;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "70:     @Override",
          "71:     public XWikiDBVersion getVersion()",
          "72:     {",
          "74:     }",
          "76:     @Override",
          "",
          "[Removed Lines]",
          "73:         return new XWikiDBVersion(140900000);",
          "",
          "[Added Lines]",
          "74:         return new XWikiDBVersion(150700000);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java||xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java": [
          "File: xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/migration/R140300000XWIKI19614DataMigrationTest.java -> xwiki-platform-core/xwiki-platform-index/xwiki-platform-index-default/src/test/java/org/xwiki/index/internal/migration/R140300000XWIKI19614DataMigrationTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import java.util.List;",
          "24: import org.junit.jupiter.api.BeforeEach;",
          "25: import org.junit.jupiter.api.Test;",
          "26: import org.junit.jupiter.api.extension.RegisterExtension;",
          "",
          "[Removed Lines]",
          "20: package org.xwiki.index.migration;",
          "",
          "[Added Lines]",
          "20: package org.xwiki.index.internal.migration;",
          "24: import javax.inject.Named;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "78:     private Execution execution;",
          "80:     @MockComponent",
          "81:     private DocumentReferenceResolver<String> resolver;",
          "83:     @RegisterExtension",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:     @Named(\"current\")",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/AbstractDocumentsMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: import java.util.Optional;",
          "25: import javax.inject.Inject;",
          "27: import org.slf4j.Logger;",
          "28: import org.xwiki.index.TaskManager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26: import javax.inject.Named;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "55:     protected Logger logger;",
          "57:     @Inject",
          "58:     protected DocumentReferenceResolver<String> documentReferenceResolver;",
          "60:     @Inject",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:     @Named(\"current\")",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/org/xwiki/internal/migration/R150000000XWIKI20285DataMigration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "62:     @Override",
          "63:     public XWikiDBVersion getVersion()",
          "64:     {",
          "66:     }",
          "68:     @Override",
          "",
          "[Removed Lines]",
          "65:         return new XWikiDBVersion(150000000);",
          "",
          "[Added Lines]",
          "66:         return new XWikiDBVersion(150700000);",
          "",
          "---------------"
        ]
      }
    }
  ]
}