{
  "cve_id": "CVE-2022-23537",
  "cve_desc": "PJSIP is a free and open source multimedia communication library written in C language implementing standard based protocols such as SIP, SDP, RTP, STUN, TURN, and ICE. Buffer overread is possible when parsing a specially crafted STUN message with unknown attribute. The vulnerability affects applications that uses STUN including PJNATH and PJSUA-LIB. The patch is available as a commit in the master branch (2.13.1).",
  "repo": "pjsip/pjproject",
  "patch_hash": "d8440f4d711a654b511f50f79c0445b26f9dd1e1",
  "patch_info": {
    "commit_hash": "d8440f4d711a654b511f50f79c0445b26f9dd1e1",
    "repo": "pjsip/pjproject",
    "commit_url": "https://github.com/pjsip/pjproject/commit/d8440f4d711a654b511f50f79c0445b26f9dd1e1",
    "files": [
      "pjnath/include/pjnath/stun_msg.h",
      "pjnath/src/pjnath/stun_msg.c"
    ],
    "message": "Merge pull request from GHSA-9pfh-r8x4-w26w\n\n* Fix buffer overread in STUN message decoder\n\n* Updates based on comments",
    "before_after_code_files": [
      "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h",
      "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c"
    ]
  },
  "patch_diff": {
    "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h": [
      "File: pjnath/include/pjnath/stun_msg.h -> pjnath/include/pjnath/stun_msg.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "443:    \\endverbatim",
      "445: typedef struct pj_stun_msg_hdr",
      "446: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "445: #pragma pack(1)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "473:     pj_uint8_t          tsx_id[12];",
      "475: } pj_stun_msg_hdr;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "477: #pragma pack()",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "491:    \\endverbatim",
      "493: typedef struct pj_stun_attr_hdr",
      "494: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "495: #pragma pack(1)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "506:     pj_uint16_t         length;",
      "508: } pj_stun_attr_hdr;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "512: #pragma pack()",
      "",
      "---------------"
    ],
    "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c": [
      "File: pjnath/src/pjnath/stun_msg.c -> pjnath/src/pjnath/stun_msg.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "747: #define INIT_ATTR(a,t,l)    (a)->hdr.type=(pj_uint16_t)(t), \\",
      "748:                             (a)->hdr.length=(pj_uint16_t)(l)",
      "751: static pj_uint16_t GETVAL16H(const pj_uint8_t *buf, unsigned pos)",
      "752: {",
      "",
      "[Removed Lines]",
      "749: #define ATTR_HDR_LEN        4",
      "",
      "[Added Lines]",
      "749: #define ATTR_HDR_LEN        sizeof(pj_stun_attr_hdr)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2327:         status = pj_stun_msg_check(pdu, pdu_len, options);",
      "2328:         if (status != PJ_SUCCESS)",
      "2329:             return status;",
      "2330:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2330:     } else {",
      "2332:         pj_uint32_t msg_len = GETVAL16H(pdu, 2) + 20;",
      "2333:         if (msg_len > pdu_len ||",
      "2334:             ((options & PJ_STUN_IS_DATAGRAM) && msg_len != pdu_len))",
      "2335:         {",
      "2336:             return PJNATH_EINSTUNMSGLEN;",
      "2337:         }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2345:         p_response = NULL;",
      "2349:         unsigned attr_type, attr_val_len;",
      "2350:         const struct attr_desc *adesc;",
      "",
      "[Removed Lines]",
      "2348:     while (pdu_len >= 4) {",
      "",
      "[Added Lines]",
      "2356:     while (pdu_len >= ATTR_HDR_LEN) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2357:         attr_val_len = (attr_val_len + 3) & (~3);",
      "2361:             pj_str_t err_msg;",
      "2362:             char err_msg_buf[80];",
      "",
      "[Removed Lines]",
      "2360:         if (pdu_len < attr_val_len) {",
      "",
      "[Added Lines]",
      "2368:         if (pdu_len < attr_val_len + ATTR_HDR_LEN) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "563f34c0974bd845c1cf48a76b63453bb5be013b",
      "candidate_info": {
        "commit_hash": "563f34c0974bd845c1cf48a76b63453bb5be013b",
        "repo": "pjsip/pjproject",
        "commit_url": "https://github.com/pjsip/pjproject/commit/563f34c0974bd845c1cf48a76b63453bb5be013b",
        "files": [
          "pjnath/include/pjnath/stun_msg.h",
          "pjnath/src/pjnath/stun_msg.c"
        ],
        "message": "Merge pull request from GHSA-9pfh-r8x4-w26w\n\n* Fix buffer overread in STUN message decoder\n\n* Updates based on comments",
        "before_after_code_files": [
          "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h",
          "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h",
            "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c"
          ],
          "candidate": [
            "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h",
            "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c"
          ]
        }
      },
      "candidate_diff": {
        "pjnath/include/pjnath/stun_msg.h||pjnath/include/pjnath/stun_msg.h": [
          "File: pjnath/include/pjnath/stun_msg.h -> pjnath/include/pjnath/stun_msg.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "443:    \\endverbatim",
          "445: typedef struct pj_stun_msg_hdr",
          "446: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "445: #pragma pack(1)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "473:     pj_uint8_t          tsx_id[12];",
          "475: } pj_stun_msg_hdr;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "477: #pragma pack()",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "491:    \\endverbatim",
          "493: typedef struct pj_stun_attr_hdr",
          "494: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "495: #pragma pack(1)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "506:     pj_uint16_t         length;",
          "508: } pj_stun_attr_hdr;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "512: #pragma pack()",
          "",
          "---------------"
        ],
        "pjnath/src/pjnath/stun_msg.c||pjnath/src/pjnath/stun_msg.c": [
          "File: pjnath/src/pjnath/stun_msg.c -> pjnath/src/pjnath/stun_msg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "747: #define INIT_ATTR(a,t,l)    (a)->hdr.type=(pj_uint16_t)(t), \\",
          "748:                             (a)->hdr.length=(pj_uint16_t)(l)",
          "751: static pj_uint16_t GETVAL16H(const pj_uint8_t *buf, unsigned pos)",
          "752: {",
          "",
          "[Removed Lines]",
          "749: #define ATTR_HDR_LEN        4",
          "",
          "[Added Lines]",
          "749: #define ATTR_HDR_LEN        sizeof(pj_stun_attr_hdr)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2327:         status = pj_stun_msg_check(pdu, pdu_len, options);",
          "2328:         if (status != PJ_SUCCESS)",
          "2329:             return status;",
          "2330:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2330:     } else {",
          "2332:         pj_uint32_t msg_len = GETVAL16H(pdu, 2) + 20;",
          "2333:         if (msg_len > pdu_len ||",
          "2334:             ((options & PJ_STUN_IS_DATAGRAM) && msg_len != pdu_len))",
          "2335:         {",
          "2336:             return PJNATH_EINSTUNMSGLEN;",
          "2337:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2345:         p_response = NULL;",
          "2349:         unsigned attr_type, attr_val_len;",
          "2350:         const struct attr_desc *adesc;",
          "",
          "[Removed Lines]",
          "2348:     while (pdu_len >= 4) {",
          "",
          "[Added Lines]",
          "2356:     while (pdu_len >= ATTR_HDR_LEN) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2357:         attr_val_len = (attr_val_len + 3) & (~3);",
          "2361:             pj_str_t err_msg;",
          "2362:             char err_msg_buf[80];",
          "",
          "[Removed Lines]",
          "2360:         if (pdu_len < attr_val_len) {",
          "",
          "[Added Lines]",
          "2368:         if (pdu_len < attr_val_len + ATTR_HDR_LEN) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}