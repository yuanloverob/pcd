{
  "cve_id": "CVE-2022-2065",
  "cve_desc": "Cross-site Scripting (XSS) - Stored in GitHub repository neorazorx/facturascripts prior to 2022.06.",
  "repo": "neorazorx/facturascripts",
  "patch_hash": "1d1edb40b40016d7fd2893b410b98569d7facca1",
  "patch_info": {
    "commit_hash": "1d1edb40b40016d7fd2893b410b98569d7facca1",
    "repo": "neorazorx/facturascripts",
    "commit_url": "https://github.com/neorazorx/facturascripts/commit/1d1edb40b40016d7fd2893b410b98569d7facca1",
    "files": [
      "Core/App/AppRouter.php"
    ],
    "message": "Force to download SVG files to prevent security problems. ------ Forzamos a descargar los archivos SVG para evitar problemas de seguridad.",
    "before_after_code_files": [
      "Core/App/AppRouter.php||Core/App/AppRouter.php"
    ]
  },
  "patch_diff": {
    "Core/App/AppRouter.php||Core/App/AppRouter.php": [
      "File: Core/App/AppRouter.php -> Core/App/AppRouter.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "127:         $allowedFolders = ['node_modules', 'vendor', 'Dinamic', 'Core', 'Plugins', 'MyFiles/Public'];",
      "128:         foreach ($allowedFolders as $folder) {",
      "129:             if ('/' . $folder === substr($uri, 0, 1 + strlen($folder))) {",
      "132:                 return true;",
      "133:             }",
      "134:         }",
      "",
      "[Removed Lines]",
      "130:                 header('Content-Type: ' . $this->getMime($filePath));",
      "131:                 readfile($filePath);",
      "",
      "[Added Lines]",
      "130:                 $this->download($filePath);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "137:         $token = filter_input(INPUT_GET, 'myft');",
      "138:         $fixedFilePath = substr(urldecode($uri), 1);",
      "139:         if ('/MyFiles/' === substr($uri, 0, 9) && $token && MyFilesToken::validate($fixedFilePath, $token)) {",
      "148:             return true;",
      "149:         }",
      "",
      "[Removed Lines]",
      "140:             header('Content-Type: ' . $this->getMime($filePath));",
      "143:             if (ob_get_contents()) {",
      "144:                 ob_end_flush();",
      "145:             }",
      "147:             readfile($filePath);",
      "",
      "[Added Lines]",
      "139:             $this->download($filePath);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "205:         }",
      "206:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "200:     private function download(string $filePath)",
      "201:     {",
      "202:         header('Content-Type: ' . $this->getMime($filePath));",
      "205:         if (ob_get_contents()) {",
      "206:             ob_end_flush();",
      "207:         }",
      "210:         if (strpos($filePath, '.svg') !== false) {",
      "211:             header('Content-Disposition: attachment; filename=\"' . basename($filePath) . '\"');",
      "212:         }",
      "214:         readfile($filePath);",
      "215:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f1ca50d021f52c4560d120bbbe7ff2a5321e38fb",
      "candidate_info": {
        "commit_hash": "f1ca50d021f52c4560d120bbbe7ff2a5321e38fb",
        "repo": "neorazorx/facturascripts",
        "commit_url": "https://github.com/neorazorx/facturascripts/commit/f1ca50d021f52c4560d120bbbe7ff2a5321e38fb",
        "files": [
          "Core/App/AppRouter.php"
        ],
        "message": "Force to download xml and xsig files to prevent XSS attacks. ------ Forzamos la descarga de archivos xml y xsig para evitar ataques XSS.",
        "before_after_code_files": [
          "Core/App/AppRouter.php||Core/App/AppRouter.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "Core/App/AppRouter.php||Core/App/AppRouter.php"
          ],
          "candidate": [
            "Core/App/AppRouter.php||Core/App/AppRouter.php"
          ]
        }
      },
      "candidate_diff": {
        "Core/App/AppRouter.php||Core/App/AppRouter.php": [
          "File: Core/App/AppRouter.php -> Core/App/AppRouter.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "206:             ob_end_flush();",
          "207:         }",
          "211:             header('Content-Disposition: attachment; filename=\"' . basename($filePath) . '\"');",
          "212:         }",
          "",
          "[Removed Lines]",
          "210:         if (strpos($filePath, '.svg') !== false) {",
          "",
          "[Added Lines]",
          "210:         $info = pathinfo($filePath);",
          "211:         $extension = strtolower($info['extension']);",
          "212:         if (in_array($extension, ['svg', 'xml', 'xsig'])) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}