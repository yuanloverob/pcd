{
  "cve_id": "CVE-2023-45134",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. `org.xwiki.platform:xwiki-platform-web` starting in version 3.1-milestone-1 and prior to 13.4-rc-1, `org.xwiki.platform:xwiki-platform-web-templates` prior to versions 14.10.2 and 15.5-rc-1, and `org.xwiki.platform:xwiki-web-standard` starting in version 2.4-milestone-2 and prior to version 3.1-milestone-1 are vulnerable to cross-site scripting. An attacker can create a template provider on any document that is part of the wiki (could be the attacker's user profile) that contains malicious code. This code is executed when this template provider is selected during document creation which can be triggered by sending the user to a URL. For the attacker, the only requirement is to have an account as by default the own user profile is editable. This allows an attacker to execute arbitrary actions with the rights of the user opening the malicious link. Depending on the rights of the user, this may allow remote code execution and full read and write access to the whole XWiki installation. This has been patched in `org.xwiki.platform:xwiki-platform-web` 13.4-rc-1, `org.xwiki.platform:xwiki-platform-web-templates` 14.10.2 and 15.5-rc-1, and `org.xwiki.platform:xwiki-web-standard` 3.1-milestone-1 by adding the appropriate escaping. The vulnerable template file createinline.vm is part of XWiki's WAR and can be patched by manually applying the changes from the fix.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "ba56fda175156dd35035f2b8c86cbd8ef1f90c2e",
  "patch_info": {
    "commit_hash": "ba56fda175156dd35035f2b8c86cbd8ef1f90c2e",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/ba56fda175156dd35035f2b8c86cbd8ef1f90c2e",
    "files": [
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
    ],
    "message": "XWIKI-20962: Escape template provider errors during document creation\n\n* Add escaping and a test",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
      "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
      "--- Hunk 1 ---",
      "[Context before]",
      "68:   <div class=\"box errormessage\">",
      "69:     #set($allowedSpaces = $createAllowedSpaces)",
      "70:     #if ($allowedSpaces.size() == 1)",
      "72:     #else",
      "74:     #end",
      "75:   </div>",
      "76: #end",
      "",
      "[Removed Lines]",
      "71:       $services.localization.render('core.create.template.allowedspace.inline', [$templateProvider, $allowedSpaces.get(0)])",
      "73:       $services.localization.render('core.create.template.allowedspaces.inline', [$templateProvider, $allowedSpaces.toString()])",
      "",
      "[Added Lines]",
      "71:       $escapetool.xml($services.localization.render('core.create.template.allowedspace.inline', [$templateProvider,",
      "72:         $allowedSpaces.get(0)]))",
      "74:       $escapetool.xml($services.localization.render('core.create.template.allowedspaces.inline', [$templateProvider,",
      "75:         $allowedSpaces.toString()]))",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: package org.xwiki.web;",
      "22: import java.util.List;",
      "24: import javax.inject.Inject;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "23: import java.util.stream.Stream;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "28: import org.jsoup.nodes.Element;",
      "29: import org.junit.jupiter.api.BeforeEach;",
      "30: import org.junit.jupiter.api.Test;",
      "31: import org.xwiki.template.TemplateManager;",
      "32: import org.xwiki.test.page.PageTest;",
      "33: import org.xwiki.velocity.VelocityManager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "32: import org.junit.jupiter.params.ParameterizedTest;",
      "33: import org.junit.jupiter.params.provider.MethodSource;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "118:             DOCUMENT_REFERENCE, viewURL, editURL);",
      "119:         assertEquals(expectedMessage, errormessage.text());",
      "120:     }",
      "121: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "129:     @ParameterizedTest",
      "130:     @MethodSource(\"allowedSpacesProvider\")",
      "131:     void templateProviderRestrictionErrorEscaping(List<String> allowedSpaces) throws Exception",
      "132:     {",
      "133:         String provider = \"\\\"provider</div>\";",
      "134:         this.request.put(\"templateprovider\", provider);",
      "135:         String template = \"template</div>\";",
      "138:         Object[] args = { template, DOCUMENT_REFERENCE, DOCUMENT_REFERENCE };",
      "139:         XWikiException exception = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
      "140:             XWikiException.ERROR_XWIKI_APP_TEMPLATE_NOT_AVAILABLE,",
      "141:             \"Template {0} cannot be used in space {1} when creating page {2}\", null, args);",
      "142:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, exception);",
      "144:         this.velocityManager.getVelocityContext().put(\"createAllowedSpaces\", allowedSpaces);",
      "147:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
      "148:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
      "149:         assertNotNull(errormessage);",
      "151:         String expectedMessage;",
      "152:         if (allowedSpaces.size() == 1) {",
      "153:             expectedMessage = String.format(\"core.create.template.allowedspace.inline [%s, %s]\",",
      "154:                 provider, allowedSpaces.get(0));",
      "155:         } else {",
      "156:             expectedMessage = String.format(\"core.create.template.allowedspaces.inline [%s, %s]\",",
      "157:                 provider, allowedSpaces);",
      "158:         }",
      "159:         assertEquals(expectedMessage, errormessage.text());",
      "160:     }",
      "162:     static Stream<List<String>> allowedSpacesProvider()",
      "163:     {",
      "164:         return Stream.of(",
      "165:             List.of(\"allowedSpace</div>\"),",
      "166:             List.of(\"allowedSpace1</div>\", \"allowedSpace2</div>\")",
      "167:         );",
      "168:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9211cec584547e8ed8b2f505ff0a65cffa3a528d",
      "candidate_info": {
        "commit_hash": "9211cec584547e8ed8b2f505ff0a65cffa3a528d",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/9211cec584547e8ed8b2f505ff0a65cffa3a528d",
        "files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ],
        "message": "XWIKI-20962: Escape template provider errors during document creation\n\n* Add escaping and a test\n\n(cherry picked from commit ba56fda175156dd35035f2b8c86cbd8ef1f90c2e)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
            "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/main/resources/templates/createinline.vm",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:   <div class=\"box errormessage\">",
          "69:     #set($allowedSpaces = $createAllowedSpaces)",
          "70:     #if ($allowedSpaces.size() == 1)",
          "72:     #else",
          "74:     #end",
          "75:   </div>",
          "76: #end",
          "",
          "[Removed Lines]",
          "71:       $services.localization.render('core.create.template.allowedspace.inline', [$templateProvider, $allowedSpaces.get(0)])",
          "73:       $services.localization.render('core.create.template.allowedspaces.inline', [$templateProvider, $allowedSpaces.toString()])",
          "",
          "[Added Lines]",
          "71:       $escapetool.xml($services.localization.render('core.create.template.allowedspace.inline', [$templateProvider,",
          "72:         $allowedSpaces.get(0)]))",
          "74:       $escapetool.xml($services.localization.render('core.create.template.allowedspaces.inline', [$templateProvider,",
          "75:         $allowedSpaces.toString()]))",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java||xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java -> xwiki-platform-core/xwiki-platform-web/xwiki-platform-web-templates/src/test/java/org/xwiki/web/CreateInlinePageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.web;",
          "22: import java.util.List;",
          "24: import javax.inject.Inject;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "23: import java.util.stream.Stream;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "28: import org.jsoup.nodes.Element;",
          "29: import org.junit.jupiter.api.BeforeEach;",
          "30: import org.junit.jupiter.api.Test;",
          "31: import org.xwiki.template.TemplateManager;",
          "32: import org.xwiki.test.page.PageTest;",
          "33: import org.xwiki.velocity.VelocityManager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "32: import org.junit.jupiter.params.ParameterizedTest;",
          "33: import org.junit.jupiter.params.provider.MethodSource;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "118:             DOCUMENT_REFERENCE, viewURL, editURL);",
          "119:         assertEquals(expectedMessage, errormessage.text());",
          "120:     }",
          "121: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "129:     @ParameterizedTest",
          "130:     @MethodSource(\"allowedSpacesProvider\")",
          "131:     void templateProviderRestrictionErrorEscaping(List<String> allowedSpaces) throws Exception",
          "132:     {",
          "133:         String provider = \"\\\"provider</div>\";",
          "134:         this.request.put(\"templateprovider\", provider);",
          "135:         String template = \"template</div>\";",
          "138:         Object[] args = { template, DOCUMENT_REFERENCE, DOCUMENT_REFERENCE };",
          "139:         XWikiException exception = new XWikiException(XWikiException.MODULE_XWIKI_STORE,",
          "140:             XWikiException.ERROR_XWIKI_APP_TEMPLATE_NOT_AVAILABLE,",
          "141:             \"Template {0} cannot be used in space {1} when creating page {2}\", null, args);",
          "142:         this.velocityManager.getVelocityContext().put(CREATE_EXCEPTION_VELOCITY_KEY, exception);",
          "144:         this.velocityManager.getVelocityContext().put(\"createAllowedSpaces\", allowedSpaces);",
          "147:         Document document = Jsoup.parse(this.templateManager.render(CREATE_INLINE_VM));",
          "148:         Element errormessage = document.getElementsByClass(ERROR_MESSAGE_CLASS).first();",
          "149:         assertNotNull(errormessage);",
          "151:         String expectedMessage;",
          "152:         if (allowedSpaces.size() == 1) {",
          "153:             expectedMessage = String.format(\"core.create.template.allowedspace.inline [%s, %s]\",",
          "154:                 provider, allowedSpaces.get(0));",
          "155:         } else {",
          "156:             expectedMessage = String.format(\"core.create.template.allowedspaces.inline [%s, %s]\",",
          "157:                 provider, allowedSpaces);",
          "158:         }",
          "159:         assertEquals(expectedMessage, errormessage.text());",
          "160:     }",
          "162:     static Stream<List<String>> allowedSpacesProvider()",
          "163:     {",
          "164:         return Stream.of(",
          "165:             List.of(\"allowedSpace</div>\"),",
          "166:             List.of(\"allowedSpace1</div>\", \"allowedSpace2</div>\")",
          "167:         );",
          "168:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}