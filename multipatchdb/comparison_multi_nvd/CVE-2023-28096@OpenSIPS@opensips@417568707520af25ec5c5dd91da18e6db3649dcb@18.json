{
  "cve_id": "CVE-2023-28096",
  "cve_desc": "OpenSIPS, a Session Initiation Protocol (SIP) server implementation, has a memory leak starting in the 2.3 branch and priot to versions 3.1.8 and 3.2.5. The memory leak was detected in the function `parse_mi_request` while performing coverage-guided fuzzing. This issue can be reproduced by sending multiple requests of the form `{\"jsonrpc\": \"2.0\",\"method\": \"log_le`. This malformed message was tested against an instance of OpenSIPS via FIFO transport layer and was found to increase the memory consumption over time.\n\nTo abuse this memory leak, attackers need to reach the management interface (MI) which typically should only be exposed on trusted interfaces. In cases where the MI is exposed to the internet without authentication, abuse of this issue will lead to memory exhaustion which may affect the underlying system\u2019s availability. No authentication is typically required to reproduce this issue. On the other hand, memory leaks may occur in other areas of OpenSIPS where the cJSON library is used for parsing JSON objects.\n\nThe issue has been fixed in versions 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
  "patch_info": {
    "commit_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/417568707520af25ec5c5dd91da18e6db3649dcb",
    "files": [
      "lib/cJSON.c"
    ],
    "message": "cJSON: fix memory leak on object parsing error\n\nIssue discovered during OpenSIPS Security Audit 2021/2022,\nby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-2mg2-g46r-j4qr",
    "before_after_code_files": [
      "lib/cJSON.c||lib/cJSON.c"
    ]
  },
  "patch_diff": {
    "lib/cJSON.c||lib/cJSON.c": [
      "File: lib/cJSON.c -> lib/cJSON.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1483: fail:",
      "1484:     if (item->child != NULL)",
      "1485:     {",
      "1487:         item->child = NULL;",
      "1488:     }",
      "",
      "[Removed Lines]",
      "1486:         cJSON_Delete(child);",
      "",
      "[Added Lines]",
      "1486:         cJSON_Delete(item->child);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0cca86fe789d77ea3e2b58326d6f282eb3433544",
      "candidate_info": {
        "commit_hash": "0cca86fe789d77ea3e2b58326d6f282eb3433544",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/0cca86fe789d77ea3e2b58326d6f282eb3433544",
        "files": [
          "modules/presence_dialoginfo/notify_body.c"
        ],
        "message": "[presence_dialoginfo] Fix aggregating dialoginfo XML\n\nFix the looping when aggregating the dialog info XML documents with multiple dialog elements. The xmlUnlinkNode() function inside the loop is breaking the looping (the \"next\" member is reset).\nCredits for reporting and fixing go to Damien Sandras (@dsandras)",
        "before_after_code_files": [
          "modules/presence_dialoginfo/notify_body.c||modules/presence_dialoginfo/notify_body.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/presence_dialoginfo/notify_body.c||modules/presence_dialoginfo/notify_body.c": [
          "File: modules/presence_dialoginfo/notify_body.c -> modules/presence_dialoginfo/notify_body.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "109: str* agregate_xmls(str* pres_user, str* pres_domain, str** body_array, int n, int partial)",
          "110: {",
          "111:  int i, j= 0;",
          "113:  xmlDocPtr  doc = NULL;",
          "114:  xmlNodePtr root_node = NULL;",
          "115:  xmlNsPtr   namespace = NULL;",
          "117:  xmlNodePtr p_root= NULL;",
          "118:  xmlDocPtr* xml_array ;",
          "119:  xmlNodePtr node = NULL;",
          "120:  char *state;",
          "121:  int winner_priority = -1, priority ;",
          "122:  xmlNodePtr winner_dialog_node = NULL ;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "118:  xmlNodePtr next_node = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "211:     goto error;",
          "212:    }",
          "213:    if (p_root->children) {",
          "215:     if (node->type == XML_ELEMENT_NODE) {",
          "216:      LM_DBG(\"node type: Element, name: %s\\n\", node->name);",
          "",
          "[Removed Lines]",
          "214:    for (node = p_root->children; node; node = node->next) {",
          "",
          "[Added Lines]",
          "213:    for (node = p_root->children; node; node = next_node) {",
          "214:     next_node = node->next;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e2fd673d9c2ce818c9172f017ee41e3962c8ec20",
      "candidate_info": {
        "commit_hash": "e2fd673d9c2ce818c9172f017ee41e3962c8ec20",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/e2fd673d9c2ce818c9172f017ee41e3962c8ec20",
        "files": [
          "Makefile.defs",
          "packaging/debian/changelog",
          "packaging/freebsd/Makefile",
          "packaging/netbsd/Makefile",
          "packaging/openbsd/Makefile",
          "packaging/redhat_fedora/opensips.spec",
          "packaging/solaris/base-pkginfo",
          "packaging/solaris/berkeley-pkginfo",
          "packaging/solaris/carrierroute-pkginfo",
          "packaging/solaris/identity-pkginfo",
          "packaging/solaris/ldap-pkginfo",
          "packaging/solaris/mmgeoip-pkginfo",
          "packaging/solaris/mysql-pkginfo",
          "packaging/solaris/perl-pkginfo",
          "packaging/solaris/pgsql-pkginfo",
          "packaging/solaris/pkginfo",
          "packaging/solaris/regex-pkginfo",
          "packaging/solaris/snmp-pkginfo",
          "packaging/solaris/tls-pkginfo",
          "packaging/solaris/xmlrpc-pkginfo"
        ],
        "message": "Bump version to 3.2.9",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs",
          "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "66: #version number",
          "67: VERSION_MAJOR = 3",
          "68: VERSION_MINOR = 2",
          "70: VERSION_BUILD =",
          "72: ifneq (,$(VERSION_BUILD))",
          "",
          "[Removed Lines]",
          "69: VERSION_SUBMINOR = 8",
          "",
          "[Added Lines]",
          "69: VERSION_SUBMINOR = 9",
          "",
          "---------------"
        ],
        "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec": [
          "File: packaging/redhat_fedora/opensips.spec -> packaging/redhat_fedora/opensips.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: Summary:  Very fast and configurable SIP server",
          "47: Name:     opensips",
          "49: Release:  1%{?dist}",
          "50: License:  GPLv2+",
          "51: Group:    System Environment/Daemons",
          "",
          "[Removed Lines]",
          "48: Version:  3.2.8",
          "",
          "[Added Lines]",
          "48: Version:  3.2.9",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "819f7c62e659f831843094d7e47b6eaec0311faf",
      "candidate_info": {
        "commit_hash": "819f7c62e659f831843094d7e47b6eaec0311faf",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/819f7c62e659f831843094d7e47b6eaec0311faf",
        "files": [
          "mem/mem.h"
        ],
        "message": "mem.h: Avoid warnings when explicitly defining -DSYSTEM_MALLOC\n\n(cherry picked from commit a11f9c74064bd5ec79445e7042d85f151672d038)",
        "before_after_code_files": [
          "mem/mem.h||mem/mem.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "mem/mem.h||mem/mem.h": [
          "File: mem/mem.h -> mem/mem.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "185: void *sys_realloc(void *, unsigned long, const char *, const char *, unsigned int);",
          "186: void sys_free(void *, const char *, const char *, unsigned int);",
          "188: #define SYSTEM_MALLOC",
          "189: #define pkg_malloc_func sys_malloc",
          "190: #define pkg_malloc(s) sys_malloc((s), __FILE__, __FUNCTION__, __LINE__)",
          "191: #define func_pkg_relloc sys_realloc",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "188: #ifndef SYSTEM_MALLOC",
          "190: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1e9652c59aec6d461289e7806e97afd92c325306",
      "candidate_info": {
        "commit_hash": "1e9652c59aec6d461289e7806e97afd92c325306",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/1e9652c59aec6d461289e7806e97afd92c325306",
        "files": [
          "modules/tm/t_fwd.c",
          "modules/tm/t_fwd.h",
          "modules/tm/tm.c"
        ],
        "message": "[tm] fix t_wait_no_more_branches() behaviour\n\nFixes #2891\nAlternative to  #2898\nCredits for the fix go to @man1207\n\n(cherry picked from commit 14d900f2a7bb05609290de71876590703678612f)",
        "before_after_code_files": [
          "modules/tm/t_fwd.c||modules/tm/t_fwd.c",
          "modules/tm/t_fwd.h||modules/tm/t_fwd.h",
          "modules/tm/tm.c||modules/tm/tm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/tm/t_fwd.c||modules/tm/t_fwd.c": [
          "File: modules/tm/t_fwd.c -> modules/tm/t_fwd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1015: }",
          "1019: {",
          "1020:  int b;",
          "1027:  for ( b=t->nr_of_outgoings-1; b>=t->first_branch ; b-- ) {",
          "1028:   if (t->uac[b].flags & T_UAC_IS_PHONY) {",
          "1030:    return 0;",
          "1031:   }",
          "1032:  }",
          "",
          "[Removed Lines]",
          "1018: int t_wait_no_more_branches( struct cell *t)",
          "1029:    t->uac[b].br_flags=t->nr_of_outgoings+1;",
          "",
          "[Added Lines]",
          "1018: int t_wait_no_more_branches( struct cell *t, int extra)",
          "1029:    t->uac[b].br_flags=t->nr_of_outgoings+extra;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1089:  }",
          "1091:  if (flags&TM_INJECT_FLAG_LAST)",
          "1095:  rc = t_forward_nonack( t, &faked_req , NULL, 0, 1/*locked*/ );",
          "",
          "[Removed Lines]",
          "1092:   t_wait_no_more_branches(t);",
          "",
          "[Added Lines]",
          "1092:   t_wait_no_more_branches(t, 1/*the branch we will create*/);",
          "",
          "---------------"
        ],
        "modules/tm/t_fwd.h||modules/tm/t_fwd.h": [
          "File: modules/tm/t_fwd.h -> modules/tm/t_fwd.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: int t_inject_branch( struct cell *t, struct sip_msg *msg, int flags);",
          "71: void get_cancel_reason(struct sip_msg *msg, int flags, str *reason);",
          "",
          "[Removed Lines]",
          "69: int t_wait_no_more_branches( struct cell *t);",
          "",
          "[Added Lines]",
          "69: int t_wait_no_more_branches( struct cell *t, int extra);",
          "",
          "---------------"
        ],
        "modules/tm/tm.c||modules/tm/tm.c": [
          "File: modules/tm/tm.c -> modules/tm/tm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1590:   return -1;",
          "1591:  }",
          "1594:   return -1;",
          "1596:  return 1;",
          "",
          "[Removed Lines]",
          "1593:  if (t_wait_no_more_branches(t)<0)",
          "",
          "[Added Lines]",
          "1593:  if (t_wait_no_more_branches(t, 0)<0)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
      "candidate_info": {
        "commit_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "files": [
          "Makefile.defs"
        ],
        "message": "Explicitly add fPIC and DPIC for gcc\n\nThis addresses linking on Fedora 34 and later with gcc 11:\n\n```\ngcc -shared -Wl,-z,relro -Wl,--as-needed  -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld  -Wl,-O2 -Wl,-E   alarm_checks.o hashTable.o interprocess_buffer.o openserMIBNotifications.o openserObjects.o openserSIPCommonObjects.o openserSIPContactTable.o openserSIPMethodSupportedTable.o openserSIPPortTable.o openserSIPRegUserLookupTable.o openserSIPRegUserTable.o openserSIPServerObjects.o openserSIPStatusCodesTable.o snmpstats.o sub_agent.o utilities.o  -L/usr/lib64 -lnetsnmpmibs -lnetsnmpagent -lnetsnmp -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lsensors -ldl -lm -lrpm -lrpmio -Wl,--enable-new-dtags -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lssl -lssl -lcrypto  -o snmpstats.so\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: warning: relocation against `event_shm_threshold' in read-only section `.text'\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: relocation R_X86_64_PC32 against undefined symbol `ctime_buf' can not be used when making a shared object; recompile with -fPIC\n/usr/bin/ld: final link failed: bad value\ncollect2: error: ld returned 1 exit status\nmake[1]: Leaving directory '/builddir/build/BUILD/opensips-3.1.7/modules/snmpstats'\nmake[1]: *** [../../Makefile.rules:39: snmpstats.so] Error 1\nmake: *** [Makefile:197: modules] Error 2\n```\n\nCloses #2734.\n\nSigned-off-by: Peter Lemenkov <lemenkov@gmail.com>\n(cherry picked from commit 0896f9a46700005a304a65ddf7e09419a3963b82)",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1340: else",
          "1341:   #gcc and maybe others, => gnu ld",
          "1342:   LDFLAGS+=-Wl,-O2 -Wl,-E $(PROFILE)",
          "1344: endif",
          "1345: endif",
          "1346: ifeq    ($(CC_NAME), clang)",
          "",
          "[Removed Lines]",
          "1343:   MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1343:   MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1372: else",
          "1373:    #gnu or other ld type",
          "1374:    LDFLAGS+=-Wl,-E $(PROFILE)",
          "1376: endif",
          "1377: endif",
          "1378: ifeq ($(CC_NAME), icc)",
          "",
          "[Removed Lines]",
          "1375:    MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1375:    MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------"
        ]
      }
    }
  ]
}