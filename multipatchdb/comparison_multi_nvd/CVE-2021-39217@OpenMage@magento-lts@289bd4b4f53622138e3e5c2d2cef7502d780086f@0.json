{
  "cve_id": "CVE-2021-39217",
  "cve_desc": "OpenMage LTS is an e-commerce platform. Prior to versions 19.4.22 and 20.0.19, Custom Layout enabled admin users to execute arbitrary commands via block methods. Versions 19.4.22 and 20.0.19 contain patches for this issue.",
  "repo": "OpenMage/magento-lts",
  "patch_hash": "289bd4b4f53622138e3e5c2d2cef7502d780086f",
  "patch_info": {
    "commit_hash": "289bd4b4f53622138e3e5c2d2cef7502d780086f",
    "repo": "OpenMage/magento-lts",
    "commit_url": "https://github.com/OpenMage/magento-lts/commit/289bd4b4f53622138e3e5c2d2cef7502d780086f",
    "files": [
      "app/code/core/Mage/Core/Helper/Security.php",
      "dev/tests/unit/Mage/Core/Helper/Security.php"
    ],
    "message": "Merge pull request from GHSA-c9q3-r4rv-mjm7\n\nCo-authored-by: Fabrizio Balliano <fabrizio.balliano@gmail.com>",
    "before_after_code_files": [
      "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
      "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
    ]
  },
  "patch_diff": {
    "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php": [
      "File: app/code/core/Mage/Core/Helper/Security.php -> app/code/core/Mage/Core/Helper/Security.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "43:     {",
      "44:         foreach ($this->invalidBlockActions as $action) {",
      "45:             $calledMethod = strtolower($method);",
      "50:                 Mage::throwException(",
      "51:                     sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)",
      "52:                 );",
      "",
      "[Removed Lines]",
      "46:             if (($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod)",
      "47:                 || ($block instanceof $action['block']",
      "48:                     && strtolower($action['block'] . '::' . $action['method']) === $calledMethod)",
      "49:             ) {",
      "",
      "[Added Lines]",
      "46:             if (str_contains($calledMethod, '::')) {",
      "47:                 $calledMethod = explode('::', $calledMethod)[1];",
      "48:             }",
      "49:             if ($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod) {",
      "",
      "---------------"
    ],
    "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php": [
      "File: dev/tests/unit/Mage/Core/Helper/Security.php -> dev/tests/unit/Mage/Core/Helper/Security.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "65:                 'Mage_Core_Block_Template::fetchView',",
      "66:                 []",
      "67:             ],",
      "68:             'parent class name is passed as second arg' => [",
      "69:                 $topmenu,",
      "70:                 'Mage_Core_Block_Template::fetchView',",
      "71:                 []",
      "72:             ],",
      "73:         ];",
      "74:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "68:             [",
      "69:                 $topmenu,",
      "70:                 'Mage_Page_Block_Html_Topmenu_Renderer::fetchView',",
      "71:                 []",
      "72:             ],",
      "78:             'parent class name is passed as second arg2' => [",
      "79:                 $topmenu,",
      "80:                 'Mage_Core_Block_Template::render',",
      "81:                 []",
      "82:             ],",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a0afd3ba4b8b2d4532b73bb9df2541bb034b8a32",
      "candidate_info": {
        "commit_hash": "a0afd3ba4b8b2d4532b73bb9df2541bb034b8a32",
        "repo": "OpenMage/magento-lts",
        "commit_url": "https://github.com/OpenMage/magento-lts/commit/a0afd3ba4b8b2d4532b73bb9df2541bb034b8a32",
        "files": [
          "app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php"
        ],
        "message": "Merge pull request from GHSA-c9q3-r4rv-mjm7\n\nCo-authored-by: Fabrizio Balliano <fabrizio.balliano@gmail.com>",
        "before_after_code_files": [
          "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ],
          "candidate": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ]
        }
      },
      "candidate_diff": {
        "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php": [
          "File: app/code/core/Mage/Core/Helper/Security.php -> app/code/core/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     {",
          "44:         foreach ($this->invalidBlockActions as $action) {",
          "45:             $calledMethod = strtolower($method);",
          "50:                 Mage::throwException(",
          "51:                     sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)",
          "52:                 );",
          "",
          "[Removed Lines]",
          "46:             if (($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod)",
          "47:                 || ($block instanceof $action['block']",
          "48:                     && strtolower($action['block'] . '::' . $action['method']) === $calledMethod)",
          "49:             ) {",
          "",
          "[Added Lines]",
          "46:             if (str_contains($calledMethod, '::')) {",
          "47:                 $calledMethod = explode('::', $calledMethod)[1];",
          "48:             }",
          "49:             if ($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod) {",
          "",
          "---------------"
        ],
        "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php": [
          "File: dev/tests/unit/Mage/Core/Helper/Security.php -> dev/tests/unit/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:                 'Mage_Core_Block_Template::fetchView',",
          "66:                 []",
          "67:             ],",
          "68:             'parent class name is passed as second arg' => [",
          "69:                 $topmenu,",
          "70:                 'Mage_Core_Block_Template::fetchView',",
          "71:                 []",
          "72:             ],",
          "73:         ];",
          "74:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:             [",
          "69:                 $topmenu,",
          "70:                 'Mage_Page_Block_Html_Topmenu_Renderer::fetchView',",
          "71:                 []",
          "72:             ],",
          "78:             'parent class name is passed as second arg2' => [",
          "79:                 $topmenu,",
          "80:                 'Mage_Core_Block_Template::render',",
          "81:                 []",
          "82:             ],",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "177162a03ff90122f428bcbc52728769c6c226a4",
      "candidate_info": {
        "commit_hash": "177162a03ff90122f428bcbc52728769c6c226a4",
        "repo": "OpenMage/magento-lts",
        "commit_url": "https://github.com/OpenMage/magento-lts/commit/177162a03ff90122f428bcbc52728769c6c226a4",
        "files": [
          "app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php"
        ],
        "message": "Merge pull request from GHSA-c9q3-r4rv-mjm7\n\nCo-authored-by: Fabrizio Balliano <fabrizio.balliano@gmail.com>",
        "before_after_code_files": [
          "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ],
          "candidate": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ]
        }
      },
      "candidate_diff": {
        "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php": [
          "File: app/code/core/Mage/Core/Helper/Security.php -> app/code/core/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     {",
          "44:         foreach ($this->invalidBlockActions as $action) {",
          "45:             $calledMethod = strtolower($method);",
          "50:                 Mage::throwException(",
          "51:                     sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)",
          "52:                 );",
          "",
          "[Removed Lines]",
          "46:             if (($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod)",
          "47:                 || ($block instanceof $action['block']",
          "48:                     && strtolower($action['block'] . '::' . $action['method']) === $calledMethod)",
          "49:             ) {",
          "",
          "[Added Lines]",
          "46:             if (str_contains($calledMethod, '::')) {",
          "47:                 $calledMethod = explode('::', $calledMethod)[1];",
          "48:             }",
          "49:             if ($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod) {",
          "",
          "---------------"
        ],
        "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php": [
          "File: dev/tests/unit/Mage/Core/Helper/Security.php -> dev/tests/unit/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:                 'Mage_Core_Block_Template::fetchView',",
          "66:                 []",
          "67:             ],",
          "68:             'parent class name is passed as second arg' => [",
          "69:                 $topmenu,",
          "70:                 'Mage_Core_Block_Template::fetchView',",
          "71:                 []",
          "72:             ],",
          "73:         ];",
          "74:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:             [",
          "69:                 $topmenu,",
          "70:                 'Mage_Page_Block_Html_Topmenu_Renderer::fetchView',",
          "71:                 []",
          "72:             ],",
          "78:             'parent class name is passed as second arg2' => [",
          "79:                 $topmenu,",
          "80:                 'Mage_Core_Block_Template::render',",
          "81:                 []",
          "82:             ],",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "10dc25f256f3816bf7ecd768eca5303c37f06ff2",
      "candidate_info": {
        "commit_hash": "10dc25f256f3816bf7ecd768eca5303c37f06ff2",
        "repo": "OpenMage/magento-lts",
        "commit_url": "https://github.com/OpenMage/magento-lts/commit/10dc25f256f3816bf7ecd768eca5303c37f06ff2",
        "files": [
          "app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php"
        ],
        "message": "Merge pull request from GHSA-c9q3-r4rv-mjm7",
        "before_after_code_files": [
          "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
          "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ],
          "candidate": [
            "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php",
            "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php"
          ]
        }
      },
      "candidate_diff": {
        "app/code/core/Mage/Core/Helper/Security.php||app/code/core/Mage/Core/Helper/Security.php": [
          "File: app/code/core/Mage/Core/Helper/Security.php -> app/code/core/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     {",
          "44:         foreach ($this->invalidBlockActions as $action) {",
          "45:             $calledMethod = strtolower($method);",
          "49:                 Mage::throwException(",
          "50:                     sprintf('Action with combination block %s and method %s is forbidden.', get_class($block), $method)",
          "51:                 );",
          "",
          "[Removed Lines]",
          "46:             if (($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod)",
          "47:                 || ($block instanceof $action['block']",
          "48:                     && strtolower($action['block'] . '::' . $action['method']) === $calledMethod)) {",
          "",
          "[Added Lines]",
          "46:             if (str_contains($calledMethod, '::')) {",
          "47:                 $calledMethod = explode('::', $calledMethod)[1];",
          "48:             }",
          "49:             if ($block instanceof $action['block'] && strtolower($action['method']) === $calledMethod) {",
          "",
          "---------------"
        ],
        "dev/tests/unit/Mage/Core/Helper/Security.php||dev/tests/unit/Mage/Core/Helper/Security.php": [
          "File: dev/tests/unit/Mage/Core/Helper/Security.php -> dev/tests/unit/Mage/Core/Helper/Security.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:                 'Mage_Core_Block_Template::fetchView',",
          "66:                 []",
          "67:             ],",
          "68:             'parent class name is passed as second arg' => [",
          "69:                 $topmenu,",
          "70:                 'Mage_Core_Block_Template::fetchView',",
          "71:                 []",
          "72:             ],",
          "73:         ];",
          "74:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:             [",
          "69:                 $topmenu,",
          "70:                 'Mage_Page_Block_Html_Topmenu_Renderer::fetchView',",
          "71:                 []",
          "72:             ],",
          "78:             'parent class name is passed as second arg2' => [",
          "79:                 $topmenu,",
          "80:                 'Mage_Core_Block_Template::render',",
          "81:                 []",
          "82:             ],",
          "",
          "---------------"
        ]
      }
    }
  ]
}