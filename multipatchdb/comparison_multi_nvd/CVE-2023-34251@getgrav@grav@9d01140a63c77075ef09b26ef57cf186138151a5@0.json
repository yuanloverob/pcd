{
  "cve_id": "CVE-2023-34251",
  "cve_desc": "Grav is a flat-file content management system. Versions prior to 1.7.42 are vulnerable to server side template injection. Remote code execution is possible by embedding malicious PHP code on the administrator screen by a user with page editing privileges. Version 1.7.42 contains a fix for this issue.",
  "repo": "getgrav/grav",
  "patch_hash": "9d01140a63c77075ef09b26ef57cf186138151a5",
  "patch_info": {
    "commit_hash": "9d01140a63c77075ef09b26ef57cf186138151a5",
    "repo": "getgrav/grav",
    "commit_url": "https://github.com/getgrav/grav/commit/9d01140a63c77075ef09b26ef57cf186138151a5",
    "files": [
      "CHANGELOG.md",
      "system/src/Grav/Common/Twig/Extension/GravExtension.php"
    ],
    "message": "Fix for dangerous tags in |map filter",
    "before_after_code_files": [
      "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
    ]
  },
  "patch_diff": {
    "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php": [
      "File: system/src/Grav/Common/Twig/Extension/GravExtension.php -> system/src/Grav/Common/Twig/Extension/GravExtension.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "175:             new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),",
      "176:         ];",
      "177:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "176:             new TwigFilter('map', [$this, 'mapFilter'], ['needs_environment' => true]),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1714:         return twig_array_filter($env, $array, $arrow);",
      "1715:     }",
      "1716: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1725:     function mapFilter(Environment $env, $array, $arrow)",
      "1726:     {",
      "1727:         if (is_string($arrow) && Utils::isDangerousFunction($arrow)) {",
      "1728:             throw new RuntimeError('Twig |map(\"' . $arrow . '\") is not allowed.');",
      "1729:         }",
      "1731:         return twig_array_map($env, $array, $arrow);",
      "1732:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8c2c1cb72611a399f13423fc6d0e1d998c03e5c8",
      "candidate_info": {
        "commit_hash": "8c2c1cb72611a399f13423fc6d0e1d998c03e5c8",
        "repo": "getgrav/grav",
        "commit_url": "https://github.com/getgrav/grav/commit/8c2c1cb72611a399f13423fc6d0e1d998c03e5c8",
        "files": [
          "CHANGELOG.md",
          "system/src/Grav/Common/Twig/Extension/GravExtension.php",
          "system/src/Grav/Common/Utils.php"
        ],
        "message": "better SSTI in |map and |filter",
        "before_after_code_files": [
          "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php",
          "system/src/Grav/Common/Utils.php||system/src/Grav/Common/Utils.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ],
          "candidate": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ]
        }
      },
      "candidate_diff": {
        "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php": [
          "File: system/src/Grav/Common/Twig/Extension/GravExtension.php -> system/src/Grav/Common/Twig/Extension/GravExtension.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1709:     function filterFilter(Environment $env, $array, $arrow)",
          "1710:     {",
          "1712:             throw new RuntimeError('Twig |filter(\"' . $arrow . '\") is not allowed.');",
          "1713:         }",
          "",
          "[Removed Lines]",
          "1711:         if (is_string($arrow) && Utils::isDangerousFunction($arrow)) {",
          "",
          "[Added Lines]",
          "1711:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1725:     function mapFilter(Environment $env, $array, $arrow)",
          "1726:     {",
          "1728:             throw new RuntimeError('Twig |map(\"' . $arrow . '\") is not allowed.');",
          "1729:         }",
          "",
          "[Removed Lines]",
          "1727:         if (is_string($arrow) && Utils::isDangerousFunction($arrow)) {",
          "",
          "[Added Lines]",
          "1727:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
          "",
          "---------------"
        ],
        "system/src/Grav/Common/Utils.php||system/src/Grav/Common/Utils.php": [
          "File: system/src/Grav/Common/Utils.php -> system/src/Grav/Common/Utils.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1950:     }",
          "1957:     {",
          "1958:         static $commandExecutionFunctions = [",
          "1959:             'exec',",
          "",
          "[Removed Lines]",
          "1956:     public static function isDangerousFunction(string $name): bool",
          "",
          "[Added Lines]",
          "1956:     public static function isDangerousFunction($name): bool",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2050:             'posix_setuid',",
          "2051:         ];",
          "2053:         if (in_array($name, $commandExecutionFunctions)) {",
          "2054:             return true;",
          "2055:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2053:         if (is_array($name) || strpos($name, \":\") !== false) {",
          "2054:             return false;",
          "2055:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "244758d4383034fe4cd292d41e477177870b65ec",
      "candidate_info": {
        "commit_hash": "244758d4383034fe4cd292d41e477177870b65ec",
        "repo": "getgrav/grav",
        "commit_url": "https://github.com/getgrav/grav/commit/244758d4383034fe4cd292d41e477177870b65ec",
        "files": [
          "CHANGELOG.md",
          "system/src/Grav/Common/Twig/Extension/GravExtension.php"
        ],
        "message": "also handle SSTI in reduce twig filter + function",
        "before_after_code_files": [
          "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ],
          "candidate": [
            "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php"
          ]
        }
      },
      "candidate_diff": {
        "system/src/Grav/Common/Twig/Extension/GravExtension.php||system/src/Grav/Common/Twig/Extension/GravExtension.php": [
          "File: system/src/Grav/Common/Twig/Extension/GravExtension.php -> system/src/Grav/Common/Twig/Extension/GravExtension.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "171:             new TwigFilter('count', 'count'),",
          "172:             new TwigFilter('array_diff', 'array_diff'),",
          "177:         ];",
          "178:     }",
          "",
          "[Removed Lines]",
          "175:             new TwigFilter('filter', [$this, 'filterFilter'], ['needs_environment' => true]),",
          "176:             new TwigFilter('map', [$this, 'mapFilter'], ['needs_environment' => true]),",
          "",
          "[Added Lines]",
          "175:             new TwigFilter('filter', [$this, 'filterFunc'], ['needs_environment' => true]),",
          "176:             new TwigFilter('map', [$this, 'mapFunc'], ['needs_environment' => true]),",
          "177:             new TwigFilter('reduce', [$this, 'reduceFunc'], ['needs_environment' => true]),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "250:             new TwigFunction('count', 'count'),",
          "251:             new TwigFunction('array_diff', 'array_diff'),",
          "252:             new TwigFunction('parse_url', 'parse_url'),",
          "253:         ];",
          "254:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "256:             new TwigFunction('filter', [$this, 'filterFunc'], ['needs_environment' => true]),",
          "257:             new TwigFunction('map', [$this, 'mapFunc'], ['needs_environment' => true]),",
          "258:             new TwigFunction('reduce', [$this, 'reduceFunc'], ['needs_environment' => true]),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1710:     {",
          "1711:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
          "1712:             throw new RuntimeError('Twig |filter(\"' . $arrow . '\") is not allowed.');",
          "",
          "[Removed Lines]",
          "1709:     function filterFilter(Environment $env, $array, $arrow)",
          "",
          "[Added Lines]",
          "1715:     function filterFunc(Environment $env, $array, $arrow)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1726:     {",
          "1727:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
          "1728:             throw new RuntimeError('Twig |map(\"' . $arrow . '\") is not allowed.');",
          "",
          "[Removed Lines]",
          "1725:     function mapFilter(Environment $env, $array, $arrow)",
          "",
          "[Added Lines]",
          "1731:     function mapFunc(Environment $env, $array, $arrow)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1731:         return twig_array_map($env, $array, $arrow);",
          "1732:     }",
          "1733: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1747:     function reduceFunc(Environment $env, $array, $arrow)",
          "1748:     {",
          "1749:         if (!$arrow instanceof \\Closure && !is_string($arrow) || Utils::isDangerousFunction($arrow)) {",
          "1750:             throw new RuntimeError('Twig |reduce(\"' . $arrow . '\") is not allowed.');",
          "1751:         }",
          "1753:         return twig_array_map($env, $array, $arrow);",
          "1754:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}