{
  "cve_id": "CVE-2022-36114",
  "cve_desc": "Cargo is a package manager for the rust programming language. It was discovered that Cargo did not limit the amount of data extracted from compressed archives. An attacker could upload to an alternate registry a specially crafted package that extracts way more data than its size (also known as a \"zip bomb\"), exhausting the disk space on the machine using Cargo to download the package. Note that by design Cargo allows code execution at build time, due to build scripts and procedural macros. The vulnerabilities in this advisory allow performing a subset of the possible damage in a harder to track down way. Your dependencies must still be trusted if you want to be protected from attacks, as it's possible to perform the same attacks with build scripts and procedural macros. The vulnerability is present in all versions of Cargo. Rust 1.64, to be released on September 22nd, will include a fix for it. Since the vulnerability is just a more limited way to accomplish what a malicious build scripts or procedural macros can do, we decided not to publish Rust point releases backporting the security fix. Patch files are available for Rust 1.63.0 are available in the wg-security-response repository for people building their own toolchain. We recommend users of alternate registries to excercise care in which package they download, by only including trusted dependencies in their projects. Please note that even with these vulnerabilities fixed, by design Cargo allows arbitrary code execution at build time thanks to build scripts and procedural macros: a malicious dependency will be able to cause damage regardless of these vulnerabilities. crates.io implemented server-side checks to reject these kinds of packages years ago, and there are no packages on crates.io exploiting these vulnerabilities. crates.io users still need to excercise care in choosing their dependencies though, as the same concerns about build scripts and procedural macros apply here.",
  "repo": "rust-lang/cargo",
  "patch_hash": "d1f9553c825f6d7481453be8d58d0e7f117988a7",
  "patch_info": {
    "commit_hash": "d1f9553c825f6d7481453be8d58d0e7f117988a7",
    "repo": "rust-lang/cargo",
    "commit_url": "https://github.com/rust-lang/cargo/commit/d1f9553c825f6d7481453be8d58d0e7f117988a7",
    "files": [
      "src/cargo/sources/registry/mod.rs",
      "src/cargo/util/io.rs",
      "src/cargo/util/mod.rs"
    ],
    "message": "CVE-2022-36114: limit the maximum unpacked size of a crate to 512MB\n\nThis gives users of custom registries the same protections, using the\nsame size limit that crates.io uses.\n\n`LimitErrorReader` code copied from crates.io.",
    "before_after_code_files": [
      "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
      "src/cargo/util/io.rs||src/cargo/util/io.rs",
      "src/cargo/util/mod.rs||src/cargo/util/mod.rs"
    ]
  },
  "patch_diff": {
    "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs": [
      "File: src/cargo/sources/registry/mod.rs -> src/cargo/sources/registry/mod.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "182: use crate::util::interning::InternedString;",
      "183: use crate::util::into_url::IntoUrl;",
      "184: use crate::util::network::PollExt;",
      "187: const PACKAGE_SOURCE_LOCK: &str = \".cargo-ok\";",
      "188: pub const CRATES_IO_INDEX: &str = \"https://github.com/rust-lang/crates.io-index\";",
      "",
      "[Removed Lines]",
      "185: use crate::util::{restricted_names, CargoResult, Config, Filesystem, OptVersionReq};",
      "",
      "[Added Lines]",
      "185: use crate::util::{",
      "186:     restricted_names, CargoResult, Config, Filesystem, LimitErrorReader, OptVersionReq,",
      "187: };",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "194: const PREFIX_TEMPLATE: &str = \"{prefix}\";",
      "195: const LOWER_PREFIX_TEMPLATE: &str = \"{lowerprefix}\";",
      "196: const CHECKSUM_TEMPLATE: &str = \"{sha256-checksum}\";",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "199: const MAX_UNPACK_SIZE: u64 = 512 * 1024 * 1024;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "615:             }",
      "616:         }",
      "617:         let gz = GzDecoder::new(tarball);",
      "618:         let mut tar = Archive::new(gz);",
      "619:         let prefix = unpack_dir.file_name().unwrap();",
      "620:         let parent = unpack_dir.parent().unwrap();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "621:         let gz = LimitErrorReader::new(gz, MAX_UNPACK_SIZE);",
      "",
      "---------------"
    ],
    "src/cargo/util/io.rs||src/cargo/util/io.rs": [
      "File: src/cargo/util/io.rs -> src/cargo/util/io.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: use std::io::{self, Read, Take};",
      "3: #[derive(Debug)]",
      "4: pub struct LimitErrorReader<R> {",
      "5:     inner: Take<R>,",
      "6: }",
      "8: impl<R: Read> LimitErrorReader<R> {",
      "9:     pub fn new(r: R, limit: u64) -> LimitErrorReader<R> {",
      "10:         LimitErrorReader {",
      "11:             inner: r.take(limit),",
      "12:         }",
      "13:     }",
      "14: }",
      "16: impl<R: Read> Read for LimitErrorReader<R> {",
      "17:     fn read(&mut self, buf: &mut [u8]) -> io::Result<usize> {",
      "18:         match self.inner.read(buf) {",
      "19:             Ok(0) if self.inner.limit() == 0 => Err(io::Error::new(",
      "20:                 io::ErrorKind::Other,",
      "21:                 \"maximum limit reached when reading\",",
      "22:             )),",
      "23:             e => e,",
      "24:         }",
      "25:     }",
      "26: }",
      "",
      "---------------"
    ],
    "src/cargo/util/mod.rs||src/cargo/util/mod.rs": [
      "File: src/cargo/util/mod.rs -> src/cargo/util/mod.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "14: pub use self::hex::{hash_u64, short_hash, to_hex};",
      "15: pub use self::into_url::IntoUrl;",
      "16: pub use self::into_url_with_base::IntoUrlWithBase;",
      "17: pub use self::lev_distance::{closest, closest_msg, lev_distance};",
      "18: pub use self::lockserver::{LockServer, LockServerClient, LockServerStarted};",
      "19: pub use self::progress::{Progress, ProgressStyle};",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "17: pub(crate) use self::io::LimitErrorReader;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "44: pub mod interning;",
      "45: pub mod into_url;",
      "46: mod into_url_with_base;",
      "47: pub mod job;",
      "48: pub mod lev_distance;",
      "49: mod lockserver;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "48: mod io;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dafe4a7ea016739680ec7998aebe1bc6de131a5b",
      "candidate_info": {
        "commit_hash": "dafe4a7ea016739680ec7998aebe1bc6de131a5b",
        "repo": "rust-lang/cargo",
        "commit_url": "https://github.com/rust-lang/cargo/commit/dafe4a7ea016739680ec7998aebe1bc6de131a5b",
        "files": [
          "crates/cargo-test-support/src/registry.rs",
          "tests/testsuite/registry.rs"
        ],
        "message": "CVE-2022-36113: add tests",
        "before_after_code_files": [
          "crates/cargo-test-support/src/registry.rs||crates/cargo-test-support/src/registry.rs",
          "tests/testsuite/registry.rs||tests/testsuite/registry.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/rust-lang/cargo/pull/11089"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crates/cargo-test-support/src/registry.rs||crates/cargo-test-support/src/registry.rs": [
          "File: crates/cargo-test-support/src/registry.rs -> crates/cargo-test-support/src/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "403:     optional: bool,",
          "404: }",
          "407: struct PackageFile {",
          "408:     path: String,",
          "412:     mode: u32,",
          "",
          "[Removed Lines]",
          "409:     contents: String,",
          "",
          "[Added Lines]",
          "407: #[non_exhaustive]",
          "408: enum EntryData {",
          "409:     Regular(String),",
          "410:     Symlink(PathBuf),",
          "411: }",
          "416:     contents: EntryData,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "780:     pub fn file_with_mode(&mut self, path: &str, mode: u32, contents: &str) -> &mut Package {",
          "781:         self.files.push(PackageFile {",
          "782:             path: path.to_string(),",
          "784:             mode,",
          "785:             extra: false,",
          "786:         });",
          "787:         self",
          "788:     }",
          "",
          "[Removed Lines]",
          "783:             contents: contents.to_string(),",
          "",
          "[Added Lines]",
          "790:             contents: EntryData::Regular(contents.into()),",
          "798:     pub fn symlink(&mut self, dst: &str, src: &str) -> &mut Package {",
          "799:         self.files.push(PackageFile {",
          "800:             path: dst.to_string(),",
          "801:             contents: EntryData::Symlink(src.into()),",
          "802:             mode: DEFAULT_MODE,",
          "803:             extra: false,",
          "804:         });",
          "805:         self",
          "806:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "795:     pub fn extra_file(&mut self, path: &str, contents: &str) -> &mut Package {",
          "796:         self.files.push(PackageFile {",
          "797:             path: path.to_string(),",
          "799:             mode: DEFAULT_MODE,",
          "800:             extra: true,",
          "801:         });",
          "",
          "[Removed Lines]",
          "798:             contents: contents.to_string(),",
          "",
          "[Added Lines]",
          "816:             contents: EntryData::Regular(contents.to_string()),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1033:             self.append_manifest(&mut a);",
          "1034:         }",
          "1035:         if self.files.is_empty() {",
          "1037:         } else {",
          "1038:             for PackageFile {",
          "1039:                 path,",
          "",
          "[Removed Lines]",
          "1036:             self.append(&mut a, \"src/lib.rs\", DEFAULT_MODE, \"\");",
          "",
          "[Added Lines]",
          "1054:             self.append(&mut a, \"src/lib.rs\", DEFAULT_MODE, &EntryData::Regular(\"\".into()));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1107:             manifest.push_str(\"[lib]\\nproc-macro = true\\n\");",
          "1108:         }",
          "1111:     }",
          "1114:         self.append_raw(",
          "1115:             ar,",
          "1116:             &format!(\"{}-{}/{}\", self.name, self.vers, file),",
          "",
          "[Removed Lines]",
          "1110:         self.append(ar, \"Cargo.toml\", DEFAULT_MODE, &manifest);",
          "1113:     fn append<W: Write>(&self, ar: &mut Builder<W>, file: &str, mode: u32, contents: &str) {",
          "",
          "[Added Lines]",
          "1128:         self.append(ar, \"Cargo.toml\", DEFAULT_MODE, &EntryData::Regular(manifest.into()));",
          "1131:     fn append<W: Write>(&self, ar: &mut Builder<W>, file: &str, mode: u32, contents: &EntryData) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1119:         );",
          "1120:     }",
          "1123:         let mut header = Header::new_ustar();",
          "1124:         header.set_size(contents.len() as u64);",
          "1125:         t!(header.set_path(path));",
          "1126:         header.set_mode(mode);",
          "",
          "[Removed Lines]",
          "1122:     fn append_raw<W: Write>(&self, ar: &mut Builder<W>, path: &str, mode: u32, contents: &str) {",
          "",
          "[Added Lines]",
          "1140:     fn append_raw<W: Write>(&self, ar: &mut Builder<W>, path: &str, mode: u32, contents: &EntryData) {",
          "1142:         let contents = match contents {",
          "1143:             EntryData::Regular(contents) => contents.as_str(),",
          "1144:             EntryData::Symlink(src) => {",
          "1145:                 header.set_entry_type(tar::EntryType::Symlink);",
          "1146:                 t!(header.set_link_name(src));",
          "1147:                 \"\" // Symlink has no contents.",
          "1148:             }",
          "1149:         };",
          "",
          "---------------"
        ],
        "tests/testsuite/registry.rs||tests/testsuite/registry.rs": [
          "File: tests/testsuite/registry.rs -> tests/testsuite/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "2583:     assert_eq!(ok.metadata().unwrap().len(), 2);",
          "2584: }",
          "2586: #[cargo_test]",
          "2587: fn ignores_unknown_index_version_http() {",
          "2588:     let _server = setup_http();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2586: #[cargo_test]",
          "2587: fn package_lock_as_a_symlink_inside_package_is_overwritten() {",
          "2588:     let registry = registry::init();",
          "2589:     let p = project()",
          "2590:         .file(",
          "2591:             \"Cargo.toml\",",
          "2592:             r#\"",
          "2593:                 [project]",
          "2594:                 name = \"foo\"",
          "2595:                 version = \"0.0.1\"",
          "2596:                 authors = []",
          "2598:                 [dependencies]",
          "2599:                 bar = \">= 0.0.0\"",
          "2600:             \"#,",
          "2601:         )",
          "2602:         .file(\"src/main.rs\", \"fn main() {}\")",
          "2603:         .build();",
          "2605:     Package::new(\"bar\", \"0.0.1\")",
          "2606:         .file(\"src/lib.rs\", \"pub fn f() {}\")",
          "2607:         .symlink(\".cargo-ok\", \"src/lib.rs\")",
          "2608:         .publish();",
          "2610:     p.cargo(\"build\").run();",
          "2612:     let id = SourceId::for_registry(registry.index_url()).unwrap();",
          "2613:     let hash = cargo::util::hex::short_hash(&id);",
          "2614:     let pkg_root = cargo_home()",
          "2615:         .join(\"registry\")",
          "2616:         .join(\"src\")",
          "2617:         .join(format!(\"-{}\", hash))",
          "2618:         .join(\"bar-0.0.1\");",
          "2619:     let ok = pkg_root.join(\".cargo-ok\");",
          "2620:     let librs = pkg_root.join(\"src/lib.rs\");",
          "2623:     assert_eq!(ok.metadata().unwrap().len(), 2);",
          "2624:     assert_eq!(fs::read_to_string(librs).unwrap(), \"pub fn f() {}\");",
          "2625: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "97b80919e404b0768ea31ae329c3b4da54bed05a",
      "candidate_info": {
        "commit_hash": "97b80919e404b0768ea31ae329c3b4da54bed05a",
        "repo": "rust-lang/cargo",
        "commit_url": "https://github.com/rust-lang/cargo/commit/97b80919e404b0768ea31ae329c3b4da54bed05a",
        "files": [
          "src/cargo/sources/registry/mod.rs"
        ],
        "message": "CVE-2022-36113: avoid unpacking .cargo-ok from the crate",
        "before_after_code_files": [
          "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/rust-lang/cargo/pull/11089"
        ],
        "olp_code_files": {
          "patch": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs"
          ],
          "candidate": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs": [
          "File: src/cargo/sources/registry/mod.rs -> src/cargo/sources/registry/mod.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "639:                     prefix",
          "640:                 )",
          "641:             }",
          "643:             let mut result = entry.unpack_in(parent).map_err(anyhow::Error::from);",
          "644:             if cfg!(windows) && restricted_names::is_windows_reserved_path(&entry_path) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "643:             if entry_path",
          "644:                 .file_name()",
          "645:                 .map_or(false, |p| p == PACKAGE_SOURCE_LOCK)",
          "646:             {",
          "647:                 continue;",
          "648:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "654:                 .with_context(|| format!(\"failed to unpack entry at `{}`\", entry_path.display()))?;",
          "655:         }",
          "659:         let mut ok = OpenOptions::new()",
          "661:             .read(true)",
          "662:             .write(true)",
          "663:             .open(&path)",
          "664:             .with_context(|| format!(\"failed to open `{}`\", path.display()))?;",
          "667:         write!(ok, \"ok\")?;",
          "669:         Ok(unpack_dir.to_path_buf())",
          "",
          "[Removed Lines]",
          "660:             .create(true)",
          "",
          "[Added Lines]",
          "667:             .create_new(true)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0bf436d0d2ca03dbe8a6a3636f7415750f78a2d7",
      "candidate_info": {
        "commit_hash": "0bf436d0d2ca03dbe8a6a3636f7415750f78a2d7",
        "repo": "rust-lang/cargo",
        "commit_url": "https://github.com/rust-lang/cargo/commit/0bf436d0d2ca03dbe8a6a3636f7415750f78a2d7",
        "files": [
          "crates/cargo-test-support/src/registry.rs"
        ],
        "message": "fix formatting",
        "before_after_code_files": [
          "crates/cargo-test-support/src/registry.rs||crates/cargo-test-support/src/registry.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/rust-lang/cargo/pull/11089"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crates/cargo-test-support/src/registry.rs||crates/cargo-test-support/src/registry.rs": [
          "File: crates/cargo-test-support/src/registry.rs -> crates/cargo-test-support/src/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1051:             self.append_manifest(&mut a);",
          "1052:         }",
          "1053:         if self.files.is_empty() {",
          "1055:         } else {",
          "1056:             for PackageFile {",
          "1057:                 path,",
          "",
          "[Removed Lines]",
          "1054:             self.append(&mut a, \"src/lib.rs\", DEFAULT_MODE, &EntryData::Regular(\"\".into()));",
          "",
          "[Added Lines]",
          "1054:             self.append(",
          "1055:                 &mut a,",
          "1056:                 \"src/lib.rs\",",
          "1057:                 DEFAULT_MODE,",
          "1058:                 &EntryData::Regular(\"\".into()),",
          "1059:             );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1125:             manifest.push_str(\"[lib]\\nproc-macro = true\\n\");",
          "1126:         }",
          "1129:     }",
          "1131:     fn append<W: Write>(&self, ar: &mut Builder<W>, file: &str, mode: u32, contents: &EntryData) {",
          "",
          "[Removed Lines]",
          "1128:         self.append(ar, \"Cargo.toml\", DEFAULT_MODE, &EntryData::Regular(manifest.into()));",
          "",
          "[Added Lines]",
          "1133:         self.append(",
          "1134:             ar,",
          "1135:             \"Cargo.toml\",",
          "1136:             DEFAULT_MODE,",
          "1137:             &EntryData::Regular(manifest.into()),",
          "1138:         );",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1137:         );",
          "1138:     }",
          "1141:         let mut header = Header::new_ustar();",
          "1142:         let contents = match contents {",
          "1143:             EntryData::Regular(contents) => contents.as_str(),",
          "",
          "[Removed Lines]",
          "1140:     fn append_raw<W: Write>(&self, ar: &mut Builder<W>, path: &str, mode: u32, contents: &EntryData) {",
          "",
          "[Added Lines]",
          "1150:     fn append_raw<W: Write>(",
          "1151:         &self,",
          "1152:         ar: &mut Builder<W>,",
          "1153:         path: &str,",
          "1154:         mode: u32,",
          "1155:         contents: &EntryData,",
          "1156:     ) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d87d57dbbda61754f4fab0f329a7ac520e062c46",
      "candidate_info": {
        "commit_hash": "d87d57dbbda61754f4fab0f329a7ac520e062c46",
        "repo": "rust-lang/cargo",
        "commit_url": "https://github.com/rust-lang/cargo/commit/d87d57dbbda61754f4fab0f329a7ac520e062c46",
        "files": [
          "src/cargo/sources/registry/mod.rs",
          "src/cargo/util/io.rs",
          "tests/testsuite/registry.rs"
        ],
        "message": "CVE-2022-36114: add tests",
        "before_after_code_files": [
          "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
          "src/cargo/util/io.rs||src/cargo/util/io.rs",
          "tests/testsuite/registry.rs||tests/testsuite/registry.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
            "src/cargo/util/io.rs||src/cargo/util/io.rs"
          ],
          "candidate": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
            "src/cargo/util/io.rs||src/cargo/util/io.rs"
          ]
        }
      },
      "candidate_diff": {
        "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs": [
          "File: src/cargo/sources/registry/mod.rs -> src/cargo/sources/registry/mod.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "618:             }",
          "619:         }",
          "620:         let gz = GzDecoder::new(tarball);",
          "622:         let mut tar = Archive::new(gz);",
          "623:         let prefix = unpack_dir.file_name().unwrap();",
          "624:         let parent = unpack_dir.parent().unwrap();",
          "",
          "[Removed Lines]",
          "621:         let gz = LimitErrorReader::new(gz, MAX_UNPACK_SIZE);",
          "",
          "[Added Lines]",
          "621:         let gz = LimitErrorReader::new(gz, max_unpack_size());",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "835:     }",
          "836: }",
          "838: fn make_dep_prefix(name: &str) -> String {",
          "839:     match name.len() {",
          "840:         1 => String::from(\"1\"),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "839: #[inline]",
          "840: fn max_unpack_size() -> u64 {",
          "841:     const VAR: &str = \"__CARGO_TEST_MAX_UNPACK_SIZE\";",
          "842:     if cfg!(debug_assertions) && std::env::var(VAR).is_ok() {",
          "843:         std::env::var(VAR)",
          "844:             .unwrap()",
          "845:             .parse()",
          "846:             .expect(\"a max unpack size in bytes\")",
          "847:     } else {",
          "848:         MAX_UNPACK_SIZE",
          "849:     }",
          "850: }",
          "",
          "---------------"
        ],
        "src/cargo/util/io.rs||src/cargo/util/io.rs": [
          "File: src/cargo/util/io.rs -> src/cargo/util/io.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "25:     }",
          "26: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: #[cfg(test)]",
          "29: mod tests {",
          "30:     use super::LimitErrorReader;",
          "32:     use std::io::Read;",
          "34:     #[test]",
          "35:     fn under_the_limit() {",
          "36:         let buf = &[1; 7][..];",
          "37:         let mut r = LimitErrorReader::new(buf, 8);",
          "38:         let mut out = Vec::new();",
          "39:         assert!(matches!(r.read_to_end(&mut out), Ok(7)));",
          "40:         assert_eq!(buf, out.as_slice());",
          "41:     }",
          "43:     #[test]",
          "44:     #[should_panic = \"maximum limit reached when reading\"]",
          "45:     fn over_the_limit() {",
          "46:         let buf = &[1; 8][..];",
          "47:         let mut r = LimitErrorReader::new(buf, 8);",
          "48:         let mut out = Vec::new();",
          "49:         r.read_to_end(&mut out).unwrap();",
          "50:     }",
          "51: }",
          "",
          "---------------"
        ],
        "tests/testsuite/registry.rs||tests/testsuite/registry.rs": [
          "File: tests/testsuite/registry.rs -> tests/testsuite/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "2697:         .with_stderr(\"[ERROR] registry url must end in a slash `/`: sparse+https://index.crates.io\")",
          "2698:         .run()",
          "2699: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2701: #[cargo_test]",
          "2702: fn reach_max_unpack_size() {",
          "2703:     let p = project()",
          "2704:         .file(",
          "2705:             \"Cargo.toml\",",
          "2706:             r#\"",
          "2707:                 [project]",
          "2708:                 name = \"foo\"",
          "2709:                 version = \"0.0.1\"",
          "2711:                 [dependencies]",
          "2712:                 bar = \">= 0.0.0\"",
          "2713:             \"#,",
          "2714:         )",
          "2715:         .file(\"src/main.rs\", \"fn main() {}\")",
          "2716:         .build();",
          "2718:     Package::new(\"bar\", \"0.0.1\").publish();",
          "2720:     p.cargo(\"build\")",
          "2721:         .env(\"__CARGO_TEST_MAX_UNPACK_SIZE\", \"8\") // hit 8 bytes limit and boom!",
          "2722:         .with_status(101)",
          "2723:         .with_stderr(",
          "2724:             \"\\",
          "2725: [UPDATING] `dummy-registry` index",
          "2726: [DOWNLOADING] crates ...",
          "2727: [DOWNLOADED] bar v0.0.1 (registry `dummy-registry`)",
          "2728: [ERROR] failed to download replaced source registry `crates-io`",
          "2730: Caused by:",
          "2731:   failed to unpack package `bar v0.0.1 (registry `dummy-registry`)`",
          "2733: Caused by:",
          "2734:   failed to iterate over archive",
          "2736: Caused by:",
          "2737:   maximum limit reached when reading",
          "2738: \",",
          "2739:         )",
          "2740:         .run();",
          "2741: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f315a70b1d2a6ac1aa4e06bd1c9dd17ec0d6c65a",
      "candidate_info": {
        "commit_hash": "f315a70b1d2a6ac1aa4e06bd1c9dd17ec0d6c65a",
        "repo": "rust-lang/cargo",
        "commit_url": "https://github.com/rust-lang/cargo/commit/f315a70b1d2a6ac1aa4e06bd1c9dd17ec0d6c65a",
        "files": [
          "Cargo.lock",
          "Cargo.toml",
          "src/cargo/sources/registry/mod.rs",
          "src/cargo/util/mod.rs",
          "tests/testsuite/registry.rs",
          "tests/testsuite/vendor.rs"
        ],
        "message": "fix: respect `umask` when unpacking `.crate` files\n\nWithout this, an attacker can upload globally writable files buried\nin the `.crate` file. After a user downloaded and unpacked the file,\nthe attacker can then write malicous code to the downloaded sources.",
        "before_after_code_files": [
          "Cargo.lock||Cargo.lock",
          "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
          "src/cargo/util/mod.rs||src/cargo/util/mod.rs",
          "tests/testsuite/registry.rs||tests/testsuite/registry.rs",
          "tests/testsuite/vendor.rs||tests/testsuite/vendor.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
            "src/cargo/util/mod.rs||src/cargo/util/mod.rs"
          ],
          "candidate": [
            "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs",
            "src/cargo/util/mod.rs||src/cargo/util/mod.rs"
          ]
        }
      },
      "candidate_diff": {
        "Cargo.lock||Cargo.lock": [
          "File: Cargo.lock -> Cargo.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "3066: [[package]]",
          "3067: name = \"tar\"",
          "3069: source = \"registry+https://github.com/rust-lang/crates.io-index\"",
          "3071: dependencies = [",
          "3072:  \"filetime\",",
          "3073:  \"libc\",",
          "",
          "[Removed Lines]",
          "3068: version = \"0.4.38\"",
          "3070: checksum = \"4b55807c0344e1e6c04d7c965f5289c39a8d94ae23ed5c0b57aabac549f871c6\"",
          "",
          "[Added Lines]",
          "3068: version = \"0.4.39\"",
          "3070: checksum = \"ec96d2ffad078296368d46ff1cb309be1c23c513b4ab0e22a45de0185275ac96\"",
          "",
          "---------------"
        ],
        "src/cargo/sources/registry/mod.rs||src/cargo/sources/registry/mod.rs": [
          "File: src/cargo/sources/registry/mod.rs -> src/cargo/sources/registry/mod.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "162: use std::collections::BTreeMap;",
          "163: use std::collections::HashSet;",
          "164: use std::fs::{File, OpenOptions};",
          "166: use std::path::{Path, PathBuf};",
          "167: use std::task::{ready, Poll};",
          "",
          "[Removed Lines]",
          "165: use std::io::{self, Write};",
          "",
          "[Added Lines]",
          "165: use std::io;",
          "166: use std::io::Read;",
          "167: use std::io::Write;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "698:             let size_limit = max_unpack_size(self.config, tarball.metadata()?.len());",
          "699:             let gz = GzDecoder::new(tarball);",
          "700:             let gz = LimitErrorReader::new(gz, size_limit);",
          "702:         };",
          "703:         let prefix = unpack_dir.file_name().unwrap();",
          "704:         let parent = unpack_dir.parent().unwrap();",
          "",
          "[Removed Lines]",
          "701:             Archive::new(gz)",
          "",
          "[Added Lines]",
          "703:             let mut tar = Archive::new(gz);",
          "704:             set_mask(&mut tar);",
          "705:             tar",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1036:         assert_eq!(make_dep_prefix(\"aBcDe\"), \"aB/cD\");",
          "1037:     }",
          "1038: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1051: #[allow(unused_variables)]",
          "1052: fn set_mask<R: Read>(tar: &mut Archive<R>) {",
          "1053:     #[cfg(unix)]",
          "1054:     tar.set_mask(crate::util::get_umask());",
          "1055: }",
          "",
          "---------------"
        ],
        "src/cargo/util/mod.rs||src/cargo/util/mod.rs": [
          "File: src/cargo/util/mod.rs -> src/cargo/util/mod.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "207:     })",
          "208: }",
          "210: #[cfg(test)]",
          "211: mod test {",
          "212:     use super::*;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "213: #[cfg(unix)]",
          "214: pub fn get_umask() -> u32 {",
          "215:     use std::sync::OnceLock;",
          "216:     static UMASK: OnceLock<libc::mode_t> = OnceLock::new();",
          "222:         let umask = libc::umask(0o022);",
          "223:         libc::umask(umask);",
          "224:         umask",
          "225:     }) as u32 // it is u16 on macos",
          "226: }",
          "",
          "---------------"
        ],
        "tests/testsuite/registry.rs||tests/testsuite/registry.rs": [
          "File: tests/testsuite/registry.rs -> tests/testsuite/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "3452:         .unwrap()",
          "3453:     };",
          "3456:     let metadata = fs::metadata(src_file_path(\"src/lib.rs\")).unwrap();",
          "3458:     let metadata = fs::metadata(src_file_path(\"example.sh\")).unwrap();",
          "3460: }",
          "",
          "[Removed Lines]",
          "3457:     assert_eq!(metadata.mode() & 0o777, 0o666);",
          "3459:     assert_eq!(metadata.mode() & 0o777, 0o777);",
          "",
          "[Added Lines]",
          "3455:     let umask = cargo::util::get_umask();",
          "3457:     assert_eq!(metadata.mode() & 0o777, 0o666 & !umask);",
          "3459:     assert_eq!(metadata.mode() & 0o777, 0o777 & !umask);",
          "",
          "---------------"
        ],
        "tests/testsuite/vendor.rs||tests/testsuite/vendor.rs": [
          "File: tests/testsuite/vendor.rs -> tests/testsuite/vendor.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1052:     p.cargo(\"vendor --respect-source-config\").run();",
          "1054:     let metadata = fs::metadata(p.root().join(\"vendor/bar/src/lib.rs\")).unwrap();",
          "1056:     let metadata = fs::metadata(p.root().join(\"vendor/bar/example.sh\")).unwrap();",
          "1058: }",
          "1060: #[cargo_test]",
          "",
          "[Removed Lines]",
          "1055:     assert_eq!(metadata.mode() & 0o777, 0o644);",
          "1057:     assert_eq!(metadata.mode() & 0o777, 0o755);",
          "",
          "[Added Lines]",
          "1054:     let umask = cargo::util::get_umask();",
          "1056:     assert_eq!(metadata.mode() & 0o777, 0o644 & !umask);",
          "1058:     assert_eq!(metadata.mode() & 0o777, 0o755 & !umask);",
          "",
          "---------------"
        ]
      }
    }
  ]
}