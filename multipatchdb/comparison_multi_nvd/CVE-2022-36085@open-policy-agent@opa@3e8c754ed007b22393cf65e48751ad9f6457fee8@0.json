{
  "cve_id": "CVE-2022-36085",
  "cve_desc": "Open Policy Agent (OPA) is an open source, general-purpose policy engine. The Rego compiler provides a (deprecated) `WithUnsafeBuiltins` function, which allows users to provide a set of built-in functions that should be deemed unsafe \u2014 and as such rejected \u2014 by the compiler if encountered in the policy compilation stage. A bypass of this protection has been found, where the use of the `with` keyword to mock such a built-in function (a feature introduced in OPA v0.40.0), isn\u2019t taken into account by `WithUnsafeBuiltins`. Multiple conditions need to be met in order to create an adverse effect. Version 0.43.1 contains a patch for this issue. As a workaround, avoid using the `WithUnsafeBuiltins` function and use the `capabilities` feature instead.",
  "repo": "open-policy-agent/opa",
  "patch_hash": "3e8c754ed007b22393cf65e48751ad9f6457fee8",
  "patch_info": {
    "commit_hash": "3e8c754ed007b22393cf65e48751ad9f6457fee8",
    "repo": "open-policy-agent/opa",
    "commit_url": "https://github.com/open-policy-agent/opa/commit/3e8c754ed007b22393cf65e48751ad9f6457fee8",
    "files": [
      "ast/compile.go",
      "ast/compile_test.go",
      "rego/rego_test.go"
    ],
    "message": "ast/compile: respect unsafeBuiltinMap for 'with' replacements\n\nThe changes are necessary for both the Compiler and the QueryCompiler. Tests\nhave been added to ensure that the code path through the rego package has also\nbeen fixed.\n\nFixes CVE-2022-36085.\n\nSigned-off-by: Stephan Renatus <stephan.renatus@gmail.com>",
    "before_after_code_files": [
      "ast/compile.go||ast/compile.go",
      "ast/compile_test.go||ast/compile_test.go",
      "rego/rego_test.go||rego/rego_test.go"
    ]
  },
  "patch_diff": {
    "ast/compile.go||ast/compile.go": [
      "File: ast/compile.go -> ast/compile.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "2196:    if !ok {",
      "2197:     return x, nil",
      "2198:    }",
      "2200:    if err != nil {",
      "2201:     c.err(err)",
      "2202:    }",
      "",
      "[Removed Lines]",
      "2199:    body, err := rewriteWithModifiersInBody(c, f, body)",
      "",
      "[Added Lines]",
      "2199:    body, err := rewriteWithModifiersInBody(c, c.unsafeBuiltinsMap, f, body)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2475: }",
      "2477: func (qc *queryCompiler) checkUnsafeBuiltins(_ *QueryContext, body Body) (Body, error) {",
      "2485:  if len(errs) > 0 {",
      "2486:   return nil, errs",
      "2487:  }",
      "2488:  return body, nil",
      "2489: }",
      "2491: func (qc *queryCompiler) checkDeprecatedBuiltins(_ *QueryContext, body Body) (Body, error) {",
      "2492:  errs := checkDeprecatedBuiltins(qc.compiler.deprecatedBuiltinsMap, body, qc.compiler.strict)",
      "2493:  if len(errs) > 0 {",
      "",
      "[Removed Lines]",
      "2478:  var unsafe map[string]struct{}",
      "2479:  if qc.unsafeBuiltins != nil {",
      "2480:   unsafe = qc.unsafeBuiltins",
      "2481:  } else {",
      "2482:   unsafe = qc.compiler.unsafeBuiltinsMap",
      "2483:  }",
      "2484:  errs := checkUnsafeBuiltins(unsafe, body)",
      "",
      "[Added Lines]",
      "2478:  errs := checkUnsafeBuiltins(qc.unsafeBuiltinsMap(), body)",
      "2485: func (qc *queryCompiler) unsafeBuiltinsMap() map[string]struct{} {",
      "2486:  if qc.unsafeBuiltins != nil {",
      "2487:   return qc.unsafeBuiltins",
      "2488:  }",
      "2489:  return qc.compiler.unsafeBuiltinsMap",
      "2490: }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2499: func (qc *queryCompiler) rewriteWithModifiers(_ *QueryContext, body Body) (Body, error) {",
      "2500:  f := newEqualityFactory(newLocalVarGenerator(\"q\", body))",
      "2502:  if err != nil {",
      "2503:   return nil, Errors{err}",
      "2504:  }",
      "",
      "[Removed Lines]",
      "2501:  body, err := rewriteWithModifiersInBody(qc.compiler, f, body)",
      "",
      "[Added Lines]",
      "2502:  body, err := rewriteWithModifiersInBody(qc.compiler, qc.unsafeBuiltinsMap(), f, body)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "4783:  var result Body",
      "4784:  for i := range body {",
      "4786:   if err != nil {",
      "4787:    return nil, err",
      "4788:   }",
      "",
      "[Removed Lines]",
      "4782: func rewriteWithModifiersInBody(c *Compiler, f *equalityFactory, body Body) (Body, *Error) {",
      "4785:   exprs, err := rewriteWithModifier(c, f, body[i])",
      "",
      "[Added Lines]",
      "4783: func rewriteWithModifiersInBody(c *Compiler, unsafeBuiltinsMap map[string]struct{}, f *equalityFactory, body Body) (Body, *Error) {",
      "4786:   exprs, err := rewriteWithModifier(c, unsafeBuiltinsMap, f, body[i])",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "4797:  return result, nil",
      "4798: }",
      "4802:  var result []*Expr",
      "4803:  for i := range expr.With {",
      "4805:   if err != nil {",
      "4806:    return nil, err",
      "4807:   }",
      "",
      "[Removed Lines]",
      "4800: func rewriteWithModifier(c *Compiler, f *equalityFactory, expr *Expr) ([]*Expr, *Error) {",
      "4804:   eval, err := validateWith(c, expr, i)",
      "",
      "[Added Lines]",
      "4801: func rewriteWithModifier(c *Compiler, unsafeBuiltinsMap map[string]struct{}, f *equalityFactory, expr *Expr) ([]*Expr, *Error) {",
      "4805:   eval, err := validateWith(c, unsafeBuiltinsMap, expr, i)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "4816:  return append(result, expr), nil",
      "4817: }",
      "4820:  target, value := expr.With[i].Target, expr.With[i].Value",
      "",
      "[Removed Lines]",
      "4819: func validateWith(c *Compiler, expr *Expr, i int) (bool, *Error) {",
      "",
      "[Added Lines]",
      "4820: func validateWith(c *Compiler, unsafeBuiltinsMap map[string]struct{}, expr *Expr, i int) (bool, *Error) {",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "4825:    value.Value = Ref([]*Term{NewTerm(v)})",
      "4826:   }",
      "4827:  }",
      "4829:  switch {",
      "4830:  case isDataRef(target):",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4829:  isBuiltinRefOrVar, err := isBuiltinRefOrVar(c.builtins, unsafeBuiltinsMap, target)",
      "4830:  if err != nil {",
      "4831:   return false, err",
      "4832:  }",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "4848:    if child := node.Child(ref[len(ref)-1].Value); child != nil {",
      "4849:     for _, v := range child.Values {",
      "4850:      if len(v.(*Rule).Head.Args) > 0 {",
      "4853:       }",
      "4854:      }",
      "4855:     }",
      "4856:    }",
      "4857:   }",
      "4858:  case isInputRef(target): // ok, valid",
      "",
      "[Removed Lines]",
      "4851:       if validateWithFunctionValue(c.builtins, c.RuleTree, value) {",
      "4852:        return false, nil",
      "4859:  case isBuiltinRefOrVar(c.builtins, target):",
      "",
      "[Added Lines]",
      "4856:       if ok, err := validateWithFunctionValue(c.builtins, unsafeBuiltinsMap, c.RuleTree, value); err != nil || ok {",
      "4857:        return false, err // may be nil",
      "4864:  case isBuiltinRefOrVar:",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "4870:    return false, err",
      "4871:   }",
      "4875:   }",
      "4876:  default:",
      "4877:   return false, NewError(TypeErr, target.Location, \"with keyword target must reference existing %v, %v, or a function\", InputRootDocument, DefaultRootDocument)",
      "",
      "[Removed Lines]",
      "4873:   if validateWithFunctionValue(c.builtins, c.RuleTree, value) {",
      "4874:    return false, nil",
      "",
      "[Added Lines]",
      "4878:   if ok, err := validateWithFunctionValue(c.builtins, unsafeBuiltinsMap, c.RuleTree, value); err != nil || ok {",
      "4879:    return false, err // may be nil",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "4900:  return nil",
      "4901: }",
      "4904:  if v, ok := value.Value.(Ref); ok {",
      "4905:   if ruleTree.Find(v) != nil { // ref exists in rule tree",
      "4907:   }",
      "4908:  }",
      "4910: }",
      "4912: func isInputRef(term *Term) bool {",
      "",
      "[Removed Lines]",
      "4903: func validateWithFunctionValue(bs map[string]*Builtin, ruleTree *TreeNode, value *Term) bool {",
      "4906:    return true",
      "4909:  return isBuiltinRefOrVar(bs, value)",
      "",
      "[Added Lines]",
      "4908: func validateWithFunctionValue(bs map[string]*Builtin, unsafeMap map[string]struct{}, ruleTree *TreeNode, value *Term) (bool, *Error) {",
      "4911:    return true, nil",
      "4914:  return isBuiltinRefOrVar(bs, unsafeMap, value)",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "4927:  return false",
      "4928: }",
      "4931:  switch v := term.Value.(type) {",
      "4932:  case Ref, Var:",
      "4933:   _, ok := bs[v.String()]",
      "4935:  }",
      "4937: }",
      "4939: func isVirtual(node *TreeNode, ref Ref) bool {",
      "",
      "[Removed Lines]",
      "4930: func isBuiltinRefOrVar(bs map[string]*Builtin, term *Term) bool {",
      "4934:   return ok",
      "4936:  return false",
      "",
      "[Added Lines]",
      "4935: func isBuiltinRefOrVar(bs map[string]*Builtin, unsafeBuiltinsMap map[string]struct{}, term *Term) (bool, *Error) {",
      "4938:   if _, ok := unsafeBuiltinsMap[v.String()]; ok {",
      "4939:    return false, NewError(CompileErr, term.Location, \"with keyword replacing built-in function: target must not be unsafe: %q\", v)",
      "4940:   }",
      "4942:   return ok, nil",
      "4944:  return false, nil",
      "",
      "---------------"
    ],
    "ast/compile_test.go||ast/compile_test.go": [
      "File: ast/compile_test.go -> ast/compile_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "3970:  tests := []struct {",
      "3971:   note         string",
      "3972:   input        string",
      "3973:   expected     string",
      "3974:   expectedRule *Rule",
      "3975:   wantErr      error",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3973:   opts         func(*Compiler) *Compiler",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "4075:     return r",
      "4076:    }(),",
      "4077:   },",
      "4078:   {",
      "4079:    note: \"built-in function: valid, arity 1, non-compound name\",",
      "4080:    input: `",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4079:   {",
      "4080:    note: \"built-in function: replaced by another built-in that's marked unsafe\",",
      "4081:    input: `",
      "4082:     q := is_object({\"url\": \"https://httpbin.org\", \"method\": \"GET\"})",
      "4083:     p { q with is_object as http.send }",
      "4084:    `,",
      "4085:    opts:    func(c *Compiler) *Compiler { return c.WithUnsafeBuiltins(map[string]struct{}{\"http.send\": {}}) },",
      "4086:    wantErr: fmt.Errorf(\"rego_compile_error: with keyword replacing built-in function: target must not be unsafe: \\\"http.send\\\"\"),",
      "4087:   },",
      "4088:   {",
      "4089:    note: \"non-built-in function: replaced by another built-in that's marked unsafe\",",
      "4090:    input: `",
      "4091:    r(_) = {}",
      "4092:    q := r({\"url\": \"https://httpbin.org\", \"method\": \"GET\"})",
      "4093:    p {",
      "4094:     q with r as http.send",
      "4095:    }`,",
      "4096:    opts:    func(c *Compiler) *Compiler { return c.WithUnsafeBuiltins(map[string]struct{}{\"http.send\": {}}) },",
      "4097:    wantErr: fmt.Errorf(\"rego_compile_error: with keyword replacing built-in function: target must not be unsafe: \\\"http.send\\\"\"),",
      "4098:   },",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "4092:  for _, tc := range tests {",
      "4093:   t.Run(tc.note, func(t *testing.T) {",
      "4094:    c := NewCompiler()",
      "4095:    module := fixture + tc.input",
      "4096:    c.Modules[\"test\"] = MustParseModule(module)",
      "4097:    compileStages(c, c.rewriteWithModifiers)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4116:    if tc.opts != nil {",
      "4117:     c = tc.opts(c)",
      "4118:    }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "6597: }",
      "6599: func TestQueryCompilerWithUnsafeBuiltins(t *testing.T) {",
      "6607:  }",
      "6608: }",
      "",
      "[Removed Lines]",
      "6600:  c := NewCompiler().WithUnsafeBuiltins(map[string]struct{}{",
      "6601:   \"count\": {},",
      "6602:  })",
      "6604:  _, err := c.QueryCompiler().WithUnsafeBuiltins(map[string]struct{}{}).Compile(MustParseBody(\"count([])\"))",
      "6605:  if err != nil {",
      "6606:   t.Fatal(err)",
      "",
      "[Added Lines]",
      "6624:  tests := []struct {",
      "6625:   note     string",
      "6626:   query    string",
      "6627:   compiler *Compiler",
      "6628:   opts     func(QueryCompiler) QueryCompiler",
      "6629:   err      string",
      "6630:  }{",
      "6631:   {",
      "6632:    note:     \"builtin unsafe via compiler\",",
      "6633:    query:    \"count([])\",",
      "6634:    compiler: NewCompiler().WithUnsafeBuiltins(map[string]struct{}{\"count\": {}}),",
      "6635:    err:      \"unsafe built-in function calls in expression: count\",",
      "6636:   },",
      "6637:   {",
      "6638:    note:     \"builtin unsafe via query compiler\",",
      "6639:    query:    \"count([])\",",
      "6640:    compiler: NewCompiler(),",
      "6641:    opts: func(qc QueryCompiler) QueryCompiler {",
      "6642:     return qc.WithUnsafeBuiltins(map[string]struct{}{\"count\": {}})",
      "6643:    },",
      "6644:    err: \"unsafe built-in function calls in expression: count\",",
      "6645:   },",
      "6646:   {",
      "6647:    note:     \"builtin unsafe via compiler, 'with' mocking\",",
      "6648:    query:    \"is_array([]) with is_array as count\",",
      "6649:    compiler: NewCompiler().WithUnsafeBuiltins(map[string]struct{}{\"count\": {}}),",
      "6650:    err:      `with keyword replacing built-in function: target must not be unsafe: \"count\"`,",
      "6651:   },",
      "6652:   {",
      "6653:    note:     \"builtin unsafe via query compiler,  'with' mocking\",",
      "6654:    query:    \"is_array([]) with is_array as count\",",
      "6655:    compiler: NewCompiler(),",
      "6656:    opts: func(qc QueryCompiler) QueryCompiler {",
      "6657:     return qc.WithUnsafeBuiltins(map[string]struct{}{\"count\": {}})",
      "6658:    },",
      "6659:    err: `with keyword replacing built-in function: target must not be unsafe: \"count\"`,",
      "6660:   },",
      "6661:  }",
      "6663:  for _, tc := range tests {",
      "6664:   t.Run(tc.note, func(t *testing.T) {",
      "6665:    qc := tc.compiler.QueryCompiler()",
      "6666:    if tc.opts != nil {",
      "6667:     qc = tc.opts(qc)",
      "6668:    }",
      "6669:    _, err := qc.Compile(MustParseBody(tc.query))",
      "6670:    var errs Errors",
      "6671:    if !errors.As(err, &errs) {",
      "6672:     t.Fatalf(\"expected error type %T, got %v %[2]T\", errs, err)",
      "6673:    }",
      "6674:    if exp, act := 1, len(errs); exp != act {",
      "6675:     t.Fatalf(\"expected %d error(s), got %d\", exp, act)",
      "6676:    }",
      "6677:    if exp, act := tc.err, errs[0].Message; exp != act {",
      "6678:     t.Errorf(\"expected message %q, got %q\", exp, act)",
      "6679:    }",
      "6680:   })",
      "",
      "---------------"
    ],
    "rego/rego_test.go||rego/rego_test.go": [
      "File: rego/rego_test.go -> rego/rego_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "1436:  ctx := context.Background()",
      "1438:  unsafeCountExpr := \"unsafe built-in function calls in expression: count\"",
      "1440:  t.Run(\"unsafe query\", func(t *testing.T) {",
      "1441:   r := New(",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1439:  unsafeCountExprWith := `with keyword replacing built-in function: target must not be unsafe: \"count\"`",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1447:   }",
      "1448:  })",
      "1450:  t.Run(\"unsafe module\", func(t *testing.T) {",
      "1451:   r := New(",
      "1452:    Query(`data.pkg.deny`),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1451:  t.Run(\"unsafe query, 'with' replacement\", func(t *testing.T) {",
      "1452:   r := New(",
      "1453:    Query(`is_array([1, 2, 3]) with is_array as count`),",
      "1454:    UnsafeBuiltins(map[string]struct{}{\"count\": {}}),",
      "1455:   )",
      "1456:   if _, err := r.Eval(ctx); err == nil || !strings.Contains(err.Error(), unsafeCountExprWith) {",
      "1457:    t.Fatalf(\"Expected unsafe built-in error but got %v\", err)",
      "1458:   }",
      "1459:  })",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1462:   }",
      "1463:  })",
      "1465:  t.Run(\"inherit in query\", func(t *testing.T) {",
      "1466:   r := New(",
      "1467:    Compiler(ast.NewCompiler().WithUnsafeBuiltins(map[string]struct{}{\"count\": {}})),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1476:  t.Run(\"unsafe module, 'with' replacement in query\", func(t *testing.T) {",
      "1477:   r := New(",
      "1478:    Query(`data.pkg.deny with is_array as count`),",
      "1479:    Module(\"pkg.rego\", `package pkg",
      "1480:    deny {",
      "1481:     is_array(input.requests) > 10",
      "1482:    }",
      "1483:    `),",
      "1484:    UnsafeBuiltins(map[string]struct{}{\"count\": {}}),",
      "1485:   )",
      "1486:   if _, err := r.Eval(ctx); err == nil || !strings.Contains(err.Error(), unsafeCountExprWith) {",
      "1487:    t.Fatalf(\"Expected unsafe built-in error but got %v\", err)",
      "1488:   }",
      "1489:  })",
      "1491:  t.Run(\"unsafe module, 'with' replacement in module\", func(t *testing.T) {",
      "1492:   r := New(",
      "1493:    Query(`data.pkg.deny`),",
      "1494:    Module(\"pkg.rego\", `package pkg",
      "1495:    deny {",
      "1496:     is_array(input.requests) > 10 with is_array as count",
      "1497:    }",
      "1498:    `),",
      "1499:    UnsafeBuiltins(map[string]struct{}{\"count\": {}}),",
      "1500:   )",
      "1501:   if _, err := r.Eval(ctx); err == nil || !strings.Contains(err.Error(), unsafeCountExprWith) {",
      "1502:    t.Fatalf(\"Expected unsafe built-in error but got %v\", err)",
      "1503:   }",
      "1504:  })",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1472:   }",
      "1473:  })",
      "1475:  t.Run(\"override/disable in query\", func(t *testing.T) {",
      "1476:   r := New(",
      "1477:    Compiler(ast.NewCompiler().WithUnsafeBuiltins(map[string]struct{}{\"count\": {}})),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1516:  t.Run(\"inherit in query, 'with' replacement\", func(t *testing.T) {",
      "1517:   r := New(",
      "1518:    Compiler(ast.NewCompiler().WithUnsafeBuiltins(map[string]struct{}{\"count\": {}})),",
      "1519:    Query(\"is_array([]) with is_array as count\"),",
      "1520:   )",
      "1521:   if _, err := r.Eval(ctx); err == nil || !strings.Contains(err.Error(), unsafeCountExprWith) {",
      "1522:    t.Fatalf(\"Expected unsafe built-in error but got %v\", err)",
      "1523:   }",
      "1524:  })",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "196c92df8b936e0b211b2d2ac767cbb89949060f",
      "candidate_info": {
        "commit_hash": "196c92df8b936e0b211b2d2ac767cbb89949060f",
        "repo": "open-policy-agent/opa",
        "commit_url": "https://github.com/open-policy-agent/opa/commit/196c92df8b936e0b211b2d2ac767cbb89949060f",
        "files": [
          "CHANGELOG.md",
          "builtin_metadata.json",
          "capabilities/v0.43.1.json",
          "version/version.go"
        ],
        "message": "Release v0.43.1\n\nSigned-off-by: Stephan Renatus <stephan.renatus@gmail.com>",
        "before_after_code_files": [
          "version/version.go||version/version.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/open-policy-agent/opa/pull/5101"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "version/version.go||version/version.go": [
          "File: version/version.go -> version/version.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: )",
          "16: var GoVersion = runtime.Version()",
          "",
          "[Removed Lines]",
          "13: var Version = \"0.43.0\"",
          "",
          "[Added Lines]",
          "13: var Version = \"0.43.1\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}