{
  "cve_id": "CVE-2023-30614",
  "cve_desc": "Pay is a payments engine for Ruby on Rails 6.0 and higher. In versions prior to 6.3.2 a payments info page of Pay is susceptible to reflected Cross-site scripting. An attacker could create a working URL that renders a javascript link to a user on a Rails application that integrates Pay. This URL could be distributed via email to specifically target certain individuals. If the targeted application contains a functionality to submit user-generated content (such as comments) the attacker could even distribute the URL using that functionality. This has been patched in version 6.3.2 and above. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "pay-rails/pay",
  "patch_hash": "5d6283a24062bd272a524ec48415f536a67ad57f",
  "patch_info": {
    "commit_hash": "5d6283a24062bd272a524ec48415f536a67ad57f",
    "repo": "pay-rails/pay",
    "commit_url": "https://github.com/pay-rails/pay/commit/5d6283a24062bd272a524ec48415f536a67ad57f",
    "files": [
      "CHANGELOG.md",
      "app/controllers/pay/payments_controller.rb",
      "app/views/pay/payments/show.html.erb"
    ],
    "message": "Fix XSS vulnerability on Stripe payment page",
    "before_after_code_files": [
      "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb",
      "app/views/pay/payments/show.html.erb||app/views/pay/payments/show.html.erb"
    ]
  },
  "patch_diff": {
    "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb": [
      "File: app/controllers/pay/payments_controller.rb -> app/controllers/pay/payments_controller.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "2:   class PaymentsController < ApplicationController",
      "3:     layout \"pay/application\"",
      "5:     def show",
      "7:       @payment = Payment.from_id(params[:id])",
      "8:     end",
      "9:   end",
      "10: end",
      "",
      "[Removed Lines]",
      "6:       @redirect_to = params[:back].presence || root_path",
      "",
      "[Added Lines]",
      "5:     before_action :set_redirect_to",
      "11:     private",
      "13:     # Ensure the back parameter is a valid path",
      "14:     # This safely handles XSS or external redirects",
      "15:     def set_redirect_to",
      "16:       @redirect_to = URI.parse(params[:back].to_s).path || root_path",
      "17:     end",
      "",
      "---------------"
    ],
    "app/views/pay/payments/show.html.erb||app/views/pay/payments/show.html.erb": [
      "File: app/views/pay/payments/show.html.erb -> app/views/pay/payments/show.html.erb",
      "--- Hunk 1 ---",
      "[Context before]",
      "54:         </div>",
      "55:       <% end %>",
      "58:     </div>",
      "60:     <p class=\"text-center text-gray-500 text-sm\">",
      "",
      "[Removed Lines]",
      "57:       <%= link_to t(\"pay.back\"), @redirect_to, class: \"inline-block w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-center text-gray-600 rounded-lg\" %>",
      "",
      "[Added Lines]",
      "57:       <%= sanitize link_to(t(\"pay.back\"), @redirect_to, class: \"inline-block w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-center text-gray-600 rounded-lg\") %>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "674840a0f0ed9de860a2b9d06570a098e4de5aa3",
      "candidate_info": {
        "commit_hash": "674840a0f0ed9de860a2b9d06570a098e4de5aa3",
        "repo": "pay-rails/pay",
        "commit_url": "https://github.com/pay-rails/pay/commit/674840a0f0ed9de860a2b9d06570a098e4de5aa3",
        "files": [
          "CHANGELOG.md",
          "Gemfile.lock",
          "app/controllers/pay/payments_controller.rb",
          "gemfiles/rails_6_1.gemfile.lock",
          "gemfiles/rails_7.gemfile.lock",
          "gemfiles/rails_main.gemfile.lock",
          "lib/pay/version.rb"
        ],
        "message": "Fix payments#show redirect_to fallback",
        "before_after_code_files": [
          "Gemfile.lock||Gemfile.lock",
          "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb",
          "gemfiles/rails_6_1.gemfile.lock||gemfiles/rails_6_1.gemfile.lock",
          "gemfiles/rails_7.gemfile.lock||gemfiles/rails_7.gemfile.lock",
          "gemfiles/rails_main.gemfile.lock||gemfiles/rails_main.gemfile.lock",
          "lib/pay/version.rb||lib/pay/version.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb"
          ],
          "candidate": [
            "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb"
          ]
        }
      },
      "candidate_diff": {
        "Gemfile.lock||Gemfile.lock": [
          "File: Gemfile.lock -> Gemfile.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: PATH",
          "20:   remote: .",
          "21:   specs:",
          "23:       rails (>= 6.0.0)",
          "25: GEM",
          "",
          "[Removed Lines]",
          "22:     pay (6.7.0)",
          "",
          "[Added Lines]",
          "22:     pay (6.7.1)",
          "",
          "---------------"
        ],
        "app/controllers/pay/payments_controller.rb||app/controllers/pay/payments_controller.rb": [
          "File: app/controllers/pay/payments_controller.rb -> app/controllers/pay/payments_controller.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "13:     # Ensure the back parameter is a valid path",
          "14:     # This safely handles XSS or external redirects",
          "15:     def set_redirect_to",
          "17:     end",
          "18:   end",
          "19: end",
          "",
          "[Removed Lines]",
          "16:       @redirect_to = URI.parse(params[:back].to_s).path || root_path",
          "",
          "[Added Lines]",
          "16:       @redirect_to = URI.parse(params[:back].to_s).path.presence || root_path",
          "",
          "---------------"
        ],
        "gemfiles/rails_6_1.gemfile.lock||gemfiles/rails_6_1.gemfile.lock": [
          "File: gemfiles/rails_6_1.gemfile.lock -> gemfiles/rails_6_1.gemfile.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: PATH",
          "20:   remote: ..",
          "21:   specs:",
          "23:       rails (>= 6.0.0)",
          "25: GEM",
          "",
          "[Removed Lines]",
          "22:     pay (6.7.0)",
          "",
          "[Added Lines]",
          "22:     pay (6.7.1)",
          "",
          "---------------"
        ],
        "gemfiles/rails_7.gemfile.lock||gemfiles/rails_7.gemfile.lock": [
          "File: gemfiles/rails_7.gemfile.lock -> gemfiles/rails_7.gemfile.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: PATH",
          "20:   remote: ..",
          "21:   specs:",
          "23:       rails (>= 6.0.0)",
          "25: GEM",
          "",
          "[Removed Lines]",
          "22:     pay (6.7.0)",
          "",
          "[Added Lines]",
          "22:     pay (6.7.1)",
          "",
          "---------------"
        ],
        "gemfiles/rails_main.gemfile.lock||gemfiles/rails_main.gemfile.lock": [
          "File: gemfiles/rails_main.gemfile.lock -> gemfiles/rails_main.gemfile.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "116: PATH",
          "117:   remote: ..",
          "118:   specs:",
          "120:       rails (>= 6.0.0)",
          "122: GEM",
          "",
          "[Removed Lines]",
          "119:     pay (6.7.0)",
          "",
          "[Added Lines]",
          "119:     pay (6.7.1)",
          "",
          "---------------"
        ],
        "lib/pay/version.rb||lib/pay/version.rb": [
          "File: lib/pay/version.rb -> lib/pay/version.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: module Pay",
          "3: end",
          "",
          "[Removed Lines]",
          "2:   VERSION = \"6.7.0\"",
          "",
          "[Added Lines]",
          "2:   VERSION = \"6.7.1\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}