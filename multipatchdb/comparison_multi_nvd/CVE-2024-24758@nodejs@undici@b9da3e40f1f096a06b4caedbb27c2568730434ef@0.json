{
  "cve_id": "CVE-2024-24758",
  "cve_desc": "Undici is an HTTP/1.1 client, written from scratch for Node.js. Undici already cleared Authorization headers on cross-origin redirects, but did not clear `Proxy-Authentication` headers. This issue has been patched in versions 5.28.3 and 6.6.1. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "nodejs/undici",
  "patch_hash": "b9da3e40f1f096a06b4caedbb27c2568730434ef",
  "patch_info": {
    "commit_hash": "b9da3e40f1f096a06b4caedbb27c2568730434ef",
    "repo": "nodejs/undici",
    "commit_url": "https://github.com/nodejs/undici/commit/b9da3e40f1f096a06b4caedbb27c2568730434ef",
    "files": [
      "lib/fetch/index.js",
      "test/fetch/redirect-cross-origin-header.js"
    ],
    "message": "Merge pull request from GHSA-3787-6prv-h9w3\n\nSigned-off-by: Matteo Collina <hello@matteocollina.com>",
    "before_after_code_files": [
      "lib/fetch/index.js||lib/fetch/index.js",
      "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js"
    ]
  },
  "patch_diff": {
    "lib/fetch/index.js||lib/fetch/index.js": [
      "File: lib/fetch/index.js -> lib/fetch/index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "1327:     request.headersList.delete('authorization', true)",
      "1330:     request.headersList.delete('cookie', true)",
      "1331:     request.headersList.delete('host', true)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1330:     request.headersList.delete('proxy-authorization', true)",
      "",
      "---------------"
    ],
    "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js": [
      "File: test/fetch/redirect-cross-origin-header.js -> test/fetch/redirect-cross-origin-header.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "7: const { fetch } = require('../..')",
      "9: test('Cross-origin redirects clear forbidden headers', async (t) => {",
      "12:   const server1 = createServer((req, res) => {",
      "13:     strictEqual(req.headers.cookie, undefined)",
      "14:     strictEqual(req.headers.authorization, undefined)",
      "16:     res.end('redirected')",
      "17:   }).listen(0)",
      "",
      "[Removed Lines]",
      "10:   const { strictEqual } = tspl(t, { plan: 5 })",
      "",
      "[Added Lines]",
      "10:   const { strictEqual } = tspl(t, { plan: 6 })",
      "15:     strictEqual(req.headers['proxy-authorization'], undefined)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "40:   const res = await fetch(`http://localhost:${server2.address().port}`, {",
      "41:     headers: {",
      "42:       Authorization: 'test',",
      "44:     }",
      "45:   })",
      "",
      "[Removed Lines]",
      "43:       Cookie: 'ddd=dddd'",
      "",
      "[Added Lines]",
      "44:       Cookie: 'ddd=dddd',",
      "45:       'Proxy-Authorization': 'test'",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d3aa574b1259c1d8d329a0f0f495ee82882b1458",
      "candidate_info": {
        "commit_hash": "d3aa574b1259c1d8d329a0f0f495ee82882b1458",
        "repo": "nodejs/undici",
        "commit_url": "https://github.com/nodejs/undici/commit/d3aa574b1259c1d8d329a0f0f495ee82882b1458",
        "files": [
          "lib/fetch/index.js",
          "test/fetch/redirect-cross-origin-header.js"
        ],
        "message": "Merge pull request from GHSA-3787-6prv-h9w3\n\nSigned-off-by: Matteo Collina <hello@matteocollina.com>",
        "before_after_code_files": [
          "lib/fetch/index.js||lib/fetch/index.js",
          "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/fetch/index.js||lib/fetch/index.js",
            "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js"
          ],
          "candidate": [
            "lib/fetch/index.js||lib/fetch/index.js",
            "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/fetch/index.js||lib/fetch/index.js": [
          "File: lib/fetch/index.js -> lib/fetch/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "1204:     request.headersList.delete('authorization')",
          "1207:     request.headersList.delete('cookie')",
          "1208:     request.headersList.delete('host')",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1207:     request.headersList.delete('proxy-authorization', true)",
          "",
          "---------------"
        ],
        "test/fetch/redirect-cross-origin-header.js||test/fetch/redirect-cross-origin-header.js": [
          "File: test/fetch/redirect-cross-origin-header.js -> test/fetch/redirect-cross-origin-header.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: const { fetch } = require('../..')",
          "8: test('Cross-origin redirects clear forbidden headers', async (t) => {",
          "11:   const server1 = createServer((req, res) => {",
          "12:     t.equal(req.headers.cookie, undefined)",
          "13:     t.equal(req.headers.authorization, undefined)",
          "15:     res.end('redirected')",
          "16:   }).listen(0)",
          "",
          "[Removed Lines]",
          "9:   t.plan(5)",
          "",
          "[Added Lines]",
          "9:   t.plan(6)",
          "14:     t.equal(req.headers['proxy-authorization'], undefined)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39:   const res = await fetch(`http://localhost:${server2.address().port}`, {",
          "40:     headers: {",
          "41:       Authorization: 'test',",
          "43:     }",
          "44:   })",
          "",
          "[Removed Lines]",
          "42:       Cookie: 'ddd=dddd'",
          "",
          "[Added Lines]",
          "43:       Cookie: 'ddd=dddd',",
          "44:       'Proxy-Authorization': 'test'",
          "",
          "---------------"
        ]
      }
    }
  ]
}