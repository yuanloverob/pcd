{
  "cve_id": "CVE-2023-22731",
  "cve_desc": "Shopware is an open source commerce platform based on Symfony Framework and Vue js. In a Twig environment **without the Sandbox extension**, it is possible to refer to PHP functions in twig filters like `map`, `filter`, `sort`. This allows a template to call any global PHP function and thus execute arbitrary code. The attacker must have access to a Twig environment in order to exploit this vulnerability. This problem has been fixed with 6.4.18.1 with an override of the specified filters until the integration of the Sandbox extension has been finished. Users are advised to upgrade. Users of major versions 6.1, 6.2, and 6.3 may also receive this fix via a plugin.\n",
  "repo": "shopware/platform",
  "patch_hash": "89d1ea154689cb6202e0d3a0ceeae0febb0c09e1",
  "patch_info": {
    "commit_hash": "89d1ea154689cb6202e0d3a0ceeae0febb0c09e1",
    "repo": "shopware/platform",
    "commit_url": "https://github.com/shopware/platform/commit/89d1ea154689cb6202e0d3a0ceeae0febb0c09e1",
    "files": [
      "changelog/_unreleased/2022-12-21-add-twig-filter-improvments.md",
      "config-schema.json",
      "phpstan-baseline.neon",
      "src/Core/Content/Seo/SeoUrlTwigFactory.php",
      "src/Core/Framework/Adapter/Twig/SecurityExtension.php",
      "src/Core/Framework/DependencyInjection/Configuration.php",
      "src/Core/Framework/DependencyInjection/services.xml",
      "src/Core/Framework/Resources/config/packages/shopware.yaml",
      "src/Core/Framework/Rule/ScriptRule.php",
      "src/Core/Framework/Script/Execution/ScriptExecutor.php",
      "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
    ],
    "message": "NEXT-24667 - Add twig improvements",
    "before_after_code_files": [
      "phpstan-baseline.neon||phpstan-baseline.neon",
      "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php",
      "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php",
      "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php",
      "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php",
      "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php",
      "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
    ]
  },
  "patch_diff": {
    "phpstan-baseline.neon||phpstan-baseline.neon": [
      "File: phpstan-baseline.neon -> phpstan-baseline.neon",
      "--- Hunk 1 ---",
      "[Context before]",
      "6875:    count: 1",
      "6876:    path: src/Core/Content/Seo/SeoUrlTemplate/TemplateGroup.php",
      "6883:   -",
      "6884:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Content\\\\\\\\Seo\\\\\\\\SeoUrlUpdater\\\\:\\\\:fetchLanguageChains\\\\(\\\\) has parameter \\\\$languages with no value type specified in iterable type array\\\\.$#\"",
      "",
      "[Removed Lines]",
      "6878:   -",
      "6879:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Content\\\\\\\\Seo\\\\\\\\SeoUrlTwigFactory\\\\:\\\\:createTwigEnvironment\\\\(\\\\) has parameter \\\\$twigExtensions with no value type specified in iterable type iterable\\\\.$#\"",
      "6880:    count: 1",
      "6881:    path: src/Core/Content/Seo/SeoUrlTwigFactory.php",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "16925:    count: 1",
      "16926:    path: src/Core/Framework/Rule/RuleConstraints.php",
      "16948:   -",
      "16949:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Framework\\\\\\\\Script\\\\\\\\Api\\\\\\\\ApiHook\\\\:\\\\:__construct\\\\(\\\\) has parameter \\\\$request with no value type specified in iterable type array\\\\.$#\"",
      "",
      "[Removed Lines]",
      "16928:   -",
      "16929:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Framework\\\\\\\\Rule\\\\\\\\ScriptRule\\\\:\\\\:render\\\\(\\\\) has parameter \\\\$context with no value type specified in iterable type array\\\\.$#\"",
      "16930:    count: 1",
      "16931:    path: src/Core/Framework/Rule/ScriptRule.php",
      "16933:   -",
      "16934:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Framework\\\\\\\\Rule\\\\\\\\ScriptRule\\\\:\\\\:setConstraints\\\\(\\\\) has parameter \\\\$constraints with no value type specified in iterable type array\\\\.$#\"",
      "16935:    count: 1",
      "16936:    path: src/Core/Framework/Rule/ScriptRule.php",
      "16938:   -",
      "16939:    message: \"#^Property Shopware\\\\\\\\Core\\\\\\\\Framework\\\\\\\\Rule\\\\\\\\ScriptRule\\\\:\\\\:\\\\$constraints type has no value type specified in iterable type array\\\\.$#\"",
      "16940:    count: 1",
      "16941:    path: src/Core/Framework/Rule/ScriptRule.php",
      "16943:   -",
      "16944:    message: \"#^Property Shopware\\\\\\\\Core\\\\\\\\Framework\\\\\\\\Rule\\\\\\\\ScriptRule\\\\:\\\\:\\\\$values type has no value type specified in iterable type array\\\\.$#\"",
      "16945:    count: 1",
      "16946:    path: src/Core/Framework/Rule/ScriptRule.php",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php": [
      "File: src/Core/Content/Seo/SeoUrlTwigFactory.php -> src/Core/Content/Seo/SeoUrlTwigFactory.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: use Cocur\\Slugify\\Bridge\\Twig\\SlugifyExtension;",
      "6: use Cocur\\Slugify\\SlugifyInterface;",
      "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
      "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
      "9: use Twig\\Environment;",
      "10: use Twig\\Extension\\EscaperExtension;",
      "11: use Twig\\Loader\\ArrayLoader;",
      "13: class SeoUrlTwigFactory",
      "14: {",
      "15:     public function createTwigEnvironment(SlugifyInterface $slugify, iterable $twigExtensions = []): Environment",
      "16:     {",
      "17:         $twig = new TwigEnvironment(new ArrayLoader());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
      "12: use Twig\\Extension\\ExtensionInterface;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "19:         $twig->enableStrictVariables();",
      "20:         $twig->addExtension(new SlugifyExtension($slugify));",
      "21:         $twig->addExtension(new PhpSyntaxExtension());",
      "24:         $coreExtension = $twig->getExtension(EscaperExtension::class);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27:         $twig->addExtension(new SecurityExtension([]));",
      "",
      "---------------"
    ],
    "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php": [
      "File: src/Core/Framework/Adapter/Twig/SecurityExtension.php -> src/Core/Framework/Adapter/Twig/SecurityExtension.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php declare(strict_types=1);",
      "3: namespace Shopware\\Core\\Framework\\Adapter\\Twig;",
      "5: use Twig\\Extension\\AbstractExtension;",
      "6: use Twig\\TwigFilter;",
      "11: class SecurityExtension extends AbstractExtension",
      "12: {",
      "16:     private array $allowedPHPFunctions;",
      "21:     public function __construct(array $allowedPHPFunctions)",
      "22:     {",
      "23:         $this->allowedPHPFunctions = $allowedPHPFunctions;",
      "24:     }",
      "29:     public function getFilters(): array",
      "30:     {",
      "31:         return [",
      "32:             new TwigFilter('map', [$this, 'map']),",
      "33:             new TwigFilter('reduce', [$this, 'reduce']),",
      "34:             new TwigFilter('filter', [$this, 'filter']),",
      "35:             new TwigFilter('sort', [$this, 'sort']),",
      "36:         ];",
      "37:     }",
      "45:     public function map(iterable $array, $function): array",
      "46:     {",
      "47:         if (\\is_string($function) && !\\in_array($function, $this->allowedPHPFunctions, true)) {",
      "48:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $function));",
      "49:         }",
      "51:         $result = [];",
      "52:         foreach ($array as $key => $value) {",
      "54:             $result[$key] = $function($value);",
      "55:         }",
      "57:         return $result;",
      "58:     }",
      "67:     public function reduce(iterable $array, $function, $initial = null)",
      "68:     {",
      "69:         if (\\is_string($function) && !\\in_array($function, $this->allowedPHPFunctions, true)) {",
      "70:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $function));",
      "71:         }",
      "73:         if (!\\is_array($array)) {",
      "74:             $array = iterator_to_array($array);",
      "75:         }",
      "78:         return array_reduce($array, $function, $initial);",
      "79:     }",
      "87:     public function filter(iterable $array, $arrow): iterable",
      "88:     {",
      "89:         if (\\is_string($arrow) && !\\in_array($arrow, $this->allowedPHPFunctions, true)) {",
      "90:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $arrow));",
      "91:         }",
      "93:         if (\\is_array($array)) {",
      "95:             return array_filter($array, $arrow, \\ARRAY_FILTER_USE_BOTH);",
      "96:         }",
      "99:         return new \\CallbackFilterIterator(new \\IteratorIterator($array), $arrow);",
      "100:     }",
      "108:     public function sort(iterable $array, $arrow = null): array",
      "109:     {",
      "110:         if (\\is_string($arrow) && !\\in_array($arrow, $this->allowedPHPFunctions, true)) {",
      "111:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $arrow));",
      "112:         }",
      "114:         if ($array instanceof \\Traversable) {",
      "115:             $array = iterator_to_array($array);",
      "116:         }",
      "118:         if ($arrow !== null) {",
      "120:             uasort($array, $arrow);",
      "121:         } else {",
      "122:             asort($array);",
      "123:         }",
      "125:         return $array;",
      "126:     }",
      "127: }",
      "",
      "---------------"
    ],
    "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php": [
      "File: src/Core/Framework/DependencyInjection/Configuration.php -> src/Core/Framework/DependencyInjection/Configuration.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39:                 ->append($this->createCacheSection())",
      "40:                 ->append($this->createHtmlSanitizerSection())",
      "41:                 ->append($this->createIncrementSection())",
      "42:             ->end();",
      "44:         return $treeBuilder;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "42:                 ->append($this->createTwigSection())",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "598:         return $rootNode;",
      "599:     }",
      "600: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "602:     private function createTwigSection(): ArrayNodeDefinition",
      "603:     {",
      "604:         $treeBuilder = new TreeBuilder('twig');",
      "606:         $rootNode = $treeBuilder->getRootNode();",
      "607:         $rootNode",
      "608:             ->children()",
      "609:                 ->arrayNode('allowed_php_functions')",
      "610:                     ->performNoDeepMerging()",
      "611:                     ->scalarPrototype()",
      "612:                 ->end()",
      "613:             ->end();",
      "615:         return $rootNode;",
      "616:     }",
      "",
      "---------------"
    ],
    "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php": [
      "File: src/Core/Framework/Rule/ScriptRule.php -> src/Core/Framework/Rule/ScriptRule.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\ComparisonExtension;",
      "6: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
      "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
      "8: use Shopware\\Core\\Framework\\App\\Event\\Hooks\\AppScriptConditionHook;",
      "9: use Shopware\\Core\\Framework\\Script\\Debugging\\Debug;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "79:             $twig->addExtension(new DebugExtension());",
      "80:         }",
      "82:         $hook = new AppScriptConditionHook($scope->getContext());",
      "84:         try {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "89:         $twig->addExtension(new SecurityExtension([]));",
      "",
      "---------------"
    ],
    "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php": [
      "File: src/Core/Framework/Script/Execution/ScriptExecutor.php -> src/Core/Framework/Script/Execution/ScriptExecutor.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: use Psr\\Log\\LoggerInterface;",
      "6: use Shopware\\Core\\DevOps\\Environment\\EnvironmentHelper;",
      "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
      "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
      "9: use Shopware\\Core\\Framework\\App\\Event\\Hooks\\AppLifecycleHook;",
      "10: use Shopware\\Core\\Framework\\Script\\Debugging\\Debug;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "162:         $twig->addExtension(new PhpSyntaxExtension());",
      "163:         $twig->addExtension($this->translationExtension);",
      "165:         if ($script->getTwigOptions()['debug'] ?? false) {",
      "166:             $twig->addExtension(new DebugExtension());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "165:         $twig->addExtension(new SecurityExtension([]));",
      "",
      "---------------"
    ],
    "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php": [
      "File: tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php -> tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php declare(strict_types=1);",
      "3: namespace Shopware\\Tests\\Unit\\Core\\Framework\\Adapter\\Twig;",
      "5: use PHPUnit\\Framework\\TestCase;",
      "6: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
      "7: use Twig\\Environment;",
      "8: use Twig\\Error\\RuntimeError;",
      "9: use Twig\\Loader\\ArrayLoader;",
      "15: class SecurityExtensionTest extends TestCase",
      "16: {",
      "17:     public function testMapNotAllowedFunction(): void",
      "18:     {",
      "19:         $this->expectException(RuntimeError::class);",
      "20:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(\"str_rot13\")|join }}');",
      "21:     }",
      "23:     public function testMapWithAllowedFunction(): void",
      "24:     {",
      "25:         static::assertSame('nop', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(\"str_rot13\")|join }}', ['str_rot13']));",
      "26:     }",
      "28:     public function testMapWithClosure(): void",
      "29:     {",
      "30:         static::assertSame('a-testb-testc-test', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(v => (v ~ \"-test\"))|join }}'));",
      "31:     }",
      "33:     public function testReduceNotAllowedFunction(): void",
      "34:     {",
      "35:         $this->expectException(RuntimeError::class);",
      "36:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|reduce(\"empty\")|join }}');",
      "37:     }",
      "39:     public function testReduceAllowedFunction(): void",
      "40:     {",
      "41:         static::assertSame('6', $this->runTwig('{{ [1 , 5]|reduce((a, b) => a + b)|json_encode|raw }}'));",
      "42:     }",
      "44:     public function testReduceOnIterator(): void",
      "45:     {",
      "46:         static::assertSame('3', $this->runTwig('{{ test|reduce((a, b) => a + b)|json_encode|raw }}', [], ['test' => new \\ArrayIterator([1, 2])]));",
      "47:     }",
      "49:     public function testFilterNotAllowedFunctionWithAllowedFunction(): void",
      "50:     {",
      "51:         $this->expectException(RuntimeError::class);",
      "52:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|filter(\"str_rot13\")|join }}');",
      "53:     }",
      "55:     public function testFilterClosure(): void",
      "56:     {",
      "57:         static::assertSame('a', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|filter(v => v == \"a\")|join }}'));",
      "58:     }",
      "60:     public function testFilterIteratorClosure(): void",
      "61:     {",
      "62:         static::assertSame(",
      "63:             'a',",
      "64:             $this->runTwig('{{ test|filter(v => v == \"a\")|join }}', [], ['test' => new \\ArrayIterator(['a', 'b', 'c'])])",
      "65:         );",
      "66:     }",
      "68:     public function testSortNotAllowedFunction(): void",
      "69:     {",
      "70:         $this->expectException(RuntimeError::class);",
      "71:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort(\"str_rot13\")|join }}');",
      "72:     }",
      "74:     public function testSortAllowedFunction(): void",
      "75:     {",
      "76:         set_error_handler(static function () {",
      "77:             return true;",
      "78:         });",
      "80:         static::assertSame('abc', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort(\"str_starts_with\")|join }}', ['str_starts_with']));",
      "82:         restore_error_handler();",
      "83:     }",
      "85:     public function testSortClosure(): void",
      "86:     {",
      "87:         static::assertSame('cba', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort((a, b) => b <=> a)|join }}'));",
      "88:     }",
      "90:     public function testSortIteratorClosure(): void",
      "91:     {",
      "92:         static::assertSame(",
      "93:             'cba',",
      "94:             $this->runTwig('{{ test|sort((a, b) => b <=> a)|join }}', [], ['test' => new \\ArrayIterator(['a', 'b', 'c'])])",
      "95:         );",
      "96:     }",
      "98:     public function testSortDefault(): void",
      "99:     {",
      "100:         static::assertSame(",
      "101:             '123',",
      "102:             $this->runTwig('{{ test|sort|join }}', [], ['test' => ['2', '3', '1']])",
      "103:         );",
      "104:     }",
      "110:     private function runTwig(string $template, array $allowedFunctions = [], array $variables = []): string",
      "111:     {",
      "112:         $twig = new Environment(new ArrayLoader([",
      "113:             'test' => $template,",
      "114:         ]));",
      "116:         $twig->addExtension(new SecurityExtension($allowedFunctions));",
      "118:         return $twig->render('test', $variables);",
      "119:     }",
      "120: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1c1ff8499563cf1ce976936d75a7b1c95f6038fc",
      "candidate_info": {
        "commit_hash": "1c1ff8499563cf1ce976936d75a7b1c95f6038fc",
        "repo": "shopware/platform",
        "commit_url": "https://github.com/shopware/platform/commit/1c1ff8499563cf1ce976936d75a7b1c95f6038fc",
        "files": [
          "changelog/_unreleased/2022-12-21-add-twig-filter-improvments.md",
          "config-schema.json",
          "phpstan-baseline.neon",
          "src/Core/Content/Seo/SeoUrlTwigFactory.php",
          "src/Core/Framework/Adapter/Twig/SecurityExtension.php",
          "src/Core/Framework/DependencyInjection/Configuration.php",
          "src/Core/Framework/DependencyInjection/services.xml",
          "src/Core/Framework/Resources/config/packages/shopware.yaml",
          "src/Core/Framework/Rule/ScriptRule.php",
          "src/Core/Framework/Script/Execution/ScriptExecutor.php",
          "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
        ],
        "message": "NEXT-24667 - Backport Twig changes",
        "before_after_code_files": [
          "phpstan-baseline.neon||phpstan-baseline.neon",
          "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php",
          "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php",
          "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php",
          "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php",
          "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php",
          "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "phpstan-baseline.neon||phpstan-baseline.neon",
            "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php",
            "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php",
            "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php",
            "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php",
            "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php",
            "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
          ],
          "candidate": [
            "phpstan-baseline.neon||phpstan-baseline.neon",
            "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php",
            "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php",
            "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php",
            "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php",
            "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php",
            "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php"
          ]
        }
      },
      "candidate_diff": {
        "phpstan-baseline.neon||phpstan-baseline.neon": [
          "File: phpstan-baseline.neon -> phpstan-baseline.neon",
          "--- Hunk 1 ---",
          "[Context before]",
          "4960:    count: 1",
          "4961:    path: src/Core/Content/Seo/SeoUrlTemplate/TemplateGroup.php",
          "4968:   -",
          "4969:    message: \"#^Cannot call method map\\\\(\\\\) on Shopware\\\\\\\\Core\\\\\\\\System\\\\\\\\SalesChannel\\\\\\\\Aggregate\\\\\\\\SalesChannelDomain\\\\\\\\SalesChannelDomainCollection\\\\|null\\\\.$#\"",
          "",
          "[Removed Lines]",
          "4963:   -",
          "4964:    message: \"#^Method Shopware\\\\\\\\Core\\\\\\\\Content\\\\\\\\Seo\\\\\\\\SeoUrlTwigFactory\\\\:\\\\:createTwigEnvironment\\\\(\\\\) has parameter \\\\$twigExtensions with no value type specified in iterable type iterable\\\\.$#\"",
          "4965:    count: 1",
          "4966:    path: src/Core/Content/Seo/SeoUrlTwigFactory.php",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/Core/Content/Seo/SeoUrlTwigFactory.php||src/Core/Content/Seo/SeoUrlTwigFactory.php": [
          "File: src/Core/Content/Seo/SeoUrlTwigFactory.php -> src/Core/Content/Seo/SeoUrlTwigFactory.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Cocur\\Slugify\\Bridge\\Twig\\SlugifyExtension;",
          "6: use Cocur\\Slugify\\SlugifyInterface;",
          "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
          "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
          "9: use Twig\\Environment;",
          "10: use Twig\\Extension\\EscaperExtension;",
          "11: use Twig\\Loader\\ArrayLoader;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
          "12: use Twig\\Extension\\ExtensionInterface;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "22:         $twig->enableStrictVariables();",
          "23:         $twig->addExtension(new SlugifyExtension($slugify));",
          "24:         $twig->addExtension(new PhpSyntaxExtension());",
          "27:         $coreExtension = $twig->getExtension(EscaperExtension::class);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30:         $twig->addExtension(new SecurityExtension([]));",
          "",
          "---------------"
        ],
        "src/Core/Framework/Adapter/Twig/SecurityExtension.php||src/Core/Framework/Adapter/Twig/SecurityExtension.php": [
          "File: src/Core/Framework/Adapter/Twig/SecurityExtension.php -> src/Core/Framework/Adapter/Twig/SecurityExtension.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php declare(strict_types=1);",
          "3: namespace Shopware\\Core\\Framework\\Adapter\\Twig;",
          "5: use Twig\\Extension\\AbstractExtension;",
          "6: use Twig\\TwigFilter;",
          "11: class SecurityExtension extends AbstractExtension",
          "12: {",
          "16:     public function __construct(private readonly array $allowedPHPFunctions)",
          "17:     {",
          "18:     }",
          "23:     public function getFilters(): array",
          "24:     {",
          "25:         return [",
          "26:             new TwigFilter('map', [$this, 'map']),",
          "27:             new TwigFilter('reduce', [$this, 'reduce']),",
          "28:             new TwigFilter('filter', [$this, 'filter']),",
          "29:             new TwigFilter('sort', [$this, 'sort']),",
          "30:         ];",
          "31:     }",
          "38:     public function map(iterable $array, string|callable|\\Closure $function): array",
          "39:     {",
          "40:         if (\\is_string($function) && !\\in_array($function, $this->allowedPHPFunctions, true)) {",
          "41:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $function));",
          "42:         }",
          "44:         $result = [];",
          "45:         foreach ($array as $key => $value) {",
          "47:             $result[$key] = $function($value);",
          "48:         }",
          "50:         return $result;",
          "51:     }",
          "56:     public function reduce(iterable $array, string|callable|\\Closure $function, mixed $initial = null): mixed",
          "57:     {",
          "58:         if (\\is_string($function) && !\\in_array($function, $this->allowedPHPFunctions, true)) {",
          "59:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $function));",
          "60:         }",
          "62:         if (!\\is_array($array)) {",
          "63:             $array = iterator_to_array($array);",
          "64:         }",
          "67:         return array_reduce($array, $function, $initial);",
          "68:     }",
          "75:     public function filter(iterable $array, string|callable|\\Closure $arrow): iterable",
          "76:     {",
          "77:         if (\\is_string($arrow) && !\\in_array($arrow, $this->allowedPHPFunctions, true)) {",
          "78:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $arrow));",
          "79:         }",
          "81:         if (\\is_array($array)) {",
          "83:             return array_filter($array, $arrow, \\ARRAY_FILTER_USE_BOTH);",
          "84:         }",
          "87:         return new \\CallbackFilterIterator(new \\IteratorIterator($array), $arrow);",
          "88:     }",
          "95:     public function sort(iterable $array, string|callable|\\Closure|null $arrow = null): array",
          "96:     {",
          "97:         if (\\is_string($arrow) && !\\in_array($arrow, $this->allowedPHPFunctions, true)) {",
          "98:             throw new \\RuntimeException(sprintf('Function \"%s\" is not allowed', $arrow));",
          "99:         }",
          "101:         if ($array instanceof \\Traversable) {",
          "102:             $array = iterator_to_array($array);",
          "103:         }",
          "105:         if ($arrow !== null) {",
          "107:             uasort($array, $arrow);",
          "108:         } else {",
          "109:             asort($array);",
          "110:         }",
          "112:         return $array;",
          "113:     }",
          "114: }",
          "",
          "---------------"
        ],
        "src/Core/Framework/DependencyInjection/Configuration.php||src/Core/Framework/DependencyInjection/Configuration.php": [
          "File: src/Core/Framework/DependencyInjection/Configuration.php -> src/Core/Framework/DependencyInjection/Configuration.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:                 ->append($this->createCacheSection())",
          "40:                 ->append($this->createHtmlSanitizerSection())",
          "41:                 ->append($this->createIncrementSection())",
          "42:             ->end();",
          "44:         return $treeBuilder;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42:                 ->append($this->createTwigSection())",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "608:         return $rootNode;",
          "609:     }",
          "610: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "612:     private function createTwigSection(): ArrayNodeDefinition",
          "613:     {",
          "614:         $treeBuilder = new TreeBuilder('twig');",
          "616:         $rootNode = $treeBuilder->getRootNode();",
          "617:         $rootNode",
          "618:             ->children()",
          "619:                 ->arrayNode('allowed_php_functions')",
          "620:                     ->performNoDeepMerging()",
          "621:                     ->scalarPrototype()",
          "622:                 ->end()",
          "623:             ->end();",
          "625:         return $rootNode;",
          "626:     }",
          "",
          "---------------"
        ],
        "src/Core/Framework/Rule/ScriptRule.php||src/Core/Framework/Rule/ScriptRule.php": [
          "File: src/Core/Framework/Rule/ScriptRule.php -> src/Core/Framework/Rule/ScriptRule.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\ComparisonExtension;",
          "6: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
          "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
          "8: use Shopware\\Core\\Framework\\App\\Event\\Hooks\\AppScriptConditionHook;",
          "9: use Shopware\\Core\\Framework\\Script\\Debugging\\Debug;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "91:             $twig->addExtension(new DebugExtension());",
          "92:         }",
          "94:         $hook = new AppScriptConditionHook($scope->getContext());",
          "96:         try {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:         $twig->addExtension(new SecurityExtension([]));",
          "",
          "---------------"
        ],
        "src/Core/Framework/Script/Execution/ScriptExecutor.php||src/Core/Framework/Script/Execution/ScriptExecutor.php": [
          "File: src/Core/Framework/Script/Execution/ScriptExecutor.php -> src/Core/Framework/Script/Execution/ScriptExecutor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use Psr\\Log\\LoggerInterface;",
          "6: use Shopware\\Core\\DevOps\\Environment\\EnvironmentHelper;",
          "7: use Shopware\\Core\\Framework\\Adapter\\Twig\\Extension\\PhpSyntaxExtension;",
          "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\TwigEnvironment;",
          "9: use Shopware\\Core\\Framework\\App\\Event\\Hooks\\AppLifecycleHook;",
          "10: use Shopware\\Core\\Framework\\Script\\Debugging\\Debug;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "162:         $twig->addExtension(new PhpSyntaxExtension());",
          "163:         $twig->addExtension($this->translationExtension);",
          "165:         if ($script->getTwigOptions()['debug'] ?? false) {",
          "166:             $twig->addExtension(new DebugExtension());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "165:         $twig->addExtension(new SecurityExtension([]));",
          "",
          "---------------"
        ],
        "tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php||tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php": [
          "File: tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php -> tests/unit/php/Core/Framework/Adapter/Twig/SecurityExtensionTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php declare(strict_types=1);",
          "3: namespace Shopware\\Tests\\Unit\\Core\\Framework\\Adapter\\Twig;",
          "5: use PHPUnit\\Framework\\TestCase;",
          "6: use Shopware\\Core\\Framework\\Adapter\\Twig\\SecurityExtension;",
          "7: use Twig\\Environment;",
          "8: use Twig\\Error\\RuntimeError;",
          "9: use Twig\\Loader\\ArrayLoader;",
          "15: class SecurityExtensionTest extends TestCase",
          "16: {",
          "17:     public function testMapNotAllowedFunction(): void",
          "18:     {",
          "19:         $this->expectException(RuntimeError::class);",
          "20:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(\"str_rot13\")|join }}');",
          "21:     }",
          "23:     public function testMapWithAllowedFunction(): void",
          "24:     {",
          "25:         static::assertSame('nop', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(\"str_rot13\")|join }}', ['str_rot13']));",
          "26:     }",
          "28:     public function testMapWithClosure(): void",
          "29:     {",
          "30:         static::assertSame('a-testb-testc-test', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|map(v => (v ~ \"-test\"))|join }}'));",
          "31:     }",
          "33:     public function testReduceNotAllowedFunction(): void",
          "34:     {",
          "35:         $this->expectException(RuntimeError::class);",
          "36:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|reduce(\"empty\")|join }}');",
          "37:     }",
          "39:     public function testReduceAllowedFunction(): void",
          "40:     {",
          "41:         static::assertSame('6', $this->runTwig('{{ [1 , 5]|reduce((a, b) => a + b)|json_encode|raw }}'));",
          "42:     }",
          "44:     public function testReduceOnIterator(): void",
          "45:     {",
          "46:         static::assertSame('3', $this->runTwig('{{ test|reduce((a, b) => a + b)|json_encode|raw }}', [], ['test' => new \\ArrayIterator([1, 2])]));",
          "47:     }",
          "49:     public function testFilterNotAllowedFunctionWithAllowedFunction(): void",
          "50:     {",
          "51:         $this->expectException(RuntimeError::class);",
          "52:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|filter(\"str_rot13\")|join }}');",
          "53:     }",
          "55:     public function testFilterClosure(): void",
          "56:     {",
          "57:         static::assertSame('a', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|filter(v => v == \"a\")|join }}'));",
          "58:     }",
          "60:     public function testFilterIteratorClosure(): void",
          "61:     {",
          "62:         static::assertSame(",
          "63:             'a',",
          "64:             $this->runTwig('{{ test|filter(v => v == \"a\")|join }}', [], ['test' => new \\ArrayIterator(['a', 'b', 'c'])])",
          "65:         );",
          "66:     }",
          "68:     public function testSortNotAllowedFunction(): void",
          "69:     {",
          "70:         $this->expectException(RuntimeError::class);",
          "71:         $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort(\"str_rot13\")|join }}');",
          "72:     }",
          "74:     public function testSortAllowedFunction(): void",
          "75:     {",
          "76:         set_error_handler(static function () {",
          "77:             return true;",
          "78:         });",
          "80:         static::assertSame('abc', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort(\"str_starts_with\")|join }}', ['str_starts_with']));",
          "82:         restore_error_handler();",
          "83:     }",
          "85:     public function testSortClosure(): void",
          "86:     {",
          "87:         static::assertSame('cba', $this->runTwig('{{ [\"a\", \"b\", \"c\"]|sort((a, b) => b <=> a)|join }}'));",
          "88:     }",
          "90:     public function testSortIteratorClosure(): void",
          "91:     {",
          "92:         static::assertSame(",
          "93:             'cba',",
          "94:             $this->runTwig('{{ test|sort((a, b) => b <=> a)|join }}', [], ['test' => new \\ArrayIterator(['a', 'b', 'c'])])",
          "95:         );",
          "96:     }",
          "98:     public function testSortDefault(): void",
          "99:     {",
          "100:         static::assertSame(",
          "101:             '123',",
          "102:             $this->runTwig('{{ test|sort|join }}', [], ['test' => ['2', '3', '1']])",
          "103:         );",
          "104:     }",
          "110:     private function runTwig(string $template, array $allowedFunctions = [], array $variables = []): string",
          "111:     {",
          "112:         $twig = new Environment(new ArrayLoader([",
          "113:             'test' => $template,",
          "114:         ]));",
          "116:         $twig->addExtension(new SecurityExtension($allowedFunctions));",
          "118:         return $twig->render('test', $variables);",
          "119:     }",
          "120: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}