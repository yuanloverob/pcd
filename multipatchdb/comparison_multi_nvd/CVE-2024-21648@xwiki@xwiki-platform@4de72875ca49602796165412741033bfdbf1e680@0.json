{
  "cve_id": "CVE-2024-21648",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. The rollback action is missing a right protection, a user can rollback to a previous version of the page to gain rights they don't have anymore. The problem has been patched in XWiki 14.10.17, 15.5.3 and 15.8-rc-1 by ensuring that the rights are checked before performing the rollback. ",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "4de72875ca49602796165412741033bfdbf1e680",
  "patch_info": {
    "commit_hash": "4de72875ca49602796165412741033bfdbf1e680",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/4de72875ca49602796165412741033bfdbf1e680",
    "files": [
      "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
      "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
      "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
    ],
    "message": "XWIKI-21257: Rollback is not triggering a UserUpdatingDocumentEvent\n\n  * Ensure that the rollback API properly calls the check method\n  * Back the changes in a unit test that check events triggered in\n    rollback",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
      "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
      "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
      "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java": [
      "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.test;",
      "22: import javax.inject.Inject;",
      "23: import javax.inject.Named;",
      "24: import javax.inject.Singleton;",
      "26: import org.apache.commons.lang3.StringUtils;",
      "27: import org.slf4j.Logger;",
      "28: import org.xwiki.component.annotation.Component;",
      "29: import org.xwiki.model.reference.DocumentReference;",
      "30: import org.xwiki.observation.AbstractEventListener;",
      "31: import org.xwiki.observation.event.Event;",
      "33: import com.xpn.xwiki.doc.XWikiDocument;",
      "34: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
      "44: @Component",
      "45: @Singleton",
      "46: @Named(CustomUserUpdatedDocumentEventListener.NAME)",
      "47: public class CustomUserUpdatedDocumentEventListener extends AbstractEventListener",
      "48: {",
      "49:     static final String NAME = \"CustomUserUpdatedDocumentEventListener\";",
      "51:     @Inject",
      "52:     private Logger logger;",
      "57:     public CustomUserUpdatedDocumentEventListener()",
      "58:     {",
      "59:         super(NAME, new UserUpdatingDocumentEvent());",
      "60:     }",
      "62:     @Override",
      "63:     public void onEvent(Event event, Object source, Object data)",
      "64:     {",
      "65:         UserUpdatingDocumentEvent userEvent = (UserUpdatingDocumentEvent) event;",
      "66:         XWikiDocument sourceDoc = (XWikiDocument) source;",
      "67:         DocumentReference expectedReference = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
      "68:         if (StringUtils.equals(userEvent.getUserReference().getName(), \"DeleteVersionTestUserCancelEvent\")",
      "69:             && sourceDoc.getDocumentReference().equals(expectedReference)) {",
      "70:             logger.info(\"Cancelling user event on purpose\");",
      "71:             userEvent.cancel();",
      "72:         }",
      "73:     }",
      "74: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java": [
      "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: package org.xwiki.flamingo.test.docker;",
      "22: import org.junit.jupiter.api.BeforeAll;",
      "23: import org.junit.jupiter.api.Order;",
      "24: import org.junit.jupiter.api.Test;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: import java.util.List;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "26: import org.xwiki.flamingo.skin.test.po.AttachmentsPane;",
      "27: import org.xwiki.flamingo.skin.test.po.AttachmentsViewPage;",
      "28: import org.xwiki.model.reference.AttachmentReference;",
      "29: import org.xwiki.rest.model.jaxb.Page;",
      "30: import org.xwiki.test.docker.junit5.TestReference;",
      "31: import org.xwiki.test.docker.junit5.UITest;",
      "32: import org.xwiki.test.ui.TestUtils;",
      "33: import org.xwiki.test.ui.po.HistoryPane;",
      "34: import org.xwiki.test.ui.po.ViewPage;",
      "35: import org.xwiki.test.ui.po.editor.WikiEditPage;",
      "37: import static org.hamcrest.MatcherAssert.assertThat;",
      "38: import static org.hamcrest.Matchers.startsWith;",
      "39: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "40: import static org.junit.jupiter.api.Assertions.assertTrue;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "31: import org.xwiki.model.reference.DocumentReference;",
      "38: import org.xwiki.test.ui.po.editor.ObjectEditPage;",
      "39: import org.xwiki.test.ui.po.editor.ObjectEditPane;",
      "45: import static org.junit.jupiter.api.Assertions.assertFalse;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "321:         assertEquals(\"1.1\", page.getVersion());",
      "322:         assertEquals(\"1.1\", page.getContent());",
      "323:     }",
      "324: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "338:     @Test",
      "339:     @Order(7)",
      "340:     void testRollbackDontMessUpRights(TestUtils setup, TestReference testReference) throws Exception",
      "341:     {",
      "342:         setup.loginAsSuperAdmin();",
      "343:         setup.rest().delete(testReference);",
      "344:         String rollbackTestUser = \"RollbackTestUser\";",
      "345:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", rollbackTestUser));",
      "346:         setup.createUser(rollbackTestUser, rollbackTestUser, \"\");",
      "347:         setup.createPage(testReference, \"Test Rollback Page\");",
      "349:         setup.setRights(testReference, \"\", \"XWiki.\" + rollbackTestUser, \"script\", true);",
      "352:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
      "353:         ObjectEditPage objectEditPage = new ObjectEditPage();",
      "354:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
      "355:         assertEquals(1, rightObjects.size());",
      "356:         ObjectEditPane objectEditPane = rightObjects.get(0);",
      "357:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
      "358:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
      "359:         assertEquals(\"1\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
      "360:         objectEditPane.setFieldValue(objectEditPane.byPropertyName(\"allow\"), \"0\");",
      "362:         objectEditPage.clickSaveAndContinue();",
      "363:         setup.gotoPage(testReference);",
      "365:         setup.login(rollbackTestUser, rollbackTestUser);",
      "368:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
      "369:         objectEditPage = new ObjectEditPage();",
      "370:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
      "371:         assertEquals(1, rightObjects.size());",
      "372:         objectEditPane = rightObjects.get(0);",
      "373:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
      "374:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
      "375:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
      "377:         ViewPage viewPage = objectEditPage.clickCancel();",
      "378:         HistoryPane historyPane = viewPage.openHistoryDocExtraPane();",
      "379:         historyPane = historyPane.showMinorEdits();",
      "382:         assertEquals(3, historyPane.getNumberOfVersions());",
      "383:         assertEquals(\"2.2\", historyPane.getCurrentVersion());",
      "384:         assertTrue(historyPane.hasVersion(\"2.1\"));",
      "386:         viewPage = historyPane.rollbackToVersion(\"2.1\");",
      "387:         historyPane = viewPage.openHistoryDocExtraPane();",
      "388:         historyPane = historyPane.showMinorEdits();",
      "391:         assertEquals(4, historyPane.getNumberOfVersions());",
      "393:         assertEquals(\"3.1\", historyPane.getCurrentVersion());",
      "394:         assertEquals(\"Rollback to version 2.1\", historyPane.getCurrentVersionComment());",
      "395:         assertTrue(historyPane.hasVersion(\"2.2\"));",
      "396:         assertTrue(historyPane.hasVersion(\"2.1\"));",
      "399:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
      "400:         objectEditPage = new ObjectEditPage();",
      "401:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
      "402:         assertEquals(1, rightObjects.size());",
      "403:         objectEditPane = rightObjects.get(0);",
      "404:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
      "405:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
      "406:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
      "408:         objectEditPage.clickCancel();",
      "409:     }",
      "420:     @Test",
      "421:     @Order(8)",
      "422:     void testDeleteVersionDontMessUpRights(TestUtils setup) throws Exception",
      "423:     {",
      "424:         setup.loginAsSuperAdmin();",
      "426:         String deleteVersionTestUser = \"DeleteVersionTestUser\";",
      "427:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
      "428:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
      "430:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
      "432:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
      "433:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "434:         HistoryPane historyPane = new HistoryPane();",
      "435:         historyPane = historyPane.showMinorEdits();",
      "437:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
      "438:         int numberOfVersions = historyPane.getNumberOfVersions();",
      "441:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
      "442:         WikiEditPage wikiEditPage = new WikiEditPage();",
      "443:         wikiEditPage.clickSaveAndView();",
      "445:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "446:         historyPane = new HistoryPane();",
      "448:         String startChangesVersion = historyPane.getCurrentVersion();",
      "450:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
      "452:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
      "453:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
      "456:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "457:         ObjectEditPage objectEditPage = new ObjectEditPage();",
      "458:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "459:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
      "460:         rightObject.displayObject();",
      "461:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "462:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "463:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "465:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
      "467:         objectEditPage.clickSaveAndContinue();",
      "469:         setup.gotoPage(xwikiPreferences);",
      "471:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
      "474:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "475:         objectEditPage = new ObjectEditPage();",
      "476:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "477:         rightObject = rightObjects.get(rightObjects.size() - 1);",
      "478:         rightObject.displayObject();",
      "479:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "480:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "481:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "483:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "484:         historyPane = new HistoryPane();",
      "485:         historyPane = historyPane.showMinorEdits();",
      "486:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
      "487:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
      "488:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
      "490:         try {",
      "491:             historyPane = historyPane.deleteVersion(historyPane.getCurrentVersion());",
      "492:             historyPane = historyPane.showMinorEdits();",
      "493:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
      "494:             assertEquals(currentMajor + \".1\", historyPane.getCurrentVersion());",
      "497:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "498:             objectEditPage = new ObjectEditPage();",
      "499:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "500:             rightObject = rightObjects.get(rightObjects.size() - 1);",
      "501:             rightObject.displayObject();",
      "502:             assertEquals(deleteVersionTestUser,",
      "503:                 rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "504:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "505:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "506:             objectEditPage.clickCancel();",
      "507:         } finally {",
      "509:             setup.loginAsSuperAdmin();",
      "510:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "511:             historyPane = new HistoryPane();",
      "512:             historyPane = historyPane.showMinorEdits();",
      "513:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
      "514:         }",
      "515:     }",
      "523:     @Test",
      "524:     @Order(9)",
      "525:     void testDeleteVersionDontMessUpRightsWithCancellingEvent(TestUtils setup)",
      "526:         throws Exception",
      "527:     {",
      "528:         setup.loginAsSuperAdmin();",
      "530:         String deleteVersionTestUser = \"DeleteVersionTestUserCancelEvent\";",
      "531:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
      "532:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
      "534:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
      "536:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
      "537:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "538:         HistoryPane historyPane = new HistoryPane();",
      "539:         historyPane = historyPane.showMinorEdits();",
      "541:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
      "542:         int numberOfVersions = historyPane.getNumberOfVersions();",
      "545:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
      "546:         WikiEditPage wikiEditPage = new WikiEditPage();",
      "547:         wikiEditPage.clickSaveAndView();",
      "549:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "550:         historyPane = new HistoryPane();",
      "552:         String startChangesVersion = historyPane.getCurrentVersion();",
      "554:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
      "556:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
      "557:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
      "560:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "561:         ObjectEditPage objectEditPage = new ObjectEditPage();",
      "562:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "563:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
      "564:         rightObject.displayObject();",
      "565:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "566:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "567:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "569:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
      "571:         objectEditPage.clickSaveAndContinue();",
      "573:         setup.gotoPage(xwikiPreferences);",
      "575:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
      "578:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "579:         objectEditPage = new ObjectEditPage();",
      "580:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "581:         rightObject = rightObjects.get(rightObjects.size() - 1);",
      "582:         rightObject.displayObject();",
      "583:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "584:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "585:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "587:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "588:         historyPane = new HistoryPane();",
      "589:         historyPane = historyPane.showMinorEdits();",
      "590:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
      "591:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
      "592:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
      "594:         try {",
      "595:             historyPane.deleteVersion(historyPane.getCurrentVersion());",
      "597:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "598:             historyPane = new HistoryPane();",
      "599:             historyPane = historyPane.showMinorEdits();",
      "603:             assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
      "604:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
      "607:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "608:             objectEditPage = new ObjectEditPage();",
      "609:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "610:             rightObject = rightObjects.get(rightObjects.size() - 1);",
      "611:             rightObject.displayObject();",
      "612:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "613:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "614:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "615:             objectEditPage.clickCancel();",
      "617:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "618:             historyPane = new HistoryPane();",
      "619:             historyPane = historyPane.showMinorEdits();",
      "622:             historyPane = historyPane.deleteVersion(currentMajor + \".1\");",
      "623:             historyPane = historyPane.showMinorEdits();",
      "625:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
      "626:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
      "627:             assertFalse(historyPane.hasVersion(currentMajor + \".1\"));",
      "630:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
      "631:             objectEditPage = new ObjectEditPage();",
      "632:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
      "633:             rightObject = rightObjects.get(rightObjects.size() - 1);",
      "634:             rightObject.displayObject();",
      "635:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
      "636:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
      "637:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
      "638:             objectEditPage.clickCancel();",
      "639:         } finally {",
      "641:             setup.loginAsSuperAdmin();",
      "642:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
      "643:             historyPane = new HistoryPane();",
      "644:             historyPane = historyPane.showMinorEdits();",
      "645:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
      "646:         }",
      "647:     }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "4709:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2, XWikiContext context)",
      "4710:         throws XWikiException",
      "4711:     {",
      "4712:         Version v1 = new Version(version1);",
      "4713:         Version v2 = new Version(version2);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4711:     {",
      "4712:         deleteDocumentVersions(document, version1, version2, false, context);",
      "4713:     }",
      "4729:     @Unstable",
      "4730:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2,",
      "4731:         boolean triggeredByUser, XWikiContext context) throws XWikiException",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "4750:                 .notify(new DocumentVersionRangeDeletingEvent(document.getDocumentReferenceWithLocale(),",
      "4751:                     lowerBound.toString(), upperBound.toString()), document, context);",
      "4762:             Version previousVersion = archive.getLatestVersion();",
      "4763:             if (!document.getRCSVersion().equals(previousVersion)) {",
      "4765:             }",
      "4768:             getObservationManager()",
      "4769:                 .notify(new DocumentVersionRangeDeletedEvent(document.getDocumentReferenceWithLocale(),",
      "",
      "[Removed Lines]",
      "4754:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
      "4756:             XWikiDocument cachedDocument =",
      "4757:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
      "4758:             cachedDocument.setDocumentArchive(archive);",
      "4764:                 context.getWiki().rollback(document, previousVersion.toString(), false, context);",
      "",
      "[Added Lines]",
      "4780:                 context.getWiki().rollback(document, previousVersion.toString(), false, triggeredByUser, context);",
      "4784:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
      "4786:             XWikiDocument cachedDocument =",
      "4787:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
      "4788:             cachedDocument.setDocumentArchive(archive);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "7570:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision, XWikiContext xcontext)",
      "7571:         throws XWikiException",
      "7572:     {",
      "7573:         LOGGER.debug(\"Rolling back [{}] to version [{}]\", tdoc, rev);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7595:     {",
      "7596:         return rollback(tdoc, rev, addRevision, false, xcontext);",
      "7597:     }",
      "7611:     @Unstable",
      "7612:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision,",
      "7613:         boolean triggeredByUser, XWikiContext xcontext) throws XWikiException",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "7647:             message = localizePlainOrKey(\"core.comment.rollback\", rev);",
      "7648:         }",
      "7650:         ObservationManager om = getObservationManager();",
      "7651:         if (om != null) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7692:         if (triggeredByUser) {",
      "7693:             checkSavingDocument(xcontext.getUserReference(), document, message, false, xcontext);",
      "7694:         }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "65:         Version v2 = versions[1];",
      "67:         if (v1 != null && v2 != null) {",
      "69:         }",
      "71:         sendRedirect(context);",
      "",
      "[Removed Lines]",
      "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), context);",
      "",
      "[Added Lines]",
      "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), true, context);",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "79:         }",
      "85:         String redirect = Utils.getRedirect(\"view\", context);",
      "",
      "[Removed Lines]",
      "82:         xwiki.rollback(tdoc, rev, context);",
      "",
      "[Added Lines]",
      "82:         xwiki.rollback(tdoc, rev, true, true, context);",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java": [
      "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "73: import com.xpn.xwiki.doc.XWikiDocument;",
      "74: import com.xpn.xwiki.internal.ReadOnlyXWikiContextProvider;",
      "75: import com.xpn.xwiki.internal.debug.DebugConfiguration;",
      "76: import com.xpn.xwiki.internal.render.groovy.ParseGroovyFromString;",
      "77: import com.xpn.xwiki.internal.skin.InternalSkinManager;",
      "78: import com.xpn.xwiki.internal.store.StoreConfiguration;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "76: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "236:         XWikiDocument result = mock(XWikiDocument.class);",
      "237:         when(result.getDocumentReference()).thenReturn(documentReference);",
      "239:         String revision = \"3.5\";",
      "240:         when(this.documentRevisionProvider.getRevision(document, revision)).thenReturn(result);",
      "242:         this.componentManager.registerMockComponent(ContextualLocalizationManager.class);",
      "246:         verify(observationManager).notify(new DocumentRollingBackEvent(documentReference, revision), document, context);",
      "247:         verify(observationManager).notify(new DocumentUpdatingEvent(documentReference), document, context);",
      "248:         verify(observationManager).notify(new DocumentUpdatedEvent(documentReference), document, context);",
      "249:         verify(observationManager).notify(new DocumentRolledBackEvent(documentReference, revision), document, context);",
      "250:     }",
      "252:     @Test",
      "",
      "[Removed Lines]",
      "244:         xwiki.rollback(document, revision, context);",
      "",
      "[Added Lines]",
      "240:         DocumentReference userReference = new DocumentReference(\"xwiki\", \"XWiki\", \"ContextUser\");",
      "241:         this.context.setUserReference(userReference);",
      "248:         xwiki.rollback(document, revision, true, true, context);",
      "254:         verify(observationManager).notify(new UserUpdatingDocumentEvent(userReference, documentReference),",
      "255:             document, context);",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java": [
      "File: xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java -> xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "183:         getDriver().findElementWithoutWaiting(pane, By.xpath(\".//input[@accesskey = 'c']\")).click();",
      "184:         return new ComparePage();",
      "185:     }",
      "186: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "193:     public int getNumberOfVersions()",
      "194:     {",
      "195:         String xpath = \".//div[@class='paginationFilter' and following-sibling::div[@id='historycontent']]\";",
      "196:         WebElement paginationDiv = getDriver().findElementWithoutWaiting(By.xpath(xpath));",
      "197:         return Integer.parseInt(getDriver().findElementWithoutWaiting(paginationDiv, By.className(\"totalResultsNo\"))",
      "198:             .getText());",
      "199:     }",
      "207:     public boolean hasVersion(String version)",
      "208:     {",
      "209:         String xpath = String.format(\".//table//tr[contains(., '%s')]\", version);",
      "210:         return getDriver().hasElementWithoutWaiting(pane, By.xpath(xpath));",
      "211:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4fa7f302b14da6f05a6904a14e3741c4c06c40a1",
      "candidate_info": {
        "commit_hash": "4fa7f302b14da6f05a6904a14e3741c4c06c40a1",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/4fa7f302b14da6f05a6904a14e3741c4c06c40a1",
        "files": [
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/resources/META-INF/components.txt",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
        ],
        "message": "XWIKI-21257: Rollback is not triggering a UserUpdatingDocumentEvent\n\n  * Ensure that the rollback API properly calls the check method\n  * Back the changes in a unit test that check events triggered in\n    rollback\n\n(cherry picked from commit 4de72875ca49602796165412741033bfdbf1e680)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
            "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
            "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java": [
          "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.test;",
          "22: import javax.inject.Inject;",
          "23: import javax.inject.Named;",
          "24: import javax.inject.Singleton;",
          "26: import org.apache.commons.lang3.StringUtils;",
          "27: import org.slf4j.Logger;",
          "28: import org.xwiki.component.annotation.Component;",
          "29: import org.xwiki.model.reference.DocumentReference;",
          "30: import org.xwiki.observation.AbstractEventListener;",
          "31: import org.xwiki.observation.event.Event;",
          "33: import com.xpn.xwiki.doc.XWikiDocument;",
          "34: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
          "44: @Component",
          "45: @Singleton",
          "46: @Named(CustomUserUpdatedDocumentEventListener.NAME)",
          "47: public class CustomUserUpdatedDocumentEventListener extends AbstractEventListener",
          "48: {",
          "49:     static final String NAME = \"CustomUserUpdatedDocumentEventListener\";",
          "51:     @Inject",
          "52:     private Logger logger;",
          "57:     public CustomUserUpdatedDocumentEventListener()",
          "58:     {",
          "59:         super(NAME, new UserUpdatingDocumentEvent());",
          "60:     }",
          "62:     @Override",
          "63:     public void onEvent(Event event, Object source, Object data)",
          "64:     {",
          "65:         UserUpdatingDocumentEvent userEvent = (UserUpdatingDocumentEvent) event;",
          "66:         XWikiDocument sourceDoc = (XWikiDocument) source;",
          "67:         DocumentReference expectedReference = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "68:         if (StringUtils.equals(userEvent.getUserReference().getName(), \"DeleteVersionTestUserCancelEvent\")",
          "69:             && sourceDoc.getDocumentReference().equals(expectedReference)) {",
          "70:             logger.info(\"Cancelling user event on purpose\");",
          "71:             userEvent.cancel();",
          "72:         }",
          "73:     }",
          "74: }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java": [
          "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.flamingo.test.docker;",
          "22: import org.junit.jupiter.api.BeforeAll;",
          "23: import org.junit.jupiter.api.Order;",
          "24: import org.junit.jupiter.api.Test;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.List;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "26: import org.xwiki.flamingo.skin.test.po.AttachmentsPane;",
          "27: import org.xwiki.flamingo.skin.test.po.AttachmentsViewPage;",
          "28: import org.xwiki.model.reference.AttachmentReference;",
          "29: import org.xwiki.rest.model.jaxb.Page;",
          "30: import org.xwiki.test.docker.junit5.TestReference;",
          "31: import org.xwiki.test.docker.junit5.UITest;",
          "32: import org.xwiki.test.ui.TestUtils;",
          "33: import org.xwiki.test.ui.po.HistoryPane;",
          "34: import org.xwiki.test.ui.po.ViewPage;",
          "35: import org.xwiki.test.ui.po.editor.WikiEditPage;",
          "37: import static org.hamcrest.MatcherAssert.assertThat;",
          "38: import static org.hamcrest.Matchers.startsWith;",
          "39: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "40: import static org.junit.jupiter.api.Assertions.assertTrue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: import org.xwiki.model.reference.DocumentReference;",
          "38: import org.xwiki.test.ui.po.editor.ObjectEditPage;",
          "39: import org.xwiki.test.ui.po.editor.ObjectEditPane;",
          "45: import static org.junit.jupiter.api.Assertions.assertFalse;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "321:         assertEquals(\"1.1\", page.getVersion());",
          "322:         assertEquals(\"1.1\", page.getContent());",
          "323:     }",
          "324: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "338:     @Test",
          "339:     @Order(7)",
          "340:     void testRollbackDontMessUpRights(TestUtils setup, TestReference testReference) throws Exception",
          "341:     {",
          "342:         setup.loginAsSuperAdmin();",
          "343:         setup.rest().delete(testReference);",
          "344:         String rollbackTestUser = \"RollbackTestUser\";",
          "345:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", rollbackTestUser));",
          "346:         setup.createUser(rollbackTestUser, rollbackTestUser, \"\");",
          "347:         setup.createPage(testReference, \"Test Rollback Page\");",
          "349:         setup.setRights(testReference, \"\", \"XWiki.\" + rollbackTestUser, \"script\", true);",
          "352:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "353:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "354:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "355:         assertEquals(1, rightObjects.size());",
          "356:         ObjectEditPane objectEditPane = rightObjects.get(0);",
          "357:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "358:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "359:         assertEquals(\"1\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "360:         objectEditPane.setFieldValue(objectEditPane.byPropertyName(\"allow\"), \"0\");",
          "362:         objectEditPage.clickSaveAndContinue();",
          "363:         setup.gotoPage(testReference);",
          "365:         setup.login(rollbackTestUser, rollbackTestUser);",
          "368:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "369:         objectEditPage = new ObjectEditPage();",
          "370:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "371:         assertEquals(1, rightObjects.size());",
          "372:         objectEditPane = rightObjects.get(0);",
          "373:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "374:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "375:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "377:         ViewPage viewPage = objectEditPage.clickCancel();",
          "378:         HistoryPane historyPane = viewPage.openHistoryDocExtraPane();",
          "379:         historyPane = historyPane.showMinorEdits();",
          "382:         assertEquals(3, historyPane.getNumberOfVersions());",
          "383:         assertEquals(\"2.2\", historyPane.getCurrentVersion());",
          "384:         assertTrue(historyPane.hasVersion(\"2.1\"));",
          "386:         viewPage = historyPane.rollbackToVersion(\"2.1\");",
          "387:         historyPane = viewPage.openHistoryDocExtraPane();",
          "388:         historyPane = historyPane.showMinorEdits();",
          "391:         assertEquals(4, historyPane.getNumberOfVersions());",
          "393:         assertEquals(\"3.1\", historyPane.getCurrentVersion());",
          "394:         assertEquals(\"Rollback to version 2.1\", historyPane.getCurrentVersionComment());",
          "395:         assertTrue(historyPane.hasVersion(\"2.2\"));",
          "396:         assertTrue(historyPane.hasVersion(\"2.1\"));",
          "399:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "400:         objectEditPage = new ObjectEditPage();",
          "401:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "402:         assertEquals(1, rightObjects.size());",
          "403:         objectEditPane = rightObjects.get(0);",
          "404:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "405:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "406:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "408:         objectEditPage.clickCancel();",
          "409:     }",
          "420:     @Test",
          "421:     @Order(8)",
          "422:     void testDeleteVersionDontMessUpRights(TestUtils setup) throws Exception",
          "423:     {",
          "424:         setup.loginAsSuperAdmin();",
          "426:         String deleteVersionTestUser = \"DeleteVersionTestUser\";",
          "427:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
          "428:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
          "430:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
          "432:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "433:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "434:         HistoryPane historyPane = new HistoryPane();",
          "435:         historyPane = historyPane.showMinorEdits();",
          "437:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
          "438:         int numberOfVersions = historyPane.getNumberOfVersions();",
          "441:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
          "442:         WikiEditPage wikiEditPage = new WikiEditPage();",
          "443:         wikiEditPage.clickSaveAndView();",
          "445:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "446:         historyPane = new HistoryPane();",
          "448:         String startChangesVersion = historyPane.getCurrentVersion();",
          "450:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
          "452:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
          "453:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
          "456:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "457:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "458:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "459:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
          "460:         rightObject.displayObject();",
          "461:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "462:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "463:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "465:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
          "467:         objectEditPage.clickSaveAndContinue();",
          "469:         setup.gotoPage(xwikiPreferences);",
          "471:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
          "474:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "475:         objectEditPage = new ObjectEditPage();",
          "476:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "477:         rightObject = rightObjects.get(rightObjects.size() - 1);",
          "478:         rightObject.displayObject();",
          "479:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "480:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "481:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "483:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "484:         historyPane = new HistoryPane();",
          "485:         historyPane = historyPane.showMinorEdits();",
          "486:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "487:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "488:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
          "490:         try {",
          "491:             historyPane = historyPane.deleteVersion(historyPane.getCurrentVersion());",
          "492:             historyPane = historyPane.showMinorEdits();",
          "493:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
          "494:             assertEquals(currentMajor + \".1\", historyPane.getCurrentVersion());",
          "497:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "498:             objectEditPage = new ObjectEditPage();",
          "499:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "500:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "501:             rightObject.displayObject();",
          "502:             assertEquals(deleteVersionTestUser,",
          "503:                 rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "504:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "505:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "506:             objectEditPage.clickCancel();",
          "507:         } finally {",
          "509:             setup.loginAsSuperAdmin();",
          "510:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "511:             historyPane = new HistoryPane();",
          "512:             historyPane = historyPane.showMinorEdits();",
          "513:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
          "514:         }",
          "515:     }",
          "523:     @Test",
          "524:     @Order(9)",
          "525:     void testDeleteVersionDontMessUpRightsWithCancellingEvent(TestUtils setup)",
          "526:         throws Exception",
          "527:     {",
          "528:         setup.loginAsSuperAdmin();",
          "530:         String deleteVersionTestUser = \"DeleteVersionTestUserCancelEvent\";",
          "531:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
          "532:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
          "534:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
          "536:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "537:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "538:         HistoryPane historyPane = new HistoryPane();",
          "539:         historyPane = historyPane.showMinorEdits();",
          "541:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
          "542:         int numberOfVersions = historyPane.getNumberOfVersions();",
          "545:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
          "546:         WikiEditPage wikiEditPage = new WikiEditPage();",
          "547:         wikiEditPage.clickSaveAndView();",
          "549:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "550:         historyPane = new HistoryPane();",
          "552:         String startChangesVersion = historyPane.getCurrentVersion();",
          "554:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
          "556:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
          "557:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
          "560:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "561:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "562:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "563:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
          "564:         rightObject.displayObject();",
          "565:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "566:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "567:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "569:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
          "571:         objectEditPage.clickSaveAndContinue();",
          "573:         setup.gotoPage(xwikiPreferences);",
          "575:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
          "578:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "579:         objectEditPage = new ObjectEditPage();",
          "580:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "581:         rightObject = rightObjects.get(rightObjects.size() - 1);",
          "582:         rightObject.displayObject();",
          "583:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "584:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "585:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "587:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "588:         historyPane = new HistoryPane();",
          "589:         historyPane = historyPane.showMinorEdits();",
          "590:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "591:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "592:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
          "594:         try {",
          "595:             historyPane.deleteVersion(historyPane.getCurrentVersion());",
          "597:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "598:             historyPane = new HistoryPane();",
          "599:             historyPane = historyPane.showMinorEdits();",
          "603:             assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "604:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "607:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "608:             objectEditPage = new ObjectEditPage();",
          "609:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "610:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "611:             rightObject.displayObject();",
          "612:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "613:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "614:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "615:             objectEditPage.clickCancel();",
          "617:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "618:             historyPane = new HistoryPane();",
          "619:             historyPane = historyPane.showMinorEdits();",
          "622:             historyPane = historyPane.deleteVersion(currentMajor + \".1\");",
          "623:             historyPane = historyPane.showMinorEdits();",
          "625:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
          "626:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "627:             assertFalse(historyPane.hasVersion(currentMajor + \".1\"));",
          "630:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "631:             objectEditPage = new ObjectEditPage();",
          "632:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "633:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "634:             rightObject.displayObject();",
          "635:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "636:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "637:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "638:             objectEditPage.clickCancel();",
          "639:         } finally {",
          "641:             setup.loginAsSuperAdmin();",
          "642:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "643:             historyPane = new HistoryPane();",
          "644:             historyPane = historyPane.showMinorEdits();",
          "645:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
          "646:         }",
          "647:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "4704:     @Unstable",
          "4705:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2, XWikiContext context)",
          "4706:         throws XWikiException",
          "4707:     {",
          "4708:         Version v1 = new Version(version1);",
          "4709:         Version v2 = new Version(version2);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4707:     {",
          "4708:         deleteDocumentVersions(document, version1, version2, false, context);",
          "4709:     }",
          "4725:     @Unstable",
          "4726:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2,",
          "4727:         boolean triggeredByUser, XWikiContext context) throws XWikiException",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4746:                 .notify(new DocumentVersionRangeDeletingEvent(document.getDocumentReferenceWithLocale(),",
          "4747:                     lowerBound.toString(), upperBound.toString()), document, context);",
          "4758:             Version previousVersion = archive.getLatestVersion();",
          "4759:             if (!document.getRCSVersion().equals(previousVersion)) {",
          "4761:             }",
          "4764:             getObservationManager()",
          "4765:                 .notify(new DocumentVersionRangeDeletedEvent(document.getDocumentReferenceWithLocale(),",
          "",
          "[Removed Lines]",
          "4750:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4752:             XWikiDocument cachedDocument =",
          "4753:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4754:             cachedDocument.setDocumentArchive(archive);",
          "4760:                 context.getWiki().rollback(document, previousVersion.toString(), false, context);",
          "",
          "[Added Lines]",
          "4776:                 context.getWiki().rollback(document, previousVersion.toString(), false, triggeredByUser, context);",
          "4780:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4782:             XWikiDocument cachedDocument =",
          "4783:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4784:             cachedDocument.setDocumentArchive(archive);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "7603:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision, XWikiContext xcontext)",
          "7604:         throws XWikiException",
          "7605:     {",
          "7606:         LOGGER.debug(\"Rolling back [{}] to version [{}]\", tdoc, rev);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7628:     {",
          "7629:         return rollback(tdoc, rev, addRevision, false, xcontext);",
          "7630:     }",
          "7644:     @Unstable",
          "7645:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision,",
          "7646:         boolean triggeredByUser, XWikiContext xcontext) throws XWikiException",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "7680:             message = localizePlainOrKey(\"core.comment.rollback\", rev);",
          "7681:         }",
          "7683:         ObservationManager om = getObservationManager();",
          "7684:         if (om != null) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7725:         if (triggeredByUser) {",
          "7726:             checkSavingDocument(xcontext.getUserReference(), document, message, false, xcontext);",
          "7727:         }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:         Version v2 = versions[1];",
          "67:         if (v1 != null && v2 != null) {",
          "69:         }",
          "71:         sendRedirect(context);",
          "",
          "[Removed Lines]",
          "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), context);",
          "",
          "[Added Lines]",
          "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), true, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:         }",
          "85:         String redirect = Utils.getRedirect(\"view\", context);",
          "",
          "[Removed Lines]",
          "82:         xwiki.rollback(tdoc, rev, context);",
          "",
          "[Added Lines]",
          "82:         xwiki.rollback(tdoc, rev, true, true, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "73: import com.xpn.xwiki.doc.XWikiDocument;",
          "74: import com.xpn.xwiki.internal.ReadOnlyXWikiContextProvider;",
          "75: import com.xpn.xwiki.internal.debug.DebugConfiguration;",
          "76: import com.xpn.xwiki.internal.render.groovy.ParseGroovyFromString;",
          "77: import com.xpn.xwiki.internal.skin.InternalSkinManager;",
          "78: import com.xpn.xwiki.internal.store.StoreConfiguration;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "236:         XWikiDocument result = mock(XWikiDocument.class);",
          "237:         when(result.getDocumentReference()).thenReturn(documentReference);",
          "239:         String revision = \"3.5\";",
          "240:         when(this.documentRevisionProvider.getRevision(document, revision)).thenReturn(result);",
          "242:         this.componentManager.registerMockComponent(ContextualLocalizationManager.class);",
          "246:         verify(observationManager).notify(new DocumentRollingBackEvent(documentReference, revision), document, context);",
          "247:         verify(observationManager).notify(new DocumentUpdatingEvent(documentReference), document, context);",
          "248:         verify(observationManager).notify(new DocumentUpdatedEvent(documentReference), document, context);",
          "249:         verify(observationManager).notify(new DocumentRolledBackEvent(documentReference, revision), document, context);",
          "250:     }",
          "252:     @Test",
          "",
          "[Removed Lines]",
          "244:         xwiki.rollback(document, revision, context);",
          "",
          "[Added Lines]",
          "240:         DocumentReference userReference = new DocumentReference(\"xwiki\", \"XWiki\", \"ContextUser\");",
          "241:         this.context.setUserReference(userReference);",
          "248:         xwiki.rollback(document, revision, true, true, context);",
          "254:         verify(observationManager).notify(new UserUpdatingDocumentEvent(userReference, documentReference),",
          "255:             document, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java": [
          "File: xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java -> xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "183:         getDriver().findElementWithoutWaiting(pane, By.xpath(\".//input[@accesskey = 'c']\")).click();",
          "184:         return new ComparePage();",
          "185:     }",
          "186: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "193:     public int getNumberOfVersions()",
          "194:     {",
          "195:         String xpath = \".//div[@class='paginationFilter' and following-sibling::div[@id='historycontent']]\";",
          "196:         WebElement paginationDiv = getDriver().findElementWithoutWaiting(By.xpath(xpath));",
          "197:         return Integer.parseInt(getDriver().findElementWithoutWaiting(paginationDiv, By.className(\"totalResultsNo\"))",
          "198:             .getText());",
          "199:     }",
          "207:     public boolean hasVersion(String version)",
          "208:     {",
          "209:         String xpath = String.format(\".//table//tr[contains(., '%s')]\", version);",
          "210:         return getDriver().hasElementWithoutWaiting(pane, By.xpath(xpath));",
          "211:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1f3220f14bb3a4dcbd10d31134c39a06037f9a74",
      "candidate_info": {
        "commit_hash": "1f3220f14bb3a4dcbd10d31134c39a06037f9a74",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/1f3220f14bb3a4dcbd10d31134c39a06037f9a74",
        "files": [
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/resources/META-INF/components.txt",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
        ],
        "message": "XWIKI-21257: Rollback is not triggering a UserUpdatingDocumentEvent\n\n  * Ensure that the rollback API properly calls the check method\n  * Back the changes in a unit test that check events triggered in\n    rollback\n\n(cherry picked from commit 4de72875ca49602796165412741033bfdbf1e680)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
            "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
            "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
            "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
            "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java": [
          "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/main/java/org/xwiki/test/CustomUserUpdatedDocumentEventListener.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.test;",
          "22: import javax.inject.Inject;",
          "23: import javax.inject.Named;",
          "24: import javax.inject.Singleton;",
          "26: import org.apache.commons.lang3.StringUtils;",
          "27: import org.slf4j.Logger;",
          "28: import org.xwiki.component.annotation.Component;",
          "29: import org.xwiki.model.reference.DocumentReference;",
          "30: import org.xwiki.observation.AbstractEventListener;",
          "31: import org.xwiki.observation.event.Event;",
          "33: import com.xpn.xwiki.doc.XWikiDocument;",
          "34: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
          "44: @Component",
          "45: @Singleton",
          "46: @Named(CustomUserUpdatedDocumentEventListener.NAME)",
          "47: public class CustomUserUpdatedDocumentEventListener extends AbstractEventListener",
          "48: {",
          "49:     static final String NAME = \"CustomUserUpdatedDocumentEventListener\";",
          "51:     @Inject",
          "52:     private Logger logger;",
          "57:     public CustomUserUpdatedDocumentEventListener()",
          "58:     {",
          "59:         super(NAME, new UserUpdatingDocumentEvent());",
          "60:     }",
          "62:     @Override",
          "63:     public void onEvent(Event event, Object source, Object data)",
          "64:     {",
          "65:         UserUpdatingDocumentEvent userEvent = (UserUpdatingDocumentEvent) event;",
          "66:         XWikiDocument sourceDoc = (XWikiDocument) source;",
          "67:         DocumentReference expectedReference = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "68:         if (StringUtils.equals(userEvent.getUserReference().getName(), \"DeleteVersionTestUserCancelEvent\")",
          "69:             && sourceDoc.getDocumentReference().equals(expectedReference)) {",
          "70:             logger.info(\"Cancelling user event on purpose\");",
          "71:             userEvent.cancel();",
          "72:         }",
          "73:     }",
          "74: }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java||xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java": [
          "File: xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java -> xwiki-platform-core/xwiki-platform-flamingo/xwiki-platform-flamingo-skin/xwiki-platform-flamingo-skin-test/xwiki-platform-flamingo-skin-test-docker/src/test/it/org/xwiki/flamingo/test/docker/VersionIT.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.flamingo.test.docker;",
          "22: import org.junit.jupiter.api.BeforeAll;",
          "23: import org.junit.jupiter.api.Order;",
          "24: import org.junit.jupiter.api.Test;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.List;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "26: import org.xwiki.flamingo.skin.test.po.AttachmentsPane;",
          "27: import org.xwiki.flamingo.skin.test.po.AttachmentsViewPage;",
          "28: import org.xwiki.model.reference.AttachmentReference;",
          "29: import org.xwiki.rest.model.jaxb.Page;",
          "30: import org.xwiki.test.docker.junit5.TestReference;",
          "31: import org.xwiki.test.docker.junit5.UITest;",
          "32: import org.xwiki.test.ui.TestUtils;",
          "33: import org.xwiki.test.ui.po.HistoryPane;",
          "34: import org.xwiki.test.ui.po.ViewPage;",
          "35: import org.xwiki.test.ui.po.editor.WikiEditPage;",
          "37: import static org.hamcrest.MatcherAssert.assertThat;",
          "38: import static org.hamcrest.Matchers.startsWith;",
          "39: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "40: import static org.junit.jupiter.api.Assertions.assertTrue;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: import org.xwiki.model.reference.DocumentReference;",
          "38: import org.xwiki.test.ui.po.editor.ObjectEditPage;",
          "39: import org.xwiki.test.ui.po.editor.ObjectEditPane;",
          "45: import static org.junit.jupiter.api.Assertions.assertFalse;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "321:         assertEquals(\"1.1\", page.getVersion());",
          "322:         assertEquals(\"1.1\", page.getContent());",
          "323:     }",
          "324: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "338:     @Test",
          "339:     @Order(7)",
          "340:     void testRollbackDontMessUpRights(TestUtils setup, TestReference testReference) throws Exception",
          "341:     {",
          "342:         setup.loginAsSuperAdmin();",
          "343:         setup.rest().delete(testReference);",
          "344:         String rollbackTestUser = \"RollbackTestUser\";",
          "345:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", rollbackTestUser));",
          "346:         setup.createUser(rollbackTestUser, rollbackTestUser, \"\");",
          "347:         setup.createPage(testReference, \"Test Rollback Page\");",
          "349:         setup.setRights(testReference, \"\", \"XWiki.\" + rollbackTestUser, \"script\", true);",
          "352:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "353:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "354:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "355:         assertEquals(1, rightObjects.size());",
          "356:         ObjectEditPane objectEditPane = rightObjects.get(0);",
          "357:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "358:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "359:         assertEquals(\"1\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "360:         objectEditPane.setFieldValue(objectEditPane.byPropertyName(\"allow\"), \"0\");",
          "362:         objectEditPage.clickSaveAndContinue();",
          "363:         setup.gotoPage(testReference);",
          "365:         setup.login(rollbackTestUser, rollbackTestUser);",
          "368:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "369:         objectEditPage = new ObjectEditPage();",
          "370:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "371:         assertEquals(1, rightObjects.size());",
          "372:         objectEditPane = rightObjects.get(0);",
          "373:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "374:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "375:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "377:         ViewPage viewPage = objectEditPage.clickCancel();",
          "378:         HistoryPane historyPane = viewPage.openHistoryDocExtraPane();",
          "379:         historyPane = historyPane.showMinorEdits();",
          "382:         assertEquals(3, historyPane.getNumberOfVersions());",
          "383:         assertEquals(\"2.2\", historyPane.getCurrentVersion());",
          "384:         assertTrue(historyPane.hasVersion(\"2.1\"));",
          "386:         viewPage = historyPane.rollbackToVersion(\"2.1\");",
          "387:         historyPane = viewPage.openHistoryDocExtraPane();",
          "388:         historyPane = historyPane.showMinorEdits();",
          "391:         assertEquals(4, historyPane.getNumberOfVersions());",
          "393:         assertEquals(\"3.1\", historyPane.getCurrentVersion());",
          "394:         assertEquals(\"Rollback to version 2.1\", historyPane.getCurrentVersionComment());",
          "395:         assertTrue(historyPane.hasVersion(\"2.2\"));",
          "396:         assertTrue(historyPane.hasVersion(\"2.1\"));",
          "399:         setup.gotoPage(testReference, \"edit\", \"editor=object\");",
          "400:         objectEditPage = new ObjectEditPage();",
          "401:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiRights\", true);",
          "402:         assertEquals(1, rightObjects.size());",
          "403:         objectEditPane = rightObjects.get(0);",
          "404:         assertEquals(\"XWiki.\" + rollbackTestUser, objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"users\")));",
          "405:         assertEquals(\"script\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"levels\")));",
          "406:         assertEquals(\"0\", objectEditPane.getFieldValue(objectEditPane.byPropertyName(\"allow\")));",
          "408:         objectEditPage.clickCancel();",
          "409:     }",
          "420:     @Test",
          "421:     @Order(8)",
          "422:     void testDeleteVersionDontMessUpRights(TestUtils setup) throws Exception",
          "423:     {",
          "424:         setup.loginAsSuperAdmin();",
          "426:         String deleteVersionTestUser = \"DeleteVersionTestUser\";",
          "427:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
          "428:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
          "430:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
          "432:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "433:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "434:         HistoryPane historyPane = new HistoryPane();",
          "435:         historyPane = historyPane.showMinorEdits();",
          "437:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
          "438:         int numberOfVersions = historyPane.getNumberOfVersions();",
          "441:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
          "442:         WikiEditPage wikiEditPage = new WikiEditPage();",
          "443:         wikiEditPage.clickSaveAndView();",
          "445:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "446:         historyPane = new HistoryPane();",
          "448:         String startChangesVersion = historyPane.getCurrentVersion();",
          "450:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
          "452:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
          "453:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
          "456:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "457:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "458:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "459:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
          "460:         rightObject.displayObject();",
          "461:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "462:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "463:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "465:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
          "467:         objectEditPage.clickSaveAndContinue();",
          "469:         setup.gotoPage(xwikiPreferences);",
          "471:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
          "474:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "475:         objectEditPage = new ObjectEditPage();",
          "476:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "477:         rightObject = rightObjects.get(rightObjects.size() - 1);",
          "478:         rightObject.displayObject();",
          "479:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "480:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "481:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "483:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "484:         historyPane = new HistoryPane();",
          "485:         historyPane = historyPane.showMinorEdits();",
          "486:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "487:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "488:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
          "490:         try {",
          "491:             historyPane = historyPane.deleteVersion(historyPane.getCurrentVersion());",
          "492:             historyPane = historyPane.showMinorEdits();",
          "493:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
          "494:             assertEquals(currentMajor + \".1\", historyPane.getCurrentVersion());",
          "497:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "498:             objectEditPage = new ObjectEditPage();",
          "499:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "500:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "501:             rightObject.displayObject();",
          "502:             assertEquals(deleteVersionTestUser,",
          "503:                 rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "504:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "505:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "506:             objectEditPage.clickCancel();",
          "507:         } finally {",
          "509:             setup.loginAsSuperAdmin();",
          "510:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "511:             historyPane = new HistoryPane();",
          "512:             historyPane = historyPane.showMinorEdits();",
          "513:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
          "514:         }",
          "515:     }",
          "523:     @Test",
          "524:     @Order(9)",
          "525:     void testDeleteVersionDontMessUpRightsWithCancellingEvent(TestUtils setup)",
          "526:         throws Exception",
          "527:     {",
          "528:         setup.loginAsSuperAdmin();",
          "530:         String deleteVersionTestUser = \"DeleteVersionTestUserCancelEvent\";",
          "531:         setup.rest().delete(new DocumentReference(\"xwiki\", \"XWiki\", deleteVersionTestUser));",
          "532:         setup.createUser(deleteVersionTestUser, deleteVersionTestUser, \"\");",
          "534:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"admin\", true);",
          "536:         DocumentReference xwikiPreferences = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "537:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "538:         HistoryPane historyPane = new HistoryPane();",
          "539:         historyPane = historyPane.showMinorEdits();",
          "541:         String latestVersionBeforeChanges = historyPane.getCurrentVersion();",
          "542:         int numberOfVersions = historyPane.getNumberOfVersions();",
          "545:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=wiki\");",
          "546:         WikiEditPage wikiEditPage = new WikiEditPage();",
          "547:         wikiEditPage.clickSaveAndView();",
          "549:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "550:         historyPane = new HistoryPane();",
          "552:         String startChangesVersion = historyPane.getCurrentVersion();",
          "554:         String currentMajor = startChangesVersion.split(\"\\\\.\")[0];",
          "556:         setup.setGlobalRights(\"\", deleteVersionTestUser, \"programming\", true);",
          "557:         currentMajor = String.valueOf(Integer.parseInt(currentMajor) + 1);",
          "560:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "561:         ObjectEditPage objectEditPage = new ObjectEditPage();",
          "562:         List<ObjectEditPane> rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "563:         ObjectEditPane rightObject = rightObjects.get(rightObjects.size() - 1);",
          "564:         rightObject.displayObject();",
          "565:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "566:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "567:         assertEquals(\"1\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "569:         rightObject.setFieldValue(rightObject.byPropertyName(\"allow\"), \"0\");",
          "571:         objectEditPage.clickSaveAndContinue();",
          "573:         setup.gotoPage(xwikiPreferences);",
          "575:         setup.login(deleteVersionTestUser, deleteVersionTestUser);",
          "578:         setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "579:         objectEditPage = new ObjectEditPage();",
          "580:         rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "581:         rightObject = rightObjects.get(rightObjects.size() - 1);",
          "582:         rightObject.displayObject();",
          "583:         assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "584:         assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "585:         assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "587:         setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "588:         historyPane = new HistoryPane();",
          "589:         historyPane = historyPane.showMinorEdits();",
          "590:         assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "591:         assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "592:         assertTrue(historyPane.hasVersion(currentMajor + \".1\"));",
          "594:         try {",
          "595:             historyPane.deleteVersion(historyPane.getCurrentVersion());",
          "597:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "598:             historyPane = new HistoryPane();",
          "599:             historyPane = historyPane.showMinorEdits();",
          "603:             assertEquals(numberOfVersions + 3, historyPane.getNumberOfVersions());",
          "604:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "607:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "608:             objectEditPage = new ObjectEditPage();",
          "609:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "610:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "611:             rightObject.displayObject();",
          "612:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "613:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "614:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "615:             objectEditPage.clickCancel();",
          "617:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "618:             historyPane = new HistoryPane();",
          "619:             historyPane = historyPane.showMinorEdits();",
          "622:             historyPane = historyPane.deleteVersion(currentMajor + \".1\");",
          "623:             historyPane = historyPane.showMinorEdits();",
          "625:             assertEquals(numberOfVersions + 2, historyPane.getNumberOfVersions());",
          "626:             assertEquals(currentMajor + \".2\", historyPane.getCurrentVersion());",
          "627:             assertFalse(historyPane.hasVersion(currentMajor + \".1\"));",
          "630:             setup.gotoPage(xwikiPreferences, \"edit\", \"editor=object\");",
          "631:             objectEditPage = new ObjectEditPage();",
          "632:             rightObjects = objectEditPage.getObjectsOfClass(\"XWiki.XWikiGlobalRights\", false);",
          "633:             rightObject = rightObjects.get(rightObjects.size() - 1);",
          "634:             rightObject.displayObject();",
          "635:             assertEquals(deleteVersionTestUser, rightObject.getFieldValue(rightObject.byPropertyName(\"users\")));",
          "636:             assertEquals(\"programming\", rightObject.getFieldValue(rightObject.byPropertyName(\"levels\")));",
          "637:             assertEquals(\"0\", rightObject.getFieldValue(rightObject.byPropertyName(\"allow\")));",
          "638:             objectEditPage.clickCancel();",
          "639:         } finally {",
          "641:             setup.loginAsSuperAdmin();",
          "642:             setup.gotoPage(xwikiPreferences, \"view\", \"viewer=history\");",
          "643:             historyPane = new HistoryPane();",
          "644:             historyPane = historyPane.showMinorEdits();",
          "645:             historyPane.rollbackToVersion(latestVersionBeforeChanges);",
          "646:         }",
          "647:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "4695:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2, XWikiContext context)",
          "4696:         throws XWikiException",
          "4697:     {",
          "4698:         Version v1 = new Version(version1);",
          "4699:         Version v2 = new Version(version2);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4697:     {",
          "4698:         deleteDocumentVersions(document, version1, version2, false, context);",
          "4699:     }",
          "4715:     @Unstable",
          "4716:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2,",
          "4717:         boolean triggeredByUser, XWikiContext context) throws XWikiException",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4736:                 .notify(new DocumentVersionRangeDeletingEvent(document.getDocumentReferenceWithLocale(),",
          "4737:                     lowerBound.toString(), upperBound.toString()), document, context);",
          "4748:             Version previousVersion = archive.getLatestVersion();",
          "4749:             if (!document.getRCSVersion().equals(previousVersion)) {",
          "4751:             }",
          "4754:             getObservationManager()",
          "4755:                 .notify(new DocumentVersionRangeDeletedEvent(document.getDocumentReferenceWithLocale(),",
          "",
          "[Removed Lines]",
          "4740:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4742:             XWikiDocument cachedDocument =",
          "4743:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4744:             cachedDocument.setDocumentArchive(archive);",
          "4750:                 context.getWiki().rollback(document, previousVersion.toString(), false, context);",
          "",
          "[Added Lines]",
          "4766:                 context.getWiki().rollback(document, previousVersion.toString(), false, triggeredByUser, context);",
          "4770:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4772:             XWikiDocument cachedDocument =",
          "4773:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4774:             cachedDocument.setDocumentArchive(archive);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "7607:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision, XWikiContext xcontext)",
          "7608:         throws XWikiException",
          "7609:     {",
          "7610:         LOGGER.debug(\"Rolling back [{}] to version [{}]\", tdoc, rev);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7632:     {",
          "7633:         return rollback(tdoc, rev, addRevision, false, xcontext);",
          "7634:     }",
          "7648:     @Unstable",
          "7649:     public XWikiDocument rollback(final XWikiDocument tdoc, String rev, boolean addRevision,",
          "7650:         boolean triggeredByUser, XWikiContext xcontext) throws XWikiException",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "7684:             message = localizePlainOrKey(\"core.comment.rollback\", rev);",
          "7685:         }",
          "7687:         ObservationManager om = getObservationManager();",
          "7688:         if (om != null) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7729:         if (triggeredByUser) {",
          "7730:             checkSavingDocument(xcontext.getUserReference(), document, message, false, xcontext);",
          "7731:         }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/DeleteVersionsAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:         Version v2 = versions[1];",
          "67:         if (v1 != null && v2 != null) {",
          "69:         }",
          "71:         sendRedirect(context);",
          "",
          "[Removed Lines]",
          "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), context);",
          "",
          "[Added Lines]",
          "68:             context.getWiki().deleteDocumentVersions(tdoc, v1.toString(), v2.toString(), true, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/web/RollbackAction.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:         }",
          "85:         String redirect = Utils.getRedirect(\"view\", context);",
          "",
          "[Removed Lines]",
          "82:         xwiki.rollback(tdoc, rev, context);",
          "",
          "[Added Lines]",
          "82:         xwiki.rollback(tdoc, rev, true, true, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java||xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java -> xwiki-platform-core/xwiki-platform-oldcore/src/test/java/com/xpn/xwiki/XWikiMockitoTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "73: import com.xpn.xwiki.doc.XWikiDocument;",
          "74: import com.xpn.xwiki.internal.ReadOnlyXWikiContextProvider;",
          "75: import com.xpn.xwiki.internal.debug.DebugConfiguration;",
          "76: import com.xpn.xwiki.internal.render.groovy.ParseGroovyFromString;",
          "77: import com.xpn.xwiki.internal.skin.InternalSkinManager;",
          "78: import com.xpn.xwiki.internal.store.StoreConfiguration;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76: import com.xpn.xwiki.internal.event.UserUpdatingDocumentEvent;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "236:         XWikiDocument result = mock(XWikiDocument.class);",
          "237:         when(result.getDocumentReference()).thenReturn(documentReference);",
          "239:         String revision = \"3.5\";",
          "240:         when(this.documentRevisionProvider.getRevision(document, revision)).thenReturn(result);",
          "242:         this.componentManager.registerMockComponent(ContextualLocalizationManager.class);",
          "246:         verify(observationManager).notify(new DocumentRollingBackEvent(documentReference, revision), document, context);",
          "247:         verify(observationManager).notify(new DocumentUpdatingEvent(documentReference), document, context);",
          "248:         verify(observationManager).notify(new DocumentUpdatedEvent(documentReference), document, context);",
          "249:         verify(observationManager).notify(new DocumentRolledBackEvent(documentReference, revision), document, context);",
          "250:     }",
          "252:     @Test",
          "",
          "[Removed Lines]",
          "244:         xwiki.rollback(document, revision, context);",
          "",
          "[Added Lines]",
          "240:         DocumentReference userReference = new DocumentReference(\"xwiki\", \"XWiki\", \"ContextUser\");",
          "241:         this.context.setUserReference(userReference);",
          "248:         xwiki.rollback(document, revision, true, true, context);",
          "254:         verify(observationManager).notify(new UserUpdatingDocumentEvent(userReference, documentReference),",
          "255:             document, context);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java||xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java": [
          "File: xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java -> xwiki-platform-core/xwiki-platform-test/xwiki-platform-test-ui/src/main/java/org/xwiki/test/ui/po/HistoryPane.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "183:         getDriver().findElementWithoutWaiting(pane, By.xpath(\".//input[@accesskey = 'c']\")).click();",
          "184:         return new ComparePage();",
          "185:     }",
          "186: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "193:     public int getNumberOfVersions()",
          "194:     {",
          "195:         String xpath = \".//div[@class='paginationFilter' and following-sibling::div[@id='historycontent']]\";",
          "196:         WebElement paginationDiv = getDriver().findElementWithoutWaiting(By.xpath(xpath));",
          "197:         return Integer.parseInt(getDriver().findElementWithoutWaiting(paginationDiv, By.className(\"totalResultsNo\"))",
          "198:             .getText());",
          "199:     }",
          "207:     public boolean hasVersion(String version)",
          "208:     {",
          "209:         String xpath = String.format(\".//table//tr[contains(., '%s')]\", version);",
          "210:         return getDriver().hasElementWithoutWaiting(pane, By.xpath(xpath));",
          "211:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "50ef499bd2a9461b587f4b5c867afe8726bdaf00",
      "candidate_info": {
        "commit_hash": "50ef499bd2a9461b587f4b5c867afe8726bdaf00",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/50ef499bd2a9461b587f4b5c867afe8726bdaf00",
        "files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java"
        ],
        "message": "XWIKI-21761: XWiki#deleteDocumentVersions does not work when called from a different wiki",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java||xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java": [
          "File: xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java -> xwiki-platform-core/xwiki-platform-oldcore/src/main/java/com/xpn/xwiki/XWiki.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "4726:     public void deleteDocumentVersions(XWikiDocument document, String version1, String version2,",
          "4727:         boolean triggeredByUser, XWikiContext context) throws XWikiException",
          "4728:     {",
          "4777:             }",
          "4790:         }",
          "4791:     }",
          "",
          "[Removed Lines]",
          "4729:         Version v1 = new Version(version1);",
          "4730:         Version v2 = new Version(version2);",
          "4733:         Version upperBound = v1;",
          "4734:         Version lowerBound = v2;",
          "4735:         if (upperBound.compareVersions(lowerBound) < 0) {",
          "4736:             Version tmp = upperBound;",
          "4737:             upperBound = lowerBound;",
          "4738:             lowerBound = tmp;",
          "4739:         }",
          "4741:         XWikiDocumentArchive archive = document.getDocumentArchive(context);",
          "4743:         if (archive.getNodes(upperBound, lowerBound).isEmpty()) {",
          "4744:             throw new XWikiException(XWikiException.MODULE_XWIKI,",
          "4745:                 XWikiException.ERROR_XWIKI_STORE_HIBERNATE_UNEXISTANT_VERSION,",
          "4746:                 String.format(\"Cannot find any revision to delete matching the range defined by [%s] and [%s]\",",
          "4747:                     lowerBound, upperBound));",
          "4748:         }",
          "4750:         archive.removeVersions(upperBound, lowerBound, context);",
          "4753:         if (archive.getLatestVersion() == null) {",
          "4755:             BatchOperationExecutor batchOperationExecutor = Utils.getComponent(BatchOperationExecutor.class);",
          "4756:             batchOperationExecutor.execute(() -> {",
          "4757:                 if (document.getLocale().equals(Locale.ROOT)) {",
          "4758:                     context.getWiki().deleteAllDocuments(document, context);",
          "4759:                 } else {",
          "4761:                     context.getWiki().deleteDocument(document, context);",
          "4762:                 }",
          "4763:             });",
          "4764:         } else {",
          "4766:             getObservationManager()",
          "4767:                 .notify(new DocumentVersionRangeDeletingEvent(document.getDocumentReferenceWithLocale(),",
          "4768:                     lowerBound.toString(), upperBound.toString()), document, context);",
          "4774:             Version previousVersion = archive.getLatestVersion();",
          "4775:             if (!document.getRCSVersion().equals(previousVersion)) {",
          "4776:                 context.getWiki().rollback(document, previousVersion.toString(), false, triggeredByUser, context);",
          "4780:             context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4782:             XWikiDocument cachedDocument =",
          "4783:                 context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4784:             cachedDocument.setDocumentArchive(archive);",
          "4787:             getObservationManager()",
          "4788:                 .notify(new DocumentVersionRangeDeletedEvent(document.getDocumentReferenceWithLocale(),",
          "4789:                     lowerBound.toString(), upperBound.toString()), document, context);",
          "",
          "[Added Lines]",
          "4729:         WikiReference currentWikiReference = context.getWikiReference();",
          "4731:         try {",
          "4732:             context.setWikiReference(document.getDocumentReference().getWikiReference());",
          "4734:             Version v1 = new Version(version1);",
          "4735:             Version v2 = new Version(version2);",
          "4738:             Version upperBound = v1;",
          "4739:             Version lowerBound = v2;",
          "4740:             if (upperBound.compareVersions(lowerBound) < 0) {",
          "4741:                 Version tmp = upperBound;",
          "4742:                 upperBound = lowerBound;",
          "4743:                 lowerBound = tmp;",
          "4746:             XWikiDocumentArchive archive = document.getDocumentArchive(context);",
          "4748:             if (archive.getNodes(upperBound, lowerBound).isEmpty()) {",
          "4749:                 throw new XWikiException(XWikiException.MODULE_XWIKI,",
          "4750:                     XWikiException.ERROR_XWIKI_STORE_HIBERNATE_UNEXISTANT_VERSION,",
          "4751:                     String.format(\"Cannot find any revision to delete matching the range defined by [%s] and [%s]\",",
          "4752:                         lowerBound, upperBound));",
          "4753:             }",
          "4755:             archive.removeVersions(upperBound, lowerBound, context);",
          "4758:             if (archive.getLatestVersion() == null) {",
          "4760:                 BatchOperationExecutor batchOperationExecutor = Utils.getComponent(BatchOperationExecutor.class);",
          "4761:                 batchOperationExecutor.execute(() -> {",
          "4762:                     if (document.getLocale().equals(Locale.ROOT)) {",
          "4763:                         context.getWiki().deleteAllDocuments(document, context);",
          "4764:                     } else {",
          "4766:                         context.getWiki().deleteDocument(document, context);",
          "4767:                     }",
          "4768:                 });",
          "4769:             } else {",
          "4771:                 getObservationManager()",
          "4772:                     .notify(new DocumentVersionRangeDeletingEvent(document.getDocumentReferenceWithLocale(),",
          "4773:                         lowerBound.toString(), upperBound.toString()), document, context);",
          "4778:                 Version previousVersion = archive.getLatestVersion();",
          "4779:                 if (!document.getRCSVersion().equals(previousVersion)) {",
          "4780:                     context.getWiki().rollback(document, previousVersion.toString(), false, triggeredByUser, context);",
          "4781:                 }",
          "4784:                 context.getWiki().getVersioningStore().saveXWikiDocArchive(archive, true, context);",
          "4786:                 XWikiDocument cachedDocument =",
          "4787:                     context.getWiki().getDocument(document.getDocumentReferenceWithLocale(), context);",
          "4788:                 cachedDocument.setDocumentArchive(archive);",
          "4791:                 getObservationManager()",
          "4792:                     .notify(new DocumentVersionRangeDeletedEvent(document.getDocumentReferenceWithLocale(),",
          "4793:                         lowerBound.toString(), upperBound.toString()), document, context);",
          "4794:             }",
          "4795:         } finally {",
          "4796:             context.setWikiReference(currentWikiReference);",
          "",
          "---------------"
        ]
      }
    }
  ]
}