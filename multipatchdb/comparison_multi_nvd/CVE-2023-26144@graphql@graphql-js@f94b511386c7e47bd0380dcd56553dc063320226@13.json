{
  "cve_id": "CVE-2023-26144",
  "cve_desc": "Versions of the package graphql from 16.3.0 and before 16.8.1 are vulnerable to Denial of Service (DoS) due to insufficient checks in the OverlappingFieldsCanBeMergedRule.ts file when parsing large queries. This vulnerability allows an attacker to degrade system performance.\r\r**Note:** It was not proven that this vulnerability can crash the process.",
  "repo": "graphql/graphql-js",
  "patch_hash": "f94b511386c7e47bd0380dcd56553dc063320226",
  "patch_info": {
    "commit_hash": "f94b511386c7e47bd0380dcd56553dc063320226",
    "repo": "graphql/graphql-js",
    "commit_url": "https://github.com/graphql/graphql-js/commit/f94b511386c7e47bd0380dcd56553dc063320226",
    "files": [
      "benchmark/repeated-fields-benchmark.js",
      "src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts",
      "src/validation/rules/OverlappingFieldsCanBeMergedRule.ts"
    ],
    "message": "OverlappingFieldsCanBeMergedRule: Fix performance degradation (#3958)\n\nCo-authored-by: AaronMoat <AaronMoat@users.noreply.github.com>\nCo-authored-by: Ivan Goncharov <ivan.goncharov.ua@gmail.com>\nResolves https://github.com/graphql/graphql-js/issues/3955 (at least",
    "before_after_code_files": [
      "benchmark/repeated-fields-benchmark.js||benchmark/repeated-fields-benchmark.js",
      "src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts||src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts",
      "src/validation/rules/OverlappingFieldsCanBeMergedRule.ts||src/validation/rules/OverlappingFieldsCanBeMergedRule.ts"
    ]
  },
  "patch_diff": {
    "benchmark/repeated-fields-benchmark.js||benchmark/repeated-fields-benchmark.js": [
      "File: benchmark/repeated-fields-benchmark.js -> benchmark/repeated-fields-benchmark.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: import { graphqlSync } from 'graphql/graphql.js';",
      "2: import { buildSchema } from 'graphql/utilities/buildASTSchema.js';",
      "4: const schema = buildSchema('type Query { hello: String! }');",
      "5: const source = `{ ${'hello '.repeat(250)}}`;",
      "7: export const benchmark = {",
      "8:   name: 'Many repeated fields',",
      "9:   count: 5,",
      "10:   measure() {",
      "11:     graphqlSync({ schema, source });",
      "12:   },",
      "13: };",
      "",
      "---------------"
    ],
    "src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts||src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts": [
      "File: src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts -> src/validation/__tests__/OverlappingFieldsCanBeMergedRule-test.ts",
      "--- Hunk 1 ---",
      "[Context before]",
      "179:     ]);",
      "180:   });",
      "182:   it('mix of stream and no stream', () => {",
      "183:     expectErrors(`",
      "184:       fragment conflictingArgs on Dog {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "182:   it('different stream directive extra argument', () => {",
      "183:     expectErrors(`",
      "184:       fragment conflictingArgs on Dog {",
      "185:         name @stream(label: \"streamLabel\", initialCount: 1)",
      "186:         name @stream(label: \"streamLabel\", initialCount: 1, extraArg: true)",
      "187:       }",
      "188:     `).toDeepEqual([",
      "189:       {",
      "190:         message:",
      "191:           'Fields \"name\" conflict because they have differing stream directives. Use different aliases on the fields to fetch both if this was intentional.',",
      "192:         locations: [",
      "193:           { line: 3, column: 9 },",
      "194:           { line: 4, column: 9 },",
      "195:         ],",
      "196:       },",
      "197:     ]);",
      "198:   });",
      "",
      "---------------"
    ],
    "src/validation/rules/OverlappingFieldsCanBeMergedRule.ts||src/validation/rules/OverlappingFieldsCanBeMergedRule.ts": [
      "File: src/validation/rules/OverlappingFieldsCanBeMergedRule.ts -> src/validation/rules/OverlappingFieldsCanBeMergedRule.ts",
      "--- Hunk 1 ---",
      "[Context before]",
      "7:   DirectiveNode,",
      "8:   FieldNode,",
      "9:   FragmentDefinitionNode,",
      "11:   SelectionSetNode,",
      "12: } from '../../language/ast.js';",
      "13: import { Kind } from '../../language/kinds.js';",
      "14: import { print } from '../../language/printer.js';",
      "",
      "[Removed Lines]",
      "10:   ObjectValueNode,",
      "",
      "[Added Lines]",
      "11:   ValueNode,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "592:     }",
      "596:       return [",
      "597:         [responseName, 'they have differing arguments'],",
      "598:         [node1],",
      "",
      "[Removed Lines]",
      "595:     if (stringifyArguments(node1) !== stringifyArguments(node2)) {",
      "",
      "[Added Lines]",
      "595:     if (!sameArguments(node1, node2)) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "649:   }",
      "650: }",
      "665: }",
      "667: function getStreamDirective(",
      "",
      "[Removed Lines]",
      "652: function stringifyArguments(fieldNode: FieldNode | DirectiveNode): string {",
      "654:   const args = /* c8 ignore next */ fieldNode.arguments ?? [];",
      "656:   const inputObjectWithArgs: ObjectValueNode = {",
      "657:     kind: Kind.OBJECT,",
      "658:     fields: args.map((argNode) => ({",
      "659:       kind: Kind.OBJECT_FIELD,",
      "660:       name: argNode.name,",
      "661:       value: argNode.value,",
      "662:     })),",
      "663:   };",
      "664:   return print(sortValueNode(inputObjectWithArgs));",
      "",
      "[Added Lines]",
      "652: function sameArguments(",
      "653:   node1: FieldNode | DirectiveNode,",
      "654:   node2: FieldNode | DirectiveNode,",
      "655: ): boolean {",
      "656:   const args1 = node1.arguments;",
      "657:   const args2 = node2.arguments;",
      "659:   if (args1 === undefined || args1.length === 0) {",
      "660:     return args2 === undefined || args2.length === 0;",
      "661:   }",
      "662:   if (args2 === undefined || args2.length === 0) {",
      "663:     return false;",
      "664:   }",
      "666:   if (args1.length !== args2.length) {",
      "667:     return false;",
      "668:   }",
      "670:   const values2 = new Map(args2.map(({ name, value }) => [name.value, value]));",
      "671:   return args1.every((arg1) => {",
      "672:     const value1 = arg1.value;",
      "673:     const value2 = values2.get(arg1.name.value);",
      "674:     if (value2 === undefined) {",
      "675:       return false;",
      "676:     }",
      "678:     return stringifyValue(value1) === stringifyValue(value2);",
      "679:   });",
      "680: }",
      "682: function stringifyValue(value: ValueNode): string | null {",
      "683:   return print(sortValueNode(value));",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "681:     return true;",
      "682:   } else if (stream1 && stream2) {",
      "685:   }",
      "687:   return false;",
      "",
      "[Removed Lines]",
      "684:     return stringifyArguments(stream1) === stringifyArguments(stream2);",
      "",
      "[Added Lines]",
      "703:     return sameArguments(stream1, stream2);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "486537f69ee1d616a8c1133b1c85d16025500ad4",
      "candidate_info": {
        "commit_hash": "486537f69ee1d616a8c1133b1c85d16025500ad4",
        "repo": "graphql/graphql-js",
        "commit_url": "https://github.com/graphql/graphql-js/commit/486537f69ee1d616a8c1133b1c85d16025500ad4",
        "files": [
          "validation/rules/OverlappingFieldsCanBeMergedRule.ts"
        ],
        "message": "Deploy  to 'deno' branch",
        "before_after_code_files": [
          "validation/rules/OverlappingFieldsCanBeMergedRule.ts||validation/rules/OverlappingFieldsCanBeMergedRule.ts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "validation/rules/OverlappingFieldsCanBeMergedRule.ts||validation/rules/OverlappingFieldsCanBeMergedRule.ts": [
          "File: validation/rules/OverlappingFieldsCanBeMergedRule.ts -> validation/rules/OverlappingFieldsCanBeMergedRule.ts",
          "--- Hunk 1 ---",
          "[Context before]",
          "5:   DirectiveNode,",
          "6:   FieldNode,",
          "7:   FragmentDefinitionNode,",
          "9:   SelectionSetNode,",
          "10: } from '../../language/ast.ts';",
          "11: import { Kind } from '../../language/kinds.ts';",
          "12: import { print } from '../../language/printer.ts';",
          "",
          "[Removed Lines]",
          "8:   ObjectValueNode,",
          "",
          "[Added Lines]",
          "9:   ValueNode,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "551:       ];",
          "552:     }",
          "555:       return [",
          "556:         [responseName, 'they have differing arguments'],",
          "557:         [node1],",
          "",
          "[Removed Lines]",
          "554:     if (stringifyArguments(node1) !== stringifyArguments(node2)) {",
          "",
          "[Added Lines]",
          "554:     if (!sameArguments(node1, node2)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "603:     return subfieldConflicts(conflicts, responseName, node1, node2);",
          "604:   }",
          "605: }",
          "618: }",
          "619: function getStreamDirective(",
          "620:   directives: ReadonlyArray<DirectiveNode>,",
          "",
          "[Removed Lines]",
          "606: function stringifyArguments(fieldNode: FieldNode | DirectiveNode): string {",
          "608:   const args = /* c8 ignore next */ fieldNode.arguments ?? [];",
          "609:   const inputObjectWithArgs: ObjectValueNode = {",
          "610:     kind: Kind.OBJECT,",
          "611:     fields: args.map((argNode) => ({",
          "612:       kind: Kind.OBJECT_FIELD,",
          "613:       name: argNode.name,",
          "614:       value: argNode.value,",
          "615:     })),",
          "616:   };",
          "617:   return print(sortValueNode(inputObjectWithArgs));",
          "",
          "[Added Lines]",
          "606: function sameArguments(",
          "607:   node1: FieldNode | DirectiveNode,",
          "608:   node2: FieldNode | DirectiveNode,",
          "609: ): boolean {",
          "610:   const args1 = node1.arguments;",
          "611:   const args2 = node2.arguments;",
          "612:   if (args1 === undefined || args1.length === 0) {",
          "613:     return args2 === undefined || args2.length === 0;",
          "614:   }",
          "615:   if (args2 === undefined || args2.length === 0) {",
          "616:     return false;",
          "617:   }",
          "618:   if (args1.length !== args2.length) {",
          "619:     return false;",
          "620:   }",
          "621:   const values2 = new Map(args2.map(({ name, value }) => [name.value, value]));",
          "622:   return args1.every((arg1) => {",
          "623:     const value1 = arg1.value;",
          "624:     const value2 = values2.get(arg1.name.value);",
          "625:     if (value2 === undefined) {",
          "626:       return false;",
          "627:     }",
          "628:     return stringifyValue(value1) === stringifyValue(value2);",
          "629:   });",
          "630: }",
          "631: function stringifyValue(value: ValueNode): string | null {",
          "632:   return print(sortValueNode(value));",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "632:     return true;",
          "633:   } else if (stream1 && stream2) {",
          "636:   }",
          "638:   return false;",
          "",
          "[Removed Lines]",
          "635:     return stringifyArguments(stream1) === stringifyArguments(stream2);",
          "",
          "[Added Lines]",
          "650:     return sameArguments(stream1, stream2);",
          "",
          "---------------"
        ]
      }
    }
  ]
}