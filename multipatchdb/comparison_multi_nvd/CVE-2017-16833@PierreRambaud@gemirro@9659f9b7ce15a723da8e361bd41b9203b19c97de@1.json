{
  "cve_id": "CVE-2017-16833",
  "cve_desc": "Stored cross-site scripting (XSS) vulnerability in Gemirro before 0.16.0 allows attackers to inject arbitrary web script via a crafted javascript: URL in the \"homepage\" value of a \".gemspec\" file.",
  "repo": "PierreRambaud/gemirro",
  "patch_hash": "9659f9b7ce15a723da8e361bd41b9203b19c97de",
  "patch_info": {
    "commit_hash": "9659f9b7ce15a723da8e361bd41b9203b19c97de",
    "repo": "PierreRambaud/gemirro",
    "commit_url": "https://github.com/PierreRambaud/gemirro/commit/9659f9b7ce15a723da8e361bd41b9203b19c97de",
    "files": [
      "Gemfile.lock",
      "lib/gemirro/server.rb",
      "views/gem.erb"
    ],
    "message": "Security Fix again, thanks to Yasin Soliman",
    "before_after_code_files": [
      "Gemfile.lock||Gemfile.lock",
      "lib/gemirro/server.rb||lib/gemirro/server.rb",
      "views/gem.erb||views/gem.erb"
    ]
  },
  "patch_diff": {
    "Gemfile.lock||Gemfile.lock": [
      "File: Gemfile.lock -> Gemfile.lock",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: PATH",
      "2:   remote: .",
      "3:   specs:",
      "5:       builder (~> 3.2)",
      "6:       confstruct (~> 1.0)",
      "7:       erubis (~> 2.7)",
      "",
      "[Removed Lines]",
      "4:     gemirro (0.14.0)",
      "",
      "[Added Lines]",
      "4:     gemirro (0.15.0)",
      "",
      "---------------"
    ],
    "lib/gemirro/server.rb||lib/gemirro/server.rb": [
      "File: lib/gemirro/server.rb -> lib/gemirro/server.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: require 'sinatra/base'",
      "2: require 'thin'",
      "4: module Gemirro",
      "5:   ##",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3: require 'uri'",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "271:       def escape(string)",
      "272:         Rack::Utils.escape_html(string)",
      "273:       end",
      "274:     end",
      "275:   end",
      "276: end",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "276:       ##",
      "277:       # Homepage link",
      "278:       #",
      "279:       # @param [Gem] spec",
      "280:       # @return [String]",
      "281:       #",
      "282:       def homepage(spec)",
      "283:         URI.parse(URI.escape(spec.homepage))",
      "284:       end",
      "",
      "---------------"
    ],
    "views/gem.erb||views/gem.erb": [
      "File: views/gem.erb -> views/gem.erb",
      "--- Hunk 1 ---",
      "[Context before]",
      "31:             <ul class=\"list-group\">",
      "32:               <% spec.authors.each do |author| %>",
      "33:                 <li class=\"list-group-item\">",
      "35:                 </li>",
      "36:               <% end %>",
      "37:             </ul>",
      "",
      "[Removed Lines]",
      "34:                   <a href=\"<%= escape(spec.homepage) %>\"><%= escape(author) %></a>",
      "",
      "[Added Lines]",
      "34:                   <a href=\"<%= homepage(spec) %>\"><%= escape(author) %></a>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8acfb9ce9774128d535e2795d583242bb86d6ea8",
      "candidate_info": {
        "commit_hash": "8acfb9ce9774128d535e2795d583242bb86d6ea8",
        "repo": "PierreRambaud/gemirro",
        "commit_url": "https://github.com/PierreRambaud/gemirro/commit/8acfb9ce9774128d535e2795d583242bb86d6ea8",
        "files": [
          "Gemfile.lock",
          "gemirro.gemspec",
          "lib/gemirro/server.rb",
          "views/gem.erb",
          "views/index.erb"
        ],
        "message": "Security Fix, thanks to Yasin Soliman",
        "before_after_code_files": [
          "Gemfile.lock||Gemfile.lock",
          "gemirro.gemspec||gemirro.gemspec",
          "lib/gemirro/server.rb||lib/gemirro/server.rb",
          "views/gem.erb||views/gem.erb",
          "views/index.erb||views/index.erb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "Gemfile.lock||Gemfile.lock",
            "lib/gemirro/server.rb||lib/gemirro/server.rb",
            "views/gem.erb||views/gem.erb"
          ],
          "candidate": [
            "Gemfile.lock||Gemfile.lock",
            "lib/gemirro/server.rb||lib/gemirro/server.rb",
            "views/gem.erb||views/gem.erb"
          ]
        }
      },
      "candidate_diff": {
        "Gemfile.lock||Gemfile.lock": [
          "File: Gemfile.lock -> Gemfile.lock",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: PATH",
          "2:   remote: .",
          "3:   specs:",
          "5:       builder (~> 3.2)",
          "6:       confstruct (~> 1.0)",
          "7:       httpclient (~> 2.8)",
          "8:       parallel (~> 1.12)",
          "9:       sinatra (~> 2.0)",
          "",
          "[Removed Lines]",
          "4:     gemirro (0.13.5)",
          "",
          "[Added Lines]",
          "4:     gemirro (0.14.0)",
          "7:       erubis (~> 2.7)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "20:     daemons (1.2.5)",
          "21:     diff-lcs (1.3)",
          "22:     docile (1.1.5)",
          "23:     eventmachine (1.2.5)",
          "24:     fakefs (0.11.3)",
          "25:     hashie (3.5.6)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24:     erubis (2.7.0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "27:     json (2.1.0)",
          "28:     mustermann (1.0.1)",
          "29:     parallel (1.12.0)",
          "32:     powerpack (0.1.1)",
          "33:     rack (2.0.3)",
          "34:     rack-protection (2.0.0)",
          "",
          "[Removed Lines]",
          "30:     parser (2.4.0.0)",
          "31:       ast (~> 2.2)",
          "",
          "[Added Lines]",
          "32:     parser (2.4.0.2)",
          "33:       ast (~> 2.3)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "37:       rack (>= 1.0, < 3)",
          "38:     rainbow (2.2.2)",
          "39:       rake",
          "41:     rspec (3.7.0)",
          "42:       rspec-core (~> 3.7.0)",
          "43:       rspec-expectations (~> 3.7.0)",
          "",
          "[Removed Lines]",
          "40:     rake (12.1.0)",
          "",
          "[Added Lines]",
          "42:     rake (12.2.1)",
          "",
          "---------------"
        ],
        "gemirro.gemspec||gemirro.gemspec": [
          "File: gemirro.gemspec -> gemirro.gemspec",
          "--- Hunk 1 ---",
          "[Context before]",
          "20:   s.add_dependency 'builder', '~>3.2'",
          "21:   s.add_dependency 'confstruct', '~>1.0'",
          "22:   s.add_dependency 'httpclient', '~>2.8'",
          "23:   s.add_dependency 'parallel', '~>1.12'",
          "24:   s.add_dependency 'sinatra', '~>2.0'",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22:   s.add_dependency 'erubis', '~>2.7'",
          "",
          "---------------"
        ],
        "lib/gemirro/server.rb||lib/gemirro/server.rb": [
          "File: lib/gemirro/server.rb -> lib/gemirro/server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "261:           Marshal.load(::Gem.inflate(uz_file.read))",
          "262:         end",
          "263:       end",
          "264:     end",
          "265:   end",
          "266: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "265:       ##",
          "266:       # Escape string",
          "267:       #",
          "268:       # @param [String] string",
          "269:       # @return [String]",
          "270:       #",
          "271:       def escape(string)",
          "272:         Rack::Utils.escape_html(string)",
          "273:       end",
          "",
          "---------------"
        ],
        "views/gem.erb||views/gem.erb": [
          "File: views/gem.erb -> views/gem.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "10:       <div class=\"panel panel-info\">",
          "11:         <div class=\"panel-heading\">",
          "12:           <a href=\"<%= url(\"gem/#{name}\") %>\">",
          "14:           </a>",
          "15:         </div>",
          "16:         <div class=\"panel-body\">",
          "17:           <% newest_gem = versions.newest %>",
          "18:           <% if spec = spec_for(name, newest_gem.number, newest_gem.platform) %>",
          "21:             <h3>Dependencies</h3>",
          "22:             <ul class=\"list-group\">",
          "23:               <% spec.dependencies.each do |dependency| %>",
          "24:                 <li class=\"list-group-item\">",
          "26:                 </li>",
          "27:               <% end %>",
          "28:             </ul>",
          "",
          "[Removed Lines]",
          "13:             <h2 class=\"panel-title\"><%= name %> <span class=\"badge pull-right\"><%= versions.newest.number %></span></h2>",
          "19:             <p><%= spec.description %></p>",
          "25:                   <a href=\"<%= url(\"gem/#{dependency.name}\") %>\"><%= [dependency.name, dependency.requirement].join(' ') %></a>",
          "",
          "[Added Lines]",
          "13:             <h2 class=\"panel-title\"><%= escape(name) %> <span class=\"badge pull-right\"><%= escape(versions.newest.number) %></span></h2>",
          "19:             <p><%= escape(spec.description) %></p>",
          "25:                   <a href=\"<%= url(\"gem/#{dependency.name}\") %>\"><%= escape([dependency.name, dependency.requirement].join(' ')) %></a>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "31:             <ul class=\"list-group\">",
          "32:               <% spec.authors.each do |author| %>",
          "33:                 <li class=\"list-group-item\">",
          "35:                 </li>",
          "36:               <% end %>",
          "37:             </ul>",
          "",
          "[Removed Lines]",
          "34:                   <a href=\"<%= spec.homepage %>\"><%= author %></a>",
          "",
          "[Added Lines]",
          "34:                   <a href=\"<%= escape(spec.homepage) %>\"><%= escape(author) %></a>",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "42:           <% versions.each.reverse_each do |version| %>",
          "43:             <li class=\"list-group-item clearfix\">",
          "44:               <p class=\"pull-left\">",
          "46:                 <% unless version.platform =~ /^ruby/i %>",
          "48:                 <% end %>",
          "49:               </p>",
          "50:               <div class=\"pull-right\">",
          "",
          "[Removed Lines]",
          "45:                 <code>gem install <%= version.name %> -v \"<%= version.number %>\"</code>",
          "47:                   <small class=\"platform\"><%= version.platform %></small>",
          "",
          "[Added Lines]",
          "45:                 <code>gem install <%= escape(version.name) %> -v \"<%= escape(version.number) %>\"</code>",
          "47:                   <small class=\"platform\"><%= escape(version.platform) %></small>",
          "",
          "---------------"
        ],
        "views/index.erb||views/index.erb": [
          "File: views/index.erb -> views/index.erb",
          "--- Hunk 1 ---",
          "[Context before]",
          "12:         <div class=\"panel panel-info\">",
          "13:           <div class=\"panel-heading\">",
          "14:             <a href=\"<%= url(\"gem/#{name}\") %>\">",
          "16:             </a>",
          "17:           </div>",
          "19:           <div class=\"panel-body\">",
          "20:             <% spec = spec_for(name, versions.newest.number) %>",
          "21:             <% if spec.is_a?(::Gem::Specification) %>",
          "23:             <% end %>",
          "25:             <% versions.reverse_each.first(5).each do |version| %>",
          "26:               <p>",
          "28:                 <% unless version.platform =~ /^ruby/i %>",
          "30:                 <% end %>",
          "31:               </p>",
          "32:             <% end %>",
          "",
          "[Removed Lines]",
          "15:               <h2 class=\"panel-title\"><%= name %> <span class=\"badge pull-right\"><%= versions.newest.number %></span></h2>",
          "22:               <%= spec.description %>",
          "27:                 <code>gem install <%= version.name %> <%= \"--prerelease\" if version.number.to_s.match(/[a-z]/i) %> -v \"<%= version.number %>\"</code>",
          "29:                   <small class=\"platform\"><%= version.platform %></small>",
          "",
          "[Added Lines]",
          "15:               <h2 class=\"panel-title\"><%= escape(name) %> <span class=\"badge pull-right\"><%= escape(versions.newest.number) %></span></h2>",
          "22:               <%= escape(spec.description) %>",
          "27:                 <code>gem install <%= escape(version.name) %> <%= \"--prerelease\" if version.number.to_s.match(/[a-z]/i) %> -v \"<%= escape(version.number) %>\"</code>",
          "29:                   <small class=\"platform\"><%= escape(version.platform) %></small>",
          "",
          "---------------"
        ]
      }
    }
  ]
}