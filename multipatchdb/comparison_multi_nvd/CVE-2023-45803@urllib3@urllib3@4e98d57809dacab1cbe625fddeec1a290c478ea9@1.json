{
  "cve_id": "CVE-2023-45803",
  "cve_desc": "urllib3 is a user-friendly HTTP client library for Python. urllib3 previously wouldn't remove the HTTP request body when an HTTP redirect response using status 301, 302, or 303 after the request had its method changed from one that could accept a request body (like `POST`) to `GET` as is required by HTTP RFCs. Although this behavior is not specified in the section for redirects, it can be inferred by piecing together information from different sections and we have observed the behavior in other major HTTP client implementations like curl and web browsers. Because the vulnerability requires a previously trusted service to become compromised in order to have an impact on confidentiality we believe the exploitability of this vulnerability is low. Additionally, many users aren't putting sensitive data in HTTP request bodies, if this is the case then this vulnerability isn't exploitable. Both of the following conditions must be true to be affected by this vulnerability: 1. Using urllib3 and submitting sensitive information in the HTTP request body (such as form data or JSON) and 2. The origin service is compromised and starts redirecting using 301, 302, or 303 to a malicious peer or the redirected-to service becomes compromised. This issue has been addressed in versions 1.26.18 and 2.0.7 and users are advised to update to resolve this issue. Users unable to update should disable redirects for services that aren't expecting to respond with redirects with `redirects=False` and disable automatic redirects with `redirects=False` and handle 301, 302, and 303 redirects manually by stripping the HTTP request body.",
  "repo": "urllib3/urllib3",
  "patch_hash": "4e98d57809dacab1cbe625fddeec1a290c478ea9",
  "patch_info": {
    "commit_hash": "4e98d57809dacab1cbe625fddeec1a290c478ea9",
    "repo": "urllib3/urllib3",
    "commit_url": "https://github.com/urllib3/urllib3/commit/4e98d57809dacab1cbe625fddeec1a290c478ea9",
    "files": [
      ".readthedocs.yml",
      "CHANGES.rst",
      "dummyserver/handlers.py",
      "src/urllib3/_collections.py",
      "src/urllib3/_version.py",
      "src/urllib3/connectionpool.py",
      "src/urllib3/poolmanager.py",
      "test/with_dummyserver/test_connectionpool.py",
      "test/with_dummyserver/test_poolmanager.py"
    ],
    "message": "Bring 2.0.7 & 1.26.18 to main (#3161)\n\n* Merge pull request from GHSA-g4mx-q9vg-27p4\n\n* Release 2.0.7",
    "before_after_code_files": [
      "dummyserver/handlers.py||dummyserver/handlers.py",
      "src/urllib3/_collections.py||src/urllib3/_collections.py",
      "src/urllib3/_version.py||src/urllib3/_version.py",
      "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py",
      "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py",
      "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py",
      "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py"
    ]
  },
  "patch_diff": {
    "dummyserver/handlers.py||dummyserver/handlers.py": [
      "File: dummyserver/handlers.py -> dummyserver/handlers.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "281:     def headers(self, request: httputil.HTTPServerRequest) -> Response:",
      "282:         return Response(json.dumps(dict(request.headers)))",
      "284:     def multi_headers(self, request: httputil.HTTPServerRequest) -> Response:",
      "285:         return Response(json.dumps({\"headers\": list(request.headers.get_all())}))",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "284:     def headers_and_params(self, request: httputil.HTTPServerRequest) -> Response:",
      "285:         params = request_params(request)",
      "286:         return Response(",
      "287:             json.dumps({\"headers\": dict(request.headers), \"params\": params})",
      "288:         )",
      "",
      "---------------"
    ],
    "src/urllib3/_collections.py||src/urllib3/_collections.py": [
      "File: src/urllib3/_collections.py -> src/urllib3/_collections.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "10:     # dependency, and is not available at runtime.",
      "11:     from typing import Protocol",
      "13:     class HasGettableStringKeys(Protocol):",
      "14:         def keys(self) -> typing.Iterator[str]:",
      "15:             ...",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     from typing_extensions import Self",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "391:             # meets our external interface requirement of `Union[List[str], _DT]`.",
      "392:             return vals[1:]",
      "394:     # Backwards compatibility for httplib",
      "395:     getheaders = getlist",
      "396:     getallmatchingheaders = getlist",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "396:     def _prepare_for_method_change(self) -> Self:",
      "397:         \"\"\"",
      "398:         Remove content-specific header fields before changing the request",
      "399:         method to GET or HEAD according to RFC 9110, Section 15.4.",
      "400:         \"\"\"",
      "401:         content_specific_headers = [",
      "402:             \"Content-Encoding\",",
      "403:             \"Content-Language\",",
      "404:             \"Content-Location\",",
      "405:             \"Content-Type\",",
      "406:             \"Content-Length\",",
      "407:             \"Digest\",",
      "408:             \"Last-Modified\",",
      "409:         ]",
      "410:         for header in content_specific_headers:",
      "411:             self.discard(header)",
      "412:         return self",
      "",
      "---------------"
    ],
    "src/urllib3/_version.py||src/urllib3/_version.py": [
      "File: src/urllib3/_version.py -> src/urllib3/_version.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: # This file is protected via CODEOWNERS",
      "2: from __future__ import annotations",
      "",
      "[Removed Lines]",
      "4: __version__ = \"2.0.6\"",
      "",
      "[Added Lines]",
      "4: __version__ = \"2.0.7\"",
      "",
      "---------------"
    ],
    "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py": [
      "File: src/urllib3/connectionpool.py -> src/urllib3/connectionpool.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "11: from types import TracebackType",
      "13: from ._base_connection import _TYPE_BODY",
      "14: from ._request_methods import RequestMethods",
      "15: from .connection import (",
      "16:     BaseSSLError,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14: from ._collections import HTTPHeaderDict",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "892:         redirect_location = redirect and response.get_redirect_location()",
      "893:         if redirect_location:",
      "894:             if response.status == 303:",
      "895:                 method = \"GET\"",
      "897:             try:",
      "898:                 retries = retries.increment(method, url, response=response, _pool=self)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "896:                 # Change the method according to RFC 9110, Section 15.4.4.",
      "898:                 # And lose the body not to transfer anything sensitive.",
      "899:                 body = None",
      "900:                 headers = HTTPHeaderDict(headers)._prepare_for_method_change()",
      "",
      "---------------"
    ],
    "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py": [
      "File: src/urllib3/poolmanager.py -> src/urllib3/poolmanager.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "7: from types import TracebackType",
      "8: from urllib.parse import urljoin",
      "11: from ._request_methods import RequestMethods",
      "12: from .connection import ProxyConfig",
      "13: from .connectionpool import HTTPConnectionPool, HTTPSConnectionPool, port_by_scheme",
      "",
      "[Removed Lines]",
      "10: from ._collections import RecentlyUsedContainer",
      "",
      "[Added Lines]",
      "10: from ._collections import HTTPHeaderDict, RecentlyUsedContainer",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "448:         # Support relative URLs for redirecting.",
      "449:         redirect_location = urljoin(url, redirect_location)",
      "452:         if response.status == 303:",
      "453:             method = \"GET\"",
      "455:         retries = kw.get(\"retries\")",
      "456:         if not isinstance(retries, Retry):",
      "",
      "[Removed Lines]",
      "451:         # RFC 7231, Section 6.4.4",
      "",
      "[Added Lines]",
      "452:             # Change the method according to RFC 9110, Section 15.4.4.",
      "454:             # And lose the body not to transfer anything sensitive.",
      "455:             kw[\"body\"] = None",
      "456:             kw[\"headers\"] = HTTPHeaderDict(kw[\"headers\"])._prepare_for_method_change()",
      "",
      "---------------"
    ],
    "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py": [
      "File: test/with_dummyserver/test_connectionpool.py -> test/with_dummyserver/test_connectionpool.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "480:             assert r.status == 200",
      "481:             assert r.data == b\"Dummy server!\"",
      "483:     def test_bad_connect(self) -> None:",
      "484:         with HTTPConnectionPool(\"badhost.invalid\", self.port) as pool:",
      "485:             with pytest.raises(MaxRetryError) as e:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "483:     def test_303_redirect_makes_request_lose_body(self) -> None:",
      "484:         with HTTPConnectionPool(self.host, self.port) as pool:",
      "485:             response = pool.request(",
      "486:                 \"POST\",",
      "487:                 \"/redirect\",",
      "488:                 fields={\"target\": \"/headers_and_params\", \"status\": \"303 See Other\"},",
      "489:             )",
      "490:         data = response.json()",
      "491:         assert data[\"params\"] == {}",
      "492:         assert \"Content-Type\" not in HTTPHeaderDict(data[\"headers\"])",
      "",
      "---------------"
    ],
    "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py": [
      "File: test/with_dummyserver/test_poolmanager.py -> test/with_dummyserver/test_poolmanager.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "244:             assert r._pool.num_connections == 1",
      "245:             assert len(http.pools) == 1",
      "247:     def test_unknown_scheme(self) -> None:",
      "248:         with PoolManager() as http:",
      "249:             unknown_scheme = \"unknown\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "247:     def test_303_redirect_makes_request_lose_body(self) -> None:",
      "248:         with PoolManager() as http:",
      "249:             response = http.request(",
      "250:                 \"POST\",",
      "251:                 f\"{self.base_url}/redirect\",",
      "252:                 fields={",
      "253:                     \"target\": f\"{self.base_url}/headers_and_params\",",
      "254:                     \"status\": \"303 See Other\",",
      "255:                 },",
      "256:             )",
      "257:         data = response.json()",
      "258:         assert data[\"params\"] == {}",
      "259:         assert \"Content-Type\" not in HTTPHeaderDict(data[\"headers\"])",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b594c5ceaca38e1ac215f916538fb128e3526a36",
      "candidate_info": {
        "commit_hash": "b594c5ceaca38e1ac215f916538fb128e3526a36",
        "repo": "urllib3/urllib3",
        "commit_url": "https://github.com/urllib3/urllib3/commit/b594c5ceaca38e1ac215f916538fb128e3526a36",
        "files": [
          "dummyserver/handlers.py",
          "src/urllib3/_collections.py",
          "src/urllib3/connectionpool.py",
          "src/urllib3/poolmanager.py",
          "test/with_dummyserver/test_connectionpool.py",
          "test/with_dummyserver/test_poolmanager.py"
        ],
        "message": "Merge pull request from GHSA-g4mx-q9vg-27p4",
        "before_after_code_files": [
          "dummyserver/handlers.py||dummyserver/handlers.py",
          "src/urllib3/_collections.py||src/urllib3/_collections.py",
          "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py",
          "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py",
          "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py",
          "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "dummyserver/handlers.py||dummyserver/handlers.py",
            "src/urllib3/_collections.py||src/urllib3/_collections.py",
            "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py",
            "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py",
            "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py",
            "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py"
          ],
          "candidate": [
            "dummyserver/handlers.py||dummyserver/handlers.py",
            "src/urllib3/_collections.py||src/urllib3/_collections.py",
            "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py",
            "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py",
            "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py",
            "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py"
          ]
        }
      },
      "candidate_diff": {
        "dummyserver/handlers.py||dummyserver/handlers.py": [
          "File: dummyserver/handlers.py -> dummyserver/handlers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "186:         status = request.params.get(\"status\", \"303 See Other\")",
          "187:         if len(status) == 3:",
          "188:             status = \"%s Redirect\" % status.decode(\"latin-1\")",
          "190:         headers = [(\"Location\", target)]",
          "191:         return Response(status=status, headers=headers)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "189:         elif isinstance(status, bytes):",
          "190:             status = status.decode(\"latin-1\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "264:     def headers(self, request):",
          "265:         return Response(json.dumps(dict(request.headers)))",
          "267:     def successful_retry(self, request):",
          "268:         \"\"\"Handler which will return an error and then success",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "269:     def headers_and_params(self, request):",
          "270:         return Response(",
          "271:             json.dumps({\"headers\": dict(request.headers), \"params\": request.params})",
          "272:         )",
          "",
          "---------------"
        ],
        "src/urllib3/_collections.py||src/urllib3/_collections.py": [
          "File: src/urllib3/_collections.py -> src/urllib3/_collections.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:         else:",
          "269:             return vals[1:]",
          "271:     # Backwards compatibility for httplib",
          "272:     getheaders = getlist",
          "273:     getallmatchingheaders = getlist",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271:     def _prepare_for_method_change(self):",
          "272:         \"\"\"",
          "273:         Remove content-specific header fields before changing the request",
          "274:         method to GET or HEAD according to RFC 9110, Section 15.4.",
          "275:         \"\"\"",
          "276:         content_specific_headers = [",
          "277:             \"Content-Encoding\",",
          "278:             \"Content-Language\",",
          "279:             \"Content-Location\",",
          "280:             \"Content-Type\",",
          "281:             \"Content-Length\",",
          "282:             \"Digest\",",
          "283:             \"Last-Modified\",",
          "284:         ]",
          "285:         for header in content_specific_headers:",
          "286:             self.discard(header)",
          "287:         return self",
          "",
          "---------------"
        ],
        "src/urllib3/connectionpool.py||src/urllib3/connectionpool.py": [
          "File: src/urllib3/connectionpool.py -> src/urllib3/connectionpool.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: from socket import error as SocketError",
          "10: from socket import timeout as SocketTimeout",
          "12: from .connection import (",
          "13:     BaseSSLError,",
          "14:     BrokenPipeError,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12: from ._collections import HTTPHeaderDict",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "843:         redirect_location = redirect and response.get_redirect_location()",
          "844:         if redirect_location:",
          "845:             if response.status == 303:",
          "846:                 method = \"GET\"",
          "848:             try:",
          "849:                 retries = retries.increment(method, url, response=response, _pool=self)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "847:                 # Change the method according to RFC 9110, Section 15.4.4.",
          "849:                 # And lose the body not to transfer anything sensitive.",
          "850:                 body = None",
          "851:                 headers = HTTPHeaderDict(headers)._prepare_for_method_change()",
          "",
          "---------------"
        ],
        "src/urllib3/poolmanager.py||src/urllib3/poolmanager.py": [
          "File: src/urllib3/poolmanager.py -> src/urllib3/poolmanager.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: import functools",
          "5: import logging",
          "8: from .connectionpool import HTTPConnectionPool, HTTPSConnectionPool, port_by_scheme",
          "9: from .exceptions import (",
          "10:     LocationValueError,",
          "",
          "[Removed Lines]",
          "7: from ._collections import RecentlyUsedContainer",
          "",
          "[Added Lines]",
          "7: from ._collections import HTTPHeaderDict, RecentlyUsedContainer",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "382:         # Support relative URLs for redirecting.",
          "383:         redirect_location = urljoin(url, redirect_location)",
          "386:         if response.status == 303:",
          "387:             method = \"GET\"",
          "389:         retries = kw.get(\"retries\")",
          "390:         if not isinstance(retries, Retry):",
          "",
          "[Removed Lines]",
          "385:         # RFC 7231, Section 6.4.4",
          "",
          "[Added Lines]",
          "386:             # Change the method according to RFC 9110, Section 15.4.4.",
          "388:             # And lose the body not to transfer anything sensitive.",
          "389:             kw[\"body\"] = None",
          "390:             kw[\"headers\"] = HTTPHeaderDict(kw[\"headers\"])._prepare_for_method_change()",
          "",
          "---------------"
        ],
        "test/with_dummyserver/test_connectionpool.py||test/with_dummyserver/test_connectionpool.py": [
          "File: test/with_dummyserver/test_connectionpool.py -> test/with_dummyserver/test_connectionpool.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "464:             assert r.status == 200",
          "465:             assert r.data == b\"Dummy server!\"",
          "467:     def test_bad_connect(self):",
          "468:         with HTTPConnectionPool(\"badhost.invalid\", self.port) as pool:",
          "469:             with pytest.raises(MaxRetryError) as e:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "467:     def test_303_redirect_makes_request_lose_body(self):",
          "468:         with HTTPConnectionPool(self.host, self.port) as pool:",
          "469:             response = pool.request(",
          "470:                 \"POST\",",
          "471:                 \"/redirect\",",
          "472:                 fields={\"target\": \"/headers_and_params\", \"status\": \"303 See Other\"},",
          "473:             )",
          "474:         data = json.loads(response.data)",
          "475:         assert data[\"params\"] == {}",
          "476:         assert \"Content-Type\" not in HTTPHeaderDict(data[\"headers\"])",
          "",
          "---------------"
        ],
        "test/with_dummyserver/test_poolmanager.py||test/with_dummyserver/test_poolmanager.py": [
          "File: test/with_dummyserver/test_poolmanager.py -> test/with_dummyserver/test_poolmanager.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: from dummyserver.server import HAS_IPV6",
          "7: from dummyserver.testcase import HTTPDummyServerTestCase, IPv6HTTPDummyServerTestCase",
          "8: from urllib3.connectionpool import port_by_scheme",
          "9: from urllib3.exceptions import MaxRetryError, URLSchemeUnknown",
          "10: from urllib3.poolmanager import PoolManager",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: from urllib3._collections import HTTPHeaderDict",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "236:             assert r._pool.num_connections == 1",
          "237:             assert len(http.pools) == 1",
          "239:     def test_unknown_scheme(self):",
          "240:         with PoolManager() as http:",
          "241:             unknown_scheme = \"unknown\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "240:     def test_303_redirect_makes_request_lose_body(self):",
          "241:         with PoolManager() as http:",
          "242:             response = http.request(",
          "243:                 \"POST\",",
          "244:                 \"%s/redirect\" % self.base_url,",
          "245:                 fields={",
          "246:                     \"target\": \"%s/headers_and_params\" % self.base_url,",
          "247:                     \"status\": \"303 See Other\",",
          "248:                 },",
          "249:             )",
          "250:         data = json.loads(response.data)",
          "251:         assert data[\"params\"] == {}",
          "252:         assert \"Content-Type\" not in HTTPHeaderDict(data[\"headers\"])",
          "",
          "---------------"
        ]
      }
    }
  ]
}