{
  "cve_id": "CVE-2022-4690",
  "cve_desc": "Cross-site Scripting (XSS) - Stored in GitHub repository usememos/memos prior to 0.9.0.",
  "repo": "usememos/memos",
  "patch_hash": "c07b4a57caa89905e54b800f4d8fb720bbf5bf82",
  "patch_info": {
    "commit_hash": "c07b4a57caa89905e54b800f4d8fb720bbf5bf82",
    "repo": "usememos/memos",
    "commit_url": "https://github.com/usememos/memos/commit/c07b4a57caa89905e54b800f4d8fb720bbf5bf82",
    "files": [
      "server/resource.go",
      "server/server.go"
    ],
    "message": "feat: add secure middleware (#832)",
    "before_after_code_files": [
      "server/resource.go||server/resource.go",
      "server/server.go||server/server.go"
    ]
  },
  "patch_diff": {
    "server/resource.go||server/resource.go": [
      "File: server/resource.go -> server/resource.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "7:  \"net/http\"",
      "8:  \"net/url\"",
      "9:  \"strconv\"",
      "11:  \"time\"",
      "13:  \"github.com/usememos/memos/api\"",
      "",
      "[Removed Lines]",
      "10:  \"strings\"",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "263:    return echo.NewHTTPError(http.StatusInternalServerError, fmt.Sprintf(\"Failed to fetch resource ID: %v\", resourceID)).SetInternal(err)",
      "264:   }",
      "271:   c.Response().Writer.WriteHeader(http.StatusOK)",
      "272:   c.Response().Writer.Header().Set(echo.HeaderCacheControl, \"max-age=31536000, immutable\")",
      "273:   if _, err := c.Response().Writer.Write(resource.Blob); err != nil {",
      "",
      "[Removed Lines]",
      "266:   if strings.HasPrefix(resource.Type, echo.MIMETextHTML) {",
      "267:    c.Response().Writer.Header().Set(\"Content-Type\", echo.MIMETextPlain)",
      "268:   } else {",
      "269:    c.Response().Writer.Header().Set(\"Content-Type\", resource.Type)",
      "270:   }",
      "",
      "[Added Lines]",
      "265:   c.Response().Writer.Header().Set(\"Content-Type\", resource.Type)",
      "",
      "---------------"
    ],
    "server/server.go||server/server.go": [
      "File: server/server.go -> server/server.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "44:   Timeout:      30 * time.Second,",
      "45:  }))",
      "47:  embedFrontend(e)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "47:  e.Use(middleware.SecureWithConfig(middleware.SecureConfig{",
      "48:   ContentSecurityPolicy: \"default-src 'self'\",",
      "49:  }))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "46c13a4b7f675b92d297df6dabb4441f13c7cd9c",
      "candidate_info": {
        "commit_hash": "46c13a4b7f675b92d297df6dabb4441f13c7cd9c",
        "repo": "usememos/memos",
        "commit_url": "https://github.com/usememos/memos/commit/46c13a4b7f675b92d297df6dabb4441f13c7cd9c",
        "files": [
          "server/common.go",
          "server/resource.go",
          "server/server.go",
          "server/version/version.go",
          "server/version/version_test.go",
          "store/db/migration/prod/0.10/00__activity.sql",
          "store/db/migration/prod/LATEST__SCHEMA.sql",
          "web/src/components/EmbedMemoDialog.tsx"
        ],
        "message": "chore: add skipper for secure (#913)",
        "before_after_code_files": [
          "server/common.go||server/common.go",
          "server/resource.go||server/resource.go",
          "server/server.go||server/server.go",
          "server/version/version.go||server/version/version.go",
          "server/version/version_test.go||server/version/version_test.go",
          "store/db/migration/prod/0.10/00__activity.sql||store/db/migration/prod/0.10/00__activity.sql",
          "store/db/migration/prod/LATEST__SCHEMA.sql||store/db/migration/prod/LATEST__SCHEMA.sql",
          "web/src/components/EmbedMemoDialog.tsx||web/src/components/EmbedMemoDialog.tsx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "server/resource.go||server/resource.go",
            "server/server.go||server/server.go"
          ],
          "candidate": [
            "server/resource.go||server/resource.go",
            "server/server.go||server/server.go"
          ]
        }
      },
      "candidate_diff": {
        "server/common.go||server/common.go": [
          "File: server/common.go -> server/common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: package server",
          "3: import (",
          "4:  \"github.com/labstack/echo/v4\"",
          "5:  \"github.com/usememos/memos/api\"",
          "6:  \"github.com/usememos/memos/common\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4:  \"net/http\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "16:  }",
          "17: }",
          "19: func (server *Server) DefaultAuthSkipper(c echo.Context) bool {",
          "20:  ctx := c.Request().Context()",
          "21:  path := c.Path()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "21: func DefaultGetRequestSkipper(c echo.Context) bool {",
          "22:  return c.Request().Method == http.MethodGet",
          "23: }",
          "",
          "---------------"
        ],
        "server/resource.go||server/resource.go": [
          "File: server/resource.go -> server/resource.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "7:  \"net/http\"",
          "8:  \"net/url\"",
          "9:  \"strconv\"",
          "10:  \"time\"",
          "12:  \"github.com/pkg/errors\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10:  \"strings\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "266:    return echo.NewHTTPError(http.StatusInternalServerError, fmt.Sprintf(\"Failed to fetch resource ID: %v\", resourceID)).SetInternal(err)",
          "267:   }",
          "270:   c.Response().Writer.WriteHeader(http.StatusOK)",
          "271:   c.Response().Writer.Header().Set(echo.HeaderCacheControl, \"max-age=31536000, immutable\")",
          "272:   c.Response().Writer.Header().Set(echo.HeaderContentSecurityPolicy, \"default-src 'self'\")",
          "",
          "[Removed Lines]",
          "269:   c.Response().Writer.Header().Set(\"Content-Type\", resource.Type)",
          "",
          "[Added Lines]",
          "270:   if strings.HasPrefix(resource.Type, \"text\") || strings.HasPrefix(resource.Type, \"application\") {",
          "271:    c.Response().Writer.Header().Set(\"Content-Type\", echo.MIMETextPlain)",
          "272:   } else {",
          "273:    c.Response().Writer.Header().Set(\"Content-Type\", resource.Type)",
          "274:   }",
          "",
          "---------------"
        ],
        "server/server.go||server/server.go": [
          "File: server/server.go -> server/server.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:  e.Use(middleware.CORS())",
          "69:  e.Use(middleware.TimeoutWithConfig(middleware.TimeoutConfig{",
          "70:   Skipper:      middleware.DefaultSkipper,",
          "",
          "[Removed Lines]",
          "67:  e.Use(middleware.Secure())",
          "",
          "[Added Lines]",
          "67:  e.Use(middleware.SecureWithConfig(middleware.SecureConfig{",
          "68:   Skipper:            DefaultGetRequestSkipper,",
          "69:   XSSProtection:      \"1; mode=block\",",
          "70:   ContentTypeNosniff: \"nosniff\",",
          "71:   XFrameOptions:      \"SAMEORIGIN\",",
          "72:   HSTSPreloadEnabled: false,",
          "73:  }))",
          "",
          "---------------"
        ],
        "server/version/version.go||server/version/version.go": [
          "File: server/version/version.go -> server/version/version.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: func GetCurrentVersion(mode string) string {",
          "16:  if mode == \"dev\" {",
          "",
          "[Removed Lines]",
          "10: var Version = \"0.9.1\"",
          "13: var DevVersion = \"0.9.1\"",
          "",
          "[Added Lines]",
          "10: var Version = \"0.10.0\"",
          "13: var DevVersion = \"0.10.0\"",
          "",
          "---------------"
        ],
        "server/version/version_test.go||server/version/version_test.go": [
          "File: server/version/version_test.go -> server/version/version_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: package version",
          "3: import \"testing\"",
          "5: func TestIsVersionGreaterOrEqualThan(t *testing.T) {",
          "6:  tests := []struct {",
          "7:   version string",
          "8:   target  string",
          "9:   want    bool",
          "10:  }{",
          "11:   {",
          "12:    version: \"0.9.1\",",
          "13:    target:  \"0.9.1\",",
          "14:    want:    true,",
          "15:   },",
          "16:   {",
          "17:    version: \"0.10.0\",",
          "18:    target:  \"0.9.1\",",
          "19:    want:    true,",
          "20:   },",
          "21:   {",
          "22:    version: \"0.9.0\",",
          "23:    target:  \"0.9.1\",",
          "24:    want:    false,",
          "25:   },",
          "26:  }",
          "27:  for _, test := range tests {",
          "28:   result := IsVersionGreaterOrEqualThan(test.version, test.target)",
          "29:   if result != test.want {",
          "30:    t.Errorf(\"got result %v, want %v.\", result, test.want)",
          "31:   }",
          "32:  }",
          "33: }",
          "",
          "---------------"
        ],
        "store/db/migration/prod/0.10/00__activity.sql||store/db/migration/prod/0.10/00__activity.sql": [
          "File: store/db/migration/prod/0.10/00__activity.sql -> store/db/migration/prod/0.10/00__activity.sql",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: -- activity",
          "2: CREATE TABLE activity (",
          "3:   id INTEGER PRIMARY KEY AUTOINCREMENT,",
          "4:   creator_id INTEGER NOT NULL,",
          "5:   created_ts BIGINT NOT NULL DEFAULT (strftime('%s', 'now')),",
          "6:   type TEXT NOT NULL DEFAULT '',",
          "7:   level TEXT NOT NULL CHECK (level IN ('INFO', 'WARN', 'ERROR')) DEFAULT 'INFO',",
          "8:   payload TEXT NOT NULL DEFAULT '{}'",
          "9: );",
          "",
          "---------------"
        ],
        "store/db/migration/prod/LATEST__SCHEMA.sql||store/db/migration/prod/LATEST__SCHEMA.sql": [
          "File: store/db/migration/prod/LATEST__SCHEMA.sql -> store/db/migration/prod/LATEST__SCHEMA.sql",
          "--- Hunk 1 ---",
          "[Context before]",
          "93:   creator_id INTEGER NOT NULL,",
          "94:   UNIQUE(name, creator_id)",
          "95: );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "97: -- activity",
          "98: CREATE TABLE activity (",
          "99:   id INTEGER PRIMARY KEY AUTOINCREMENT,",
          "100:   creator_id INTEGER NOT NULL,",
          "101:   created_ts BIGINT NOT NULL DEFAULT (strftime('%s', 'now')),",
          "102:   type TEXT NOT NULL DEFAULT '',",
          "103:   level TEXT NOT NULL CHECK (level IN ('INFO', 'WARN', 'ERROR')) DEFAULT 'INFO',",
          "104:   payload TEXT NOT NULL DEFAULT '{}'",
          "105: );",
          "",
          "---------------"
        ],
        "web/src/components/EmbedMemoDialog.tsx||web/src/components/EmbedMemoDialog.tsx": [
          "File: web/src/components/EmbedMemoDialog.tsx -> web/src/components/EmbedMemoDialog.tsx",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:           <code className=\"w-full break-all whitespace-pre-wrap\">{memoEmbeddedCode()}</code>",
          "35:         </pre>",
          "36:         <p className=\"w-full text-sm leading-6 flex flex-row justify-between items-center mt-2\">",
          "38:           <span className=\"btn-primary\" onClick={handleCopyCode}>",
          "39:             Copy",
          "40:           </span>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37:           <span className=\"italic opacity-80\">* Only the public memo supports.</span>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "677750ef51079def6f18899128db42daa38dd380",
      "candidate_info": {
        "commit_hash": "677750ef51079def6f18899128db42daa38dd380",
        "repo": "usememos/memos",
        "commit_url": "https://github.com/usememos/memos/commit/677750ef51079def6f18899128db42daa38dd380",
        "files": [
          "Dockerfile",
          "server/metric_collector.go",
          "server/resource.go",
          "server/version/version.go",
          "store/db/db.go"
        ],
        "message": "chore: upgrade version to `0.10.1` (#949)",
        "before_after_code_files": [
          "server/metric_collector.go||server/metric_collector.go",
          "server/resource.go||server/resource.go",
          "server/version/version.go||server/version/version.go",
          "store/db/db.go||store/db/db.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "server/resource.go||server/resource.go"
          ],
          "candidate": [
            "server/resource.go||server/resource.go"
          ]
        }
      },
      "candidate_diff": {
        "server/metric_collector.go||server/metric_collector.go": [
          "File: server/metric_collector.go -> server/metric_collector.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "27:  mc := &MetricCollector{",
          "28:   collector: c,",
          "29:   ID:        s.ID,",
          "31:   Profile:   s.Profile,",
          "32:  }",
          "33:  s.Collector = mc",
          "",
          "[Removed Lines]",
          "30:   Enabled:   true,",
          "",
          "[Added Lines]",
          "30:   Enabled:   false,",
          "",
          "---------------"
        ],
        "server/resource.go||server/resource.go": [
          "File: server/resource.go -> server/resource.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:    return echo.NewHTTPError(http.StatusInternalServerError, fmt.Sprintf(\"Failed to fetch resource ID: %v\", resourceID)).SetInternal(err)",
          "269:   }",
          "273:    resourceType = echo.MIMETextPlain",
          "274:   }",
          "275:   c.Response().Writer.Header().Set(echo.HeaderCacheControl, \"max-age=31536000, immutable\")",
          "",
          "[Removed Lines]",
          "271:   resourceType := resource.Type",
          "272:   if strings.HasPrefix(resource.Type, \"text\") || strings.HasPrefix(resource.Type, \"application\") {",
          "",
          "[Added Lines]",
          "271:   resourceType := strings.ToLower(resource.Type)",
          "272:   if strings.HasPrefix(resourceType, \"text\") || strings.HasPrefix(resourceType, \"application\") {",
          "",
          "---------------"
        ],
        "server/version/version.go||server/version/version.go": [
          "File: server/version/version.go -> server/version/version.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: func GetCurrentVersion(mode string) string {",
          "18:  if mode == \"dev\" {",
          "",
          "[Removed Lines]",
          "12: var Version = \"0.10.0\"",
          "15: var DevVersion = \"0.10.0\"",
          "",
          "[Added Lines]",
          "12: var Version = \"0.10.1\"",
          "15: var DevVersion = \"0.10.1\"",
          "",
          "---------------"
        ],
        "store/db/db.go||store/db/db.go": [
          "File: store/db/db.go -> store/db/db.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:    return fmt.Errorf(\"failed to find migration history, err: %w\", err)",
          "74:   }",
          "75:   if len(migrationHistoryList) == 0 {",
          "77:     Version: currentVersion,",
          "79:     return fmt.Errorf(\"failed to upsert migration history, err: %w\", err)",
          "80:    }",
          "81:    return nil",
          "82:   }",
          "83:   migrationHistoryVersionList := []string{}",
          "84:   for _, migrationHistory := range migrationHistoryList {",
          "85:    migrationHistoryVersionList = append(migrationHistoryVersionList, migrationHistory.Version)",
          "",
          "[Removed Lines]",
          "76:    if _, err = db.UpsertMigrationHistory(ctx, &MigrationHistoryUpsert{",
          "78:    }); err != nil {",
          "",
          "[Added Lines]",
          "76:    _, err := db.UpsertMigrationHistory(ctx, &MigrationHistoryUpsert{",
          "78:    })",
          "79:    if err != nil {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8c146aed68edcc23d551836ae22602f2a641eeb7",
      "candidate_info": {
        "commit_hash": "8c146aed68edcc23d551836ae22602f2a641eeb7",
        "repo": "usememos/memos",
        "commit_url": "https://github.com/usememos/memos/commit/8c146aed68edcc23d551836ae22602f2a641eeb7",
        "files": [
          "server/resource.go",
          "web/src/components/DailyMemo.tsx",
          "web/src/components/MemoResources.tsx",
          "web/src/components/ShareMemoDialog.tsx",
          "web/src/components/common/SquareDiv.tsx",
          "web/src/less/daily-memo.less",
          "web/src/less/explore.less",
          "web/src/less/home.less",
          "web/src/less/memo-resources.less",
          "web/src/less/share-memo-dialog.less"
        ],
        "message": "feat: update memo resources style (#933)\n\n* feat: update memo resources style\n\n* chore: update",
        "before_after_code_files": [
          "server/resource.go||server/resource.go",
          "web/src/components/DailyMemo.tsx||web/src/components/DailyMemo.tsx",
          "web/src/components/MemoResources.tsx||web/src/components/MemoResources.tsx",
          "web/src/components/ShareMemoDialog.tsx||web/src/components/ShareMemoDialog.tsx",
          "web/src/components/common/SquareDiv.tsx||web/src/components/common/SquareDiv.tsx",
          "web/src/less/daily-memo.less||web/src/less/daily-memo.less",
          "web/src/less/explore.less||web/src/less/explore.less",
          "web/src/less/home.less||web/src/less/home.less",
          "web/src/less/memo-resources.less||web/src/less/memo-resources.less",
          "web/src/less/share-memo-dialog.less||web/src/less/share-memo-dialog.less"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "server/resource.go||server/resource.go"
          ],
          "candidate": [
            "server/resource.go||server/resource.go"
          ]
        }
      },
      "candidate_diff": {
        "server/resource.go||server/resource.go": [
          "File: server/resource.go -> server/resource.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: package server",
          "3: import (",
          "4:  \"encoding/json\"",
          "5:  \"fmt\"",
          "6:  \"io\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4:  \"bytes\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "267:    return echo.NewHTTPError(http.StatusInternalServerError, fmt.Sprintf(\"Failed to fetch resource ID: %v\", resourceID)).SetInternal(err)",
          "268:   }",
          "270:   if strings.HasPrefix(resource.Type, \"text\") || strings.HasPrefix(resource.Type, \"application\") {",
          "274:   }",
          "276:   c.Response().Writer.Header().Set(echo.HeaderCacheControl, \"max-age=31536000, immutable\")",
          "277:   c.Response().Writer.Header().Set(echo.HeaderContentSecurityPolicy, \"default-src 'self'\")",
          "282:  })",
          "283: }",
          "",
          "[Removed Lines]",
          "271:    c.Response().Writer.Header().Set(\"Content-Type\", echo.MIMETextPlain)",
          "272:   } else {",
          "273:    c.Response().Writer.Header().Set(\"Content-Type\", resource.Type)",
          "275:   c.Response().Writer.WriteHeader(http.StatusOK)",
          "278:   if _, err := c.Response().Writer.Write(resource.Blob); err != nil {",
          "279:    return echo.NewHTTPError(http.StatusInternalServerError, \"Failed to write response\").SetInternal(err)",
          "280:   }",
          "281:   return nil",
          "",
          "[Added Lines]",
          "271:   resourceType := resource.Type",
          "273:    resourceType = echo.MIMETextPlain",
          "277:   return c.Stream(http.StatusOK, resourceType, bytes.NewReader(resource.Blob))",
          "",
          "---------------"
        ],
        "web/src/components/DailyMemo.tsx||web/src/components/DailyMemo.tsx": [
          "File: web/src/components/DailyMemo.tsx -> web/src/components/DailyMemo.tsx",
          "--- Hunk 1 ---",
          "[Context before]",
          "21:       </div>",
          "22:       <div className=\"memo-container\">",
          "23:         <MemoContent content={memo.content} displayConfig={displayConfig} />",
          "25:       </div>",
          "26:       <div className=\"split-line\"></div>",
          "27:     </div>",
          "",
          "[Removed Lines]",
          "24:         <MemoResources resourceList={memo.resourceList} style=\"col\" />",
          "",
          "[Added Lines]",
          "24:         <MemoResources resourceList={memo.resourceList} />",
          "",
          "---------------"
        ],
        "web/src/components/MemoResources.tsx||web/src/components/MemoResources.tsx": [
          "File: web/src/components/MemoResources.tsx -> web/src/components/MemoResources.tsx",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: import Icon from \"./Icon\";",
          "3: import \"../less/memo-resources.less\";",
          "5: interface Props {",
          "6:   resourceList: Resource[];",
          "7:   className?: string;",
          "9: }",
          "11: const getDefaultProps = (): Props => {",
          "12:   return {",
          "13:     className: \"\",",
          "15:     resourceList: [],",
          "16:   };",
          "17: };",
          "19: const MemoResources: React.FC<Props> = (props: Props) => {",
          "21:     ...getDefaultProps(),",
          "22:     ...props,",
          "23:   };",
          "",
          "[Removed Lines]",
          "1: import Image from \"./Image\";",
          "8:   style?: \"row\" | \"col\";",
          "14:     style: \"row\",",
          "20:   const { className, style, resourceList } = {",
          "",
          "[Added Lines]",
          "1: import { absolutifyLink } from \"../helpers/utils\";",
          "3: import SquareDiv from \"./common/SquareDiv\";",
          "4: import showPreviewImageDialog from \"./PreviewImageDialog\";",
          "20:   const { className, resourceList } = {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "35:       return `/o/r/${resource.id}/${resource.filename}`;",
          "36:     });",
          "38:   return (",
          "56:       <div className=\"other-resource-wrapper\">",
          "57:         {otherResourceList.map((resource) => {",
          "58:           return (",
          "",
          "[Removed Lines]",
          "39:     <div className={`resource-wrapper ${className || \"\"}`}>",
          "40:       {availableResourceList.length > 0 && (",
          "41:         <div className={`images-wrapper ${style}`}>",
          "42:           {availableResourceList.map((resource) => {",
          "43:             const url = `/o/r/${resource.id}/${resource.filename}`;",
          "44:             if (resource.type.startsWith(\"image\")) {",
          "45:               return (",
          "46:                 <Image className=\"memo-resource\" key={resource.id} imgUrls={imgUrls} index={imgUrls.findIndex((item) => item === url)} />",
          "47:               );",
          "48:             } else if (resource.type.startsWith(\"video\")) {",
          "49:               return <video className=\"memo-resource\" controls key={resource.id} src={url} />;",
          "50:             } else {",
          "51:               return null;",
          "52:             }",
          "53:           })}",
          "54:         </div>",
          "55:       )}",
          "",
          "[Added Lines]",
          "38:   const handleImageClick = (imgUrl: string) => {",
          "39:     const index = imgUrls.findIndex((url) => url === imgUrl);",
          "40:     showPreviewImageDialog(imgUrls, index);",
          "41:   };",
          "44:     <>",
          "45:       <div className={`resource-wrapper ${className || \"\"}`}>",
          "46:         {availableResourceList.length > 0 && (",
          "47:           <div className=\"images-wrapper\">",
          "48:             {availableResourceList.map((resource) => {",
          "49:               const url = `/o/r/${resource.id}/${resource.filename}`;",
          "50:               if (resource.type.startsWith(\"image\")) {",
          "51:                 return (",
          "52:                   <SquareDiv key={resource.id} className=\"memo-resource\">",
          "53:                     <img src={absolutifyLink(url)} onClick={() => handleImageClick(url)} decoding=\"async\" loading=\"lazy\" />",
          "54:                   </SquareDiv>",
          "55:                 );",
          "56:               } else if (resource.type.startsWith(\"video\")) {",
          "57:                 return (",
          "58:                   <SquareDiv key={resource.id} className=\"memo-resource\">",
          "59:                     <video preload=\"metadata\" controls key={resource.id}>",
          "60:                       <source src={absolutifyLink(url)} type={resource.type} />",
          "61:                     </video>",
          "62:                   </SquareDiv>",
          "63:                 );",
          "64:               } else {",
          "65:                 return null;",
          "66:               }",
          "67:             })}",
          "68:           </div>",
          "69:         )}",
          "70:       </div>",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "63:           );",
          "64:         })}",
          "65:       </div>",
          "67:   );",
          "68: };",
          "",
          "[Removed Lines]",
          "66:     </div>",
          "",
          "[Added Lines]",
          "81:     </>",
          "",
          "---------------"
        ],
        "web/src/components/ShareMemoDialog.tsx||web/src/components/ShareMemoDialog.tsx": [
          "File: web/src/components/ShareMemoDialog.tsx -> web/src/components/ShareMemoDialog.tsx",
          "--- Hunk 1 ---",
          "[Context before]",
          "135:           <span className=\"time-text\">{memo.createdAtStr}</span>",
          "136:           <div className=\"memo-content-wrapper\">",
          "137:             <MemoContent content={memo.content} displayConfig={{ enableExpand: false }} />",
          "139:           </div>",
          "140:           <div className=\"watermark-container\">",
          "141:             <div className=\"userinfo-container\">",
          "",
          "[Removed Lines]",
          "138:             <MemoResources style=\"col\" resourceList={memo.resourceList} />",
          "",
          "[Added Lines]",
          "138:             <MemoResources resourceList={memo.resourceList} />",
          "",
          "---------------"
        ],
        "web/src/components/common/SquareDiv.tsx||web/src/components/common/SquareDiv.tsx": [
          "File: web/src/components/common/SquareDiv.tsx -> web/src/components/common/SquareDiv.tsx",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import { useEffect, useRef } from \"react\";",
          "3: interface Props {",
          "4:   children: React.ReactNode;",
          "5:   baseSide?: \"width\" | \"height\";",
          "6:   className?: string;",
          "7: }",
          "9: const SquareDiv: React.FC<Props> = (props: Props) => {",
          "10:   const { children, className } = props;",
          "11:   const baseSide = props.baseSide || \"width\";",
          "12:   const squareDivRef = useRef<HTMLDivElement>(null);",
          "14:   useEffect(() => {",
          "15:     const adjustSquareSize = () => {",
          "16:       if (!squareDivRef.current) {",
          "17:         return;",
          "18:       }",
          "20:       if (baseSide === \"width\") {",
          "21:         const width = squareDivRef.current.clientWidth;",
          "22:         squareDivRef.current.style.height = width + \"px\";",
          "23:       } else {",
          "24:         const height = squareDivRef.current.clientHeight;",
          "25:         squareDivRef.current.style.width = height + \"px\";",
          "26:       }",
          "27:     };",
          "29:     adjustSquareSize();",
          "31:     window.addEventListener(\"resize\", adjustSquareSize);",
          "33:     return () => {",
          "34:       window.removeEventListener(\"resize\", adjustSquareSize);",
          "35:     };",
          "36:   }, []);",
          "38:   return (",
          "39:     <div ref={squareDivRef} className={`${[baseSide === \"width\" ? \"w-full\" : \"h-full\", className ?? \"\"].join(\" \")}`}>",
          "40:       {children}",
          "41:     </div>",
          "42:   );",
          "43: };",
          "45: export default SquareDiv;",
          "",
          "---------------"
        ],
        "web/src/less/daily-memo.less||web/src/less/daily-memo.less": [
          "File: web/src/less/daily-memo.less -> web/src/less/daily-memo.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "21:     .memo-content-text {",
          "22:       @apply mt-1;",
          "23:     }",
          "24:   }",
          "25: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25:     > .resource-wrapper {",
          "26:       > .images-wrapper {",
          "27:         @apply !grid-cols-2;",
          "28:       }",
          "29:     }",
          "",
          "---------------"
        ],
        "web/src/less/explore.less||web/src/less/explore.less": [
          "File: web/src/less/explore.less -> web/src/less/explore.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: .page-wrapper.explore {",
          "4:   > .page-container {",
          "5:     @apply relative w-full min-h-full mx-auto flex flex-col justify-start items-center pb-8;",
          "7:     > .page-header {",
          "10:       > .title-container {",
          "11:         @apply flex flex-row justify-start items-center;",
          "",
          "[Removed Lines]",
          "2:   @apply relative top-0 w-full h-full overflow-y-auto overflow-x-hidden bg-zinc-100 dark:bg-zinc-800;",
          "8:       @apply sticky top-0 z-10 max-w-2xl w-full min-h-full flex flex-row justify-between backdrop-blur-sm items-center px-4 sm:pr-6 pt-6 mb-2 ml-calc;",
          "",
          "[Added Lines]",
          "2:   @apply w-full h-full overflow-y-auto overflow-x-hidden bg-zinc-100 dark:bg-zinc-800;",
          "8:       @apply sticky top-0 z-10 max-w-2xl w-full h-auto flex flex-row justify-between backdrop-blur-sm items-center px-4 sm:pr-6 pt-6 mb-2 ml-calc;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "27:     }",
          "29:     > .memos-wrapper {",
          "32:       > .memo-container {",
          "33:         @apply flex flex-col justify-start items-start w-full p-4 mt-2 bg-white dark:bg-zinc-700 rounded-lg border border-white dark:border-zinc-800 hover:border-gray-200 dark:hover:border-zinc-600;",
          "",
          "[Removed Lines]",
          "30:       @apply relative flex-grow max-w-2xl w-full min-h-full flex flex-col justify-start items-start px-4 sm:pr-6 ml-calc;",
          "",
          "[Added Lines]",
          "30:       @apply relative flex-grow max-w-2xl w-full h-auto flex flex-col justify-start items-start px-4 sm:pr-6 ml-calc;",
          "",
          "---------------"
        ],
        "web/src/less/home.less||web/src/less/home.less": [
          "File: web/src/less/home.less -> web/src/less/home.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: .page-wrapper.home {",
          "4:   > .banner-wrapper {",
          "5:     @apply w-full flex flex-col justify-start items-center;",
          "",
          "[Removed Lines]",
          "2:   @apply relative top-0 w-full h-full overflow-y-auto overflow-x-hidden bg-zinc-100 dark:bg-zinc-800;",
          "",
          "[Added Lines]",
          "2:   @apply w-full h-full overflow-y-auto overflow-x-hidden bg-zinc-100 dark:bg-zinc-800;",
          "",
          "---------------"
        ],
        "web/src/less/memo-resources.less||web/src/less/memo-resources.less": [
          "File: web/src/less/memo-resources.less -> web/src/less/memo-resources.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   @apply w-full flex flex-col justify-start items-start;",
          "4:   > .images-wrapper {",
          "7:     > .memo-resource {",
          "10:       > img {",
          "12:       }",
          "36:       }",
          "37:     }",
          "38:   }",
          "53:     }",
          "54:   }",
          "55: }",
          "",
          "[Removed Lines]",
          "5:     @apply w-full flex mt-2 pb-1;",
          "8:       @apply w-auto h-auto shrink-0 grow-0 cursor-pointer rounded;",
          "11:         @apply rounded hover:shadow;",
          "13:     }",
          "15:     &.row {",
          "16:       @apply flex-row justify-start items-start overflow-x-auto overflow-y-hidden;",
          "18:       > .memo-resource {",
          "19:         @apply max-w-xs h-auto max-h-40 mr-2 last:mr-0;",
          "21:         > img {",
          "22:           @apply w-auto max-h-40;",
          "23:         }",
          "24:       }",
          "25:     }",
          "27:     &.col {",
          "28:       @apply flex-col justify-start items-start;",
          "30:       > .memo-resource {",
          "31:         @apply w-full h-auto mb-2 last:mb-0;",
          "33:         > img {",
          "34:           @apply w-full h-auto shadow;",
          "35:         }",
          "40:   > .other-resource-wrapper {",
          "41:     @apply w-full flex flex-row justify-start flex-wrap;",
          "43:     > .other-resource-container {",
          "44:       @apply mt-1 mr-1 max-w-full flex flex-row justify-start items-center flex-nowrap bg-gray-100 px-2 py-1 rounded cursor-pointer hover:bg-gray-200;",
          "46:       > .icon-img {",
          "47:         @apply w-4 h-auto mr-1 text-gray-500;",
          "48:       }",
          "50:       > .name-text {",
          "51:         @apply text-gray-500 text-sm max-w-xs truncate font-mono;",
          "52:       }",
          "",
          "[Added Lines]",
          "5:     @apply w-full grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2;",
          "8:       @apply shadow overflow-auto hide-scrollbar;",
          "11:         @apply cursor-pointer rounded min-h-full w-auto min-w-full object-cover;",
          "14:       > video {",
          "15:         @apply cursor-pointer rounded w-full h-full object-contain bg-zinc-100 dark:bg-zinc-800;",
          "19: }",
          "21: .other-resource-wrapper {",
          "22:   @apply w-full flex flex-row justify-start flex-wrap;",
          "24:   > .other-resource-container {",
          "25:     @apply mt-1 mr-1 max-w-full flex flex-row justify-start items-center flex-nowrap bg-gray-100 px-2 py-1 rounded cursor-pointer hover:bg-gray-200;",
          "27:     > .icon-img {",
          "28:       @apply w-4 h-auto mr-1 text-gray-500;",
          "29:     }",
          "31:     > .name-text {",
          "32:       @apply text-gray-500 text-sm max-w-xs truncate font-mono;",
          "",
          "---------------"
        ],
        "web/src/less/share-memo-dialog.less||web/src/less/share-memo-dialog.less": [
          "File: web/src/less/share-memo-dialog.less -> web/src/less/share-memo-dialog.less",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:         > .memo-content-wrapper {",
          "49:           @apply w-full px-6 text-base pb-4;",
          "57:           }",
          "58:         }",
          "",
          "[Removed Lines]",
          "50:         }",
          "52:         > .images-container {",
          "53:           @apply w-full h-auto flex flex-col justify-start items-start px-6 pb-2;",
          "55:           > img {",
          "56:             @apply w-full h-auto mb-2 rounded;",
          "",
          "[Added Lines]",
          "51:           > .resource-wrapper {",
          "52:             > .images-wrapper {",
          "53:               @apply !grid-cols-2;",
          "54:             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2d14047c73aa8843cc65210a41b2dd5e217dd40a",
      "candidate_info": {
        "commit_hash": "2d14047c73aa8843cc65210a41b2dd5e217dd40a",
        "repo": "usememos/memos",
        "commit_url": "https://github.com/usememos/memos/commit/2d14047c73aa8843cc65210a41b2dd5e217dd40a",
        "files": [
          "server/resource.go"
        ],
        "message": "fix: pdf resource preview (#1008)",
        "before_after_code_files": [
          "server/resource.go||server/resource.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "server/resource.go||server/resource.go"
          ],
          "candidate": [
            "server/resource.go||server/resource.go"
          ]
        }
      },
      "candidate_diff": {
        "server/resource.go||server/resource.go": [
          "File: server/resource.go -> server/resource.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "300:   }",
          "302:   resourceType := strings.ToLower(resource.Type)",
          "304:    resourceType = echo.MIMETextPlain",
          "305:   }",
          "306:   c.Response().Writer.Header().Set(echo.HeaderCacheControl, \"max-age=31536000, immutable\")",
          "",
          "[Removed Lines]",
          "303:   if strings.HasPrefix(resourceType, \"text\") || strings.HasPrefix(resourceType, \"application\") {",
          "",
          "[Added Lines]",
          "303:   if strings.HasPrefix(resourceType, \"text\") || (strings.HasPrefix(resourceType, \"application\") && resourceType != \"application/pdf\") {",
          "",
          "---------------"
        ]
      }
    }
  ]
}