{
  "cve_id": "CVE-2011-4293",
  "cve_desc": "The theme implementation in Moodle 2.0.x before 2.0.4 and 2.1.x before 2.1.1 triggers duplicate caching of Cascading Style Sheets (CSS) and JavaScript content, which allows remote attackers to bypass intended access restrictions and write to an operating-system temporary directory via unspecified vectors.",
  "repo": "moodle/moodle",
  "patch_hash": "e1c2a211f259821910be2cba23679d4176fb00a3",
  "patch_info": {
    "commit_hash": "e1c2a211f259821910be2cba23679d4176fb00a3",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/e1c2a211f259821910be2cba23679d4176fb00a3",
    "files": [
      "theme/javascript.php",
      "theme/styles.php"
    ],
    "message": "MDL-28147 do not double cache theme css/js",
    "before_after_code_files": [
      "theme/javascript.php||theme/javascript.php",
      "theme/styles.php||theme/styles.php"
    ]
  },
  "patch_diff": {
    "theme/javascript.php||theme/javascript.php": [
      "File: theme/javascript.php -> theme/javascript.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "118: }",
      "120: function minify($files) {",
      "123:     if (0 === stripos(PHP_OS, 'win')) {",
      "124:         Minify::setDocRoot(); // IIS may need help",
      "125:     }",
      "128:     $options = array(",
      "129:         'bubbleCssImports' => false,",
      "",
      "[Removed Lines]",
      "121:     global $CFG;",
      "126:     Minify::setCache('', true);",
      "",
      "[Added Lines]",
      "125:     Minify::setCache(null, false);",
      "",
      "---------------"
    ],
    "theme/styles.php||theme/styles.php": [
      "File: theme/styles.php -> theme/styles.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "160:     if (0 === stripos(PHP_OS, 'win')) {",
      "161:         Minify::setDocRoot(); // IIS may need help",
      "162:     }",
      "165:     $options = array(",
      "166:         'bubbleCssImports' => false,",
      "",
      "[Removed Lines]",
      "163:     Minify::setCache('', true);",
      "",
      "[Added Lines]",
      "164:     Minify::setCache(null, false);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8c672cf9f35a1578b706b3a05713be5763299f3f",
      "candidate_info": {
        "commit_hash": "8c672cf9f35a1578b706b3a05713be5763299f3f",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8c672cf9f35a1578b706b3a05713be5763299f3f",
        "files": [
          "lib/csslib.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php",
          "theme/yui_combo.php",
          "theme/yui_image.php"
        ],
        "message": "MDL-32683 explicitly allow more caching of static content",
        "before_after_code_files": [
          "lib/csslib.php||lib/csslib.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php",
          "theme/yui_combo.php||theme/yui_combo.php",
          "theme/yui_image.php||theme/yui_image.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ],
          "candidate": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/csslib.php||lib/csslib.php": [
          "File: lib/csslib.php -> lib/csslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "99:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', time()) .' GMT');",
          "100:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "101:     header('Pragma: ');",
          "103:     header('Accept-Ranges: none');",
          "104:     header('Content-Type: text/css; charset=utf-8');",
          "105:     header('Content-Length: '.strlen($css));",
          "",
          "[Removed Lines]",
          "102:     header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "102:     header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', filemtime($csspath)) .' GMT');",
          "125:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "126:     header('Pragma: ');",
          "128:     header('Accept-Ranges: none');",
          "129:     header('Content-Type: text/css; charset=utf-8');",
          "130:     if (!min_enable_zlib_compression()) {",
          "",
          "[Removed Lines]",
          "127:     header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "127:     header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "82:             $mimetype = get_contenttype_from_ext($ext);",
          "83:             header('HTTP/1.1 304 Not Modified');",
          "84:             header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "86:             header('Content-Type: '.$mimetype);",
          "87:             die;",
          "88:         }",
          "",
          "[Removed Lines]",
          "85:             header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "85:             header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "153:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', time()) .' GMT');",
          "154:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "155:     header('Pragma: ');",
          "157:     header('Accept-Ranges: none');",
          "158:     header('Content-Type: '.$mimetype);",
          "159:     header('Content-Length: '.filesize($imagepath));",
          "",
          "[Removed Lines]",
          "156:     header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "156:     header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         $lifetime = 60*60*24*30; // 30 days",
          "60:         header('HTTP/1.1 304 Not Modified');",
          "61:         header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "63:         header('Content-Type: application/javascript; charset=utf-8');",
          "64:         die;",
          "65:     }",
          "",
          "[Removed Lines]",
          "62:         header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "62:         header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', filemtime($jspath)) .' GMT');",
          "109:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "110:     header('Pragma: ');",
          "112:     header('Accept-Ranges: none');",
          "113:     header('Content-Type: application/javascript; charset=utf-8');",
          "",
          "[Removed Lines]",
          "111:     header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "111:     header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:         $lifetime = 60*60*24*30; // 30 days",
          "65:         header('HTTP/1.1 304 Not Modified');",
          "66:         header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "68:         header('Content-Type: text/css; charset=utf-8');",
          "69:         die;",
          "70:     }",
          "",
          "[Removed Lines]",
          "67:         header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "67:         header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------"
        ],
        "theme/yui_combo.php||theme/yui_combo.php": [
          "File: theme/yui_combo.php -> theme/yui_combo.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "56:     $lifetime = 60*60*24*30; // 30 days",
          "57:     header('HTTP/1.1 304 Not Modified');",
          "58:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "60:     header('Content-Type: '.$mimetype);",
          "61:     die;",
          "62: }",
          "",
          "[Removed Lines]",
          "59:     header('Cache-Control: max-age='.$lifetime);",
          "",
          "[Added Lines]",
          "59:     header('Cache-Control: public, max-age='.$lifetime);",
          "",
          "---------------"
        ],
        "theme/yui_image.php||theme/yui_image.php": [
          "File: theme/yui_image.php -> theme/yui_image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "90:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', filemtime($imagepath)) .' GMT');",
          "91:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "92:     header('Pragma: ');",
          "94:     header('Accept-Ranges: none');",
          "95:     header('Content-Type: '.$mimetype);",
          "96:     header('Content-Length: '.filesize($imagepath));",
          "",
          "[Removed Lines]",
          "93:     header('Cache-Control: max-age=315360000');",
          "",
          "[Added Lines]",
          "93:     header('Cache-Control: public, max-age=315360000');",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e164a0dfeaefcf654d1d5d2cda729f3123fa178a",
      "candidate_info": {
        "commit_hash": "e164a0dfeaefcf654d1d5d2cda729f3123fa178a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/e164a0dfeaefcf654d1d5d2cda729f3123fa178a",
        "files": [
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php"
        ],
        "message": "MDL-30349 clear file stat cache when adding new theme cache files\n\nHopefully this will resolve some cache reset problems.",
        "before_after_code_files": [
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ],
          "candidate": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ]
        }
      },
      "candidate_diff": {
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "115:     $pathinfo = pathinfo($imagefile);",
          "116:     $cacheimage = \"$candidatelocation/$image.\".$pathinfo['extension'];",
          "117:     if (!file_exists($cacheimage)) {",
          "118:         check_dir_exists(dirname($cacheimage));",
          "119:         copy($imagefile, $cacheimage);",
          "120:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "120:         clearstatcache();",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "77: $theme = theme_config::load($themename);",
          "79: if ($rev > -1) {",
          "80:     check_dir_exists(dirname($candidate));",
          "81:     $fp = fopen($candidate, 'w');",
          "82:     fwrite($fp, minify($theme->javascript_files($type)));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:     clearstatcache();",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "114: function store_css(theme_config $theme, $csspath, $cssfiles) {",
          "115:     $css = $theme->post_process(minify($cssfiles));",
          "116:     check_dir_exists(dirname($csspath));",
          "117:     $fp = fopen($csspath, 'w');",
          "118:     fwrite($fp, $css);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "118:     clearstatcache();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7e9f1b63e509263d2143b311862ebcd261226b93",
      "candidate_info": {
        "commit_hash": "7e9f1b63e509263d2143b311862ebcd261226b93",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/7e9f1b63e509263d2143b311862ebcd261226b93",
        "files": [
          "theme/image.php",
          "theme/javascript.php",
          "theme/yui_image.php"
        ],
        "message": "MDL-26028 use X-Sendfile for theme images and javascript",
        "before_after_code_files": [
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/yui_image.php||theme/yui_image.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "theme/javascript.php||theme/javascript.php"
          ],
          "candidate": [
            "theme/javascript.php||theme/javascript.php"
          ]
        }
      },
      "candidate_diff": {
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "140: function send_cached_image($imagepath, $rev) {",
          "141:     $lifetime = 60*60*24*30; // 30 days",
          "142:     $pathinfo = pathinfo($imagepath);",
          "143:     $imagename = $pathinfo['filename'].'.'.$pathinfo['extension'];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "141:     global $CFG;",
          "142:     require(\"$CFG->dirroot/lib/xsendfilelib.php\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "154:     header('Content-Type: '.$mimetype);",
          "155:     header('Content-Length: '.filesize($imagepath));",
          "159:     readfile($imagepath);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "160:     if (xsendfile($imagepath)) {",
          "161:         die;",
          "162:     }",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "101: function send_cached_js($jspath) {",
          "102:     $lifetime = 60*60*24*30; // 30 days",
          "104:     header('Content-Disposition: inline; filename=\"javascript.php\"');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102:     global $CFG;",
          "103:     require(\"$CFG->dirroot/lib/xsendfilelib.php\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108:     header('Cache-Control: max-age='.$lifetime);",
          "109:     header('Accept-Ranges: none');",
          "110:     header('Content-Type: application/javascript; charset=utf-8');",
          "111:     if (!min_enable_zlib_compression()) {",
          "112:         header('Content-Length: '.filesize($jspath));",
          "113:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "115:     if (xsendfile($jspath)) {",
          "116:         die;",
          "117:     }",
          "",
          "---------------"
        ],
        "theme/yui_image.php||theme/yui_image.php": [
          "File: theme/yui_image.php -> theme/yui_image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68: function yui_image_cached($imagepath) {",
          "69:     $lifetime = 60*60*24*300; // 300 days === forever",
          "70:     $pathinfo = pathinfo($imagepath);",
          "71:     $imagename = $pathinfo['filename'].'.'.$pathinfo['extension'];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "69:     global $CFG;",
          "70:     require(\"$CFG->dirroot/lib/xsendfilelib.php\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "88:     header('Content-Type: '.$mimetype);",
          "89:     header('Content-Length: '.filesize($imagepath));",
          "93:     readfile($imagepath);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "94:     if (xsendfile($imagepath)) {",
          "95:         die;",
          "96:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "979d3207222bb2106dff8ea782433994debd3c8b",
      "candidate_info": {
        "commit_hash": "979d3207222bb2106dff8ea782433994debd3c8b",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/979d3207222bb2106dff8ea782433994debd3c8b",
        "files": [
          "lib/csslib.php",
          "lib/javascript.php",
          "lib/jslib.php",
          "theme/image.php",
          "theme/javascript.php",
          "theme/styles.php"
        ],
        "message": "MDL-32825 try to improve atomicity of cache file operations in themes and javascript",
        "before_after_code_files": [
          "lib/csslib.php||lib/csslib.php",
          "lib/javascript.php||lib/javascript.php",
          "lib/jslib.php||lib/jslib.php",
          "theme/image.php||theme/image.php",
          "theme/javascript.php||theme/javascript.php",
          "theme/styles.php||theme/styles.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ],
          "candidate": [
            "theme/javascript.php||theme/javascript.php",
            "theme/styles.php||theme/styles.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/csslib.php||lib/csslib.php": [
          "File: lib/csslib.php -> lib/csslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:         $css = $theme->post_process(css_minify_css($cssfiles));",
          "72:     }",
          "78: }",
          "",
          "[Removed Lines]",
          "74:     check_dir_exists(dirname($csspath));",
          "75:     $fp = fopen($csspath, 'w');",
          "76:     fwrite($fp, $css);",
          "77:     fclose($fp);",
          "",
          "[Added Lines]",
          "74:     clearstatcache();",
          "75:     if (!file_exists(dirname($csspath))) {",
          "76:         @mkdir(dirname($csspath), $CFG->directorypermissions, true);",
          "77:     }",
          "81:     ignore_user_abort(true);",
          "82:     if ($fp = fopen($csspath.'.tmp', 'xb')) {",
          "83:         fwrite($fp, $css);",
          "84:         fclose($fp);",
          "85:         rename($csspath.'.tmp', $csspath);",
          "86:         @chmod($csspath, $CFG->filepermissions);",
          "87:         @unlink($csspath.'.tmp'); // just in case anything fails",
          "88:     }",
          "89:     ignore_user_abort(false);",
          "90:     if (connection_aborted()) {",
          "91:         die;",
          "92:     }",
          "",
          "---------------"
        ],
        "lib/javascript.php||lib/javascript.php": [
          "File: lib/javascript.php -> lib/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:         js_send_cached($candidate, $etag);",
          "90:     } else {",
          "93:         }",
          "98:     }",
          "106: }",
          "",
          "[Removed Lines]",
          "91:         if (!file_exists(dirname($candidate))) {",
          "92:             @mkdir(dirname($candidate), $CFG->directorypermissions, true);",
          "94:         $fp = fopen($candidate, 'w');",
          "95:         fwrite($fp, js_minify($jsfiles));",
          "96:         fclose($fp);",
          "97:         js_send_cached($candidate, $etag);",
          "100: } else {",
          "101:     $content = '';",
          "102:     foreach ($jsfiles as $jsfile) {",
          "103:         $content .= file_get_contents($jsfile).\"\\n\";",
          "104:     }",
          "105:     js_send_uncached($candidate, $etag);",
          "",
          "[Added Lines]",
          "91:         js_write_cache_file_content($candidate, js_minify($jsfiles));",
          "93:         clearstatcache();",
          "94:         if (file_exists($candidate)) {",
          "95:             js_send_cached($candidate, $etag);",
          "98: }",
          "100: $content = '';",
          "101: foreach ($jsfiles as $jsfile) {",
          "102:     $content .= file_get_contents($jsfile).\"\\n\";",
          "104: js_send_uncached($content, $etag);",
          "",
          "---------------"
        ],
        "lib/jslib.php||lib/jslib.php": [
          "File: lib/jslib.php -> lib/jslib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "154:     }",
          "155:     return $js;",
          "156: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "163: function js_write_cache_file_content($file, $content) {",
          "164:     global $CFG;",
          "166:     clearstatcache();",
          "167:     if (!file_exists(dirname($file))) {",
          "168:         @mkdir(dirname($file), $CFG->directorypermissions, true);",
          "169:     }",
          "173:     ignore_user_abort(true);",
          "174:     if ($fp = fopen($file.'.tmp', 'xb')) {",
          "175:         fwrite($fp, $content);",
          "176:         fclose($fp);",
          "177:         rename($file.'.tmp', $file);",
          "178:         @chmod($file, $CFG->filepermissions);",
          "179:         @unlink($file.'.tmp'); // just in case anything fails",
          "180:     }",
          "181:     ignore_user_abort(false);",
          "182:     if (connection_aborted()) {",
          "183:         die;",
          "184:     }",
          "185: }",
          "190: function js_send_css_not_found() {",
          "191:     header('HTTP/1.0 404 not found');",
          "192:     die('JS was not found, sorry.');",
          "193: }",
          "",
          "---------------"
        ],
        "theme/image.php||theme/image.php": [
          "File: theme/image.php -> theme/image.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "135:     image_not_found();",
          "136: }",
          "139: if ($rev > -1) {",
          "140:     $pathinfo = pathinfo($imagefile);",
          "141:     $cacheimage = \"$candidatelocation/$image.\".$pathinfo['extension'];",
          "149:     }",
          "154: }",
          "",
          "[Removed Lines]",
          "142:     if (!file_exists($cacheimage)) {",
          "143:         if (!file_exists(dirname($cacheimage))) {",
          "146:             @mkdir(dirname($cacheimage), $CFG->directorypermissions, true);",
          "147:         }",
          "148:         copy($imagefile, $cacheimage);",
          "150:     send_cached_image($cacheimage, $etag);",
          "152: } else {",
          "153:     send_uncached_image($imagefile);",
          "",
          "[Added Lines]",
          "142:     clearstatcache();",
          "143:     if (!file_exists(dirname($cacheimage))) {",
          "144:         @mkdir(dirname($cacheimage), $CFG->directorypermissions, true);",
          "149:     ignore_user_abort(true);",
          "150:     if (@copy($imagefile, $cacheimage.'.tmp')) {",
          "151:         rename($cacheimage.'.tmp', $cacheimage);",
          "152:         @chmod($cacheimage, $CFG->filepermissions);",
          "153:         @unlink($cacheimage.'.tmp'); // just in case anything fails",
          "154:     }",
          "155:     ignore_user_abort(false);",
          "156:     if (connection_aborted()) {",
          "157:         die;",
          "158:     }",
          "160:     clearstatcache();",
          "161:     if (file_exists($cacheimage)) {",
          "162:         send_cached_image($cacheimage, $etag);",
          "163:     }",
          "166: send_uncached_image($imagefile);",
          "",
          "---------------"
        ],
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "90: $etag = sha1(\"$themename/$rev/$type\");",
          "92: if ($rev > -1) {",
          "95:     clearstatcache();",
          "104: }",
          "",
          "[Removed Lines]",
          "96:     check_dir_exists(dirname($candidate));",
          "97:     $fp = fopen($candidate, 'w');",
          "98:     fwrite($fp, js_minify($theme->javascript_files($type)));",
          "99:     fclose($fp);",
          "100:     js_send_cached($candidate, $etag);",
          "102: } else {",
          "103:     js_send_uncached($theme->javascript_content($type));",
          "",
          "[Added Lines]",
          "93:     js_write_cache_file_content($candidate, js_minify($theme->javascript_files($type)));",
          "96:     if (file_exists($candidate)) {",
          "97:         js_send_cached($candidate, $etag);",
          "98:     }",
          "101: js_send_uncached($theme->javascript_content($type));",
          "",
          "---------------"
        ],
        "theme/styles.php||theme/styles.php": [
          "File: theme/styles.php -> theme/styles.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "118:     $cssfile = \"$CFG->cachedir/theme/$themename/css/all.css\";",
          "119:     css_store_css($theme, $cssfile, $allfiles);",
          "120: }",
          "121: css_send_cached_css($candidatesheet, $etag);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "123: clearstatcache();",
          "124: if (!file_exists($candidatesheet)) {",
          "125:     css_send_css_not_found();",
          "126: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8475b9704ff38c3de23735f8f1f50389e55546c3",
      "candidate_info": {
        "commit_hash": "8475b9704ff38c3de23735f8f1f50389e55546c3",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8475b9704ff38c3de23735f8f1f50389e55546c3",
        "files": [
          "theme/javascript.php"
        ],
        "message": "MDL-32683 fine tune theme javascript caching",
        "before_after_code_files": [
          "theme/javascript.php||theme/javascript.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "theme/javascript.php||theme/javascript.php"
          ],
          "candidate": [
            "theme/javascript.php||theme/javascript.php"
          ]
        }
      },
      "candidate_diff": {
        "theme/javascript.php||theme/javascript.php": [
          "File: theme/javascript.php -> theme/javascript.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64: }",
          "66: $candidate = \"$CFG->cachedir/theme/$themename/javascript_$type.js\";",
          "68: if ($rev > -1 and file_exists($candidate)) {",
          "69:     if (!empty($_SERVER['HTTP_IF_NONE_MATCH']) || !empty($_SERVER['HTTP_IF_MODIFIED_SINCE'])) {",
          "73:         header('HTTP/1.1 304 Not Modified');",
          "74:         header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "75:         header('Cache-Control: public, max-age='.$lifetime);",
          "76:         header('Content-Type: application/javascript; charset=utf-8');",
          "77:         die;",
          "78:     }",
          "80: }",
          "",
          "[Removed Lines]",
          "72:         $lifetime = 60*60*24*30; // 30 days",
          "79:     send_cached_js($candidate, $rev);",
          "",
          "[Added Lines]",
          "67: $etag = sha1(\"$themename/$rev/$type\");",
          "73:         $lifetime = 60*60*24*60; // 60 days only - the revision may get incremented quite often",
          "78:         header('Etag: '.$etag);",
          "81:     send_cached_js($candidate, $etag);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "94: $theme = theme_config::load($themename);",
          "96: if ($rev > -1) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "98: $rev = theme_get_revision();",
          "99: $etag = sha1(\"$themename/$rev/$type\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "101:     $fp = fopen($candidate, 'w');",
          "102:     fwrite($fp, minify($theme->javascript_files($type)));",
          "103:     fclose($fp);",
          "105: } else {",
          "106:     send_uncached_js($theme->javascript_content($type));",
          "107: }",
          "",
          "[Removed Lines]",
          "104:     send_cached_js($candidate);",
          "",
          "[Added Lines]",
          "109:     send_cached_js($candidate, $etag);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "115:     global $CFG;",
          "116:     require(\"$CFG->dirroot/lib/xsendfilelib.php\");",
          "120:     header('Content-Disposition: inline; filename=\"javascript.php\"');",
          "121:     header('Last-Modified: '. gmdate('D, d M Y H:i:s', filemtime($jspath)) .' GMT');",
          "122:     header('Expires: '. gmdate('D, d M Y H:i:s', time() + $lifetime) .' GMT');",
          "",
          "[Removed Lines]",
          "114: function send_cached_js($jspath) {",
          "118:     $lifetime = 60*60*24*30; // 30 days",
          "",
          "[Added Lines]",
          "119: function send_cached_js($jspath, $etag) {",
          "123:     $lifetime = 60*60*24*60; // 60 days only - the revision may get incremented quite often",
          "125:     header('Etag: '.$etag);",
          "",
          "---------------"
        ]
      }
    }
  ]
}