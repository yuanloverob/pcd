{
  "cve_id": "CVE-2021-46876",
  "cve_desc": "An issue was discovered in eZ Publish Ibexa Kernel before 7.5.15.1. The /user/sessions endpoint can be abused to determine account existence.",
  "repo": "ezsystems/ezpublish-kernel",
  "patch_hash": "b496f073c3f03707d3531a6941dc098b84e3cbed",
  "patch_info": {
    "commit_hash": "b496f073c3f03707d3531a6941dc098b84e3cbed",
    "repo": "ezsystems/ezpublish-kernel",
    "commit_url": "https://github.com/ezsystems/ezpublish-kernel/commit/b496f073c3f03707d3531a6941dc098b84e3cbed",
    "files": [
      "eZ/Bundle/EzPublishRestBundle/Resources/config/default_settings.yml",
      "eZ/Bundle/EzPublishRestBundle/Resources/config/security.yml",
      "eZ/Publish/Core/REST/Server/Controller/SessionController.php",
      "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
    ],
    "message": "Merge pull request from GHSA-gmrf-99gw-vvwj\n\nCo-authored-by: Bartek Wajda <bartlomiej.wajda@ibexa.co>",
    "before_after_code_files": [
      "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php",
      "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
    ]
  },
  "patch_diff": {
    "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php": [
      "File: eZ/Publish/Core/REST/Server/Controller/SessionController.php -> eZ/Publish/Core/REST/Server/Controller/SessionController.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "59:             )",
      "60:         );",
      "61:         $request->attributes->set('username', $sessionInput->login);",
      "64:         try {",
      "65:             $session = $request->getSession();",
      "",
      "[Removed Lines]",
      "62:         $request->attributes->set('password', $sessionInput->password);",
      "",
      "[Added Lines]",
      "62:         $request->attributes->set('password', (string) $sessionInput->password);",
      "",
      "---------------"
    ],
    "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php": [
      "File: eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php -> eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "37: class RestAuthenticator implements ListenerInterface, AuthenticatorInterface",
      "38: {",
      "40:     private $logger;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39:     const DEFAULT_MIN_SLEEP_VALUE = 30000;",
      "41:     const DEFAULT_MAX_SLEEP_VALUE = 500000;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "60:     private $logoutHandlers = [];",
      "62:     public function __construct(",
      "63:         TokenStorageInterface $tokenStorage,",
      "64:         AuthenticationManagerInterface $authenticationManager,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "69:     private $minSleepTime;",
      "74:     private $maxSleepTime;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "66:         EventDispatcherInterface $dispatcher,",
      "67:         ConfigResolverInterface $configResolver,",
      "68:         SessionStorageInterface $sessionStorage,",
      "70:     ) {",
      "71:         $this->tokenStorage = $tokenStorage;",
      "72:         $this->authenticationManager = $authenticationManager;",
      "",
      "[Removed Lines]",
      "69:         LoggerInterface $logger = null",
      "",
      "[Added Lines]",
      "83:         LoggerInterface $logger = null,",
      "84:         $minSleepTime = self::DEFAULT_MIN_SLEEP_VALUE,",
      "85:         $maxSleepTime = self::DEFAULT_MAX_SLEEP_VALUE",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "75:         $this->configResolver = $configResolver;",
      "76:         $this->sessionStorage = $sessionStorage;",
      "77:         $this->logger = $logger;",
      "78:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "94:         $this->minSleepTime = !is_int($minSleepTime) ? self::DEFAULT_MIN_SLEEP_VALUE : $minSleepTime;",
      "95:         $this->maxSleepTime = !is_int($maxSleepTime) ? self::DEFAULT_MAX_SLEEP_VALUE : $maxSleepTime;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "90:     public function authenticate(Request $request)",
      "91:     {",
      "94:         $previousToken = $this->tokenStorage->getToken();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "110:         usleep(random_int($this->minSleepTime, $this->maxSleepTime));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0125b590dffac0850babfb84bcdcb51f6d6bbd74",
      "candidate_info": {
        "commit_hash": "0125b590dffac0850babfb84bcdcb51f6d6bbd74",
        "repo": "ezsystems/ezpublish-kernel",
        "commit_url": "https://github.com/ezsystems/ezpublish-kernel/commit/0125b590dffac0850babfb84bcdcb51f6d6bbd74",
        "files": [
          "eZ/Bundle/EzPublishRestBundle/Resources/config/default_settings.yml",
          "eZ/Bundle/EzPublishRestBundle/Resources/config/security.yml",
          "eZ/Publish/Core/REST/Server/Controller/SessionController.php",
          "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
        ],
        "message": "Merge pull request from GHSA-gmrf-99gw-vvwj\n\nCo-authored-by: Bartek Wajda <bartlomiej.wajda@ibexa.co>\n(cherry picked from commit b496f073c3f03707d3531a6941dc098b84e3cbed)",
        "before_after_code_files": [
          "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php",
          "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php",
            "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
          ],
          "candidate": [
            "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php",
            "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
          ]
        }
      },
      "candidate_diff": {
        "eZ/Publish/Core/REST/Server/Controller/SessionController.php||eZ/Publish/Core/REST/Server/Controller/SessionController.php": [
          "File: eZ/Publish/Core/REST/Server/Controller/SessionController.php -> eZ/Publish/Core/REST/Server/Controller/SessionController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:             )",
          "60:         );",
          "61:         $request->attributes->set('username', $sessionInput->login);",
          "64:         try {",
          "65:             $session = $request->getSession();",
          "",
          "[Removed Lines]",
          "62:         $request->attributes->set('password', $sessionInput->password);",
          "",
          "[Added Lines]",
          "62:         $request->attributes->set('password', (string) $sessionInput->password);",
          "",
          "---------------"
        ],
        "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php": [
          "File: eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php -> eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: class RestAuthenticator implements ListenerInterface, AuthenticatorInterface",
          "38: {",
          "40:     private $logger;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:     const DEFAULT_MIN_SLEEP_VALUE = 30000;",
          "41:     const DEFAULT_MAX_SLEEP_VALUE = 500000;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "60:     private $logoutHandlers = [];",
          "62:     public function __construct(",
          "63:         TokenStorageInterface $tokenStorage,",
          "64:         AuthenticationManagerInterface $authenticationManager,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "69:     private $minSleepTime;",
          "74:     private $maxSleepTime;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "66:         EventDispatcherInterface $dispatcher,",
          "67:         ConfigResolverInterface $configResolver,",
          "68:         SessionStorageInterface $sessionStorage,",
          "70:     ) {",
          "71:         $this->tokenStorage = $tokenStorage;",
          "72:         $this->authenticationManager = $authenticationManager;",
          "",
          "[Removed Lines]",
          "69:         LoggerInterface $logger = null",
          "",
          "[Added Lines]",
          "83:         LoggerInterface $logger = null,",
          "84:         $minSleepTime = self::DEFAULT_MIN_SLEEP_VALUE,",
          "85:         $maxSleepTime = self::DEFAULT_MAX_SLEEP_VALUE",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "75:         $this->configResolver = $configResolver;",
          "76:         $this->sessionStorage = $sessionStorage;",
          "77:         $this->logger = $logger;",
          "78:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "94:         $this->minSleepTime = !is_int($minSleepTime) ? self::DEFAULT_MIN_SLEEP_VALUE : $minSleepTime;",
          "95:         $this->maxSleepTime = !is_int($maxSleepTime) ? self::DEFAULT_MAX_SLEEP_VALUE : $maxSleepTime;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "90:     public function authenticate(Request $request)",
          "91:     {",
          "94:         $previousToken = $this->tokenStorage->getToken();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "110:         usleep(random_int($this->minSleepTime, $this->maxSleepTime));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "33edc5305906819db1cca8ec164540225964a32c",
      "candidate_info": {
        "commit_hash": "33edc5305906819db1cca8ec164540225964a32c",
        "repo": "ezsystems/ezpublish-kernel",
        "commit_url": "https://github.com/ezsystems/ezpublish-kernel/commit/33edc5305906819db1cca8ec164540225964a32c",
        "files": [
          "eZ/Bundle/EzPublishRestBundle/Resources/config/default_settings.yml",
          "eZ/Bundle/EzPublishRestBundle/Resources/config/security.yml",
          "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php",
          "eZ/Publish/Core/Repository/UserService.php"
        ],
        "message": "Merge pull request from GHSA-gmrf-99gw-vvwj\n\n* EZP-32156: Advisory fixes for 'user/sessions' endpoint\n\n* EZP-32156: Adjust script execution delay\n\n* EZP-32156: Parametrized usleep call\n\n* Added comment explaining constructor params\n\nCo-authored-by: Gunnstein Lye <gunnstein.lye@ez.no>\n\n* EZP-32156: Introduced sleep constants\n\n* EZP-32156: Initialize boundary times in constructor\n\nCo-authored-by: Bartek Wajda <bartlomiej.wajda@ibexa.co>\nCo-authored-by: Gunnstein Lye <gunnstein.lye@ez.no>\n(cherry picked from commit 4a538dbfd28fecd404f11fa0816b69a5a9e93a16)",
        "before_after_code_files": [
          "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php",
          "eZ/Publish/Core/Repository/UserService.php||eZ/Publish/Core/Repository/UserService.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
          ],
          "candidate": [
            "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php"
          ]
        }
      },
      "candidate_diff": {
        "eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php||eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php": [
          "File: eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php -> eZ/Publish/Core/REST/Server/Security/RestAuthenticator.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: class RestAuthenticator implements ListenerInterface, AuthenticatorInterface",
          "40: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "41:     const DEFAULT_MIN_SLEEP_VALUE = 30000;",
          "43:     const DEFAULT_MAX_SLEEP_VALUE = 500000;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "78:     private $logoutHandlers = [];",
          "80:     public function __construct(",
          "81:         TokenStorageInterface $tokenStorage,",
          "82:         AuthenticationManagerInterface $authenticationManager,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87:     private $minSleepTime;",
          "92:     private $maxSleepTime;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "84:         EventDispatcherInterface $dispatcher,",
          "85:         ConfigResolverInterface $configResolver,",
          "86:         SessionStorageInterface $sessionStorage,",
          "88:     ) {",
          "89:         $this->tokenStorage = $tokenStorage;",
          "90:         $this->authenticationManager = $authenticationManager;",
          "",
          "[Removed Lines]",
          "87:         LoggerInterface $logger = null",
          "",
          "[Added Lines]",
          "101:         LoggerInterface $logger = null,",
          "102:         $minSleepTime = self::DEFAULT_MIN_SLEEP_VALUE,",
          "103:         $maxSleepTime = self::DEFAULT_MAX_SLEEP_VALUE",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "93:         $this->configResolver = $configResolver;",
          "94:         $this->sessionStorage = $sessionStorage;",
          "95:         $this->logger = $logger;",
          "96:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "112:         $this->minSleepTime = !is_int($minSleepTime) ? self::DEFAULT_MIN_SLEEP_VALUE : $minSleepTime;",
          "113:         $this->maxSleepTime = !is_int($maxSleepTime) ? self::DEFAULT_MAX_SLEEP_VALUE : $maxSleepTime;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "108:     public function authenticate(Request $request)",
          "109:     {",
          "112:         $previousToken = $this->tokenStorage->getToken();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128:         usleep(random_int($this->minSleepTime, $this->maxSleepTime));",
          "",
          "---------------"
        ],
        "eZ/Publish/Core/Repository/UserService.php||eZ/Publish/Core/Repository/UserService.php": [
          "File: eZ/Publish/Core/Repository/UserService.php -> eZ/Publish/Core/Repository/UserService.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "572:             throw new InvalidArgumentValue('login', $login);",
          "573:         }",
          "576:             throw new InvalidArgumentValue('password', $password);",
          "577:         }",
          "",
          "[Removed Lines]",
          "575:         if (!is_string($password)) {",
          "",
          "[Added Lines]",
          "575:         if (!is_string($password) && $password !== null) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}