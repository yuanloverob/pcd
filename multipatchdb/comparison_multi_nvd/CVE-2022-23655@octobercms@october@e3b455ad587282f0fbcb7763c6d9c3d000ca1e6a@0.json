{
  "cve_id": "CVE-2022-23655",
  "cve_desc": "Octobercms is a self-hosted CMS platform based on the Laravel PHP Framework. Affected versions of OctoberCMS did not validate gateway server signatures. As a result non-authoritative gateway servers may be used to exfiltrate user private keys. Users are advised to upgrade their installations to build 474 or v1.1.10. The only known workaround is to manually apply the patch (e3b455ad587282f0fbcb7763c6d9c3d000ca1e6a) which adds server signature validation.",
  "repo": "octobercms/october",
  "patch_hash": "e3b455ad587282f0fbcb7763c6d9c3d000ca1e6a",
  "patch_info": {
    "commit_hash": "e3b455ad587282f0fbcb7763c6d9c3d000ca1e6a",
    "repo": "octobercms/october",
    "commit_url": "https://github.com/octobercms/october/commit/e3b455ad587282f0fbcb7763c6d9c3d000ca1e6a",
    "files": [
      "modules/system/classes/UpdateManager.php"
    ],
    "message": "Checks gateway server has a valid signature",
    "before_after_code_files": [
      "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php"
    ]
  },
  "patch_diff": {
    "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php": [
      "File: modules/system/classes/UpdateManager.php -> modules/system/classes/UpdateManager.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "8: use Cache;",
      "9: use Schema;",
      "10: use Config;",
      "11: use ApplicationException;",
      "12: use Cms\\Classes\\ThemeManager;",
      "13: use System\\Models\\Parameter;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "11: use Request;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "885:             throw new ApplicationException(Lang::get('system::lang.server.response_invalid'));",
      "886:         }",
      "888:         return $resultData;",
      "889:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "889:         if (!$this->validateServerSignature($resultData, $result->headers['Rest-Sign'] ?? '')) {",
      "890:             throw new ApplicationException(Lang::get('system::lang.server.response_invalid') . ' (Bad signature)');",
      "891:         }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "964:     protected function applyHttpAttributes($http, $postData)",
      "965:     {",
      "969:         $postData['server'] = base64_encode(json_encode([",
      "970:             'php'   => PHP_VERSION,",
      "971:             'url'   => Url::to('/'),",
      "972:             'since' => PluginVersion::orderBy('created_at')->value('created_at')",
      "973:         ]));",
      "",
      "[Removed Lines]",
      "966:         $postData['protocol_version'] = '1.2';",
      "967:         $postData['client'] = 'october';",
      "",
      "[Added Lines]",
      "971:         $postData['protocol_version'] = '1.3';",
      "972:         $postData['client'] = 'October CMS';",
      "977:             'ip'    => Request::ip(),",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1070:             }",
      "1071:         }",
      "1072:     }",
      "1073: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1085:     protected function validateServerSignature($data, $signature)",
      "1086:     {",
      "1087:         if (!$signature) {",
      "1088:             return false;",
      "1089:         }",
      "1091:         $signature = base64_decode($signature);",
      "1093:         $pubKey = '-----BEGIN PUBLIC KEY-----",
      "1094: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt+KwvTXqC8Mz9vV4KIvX",
      "1095: 3y+aZusrlg26jdbNVUuhXNFbt1VisjJydHW2+WGsiEHSy2s61ZAV2dICR6f3huSw",
      "1096: jY/MH9j23Oo/u61CBpvIS3Q8uC+TLtJl4/F9eqlnzocfMoKe8NmcBbUR3TKQoIok",
      "1097: xbSMl6jiE2k5TJdzhHUxjZRIeeLDLMKYX6xt37LdhuM8zO6sXQmCGg4J6LmHTJph",
      "1098: 96H11gBvcFSFJSmIiDykJOELZl/aVcY1g3YgpL0mw5Bw1VTmKaRdz1eBi9DmKrKX",
      "1099: UijG4gD8eLRV/FS/sZCFNR/evbQXvTBxO0TOIVi85PlQEcMl4SBj0CoTyNbcAGtz",
      "1100: 4wIDAQAB",
      "1101: -----END PUBLIC KEY-----';",
      "1103:         $pubKey = Config::get('system.update_gateway_key', $pubKey);",
      "1105:         $data = base64_encode(json_encode($data));",
      "1107:         return openssl_verify($data, $signature, $pubKey) === 1;",
      "1108:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0fa592ba42eebd3c38621f14c9d9f4588278efab",
      "candidate_info": {
        "commit_hash": "0fa592ba42eebd3c38621f14c9d9f4588278efab",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/0fa592ba42eebd3c38621f14c9d9f4588278efab",
        "files": [
          "modules/system/classes/UpdateManager.php"
        ],
        "message": "Checks gateway server has a valid signature",
        "before_after_code_files": [
          "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php"
          ],
          "candidate": [
            "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php"
          ]
        }
      },
      "candidate_diff": {
        "modules/system/classes/UpdateManager.php||modules/system/classes/UpdateManager.php": [
          "File: modules/system/classes/UpdateManager.php -> modules/system/classes/UpdateManager.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: use Cache;",
          "9: use Schema;",
          "10: use Config;",
          "11: use ApplicationException;",
          "12: use Cms\\Classes\\ThemeManager;",
          "13: use System\\Models\\Parameter;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11: use Request;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "885:             throw new ApplicationException(Lang::get('system::lang.server.response_invalid'));",
          "886:         }",
          "888:         return $resultData;",
          "889:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "889:         if (!$this->validateServerSignature($resultData, $result->headers['Rest-Sign'] ?? '')) {",
          "890:             throw new ApplicationException(Lang::get('system::lang.server.response_invalid') . ' (Bad signature)');",
          "891:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "964:     protected function applyHttpAttributes($http, $postData)",
          "965:     {",
          "969:         $postData['server'] = base64_encode(json_encode([",
          "970:             'php'   => PHP_VERSION,",
          "971:             'url'   => Url::to('/'),",
          "972:             'since' => PluginVersion::orderBy('created_at')->value('created_at')",
          "973:         ]));",
          "",
          "[Removed Lines]",
          "966:         $postData['protocol_version'] = '1.2';",
          "967:         $postData['client'] = 'october';",
          "",
          "[Added Lines]",
          "971:         $postData['protocol_version'] = '1.3';",
          "972:         $postData['client'] = 'October CMS';",
          "977:             'ip'    => Request::ip(),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1020:     {",
          "1021:         return Config::get('database.migrations', 'migrations');",
          "1022:     }",
          "1023: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1035:     protected function validateServerSignature($data, $signature)",
          "1036:     {",
          "1037:         if (!$signature) {",
          "1038:             return false;",
          "1039:         }",
          "1041:         $signature = base64_decode($signature);",
          "1043:         $pubKey = '-----BEGIN PUBLIC KEY-----",
          "1044: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt+KwvTXqC8Mz9vV4KIvX",
          "1045: 3y+aZusrlg26jdbNVUuhXNFbt1VisjJydHW2+WGsiEHSy2s61ZAV2dICR6f3huSw",
          "1046: jY/MH9j23Oo/u61CBpvIS3Q8uC+TLtJl4/F9eqlnzocfMoKe8NmcBbUR3TKQoIok",
          "1047: xbSMl6jiE2k5TJdzhHUxjZRIeeLDLMKYX6xt37LdhuM8zO6sXQmCGg4J6LmHTJph",
          "1048: 96H11gBvcFSFJSmIiDykJOELZl/aVcY1g3YgpL0mw5Bw1VTmKaRdz1eBi9DmKrKX",
          "1049: UijG4gD8eLRV/FS/sZCFNR/evbQXvTBxO0TOIVi85PlQEcMl4SBj0CoTyNbcAGtz",
          "1050: 4wIDAQAB",
          "1051: -----END PUBLIC KEY-----';",
          "1053:         $pubKey = Config::get('system.update_gateway_key', $pubKey);",
          "1055:         $data = base64_encode(json_encode($data));",
          "1057:         return openssl_verify($data, $signature, $pubKey) === 1;",
          "1058:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}