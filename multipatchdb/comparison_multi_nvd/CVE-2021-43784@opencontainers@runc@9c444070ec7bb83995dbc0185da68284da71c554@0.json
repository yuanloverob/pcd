{
  "cve_id": "CVE-2021-43784",
  "cve_desc": "runc is a CLI tool for spawning and running containers on Linux according to the OCI specification. In runc, netlink is used internally as a serialization system for specifying the relevant container configuration to the `C` portion of the code (responsible for the based namespace setup of containers). In all versions of runc prior to 1.0.3, the encoder did not handle the possibility of an integer overflow in the 16-bit length field for the byte array attribute type, meaning that a large enough malicious byte array attribute could result in the length overflowing and the attribute contents being parsed as netlink messages for container configuration. This vulnerability requires the attacker to have some control over the configuration of the container and would allow the attacker to bypass the namespace restrictions of the container by simply adding their own netlink payload which disables all namespaces. The main users impacted are those who allow untrusted images with untrusted configurations to run on their machines (such as with shared cloud infrastructure). runc version 1.0.3 contains a fix for this bug. As a workaround, one may try disallowing untrusted namespace paths from your container. It should be noted that untrusted namespace paths would allow the attacker to disable namespace protections entirely even in the absence of this bug.",
  "repo": "opencontainers/runc",
  "patch_hash": "9c444070ec7bb83995dbc0185da68284da71c554",
  "patch_info": {
    "commit_hash": "9c444070ec7bb83995dbc0185da68284da71c554",
    "repo": "opencontainers/runc",
    "commit_url": "https://github.com/opencontainers/runc/commit/9c444070ec7bb83995dbc0185da68284da71c554",
    "files": [
      "libcontainer/configs/mount.go",
      "libcontainer/container_linux.go",
      "libcontainer/factory_linux.go",
      "libcontainer/init_linux.go",
      "libcontainer/message_linux.go",
      "libcontainer/nsenter/nsexec.c",
      "libcontainer/rootfs_linux.go",
      "libcontainer/standard_init_linux.go"
    ],
    "message": "Open bind mount sources from the host userns\n\nThe source of the bind mount might not be accessible in a different user\nnamespace because a component of the source path might not be traversed\nunder the users and groups mapped inside the user namespace. This caused\nerrors such as the following:\n\n  # time=\"2020-06-22T13:48:26Z\" level=error msg=\"container_linux.go:367:\n  starting container process caused: process_linux.go:459:\n  container init caused: rootfs_linux.go:58:\n  mounting \\\"/tmp/busyboxtest/source-inaccessible/dir\\\"\n  to rootfs at \\\"/tmp/inaccessible\\\" caused:\n  stat /tmp/busyboxtest/source-inaccessible/dir: permission denied\"\n\nTo solve this problem, this patch performs the following:\n\n1. in nsexec.c, it opens the source path in the host userns (so we have\n   the right permissions to open it) but in the container mntns (so the\n   kernel cross mntns mount check let us mount it later:\n   https://github.com/torvalds/linux/blob/v5.8/fs/namespace.c#L2312).\n\n2. in nsexec.c, it passes the file descriptors of the source to the\n   child process with SCM_RIGHTS.\n\n3. In runc-init in Golang, it finishes the mounts while inside the\n   userns even without access to the some components of the source\n   paths.\n\nPassing the fds with SCM_RIGHTS is necessary because once the child\nprocess is in the container mntns, it is already in the container userns\nso it cannot temporarily join the host mntns.\n\nThis patch uses the existing mechanism with _LIBCONTAINER_* environment\nvariables to pass the file descriptors from runc to runc init.\n\nThis patch uses the existing mechanism with the Netlink-style bootstrap\nto pass information about the list of source mounts to nsexec.c.\n\nRootless containers don't use this bind mount sources fdpassing\nmechanism because we can't setns() to the target mntns in a rootless\ncontainer (we don't have the privileges when we are in the host userns).\n\nThis patch takes care of using O_CLOEXEC on mount fds, and close them\nearly.\n\nFixes: #2484.\n\nSigned-off-by: Alban Crequy <alban@kinvolk.io>\nSigned-off-by: Rodrigo Campos <rodrigo@kinvolk.io>\nCo-authored-by: Rodrigo Campos <rodrigo@kinvolk.io>",
    "before_after_code_files": [
      "libcontainer/configs/mount.go||libcontainer/configs/mount.go",
      "libcontainer/container_linux.go||libcontainer/container_linux.go",
      "libcontainer/factory_linux.go||libcontainer/factory_linux.go",
      "libcontainer/init_linux.go||libcontainer/init_linux.go",
      "libcontainer/message_linux.go||libcontainer/message_linux.go",
      "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c",
      "libcontainer/rootfs_linux.go||libcontainer/rootfs_linux.go",
      "libcontainer/standard_init_linux.go||libcontainer/standard_init_linux.go"
    ]
  },
  "patch_diff": {
    "libcontainer/configs/mount.go||libcontainer/configs/mount.go": [
      "File: libcontainer/configs/mount.go -> libcontainer/configs/mount.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: package configs",
      "3: const (",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3: import \"golang.org/x/sys/unix\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "38:  PostmountCmds []Command `json:\"postmount_cmds\"`",
      "39: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "43: func (m *Mount) IsBind() bool {",
      "44:  return m.Flags&unix.MS_BIND != 0",
      "45: }",
      "",
      "---------------"
    ],
    "libcontainer/container_linux.go||libcontainer/container_linux.go": [
      "File: libcontainer/container_linux.go -> libcontainer/container_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "521:  return cmd",
      "522: }",
      "524: func (c *linuxContainer) newInitProcess(p *Process, cmd *exec.Cmd, messageSockPair, logFilePair filePair) (*initProcess, error) {",
      "525:  cmd.Env = append(cmd.Env, \"_LIBCONTAINER_INITTYPE=\"+string(initStandard))",
      "526:  nsMaps := make(map[configs.NamespaceType]string)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "527: func (c *linuxContainer) shouldSendMountSources() bool {",
      "530:  if !c.config.Namespaces.Contains(configs.NEWUSER) ||",
      "531:   !c.config.Namespaces.Contains(configs.NEWNS) {",
      "532:   return false",
      "533:  }",
      "537:  if c.config.RootlessEUID {",
      "538:   return false",
      "539:  }",
      "542:  for _, m := range c.config.Mounts {",
      "543:   if m.IsBind() {",
      "544:    return true",
      "545:   }",
      "546:  }",
      "548:  return false",
      "549: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "530:   }",
      "531:  }",
      "532:  _, sharePidns := nsMaps[configs.NEWPID]",
      "534:  if err != nil {",
      "535:   return nil, err",
      "536:  }",
      "537:  init := &initProcess{",
      "538:   cmd:             cmd,",
      "539:   messageSockPair: messageSockPair,",
      "",
      "[Removed Lines]",
      "533:  data, err := c.bootstrapData(c.config.Namespaces.CloneFlags(), nsMaps)",
      "",
      "[Added Lines]",
      "560:  data, err := c.bootstrapData(c.config.Namespaces.CloneFlags(), nsMaps, initStandard)",
      "565:  if c.shouldSendMountSources() {",
      "568:   mountFds := make([]int, len(c.config.Mounts))",
      "569:   for i, m := range c.config.Mounts {",
      "570:    if !m.IsBind() {",
      "572:     mountFds[i] = -1",
      "573:     continue",
      "574:    }",
      "580:    cmd.ExtraFiles = append(cmd.ExtraFiles, messageSockPair.child)",
      "581:    mountFds[i] = stdioFdCount + len(cmd.ExtraFiles) - 1",
      "582:   }",
      "584:   mountFdsJson, err := json.Marshal(mountFds)",
      "585:   if err != nil {",
      "586:    return nil, fmt.Errorf(\"Error creating _LIBCONTAINER_MOUNT_FDS: %w\", err)",
      "587:   }",
      "589:   cmd.Env = append(cmd.Env,",
      "590:    \"_LIBCONTAINER_MOUNT_FDS=\"+string(mountFdsJson),",
      "591:   )",
      "592:  }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "558:  }",
      "562:  if err != nil {",
      "563:   return nil, err",
      "564:  }",
      "",
      "[Removed Lines]",
      "561:  data, err := c.bootstrapData(0, state.NamespacePaths)",
      "",
      "[Added Lines]",
      "618:  data, err := c.bootstrapData(0, state.NamespacePaths, initSetns)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1213:  case \"bind\":",
      "1217:    return err",
      "1218:   }",
      "1219:  default:",
      "",
      "[Removed Lines]",
      "1216:   if err := prepareBindMount(m, c.config.Rootfs); err != nil {",
      "",
      "[Added Lines]",
      "1275:   if err := prepareBindMount(m, c.config.Rootfs, nil); err != nil {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2055:  r := nl.NewNetlinkRequest(int(InitMsg), 0)",
      "",
      "[Removed Lines]",
      "2053: func (c *linuxContainer) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string) (io.Reader, error) {",
      "",
      "[Added Lines]",
      "2112: func (c *linuxContainer) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string, it initType) (io.Reader, error) {",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "2132:   Value: c.config.RootlessEUID,",
      "2133:  })",
      "2135:  return bytes.NewReader(r.Serialize()), nil",
      "2136: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2195:  if it == initStandard && c.shouldSendMountSources() {",
      "2196:   var mounts []byte",
      "2197:   for _, m := range c.config.Mounts {",
      "2198:    if m.IsBind() {",
      "2199:     mounts = append(mounts, []byte(m.Source)...)",
      "2200:    }",
      "2201:    mounts = append(mounts, byte(0))",
      "2202:   }",
      "2204:   r.AddData(&Bytemsg{",
      "2205:    Type:  MountSourcesAttr,",
      "2206:    Value: mounts,",
      "2207:   })",
      "2208:  }",
      "",
      "---------------"
    ],
    "libcontainer/factory_linux.go||libcontainer/factory_linux.go": [
      "File: libcontainer/factory_linux.go -> libcontainer/factory_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "295:   return fmt.Errorf(\"unable to convert _LIBCONTAINER_LOGPIPE: %w\", err)",
      "296:  }",
      "300:  os.Clearenv()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "299:  mountFds, err := parseMountFds()",
      "300:  if err != nil {",
      "301:   return err",
      "302:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "305:   }",
      "306:  }()",
      "309:  if err != nil {",
      "310:   return err",
      "311:  }",
      "",
      "[Removed Lines]",
      "308:  i, err := newContainerInit(it, pipe, consoleSocket, fifofd, logPipeFd)",
      "",
      "[Added Lines]",
      "314:  i, err := newContainerInit(it, pipe, consoleSocket, fifofd, logPipeFd, mountFds)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "359:   return nil",
      "360:  }",
      "361: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "369: func parseMountFds() ([]int, error) {",
      "370:  fdsJson := os.Getenv(\"_LIBCONTAINER_MOUNT_FDS\")",
      "371:  if fdsJson == \"\" {",
      "373:   return nil, nil",
      "374:  }",
      "376:  var mountFds []int",
      "377:  if err := json.Unmarshal([]byte(fdsJson), &mountFds); err != nil {",
      "378:   return nil, fmt.Errorf(\"Error unmarshalling _LIBCONTAINER_MOUNT_FDS: %w\", err)",
      "379:  }",
      "381:  return mountFds, nil",
      "382: }",
      "",
      "---------------"
    ],
    "libcontainer/init_linux.go||libcontainer/init_linux.go": [
      "File: libcontainer/init_linux.go -> libcontainer/init_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "76:  Init() error",
      "77: }",
      "80:  var config *initConfig",
      "81:  if err := json.NewDecoder(pipe).Decode(&config); err != nil {",
      "82:   return nil, err",
      "",
      "[Removed Lines]",
      "79: func newContainerInit(t initType, pipe *os.File, consoleSocket *os.File, fifoFd, logFd int) (initer, error) {",
      "",
      "[Added Lines]",
      "79: func newContainerInit(t initType, pipe *os.File, consoleSocket *os.File, fifoFd, logFd int, mountFds []int) (initer, error) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "86:  }",
      "87:  switch t {",
      "88:  case initSetns:",
      "89:   return &linuxSetnsInit{",
      "90:    pipe:          pipe,",
      "91:    consoleSocket: consoleSocket,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "90:   if mountFds != nil {",
      "91:    return nil, errors.New(\"mountFds must be nil. Can't mount while doing runc exec.\")",
      "92:   }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "100:    config:        config,",
      "101:    fifoFd:        fifoFd,",
      "102:    logFd:         logFd,",
      "103:   }, nil",
      "104:  }",
      "105:  return nil, fmt.Errorf(\"unknown init type %q\", t)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "108:    mountFds:      mountFds,",
      "",
      "---------------"
    ],
    "libcontainer/message_linux.go||libcontainer/message_linux.go": [
      "File: libcontainer/message_linux.go -> libcontainer/message_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "18:  RootlessEUIDAttr uint16 = 27287",
      "19:  UidmapPathAttr   uint16 = 27288",
      "20:  GidmapPathAttr   uint16 = 27289",
      "21: )",
      "23: type Int32msg struct {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "21:  MountSourcesAttr uint16 = 27290",
      "",
      "---------------"
    ],
    "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c": [
      "File: libcontainer/nsenter/nsexec.c -> libcontainer/nsenter/nsexec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include <errno.h>",
      "5: #include <fcntl.h>",
      "6: #include <grp.h>",
      "7: #include <sched.h>",
      "8: #include <setjmp.h>",
      "9: #include <signal.h>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7: #include <limits.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "87:  size_t uidmappath_len;",
      "88:  char *gidmappath;",
      "89:  size_t gidmappath_len;",
      "90: };",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "95:  char *mountsources;",
      "96:  size_t mountsources_len;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "119: #define ROOTLESS_EUID_ATTR 27287",
      "120: #define UIDMAPPATH_ATTR  27288",
      "121: #define GIDMAPPATH_ATTR  27289",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "129: #define MOUNT_SOURCES_ATTR 27290",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "542:   case SETGROUP_ATTR:",
      "543:    config->is_setgroup = readint8(current);",
      "544:    break;",
      "545:   default:",
      "546:    bail(\"unknown netlink message type %d\", nlattr->nla_type);",
      "547:   }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "553:   case MOUNT_SOURCES_ATTR:",
      "554:    config->mountsources = current;",
      "555:    config->mountsources_len = payload_len;",
      "556:    break;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "633:   return 0;",
      "634: }",
      "636: void nsexec(void)",
      "637: {",
      "638:  int pipenum;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "648: void receive_fd(int sockfd, int new_fd)",
      "649: {",
      "650:  int bytes_read;",
      "651:  struct msghdr msg = { };",
      "652:  struct cmsghdr *cmsg;",
      "653:  struct iovec iov = { };",
      "654:  char null_byte = '\\0';",
      "655:  int ret;",
      "656:  int fd_count;",
      "657:  int *fd_payload;",
      "659:  iov.iov_base = &null_byte;",
      "660:  iov.iov_len = 1;",
      "662:  msg.msg_iov = &iov;",
      "663:  msg.msg_iovlen = 1;",
      "665:  msg.msg_controllen = CMSG_SPACE(sizeof(int));",
      "666:  msg.msg_control = malloc(msg.msg_controllen);",
      "667:  if (msg.msg_control == NULL) {",
      "668:   bail(\"Can't allocate memory to receive fd.\");",
      "669:  }",
      "671:  memset(msg.msg_control, 0, msg.msg_controllen);",
      "673:  bytes_read = recvmsg(sockfd, &msg, 0);",
      "674:  if (bytes_read != 1)",
      "675:   bail(\"failed to receive fd from unix socket %d\", sockfd);",
      "676:  if (msg.msg_flags & MSG_CTRUNC)",
      "677:   bail(\"received truncated control message from unix socket %d\", sockfd);",
      "679:  cmsg = CMSG_FIRSTHDR(&msg);",
      "680:  if (!cmsg)",
      "681:   bail(\"received message from unix socket %d without control message\", sockfd);",
      "683:  if (cmsg->cmsg_level != SOL_SOCKET)",
      "684:   bail(\"received unknown control message from unix socket %d: cmsg_level=%d\", sockfd, cmsg->cmsg_level);",
      "686:  if (cmsg->cmsg_type != SCM_RIGHTS)",
      "687:   bail(\"received unknown control message from unix socket %d: cmsg_type=%d\", sockfd, cmsg->cmsg_type);",
      "689:  fd_count = (cmsg->cmsg_len - CMSG_LEN(0)) / sizeof(int);",
      "690:  if (fd_count != 1)",
      "691:   bail(\"received control message from unix socket %d with too many fds: %d\", sockfd, fd_count);",
      "693:  fd_payload = (int *)CMSG_DATA(cmsg);",
      "694:  ret = dup3(*fd_payload, new_fd, O_CLOEXEC);",
      "695:  if (ret < 0)",
      "696:   bail(\"cannot dup3 fd %d to %d\", *fd_payload, new_fd);",
      "698:  free(msg.msg_control);",
      "700:  ret = close(*fd_payload);",
      "701:  if (ret < 0)",
      "702:   bail(\"cannot close fd %d\", *fd_payload);",
      "703: }",
      "705: void send_fd(int sockfd, int fd)",
      "706: {",
      "707:  int bytes_written;",
      "708:  struct msghdr msg = { };",
      "709:  struct cmsghdr *cmsg;",
      "710:  struct iovec iov[1] = { };",
      "711:  char null_byte = '\\0';",
      "713:  iov[0].iov_base = &null_byte;",
      "714:  iov[0].iov_len = 1;",
      "716:  msg.msg_iov = iov;",
      "717:  msg.msg_iovlen = 1;",
      "721:  msg.msg_controllen = CMSG_SPACE(sizeof(int));",
      "722:  msg.msg_control = malloc(msg.msg_controllen);",
      "723:  if (msg.msg_control == NULL) {",
      "724:   bail(\"Can't allocate memory to send fd.\");",
      "725:  }",
      "727:  memset(msg.msg_control, 0, msg.msg_controllen);",
      "729:  cmsg = CMSG_FIRSTHDR(&msg);",
      "730:  cmsg->cmsg_level = SOL_SOCKET;",
      "731:  cmsg->cmsg_type = SCM_RIGHTS;",
      "732:  cmsg->cmsg_len = CMSG_LEN(sizeof(int));",
      "733:  memcpy(CMSG_DATA(cmsg), &fd, sizeof(int));",
      "735:  bytes_written = sendmsg(sockfd, &msg, 0);",
      "737:  free(msg.msg_control);",
      "739:  if (bytes_written != 1)",
      "740:   bail(\"failed to send fd %d via unix socket %d\", fd, sockfd);",
      "741: }",
      "743: void receive_mountsources(int sockfd)",
      "744: {",
      "745:  char *mount_fds, *endp;",
      "746:  long new_fd;",
      "749:  mount_fds = getenv(\"_LIBCONTAINER_MOUNT_FDS\");",
      "751:  if (mount_fds[0] != '[') {",
      "752:   bail(\"malformed _LIBCONTAINER_MOUNT_FDS env var: missing '['\");",
      "753:  }",
      "754:  mount_fds++;",
      "756:  for (endp = mount_fds; *endp != ']'; mount_fds = endp + 1) {",
      "757:   new_fd = strtol(mount_fds, &endp, 10);",
      "758:   if (endp == mount_fds) {",
      "759:    bail(\"malformed _LIBCONTAINER_MOUNT_FDS env var: not a number\");",
      "760:   }",
      "761:   if (*endp == '\\0') {",
      "762:    bail(\"malformed _LIBCONTAINER_MOUNT_FDS env var: missing ]\");",
      "763:   }",
      "765:   if (new_fd == -1) {",
      "766:    continue;",
      "767:   }",
      "769:   if (new_fd == LONG_MAX || new_fd < 0 || new_fd > INT_MAX) {",
      "770:    bail(\"malformed _LIBCONTAINER_MOUNT_FDS env var: fds out of range\");",
      "771:   }",
      "773:   receive_fd(sockfd, new_fd);",
      "774:  }",
      "775: }",
      "777: void send_mountsources(int sockfd, pid_t child, char *mountsources, size_t mountsources_len)",
      "778: {",
      "779:  char proc_path[PATH_MAX];",
      "780:  int host_mntns_fd;",
      "781:  int container_mntns_fd;",
      "782:  int fd;",
      "783:  int ret;",
      "787:  if (mountsources == NULL)",
      "788:   return;",
      "790:  host_mntns_fd = open(\"/proc/self/ns/mnt\", O_RDONLY | O_CLOEXEC);",
      "791:  if (host_mntns_fd == -1)",
      "792:   bail(\"failed to get current mount namespace\");",
      "794:  if (snprintf(proc_path, PATH_MAX, \"/proc/%d/ns/mnt\", child) < 0)",
      "795:   bail(\"failed to get mount namespace path\");",
      "797:  container_mntns_fd = open(proc_path, O_RDONLY | O_CLOEXEC);",
      "798:  if (container_mntns_fd == -1)",
      "799:   bail(\"failed to get container mount namespace\");",
      "801:  if (setns(container_mntns_fd, CLONE_NEWNS) < 0)",
      "802:   bail(\"failed to setns to container mntns\");",
      "804:  char *mountsources_end = mountsources + mountsources_len;",
      "805:  while (mountsources < mountsources_end) {",
      "806:   if (mountsources[0] == '\\0') {",
      "807:    mountsources++;",
      "808:    continue;",
      "809:   }",
      "811:   fd = open(mountsources, O_PATH | O_CLOEXEC);",
      "812:   if (fd < 0)",
      "813:    bail(\"failed to open mount source %s\", mountsources);",
      "815:   send_fd(sockfd, fd);",
      "817:   ret = close(fd);",
      "818:   if (ret != 0)",
      "819:    bail(\"failed to close mount source fd %d\", fd);",
      "821:   mountsources += strlen(mountsources) + 1;",
      "822:  }",
      "824:  if (setns(host_mntns_fd, CLONE_NEWNS) < 0)",
      "825:   bail(\"failed to setns to host mntns\");",
      "827:  ret = close(host_mntns_fd);",
      "828:  if (ret != 0)",
      "829:   bail(\"failed to close host mount namespace fd %d\", host_mntns_fd);",
      "830:  ret = close(container_mntns_fd);",
      "831:  if (ret != 0)",
      "832:   bail(\"failed to close container mount namespace fd %d\", container_mntns_fd);",
      "833: }",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "865:       bail(\"failed to sync with runc: write(pid-JSON)\");",
      "866:      }",
      "867:      break;",
      "868:     case SYNC_CHILD_FINISH:",
      "869:      write_log(DEBUG, \"stage-1 complete\");",
      "870:      stage1_complete = true;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1067:     case SYNC_MOUNTSOURCES_PLS:",
      "1068:      send_mountsources(syncfd, stage1_pid, config.mountsources,",
      "1069:          config.mountsources_len);",
      "1071:      s = SYNC_MOUNTSOURCES_ACK;",
      "1072:      if (write(syncfd, &s, sizeof(s)) != sizeof(s)) {",
      "1073:       kill(stage1_pid, SIGKILL);",
      "1074:       bail(\"failed to sync with child: write(SYNC_MOUNTSOURCES_ACK)\");",
      "1075:      }",
      "1076:      break;",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1019:    if (unshare(config.cloneflags & ~CLONE_NEWCGROUP) < 0)",
      "1020:     bail(\"failed to unshare remaining namespaces (except cgroupns)\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1232:    if (config.mountsources) {",
      "1233:     s = SYNC_MOUNTSOURCES_PLS;",
      "1234:     if (write(syncfd, &s, sizeof(s)) != sizeof(s)) {",
      "1235:      kill(stage2_pid, SIGKILL);",
      "1236:      bail(\"failed to sync with parent: write(SYNC_MOUNTSOURCES_PLS)\");",
      "1237:     }",
      "1240:     receive_mountsources(syncfd);",
      "1243:     if (read(syncfd, &s, sizeof(s)) != sizeof(s)) {",
      "1244:      kill(stage2_pid, SIGKILL);",
      "1245:      bail(\"failed to sync with parent: read(SYNC_MOUNTSOURCES_ACK)\");",
      "1246:     }",
      "1247:     if (s != SYNC_MOUNTSOURCES_ACK) {",
      "1248:      kill(stage2_pid, SIGKILL);",
      "1249:      bail(\"failed to sync with parent: SYNC_MOUNTSOURCES_ACK: got %u\", s);",
      "1250:     }",
      "1251:    }",
      "",
      "---------------"
    ],
    "libcontainer/rootfs_linux.go||libcontainer/rootfs_linux.go": [
      "File: libcontainer/rootfs_linux.go -> libcontainer/rootfs_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "36:  cgroup2Path     string",
      "37:  rootlessCgroups bool",
      "38:  cgroupns        bool",
      "39: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39:  fd              *int",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "55:  config := iConfig.Config",
      "56:  if err := prepareRoot(config); err != nil {",
      "57:   return fmt.Errorf(\"error preparing rootfs: %w\", err)",
      "58:  }",
      "60:  mountConfig := &mountConfig{",
      "61:   root:            config.Rootfs,",
      "62:   label:           config.MountLabel,",
      "",
      "[Removed Lines]",
      "54: func prepareRootfs(pipe io.ReadWriter, iConfig *initConfig) (err error) {",
      "",
      "[Added Lines]",
      "55: func prepareRootfs(pipe io.ReadWriter, iConfig *initConfig, mountFds []int) (err error) {",
      "61:  if mountFds != nil && len(mountFds) != len(config.Mounts) {",
      "62:   return fmt.Errorf(\"malformed mountFds slice. Expected size: %v, got: %v. Slice: %v\", len(config.Mounts), len(mountFds), mountFds)",
      "63:  }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "65:   cgroupns:        config.Namespaces.Contains(configs.NEWCGROUP),",
      "66:  }",
      "67:  setupDev := needsSetupDev(config)",
      "69:   for _, precmd := range m.PremountCmds {",
      "70:    if err := mountCmd(precmd); err != nil {",
      "71:     return fmt.Errorf(\"error running premount command: %w\", err)",
      "72:    }",
      "73:   }",
      "74:   if err := mountToRootfs(m, mountConfig); err != nil {",
      "75:    return fmt.Errorf(\"error mounting %q to rootfs at %q: %w\", m.Source, m.Destination, err)",
      "76:   }",
      "",
      "[Removed Lines]",
      "68:  for _, m := range config.Mounts {",
      "",
      "[Added Lines]",
      "73:  for i, m := range config.Mounts {",
      "82:   if mountFds != nil && mountFds[i] != -1 {",
      "83:    mountConfig.fd = &mountFds[i]",
      "84:   }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "210:  return nil",
      "211: }",
      "215:  if err != nil {",
      "",
      "[Removed Lines]",
      "213: func prepareBindMount(m *configs.Mount, rootfs string) error {",
      "214:  stat, err := os.Stat(m.Source)",
      "",
      "[Added Lines]",
      "225: func prepareBindMount(m *configs.Mount, rootfs string, mountFd *int) error {",
      "226:  source := m.Source",
      "227:  if mountFd != nil {",
      "228:   source = \"/proc/self/fd/\" + strconv.Itoa(*mountFd)",
      "229:  }",
      "231:  stat, err := os.Stat(source)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "225:  if dest, err = securejoin.SecureJoin(rootfs, m.Destination); err != nil {",
      "226:   return err",
      "227:  }",
      "229:   return err",
      "230:  }",
      "231:  if err := createIfNotExists(dest, stat.IsDir()); err != nil {",
      "",
      "[Removed Lines]",
      "228:  if err := checkProcMount(rootfs, dest, m.Source); err != nil {",
      "",
      "[Added Lines]",
      "245:  if err := checkProcMount(rootfs, dest, source); err != nil {",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "348:  oldDest := m.Destination",
      "349:  m.Destination = tmpDir",
      "351:  m.Destination = oldDest",
      "352:  if err != nil {",
      "353:   return err",
      "",
      "[Removed Lines]",
      "350:  err = mountPropagate(m, \"/\", mountLabel)",
      "",
      "[Added Lines]",
      "369:  err = mountPropagate(m, \"/\", mountLabel, nil)",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "378: func mountToRootfs(m *configs.Mount, c *mountConfig) error {",
      "379:  rootfs := c.root",
      "380:  mountLabel := c.label",
      "381:  dest, err := securejoin.SecureJoin(rootfs, m.Destination)",
      "382:  if err != nil {",
      "383:   return err",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "400:  mountFd := c.fd",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "401:    return err",
      "402:   }",
      "405:  case \"mqueue\":",
      "406:   if err := os.MkdirAll(dest, 0o755); err != nil {",
      "407:    return err",
      "408:   }",
      "410:    return err",
      "411:   }",
      "412:   return label.SetFileLabel(dest, mountLabel)",
      "",
      "[Removed Lines]",
      "404:   return mountPropagate(m, rootfs, \"\")",
      "409:   if err := mountPropagate(m, rootfs, \"\"); err != nil {",
      "",
      "[Added Lines]",
      "424:   return mountPropagate(m, rootfs, \"\", nil)",
      "429:   if err := mountPropagate(m, rootfs, \"\", nil); err != nil {",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "421:   if m.Extensions&configs.EXT_COPYUP == configs.EXT_COPYUP {",
      "422:    err = doTmpfsCopyUp(m, rootfs, mountLabel)",
      "423:   } else {",
      "425:   }",
      "426:   if err != nil {",
      "427:    return err",
      "428:   }",
      "429:   if stat != nil {",
      "430:    if err = os.Chmod(dest, stat.Mode()); err != nil {",
      "431:     return err",
      "",
      "[Removed Lines]",
      "424:    err = mountPropagate(m, rootfs, mountLabel)",
      "",
      "[Added Lines]",
      "444:    err = mountPropagate(m, rootfs, mountLabel, nil)",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "433:   }",
      "435:   if m.Flags&unix.MS_RDONLY != 0 {",
      "437:     return err",
      "438:    }",
      "439:   }",
      "440:   return nil",
      "441:  case \"bind\":",
      "443:    return err",
      "444:   }",
      "446:    return err",
      "447:   }",
      "450:   if m.Flags&^(unix.MS_REC|unix.MS_REMOUNT|unix.MS_BIND) != 0 {",
      "453:     return err",
      "454:    }",
      "455:   }",
      "",
      "[Removed Lines]",
      "436:    if err := remount(m, rootfs); err != nil {",
      "442:   if err := prepareBindMount(m, rootfs); err != nil {",
      "445:   if err := mountPropagate(m, rootfs, mountLabel); err != nil {",
      "452:    if err := remount(m, rootfs); err != nil {",
      "",
      "[Added Lines]",
      "458:    if err := remount(m, rootfs, mountFd); err != nil {",
      "464:   if err := prepareBindMount(m, rootfs, mountFd); err != nil {",
      "467:   if err := mountPropagate(m, rootfs, mountLabel, mountFd); err != nil {",
      "474:    if err := remount(m, rootfs, mountFd); err != nil {",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "475:   if err := os.MkdirAll(dest, 0o755); err != nil {",
      "476:    return err",
      "477:   }",
      "479:  }",
      "480:  return nil",
      "481: }",
      "",
      "[Removed Lines]",
      "478:   return mountPropagate(m, rootfs, mountLabel)",
      "",
      "[Added Lines]",
      "500:   return mountPropagate(m, rootfs, mountLabel, mountFd)",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1037:  return ioutil.WriteFile(path.Join(\"/proc/sys\", keyPath), []byte(value), 0o644)",
      "1038: }",
      "1041:  return utils.WithProcfd(rootfs, m.Destination, func(procfd string) error {",
      "1043:  })",
      "1044: }",
      "1049:  var (",
      "1050:   data  = label.FormatMountLabel(m.Data, mountLabel)",
      "1051:   flags = m.Flags",
      "",
      "[Removed Lines]",
      "1040: func remount(m *configs.Mount, rootfs string) error {",
      "1042:   return mount(m.Source, m.Destination, procfd, m.Device, uintptr(m.Flags|unix.MS_REMOUNT), \"\")",
      "1048: func mountPropagate(m *configs.Mount, rootfs string, mountLabel string) error {",
      "",
      "[Added Lines]",
      "1062: func remount(m *configs.Mount, rootfs string, mountFd *int) error {",
      "1063:  source := m.Source",
      "1064:  if mountFd != nil {",
      "1065:   source = \"/proc/self/fd/\" + strconv.Itoa(*mountFd)",
      "1066:  }",
      "1069:   return mount(source, m.Destination, procfd, m.Device, uintptr(m.Flags|unix.MS_REMOUNT), \"\")",
      "1075: func mountPropagate(m *configs.Mount, rootfs string, mountLabel string, mountFd *int) error {",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1065:  if err := utils.WithProcfd(rootfs, m.Destination, func(procfd string) error {",
      "1067:  }); err != nil {",
      "1068:   return err",
      "1069:  }",
      "",
      "[Removed Lines]",
      "1066:   return mount(m.Source, m.Destination, procfd, m.Device, uintptr(flags), data)",
      "",
      "[Added Lines]",
      "1092:  source := m.Source",
      "1093:  if mountFd != nil {",
      "1094:   source = \"/proc/self/fd/\" + strconv.Itoa(*mountFd)",
      "1095:  }",
      "1098:   return mount(source, m.Destination, procfd, m.Device, uintptr(flags), data)",
      "",
      "---------------"
    ],
    "libcontainer/standard_init_linux.go||libcontainer/standard_init_linux.go": [
      "File: libcontainer/standard_init_linux.go -> libcontainer/standard_init_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "26:  parentPid     int",
      "27:  fifoFd        int",
      "28:  logFd         int",
      "29:  config        *initConfig",
      "30: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29:  mountFds      []int",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "89:  selinux.GetEnabled()",
      "91:   return err",
      "92:  }",
      "",
      "[Removed Lines]",
      "90:  if err := prepareRootfs(l.pipe, l.config); err != nil {",
      "",
      "[Added Lines]",
      "93:  err := prepareRootfs(l.pipe, l.config, l.mountFds)",
      "94:  for _, m := range l.mountFds {",
      "95:   if m == -1 {",
      "96:    continue",
      "97:   }",
      "99:   if err := unix.Close(m); err != nil {",
      "100:    return fmt.Errorf(\"Unable to close mountFds fds: %w\", err)",
      "101:   }",
      "102:  }",
      "104:  if err != nil {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8542322dfe80b92c94291fd7427a9ca307017403",
      "candidate_info": {
        "commit_hash": "8542322dfe80b92c94291fd7427a9ca307017403",
        "repo": "opencontainers/runc",
        "commit_url": "https://github.com/opencontainers/runc/commit/8542322dfe80b92c94291fd7427a9ca307017403",
        "files": [
          "libcontainer/integration/exec_test.go",
          "libcontainer/integration/utils_test.go"
        ],
        "message": "libcontainer: Add unit tests with userns and mounts\n\nAdd a unit test to check that bind mounts that have a part of its\npath non accessible by others still work when using user namespaces.\n\nTo do this, we also modify newRoot() to return rootfs directories that\ncan be traverse by others, so the rootfs created works for all test\n(either running in a userns or not).\n\nSigned-off-by: Mauricio V\u00e1squez <mauricio@kinvolk.io>\nSigned-off-by: Rodrigo Campos <rodrigo@kinvolk.io>\nCo-authored-by: Rodrigo Campos <rodrigo@kinvolk.io>",
        "before_after_code_files": [
          "libcontainer/integration/exec_test.go||libcontainer/integration/exec_test.go",
          "libcontainer/integration/utils_test.go||libcontainer/integration/utils_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/opencontainers/runc/pull/2576"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libcontainer/integration/exec_test.go||libcontainer/integration/exec_test.go": [
          "File: libcontainer/integration/exec_test.go -> libcontainer/integration/exec_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import (",
          "4:  \"bytes\"",
          "5:  \"encoding/json\"",
          "6:  \"fmt\"",
          "7:  \"io/ioutil\"",
          "8:  \"os\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:  \"errors\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1838:   t.Fatalf(\"found %d extra fds after container.Run\", count)",
          "1839:  }",
          "1840: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1845: func TestBindMountAndUser(t *testing.T) {",
          "1846:  if _, err := os.Stat(\"/proc/self/ns/user\"); errors.Is(err, os.ErrNotExist) {",
          "1847:   t.Skip(\"userns is unsupported\")",
          "1848:  }",
          "1850:  if testing.Short() {",
          "1851:   return",
          "1852:  }",
          "1854:  temphost := t.TempDir()",
          "1855:  dirhost := filepath.Join(temphost, \"inaccessible\", \"dir\")",
          "1857:  err := os.MkdirAll(dirhost, 0o755)",
          "1858:  ok(t, err)",
          "1860:  err = ioutil.WriteFile(filepath.Join(dirhost, \"foo.txt\"), []byte(\"Hello\"), 0o755)",
          "1861:  ok(t, err)",
          "1864:  err = os.Chmod(filepath.Join(temphost, \"inaccessible\"), 0o700)",
          "1865:  ok(t, err)",
          "1867:  config := newTemplateConfig(t, &tParam{",
          "1868:   userns: true,",
          "1869:  })",
          "1872:  config.UidMappings[0].HostID = 1000",
          "1873:  config.GidMappings[0].HostID = 1000",
          "1877:  err = os.Chown(config.Rootfs, 1000, 1000)",
          "1878:  ok(t, err)",
          "1880:  config.Mounts = append(config.Mounts, &configs.Mount{",
          "1881:   Source:      dirhost,",
          "1882:   Destination: \"/tmp/mnt1cont\",",
          "1883:   Device:      \"bind\",",
          "1884:   Flags:       unix.MS_BIND | unix.MS_REC,",
          "1885:  })",
          "1887:  container, err := newContainer(t, config)",
          "1888:  ok(t, err)",
          "1889:  defer container.Destroy() //nolint: errcheck",
          "1891:  var stdout bytes.Buffer",
          "1893:  pconfig := libcontainer.Process{",
          "1894:   Cwd:    \"/\",",
          "1895:   Args:   []string{\"sh\", \"-c\", \"stat /tmp/mnt1cont/foo.txt\"},",
          "1896:   Env:    standardEnvironment,",
          "1897:   Stdout: &stdout,",
          "1898:   Init:   true,",
          "1899:  }",
          "1900:  err = container.Run(&pconfig)",
          "1901:  ok(t, err)",
          "1903:  waitProcess(&pconfig, t)",
          "1904: }",
          "",
          "---------------"
        ],
        "libcontainer/integration/utils_test.go||libcontainer/integration/utils_test.go": [
          "File: libcontainer/integration/utils_test.go -> libcontainer/integration/utils_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "105:  if err := copyBusybox(dir); err != nil {",
          "106:   t.Fatal(err)",
          "107:  }",
          "108:  return dir",
          "109: }",
          "111: func remove(dir string) {",
          "112:  _ = os.RemoveAll(dir)",
          "113: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "111:  if err := traversePath(dir); err != nil {",
          "112:   t.Fatalf(\"Error making newRootfs path traversable by others: %v\", err)",
          "113:  }",
          "121: func traversePath(tPath string) error {",
          "123:  tempBase := os.TempDir()",
          "124:  if !strings.HasPrefix(tPath, tempBase) {",
          "125:   return fmt.Errorf(\"traversePath: %q is not a descendant of %q\", tPath, tempBase)",
          "126:  }",
          "128:  var path string",
          "129:  for _, p := range strings.SplitAfter(tPath, \"/\") {",
          "130:   path = path + p",
          "131:   stats, err := os.Stat(path)",
          "132:   if err != nil {",
          "133:    return err",
          "134:   }",
          "136:   perm := stats.Mode().Perm()",
          "138:   if perm&0o5 == 0o5 {",
          "139:    continue",
          "140:   }",
          "142:   if strings.HasPrefix(tempBase, path) {",
          "143:    return fmt.Errorf(\"traversePath: directory %q MUST have read+exec permissions for others\", path)",
          "144:   }",
          "146:   if err := os.Chmod(path, perm|0o5); err != nil {",
          "147:    return err",
          "148:   }",
          "149:  }",
          "151:  return nil",
          "152: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81fdc8ce1c83ada66a1076a52d72f228ee1f7b0e",
      "candidate_info": {
        "commit_hash": "81fdc8ce1c83ada66a1076a52d72f228ee1f7b0e",
        "repo": "opencontainers/runc",
        "commit_url": "https://github.com/opencontainers/runc/commit/81fdc8ce1c83ada66a1076a52d72f228ee1f7b0e",
        "files": [
          "tests/integration/userns.bats"
        ],
        "message": "New integration tests for user namespaces bind sources\n\nThe previous commit fixed an issue opening bind mount sources. This\ncommit just adds integration tests to make sure we don't regress on this\nin the future.\n\nSigned-off-by: Alban Crequy <alban@kinvolk.io>\nSigned-off-by: Rodrigo Campos <rodrigo@kinvolk.io>\nCo-authored-by: Rodrigo Campos <rodrigo@kinvolk.io>",
        "before_after_code_files": [
          "tests/integration/userns.bats||tests/integration/userns.bats"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/opencontainers/runc/pull/2576"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/integration/userns.bats||tests/integration/userns.bats": [
          "File: tests/integration/userns.bats -> tests/integration/userns.bats",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: #!/usr/bin/env bats",
          "3: load helpers",
          "5: function setup() {",
          "6:  setup_busybox",
          "8:  # Prepare source folders for bind mount",
          "9:  mkdir -p source-{accessible,inaccessible-1,inaccessible-2}/dir",
          "10:  touch source-{accessible,inaccessible-1,inaccessible-2}/dir/foo.txt",
          "12:  # Permissions only to the owner, it is inaccessible to group/others",
          "13:  chmod 700 source-inaccessible-{1,2}",
          "15:  mkdir -p rootfs/{proc,sys,tmp}",
          "16:  mkdir -p rootfs/tmp/mount-{1,2}",
          "18:  # We need to give permissions for others so the uid inside the userns",
          "19:  # can mount the rootfs on itself. Otherwise the rootfs mount will fail.",
          "20:  chmod 755 \"$ROOT\"",
          "22:  if [ \"$ROOTLESS\" -eq 0 ]; then",
          "23:   update_config ' .linux.namespaces += [{\"type\": \"user\"}]",
          "24:    | .linux.uidMappings += [{\"hostID\": 100000, \"containerID\": 0, \"size\": 65534}]",
          "25:    | .linux.gidMappings += [{\"hostID\": 100000, \"containerID\": 0, \"size\": 65534}] '",
          "26:  fi",
          "27: }",
          "29: function teardown() {",
          "30:  teardown_bundle",
          "31: }",
          "33: @test \"userns with simple mount\" {",
          "34:  update_config ' .process.args += [\"-c\", \"stat /tmp/mount-1/foo.txt\"]",
          "35:   | .mounts += [{\"source\": \"source-accessible/dir\", \"destination\": \"/tmp/mount-1\", \"options\": [\"bind\"]}] '",
          "37:  runc run test_busybox",
          "38:  [ \"$status\" -eq 0 ]",
          "39: }",
          "41: # We had bugs where 1 mount worked but not 2+, test with 2 as it is a more",
          "42: # general case.",
          "43: @test \"userns with 2 inaccessible mounts\" {",
          "44:  update_config '   .process.args += [\"-c\", \"stat /tmp/mount-1/foo.txt /tmp/mount-2/foo.txt\"]",
          "45:    | .mounts += [ { \"source\": \"source-inaccessible-1/dir\", \"destination\": \"/tmp/mount-1\", \"options\": [\"bind\"] },",
          "46:                    { \"source\": \"source-inaccessible-2/dir\", \"destination\": \"/tmp/mount-2\", \"options\": [\"bind\"] }",
          "47:               ]'",
          "49:  # When not running rootless, this should work: while",
          "50:  # \"source-inaccessible-1\" can't be read by the uid in the userns, the fd",
          "51:  # is opened before changing to the userns and sent over via SCM_RIGHTs",
          "52:  # (with env var _LIBCONTAINER_MOUNT_FDS). Idem for",
          "53:  # source-inaccessible-2.",
          "54:  # On rootless, the owner is the same so it is accessible.",
          "55:  runc run test_busybox",
          "56:  [ \"$status\" -eq 0 ]",
          "57: }",
          "59: # exec + bindmounts + user ns is a special case in the code. Test that it works.",
          "60: @test \"userns with inaccessible mount + exec\" {",
          "61:  update_config ' .mounts += [  { \"source\": \"source-inaccessible-1/dir\", \"destination\": \"/tmp/mount-1\", \"options\": [\"bind\"] },",
          "62:      { \"source\": \"source-inaccessible-2/dir\", \"destination\": \"/tmp/mount-2\", \"options\": [\"bind\"] }",
          "63:             ]'",
          "65:  runc run -d --console-socket \"$CONSOLE_SOCKET\" test_busybox",
          "66:  [ \"$status\" -eq 0 ]",
          "68:  runc exec test_busybox stat /tmp/mount-1/foo.txt /tmp/mount-2/foo.txt",
          "69:  [ \"$status\" -eq 0 ]",
          "70: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d72d057ba794164c3cce9451a00b72a78b25e1ae",
      "candidate_info": {
        "commit_hash": "d72d057ba794164c3cce9451a00b72a78b25e1ae",
        "repo": "opencontainers/runc",
        "commit_url": "https://github.com/opencontainers/runc/commit/d72d057ba794164c3cce9451a00b72a78b25e1ae",
        "files": [
          "libcontainer/container_linux.go",
          "libcontainer/message_linux.go"
        ],
        "message": "runc init: avoid netlink message length overflows\n\nWhen writing netlink messages, it is possible to have a byte array\nlarger than UINT16_MAX which would result in the length field\noverflowing and allowing user-controlled data to be parsed as control\ncharacters (such as creating custom mount points, changing which set of\nnamespaces to allow, and so on).\n\nCo-authored-by: Kir Kolyshkin <kolyshkin@gmail.com>\nSigned-off-by: Kir Kolyshkin <kolyshkin@gmail.com>\nSigned-off-by: Aleksa Sarai <cyphar@cyphar.com>",
        "before_after_code_files": [
          "libcontainer/container_linux.go||libcontainer/container_linux.go",
          "libcontainer/message_linux.go||libcontainer/message_linux.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libcontainer/container_linux.go||libcontainer/container_linux.go",
            "libcontainer/message_linux.go||libcontainer/message_linux.go"
          ],
          "candidate": [
            "libcontainer/container_linux.go||libcontainer/container_linux.go",
            "libcontainer/message_linux.go||libcontainer/message_linux.go"
          ]
        }
      },
      "candidate_diff": {
        "libcontainer/container_linux.go||libcontainer/container_linux.go": [
          "File: libcontainer/container_linux.go -> libcontainer/container_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "2102:  return data.Bytes(), nil",
          "2103: }",
          "2113:  r := nl.NewNetlinkRequest(int(InitMsg), 0)",
          "2116:  r.AddData(&Int32msg{",
          "2117:   Type:  CloneFlagsAttr,",
          "",
          "[Removed Lines]",
          "2111: func (c *linuxContainer) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string, it initType) (io.Reader, error) {",
          "",
          "[Added Lines]",
          "2108: type netlinkError struct{ error }",
          "2116: func (c *linuxContainer) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string, it initType) (_ io.Reader, Err error) {",
          "2123:  defer func() {",
          "2124:   if r := recover(); r != nil {",
          "2125:    if e, ok := r.(netlinkError); ok {",
          "2126:     Err = e.error",
          "2127:    } else {",
          "2128:     panic(r)",
          "2129:    }",
          "2130:   }",
          "2131:  }()",
          "",
          "---------------"
        ],
        "libcontainer/message_linux.go||libcontainer/message_linux.go": [
          "File: libcontainer/message_linux.go -> libcontainer/message_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: package libcontainer",
          "3: import (",
          "4:  \"github.com/vishvananda/netlink/nl\"",
          "5:  \"golang.org/x/sys/unix\"",
          "6: )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4:  \"fmt\"",
          "5:  \"math\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "54: func (msg *Bytemsg) Serialize() []byte {",
          "55:  l := msg.Len()",
          "56:  buf := make([]byte, (l+unix.NLA_ALIGNTO-1) & ^(unix.NLA_ALIGNTO-1))",
          "57:  native := nl.NativeEndian()",
          "58:  native.PutUint16(buf[0:2], uint16(l))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:  if l > math.MaxUint16 {",
          "63:   panic(netlinkError{fmt.Errorf(\"netlink: cannot serialize bytemsg of length %d (larger than UINT16_MAX)\", l)})",
          "64:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d614445dd8f03d3b0fcf12ef9fbf11f1884a2aed",
      "candidate_info": {
        "commit_hash": "d614445dd8f03d3b0fcf12ef9fbf11f1884a2aed",
        "repo": "opencontainers/runc",
        "commit_url": "https://github.com/opencontainers/runc/commit/d614445dd8f03d3b0fcf12ef9fbf11f1884a2aed",
        "files": [
          "libcontainer/nsenter/nsexec.c"
        ],
        "message": "[1.1] libct/nsenter: switch to sane_kill()\n\nSigned-off-by: guodong <guodong9211@gmail.com>",
        "before_after_code_files": [
          "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c"
          ],
          "candidate": [
            "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c"
          ]
        }
      },
      "candidate_diff": {
        "libcontainer/nsenter/nsexec.c||libcontainer/nsenter/nsexec.c": [
          "File: libcontainer/nsenter/nsexec.c -> libcontainer/nsenter/nsexec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1069:      s = SYNC_MOUNTSOURCES_ACK;",
          "1070:      if (write(syncfd, &s, sizeof(s)) != sizeof(s)) {",
          "1072:       bail(\"failed to sync with child: write(SYNC_MOUNTSOURCES_ACK)\");",
          "1073:      }",
          "1074:      break;",
          "",
          "[Removed Lines]",
          "1071:       kill(stage1_pid, SIGKILL);",
          "",
          "[Added Lines]",
          "1071:       sane_kill(stage1_pid, SIGKILL);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1230:    if (config.mountsources) {",
          "1231:     s = SYNC_MOUNTSOURCES_PLS;",
          "1232:     if (write(syncfd, &s, sizeof(s)) != sizeof(s)) {",
          "1234:      bail(\"failed to sync with parent: write(SYNC_MOUNTSOURCES_PLS)\");",
          "1235:     }",
          "",
          "[Removed Lines]",
          "1233:      kill(stage2_pid, SIGKILL);",
          "",
          "[Added Lines]",
          "1233:      sane_kill(stage2_pid, SIGKILL);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1241:     if (read(syncfd, &s, sizeof(s)) != sizeof(s)) {",
          "1243:      bail(\"failed to sync with parent: read(SYNC_MOUNTSOURCES_ACK)\");",
          "1244:     }",
          "1245:     if (s != SYNC_MOUNTSOURCES_ACK) {",
          "1247:      bail(\"failed to sync with parent: SYNC_MOUNTSOURCES_ACK: got %u\", s);",
          "1248:     }",
          "1249:    }",
          "",
          "[Removed Lines]",
          "1242:      kill(stage2_pid, SIGKILL);",
          "1246:      kill(stage2_pid, SIGKILL);",
          "",
          "[Added Lines]",
          "1242:      sane_kill(stage2_pid, SIGKILL);",
          "1246:      sane_kill(stage2_pid, SIGKILL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "102b8abd266de73950301aae0106f2ca582c2de3",
      "candidate_info": {
        "commit_hash": "102b8abd266de73950301aae0106f2ca582c2de3",
        "repo": "opencontainers/runc",
        "commit_url": "https://github.com/opencontainers/runc/commit/102b8abd266de73950301aae0106f2ca582c2de3",
        "files": [
          "delete.go",
          "libcontainer/container.go",
          "libcontainer/container_linux.go",
          "libcontainer/container_linux_test.go",
          "libcontainer/factory_linux.go",
          "libcontainer/factory_linux_test.go",
          "libcontainer/integration/utils_test.go",
          "libcontainer/process_linux.go",
          "libcontainer/state_linux.go",
          "libcontainer/state_linux_test.go",
          "notify_socket.go",
          "utils_linux.go"
        ],
        "message": "libct: rm BaseContainer and Container interfaces\n\nThe only implementation of these is linuxContainer. It does not make\nsense to have an interface with a single implementation, and we do not\nforesee other types of containers being added to runc.\n\nRemove BaseContainer and Container interfaces, moving their methods\ndocumentation to linuxContainer.\n\nRename linuxContainer to Container.\n\nAdopt users from using interface to using struct.\n\nSigned-off-by: Kir Kolyshkin <kolyshkin@gmail.com>",
        "before_after_code_files": [
          "delete.go||delete.go",
          "libcontainer/container.go||libcontainer/container.go",
          "libcontainer/container_linux.go||libcontainer/container_linux.go",
          "libcontainer/container_linux_test.go||libcontainer/container_linux_test.go",
          "libcontainer/factory_linux.go||libcontainer/factory_linux.go",
          "libcontainer/factory_linux_test.go||libcontainer/factory_linux_test.go",
          "libcontainer/integration/utils_test.go||libcontainer/integration/utils_test.go",
          "libcontainer/process_linux.go||libcontainer/process_linux.go",
          "libcontainer/state_linux.go||libcontainer/state_linux.go",
          "libcontainer/state_linux_test.go||libcontainer/state_linux_test.go",
          "notify_socket.go||notify_socket.go",
          "utils_linux.go||utils_linux.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libcontainer/container_linux.go||libcontainer/container_linux.go",
            "libcontainer/factory_linux.go||libcontainer/factory_linux.go"
          ],
          "candidate": [
            "libcontainer/container_linux.go||libcontainer/container_linux.go",
            "libcontainer/factory_linux.go||libcontainer/factory_linux.go"
          ]
        }
      },
      "candidate_diff": {
        "delete.go||delete.go": [
          "File: delete.go -> delete.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13:  \"golang.org/x/sys/unix\"",
          "14: )",
          "17:  _ = container.Signal(unix.SIGKILL, false)",
          "18:  for i := 0; i < 100; i++ {",
          "19:   time.Sleep(100 * time.Millisecond)",
          "",
          "[Removed Lines]",
          "16: func killContainer(container libcontainer.Container) error {",
          "",
          "[Added Lines]",
          "16: func killContainer(container *libcontainer.Container) error {",
          "",
          "---------------"
        ],
        "libcontainer/container.go||libcontainer/container.go": [
          "File: libcontainer/container.go -> libcontainer/container.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: package libcontainer",
          "7: import (",
          "9:  \"time\"",
          "11:  \"github.com/opencontainers/runc/libcontainer/configs\"",
          "13: )",
          "",
          "[Removed Lines]",
          "8:  \"os\"",
          "12:  \"github.com/opencontainers/runtime-spec/specs-go\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "60:  Config configs.Config `json:\"config\"`",
          "61: }",
          "",
          "[Removed Lines]",
          "68: type BaseContainer interface {",
          "70:  ID() string",
          "73:  Status() (Status, error)",
          "76:  State() (*State, error)",
          "79:  OCIState() (*specs.State, error)",
          "82:  Config() configs.Config",
          "88:  Processes() ([]int, error)",
          "91:  Stats() (*Stats, error)",
          "97:  Set(config configs.Config) error",
          "101:  Start(process *Process) (err error)",
          "106:  Run(process *Process) (err error)",
          "116:  Destroy() error",
          "122:  Signal(s os.Signal, all bool) error",
          "125:  Exec() error",
          "126: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "libcontainer/container_linux.go||libcontainer/container_linux.go": [
          "File: libcontainer/container_linux.go -> libcontainer/container_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: const stdioFdCount = 3",
          "40:  id                   string",
          "41:  root                 string",
          "42:  config               *configs.Config",
          "",
          "[Removed Lines]",
          "39: type linuxContainer struct {",
          "",
          "[Added Lines]",
          "40: type Container struct {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:  IntelRdtPath string `json:\"intel_rdt_path\"`",
          "81: }",
          "119:  return c.id",
          "120: }",
          "124:  return *c.config",
          "125: }",
          "128:  c.m.Lock()",
          "129:  defer c.m.Unlock()",
          "130:  return c.currentStatus()",
          "131: }",
          "134:  c.m.Lock()",
          "135:  defer c.m.Unlock()",
          "136:  return c.currentState()",
          "137: }",
          "140:  c.m.Lock()",
          "141:  defer c.m.Unlock()",
          "142:  return c.currentOCIState()",
          "143: }",
          "146:  var pids []int",
          "147:  status, err := c.currentStatus()",
          "148:  if err != nil {",
          "",
          "[Removed Lines]",
          "88: type Container interface {",
          "89:  BaseContainer",
          "94:  Checkpoint(criuOpts *CriuOpts) error",
          "97:  Restore(process *Process, criuOpts *CriuOpts) error",
          "103:  Pause() error",
          "108:  Resume() error",
          "111:  NotifyOOM() (<-chan struct{}, error)",
          "114:  NotifyMemoryPressure(level PressureLevel) (<-chan struct{}, error)",
          "115: }",
          "118: func (c *linuxContainer) ID() string {",
          "123: func (c *linuxContainer) Config() configs.Config {",
          "127: func (c *linuxContainer) Status() (Status, error) {",
          "133: func (c *linuxContainer) State() (*State, error) {",
          "139: func (c *linuxContainer) OCIState() (*specs.State, error) {",
          "145: func (c *linuxContainer) Processes() ([]int, error) {",
          "",
          "[Added Lines]",
          "85: func (c *Container) ID() string {",
          "90: func (c *Container) Config() configs.Config {",
          "95: func (c *Container) Status() (Status, error) {",
          "102: func (c *Container) State() (*State, error) {",
          "109: func (c *Container) OCIState() (*specs.State, error) {",
          "121: func (c *Container) Processes() ([]int, error) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "160:  return pids, nil",
          "161: }",
          "164:  var (",
          "165:   err   error",
          "166:   stats = &Stats{}",
          "",
          "[Removed Lines]",
          "163: func (c *linuxContainer) Stats() (*Stats, error) {",
          "",
          "[Added Lines]",
          "140: func (c *Container) Stats() (*Stats, error) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "186:  return stats, nil",
          "187: }",
          "190:  c.m.Lock()",
          "191:  defer c.m.Unlock()",
          "192:  status, err := c.currentStatus()",
          "",
          "[Removed Lines]",
          "189: func (c *linuxContainer) Set(config configs.Config) error {",
          "",
          "[Added Lines]",
          "168: func (c *Container) Set(config configs.Config) error {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "221:  return err",
          "222: }",
          "225:  c.m.Lock()",
          "226:  defer c.m.Unlock()",
          "227:  if c.config.Cgroups.Resources.SkipDevices {",
          "",
          "[Removed Lines]",
          "224: func (c *linuxContainer) Start(process *Process) error {",
          "",
          "[Added Lines]",
          "205: func (c *Container) Start(process *Process) error {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "241:  return nil",
          "242: }",
          "245:  if err := c.Start(process); err != nil {",
          "246:   return err",
          "247:  }",
          "",
          "[Removed Lines]",
          "244: func (c *linuxContainer) Run(process *Process) error {",
          "",
          "[Added Lines]",
          "228: func (c *Container) Run(process *Process) error {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "251:  return nil",
          "252: }",
          "255:  c.m.Lock()",
          "256:  defer c.m.Unlock()",
          "257:  return c.exec()",
          "258: }",
          "261:  path := filepath.Join(c.root, execFifoFilename)",
          "262:  pid := c.initProcess.pid()",
          "263:  blockingFifoOpenCh := awaitFifoOpen(path)",
          "",
          "[Removed Lines]",
          "254: func (c *linuxContainer) Exec() error {",
          "260: func (c *linuxContainer) exec() error {",
          "",
          "[Added Lines]",
          "239: func (c *Container) Exec() error {",
          "245: func (c *Container) exec() error {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "329:  err  error",
          "330: }",
          "333:  parent, err := c.newParentProcess(process)",
          "334:  if err != nil {",
          "335:   return fmt.Errorf(\"unable to create new parent process: %w\", err)",
          "",
          "[Removed Lines]",
          "332: func (c *linuxContainer) start(process *Process) (retErr error) {",
          "",
          "[Added Lines]",
          "317: func (c *Container) start(process *Process) (retErr error) {",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "370:  return nil",
          "371: }",
          "374:  c.m.Lock()",
          "375:  defer c.m.Unlock()",
          "376:  status, err := c.currentStatus()",
          "",
          "[Removed Lines]",
          "373: func (c *linuxContainer) Signal(s os.Signal, all bool) error {",
          "",
          "[Added Lines]",
          "358: func (c *Container) Signal(s os.Signal, all bool) error {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "402:  return ErrNotRunning",
          "403: }",
          "406:  rootuid, err := c.Config().HostRootUID()",
          "407:  if err != nil {",
          "408:   return err",
          "",
          "[Removed Lines]",
          "405: func (c *linuxContainer) createExecFifo() error {",
          "",
          "[Added Lines]",
          "390: func (c *Container) createExecFifo() error {",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "425:  return os.Chown(fifoName, rootuid, rootgid)",
          "426: }",
          "429:  fifoName := filepath.Join(c.root, execFifoFilename)",
          "430:  os.Remove(fifoName)",
          "431: }",
          "",
          "[Removed Lines]",
          "428: func (c *linuxContainer) deleteExecFifo() {",
          "",
          "[Added Lines]",
          "413: func (c *Container) deleteExecFifo() {",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "438:  fifoName := filepath.Join(c.root, execFifoFilename)",
          "439:  fifo, err := os.OpenFile(fifoName, unix.O_PATH|unix.O_CLOEXEC, 0)",
          "440:  if err != nil {",
          "",
          "[Removed Lines]",
          "437: func (c *linuxContainer) includeExecFifo(cmd *exec.Cmd) error {",
          "",
          "[Added Lines]",
          "422: func (c *Container) includeExecFifo(cmd *exec.Cmd) error {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "448:  return nil",
          "449: }",
          "452:  parentInitPipe, childInitPipe, err := utils.NewSockPair(\"init\")",
          "453:  if err != nil {",
          "454:   return nil, fmt.Errorf(\"unable to create init pipe: %w\", err)",
          "",
          "[Removed Lines]",
          "451: func (c *linuxContainer) newParentProcess(p *Process) (parentProcess, error) {",
          "",
          "[Added Lines]",
          "436: func (c *Container) newParentProcess(p *Process) (parentProcess, error) {",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "477:  return c.newInitProcess(p, cmd, messageSockPair, logFilePair)",
          "478: }",
          "481:  cmd := exec.Command(\"/proc/self/exe\", \"init\")",
          "482:  cmd.Args[0] = os.Args[0]",
          "483:  cmd.Stdin = p.Stdin",
          "",
          "[Removed Lines]",
          "480: func (c *linuxContainer) commandTemplate(p *Process, childInitPipe *os.File, childLogPipe *os.File) *exec.Cmd {",
          "",
          "[Added Lines]",
          "465: func (c *Container) commandTemplate(p *Process, childInitPipe *os.File, childLogPipe *os.File) *exec.Cmd {",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "525:  if !c.config.Namespaces.Contains(configs.NEWUSER) ||",
          "",
          "[Removed Lines]",
          "522: func (c *linuxContainer) shouldSendMountSources() bool {",
          "",
          "[Added Lines]",
          "507: func (c *Container) shouldSendMountSources() bool {",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "543:  return false",
          "544: }",
          "547:  cmd.Env = append(cmd.Env, \"_LIBCONTAINER_INITTYPE=\"+string(initStandard))",
          "548:  nsMaps := make(map[configs.NamespaceType]string)",
          "549:  for _, ns := range c.config.Namespaces {",
          "",
          "[Removed Lines]",
          "546: func (c *linuxContainer) newInitProcess(p *Process, cmd *exec.Cmd, messageSockPair, logFilePair filePair) (*initProcess, error) {",
          "",
          "[Added Lines]",
          "531: func (c *Container) newInitProcess(p *Process, cmd *exec.Cmd, messageSockPair, logFilePair filePair) (*initProcess, error) {",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "602:  return init, nil",
          "603: }",
          "606:  cmd.Env = append(cmd.Env, \"_LIBCONTAINER_INITTYPE=\"+string(initSetns))",
          "607:  state, err := c.currentState()",
          "608:  if err != nil {",
          "",
          "[Removed Lines]",
          "605: func (c *linuxContainer) newSetnsProcess(p *Process, cmd *exec.Cmd, messageSockPair, logFilePair filePair) (*setnsProcess, error) {",
          "",
          "[Added Lines]",
          "590: func (c *Container) newSetnsProcess(p *Process, cmd *exec.Cmd, messageSockPair, logFilePair filePair) (*setnsProcess, error) {",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "659:  return proc, nil",
          "660: }",
          "663:  cfg := &initConfig{",
          "664:   Config:           c.config,",
          "665:   Args:             process.Args,",
          "",
          "[Removed Lines]",
          "662: func (c *linuxContainer) newInitConfig(process *Process) *initConfig {",
          "",
          "[Added Lines]",
          "647: func (c *Container) newInitConfig(process *Process) *initConfig {",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "699:  return cfg",
          "700: }",
          "703:  c.m.Lock()",
          "704:  defer c.m.Unlock()",
          "705:  return c.state.destroy()",
          "706: }",
          "709:  c.m.Lock()",
          "710:  defer c.m.Unlock()",
          "711:  status, err := c.currentStatus()",
          "",
          "[Removed Lines]",
          "702: func (c *linuxContainer) Destroy() error {",
          "708: func (c *linuxContainer) Pause() error {",
          "",
          "[Added Lines]",
          "695: func (c *Container) Destroy() error {",
          "703: func (c *Container) Pause() error {",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "724:  return ErrNotRunning",
          "725: }",
          "728:  c.m.Lock()",
          "729:  defer c.m.Unlock()",
          "730:  status, err := c.currentStatus()",
          "",
          "[Removed Lines]",
          "727: func (c *linuxContainer) Resume() error {",
          "",
          "[Added Lines]",
          "726: func (c *Container) Resume() error {",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "742:  })",
          "743: }",
          "747:  if c.config.RootlessCgroups {",
          "748:   logrus.Warn(\"getting OOM notifications may fail if you don't have the full access to cgroups\")",
          "",
          "[Removed Lines]",
          "745: func (c *linuxContainer) NotifyOOM() (<-chan struct{}, error) {",
          "",
          "[Added Lines]",
          "746: func (c *Container) NotifyOOM() (<-chan struct{}, error) {",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "754:  return notifyOnOOM(path)",
          "755: }",
          "759:  if c.config.RootlessCgroups {",
          "760:   logrus.Warn(\"getting memory pressure notifications may fail if you don't have the full access to cgroups\")",
          "",
          "[Removed Lines]",
          "757: func (c *linuxContainer) NotifyMemoryPressure(level PressureLevel) (<-chan struct{}, error) {",
          "",
          "[Added Lines]",
          "760: func (c *Container) NotifyMemoryPressure(level PressureLevel) (<-chan struct{}, error) {",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "765: var criuFeatures *criurpc.CriuFeatures",
          "768:  t := criurpc.CriuReqType_FEATURE_CHECK",
          "",
          "[Removed Lines]",
          "767: func (c *linuxContainer) checkCriuFeatures(criuOpts *CriuOpts, rpcOpts *criurpc.CriuOpts, criuFeat *criurpc.CriuFeatures) error {",
          "",
          "[Added Lines]",
          "770: func (c *Container) checkCriuFeatures(criuOpts *CriuOpts, rpcOpts *criurpc.CriuOpts, criuFeat *criurpc.CriuFeatures) error {",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "824:  return nil",
          "825: }",
          "831:  if c.criuVersion != 0 {",
          "",
          "[Removed Lines]",
          "828: func (c *linuxContainer) checkCriuVersion(minVersion int) error {",
          "",
          "[Added Lines]",
          "831: func (c *Container) checkCriuVersion(minVersion int) error {",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "845: const descriptorsFilename = \"descriptors.json\"",
          "848:  mountDest := strings.TrimPrefix(m.Destination, c.config.Rootfs)",
          "849:  if dest, err := securejoin.SecureJoin(c.config.Rootfs, mountDest); err == nil {",
          "850:   mountDest = dest[len(c.config.Rootfs):]",
          "",
          "[Removed Lines]",
          "847: func (c *linuxContainer) addCriuDumpMount(req *criurpc.CriuReq, m *configs.Mount) {",
          "",
          "[Added Lines]",
          "850: func (c *Container) addCriuDumpMount(req *criurpc.CriuReq, m *configs.Mount) {",
          "",
          "---------------",
          "--- Hunk 26 ---",
          "[Context before]",
          "856:  req.Opts.ExtMnt = append(req.Opts.ExtMnt, extMnt)",
          "857: }",
          "860:  for _, path := range c.config.MaskPaths {",
          "861:   fi, err := os.Stat(fmt.Sprintf(\"/proc/%d/root/%s\", c.initProcess.pid(), path))",
          "862:   if err != nil {",
          "",
          "[Removed Lines]",
          "859: func (c *linuxContainer) addMaskPaths(req *criurpc.CriuReq) error {",
          "",
          "[Added Lines]",
          "862: func (c *Container) addMaskPaths(req *criurpc.CriuReq) error {",
          "",
          "---------------",
          "--- Hunk 27 ---",
          "[Context before]",
          "878:  return nil",
          "879: }",
          "",
          "[Removed Lines]",
          "881: func (c *linuxContainer) handleCriuConfigurationFile(rpcOpts *criurpc.CriuOpts) {",
          "",
          "[Added Lines]",
          "884: func (c *Container) handleCriuConfigurationFile(rpcOpts *criurpc.CriuOpts) {",
          "",
          "---------------",
          "--- Hunk 28 ---",
          "[Context before]",
          "903:  }",
          "904: }",
          "907:  var minVersion int",
          "908:  switch t {",
          "909:  case configs.NEWNET:",
          "",
          "[Removed Lines]",
          "906: func (c *linuxContainer) criuSupportsExtNS(t configs.NamespaceType) bool {",
          "",
          "[Added Lines]",
          "909: func (c *Container) criuSupportsExtNS(t configs.NamespaceType) bool {",
          "",
          "---------------",
          "--- Hunk 29 ---",
          "[Context before]",
          "923:  return \"extRoot\" + strings.Title(configs.NsName(t)) + \"NS\" //nolint:staticcheck // SA1019: strings.Title is deprecated",
          "924: }",
          "927:  if !c.criuSupportsExtNS(t) {",
          "928:   return nil",
          "929:  }",
          "",
          "[Removed Lines]",
          "926: func (c *linuxContainer) handleCheckpointingExternalNamespaces(rpcOpts *criurpc.CriuOpts, t configs.NamespaceType) error {",
          "",
          "[Added Lines]",
          "929: func (c *Container) handleCheckpointingExternalNamespaces(rpcOpts *criurpc.CriuOpts, t configs.NamespaceType) error {",
          "",
          "---------------",
          "--- Hunk 30 ---",
          "[Context before]",
          "945:  return nil",
          "946: }",
          "949:  for _, ns := range c.config.Namespaces {",
          "950:   switch ns.Type {",
          "951:   case configs.NEWNET, configs.NEWPID:",
          "",
          "[Removed Lines]",
          "948: func (c *linuxContainer) handleRestoringNamespaces(rpcOpts *criurpc.CriuOpts, extraFiles *[]*os.File) error {",
          "",
          "[Added Lines]",
          "951: func (c *Container) handleRestoringNamespaces(rpcOpts *criurpc.CriuOpts, extraFiles *[]*os.File) error {",
          "",
          "---------------",
          "--- Hunk 31 ---",
          "[Context before]",
          "983:  return nil",
          "984: }",
          "987:  if !c.criuSupportsExtNS(t) {",
          "988:   return nil",
          "989:  }",
          "",
          "[Removed Lines]",
          "986: func (c *linuxContainer) handleRestoringExternalNamespaces(rpcOpts *criurpc.CriuOpts, extraFiles *[]*os.File, t configs.NamespaceType) error {",
          "",
          "[Added Lines]",
          "989: func (c *Container) handleRestoringExternalNamespaces(rpcOpts *criurpc.CriuOpts, extraFiles *[]*os.File, t configs.NamespaceType) error {",
          "",
          "---------------",
          "--- Hunk 32 ---",
          "[Context before]",
          "1014:  return nil",
          "1015: }",
          "1018:  c.m.Lock()",
          "1019:  defer c.m.Unlock()",
          "",
          "[Removed Lines]",
          "1017: func (c *linuxContainer) Checkpoint(criuOpts *CriuOpts) error {",
          "",
          "[Added Lines]",
          "1020: func (c *Container) Checkpoint(criuOpts *CriuOpts) error {",
          "",
          "---------------",
          "--- Hunk 33 ---",
          "[Context before]",
          "1222:  return nil",
          "1223: }",
          "1226:  mountDest := strings.TrimPrefix(m.Destination, c.config.Rootfs)",
          "1227:  if dest, err := securejoin.SecureJoin(c.config.Rootfs, mountDest); err == nil {",
          "1228:   mountDest = dest[len(c.config.Rootfs):]",
          "",
          "[Removed Lines]",
          "1225: func (c *linuxContainer) addCriuRestoreMount(req *criurpc.CriuReq, m *configs.Mount) {",
          "",
          "[Added Lines]",
          "1228: func (c *Container) addCriuRestoreMount(req *criurpc.CriuReq, m *configs.Mount) {",
          "",
          "---------------",
          "--- Hunk 34 ---",
          "[Context before]",
          "1234:  req.Opts.ExtMnt = append(req.Opts.ExtMnt, extMnt)",
          "1235: }",
          "1238:  for _, iface := range c.config.Networks {",
          "1239:   switch iface.Type {",
          "1240:   case \"veth\":",
          "",
          "[Removed Lines]",
          "1237: func (c *linuxContainer) restoreNetwork(req *criurpc.CriuReq, criuOpts *CriuOpts) {",
          "",
          "[Added Lines]",
          "1240: func (c *Container) restoreNetwork(req *criurpc.CriuReq, criuOpts *CriuOpts) {",
          "",
          "---------------",
          "--- Hunk 35 ---",
          "[Context before]",
          "1261:  switch m.Device {",
          "1262:  case \"cgroup\":",
          "",
          "[Removed Lines]",
          "1260: func (c *linuxContainer) makeCriuRestoreMountpoints(m *configs.Mount) error {",
          "",
          "[Added Lines]",
          "1263: func (c *Container) makeCriuRestoreMountpoints(m *configs.Mount) error {",
          "",
          "---------------",
          "--- Hunk 36 ---",
          "[Context before]",
          "1314:  tmpfs := []string{}",
          "1315:  for _, m := range mounts {",
          "",
          "[Removed Lines]",
          "1312: func (c *linuxContainer) prepareCriuRestoreMounts(mounts []*configs.Mount) error {",
          "",
          "[Added Lines]",
          "1315: func (c *Container) prepareCriuRestoreMounts(mounts []*configs.Mount) error {",
          "",
          "---------------",
          "--- Hunk 37 ---",
          "[Context before]",
          "1366:  return nil",
          "1367: }",
          "1370:  c.m.Lock()",
          "1371:  defer c.m.Unlock()",
          "",
          "[Removed Lines]",
          "1369: func (c *linuxContainer) Restore(process *Process, criuOpts *CriuOpts) error {",
          "",
          "[Added Lines]",
          "1374: func (c *Container) Restore(process *Process, criuOpts *CriuOpts) error {",
          "",
          "---------------",
          "--- Hunk 38 ---",
          "[Context before]",
          "1540:  return err",
          "1541: }",
          "1545:  if req.GetType() != criurpc.CriuReqType_RESTORE {",
          "1546:   return nil",
          "",
          "[Removed Lines]",
          "1543: func (c *linuxContainer) criuApplyCgroups(pid int, req *criurpc.CriuReq) error {",
          "",
          "[Added Lines]",
          "1548: func (c *Container) criuApplyCgroups(pid int, req *criurpc.CriuReq) error {",
          "",
          "---------------",
          "--- Hunk 39 ---",
          "[Context before]",
          "1577:  return nil",
          "1578: }",
          "1581:  fds, err := unix.Socketpair(unix.AF_LOCAL, unix.SOCK_SEQPACKET|unix.SOCK_CLOEXEC, 0)",
          "1582:  if err != nil {",
          "1583:   return err",
          "",
          "[Removed Lines]",
          "1580: func (c *linuxContainer) criuSwrk(process *Process, req *criurpc.CriuReq, opts *CriuOpts, extraFiles []*os.File) error {",
          "",
          "[Added Lines]",
          "1585: func (c *Container) criuSwrk(process *Process, req *criurpc.CriuReq, opts *CriuOpts, extraFiles []*os.File) error {",
          "",
          "---------------",
          "--- Hunk 40 ---",
          "[Context before]",
          "1795:  return nil",
          "1796: }",
          "1799:  notify := resp.GetNotify()",
          "1800:  if notify == nil {",
          "1801:   return fmt.Errorf(\"invalid response: %s\", resp.String())",
          "",
          "[Removed Lines]",
          "1798: func (c *linuxContainer) criuNotifications(resp *criurpc.CriuResp, process *Process, cmd *exec.Cmd, opts *CriuOpts, fds []string, oob []byte) error {",
          "",
          "[Added Lines]",
          "1803: func (c *Container) criuNotifications(resp *criurpc.CriuResp, process *Process, cmd *exec.Cmd, opts *CriuOpts, fds []string, oob []byte) error {",
          "",
          "---------------",
          "--- Hunk 41 ---",
          "[Context before]",
          "1893:  return nil",
          "1894: }",
          "1897:  if process != nil {",
          "1898:   c.initProcess = process",
          "1899:  }",
          "",
          "[Removed Lines]",
          "1896: func (c *linuxContainer) updateState(process parentProcess) (*State, error) {",
          "",
          "[Added Lines]",
          "1901: func (c *Container) updateState(process parentProcess) (*State, error) {",
          "",
          "---------------",
          "--- Hunk 42 ---",
          "[Context before]",
          "1908:  return state, nil",
          "1909: }",
          "1912:  tmpFile, err := os.CreateTemp(c.root, \"state-\")",
          "1913:  if err != nil {",
          "1914:   return err",
          "",
          "[Removed Lines]",
          "1911: func (c *linuxContainer) saveState(s *State) (retErr error) {",
          "",
          "[Added Lines]",
          "1916: func (c *Container) saveState(s *State) (retErr error) {",
          "",
          "---------------",
          "--- Hunk 43 ---",
          "[Context before]",
          "1934:  return os.Rename(tmpFile.Name(), stateFilePath)",
          "1935: }",
          "1938:  if err := c.refreshState(); err != nil {",
          "1939:   return -1, err",
          "1940:  }",
          "",
          "[Removed Lines]",
          "1937: func (c *linuxContainer) currentStatus() (Status, error) {",
          "",
          "[Added Lines]",
          "1942: func (c *Container) currentStatus() (Status, error) {",
          "",
          "---------------",
          "--- Hunk 44 ---",
          "[Context before]",
          "1949:  paused, err := c.isPaused()",
          "1950:  if err != nil {",
          "1951:   return err",
          "",
          "[Removed Lines]",
          "1948: func (c *linuxContainer) refreshState() error {",
          "",
          "[Added Lines]",
          "1953: func (c *Container) refreshState() error {",
          "",
          "---------------",
          "--- Hunk 45 ---",
          "[Context before]",
          "1963:  return c.state.transition(&stoppedState{c: c})",
          "1964: }",
          "1967:  if c.initProcess == nil {",
          "1968:   return Stopped",
          "1969:  }",
          "",
          "[Removed Lines]",
          "1966: func (c *linuxContainer) runType() Status {",
          "",
          "[Added Lines]",
          "1971: func (c *Container) runType() Status {",
          "",
          "---------------",
          "--- Hunk 46 ---",
          "[Context before]",
          "1983:  return Running",
          "1984: }",
          "1987:  state, err := c.cgroupManager.GetFreezerState()",
          "1988:  if err != nil {",
          "1989:   return false, err",
          "",
          "[Removed Lines]",
          "1986: func (c *linuxContainer) isPaused() (bool, error) {",
          "",
          "[Added Lines]",
          "1991: func (c *Container) isPaused() (bool, error) {",
          "",
          "---------------",
          "--- Hunk 47 ---",
          "[Context before]",
          "1991:  return state == configs.Frozen, nil",
          "1992: }",
          "1995:  var (",
          "1996:   startTime           uint64",
          "1997:   externalDescriptors []string",
          "",
          "[Removed Lines]",
          "1994: func (c *linuxContainer) currentState() (*State, error) {",
          "",
          "[Added Lines]",
          "1999: func (c *Container) currentState() (*State, error) {",
          "",
          "---------------",
          "--- Hunk 48 ---",
          "[Context before]",
          "2038:  return state, nil",
          "2039: }",
          "2042:  bundle, annotations := utils.Annotations(c.config.Labels)",
          "2043:  state := &specs.State{",
          "2044:   Version:     specs.Version,",
          "",
          "[Removed Lines]",
          "2041: func (c *linuxContainer) currentOCIState() (*specs.State, error) {",
          "",
          "[Added Lines]",
          "2046: func (c *Container) currentOCIState() (*specs.State, error) {",
          "",
          "---------------",
          "--- Hunk 49 ---",
          "[Context before]",
          "2065:  paths := []string{}",
          "2066:  for _, ns := range configs.NamespaceTypes() {",
          "",
          "[Removed Lines]",
          "2064: func (c *linuxContainer) orderNamespacePaths(namespaces map[configs.NamespaceType]string) ([]string, error) {",
          "",
          "[Added Lines]",
          "2069: func (c *Container) orderNamespacePaths(namespaces map[configs.NamespaceType]string) ([]string, error) {",
          "",
          "---------------",
          "--- Hunk 50 ---",
          "[Context before]",
          "2119:  r := nl.NewNetlinkRequest(int(InitMsg), 0)",
          "",
          "[Removed Lines]",
          "2117: func (c *linuxContainer) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string, it initType) (_ io.Reader, Err error) {",
          "",
          "[Added Lines]",
          "2122: func (c *Container) bootstrapData(cloneFlags uintptr, nsMaps map[configs.NamespaceType]string, it initType) (_ io.Reader, Err error) {",
          "",
          "---------------"
        ],
        "libcontainer/container_linux_test.go||libcontainer/container_linux_test.go": [
          "File: libcontainer/container_linux_test.go -> libcontainer/container_linux_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "115:  if err != nil {",
          "116:   t.Fatalf(\"can't stat pid %d, got %v\", pid, err)",
          "117:  }",
          "119:   id:     \"myid\",",
          "120:   config: &configs.Config{},",
          "121:   cgroupManager: &mockCgroupManager{",
          "",
          "[Removed Lines]",
          "118:  container := &linuxContainer{",
          "",
          "[Added Lines]",
          "118:  container := &Container{",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "148:   expectedMemoryPath  = \"/sys/fs/cgroup/memory/myid\"",
          "149:   expectedNetworkPath = fmt.Sprintf(\"/proc/%d/ns/net\", pid)",
          "150:  )",
          "152:   id: \"myid\",",
          "153:   config: &configs.Config{",
          "154:    Namespaces: []configs.Namespace{",
          "",
          "[Removed Lines]",
          "151:  container := &linuxContainer{",
          "",
          "[Added Lines]",
          "151:  container := &Container{",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "232:   t.Fatal(err)",
          "233:  }",
          "236:   root: t.TempDir(),",
          "237:   id:   \"myid\",",
          "238:   config: &configs.Config{",
          "",
          "[Removed Lines]",
          "235:  container := &linuxContainer{",
          "",
          "[Added Lines]",
          "235:  container := &Container{",
          "",
          "---------------"
        ],
        "libcontainer/factory_linux.go||libcontainer/factory_linux.go": [
          "File: libcontainer/factory_linux.go -> libcontainer/factory_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:  if root == \"\" {",
          "42:   return nil, errors.New(\"root not set\")",
          "43:  }",
          "",
          "[Removed Lines]",
          "40: func Create(root, id string, config *configs.Config) (Container, error) {",
          "",
          "[Added Lines]",
          "40: func Create(root, id string, config *configs.Config) (*Container, error) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:  if err := os.Mkdir(containerRoot, 0o711); err != nil {",
          "99:   return nil, err",
          "100:  }",
          "102:   id:              id,",
          "103:   root:            containerRoot,",
          "104:   config:          config,",
          "",
          "[Removed Lines]",
          "101:  c := &linuxContainer{",
          "",
          "[Added Lines]",
          "101:  c := &Container{",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "116:  if root == \"\" {",
          "117:   return nil, errors.New(\"root not set\")",
          "118:  }",
          "",
          "[Removed Lines]",
          "115: func Load(root, id string) (Container, error) {",
          "",
          "[Added Lines]",
          "115: func Load(root, id string) (*Container, error) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "137:  if err != nil {",
          "138:   return nil, err",
          "139:  }",
          "141:   initProcess:          r,",
          "142:   initProcessStartTime: state.InitProcessStartTime,",
          "143:   id:                   id,",
          "",
          "[Removed Lines]",
          "140:  c := &linuxContainer{",
          "",
          "[Added Lines]",
          "140:  c := &Container{",
          "",
          "---------------"
        ],
        "libcontainer/factory_linux_test.go||libcontainer/factory_linux_test.go": [
          "File: libcontainer/factory_linux_test.go -> libcontainer/factory_linux_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:  if !reflect.DeepEqual(config.Hooks, expectedHooks) {",
          "76:   t.Fatalf(\"expects hooks %q but received %q\", expectedHooks, config.Hooks)",
          "77:  }",
          "84:  }",
          "85: }",
          "",
          "[Removed Lines]",
          "78:  lcontainer, ok := container.(*linuxContainer)",
          "79:  if !ok {",
          "80:   t.Fatal(\"expected linux container on linux based systems\")",
          "81:  }",
          "82:  if lcontainer.initProcess.pid() != expectedState.InitProcessPid {",
          "83:   t.Fatalf(\"expected init pid %d but received %d\", expectedState.InitProcessPid, lcontainer.initProcess.pid())",
          "",
          "[Added Lines]",
          "78:  if container.initProcess.pid() != expectedState.InitProcessPid {",
          "79:   t.Fatalf(\"expected init pid %d but received %d\", expectedState.InitProcessPid, container.initProcess.pid())",
          "",
          "---------------"
        ],
        "libcontainer/integration/utils_test.go||libcontainer/integration/utils_test.go": [
          "File: libcontainer/integration/utils_test.go -> libcontainer/integration/utils_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "165:  return nil",
          "166: }",
          "169:  name := strings.ReplaceAll(t.Name(), \"/\", \"_\") + strconv.FormatInt(-int64(time.Now().Nanosecond()), 35)",
          "170:  root := t.TempDir()",
          "",
          "[Removed Lines]",
          "168: func newContainer(t *testing.T, config *configs.Config) (libcontainer.Container, error) {",
          "",
          "[Added Lines]",
          "168: func newContainer(t *testing.T, config *configs.Config) (*libcontainer.Container, error) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "212:  return",
          "213: }",
          "216:  _ = container.Destroy()",
          "217: }",
          "",
          "[Removed Lines]",
          "215: func destroyContainer(container libcontainer.Container) {",
          "",
          "[Added Lines]",
          "215: func destroyContainer(container *libcontainer.Container) {",
          "",
          "---------------"
        ],
        "libcontainer/process_linux.go||libcontainer/process_linux.go": [
          "File: libcontainer/process_linux.go -> libcontainer/process_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "300:  config          *initConfig",
          "301:  manager         cgroups.Manager",
          "302:  intelRdtManager *intelrdt.Manager",
          "304:  fds             []string",
          "305:  process         *Process",
          "306:  bootstrapData   io.Reader",
          "",
          "[Removed Lines]",
          "303:  container       *linuxContainer",
          "",
          "[Added Lines]",
          "303:  container       *Container",
          "",
          "---------------"
        ],
        "libcontainer/state_linux.go||libcontainer/state_linux.go": [
          "File: libcontainer/state_linux.go -> libcontainer/state_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "35:  status() Status",
          "36: }",
          "39:  if !c.config.Namespaces.Contains(configs.NEWPID) ||",
          "40:   c.config.Namespaces.PathOf(configs.NEWPID) != \"\" {",
          "41:   if err := signalAllProcesses(c.cgroupManager, unix.SIGKILL); err != nil {",
          "",
          "[Removed Lines]",
          "38: func destroy(c *linuxContainer) error {",
          "",
          "[Added Lines]",
          "38: func destroy(c *Container) error {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59:  return err",
          "60: }",
          "63:  hooks := c.config.Hooks",
          "64:  if hooks == nil {",
          "65:   return nil",
          "",
          "[Removed Lines]",
          "62: func runPoststopHooks(c *linuxContainer) error {",
          "",
          "[Added Lines]",
          "62: func runPoststopHooks(c *Container) error {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "82: type stoppedState struct {",
          "84: }",
          "86: func (b *stoppedState) status() Status {",
          "",
          "[Removed Lines]",
          "83:  c *linuxContainer",
          "",
          "[Added Lines]",
          "83:  c *Container",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "106: type runningState struct {",
          "108: }",
          "110: func (r *runningState) status() Status {",
          "",
          "[Removed Lines]",
          "107:  c *linuxContainer",
          "",
          "[Added Lines]",
          "107:  c *Container",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "136: }",
          "138: type createdState struct {",
          "140: }",
          "142: func (i *createdState) status() Status {",
          "",
          "[Removed Lines]",
          "139:  c *linuxContainer",
          "",
          "[Added Lines]",
          "139:  c *Container",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "164: type pausedState struct {",
          "166: }",
          "168: func (p *pausedState) status() Status {",
          "",
          "[Removed Lines]",
          "165:  c *linuxContainer",
          "",
          "[Added Lines]",
          "165:  c *Container",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "196: type restoredState struct {",
          "197:  imageDir string",
          "199: }",
          "201: func (r *restoredState) status() Status {",
          "",
          "[Removed Lines]",
          "198:  c        *linuxContainer",
          "",
          "[Added Lines]",
          "198:  c        *Container",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "224: type loadedState struct {",
          "226:  s Status",
          "227: }",
          "",
          "[Removed Lines]",
          "225:  c *linuxContainer",
          "",
          "[Added Lines]",
          "225:  c *Container",
          "",
          "---------------"
        ],
        "libcontainer/state_linux_test.go||libcontainer/state_linux_test.go": [
          "File: libcontainer/state_linux_test.go -> libcontainer/state_linux_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "53: func TestStoppedStateTransition(t *testing.T) {",
          "54:  testTransitions(",
          "55:   t,",
          "57:   []containerState{",
          "58:    &stoppedState{},",
          "59:    &runningState{},",
          "",
          "[Removed Lines]",
          "56:   &stoppedState{c: &linuxContainer{}},",
          "",
          "[Added Lines]",
          "56:   &stoppedState{c: &Container{}},",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "65: func TestPausedStateTransition(t *testing.T) {",
          "66:  testTransitions(",
          "67:   t,",
          "69:   []containerState{",
          "70:    &pausedState{},",
          "71:    &runningState{},",
          "",
          "[Removed Lines]",
          "68:   &pausedState{c: &linuxContainer{}},",
          "",
          "[Added Lines]",
          "68:   &pausedState{c: &Container{}},",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "77: func TestRestoredStateTransition(t *testing.T) {",
          "78:  testTransitions(",
          "79:   t,",
          "81:   []containerState{",
          "82:    &stoppedState{},",
          "83:    &runningState{},",
          "",
          "[Removed Lines]",
          "80:   &restoredState{c: &linuxContainer{}},",
          "",
          "[Added Lines]",
          "80:   &restoredState{c: &Container{}},",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "88: func TestRunningStateTransition(t *testing.T) {",
          "89:  testTransitions(",
          "90:   t,",
          "92:   []containerState{",
          "93:    &stoppedState{},",
          "94:    &pausedState{},",
          "",
          "[Removed Lines]",
          "91:   &runningState{c: &linuxContainer{}},",
          "",
          "[Added Lines]",
          "91:   &runningState{c: &Container{}},",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "100: func TestCreatedStateTransition(t *testing.T) {",
          "101:  testTransitions(",
          "102:   t,",
          "104:   []containerState{",
          "105:    &stoppedState{},",
          "106:    &pausedState{},",
          "",
          "[Removed Lines]",
          "103:   &createdState{c: &linuxContainer{}},",
          "",
          "[Added Lines]",
          "103:   &createdState{c: &Container{}},",
          "",
          "---------------"
        ],
        "notify_socket.go||notify_socket.go": [
          "File: notify_socket.go -> notify_socket.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:  return notifySocket, nil",
          "92: }",
          "95:  state, err := container.State()",
          "96:  if err != nil {",
          "97:   return err",
          "",
          "[Removed Lines]",
          "94: func (s *notifySocket) waitForContainer(container libcontainer.Container) error {",
          "",
          "[Added Lines]",
          "94: func (s *notifySocket) waitForContainer(container *libcontainer.Container) error {",
          "",
          "---------------"
        ],
        "utils_linux.go||utils_linux.go": [
          "File: utils_linux.go -> utils_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "29:  id := context.Args().First()",
          "30:  if id == \"\" {",
          "31:   return nil, errEmptyID",
          "",
          "[Removed Lines]",
          "28: func getContainer(context *cli.Context) (libcontainer.Container, error) {",
          "",
          "[Added Lines]",
          "28: func getContainer(context *cli.Context) (*libcontainer.Container, error) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82:  return lp, nil",
          "83: }",
          "86:  if err := container.Destroy(); err != nil {",
          "87:   logrus.Error(err)",
          "88:  }",
          "",
          "[Removed Lines]",
          "85: func destroy(container libcontainer.Container) {",
          "",
          "[Added Lines]",
          "85: func destroy(container *libcontainer.Container) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "162:  return os.Rename(tmpName, path)",
          "163: }",
          "166:  rootlessCg, err := shouldUseRootlessCgroupManager(context)",
          "167:  if err != nil {",
          "168:   return nil, err",
          "",
          "[Removed Lines]",
          "165: func createContainer(context *cli.Context, id string, spec *specs.Spec) (libcontainer.Container, error) {",
          "",
          "[Added Lines]",
          "165: func createContainer(context *cli.Context, id string, spec *specs.Spec) (*libcontainer.Container, error) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "193:  preserveFDs     int",
          "194:  pidFile         string",
          "195:  consoleSocket   string",
          "197:  action          CtAct",
          "198:  notifySocket    *notifySocket",
          "199:  criuOpts        *libcontainer.CriuOpts",
          "",
          "[Removed Lines]",
          "196:  container       libcontainer.Container",
          "",
          "[Added Lines]",
          "196:  container       *libcontainer.Container",
          "",
          "---------------"
        ]
      }
    }
  ]
}