{
  "cve_id": "CVE-2020-15248",
  "cve_desc": "October is a free, open-source, self-hosted CMS platform based on the Laravel PHP Framework. In October CMS from version 1.0.319 and before version 1.0.470, backend users with the default \"Publisher\" system role have access to create & manage users where they can choose which role the new user has. This means that a user with \"Publisher\" access has the ability to escalate their access to \"Developer\" access. Issue has been patched in Build 470 (v1.0.470) & v1.1.1.",
  "repo": "octobercms/october",
  "patch_hash": "78a37298a4ed4602b383522344a31e311402d829",
  "patch_info": {
    "commit_hash": "78a37298a4ed4602b383522344a31e311402d829",
    "repo": "octobercms/october",
    "commit_url": "https://github.com/octobercms/october/commit/78a37298a4ed4602b383522344a31e311402d829",
    "files": [
      "modules/backend/ServiceProvider.php",
      "modules/system/ServiceProvider.php"
    ],
    "message": "Tightened up the default permissions granted to the \"Publisher\" system role out of the box\n\n(cherry picked from commit 8a785e439395aa901d2b9d7bcb6a343a071c7870)",
    "before_after_code_files": [
      "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php",
      "modules/system/ServiceProvider.php||modules/system/ServiceProvider.php"
    ]
  },
  "patch_diff": {
    "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php": [
      "File: modules/backend/ServiceProvider.php -> modules/backend/ServiceProvider.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "140:             $manager->registerPermissions('October.Backend', [",
      "141:                 'backend.access_dashboard' => [",
      "142:                     'label' => 'system::lang.permissions.view_the_dashboard',",
      "144:                 ],",
      "145:                 'backend.manage_default_dashboard' => [",
      "146:                     'label' => 'system::lang.permissions.manage_default_dashboard',",
      "147:                     'tab'   => 'system::lang.permissions.name',",
      "148:                 ],",
      "149:                 'backend.manage_users' => [",
      "150:                     'label' => 'system::lang.permissions.manage_other_administrators',",
      "152:                 ],",
      "153:                 'backend.impersonate_users' => [",
      "154:                     'label' => 'system::lang.permissions.impersonate_users',",
      "155:                     'tab'   => 'system::lang.permissions.name',",
      "156:                 ],",
      "157:                 'backend.manage_preferences' => [",
      "158:                     'label' => 'system::lang.permissions.manage_preferences',",
      "160:                 ],",
      "161:                 'backend.manage_editor' => [",
      "162:                     'label' => 'system::lang.permissions.manage_editor',",
      "164:                 ],",
      "165:                 'backend.manage_branding' => [",
      "166:                     'label' => 'system::lang.permissions.manage_branding',",
      "168:                 ],",
      "169:                 'media.manage_media' => [",
      "170:                     'label' => 'backend::lang.permissions.manage_media',",
      "",
      "[Removed Lines]",
      "143:                     'tab'   => 'system::lang.permissions.name'",
      "151:                     'tab'   => 'system::lang.permissions.name'",
      "159:                     'tab'   => 'system::lang.permissions.name'",
      "163:                     'tab'   => 'system::lang.permissions.name'",
      "167:                     'tab'   => 'system::lang.permissions.name'",
      "",
      "[Added Lines]",
      "143:                     'tab'   => 'system::lang.permissions.name',",
      "148:                     'roles' => UserRole::CODE_DEVELOPER,",
      "152:                     'tab'   => 'system::lang.permissions.name',",
      "153:                     'roles' => UserRole::CODE_DEVELOPER,",
      "158:                     'roles' => UserRole::CODE_DEVELOPER,",
      "162:                     'tab'   => 'system::lang.permissions.name',",
      "166:                     'tab'   => 'system::lang.permissions.name',",
      "170:                     'tab'   => 'system::lang.permissions.name',",
      "",
      "---------------"
    ],
    "modules/system/ServiceProvider.php||modules/system/ServiceProvider.php": [
      "File: modules/system/ServiceProvider.php -> modules/system/ServiceProvider.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "9: use Request;",
      "10: use BackendMenu;",
      "11: use BackendAuth;",
      "12: use Twig\\Extension\\SandboxExtension;",
      "13: use Twig\\Environment as TwigEnvironment;",
      "14: use System\\Classes\\MailManager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "12: use Backend\\Models\\UserRole;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "417:             $manager->registerPermissions('October.System', [",
      "418:                 'system.manage_updates' => [",
      "419:                     'label' => 'system::lang.permissions.manage_software_updates',",
      "421:                 ],",
      "422:                 'system.access_logs' => [",
      "423:                     'label' => 'system::lang.permissions.access_logs',",
      "425:                 ],",
      "426:                 'system.manage_mail_settings' => [",
      "427:                     'label' => 'system::lang.permissions.manage_mail_settings',",
      "429:                 ],",
      "430:                 'system.manage_mail_templates' => [",
      "431:                     'label' => 'system::lang.permissions.manage_mail_templates',",
      "433:                 ]",
      "434:             ]);",
      "435:         });",
      "",
      "[Removed Lines]",
      "420:                     'tab' => 'system::lang.permissions.name'",
      "424:                     'tab' => 'system::lang.permissions.name'",
      "428:                     'tab' => 'system::lang.permissions.name'",
      "432:                     'tab' => 'system::lang.permissions.name'",
      "",
      "[Added Lines]",
      "421:                     'tab' => 'system::lang.permissions.name',",
      "422:                     'roles' => UserRole::CODE_DEVELOPER,",
      "426:                     'tab' => 'system::lang.permissions.name',",
      "427:                     'roles' => UserRole::CODE_DEVELOPER,",
      "431:                     'tab' => 'system::lang.permissions.name',",
      "432:                     'roles' => UserRole::CODE_DEVELOPER,",
      "436:                     'tab' => 'system::lang.permissions.name',",
      "437:                     'roles' => UserRole::CODE_DEVELOPER,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f9e14b02f586d509499b292ea9b8017208f02ce3",
      "candidate_info": {
        "commit_hash": "f9e14b02f586d509499b292ea9b8017208f02ce3",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/f9e14b02f586d509499b292ea9b8017208f02ce3",
        "files": [
          "modules/system/twig/Loader.php"
        ],
        "message": "Only allow view files in system twig\n\nThis no longer allows arbitrary inclusions, only views from the native Laravel view engine. Note this also affects the cms twig loader",
        "before_after_code_files": [
          "modules/system/twig/Loader.php||modules/system/twig/Loader.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/system/twig/Loader.php||modules/system/twig/Loader.php": [
          "File: modules/system/twig/Loader.php -> modules/system/twig/Loader.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: use App;",
          "4: use File;",
          "5: use Twig\\Source as TwigSource;",
          "6: use Twig\\Loader\\LoaderInterface as TwigLoaderInterface;",
          "7: use Exception;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5: use View;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "15: class Loader implements TwigLoaderInterface",
          "16: {",
          "",
          "[Removed Lines]",
          "20:     protected $extension = 'htm';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "37:             return $this->cache[$name];",
          "38:         }",
          "50:         return $this->cache[$name] = $path;",
          "51:     }",
          "53:     public function getSourceContext($name)",
          "54:     {",
          "56:     }",
          "58:     public function getCacheKey($name)",
          "",
          "[Removed Lines]",
          "40:         if (File::isFile($name)) {",
          "41:             return $this->cache[$name] = $name;",
          "42:         }",
          "44:         $view = $name;",
          "45:         if (File::extension($view) === $this->extension) {",
          "46:             $view = substr($view, 0, -strlen($this->extension));",
          "47:         }",
          "49:         $path = $finder->find($view);",
          "55:         return new TwigSource(File::get($this->findTemplate($name)), $name);",
          "",
          "[Added Lines]",
          "36:         $path = $finder->find($name);",
          "42:         return new TwigSource((string) View::make($name), $name);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9dca130faee47d598cc6f4e6febe337a652e1f4d",
      "candidate_info": {
        "commit_hash": "9dca130faee47d598cc6f4e6febe337a652e1f4d",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/9dca130faee47d598cc6f4e6febe337a652e1f4d",
        "files": [
          "tests/unit/backend/widgets/FormTest.php"
        ],
        "message": "Add unit tests for the different ways of providing field options",
        "before_after_code_files": [
          "tests/unit/backend/widgets/FormTest.php||tests/unit/backend/widgets/FormTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/unit/backend/widgets/FormTest.php||tests/unit/backend/widgets/FormTest.php": [
          "File: tests/unit/backend/widgets/FormTest.php -> tests/unit/backend/widgets/FormTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: class FormTestModel extends Model",
          "8: {",
          "10: }",
          "12: class FormTest extends PluginTestCase",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9:     public function modelCustomOptionsMethod()",
          "10:     {",
          "11:         return ['model', 'custom', 'options'];",
          "12:     }",
          "14:     public function getFieldNameOnModelOptionsMethodOptions()",
          "15:     {",
          "16:         return ['model', 'field name', 'options method'];",
          "17:     }",
          "19:     public function getDropdownOptions()",
          "20:     {",
          "21:         return ['dropdown', 'options'];",
          "22:     }",
          "23: }",
          "25: class FormHelper",
          "26: {",
          "27:     public static function staticMethodOptions()",
          "28:     {",
          "29:         return ['static', 'method'];",
          "30:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131:         $this->assertEquals('[name=\"array[trigger][]\"]', array_get($attributes, 'data-trigger'));",
          "132:     }",
          "134:     protected function restrictedFormFixture(bool $singlePermission = false)",
          "135:     {",
          "136:         return new Form(null, [",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "155:     public function testOptionsGeneration()",
          "156:     {",
          "157:         $form = new Form(null, [",
          "158:             'model' => new FormTestModel,",
          "159:             'arrayName' => 'array',",
          "160:             'fields' => [",
          "161:                 'static_method_options' => [",
          "162:                     'type' => 'dropdown',",
          "163:                     'options' => '\\FormHelper::staticMethodOptions',",
          "164:                     'expect' => ['static', 'method'],",
          "165:                 ],",
          "166:                 'callable_options' => [",
          "167:                     'type' => 'dropdown',",
          "168:                     'options' => [\\FormHelper::class, 'staticMethodOptions'],",
          "169:                     'expect' => ['static', 'method'],",
          "170:                 ],",
          "171:                 'model_method_options' => [",
          "172:                     'type' => 'dropdown',",
          "173:                     'options' => 'modelCustomOptionsMethod',",
          "174:                     'expect' => ['model', 'custom', 'options'],",
          "175:                 ],",
          "176:                 'defined_options' => [",
          "177:                     'type' => 'dropdown',",
          "178:                     'options' => ['value1', 'value2'],",
          "179:                     'expect' => ['value1', 'value2'],",
          "180:                 ],",
          "181:                 'defined_options_key_value' => [",
          "182:                     'type' => 'dropdown',",
          "183:                     'options' => [",
          "184:                         'key1' => 'value1',",
          "185:                         'key2' => 'value2',",
          "186:                     ],",
          "187:                     'expect' => [",
          "188:                         'key1' => 'value1',",
          "189:                         'key2' => 'value2',",
          "190:                     ],",
          "191:                 ],",
          "192:                 'field_name_on_model_options_method' => [",
          "193:                     'type' => 'dropdown',",
          "194:                     'expect' => ['model', 'field name', 'options method'],",
          "195:                 ],",
          "196:                 'get_dropdown_options_method' => [",
          "197:                     'type' => 'dropdown',",
          "198:                     'expect' => ['dropdown', 'options'],",
          "199:                 ],",
          "200:             ]",
          "201:         ]);",
          "203:         $form->render();",
          "205:         foreach ($form->getFields() as $name => $field) {",
          "206:             $this->assertEquals($field->options(), $field->config['expect']);",
          "207:         }",
          "208:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ed06a6f1ac94c219e37a16e74325cf0a89bbe73e",
      "candidate_info": {
        "commit_hash": "ed06a6f1ac94c219e37a16e74325cf0a89bbe73e",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/ed06a6f1ac94c219e37a16e74325cf0a89bbe73e",
        "files": [
          "modules/backend/formwidgets/Repeater.php"
        ],
        "message": "Do minItem initialization before checking current value in repeater prep\n\nFixes https://github.com/octobercms/october/issues/5274",
        "before_after_code_files": [
          "modules/backend/formwidgets/Repeater.php||modules/backend/formwidgets/Repeater.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/backend/formwidgets/Repeater.php||modules/backend/formwidgets/Repeater.php": [
          "File: modules/backend/formwidgets/Repeater.php -> modules/backend/formwidgets/Repeater.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "248:             }",
          "249:         }",
          "263:         if (!$this->useGroups && $this->minItems > 0) {",
          "",
          "[Removed Lines]",
          "251:         if (!$this->childAddItemCalled && $currentValue === null) {",
          "252:             $this->formWidgets = [];",
          "253:             return;",
          "254:         }",
          "256:         if ($this->childAddItemCalled && !isset($currentValue[$this->childIndexCalled])) {",
          "258:             $this->makeItemFormWidget($this->childIndexCalled);",
          "259:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "273:             }",
          "274:         }",
          "276:         if (!is_array($currentValue)) {",
          "277:             return;",
          "278:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "266:         if (!$this->childAddItemCalled && $currentValue === null) {",
          "267:             $this->formWidgets = [];",
          "268:             return;",
          "269:         }",
          "271:         if ($this->childAddItemCalled && !isset($currentValue[$this->childIndexCalled])) {",
          "273:             $this->makeItemFormWidget($this->childIndexCalled);",
          "274:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "51d1c163693d3db3cab38f640de0b4585e811fd2",
      "candidate_info": {
        "commit_hash": "51d1c163693d3db3cab38f640de0b4585e811fd2",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/51d1c163693d3db3cab38f640de0b4585e811fd2",
        "files": [
          "modules/backend/ServiceProvider.php",
          "modules/backend/controllers/Preferences.php",
          "modules/backend/lang/en/lang.php",
          "modules/backend/models/preference/fields.yaml",
          "modules/system/lang/en/lang.php"
        ],
        "message": "More tweaks to the default publisher permissions, added separate permission for users to manage their own personal editor preferences.",
        "before_after_code_files": [
          "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php",
          "modules/backend/controllers/Preferences.php||modules/backend/controllers/Preferences.php",
          "modules/backend/lang/en/lang.php||modules/backend/lang/en/lang.php",
          "modules/system/lang/en/lang.php||modules/system/lang/en/lang.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [
            "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php"
          ],
          "candidate": [
            "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php"
          ]
        }
      },
      "candidate_diff": {
        "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php": [
          "File: modules/backend/ServiceProvider.php -> modules/backend/ServiceProvider.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "165:                 'backend.manage_editor' => [",
          "166:                     'label' => 'system::lang.permissions.manage_editor',",
          "167:                     'tab'   => 'system::lang.permissions.name',",
          "168:                 ],",
          "169:                 'backend.manage_branding' => [",
          "170:                     'label' => 'system::lang.permissions.manage_branding',",
          "171:                     'tab'   => 'system::lang.permissions.name',",
          "172:                 ],",
          "173:                 'media.manage_media' => [",
          "174:                     'label' => 'backend::lang.permissions.manage_media',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "168:                     'roles' => UserRole::CODE_DEVELOPER,",
          "169:                 ],",
          "170:                 'backend.manage_own_editor' => [",
          "171:                     'label' => 'system::lang.permissions.manage_own_editor',",
          "172:                     'tab'   => 'system::lang.permissions.name',",
          "177:                     'roles' => UserRole::CODE_DEVELOPER,",
          "",
          "---------------"
        ],
        "modules/backend/controllers/Preferences.php||modules/backend/controllers/Preferences.php": [
          "File: modules/backend/controllers/Preferences.php -> modules/backend/controllers/Preferences.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     public function formExtendFields($form)",
          "59:     {",
          "61:             $form->removeTab('backend::lang.backend_preferences.code_editor');",
          "62:         }",
          "63:     }",
          "",
          "[Removed Lines]",
          "60:         if (!$this->user->hasAccess('backend.manage_editor')) {",
          "",
          "[Added Lines]",
          "60:         if (!$this->user->hasAccess('backend.manage_own_editor')) {",
          "",
          "---------------"
        ],
        "modules/backend/lang/en/lang.php||modules/backend/lang/en/lang.php": [
          "File: modules/backend/lang/en/lang.php -> modules/backend/lang/en/lang.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "373:     'editor' => [",
          "374:         'menu_label' => 'Editor settings',",
          "375:         'menu_description' => 'Customize the global editor preferences, such as font size and color scheme.',",
          "376:         'font_size' => 'Font size',",
          "377:         'tab_size' => 'Tab size',",
          "378:         'use_hard_tabs' => 'Indent using tabs',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "376:         'preview' => 'Preview',",
          "",
          "---------------"
        ],
        "modules/system/lang/en/lang.php||modules/system/lang/en/lang.php": [
          "File: modules/system/lang/en/lang.php -> modules/system/lang/en/lang.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "441:         'manage_other_administrators' => 'Manage other administrators',",
          "442:         'impersonate_users' => 'Impersonate users',",
          "443:         'manage_preferences' => 'Manage backend preferences',",
          "445:         'view_the_dashboard' => 'View the dashboard',",
          "446:         'manage_default_dashboard' => 'Manage the default dashboard',",
          "447:         'manage_branding' => 'Customize the back-end',",
          "",
          "[Removed Lines]",
          "444:         'manage_editor' => 'Manage code editor preferences',",
          "",
          "[Added Lines]",
          "444:         'manage_editor' => 'Manage global code editor preferences',",
          "445:         'manage_own_editor' => 'Manage personal code editor preferences',",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dca6128501890473043cbe2bfd3016b4f48d39d6",
      "candidate_info": {
        "commit_hash": "dca6128501890473043cbe2bfd3016b4f48d39d6",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/dca6128501890473043cbe2bfd3016b4f48d39d6",
        "files": [
          "modules/cms/twig/Loader.php"
        ],
        "message": "Change Twig template loading fallbacks\n\nPreviously:\n- registered Laravel view file\n- attempt to load file as a CMS partial\n\nNow:\n- registered Laravel view file\n- valid CMS partials\n- any file that Twig can access (from the project root) rendered as a plain twig template (but with support for the CMS twig environment)\n\nFixes https://github.com/octobercms/library/commit/80aab47f044a2660aa352450f55137598f362aa4#commitcomment-42223643, https://github.com/octobercms/october/issues/5261#issuecomment-691235167",
        "before_after_code_files": [
          "modules/cms/twig/Loader.php||modules/cms/twig/Loader.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/cms/twig/Loader.php||modules/cms/twig/Loader.php": [
          "File: modules/cms/twig/Loader.php -> modules/cms/twig/Loader.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "120:     protected function validateCmsObject($name)",
          "121:     {",
          "123:             return true;",
          "124:         }",
          "",
          "[Removed Lines]",
          "122:         if ($name === $this->obj->getFilePath()) {",
          "",
          "[Added Lines]",
          "141:         if ($this->obj && $name === $this->obj->getFilePath()) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "138:     protected function findFallbackObject($name)",
          "139:     {",
          "140:         if (strpos($name, '::') !== false) {",
          "141:             return false;",
          "142:         }",
          "144:         if (array_key_exists($name, $this->fallbackCache)) {",
          "145:             return $this->fallbackCache[$name];",
          "146:         }",
          "149:     }",
          "150: }",
          "",
          "[Removed Lines]",
          "148:         return $this->fallbackCache[$name] = CmsPartial::find($name);",
          "",
          "[Added Lines]",
          "172:         try {",
          "173:             $partial = CmsPartial::find($name);",
          "174:         } catch (\\Exception $e) {",
          "175:             return false;",
          "176:         }",
          "178:         return $this->fallbackCache[$name] = $partial;",
          "",
          "---------------"
        ]
      }
    }
  ]
}