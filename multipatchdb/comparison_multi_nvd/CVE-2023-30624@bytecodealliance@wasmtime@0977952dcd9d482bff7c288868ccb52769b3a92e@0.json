{
  "cve_id": "CVE-2023-30624",
  "cve_desc": "Wasmtime is a standalone runtime for WebAssembly. Prior to versions 6.0.2, 7.0.1, and 8.0.1, Wasmtime's implementation of managing per-instance state, such as tables and memories, contains LLVM-level undefined behavior. This undefined behavior was found to cause runtime-level issues when compiled with LLVM 16 which causes some writes, which are critical for correctness, to be optimized away. Vulnerable versions of Wasmtime compiled with Rust 1.70, which is currently in beta, or later are known to have incorrectly compiled functions. Versions of Wasmtime compiled with the current Rust stable release, 1.69, and prior are not known at this time to have any issues, but can theoretically exhibit potential issues.\n\nThe underlying problem is that Wasmtime's runtime state for an instance involves a Rust-defined structure called `Instance` which has a trailing `VMContext` structure after it. This `VMContext` structure has a runtime-defined layout that is unique per-module. This representation cannot be expressed with safe code in Rust so `unsafe` code is required to maintain this state. The code doing this, however, has methods which take `&self` as an argument but modify data in the `VMContext` part of the allocation. This means that pointers derived from `&self` are mutated. This is typically not allowed, except in the presence of `UnsafeCell`, in Rust. When compiled to LLVM these functions have `noalias readonly` parameters which means it's UB to write through the pointers.\n\nWasmtime's internal representation and management of `VMContext` has been updated to use `&mut self` methods where appropriate. Additionally verification tools for `unsafe` code in Rust, such as `cargo miri`, are planned to be executed on the `main` branch soon to fix any Rust-level issues that may be exploited in future compiler versions.\n\nPrecomplied binaries available for Wasmtime from GitHub releases have been compiled with at most LLVM 15 so are not known to be vulnerable. As mentioned above, however, it's still recommended to update.\n\nWasmtime version 6.0.2, 7.0.1, and 8.0.1 have been issued which contain the patch necessary to work correctly on LLVM 16 and have no known UB on LLVM 15 and earlier. If Wasmtime is compiled with Rust 1.69 and prior, which use LLVM 15, then there are no known issues. There is a theoretical possibility for undefined behavior to exploited, however, so it's recommended that users upgrade to a patched version of Wasmtime. Users using beta Rust (1.70 at this time) or nightly Rust (1.71 at this time) must update to a patched version to work correctly.",
  "repo": "bytecodealliance/wasmtime",
  "patch_hash": "0977952dcd9d482bff7c288868ccb52769b3a92e",
  "patch_info": {
    "commit_hash": "0977952dcd9d482bff7c288868ccb52769b3a92e",
    "repo": "bytecodealliance/wasmtime",
    "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/0977952dcd9d482bff7c288868ccb52769b3a92e",
    "files": [
      "RELEASES.md",
      "crates/environ/src/module.rs",
      "crates/runtime/src/instance.rs",
      "crates/runtime/src/instance/allocator.rs",
      "crates/runtime/src/libcalls.rs",
      "crates/runtime/src/traphandlers.rs"
    ],
    "message": "Merge pull request from GHSA-ch89-5g45-qwc7\n\n* Fix miscompile from functions mutating `VMContext`\n\nThis commit fixes a miscompilation in Wasmtime on LLVM 16 where methods\non `Instance` which mutated the state of the internal `VMContext` were\noptimized to not actually mutate the state. The root cause of this issue\nis a change in LLVM which takes advantage of `noalias readonly` pointers\nwhich is how `&self` methods are translated. This means that `Instance`\nmethods which take `&self` but actually mutate the `VMContext` end up\nbeing undefined behavior from LLVM's point of view, meaning that the\nwrites are candidate for removal.\n\nThe fix applied here is intended to be a temporary one while a more\nformal fix, ideally backed by `cargo miri` verification, is implemented\non `main`. The fix here is to change the return value of\n`vmctx_plus_offset` to return `*const T` instead of `*mut T`. This\ncaused lots of portions of the runtime code to stop compiling because\nmutations were indeed happening. To cover these a new\n`vmctx_plus_offset_mut` method was added which notably takes `&mut self`\ninstead of `&self`. This forced all callers which may mutate to reflect\nthe `&mut self` requirement, propagating that outwards.\n\nThis fixes the miscompilation with LLVM 16 in the immediate future and\nshould be at least a meager line of defense against issues like this in\nthe future. This is not a long-term fix, though, since `cargo miri`\nstill does not like what's being done in `Instance` and with\n`VMContext`. That fix is likely to be more invasive, though, so it's\nbeing deferred to later.\n\n* Update release notes\n\n* Fix dates and fill out more notes",
    "before_after_code_files": [
      "crates/environ/src/module.rs||crates/environ/src/module.rs",
      "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
      "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs",
      "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs",
      "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs"
    ]
  },
  "patch_diff": {
    "crates/environ/src/module.rs||crates/environ/src/module.rs": [
      "File: crates/environ/src/module.rs -> crates/environ/src/module.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "241:         }",
      "242:         let mut idx = 0;",
      "243:         let ok = self.module.memory_initialization.init_memory(",
      "244:             InitMemory::CompileTime(&self.module),",
      "",
      "[Removed Lines]",
      "245:             &mut |memory, init| {",
      "",
      "[Added Lines]",
      "244:             &mut (),",
      "246:             |(), memory, init| {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "529:         &self,",
      "532:     ) -> bool {",
      "533:         let initializers = match self {",
      "",
      "[Removed Lines]",
      "528:     pub fn init_memory(",
      "530:         state: InitMemory<'_>,",
      "531:         write: &mut dyn FnMut(MemoryIndex, &StaticMemoryInitializer) -> bool,",
      "",
      "[Added Lines]",
      "529:     pub fn init_memory<T>(",
      "531:         state: &mut T,",
      "532:         init: InitMemory<'_, T>,",
      "533:         mut write: impl FnMut(&mut T, MemoryIndex, &StaticMemoryInitializer) -> bool,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "543:             MemoryInitialization::Static { map } => {",
      "544:                 for (index, init) in map {",
      "545:                     if let Some(init) = init {",
      "547:                         if !result {",
      "548:                             return result;",
      "549:                         }",
      "",
      "[Removed Lines]",
      "546:                         let result = write(index, init);",
      "",
      "[Added Lines]",
      "548:                         let result = write(state, index, init);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "569:             let base = match base {",
      "571:                     InitMemory::Runtime {",
      "572:                         get_global_as_u64, ..",
      "574:                     InitMemory::CompileTime(_) => return false,",
      "575:                 },",
      "576:                 None => 0,",
      "",
      "[Removed Lines]",
      "570:                 Some(index) => match &state {",
      "573:                     } => get_global_as_u64(index),",
      "",
      "[Added Lines]",
      "572:                 Some(index) => match &init {",
      "575:                     } => get_global_as_u64(state, index),",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "585:                 None => return false,",
      "586:             };",
      "589:                 InitMemory::CompileTime(module) => module.memory_plans[memory_index].memory.minimum,",
      "590:                 InitMemory::Runtime {",
      "591:                     memory_size_in_pages,",
      "592:                     ..",
      "594:             };",
      "",
      "[Removed Lines]",
      "588:             let cur_size_in_pages = match &state {",
      "593:                 } => memory_size_in_pages(memory_index),",
      "",
      "[Added Lines]",
      "590:             let cur_size_in_pages = match &init {",
      "595:                 } => memory_size_in_pages(state, memory_index),",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "616:                 offset: start,",
      "617:                 data: data.clone(),",
      "618:             };",
      "620:             if !result {",
      "621:                 return result;",
      "622:             }",
      "",
      "[Removed Lines]",
      "619:             let result = write(memory_index, &init);",
      "",
      "[Added Lines]",
      "621:             let result = write(state, memory_index, &init);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "631: pub enum InitMemory<'a> {",
      "",
      "[Added Lines]",
      "633: pub enum InitMemory<'a, T> {",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "641:     Runtime {",
      "647:     },",
      "648: }",
      "",
      "[Removed Lines]",
      "643:         memory_size_in_pages: &'a dyn Fn(MemoryIndex) -> u64,",
      "646:         get_global_as_u64: &'a dyn Fn(GlobalIndex) -> u64,",
      "",
      "[Added Lines]",
      "645:         memory_size_in_pages: &'a dyn Fn(&mut T, MemoryIndex) -> u64,",
      "648:         get_global_as_u64: &'a dyn Fn(&mut T, GlobalIndex) -> u64,",
      "",
      "---------------"
    ],
    "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
      "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "152:             .add(usize::try_from(offset).unwrap())",
      "153:             .cast()",
      "154:     }",
      "",
      "[Removed Lines]",
      "150:     unsafe fn vmctx_plus_offset<T>(&self, offset: u32) -> *mut T {",
      "151:         (self.vmctx_ptr().cast::<u8>())",
      "",
      "[Added Lines]",
      "150:     unsafe fn vmctx_plus_offset<T>(&self, offset: u32) -> *const T {",
      "151:         (std::ptr::addr_of!(self.vmctx).cast::<u8>())",
      "152:             .add(usize::try_from(offset).unwrap())",
      "153:             .cast()",
      "154:     }",
      "156:     unsafe fn vmctx_plus_offset_mut<T>(&mut self, offset: u32) -> *mut T {",
      "157:         (std::ptr::addr_of_mut!(self.vmctx).cast::<u8>())",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "185:     #[allow(dead_code)]",
      "187:         unsafe { *self.table_ptr(index) }",
      "188:     }",
      "192:         unsafe {",
      "194:         }",
      "195:     }",
      "200:     }",
      "",
      "[Removed Lines]",
      "186:     fn table(&self, index: DefinedTableIndex) -> VMTableDefinition {",
      "191:     fn set_table(&self, index: DefinedTableIndex, table: VMTableDefinition) {",
      "198:     fn table_ptr(&self, index: DefinedTableIndex) -> *mut VMTableDefinition {",
      "199:         unsafe { self.vmctx_plus_offset(self.offsets().vmctx_vmtable_definition(index)) }",
      "",
      "[Added Lines]",
      "192:     fn table(&mut self, index: DefinedTableIndex) -> VMTableDefinition {",
      "197:     fn set_table(&mut self, index: DefinedTableIndex, table: VMTableDefinition) {",
      "204:     fn table_ptr(&mut self, index: DefinedTableIndex) -> *mut VMTableDefinition {",
      "205:         unsafe { self.vmctx_plus_offset_mut(self.offsets().vmctx_vmtable_definition(index)) }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "238:     }",
      "242:         unsafe { &*self.global_ptr(index) }",
      "243:     }",
      "248:     }",
      "",
      "[Removed Lines]",
      "241:     fn global(&self, index: DefinedGlobalIndex) -> &VMGlobalDefinition {",
      "246:     fn global_ptr(&self, index: DefinedGlobalIndex) -> *mut VMGlobalDefinition {",
      "247:         unsafe { self.vmctx_plus_offset(self.offsets().vmctx_vmglobal_definition(index)) }",
      "",
      "[Added Lines]",
      "247:     fn global(&mut self, index: DefinedGlobalIndex) -> &VMGlobalDefinition {",
      "252:     fn global_ptr(&mut self, index: DefinedGlobalIndex) -> *mut VMGlobalDefinition {",
      "253:         unsafe { self.vmctx_plus_offset_mut(self.offsets().vmctx_vmglobal_definition(index)) }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "254:     pub(crate) fn defined_or_imported_global_ptr(",
      "256:         index: GlobalIndex,",
      "257:     ) -> *mut VMGlobalDefinition {",
      "258:         if let Some(index) = self.module().defined_global_index(index) {",
      "",
      "[Removed Lines]",
      "255:         &self,",
      "",
      "[Added Lines]",
      "261:         &mut self,",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "263:     }",
      "268:     }",
      "273:     }",
      "278:     }",
      "",
      "[Removed Lines]",
      "266:     pub fn runtime_limits(&self) -> *mut *const VMRuntimeLimits {",
      "267:         unsafe { self.vmctx_plus_offset(self.offsets().vmctx_runtime_limits()) }",
      "271:     pub fn epoch_ptr(&self) -> *mut *const AtomicU64 {",
      "272:         unsafe { self.vmctx_plus_offset(self.offsets().vmctx_epoch_ptr()) }",
      "276:     pub fn externref_activations_table(&self) -> *mut *mut VMExternRefActivationsTable {",
      "277:         unsafe { self.vmctx_plus_offset(self.offsets().vmctx_externref_activations_table()) }",
      "",
      "[Added Lines]",
      "272:     pub fn runtime_limits(&mut self) -> *mut *const VMRuntimeLimits {",
      "273:         unsafe { self.vmctx_plus_offset_mut(self.offsets().vmctx_runtime_limits()) }",
      "277:     pub fn epoch_ptr(&mut self) -> *mut *const AtomicU64 {",
      "278:         unsafe { self.vmctx_plus_offset_mut(self.offsets().vmctx_epoch_ptr()) }",
      "282:     pub fn externref_activations_table(&mut self) -> *mut *mut VMExternRefActivationsTable {",
      "283:         unsafe { self.vmctx_plus_offset_mut(self.offsets().vmctx_externref_activations_table()) }",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "402:     }",
      "406:         let index = DefinedTableIndex::new(",
      "407:             usize::try_from(",
      "408:                 (table as *const VMTableDefinition)",
      "",
      "[Removed Lines]",
      "405:     unsafe fn table_index(&self, table: &VMTableDefinition) -> DefinedTableIndex {",
      "",
      "[Added Lines]",
      "411:     unsafe fn table_index(&mut self, table: &VMTableDefinition) -> DefinedTableIndex {",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "584:             let func = &self.module().functions[index];",
      "585:             let sig = func.signature;",
      "586:             let anyfunc: *mut VMCallerCheckedFuncRef = self",
      "588:                     self.offsets().vmctx_anyfunc(func.anyfunc),",
      "589:                 );",
      "590:             self.construct_anyfunc(index, sig, anyfunc);",
      "",
      "[Removed Lines]",
      "587:                 .vmctx_plus_offset::<VMCallerCheckedFuncRef>(",
      "",
      "[Added Lines]",
      "593:                 .vmctx_plus_offset_mut::<VMCallerCheckedFuncRef>(",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "923:     ) {",
      "924:         assert!(std::ptr::eq(module, self.module().as_ref()));",
      "927:         self.set_callee(None);",
      "928:         self.set_store(store.as_raw());",
      "931:         let signatures = self.runtime_info.signature_ids();",
      "938:         debug_assert_eq!(imports.functions.len(), module.num_imported_funcs);",
      "939:         ptr::copy_nonoverlapping(",
      "940:             imports.functions.as_ptr(),",
      "942:             imports.functions.len(),",
      "943:         );",
      "944:         debug_assert_eq!(imports.tables.len(), module.num_imported_tables);",
      "945:         ptr::copy_nonoverlapping(",
      "946:             imports.tables.as_ptr(),",
      "948:             imports.tables.len(),",
      "949:         );",
      "950:         debug_assert_eq!(imports.memories.len(), module.num_imported_memories);",
      "951:         ptr::copy_nonoverlapping(",
      "952:             imports.memories.as_ptr(),",
      "954:             imports.memories.len(),",
      "955:         );",
      "956:         debug_assert_eq!(imports.globals.len(), module.num_imported_globals);",
      "957:         ptr::copy_nonoverlapping(",
      "958:             imports.globals.as_ptr(),",
      "960:             imports.globals.len(),",
      "961:         );",
      "",
      "[Removed Lines]",
      "941:             self.vmctx_plus_offset(offsets.vmctx_imported_functions_begin()),",
      "947:             self.vmctx_plus_offset(offsets.vmctx_imported_tables_begin()),",
      "953:             self.vmctx_plus_offset(offsets.vmctx_imported_memories_begin()),",
      "959:             self.vmctx_plus_offset(offsets.vmctx_imported_globals_begin()),",
      "",
      "[Added Lines]",
      "942:             &VMBuiltinFunctionsArray::INIT;",
      "948:             self.vmctx_plus_offset_mut(offsets.vmctx_imported_functions_begin()),",
      "954:             self.vmctx_plus_offset_mut(offsets.vmctx_imported_tables_begin()),",
      "960:             self.vmctx_plus_offset_mut(offsets.vmctx_imported_memories_begin()),",
      "966:             self.vmctx_plus_offset_mut(offsets.vmctx_imported_globals_begin()),",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "971:         for i in 0..module.table_plans.len() - module.num_imported_tables {",
      "972:             ptr::write(ptr, self.tables[DefinedTableIndex::new(i)].vmtable());",
      "973:             ptr = ptr.add(1);",
      "",
      "[Removed Lines]",
      "970:         let mut ptr = self.vmctx_plus_offset(offsets.vmctx_tables_begin());",
      "",
      "[Added Lines]",
      "977:         let mut ptr = self.vmctx_plus_offset_mut(offsets.vmctx_tables_begin());",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "983:         for i in 0..module.memory_plans.len() - module.num_imported_memories {",
      "984:             let defined_memory_index = DefinedMemoryIndex::new(i);",
      "985:             let memory_index = module.memory_index(defined_memory_index);",
      "",
      "[Removed Lines]",
      "981:         let mut ptr = self.vmctx_plus_offset(offsets.vmctx_memories_begin());",
      "982:         let mut owned_ptr = self.vmctx_plus_offset(offsets.vmctx_owned_memories_begin());",
      "",
      "[Added Lines]",
      "988:         let mut ptr = self.vmctx_plus_offset_mut(offsets.vmctx_memories_begin());",
      "989:         let mut owned_ptr = self.vmctx_plus_offset_mut(offsets.vmctx_owned_memories_begin());",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1068: impl Drop for Instance {",
      "1069:     fn drop(&mut self) {",
      "1073:                 Some(idx) => idx,",
      "1074:                 None => continue,",
      "1075:             };",
      "",
      "[Removed Lines]",
      "1071:         for (idx, global) in self.module().globals.iter() {",
      "1072:             let idx = match self.module().defined_global_index(idx) {",
      "",
      "[Added Lines]",
      "1078:         let module = self.module().clone();",
      "1079:         for (idx, global) in module.globals.iter() {",
      "1080:             let idx = match module.defined_global_index(idx) {",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1182:     }",
      "1187:     }",
      "",
      "[Removed Lines]",
      "1185:     pub unsafe fn table_index(&self, table: &VMTableDefinition) -> DefinedTableIndex {",
      "1186:         self.instance().table_index(table)",
      "",
      "[Added Lines]",
      "1193:     pub unsafe fn table_index(&mut self, table: &VMTableDefinition) -> DefinedTableIndex {",
      "1194:         self.instance_mut().table_index(table)",
      "",
      "---------------"
    ],
    "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs": [
      "File: crates/runtime/src/instance/allocator.rs -> crates/runtime/src/instance/allocator.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "200:     fn purge_module(&self, module: CompiledModuleId);",
      "201: }",
      "204:     match init.base {",
      "205:         Some(base) => {",
      "214:             init.offset",
      "215:                 .checked_add(val)",
      "",
      "[Removed Lines]",
      "203: fn get_table_init_start(init: &TableInitializer, instance: &Instance) -> Result<u32> {",
      "206:             let val = unsafe {",
      "207:                 if let Some(def_index) = instance.module().defined_global_index(base) {",
      "209:                 } else {",
      "211:                 }",
      "212:             };",
      "",
      "[Added Lines]",
      "203: fn get_table_init_start(init: &TableInitializer, instance: &mut Instance) -> Result<u32> {",
      "206:             let val = unsafe { *(*instance.defined_or_imported_global_ptr(base)).as_u32() };",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "256:         TableInitialization::FuncTable { segments, .. }",
      "257:         | TableInitialization::Segments { segments } => {",
      "258:             for segment in segments {",
      "259:                 instance.table_init_segment(",
      "260:                     segment.table_index,",
      "261:                     &segment.elements,",
      "263:                     0,",
      "264:                     segment.elements.len() as u32,",
      "265:                 )?;",
      "",
      "[Removed Lines]",
      "262:                     get_table_init_start(segment, instance)?,",
      "",
      "[Added Lines]",
      "253:                 let start = get_table_init_start(segment, instance)?;",
      "257:                     start,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "270:     Ok(())",
      "271: }",
      "274:     match init.base {",
      "275:         Some(base) => {",
      "276:             let mem64 = instance.module().memory_plans[init.memory_index]",
      "277:                 .memory",
      "278:                 .memory64;",
      "279:             let val = unsafe {",
      "285:                 if mem64 {",
      "287:                 } else {",
      "289:                 }",
      "290:             };",
      "",
      "[Removed Lines]",
      "273: fn get_memory_init_start(init: &MemoryInitializer, instance: &Instance) -> Result<u64> {",
      "280:                 let global = if let Some(def_index) = instance.module().defined_global_index(base) {",
      "281:                     instance.global(def_index)",
      "282:                 } else {",
      "283:                     &*instance.imported_global(base).from",
      "284:                 };",
      "288:                     u64::from(*global.as_u32())",
      "",
      "[Added Lines]",
      "268: fn get_memory_init_start(init: &MemoryInitializer, instance: &mut Instance) -> Result<u64> {",
      "275:                 let global = instance.defined_or_imported_global_ptr(base);",
      "279:                     u64::from(*(*global).as_u32())",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "297:     }",
      "298: }",
      "301:     for init in initializers {",
      "302:         let memory = instance.get_memory(init.memory_index);",
      "303:         let start = get_memory_init_start(init, instance)?;",
      "",
      "[Removed Lines]",
      "300: fn check_memory_init_bounds(instance: &Instance, initializers: &[MemoryInitializer]) -> Result<()> {",
      "",
      "[Added Lines]",
      "291: fn check_memory_init_bounds(",
      "292:     instance: &mut Instance,",
      "293:     initializers: &[MemoryInitializer],",
      "294: ) -> Result<()> {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "319: }",
      "321: fn initialize_memories(instance: &mut Instance, module: &Module) -> Result<()> {",
      "333:         if module.globals[global].wasm_ty == WasmType::I64 {",
      "335:         } else {",
      "337:         }",
      "338:     };",
      "",
      "[Removed Lines]",
      "322:     let memory_size_in_pages =",
      "323:         &|memory| (instance.get_memory(memory).current_length() as u64) / u64::from(WASM_PAGE_SIZE);",
      "327:     let get_global_as_u64 = &|global| unsafe {",
      "328:         let def = if let Some(def_index) = instance.module().defined_global_index(global) {",
      "329:             instance.global(def_index)",
      "330:         } else {",
      "331:             &*instance.imported_global(global).from",
      "332:         };",
      "336:             u64::from(*def.as_u32())",
      "",
      "[Added Lines]",
      "316:     let memory_size_in_pages = &|instance: &mut Instance, memory| {",
      "317:         (instance.get_memory(memory).current_length() as u64) / u64::from(WASM_PAGE_SIZE)",
      "318:     };",
      "322:     let get_global_as_u64 = &mut |instance: &mut Instance, global| unsafe {",
      "323:         let def = instance.defined_or_imported_global_ptr(global);",
      "327:             u64::from(*(*def).as_u32())",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "348:     let ok = module.memory_initialization.init_memory(",
      "349:         InitMemory::Runtime {",
      "350:             memory_size_in_pages,",
      "351:             get_global_as_u64,",
      "352:         },",
      "",
      "[Removed Lines]",
      "353:         &mut |memory_index, init| {",
      "",
      "[Added Lines]",
      "340:         instance,",
      "345:         |instance, memory_index, init| {",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "383: fn check_init_bounds(instance: &mut Instance, module: &Module) -> Result<()> {",
      "384:     check_table_init_bounds(instance, module)?;",
      "387:         MemoryInitialization::Segmented(initializers) => {",
      "388:             check_memory_init_bounds(instance, initializers)?;",
      "389:         }",
      "",
      "[Removed Lines]",
      "386:     match &instance.module().memory_initialization {",
      "",
      "[Added Lines]",
      "378:     match &module.memory_initialization {",
      "",
      "---------------"
    ],
    "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs": [
      "File: crates/runtime/src/libcalls.rs -> crates/runtime/src/libcalls.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "413: unsafe fn externref_global_get(vmctx: *mut VMContext, index: u32) -> *mut u8 {",
      "414:     let index = GlobalIndex::from_u32(index);",
      "416:     let global = instance.defined_or_imported_global_ptr(index);",
      "417:     match (*global).as_externref().clone() {",
      "418:         None => ptr::null_mut(),",
      "",
      "[Removed Lines]",
      "415:     let instance = (*vmctx).instance();",
      "",
      "[Added Lines]",
      "415:     let instance = (*vmctx).instance_mut();",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "435:     };",
      "437:     let index = GlobalIndex::from_u32(index);",
      "439:     let global = instance.defined_or_imported_global_ptr(index);",
      "",
      "[Removed Lines]",
      "438:     let instance = (*vmctx).instance();",
      "",
      "[Added Lines]",
      "438:     let instance = (*vmctx).instance_mut();",
      "",
      "---------------"
    ],
    "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs": [
      "File: crates/runtime/src/traphandlers.rs -> crates/runtime/src/traphandlers.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "219: where",
      "220:     F: FnMut(*mut VMContext),",
      "221: {",
      "224:     let result = CallThreadState::new(signal_handler, capture_backtrace, *limits).with(|cx| {",
      "225:         wasmtime_setjmp(",
      "",
      "[Removed Lines]",
      "222:     let limits = (*caller).instance().runtime_limits();",
      "",
      "[Added Lines]",
      "222:     let limits = (*caller).instance_mut().runtime_limits();",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "36fb62ca3bea7dd1456f12ead03084e2ceb48cda",
      "candidate_info": {
        "commit_hash": "36fb62ca3bea7dd1456f12ead03084e2ceb48cda",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/36fb62ca3bea7dd1456f12ead03084e2ceb48cda",
        "files": [
          "crates/environ/src/module.rs",
          "crates/environ/src/module_environ.rs",
          "crates/runtime/src/instance.rs",
          "crates/runtime/src/instance/allocator.rs",
          "crates/runtime/src/table.rs",
          "crates/wast/src/spectest.rs",
          "tests/all/wast.rs",
          "tests/spec_testsuite"
        ],
        "message": "Support `global.get` in more constant expressions (#7996)\n\nThis commit updates Wasmtime to support `global.get` in constant\nexpressions when located in table initializers and element segments.\nPre-reference-types this never came up because there was no valid\n`global.get` that would typecheck. After the reference-types proposal\nlanded however this became possible but Wasmtime did not support it.\nThis was surfaced in #6705 when the spec test suite was updated and has\na new test that exercises this functionality.\n\nThis commit both updates the spec test suite and additionally adds\nsupport for this new form of element segment and table initialization\nexpression.\n\nThe fact that Wasmtime hasn't supported this until now also means that\nwe have a gap in our fuzz-testing infrastructure. The `wasm-smith`\ngenerator is being updated in bytecodealliance/wasm-tools#1426 to\ngenerate modules with this particular feature and I've tested that with\nthat PR fuzzing here eventually generates an error before this PR.\n\nCloses #6705",
        "before_after_code_files": [
          "crates/environ/src/module.rs||crates/environ/src/module.rs",
          "crates/environ/src/module_environ.rs||crates/environ/src/module_environ.rs",
          "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
          "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs",
          "crates/runtime/src/table.rs||crates/runtime/src/table.rs",
          "crates/wast/src/spectest.rs||crates/wast/src/spectest.rs",
          "tests/all/wast.rs||tests/all/wast.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "crates/environ/src/module.rs||crates/environ/src/module.rs",
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs"
          ],
          "candidate": [
            "crates/environ/src/module.rs||crates/environ/src/module.rs",
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs"
          ]
        }
      },
      "candidate_diff": {
        "crates/environ/src/module.rs||crates/environ/src/module.rs": [
          "File: crates/environ/src/module.rs -> crates/environ/src/module.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "463:                 Some(top) => top,",
          "464:                 None => break,",
          "465:             };",
          "",
          "[Removed Lines]",
          "462:             let top = match segment.offset.checked_add(segment.elements.len() as u32) {",
          "",
          "[Added Lines]",
          "462:             let top = match segment.offset.checked_add(segment.elements.len()) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "482:                 WasmHeapType::Extern => break,",
          "483:             }",
          "485:             let precomputed =",
          "486:                 match &mut self.module.table_initialization.initial_values[defined_index] {",
          "487:                     TableInitialValue::Null { precomputed } => precomputed,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "487:             let function_elements = match &segment.elements {",
          "488:                 TableSegmentElements::Functions(indices) => indices,",
          "489:                 TableSegmentElements::Expressions(_) => break,",
          "490:             };",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "496:                 };",
          "",
          "[Removed Lines]",
          "495:                     TableInitialValue::FuncRef(_) => break,",
          "",
          "[Added Lines]",
          "502:                     TableInitialValue::FuncRef(_) | TableInitialValue::GlobalGet(_) => break,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "504:                 precomputed.resize(top as usize, FuncIndex::reserved_value());",
          "505:             }",
          "506:             let dst = &mut precomputed[(segment.offset as usize)..(top as usize)];",
          "510:             let _ = segments.next();",
          "",
          "[Removed Lines]",
          "507:             dst.copy_from_slice(&segment.elements[..]);",
          "",
          "[Added Lines]",
          "514:             dst.copy_from_slice(&function_elements);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "759:     FuncRef(FuncIndex),",
          "760: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "770:     GlobalGet(GlobalIndex),",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "770:     pub offset: u32,",
          "773: }",
          "",
          "[Removed Lines]",
          "772:     pub elements: Box<[FuncIndex]>,",
          "",
          "[Added Lines]",
          "783:     pub elements: TableSegmentElements,",
          "784: }",
          "788: #[derive(Clone, Debug, Serialize, Deserialize)]",
          "789: pub enum TableSegmentElements {",
          "792:     Functions(Box<[FuncIndex]>),",
          "794:     Expressions(Box<[TableElementExpression]>),",
          "795: }",
          "797: impl TableSegmentElements {",
          "799:     pub fn len(&self) -> u32 {",
          "800:         match self {",
          "801:             Self::Functions(s) => s.len() as u32,",
          "802:             Self::Expressions(s) => s.len() as u32,",
          "803:         }",
          "804:     }",
          "805: }",
          "808: #[derive(Clone, Debug, Serialize, Deserialize)]",
          "809: pub enum TableElementExpression {",
          "811:     Function(FuncIndex),",
          "813:     GlobalGet(GlobalIndex),",
          "815:     Null,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "815:     pub memory_initialization: MemoryInitialization,",
          "821:     pub passive_elements_map: BTreeMap<ElemIndex, usize>,",
          "",
          "[Removed Lines]",
          "818:     pub passive_elements: Vec<Box<[FuncIndex]>>,",
          "",
          "[Added Lines]",
          "861:     pub passive_elements: Vec<TableSegmentElements>,",
          "",
          "---------------"
        ],
        "crates/environ/src/module_environ.rs||crates/environ/src/module_environ.rs": [
          "File: crates/environ/src/module_environ.rs -> crates/environ/src/module_environ.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use crate::module::{",
          "2:     FuncRefIndex, Initializer, MemoryInitialization, MemoryInitializer, MemoryPlan, Module,",
          "4: };",
          "5: use crate::{",
          "6:     DataIndex, DefinedFuncIndex, ElemIndex, EntityIndex, EntityType, FuncIndex, GlobalIndex,",
          "",
          "[Removed Lines]",
          "3:     ModuleType, TablePlan, TableSegment,",
          "",
          "[Added Lines]",
          "3:     ModuleType, TableElementExpression, TablePlan, TableSegment, TableSegmentElements,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "8:     Tunables, TypeConvert, TypeIndex, Unsigned, WasmError, WasmHeapType, WasmResult, WasmValType,",
          "9:     WasmparserTypeConverter,",
          "10: };",
          "12: use std::borrow::Cow;",
          "13: use std::collections::HashMap;",
          "14: use std::path::PathBuf;",
          "",
          "[Removed Lines]",
          "11: use cranelift_entity::packed_option::ReservedValue;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "320:                                     self.flag_func_escaped(index);",
          "321:                                     TableInitialValue::FuncRef(index)",
          "322:                                 }",
          "323:                                 s => {",
          "324:                                     return Err(WasmError::Unsupported(format!(",
          "325:                                         \"unsupported init expr in table section: {:?}\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "322:                                 Operator::GlobalGet { global_index } => {",
          "323:                                     let index = GlobalIndex::from_u32(global_index);",
          "324:                                     TableInitialValue::GlobalGet(index)",
          "325:                                 }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "454:                         ElementItems::Functions(funcs) => {",
          "456:                             for func in funcs {",
          "457:                                 let func = FuncIndex::from_u32(func?);",
          "458:                                 self.flag_func_escaped(func);",
          "460:                             }",
          "461:                         }",
          "467:                                     Operator::RefFunc { function_index } => {",
          "468:                                         let func = FuncIndex::from_u32(function_index);",
          "469:                                         self.flag_func_escaped(func);",
          "471:                                     }",
          "472:                                     s => {",
          "473:                                         return Err(WasmError::Unsupported(format!(",
          "",
          "[Removed Lines]",
          "452:                     let mut elements = Vec::new();",
          "453:                     match items {",
          "455:                             elements.reserve(usize::try_from(funcs.count()).unwrap());",
          "459:                                 elements.push(func);",
          "462:                         ElementItems::Expressions(_ty, funcs) => {",
          "463:                             elements.reserve(usize::try_from(funcs.count()).unwrap());",
          "464:                             for func in funcs {",
          "465:                                 let func = match func?.get_binary_reader().read_operator()? {",
          "466:                                     Operator::RefNull { .. } => FuncIndex::reserved_value(),",
          "470:                                         func",
          "",
          "[Added Lines]",
          "455:                     let elements = match items {",
          "457:                             let mut elems =",
          "458:                                 Vec::with_capacity(usize::try_from(funcs.count()).unwrap());",
          "462:                                 elems.push(func);",
          "464:                             TableSegmentElements::Functions(elems.into())",
          "466:                         ElementItems::Expressions(_ty, items) => {",
          "467:                             let mut exprs =",
          "468:                                 Vec::with_capacity(usize::try_from(items.count()).unwrap());",
          "469:                             for expr in items {",
          "470:                                 let expr = match expr?.get_binary_reader().read_operator()? {",
          "471:                                     Operator::RefNull { .. } => TableElementExpression::Null,",
          "475:                                         TableElementExpression::Function(func)",
          "476:                                     }",
          "477:                                     Operator::GlobalGet { global_index } => {",
          "478:                                         let global = GlobalIndex::from_u32(global_index);",
          "479:                                         TableElementExpression::GlobalGet(global)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "476:                                         )));",
          "477:                                     }",
          "478:                                 };",
          "480:                             }",
          "481:                         }",
          "484:                     match kind {",
          "485:                         ElementKind::Active {",
          "",
          "[Removed Lines]",
          "479:                                 elements.push(func);",
          "482:                     }",
          "",
          "[Added Lines]",
          "488:                                 exprs.push(expr);",
          "490:                             TableSegmentElements::Expressions(exprs.into())",
          "492:                     };",
          "",
          "---------------"
        ],
        "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
          "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: use wasmtime_environ::{",
          "30:     packed_option::ReservedValue, DataIndex, DefinedGlobalIndex, DefinedMemoryIndex,",
          "31:     DefinedTableIndex, ElemIndex, EntityIndex, EntityRef, EntitySet, FuncIndex, GlobalIndex,",
          "34: };",
          "35: #[cfg(feature = \"wmemcheck\")]",
          "36: use wasmtime_wmemcheck::Wmemcheck;",
          "",
          "[Removed Lines]",
          "32:     GlobalInit, HostPtr, MemoryIndex, MemoryPlan, Module, PrimaryMap, TableIndex,",
          "33:     TableInitialValue, Trap, VMOffsets, WasmHeapType, WasmRefType, WasmValType, VMCONTEXT_MAGIC,",
          "",
          "[Added Lines]",
          "32:     GlobalInit, HostPtr, MemoryIndex, MemoryPlan, Module, PrimaryMap, TableElementExpression,",
          "33:     TableIndex, TableInitialValue, TableSegmentElements, Trap, VMOffsets, WasmHeapType,",
          "34:     WasmRefType, WasmValType, VMCONTEXT_MAGIC,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "805:         let module = self.module().clone();",
          "807:         let elements = match module.passive_elements_map.get(&elem_index) {",
          "808:             Some(index) if !self.dropped_elements.contains(elem_index) => {",
          "810:             }",
          "812:         };",
          "813:         self.table_init_segment(table_index, elements, dst, src, len)",
          "814:     }",
          "",
          "[Removed Lines]",
          "809:                 module.passive_elements[*index].as_ref()",
          "811:             _ => &[],",
          "",
          "[Added Lines]",
          "808:         let empty = TableSegmentElements::Functions(Box::new([]));",
          "811:                 &module.passive_elements[*index]",
          "813:             _ => &empty,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "816:     pub(crate) fn table_init_segment(",
          "817:         &mut self,",
          "818:         table_index: TableIndex,",
          "820:         dst: u32,",
          "821:         src: u32,",
          "822:         len: u32,",
          "",
          "[Removed Lines]",
          "819:         elements: &[FuncIndex],",
          "",
          "[Added Lines]",
          "821:         elements: &TableSegmentElements,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "826:         let table = unsafe { &mut *self.get_table(table_index) };",
          "839:                     dst,",
          "843:                 )?;",
          "844:             }",
          "849:             }",
          "850:         }",
          "851:         Ok(())",
          "852:     }",
          "",
          "[Removed Lines]",
          "828:         let elements = match elements",
          "829:             .get(usize::try_from(src).unwrap()..)",
          "830:             .and_then(|s| s.get(..usize::try_from(len).unwrap()))",
          "831:         {",
          "832:             Some(elements) => elements,",
          "833:             None => return Err(Trap::TableOutOfBounds),",
          "834:         };",
          "836:         match table.element_type() {",
          "837:             TableElementType::Func => {",
          "838:                 table.init_funcs(",
          "840:                     elements",
          "841:                         .iter()",
          "842:                         .map(|idx| self.get_func_ref(*idx).unwrap_or(std::ptr::null_mut())),",
          "846:             TableElementType::Extern => {",
          "847:                 debug_assert!(elements.iter().all(|e| *e == FuncIndex::reserved_value()));",
          "848:                 table.fill(dst, TableElement::ExternRef(None), len)?;",
          "",
          "[Added Lines]",
          "829:         let src = usize::try_from(src).map_err(|_| Trap::TableOutOfBounds)?;",
          "830:         let len = usize::try_from(len).map_err(|_| Trap::TableOutOfBounds)?;",
          "832:         match elements {",
          "833:             TableSegmentElements::Functions(funcs) => {",
          "834:                 let elements = funcs",
          "835:                     .get(src..)",
          "836:                     .and_then(|s| s.get(..len))",
          "837:                     .ok_or(Trap::TableOutOfBounds)?;",
          "838:                 table.init(",
          "840:                     elements.iter().map(|idx| {",
          "841:                         TableElement::FuncRef(",
          "842:                             self.get_func_ref(*idx).unwrap_or(std::ptr::null_mut()),",
          "843:                         )",
          "844:                     }),",
          "847:             TableSegmentElements::Expressions(exprs) => {",
          "848:                 let ty = table.element_type();",
          "849:                 let exprs = exprs",
          "850:                     .get(src..)",
          "851:                     .and_then(|s| s.get(..len))",
          "852:                     .ok_or(Trap::TableOutOfBounds)?;",
          "853:                 table.init(",
          "854:                     dst,",
          "855:                     exprs.iter().map(|expr| match ty {",
          "856:                         TableElementType::Func => {",
          "857:                             let funcref = match expr {",
          "858:                                 TableElementExpression::Null => std::ptr::null_mut(),",
          "859:                                 TableElementExpression::Function(idx) => {",
          "860:                                     self.get_func_ref(*idx).unwrap()",
          "861:                                 }",
          "862:                                 TableElementExpression::GlobalGet(idx) => {",
          "863:                                     let global = self.defined_or_imported_global_ptr(*idx);",
          "864:                                     unsafe { (*global).as_func_ref() }",
          "865:                                 }",
          "866:                             };",
          "867:                             TableElement::FuncRef(funcref)",
          "868:                         }",
          "869:                         TableElementType::Extern => {",
          "870:                             let externref = match expr {",
          "871:                                 TableElementExpression::Null => None,",
          "872:                                 TableElementExpression::Function(_) => unreachable!(),",
          "873:                                 TableElementExpression::GlobalGet(idx) => {",
          "874:                                     let global = self.defined_or_imported_global_ptr(*idx);",
          "875:                                     unsafe { (*global).as_externref().clone() }",
          "876:                                 }",
          "877:                             };",
          "878:                             TableElement::ExternRef(externref)",
          "879:                         }",
          "880:                     }),",
          "881:                 )?;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1060:                 let module = self.module();",
          "1061:                 let precomputed = match &module.table_initialization.initial_values[idx] {",
          "1062:                     TableInitialValue::Null { precomputed } => precomputed,",
          "1064:                 };",
          "1065:                 let func_index = precomputed.get(i as usize).cloned();",
          "1066:                 let func_ref = func_index",
          "",
          "[Removed Lines]",
          "1063:                     TableInitialValue::FuncRef(_) => unreachable!(),",
          "",
          "[Added Lines]",
          "1097:                     TableInitialValue::FuncRef(_) | TableInitialValue::GlobalGet(_) => {",
          "1098:                         unreachable!()",
          "1099:                     }",
          "",
          "---------------"
        ],
        "crates/runtime/src/instance/allocator.rs||crates/runtime/src/instance/allocator.rs": [
          "File: crates/runtime/src/instance/allocator.rs -> crates/runtime/src/instance/allocator.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "507:         let table = unsafe { &*instance.get_table(segment.table_index) };",
          "508:         let start = get_table_init_start(segment, instance)?;",
          "509:         let start = usize::try_from(start).unwrap();",
          "512:         match end {",
          "513:             Some(end) if end <= table.size() as usize => {",
          "",
          "[Removed Lines]",
          "510:         let end = start.checked_add(segment.elements.len());",
          "",
          "[Added Lines]",
          "510:         let end = start.checked_add(usize::try_from(segment.elements.len()).unwrap());",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "533:                 let table = unsafe { &mut *instance.get_defined_table(table) };",
          "534:                 table.init_func(funcref)?;",
          "535:             }",
          "536:         }",
          "537:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "537:             TableInitialValue::GlobalGet(idx) => unsafe {",
          "538:                 let global = instance.defined_or_imported_global_ptr(*idx);",
          "539:                 let funcref = (*global).as_func_ref();",
          "540:                 let table = &mut *instance.get_defined_table(table);",
          "541:                 table.init_func(funcref)?;",
          "542:             },",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "550:             &segment.elements,",
          "551:             start,",
          "552:             0,",
          "554:         )?;",
          "555:     }",
          "",
          "[Removed Lines]",
          "553:             segment.elements.len() as u32,",
          "",
          "[Added Lines]",
          "560:             segment.elements.len(),",
          "",
          "---------------"
        ],
        "crates/runtime/src/table.rs||crates/runtime/src/table.rs": [
          "File: crates/runtime/src/table.rs -> crates/runtime/src/table.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "39:     Extern,",
          "40: }",
          "44: unsafe impl Send for TableElement where VMExternRef: Send {}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: impl TableElementType {",
          "43:     fn matches(&self, val: &TableElement) -> bool {",
          "44:         match (val, self) {",
          "45:             (TableElement::FuncRef(_), TableElementType::Func) => true,",
          "46:             (TableElement::ExternRef(_), TableElementType::Extern) => true,",
          "47:             _ => false,",
          "48:         }",
          "49:     }",
          "50: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "297:         &mut self,",
          "298:         dst: u32,",
          "300:     ) -> Result<(), Trap> {",
          "303:         let elements = match self",
          "304:             .elements_mut()",
          "",
          "[Removed Lines]",
          "296:     pub fn init_funcs(",
          "299:         items: impl ExactSizeIterator<Item = *mut VMFuncRef>,",
          "301:         assert!(self.element_type() == TableElementType::Func);",
          "",
          "[Added Lines]",
          "306:     pub fn init(",
          "309:         items: impl ExactSizeIterator<Item = TableElement>,",
          "311:         let ty = self.element_type();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "310:         };",
          "312:         for (item, slot) in items.zip(elements) {",
          "313:             unsafe {",
          "315:             }",
          "316:         }",
          "317:         Ok(())",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "323:             debug_assert!(ty.matches(&item));",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "493:     }",
          "495:     fn type_matches(&self, val: &TableElement) -> bool {",
          "501:     }",
          "503:     fn elements(&self) -> &[TableValue] {",
          "",
          "[Removed Lines]",
          "496:         match (&val, self.element_type()) {",
          "497:             (TableElement::FuncRef(_), TableElementType::Func) => true,",
          "498:             (TableElement::ExternRef(_), TableElementType::Extern) => true,",
          "499:             _ => false,",
          "500:         }",
          "",
          "[Added Lines]",
          "507:         self.element_type().matches(val)",
          "",
          "---------------"
        ],
        "crates/wast/src/spectest.rs||crates/wast/src/spectest.rs": [
          "File: crates/wast/src/spectest.rs -> crates/wast/src/spectest.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:     linker.define(&mut *store, \"spectest\", \"global_i64\", g)?;",
          "32:     let ty = GlobalType::new(ValType::F32, Mutability::Const);",
          "34:     linker.define(&mut *store, \"spectest\", \"global_f32\", g)?;",
          "36:     let ty = GlobalType::new(ValType::F64, Mutability::Const);",
          "38:     linker.define(&mut *store, \"spectest\", \"global_f64\", g)?;",
          "40:     let ty = TableType::new(RefType::FUNCREF, 10, Some(20));",
          "",
          "[Removed Lines]",
          "33:     let g = Global::new(&mut *store, ty, Val::F32(0x4426_8000))?;",
          "37:     let g = Global::new(&mut *store, ty, Val::F64(0x4084_d000_0000_0000))?;",
          "",
          "[Added Lines]",
          "33:     let g = Global::new(&mut *store, ty, Val::F32(0x4426_a666))?;",
          "37:     let g = Global::new(&mut *store, ty, Val::F64(0x4084_d4cc_cccc_cccd))?;",
          "",
          "---------------"
        ],
        "tests/all/wast.rs||tests/all/wast.rs": [
          "File: tests/all/wast.rs -> tests/all/wast.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "133:             .max_memory_protection_keys(2)",
          "134:             .memory_pages(805)",
          "135:             .max_memories_per_module(if multi_memory { 9 } else { 1 })",
          "",
          "[Removed Lines]",
          "136:             .max_tables_per_module(4);",
          "",
          "[Added Lines]",
          "136:             .max_tables_per_module(5);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "614665688d27986014926be37a99f70dcff02910",
      "candidate_info": {
        "commit_hash": "614665688d27986014926be37a99f70dcff02910",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/614665688d27986014926be37a99f70dcff02910",
        "files": [
          "crates/runtime/src/libcalls.rs"
        ],
        "message": "Make libcalls slightly safer (#6360)\n\nBake in the `*mut VMContext` to `&mut Instance` translation into the\nmacro-generated trampolines to avoid the need to use\n`Instance::from_vmctx` with an extra level of indentation everywhere.\nAdditionally some libcalls are now entirely safe code as their one\nunsafe operation was the `VMContext` to `Instance` translation.",
        "before_after_code_files": [
          "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs"
          ],
          "candidate": [
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs"
          ]
        }
      },
      "candidate_diff": {
        "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs": [
          "File: crates/runtime/src/libcalls.rs -> crates/runtime/src/libcalls.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "57: use crate::externref::VMExternRef;",
          "58: use crate::table::{Table, TableElementType};",
          "60: use crate::{Instance, TrapReason};",
          "61: use anyhow::Result;",
          "62: use std::mem;",
          "",
          "[Removed Lines]",
          "59: use crate::vmcontext::{VMContext, VMFuncRef};",
          "",
          "[Added Lines]",
          "59: use crate::vmcontext::VMFuncRef;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "75: pub mod trampolines {",
          "78:     macro_rules! libcall {",
          "79:         (",
          "",
          "[Removed Lines]",
          "76:     use crate::{TrapReason, VMContext};",
          "",
          "[Added Lines]",
          "76:     use crate::{Instance, TrapReason, VMContext};",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "112:                 #[cfg_attr(target_arch = \"s390x\", no_mangle)]",
          "113:                 unsafe extern \"C\" fn [<impl_ $name>](",
          "115:                     $( $pname : libcall!(@ty $param), )*",
          "116:                 ) $( -> libcall!(@ty $result))? {",
          "117:                     let result = std::panic::catch_unwind(std::panic::AssertUnwindSafe(|| {",
          "119:                     }));",
          "120:                     match result {",
          "121:                         Ok(ret) => LibcallResult::convert(ret),",
          "",
          "[Removed Lines]",
          "114:                     vmctx : *mut VMContext,",
          "118:                         super::$name(vmctx, $($pname),*)",
          "",
          "[Added Lines]",
          "114:                     vmctx: *mut VMContext,",
          "118:                         Instance::from_vmctx(vmctx, |instance| {",
          "119:                             super::$name(instance, $($pname),*)",
          "120:                         })",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "181:     }",
          "182: }",
          "186:     delta: u64,",
          "187:     memory_index: u32,",
          "188: ) -> Result<*mut u8, TrapReason> {",
          "203: }",
          "209: unsafe fn table_grow(",
          "211:     table_index: u32,",
          "212:     delta: u32,",
          "",
          "[Removed Lines]",
          "184: unsafe fn memory32_grow(",
          "185:     vmctx: *mut VMContext,",
          "189:     Instance::from_vmctx(vmctx, |instance| {",
          "190:         let memory_index = MemoryIndex::from_u32(memory_index);",
          "191:         let result =",
          "192:             match instance",
          "193:                 .memory_grow(memory_index, delta)",
          "194:                 .map_err(|error| TrapReason::User {",
          "195:                     error,",
          "196:                     needs_backtrace: true,",
          "197:                 })? {",
          "198:                 Some(size_in_bytes) => size_in_bytes / (wasmtime_environ::WASM_PAGE_SIZE as usize),",
          "199:                 None => usize::max_value(),",
          "200:             };",
          "201:         Ok(result as *mut _)",
          "202:     })",
          "210:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "186: fn memory32_grow(",
          "187:     instance: &mut Instance,",
          "191:     let memory_index = MemoryIndex::from_u32(memory_index);",
          "192:     let result =",
          "193:         match instance",
          "194:             .memory_grow(memory_index, delta)",
          "195:             .map_err(|error| TrapReason::User {",
          "196:                 error,",
          "197:                 needs_backtrace: true,",
          "198:             })? {",
          "199:             Some(size_in_bytes) => size_in_bytes / (wasmtime_environ::WASM_PAGE_SIZE as usize),",
          "200:             None => usize::max_value(),",
          "201:         };",
          "202:     Ok(result as *mut _)",
          "207:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "215:     init_value: *mut u8,",
          "216: ) -> Result<u32> {",
          "217:     let table_index = TableIndex::from_u32(table_index);",
          "234:     })",
          "235: }",
          "",
          "[Removed Lines]",
          "218:     Instance::from_vmctx(vmctx, |instance| {",
          "219:         let element = match instance.table_element_type(table_index) {",
          "220:             TableElementType::Func => (init_value as *mut VMFuncRef).into(),",
          "221:             TableElementType::Extern => {",
          "222:                 let init_value = if init_value.is_null() {",
          "223:                     None",
          "224:                 } else {",
          "225:                     Some(VMExternRef::clone_from_raw(init_value))",
          "226:                 };",
          "227:                 init_value.into()",
          "228:             }",
          "229:         };",
          "230:         Ok(match instance.table_grow(table_index, delta, element)? {",
          "231:             Some(r) => r,",
          "232:             None => -1_i32 as u32,",
          "233:         })",
          "",
          "[Added Lines]",
          "215:     let element = match instance.table_element_type(table_index) {",
          "216:         TableElementType::Func => (init_value as *mut VMFuncRef).into(),",
          "217:         TableElementType::Extern => {",
          "218:             let init_value = if init_value.is_null() {",
          "219:                 None",
          "220:             } else {",
          "221:                 Some(VMExternRef::clone_from_raw(init_value))",
          "222:             };",
          "223:             init_value.into()",
          "224:         }",
          "225:     };",
          "226:     Ok(match instance.table_grow(table_index, delta, element)? {",
          "227:         Some(r) => r,",
          "228:         None => -1_i32 as u32,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "241: unsafe fn table_fill(",
          "243:     table_index: u32,",
          "244:     dst: u32,",
          "",
          "[Removed Lines]",
          "242:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "237:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "247:     val: *mut u8,",
          "248:     len: u32,",
          "249: ) -> Result<(), Trap> {",
          "266:         }",
          "268: }",
          "270: use table_fill as table_fill_func_ref;",
          "",
          "[Removed Lines]",
          "250:     Instance::from_vmctx(vmctx, |instance| {",
          "251:         let table_index = TableIndex::from_u32(table_index);",
          "252:         let table = &mut *instance.get_table(table_index);",
          "253:         match table.element_type() {",
          "254:             TableElementType::Func => {",
          "255:                 let val = val as *mut VMFuncRef;",
          "256:                 table.fill(dst, val.into(), len)",
          "257:             }",
          "258:             TableElementType::Extern => {",
          "259:                 let val = if val.is_null() {",
          "260:                     None",
          "261:                 } else {",
          "262:                     Some(VMExternRef::clone_from_raw(val))",
          "263:                 };",
          "264:                 table.fill(dst, val.into(), len)",
          "265:             }",
          "267:     })",
          "",
          "[Added Lines]",
          "245:     let table_index = TableIndex::from_u32(table_index);",
          "246:     let table = &mut *instance.get_table(table_index);",
          "247:     match table.element_type() {",
          "248:         TableElementType::Func => {",
          "249:             let val = val as *mut VMFuncRef;",
          "250:             table.fill(dst, val.into(), len)",
          "252:         TableElementType::Extern => {",
          "253:             let val = if val.is_null() {",
          "254:                 None",
          "255:             } else {",
          "256:                 Some(VMExternRef::clone_from_raw(val))",
          "257:             };",
          "258:             table.fill(dst, val.into(), len)",
          "259:         }",
          "260:     }",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "274: unsafe fn table_copy(",
          "276:     dst_table_index: u32,",
          "277:     src_table_index: u32,",
          "278:     dst: u32,",
          "",
          "[Removed Lines]",
          "275:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "268:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "281: ) -> Result<(), Trap> {",
          "282:     let dst_table_index = TableIndex::from_u32(dst_table_index);",
          "283:     let src_table_index = TableIndex::from_u32(src_table_index);",
          "291: }",
          "296:     table_index: u32,",
          "297:     elem_index: u32,",
          "298:     dst: u32,",
          "",
          "[Removed Lines]",
          "284:     Instance::from_vmctx(vmctx, |instance| {",
          "285:         let dst_table = instance.get_table(dst_table_index);",
          "287:         let src_range = src..(src.checked_add(len).unwrap_or(u32::MAX));",
          "288:         let src_table = instance.get_table_with_lazy_init(src_table_index, src_range);",
          "289:         Table::copy(dst_table, src_table, dst, src, len)",
          "290:     })",
          "294: unsafe fn table_init(",
          "295:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "277:     let dst_table = instance.get_table(dst_table_index);",
          "279:     let src_range = src..(src.checked_add(len).unwrap_or(u32::MAX));",
          "280:     let src_table = instance.get_table_with_lazy_init(src_table_index, src_range);",
          "281:     Table::copy(dst_table, src_table, dst, src, len)",
          "285: fn table_init(",
          "286:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "301: ) -> Result<(), Trap> {",
          "302:     let table_index = TableIndex::from_u32(table_index);",
          "303:     let elem_index = ElemIndex::from_u32(elem_index);",
          "307: }",
          "311:     let elem_index = ElemIndex::from_u32(elem_index);",
          "313: }",
          "318:     dst_index: u32,",
          "319:     dst: u64,",
          "320:     src_index: u32,",
          "",
          "[Removed Lines]",
          "304:     Instance::from_vmctx(vmctx, |i| {",
          "305:         i.table_init(table_index, elem_index, dst, src, len)",
          "306:     })",
          "310: unsafe fn elem_drop(vmctx: *mut VMContext, elem_index: u32) {",
          "312:     Instance::from_vmctx(vmctx, |i| i.elem_drop(elem_index))",
          "316: unsafe fn memory_copy(",
          "317:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "295:     instance.table_init(table_index, elem_index, dst, src, len)",
          "299: fn elem_drop(instance: &mut Instance, elem_index: u32) {",
          "301:     instance.elem_drop(elem_index)",
          "305: fn memory_copy(",
          "306:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "323: ) -> Result<(), Trap> {",
          "324:     let src_index = MemoryIndex::from_u32(src_index);",
          "325:     let dst_index = MemoryIndex::from_u32(dst_index);",
          "329: }",
          "334:     memory_index: u32,",
          "335:     dst: u64,",
          "336:     val: u32,",
          "337:     len: u64,",
          "338: ) -> Result<(), Trap> {",
          "339:     let memory_index = MemoryIndex::from_u32(memory_index);",
          "341: }",
          "346:     memory_index: u32,",
          "347:     data_index: u32,",
          "348:     dst: u64,",
          "",
          "[Removed Lines]",
          "326:     Instance::from_vmctx(vmctx, |i| {",
          "327:         i.memory_copy(dst_index, dst, src_index, src, len)",
          "328:     })",
          "332: unsafe fn memory_fill(",
          "333:     vmctx: *mut VMContext,",
          "340:     Instance::from_vmctx(vmctx, |i| i.memory_fill(memory_index, dst, val as u8, len))",
          "344: unsafe fn memory_init(",
          "345:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "315:     instance.memory_copy(dst_index, dst, src_index, src, len)",
          "319: fn memory_fill(",
          "320:     instance: &mut Instance,",
          "327:     instance.memory_fill(memory_index, dst, val as u8, len)",
          "331: fn memory_init(",
          "332:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "351: ) -> Result<(), Trap> {",
          "352:     let memory_index = MemoryIndex::from_u32(memory_index);",
          "353:     let data_index = DataIndex::from_u32(data_index);",
          "357: }",
          "367: }",
          "371:     let data_index = DataIndex::from_u32(data_index);",
          "373: }",
          "376: unsafe fn table_get_lazy_init_func_ref(",
          "378:     table_index: u32,",
          "379:     index: u32,",
          "380: ) -> *mut u8 {",
          "390: }",
          "394:     let externref = externref as *mut crate::externref::VMExternData;",
          "395:     let externref = NonNull::new(externref).unwrap().into();",
          "396:     crate::externref::VMExternData::drop_and_dealloc(externref);",
          "",
          "[Removed Lines]",
          "354:     Instance::from_vmctx(vmctx, |i| {",
          "355:         i.memory_init(memory_index, data_index, dst, src, len)",
          "356:     })",
          "360: unsafe fn ref_func(vmctx: *mut VMContext, func_index: u32) -> *mut u8 {",
          "361:     Instance::from_vmctx(vmctx, |instance| {",
          "362:         instance",
          "363:             .get_func_ref(FuncIndex::from_u32(func_index))",
          "364:             .expect(\"ref_func: funcref should always be available for given func index\")",
          "365:             .cast()",
          "366:     })",
          "370: unsafe fn data_drop(vmctx: *mut VMContext, data_index: u32) {",
          "372:     Instance::from_vmctx(vmctx, |i| i.data_drop(data_index))",
          "377:     vmctx: *mut VMContext,",
          "381:     Instance::from_vmctx(vmctx, |instance| {",
          "382:         let table_index = TableIndex::from_u32(table_index);",
          "383:         let table = instance.get_table_with_lazy_init(table_index, std::iter::once(index));",
          "384:         let elem = (*table)",
          "385:             .get(index)",
          "386:             .expect(\"table access already bounds-checked\");",
          "388:         elem.into_ref_asserting_initialized()",
          "389:     })",
          "393: unsafe fn drop_externref(_vmctx: *mut VMContext, externref: *mut u8) {",
          "",
          "[Added Lines]",
          "341:     instance.memory_init(memory_index, data_index, dst, src, len)",
          "345: fn ref_func(instance: &mut Instance, func_index: u32) -> *mut u8 {",
          "346:     instance",
          "347:         .get_func_ref(FuncIndex::from_u32(func_index))",
          "348:         .expect(\"ref_func: funcref should always be available for given func index\")",
          "349:         .cast()",
          "353: fn data_drop(instance: &mut Instance, data_index: u32) {",
          "355:     instance.data_drop(data_index)",
          "360:     instance: &mut Instance,",
          "364:     let table_index = TableIndex::from_u32(table_index);",
          "365:     let table = instance.get_table_with_lazy_init(table_index, std::iter::once(index));",
          "366:     let elem = (*table)",
          "367:         .get(index)",
          "368:         .expect(\"table access already bounds-checked\");",
          "370:     elem.into_ref_asserting_initialized()",
          "374: unsafe fn drop_externref(_instance: &mut Instance, externref: *mut u8) {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "402:     let externref = VMExternRef::clone_from_raw(externref);",
          "419: }",
          "423:     let index = GlobalIndex::from_u32(index);",
          "436:         }",
          "438: }",
          "442:     let externref = if externref.is_null() {",
          "443:         None",
          "444:     } else {",
          "",
          "[Removed Lines]",
          "401: unsafe fn activations_table_insert_with_gc(vmctx: *mut VMContext, externref: *mut u8) {",
          "403:     Instance::from_vmctx(vmctx, |instance| {",
          "404:         let limits = *instance.runtime_limits();",
          "405:         let (activations_table, module_info_lookup) =",
          "406:             (*instance.store()).externref_activations_table();",
          "415:         activations_table.insert_without_gc(externref.clone());",
          "417:         activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "418:     })",
          "422: unsafe fn externref_global_get(vmctx: *mut VMContext, index: u32) -> *mut u8 {",
          "424:     Instance::from_vmctx(vmctx, |instance| {",
          "425:         let limits = *instance.runtime_limits();",
          "426:         let global = instance.defined_or_imported_global_ptr(index);",
          "427:         match (*global).as_externref().clone() {",
          "428:             None => ptr::null_mut(),",
          "429:             Some(externref) => {",
          "430:                 let raw = externref.as_raw();",
          "431:                 let (activations_table, module_info_lookup) =",
          "432:                     (*instance.store()).externref_activations_table();",
          "433:                 activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "434:                 raw",
          "435:             }",
          "437:     })",
          "441: unsafe fn externref_global_set(vmctx: *mut VMContext, index: u32, externref: *mut u8) {",
          "",
          "[Added Lines]",
          "382: unsafe fn activations_table_insert_with_gc(instance: &mut Instance, externref: *mut u8) {",
          "384:     let limits = *instance.runtime_limits();",
          "385:     let (activations_table, module_info_lookup) = (*instance.store()).externref_activations_table();",
          "394:     activations_table.insert_without_gc(externref.clone());",
          "396:     activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "400: unsafe fn externref_global_get(instance: &mut Instance, index: u32) -> *mut u8 {",
          "402:     let limits = *instance.runtime_limits();",
          "403:     let global = instance.defined_or_imported_global_ptr(index);",
          "404:     match (*global).as_externref().clone() {",
          "405:         None => ptr::null_mut(),",
          "406:         Some(externref) => {",
          "407:             let raw = externref.as_raw();",
          "408:             let (activations_table, module_info_lookup) =",
          "409:                 (*instance.store()).externref_activations_table();",
          "410:             activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "411:             raw",
          "413:     }",
          "417: unsafe fn externref_global_set(instance: &mut Instance, index: u32, externref: *mut u8) {",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "446:     };",
          "448:     let index = GlobalIndex::from_u32(index);",
          "459: }",
          "464:     memory_index: u32,",
          "465:     addr_index: u64,",
          "466:     count: u32,",
          "467: ) -> Result<u32, Trap> {",
          "468:     let memory = MemoryIndex::from_u32(memory_index);",
          "474: }",
          "479:     memory_index: u32,",
          "480:     addr_index: u64,",
          "481:     expected: u32,",
          "",
          "[Removed Lines]",
          "449:     Instance::from_vmctx(vmctx, |instance| {",
          "450:         let global = instance.defined_or_imported_global_ptr(index);",
          "456:         let old = mem::replace((*global).as_externref_mut(), externref);",
          "457:         drop(old);",
          "458:     })",
          "462: unsafe fn memory_atomic_notify(",
          "463:     vmctx: *mut VMContext,",
          "469:     Instance::from_vmctx(vmctx, |instance| {",
          "470:         instance",
          "471:             .get_runtime_memory(memory)",
          "472:             .atomic_notify(addr_index, count)",
          "473:     })",
          "477: unsafe fn memory_atomic_wait32(",
          "478:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "425:     let global = instance.defined_or_imported_global_ptr(index);",
          "431:     let old = mem::replace((*global).as_externref_mut(), externref);",
          "432:     drop(old);",
          "436: fn memory_atomic_notify(",
          "437:     instance: &mut Instance,",
          "443:     instance",
          "444:         .get_runtime_memory(memory)",
          "445:         .atomic_notify(addr_index, count)",
          "449: fn memory_atomic_wait32(",
          "450:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "485:     let timeout = (timeout as i64 >= 0).then(|| Instant::now() + Duration::from_nanos(timeout));",
          "486:     let memory = MemoryIndex::from_u32(memory_index);",
          "492: }",
          "497:     memory_index: u32,",
          "498:     addr_index: u64,",
          "499:     expected: u64,",
          "",
          "[Removed Lines]",
          "487:     Instance::from_vmctx(vmctx, |instance| {",
          "488:         Ok(instance",
          "489:             .get_runtime_memory(memory)",
          "490:             .atomic_wait32(addr_index, expected, timeout)? as u32)",
          "491:     })",
          "495: unsafe fn memory_atomic_wait64(",
          "496:     vmctx: *mut VMContext,",
          "",
          "[Added Lines]",
          "459:     Ok(instance",
          "460:         .get_runtime_memory(memory)",
          "461:         .atomic_wait32(addr_index, expected, timeout)? as u32)",
          "465: fn memory_atomic_wait64(",
          "466:     instance: &mut Instance,",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "503:     let timeout = (timeout as i64 >= 0).then(|| Instant::now() + Duration::from_nanos(timeout));",
          "504:     let memory = MemoryIndex::from_u32(memory_index);",
          "510: }",
          "515: }",
          "520: }",
          "",
          "[Removed Lines]",
          "505:     Instance::from_vmctx(vmctx, |instance| {",
          "506:         Ok(instance",
          "507:             .get_runtime_memory(memory)",
          "508:             .atomic_wait64(addr_index, expected, timeout)? as u32)",
          "509:     })",
          "513: unsafe fn out_of_gas(vmctx: *mut VMContext) -> Result<()> {",
          "514:     Instance::from_vmctx(vmctx, |i| (*i.store()).out_of_gas())",
          "518: unsafe fn new_epoch(vmctx: *mut VMContext) -> Result<u64> {",
          "519:     Instance::from_vmctx(vmctx, |i| (*i.store()).new_epoch())",
          "",
          "[Added Lines]",
          "475:     Ok(instance",
          "476:         .get_runtime_memory(memory)",
          "477:         .atomic_wait64(addr_index, expected, timeout)? as u32)",
          "481: unsafe fn out_of_gas(instance: &mut Instance) -> Result<()> {",
          "482:     (*instance.store()).out_of_gas()",
          "486: unsafe fn new_epoch(instance: &mut Instance) -> Result<u64> {",
          "487:     (*instance.store()).new_epoch()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4f1e6f37856b2e829a31aa4b4c5cade91abf4d97",
      "candidate_info": {
        "commit_hash": "4f1e6f37856b2e829a31aa4b4c5cade91abf4d97",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/4f1e6f37856b2e829a31aa4b4c5cade91abf4d97",
        "files": [
          "crates/fiber/src/unix.rs",
          "crates/runtime/src/component.rs",
          "crates/runtime/src/instance.rs",
          "crates/runtime/src/memory.rs",
          "crates/runtime/src/sys/custom/mmap.rs",
          "crates/runtime/src/sys/miri/mmap.rs",
          "crates/runtime/src/sys/unix/mmap.rs",
          "tests/all/memory.rs"
        ],
        "message": "Use some new standard library methods from Rust 1.74, 1.75 (#8209)\n\n* Use some `byte_add` methods from Rust 1.75\n\nNow that we're able to, use some convenience methods from the 1.75\nrelease of Rust.\n\n* Use `Atomic*::from_ptr` from Rust 1.75\n\nHelps clean up some casts and clarify local intent.",
        "before_after_code_files": [
          "crates/fiber/src/unix.rs||crates/fiber/src/unix.rs",
          "crates/runtime/src/component.rs||crates/runtime/src/component.rs",
          "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
          "crates/runtime/src/memory.rs||crates/runtime/src/memory.rs",
          "crates/runtime/src/sys/custom/mmap.rs||crates/runtime/src/sys/custom/mmap.rs",
          "crates/runtime/src/sys/miri/mmap.rs||crates/runtime/src/sys/miri/mmap.rs",
          "crates/runtime/src/sys/unix/mmap.rs||crates/runtime/src/sys/unix/mmap.rs",
          "tests/all/memory.rs||tests/all/memory.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs"
          ],
          "candidate": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs"
          ]
        }
      },
      "candidate_diff": {
        "crates/fiber/src/unix.rs||crates/fiber/src/unix.rs": [
          "File: crates/fiber/src/unix.rs -> crates/fiber/src/unix.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:             )?;",
          "73:             rustix::mm::mprotect(",
          "75:                 size,",
          "76:                 rustix::mm::MprotectFlags::READ | rustix::mm::MprotectFlags::WRITE,",
          "77:             )?;",
          "79:             Ok(Self::Default {",
          "81:                 len: mmap_len,",
          "82:                 mmap: true,",
          "83:             })",
          "",
          "[Removed Lines]",
          "74:                 mmap.cast::<u8>().add(page_size).cast(),",
          "80:                 top: mmap.cast::<u8>().add(mmap_len),",
          "",
          "[Added Lines]",
          "74:                 mmap.byte_add(page_size).cast(),",
          "80:                 top: mmap.byte_add(mmap_len).cast(),",
          "",
          "---------------"
        ],
        "crates/runtime/src/component.rs||crates/runtime/src/component.rs": [
          "File: crates/runtime/src/component.rs -> crates/runtime/src/component.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:         f: impl FnOnce(&mut ComponentInstance) -> R,",
          "157:     ) -> R {",
          "158:         let ptr = vmctx",
          "161:             .cast::<ComponentInstance>();",
          "162:         f(&mut *ptr)",
          "163:     }",
          "",
          "[Removed Lines]",
          "159:             .cast::<u8>()",
          "160:             .sub(mem::size_of::<ComponentInstance>())",
          "",
          "[Added Lines]",
          "159:             .byte_sub(mem::size_of::<ComponentInstance>())",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "205:                 vmctx_self_reference: SendSyncPtr::new(",
          "206:                     NonNull::new(",
          "207:                         ptr.as_ptr()",
          "210:                             .cast(),",
          "211:                     )",
          "212:                     .unwrap(),",
          "",
          "[Removed Lines]",
          "208:                             .cast::<u8>()",
          "209:                             .add(mem::size_of::<ComponentInstance>())",
          "",
          "[Added Lines]",
          "207:                             .byte_add(mem::size_of::<ComponentInstance>())",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "231:     unsafe fn vmctx_plus_offset<T>(&self, offset: u32) -> *const T {",
          "232:         self.vmctx()",
          "235:             .cast()",
          "236:     }",
          "238:     unsafe fn vmctx_plus_offset_mut<T>(&mut self, offset: u32) -> *mut T {",
          "239:         self.vmctx()",
          "242:             .cast()",
          "243:     }",
          "",
          "[Removed Lines]",
          "233:             .cast::<u8>()",
          "234:             .add(usize::try_from(offset).unwrap())",
          "240:             .cast::<u8>()",
          "241:             .add(usize::try_from(offset).unwrap())",
          "",
          "[Added Lines]",
          "231:             .byte_add(usize::try_from(offset).unwrap())",
          "237:             .byte_add(usize::try_from(offset).unwrap())",
          "",
          "---------------"
        ],
        "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
          "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "189:                 dropped_elements,",
          "190:                 dropped_data,",
          "191:                 host_state: req.host_state,",
          "195:                 vmctx: VMContext {",
          "196:                     _marker: std::marker::PhantomPinned,",
          "197:                 },",
          "",
          "[Removed Lines]",
          "192:                 vmctx_self_reference: SendSyncPtr::new(",
          "193:                     NonNull::new(ptr.cast::<u8>().add(mem::size_of::<Instance>()).cast()).unwrap(),",
          "194:                 ),",
          "",
          "[Added Lines]",
          "192:                 vmctx_self_reference: SendSyncPtr::new(NonNull::new(ptr.add(1).cast()).unwrap()),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "236:     #[inline]",
          "237:     pub unsafe fn from_vmctx<R>(vmctx: *mut VMContext, f: impl FnOnce(&mut Instance) -> R) -> R {",
          "238:         let ptr = vmctx",
          "241:             .cast::<Instance>();",
          "242:         f(&mut *ptr)",
          "243:     }",
          "",
          "[Removed Lines]",
          "239:             .cast::<u8>()",
          "240:             .sub(mem::size_of::<Instance>())",
          "",
          "[Added Lines]",
          "237:             .byte_sub(mem::size_of::<Instance>())",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "252:     unsafe fn vmctx_plus_offset<T>(&self, offset: u32) -> *const T {",
          "253:         self.vmctx()",
          "256:             .cast()",
          "257:     }",
          "260:     unsafe fn vmctx_plus_offset_mut<T>(&mut self, offset: u32) -> *mut T {",
          "261:         self.vmctx()",
          "264:             .cast()",
          "265:     }",
          "",
          "[Removed Lines]",
          "254:             .cast::<u8>()",
          "255:             .add(usize::try_from(offset).unwrap())",
          "262:             .cast::<u8>()",
          "263:             .add(usize::try_from(offset).unwrap())",
          "",
          "[Added Lines]",
          "251:             .byte_add(usize::try_from(offset).unwrap())",
          "258:             .byte_add(usize::try_from(offset).unwrap())",
          "",
          "---------------"
        ],
        "crates/runtime/src/memory.rs||crates/runtime/src/memory.rs": [
          "File: crates/runtime/src/memory.rs -> crates/runtime/src/memory.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "586:         assert!(std::mem::size_of::<AtomicU32>() == 4);",
          "587:         assert!(std::mem::align_of::<AtomicU32>() <= 4);",
          "590:         WAITER.with(|waiter| {",
          "591:             let mut waiter = waiter.borrow_mut();",
          "",
          "[Removed Lines]",
          "588:         let atomic = unsafe { &*(addr as *const AtomicU32) };",
          "",
          "[Added Lines]",
          "588:         let atomic = unsafe { AtomicU32::from_ptr(addr.cast()) };",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "609:         assert!(std::mem::size_of::<AtomicU64>() == 8);",
          "610:         assert!(std::mem::align_of::<AtomicU64>() <= 8);",
          "613:         WAITER.with(|waiter| {",
          "614:             let mut waiter = waiter.borrow_mut();",
          "",
          "[Removed Lines]",
          "611:         let atomic = unsafe { &*(addr as *const AtomicU64) };",
          "",
          "[Added Lines]",
          "611:         let atomic = unsafe { AtomicU64::from_ptr(addr.cast()) };",
          "",
          "---------------"
        ],
        "crates/runtime/src/sys/custom/mmap.rs||crates/runtime/src/sys/custom/mmap.rs": [
          "File: crates/runtime/src/sys/custom/mmap.rs -> crates/runtime/src/sys/custom/mmap.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:     }",
          "44:     pub fn make_accessible(&mut self, start: usize, len: usize) -> Result<()> {",
          "46:         unsafe {",
          "47:             cvt(capi::wasmtime_mprotect(",
          "49:                 len,",
          "50:                 capi::PROT_READ | capi::PROT_WRITE,",
          "51:             ))?;",
          "",
          "[Removed Lines]",
          "45:         let ptr = self.memory.as_ptr().cast::<u8>();",
          "48:                 ptr.add(start).cast(),",
          "",
          "[Added Lines]",
          "45:         let ptr = self.memory.as_ptr();",
          "48:                 ptr.byte_add(start).cast(),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "74:         range: Range<usize>,",
          "75:         enable_branch_protection: bool,",
          "76:     ) -> Result<()> {",
          "78:         let len = range.end - range.start;",
          "",
          "[Removed Lines]",
          "77:         let base = self.memory.as_ptr().cast::<u8>().add(range.start).cast();",
          "",
          "[Added Lines]",
          "77:         let base = self.memory.as_ptr().byte_add(range.start).cast();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:     }",
          "91:     pub unsafe fn make_readonly(&self, range: Range<usize>) -> Result<()> {",
          "93:         let len = range.end - range.start;",
          "95:         cvt(capi::wasmtime_mprotect(base, len, capi::PROT_READ))?;",
          "",
          "[Removed Lines]",
          "92:         let base = self.memory.as_ptr().cast::<u8>().add(range.start).cast();",
          "",
          "[Added Lines]",
          "92:         let base = self.memory.as_ptr().byte_add(range.start).cast();",
          "",
          "---------------"
        ],
        "crates/runtime/src/sys/miri/mmap.rs||crates/runtime/src/sys/miri/mmap.rs": [
          "File: crates/runtime/src/sys/miri/mmap.rs -> crates/runtime/src/sys/miri/mmap.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:         unsafe {",
          "55:         }",
          "56:         Ok(())",
          "57:     }",
          "",
          "[Removed Lines]",
          "54:             std::ptr::write_bytes(self.memory.as_ptr().cast::<u8>().add(start), 0u8, len);",
          "",
          "[Added Lines]",
          "54:             std::ptr::write_bytes(self.as_mut_ptr().add(start), 0u8, len);",
          "",
          "---------------"
        ],
        "crates/runtime/src/sys/unix/mmap.rs||crates/runtime/src/sys/unix/mmap.rs": [
          "File: crates/runtime/src/sys/unix/mmap.rs -> crates/runtime/src/sys/unix/mmap.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:     }",
          "74:     pub fn make_accessible(&mut self, start: usize, len: usize) -> Result<()> {",
          "76:         unsafe {",
          "77:             mprotect(",
          "79:                 len,",
          "80:                 MprotectFlags::READ | MprotectFlags::WRITE,",
          "81:             )?;",
          "",
          "[Removed Lines]",
          "75:         let ptr = self.memory.as_ptr().cast::<u8>();",
          "78:                 ptr.add(start).cast(),",
          "",
          "[Added Lines]",
          "75:         let ptr = self.memory.as_ptr();",
          "78:                 ptr.byte_add(start).cast(),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "104:         range: Range<usize>,",
          "105:         enable_branch_protection: bool,",
          "106:     ) -> Result<()> {",
          "108:         let len = range.end - range.start;",
          "110:         let flags = MprotectFlags::READ | MprotectFlags::EXEC;",
          "",
          "[Removed Lines]",
          "107:         let base = self.memory.as_ptr().cast::<u8>().add(range.start).cast();",
          "",
          "[Added Lines]",
          "107:         let base = self.memory.as_ptr().byte_add(range.start).cast();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "128:     }",
          "130:     pub unsafe fn make_readonly(&self, range: Range<usize>) -> Result<()> {",
          "132:         let len = range.end - range.start;",
          "134:         mprotect(base, len, MprotectFlags::READ)?;",
          "",
          "[Removed Lines]",
          "131:         let base = self.memory.as_ptr().cast::<u8>().add(range.start).cast();",
          "",
          "[Added Lines]",
          "131:         let base = self.memory.as_ptr().byte_add(range.start).cast();",
          "",
          "---------------"
        ],
        "tests/all/memory.rs||tests/all/memory.rs": [
          "File: tests/all/memory.rs -> tests/all/memory.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "610:     let engine = Engine::default();",
          "611:     let memory = SharedMemory::new(&engine, MemoryType::shared(1, 1))?;",
          "",
          "[Removed Lines]",
          "612:     let data = unsafe { &*(memory.data().as_ptr() as *const AtomicU32) };",
          "613:     let locked = unsafe { &*(memory.data().as_ptr().add(4) as *const AtomicU32) };",
          "",
          "[Added Lines]",
          "612:     let data = unsafe { AtomicU32::from_ptr(memory.data().as_ptr().cast_mut().cast()) };",
          "613:     let locked = unsafe { AtomicU32::from_ptr(memory.data().as_ptr().add(4).cast_mut().cast()) };",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "60ce6f5d5c5b7defc6f7a8bfaa6bfb8db82b0aa1",
      "candidate_info": {
        "commit_hash": "60ce6f5d5c5b7defc6f7a8bfaa6bfb8db82b0aa1",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/60ce6f5d5c5b7defc6f7a8bfaa6bfb8db82b0aa1",
        "files": [
          "crates/runtime/src/externref.rs",
          "crates/runtime/src/libcalls.rs",
          "crates/runtime/src/traphandlers.rs",
          "crates/runtime/src/traphandlers/backtrace.rs",
          "crates/wasmtime/src/profiling.rs",
          "crates/wasmtime/src/store.rs",
          "crates/wasmtime/src/trap.rs",
          "src/commands/run.rs",
          "tests/all/async_functions.rs",
          "tests/all/traps.rs"
        ],
        "message": "`wasmtime`: Fix resetting stack-walking registers when entering/exiting Wasm (#6321)\n\n* wasmtime: Fix resetting stack-walking registers when entering/exiting Wasm\n\nFixes a regression from #6262, originally reported in\nhttps://github.com/bytecodealliance/wasmtime-dotnet/pull/245\n\nThe issue was that we would enter Wasm and save the stack-walking registers but\nnever clear them after Wasm returns. Then if a host-to-host call tried to\ncapture a stack, we would mistakenly attempt to use those stale registers to\nstart the stack walk. This mistake would be caught by an assertion, triggering a\npanic.\n\nThis commit fixes the issue by managing the save/restore in the\n`CallThreadState` construction/drop, rather than in the old `set_prev`\nmethod.\n\nCo-Authored-By: Alex Crichton <alex@alexcrichton.com>\n\n* Plumb through `VMRuntimeLimits` when capturing stack traces\n\nThis way we can differentiate between the same module loaded in different stores\nand avoid leaking other stores' frames into our backtraces.\n\nCo-Authored-By: Jamey Sharp <jsharp@fastly.com>\n\n---------\n\nCo-authored-by: Alex Crichton <alex@alexcrichton.com>\nCo-authored-by: Jamey Sharp <jsharp@fastly.com>",
        "before_after_code_files": [
          "crates/runtime/src/externref.rs||crates/runtime/src/externref.rs",
          "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs",
          "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs",
          "crates/runtime/src/traphandlers/backtrace.rs||crates/runtime/src/traphandlers/backtrace.rs",
          "crates/wasmtime/src/profiling.rs||crates/wasmtime/src/profiling.rs",
          "crates/wasmtime/src/store.rs||crates/wasmtime/src/store.rs",
          "crates/wasmtime/src/trap.rs||crates/wasmtime/src/trap.rs",
          "src/commands/run.rs||src/commands/run.rs",
          "tests/all/async_functions.rs||tests/all/async_functions.rs",
          "tests/all/traps.rs||tests/all/traps.rs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs",
            "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs"
          ],
          "candidate": [
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs",
            "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs"
          ]
        }
      },
      "candidate_diff": {
        "crates/runtime/src/externref.rs||crates/runtime/src/externref.rs": [
          "File: crates/runtime/src/externref.rs -> crates/runtime/src/externref.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "102: use std::alloc::Layout;",
          "103: use std::any::Any;",
          "104: use std::cell::UnsafeCell;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102: use crate::{Backtrace, VMRuntimeLimits};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111: use std::sync::atomic::{self, AtomicUsize, Ordering};",
          "112: use wasmtime_environ::StackMap;",
          "",
          "[Removed Lines]",
          "114: use crate::Backtrace;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "649:     #[inline]",
          "650:     pub unsafe fn insert_with_gc(",
          "651:         &mut self,",
          "652:         externref: VMExternRef,",
          "653:         module_info_lookup: &dyn ModuleInfoLookup,",
          "654:     ) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "651:         limits: *const VMRuntimeLimits,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "656:         assert!(self.gc_okay);",
          "658:         if let Err(externref) = self.try_insert(externref) {",
          "660:         }",
          "661:     }",
          "663:     #[inline(never)]",
          "664:     unsafe fn gc_and_insert_slow(",
          "665:         &mut self,",
          "666:         externref: VMExternRef,",
          "667:         module_info_lookup: &dyn ModuleInfoLookup,",
          "668:     ) {",
          "",
          "[Removed Lines]",
          "659:             self.gc_and_insert_slow(externref, module_info_lookup);",
          "669:         gc(module_info_lookup, self);",
          "",
          "[Added Lines]",
          "659:             self.gc_and_insert_slow(limits, externref, module_info_lookup);",
          "666:         limits: *const VMRuntimeLimits,",
          "670:         gc(limits, module_info_lookup, self);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "856: pub unsafe fn gc(",
          "857:     module_info_lookup: &dyn ModuleInfoLookup,",
          "858:     externref_activations_table: &mut VMExternRefActivationsTable,",
          "859: ) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "858:     limits: *const VMRuntimeLimits,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "894:     }",
          "896:     log::trace!(\"begin GC trace\");",
          "898:         let pc = frame.pc();",
          "899:         debug_assert!(pc != 0, \"we should always get a valid PC for Wasm frames\");",
          "",
          "[Removed Lines]",
          "897:     Backtrace::trace(|frame| {",
          "",
          "[Added Lines]",
          "899:     Backtrace::trace(limits, |frame| {",
          "",
          "---------------"
        ],
        "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs": [
          "File: crates/runtime/src/libcalls.rs -> crates/runtime/src/libcalls.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "395: unsafe fn activations_table_insert_with_gc(vmctx: *mut VMContext, externref: *mut u8) {",
          "396:     let externref = VMExternRef::clone_from_raw(externref);",
          "398:     let (activations_table, module_info_lookup) = (*instance.store()).externref_activations_table();",
          "",
          "[Removed Lines]",
          "397:     let instance = (*vmctx).instance();",
          "",
          "[Added Lines]",
          "397:     let instance = (*vmctx).instance_mut();",
          "398:     let limits = *instance.runtime_limits();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "407:     activations_table.insert_without_gc(externref.clone());",
          "410: }",
          "413: unsafe fn externref_global_get(vmctx: *mut VMContext, index: u32) -> *mut u8 {",
          "414:     let index = GlobalIndex::from_u32(index);",
          "415:     let instance = (*vmctx).instance_mut();",
          "416:     let global = instance.defined_or_imported_global_ptr(index);",
          "417:     match (*global).as_externref().clone() {",
          "418:         None => ptr::null_mut(),",
          "",
          "[Removed Lines]",
          "409:     activations_table.insert_with_gc(externref, module_info_lookup);",
          "",
          "[Added Lines]",
          "410:     activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "417:     let limits = *instance.runtime_limits();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "420:             let raw = externref.as_raw();",
          "421:             let (activations_table, module_info_lookup) =",
          "422:                 (*instance.store()).externref_activations_table();",
          "424:             raw",
          "425:         }",
          "426:     }",
          "",
          "[Removed Lines]",
          "423:             activations_table.insert_with_gc(externref, module_info_lookup);",
          "",
          "[Added Lines]",
          "425:             activations_table.insert_with_gc(limits, externref, module_info_lookup);",
          "",
          "---------------"
        ],
        "crates/runtime/src/traphandlers.rs||crates/runtime/src/traphandlers.rs": [
          "File: crates/runtime/src/traphandlers.rs -> crates/runtime/src/traphandlers.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "249: mod call_thread_state {",
          "250:     use super::*;",
          "",
          "[Removed Lines]",
          "251:     use std::mem;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "263:         prev: Cell<tls::Ptr>,",
          "272:         old_last_wasm_exit_fp: Cell<usize>,",
          "273:         old_last_wasm_exit_pc: Cell<usize>,",
          "274:         old_last_wasm_entry_sp: Cell<usize>,",
          "275:     }",
          "277:     impl CallThreadState {",
          "278:         #[inline]",
          "279:         pub(super) fn new(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "277:     impl Drop for CallThreadState {",
          "278:         fn drop(&mut self) {",
          "279:             unsafe {",
          "283:             }",
          "284:         }",
          "285:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "288:                 capture_backtrace,",
          "289:                 limits,",
          "290:                 prev: Cell::new(ptr::null()),",
          "294:             }",
          "295:         }",
          "",
          "[Removed Lines]",
          "291:                 old_last_wasm_exit_fp: Cell::new(0),",
          "292:                 old_last_wasm_exit_pc: Cell::new(0),",
          "293:                 old_last_wasm_entry_sp: Cell::new(0),",
          "",
          "[Added Lines]",
          "301:                 old_last_wasm_exit_fp: Cell::new(unsafe { *(*limits).last_wasm_exit_fp.get() }),",
          "302:                 old_last_wasm_exit_pc: Cell::new(unsafe { *(*limits).last_wasm_exit_pc.get() }),",
          "303:                 old_last_wasm_entry_sp: Cell::new(unsafe { *(*limits).last_wasm_entry_sp.get() }),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "314:             self.prev.get()",
          "315:         }",
          "394:         }",
          "395:     }",
          "396: }",
          "",
          "[Removed Lines]",
          "322:         pub unsafe fn set_prev(&self, prev: tls::Ptr) -> tls::Ptr {",
          "323:             let old_prev = self.prev.get();",
          "331:             if let Some(old_prev) = old_prev.as_ref() {",
          "335:             }",
          "337:             self.prev.set(prev);",
          "339:             let mut old_last_wasm_exit_fp = 0;",
          "340:             let mut old_last_wasm_exit_pc = 0;",
          "341:             let mut old_last_wasm_entry_sp = 0;",
          "342:             if let Some(prev) = prev.as_ref() {",
          "381:                 old_last_wasm_exit_fp =",
          "382:                     mem::replace(&mut *(*prev.limits).last_wasm_exit_fp.get(), 0);",
          "383:                 old_last_wasm_exit_pc =",
          "384:                     mem::replace(&mut *(*prev.limits).last_wasm_exit_pc.get(), 0);",
          "385:                 old_last_wasm_entry_sp =",
          "386:                     mem::replace(&mut *(*prev.limits).last_wasm_entry_sp.get(), 0);",
          "387:             }",
          "389:             self.old_last_wasm_exit_fp.set(old_last_wasm_exit_fp);",
          "390:             self.old_last_wasm_exit_pc.set(old_last_wasm_exit_pc);",
          "391:             self.old_last_wasm_entry_sp.set(old_last_wasm_entry_sp);",
          "393:             old_prev",
          "",
          "[Added Lines]",
          "327:         pub(crate) unsafe fn push(&self) {",
          "328:             assert!(self.prev.get().is_null());",
          "329:             self.prev.set(tls::raw::replace(self));",
          "330:         }",
          "332:         pub(crate) unsafe fn pop(&self) {",
          "333:             let prev = self.prev.replace(ptr::null());",
          "334:             let head = tls::raw::replace(prev);",
          "335:             assert!(std::ptr::eq(head, self));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "433:                 needs_backtrace: false,",
          "434:                 ..",
          "435:             }) => None,",
          "437:         };",
          "438:         unsafe {",
          "439:             (*self.unwind.get()).as_mut_ptr().write((reason, backtrace));",
          "",
          "[Removed Lines]",
          "436:             UnwindReason::Trap(_) => self.capture_backtrace(None),",
          "",
          "[Added Lines]",
          "378:             UnwindReason::Trap(_) => self.capture_backtrace(self.limits, None),",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "487:     }",
          "489:     fn set_jit_trap(&self, pc: *const u8, fp: usize, faulting_addr: Option<usize>) {",
          "491:         unsafe {",
          "492:             (*self.unwind.get()).as_mut_ptr().write((",
          "493:                 UnwindReason::Trap(TrapReason::Jit {",
          "",
          "[Removed Lines]",
          "490:         let backtrace = self.capture_backtrace(Some((pc as usize, fp)));",
          "",
          "[Added Lines]",
          "432:         let backtrace = self.capture_backtrace(self.limits, Some((pc as usize, fp)));",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "499:         }",
          "500:     }",
          "503:         if !self.capture_backtrace {",
          "504:             return None;",
          "505:         }",
          "508:     }",
          "510:     pub(crate) fn iter<'a>(&'a self) -> impl Iterator<Item = &Self> + 'a {",
          "",
          "[Removed Lines]",
          "502:     fn capture_backtrace(&self, pc_and_fp: Option<(usize, usize)>) -> Option<Backtrace> {",
          "507:         Some(unsafe { Backtrace::new_with_trap_state(self, pc_and_fp) })",
          "",
          "[Added Lines]",
          "444:     fn capture_backtrace(",
          "445:         &self,",
          "446:         limits: *const VMRuntimeLimits,",
          "447:         trap_pc_and_fp: Option<(usize, usize)>,",
          "448:     ) -> Option<Backtrace> {",
          "453:         Some(unsafe { Backtrace::new_with_trap_state(limits, self, trap_pc_and_fp) })",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "534: mod tls {",
          "535:     use super::CallThreadState;",
          "538:     pub use raw::Ptr;",
          "",
          "[Removed Lines]",
          "536:     use std::ptr;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "555:         use super::CallThreadState;",
          "556:         use std::cell::Cell;",
          "557:         use std::ptr;",
          "",
          "[Removed Lines]",
          "554:     mod raw {",
          "",
          "[Added Lines]",
          "499:     pub(super) mod raw {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "626:             let state = raw::get();",
          "627:             if let Some(state) = state.as_ref() {",
          "630:             } else {",
          "",
          "[Removed Lines]",
          "628:                 let prev_state = state.set_prev(ptr::null());",
          "629:                 raw::replace(prev_state);",
          "",
          "[Added Lines]",
          "573:                 state.pop();",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "642:         pub unsafe fn replace(self) {",
          "647:             }",
          "655:         }",
          "656:     }",
          "",
          "[Removed Lines]",
          "645:             if self.state.is_null() {",
          "646:                 return;",
          "651:             let prev = raw::get();",
          "652:             assert!((*self.state).prev().is_null());",
          "653:             (*self.state).set_prev(prev);",
          "654:             raw::replace(self.state);",
          "",
          "[Added Lines]",
          "587:             if let Some(state) = self.state.as_ref() {",
          "588:                 state.push();",
          "589:             } else {",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "668:             #[inline]",
          "669:             fn drop(&mut self) {",
          "670:                 unsafe {",
          "674:                 }",
          "675:             }",
          "676:         }",
          "680:         unsafe {",
          "683:             let reset = Reset { state };",
          "684:             closure(reset.state)",
          "685:         }",
          "",
          "[Removed Lines]",
          "671:                     let prev = self.state.set_prev(ptr::null());",
          "672:                     let old_state = raw::replace(prev);",
          "673:                     debug_assert!(std::ptr::eq(old_state, self.state));",
          "678:         let prev = raw::replace(state);",
          "681:             state.set_prev(prev);",
          "",
          "[Added Lines]",
          "609:                     self.state.pop();",
          "615:             state.push();",
          "",
          "---------------"
        ],
        "crates/runtime/src/traphandlers/backtrace.rs||crates/runtime/src/traphandlers/backtrace.rs": [
          "File: crates/runtime/src/traphandlers/backtrace.rs -> crates/runtime/src/traphandlers/backtrace.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: use cfg_if::cfg_if;",
          "25: use std::ops::ControlFlow;",
          "",
          "[Removed Lines]",
          "23: use crate::traphandlers::{tls, CallThreadState};",
          "",
          "[Added Lines]",
          "23: use crate::{",
          "24:     traphandlers::{tls, CallThreadState},",
          "25:     VMRuntimeLimits,",
          "26: };",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     }",
          "84:         tls::with(|state| match state {",
          "86:             None => Backtrace(vec![]),",
          "87:         })",
          "88:     }",
          "",
          "[Removed Lines]",
          "83:     pub fn new() -> Backtrace {",
          "85:             Some(state) => unsafe { Self::new_with_trap_state(state, None) },",
          "",
          "[Added Lines]",
          "86:     pub fn new(limits: *const VMRuntimeLimits) -> Backtrace {",
          "88:             Some(state) => unsafe { Self::new_with_trap_state(limits, state, None) },",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "95:     pub(crate) unsafe fn new_with_trap_state(",
          "96:         state: &CallThreadState,",
          "97:         trap_pc_and_fp: Option<(usize, usize)>,",
          "98:     ) -> Backtrace {",
          "99:         let mut frames = vec![];",
          "101:             frames.push(frame);",
          "102:             ControlFlow::Continue(())",
          "103:         });",
          "",
          "[Removed Lines]",
          "100:         Self::trace_with_trap_state(state, trap_pc_and_fp, |frame| {",
          "",
          "[Added Lines]",
          "99:         limits: *const VMRuntimeLimits,",
          "104:         Self::trace_with_trap_state(limits, state, trap_pc_and_fp, |frame| {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "105:     }",
          "109:         tls::with(|state| match state {",
          "111:             None => {}",
          "112:         });",
          "113:     }",
          "",
          "[Removed Lines]",
          "108:     pub fn trace(f: impl FnMut(Frame) -> ControlFlow<()>) {",
          "110:             Some(state) => unsafe { Self::trace_with_trap_state(state, None, f) },",
          "",
          "[Added Lines]",
          "112:     pub fn trace(limits: *const VMRuntimeLimits, f: impl FnMut(Frame) -> ControlFlow<()>) {",
          "114:             Some(state) => unsafe { Self::trace_with_trap_state(limits, state, None, f) },",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "120:     pub(crate) unsafe fn trace_with_trap_state(",
          "121:         state: &CallThreadState,",
          "122:         trap_pc_and_fp: Option<(usize, usize)>,",
          "123:         mut f: impl FnMut(Frame) -> ControlFlow<()>,",
          "124:     ) {",
          "125:         log::trace!(\"====== Capturing Backtrace ======\");",
          "126:         let (last_wasm_exit_pc, last_wasm_exit_fp) = match trap_pc_and_fp {",
          "133:             None => {",
          "144:                 (pc, fp)",
          "145:             }",
          "146:         };",
          "151:             last_wasm_exit_pc,",
          "152:             last_wasm_exit_fp,",
          "189:             }",
          "198:                 return;",
          "199:             }",
          "200:         }",
          "203:     }",
          "",
          "[Removed Lines]",
          "130:             Some((pc, fp)) => (pc, fp),",
          "134:                 let pc = *(*state.limits).last_wasm_exit_pc.get();",
          "135:                 let fp = *(*state.limits).last_wasm_exit_fp.get();",
          "137:                 if pc == 0 {",
          "140:                     assert_eq!(fp, 0);",
          "141:                     return;",
          "142:                 }",
          "150:         if let ControlFlow::Break(()) = Self::trace_through_wasm(",
          "154:             &mut f,",
          "155:         ) {",
          "156:             log::trace!(\"====== Done Capturing Backtrace ======\");",
          "157:             return;",
          "158:         }",
          "162:         for state in state.iter() {",
          "167:             if state.prev().is_null() {",
          "168:                 debug_assert_eq!(state.old_last_wasm_exit_pc(), 0);",
          "169:                 debug_assert_eq!(state.old_last_wasm_exit_fp(), 0);",
          "170:                 debug_assert_eq!(state.old_last_wasm_entry_sp(), 0);",
          "171:                 log::trace!(\"====== Done Capturing Backtrace ======\");",
          "172:                 return;",
          "173:             }",
          "185:             if state.old_last_wasm_entry_sp() == 0 {",
          "186:                 debug_assert_eq!(state.old_last_wasm_exit_fp(), 0);",
          "187:                 debug_assert_eq!(state.old_last_wasm_exit_pc(), 0);",
          "188:                 continue;",
          "191:             if let ControlFlow::Break(()) = Self::trace_through_wasm(",
          "192:                 state.old_last_wasm_exit_pc(),",
          "193:                 state.old_last_wasm_exit_fp(),",
          "194:                 state.old_last_wasm_entry_sp(),",
          "195:                 &mut f,",
          "196:             ) {",
          "197:                 log::trace!(\"====== Done Capturing Backtrace ======\");",
          "202:         unreachable!()",
          "",
          "[Added Lines]",
          "125:         limits: *const VMRuntimeLimits,",
          "136:             Some((pc, fp)) => {",
          "137:                 assert!(std::ptr::eq(limits, state.limits));",
          "138:                 (pc, fp)",
          "139:             }",
          "143:                 let pc = *(*limits).last_wasm_exit_pc.get();",
          "144:                 let fp = *(*limits).last_wasm_exit_fp.get();",
          "149:         let activations = std::iter::once((",
          "153:         ))",
          "154:         .chain(",
          "155:             state",
          "156:                 .iter()",
          "157:                 .filter(|state| std::ptr::eq(limits, state.limits))",
          "158:                 .map(|state| {",
          "159:                     (",
          "160:                         state.old_last_wasm_exit_pc(),",
          "161:                         state.old_last_wasm_exit_fp(),",
          "162:                         state.old_last_wasm_entry_sp(),",
          "163:                     )",
          "164:                 }),",
          "165:         )",
          "166:         .take_while(|&(pc, fp, sp)| {",
          "167:             if pc == 0 {",
          "168:                 debug_assert_eq!(fp, 0);",
          "169:                 debug_assert_eq!(sp, 0);",
          "171:             pc != 0",
          "172:         });",
          "174:         for (pc, fp, sp) in activations {",
          "175:             if let ControlFlow::Break(()) = Self::trace_through_wasm(pc, fp, sp, &mut f) {",
          "176:                 log::trace!(\"====== Done Capturing Backtrace (closure break) ======\");",
          "181:         log::trace!(\"====== Done Capturing Backtrace (reached end of activations) ======\");",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/profiling.rs||crates/wasmtime/src/profiling.rs": [
          "File: crates/wasmtime/src/profiling.rs -> crates/wasmtime/src/profiling.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use anyhow::Result;",
          "2: use fxprof_processed_profile::debugid::DebugId;",
          "3: use fxprof_processed_profile::{",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: use crate::{AsContext, Module};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "10: use wasmtime_jit::CompiledModule;",
          "11: use wasmtime_runtime::Backtrace;",
          "",
          "[Removed Lines]",
          "13: use crate::Module;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "133:         let now = Timestamp::from_nanos_since_reference(",
          "134:             self.start.elapsed().as_nanos().try_into().unwrap(),",
          "135:         );",
          "138:         let frames = backtrace",
          "139:             .frames()",
          "",
          "[Removed Lines]",
          "132:     pub fn sample(&mut self) {",
          "137:         let backtrace = Backtrace::new();",
          "",
          "[Added Lines]",
          "131:     pub fn sample(&mut self, store: impl AsContext) {",
          "136:         let backtrace = Backtrace::new(store.as_context().0.vmruntime_limits());",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/store.rs||crates/wasmtime/src/store.rs": [
          "File: crates/wasmtime/src/store.rs -> crates/wasmtime/src/store.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1228:     pub fn gc(&mut self) {",
          "1232:     }",
          "",
          "[Removed Lines]",
          "1231:         unsafe { wasmtime_runtime::gc(&self.modules, &mut self.externref_activations_table) }",
          "",
          "[Added Lines]",
          "1231:         unsafe {",
          "1232:             wasmtime_runtime::gc(",
          "1233:                 self.runtime_limits(),",
          "1234:                 &self.modules,",
          "1235:                 &mut self.externref_activations_table,",
          "1236:             )",
          "1237:         }",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/trap.rs||crates/wasmtime/src/trap.rs": [
          "File: crates/wasmtime/src/trap.rs -> crates/wasmtime/src/trap.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "264:     pub fn force_capture(store: impl AsContext) -> WasmBacktrace {",
          "265:         let store = store.as_context();",
          "267:     }",
          "269:     fn from_captured(",
          "",
          "[Removed Lines]",
          "266:         Self::from_captured(store.0, wasmtime_runtime::Backtrace::new(), None)",
          "",
          "[Added Lines]",
          "266:         Self::from_captured(",
          "267:             store.0,",
          "268:             wasmtime_runtime::Backtrace::new(store.0.runtime_limits()),",
          "269:             None,",
          "270:         )",
          "",
          "---------------"
        ],
        "src/commands/run.rs||src/commands/run.rs": [
          "File: src/commands/run.rs -> src/commands/run.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: use std::thread;",
          "11: use std::time::Duration;",
          "12: use wasmtime::{",
          "15: };",
          "16: use wasmtime_cli_flags::{CommonOptions, WasiModules};",
          "17: use wasmtime_wasi::maybe_exit_on_error;",
          "",
          "[Removed Lines]",
          "13:     Engine, Func, GuestProfiler, Linker, Module, Store, StoreLimits, StoreLimitsBuilder, Val,",
          "14:     ValType,",
          "",
          "[Added Lines]",
          "13:     AsContextMut, Engine, Func, GuestProfiler, Linker, Module, Store, StoreLimits,",
          "14:     StoreLimitsBuilder, Val, ValType,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "403:             store.data_mut().guest_profiler =",
          "404:                 Some(Arc::new(GuestProfiler::new(module_name, interval, modules)));",
          "406:             if let Some(timeout) = self.wasm_timeout {",
          "407:                 let mut timeout = (timeout.as_secs_f64() / interval.as_secs_f64()).ceil() as u64;",
          "408:                 assert!(timeout > 0);",
          "409:                 store.epoch_deadline_callback(move |mut store| {",
          "413:                     timeout -= 1;",
          "414:                     if timeout == 0 {",
          "415:                         bail!(\"timeout exceeded\");",
          "",
          "[Removed Lines]",
          "410:                     Arc::get_mut(store.data_mut().guest_profiler.as_mut().unwrap())",
          "411:                         .expect(\"profiling doesn't support threads yet\")",
          "412:                         .sample();",
          "",
          "[Added Lines]",
          "406:             fn sample(mut store: impl AsContextMut<Data = Host>) {",
          "407:                 let mut profiler = store",
          "408:                     .as_context_mut()",
          "409:                     .data_mut()",
          "410:                     .guest_profiler",
          "411:                     .take()",
          "412:                     .unwrap();",
          "413:                 Arc::get_mut(&mut profiler)",
          "414:                     .expect(\"profiling doesn't support threads yet\")",
          "415:                     .sample(&store);",
          "416:                 store.as_context_mut().data_mut().guest_profiler = Some(profiler);",
          "417:             }",
          "423:                     sample(&mut store);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "418:                 });",
          "419:             } else {",
          "420:                 store.epoch_deadline_callback(move |mut store| {",
          "424:                     Ok(1)",
          "425:                 });",
          "426:             }",
          "",
          "[Removed Lines]",
          "421:                     Arc::get_mut(store.data_mut().guest_profiler.as_mut().unwrap())",
          "422:                         .expect(\"profiling doesn't support threads yet\")",
          "423:                         .sample();",
          "",
          "[Added Lines]",
          "432:                     sample(&mut store);",
          "",
          "---------------"
        ],
        "tests/all/async_functions.rs||tests/all/async_functions.rs": [
          "File: tests/all/async_functions.rs -> tests/all/async_functions.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use anyhow::{anyhow, bail, Result};",
          "2: use std::future::Future;",
          "3: use std::pin::Pin;",
          "4: use std::task::{Context, Poll, RawWaker, RawWakerVTable, Waker};",
          "5: use wasmtime::*;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4: use std::sync::{Arc, Mutex};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "706:     const RAW: RawWaker = RawWaker::new(0 as *const (), &VTABLE);",
          "707:     unsafe { Waker::from_raw(RAW) }",
          "708: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "711: #[tokio::test]",
          "712: async fn non_stacky_async_activations() -> Result<()> {",
          "713:     let mut config = Config::new();",
          "714:     config.async_support(true);",
          "715:     let engine = Engine::new(&config)?;",
          "716:     let mut store1: Store<Option<Pin<Box<dyn Future<Output = Result<()>> + Send>>>> =",
          "717:         Store::new(&engine, None);",
          "718:     let mut linker1 = Linker::new(&engine);",
          "720:     let module1 = Module::new(",
          "721:         &engine,",
          "722:         r#\"",
          "723:             (module $m1",
          "724:                 (import \"\" \"host_capture_stack\" (func $host_capture_stack))",
          "725:                 (import \"\" \"start_async_instance\" (func $start_async_instance))",
          "726:                 (func $capture_stack (export \"capture_stack\")",
          "727:                     call $host_capture_stack",
          "728:                 )",
          "729:                 (func $run_sync (export \"run_sync\")",
          "730:                     call $start_async_instance",
          "731:                 )",
          "732:             )",
          "733:         \"#,",
          "734:     )?;",
          "736:     let module2 = Module::new(",
          "737:         &engine,",
          "738:         r#\"",
          "739:             (module $m2",
          "740:                 (import \"\" \"yield\" (func $yield))",
          "742:                 (func $run_async (export \"run_async\")",
          "743:                     call $yield",
          "744:                 )",
          "745:             )",
          "746:         \"#,",
          "747:     )?;",
          "749:     let stacks = Arc::new(Mutex::new(vec![]));",
          "750:     fn capture_stack(stacks: &Arc<Mutex<Vec<WasmBacktrace>>>, store: impl AsContext) {",
          "751:         let mut stacks = stacks.lock().unwrap();",
          "752:         stacks.push(wasmtime::WasmBacktrace::force_capture(store));",
          "753:     }",
          "755:     linker1.func_wrap0_async(\"\", \"host_capture_stack\", {",
          "756:         let stacks = stacks.clone();",
          "757:         move |caller| {",
          "758:             capture_stack(&stacks, &caller);",
          "759:             Box::new(async { Ok(()) })",
          "760:         }",
          "761:     })?;",
          "763:     linker1.func_wrap0_async(\"\", \"start_async_instance\", {",
          "764:         let stacks = stacks.clone();",
          "765:         move |mut caller| {",
          "766:             let stacks = stacks.clone();",
          "767:             capture_stack(&stacks, &caller);",
          "769:             let module2 = module2.clone();",
          "770:             let mut store2 = Store::new(caller.engine(), ());",
          "771:             let mut linker2 = Linker::new(caller.engine());",
          "772:             linker2",
          "773:                 .func_wrap0_async(\"\", \"yield\", {",
          "774:                     let stacks = stacks.clone();",
          "775:                     move |caller| {",
          "776:                         let stacks = stacks.clone();",
          "777:                         Box::new(async move {",
          "778:                             capture_stack(&stacks, &caller);",
          "779:                             tokio::task::yield_now().await;",
          "780:                             capture_stack(&stacks, &caller);",
          "781:                             Ok(())",
          "782:                         })",
          "783:                     }",
          "784:                 })",
          "785:                 .unwrap();",
          "787:             Box::new(async move {",
          "788:                 let future = PollOnce::new(Box::pin({",
          "789:                     let stacks = stacks.clone();",
          "790:                     async move {",
          "791:                         let instance2 = linker2.instantiate_async(&mut store2, &module2).await?;",
          "793:                         instance2",
          "794:                             .get_func(&mut store2, \"run_async\")",
          "795:                             .unwrap()",
          "796:                             .call_async(&mut store2, &[], &mut [])",
          "797:                             .await?;",
          "799:                         capture_stack(&stacks, &store2);",
          "800:                         Ok(())",
          "801:                     }",
          "802:                 }) as _)",
          "803:                 .await;",
          "804:                 capture_stack(&stacks, &caller);",
          "806:                 Ok(())",
          "807:             })",
          "808:         }",
          "809:     })?;",
          "811:     let instance1 = linker1.instantiate_async(&mut store1, &module1).await?;",
          "812:     instance1",
          "813:         .get_typed_func::<(), ()>(&mut store1, \"run_sync\")?",
          "814:         .call_async(&mut store1, ())",
          "815:         .await?;",
          "816:     let future = store1.data_mut().take().unwrap();",
          "817:     future.await?;",
          "819:     instance1",
          "820:         .get_typed_func::<(), ()>(&mut store1, \"capture_stack\")?",
          "821:         .call_async(&mut store1, ())",
          "822:         .await?;",
          "824:     let stacks = stacks.lock().unwrap();",
          "825:     eprintln!(\"stacks = {stacks:#?}\");",
          "827:     assert_eq!(stacks.len(), 6);",
          "828:     for (actual, expected) in stacks.iter().zip(vec![",
          "829:         vec![\"run_sync\"],",
          "830:         vec![\"run_async\"],",
          "831:         vec![\"run_sync\"],",
          "832:         vec![\"run_async\"],",
          "833:         vec![],",
          "834:         vec![\"capture_stack\"],",
          "835:     ]) {",
          "836:         eprintln!(\"expected = {expected:?}\");",
          "837:         eprintln!(\"actual = {actual:?}\");",
          "838:         assert_eq!(actual.frames().len(), expected.len());",
          "839:         for (actual, expected) in actual.frames().iter().zip(expected) {",
          "840:             assert_eq!(actual.func_name(), Some(expected));",
          "841:         }",
          "842:     }",
          "844:     Ok(())",
          "845: }",
          "",
          "---------------"
        ],
        "tests/all/traps.rs||tests/all/traps.rs": [
          "File: tests/all/traps.rs -> tests/all/traps.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use anyhow::{bail, Error, Result};",
          "2: use std::panic::{self, AssertUnwindSafe};",
          "3: use std::process::Command;",
          "4: use wasmtime::*;",
          "6: #[test]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4: use std::sync::{Arc, Mutex};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1469:     Ok(())",
          "1470: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1473: #[test]",
          "1474: fn dont_see_stale_stack_walking_registers() -> Result<()> {",
          "1475:     let engine = Engine::default();",
          "1477:     let module = Module::new(",
          "1478:         &engine,",
          "1479:         r#\"",
          "1480:             (module",
          "1481:                 (import \"\" \"host_start\" (func $host_start))",
          "1482:                 (import \"\" \"host_get_trap\" (func $host_get_trap))",
          "1483:                 (export \"get_trap\" (func $host_get_trap))",
          "1485:                 ;; We enter and exit Wasm, which saves registers in the",
          "1486:                 ;; `VMRuntimeLimits`. Later, when we call a re-exported host",
          "1487:                 ;; function, we should not accidentally reuse those saved",
          "1488:                 ;; registers.",
          "1489:                 (start $start)",
          "1490:                 (func $start",
          "1491:                     (call $host_start)",
          "1492:                 )",
          "1493:             )",
          "1494:         \"#,",
          "1495:     )?;",
          "1497:     let mut store = Store::new(&engine, ());",
          "1498:     let mut linker = Linker::new(&engine);",
          "1500:     let host_start = Func::new(",
          "1501:         &mut store,",
          "1502:         FuncType::new([], []),",
          "1503:         |_caller, _args, _results| Ok(()),",
          "1504:     );",
          "1505:     linker.define(&store, \"\", \"host_start\", host_start)?;",
          "1507:     let host_get_trap = Func::new(",
          "1508:         &mut store,",
          "1509:         FuncType::new([], []),",
          "1510:         |_caller, _args, _results| Err(anyhow::anyhow!(\"trap!!!\")),",
          "1511:     );",
          "1512:     linker.define(&store, \"\", \"host_get_trap\", host_get_trap)?;",
          "1514:     let instance = linker.instantiate(&mut store, &module)?;",
          "1515:     let get_trap = instance.get_func(&mut store, \"get_trap\").unwrap();",
          "1517:     let err = get_trap.call(&mut store, &[], &mut []).unwrap_err();",
          "1518:     assert!(err.to_string().contains(\"trap!!!\"));",
          "1520:     Ok(())",
          "1521: }",
          "1523: #[test]",
          "1524: fn same_module_multiple_stores() -> Result<()> {",
          "1525:     let _ = env_logger::try_init();",
          "1527:     let engine = Engine::default();",
          "1529:     let module = Module::new(",
          "1530:         &engine,",
          "1531:         r#\"",
          "1532:             (module",
          "1533:                 (import \"\" \"f\" (func $f))",
          "1534:                 (import \"\" \"call_ref\" (func $call_ref (param funcref)))",
          "1535:                 (global $g (mut i32) (i32.const 0))",
          "1536:                 (func $a (export \"a\")",
          "1537:                     call $b",
          "1538:                 )",
          "1539:                 (func $b",
          "1540:                     call $c",
          "1541:                 )",
          "1542:                 (func $c",
          "1543:                     global.get $g",
          "1544:                     if",
          "1545:                         call $f",
          "1546:                     else",
          "1547:                         i32.const 1",
          "1548:                         global.set $g",
          "1549:                         ref.func $a",
          "1550:                         call $call_ref",
          "1551:                     end",
          "1552:                 )",
          "1553:             )",
          "1554:         \"#,",
          "1555:     )?;",
          "1557:     let stacks = Arc::new(Mutex::new(vec![]));",
          "1559:     let mut store3 = Store::new(&engine, ());",
          "1560:     let f3 = Func::new(&mut store3, FuncType::new([], []), {",
          "1561:         let stacks = stacks.clone();",
          "1562:         move |caller, _params, _results| {",
          "1563:             stacks",
          "1564:                 .lock()",
          "1565:                 .unwrap()",
          "1566:                 .push(WasmBacktrace::force_capture(caller));",
          "1567:             Ok(())",
          "1568:         }",
          "1569:     });",
          "1570:     let call_ref3 = Func::wrap(&mut store3, |caller: Caller<'_, _>, f: Option<Func>| {",
          "1571:         f.unwrap().call(caller, &[], &mut [])",
          "1572:     });",
          "1573:     let instance3 = Instance::new(&mut store3, &module, &[f3.into(), call_ref3.into()])?;",
          "1575:     let mut store2 = Store::new(&engine, store3);",
          "1576:     let f2 = Func::new(&mut store2, FuncType::new([], []), {",
          "1577:         let stacks = stacks.clone();",
          "1578:         move |mut caller, _params, _results| {",
          "1579:             stacks",
          "1580:                 .lock()",
          "1581:                 .unwrap()",
          "1582:                 .push(WasmBacktrace::force_capture(&mut caller));",
          "1583:             instance3",
          "1584:                 .get_typed_func::<(), ()>(caller.data_mut(), \"a\")",
          "1585:                 .unwrap()",
          "1586:                 .call(caller.data_mut(), ())",
          "1587:                 .unwrap();",
          "1588:             Ok(())",
          "1589:         }",
          "1590:     });",
          "1591:     let call_ref2 = Func::wrap(&mut store2, |caller: Caller<'_, _>, f: Option<Func>| {",
          "1592:         f.unwrap().call(caller, &[], &mut [])",
          "1593:     });",
          "1594:     let instance2 = Instance::new(&mut store2, &module, &[f2.into(), call_ref2.into()])?;",
          "1596:     let mut store1 = Store::new(&engine, store2);",
          "1597:     let f1 = Func::new(&mut store1, FuncType::new([], []), {",
          "1598:         let stacks = stacks.clone();",
          "1599:         move |mut caller, _params, _results| {",
          "1600:             stacks",
          "1601:                 .lock()",
          "1602:                 .unwrap()",
          "1603:                 .push(WasmBacktrace::force_capture(&mut caller));",
          "1604:             instance2",
          "1605:                 .get_typed_func::<(), ()>(caller.data_mut(), \"a\")",
          "1606:                 .unwrap()",
          "1607:                 .call(caller.data_mut(), ())",
          "1608:                 .unwrap();",
          "1609:             Ok(())",
          "1610:         }",
          "1611:     });",
          "1612:     let call_ref1 = Func::wrap(&mut store1, |caller: Caller<'_, _>, f: Option<Func>| {",
          "1613:         f.unwrap().call(caller, &[], &mut [])",
          "1614:     });",
          "1615:     let instance1 = Instance::new(&mut store1, &module, &[f1.into(), call_ref1.into()])?;",
          "1617:     instance1",
          "1618:         .get_typed_func(&mut store1, \"a\")?",
          "1619:         .call(&mut store1, ())?;",
          "1621:     let expected_stacks = vec![",
          "1623:         vec![\"c\", \"b\", \"a\", \"c\", \"b\", \"a\"],",
          "1625:         vec![\"c\", \"b\", \"a\", \"c\", \"b\", \"a\"],",
          "1627:         vec![\"c\", \"b\", \"a\", \"c\", \"b\", \"a\"],",
          "1628:     ];",
          "1629:     eprintln!(\"expected = {expected_stacks:#?}\");",
          "1630:     let actual_stacks = stacks.lock().unwrap();",
          "1631:     eprintln!(\"actaul = {actual_stacks:#?}\");",
          "1633:     assert_eq!(actual_stacks.len(), expected_stacks.len());",
          "1634:     for (expected_stack, actual_stack) in expected_stacks.into_iter().zip(actual_stacks.iter()) {",
          "1635:         assert_eq!(expected_stack.len(), actual_stack.frames().len());",
          "1636:         for (expected_frame, actual_frame) in expected_stack.into_iter().zip(actual_stack.frames())",
          "1637:         {",
          "1638:             assert_eq!(actual_frame.func_name(), Some(expected_frame));",
          "1639:         }",
          "1640:     }",
          "1642:     Ok(())",
          "1643: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dd0364d367c579abc8f572d2a056aca6cd286887",
      "candidate_info": {
        "commit_hash": "dd0364d367c579abc8f572d2a056aca6cd286887",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/dd0364d367c579abc8f572d2a056aca6cd286887",
        "files": [
          ".github/workflows/main.yml",
          "crates/c-api/Cargo.toml",
          "crates/cli-flags/Cargo.toml",
          "crates/cranelift/Cargo.toml",
          "crates/cranelift/src/func_environ.rs",
          "crates/environ/Cargo.toml",
          "crates/environ/src/builtin.rs",
          "crates/fuzzing/Cargo.toml",
          "crates/runtime/Cargo.toml",
          "crates/runtime/src/externref.rs",
          "crates/runtime/src/externref/gc.rs",
          "crates/runtime/src/externref/no_gc.rs",
          "crates/runtime/src/instance.rs",
          "crates/runtime/src/libcalls.rs",
          "crates/runtime/src/table.rs",
          "crates/runtime/src/vmcontext.rs",
          "crates/wasmtime/Cargo.toml",
          "crates/wasmtime/src/config.rs",
          "crates/wasmtime/src/engine/serialization.rs",
          "crates/wasmtime/src/runtime.rs",
          "crates/wasmtime/src/runtime/externals/global.rs",
          "crates/wasmtime/src/runtime/externals/table.rs",
          "crates/wasmtime/src/runtime/func.rs",
          "crates/wasmtime/src/runtime/func/typed.rs",
          "crates/wasmtime/src/runtime/module/registry.rs",
          "crates/wasmtime/src/runtime/ref.rs",
          "crates/wasmtime/src/runtime/ref/gc_ref.rs",
          "crates/wasmtime/src/runtime/ref/no_gc_ref.rs",
          "crates/wasmtime/src/runtime/store.rs",
          "crates/wasmtime/src/runtime/trampoline/global.rs",
          "crates/wasmtime/src/runtime/uninhabited.rs",
          "crates/wasmtime/src/runtime/values.rs",
          "crates/wast/Cargo.toml",
          "winch/codegen/src/codegen/builtin.rs",
          "winch/filetests/filetests/x64/table/fill.wat"
        ],
        "message": "Wasmtime: Add a `gc` cargo feature (#7975)\n\n* Wasmtime: Add a `gc` cargo feature\n\nThis controls whether support for `ExternRef` and its associated deferred,\nreference-counting garbage collector is enabled at compile time or not. It will\nalso be used for similarly for Wasmtime's full Wasm GC support as that gets\nadded.\n\n* Add CI for `gc` Cargo feature\n\n* Cut down on the number of `#[cfg(feature = \"gc\")]`s outside the implementation of `[VM]ExternRef`\n\n* Fix wasmparser reference types configuration with GC disabled/enabled\n\n* More config fix\n\n* doc cfg\n\n* Make the dummy `VMExternRefActivationsTable` inhabited\n\n* Fix winch tests\n\n* final review bits\n\n* Enable wasmtime's gc cargo feature for the C API\n\n* Enable wasmtime's gc cargo feature from wasmtime-cli-flags\n\n* enable gc cargo feature in a couple other crates",
        "before_after_code_files": [
          "crates/cranelift/src/func_environ.rs||crates/cranelift/src/func_environ.rs",
          "crates/environ/src/builtin.rs||crates/environ/src/builtin.rs",
          "crates/runtime/src/externref.rs||crates/runtime/src/externref.rs",
          "crates/runtime/src/externref/gc.rs||crates/runtime/src/externref/gc.rs",
          "crates/runtime/src/externref/no_gc.rs||crates/runtime/src/externref/no_gc.rs",
          "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
          "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs",
          "crates/runtime/src/table.rs||crates/runtime/src/table.rs",
          "crates/runtime/src/vmcontext.rs||crates/runtime/src/vmcontext.rs",
          "crates/wasmtime/src/config.rs||crates/wasmtime/src/config.rs",
          "crates/wasmtime/src/engine/serialization.rs||crates/wasmtime/src/engine/serialization.rs",
          "crates/wasmtime/src/runtime.rs||crates/wasmtime/src/runtime.rs",
          "crates/wasmtime/src/runtime/externals/global.rs||crates/wasmtime/src/runtime/externals/global.rs",
          "crates/wasmtime/src/runtime/externals/table.rs||crates/wasmtime/src/runtime/externals/table.rs",
          "crates/wasmtime/src/runtime/func.rs||crates/wasmtime/src/runtime/func.rs",
          "crates/wasmtime/src/runtime/func/typed.rs||crates/wasmtime/src/runtime/func/typed.rs",
          "crates/wasmtime/src/runtime/module/registry.rs||crates/wasmtime/src/runtime/module/registry.rs",
          "crates/wasmtime/src/runtime/ref.rs||crates/wasmtime/src/runtime/ref.rs",
          "crates/wasmtime/src/runtime/ref/gc_ref.rs||crates/wasmtime/src/runtime/ref/gc_ref.rs",
          "crates/wasmtime/src/runtime/ref/no_gc_ref.rs||crates/wasmtime/src/runtime/ref/no_gc_ref.rs",
          "crates/wasmtime/src/runtime/store.rs||crates/wasmtime/src/runtime/store.rs",
          "crates/wasmtime/src/runtime/trampoline/global.rs||crates/wasmtime/src/runtime/trampoline/global.rs",
          "crates/wasmtime/src/runtime/uninhabited.rs||crates/wasmtime/src/runtime/uninhabited.rs",
          "crates/wasmtime/src/runtime/values.rs||crates/wasmtime/src/runtime/values.rs",
          "winch/codegen/src/codegen/builtin.rs||winch/codegen/src/codegen/builtin.rs",
          "winch/filetests/filetests/x64/table/fill.wat||winch/filetests/filetests/x64/table/fill.wat"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs"
          ],
          "candidate": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs"
          ]
        }
      },
      "candidate_diff": {
        "crates/cranelift/src/func_environ.rs||crates/cranelift/src/func_environ.rs": [
          "File: crates/cranelift/src/func_environ.rs -> crates/cranelift/src/func_environ.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:     ) => {",
          "37:         struct BuiltinFunctionSignatures {",
          "38:             pointer_type: ir::Type,",
          "39:             reference_type: ir::Type,",
          "40:             call_conv: isa::CallConv,",
          "41:             $(",
          "42:                 $name: Option<ir::SigRef>,",
          "43:             )*",
          "44:         }",
          "46:         impl BuiltinFunctionSignatures {",
          "47:             fn new(",
          "48:                 pointer_type: ir::Type,",
          "49:                 reference_type: ir::Type,",
          "50:                 call_conv: isa::CallConv,",
          "51:             ) -> Self {",
          "52:                 Self {",
          "53:                     pointer_type,",
          "54:                     reference_type,",
          "55:                     call_conv,",
          "56:                     $(",
          "57:                         $name: None,",
          "58:                     )*",
          "59:                 }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37:         #[allow(unused_doc_comments)]",
          "41:             #[cfg(feature = \"gc\")]",
          "47:                 $( #[$attr] )*",
          "52:         #[allow(unused_doc_comments)]",
          "59:                 #[cfg(not(feature = \"gc\"))]",
          "60:                 let _ = reference_type;",
          "65:                     #[cfg(feature = \"gc\")]",
          "71:                         $( #[$attr] )*",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "63:                 AbiParam::special(self.pointer_type, ArgumentPurpose::VMContext)",
          "64:             }",
          "66:             fn reference(&self) -> AbiParam {",
          "67:                 AbiParam::new(self.reference_type)",
          "68:             }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:             #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "89:             }",
          "91:             $(",
          "92:                 fn $name(&mut self, func: &mut Function) -> ir::SigRef {",
          "93:                     let sig = self.$name.unwrap_or_else(|| {",
          "94:                         func.import_signature(Signature {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:                 $( #[$attr] )*",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "339:     fn mutate_externref_ref_count(",
          "340:         &mut self,",
          "341:         builder: &mut FunctionBuilder,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "356:     #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1324:                     self.builtin_function_signatures",
          "1325:                         .table_grow_func_ref(&mut pos.func),",
          "1326:                 ),",
          "1327:                 WasmHeapType::Extern => (",
          "1328:                     BuiltinFunctionIndex::table_grow_externref(),",
          "1329:                     self.builtin_function_signatures",
          "1330:                         .table_grow_externref(&mut pos.func),",
          "1331:                 ),",
          "1332:             };",
          "1334:         let (vmctx, func_addr) = self.translate_load_builtin_function_address(&mut pos, func_idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1345:                 #[cfg(feature = \"gc\")]",
          "1351:                 #[cfg(not(feature = \"gc\"))]",
          "1352:                 WasmHeapType::Extern => {",
          "1353:                     return Err(cranelift_wasm::wasm_unsupported!(",
          "1354:                         \"support for `externref` disabled at compile time because \\",
          "1355:                      the `gc` cargo feature was not enabled\",",
          "1356:                     ))",
          "1357:                 }",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1350:         table: ir::Table,",
          "1351:         index: ir::Value,",
          "1352:     ) -> WasmResult<ir::Value> {",
          "1355:         let plan = &self.module.table_plans[table_index];",
          "1356:         match plan.table.wasm_ty.heap_type {",
          "1357:             WasmHeapType::Func | WasmHeapType::Concrete(_) | WasmHeapType::NoFunc => match plan",
          "",
          "[Removed Lines]",
          "1353:         let pointer_type = self.pointer_type();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1361:                     Ok(self.get_or_init_func_ref_table_elem(builder, table_index, table, index))",
          "1362:                 }",
          "1363:             },",
          "1364:             WasmHeapType::Extern => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1388:             #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1385:                 let reference_type = self.reference_type(WasmHeapType::Extern);",
          "1387:                 builder.ensure_inserted_block();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1410:                 let pointer_type = self.pointer_type();",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1478:                 Ok(elem)",
          "1479:             }",
          "1480:         }",
          "1481:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1506:             #[cfg(not(feature = \"gc\"))]",
          "1507:             WasmHeapType::Extern => {",
          "1508:                 return Err(cranelift_wasm::wasm_unsupported!(",
          "1509:                     \"support for `externref` disabled at compile time because the \\",
          "1510:                  `gc` cargo feature was not enabled\",",
          "1511:                 ))",
          "1512:             }",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1510:                 }",
          "1511:             },",
          "1513:             WasmHeapType::Extern => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1546:             #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1641:                 Ok(())",
          "1642:             }",
          "1643:         }",
          "1644:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1678:             #[cfg(not(feature = \"gc\"))]",
          "1679:             WasmHeapType::Extern => {",
          "1680:                 return Err(cranelift_wasm::wasm_unsupported!(",
          "1681:                     \"support for `externref` disabled at compile time because the \\",
          "1682:                      `gc` cargo feature was not enabled\",",
          "1683:                 ))",
          "1684:             }",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1658:                     self.builtin_function_signatures",
          "1659:                         .table_fill_func_ref(&mut pos.func),",
          "1660:                 ),",
          "1661:                 WasmHeapType::Extern => (",
          "1662:                     BuiltinFunctionIndex::table_fill_externref(),",
          "1663:                     self.builtin_function_signatures",
          "1664:                         .table_fill_externref(&mut pos.func),",
          "1665:                 ),",
          "1666:             };",
          "1668:         let (vmctx, builtin_addr) =",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1703:                 #[cfg(feature = \"gc\")]",
          "1709:                 #[cfg(not(feature = \"gc\"))]",
          "1710:                 WasmHeapType::Extern => {",
          "1711:                     return Err(cranelift_wasm::wasm_unsupported!(",
          "1712:                         \"support for `externref` disabled at compile time because the \\",
          "1713:                          `gc` cargo feature was not enabled\",",
          "1714:                     ));",
          "1715:                 }",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1727:         Ok(pos.func.dfg.first_result(call_inst))",
          "1728:     }",
          "1730:     fn translate_custom_global_get(",
          "1731:         &mut self,",
          "1732:         mut pos: cranelift_codegen::cursor::FuncCursor<'_>,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1780:     #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1754:         Ok(pos.func.dfg.first_result(call_inst))",
          "1755:     }",
          "1757:     fn translate_custom_global_set(",
          "1758:         &mut self,",
          "1759:         mut pos: cranelift_codegen::cursor::FuncCursor<'_>,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1808:     #[cfg(not(feature = \"gc\"))]",
          "1809:     fn translate_custom_global_get(",
          "1810:         &mut self,",
          "1811:         _pos: FuncCursor,",
          "1812:         index: GlobalIndex,",
          "1813:     ) -> WasmResult<ir::Value> {",
          "1814:         debug_assert_eq!(",
          "1815:             self.module.globals[index].wasm_ty,",
          "1816:             WasmValType::Ref(WasmRefType::EXTERNREF),",
          "1817:             \"We only use GlobalVariable::Custom for externref\"",
          "1818:         );",
          "1819:         Err(cranelift_wasm::wasm_unsupported!(",
          "1820:             \"support for `externref` disabled at compile time because the \\",
          "1821:              `gc` cargo feature was not enabled\",",
          "1822:         ))",
          "1823:     }",
          "1825:     #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1781:         Ok(())",
          "1782:     }",
          "1784:     fn make_heap(&mut self, func: &mut ir::Function, index: MemoryIndex) -> WasmResult<Heap> {",
          "1785:         let pointer_type = self.pointer_type();",
          "1786:         let is_shared = self.module.memory_plans[index].memory.shared;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1853:     #[cfg(not(feature = \"gc\"))]",
          "1854:     fn translate_custom_global_set(",
          "1855:         &mut self,",
          "1856:         _pos: FuncCursor,",
          "1857:         index: GlobalIndex,",
          "1858:         _value: ir::Value,",
          "1859:     ) -> WasmResult<()> {",
          "1860:         debug_assert_eq!(",
          "1861:             self.module.globals[index].wasm_ty,",
          "1862:             WasmValType::Ref(WasmRefType::EXTERNREF),",
          "1863:             \"We only use GlobalVariable::Custom for externref\"",
          "1864:         );",
          "1865:         Err(cranelift_wasm::wasm_unsupported!(",
          "1866:             \"support for `externref` disabled at compile time because the \\",
          "1867:              `gc` cargo feature was not enabled\",",
          "1868:         ))",
          "1869:     }",
          "",
          "---------------"
        ],
        "crates/environ/src/builtin.rs||crates/environ/src/builtin.rs": [
          "File: crates/environ/src/builtin.rs -> crates/environ/src/builtin.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "26:             table_get_lazy_init_func_ref(vmctx: vmctx, table: i32, index: i32) -> pointer;",
          "28:             table_grow_func_ref(vmctx: vmctx, table: i32, delta: i32, init: pointer) -> i32;",
          "34:             table_fill_func_ref(vmctx: vmctx, table: i32, dst: i32, val: pointer, len: i32);",
          "45:             memory_atomic_notify(vmctx: vmctx, memory: i32, addr: i64, count: i32) -> i32;",
          "",
          "[Removed Lines]",
          "30:             table_grow_externref(vmctx: vmctx, table: i32, delta: i32, init: reference) -> i32;",
          "32:             table_fill_externref(vmctx: vmctx, table: i32, dst: i32, val: reference, len: i32);",
          "36:             drop_externref(vmctx: vmctx, val: pointer);",
          "39:             activations_table_insert_with_gc(vmctx: vmctx, val: reference);",
          "41:             externref_global_get(vmctx: vmctx, global: i32) -> reference;",
          "43:             externref_global_set(vmctx: vmctx, global: i32, val: reference);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "67:             update_stack_pointer(vmctx: vmctx, value: i32);",
          "69:             update_mem_size(vmctx: vmctx, num_bytes: i32);",
          "70:         }",
          "71:     };",
          "72: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:             #[cfg(feature = \"gc\")]",
          "60:             drop_externref(vmctx: vmctx, val: pointer);",
          "64:             #[cfg(feature = \"gc\")]",
          "65:             activations_table_insert_with_gc(vmctx: vmctx, val: reference);",
          "68:             #[cfg(feature = \"gc\")]",
          "69:             externref_global_get(vmctx: vmctx, global: i32) -> reference;",
          "72:             #[cfg(feature = \"gc\")]",
          "73:             externref_global_set(vmctx: vmctx, global: i32, val: reference);",
          "76:             #[cfg(feature = \"gc\")]",
          "77:             table_grow_externref(vmctx: vmctx, table: i32, delta: i32, init: reference) -> i32;",
          "80:             #[cfg(feature = \"gc\")]",
          "81:             table_fill_externref(vmctx: vmctx, table: i32, dst: i32, val: reference, len: i32);",
          "",
          "---------------"
        ],
        "crates/runtime/src/externref.rs||crates/runtime/src/externref.rs": [
          "File: crates/runtime/src/externref.rs -> crates/runtime/src/externref.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "102: use crate::{Backtrace, SendSyncPtr, VMRuntimeLimits};",
          "103: use std::alloc::Layout;",
          "104: use std::any::Any;",
          "105: use std::cell::UnsafeCell;",
          "106: use std::cmp;",
          "107: use std::collections::HashSet;",
          "108: use std::hash::{Hash, Hasher};",
          "109: use std::mem;",
          "110: use std::ops::Deref;",
          "111: use std::ptr::{self, NonNull};",
          "112: use std::sync::atomic::{self, AtomicUsize, Ordering};",
          "113: use wasmtime_environ::StackMap;",
          "165: #[derive(Debug)]",
          "166: #[repr(transparent)]",
          "167: pub struct VMExternRef(SendSyncPtr<VMExternData>);",
          "169: impl std::fmt::Pointer for VMExternRef {",
          "170:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "171:         std::fmt::Pointer::fmt(&self.0, f)",
          "172:     }",
          "173: }",
          "175: #[repr(C)]",
          "176: pub(crate) struct VMExternData {",
          "190:     ref_count: AtomicUsize,",
          "194:     value_ptr: SendSyncPtr<dyn Any + Send + Sync>,",
          "195: }",
          "197: impl Clone for VMExternRef {",
          "198:     #[inline]",
          "199:     fn clone(&self) -> VMExternRef {",
          "200:         self.extern_data().increment_ref_count();",
          "201:         VMExternRef(self.0)",
          "202:     }",
          "203: }",
          "205: impl Drop for VMExternRef {",
          "206:     #[inline]",
          "207:     fn drop(&mut self) {",
          "208:         let data = self.extern_data();",
          "217:         if data.ref_count.fetch_sub(1, Ordering::Release) != 1 {",
          "218:             return;",
          "219:         }",
          "220:         atomic::fence(Ordering::Acquire);",
          "222:         unsafe {",
          "223:             VMExternData::drop_and_dealloc(self.0);",
          "224:         }",
          "225:     }",
          "226: }",
          "228: impl VMExternData {",
          "236:     unsafe fn layout_for(value_size: usize, value_align: usize) -> (Layout, usize) {",
          "237:         let extern_data_size = mem::size_of::<VMExternData>();",
          "238:         let extern_data_align = mem::align_of::<VMExternData>();",
          "240:         let value_and_padding_size = round_up_to_align(value_size, extern_data_align).unwrap();",
          "242:         let alloc_align = std::cmp::max(value_align, extern_data_align);",
          "243:         let alloc_size = value_and_padding_size + extern_data_size;",
          "245:         debug_assert!(",
          "246:             Layout::from_size_align(alloc_size, alloc_align).is_ok(),",
          "247:             \"should create a `Layout` for size={} and align={} okay\",",
          "248:             alloc_size,",
          "249:             alloc_align,",
          "250:         );",
          "251:         (",
          "252:             Layout::from_size_align_unchecked(alloc_size, alloc_align),",
          "253:             value_and_padding_size,",
          "254:         )",
          "255:     }",
          "258:     pub(crate) unsafe fn drop_and_dealloc(mut data: SendSyncPtr<VMExternData>) {",
          "259:         log::trace!(\"Dropping externref data @ {:p}\", data);",
          "264:         let (alloc_ptr, layout) = {",
          "265:             let data = data.as_mut();",
          "266:             debug_assert_eq!(data.ref_count.load(Ordering::SeqCst), 0);",
          "270:             let (layout, _) = {",
          "271:                 let value = data.value_ptr.as_ref();",
          "272:                 Self::layout_for(mem::size_of_val(value), mem::align_of_val(value))",
          "273:             };",
          "275:             ptr::drop_in_place(data.value_ptr.as_ptr());",
          "276:             let alloc_ptr = data.value_ptr.as_ptr().cast::<u8>();",
          "278:             (alloc_ptr, layout)",
          "279:         };",
          "281:         ptr::drop_in_place(data.as_ptr());",
          "282:         std::alloc::dealloc(alloc_ptr, layout);",
          "283:     }",
          "285:     #[inline]",
          "286:     fn increment_ref_count(&self) {",
          "294:         self.ref_count.fetch_add(1, Ordering::Relaxed);",
          "295:     }",
          "296: }",
          "298: #[inline]",
          "299: fn round_up_to_align(n: usize, align: usize) -> Option<usize> {",
          "300:     debug_assert!(align.is_power_of_two());",
          "301:     let align_minus_one = align - 1;",
          "302:     Some(n.checked_add(align_minus_one)? & !align_minus_one)",
          "303: }",
          "305: impl VMExternRef {",
          "307:     pub fn new<T>(value: T) -> VMExternRef",
          "308:     where",
          "309:         T: 'static + Any + Send + Sync,",
          "310:     {",
          "311:         VMExternRef::new_with(|| value)",
          "312:     }",
          "315:     pub fn new_with<T>(make_value: impl FnOnce() -> T) -> VMExternRef",
          "316:     where",
          "317:         T: 'static + Any + Send + Sync,",
          "318:     {",
          "319:         unsafe {",
          "320:             let (layout, footer_offset) =",
          "321:                 VMExternData::layout_for(mem::size_of::<T>(), mem::align_of::<T>());",
          "323:             let alloc_ptr = std::alloc::alloc(layout);",
          "324:             let alloc_ptr = NonNull::new(alloc_ptr).unwrap_or_else(|| {",
          "325:                 std::alloc::handle_alloc_error(layout);",
          "326:             });",
          "328:             let value_ptr = alloc_ptr.cast::<T>();",
          "329:             ptr::write(value_ptr.as_ptr(), make_value());",
          "331:             let extern_data_ptr =",
          "332:                 alloc_ptr.cast::<u8>().as_ptr().add(footer_offset) as *mut VMExternData;",
          "334:             ptr::write(",
          "335:                 extern_data_ptr,",
          "336:                 VMExternData {",
          "337:                     ref_count: AtomicUsize::new(1),",
          "339:                     value_ptr: SendSyncPtr::new(NonNull::new_unchecked(value_ptr.as_ptr())),",
          "340:                 },",
          "341:             );",
          "343:             log::trace!(\"New externref data @ {:p}\", extern_data_ptr);",
          "344:             VMExternRef(NonNull::new_unchecked(extern_data_ptr).into())",
          "345:         }",
          "346:     }",
          "357:     #[inline]",
          "358:     pub fn as_raw(&self) -> *mut u8 {",
          "359:         let ptr = self.0.as_ptr().cast::<u8>();",
          "360:         ptr",
          "361:     }",
          "371:     pub unsafe fn into_raw(self) -> *mut u8 {",
          "372:         let ptr = self.0.as_ptr().cast::<u8>();",
          "373:         std::mem::forget(self);",
          "374:         ptr",
          "375:     }",
          "385:     pub unsafe fn from_raw(ptr: *mut u8) -> Self {",
          "386:         debug_assert!(!ptr.is_null());",
          "387:         VMExternRef(NonNull::new_unchecked(ptr).cast().into())",
          "388:     }",
          "401:     pub unsafe fn clone_from_raw(ptr: *mut u8) -> Self {",
          "402:         debug_assert!(!ptr.is_null());",
          "403:         let x = VMExternRef(NonNull::new_unchecked(ptr).cast().into());",
          "404:         x.extern_data().increment_ref_count();",
          "405:         x",
          "406:     }",
          "412:     pub fn strong_count(&self) -> usize {",
          "413:         self.extern_data().ref_count.load(Ordering::SeqCst)",
          "414:     }",
          "416:     #[inline]",
          "417:     fn extern_data(&self) -> &VMExternData {",
          "418:         unsafe { self.0.as_ref() }",
          "419:     }",
          "420: }",
          "427: impl VMExternRef {",
          "433:     #[inline]",
          "434:     pub fn eq(a: &Self, b: &Self) -> bool {",
          "435:         ptr::eq(a.0.as_ptr(), b.0.as_ptr())",
          "436:     }",
          "442:     #[inline]",
          "443:     pub fn hash<H>(externref: &Self, hasher: &mut H)",
          "444:     where",
          "445:         H: Hasher,",
          "446:     {",
          "447:         ptr::hash(externref.0.as_ptr(), hasher);",
          "448:     }",
          "455:     #[inline]",
          "456:     pub fn cmp(a: &Self, b: &Self) -> cmp::Ordering {",
          "457:         let a = a.0.as_ptr() as usize;",
          "458:         let b = b.0.as_ptr() as usize;",
          "459:         a.cmp(&b)",
          "460:     }",
          "461: }",
          "463: impl Deref for VMExternRef {",
          "464:     type Target = dyn Any;",
          "466:     fn deref(&self) -> &dyn Any {",
          "467:         unsafe { self.extern_data().value_ptr.as_ref() }",
          "468:     }",
          "469: }",
          "476: #[derive(Clone, Debug)]",
          "477: struct VMExternRefWithTraits(VMExternRef);",
          "479: impl Hash for VMExternRefWithTraits {",
          "480:     fn hash<H>(&self, hasher: &mut H)",
          "481:     where",
          "482:         H: Hasher,",
          "483:     {",
          "484:         VMExternRef::hash(&self.0, hasher)",
          "485:     }",
          "486: }",
          "488: impl PartialEq for VMExternRefWithTraits {",
          "489:     fn eq(&self, other: &Self) -> bool {",
          "490:         VMExternRef::eq(&self.0, &other.0)",
          "491:     }",
          "492: }",
          "494: impl Eq for VMExternRefWithTraits {}",
          "496: type TableElem = UnsafeCell<Option<VMExternRef>>;",
          "503: #[repr(C)] // `alloc` must be the first member, it's accessed from JIT code.",
          "504: pub struct VMExternRefActivationsTable {",
          "509:     alloc: VMExternRefTableAlloc,",
          "518:     over_approximated_stack_roots: HashSet<VMExternRefWithTraits>,",
          "526:     precise_stack_roots: HashSet<VMExternRefWithTraits>,",
          "530:     #[cfg(debug_assertions)]",
          "531:     gc_okay: bool,",
          "532: }",
          "534: #[repr(C)] // This is accessed from JIT code.",
          "535: struct VMExternRefTableAlloc {",
          "540:     next: UnsafeCell<NonNull<TableElem>>,",
          "546:     end: NonNull<TableElem>,",
          "551:     chunk: Box<[TableElem]>,",
          "552: }",
          "557: unsafe impl Send for VMExternRefTableAlloc {}",
          "558: unsafe impl Sync for VMExternRefTableAlloc {}",
          "560: fn _assert_send_sync() {",
          "561:     fn _assert<T: Send + Sync>() {}",
          "562:     _assert::<VMExternRefActivationsTable>();",
          "563:     _assert::<VMExternRef>();",
          "564: }",
          "566: impl VMExternRefActivationsTable {",
          "567:     const CHUNK_SIZE: usize = 4096 / mem::size_of::<usize>();",
          "570:     pub fn new() -> Self {",
          "576:         let mut chunk: Box<[TableElem]> = Box::new([]);",
          "577:         let next = chunk.as_mut_ptr();",
          "578:         let end = unsafe { next.add(chunk.len()) };",
          "580:         VMExternRefActivationsTable {",
          "581:             alloc: VMExternRefTableAlloc {",
          "582:                 next: UnsafeCell::new(NonNull::new(next).unwrap()),",
          "583:                 end: NonNull::new(end).unwrap(),",
          "584:                 chunk,",
          "585:             },",
          "586:             over_approximated_stack_roots: HashSet::new(),",
          "587:             precise_stack_roots: HashSet::new(),",
          "588:             #[cfg(debug_assertions)]",
          "589:             gc_okay: true,",
          "590:         }",
          "591:     }",
          "593:     fn new_chunk(size: usize) -> Box<[UnsafeCell<Option<VMExternRef>>]> {",
          "594:         assert!(size >= Self::CHUNK_SIZE);",
          "595:         (0..size).map(|_| UnsafeCell::new(None)).collect()",
          "596:     }",
          "599:     #[inline]",
          "600:     pub fn bump_capacity_remaining(&self) -> usize {",
          "601:         let end = self.alloc.end.as_ptr() as usize;",
          "602:         let next = unsafe { *self.alloc.next.get() };",
          "603:         end - next.as_ptr() as usize",
          "604:     }",
          "615:     #[inline]",
          "616:     pub fn try_insert(&mut self, externref: VMExternRef) -> Result<(), VMExternRef> {",
          "617:         unsafe {",
          "618:             let next = *self.alloc.next.get();",
          "619:             if next == self.alloc.end {",
          "620:                 return Err(externref);",
          "621:             }",
          "623:             debug_assert!(",
          "624:                 (*next.as_ref().get()).is_none(),",
          "625:                 \"slots >= the `next` bump finger are always `None`\"",
          "626:             );",
          "627:             ptr::write(next.as_ptr(), UnsafeCell::new(Some(externref)));",
          "629:             let next = NonNull::new_unchecked(next.as_ptr().add(1));",
          "630:             debug_assert!(next <= self.alloc.end);",
          "633:             Ok(())",
          "634:         }",
          "635:     }",
          "643:     #[inline]",
          "644:     pub unsafe fn insert_with_gc(",
          "645:         &mut self,",
          "646:         limits: *const VMRuntimeLimits,",
          "647:         externref: VMExternRef,",
          "648:         module_info_lookup: &dyn ModuleInfoLookup,",
          "649:     ) {",
          "650:         #[cfg(debug_assertions)]",
          "651:         assert!(self.gc_okay);",
          "653:         if let Err(externref) = self.try_insert(externref) {",
          "654:             self.gc_and_insert_slow(limits, externref, module_info_lookup);",
          "655:         }",
          "656:     }",
          "658:     #[inline(never)]",
          "659:     unsafe fn gc_and_insert_slow(",
          "660:         &mut self,",
          "661:         limits: *const VMRuntimeLimits,",
          "662:         externref: VMExternRef,",
          "663:         module_info_lookup: &dyn ModuleInfoLookup,",
          "664:     ) {",
          "665:         gc(limits, module_info_lookup, self);",
          "670:         self.over_approximated_stack_roots",
          "671:             .insert(VMExternRefWithTraits(externref));",
          "672:     }",
          "675:     #[inline]",
          "676:     pub fn insert_without_gc(&mut self, externref: VMExternRef) {",
          "677:         if let Err(externref) = self.try_insert(externref) {",
          "678:             self.insert_slow_without_gc(externref);",
          "679:         }",
          "680:     }",
          "682:     #[inline(never)]",
          "683:     fn insert_slow_without_gc(&mut self, externref: VMExternRef) {",
          "684:         self.over_approximated_stack_roots",
          "685:             .insert(VMExternRefWithTraits(externref));",
          "686:     }",
          "688:     fn num_filled_in_bump_chunk(&self) -> usize {",
          "689:         let next = unsafe { *self.alloc.next.get() };",
          "690:         let bytes_unused = (self.alloc.end.as_ptr() as usize) - (next.as_ptr() as usize);",
          "691:         let slots_unused = bytes_unused / mem::size_of::<TableElem>();",
          "692:         self.alloc.chunk.len().saturating_sub(slots_unused)",
          "693:     }",
          "695:     fn elements(&self, mut f: impl FnMut(&VMExternRef)) {",
          "696:         for elem in self.over_approximated_stack_roots.iter() {",
          "697:             f(&elem.0);",
          "698:         }",
          "702:         let num_filled = self.num_filled_in_bump_chunk();",
          "703:         for slot in self.alloc.chunk.iter().take(num_filled) {",
          "704:             if let Some(elem) = unsafe { &*slot.get() } {",
          "705:                 f(elem);",
          "706:             }",
          "707:         }",
          "708:     }",
          "710:     fn insert_precise_stack_root(",
          "711:         precise_stack_roots: &mut HashSet<VMExternRefWithTraits>,",
          "712:         root: NonNull<VMExternData>,",
          "713:     ) {",
          "714:         let root = unsafe { VMExternRef::clone_from_raw(root.as_ptr().cast()) };",
          "715:         log::trace!(\"Found externref on stack: {:p}\", root);",
          "716:         precise_stack_roots.insert(VMExternRefWithTraits(root));",
          "717:     }",
          "721:     fn sweep(&mut self) {",
          "722:         log::trace!(\"begin GC sweep\");",
          "725:         let num_filled = self.num_filled_in_bump_chunk();",
          "726:         unsafe {",
          "728:         }",
          "729:         for slot in self.alloc.chunk.iter().take(num_filled) {",
          "730:             unsafe {",
          "732:             }",
          "733:         }",
          "734:         debug_assert!(",
          "735:             self.alloc",
          "736:                 .chunk",
          "737:                 .iter()",
          "738:                 .all(|slot| unsafe { (*slot.get()).as_ref().is_none() }),",
          "739:             \"after sweeping the bump chunk, all slots should be `None`\"",
          "740:         );",
          "744:         if self.alloc.chunk.is_empty() {",
          "745:             self.alloc.chunk = Self::new_chunk(Self::CHUNK_SIZE);",
          "746:             self.alloc.end =",
          "747:                 NonNull::new(unsafe { self.alloc.chunk.as_mut_ptr().add(self.alloc.chunk.len()) })",
          "748:                     .unwrap();",
          "749:         }",
          "752:         unsafe {",
          "753:             let next = self.alloc.chunk.as_mut_ptr();",
          "754:             debug_assert!(!next.is_null());",
          "756:         }",
          "760:         mem::swap(",
          "761:             &mut self.precise_stack_roots,",
          "762:             &mut self.over_approximated_stack_roots,",
          "763:         );",
          "771:         self.precise_stack_roots.clear();",
          "773:         log::trace!(\"end GC sweep\");",
          "774:     }",
          "781:     #[inline]",
          "782:     pub fn set_gc_okay(&mut self, okay: bool) -> bool {",
          "783:         #[cfg(debug_assertions)]",
          "784:         {",
          "785:             return std::mem::replace(&mut self.gc_okay, okay);",
          "786:         }",
          "787:         #[cfg(not(debug_assertions))]",
          "788:         {",
          "789:             let _ = okay;",
          "790:             return true;",
          "791:         }",
          "792:     }",
          "793: }",
          "",
          "[Added Lines]",
          "1: #[cfg(feature = \"gc\")]",
          "2: mod gc;",
          "3: #[cfg(feature = \"gc\")]",
          "4: pub use gc::*;",
          "6: #[cfg(not(feature = \"gc\"))]",
          "7: mod no_gc;",
          "8: #[cfg(not(feature = \"gc\"))]",
          "9: pub use no_gc::*;",
          "11: use wasmtime_environ::StackMap;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "805:     fn lookup_stack_map(&self, pc: usize) -> Option<&StackMap>;",
          "806: }",
          "",
          "[Removed Lines]",
          "808: #[derive(Debug, Default)]",
          "809: struct DebugOnly<T> {",
          "810:     inner: T,",
          "811: }",
          "813: impl<T> std::ops::Deref for DebugOnly<T> {",
          "814:     type Target = T;",
          "816:     fn deref(&self) -> &T {",
          "817:         if cfg!(debug_assertions) {",
          "818:             &self.inner",
          "819:         } else {",
          "820:             panic!(",
          "821:                 \"only deref `DebugOnly` when `cfg(debug_assertions)` or \\",
          "822:                  inside a `debug_assert!(..)`\"",
          "823:             )",
          "824:         }",
          "825:     }",
          "826: }",
          "828: impl<T> std::ops::DerefMut for DebugOnly<T> {",
          "829:     fn deref_mut(&mut self) -> &mut T {",
          "830:         if cfg!(debug_assertions) {",
          "831:             &mut self.inner",
          "832:         } else {",
          "833:             panic!(",
          "834:                 \"only deref `DebugOnly` when `cfg(debug_assertions)` or \\",
          "835:                  inside a `debug_assert!(..)`\"",
          "836:             )",
          "837:         }",
          "838:     }",
          "839: }",
          "852: pub unsafe fn gc(",
          "853:     limits: *const VMRuntimeLimits,",
          "854:     module_info_lookup: &dyn ModuleInfoLookup,",
          "855:     externref_activations_table: &mut VMExternRefActivationsTable,",
          "856: ) {",
          "857:     log::debug!(\"start GC\");",
          "859:     #[cfg(debug_assertions)]",
          "860:     assert!(externref_activations_table.gc_okay);",
          "862:     debug_assert!({",
          "868:         externref_activations_table.precise_stack_roots.is_empty()",
          "869:     });",
          "886:     let mut activations_table_set: DebugOnly<HashSet<_>> = Default::default();",
          "887:     if cfg!(debug_assertions) {",
          "888:         externref_activations_table.elements(|elem| {",
          "889:             activations_table_set.insert(elem.as_raw() as *mut VMExternData);",
          "890:         });",
          "891:     }",
          "893:     log::trace!(\"begin GC trace\");",
          "894:     Backtrace::trace(limits, |frame| {",
          "895:         let pc = frame.pc();",
          "896:         debug_assert!(pc != 0, \"we should always get a valid PC for Wasm frames\");",
          "898:         let fp = frame.fp();",
          "899:         debug_assert!(",
          "900:             fp != 0,",
          "901:             \"we should always get a valid frame pointer for Wasm frames\"",
          "902:         );",
          "904:         let module_info = module_info_lookup",
          "905:             .lookup(pc)",
          "906:             .expect(\"should have module info for Wasm frame\");",
          "908:         let stack_map = match module_info.lookup_stack_map(pc) {",
          "909:             Some(sm) => sm,",
          "910:             None => {",
          "911:                 log::trace!(\"No stack map for this Wasm frame\");",
          "912:                 return std::ops::ControlFlow::Continue(());",
          "913:             }",
          "914:         };",
          "915:         log::trace!(",
          "916:             \"We have a stack map that maps {} words in this Wasm frame\",",
          "917:             stack_map.mapped_words()",
          "918:         );",
          "920:         let sp = fp - stack_map.mapped_words() as usize * mem::size_of::<usize>();",
          "922:         for i in 0..(stack_map.mapped_words() as usize) {",
          "927:             let stack_slot = sp + i * mem::size_of::<usize>();",
          "929:             if !stack_map.get_bit(i) {",
          "930:                 log::trace!(",
          "931:                     \"Stack slot @ {:p} does not contain externrefs\",",
          "932:                     stack_slot as *const (),",
          "933:                 );",
          "934:                 continue;",
          "935:             }",
          "937:             let stack_slot = stack_slot as *const *mut VMExternData;",
          "938:             let r = std::ptr::read(stack_slot);",
          "939:             log::trace!(\"Stack slot @ {:p} = {:p}\", stack_slot, r);",
          "941:             debug_assert!(",
          "942:                 r.is_null() || activations_table_set.contains(&r),",
          "943:                 \"every on-stack externref inside a Wasm frame should \\",
          "944:                  have an entry in the VMExternRefActivationsTable; \\",
          "945:                  {:?} is not in the table\",",
          "946:                 r",
          "947:             );",
          "949:             if let Some(r) = NonNull::new(r) {",
          "950:                 VMExternRefActivationsTable::insert_precise_stack_root(",
          "951:                     &mut externref_activations_table.precise_stack_roots,",
          "952:                     r,",
          "953:                 );",
          "954:             }",
          "955:         }",
          "957:         std::ops::ControlFlow::Continue(())",
          "958:     });",
          "959:     log::trace!(\"end GC trace\");",
          "961:     externref_activations_table.sweep();",
          "963:     log::debug!(\"end GC\");",
          "964: }",
          "966: #[cfg(test)]",
          "967: mod tests {",
          "968:     use super::*;",
          "970:     #[test]",
          "971:     fn extern_ref_is_pointer_sized_and_aligned() {",
          "972:         assert_eq!(mem::size_of::<VMExternRef>(), mem::size_of::<*mut ()>());",
          "973:         assert_eq!(mem::align_of::<VMExternRef>(), mem::align_of::<*mut ()>());",
          "974:         assert_eq!(",
          "975:             mem::size_of::<Option<VMExternRef>>(),",
          "976:             mem::size_of::<*mut ()>()",
          "977:         );",
          "978:         assert_eq!(",
          "979:             mem::align_of::<Option<VMExternRef>>(),",
          "980:             mem::align_of::<*mut ()>()",
          "981:         );",
          "982:     }",
          "984:     #[test]",
          "985:     fn ref_count_is_at_correct_offset() {",
          "986:         let s = \"hi\";",
          "987:         let s: &(dyn Any + Send + Sync) = &s as _;",
          "988:         let s: *const (dyn Any + Send + Sync) = s as _;",
          "989:         let s: *mut (dyn Any + Send + Sync) = s as _;",
          "991:         let extern_data = VMExternData {",
          "992:             ref_count: AtomicUsize::new(0),",
          "993:             value_ptr: NonNull::new(s).unwrap().into(),",
          "994:         };",
          "996:         let extern_data_ptr = &extern_data as *const _;",
          "997:         let ref_count_ptr = &extern_data.ref_count as *const _;",
          "999:         let actual_offset = (ref_count_ptr as usize) - (extern_data_ptr as usize);",
          "1001:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "1002:             ptr: 8,",
          "1003:             num_imported_functions: 0,",
          "1004:             num_imported_tables: 0,",
          "1005:             num_imported_memories: 0,",
          "1006:             num_imported_globals: 0,",
          "1007:             num_defined_tables: 0,",
          "1008:             num_defined_memories: 0,",
          "1009:             num_owned_memories: 0,",
          "1010:             num_defined_globals: 0,",
          "1011:             num_escaped_funcs: 0,",
          "1012:         });",
          "1013:         assert_eq!(",
          "1014:             offsets.vm_extern_data_ref_count(),",
          "1015:             actual_offset.try_into().unwrap(),",
          "1016:         );",
          "1017:     }",
          "1019:     #[test]",
          "1020:     fn table_next_is_at_correct_offset() {",
          "1021:         let table = VMExternRefActivationsTable::new();",
          "1023:         let table_ptr = &table as *const _;",
          "1024:         let next_ptr = &table.alloc.next as *const _;",
          "1026:         let actual_offset = (next_ptr as usize) - (table_ptr as usize);",
          "1028:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "1029:             ptr: 8,",
          "1030:             num_imported_functions: 0,",
          "1031:             num_imported_tables: 0,",
          "1032:             num_imported_memories: 0,",
          "1033:             num_imported_globals: 0,",
          "1034:             num_defined_tables: 0,",
          "1035:             num_defined_memories: 0,",
          "1036:             num_owned_memories: 0,",
          "1037:             num_defined_globals: 0,",
          "1038:             num_escaped_funcs: 0,",
          "1039:         });",
          "1040:         assert_eq!(",
          "1041:             offsets.vm_extern_ref_activation_table_next() as usize,",
          "1042:             actual_offset",
          "1043:         );",
          "1044:     }",
          "1046:     #[test]",
          "1047:     fn table_end_is_at_correct_offset() {",
          "1048:         let table = VMExternRefActivationsTable::new();",
          "1050:         let table_ptr = &table as *const _;",
          "1051:         let end_ptr = &table.alloc.end as *const _;",
          "1053:         let actual_offset = (end_ptr as usize) - (table_ptr as usize);",
          "1055:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "1056:             ptr: 8,",
          "1057:             num_imported_functions: 0,",
          "1058:             num_imported_tables: 0,",
          "1059:             num_imported_memories: 0,",
          "1060:             num_imported_globals: 0,",
          "1061:             num_defined_tables: 0,",
          "1062:             num_defined_memories: 0,",
          "1063:             num_owned_memories: 0,",
          "1064:             num_defined_globals: 0,",
          "1065:             num_escaped_funcs: 0,",
          "1066:         });",
          "1067:         assert_eq!(",
          "1068:             offsets.vm_extern_ref_activation_table_end() as usize,",
          "1069:             actual_offset",
          "1070:         );",
          "1071:     }",
          "1072: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "crates/runtime/src/externref/gc.rs||crates/runtime/src/externref/gc.rs": [
          "File: crates/runtime/src/externref/gc.rs -> crates/runtime/src/externref/gc.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102: use crate::{Backtrace, ModuleInfoLookup, SendSyncPtr, VMRuntimeLimits};",
          "103: use std::alloc::Layout;",
          "104: use std::any::Any;",
          "105: use std::cell::UnsafeCell;",
          "106: use std::cmp;",
          "107: use std::collections::HashSet;",
          "108: use std::hash::{Hash, Hasher};",
          "109: use std::mem;",
          "110: use std::ops::Deref;",
          "111: use std::ptr::{self, NonNull};",
          "112: use std::sync::atomic::{self, AtomicUsize, Ordering};",
          "164: #[derive(Debug)]",
          "165: #[repr(transparent)]",
          "166: pub struct VMExternRef(SendSyncPtr<VMExternData>);",
          "168: impl std::fmt::Pointer for VMExternRef {",
          "169:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "170:         std::fmt::Pointer::fmt(&self.0, f)",
          "171:     }",
          "172: }",
          "174: #[repr(C)]",
          "175: pub(crate) struct VMExternData {",
          "189:     ref_count: AtomicUsize,",
          "193:     value_ptr: SendSyncPtr<dyn Any + Send + Sync>,",
          "194: }",
          "196: impl Clone for VMExternRef {",
          "197:     #[inline]",
          "198:     fn clone(&self) -> VMExternRef {",
          "199:         self.extern_data().increment_ref_count();",
          "200:         VMExternRef(self.0)",
          "201:     }",
          "202: }",
          "204: impl Drop for VMExternRef {",
          "205:     #[inline]",
          "206:     fn drop(&mut self) {",
          "207:         let data = self.extern_data();",
          "216:         if data.ref_count.fetch_sub(1, Ordering::Release) != 1 {",
          "217:             return;",
          "218:         }",
          "219:         atomic::fence(Ordering::Acquire);",
          "221:         unsafe {",
          "222:             VMExternData::drop_and_dealloc(self.0);",
          "223:         }",
          "224:     }",
          "225: }",
          "227: impl VMExternData {",
          "235:     unsafe fn layout_for(value_size: usize, value_align: usize) -> (Layout, usize) {",
          "236:         let extern_data_size = mem::size_of::<VMExternData>();",
          "237:         let extern_data_align = mem::align_of::<VMExternData>();",
          "239:         let value_and_padding_size = round_up_to_align(value_size, extern_data_align).unwrap();",
          "241:         let alloc_align = std::cmp::max(value_align, extern_data_align);",
          "242:         let alloc_size = value_and_padding_size + extern_data_size;",
          "244:         debug_assert!(",
          "245:             Layout::from_size_align(alloc_size, alloc_align).is_ok(),",
          "246:             \"should create a `Layout` for size={} and align={} okay\",",
          "247:             alloc_size,",
          "248:             alloc_align,",
          "249:         );",
          "250:         (",
          "251:             Layout::from_size_align_unchecked(alloc_size, alloc_align),",
          "252:             value_and_padding_size,",
          "253:         )",
          "254:     }",
          "257:     pub(crate) unsafe fn drop_and_dealloc(mut data: SendSyncPtr<VMExternData>) {",
          "258:         log::trace!(\"Dropping externref data @ {:p}\", data);",
          "263:         let (alloc_ptr, layout) = {",
          "264:             let data = data.as_mut();",
          "265:             debug_assert_eq!(data.ref_count.load(Ordering::SeqCst), 0);",
          "269:             let (layout, _) = {",
          "270:                 let value = data.value_ptr.as_ref();",
          "271:                 Self::layout_for(mem::size_of_val(value), mem::align_of_val(value))",
          "272:             };",
          "274:             ptr::drop_in_place(data.value_ptr.as_ptr());",
          "275:             let alloc_ptr = data.value_ptr.as_ptr().cast::<u8>();",
          "277:             (alloc_ptr, layout)",
          "278:         };",
          "280:         ptr::drop_in_place(data.as_ptr());",
          "281:         std::alloc::dealloc(alloc_ptr, layout);",
          "282:     }",
          "284:     #[inline]",
          "285:     fn increment_ref_count(&self) {",
          "293:         self.ref_count.fetch_add(1, Ordering::Relaxed);",
          "294:     }",
          "295: }",
          "297: #[inline]",
          "298: fn round_up_to_align(n: usize, align: usize) -> Option<usize> {",
          "299:     debug_assert!(align.is_power_of_two());",
          "300:     let align_minus_one = align - 1;",
          "301:     Some(n.checked_add(align_minus_one)? & !align_minus_one)",
          "302: }",
          "304: impl VMExternRef {",
          "306:     pub fn new<T>(value: T) -> VMExternRef",
          "307:     where",
          "308:         T: 'static + Any + Send + Sync,",
          "309:     {",
          "310:         VMExternRef::new_with(|| value)",
          "311:     }",
          "314:     pub fn new_with<T>(make_value: impl FnOnce() -> T) -> VMExternRef",
          "315:     where",
          "316:         T: 'static + Any + Send + Sync,",
          "317:     {",
          "318:         unsafe {",
          "319:             let (layout, footer_offset) =",
          "320:                 VMExternData::layout_for(mem::size_of::<T>(), mem::align_of::<T>());",
          "322:             let alloc_ptr = std::alloc::alloc(layout);",
          "323:             let alloc_ptr = NonNull::new(alloc_ptr).unwrap_or_else(|| {",
          "324:                 std::alloc::handle_alloc_error(layout);",
          "325:             });",
          "327:             let value_ptr = alloc_ptr.cast::<T>();",
          "328:             ptr::write(value_ptr.as_ptr(), make_value());",
          "330:             let extern_data_ptr =",
          "331:                 alloc_ptr.cast::<u8>().as_ptr().add(footer_offset) as *mut VMExternData;",
          "333:             ptr::write(",
          "334:                 extern_data_ptr,",
          "335:                 VMExternData {",
          "336:                     ref_count: AtomicUsize::new(1),",
          "338:                     value_ptr: SendSyncPtr::new(NonNull::new_unchecked(value_ptr.as_ptr())),",
          "339:                 },",
          "340:             );",
          "342:             log::trace!(\"New externref data @ {:p}\", extern_data_ptr);",
          "343:             VMExternRef(NonNull::new_unchecked(extern_data_ptr).into())",
          "344:         }",
          "345:     }",
          "356:     #[inline]",
          "357:     pub fn as_raw(&self) -> *mut u8 {",
          "358:         let ptr = self.0.as_ptr().cast::<u8>();",
          "359:         ptr",
          "360:     }",
          "370:     pub unsafe fn into_raw(self) -> *mut u8 {",
          "371:         let ptr = self.0.as_ptr().cast::<u8>();",
          "372:         std::mem::forget(self);",
          "373:         ptr",
          "374:     }",
          "384:     #[inline]",
          "385:     pub unsafe fn from_raw(ptr: *mut u8) -> Option<Self> {",
          "386:         Some(VMExternRef(NonNull::new(ptr)?.cast().into()))",
          "387:     }",
          "400:     #[inline]",
          "401:     pub unsafe fn clone_from_raw(ptr: *mut u8) -> Option<Self> {",
          "402:         let x = VMExternRef(NonNull::new(ptr)?.cast::<VMExternData>().into());",
          "403:         x.extern_data().increment_ref_count();",
          "404:         Some(x)",
          "405:     }",
          "411:     pub fn strong_count(&self) -> usize {",
          "412:         self.extern_data().ref_count.load(Ordering::SeqCst)",
          "413:     }",
          "415:     #[inline]",
          "416:     fn extern_data(&self) -> &VMExternData {",
          "417:         unsafe { self.0.as_ref() }",
          "418:     }",
          "419: }",
          "426: impl VMExternRef {",
          "432:     #[inline]",
          "433:     pub fn eq(a: &Self, b: &Self) -> bool {",
          "434:         ptr::eq(a.0.as_ptr(), b.0.as_ptr())",
          "435:     }",
          "441:     #[inline]",
          "442:     pub fn hash<H>(externref: &Self, hasher: &mut H)",
          "443:     where",
          "444:         H: Hasher,",
          "445:     {",
          "446:         ptr::hash(externref.0.as_ptr(), hasher);",
          "447:     }",
          "454:     #[inline]",
          "455:     pub fn cmp(a: &Self, b: &Self) -> cmp::Ordering {",
          "456:         let a = a.0.as_ptr() as usize;",
          "457:         let b = b.0.as_ptr() as usize;",
          "458:         a.cmp(&b)",
          "459:     }",
          "460: }",
          "462: impl Deref for VMExternRef {",
          "463:     type Target = dyn Any;",
          "465:     fn deref(&self) -> &dyn Any {",
          "466:         unsafe { self.extern_data().value_ptr.as_ref() }",
          "467:     }",
          "468: }",
          "475: #[derive(Clone, Debug)]",
          "476: struct VMExternRefWithTraits(VMExternRef);",
          "478: impl Hash for VMExternRefWithTraits {",
          "479:     fn hash<H>(&self, hasher: &mut H)",
          "480:     where",
          "481:         H: Hasher,",
          "482:     {",
          "483:         VMExternRef::hash(&self.0, hasher)",
          "484:     }",
          "485: }",
          "487: impl PartialEq for VMExternRefWithTraits {",
          "488:     fn eq(&self, other: &Self) -> bool {",
          "489:         VMExternRef::eq(&self.0, &other.0)",
          "490:     }",
          "491: }",
          "493: impl Eq for VMExternRefWithTraits {}",
          "495: type TableElem = UnsafeCell<Option<VMExternRef>>;",
          "502: #[repr(C)] // `alloc` must be the first member, it's accessed from JIT code.",
          "503: pub struct VMExternRefActivationsTable {",
          "508:     alloc: VMExternRefTableAlloc,",
          "517:     over_approximated_stack_roots: HashSet<VMExternRefWithTraits>,",
          "525:     precise_stack_roots: HashSet<VMExternRefWithTraits>,",
          "529:     #[cfg(debug_assertions)]",
          "530:     gc_okay: bool,",
          "531: }",
          "533: #[repr(C)] // This is accessed from JIT code.",
          "534: struct VMExternRefTableAlloc {",
          "539:     next: UnsafeCell<NonNull<TableElem>>,",
          "545:     end: NonNull<TableElem>,",
          "550:     chunk: Box<[TableElem]>,",
          "551: }",
          "556: unsafe impl Send for VMExternRefTableAlloc {}",
          "557: unsafe impl Sync for VMExternRefTableAlloc {}",
          "559: fn _assert_send_sync() {",
          "560:     fn _assert<T: Send + Sync>() {}",
          "561:     _assert::<VMExternRefActivationsTable>();",
          "562:     _assert::<VMExternRef>();",
          "563: }",
          "565: impl VMExternRefActivationsTable {",
          "566:     const CHUNK_SIZE: usize = 4096 / mem::size_of::<usize>();",
          "569:     pub fn new() -> Self {",
          "575:         let mut chunk: Box<[TableElem]> = Box::new([]);",
          "576:         let next = chunk.as_mut_ptr();",
          "577:         let end = unsafe { next.add(chunk.len()) };",
          "579:         VMExternRefActivationsTable {",
          "580:             alloc: VMExternRefTableAlloc {",
          "581:                 next: UnsafeCell::new(NonNull::new(next).unwrap()),",
          "582:                 end: NonNull::new(end).unwrap(),",
          "583:                 chunk,",
          "584:             },",
          "585:             over_approximated_stack_roots: HashSet::new(),",
          "586:             precise_stack_roots: HashSet::new(),",
          "587:             #[cfg(debug_assertions)]",
          "588:             gc_okay: true,",
          "589:         }",
          "590:     }",
          "592:     fn new_chunk(size: usize) -> Box<[UnsafeCell<Option<VMExternRef>>]> {",
          "593:         assert!(size >= Self::CHUNK_SIZE);",
          "594:         (0..size).map(|_| UnsafeCell::new(None)).collect()",
          "595:     }",
          "598:     #[inline]",
          "599:     pub fn bump_capacity_remaining(&self) -> usize {",
          "600:         let end = self.alloc.end.as_ptr() as usize;",
          "601:         let next = unsafe { *self.alloc.next.get() };",
          "602:         end - next.as_ptr() as usize",
          "603:     }",
          "614:     #[inline]",
          "615:     pub fn try_insert(&mut self, externref: VMExternRef) -> Result<(), VMExternRef> {",
          "616:         unsafe {",
          "617:             let next = *self.alloc.next.get();",
          "618:             if next == self.alloc.end {",
          "619:                 return Err(externref);",
          "620:             }",
          "622:             debug_assert!(",
          "623:                 (*next.as_ref().get()).is_none(),",
          "624:                 \"slots >= the `next` bump finger are always `None`\"",
          "625:             );",
          "626:             ptr::write(next.as_ptr(), UnsafeCell::new(Some(externref)));",
          "628:             let next = NonNull::new_unchecked(next.as_ptr().add(1));",
          "629:             debug_assert!(next <= self.alloc.end);",
          "632:             Ok(())",
          "633:         }",
          "634:     }",
          "642:     #[inline]",
          "643:     pub unsafe fn insert_with_gc(",
          "644:         &mut self,",
          "645:         limits: *const VMRuntimeLimits,",
          "646:         externref: VMExternRef,",
          "647:         module_info_lookup: &dyn ModuleInfoLookup,",
          "648:     ) {",
          "649:         #[cfg(debug_assertions)]",
          "650:         assert!(self.gc_okay);",
          "652:         if let Err(externref) = self.try_insert(externref) {",
          "653:             self.gc_and_insert_slow(limits, externref, module_info_lookup);",
          "654:         }",
          "655:     }",
          "657:     #[inline(never)]",
          "658:     unsafe fn gc_and_insert_slow(",
          "659:         &mut self,",
          "660:         limits: *const VMRuntimeLimits,",
          "661:         externref: VMExternRef,",
          "662:         module_info_lookup: &dyn ModuleInfoLookup,",
          "663:     ) {",
          "664:         gc(limits, module_info_lookup, self);",
          "669:         self.over_approximated_stack_roots",
          "670:             .insert(VMExternRefWithTraits(externref));",
          "671:     }",
          "674:     #[inline]",
          "675:     pub fn insert_without_gc(&mut self, externref: VMExternRef) {",
          "676:         if let Err(externref) = self.try_insert(externref) {",
          "677:             self.insert_slow_without_gc(externref);",
          "678:         }",
          "679:     }",
          "681:     #[inline(never)]",
          "682:     fn insert_slow_without_gc(&mut self, externref: VMExternRef) {",
          "683:         self.over_approximated_stack_roots",
          "684:             .insert(VMExternRefWithTraits(externref));",
          "685:     }",
          "687:     fn num_filled_in_bump_chunk(&self) -> usize {",
          "688:         let next = unsafe { *self.alloc.next.get() };",
          "689:         let bytes_unused = (self.alloc.end.as_ptr() as usize) - (next.as_ptr() as usize);",
          "690:         let slots_unused = bytes_unused / mem::size_of::<TableElem>();",
          "691:         self.alloc.chunk.len().saturating_sub(slots_unused)",
          "692:     }",
          "694:     fn elements(&self, mut f: impl FnMut(&VMExternRef)) {",
          "695:         for elem in self.over_approximated_stack_roots.iter() {",
          "696:             f(&elem.0);",
          "697:         }",
          "701:         let num_filled = self.num_filled_in_bump_chunk();",
          "702:         for slot in self.alloc.chunk.iter().take(num_filled) {",
          "703:             if let Some(elem) = unsafe { &*slot.get() } {",
          "704:                 f(elem);",
          "705:             }",
          "706:         }",
          "707:     }",
          "709:     fn insert_precise_stack_root(",
          "710:         precise_stack_roots: &mut HashSet<VMExternRefWithTraits>,",
          "711:         root: NonNull<VMExternData>,",
          "712:     ) {",
          "713:         let root = unsafe { VMExternRef::clone_from_raw(root.as_ptr().cast()).unwrap() };",
          "714:         log::trace!(\"Found externref on stack: {:p}\", root);",
          "715:         precise_stack_roots.insert(VMExternRefWithTraits(root));",
          "716:     }",
          "720:     fn sweep(&mut self) {",
          "721:         log::trace!(\"begin GC sweep\");",
          "724:         let num_filled = self.num_filled_in_bump_chunk();",
          "725:         unsafe {",
          "727:         }",
          "728:         for slot in self.alloc.chunk.iter().take(num_filled) {",
          "729:             unsafe {",
          "731:             }",
          "732:         }",
          "733:         debug_assert!(",
          "734:             self.alloc",
          "735:                 .chunk",
          "736:                 .iter()",
          "737:                 .all(|slot| unsafe { (*slot.get()).as_ref().is_none() }),",
          "738:             \"after sweeping the bump chunk, all slots should be `None`\"",
          "739:         );",
          "743:         if self.alloc.chunk.is_empty() {",
          "744:             self.alloc.chunk = Self::new_chunk(Self::CHUNK_SIZE);",
          "745:             self.alloc.end =",
          "746:                 NonNull::new(unsafe { self.alloc.chunk.as_mut_ptr().add(self.alloc.chunk.len()) })",
          "747:                     .unwrap();",
          "748:         }",
          "751:         unsafe {",
          "752:             let next = self.alloc.chunk.as_mut_ptr();",
          "753:             debug_assert!(!next.is_null());",
          "755:         }",
          "759:         mem::swap(",
          "760:             &mut self.precise_stack_roots,",
          "761:             &mut self.over_approximated_stack_roots,",
          "762:         );",
          "770:         self.precise_stack_roots.clear();",
          "772:         log::trace!(\"end GC sweep\");",
          "773:     }",
          "780:     #[inline]",
          "781:     pub fn set_gc_okay(&mut self, okay: bool) -> bool {",
          "782:         #[cfg(debug_assertions)]",
          "783:         {",
          "784:             return std::mem::replace(&mut self.gc_okay, okay);",
          "785:         }",
          "786:         #[cfg(not(debug_assertions))]",
          "787:         {",
          "788:             let _ = okay;",
          "789:             return true;",
          "790:         }",
          "791:     }",
          "792: }",
          "794: #[derive(Debug, Default)]",
          "795: struct DebugOnly<T> {",
          "796:     inner: T,",
          "797: }",
          "799: impl<T> std::ops::Deref for DebugOnly<T> {",
          "800:     type Target = T;",
          "802:     fn deref(&self) -> &T {",
          "803:         if cfg!(debug_assertions) {",
          "804:             &self.inner",
          "805:         } else {",
          "806:             panic!(",
          "807:                 \"only deref `DebugOnly` when `cfg(debug_assertions)` or \\",
          "808:                  inside a `debug_assert!(..)`\"",
          "809:             )",
          "810:         }",
          "811:     }",
          "812: }",
          "814: impl<T> std::ops::DerefMut for DebugOnly<T> {",
          "815:     fn deref_mut(&mut self) -> &mut T {",
          "816:         if cfg!(debug_assertions) {",
          "817:             &mut self.inner",
          "818:         } else {",
          "819:             panic!(",
          "820:                 \"only deref `DebugOnly` when `cfg(debug_assertions)` or \\",
          "821:                  inside a `debug_assert!(..)`\"",
          "822:             )",
          "823:         }",
          "824:     }",
          "825: }",
          "838: pub unsafe fn gc(",
          "839:     limits: *const VMRuntimeLimits,",
          "840:     module_info_lookup: &dyn ModuleInfoLookup,",
          "841:     externref_activations_table: &mut VMExternRefActivationsTable,",
          "842: ) {",
          "843:     log::debug!(\"start GC\");",
          "845:     #[cfg(debug_assertions)]",
          "846:     assert!(externref_activations_table.gc_okay);",
          "848:     debug_assert!({",
          "854:         externref_activations_table.precise_stack_roots.is_empty()",
          "855:     });",
          "872:     let mut activations_table_set: DebugOnly<HashSet<_>> = Default::default();",
          "873:     if cfg!(debug_assertions) {",
          "874:         externref_activations_table.elements(|elem| {",
          "875:             activations_table_set.insert(elem.as_raw() as *mut VMExternData);",
          "876:         });",
          "877:     }",
          "879:     log::trace!(\"begin GC trace\");",
          "880:     Backtrace::trace(limits, |frame| {",
          "881:         let pc = frame.pc();",
          "882:         debug_assert!(pc != 0, \"we should always get a valid PC for Wasm frames\");",
          "884:         let fp = frame.fp();",
          "885:         debug_assert!(",
          "886:             fp != 0,",
          "887:             \"we should always get a valid frame pointer for Wasm frames\"",
          "888:         );",
          "890:         let module_info = module_info_lookup",
          "891:             .lookup(pc)",
          "892:             .expect(\"should have module info for Wasm frame\");",
          "894:         let stack_map = match module_info.lookup_stack_map(pc) {",
          "895:             Some(sm) => sm,",
          "896:             None => {",
          "897:                 log::trace!(\"No stack map for this Wasm frame\");",
          "898:                 return std::ops::ControlFlow::Continue(());",
          "899:             }",
          "900:         };",
          "901:         log::trace!(",
          "902:             \"We have a stack map that maps {} words in this Wasm frame\",",
          "903:             stack_map.mapped_words()",
          "904:         );",
          "906:         let sp = fp - stack_map.mapped_words() as usize * mem::size_of::<usize>();",
          "908:         for i in 0..(stack_map.mapped_words() as usize) {",
          "913:             let stack_slot = sp + i * mem::size_of::<usize>();",
          "915:             if !stack_map.get_bit(i) {",
          "916:                 log::trace!(",
          "917:                     \"Stack slot @ {:p} does not contain externrefs\",",
          "918:                     stack_slot as *const (),",
          "919:                 );",
          "920:                 continue;",
          "921:             }",
          "923:             let stack_slot = stack_slot as *const *mut VMExternData;",
          "924:             let r = std::ptr::read(stack_slot);",
          "925:             log::trace!(\"Stack slot @ {:p} = {:p}\", stack_slot, r);",
          "927:             debug_assert!(",
          "928:                 r.is_null() || activations_table_set.contains(&r),",
          "929:                 \"every on-stack externref inside a Wasm frame should \\",
          "930:                  have an entry in the VMExternRefActivationsTable; \\",
          "931:                  {:?} is not in the table\",",
          "932:                 r",
          "933:             );",
          "935:             if let Some(r) = NonNull::new(r) {",
          "936:                 VMExternRefActivationsTable::insert_precise_stack_root(",
          "937:                     &mut externref_activations_table.precise_stack_roots,",
          "938:                     r,",
          "939:                 );",
          "940:             }",
          "941:         }",
          "943:         std::ops::ControlFlow::Continue(())",
          "944:     });",
          "945:     log::trace!(\"end GC trace\");",
          "947:     externref_activations_table.sweep();",
          "949:     log::debug!(\"end GC\");",
          "950: }",
          "952: #[cfg(test)]",
          "953: mod tests {",
          "954:     use super::*;",
          "956:     #[test]",
          "957:     fn extern_ref_is_pointer_sized_and_aligned() {",
          "958:         assert_eq!(mem::size_of::<VMExternRef>(), mem::size_of::<*mut ()>());",
          "959:         assert_eq!(mem::align_of::<VMExternRef>(), mem::align_of::<*mut ()>());",
          "960:         assert_eq!(",
          "961:             mem::size_of::<Option<VMExternRef>>(),",
          "962:             mem::size_of::<*mut ()>()",
          "963:         );",
          "964:         assert_eq!(",
          "965:             mem::align_of::<Option<VMExternRef>>(),",
          "966:             mem::align_of::<*mut ()>()",
          "967:         );",
          "968:     }",
          "970:     #[test]",
          "971:     fn ref_count_is_at_correct_offset() {",
          "972:         let s = \"hi\";",
          "973:         let s: &(dyn Any + Send + Sync) = &s as _;",
          "974:         let s: *const (dyn Any + Send + Sync) = s as _;",
          "975:         let s: *mut (dyn Any + Send + Sync) = s as _;",
          "977:         let extern_data = VMExternData {",
          "978:             ref_count: AtomicUsize::new(0),",
          "979:             value_ptr: NonNull::new(s).unwrap().into(),",
          "980:         };",
          "982:         let extern_data_ptr = &extern_data as *const _;",
          "983:         let ref_count_ptr = &extern_data.ref_count as *const _;",
          "985:         let actual_offset = (ref_count_ptr as usize) - (extern_data_ptr as usize);",
          "987:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "988:             ptr: 8,",
          "989:             num_imported_functions: 0,",
          "990:             num_imported_tables: 0,",
          "991:             num_imported_memories: 0,",
          "992:             num_imported_globals: 0,",
          "993:             num_defined_tables: 0,",
          "994:             num_defined_memories: 0,",
          "995:             num_owned_memories: 0,",
          "996:             num_defined_globals: 0,",
          "997:             num_escaped_funcs: 0,",
          "998:         });",
          "999:         assert_eq!(",
          "1000:             offsets.vm_extern_data_ref_count(),",
          "1001:             actual_offset.try_into().unwrap(),",
          "1002:         );",
          "1003:     }",
          "1005:     #[test]",
          "1006:     fn table_next_is_at_correct_offset() {",
          "1007:         let table = VMExternRefActivationsTable::new();",
          "1009:         let table_ptr = &table as *const _;",
          "1010:         let next_ptr = &table.alloc.next as *const _;",
          "1012:         let actual_offset = (next_ptr as usize) - (table_ptr as usize);",
          "1014:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "1015:             ptr: 8,",
          "1016:             num_imported_functions: 0,",
          "1017:             num_imported_tables: 0,",
          "1018:             num_imported_memories: 0,",
          "1019:             num_imported_globals: 0,",
          "1020:             num_defined_tables: 0,",
          "1021:             num_defined_memories: 0,",
          "1022:             num_owned_memories: 0,",
          "1023:             num_defined_globals: 0,",
          "1024:             num_escaped_funcs: 0,",
          "1025:         });",
          "1026:         assert_eq!(",
          "1027:             offsets.vm_extern_ref_activation_table_next() as usize,",
          "1028:             actual_offset",
          "1029:         );",
          "1030:     }",
          "1032:     #[test]",
          "1033:     fn table_end_is_at_correct_offset() {",
          "1034:         let table = VMExternRefActivationsTable::new();",
          "1036:         let table_ptr = &table as *const _;",
          "1037:         let end_ptr = &table.alloc.end as *const _;",
          "1039:         let actual_offset = (end_ptr as usize) - (table_ptr as usize);",
          "1041:         let offsets = wasmtime_environ::VMOffsets::from(wasmtime_environ::VMOffsetsFields {",
          "1042:             ptr: 8,",
          "1043:             num_imported_functions: 0,",
          "1044:             num_imported_tables: 0,",
          "1045:             num_imported_memories: 0,",
          "1046:             num_imported_globals: 0,",
          "1047:             num_defined_tables: 0,",
          "1048:             num_defined_memories: 0,",
          "1049:             num_owned_memories: 0,",
          "1050:             num_defined_globals: 0,",
          "1051:             num_escaped_funcs: 0,",
          "1052:         });",
          "1053:         assert_eq!(",
          "1054:             offsets.vm_extern_ref_activation_table_end() as usize,",
          "1055:             actual_offset",
          "1056:         );",
          "1057:     }",
          "1058: }",
          "",
          "---------------"
        ],
        "crates/runtime/src/externref/no_gc.rs||crates/runtime/src/externref/no_gc.rs": [
          "File: crates/runtime/src/externref/no_gc.rs -> crates/runtime/src/externref/no_gc.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6: #![allow(missing_docs)]",
          "8: use crate::{ModuleInfoLookup, VMRuntimeLimits};",
          "9: use std::any::Any;",
          "10: use std::cmp;",
          "11: use std::hash::Hasher;",
          "12: use std::ops::Deref;",
          "14: #[derive(Clone)]",
          "15: enum Uninhabited {}",
          "17: #[derive(Clone)]",
          "18: pub struct VMExternRef(Uninhabited);",
          "20: impl std::fmt::Pointer for VMExternRef {",
          "21:     fn fmt(&self, _f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "22:         match self.0 {}",
          "23:     }",
          "24: }",
          "26: impl Drop for VMExternRef {",
          "27:     fn drop(&mut self) {",
          "28:         match self.0 {}",
          "29:     }",
          "30: }",
          "32: impl VMExternRef {",
          "34:     pub fn assert_unreachable<T>(&self) -> T {",
          "35:         match self.0 {}",
          "36:     }",
          "38:     pub fn as_raw(&self) -> *mut u8 {",
          "39:         match self.0 {}",
          "40:     }",
          "42:     pub unsafe fn into_raw(self) -> *mut u8 {",
          "43:         match self.0 {}",
          "44:     }",
          "46:     pub unsafe fn from_raw(ptr: *mut u8) -> Option<Self> {",
          "47:         assert!(ptr.is_null());",
          "48:         None",
          "49:     }",
          "51:     pub unsafe fn clone_from_raw(ptr: *mut u8) -> Option<Self> {",
          "52:         assert!(ptr.is_null());",
          "53:         None",
          "54:     }",
          "56:     pub fn strong_count(&self) -> usize {",
          "57:         match self.0 {}",
          "58:     }",
          "60:     pub fn eq(a: &Self, _b: &Self) -> bool {",
          "61:         match a.0 {}",
          "62:     }",
          "64:     pub fn hash<H>(externref: &Self, _hasher: &mut H)",
          "65:     where",
          "66:         H: Hasher,",
          "67:     {",
          "68:         match externref.0 {}",
          "69:     }",
          "71:     pub fn cmp(a: &Self, _b: &Self) -> cmp::Ordering {",
          "72:         match a.0 {}",
          "73:     }",
          "74: }",
          "76: impl Deref for VMExternRef {",
          "77:     type Target = dyn Any;",
          "79:     fn deref(&self) -> &dyn Any {",
          "80:         match self.0 {}",
          "81:     }",
          "82: }",
          "84: pub struct VMExternRefActivationsTable {",
          "85:     _priv: (),",
          "86: }",
          "88: impl VMExternRefActivationsTable {",
          "89:     pub fn new() -> Self {",
          "90:         Self { _priv: () }",
          "91:     }",
          "93:     pub fn bump_capacity_remaining(&self) -> usize {",
          "94:         usize::MAX",
          "95:     }",
          "97:     pub fn try_insert(&mut self, externref: VMExternRef) -> Result<(), VMExternRef> {",
          "98:         match externref.0 {}",
          "99:     }",
          "101:     pub unsafe fn insert_with_gc(",
          "102:         &mut self,",
          "103:         _limits: *const VMRuntimeLimits,",
          "104:         externref: VMExternRef,",
          "105:         _module_info_lookup: &dyn ModuleInfoLookup,",
          "106:     ) {",
          "107:         match externref.0 {}",
          "108:     }",
          "110:     pub fn insert_without_gc(&mut self, externref: VMExternRef) {",
          "111:         match externref.0 {}",
          "112:     }",
          "114:     pub fn set_gc_okay(&mut self, _okay: bool) -> bool {",
          "115:         true",
          "116:     }",
          "117: }",
          "119: pub unsafe fn gc(",
          "120:     _limits: *const VMRuntimeLimits,",
          "121:     _module_info_lookup: &dyn ModuleInfoLookup,",
          "122:     _externref_activations_table: &mut VMExternRefActivationsTable,",
          "123: ) {",
          "125: }",
          "",
          "---------------"
        ],
        "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
          "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1286:                 WasmValType::Ref(WasmRefType {",
          "1287:                     heap_type: WasmHeapType::Extern,",
          "1288:                     ..",
          "1290:                 _ => continue,",
          "1291:             }",
          "1295:         }",
          "1296:     }",
          "1297: }",
          "",
          "[Removed Lines]",
          "1289:                 }) => {}",
          "1292:             unsafe {",
          "1293:                 drop((*self.global_ptr(idx)).as_externref_mut().take());",
          "1294:             }",
          "",
          "[Added Lines]",
          "1291:                 }) => unsafe {",
          "1292:                     drop((*self.global_ptr(idx)).as_externref_mut().take());",
          "1293:                 },",
          "",
          "---------------"
        ],
        "crates/runtime/src/libcalls.rs||crates/runtime/src/libcalls.rs": [
          "File: crates/runtime/src/libcalls.rs -> crates/runtime/src/libcalls.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "62: use anyhow::bail;",
          "63: use anyhow::Result;",
          "64: use cfg_if::cfg_if;",
          "67: use std::time::{Duration, Instant};",
          "71: #[cfg(feature = \"wmemcheck\")]",
          "72: use wasmtime_wmemcheck::AccessError::{",
          "73:     DoubleMalloc, InvalidFree, InvalidRead, InvalidWrite, OutOfBounds,",
          "",
          "[Removed Lines]",
          "65: use std::mem;",
          "66: use std::ptr::{self, NonNull};",
          "68: use wasmtime_environ::{",
          "69:     DataIndex, ElemIndex, FuncIndex, GlobalIndex, MemoryIndex, TableIndex, Trap, Unsigned,",
          "70: };",
          "",
          "[Added Lines]",
          "66: use wasmtime_environ::{DataIndex, ElemIndex, FuncIndex, MemoryIndex, TableIndex, Trap, Unsigned};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: pub mod trampolines {",
          "83:     use crate::arch::wasm_to_libcall_trampoline;",
          "84:     use crate::{Instance, TrapReason, VMContext};",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     #![allow(unused_doc_comments, unused_attributes)]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "99:                 extern \"C\" {",
          "100:                     #[allow(missing_docs)]",
          "101:                     #[allow(improper_ctypes)]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99:                 $( #[$attr] )*",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "106:                     ) $(-> libcall!(@ty $result))?;",
          "107:                 }",
          "109:                 wasm_to_libcall_trampoline!($name ; [<impl_ $name>]);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "110:                 $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "121:                 #[cfg_attr(target_arch = \"s390x\", wasmtime_versioned_export_macros::versioned_export)]",
          "122:                 unsafe extern \"C\" fn [<impl_ $name>](",
          "123:                     vmctx: *mut VMContext,",
          "124:                     $( $pname : libcall!(@ty $param), )*",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "124:                 $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "140:                 #[allow(non_upper_case_globals)]",
          "141:                 #[used]",
          "142:                 static [<impl_ $name _ref>]: unsafe extern \"C\" fn(",
          "144:                     $( $pname : libcall!(@ty $param), )*",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "145:                 $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "221:     init_value: *mut u8,",
          "222: ) -> Result<u32> {",
          "223:     let table_index = TableIndex::from_u32(table_index);",
          "224:     let element = match instance.table_element_type(table_index) {",
          "225:         TableElementType::Func => (init_value as *mut VMFuncRef).into(),",
          "234:     };",
          "235:     Ok(match instance.table_grow(table_index, delta, element)? {",
          "236:         Some(r) => r,",
          "237:         None => (-1_i32).unsigned(),",
          "",
          "[Removed Lines]",
          "226:         TableElementType::Extern => {",
          "227:             let init_value = if init_value.is_null() {",
          "228:                 None",
          "229:             } else {",
          "230:                 Some(VMExternRef::clone_from_raw(init_value))",
          "231:             };",
          "232:             init_value.into()",
          "233:         }",
          "",
          "[Added Lines]",
          "231:         TableElementType::Extern => VMExternRef::clone_from_raw(init_value).into(),",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "239: }",
          "241: use table_grow as table_grow_func_ref;",
          "242: use table_grow as table_grow_externref;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "242: #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "258:             let val = val as *mut VMFuncRef;",
          "259:             table.fill(dst, val.into(), len)",
          "260:         }",
          "261:         TableElementType::Extern => {",
          "267:             table.fill(dst, val.into(), len)",
          "268:         }",
          "269:     }",
          "270: }",
          "272: use table_fill as table_fill_func_ref;",
          "273: use table_fill as table_fill_externref;",
          "",
          "[Removed Lines]",
          "262:             let val = if val.is_null() {",
          "263:                 None",
          "264:             } else {",
          "265:                 Some(VMExternRef::clone_from_raw(val))",
          "266:             };",
          "",
          "[Added Lines]",
          "264:             let val = VMExternRef::clone_from_raw(val);",
          "272: #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "380: }",
          "383: unsafe fn drop_externref(_instance: &mut Instance, externref: *mut u8) {",
          "384:     let externref = externref as *mut crate::externref::VMExternData;",
          "386:     crate::externref::VMExternData::drop_and_dealloc(externref);",
          "387: }",
          "391: unsafe fn activations_table_insert_with_gc(instance: &mut Instance, externref: *mut u8) {",
          "393:     let limits = *instance.runtime_limits();",
          "394:     let (activations_table, module_info_lookup) = (*instance.store()).externref_activations_table();",
          "",
          "[Removed Lines]",
          "385:     let externref = NonNull::new(externref).unwrap().into();",
          "392:     let externref = VMExternRef::clone_from_raw(externref);",
          "",
          "[Added Lines]",
          "383: #[cfg(feature = \"gc\")]",
          "386:     let externref = std::ptr::NonNull::new(externref).unwrap().into();",
          "392: #[cfg(feature = \"gc\")]",
          "394:     let externref = VMExternRef::clone_from_raw(externref).unwrap();",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "406: }",
          "409: unsafe fn externref_global_get(instance: &mut Instance, index: u32) -> *mut u8 {",
          "411:     let limits = *instance.runtime_limits();",
          "412:     let global = instance.defined_or_imported_global_ptr(index);",
          "413:     match (*global).as_externref().clone() {",
          "415:         Some(externref) => {",
          "416:             let raw = externref.as_raw();",
          "417:             let (activations_table, module_info_lookup) =",
          "",
          "[Removed Lines]",
          "410:     let index = GlobalIndex::from_u32(index);",
          "414:         None => ptr::null_mut(),",
          "",
          "[Added Lines]",
          "411: #[cfg(feature = \"gc\")]",
          "413:     let index = wasmtime_environ::GlobalIndex::from_u32(index);",
          "417:         None => std::ptr::null_mut(),",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "423: }",
          "426: unsafe fn externref_global_set(instance: &mut Instance, index: u32, externref: *mut u8) {",
          "434:     let global = instance.defined_or_imported_global_ptr(index);",
          "441:     drop(old);",
          "442: }",
          "",
          "[Removed Lines]",
          "427:     let externref = if externref.is_null() {",
          "428:         None",
          "429:     } else {",
          "430:         Some(VMExternRef::clone_from_raw(externref))",
          "431:     };",
          "433:     let index = GlobalIndex::from_u32(index);",
          "440:     let old = mem::replace((*global).as_externref_mut(), externref);",
          "",
          "[Added Lines]",
          "429: #[cfg(feature = \"gc\")]",
          "431:     let externref = VMExternRef::clone_from_raw(externref);",
          "433:     let index = wasmtime_environ::GlobalIndex::from_u32(index);",
          "440:     let old = std::mem::replace((*global).as_externref_mut(), externref);",
          "",
          "---------------"
        ],
        "crates/runtime/src/table.rs||crates/runtime/src/table.rs": [
          "File: crates/runtime/src/table.rs -> crates/runtime/src/table.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: use crate::vmcontext::{VMFuncRef, VMTableDefinition};",
          "7: use anyhow::{bail, format_err, Error, Result};",
          "8: use sptr::Strict;",
          "9: use std::ops::Range;",
          "",
          "[Removed Lines]",
          "6: use crate::{SendSyncPtr, Store, VMExternRef};",
          "",
          "[Added Lines]",
          "5: #![cfg_attr(feature = \"gc\", allow(irrefutable_let_patterns))]",
          "7: use crate::externref::VMExternRef;",
          "9: use crate::{SendSyncPtr, Store};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "57:             }",
          "58:             (TableElementType::Extern, None) => Self::ExternRef(None),",
          "59:             (TableElementType::Extern, Some(ptr)) => {",
          "61:             }",
          "62:         }",
          "63:     }",
          "",
          "[Removed Lines]",
          "60:                 Self::ExternRef(Some(VMExternRef::from_raw(ptr.as_ptr())))",
          "",
          "[Added Lines]",
          "65:                 Self::ExternRef(VMExternRef::from_raw(ptr.as_ptr()))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "73:             TableElementType::Func => TableElement::from_table_value(ty, ptr),",
          "75:             TableElementType::Extern => {",
          "77:             }",
          "78:         }",
          "79:     }",
          "",
          "[Removed Lines]",
          "76:                 Self::ExternRef(ptr.map(|p| VMExternRef::clone_from_raw(p.as_ptr())))",
          "",
          "[Added Lines]",
          "81:                 Self::ExternRef(ptr.and_then(|p| VMExternRef::clone_from_raw(p.as_ptr())))",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "112:     pub(crate) unsafe fn into_ref_asserting_initialized(self) -> *mut u8 {",
          "113:         match self {",
          "114:             Self::FuncRef(e) => e.cast(),",
          "116:             Self::UninitFunc => panic!(\"Uninitialized table element value outside of table slot\"),",
          "117:         }",
          "118:     }",
          "",
          "[Removed Lines]",
          "115:             Self::ExternRef(e) => e.map_or(ptr::null_mut(), |e| e.into_raw()),",
          "",
          "[Added Lines]",
          "121:             Self::ExternRef(e) => e.map_or(ptr::null_mut(), |e| e.into_raw()),",
          "",
          "---------------"
        ],
        "crates/runtime/src/vmcontext.rs||crates/runtime/src/vmcontext.rs": [
          "File: crates/runtime/src/vmcontext.rs -> crates/runtime/src/vmcontext.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "390: #[cfg(test)]",
          "391: mod test_vmglobal_definition {",
          "392:     use super::VMGlobalDefinition;",
          "394:     use std::mem::{align_of, size_of};",
          "395:     use wasmtime_environ::{Module, PtrSize, VMOffsets};",
          "",
          "[Removed Lines]",
          "393:     use crate::externref::VMExternRef;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "421:     }",
          "423:     #[test]",
          "424:     fn check_vmglobal_can_contain_externref() {",
          "425:         assert!(size_of::<VMExternRef>() <= size_of::<VMGlobalDefinition>());",
          "426:     }",
          "427: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "423:     #[cfg(feature = \"gc\")]",
          "425:         use crate::externref::VMExternRef;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "536:     pub unsafe fn as_externref(&self) -> &Option<VMExternRef> {",
          "538:     }",
          "541:     pub unsafe fn as_externref_mut(&mut self) -> &mut Option<VMExternRef> {",
          "543:             .storage",
          "544:             .as_mut()",
          "545:             .as_mut_ptr()",
          "547:     }",
          "",
          "[Removed Lines]",
          "537:         &*(self.storage.as_ref().as_ptr().cast::<Option<VMExternRef>>())",
          "542:         &mut *(self",
          "546:             .cast::<Option<VMExternRef>>())",
          "",
          "[Added Lines]",
          "538:         let ret = &*(self.storage.as_ref().as_ptr().cast::<Option<VMExternRef>>());",
          "539:         assert!(cfg!(feature = \"gc\") || ret.is_none());",
          "540:         ret",
          "545:         let ret = &mut *(self",
          "549:             .cast::<Option<VMExternRef>>());",
          "550:         assert!(cfg!(feature = \"gc\") || ret.is_none());",
          "551:         ret",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "707:         #[repr(C)]",
          "708:         pub struct VMBuiltinFunctionsArray {",
          "709:             $(",
          "710:                 $name: unsafe extern \"C\" fn(",
          "711:                     $(define_builtin_array!(@ty $param)),*",
          "712:                 ) $( -> define_builtin_array!(@ty $result))?,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "715:                 $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "714:         }",
          "716:         impl VMBuiltinFunctionsArray {",
          "717:             pub const INIT: VMBuiltinFunctionsArray = VMBuiltinFunctionsArray {",
          "719:             };",
          "720:         }",
          "721:     };",
          "",
          "[Removed Lines]",
          "718:                 $($name: crate::libcalls::trampolines::$name,)*",
          "",
          "[Added Lines]",
          "723:             #[allow(unused_doc_comments)]",
          "725:                 $(",
          "726:                     $( #[ $attr ] )*",
          "727:                     $name: crate::libcalls::trampolines::$name,",
          "728:                 )*",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1098:     #[inline]",
          "1099:     pub fn externref(i: *mut c_void) -> ValRaw {",
          "1100:         ValRaw {",
          "1101:             externref: Strict::map_addr(i, |i| i.to_le()),",
          "1102:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1110:         assert!(cfg!(feature = \"gc\") || i.is_null());",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1154:     #[inline]",
          "1155:     pub fn get_externref(&self) -> *mut c_void {",
          "1157:     }",
          "1158: }",
          "",
          "[Removed Lines]",
          "1156:         unsafe { Strict::map_addr(self.externref, |i| usize::from_le(i)) }",
          "",
          "[Added Lines]",
          "1167:         let ptr = unsafe { Strict::map_addr(self.externref, |i| usize::from_le(i)) };",
          "1168:         assert!(cfg!(feature = \"gc\") || ptr.is_null());",
          "1169:         ptr",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/config.rs||crates/wasmtime/src/config.rs": [
          "File: crates/wasmtime/src/config.rs -> crates/wasmtime/src/config.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "252:             ret.cranelift_opt_level(OptLevel::Speed);",
          "253:         }",
          "255:         ret.wasm_reference_types(true);",
          "256:         ret.wasm_multi_value(true);",
          "257:         ret.wasm_bulk_memory(true);",
          "258:         ret.wasm_simd(true);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "255:         #[cfg(feature = \"gc\")]",
          "257:         #[cfg(not(feature = \"gc\"))]",
          "258:         {",
          "259:             ret.features.reference_types = false;",
          "260:             ret.features.function_references = false;",
          "261:             ret.features.gc = false;",
          "262:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "732:     pub fn wasm_reference_types(&mut self, enable: bool) -> &mut Self {",
          "733:         self.features.reference_types = enable;",
          "734:         self",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "740:     #[cfg(feature = \"gc\")]",
          "741:     #[cfg_attr(docsrs, doc(cfg(feature = \"gc\")))]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "750:     pub fn wasm_function_references(&mut self, enable: bool) -> &mut Self {",
          "751:         self.features.function_references = enable;",
          "752:         self",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "760:     #[cfg(feature = \"gc\")]",
          "761:     #[cfg_attr(docsrs, doc(cfg(feature = \"gc\")))]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "770:     pub fn wasm_gc(&mut self, enable: bool) -> &mut Self {",
          "771:         self.features.gc = enable;",
          "772:         self",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "782:     #[cfg(feature = \"gc\")]",
          "783:     #[cfg_attr(docsrs, doc(cfg(feature = \"gc\")))]",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/engine/serialization.rs||crates/wasmtime/src/engine/serialization.rs": [
          "File: crates/wasmtime/src/engine/serialization.rs -> crates/wasmtime/src/engine/serialization.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: use crate::{Engine, ModuleVersionStrategy, Precompiled};",
          "26: use object::write::{Object, StandardSegment};",
          "27: use object::{File, FileFlags, Object as _, ObjectSection, SectionKind};",
          "28: use serde_derive::{Deserialize, Serialize};",
          "",
          "[Removed Lines]",
          "25: use anyhow::{anyhow, bail, Context, Result};",
          "",
          "[Added Lines]",
          "25: use anyhow::{anyhow, bail, ensure, Context, Result};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "406:         Ok(())",
          "407:     }",
          "409:     fn check_features(&mut self, other: &wasmparser::WasmFeatures) -> Result<()> {",
          "410:         let WasmFeatures {",
          "411:             reference_types,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "409:     fn check_cfg_bool(",
          "410:         cfg: bool,",
          "411:         cfg_str: &str,",
          "412:         found: bool,",
          "413:         expected: bool,",
          "414:         feature: &str,",
          "415:     ) -> Result<()> {",
          "416:         if cfg {",
          "417:             Self::check_bool(found, expected, feature)",
          "418:         } else {",
          "419:             assert!(!expected);",
          "420:             ensure!(",
          "421:                 !found,",
          "422:                 \"Module was compiled with {feature} but support in the host \\",
          "423:                  was disabled at compile time because the `{cfg_str}` Cargo \\",
          "424:                  feature was not enabled\",",
          "425:             );",
          "426:             Ok(())",
          "427:         }",
          "428:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "424:             gc,",
          "425:         } = self.features;",
          "428:             reference_types,",
          "429:             other.reference_types,",
          "430:             \"WebAssembly reference types support\",",
          "431:         )?;",
          "432:         Self::check_bool(",
          "433:             multi_value,",
          "434:             other.multi_value,",
          "",
          "[Removed Lines]",
          "427:         Self::check_bool(",
          "",
          "[Added Lines]",
          "448:         Self::check_cfg_bool(",
          "449:             cfg!(feature = \"gc\"),",
          "450:             \"gc\",",
          "455:         Self::check_cfg_bool(",
          "456:             cfg!(feature = \"gc\"),",
          "457:             \"gc\",",
          "458:             function_references,",
          "459:             other.function_references,",
          "460:             \"WebAssembly function-references support\",",
          "461:         )?;",
          "462:         Self::check_cfg_bool(",
          "463:             cfg!(feature = \"gc\"),",
          "464:             \"gc\",",
          "465:             gc,",
          "466:             other.gc,",
          "467:             \"WebAssembly garbage collection support\",",
          "468:         )?;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "472:             other.relaxed_simd,",
          "473:             \"WebAssembly relaxed-simd support\",",
          "474:         )?;",
          "482:         Ok(())",
          "483:     }",
          "",
          "[Removed Lines]",
          "475:         Self::check_bool(",
          "476:             function_references,",
          "477:             other.function_references,",
          "478:             \"WebAssembly function-references support\",",
          "479:         )?;",
          "480:         Self::check_bool(gc, other.gc, \"WebAssembly garbage collection support\")?;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime.rs||crates/wasmtime/src/runtime.rs": [
          "File: crates/wasmtime/src/runtime.rs -> crates/wasmtime/src/runtime.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: pub(crate) mod trap;",
          "22: pub(crate) mod type_registry;",
          "23: pub(crate) mod types;",
          "24: pub(crate) mod v128;",
          "25: pub(crate) mod values;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24: pub(crate) mod uninhabited;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "66: pub use v128::V128;",
          "67: pub use values::*;",
          "69: #[cfg(feature = \"profiling\")]",
          "70: pub use profiling::GuestProfiler;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: pub(crate) use uninhabited::*;",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/externals/global.rs||crates/wasmtime/src/runtime/externals/global.rs": [
          "File: crates/wasmtime/src/runtime/externals/global.rs -> crates/wasmtime/src/runtime/externals/global.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "110:                 ValType::V128 => Val::V128((*definition.as_u128()).into()),",
          "111:                 ValType::Ref(ref_ty) => {",
          "112:                     let reference = match ref_ty.heap_type() {",
          "113:                         HeapType::Extern => Ref::Extern(",
          "114:                             definition",
          "115:                                 .as_externref()",
          "116:                                 .clone()",
          "118:                         ),",
          "123:                     };",
          "124:                     debug_assert!(",
          "125:                         ref_ty.is_nullable() || !reference.is_null(),",
          "",
          "[Removed Lines]",
          "117:                                 .map(|inner| ExternRef { inner }),",
          "119:                         HeapType::Func | HeapType::Concrete(_) => {",
          "120:                             Ref::Func(Func::from_raw(store, definition.as_func_ref().cast()))",
          "121:                         }",
          "122:                         HeapType::NoFunc => Ref::Func(None),",
          "",
          "[Added Lines]",
          "113:                         HeapType::Func | HeapType::Concrete(_) => {",
          "114:                             Ref::Func(Func::from_raw(store, definition.as_func_ref().cast()))",
          "115:                         }",
          "117:                         HeapType::NoFunc => Ref::Func(None),",
          "123:                                 .map(|inner| ExternRef::from_vm_extern_ref(inner)),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "165:                 Val::ExternRef(e) => {",
          "169:                     drop(old);",
          "170:                 }",
          "171:             }",
          "",
          "[Removed Lines]",
          "168:                     let old = mem::replace(definition.as_externref_mut(), e.map(|e| e.inner));",
          "",
          "[Added Lines]",
          "170:                     let old = mem::replace(",
          "171:                         definition.as_externref_mut(),",
          "172:                         e.map(|e| e.into_vm_extern_ref()),",
          "173:                     );",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/externals/table.rs||crates/wasmtime/src/runtime/externals/table.rs": [
          "File: crates/wasmtime/src/runtime/externals/table.rs -> crates/wasmtime/src/runtime/externals/table.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "154:                     let func = Func::from_vm_func_ref(store, f);",
          "155:                     Some(func.into())",
          "156:                 }",
          "157:                 runtime::TableElement::ExternRef(None) => Some(Ref::Extern(None)),",
          "158:                 runtime::TableElement::ExternRef(Some(x)) => {",
          "160:                     Some(x.into())",
          "161:                 }",
          "165:             }",
          "166:         }",
          "167:     }",
          "",
          "[Removed Lines]",
          "159:                     let x = ExternRef { inner: x };",
          "162:                 runtime::TableElement::UninitFunc => {",
          "163:                     unreachable!(\"lazy init above should have converted UninitFunc\")",
          "164:                 }",
          "",
          "[Added Lines]",
          "158:                 runtime::TableElement::UninitFunc => {",
          "159:                     unreachable!(\"lazy init above should have converted UninitFunc\")",
          "160:                 }",
          "164:                 #[cfg_attr(not(feature = \"gc\"), allow(unreachable_code, unused_variables))]",
          "166:                     let x = ExternRef::from_vm_extern_ref(x);",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/func.rs||crates/wasmtime/src/runtime/func.rs": [
          "File: crates/wasmtime/src/runtime/func.rs -> crates/wasmtime/src/runtime/func.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: use crate::store::{StoreData, StoreOpaque, Stored};",
          "2: use crate::type_registry::RegisteredType;",
          "3: use crate::{",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: use crate::runtime::Uninhabited;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "78:     _inner: Uninhabited,",
          "79: }",
          "84: impl NoFunc {",
          "86:     #[inline]",
          "",
          "[Removed Lines]",
          "81: #[derive(Copy, Clone, Debug, PartialEq, Eq)]",
          "82: enum Uninhabited {}",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1159:         let values_vec_size = params.len().max(ty.results().len());",
          "1173:         {",
          "1175:         }",
          "",
          "[Removed Lines]",
          "1168:         if ty.as_wasm_func_type().externref_params_count()",
          "1169:             > store",
          "1170:                 .0",
          "1171:                 .externref_activations_table()",
          "1172:                 .bump_capacity_remaining()",
          "1174:             store.gc();",
          "",
          "[Added Lines]",
          "1159:         #[cfg(feature = \"gc\")]",
          "1168:             if ty.as_wasm_func_type().externref_params_count()",
          "1169:                 > store",
          "1170:                     .0",
          "1171:                     .externref_activations_table()",
          "1172:                     .bump_capacity_remaining()",
          "1173:             {",
          "1174:                 store.gc();",
          "1175:             }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1307:         let (params, results) = val_vec.split_at_mut(nparams);",
          "1308:         func(caller.sub_caller(), params, results)?;",
          "1317:         {",
          "1319:         }",
          "",
          "[Removed Lines]",
          "1311:         if ty.as_wasm_func_type().externref_returns_count()",
          "1312:             > caller",
          "1313:                 .store",
          "1314:                 .0",
          "1315:                 .externref_activations_table()",
          "1316:                 .bump_capacity_remaining()",
          "1318:             caller.store.gc();",
          "",
          "[Added Lines]",
          "1311:         #[cfg(feature = \"gc\")]",
          "1314:             if ty.as_wasm_func_type().externref_returns_count()",
          "1315:                 > caller",
          "1316:                     .store",
          "1317:                     .0",
          "1318:                     .externref_activations_table()",
          "1319:                     .bump_capacity_remaining()",
          "1320:             {",
          "1321:                 caller.store.gc();",
          "1322:             }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2026:     pub fn gc(&mut self) {",
          "2027:         self.store.gc()",
          "2028:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2030:     #[cfg(feature = \"gc\")]",
          "2031:     #[cfg_attr(docsrs, doc(cfg(feature = \"gc\")))]",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/func/typed.rs||crates/wasmtime/src/runtime/func/typed.rs": [
          "File: crates/wasmtime/src/runtime/func/typed.rs -> crates/wasmtime/src/runtime/func/typed.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:             Self::debug_typecheck(store.0, func.as_ref().type_index);",
          "157:         }",
          "165:         {",
          "167:         }",
          "",
          "[Removed Lines]",
          "160:         if params.externrefs_count()",
          "161:             > store",
          "162:                 .0",
          "163:                 .externref_activations_table()",
          "164:                 .bump_capacity_remaining()",
          "166:             store.gc();",
          "",
          "[Added Lines]",
          "159:         #[cfg(feature = \"gc\")]",
          "162:             if params.externrefs_count()",
          "163:                 > store",
          "164:                     .0",
          "165:                     .externref_activations_table()",
          "166:                     .bump_capacity_remaining()",
          "167:             {",
          "168:                 store.gc();",
          "169:             }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "423:     f64/u64/get_f64 => F64",
          "424: }",
          "426: unsafe impl WasmTy for ExternRef {",
          "427:     type Abi = NonNull<u8>;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "429: #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "461:     #[inline]",
          "462:     fn into_abi(self, store: &mut StoreOpaque) -> Self::Abi {",
          "464:         unsafe {",
          "",
          "[Removed Lines]",
          "463:         let abi = self.inner.as_raw();",
          "",
          "[Added Lines]",
          "467:         let inner = self.into_vm_extern_ref();",
          "468:         let abi = inner.as_raw();",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "493:             let mut store = AutoAssertNoGc::new(store);",
          "496:             debug_assert!(!abi.is_null());",
          "497:             NonNull::new_unchecked(abi)",
          "",
          "[Removed Lines]",
          "494:             store.insert_vmexternref_without_gc(self.inner);",
          "",
          "[Added Lines]",
          "499:             store.insert_vmexternref_without_gc(inner);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "501:     #[inline]",
          "502:     unsafe fn from_abi(abi: Self::Abi, _store: &mut StoreOpaque) -> Self {",
          "506:     }",
          "507: }",
          "509: unsafe impl WasmTy for Option<ExternRef> {",
          "510:     type Abi = *mut u8;",
          "",
          "[Removed Lines]",
          "503:         ExternRef {",
          "504:             inner: wasmtime_runtime::VMExternRef::clone_from_raw(abi.as_ptr()),",
          "505:         }",
          "",
          "[Added Lines]",
          "508:         let inner = wasmtime_runtime::VMExternRef::clone_from_raw(abi.as_ptr()).unwrap();",
          "509:         ExternRef::from_vm_extern_ref(inner)",
          "513: #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "551:     #[inline]",
          "552:     unsafe fn from_abi(abi: Self::Abi, _store: &mut StoreOpaque) -> Self {",
          "560:     }",
          "561: }",
          "",
          "[Removed Lines]",
          "553:         if abi.is_null() {",
          "554:             None",
          "555:         } else {",
          "556:             Some(ExternRef {",
          "557:                 inner: wasmtime_runtime::VMExternRef::clone_from_raw(abi),",
          "558:             })",
          "559:         }",
          "",
          "[Added Lines]",
          "558:         let inner = wasmtime_runtime::VMExternRef::clone_from_raw(abi)?;",
          "559:         Some(ExternRef::from_vm_extern_ref(inner))",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/module/registry.rs||crates/wasmtime/src/runtime/module/registry.rs": [
          "File: crates/wasmtime/src/runtime/module/registry.rs -> crates/wasmtime/src/runtime/module/registry.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:     ptr::NonNull,",
          "12:     sync::{Arc, RwLock},",
          "13: };",
          "",
          "[Removed Lines]",
          "14: use wasmtime_runtime::{ModuleInfo, VMSharedTypeIndex, VMWasmCallFunction};",
          "",
          "[Added Lines]",
          "14: use wasmtime_runtime::{VMSharedTypeIndex, VMWasmCallFunction};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "67:     }",
          "71:         let (module, _) = self.module_and_offset(pc)?;",
          "72:         Some(module.module_info())",
          "73:     }",
          "",
          "[Removed Lines]",
          "70:     pub fn lookup_module_info(&self, pc: usize) -> Option<&dyn ModuleInfo> {",
          "",
          "[Added Lines]",
          "70:     pub fn lookup_module_info(&self, pc: usize) -> Option<&dyn wasmtime_runtime::ModuleInfo> {",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/ref.rs||crates/wasmtime/src/runtime/ref.rs": [
          "File: crates/wasmtime/src/runtime/ref.rs -> crates/wasmtime/src/runtime/ref.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: #![allow(missing_docs)]",
          "3: use crate::AsContextMut;",
          "4: use std::any::Any;",
          "5: use std::ffi::c_void;",
          "6: use wasmtime_runtime::VMExternRef;",
          "9: #[derive(Clone, Debug)]",
          "10: #[repr(transparent)]",
          "11: pub struct ExternRef {",
          "12:     pub(crate) inner: VMExternRef,",
          "13: }",
          "15: impl ExternRef {",
          "17:     pub fn new<T>(value: T) -> ExternRef",
          "18:     where",
          "19:         T: 'static + Any + Send + Sync,",
          "20:     {",
          "21:         let inner = VMExternRef::new(value);",
          "22:         ExternRef { inner }",
          "23:     }",
          "26:     pub fn data(&self) -> &dyn Any {",
          "27:         &*self.inner",
          "28:     }",
          "34:     pub fn strong_count(&self) -> usize {",
          "35:         self.inner.strong_count()",
          "36:     }",
          "42:     pub fn ptr_eq(&self, other: &ExternRef) -> bool {",
          "43:         VMExternRef::eq(&self.inner, &other.inner)",
          "44:     }",
          "74:     pub unsafe fn from_raw(raw: *mut c_void) -> Option<ExternRef> {",
          "75:         let raw = raw.cast::<u8>();",
          "76:         if raw.is_null() {",
          "77:             None",
          "78:         } else {",
          "79:             Some(ExternRef {",
          "80:                 inner: VMExternRef::clone_from_raw(raw),",
          "81:             })",
          "82:         }",
          "83:     }",
          "95:     pub unsafe fn to_raw(&self, mut store: impl AsContextMut) -> *mut c_void {",
          "96:         let externref_ptr = self.inner.as_raw();",
          "97:         store",
          "98:             .as_context_mut()",
          "99:             .0",
          "100:             .insert_vmexternref_without_gc(self.inner.clone());",
          "101:         externref_ptr.cast()",
          "102:     }",
          "103: }",
          "105: impl std::fmt::Pointer for ExternRef {",
          "106:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "107:         std::fmt::Pointer::fmt(&self.inner, f)",
          "108:     }",
          "109: }",
          "",
          "[Added Lines]",
          "1: #[cfg(feature = \"gc\")]",
          "2: mod gc_ref;",
          "3: #[cfg(feature = \"gc\")]",
          "4: pub use gc_ref::*;",
          "6: #[cfg(not(feature = \"gc\"))]",
          "7: mod no_gc_ref;",
          "8: #[cfg(not(feature = \"gc\"))]",
          "9: pub use no_gc_ref::*;",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/ref/gc_ref.rs||crates/wasmtime/src/runtime/ref/gc_ref.rs": [
          "File: crates/wasmtime/src/runtime/ref/gc_ref.rs -> crates/wasmtime/src/runtime/ref/gc_ref.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: use crate::AsContextMut;",
          "2: use std::any::Any;",
          "3: use std::ffi::c_void;",
          "4: use wasmtime_runtime::VMExternRef;",
          "7: #[derive(Clone, Debug)]",
          "8: #[repr(transparent)]",
          "9: pub struct ExternRef {",
          "10:     inner: VMExternRef,",
          "11: }",
          "13: impl ExternRef {",
          "15:     pub fn new<T>(value: T) -> ExternRef",
          "16:     where",
          "17:         T: 'static + Any + Send + Sync,",
          "18:     {",
          "19:         let inner = VMExternRef::new(value);",
          "20:         ExternRef { inner }",
          "21:     }",
          "23:     pub(crate) fn from_vm_extern_ref(inner: VMExternRef) -> Self {",
          "24:         ExternRef { inner }",
          "25:     }",
          "27:     pub(crate) fn into_vm_extern_ref(self) -> VMExternRef {",
          "28:         self.inner",
          "29:     }",
          "32:     pub fn data(&self) -> &dyn Any {",
          "33:         &*self.inner",
          "34:     }",
          "40:     pub fn strong_count(&self) -> usize {",
          "41:         self.inner.strong_count()",
          "42:     }",
          "48:     pub fn ptr_eq(&self, other: &ExternRef) -> bool {",
          "49:         VMExternRef::eq(&self.inner, &other.inner)",
          "50:     }",
          "80:     pub unsafe fn from_raw(raw: *mut c_void) -> Option<ExternRef> {",
          "81:         let raw = raw.cast::<u8>();",
          "82:         let inner = VMExternRef::clone_from_raw(raw)?;",
          "83:         Some(ExternRef { inner })",
          "84:     }",
          "96:     pub unsafe fn to_raw(&self, mut store: impl AsContextMut) -> *mut c_void {",
          "97:         let externref_ptr = self.inner.as_raw();",
          "98:         store",
          "99:             .as_context_mut()",
          "100:             .0",
          "101:             .insert_vmexternref_without_gc(self.inner.clone());",
          "102:         externref_ptr.cast()",
          "103:     }",
          "104: }",
          "106: impl std::fmt::Pointer for ExternRef {",
          "107:     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "108:         std::fmt::Pointer::fmt(&self.inner, f)",
          "109:     }",
          "110: }",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/ref/no_gc_ref.rs||crates/wasmtime/src/runtime/ref/no_gc_ref.rs": [
          "File: crates/wasmtime/src/runtime/ref/no_gc_ref.rs -> crates/wasmtime/src/runtime/ref/no_gc_ref.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: #![allow(missing_docs)]",
          "9: use crate::runtime::Uninhabited;",
          "10: use crate::AsContextMut;",
          "11: use std::any::Any;",
          "12: use std::ffi::c_void;",
          "13: use wasmtime_runtime::VMExternRef;",
          "19: #[derive(Clone, Debug)]",
          "20: pub struct ExternRef {",
          "21:     _inner: Uninhabited,",
          "22: }",
          "24: impl ExternRef {",
          "25:     pub(crate) fn from_vm_extern_ref(inner: VMExternRef) -> Self {",
          "26:         inner.assert_unreachable()",
          "27:     }",
          "29:     pub(crate) fn into_vm_extern_ref(self) -> VMExternRef {",
          "30:         match self._inner {}",
          "31:     }",
          "33:     pub fn data(&self) -> &dyn Any {",
          "34:         match self._inner {}",
          "35:     }",
          "37:     pub fn strong_count(&self) -> usize {",
          "38:         match self._inner {}",
          "39:     }",
          "41:     pub fn ptr_eq(&self, _other: &ExternRef) -> bool {",
          "42:         match self._inner {}",
          "43:     }",
          "45:     pub unsafe fn from_raw(raw: *mut c_void) -> Option<ExternRef> {",
          "46:         assert!(raw.is_null());",
          "47:         None",
          "48:     }",
          "50:     pub unsafe fn to_raw(&self, mut store: impl AsContextMut) -> *mut c_void {",
          "51:         let _ = &mut store;",
          "52:         match self._inner {}",
          "53:     }",
          "54: }",
          "56: impl std::fmt::Pointer for ExternRef {",
          "57:     fn fmt(&self, _f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {",
          "58:         match self._inner {}",
          "59:     }",
          "60: }",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/store.rs||crates/wasmtime/src/runtime/store.rs": [
          "File: crates/wasmtime/src/runtime/store.rs -> crates/wasmtime/src/runtime/store.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "97: use std::task::{Context, Poll};",
          "98: use wasmtime_runtime::mpk::{self, ProtectionKey, ProtectionMask};",
          "99: use wasmtime_runtime::{",
          "103: };",
          "105: mod context;",
          "",
          "[Removed Lines]",
          "100:     ExportGlobal, InstanceAllocationRequest, InstanceAllocator, InstanceHandle, ModuleInfo,",
          "101:     OnDemandInstanceAllocator, SignalHandler, StoreBox, StorePtr, VMContext, VMExternRef,",
          "102:     VMExternRefActivationsTable, VMFuncRef, VMRuntimeLimits, WasmFault,",
          "",
          "[Added Lines]",
          "100:     ExportGlobal, InstanceAllocationRequest, InstanceAllocator, InstanceHandle,",
          "101:     OnDemandInstanceAllocator, SignalHandler, StoreBox, StorePtr, VMContext, VMFuncRef,",
          "102:     VMRuntimeLimits, WasmFault,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "307:     #[cfg(feature = \"component-model\")]",
          "308:     num_component_instances: usize,",
          "309:     signal_handler: Option<Box<SignalHandler<'static>>>,",
          "311:     modules: ModuleRegistry,",
          "312:     func_refs: FuncRefs,",
          "313:     host_globals: Vec<StoreBox<VMHostGlobalContext>>,",
          "",
          "[Removed Lines]",
          "310:     externref_activations_table: VMExternRefActivationsTable,",
          "",
          "[Added Lines]",
          "310:     externref_activations_table: wasmtime_runtime::VMExternRefActivationsTable,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "392: where",
          "393:     T: std::ops::DerefMut<Target = StoreOpaque>,",
          "394: {",
          "396:     prev_okay: bool,",
          "397:     store: T,",
          "398: }",
          "",
          "[Removed Lines]",
          "395:     #[cfg(debug_assertions)]",
          "",
          "[Added Lines]",
          "395:     #[cfg(all(debug_assertions, feature = \"gc\"))]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "404:     #[inline]",
          "405:     pub fn new(mut store: T) -> Self {",
          "406:         let _ = &mut store;",
          "408:         {",
          "409:             let prev_okay = store.externref_activations_table.set_gc_okay(false);",
          "410:             return AutoAssertNoGc { store, prev_okay };",
          "411:         }",
          "413:         {",
          "414:             return AutoAssertNoGc { store };",
          "415:         }",
          "",
          "[Removed Lines]",
          "407:         #[cfg(debug_assertions)]",
          "412:         #[cfg(not(debug_assertions))]",
          "",
          "[Added Lines]",
          "407:         #[cfg(all(debug_assertions, feature = \"gc\"))]",
          "412:         #[cfg(not(all(debug_assertions, feature = \"gc\")))]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "441:     T: std::ops::DerefMut<Target = StoreOpaque>,",
          "442: {",
          "443:     fn drop(&mut self) {",
          "445:         {",
          "446:             self.store",
          "447:                 .externref_activations_table",
          "",
          "[Removed Lines]",
          "444:         #[cfg(debug_assertions)]",
          "",
          "[Added Lines]",
          "444:         #[cfg(all(debug_assertions, feature = \"gc\"))]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "497:                 #[cfg(feature = \"component-model\")]",
          "498:                 num_component_instances: 0,",
          "499:                 signal_handler: None,",
          "501:                 modules: ModuleRegistry::default(),",
          "502:                 func_refs: FuncRefs::default(),",
          "503:                 host_globals: Vec::new(),",
          "",
          "[Removed Lines]",
          "500:                 externref_activations_table: VMExternRefActivationsTable::new(),",
          "",
          "[Added Lines]",
          "500:                 externref_activations_table: wasmtime_runtime::VMExternRefActivationsTable::new(),",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "797:     pub fn gc(&mut self) {",
          "798:         self.inner.gc()",
          "799:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "799:     #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1039:     pub fn gc(&mut self) {",
          "1040:         self.0.gc()",
          "1041:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1044:     #[cfg(feature = \"gc\")]",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1374:     }",
          "1376:     #[inline]",
          "1378:         &mut self.externref_activations_table",
          "1379:     }",
          "",
          "[Removed Lines]",
          "1377:     pub fn externref_activations_table(&mut self) -> &mut VMExternRefActivationsTable {",
          "",
          "[Added Lines]",
          "1383:     pub fn externref_activations_table(",
          "1384:         &mut self,",
          "1385:     ) -> &mut wasmtime_runtime::VMExternRefActivationsTable {",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1523:         &self.runtime_limits as *const VMRuntimeLimits as *mut VMRuntimeLimits",
          "1524:     }",
          "1527:         self.externref_activations_table.insert_without_gc(r);",
          "1528:     }",
          "",
          "[Removed Lines]",
          "1526:     pub unsafe fn insert_vmexternref_without_gc(&mut self, r: VMExternRef) {",
          "",
          "[Added Lines]",
          "1534:     pub unsafe fn insert_vmexternref_without_gc(&mut self, r: wasmtime_runtime::VMExternRef) {",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2042:     fn externref_activations_table(",
          "2043:         &mut self,",
          "2044:     ) -> (",
          "2046:         &dyn wasmtime_runtime::ModuleInfoLookup,",
          "2047:     ) {",
          "2048:         let inner = &mut self.inner;",
          "",
          "[Removed Lines]",
          "2045:         &mut VMExternRefActivationsTable,",
          "",
          "[Added Lines]",
          "2053:         &mut wasmtime_runtime::VMExternRefActivationsTable,",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2299: }",
          "2301: impl wasmtime_runtime::ModuleInfoLookup for ModuleRegistry {",
          "2303:         self.lookup_module_info(pc)",
          "2304:     }",
          "2305: }",
          "",
          "[Removed Lines]",
          "2302:     fn lookup(&self, pc: usize) -> Option<&dyn ModuleInfo> {",
          "",
          "[Added Lines]",
          "2310:     fn lookup(&self, pc: usize) -> Option<&dyn wasmtime_runtime::ModuleInfo> {",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/trampoline/global.rs||crates/wasmtime/src/runtime/trampoline/global.rs": [
          "File: crates/wasmtime/src/runtime/trampoline/global.rs -> crates/wasmtime/src/runtime/trampoline/global.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "21:             }",
          "22:             crate::ValType::Ref(r) => match r.heap_type() {",
          "24:                 HeapType::Func | HeapType::Concrete(_) | HeapType::NoFunc => {",
          "26:                 }",
          "27:             },",
          "28:         }",
          "29:     }",
          "",
          "[Removed Lines]",
          "23:                 HeapType::Extern => unsafe { ptr::drop_in_place(self.global.as_externref_mut()) },",
          "",
          "[Added Lines]",
          "26:                 HeapType::Extern => unsafe { ptr::drop_in_place(self.global.as_externref_mut()) },",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/uninhabited.rs||crates/wasmtime/src/runtime/uninhabited.rs": [
          "File: crates/wasmtime/src/runtime/uninhabited.rs -> crates/wasmtime/src/runtime/uninhabited.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4: #[derive(Copy, Clone, Debug, PartialEq, Eq)]",
          "5: pub(crate) enum Uninhabited {}",
          "",
          "---------------"
        ],
        "crates/wasmtime/src/runtime/values.rs||crates/wasmtime/src/runtime/values.rs": [
          "File: crates/wasmtime/src/runtime/values.rs -> crates/wasmtime/src/runtime/values.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "178:             Val::V128(b) => ValRaw::v128(b.as_u128()),",
          "179:             Val::ExternRef(e) => {",
          "180:                 let externref = match e {",
          "182:                     None => ptr::null_mut(),",
          "183:                 };",
          "184:                 ValRaw::externref(externref)",
          "185:             }",
          "",
          "[Removed Lines]",
          "181:                     Some(e) => e.to_raw(store),",
          "",
          "[Added Lines]",
          "182:                     Some(e) => e.to_raw(store),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "209:             ValType::V128 => Val::V128(raw.get_v128().into()),",
          "210:             ValType::Ref(ref_ty) => {",
          "211:                 let ref_ = match ref_ty.heap_type() {",
          "213:                     HeapType::Func | HeapType::Concrete(_) => {",
          "214:                         Func::from_raw(store, raw.get_funcref()).into()",
          "215:                     }",
          "216:                     HeapType::NoFunc => Ref::Func(None),",
          "217:                 };",
          "218:                 assert!(",
          "219:                     ref_ty.is_nullable() || !ref_.is_null(),",
          "",
          "[Removed Lines]",
          "212:                     HeapType::Extern => ExternRef::from_raw(raw.get_externref()).into(),",
          "",
          "[Added Lines]",
          "216:                     HeapType::Extern => ExternRef::from_raw(raw.get_externref()).into(),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "689:                 );",
          "690:                 Ok(TableElement::FuncRef(f.vm_func_ref(store).as_ptr()))",
          "691:             }",
          "692:             (Ref::Extern(e), HeapType::Extern) => match e {",
          "693:                 None => {",
          "694:                     assert!(ty.is_nullable());",
          "695:                     Ok(TableElement::ExternRef(None))",
          "696:                 }",
          "698:             },",
          "699:             _ => unreachable!(\"checked that the value matches the type above\"),",
          "700:         }",
          "701:     }",
          "",
          "[Removed Lines]",
          "697:                 Some(e) => Ok(TableElement::ExternRef(Some(e.inner))),",
          "",
          "[Added Lines]",
          "698:                 Some(e) => Ok(TableElement::ExternRef(Some(e.into_vm_extern_ref()))),",
          "",
          "---------------"
        ],
        "winch/codegen/src/codegen/builtin.rs||winch/codegen/src/codegen/builtin.rs": [
          "File: winch/codegen/src/codegen/builtin.rs -> winch/codegen/src/codegen/builtin.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "94:             nearest_f64: Option<BuiltinFunction>,",
          "95:             $(",
          "96:                 $name: Option<BuiltinFunction>,",
          "97:             )*",
          "98:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "96:                 $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "102:         impl BuiltinFunctions {",
          "103:             pub fn new<P: PtrSize>(vmoffsets: &VMOffsets<P>, call_conv: CallingConvention) -> Self {",
          "104:                 let size = vmoffsets.ptr.size();",
          "105:                 Self {",
          "106:                     ptr_size: size,",
          "107:                     call_conv,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "106:                 #[allow(unused_doc_comments)]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "116:                     nearest_f32: None,",
          "117:                     nearest_f64: None,",
          "118:                     $(",
          "119:                         $name: None,",
          "120:                     )*",
          "121:                 }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "121:                         $( #[ $attr ] )*",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "246:             }",
          "248:             $(",
          "249:                 pub(crate) fn $name<A: ABI, P: PtrSize>(&mut self) -> BuiltinFunction {",
          "250:                     if self.$name.is_none() {",
          "251:                         let params = vec![ $(self.$param() ),* ];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "252:                 $( #[ $attr ] )*",
          "",
          "---------------"
        ],
        "winch/filetests/filetests/x64/table/fill.wat||winch/filetests/filetests/x64/table/fill.wat": [
          "File: winch/filetests/filetests/x64/table/fill.wat -> winch/filetests/filetests/x64/table/fill.wat",
          "--- Hunk 1 ---",
          "[Context before]",
          "118: ;;   c1:  4883e0fe              and rax, 0xfffffffffffffffe",
          "119: ;;        4889442404            mov qword ptr [rsp + 4], rax",
          "120: ;;        4d8b5e38              mov r11, qword ptr [r14 + 0x38]",
          "122: ;;        448b5c2414            mov r11d, dword ptr [rsp + 0x14]",
          "123: ;;        4883ec04              sub rsp, 4",
          "124: ;;        44891c24              mov dword ptr [rsp], r11d",
          "",
          "[Removed Lines]",
          "121: ;;        498b4368              mov rax, qword ptr [r11 + 0x68]",
          "",
          "[Added Lines]",
          "121: ;;        498b4358              mov rax, qword ptr [r11 + 0x58]",
          "",
          "---------------"
        ]
      }
    }
  ]
}