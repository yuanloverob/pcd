{
  "cve_id": "CVE-2023-45809",
  "cve_desc": "Wagtail is an open source content management system built on Django. A user with a limited-permission editor account for the Wagtail admin can make a direct URL request to the admin view that handles bulk actions on user accounts. While authentication rules prevent the user from making any changes, the error message discloses the display names of user accounts, and by modifying URL parameters, the user can retrieve the display name for any user. The vulnerability is not exploitable by an ordinary site visitor without access to the Wagtail admin. Patched versions have been released as Wagtail 4.1.8 (LTS), 5.0.5 and 5.1.3. The fix is also included in Release Candidate 1 of the forthcoming Wagtail 5.2 release. Users are advised to upgrade. There are no known workarounds for this vulnerability.",
  "repo": "wagtail/wagtail",
  "patch_hash": "bc96aed6ac53f998b2f4c4bf97e2d4f5fe337e5b",
  "patch_info": {
    "commit_hash": "bc96aed6ac53f998b2f4c4bf97e2d4f5fe337e5b",
    "repo": "wagtail/wagtail",
    "commit_url": "https://github.com/wagtail/wagtail/commit/bc96aed6ac53f998b2f4c4bf97e2d4f5fe337e5b",
    "files": [
      "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
      "wagtail/users/views/bulk_actions/user_bulk_action.py"
    ],
    "message": "Redirect away from user bulk actions when user has no permissions on users",
    "before_after_code_files": [
      "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
      "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
    ]
  },
  "patch_diff": {
    "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py": [
      "File: wagtail/users/tests/test_bulk_actions/test_bulk_delete.py -> wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: from django.contrib.auth import get_user_model",
      "2: from django.http import HttpRequest, HttpResponse",
      "3: from django.test import TestCase",
      "4: from django.urls import reverse",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2: from django.contrib.auth.models import Permission",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "51:             response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
      "52:         )",
      "54:     def test_bulk_delete(self):",
      "55:         response = self.client.post(self.url)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "55:     def test_user_permissions_required(self):",
      "56:         # Log in with a user that doesn't have permission to delete users",
      "57:         user = self.create_user(username=\"editor\", password=\"password\")",
      "58:         admin_permission = Permission.objects.get(",
      "59:             content_type__app_label=\"wagtailadmin\", codename=\"access_admin\"",
      "60:         )",
      "61:         user.user_permissions.add(admin_permission)",
      "62:         self.login(username=\"editor\", password=\"password\")",
      "64:         response = self.client.get(self.url)",
      "65:         self.assertRedirects(response, \"/admin/\")",
      "",
      "---------------"
    ],
    "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py": [
      "File: wagtail/users/views/bulk_actions/user_bulk_action.py -> wagtail/users/views/bulk_actions/user_bulk_action.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: from django.contrib.auth import get_user_model",
      "3: from wagtail.admin.views.bulk_action import BulkAction",
      "4: from wagtail.users.views.users import get_users_filter_query",
      "10:     def get_all_objects_in_listing_query(self, parent_id):",
      "11:         listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
      "",
      "[Removed Lines]",
      "7: class UserBulkAction(BulkAction):",
      "8:     models = [get_user_model()]",
      "",
      "[Added Lines]",
      "4: from wagtail.admin.views.generic.permissions import PermissionCheckedMixin",
      "5: from wagtail.permission_policies import ModelPermissionPolicy",
      "8: User = get_user_model()",
      "11: class UserBulkAction(PermissionCheckedMixin, BulkAction):",
      "12:     models = [User]",
      "13:     permission_policy = ModelPermissionPolicy(User)",
      "14:     any_permission_required = [\"add\", \"change\", \"delete\"]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0bacd29473107d9d7f5b723a15a683449679756d",
      "candidate_info": {
        "commit_hash": "0bacd29473107d9d7f5b723a15a683449679756d",
        "repo": "wagtail/wagtail",
        "commit_url": "https://github.com/wagtail/wagtail/commit/0bacd29473107d9d7f5b723a15a683449679756d",
        "files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py"
        ],
        "message": "Redirect away from user bulk actions when user has no permissions on users",
        "before_after_code_files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ],
          "candidate": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ]
        }
      },
      "candidate_diff": {
        "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py": [
          "File: wagtail/users/tests/test_bulk_actions/test_bulk_delete.py -> wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "2: from django.http import HttpRequest, HttpResponse",
          "3: from django.test import TestCase",
          "4: from django.urls import reverse",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: from django.contrib.auth.models import Permission",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:             response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
          "52:         )",
          "54:     def test_bulk_delete(self):",
          "55:         response = self.client.post(self.url)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:     def test_user_permissions_required(self):",
          "56:         # Log in with a user that doesn't have permission to delete users",
          "57:         user = self.create_user(username=\"editor\", password=\"password\")",
          "58:         admin_permission = Permission.objects.get(",
          "59:             content_type__app_label=\"wagtailadmin\", codename=\"access_admin\"",
          "60:         )",
          "61:         user.user_permissions.add(admin_permission)",
          "62:         self.login(username=\"editor\", password=\"password\")",
          "64:         response = self.client.get(self.url)",
          "65:         self.assertRedirects(response, \"/admin/\")",
          "",
          "---------------"
        ],
        "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py": [
          "File: wagtail/users/views/bulk_actions/user_bulk_action.py -> wagtail/users/views/bulk_actions/user_bulk_action.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "3: from wagtail.admin.views.bulk_action import BulkAction",
          "4: from wagtail.users.views.users import get_users_filter_query",
          "10:     def get_all_objects_in_listing_query(self, parent_id):",
          "11:         listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
          "",
          "[Removed Lines]",
          "7: class UserBulkAction(BulkAction):",
          "8:     models = [get_user_model()]",
          "",
          "[Added Lines]",
          "4: from wagtail.admin.views.generic.permissions import PermissionCheckedMixin",
          "5: from wagtail.permission_policies import ModelPermissionPolicy",
          "8: User = get_user_model()",
          "11: class UserBulkAction(PermissionCheckedMixin, BulkAction):",
          "12:     models = [User]",
          "13:     permission_policy = ModelPermissionPolicy(User)",
          "14:     any_permission_required = [\"add\", \"change\", \"delete\"]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2231f462c75dfe84307fb40577e8c2109a23b27e",
      "candidate_info": {
        "commit_hash": "2231f462c75dfe84307fb40577e8c2109a23b27e",
        "repo": "wagtail/wagtail",
        "commit_url": "https://github.com/wagtail/wagtail/commit/2231f462c75dfe84307fb40577e8c2109a23b27e",
        "files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py"
        ],
        "message": "Redirect away from user bulk actions when user has no permissions on users",
        "before_after_code_files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ],
          "candidate": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ]
        }
      },
      "candidate_diff": {
        "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py": [
          "File: wagtail/users/tests/test_bulk_actions/test_bulk_delete.py -> wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "2: from django.http import HttpRequest, HttpResponse",
          "3: from django.test import TestCase",
          "4: from django.urls import reverse",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: from django.contrib.auth.models import Permission",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:             response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
          "52:         )",
          "54:     def test_bulk_delete(self):",
          "55:         response = self.client.post(self.url)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:     def test_user_permissions_required(self):",
          "56:         # Log in with a user that doesn't have permission to delete users",
          "57:         user = self.create_user(username=\"editor\", password=\"password\")",
          "58:         admin_permission = Permission.objects.get(",
          "59:             content_type__app_label=\"wagtailadmin\", codename=\"access_admin\"",
          "60:         )",
          "61:         user.user_permissions.add(admin_permission)",
          "62:         self.login(username=\"editor\", password=\"password\")",
          "64:         response = self.client.get(self.url)",
          "65:         self.assertRedirects(response, \"/admin/\")",
          "",
          "---------------"
        ],
        "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py": [
          "File: wagtail/users/views/bulk_actions/user_bulk_action.py -> wagtail/users/views/bulk_actions/user_bulk_action.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "3: from wagtail.admin.views.bulk_action import BulkAction",
          "4: from wagtail.users.views.users import get_users_filter_query",
          "10:     def get_all_objects_in_listing_query(self, parent_id):",
          "11:         listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
          "",
          "[Removed Lines]",
          "7: class UserBulkAction(BulkAction):",
          "8:     models = [get_user_model()]",
          "",
          "[Added Lines]",
          "4: from wagtail.admin.views.generic.permissions import PermissionCheckedMixin",
          "5: from wagtail.permission_policies import ModelPermissionPolicy",
          "8: User = get_user_model()",
          "11: class UserBulkAction(PermissionCheckedMixin, BulkAction):",
          "12:     models = [User]",
          "13:     permission_policy = ModelPermissionPolicy(User)",
          "14:     any_permission_required = [\"add\", \"change\", \"delete\"]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8ec42858f92bd84be1ca4278ce63c63b7f37f0aa",
      "candidate_info": {
        "commit_hash": "8ec42858f92bd84be1ca4278ce63c63b7f37f0aa",
        "repo": "wagtail/wagtail",
        "commit_url": "https://github.com/wagtail/wagtail/commit/8ec42858f92bd84be1ca4278ce63c63b7f37f0aa",
        "files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py"
        ],
        "message": "Redirect away from user bulk actions when user has no permissions on users",
        "before_after_code_files": [
          "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ],
          "candidate": [
            "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
            "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py"
          ]
        }
      },
      "candidate_diff": {
        "wagtail/users/tests/test_bulk_actions/test_bulk_delete.py||wagtail/users/tests/test_bulk_actions/test_bulk_delete.py": [
          "File: wagtail/users/tests/test_bulk_actions/test_bulk_delete.py -> wagtail/users/tests/test_bulk_actions/test_bulk_delete.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "2: from django.http import HttpRequest, HttpResponse",
          "3: from django.test import TestCase",
          "4: from django.urls import reverse",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: from django.contrib.auth.models import Permission",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:             response, \"wagtailusers/bulk_actions/confirm_bulk_delete.html\"",
          "52:         )",
          "54:     def test_bulk_delete(self):",
          "55:         response = self.client.post(self.url)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:     def test_user_permissions_required(self):",
          "56:         # Log in with a user that doesn't have permission to delete users",
          "57:         user = self.create_user(username=\"editor\", password=\"password\")",
          "58:         admin_permission = Permission.objects.get(",
          "59:             content_type__app_label=\"wagtailadmin\", codename=\"access_admin\"",
          "60:         )",
          "61:         user.user_permissions.add(admin_permission)",
          "62:         self.login(username=\"editor\", password=\"password\")",
          "64:         response = self.client.get(self.url)",
          "65:         self.assertRedirects(response, \"/admin/\")",
          "",
          "---------------"
        ],
        "wagtail/users/views/bulk_actions/user_bulk_action.py||wagtail/users/views/bulk_actions/user_bulk_action.py": [
          "File: wagtail/users/views/bulk_actions/user_bulk_action.py -> wagtail/users/views/bulk_actions/user_bulk_action.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: from django.contrib.auth import get_user_model",
          "3: from wagtail.admin.views.bulk_action import BulkAction",
          "4: from wagtail.users.views.users import get_users_filter_query",
          "10:     def get_all_objects_in_listing_query(self, parent_id):",
          "11:         listing_objects = self.model.objects.all().values_list(\"pk\", flat=True)",
          "",
          "[Removed Lines]",
          "7: class UserBulkAction(BulkAction):",
          "8:     models = [get_user_model()]",
          "",
          "[Added Lines]",
          "4: from wagtail.admin.views.generic.permissions import PermissionCheckedMixin",
          "5: from wagtail.permission_policies import ModelPermissionPolicy",
          "8: User = get_user_model()",
          "11: class UserBulkAction(PermissionCheckedMixin, BulkAction):",
          "12:     models = [User]",
          "13:     permission_policy = ModelPermissionPolicy(User)",
          "14:     any_permission_required = [\"add\", \"change\", \"delete\"]",
          "",
          "---------------"
        ]
      }
    }
  ]
}