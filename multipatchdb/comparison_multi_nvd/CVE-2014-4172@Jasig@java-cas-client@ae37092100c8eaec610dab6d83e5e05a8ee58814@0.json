{
  "cve_id": "CVE-2014-4172",
  "cve_desc": "A URL parameter injection vulnerability was found in the back-channel ticket validation step of the CAS protocol in Jasig Java CAS Client before 3.3.2, .NET CAS Client before 1.0.2, and phpCAS before 1.3.3 that allow remote attackers to inject arbitrary web script or HTML via the (1) service parameter to validation/AbstractUrlBasedTicketValidator.java or (2) pgtUrl parameter to validation/Cas20ServiceTicketValidator.java.",
  "repo": "Jasig/java-cas-client",
  "patch_hash": "ae37092100c8eaec610dab6d83e5e05a8ee58814",
  "patch_info": {
    "commit_hash": "ae37092100c8eaec610dab6d83e5e05a8ee58814",
    "repo": "Jasig/java-cas-client",
    "commit_url": "https://github.com/Jasig/java-cas-client/commit/ae37092100c8eaec610dab6d83e5e05a8ee58814",
    "files": [
      "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
      "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
      "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
    ],
    "message": "CASC-228 URL Encode Paramaters Passed to Server via Validate\n\nProblem: We currently don't pass encoded values to the server, possibly resolving in parsing/extraction errors.\nSolution: URL Encode all values instead of just the service url.\n\nQA Notes: Added unit test.",
    "before_after_code_files": [
      "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
      "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
      "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
    ]
  },
  "patch_diff": {
    "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java": [
      "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "111:         logger.debug(\"Placing URL parameters in map.\");",
      "112:         urlParameters.put(\"ticket\", ticket);",
      "115:         if (this.renew) {",
      "116:             urlParameters.put(\"renew\", \"true\");",
      "",
      "[Removed Lines]",
      "113:         urlParameters.put(\"service\", encodeUrl(serviceUrl));",
      "",
      "[Added Lines]",
      "113:         urlParameters.put(\"service\", serviceUrl);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "144:                 buffer.append(i++ == 0 ? \"?\" : \"&\");",
      "145:                 buffer.append(key);",
      "146:                 buffer.append(\"=\");",
      "148:             }",
      "149:         }",
      "",
      "[Removed Lines]",
      "147:                 buffer.append(value);",
      "",
      "[Added Lines]",
      "147:                 final String encodedValue = encodeUrl(value);",
      "148:                 buffer.append(encodedValue);",
      "",
      "---------------"
    ],
    "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java": [
      "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "72:     protected final void populateUrlAttributeMap(final Map<String, String> urlParameters) {",
      "74:     }",
      "76:     protected String getUrlSuffix() {",
      "",
      "[Removed Lines]",
      "73:         urlParameters.put(\"pgtUrl\", encodeUrl(this.proxyCallbackUrl));",
      "",
      "[Added Lines]",
      "73:         urlParameters.put(\"pgtUrl\", this.proxyCallbackUrl);",
      "",
      "---------------"
    ],
    "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java": [
      "File: cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java -> cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: package org.jasig.cas.client.validation;",
      "23: import java.io.UnsupportedEncodingException;",
      "24: import org.jasig.cas.client.PublicTestHttpServer;",
      "25: import org.junit.Before;",
      "",
      "[Removed Lines]",
      "21: import static org.junit.Assert.assertEquals;",
      "22: import static org.junit.Assert.fail;",
      "",
      "[Added Lines]",
      "21: import static org.junit.Assert.*;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "81:         }",
      "82:     }",
      "83: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "83:     @Test",
      "84:     public void urlEncodedValues() {",
      "85:         final String ticket = \"ST-1-owKEOtYJjg77iHcCQpkl-cas01.example.org%26%73%65%72%76%69%63%65%3d%68%74%74%70%25%33%41%25%32%46%25%32%46%31%32%37%2e%30%2e%30%2e%31%25%32%46%62%6f%72%69%6e%67%25%32%46%23\";",
      "86:         final String service = \"foobar\";",
      "87:         final String url = this.ticketValidator.constructValidationUrl(ticket, service);",
      "89:         final String encodedValue = this.ticketValidator.encodeUrl(ticket);",
      "90:         assertTrue(url.contains(encodedValue));",
      "91:         assertFalse(url.contains(ticket));",
      "92:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8afb55e2b2770cdd0b1b341bd8a773a73b6f3eb3",
      "candidate_info": {
        "commit_hash": "8afb55e2b2770cdd0b1b341bd8a773a73b6f3eb3",
        "repo": "Jasig/java-cas-client",
        "commit_url": "https://github.com/Jasig/java-cas-client/commit/8afb55e2b2770cdd0b1b341bd8a773a73b6f3eb3",
        "files": [
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
        ],
        "message": "CASC-228 URL Encode Paramaters Passed to Server via Validate\n\nProblem: We currently don't pass encoded values to the server, possibly resolving in parsing/extraction errors.\nSolution: URL Encode all values instead of just the service url.\n\nQA Notes: Added unit test.\n\nConflicts:\n\tcas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java\n\tcas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java",
        "before_after_code_files": [
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
            "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
          ],
          "candidate": [
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
            "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
          ]
        }
      },
      "candidate_diff": {
        "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java": [
          "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:         log.debug(\"Placing URL parameters in map.\");",
          "117:         urlParameters.put(\"ticket\", ticket);",
          "120:         if (this.renew) {",
          "121:             urlParameters.put(\"renew\", \"true\");",
          "",
          "[Removed Lines]",
          "118:         urlParameters.put(\"service\", encodeUrl(serviceUrl));",
          "",
          "[Added Lines]",
          "118:         urlParameters.put(\"service\", serviceUrl);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "148:                 buffer.append(i++ == 0 ? \"?\" : \"&\");",
          "149:                 buffer.append(key);",
          "150:                 buffer.append(\"=\");",
          "152:             }",
          "153:         }",
          "",
          "[Removed Lines]",
          "151:                 buffer.append(value);",
          "",
          "[Added Lines]",
          "151:                 final String encodedValue = encodeUrl(value);",
          "152:                 buffer.append(encodedValue);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "239:     protected final String getEncoding() {",
          "240:         return this.encoding;",
          "241:     }",
          "",
          "[Removed Lines]",
          "242: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java": [
          "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:     }",
          "77:     protected String getUrlSuffix() {",
          "",
          "[Removed Lines]",
          "73:     protected final void populateUrlAttributeMap(final Map<String,String> urlParameters) {",
          "74:         urlParameters.put(\"pgtUrl\", encodeUrl(this.proxyCallbackUrl));",
          "",
          "[Added Lines]",
          "73:     protected final void populateUrlAttributeMap(final Map<String, String> urlParameters) {",
          "74:         urlParameters.put(\"pgtUrl\", this.proxyCallbackUrl);",
          "",
          "---------------"
        ],
        "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java": [
          "File: cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java -> cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.jasig.cas.client.validation;",
          "23: import org.jasig.cas.client.PublicTestHttpServer;",
          "25: import org.junit.Before;",
          "26: import org.junit.Test;",
          "30: import static org.junit.Assert.*;",
          "",
          "[Removed Lines]",
          "24: import org.junit.AfterClass;",
          "28: import java.io.UnsupportedEncodingException;",
          "",
          "[Added Lines]",
          "22: import java.io.UnsupportedEncodingException;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "90:         }",
          "91:     }",
          "92: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "90:     @Test",
          "91:     public void urlEncodedValues() {",
          "92:         final String ticket = \"ST-1-owKEOtYJjg77iHcCQpkl-cas01.example.org%26%73%65%72%76%69%63%65%3d%68%74%74%70%25%33%41%25%32%46%25%32%46%31%32%37%2e%30%2e%30%2e%31%25%32%46%62%6f%72%69%6e%67%25%32%46%23\";",
          "93:         final String service = \"foobar\";",
          "94:         final String url = this.ticketValidator.constructValidationUrl(ticket, service);",
          "96:         final String encodedValue = this.ticketValidator.encodeUrl(ticket);",
          "97:         assertTrue(url.contains(encodedValue));",
          "98:         assertFalse(url.contains(ticket));",
          "99:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9de2be91a2ed4f013900cb1facd4036c2f34d051",
      "candidate_info": {
        "commit_hash": "9de2be91a2ed4f013900cb1facd4036c2f34d051",
        "repo": "Jasig/java-cas-client",
        "commit_url": "https://github.com/Jasig/java-cas-client/commit/9de2be91a2ed4f013900cb1facd4036c2f34d051",
        "files": [
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
        ],
        "message": "CASC-228 URL Encode Paramaters Passed to Server via Validate\n\nProblem: We currently don't pass encoded values to the server, possibly resolving in parsing/extraction errors.\nSolution: URL Encode all values instead of just the service url.\n\nQA Notes: Added unit test.",
        "before_after_code_files": [
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
            "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
          ],
          "candidate": [
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
            "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
            "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java"
          ]
        }
      },
      "candidate_diff": {
        "cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java": [
          "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/AbstractUrlBasedTicketValidator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "111:         logger.debug(\"Placing URL parameters in map.\");",
          "112:         urlParameters.put(\"ticket\", ticket);",
          "115:         if (this.renew) {",
          "116:             urlParameters.put(\"renew\", \"true\");",
          "",
          "[Removed Lines]",
          "113:         urlParameters.put(\"service\", encodeUrl(serviceUrl));",
          "",
          "[Added Lines]",
          "113:         urlParameters.put(\"service\", serviceUrl);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "144:                 buffer.append(i++ == 0 ? \"?\" : \"&\");",
          "145:                 buffer.append(key);",
          "146:                 buffer.append(\"=\");",
          "148:             }",
          "149:         }",
          "",
          "[Removed Lines]",
          "147:                 buffer.append(value);",
          "",
          "[Added Lines]",
          "147:                 final String encodedValue = encodeUrl(value);",
          "148:                 buffer.append(encodedValue);",
          "",
          "---------------"
        ],
        "cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java||cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java": [
          "File: cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java -> cas-client-core/src/main/java/org/jasig/cas/client/validation/Cas20ServiceTicketValidator.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:     protected final void populateUrlAttributeMap(final Map<String, String> urlParameters) {",
          "74:     }",
          "76:     protected String getUrlSuffix() {",
          "",
          "[Removed Lines]",
          "73:         urlParameters.put(\"pgtUrl\", encodeUrl(this.proxyCallbackUrl));",
          "",
          "[Added Lines]",
          "73:         urlParameters.put(\"pgtUrl\", this.proxyCallbackUrl);",
          "",
          "---------------"
        ],
        "cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java||cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java": [
          "File: cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java -> cas-client-core/src/test/java/org/jasig/cas/client/validation/Cas10TicketValidatorTests.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: package org.jasig.cas.client.validation;",
          "23: import java.io.UnsupportedEncodingException;",
          "24: import org.jasig.cas.client.PublicTestHttpServer;",
          "25: import org.junit.Before;",
          "",
          "[Removed Lines]",
          "21: import static org.junit.Assert.assertEquals;",
          "22: import static org.junit.Assert.fail;",
          "",
          "[Added Lines]",
          "21: import static org.junit.Assert.*;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "81:         }",
          "82:     }",
          "83: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:     @Test",
          "84:     public void urlEncodedValues() {",
          "85:         final String ticket = \"ST-1-owKEOtYJjg77iHcCQpkl-cas01.example.org%26%73%65%72%76%69%63%65%3d%68%74%74%70%25%33%41%25%32%46%25%32%46%31%32%37%2e%30%2e%30%2e%31%25%32%46%62%6f%72%69%6e%67%25%32%46%23\";",
          "86:         final String service = \"foobar\";",
          "87:         final String url = this.ticketValidator.constructValidationUrl(ticket, service);",
          "89:         final String encodedValue = this.ticketValidator.encodeUrl(ticket);",
          "90:         assertTrue(url.contains(encodedValue));",
          "91:         assertFalse(url.contains(ticket));",
          "92:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}