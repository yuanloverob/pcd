{
  "cve_id": "CVE-2022-27651",
  "cve_desc": "A flaw was found in buildah where containers were incorrectly started with non-empty default permissions. A bug was found in Moby (Docker Engine) where containers were incorrectly started with non-empty inheritable Linux process capabilities, enabling an attacker with access to programs with inheritable file capabilities to elevate those capabilities to the permitted set when execve(2) runs. This has the potential to impact confidentiality and integrity.",
  "repo": "containers/buildah",
  "patch_hash": "e7e55c988c05dd74005184ceb64f097a0cfe645b",
  "patch_info": {
    "commit_hash": "e7e55c988c05dd74005184ceb64f097a0cfe645b",
    "repo": "containers/buildah",
    "commit_url": "https://github.com/containers/buildah/commit/e7e55c988c05dd74005184ceb64f097a0cfe645b",
    "files": [
      "chroot/run.go",
      "run_linux.go"
    ],
    "message": "do not set the inheritable capabilities\n\nThe kernel never sets the inheritable capabilities for a process, they\nare only set by userspace.  Emulate the same behavior.\n\nCloses: CVE-2022-27651\n\nSigned-off-by: Giuseppe Scrivano <gscrivan@redhat.com>",
    "before_after_code_files": [
      "chroot/run.go||chroot/run.go",
      "run_linux.go||run_linux.go"
    ]
  },
  "patch_diff": {
    "chroot/run.go||chroot/run.go": [
      "File: chroot/run.go -> chroot/run.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "897:  capMap := map[capability.CapType][]string{",
      "898:   capability.BOUNDING:    spec.Process.Capabilities.Bounding,",
      "899:   capability.EFFECTIVE:   spec.Process.Capabilities.Effective,",
      "901:   capability.PERMITTED:   spec.Process.Capabilities.Permitted,",
      "902:   capability.AMBIENT:     spec.Process.Capabilities.Ambient,",
      "903:  }",
      "",
      "[Removed Lines]",
      "900:   capability.INHERITABLE: spec.Process.Capabilities.Inheritable,",
      "",
      "[Added Lines]",
      "900:   capability.INHERITABLE: []string{},",
      "",
      "---------------"
    ],
    "run_linux.go||run_linux.go": [
      "File: run_linux.go -> run_linux.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "1964:   if err := g.AddProcessCapabilityEffective(cap); err != nil {",
      "1965:    return errors.Wrapf(err, \"error adding %q to the effective capability set\", cap)",
      "1966:   }",
      "1970:   if err := g.AddProcessCapabilityPermitted(cap); err != nil {",
      "1971:    return errors.Wrapf(err, \"error adding %q to the permitted capability set\", cap)",
      "1972:   }",
      "",
      "[Removed Lines]",
      "1967:   if err := g.AddProcessCapabilityInheritable(cap); err != nil {",
      "1968:    return errors.Wrapf(err, \"error adding %q to the inheritable capability set\", cap)",
      "1969:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1985:   if err := g.DropProcessCapabilityEffective(cap); err != nil {",
      "1986:    return errors.Wrapf(err, \"error removing %q from the effective capability set\", cap)",
      "1987:   }",
      "1991:   if err := g.DropProcessCapabilityPermitted(cap); err != nil {",
      "1992:    return errors.Wrapf(err, \"error removing %q from the permitted capability set\", cap)",
      "1993:   }",
      "",
      "[Removed Lines]",
      "1988:   if err := g.DropProcessCapabilityInheritable(cap); err != nil {",
      "1989:    return errors.Wrapf(err, \"error removing %q from the inheritable capability set\", cap)",
      "1990:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cb029f874968d929e5f1b3913bbf25861d759f3d",
      "candidate_info": {
        "commit_hash": "cb029f874968d929e5f1b3913bbf25861d759f3d",
        "repo": "containers/buildah",
        "commit_url": "https://github.com/containers/buildah/commit/cb029f874968d929e5f1b3913bbf25861d759f3d",
        "files": [
          "chroot/run.go",
          "run_linux.go"
        ],
        "message": "do not set the inheritable capabilities\n\nThe kernel never sets the inheritable capabilities for a process, they\nare only set by userspace.  Emulate the same behavior.\n\nCloses: CVE-2022-27651\n\nSigned-off-by: Giuseppe Scrivano <gscrivan@redhat.com>",
        "before_after_code_files": [
          "chroot/run.go||chroot/run.go",
          "run_linux.go||run_linux.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ],
          "candidate": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ]
        }
      },
      "candidate_diff": {
        "chroot/run.go||chroot/run.go": [
          "File: chroot/run.go -> chroot/run.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "888:  capMap := map[capability.CapType][]string{",
          "889:   capability.BOUNDING:    spec.Process.Capabilities.Bounding,",
          "890:   capability.EFFECTIVE:   spec.Process.Capabilities.Effective,",
          "892:   capability.PERMITTED:   spec.Process.Capabilities.Permitted,",
          "893:   capability.AMBIENT:     spec.Process.Capabilities.Ambient,",
          "894:  }",
          "",
          "[Removed Lines]",
          "891:   capability.INHERITABLE: spec.Process.Capabilities.Inheritable,",
          "",
          "[Added Lines]",
          "891:   capability.INHERITABLE: []string{},",
          "",
          "---------------"
        ],
        "run_linux.go||run_linux.go": [
          "File: run_linux.go -> run_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1755:   if err := g.AddProcessCapabilityEffective(cap); err != nil {",
          "1756:    return errors.Wrapf(err, \"error adding %q to the effective capability set\", cap)",
          "1757:   }",
          "1761:   if err := g.AddProcessCapabilityPermitted(cap); err != nil {",
          "1762:    return errors.Wrapf(err, \"error adding %q to the permitted capability set\", cap)",
          "1763:   }",
          "",
          "[Removed Lines]",
          "1758:   if err := g.AddProcessCapabilityInheritable(cap); err != nil {",
          "1759:    return errors.Wrapf(err, \"error adding %q to the inheritable capability set\", cap)",
          "1760:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1776:   if err := g.DropProcessCapabilityEffective(cap); err != nil {",
          "1777:    return errors.Wrapf(err, \"error removing %q from the effective capability set\", cap)",
          "1778:   }",
          "1782:   if err := g.DropProcessCapabilityPermitted(cap); err != nil {",
          "1783:    return errors.Wrapf(err, \"error removing %q from the permitted capability set\", cap)",
          "1784:   }",
          "",
          "[Removed Lines]",
          "1779:   if err := g.DropProcessCapabilityInheritable(cap); err != nil {",
          "1780:    return errors.Wrapf(err, \"error removing %q from the inheritable capability set\", cap)",
          "1781:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f1228fca5b6c91c20edc48f6b10a14bf478da980",
      "candidate_info": {
        "commit_hash": "f1228fca5b6c91c20edc48f6b10a14bf478da980",
        "repo": "containers/buildah",
        "commit_url": "https://github.com/containers/buildah/commit/f1228fca5b6c91c20edc48f6b10a14bf478da980",
        "files": [
          "chroot/run.go",
          "run_linux.go"
        ],
        "message": "do not set the inheritable capabilities\n\nThe kernel never sets the inheritable capabilities for a process, they\nare only set by userspace.  Emulate the same behavior.\n\nCloses: CVE-2022-27651\n\nSigned-off-by: Giuseppe Scrivano <gscrivan@redhat.com>",
        "before_after_code_files": [
          "chroot/run.go||chroot/run.go",
          "run_linux.go||run_linux.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ],
          "candidate": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ]
        }
      },
      "candidate_diff": {
        "chroot/run.go||chroot/run.go": [
          "File: chroot/run.go -> chroot/run.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "894:  capMap := map[capability.CapType][]string{",
          "895:   capability.BOUNDING:    spec.Process.Capabilities.Bounding,",
          "896:   capability.EFFECTIVE:   spec.Process.Capabilities.Effective,",
          "898:   capability.PERMITTED:   spec.Process.Capabilities.Permitted,",
          "899:   capability.AMBIENT:     spec.Process.Capabilities.Ambient,",
          "900:  }",
          "",
          "[Removed Lines]",
          "897:   capability.INHERITABLE: spec.Process.Capabilities.Inheritable,",
          "",
          "[Added Lines]",
          "897:   capability.INHERITABLE: {},",
          "",
          "---------------"
        ],
        "run_linux.go||run_linux.go": [
          "File: run_linux.go -> run_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1898:   if err := g.AddProcessCapabilityEffective(cap); err != nil {",
          "1899:    return errors.Wrapf(err, \"error adding %q to the effective capability set\", cap)",
          "1900:   }",
          "1904:   if err := g.AddProcessCapabilityPermitted(cap); err != nil {",
          "1905:    return errors.Wrapf(err, \"error adding %q to the permitted capability set\", cap)",
          "1906:   }",
          "",
          "[Removed Lines]",
          "1901:   if err := g.AddProcessCapabilityInheritable(cap); err != nil {",
          "1902:    return errors.Wrapf(err, \"error adding %q to the inheritable capability set\", cap)",
          "1903:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1919:   if err := g.DropProcessCapabilityEffective(cap); err != nil {",
          "1920:    return errors.Wrapf(err, \"error removing %q from the effective capability set\", cap)",
          "1921:   }",
          "1925:   if err := g.DropProcessCapabilityPermitted(cap); err != nil {",
          "1926:    return errors.Wrapf(err, \"error removing %q from the permitted capability set\", cap)",
          "1927:   }",
          "",
          "[Removed Lines]",
          "1922:   if err := g.DropProcessCapabilityInheritable(cap); err != nil {",
          "1923:    return errors.Wrapf(err, \"error removing %q from the inheritable capability set\", cap)",
          "1924:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3c433d54cca46b38aefe266b5389afad17ef37dc",
      "candidate_info": {
        "commit_hash": "3c433d54cca46b38aefe266b5389afad17ef37dc",
        "repo": "containers/buildah",
        "commit_url": "https://github.com/containers/buildah/commit/3c433d54cca46b38aefe266b5389afad17ef37dc",
        "files": [
          "chroot/run.go",
          "run_linux.go",
          "tests/run.bats"
        ],
        "message": "[release-1.19] CVE-2022-27651: do not set the inheritable capabilities\n\nThe kernel never sets the inheritable capabilities for a process, they are only set by userspace. Emulate the same behavior.\n\nCloses: CVE-2022-27651\n\nStolen from #3856\n\nSigned-off-by: tomsweeneyredhat <tsweeney@redhat.com>",
        "before_after_code_files": [
          "chroot/run.go||chroot/run.go",
          "run_linux.go||run_linux.go",
          "tests/run.bats||tests/run.bats"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ],
          "candidate": [
            "chroot/run.go||chroot/run.go",
            "run_linux.go||run_linux.go"
          ]
        }
      },
      "candidate_diff": {
        "chroot/run.go||chroot/run.go": [
          "File: chroot/run.go -> chroot/run.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "893:  capMap := map[capability.CapType][]string{",
          "894:   capability.BOUNDING:    spec.Process.Capabilities.Bounding,",
          "895:   capability.EFFECTIVE:   spec.Process.Capabilities.Effective,",
          "897:   capability.PERMITTED:   spec.Process.Capabilities.Permitted,",
          "898:   capability.AMBIENT:     spec.Process.Capabilities.Ambient,",
          "899:  }",
          "",
          "[Removed Lines]",
          "896:   capability.INHERITABLE: spec.Process.Capabilities.Inheritable,",
          "",
          "[Added Lines]",
          "896:   capability.INHERITABLE: {},",
          "",
          "---------------"
        ],
        "run_linux.go||run_linux.go": [
          "File: run_linux.go -> run_linux.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "1882:   if err := g.AddProcessCapabilityEffective(cap); err != nil {",
          "1883:    return errors.Wrapf(err, \"error adding %q to the effective capability set\", cap)",
          "1884:   }",
          "1888:   if err := g.AddProcessCapabilityPermitted(cap); err != nil {",
          "1889:    return errors.Wrapf(err, \"error adding %q to the permitted capability set\", cap)",
          "1890:   }",
          "",
          "[Removed Lines]",
          "1885:   if err := g.AddProcessCapabilityInheritable(cap); err != nil {",
          "1886:    return errors.Wrapf(err, \"error adding %q to the inheritable capability set\", cap)",
          "1887:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1903:   if err := g.DropProcessCapabilityEffective(cap); err != nil {",
          "1904:    return errors.Wrapf(err, \"error removing %q from the effective capability set\", cap)",
          "1905:   }",
          "1909:   if err := g.DropProcessCapabilityPermitted(cap); err != nil {",
          "1910:    return errors.Wrapf(err, \"error removing %q from the permitted capability set\", cap)",
          "1911:   }",
          "",
          "[Removed Lines]",
          "1906:   if err := g.DropProcessCapabilityInheritable(cap); err != nil {",
          "1907:    return errors.Wrapf(err, \"error removing %q from the inheritable capability set\", cap)",
          "1908:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "tests/run.bats||tests/run.bats": [
          "File: tests/run.bats -> tests/run.bats",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:  expect_output --substring \"nameserver 110.110.0.110\"",
          "534:  run_buildah rm -a",
          "535: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "537: @test \"run-inheritable-capabilities\" {",
          "538:  skip_if_no_runtime",
          "540:  _prefetch alpine",
          "542:  run_buildah from --quiet --pull=false --signature-policy ${TESTSDIR}/policy.json alpine",
          "543:  cid=$output",
          "544:  run_buildah run $cid grep ^CapInh: /proc/self/status",
          "545:  expect_output \"CapInh: 0000000000000000\"",
          "546:  run_buildah run --cap-add=ALL $cid grep ^CapInh: /proc/self/status",
          "547:  expect_output \"CapInh: 0000000000000000\"",
          "548: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}