{
  "cve_id": "CVE-2023-28096",
  "cve_desc": "OpenSIPS, a Session Initiation Protocol (SIP) server implementation, has a memory leak starting in the 2.3 branch and priot to versions 3.1.8 and 3.2.5. The memory leak was detected in the function `parse_mi_request` while performing coverage-guided fuzzing. This issue can be reproduced by sending multiple requests of the form `{\"jsonrpc\": \"2.0\",\"method\": \"log_le`. This malformed message was tested against an instance of OpenSIPS via FIFO transport layer and was found to increase the memory consumption over time.\n\nTo abuse this memory leak, attackers need to reach the management interface (MI) which typically should only be exposed on trusted interfaces. In cases where the MI is exposed to the internet without authentication, abuse of this issue will lead to memory exhaustion which may affect the underlying system\u2019s availability. No authentication is typically required to reproduce this issue. On the other hand, memory leaks may occur in other areas of OpenSIPS where the cJSON library is used for parsing JSON objects.\n\nThe issue has been fixed in versions 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
  "patch_info": {
    "commit_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/417568707520af25ec5c5dd91da18e6db3649dcb",
    "files": [
      "lib/cJSON.c"
    ],
    "message": "cJSON: fix memory leak on object parsing error\n\nIssue discovered during OpenSIPS Security Audit 2021/2022,\nby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-2mg2-g46r-j4qr",
    "before_after_code_files": [
      "lib/cJSON.c||lib/cJSON.c"
    ]
  },
  "patch_diff": {
    "lib/cJSON.c||lib/cJSON.c": [
      "File: lib/cJSON.c -> lib/cJSON.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1483: fail:",
      "1484:     if (item->child != NULL)",
      "1485:     {",
      "1487:         item->child = NULL;",
      "1488:     }",
      "",
      "[Removed Lines]",
      "1486:         cJSON_Delete(child);",
      "",
      "[Added Lines]",
      "1486:         cJSON_Delete(item->child);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9af70963ded16c369fe5d3be2027d8efe247adf6",
      "candidate_info": {
        "commit_hash": "9af70963ded16c369fe5d3be2027d8efe247adf6",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/9af70963ded16c369fe5d3be2027d8efe247adf6",
        "files": [
          "Makefile.defs",
          "packaging/debian/changelog",
          "packaging/freebsd/Makefile",
          "packaging/netbsd/Makefile",
          "packaging/openbsd/Makefile",
          "packaging/redhat_fedora/opensips.spec",
          "packaging/solaris/base-pkginfo",
          "packaging/solaris/berkeley-pkginfo",
          "packaging/solaris/carrierroute-pkginfo",
          "packaging/solaris/identity-pkginfo",
          "packaging/solaris/ldap-pkginfo",
          "packaging/solaris/mmgeoip-pkginfo",
          "packaging/solaris/mysql-pkginfo",
          "packaging/solaris/perl-pkginfo",
          "packaging/solaris/pgsql-pkginfo",
          "packaging/solaris/pkginfo",
          "packaging/solaris/regex-pkginfo",
          "packaging/solaris/snmp-pkginfo",
          "packaging/solaris/tls-pkginfo",
          "packaging/solaris/xmlrpc-pkginfo"
        ],
        "message": "Bump version to 3.2.7",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs",
          "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "66: #version number",
          "67: VERSION_MAJOR = 3",
          "68: VERSION_MINOR = 2",
          "70: VERSION_BUILD =",
          "72: ifneq (,$(VERSION_BUILD))",
          "",
          "[Removed Lines]",
          "69: VERSION_SUBMINOR = 6",
          "",
          "[Added Lines]",
          "69: VERSION_SUBMINOR = 7",
          "",
          "---------------"
        ],
        "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec": [
          "File: packaging/redhat_fedora/opensips.spec -> packaging/redhat_fedora/opensips.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: Summary:  Very fast and configurable SIP server",
          "47: Name:     opensips",
          "49: Release:  1%{?dist}",
          "50: License:  GPLv2+",
          "51: Group:    System Environment/Daemons",
          "",
          "[Removed Lines]",
          "48: Version:  3.2.6",
          "",
          "[Added Lines]",
          "48: Version:  3.2.7",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
      "candidate_info": {
        "commit_hash": "a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
        "files": [
          "modules/media_exchange/media_utils.c"
        ],
        "message": "media_exchange: make sure we do not unreference NULL dlg\n\n(cherry picked from commit 581a4b8e5b9575fb63c631886b58b051797f2642)",
        "before_after_code_files": [
          "modules/media_exchange/media_utils.c||modules/media_exchange/media_utils.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/media_exchange/media_utils.c||modules/media_exchange/media_utils.c": [
          "File: modules/media_exchange/media_utils.c -> modules/media_exchange/media_utils.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1331:    break;",
          "1332:  }",
          "1335:  return;",
          "1336: }",
          "",
          "[Removed Lines]",
          "1334:  media_dlg.dlg_unref(dlg, 1);",
          "",
          "[Added Lines]",
          "1334:  if (dlg)",
          "1335:   media_dlg.dlg_unref(dlg, 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5582666ba49365dd18387e1b7cc59d853c3841ad",
      "candidate_info": {
        "commit_hash": "5582666ba49365dd18387e1b7cc59d853c3841ad",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/5582666ba49365dd18387e1b7cc59d853c3841ad",
        "files": [
          "modules/aaa_diameter/app_opensips/avps.c"
        ],
        "message": "aaa_diameter: Fix `app_opensips` compilation\n\nThe \"peer.h\" import is not available when compiling \"app_opensips\"\nwithin freeDiameter.  Moreover, it's not used anyway, so just remove it.\n\n(cherry picked from commit 7c3fef41a22b39d296c97a21ea5aed1d4d5770e7)",
        "before_after_code_files": [
          "modules/aaa_diameter/app_opensips/avps.c||modules/aaa_diameter/app_opensips/avps.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/aaa_diameter/app_opensips/avps.c||modules/aaa_diameter/app_opensips/avps.c": [
          "File: modules/aaa_diameter/app_opensips/avps.c -> modules/aaa_diameter/app_opensips/avps.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "38: #include \"ctype.h\"",
          "41: #include \"avps.h\"",
          "",
          "[Removed Lines]",
          "40: #include \"../peer.h\"",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e8c084e4d593c8ac89d3a62d8489575d58f93fe5",
      "candidate_info": {
        "commit_hash": "e8c084e4d593c8ac89d3a62d8489575d58f93fe5",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/e8c084e4d593c8ac89d3a62d8489575d58f93fe5",
        "files": [
          "modules/b2b_entities/dlg.c"
        ],
        "message": "Merge pull request #2773 from carstenbock/use_library_for_require_parsing\n\nUse library function to fix edge case in require parsing\n\n(cherry picked from commit 432a53305ba421067f2feb7b19cb2c3f1b0289ee)",
        "before_after_code_files": [
          "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c": [
          "File: modules/b2b_entities/dlg.c -> modules/b2b_entities/dlg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: #include \"../../parser/parse_methods.h\"",
          "35: #include \"../../parser/parse_content.h\"",
          "36: #include \"../../parser/parse_authenticate.h\"",
          "37: #include \"../../parser/sdp/sdp.h\"",
          "38: #include \"../../locking.h\"",
          "39: #include \"../../script_cb.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: #include \"../../parser/parse_supported.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2573:  int b2b_ev = -1;",
          "2574:  struct b2b_context *ctx;",
          "2575:  int b2b_cb_flags = 0;",
          "2577:  to_hdr_parsed.param_lst = from_hdr_parsed.param_lst = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2578:  unsigned int reqmask;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3141:     while(hdr)",
          "3142:     {",
          "3143:      LM_DBG(\"Found require hdr\\n\");",
          "3152:      hdr = hdr->sibling;",
          "3153:     }",
          "3154:     if(hdr)",
          "",
          "[Removed Lines]",
          "3144:      if ( (hdr->body.len == 6 &&",
          "3145:       strncmp(hdr->body.s, \"100rel\", 6)==0) ||",
          "3146:      (hdr->body.len == 8 &&",
          "3147:       strncmp(hdr->body.s, \"100rel\\r\\n\", 8)==0) )",
          "3148:      {",
          "3149:       LM_DBG(\"Found 100rel header\\n\");",
          "3150:       break;",
          "3151:      }",
          "",
          "[Added Lines]",
          "3147:      parse_supported_body(&(hdr->body), &reqmask);",
          "3148:      if (reqmask & F_SUPPORTED_100REL) {",
          "3149:        LM_DBG(\"Found 100rel header\\n\");",
          "3150:        break;",
          "3151:      }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "806d0c4690dbdb6aafff93bf620fb9fca25a7489",
      "candidate_info": {
        "commit_hash": "806d0c4690dbdb6aafff93bf620fb9fca25a7489",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/806d0c4690dbdb6aafff93bf620fb9fca25a7489",
        "files": [
          "Makefile.conf.template"
        ],
        "message": "Add QM_DBG_MALLOC_HIST flag to Makefile.conf template\n\n(cherry picked from commit 4c748b3f8380185ed74ed8ea37e9e9e9470b685f)",
        "before_after_code_files": [
          "Makefile.conf.template||Makefile.conf.template"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.conf.template||Makefile.conf.template": [
          "File: Makefile.conf.template -> Makefile.conf.template",
          "--- Hunk 1 ---",
          "[Context before]",
          "82: DEFS+= -DQ_MALLOC #Quality assurance memory allocator with runtime safety checks",
          "83: DEFS+= -DHP_MALLOC #High performance allocator with fine-grained locking",
          "84: DEFS+= -DDBG_MALLOC #Include additional, debug-enabled allocator flavors",
          "85: #DEFS+= -DNO_DEBUG #Compile out all debug messages",
          "86: #DEFS+= -DNO_LOG #Compile out all logging",
          "87: #DEFS_GROUP_START",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85: #DEFS+= -DQM_DBG_MALLOC_HIST=3 #Size of debug history for Q_MALLOC (default is 1)",
          "",
          "---------------"
        ]
      }
    }
  ]
}