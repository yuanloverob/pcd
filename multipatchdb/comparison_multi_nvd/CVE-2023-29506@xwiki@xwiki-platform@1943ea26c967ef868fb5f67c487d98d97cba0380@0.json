{
  "cve_id": "CVE-2023-29506",
  "cve_desc": "XWiki Commons are technical libraries common to several other top level XWiki projects. It was possible to inject some code using the URL of authenticated endpoints. This problem has been patched on XWiki 13.10.11, 14.4.7 and 14.10.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "1943ea26c967ef868fb5f67c487d98d97cba0380",
  "patch_info": {
    "commit_hash": "1943ea26c967ef868fb5f67c487d98d97cba0380",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/1943ea26c967ef868fb5f67c487d98d97cba0380",
    "files": [
      "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
      "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
    ],
    "message": "XWIKI-20335: Wiki existence is not properly checked in authenticate",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
      "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java": [
      "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "37: import org.xwiki.resource.ResourceReferenceHandlerException;",
      "38: import org.xwiki.resource.ResourceType;",
      "39: import org.xwiki.security.authentication.AuthenticationResourceReference;",
      "41: import com.xpn.xwiki.XWikiContext;",
      "42: import com.xpn.xwiki.XWikiContextInitializer;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
      "41: import org.xwiki.wiki.manager.WikiManagerException;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "59:     @Inject",
      "60:     private Execution execution;",
      "62:     @Override",
      "63:     public List<ResourceType> getSupportedResourceReferences()",
      "64:     {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "64:     @Inject",
      "65:     private WikiDescriptorManager wikiDescriptorManager;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "71:     {",
      "72:         AuthenticationResourceReference authenticationResourceReference = (AuthenticationResourceReference) reference;",
      "74:         switch (authenticationResourceReference.getAction()) {",
      "75:             case RETRIEVE_USERNAME:",
      "76:                 this.handleAction(\"forgotusername\", authenticationResourceReference.getWikiReference());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "79:         WikiReference wikiReference = authenticationResourceReference.getWikiReference();",
      "80:         try {",
      "81:             if (!this.wikiDescriptorManager.exists(wikiReference.getName())) {",
      "82:                 throw new ResourceReferenceHandlerException(",
      "83:                     String.format(\"The wiki [%s] does not exist.\", wikiReference.getName()));",
      "84:             }",
      "85:         } catch (WikiManagerException e) {",
      "86:             throw new ResourceReferenceHandlerException(",
      "87:                 String.format(\"Error when checking if wiki [%s] exists.\", wikiReference.getName()), e);",
      "88:         }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java": [
      "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "31: import org.xwiki.context.ExecutionContext;",
      "32: import org.xwiki.model.reference.WikiReference;",
      "33: import org.xwiki.resource.ResourceReferenceHandlerChain;",
      "34: import org.xwiki.security.authentication.AuthenticationAction;",
      "35: import org.xwiki.security.authentication.AuthenticationResourceReference;",
      "36: import org.xwiki.test.junit5.mockito.ComponentTest;",
      "37: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
      "38: import org.xwiki.test.junit5.mockito.MockComponent;",
      "40: import com.xpn.xwiki.XWiki;",
      "41: import com.xpn.xwiki.XWikiContext;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "34: import org.xwiki.resource.ResourceReferenceHandlerException;",
      "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
      "41: import org.xwiki.wiki.manager.WikiManagerException;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "45: import com.xpn.xwiki.web.XWikiResponse;",
      "47: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "48: import static org.mockito.ArgumentMatchers.any;",
      "49: import static org.mockito.ArgumentMatchers.eq;",
      "50: import static org.mockito.Mockito.mock;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "51: import static org.junit.jupiter.api.Assertions.assertThrows;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "69:     @MockComponent",
      "70:     private Execution execution;",
      "72:     private XWikiResponse response;",
      "74:     private XWiki xwiki;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "76:     @MockComponent",
      "77:     private WikiDescriptorManager wikiDescriptorManager;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "112:     void handleResetPassword() throws Exception",
      "113:     {",
      "114:         WikiReference wikiReference = new WikiReference(\"foo\");",
      "115:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
      "116:             wikiReference,",
      "117:             AuthenticationAction.RESET_PASSWORD);",
      "121:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
      "122:         this.resourceReferenceHandler.handle(resourceReference, chain);",
      "124:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
      "",
      "[Removed Lines]",
      "119:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
      "",
      "[Added Lines]",
      "122:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(false);",
      "128:         ResourceReferenceHandlerException exception =",
      "129:             assertThrows(ResourceReferenceHandlerException.class,",
      "130:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
      "131:         assertEquals(\"The wiki [foo] does not exist.\", exception.getMessage());",
      "133:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(true);",
      "134:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "133:     void handleForgotUsername() throws Exception",
      "134:     {",
      "135:         WikiReference wikiReference = new WikiReference(\"bar\");",
      "136:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
      "137:             wikiReference,",
      "138:             AuthenticationAction.RETRIEVE_USERNAME);",
      "140:         when(this.xwiki.evaluateTemplate(\"forgotusername.vm\", context)).thenReturn(\"Forgot user name content\");",
      "143:         this.resourceReferenceHandler.handle(resourceReference, chain);",
      "145:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
      "146:         verify(this.xWikiContextInitializer).initialize(any(ExecutionContext.class));",
      "147:         verify(servletOutputStream).write(\"Forgot user name content\".getBytes(StandardCharsets.UTF_8));",
      "",
      "[Removed Lines]",
      "142:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
      "",
      "[Added Lines]",
      "149:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(false);",
      "154:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
      "155:         ResourceReferenceHandlerException exception =",
      "156:             assertThrows(ResourceReferenceHandlerException.class,",
      "157:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
      "158:         assertEquals(\"The wiki [bar] does not exist.\", exception.getMessage());",
      "160:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(true);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "149:         verify(context).setWikiReference(wikiReference);",
      "150:         verify(context).setWikiReference(currentWiki);",
      "151:     }",
      "152: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "172:     @Test",
      "173:     void handleForgotUsernameWikiDescriptorError() throws Exception",
      "174:     {",
      "175:         WikiReference wikiReference = new WikiReference(\"bar\");",
      "176:         when(this.wikiDescriptorManager.exists(\"bar\")).thenThrow(new WikiManagerException(\"Cannot access wiki\"));",
      "177:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
      "178:             wikiReference,",
      "179:             AuthenticationAction.RETRIEVE_USERNAME);",
      "181:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
      "182:         ResourceReferenceHandlerException exception =",
      "183:             assertThrows(ResourceReferenceHandlerException.class,",
      "184:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
      "185:         assertEquals(\"Error when checking if wiki [bar] exists.\", exception.getMessage());",
      "186:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d3393dc632773b799f73e0fedb191eb557d64834",
      "candidate_info": {
        "commit_hash": "d3393dc632773b799f73e0fedb191eb557d64834",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/d3393dc632773b799f73e0fedb191eb557d64834",
        "files": [
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
        ],
        "message": "XWIKI-20335: Wiki existence is not properly checked in authenticate\n\n(cherry picked from commit 1943ea26c967ef868fb5f67c487d98d97cba0380)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java": [
          "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: import org.xwiki.resource.ResourceReferenceHandlerException;",
          "38: import org.xwiki.resource.ResourceType;",
          "39: import org.xwiki.security.authentication.AuthenticationResourceReference;",
          "41: import com.xpn.xwiki.XWikiContext;",
          "42: import com.xpn.xwiki.XWikiContextInitializer;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
          "41: import org.xwiki.wiki.manager.WikiManagerException;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59:     @Inject",
          "60:     private Execution execution;",
          "62:     @Override",
          "63:     public List<ResourceType> getSupportedResourceReferences()",
          "64:     {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:     @Inject",
          "65:     private WikiDescriptorManager wikiDescriptorManager;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "71:     {",
          "72:         AuthenticationResourceReference authenticationResourceReference = (AuthenticationResourceReference) reference;",
          "74:         switch (authenticationResourceReference.getAction()) {",
          "75:             case RETRIEVE_USERNAME:",
          "76:                 this.handleAction(\"forgotusername\", authenticationResourceReference.getWikiReference());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "79:         WikiReference wikiReference = authenticationResourceReference.getWikiReference();",
          "80:         try {",
          "81:             if (!this.wikiDescriptorManager.exists(wikiReference.getName())) {",
          "82:                 throw new ResourceReferenceHandlerException(",
          "83:                     String.format(\"The wiki [%s] does not exist.\", wikiReference.getName()));",
          "84:             }",
          "85:         } catch (WikiManagerException e) {",
          "86:             throw new ResourceReferenceHandlerException(",
          "87:                 String.format(\"Error when checking if wiki [%s] exists.\", wikiReference.getName()), e);",
          "88:         }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java": [
          "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: import org.xwiki.context.ExecutionContext;",
          "32: import org.xwiki.model.reference.WikiReference;",
          "33: import org.xwiki.resource.ResourceReferenceHandlerChain;",
          "34: import org.xwiki.security.authentication.AuthenticationAction;",
          "35: import org.xwiki.security.authentication.AuthenticationResourceReference;",
          "36: import org.xwiki.test.junit5.mockito.ComponentTest;",
          "37: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
          "38: import org.xwiki.test.junit5.mockito.MockComponent;",
          "40: import com.xpn.xwiki.XWiki;",
          "41: import com.xpn.xwiki.XWikiContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: import org.xwiki.resource.ResourceReferenceHandlerException;",
          "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
          "41: import org.xwiki.wiki.manager.WikiManagerException;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45: import com.xpn.xwiki.web.XWikiResponse;",
          "47: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "48: import static org.mockito.ArgumentMatchers.any;",
          "49: import static org.mockito.ArgumentMatchers.eq;",
          "50: import static org.mockito.Mockito.mock;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51: import static org.junit.jupiter.api.Assertions.assertThrows;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "69:     @MockComponent",
          "70:     private Execution execution;",
          "72:     private XWikiResponse response;",
          "74:     private XWiki xwiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76:     @MockComponent",
          "77:     private WikiDescriptorManager wikiDescriptorManager;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "112:     void handleResetPassword() throws Exception",
          "113:     {",
          "114:         WikiReference wikiReference = new WikiReference(\"foo\");",
          "115:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "116:             wikiReference,",
          "117:             AuthenticationAction.RESET_PASSWORD);",
          "121:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "122:         this.resourceReferenceHandler.handle(resourceReference, chain);",
          "124:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
          "",
          "[Removed Lines]",
          "119:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
          "",
          "[Added Lines]",
          "122:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(false);",
          "128:         ResourceReferenceHandlerException exception =",
          "129:             assertThrows(ResourceReferenceHandlerException.class,",
          "130:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "131:         assertEquals(\"The wiki [foo] does not exist.\", exception.getMessage());",
          "133:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(true);",
          "134:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:     void handleForgotUsername() throws Exception",
          "134:     {",
          "135:         WikiReference wikiReference = new WikiReference(\"bar\");",
          "136:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "137:             wikiReference,",
          "138:             AuthenticationAction.RETRIEVE_USERNAME);",
          "140:         when(this.xwiki.evaluateTemplate(\"forgotusername.vm\", context)).thenReturn(\"Forgot user name content\");",
          "143:         this.resourceReferenceHandler.handle(resourceReference, chain);",
          "145:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
          "146:         verify(this.xWikiContextInitializer).initialize(any(ExecutionContext.class));",
          "147:         verify(servletOutputStream).write(\"Forgot user name content\".getBytes(StandardCharsets.UTF_8));",
          "",
          "[Removed Lines]",
          "142:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "",
          "[Added Lines]",
          "149:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(false);",
          "154:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "155:         ResourceReferenceHandlerException exception =",
          "156:             assertThrows(ResourceReferenceHandlerException.class,",
          "157:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "158:         assertEquals(\"The wiki [bar] does not exist.\", exception.getMessage());",
          "160:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(true);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "149:         verify(context).setWikiReference(wikiReference);",
          "150:         verify(context).setWikiReference(currentWiki);",
          "151:     }",
          "152: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "172:     @Test",
          "173:     void handleForgotUsernameWikiDescriptorError() throws Exception",
          "174:     {",
          "175:         WikiReference wikiReference = new WikiReference(\"bar\");",
          "176:         when(this.wikiDescriptorManager.exists(\"bar\")).thenThrow(new WikiManagerException(\"Cannot access wiki\"));",
          "177:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "178:             wikiReference,",
          "179:             AuthenticationAction.RETRIEVE_USERNAME);",
          "181:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "182:         ResourceReferenceHandlerException exception =",
          "183:             assertThrows(ResourceReferenceHandlerException.class,",
          "184:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "185:         assertEquals(\"Error when checking if wiki [bar] exists.\", exception.getMessage());",
          "186:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "59c6f47d7e12503798e87bd2e1c16a688eb8c748",
      "candidate_info": {
        "commit_hash": "59c6f47d7e12503798e87bd2e1c16a688eb8c748",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/59c6f47d7e12503798e87bd2e1c16a688eb8c748",
        "files": [
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
        ],
        "message": "XWIKI-20335: Wiki existence is not properly checked in authenticate\n\n(cherry picked from commit 1943ea26c967ef868fb5f67c487d98d97cba0380)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
            "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java": [
          "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/main/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandler.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: import org.xwiki.resource.ResourceReferenceHandlerException;",
          "38: import org.xwiki.resource.ResourceType;",
          "39: import org.xwiki.security.authentication.AuthenticationResourceReference;",
          "41: import com.xpn.xwiki.XWikiContext;",
          "42: import com.xpn.xwiki.XWikiContextInitializer;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
          "41: import org.xwiki.wiki.manager.WikiManagerException;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59:     @Inject",
          "60:     private Execution execution;",
          "62:     @Override",
          "63:     public List<ResourceType> getSupportedResourceReferences()",
          "64:     {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:     @Inject",
          "65:     private WikiDescriptorManager wikiDescriptorManager;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "71:     {",
          "72:         AuthenticationResourceReference authenticationResourceReference = (AuthenticationResourceReference) reference;",
          "74:         switch (authenticationResourceReference.getAction()) {",
          "75:             case RETRIEVE_USERNAME:",
          "76:                 this.handleAction(\"forgotusername\", authenticationResourceReference.getWikiReference());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "79:         WikiReference wikiReference = authenticationResourceReference.getWikiReference();",
          "80:         try {",
          "81:             if (!this.wikiDescriptorManager.exists(wikiReference.getName())) {",
          "82:                 throw new ResourceReferenceHandlerException(",
          "83:                     String.format(\"The wiki [%s] does not exist.\", wikiReference.getName()));",
          "84:             }",
          "85:         } catch (WikiManagerException e) {",
          "86:             throw new ResourceReferenceHandlerException(",
          "87:                 String.format(\"Error when checking if wiki [%s] exists.\", wikiReference.getName()), e);",
          "88:         }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java||xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java": [
          "File: xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java -> xwiki-platform-core/xwiki-platform-security/xwiki-platform-security-authentication/xwiki-platform-security-authentication-default/src/test/java/org/xwiki/security/authentication/internal/resource/AuthenticationResourceReferenceHandlerTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: import org.xwiki.context.ExecutionContext;",
          "32: import org.xwiki.model.reference.WikiReference;",
          "33: import org.xwiki.resource.ResourceReferenceHandlerChain;",
          "34: import org.xwiki.security.authentication.AuthenticationAction;",
          "35: import org.xwiki.security.authentication.AuthenticationResourceReference;",
          "36: import org.xwiki.test.junit5.mockito.ComponentTest;",
          "37: import org.xwiki.test.junit5.mockito.InjectMockComponents;",
          "38: import org.xwiki.test.junit5.mockito.MockComponent;",
          "40: import com.xpn.xwiki.XWiki;",
          "41: import com.xpn.xwiki.XWikiContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: import org.xwiki.resource.ResourceReferenceHandlerException;",
          "40: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
          "41: import org.xwiki.wiki.manager.WikiManagerException;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45: import com.xpn.xwiki.web.XWikiResponse;",
          "47: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "48: import static org.mockito.ArgumentMatchers.any;",
          "49: import static org.mockito.ArgumentMatchers.eq;",
          "50: import static org.mockito.Mockito.mock;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51: import static org.junit.jupiter.api.Assertions.assertThrows;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "69:     @MockComponent",
          "70:     private Execution execution;",
          "72:     private XWikiResponse response;",
          "74:     private XWiki xwiki;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "76:     @MockComponent",
          "77:     private WikiDescriptorManager wikiDescriptorManager;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "112:     void handleResetPassword() throws Exception",
          "113:     {",
          "114:         WikiReference wikiReference = new WikiReference(\"foo\");",
          "115:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "116:             wikiReference,",
          "117:             AuthenticationAction.RESET_PASSWORD);",
          "121:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "122:         this.resourceReferenceHandler.handle(resourceReference, chain);",
          "124:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
          "",
          "[Removed Lines]",
          "119:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
          "",
          "[Added Lines]",
          "122:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(false);",
          "128:         ResourceReferenceHandlerException exception =",
          "129:             assertThrows(ResourceReferenceHandlerException.class,",
          "130:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "131:         assertEquals(\"The wiki [foo] does not exist.\", exception.getMessage());",
          "133:         when(this.wikiDescriptorManager.exists(\"foo\")).thenReturn(true);",
          "134:         when(this.xwiki.evaluateTemplate(\"resetpassword.vm\", context)).thenReturn(\"Reset password content\");",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "133:     void handleForgotUsername() throws Exception",
          "134:     {",
          "135:         WikiReference wikiReference = new WikiReference(\"bar\");",
          "136:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "137:             wikiReference,",
          "138:             AuthenticationAction.RETRIEVE_USERNAME);",
          "140:         when(this.xwiki.evaluateTemplate(\"forgotusername.vm\", context)).thenReturn(\"Forgot user name content\");",
          "143:         this.resourceReferenceHandler.handle(resourceReference, chain);",
          "145:         verify(response).setContentType(\"text/html; charset=UTF-8\");",
          "146:         verify(this.xWikiContextInitializer).initialize(any(ExecutionContext.class));",
          "147:         verify(servletOutputStream).write(\"Forgot user name content\".getBytes(StandardCharsets.UTF_8));",
          "",
          "[Removed Lines]",
          "142:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "",
          "[Added Lines]",
          "149:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(false);",
          "154:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "155:         ResourceReferenceHandlerException exception =",
          "156:             assertThrows(ResourceReferenceHandlerException.class,",
          "157:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "158:         assertEquals(\"The wiki [bar] does not exist.\", exception.getMessage());",
          "160:         when(this.wikiDescriptorManager.exists(\"bar\")).thenReturn(true);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "149:         verify(context).setWikiReference(wikiReference);",
          "150:         verify(context).setWikiReference(currentWiki);",
          "151:     }",
          "152: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "172:     @Test",
          "173:     void handleForgotUsernameWikiDescriptorError() throws Exception",
          "174:     {",
          "175:         WikiReference wikiReference = new WikiReference(\"bar\");",
          "176:         when(this.wikiDescriptorManager.exists(\"bar\")).thenThrow(new WikiManagerException(\"Cannot access wiki\"));",
          "177:         AuthenticationResourceReference resourceReference = new AuthenticationResourceReference(",
          "178:             wikiReference,",
          "179:             AuthenticationAction.RETRIEVE_USERNAME);",
          "181:         ResourceReferenceHandlerChain chain = mock(ResourceReferenceHandlerChain.class);",
          "182:         ResourceReferenceHandlerException exception =",
          "183:             assertThrows(ResourceReferenceHandlerException.class,",
          "184:                 () -> this.resourceReferenceHandler.handle(resourceReference, chain));",
          "185:         assertEquals(\"Error when checking if wiki [bar] exists.\", exception.getMessage());",
          "186:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}