{
  "cve_id": "CVE-2020-15248",
  "cve_desc": "October is a free, open-source, self-hosted CMS platform based on the Laravel PHP Framework. In October CMS from version 1.0.319 and before version 1.0.470, backend users with the default \"Publisher\" system role have access to create & manage users where they can choose which role the new user has. This means that a user with \"Publisher\" access has the ability to escalate their access to \"Developer\" access. Issue has been patched in Build 470 (v1.0.470) & v1.1.1.",
  "repo": "octobercms/october",
  "patch_hash": "78a37298a4ed4602b383522344a31e311402d829",
  "patch_info": {
    "commit_hash": "78a37298a4ed4602b383522344a31e311402d829",
    "repo": "octobercms/october",
    "commit_url": "https://github.com/octobercms/october/commit/78a37298a4ed4602b383522344a31e311402d829",
    "files": [
      "modules/backend/ServiceProvider.php",
      "modules/system/ServiceProvider.php"
    ],
    "message": "Tightened up the default permissions granted to the \"Publisher\" system role out of the box\n\n(cherry picked from commit 8a785e439395aa901d2b9d7bcb6a343a071c7870)",
    "before_after_code_files": [
      "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php",
      "modules/system/ServiceProvider.php||modules/system/ServiceProvider.php"
    ]
  },
  "patch_diff": {
    "modules/backend/ServiceProvider.php||modules/backend/ServiceProvider.php": [
      "File: modules/backend/ServiceProvider.php -> modules/backend/ServiceProvider.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "140:             $manager->registerPermissions('October.Backend', [",
      "141:                 'backend.access_dashboard' => [",
      "142:                     'label' => 'system::lang.permissions.view_the_dashboard',",
      "144:                 ],",
      "145:                 'backend.manage_default_dashboard' => [",
      "146:                     'label' => 'system::lang.permissions.manage_default_dashboard',",
      "147:                     'tab'   => 'system::lang.permissions.name',",
      "148:                 ],",
      "149:                 'backend.manage_users' => [",
      "150:                     'label' => 'system::lang.permissions.manage_other_administrators',",
      "152:                 ],",
      "153:                 'backend.impersonate_users' => [",
      "154:                     'label' => 'system::lang.permissions.impersonate_users',",
      "155:                     'tab'   => 'system::lang.permissions.name',",
      "156:                 ],",
      "157:                 'backend.manage_preferences' => [",
      "158:                     'label' => 'system::lang.permissions.manage_preferences',",
      "160:                 ],",
      "161:                 'backend.manage_editor' => [",
      "162:                     'label' => 'system::lang.permissions.manage_editor',",
      "164:                 ],",
      "165:                 'backend.manage_branding' => [",
      "166:                     'label' => 'system::lang.permissions.manage_branding',",
      "168:                 ],",
      "169:                 'media.manage_media' => [",
      "170:                     'label' => 'backend::lang.permissions.manage_media',",
      "",
      "[Removed Lines]",
      "143:                     'tab'   => 'system::lang.permissions.name'",
      "151:                     'tab'   => 'system::lang.permissions.name'",
      "159:                     'tab'   => 'system::lang.permissions.name'",
      "163:                     'tab'   => 'system::lang.permissions.name'",
      "167:                     'tab'   => 'system::lang.permissions.name'",
      "",
      "[Added Lines]",
      "143:                     'tab'   => 'system::lang.permissions.name',",
      "148:                     'roles' => UserRole::CODE_DEVELOPER,",
      "152:                     'tab'   => 'system::lang.permissions.name',",
      "153:                     'roles' => UserRole::CODE_DEVELOPER,",
      "158:                     'roles' => UserRole::CODE_DEVELOPER,",
      "162:                     'tab'   => 'system::lang.permissions.name',",
      "166:                     'tab'   => 'system::lang.permissions.name',",
      "170:                     'tab'   => 'system::lang.permissions.name',",
      "",
      "---------------"
    ],
    "modules/system/ServiceProvider.php||modules/system/ServiceProvider.php": [
      "File: modules/system/ServiceProvider.php -> modules/system/ServiceProvider.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "9: use Request;",
      "10: use BackendMenu;",
      "11: use BackendAuth;",
      "12: use Twig\\Extension\\SandboxExtension;",
      "13: use Twig\\Environment as TwigEnvironment;",
      "14: use System\\Classes\\MailManager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "12: use Backend\\Models\\UserRole;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "417:             $manager->registerPermissions('October.System', [",
      "418:                 'system.manage_updates' => [",
      "419:                     'label' => 'system::lang.permissions.manage_software_updates',",
      "421:                 ],",
      "422:                 'system.access_logs' => [",
      "423:                     'label' => 'system::lang.permissions.access_logs',",
      "425:                 ],",
      "426:                 'system.manage_mail_settings' => [",
      "427:                     'label' => 'system::lang.permissions.manage_mail_settings',",
      "429:                 ],",
      "430:                 'system.manage_mail_templates' => [",
      "431:                     'label' => 'system::lang.permissions.manage_mail_templates',",
      "433:                 ]",
      "434:             ]);",
      "435:         });",
      "",
      "[Removed Lines]",
      "420:                     'tab' => 'system::lang.permissions.name'",
      "424:                     'tab' => 'system::lang.permissions.name'",
      "428:                     'tab' => 'system::lang.permissions.name'",
      "432:                     'tab' => 'system::lang.permissions.name'",
      "",
      "[Added Lines]",
      "421:                     'tab' => 'system::lang.permissions.name',",
      "422:                     'roles' => UserRole::CODE_DEVELOPER,",
      "426:                     'tab' => 'system::lang.permissions.name',",
      "427:                     'roles' => UserRole::CODE_DEVELOPER,",
      "431:                     'tab' => 'system::lang.permissions.name',",
      "432:                     'roles' => UserRole::CODE_DEVELOPER,",
      "436:                     'tab' => 'system::lang.permissions.name',",
      "437:                     'roles' => UserRole::CODE_DEVELOPER,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b407f26e024c9f3d10fc9c0ea14fe2649c01e1e2",
      "candidate_info": {
        "commit_hash": "b407f26e024c9f3d10fc9c0ea14fe2649c01e1e2",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/b407f26e024c9f3d10fc9c0ea14fe2649c01e1e2",
        "files": [
          "modules/backend/lang/en/lang.php",
          "modules/backend/widgets/Form.php"
        ],
        "message": "Add support for \\Path\\To\\Class::staticMethodName for defining field options.\n\nRelated: https://github.com/octobercms/library/commit/95d0b61a298d0933dd2117967481e00b416029c4",
        "before_after_code_files": [
          "modules/backend/lang/en/lang.php||modules/backend/lang/en/lang.php",
          "modules/backend/widgets/Form.php||modules/backend/widgets/Form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/backend/lang/en/lang.php||modules/backend/lang/en/lang.php": [
          "File: modules/backend/lang/en/lang.php -> modules/backend/lang/en/lang.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:         'invalid_type' => 'Invalid field type used :type.',",
          "10:         'options_method_invalid_model' => \"The attribute ':field' does not resolve to a valid model. Try specifying the options method for model class :model explicitly.\",",
          "11:         'options_method_not_exists' => \"The model class :model must define a method :method() returning options for the ':field' form field.\",",
          "12:         'colors_method_not_exists' => \"The model class :model must define a method :method() returning html color HEX codes for the ':field' form field.\",",
          "13:     ],",
          "14:     'widget' => [",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "12:         'options_static_method_invalid_value' => \"The static method ':method()' on :class did not return a valid options array.\",",
          "",
          "---------------"
        ],
        "modules/backend/widgets/Form.php||modules/backend/widgets/Form.php": [
          "File: modules/backend/widgets/Form.php -> modules/backend/widgets/Form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1330:         elseif (is_string($fieldOptions)) {",
          "1331:             if (!$this->objectMethodExists($this->model, $fieldOptions)) {",
          "1332:                 throw new ApplicationException(Lang::get('backend::lang.field.options_method_not_exists', [",
          "1333:                     'model'  => get_class($this->model),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1333:             if (str_contains($fieldOptions, '::')) {",
          "1334:                 $options = explode('::', $fieldOptions);",
          "1335:                 if (count($options) === 2 && class_exists($options[0]) && method_exists($options[0], $options[1])) {",
          "1336:                     $result = $options[0]::{$options[1]}();",
          "1337:                     if (!is_array($result)) {",
          "1338:                         throw new ApplicationException(Lang::get('backend::lang.field.options_static_method_invalid_value', [",
          "1339:                             'class' => $options[0],",
          "1340:                             'method' => $options[1]",
          "1341:                         ]));",
          "1342:                     }",
          "1343:                     return $result;",
          "1344:                 }",
          "1345:             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "15ca68c22df788397b2e84a9abfa5ecbc579b3ff",
      "candidate_info": {
        "commit_hash": "15ca68c22df788397b2e84a9abfa5ecbc579b3ff",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/15ca68c22df788397b2e84a9abfa5ecbc579b3ff",
        "files": [
          "modules/system/classes/MediaLibrary.php"
        ],
        "message": "No need to throw exceptions when generating MediaLibrary URLs",
        "before_after_code_files": [
          "modules/system/classes/MediaLibrary.php||modules/system/classes/MediaLibrary.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/system/classes/MediaLibrary.php||modules/system/classes/MediaLibrary.php": [
          "File: modules/system/classes/MediaLibrary.php -> modules/system/classes/MediaLibrary.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "537:     public function getPathUrl($path)",
          "538:     {",
          "541:         $fullPath = $this->storagePath . implode(\"/\", array_map(\"rawurlencode\", explode(\"/\", $path)));",
          "",
          "[Removed Lines]",
          "539:         $path = $this->validatePath($path);",
          "",
          "[Added Lines]",
          "539:         $path = $this->validatePath($path, true);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3dc105173a8899b6266bc8befce0d289802a06a0",
      "candidate_info": {
        "commit_hash": "3dc105173a8899b6266bc8befce0d289802a06a0",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/3dc105173a8899b6266bc8befce0d289802a06a0",
        "files": [
          "modules/system/twig/Engine.php",
          "modules/system/twig/Loader.php"
        ],
        "message": "Only allow local files via view engine\n\nThe Laravel view engine wants to supply the Twig engine with an absolute path, even though this is outside the inclusion rules. This implements a temporary exception to wave it through. It seems like a suitable alternative instead of implementing a reverse lookup to ensure the path is a valid view file, since we can trust the source engine has passed the value through its resolver already\n\nFixes previous fix",
        "before_after_code_files": [
          "modules/system/twig/Engine.php||modules/system/twig/Engine.php",
          "modules/system/twig/Loader.php||modules/system/twig/Loader.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/system/twig/Engine.php||modules/system/twig/Engine.php": [
          "File: modules/system/twig/Engine.php -> modules/system/twig/Engine.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <?php namespace System\\Twig;",
          "3: use Twig\\Environment as TwigEnvironment;",
          "4: use Illuminate\\Contracts\\View\\Engine as EngineInterface;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: use System\\Twig\\Loader as TwigLoader;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "27:     public function get($path, array $vars = [])",
          "28:     {",
          "29:         $template = $this->environment->loadTemplate($path);",
          "30:         return $template->render($vars);",
          "31:     }",
          "32: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30:         $previousAllow = TwigLoader::$allowInclude;",
          "32:         TwigLoader::$allowInclude = true;",
          "36:         TwigLoader::$allowInclude = $previousAllow;",
          "",
          "---------------"
        ],
        "modules/system/twig/Loader.php||modules/system/twig/Loader.php": [
          "File: modules/system/twig/Loader.php -> modules/system/twig/Loader.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: class Loader implements TwigLoaderInterface",
          "16: {",
          "",
          "[Removed Lines]",
          "20:     protected $extension = 'htm';",
          "",
          "[Added Lines]",
          "20:     public static $allowInclude = false;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "37:             return $this->cache[$name];",
          "38:         }",
          "43:         }",
          "45:         $path = $finder->find($name);",
          "",
          "[Removed Lines]",
          "40:         $view = $name;",
          "41:         if (File::extension($view) === $this->extension) {",
          "42:             $view = substr($view, 0, -strlen($this->extension));",
          "",
          "[Added Lines]",
          "40:         if (static::$allowInclude === true && File::isFile($name)) {",
          "41:             return $this->cache[$name] = $name;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ce361cae67cad5aeeab92b4b19ab03002f2e69b4",
      "candidate_info": {
        "commit_hash": "ce361cae67cad5aeeab92b4b19ab03002f2e69b4",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/ce361cae67cad5aeeab92b4b19ab03002f2e69b4",
        "files": [
          "tests/unit/system/classes/UpdatesControllerTest.php"
        ],
        "message": "Fix UpdatesController test",
        "before_after_code_files": [
          "tests/unit/system/classes/UpdatesControllerTest.php||tests/unit/system/classes/UpdatesControllerTest.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/unit/system/classes/UpdatesControllerTest.php||tests/unit/system/classes/UpdatesControllerTest.php": [
          "File: tests/unit/system/classes/UpdatesControllerTest.php -> tests/unit/system/classes/UpdatesControllerTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "14:         $controller = $this->getMockBuilder(Updates::class)->disableOriginalConstructor()->getMock();",
          "16:         $expectedVersions = [",
          "17:             '1.0.5' => [",
          "18:                 'Create blog settings table',",
          "19:                 'Another update message',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "17:             '1.2.0' => [",
          "18:                 '!!! Security update - see: https://octobercms.com',",
          "19:             ],",
          "20:             '1.1.0' => [",
          "21:                 '!!! Drop support for blog settings',",
          "22:             ],",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0101e1f96b49cf9324ca5ff405e42e810eabc96a",
      "candidate_info": {
        "commit_hash": "0101e1f96b49cf9324ca5ff405e42e810eabc96a",
        "repo": "octobercms/october",
        "commit_url": "https://github.com/octobercms/october/commit/0101e1f96b49cf9324ca5ff405e42e810eabc96a",
        "files": [
          "modules/system/classes/ImageResizer.php"
        ],
        "message": "Fix issue with image resizer URLs that contain URL-encoded characters (i.e. spaces)\n\nDon't double decode the URL when validating it because the routing engine already decoded it once",
        "before_after_code_files": [
          "modules/system/classes/ImageResizer.php||modules/system/classes/ImageResizer.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/octobercms/october/pull/5359"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/system/classes/ImageResizer.php||modules/system/classes/ImageResizer.php": [
          "File: modules/system/classes/ImageResizer.php -> modules/system/classes/ImageResizer.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "483:     {",
          "489:         $identifier = $this->getIdentifier();",
          "",
          "[Removed Lines]",
          "486:         $resizedUrl = urlencode(urlencode($this->getResizedUrl()));",
          "",
          "[Added Lines]",
          "486:         $resizedUrl = rawurlencode(rawurlencode($this->getResizedUrl()));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "572:         } elseif (is_string($image)) {",
          "578:             $resizeSources = static::getAvailableSources();",
          "579:             foreach ($resizeSources as $source => $details) {",
          "584:                 if (starts_with($relativePath, $sourcePath)) {",
          "",
          "[Removed Lines]",
          "574:             $relativePath = static::normalizePath(urldecode(parse_url($image, PHP_URL_PATH)));",
          "581:                 $sourcePath = static::normalizePath(urldecode(parse_url($details['path'], PHP_URL_PATH)));",
          "",
          "[Added Lines]",
          "574:             $relativePath = static::normalizePath(rawurldecode(parse_url($image, PHP_URL_PATH)));",
          "581:                 $sourcePath = static::normalizePath(rawurldecode(parse_url($details['path'], PHP_URL_PATH)));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "727:     {",
          "731:         $url = null;",
          "",
          "[Removed Lines]",
          "730:         $decodedUrl = urldecode(urldecode($encodedUrl));",
          "",
          "[Added Lines]",
          "730:         $decodedUrl = rawurldecode($encodedUrl);",
          "",
          "---------------"
        ]
      }
    }
  ]
}