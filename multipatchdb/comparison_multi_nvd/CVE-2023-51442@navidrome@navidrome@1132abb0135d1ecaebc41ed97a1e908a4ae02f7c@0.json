{
  "cve_id": "CVE-2023-51442",
  "cve_desc": "Navidrome is an open source web-based music collection server and streamer. A security vulnerability has been identified in navidrome's subsonic endpoint, allowing for authentication bypass. This exploit enables unauthorized access to any known account by utilizing a JSON Web Token (JWT) signed with the key \"not so secret\". The vulnerability can only be exploited on instances that have never been restarted. Navidrome supports an extension to the subsonic authentication scheme, where a JWT can be provided using a `jwt` query parameter instead of the traditional password or token and salt (corresponding to resp. the `p` or `t` and `s` query parameters). This authentication bypass vulnerability potentially affects all instances that don't protect the subsonic endpoint `/rest/`, which is expected to be most instances in a standard deployment, and most instances in the reverse proxy setup too (as the documentation mentions to leave that endpoint unprotected). This issue has been patched in version 0.50.2.\n",
  "repo": "navidrome/navidrome",
  "patch_hash": "1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
  "patch_info": {
    "commit_hash": "1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
    "repo": "navidrome/navidrome",
    "commit_url": "https://github.com/navidrome/navidrome/commit/1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
    "files": [
      "core/auth/auth.go",
      "server/server.go"
    ],
    "message": "Fix possible authentication bypass",
    "before_after_code_files": [
      "core/auth/auth.go||core/auth/auth.go",
      "server/server.go||server/server.go"
    ]
  },
  "patch_diff": {
    "core/auth/auth.go||core/auth/auth.go": [
      "File: core/auth/auth.go -> core/auth/auth.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "6:  \"time\"",
      "8:  \"github.com/go-chi/jwtauth/v5\"",
      "9:  \"github.com/lestrrat-go/jwx/v2/jwt\"",
      "10:  \"github.com/navidrome/navidrome/conf\"",
      "11:  \"github.com/navidrome/navidrome/consts\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "9:  \"github.com/google/uuid\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "23: func Init(ds model.DataStore) {",
      "24:  once.Do(func() {",
      "25:   log.Info(\"Setting Session Timeout\", \"value\", conf.Server.SessionTimeout)",
      "28:    log.Error(\"No JWT secret found in DB. Setting a temp one, but please report this error\", err)",
      "29:   }",
      "30:   Secret = []byte(secret)",
      "31:   TokenAuth = jwtauth.New(\"HS256\", Secret, nil)",
      "",
      "[Removed Lines]",
      "26:   secret, err := ds.Property(context.TODO()).DefaultGet(consts.JWTSecretKey, \"not so secret\")",
      "27:   if err != nil {",
      "",
      "[Added Lines]",
      "27:   secret, err := ds.Property(context.TODO()).Get(consts.JWTSecretKey)",
      "28:   if err != nil || secret == \"\" {",
      "30:    secret = uuid.NewString()",
      "",
      "---------------"
    ],
    "server/server.go||server/server.go": [
      "File: server/server.go -> server/server.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "35: func New(ds model.DataStore, broker events.Broker) *Server {",
      "36:  s := &Server{ds: ds, broker: broker}",
      "38:  initialSetup(ds)",
      "39:  s.initRoutes()",
      "40:  s.mountAuthenticationRoutes()",
      "41:  s.mountRootRedirector()",
      "",
      "[Removed Lines]",
      "37:  auth.Init(s.ds)",
      "",
      "[Added Lines]",
      "38:  auth.Init(s.ds)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
      "candidate_info": {
        "commit_hash": "1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
        "repo": "navidrome/navidrome",
        "commit_url": "https://github.com/navidrome/navidrome/commit/1132abb0135d1ecaebc41ed97a1e908a4ae02f7c",
        "files": [
          "core/auth/auth.go",
          "server/server.go"
        ],
        "message": "Fix possible authentication bypass",
        "before_after_code_files": [
          "core/auth/auth.go||core/auth/auth.go",
          "server/server.go||server/server.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/auth/auth.go||core/auth/auth.go",
            "server/server.go||server/server.go"
          ],
          "candidate": [
            "core/auth/auth.go||core/auth/auth.go",
            "server/server.go||server/server.go"
          ]
        }
      },
      "candidate_diff": {
        "core/auth/auth.go||core/auth/auth.go": [
          "File: core/auth/auth.go -> core/auth/auth.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "6:  \"time\"",
          "8:  \"github.com/go-chi/jwtauth/v5\"",
          "9:  \"github.com/lestrrat-go/jwx/v2/jwt\"",
          "10:  \"github.com/navidrome/navidrome/conf\"",
          "11:  \"github.com/navidrome/navidrome/consts\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9:  \"github.com/google/uuid\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "23: func Init(ds model.DataStore) {",
          "24:  once.Do(func() {",
          "25:   log.Info(\"Setting Session Timeout\", \"value\", conf.Server.SessionTimeout)",
          "28:    log.Error(\"No JWT secret found in DB. Setting a temp one, but please report this error\", err)",
          "29:   }",
          "30:   Secret = []byte(secret)",
          "31:   TokenAuth = jwtauth.New(\"HS256\", Secret, nil)",
          "",
          "[Removed Lines]",
          "26:   secret, err := ds.Property(context.TODO()).DefaultGet(consts.JWTSecretKey, \"not so secret\")",
          "27:   if err != nil {",
          "",
          "[Added Lines]",
          "27:   secret, err := ds.Property(context.TODO()).Get(consts.JWTSecretKey)",
          "28:   if err != nil || secret == \"\" {",
          "30:    secret = uuid.NewString()",
          "",
          "---------------"
        ],
        "server/server.go||server/server.go": [
          "File: server/server.go -> server/server.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: func New(ds model.DataStore, broker events.Broker) *Server {",
          "36:  s := &Server{ds: ds, broker: broker}",
          "38:  initialSetup(ds)",
          "39:  s.initRoutes()",
          "40:  s.mountAuthenticationRoutes()",
          "41:  s.mountRootRedirector()",
          "",
          "[Removed Lines]",
          "37:  auth.Init(s.ds)",
          "",
          "[Added Lines]",
          "38:  auth.Init(s.ds)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d80e1a260bed86cef0ef6bbaa85b9346bd0488f1",
      "candidate_info": {
        "commit_hash": "d80e1a260bed86cef0ef6bbaa85b9346bd0488f1",
        "repo": "navidrome/navidrome",
        "commit_url": "https://github.com/navidrome/navidrome/commit/d80e1a260bed86cef0ef6bbaa85b9346bd0488f1",
        "files": [
          "core/auth/auth.go",
          "server/server.go"
        ],
        "message": "Fix possible authentication bypass",
        "before_after_code_files": [
          "core/auth/auth.go||core/auth/auth.go",
          "server/server.go||server/server.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/auth/auth.go||core/auth/auth.go",
            "server/server.go||server/server.go"
          ],
          "candidate": [
            "core/auth/auth.go||core/auth/auth.go",
            "server/server.go||server/server.go"
          ]
        }
      },
      "candidate_diff": {
        "core/auth/auth.go||core/auth/auth.go": [
          "File: core/auth/auth.go -> core/auth/auth.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "6:  \"time\"",
          "8:  \"github.com/go-chi/jwtauth/v5\"",
          "9:  \"github.com/lestrrat-go/jwx/v2/jwt\"",
          "10:  \"github.com/navidrome/navidrome/conf\"",
          "11:  \"github.com/navidrome/navidrome/consts\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9:  \"github.com/google/uuid\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "23: func Init(ds model.DataStore) {",
          "24:  once.Do(func() {",
          "25:   log.Info(\"Setting Session Timeout\", \"value\", conf.Server.SessionTimeout)",
          "28:    log.Error(\"No JWT secret found in DB. Setting a temp one, but please report this error\", err)",
          "29:   }",
          "30:   Secret = []byte(secret)",
          "31:   TokenAuth = jwtauth.New(\"HS256\", Secret, nil)",
          "",
          "[Removed Lines]",
          "26:   secret, err := ds.Property(context.TODO()).DefaultGet(consts.JWTSecretKey, \"not so secret\")",
          "27:   if err != nil {",
          "",
          "[Added Lines]",
          "27:   secret, err := ds.Property(context.TODO()).Get(consts.JWTSecretKey)",
          "28:   if err != nil || secret == \"\" {",
          "30:    secret = uuid.NewString()",
          "",
          "---------------"
        ],
        "server/server.go||server/server.go": [
          "File: server/server.go -> server/server.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: func New(ds model.DataStore, broker events.Broker) *Server {",
          "36:  s := &Server{ds: ds, broker: broker}",
          "38:  initialSetup(ds)",
          "39:  s.initRoutes()",
          "40:  s.mountAuthenticationRoutes()",
          "41:  s.mountRootRedirector()",
          "",
          "[Removed Lines]",
          "37:  auth.Init(s.ds)",
          "",
          "[Added Lines]",
          "38:  auth.Init(s.ds)",
          "",
          "---------------"
        ]
      }
    }
  ]
}