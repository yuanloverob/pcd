{
  "cve_id": "CVE-2023-23931",
  "cve_desc": "cryptography is a package designed to expose cryptographic primitives and recipes to Python developers. In affected versions `Cipher.update_into` would accept Python objects which implement the buffer protocol, but provide only immutable buffers. This would allow immutable objects (such as `bytes`) to be mutated, thus violating fundamental rules of Python and resulting in corrupted output. This now correctly raises an exception. This issue has been present since `update_into` was originally introduced in cryptography 1.8.",
  "repo": "pyca/cryptography",
  "patch_hash": "94a50a9731f35405f0357fa5f3b177d46a726ab3",
  "patch_info": {
    "commit_hash": "94a50a9731f35405f0357fa5f3b177d46a726ab3",
    "repo": "pyca/cryptography",
    "commit_url": "https://github.com/pyca/cryptography/pull/8230/commits/94a50a9731f35405f0357fa5f3b177d46a726ab3",
    "files": [
      "src/cryptography/hazmat/backends/openssl/ciphers.py",
      "tests/hazmat/primitives/test_ciphers.py"
    ],
    "message": "Don't allow update_into to mutate immutable objects",
    "before_after_code_files": [
      "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py",
      "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py"
    ]
  },
  "patch_diff": {
    "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py": [
      "File: src/cryptography/hazmat/backends/openssl/ciphers.py -> src/cryptography/hazmat/backends/openssl/ciphers.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "156:         data_processed = 0",
      "157:         total_out = 0",
      "158:         outlen = self._backend._ffi.new(\"int *\")",
      "160:         baseinbuf = self._backend._ffi.from_buffer(data)",
      "162:         while data_processed != total_data_len:",
      "",
      "[Removed Lines]",
      "159:         baseoutbuf = self._backend._ffi.from_buffer(buf)",
      "",
      "[Added Lines]",
      "159:         baseoutbuf = self._backend._ffi.from_buffer(buf, require_writable=True)",
      "",
      "---------------"
    ],
    "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py": [
      "File: tests/hazmat/primitives/test_ciphers.py -> tests/hazmat/primitives/test_ciphers.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "318:         with pytest.raises(ValueError):",
      "319:             encryptor.update_into(b\"testing\", buf)",
      "321:     @pytest.mark.supported(",
      "322:         only_if=lambda backend: backend.cipher_supported(",
      "323:             AES(b\"\\x00\" * 16), modes.GCM(b\"\\x00\" * 12)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "321:     def test_update_into_immutable(self, backend):",
      "322:         key = b\"\\x00\" * 16",
      "323:         c = ciphers.Cipher(AES(key), modes.ECB(), backend)",
      "324:         encryptor = c.encryptor()",
      "325:         buf = b\"\\x00\" * 32",
      "326:         with pytest.raises((TypeError, BufferError)):",
      "327:             encryptor.update_into(b\"testing\", buf)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9fbf84efc861668755ab645530ec7be9cf3c6696",
      "candidate_info": {
        "commit_hash": "9fbf84efc861668755ab645530ec7be9cf3c6696",
        "repo": "pyca/cryptography",
        "commit_url": "https://github.com/pyca/cryptography/commit/9fbf84efc861668755ab645530ec7be9cf3c6696",
        "files": [
          "src/cryptography/hazmat/backends/openssl/ciphers.py",
          "tests/hazmat/primitives/test_ciphers.py"
        ],
        "message": "Don't allow update_into to mutate immutable objects (#8230)",
        "before_after_code_files": [
          "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py",
          "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/pyca/cryptography/pull/8230"
        ],
        "olp_code_files": {
          "patch": [
            "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py",
            "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py"
          ],
          "candidate": [
            "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py",
            "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py"
          ]
        }
      },
      "candidate_diff": {
        "src/cryptography/hazmat/backends/openssl/ciphers.py||src/cryptography/hazmat/backends/openssl/ciphers.py": [
          "File: src/cryptography/hazmat/backends/openssl/ciphers.py -> src/cryptography/hazmat/backends/openssl/ciphers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:         data_processed = 0",
          "157:         total_out = 0",
          "158:         outlen = self._backend._ffi.new(\"int *\")",
          "160:         baseinbuf = self._backend._ffi.from_buffer(data)",
          "162:         while data_processed != total_data_len:",
          "",
          "[Removed Lines]",
          "159:         baseoutbuf = self._backend._ffi.from_buffer(buf)",
          "",
          "[Added Lines]",
          "159:         baseoutbuf = self._backend._ffi.from_buffer(buf, require_writable=True)",
          "",
          "---------------"
        ],
        "tests/hazmat/primitives/test_ciphers.py||tests/hazmat/primitives/test_ciphers.py": [
          "File: tests/hazmat/primitives/test_ciphers.py -> tests/hazmat/primitives/test_ciphers.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "318:         with pytest.raises(ValueError):",
          "319:             encryptor.update_into(b\"testing\", buf)",
          "321:     @pytest.mark.supported(",
          "322:         only_if=lambda backend: backend.cipher_supported(",
          "323:             AES(b\"\\x00\" * 16), modes.GCM(b\"\\x00\" * 12)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "321:     def test_update_into_immutable(self, backend):",
          "322:         key = b\"\\x00\" * 16",
          "323:         c = ciphers.Cipher(AES(key), modes.ECB(), backend)",
          "324:         encryptor = c.encryptor()",
          "325:         buf = b\"\\x00\" * 32",
          "326:         with pytest.raises((TypeError, BufferError)):",
          "327:             encryptor.update_into(b\"testing\", buf)",
          "",
          "---------------"
        ]
      }
    }
  ]
}