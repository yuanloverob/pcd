{
  "cve_id": "CVE-2023-51763",
  "cve_desc": "csv_builder.rb in ActiveAdmin (aka Active Admin) before 3.2.0 allows CSV injection.",
  "repo": "activeadmin/activeadmin",
  "patch_hash": "697be2b183491beadc8f0b7d8b5bfb44f2387909",
  "patch_info": {
    "commit_hash": "697be2b183491beadc8f0b7d8b5bfb44f2387909",
    "repo": "activeadmin/activeadmin",
    "commit_url": "https://github.com/activeadmin/activeadmin/commit/697be2b183491beadc8f0b7d8b5bfb44f2387909",
    "files": [
      "lib/active_admin/csv_builder.rb",
      "spec/unit/csv_builder_spec.rb"
    ],
    "message": "Protect against CSV Injection (#8161)\n\nprotect against CSV Injection\n\nRead more here https://owasp.org/www-community/attacks/CSV_Injection",
    "before_after_code_files": [
      "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb",
      "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb"
    ]
  },
  "patch_diff": {
    "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb": [
      "File: lib/active_admin/csv_builder.rb -> lib/active_admin/csv_builder.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:       csv << bom if bom",
      "53:       if column_names",
      "55:       end",
      "57:       controller.send(:in_paginated_batches) do |resource|",
      "",
      "[Removed Lines]",
      "54:         csv << CSV.generate_line(columns.map { |c| encode c.name, options }, **csv_options)",
      "",
      "[Added Lines]",
      "54:         csv << CSV.generate_line(columns.map { |c| sanitize(encode(c.name, options)) }, **csv_options)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71:     def build_row(resource, columns, options)",
      "72:       columns.map do |column|",
      "74:       end",
      "75:     end",
      "",
      "[Removed Lines]",
      "73:         encode call_method_or_proc_on(resource, column.data), options",
      "",
      "[Added Lines]",
      "73:         sanitize(encode(call_method_or_proc_on(resource, column.data), options))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "86:       end",
      "87:     end",
      "89:     def method_missing(method, *args, &block)",
      "90:       if @view_context.respond_to? method",
      "91:         @view_context.public_send method, *args, &block",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "89:     def sanitize(content)",
      "90:       Sanitizer.sanitize(content)",
      "91:     end",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "120:       @column_transitive_options ||= @options.slice(*COLUMN_TRANSITIVE_OPTIONS)",
      "121:     end",
      "122:   end",
      "123: end",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "128:   # Prevents CSV Injection according to https://owasp.org/www-community/attacks/CSV_Injection",
      "129:   module Sanitizer",
      "130:     extend self",
      "132:     ATTACK_CHARACTERS = ['=', '+', '-', '@', \"\\t\", \"\\r\"].freeze",
      "134:     def sanitize(value)",
      "135:       return \"'#{value}\" if require_sanitization?(value)",
      "137:       value",
      "138:     end",
      "140:     def require_sanitization?(value)",
      "141:       value.is_a?(String) && value.starts_with?(*ATTACK_CHARACTERS)",
      "142:     end",
      "143:   end",
      "",
      "---------------"
    ],
    "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb": [
      "File: spec/unit/csv_builder_spec.rb -> spec/unit/csv_builder_spec.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "277:       end",
      "278:     end",
      "279:   end",
      "280: end",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "281:   context 'csv injection' do",
      "282:     let(:dummy_controller) do",
      "283:       class DummyController",
      "284:         def in_paginated_batches(&block)",
      "285:           Post.all.each(&block)",
      "286:         end",
      "288:         def view_context",
      "289:           MethodOrProcHelper",
      "290:         end",
      "291:       end",
      "292:       DummyController.new",
      "293:     end",
      "295:     let(:builder) do",
      "296:       ActiveAdmin::CSVBuilder.new do",
      "297:         column(:id)",
      "298:         column(:title)",
      "299:       end",
      "300:     end",
      "302:     ['=', '+', '-', '@', \"\\t\", \"\\r\"].each do |char|",
      "303:       it \"prepends a single quote when column starts with a #{char} character\" do",
      "304:         attack = \"#{char}1+2\"",
      "306:         escaped_attack = \"'#{attack}\"",
      "307:         escaped_attack = \"\\\"#{escaped_attack}\\\"\" if char == \"\\r\"",
      "309:         post = Post.create!(title: attack)",
      "310:         receiver = []",
      "311:         builder.build dummy_controller, receiver",
      "312:         line = receiver.last",
      "313:         expect(line).to eq \"#{post.id},#{escaped_attack}\\n\"",
      "314:       end",
      "316:       it \"accounts for the field separator when character #{char} is used to inject a formula\" do",
      "317:         attack = \"#{char}1+2'\\\" ;,#{char}1+2\"",
      "318:         escaped_attack = \"\\\"'#{attack.gsub('\"', '\"\"')}\\\"\"",
      "320:         post = Post.create!(title: attack)",
      "321:         receiver = []",
      "322:         builder.build dummy_controller, receiver",
      "323:         line = receiver.last",
      "324:         expect(line).to eq \"#{post.id},#{escaped_attack}\\n\"",
      "325:       end",
      "326:     end",
      "327:   end",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7af735cf657c73734fca1900cd6a5adac4ee706e",
      "candidate_info": {
        "commit_hash": "7af735cf657c73734fca1900cd6a5adac4ee706e",
        "repo": "activeadmin/activeadmin",
        "commit_url": "https://github.com/activeadmin/activeadmin/commit/7af735cf657c73734fca1900cd6a5adac4ee706e",
        "files": [
          "lib/active_admin/csv_builder.rb",
          "spec/unit/csv_builder_spec.rb"
        ],
        "message": "Backport to 3-0 stable branch protect against CSV Injection (#8161) (#8167)\n\nprotect against CSV Injection\n\nRead more here https://owasp.org/www-community/attacks/CSV_Injection",
        "before_after_code_files": [
          "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb",
          "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb",
            "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb"
          ],
          "candidate": [
            "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb",
            "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/active_admin/csv_builder.rb||lib/active_admin/csv_builder.rb": [
          "File: lib/active_admin/csv_builder.rb -> lib/active_admin/csv_builder.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:       csv << bom if bom",
          "53:       if column_names",
          "55:       end",
          "57:       controller.send(:in_paginated_batches) do |resource|",
          "",
          "[Removed Lines]",
          "54:         csv << CSV.generate_line(columns.map { |c| encode c.name, options }, **csv_options)",
          "",
          "[Added Lines]",
          "54:         csv << CSV.generate_line(columns.map { |c| sanitize(encode(c.name, options)) }, **csv_options)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:     def build_row(resource, columns, options)",
          "72:       columns.map do |column|",
          "74:       end",
          "75:     end",
          "",
          "[Removed Lines]",
          "73:         encode call_method_or_proc_on(resource, column.data), options",
          "",
          "[Added Lines]",
          "73:         sanitize(encode(call_method_or_proc_on(resource, column.data), options))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "86:       end",
          "87:     end",
          "89:     def method_missing(method, *args, &block)",
          "90:       if @view_context.respond_to? method",
          "91:         @view_context.public_send method, *args, &block",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "89:     def sanitize(content)",
          "90:       Sanitizer.sanitize(content)",
          "91:     end",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "120:       @column_transitive_options ||= @options.slice(*COLUMN_TRANSITIVE_OPTIONS)",
          "121:     end",
          "122:   end",
          "123: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128:   # Prevents CSV Injection according to https://owasp.org/www-community/attacks/CSV_Injection",
          "129:   module Sanitizer",
          "130:     extend self",
          "132:     ATTACK_CHARACTERS = [\"=\", \"+\", \"-\", \"@\", \"\\t\", \"\\r\"].freeze",
          "134:     def sanitize(value)",
          "135:       return \"'#{value}\" if require_sanitization?(value)",
          "137:       value",
          "138:     end",
          "140:     def require_sanitization?(value)",
          "141:       value.is_a?(String) && value.starts_with?(*ATTACK_CHARACTERS)",
          "142:     end",
          "143:   end",
          "",
          "---------------"
        ],
        "spec/unit/csv_builder_spec.rb||spec/unit/csv_builder_spec.rb": [
          "File: spec/unit/csv_builder_spec.rb -> spec/unit/csv_builder_spec.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "277:       end",
          "278:     end",
          "279:   end",
          "280: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "281:   context \"csv injection\" do",
          "282:     let(:dummy_controller) do",
          "283:       class DummyController",
          "284:         def in_paginated_batches(&block)",
          "285:           Post.all.each(&block)",
          "286:         end",
          "288:         def view_context",
          "289:           MethodOrProcHelper",
          "290:         end",
          "291:       end",
          "292:       DummyController.new",
          "293:     end",
          "295:     let(:builder) do",
          "296:       ActiveAdmin::CSVBuilder.new do",
          "297:         column(:id)",
          "298:         column(:title)",
          "299:       end",
          "300:     end",
          "302:     [\"=\", \"+\", \"-\", \"@\", \"\\t\", \"\\r\"].each do |char|",
          "303:       it \"prepends a single quote when column starts with a #{char} character\" do",
          "304:         attack = \"#{char}1+2\"",
          "306:         escaped_attack = \"'#{attack}\"",
          "307:         escaped_attack = \"\\\"#{escaped_attack}\\\"\" if char == \"\\r\"",
          "309:         post = Post.create!(title: attack)",
          "310:         receiver = []",
          "311:         builder.build dummy_controller, receiver",
          "312:         line = receiver.last",
          "313:         expect(line).to eq \"#{post.id},#{escaped_attack}\\n\"",
          "314:       end",
          "316:       it \"accounts for the field separator when character #{char} is used to inject a formula\" do",
          "317:         attack = \"#{char}1+2'\\\" ;,#{char}1+2\"",
          "318:         escaped_attack = \"\\\"'#{attack.gsub('\"', '\"\"')}\\\"\"",
          "320:         post = Post.create!(title: attack)",
          "321:         receiver = []",
          "322:         builder.build dummy_controller, receiver",
          "323:         line = receiver.last",
          "324:         expect(line).to eq \"#{post.id},#{escaped_attack}\\n\"",
          "325:       end",
          "326:     end",
          "327:   end",
          "",
          "---------------"
        ]
      }
    }
  ]
}