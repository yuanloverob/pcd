{
  "cve_id": "CVE-2023-41102",
  "cve_desc": "An issue was discovered in the captive portal in OpenNDS before version 10.1.3. It has multiple memory leaks due to not freeing up allocated memory. This may lead to a Denial-of-Service condition due to the consumption of all available memory. Affected OpenNDS before version 10.1.3 fixed in OpenWrt master and OpenWrt 23.05 on 23. November by updating OpenNDS to version 10.2.0.",
  "repo": "openNDS/openNDS",
  "patch_hash": "31dbf4aa069c5bb39a7926d86036ce3b04312b51",
  "patch_info": {
    "commit_hash": "31dbf4aa069c5bb39a7926d86036ce3b04312b51",
    "repo": "openNDS/openNDS",
    "commit_url": "https://github.com/openNDS/openNDS/commit/31dbf4aa069c5bb39a7926d86036ce3b04312b51",
    "files": [
      "src/client_list.c",
      "src/http_microhttpd.c"
    ],
    "message": "Fix - memory leak when deleting client from client list\n\nSigned-off-by: Rob White <rob@blue-wave.net>",
    "before_after_code_files": [
      "src/client_list.c||src/client_list.c",
      "src/http_microhttpd.c||src/http_microhttpd.c"
    ]
  },
  "patch_diff": {
    "src/client_list.c||src/client_list.c": [
      "File: src/client_list.c -> src/client_list.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "173:  client->hid = safe_strdup(hash);",
      "174:  free(hash);",
      "177:  client->custom = safe_calloc(MID_BUF);",
      "178:  client->client_type = safe_calloc(STATUS_BUF);",
      "181:  if (client->cid) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "180:  if (!client->cpi_query) {",
      "181:   client->cpi_query = safe_calloc(STATUS_BUF);",
      "182:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "188:    free(msg);",
      "189:    free(cidinfo);",
      "190:   }",
      "193:  }",
      "195: }",
      "",
      "[Removed Lines]",
      "192:   client->cid = safe_calloc(SMALL_BUF);",
      "",
      "[Added Lines]",
      "197:  client->cid = safe_calloc(SMALL_BUF);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "428:   }",
      "429:  }",
      "431:  free(client);",
      "432: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "435:  free(client->token);",
      "436:  free(client->hid);",
      "437:  free(client->custom);",
      "438:  free(client->client_type);",
      "439:  free(client->cid);",
      "441:  if (strcmp(client->cpi_query, \"\") == 0) {",
      "442:   free(client->cpi_query);",
      "443:  }",
      "",
      "---------------"
    ],
    "src/http_microhttpd.c||src/http_microhttpd.c": [
      "File: src/http_microhttpd.c -> src/http_microhttpd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1385:  if (strcmp(url, \"/login\") == 0) {",
      "1386:   client->cpi_query = safe_strdup(originurl);",
      "1387:   debug(LOG_DEBUG, \"RFC8910 request: %s\", client->cpi_query);",
      "1390:  }",
      "1392:  debug(LOG_DEBUG, \"originurl_raw: %s\", originurl_raw);",
      "",
      "[Removed Lines]",
      "1388:  } else {",
      "1389:   client->cpi_query = \"none\";",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c104cd1b3131f70f218cfa3b01e8b56870eaf3d3",
      "candidate_info": {
        "commit_hash": "c104cd1b3131f70f218cfa3b01e8b56870eaf3d3",
        "repo": "openNDS/openNDS",
        "commit_url": "https://github.com/openNDS/openNDS/commit/c104cd1b3131f70f218cfa3b01e8b56870eaf3d3",
        "files": [
          "forward_authentication_service/fas-aes/fas-aes-https.php",
          "forward_authentication_service/fas-aes/fas-aes.php",
          "forward_authentication_service/fas-hid/fas-hid.php"
        ],
        "message": "Add - support for cpi_query in example FAS scripts\n\nSigned-off-by: Rob White <rob@blue-wave.net>",
        "before_after_code_files": [
          "forward_authentication_service/fas-aes/fas-aes-https.php||forward_authentication_service/fas-aes/fas-aes-https.php",
          "forward_authentication_service/fas-aes/fas-aes.php||forward_authentication_service/fas-aes/fas-aes.php",
          "forward_authentication_service/fas-hid/fas-hid.php||forward_authentication_service/fas-hid/fas-hid.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/openNDS/openNDS/pull/519"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "forward_authentication_service/fas-aes/fas-aes-https.php||forward_authentication_service/fas-aes/fas-aes-https.php": [
          "File: forward_authentication_service/fas-aes/fas-aes-https.php -> forward_authentication_service/fas-aes/fas-aes-https.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "228:  $cipher=\"AES-256-CBC\";",
          "231:  if (isset($_GET['fas']) and isset($_GET['iv']))  {",
          "232:   $string=$_GET['fas'];",
          "",
          "[Removed Lines]",
          "229:  $ndsparamlist=explode(\" \", \"clientip clientmac client_type gatewayname gatewayurl version hid gatewayaddress gatewaymac originurl clientif admin_email location\");",
          "",
          "[Added Lines]",
          "229:  $ndsparamlist=explode(\" \", \"clientip clientmac client_type gatewayname gatewayurl version hid gatewayaddress gatewaymac cpi_query originurl clientif admin_email location\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "443:  $gatewaymac=$GLOBALS[\"gatewaymac\"];",
          "444:  $clientif=$GLOBALS[\"clientif\"];",
          "445:  $originurl=$GLOBALS[\"originurl\"];",
          "446:  $redir=rawurldecode($originurl);",
          "447:  if (isset($_GET[\"fullname\"])) {",
          "448:   $fullname=$_GET[\"fullname\"];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "446:  $cpi_query=$GLOBALS[\"cpi_query\"];",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "457:  }",
          "459:  $log=date('Y-m-d H:i:s', $_SERVER['REQUEST_TIME']).",
          "462:  if ($logpath == \"\") {",
          "463:   $logfile=\"ndslog/ndslog_log.php\";",
          "",
          "[Removed Lines]",
          "460:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $redir\\n\";",
          "",
          "[Added Lines]",
          "461:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $cpi_query, $redir\\n\";",
          "",
          "---------------"
        ],
        "forward_authentication_service/fas-aes/fas-aes.php||forward_authentication_service/fas-aes/fas-aes.php": [
          "File: forward_authentication_service/fas-aes/fas-aes.php -> forward_authentication_service/fas-aes/fas-aes.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "104: #",
          "105: ####################################################################################################################################",
          "109: if (isset($_GET['fas']) and isset($_GET['iv']))  {",
          "110:  $string=$_GET['fas'];",
          "",
          "[Removed Lines]",
          "107: $ndsparamlist=explode(\" \", \"clientip clientmac client_type gatewayname gatewayurl version hid gatewayaddress gatewaymac authdir originurl clientif admin_email location\");",
          "",
          "[Added Lines]",
          "107: $ndsparamlist=explode(\" \", \"clientip clientmac client_type gatewayname gatewayurl version hid gatewayaddress gatewaymac authdir cpi_query originurl clientif admin_email location\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "255:  $clientif=$GLOBALS[\"clientif\"];",
          "256:  $originurl=$GLOBALS[\"originurl\"];",
          "257:  $redir=rawurldecode($originurl);",
          "258:  $fullname=$_GET[\"fullname\"];",
          "259:  $email=$_GET[\"email\"];",
          "262:  $log=date('Y-m-d H:i:s', $_SERVER['REQUEST_TIME']).",
          "265:  if ($logpath == \"\") {",
          "266:   $logfile=\"ndslog/ndslog_log.php\";",
          "",
          "[Removed Lines]",
          "263:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $redir\\n\";",
          "",
          "[Added Lines]",
          "258:  $cpi_query=$GLOBALS[\"cpi_query\"];",
          "263:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $cpi_query, $redir\\n\";",
          "",
          "---------------"
        ],
        "forward_authentication_service/fas-hid/fas-hid.php||forward_authentication_service/fas-hid/fas-hid.php": [
          "File: forward_authentication_service/fas-hid/fas-hid.php -> forward_authentication_service/fas-hid/fas-hid.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:   if ($name == \"gatewaymac\") {$gatewaymac=$value;}",
          "81:   if ($name == \"authdir\") {$authdir=$value;}",
          "82:   if ($name == \"originurl\") {$originurl=$value;}",
          "83:   if ($name == \"clientif\") {$clientif=$value;}",
          "84:   if ($name == \"admin_email\") {$admin_email=$value;}",
          "85:   if ($name == \"location\") {$location=$value;}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:   if ($name == \"cpi_query\") {$cpi_query=$value;}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "213:  $clientif=$GLOBALS[\"clientif\"];",
          "214:  $originurl=$GLOBALS[\"originurl\"];",
          "215:  $redir=rawurldecode($originurl);",
          "216:  $fullname=$_GET[\"fullname\"];",
          "217:  $email=$_GET[\"email\"];",
          "220:  $log=date('Y-m-d H:i:s', $_SERVER['REQUEST_TIME']).",
          "223:  if ($logpath == \"\") {",
          "224:   $logfile=\"ndslog/ndslog_log.php\";",
          "",
          "[Removed Lines]",
          "221:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $redir\\n\";",
          "",
          "[Added Lines]",
          "217:  $cpi_query=$GLOBALS[\"cpi_query\"];",
          "222:   \", $script, $gatewayname, $fullname, $email, $clientip, $clientmac, $client_type, $clientif, $user_agent, $cpi_query, $redir\\n\";",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4dfa8037fc6a150442406e3d2e7e150ae98e0c67",
      "candidate_info": {
        "commit_hash": "4dfa8037fc6a150442406e3d2e7e150ae98e0c67",
        "repo": "openNDS/openNDS",
        "commit_url": "https://github.com/openNDS/openNDS/commit/4dfa8037fc6a150442406e3d2e7e150ae98e0c67",
        "files": [
          "forward_authentication_service/libs/libopennds.sh"
        ],
        "message": "Add - html entity handling for semicolon\n\nSigned-off-by: Rob White <rob@blue-wave.net>",
        "before_after_code_files": [
          "forward_authentication_service/libs/libopennds.sh||forward_authentication_service/libs/libopennds.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/openNDS/openNDS/pull/519"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "forward_authentication_service/libs/libopennds.sh||forward_authentication_service/libs/libopennds.sh": [
          "File: forward_authentication_service/libs/libopennds.sh -> forward_authentication_service/libs/libopennds.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "632: htmlentityencode() {",
          "633:  entitylist=\"",
          "634:   s/\\\"/\\&quot;/g",
          "635:   s/>/\\&gt;/g",
          "636:   s/</\\&lt;/g",
          "637:   s/%/\\&#37;/g",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "635:   s/;/\\&#59;/g",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "652: htmlentitydecode() {",
          "653:  entitylist=\"",
          "654:   s/\\&quot;/\\\"/g",
          "655:   s/\\&gt;/>/g",
          "656:   s/\\&lt;/</g",
          "657:   s/\\&#37;/%/g",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "656:   s/\\&#59;/;/g",
          "",
          "---------------"
        ]
      }
    }
  ]
}