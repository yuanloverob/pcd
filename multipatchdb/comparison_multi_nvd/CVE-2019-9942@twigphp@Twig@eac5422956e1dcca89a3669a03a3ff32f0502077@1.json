{
  "cve_id": "CVE-2019-9942",
  "cve_desc": "A sandbox information disclosure exists in Twig before 1.38.0 and 2.x before 2.7.0 because, under some circumstances, it is possible to call the __toString() method on an object even if not allowed by the security policy in place.",
  "repo": "twigphp/Twig",
  "patch_hash": "eac5422956e1dcca89a3669a03a3ff32f0502077",
  "patch_info": {
    "commit_hash": "eac5422956e1dcca89a3669a03a3ff32f0502077",
    "repo": "twigphp/Twig",
    "commit_url": "https://github.com/twigphp/Twig/commit/eac5422956e1dcca89a3669a03a3ff32f0502077",
    "files": [
      "CHANGELOG",
      "src/Node/CheckToStringNode.php",
      "src/Node/SandboxedPrintNode.php",
      "src/NodeVisitor/SandboxNodeVisitor.php",
      "test/Twig/Tests/Extension/SandboxTest.php",
      "test/Twig/Tests/Node/SandboxedPrintTest.php"
    ],
    "message": "fixed security issue in the sandbox",
    "before_after_code_files": [
      "src/Node/CheckToStringNode.php||src/Node/CheckToStringNode.php",
      "src/Node/SandboxedPrintNode.php||src/Node/SandboxedPrintNode.php",
      "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php",
      "test/Twig/Tests/Extension/SandboxTest.php||test/Twig/Tests/Extension/SandboxTest.php",
      "test/Twig/Tests/Node/SandboxedPrintTest.php||test/Twig/Tests/Node/SandboxedPrintTest.php"
    ]
  },
  "patch_diff": {
    "src/Node/CheckToStringNode.php||src/Node/CheckToStringNode.php": [
      "File: src/Node/CheckToStringNode.php -> src/Node/CheckToStringNode.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "12: namespace Twig\\Node;",
      "14: use Twig\\Compiler;",
      "15: use Twig\\Node\\Expression\\AbstractExpression;",
      "27: class CheckToStringNode extends Node",
      "28: {",
      "29:     public function __construct(AbstractExpression $expr)",
      "30:     {",
      "31:         parent::__construct(['expr' => $expr], [], $expr->getTemplateLine(), $expr->getNodeTag());",
      "32:     }",
      "34:     public function compile(Compiler $compiler)",
      "35:     {",
      "36:         $compiler",
      "37:             ->raw('$this->sandbox->ensureToStringAllowed(')",
      "38:             ->subcompile($this->getNode('expr'))",
      "39:             ->raw(')')",
      "40:         ;",
      "41:     }",
      "42: }",
      "",
      "---------------"
    ],
    "src/Node/SandboxedPrintNode.php||src/Node/SandboxedPrintNode.php": [
      "File: src/Node/SandboxedPrintNode.php -> src/Node/SandboxedPrintNode.php"
    ],
    "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php": [
      "File: src/NodeVisitor/SandboxNodeVisitor.php -> src/NodeVisitor/SandboxNodeVisitor.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "14: use Twig\\Environment;",
      "15: use Twig\\Node\\CheckSecurityNode;",
      "16: use Twig\\Node\\Expression\\Binary\\RangeBinary;",
      "17: use Twig\\Node\\Expression\\FilterExpression;",
      "18: use Twig\\Node\\Expression\\FunctionExpression;",
      "19: use Twig\\Node\\ModuleNode;",
      "20: use Twig\\Node\\Node;",
      "21: use Twig\\Node\\PrintNode;",
      "",
      "[Removed Lines]",
      "22: use Twig\\Node\\SandboxedPrintNode;",
      "",
      "[Added Lines]",
      "16: use Twig\\Node\\CheckToStringNode;",
      "17: use Twig\\Node\\Expression\\Binary\\ConcatBinary;",
      "21: use Twig\\Node\\Expression\\GetAttrExpression;",
      "22: use Twig\\Node\\Expression\\NameExpression;",
      "26: use Twig\\Node\\SetNode;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "33:     protected $filters;",
      "34:     protected $functions;",
      "36:     protected function doEnterNode(Node $node, Environment $env)",
      "37:     {",
      "38:         if ($node instanceof ModuleNode) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "40:     private $needsToStringWrap = false;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "63:                 $this->functions['range'] = $node;",
      "64:             }",
      "67:             if ($node instanceof PrintNode) {",
      "69:             }",
      "70:         }",
      "",
      "[Removed Lines]",
      "68:                 return new SandboxedPrintNode($node->getNode('expr'), $node->getTemplateLine(), $node->getNodeTag());",
      "",
      "[Added Lines]",
      "73:                 $this->needsToStringWrap = true;",
      "74:                 $this->wrapNode($node, 'expr');",
      "75:             }",
      "77:             if ($node instanceof SetNode && !$node->getAttribute('capture')) {",
      "78:                 $this->needsToStringWrap = true;",
      "79:             }",
      "82:             if ($this->needsToStringWrap) {",
      "83:                 if ($node instanceof ConcatBinary) {",
      "84:                     $this->wrapNode($node, 'left');",
      "85:                     $this->wrapNode($node, 'right');",
      "86:                 }",
      "87:                 if ($node instanceof FilterExpression) {",
      "88:                     $this->wrapNode($node, 'node');",
      "89:                     $this->wrapArrayNode($node, 'arguments');",
      "90:                 }",
      "91:                 if ($node instanceof FunctionExpression) {",
      "92:                     $this->wrapArrayNode($node, 'arguments');",
      "93:                 }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "78:             $this->inAModule = false;",
      "80:             $node->setNode('constructor_end', new Node([new CheckSecurityNode($this->filters, $this->tags, $this->functions), $node->getNode('display_start')]));",
      "81:         }",
      "83:         return $node;",
      "84:     }",
      "86:     public function getPriority()",
      "87:     {",
      "88:         return 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "106:         } elseif ($this->inAModule) {",
      "107:             if ($node instanceof PrintNode || $node instanceof SetNode) {",
      "108:                 $this->needsToStringWrap = false;",
      "109:             }",
      "115:     private function wrapNode(Node $node, $name)",
      "116:     {",
      "117:         $expr = $node->getNode($name);",
      "118:         if ($expr instanceof NameExpression || $expr instanceof GetAttrExpression) {",
      "119:             $node->setNode($name, new CheckToStringNode($expr));",
      "120:         }",
      "121:     }",
      "123:     private function wrapArrayNode(Node $node, $name)",
      "124:     {",
      "125:         $args = $node->getNode($name);",
      "126:         foreach ($args as $name => $_) {",
      "127:             $this->wrapNode($args, $name);",
      "128:         }",
      "129:     }",
      "",
      "---------------"
    ],
    "test/Twig/Tests/Extension/SandboxTest.php||test/Twig/Tests/Extension/SandboxTest.php": [
      "File: test/Twig/Tests/Extension/SandboxTest.php -> test/Twig/Tests/Extension/SandboxTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:             '1_basic3' => '{% if name %}foo{% endif %}',",
      "35:             '1_basic4' => '{{ obj.bar }}',",
      "36:             '1_basic5' => '{{ obj }}',",
      "38:             '1_basic7' => '{{ cycle([\"foo\",\"bar\"], 1) }}',",
      "39:             '1_basic8' => '{{ obj.getfoobar }}{{ obj.getFooBar }}',",
      "40:             '1_basic9' => '{{ obj.foobar }}{{ obj.fooBar }}',",
      "",
      "[Removed Lines]",
      "37:             '1_basic6' => '{{ arr.obj }}',",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "112:         }",
      "113:     }",
      "116:     {",
      "118:         try {",
      "120:             $this->fail('Sandbox throws a SecurityError exception if an unallowed method (__toString()) is called in the template');",
      "121:         } catch (SecurityError $e) {",
      "122:             $this->assertInstanceOf('\\Twig\\Sandbox\\SecurityNotAllowedMethodError', $e, 'Exception should be an instance of Twig_Sandbox_SecurityNotAllowedMethodError');",
      "",
      "[Removed Lines]",
      "115:     public function testSandboxUnallowedToString()",
      "117:         $twig = $this->getEnvironment(true, [], self::$templates);",
      "119:             $twig->load('1_basic5')->render(self::$params);",
      "",
      "[Added Lines]",
      "117:     public function testSandboxUnallowedToString($template)",
      "119:         $twig = $this->getEnvironment(true, [], ['index' => $template], [], ['upper'], ['FooObject' => 'getAnotherFooObject'], [], ['random']);",
      "121:             $twig->loadTemplate('index')->render(self::$params);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "125:         }",
      "126:     }",
      "129:     {",
      "139:     }",
      "141:     public function testSandboxUnallowedFunction()",
      "",
      "[Removed Lines]",
      "128:     public function testSandboxUnallowedToStringArray()",
      "130:         $twig = $this->getEnvironment(true, [], self::$templates);",
      "131:         try {",
      "132:             $twig->load('1_basic6')->render(self::$params);",
      "133:             $this->fail('Sandbox throws a SecurityError exception if an unallowed method (__toString()) is called in the template');",
      "134:         } catch (SecurityError $e) {",
      "135:             $this->assertInstanceOf('\\Twig\\Sandbox\\SecurityNotAllowedMethodError', $e, 'Exception should be an instance of Twig_Sandbox_SecurityNotAllowedMethodError');",
      "136:             $this->assertEquals('FooObject', $e->getClassName(), 'Exception should be raised on the \"FooObject\" class');",
      "137:             $this->assertEquals('__tostring', $e->getMethodName(), 'Exception should be raised on the \"__toString\" method');",
      "138:         }",
      "",
      "[Added Lines]",
      "130:     public function getSandboxUnallowedToStringTests()",
      "132:         return [",
      "133:             'simple' => ['{{ obj }}'],",
      "134:             'object_from_array' => ['{{ arr.obj }}'],",
      "135:             'object_chain' => ['{{ obj.anotherFooObject }}'],",
      "136:             'filter' => ['{{ obj|upper }}'],",
      "137:             'filter_from_array' => ['{{ arr.obj|upper }}'],",
      "138:             'function' => ['{{ random(obj) }}'],",
      "139:             'function_from_array' => ['{{ random(arr.obj) }}'],",
      "140:             'function_and_filter' => ['{{ random(obj|upper) }}'],",
      "141:             'function_and_filter_from_array' => ['{{ random(arr.obj|upper) }}'],",
      "142:             'object_chain_and_filter' => ['{{ obj.anotherFooObject|upper }}'],",
      "143:             'object_chain_and_function' => ['{{ random(obj.anotherFooObject) }}'],",
      "144:             'concat' => ['{{ obj ~ \"\" }}'],",
      "145:             'concat_again' => ['{{ \"\" ~ obj }}'],",
      "146:         ];",
      "147:     }",
      "152:     public function testSandboxAllowedToString($template, $output)",
      "153:     {",
      "154:         $twig = $this->getEnvironment(true, [], ['index' => $template], ['set'], [], ['FooObject' => ['foo', 'getAnotherFooObject']]);",
      "155:         $this->assertEquals($output, $twig->load('index')->render(self::$params));",
      "156:     }",
      "158:     public function getSandboxAllowedToStringTests()",
      "159:     {",
      "160:         return [",
      "161:             'constant_test' => ['{{ obj is constant(\"PHP_INT_MAX\") }}', ''],",
      "162:             'set_object' => ['{% set a = obj.anotherFooObject %}{{ a.foo }}', 'foo'],",
      "163:             'is_defined' => ['{{ obj.anotherFooObject is defined }}', '1'],",
      "164:             'is_null' => ['{{ obj is null }}', ''],",
      "165:             'is_sameas' => ['{{ obj is same as(obj) }}', '1'],",
      "166:             'is_sameas_from_array' => ['{{ arr.obj is same as(arr.obj) }}', '1'],",
      "167:             'is_sameas_from_another_method' => ['{{ obj.anotherFooObject is same as(obj.anotherFooObject) }}', ''],",
      "168:         ];",
      "169:     }",
      "171:     public function testSandboxAllowMethodToString()",
      "172:     {",
      "173:         $twig = $this->getEnvironment(true, [], self::$templates, [], [], ['FooObject' => '__toString']);",
      "174:         FooObject::reset();",
      "175:         $this->assertEquals('foo', $twig->load('1_basic5')->render(self::$params), 'Sandbox allow some methods');",
      "176:         $this->assertEquals(1, FooObject::$called['__toString'], 'Sandbox only calls method once');",
      "177:     }",
      "179:     public function testSandboxAllowMethodToStringDisabled()",
      "180:     {",
      "181:         $twig = $this->getEnvironment(false, [], self::$templates);",
      "182:         FooObject::reset();",
      "183:         $this->assertEquals('foo', $twig->load('1_basic5')->render(self::$params), 'Sandbox allows __toString when sandbox disabled');",
      "184:         $this->assertEquals(1, FooObject::$called['__toString'], 'Sandbox only calls method once');",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "170:         $this->assertEquals(1, FooObject::$called['foo'], 'Sandbox only calls method once');",
      "171:     }",
      "189:     public function testSandboxAllowFilter()",
      "190:     {",
      "191:         $twig = $this->getEnvironment(true, [], self::$templates, [], ['upper']);",
      "",
      "[Removed Lines]",
      "173:     public function testSandboxAllowMethodToString()",
      "174:     {",
      "175:         $twig = $this->getEnvironment(true, [], self::$templates, [], [], ['FooObject' => '__toString']);",
      "176:         FooObject::reset();",
      "177:         $this->assertEquals('foo', $twig->load('1_basic5')->render(self::$params), 'Sandbox allow some methods');",
      "178:         $this->assertEquals(1, FooObject::$called['__toString'], 'Sandbox only calls method once');",
      "179:     }",
      "181:     public function testSandboxAllowMethodToStringDisabled()",
      "182:     {",
      "183:         $twig = $this->getEnvironment(false, [], self::$templates);",
      "184:         FooObject::reset();",
      "185:         $this->assertEquals('foo', $twig->load('1_basic5')->render(self::$params), 'Sandbox allows __toString when sandbox disabled');",
      "186:         $this->assertEquals(1, FooObject::$called['__toString'], 'Sandbox only calls method once');",
      "187:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "327:         return 'foobar';",
      "328:     }",
      "329: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "360:     public function getAnotherFooObject()",
      "361:     {",
      "362:         return new self();",
      "363:     }",
      "",
      "---------------"
    ],
    "test/Twig/Tests/Node/SandboxedPrintTest.php||test/Twig/Tests/Node/SandboxedPrintTest.php": [
      "File: test/Twig/Tests/Node/SandboxedPrintTest.php -> test/Twig/Tests/Node/SandboxedPrintTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "241f95cb25e537fdc7f27088c7efff685c2c5f82",
      "candidate_info": {
        "commit_hash": "241f95cb25e537fdc7f27088c7efff685c2c5f82",
        "repo": "twigphp/Twig",
        "commit_url": "https://github.com/twigphp/Twig/commit/241f95cb25e537fdc7f27088c7efff685c2c5f82",
        "files": [
          "src/ExpressionParser.php",
          "src/Node/Expression/BlockReferenceExpression.php",
          "src/Node/Expression/CallExpression.php",
          "src/NodeTraverser.php",
          "src/NodeVisitor/EscaperNodeVisitor.php",
          "src/NodeVisitor/OptimizerNodeVisitor.php",
          "src/NodeVisitor/SafeAnalysisNodeVisitor.php",
          "src/NodeVisitor/SandboxNodeVisitor.php",
          "src/Parser.php",
          "src/Profiler/Dumper/BaseDumper.php",
          "src/Profiler/Dumper/BlackfireDumper.php",
          "src/Profiler/NodeVisitor/ProfilerNodeVisitor.php"
        ],
        "message": "added some type hints on private methods",
        "before_after_code_files": [
          "src/ExpressionParser.php||src/ExpressionParser.php",
          "src/Node/Expression/BlockReferenceExpression.php||src/Node/Expression/BlockReferenceExpression.php",
          "src/Node/Expression/CallExpression.php||src/Node/Expression/CallExpression.php",
          "src/NodeTraverser.php||src/NodeTraverser.php",
          "src/NodeVisitor/EscaperNodeVisitor.php||src/NodeVisitor/EscaperNodeVisitor.php",
          "src/NodeVisitor/OptimizerNodeVisitor.php||src/NodeVisitor/OptimizerNodeVisitor.php",
          "src/NodeVisitor/SafeAnalysisNodeVisitor.php||src/NodeVisitor/SafeAnalysisNodeVisitor.php",
          "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php",
          "src/Parser.php||src/Parser.php",
          "src/Profiler/Dumper/BaseDumper.php||src/Profiler/Dumper/BaseDumper.php",
          "src/Profiler/Dumper/BlackfireDumper.php||src/Profiler/Dumper/BlackfireDumper.php",
          "src/Profiler/NodeVisitor/ProfilerNodeVisitor.php||src/Profiler/NodeVisitor/ProfilerNodeVisitor.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php"
          ],
          "candidate": [
            "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php"
          ]
        }
      },
      "candidate_diff": {
        "src/ExpressionParser.php||src/ExpressionParser.php": [
          "File: src/ExpressionParser.php -> src/ExpressionParser.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: use Twig\\Node\\Expression\\Unary\\NotUnary;",
          "28: use Twig\\Node\\Expression\\Unary\\PosUnary;",
          "29: use Twig\\Node\\Node;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "30: use Twig\\Node\\Expression\\AbstractExpression;",
          "31: use Twig\\Node\\Expression\\TestExpression;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "88:         return $expr;",
          "89:     }",
          "92:     {",
          "93:         $token = $this->parser->getCurrentToken();",
          "",
          "[Removed Lines]",
          "91:     private function getPrimary()",
          "",
          "[Added Lines]",
          "93:     private function getPrimary(): AbstractExpression",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "110:         return $this->parsePrimaryExpression();",
          "111:     }",
          "114:     {",
          "115:         while ($this->parser->getStream()->nextIf(/* Token::PUNCTUATION_TYPE */ 9, '?')) {",
          "116:             if (!$this->parser->getStream()->nextIf(/* Token::PUNCTUATION_TYPE */ 9, ':')) {",
          "",
          "[Removed Lines]",
          "113:     private function parseConditionalExpression($expr)",
          "",
          "[Added Lines]",
          "115:     private function parseConditionalExpression($expr): AbstractExpression",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "131:         return $expr;",
          "132:     }",
          "135:     {",
          "136:         return $token->test(/* Token::OPERATOR_TYPE */ 8) && isset($this->unaryOperators[$token->getValue()]);",
          "137:     }",
          "140:     {",
          "141:         return $token->test(/* Token::OPERATOR_TYPE */ 8) && isset($this->binaryOperators[$token->getValue()]);",
          "142:     }",
          "",
          "[Removed Lines]",
          "134:     private function isUnary(Token $token)",
          "139:     private function isBinary(Token $token)",
          "",
          "[Added Lines]",
          "136:     private function isUnary(Token $token): bool",
          "141:     private function isBinary(Token $token): bool",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "598:         return new Node($targets);",
          "599:     }",
          "602:     {",
          "603:         return new NotUnary($this->parseTestExpression($node), $this->parser->getCurrentToken()->getLine());",
          "604:     }",
          "607:     {",
          "608:         $stream = $this->parser->getStream();",
          "609:         list($name, $test) = $this->getTest($node->getTemplateLine());",
          "",
          "[Removed Lines]",
          "601:     private function parseNotTestExpression(Node $node)",
          "606:     private function parseTestExpression(Node $node)",
          "",
          "[Added Lines]",
          "603:     private function parseNotTestExpression(Node $node): NotUnary",
          "608:     private function parseTestExpression(Node $node): TestExpression",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "617:         return new $class($node, $name, $arguments, $this->parser->getCurrentToken()->getLine());",
          "618:     }",
          "621:     {",
          "622:         $stream = $this->parser->getStream();",
          "623:         $name = $stream->expect(/* Token::NAME_TYPE */ 5)->getValue();",
          "",
          "[Removed Lines]",
          "620:     private function getTest($line)",
          "",
          "[Added Lines]",
          "622:     private function getTest(int $line): array",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "643:         throw $e;",
          "644:     }",
          "647:     {",
          "648:         if ($test->isDeprecated()) {",
          "649:             $stream = $this->parser->getStream();",
          "",
          "[Removed Lines]",
          "646:     private function getTestNodeClass($test)",
          "",
          "[Added Lines]",
          "648:     private function getTestNodeClass(TwigTest $test): string",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "664:         return $test->getNodeClass();",
          "665:     }",
          "668:     {",
          "669:         if (false === $function = $this->env->getFunction($name)) {",
          "670:             $e = new SyntaxError(sprintf('Unknown \"%s\" function.', $name), $line, $this->parser->getStream()->getSourceContext());",
          "",
          "[Removed Lines]",
          "667:     private function getFunctionNodeClass($name, $line)",
          "",
          "[Added Lines]",
          "669:     private function getFunctionNodeClass(string $name, int $line): string",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "690:         return $function->getNodeClass();",
          "691:     }",
          "694:     {",
          "695:         if (false === $filter = $this->env->getFilter($name)) {",
          "696:             $e = new SyntaxError(sprintf('Unknown \"%s\" filter.', $name), $line, $this->parser->getStream()->getSourceContext());",
          "",
          "[Removed Lines]",
          "693:     private function getFilterNodeClass($name, $line)",
          "",
          "[Added Lines]",
          "695:     private function getFilterNodeClass(string $name, int $line): string",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "717:     }",
          "721:     {",
          "722:         if (!($node instanceof ConstantExpression || $node instanceof ArrayExpression",
          "723:             || $node instanceof NegUnary || $node instanceof PosUnary",
          "",
          "[Removed Lines]",
          "720:     private function checkConstantExpression(Node $node)",
          "",
          "[Added Lines]",
          "722:     private function checkConstantExpression(Node $node): bool",
          "",
          "---------------"
        ],
        "src/Node/Expression/BlockReferenceExpression.php||src/Node/Expression/BlockReferenceExpression.php": [
          "File: src/Node/Expression/BlockReferenceExpression.php -> src/Node/Expression/BlockReferenceExpression.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:         }",
          "50:     }",
          "53:     {",
          "54:         if (!$this->hasNode('template')) {",
          "55:             $compiler->write('$this');",
          "",
          "[Removed Lines]",
          "52:     private function compileTemplateCall(Compiler $compiler, $method)",
          "",
          "[Added Lines]",
          "52:     private function compileTemplateCall(Compiler $compiler, string $method): Compiler",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "66:         }",
          "68:         $compiler->raw(sprintf('->%s', $method));",
          "72:     }",
          "75:     {",
          "76:         $compiler",
          "77:             ->raw('(')",
          "",
          "[Removed Lines]",
          "69:         $this->compileBlockArguments($compiler);",
          "71:         return $compiler;",
          "74:     private function compileBlockArguments(Compiler $compiler)",
          "",
          "[Added Lines]",
          "70:         return $this->compileBlockArguments($compiler);",
          "73:     private function compileBlockArguments(Compiler $compiler): Compiler",
          "",
          "---------------"
        ],
        "src/Node/Expression/CallExpression.php||src/Node/Expression/CallExpression.php": [
          "File: src/Node/Expression/CallExpression.php -> src/Node/Expression/CallExpression.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "230:         return strtolower(preg_replace(['/([A-Z]+)([A-Z][a-z])/', '/([a-z\\d])([A-Z])/'], ['\\\\1_\\\\2', '\\\\1_\\\\2'], $name));",
          "231:     }",
          "234:     {",
          "235:         list($r) = $this->reflectCallable($callable);",
          "236:         if (null === $r) {",
          "",
          "[Removed Lines]",
          "233:     private function getCallableParameters($callable, $isVariadic)",
          "",
          "[Added Lines]",
          "233:     private function getCallableParameters($callable, bool $isVariadic): array",
          "",
          "---------------"
        ],
        "src/NodeTraverser.php||src/NodeTraverser.php": [
          "File: src/NodeTraverser.php -> src/NodeTraverser.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:         return $node;",
          "60:     }",
          "63:     {",
          "64:         $node = $visitor->enterNode($node, $this->env);",
          "",
          "[Removed Lines]",
          "62:     private function traverseForVisitor(NodeVisitorInterface $visitor, Node $node)",
          "",
          "[Added Lines]",
          "62:     private function traverseForVisitor(NodeVisitorInterface $visitor, Node $node): Node",
          "",
          "---------------"
        ],
        "src/NodeVisitor/EscaperNodeVisitor.php||src/NodeVisitor/EscaperNodeVisitor.php": [
          "File: src/NodeVisitor/EscaperNodeVisitor.php -> src/NodeVisitor/EscaperNodeVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "147:         return $this->defaultStrategy ? $this->defaultStrategy : false;",
          "148:     }",
          "151:     {",
          "152:         $line = $node->getTemplateLine();",
          "153:         $name = new ConstantExpression('escape', $line);",
          "",
          "[Removed Lines]",
          "150:     private function getEscaperFilter($type, Node $node)",
          "",
          "[Added Lines]",
          "150:     private function getEscaperFilter(string $type, Node $node): FilterExpression",
          "",
          "---------------"
        ],
        "src/NodeVisitor/OptimizerNodeVisitor.php||src/NodeVisitor/OptimizerNodeVisitor.php": [
          "File: src/NodeVisitor/OptimizerNodeVisitor.php -> src/NodeVisitor/OptimizerNodeVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "97:     {",
          "98:         if (!$node instanceof PrintNode) {",
          "99:             return $node;",
          "",
          "[Removed Lines]",
          "96:     private function optimizePrintNode(Node $node, Environment $env)",
          "",
          "[Added Lines]",
          "94:     private function optimizePrintNode(Node $node, Environment $env): Node",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "121:     {",
          "122:         if ($node instanceof FilterExpression && 'raw' == $node->getNode('filter')->getAttribute('value')) {",
          "123:             return $node->getNode('node');",
          "",
          "[Removed Lines]",
          "120:     private function optimizeRawFilter(Node $node, Environment $env)",
          "",
          "[Added Lines]",
          "116:     private function optimizeRawFilter(Node $node, Environment $env): Node",
          "",
          "---------------"
        ],
        "src/NodeVisitor/SafeAnalysisNodeVisitor.php||src/NodeVisitor/SafeAnalysisNodeVisitor.php": [
          "File: src/NodeVisitor/SafeAnalysisNodeVisitor.php -> src/NodeVisitor/SafeAnalysisNodeVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "134:         return $node;",
          "135:     }",
          "138:     {",
          "139:         if (null === $a || null === $b) {",
          "140:             return [];",
          "",
          "[Removed Lines]",
          "137:     private function intersectSafe(array $a = null, array $b = null)",
          "",
          "[Added Lines]",
          "137:     private function intersectSafe(array $a = null, array $b = null): array",
          "",
          "---------------"
        ],
        "src/NodeVisitor/SandboxNodeVisitor.php||src/NodeVisitor/SandboxNodeVisitor.php": [
          "File: src/NodeVisitor/SandboxNodeVisitor.php -> src/NodeVisitor/SandboxNodeVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "110:         return $node;",
          "111:     }",
          "114:     {",
          "115:         $expr = $node->getNode($name);",
          "116:         if ($expr instanceof NameExpression || $expr instanceof GetAttrExpression) {",
          "",
          "[Removed Lines]",
          "113:     private function wrapNode(Node $node, $name)",
          "",
          "[Added Lines]",
          "113:     private function wrapNode(Node $node, string $name)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "118:         }",
          "119:     }",
          "122:     {",
          "123:         $args = $node->getNode($name);",
          "124:         foreach ($args as $name => $_) {",
          "",
          "[Removed Lines]",
          "121:     private function wrapArrayNode(Node $node, $name)",
          "",
          "[Added Lines]",
          "121:     private function wrapArrayNode(Node $node, string $name)",
          "",
          "---------------"
        ],
        "src/Parser.php||src/Parser.php": [
          "File: src/Parser.php -> src/Parser.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "335:         return $this->stream->getCurrent();",
          "336:     }",
          "339:     {",
          "341:         if (",
          "",
          "[Removed Lines]",
          "338:     private function filterBodyNodes(Node $node, $nested = false)",
          "",
          "[Added Lines]",
          "338:     private function filterBodyNodes(Node $node, bool $nested = false)",
          "",
          "---------------"
        ],
        "src/Profiler/Dumper/BaseDumper.php||src/Profiler/Dumper/BaseDumper.php": [
          "File: src/Profiler/Dumper/BaseDumper.php -> src/Profiler/Dumper/BaseDumper.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:     abstract protected function formatTime(Profile $profile, $percent);",
          "35:     {",
          "36:         if ($profile->isRoot()) {",
          "37:             $this->root = $profile->getDuration();",
          "",
          "[Removed Lines]",
          "34:     private function dumpProfile(Profile $profile, $prefix = '', $sibling = false)",
          "",
          "[Added Lines]",
          "34:     private function dumpProfile(Profile $profile, $prefix = '', $sibling = false): string",
          "",
          "---------------"
        ],
        "src/Profiler/Dumper/BlackfireDumper.php||src/Profiler/Dumper/BlackfireDumper.php": [
          "File: src/Profiler/Dumper/BlackfireDumper.php -> src/Profiler/Dumper/BlackfireDumper.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "40:         return $str;",
          "41:     }",
          "44:     {",
          "45:         foreach ($profile as $p) {",
          "46:             if ($p->isTemplate()) {",
          "",
          "[Removed Lines]",
          "43:     private function dumpChildren($parent, Profile $profile, &$data)",
          "",
          "[Added Lines]",
          "43:     private function dumpChildren(string $parent, Profile $profile, &$data)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "53:         }",
          "54:     }",
          "57:     {",
          "58:         if (isset($data[$edge])) {",
          "59:             ++$data[$edge]['ct'];",
          "",
          "[Removed Lines]",
          "56:     private function dumpProfile($edge, Profile $profile, &$data)",
          "",
          "[Added Lines]",
          "56:     private function dumpProfile(string $edge, Profile $profile, &$data)",
          "",
          "---------------"
        ],
        "src/Profiler/NodeVisitor/ProfilerNodeVisitor.php||src/Profiler/NodeVisitor/ProfilerNodeVisitor.php": [
          "File: src/Profiler/NodeVisitor/ProfilerNodeVisitor.php -> src/Profiler/NodeVisitor/ProfilerNodeVisitor.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:         return $node;",
          "65:     }",
          "68:     {",
          "69:         return sprintf('__internal_%s', hash('sha256', $this->extensionName));",
          "70:     }",
          "",
          "[Removed Lines]",
          "67:     private function getVarName()",
          "",
          "[Added Lines]",
          "67:     private function getVarName(): string",
          "",
          "---------------"
        ]
      }
    }
  ]
}