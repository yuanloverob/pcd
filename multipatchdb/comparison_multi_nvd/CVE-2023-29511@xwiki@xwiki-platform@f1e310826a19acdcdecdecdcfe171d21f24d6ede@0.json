{
  "cve_id": "CVE-2023-29511",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. Any user with edit rights on a page (e.g., it's own user page), can execute arbitrary Groovy, Python or Velocity code in XWiki leading to full access to the XWiki installation. The root cause is improper escaping of the section ids in `XWiki.AdminFieldsDisplaySheet`. This page is installed by default. The vulnerability has been patched in XWiki versions 15.0-rc-1, 14.10.1, 14.4.8, and 13.10.11.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "f1e310826a19acdcdecdecdcfe171d21f24d6ede",
  "patch_info": {
    "commit_hash": "f1e310826a19acdcdecdecdcfe171d21f24d6ede",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/f1e310826a19acdcdecdecdcfe171d21f24d6ede",
    "files": [
      "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/pom.xml",
      "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/main/resources/XWiki/AdminFieldsDisplaySheet.xml",
      "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
    ],
    "message": "XWIKI-20261: Improved escaping of AdminFieldsDisplaySheet",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java": [
      "File: xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java -> xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.administration;",
      "22: import java.util.Map;",
      "24: import javax.script.ScriptContext;",
      "26: import org.jsoup.nodes.Document;",
      "27: import org.jsoup.nodes.Element;",
      "28: import org.junit.jupiter.api.BeforeEach;",
      "29: import org.junit.jupiter.api.Test;",
      "30: import org.xwiki.model.reference.DocumentReference;",
      "31: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
      "32: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
      "33: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
      "34: import org.xwiki.script.ScriptContextManager;",
      "35: import org.xwiki.test.annotation.ComponentList;",
      "36: import org.xwiki.test.page.HTML50ComponentList;",
      "37: import org.xwiki.test.page.PageTest;",
      "38: import org.xwiki.test.page.TestNoScriptMacro;",
      "39: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
      "41: import static java.util.Collections.emptyList;",
      "42: import static java.util.Collections.singletonMap;",
      "43: import static javax.script.ScriptContext.ENGINE_SCOPE;",
      "44: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "55: @HTML50ComponentList",
      "56: @XWikiSyntax21ComponentList",
      "57: @RenderingScriptServiceComponentList",
      "58: @ComponentList({",
      "59:     TestNoScriptMacro.class,",
      "60:     DefaultExtendedRenderingConfiguration.class,",
      "61:     RenderingConfigClassDocumentConfigurationSource.class",
      "62: })",
      "63: class AdminFieldsDisplaySheetPageTest extends PageTest",
      "64: {",
      "65:     private ScriptContext scriptContext;",
      "67:     @BeforeEach",
      "68:     void setUp() throws Exception",
      "69:     {",
      "70:         this.scriptContext =",
      "71:             this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class).getScriptContext();",
      "72:     }",
      "74:     @Test",
      "75:     void escaping() throws Exception",
      "76:     {",
      "77:         String paramsInput = \"\\\"/><script>console.log('params');</script>{{/html}}{{noscript/}}\";",
      "78:         String sectionInput = \"\\\"/><strong>console.log('section');</script>{{/html}}{{noscript/}}\";",
      "79:         String paramClassInput = \"\\\"/><script>console.log('paramClass');</script>{{/html}}{{noscript/}}\";",
      "80:         Map<Object, Object> params = singletonMap(paramsInput, emptyList());",
      "81:         DocumentReference otherDocumentReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");",
      "82:         com.xpn.xwiki.api.Document otherDocument =",
      "83:             new com.xpn.xwiki.api.Document(this.xwiki.getDocument(otherDocumentReference, this.context), this.context);",
      "85:         this.scriptContext.setAttribute(\"section\", sectionInput, ENGINE_SCOPE);",
      "86:         this.scriptContext.setAttribute(\"paramDoc\", otherDocument, ENGINE_SCOPE);",
      "87:         this.scriptContext.setAttribute(\"params\", params, ENGINE_SCOPE);",
      "88:         this.scriptContext.setAttribute(\"paramClass\", paramClassInput, ENGINE_SCOPE);",
      "90:         Document document = renderHTMLPage(new DocumentReference(\"xwiki\", \"XWiki\", \"AdminFieldsDisplaySheet\"));",
      "92:         Element form = document.selectFirst(\"form\");",
      "93:         assertEquals(String.format(\"%s_%s\", sectionInput, paramClassInput), form.attr(\"id\"));",
      "94:         assertEquals(\"/xwiki/bin/saveandcontinue/Space/Page\", form.attr(\"action\"));",
      "95:         Element fieldset = form.selectFirst(\"fieldset\");",
      "96:         assertEquals(paramsInput, fieldset.attr(\"class\"));",
      "97:         assertEquals(paramClassInput, document.selectFirst(\".hidden input[name='classname']\").val());",
      "98:     }",
      "99: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "03b5d7d6b5625e751e70177845e6594fc00ec77d",
      "candidate_info": {
        "commit_hash": "03b5d7d6b5625e751e70177845e6594fc00ec77d",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/03b5d7d6b5625e751e70177845e6594fc00ec77d",
        "files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/main/resources/XWiki/AdminFieldsDisplaySheet.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ],
        "message": "XWIKI-20261: Improved escaping of AdminFieldsDisplaySheet",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java -> xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.administration;",
          "22: import java.util.Map;",
          "24: import javax.script.ScriptContext;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.Collections;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "27: import org.jsoup.nodes.Element;",
          "28: import org.junit.jupiter.api.BeforeEach;",
          "29: import org.junit.jupiter.api.Test;",
          "30: import org.xwiki.model.reference.DocumentReference;",
          "31: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
          "32: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
          "33: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: import org.mockito.Mock;",
          "32: import org.xwiki.component.util.DefaultParameterizedType;",
          "33: import org.xwiki.configuration.internal.RestrictedConfigurationSource;",
          "35: import org.xwiki.model.script.ModelScriptService;",
          "36: import org.xwiki.query.Query;",
          "37: import org.xwiki.query.QueryBuilder;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "38: import org.xwiki.test.page.TestNoScriptMacro;",
          "39: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
          "41: import static java.util.Collections.emptyList;",
          "42: import static java.util.Collections.singletonMap;",
          "43: import static javax.script.ScriptContext.ENGINE_SCOPE;",
          "44: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "48: import com.xpn.xwiki.doc.XWikiDocument;",
          "49: import com.xpn.xwiki.internal.mandatory.XWikiPreferencesDocumentInitializer;",
          "50: import com.xpn.xwiki.objects.BaseObject;",
          "51: import com.xpn.xwiki.objects.classes.DBListClass;",
          "54: import static java.util.Collections.singletonList;",
          "58: import static org.mockito.ArgumentMatchers.any;",
          "59: import static org.mockito.Mockito.when;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "58: @ComponentList({",
          "59:     TestNoScriptMacro.class,",
          "60:     DefaultExtendedRenderingConfiguration.class,",
          "62: })",
          "63: class AdminFieldsDisplaySheetPageTest extends PageTest",
          "64: {",
          "65:     private ScriptContext scriptContext;",
          "67:     @BeforeEach",
          "68:     void setUp() throws Exception",
          "69:     {",
          "70:         this.scriptContext =",
          "71:             this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class).getScriptContext();",
          "72:     }",
          "74:     @Test",
          "",
          "[Removed Lines]",
          "61:     RenderingConfigClassDocumentConfigurationSource.class",
          "",
          "[Added Lines]",
          "76:     RenderingConfigClassDocumentConfigurationSource.class,",
          "77:     XWikiPreferencesDocumentInitializer.class,",
          "78:     ModelScriptService.class,",
          "79:     RestrictedConfigurationSource.class",
          "85:     @Mock",
          "86:     private Query query;",
          "94:         QueryBuilder<DBListClass> queryBuilder = this.componentManager.registerMockComponent(",
          "95:             new DefaultParameterizedType(null, QueryBuilder.class, DBListClass.class));",
          "96:         when(queryBuilder.build(any())).thenReturn(this.query);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "96:         assertEquals(paramsInput, fieldset.attr(\"class\"));",
          "97:         assertEquals(paramClassInput, document.selectFirst(\".hidden input[name='classname']\").val());",
          "98:     }",
          "99: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "125:     @Test",
          "126:     void displayLinkInColorThemeHint() throws Exception",
          "127:     {",
          "128:         DocumentReference flamingoThemeDocumentReference = new DocumentReference(\"xwiki\", \"FlamingoThemes\", \"WebHome\");",
          "129:         DocumentReference xwikiPreferencesDocumentReference =",
          "130:             new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiPreferences\");",
          "131:         DocumentReference otherDocumentReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");",
          "134:         this.xwiki.initializeMandatoryDocuments(this.context);",
          "137:         this.xwiki.saveDocument(this.xwiki.getDocument(flamingoThemeDocumentReference, this.context), this.context);",
          "140:         XWikiDocument otherDoc = this.xwiki.getDocument(otherDocumentReference, this.context);",
          "141:         BaseObject xObject =",
          "142:             otherDoc.newXObject(xwikiPreferencesDocumentReference, this.context);",
          "143:         xObject.set(\"colorTheme\", \"themeName\", this.context);",
          "144:         this.xwiki.saveDocument(otherDoc, this.context);",
          "147:         this.scriptContext.setAttribute(\"section\", \"test-section\", ENGINE_SCOPE);",
          "148:         this.scriptContext.setAttribute(\"paramDoc\", new com.xpn.xwiki.api.Document(otherDoc, this.context),",
          "149:             ENGINE_SCOPE);",
          "150:         this.scriptContext.setAttribute(\"params\",",
          "151:             Collections.<Object, Object>singletonMap(\"param-input\", singletonList(\"colorTheme\")), ENGINE_SCOPE);",
          "153:         Document document = renderHTMLPage(new DocumentReference(\"xwiki\", \"XWiki\", \"AdminFieldsDisplaySheet\"));",
          "155:         Element xHint = document.selectFirst(\".xHint\");",
          "156:         assertEquals(\"admin.colortheme.manage\", xHint.text());",
          "157:         assertEquals(\"/xwiki/bin/view/FlamingoThemes/\", xHint.selectFirst(\"a\").attr(\"href\"));",
          "158:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "04aa06d830c1098a9d8c80c2f6f49418d8764f7f",
      "candidate_info": {
        "commit_hash": "04aa06d830c1098a9d8c80c2f6f49418d8764f7f",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/04aa06d830c1098a9d8c80c2f6f49418d8764f7f",
        "files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/pom.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/main/resources/XWiki/AdminFieldsDisplaySheet.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ],
        "message": "XWIKI-20261: Improved escaping of AdminFieldsDisplaySheet",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java -> xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.administration;",
          "22: import java.util.Map;",
          "24: import javax.script.ScriptContext;",
          "26: import org.jsoup.nodes.Document;",
          "27: import org.jsoup.nodes.Element;",
          "28: import org.junit.jupiter.api.BeforeEach;",
          "29: import org.junit.jupiter.api.Test;",
          "30: import org.xwiki.model.reference.DocumentReference;",
          "31: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
          "32: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
          "33: import org.xwiki.rendering.internal.macro.DefaultMacroCategoryManager;",
          "34: import org.xwiki.rendering.internal.syntax.SyntaxConverter;",
          "35: import org.xwiki.rendering.internal.transformation.macro.DefaultMacroTransformationConfiguration;",
          "36: import org.xwiki.rendering.script.RenderingScriptService;",
          "37: import org.xwiki.script.ScriptContextManager;",
          "38: import org.xwiki.test.annotation.ComponentList;",
          "39: import org.xwiki.test.page.HTML50ComponentList;",
          "40: import org.xwiki.test.page.PageTest;",
          "41: import org.xwiki.test.page.TestNoScriptMacro;",
          "42: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
          "43: import org.xwiki.xml.internal.html.filter.ControlCharactersFilter;",
          "45: import static java.util.Collections.emptyList;",
          "46: import static java.util.Collections.singletonMap;",
          "47: import static javax.script.ScriptContext.ENGINE_SCOPE;",
          "48: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "59: @HTML50ComponentList",
          "60: @XWikiSyntax21ComponentList",
          "61: @ComponentList({",
          "62:     TestNoScriptMacro.class,",
          "63:     DefaultExtendedRenderingConfiguration.class,",
          "64:     RenderingConfigClassDocumentConfigurationSource.class,",
          "66:     RenderingScriptService.class,",
          "67:     DefaultExtendedRenderingConfiguration.class,",
          "68:     RenderingConfigClassDocumentConfigurationSource.class,",
          "69:     SyntaxConverter.class,",
          "70:     DefaultMacroCategoryManager.class,",
          "71:     DefaultMacroTransformationConfiguration.class,",
          "73:     ControlCharactersFilter.class",
          "74: })",
          "75: class AdminFieldsDisplaySheetPageTest extends PageTest",
          "76: {",
          "77:     private ScriptContext scriptContext;",
          "79:     @BeforeEach",
          "80:     void setUp() throws Exception",
          "81:     {",
          "82:         this.scriptContext =",
          "83:             this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class).getScriptContext();",
          "84:     }",
          "86:     @Test",
          "87:     void escaping() throws Exception",
          "88:     {",
          "89:         String paramsInput = \"\\\"/><script>console.log('params');</script>{{/html}}{{noscript/}}\";",
          "90:         String sectionInput = \"\\\"/><strong>console.log('section');</script>{{/html}}{{noscript/}}\";",
          "91:         String paramClassInput = \"\\\"/><script>console.log('paramClass');</script>{{/html}}{{noscript/}}\";",
          "92:         Map<Object, Object> params = singletonMap(paramsInput, emptyList());",
          "93:         DocumentReference otherDocumentReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");",
          "94:         com.xpn.xwiki.api.Document otherDocument =",
          "95:             new com.xpn.xwiki.api.Document(this.xwiki.getDocument(otherDocumentReference, this.context), this.context);",
          "97:         this.scriptContext.setAttribute(\"section\", sectionInput, ENGINE_SCOPE);",
          "98:         this.scriptContext.setAttribute(\"paramDoc\", otherDocument, ENGINE_SCOPE);",
          "99:         this.scriptContext.setAttribute(\"params\", params, ENGINE_SCOPE);",
          "100:         this.scriptContext.setAttribute(\"paramClass\", paramClassInput, ENGINE_SCOPE);",
          "102:         Document document = renderHTMLPage(new DocumentReference(\"xwiki\", \"XWiki\", \"AdminFieldsDisplaySheet\"));",
          "104:         Element form = document.selectFirst(\"form\");",
          "105:         assertEquals(String.format(\"%s_%s\", sectionInput, paramClassInput), form.attr(\"id\"));",
          "106:         assertEquals(\"/xwiki/bin/saveandcontinue/Space/Page\", form.attr(\"action\"));",
          "107:         Element fieldset = form.selectFirst(\"fieldset\");",
          "108:         assertEquals(paramsInput, fieldset.attr(\"class\"));",
          "109:         assertEquals(paramClassInput, document.selectFirst(\".hidden input[name='classname']\").val());",
          "110:     }",
          "111: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e21d6bac5c4d706b0c3fcd6495263dfcf2023a98",
      "candidate_info": {
        "commit_hash": "e21d6bac5c4d706b0c3fcd6495263dfcf2023a98",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/e21d6bac5c4d706b0c3fcd6495263dfcf2023a98",
        "files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/pom.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/main/resources/XWiki/AdminFieldsDisplaySheet.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ],
        "message": "XWIKI-20261: Improved escaping of AdminFieldsDisplaySheet",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java -> xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.administration;",
          "22: import java.util.Map;",
          "24: import javax.script.ScriptContext;",
          "26: import org.jsoup.nodes.Document;",
          "27: import org.jsoup.nodes.Element;",
          "28: import org.junit.jupiter.api.BeforeEach;",
          "29: import org.junit.jupiter.api.Test;",
          "30: import org.xwiki.model.reference.DocumentReference;",
          "31: import org.xwiki.rendering.RenderingScriptServiceComponentList;",
          "32: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
          "33: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
          "34: import org.xwiki.script.ScriptContextManager;",
          "35: import org.xwiki.test.annotation.ComponentList;",
          "36: import org.xwiki.test.page.HTML50ComponentList;",
          "37: import org.xwiki.test.page.PageTest;",
          "38: import org.xwiki.test.page.TestNoScriptMacro;",
          "39: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
          "41: import static java.util.Collections.emptyList;",
          "42: import static java.util.Collections.singletonMap;",
          "43: import static javax.script.ScriptContext.ENGINE_SCOPE;",
          "44: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "55: @HTML50ComponentList",
          "56: @XWikiSyntax21ComponentList",
          "57: @RenderingScriptServiceComponentList",
          "58: @ComponentList({",
          "59:     TestNoScriptMacro.class,",
          "60:     DefaultExtendedRenderingConfiguration.class,",
          "61:     RenderingConfigClassDocumentConfigurationSource.class",
          "62: })",
          "63: class AdminFieldsDisplaySheetPageTest extends PageTest",
          "64: {",
          "65:     private ScriptContext scriptContext;",
          "67:     @BeforeEach",
          "68:     void setUp() throws Exception",
          "69:     {",
          "70:         this.scriptContext =",
          "71:             this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class).getScriptContext();",
          "72:     }",
          "74:     @Test",
          "75:     void escaping() throws Exception",
          "76:     {",
          "77:         String paramsInput = \"\\\"/><script>console.log('params');</script>{{/html}}{{noscript/}}\";",
          "78:         String sectionInput = \"\\\"/><strong>console.log('section');</script>{{/html}}{{noscript/}}\";",
          "79:         String paramClassInput = \"\\\"/><script>console.log('paramClass');</script>{{/html}}{{noscript/}}\";",
          "80:         Map<Object, Object> params = singletonMap(paramsInput, emptyList());",
          "81:         DocumentReference otherDocumentReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");",
          "82:         com.xpn.xwiki.api.Document otherDocument =",
          "83:             new com.xpn.xwiki.api.Document(this.xwiki.getDocument(otherDocumentReference, this.context), this.context);",
          "85:         this.scriptContext.setAttribute(\"section\", sectionInput, ENGINE_SCOPE);",
          "86:         this.scriptContext.setAttribute(\"paramDoc\", otherDocument, ENGINE_SCOPE);",
          "87:         this.scriptContext.setAttribute(\"params\", params, ENGINE_SCOPE);",
          "88:         this.scriptContext.setAttribute(\"paramClass\", paramClassInput, ENGINE_SCOPE);",
          "90:         Document document = renderHTMLPage(new DocumentReference(\"xwiki\", \"XWiki\", \"AdminFieldsDisplaySheet\"));",
          "92:         Element form = document.selectFirst(\"form\");",
          "93:         assertEquals(String.format(\"%s_%s\", sectionInput, paramClassInput), form.attr(\"id\"));",
          "94:         assertEquals(\"/xwiki/bin/saveandcontinue/Space/Page\", form.attr(\"action\"));",
          "95:         Element fieldset = form.selectFirst(\"fieldset\");",
          "96:         assertEquals(paramsInput, fieldset.attr(\"class\"));",
          "97:         assertEquals(paramClassInput, document.selectFirst(\".hidden input[name='classname']\").val());",
          "98:     }",
          "99: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1c06149d7541f7a01f961b3c98d49765462196ad",
      "candidate_info": {
        "commit_hash": "1c06149d7541f7a01f961b3c98d49765462196ad",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/1c06149d7541f7a01f961b3c98d49765462196ad",
        "files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/pom.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/main/resources/XWiki/AdminFieldsDisplaySheet.xml",
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ],
        "message": "XWIKI-20261: Improved escaping of AdminFieldsDisplaySheet",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java||xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java": [
          "File: xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java -> xwiki-platform-core/xwiki-platform-administration/xwiki-platform-administration-ui/src/test/java/org/xwiki/administration/AdminFieldsDisplaySheetPageTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.administration;",
          "22: import java.util.Map;",
          "24: import javax.script.ScriptContext;",
          "26: import org.jsoup.nodes.Document;",
          "27: import org.jsoup.nodes.Element;",
          "28: import org.junit.jupiter.api.BeforeEach;",
          "29: import org.junit.jupiter.api.Test;",
          "30: import org.xwiki.model.reference.DocumentReference;",
          "31: import org.xwiki.rendering.internal.configuration.DefaultExtendedRenderingConfiguration;",
          "32: import org.xwiki.rendering.internal.configuration.RenderingConfigClassDocumentConfigurationSource;",
          "33: import org.xwiki.rendering.internal.macro.DefaultMacroCategoryManager;",
          "34: import org.xwiki.rendering.internal.syntax.SyntaxConverter;",
          "35: import org.xwiki.rendering.internal.transformation.macro.DefaultMacroTransformationConfiguration;",
          "36: import org.xwiki.rendering.script.RenderingScriptService;",
          "37: import org.xwiki.script.ScriptContextManager;",
          "38: import org.xwiki.test.annotation.ComponentList;",
          "39: import org.xwiki.test.page.HTML50ComponentList;",
          "40: import org.xwiki.test.page.PageTest;",
          "41: import org.xwiki.test.page.TestNoScriptMacro;",
          "42: import org.xwiki.test.page.XWikiSyntax21ComponentList;",
          "43: import org.xwiki.velocity.tools.EscapeTool;",
          "44: import org.xwiki.xml.internal.html.filter.ControlCharactersFilter;",
          "46: import static java.util.Collections.emptyList;",
          "47: import static java.util.Collections.singletonMap;",
          "48: import static javax.script.ScriptContext.ENGINE_SCOPE;",
          "49: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "60: @HTML50ComponentList",
          "61: @XWikiSyntax21ComponentList",
          "62: @ComponentList({",
          "63:     TestNoScriptMacro.class,",
          "64:     DefaultExtendedRenderingConfiguration.class,",
          "65:     RenderingConfigClassDocumentConfigurationSource.class,",
          "67:     RenderingScriptService.class,",
          "68:     DefaultExtendedRenderingConfiguration.class,",
          "69:     RenderingConfigClassDocumentConfigurationSource.class,",
          "70:     SyntaxConverter.class,",
          "71:     DefaultMacroCategoryManager.class,",
          "72:     DefaultMacroTransformationConfiguration.class,",
          "74:     ControlCharactersFilter.class",
          "75: })",
          "76: class AdminFieldsDisplaySheetPageTest extends PageTest",
          "77: {",
          "78:     private ScriptContext scriptContext;",
          "80:     @BeforeEach",
          "81:     void setUp() throws Exception",
          "82:     {",
          "83:         this.scriptContext =",
          "84:             this.oldcore.getMocker().<ScriptContextManager>getInstance(ScriptContextManager.class).getScriptContext();",
          "85:         registerVelocityTool(\"escapetool\", new EscapeTool());",
          "86:     }",
          "88:     @Test",
          "89:     void escaping() throws Exception",
          "90:     {",
          "91:         String paramsInput = \"\\\"/><script>console.log('params');</script>{{/html}}{{noscript/}}\";",
          "92:         String sectionInput = \"\\\"/><strong>console.log('section');</script>{{/html}}{{noscript/}}\";",
          "93:         String paramClassInput = \"\\\"/><script>console.log('paramClass');</script>{{/html}}{{noscript/}}\";",
          "94:         Map<Object, Object> params = singletonMap(paramsInput, emptyList());",
          "95:         DocumentReference otherDocumentReference = new DocumentReference(\"xwiki\", \"Space\", \"Page\");",
          "96:         com.xpn.xwiki.api.Document otherDocument =",
          "97:             new com.xpn.xwiki.api.Document(this.xwiki.getDocument(otherDocumentReference, this.context), this.context);",
          "99:         this.scriptContext.setAttribute(\"section\", sectionInput, ENGINE_SCOPE);",
          "100:         this.scriptContext.setAttribute(\"paramDoc\", otherDocument, ENGINE_SCOPE);",
          "101:         this.scriptContext.setAttribute(\"params\", params, ENGINE_SCOPE);",
          "102:         this.scriptContext.setAttribute(\"paramClass\", paramClassInput, ENGINE_SCOPE);",
          "104:         Document document = renderHTMLPage(new DocumentReference(\"xwiki\", \"XWiki\", \"AdminFieldsDisplaySheet\"));",
          "106:         Element form = document.selectFirst(\"form\");",
          "107:         assertEquals(String.format(\"%s_%s\", sectionInput, paramClassInput), form.attr(\"id\"));",
          "108:         assertEquals(\"/xwiki/bin/saveandcontinue/Space/Page\", form.attr(\"action\"));",
          "109:         Element fieldset = form.selectFirst(\"fieldset\");",
          "110:         assertEquals(paramsInput, fieldset.attr(\"class\"));",
          "111:         assertEquals(paramClassInput, document.selectFirst(\".hidden input[name='classname']\").val());",
          "112:     }",
          "113: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}