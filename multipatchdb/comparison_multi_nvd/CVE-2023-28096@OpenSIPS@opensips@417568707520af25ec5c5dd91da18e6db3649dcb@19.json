{
  "cve_id": "CVE-2023-28096",
  "cve_desc": "OpenSIPS, a Session Initiation Protocol (SIP) server implementation, has a memory leak starting in the 2.3 branch and priot to versions 3.1.8 and 3.2.5. The memory leak was detected in the function `parse_mi_request` while performing coverage-guided fuzzing. This issue can be reproduced by sending multiple requests of the form `{\"jsonrpc\": \"2.0\",\"method\": \"log_le`. This malformed message was tested against an instance of OpenSIPS via FIFO transport layer and was found to increase the memory consumption over time.\n\nTo abuse this memory leak, attackers need to reach the management interface (MI) which typically should only be exposed on trusted interfaces. In cases where the MI is exposed to the internet without authentication, abuse of this issue will lead to memory exhaustion which may affect the underlying system\u2019s availability. No authentication is typically required to reproduce this issue. On the other hand, memory leaks may occur in other areas of OpenSIPS where the cJSON library is used for parsing JSON objects.\n\nThe issue has been fixed in versions 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
  "patch_info": {
    "commit_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/417568707520af25ec5c5dd91da18e6db3649dcb",
    "files": [
      "lib/cJSON.c"
    ],
    "message": "cJSON: fix memory leak on object parsing error\n\nIssue discovered during OpenSIPS Security Audit 2021/2022,\nby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-2mg2-g46r-j4qr",
    "before_after_code_files": [
      "lib/cJSON.c||lib/cJSON.c"
    ]
  },
  "patch_diff": {
    "lib/cJSON.c||lib/cJSON.c": [
      "File: lib/cJSON.c -> lib/cJSON.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1483: fail:",
      "1484:     if (item->child != NULL)",
      "1485:     {",
      "1487:         item->child = NULL;",
      "1488:     }",
      "",
      "[Removed Lines]",
      "1486:         cJSON_Delete(child);",
      "",
      "[Added Lines]",
      "1486:         cJSON_Delete(item->child);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d5f20d8623451890354b4c5115a50cb2622cc07c",
      "candidate_info": {
        "commit_hash": "d5f20d8623451890354b4c5115a50cb2622cc07c",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/d5f20d8623451890354b4c5115a50cb2622cc07c",
        "files": [
          "modules/python/python_exec.c"
        ],
        "message": "python: Don't leak memory in python_exec().\n\nThe bug was introduced in rev 302058d8d38 (April 2019) along\nwith module API cleanup and affects all releases since 3.0.",
        "before_after_code_files": [
          "modules/python/python_exec.c||modules/python/python_exec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/python/python_exec.c||modules/python/python_exec.c": [
          "File: modules/python/python_exec.c -> modules/python/python_exec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     str mystr;",
          "49:     if (pkg_nt_str_dup(&method_name, _method_name_s) < 0)",
          "51:     if (_mystr_s && pkg_nt_str_dup(&mystr, _mystr_s) < 0)",
          "54:     PyEval_AcquireThread(myThreadState);",
          "",
          "[Removed Lines]",
          "50:         return -1;",
          "52:         return -1;",
          "",
          "[Added Lines]",
          "50:         goto e0;",
          "52:         goto e1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "115:     rval = PyLong_AsLong(pResult);",
          "116:     Py_DECREF(pResult);",
          "117:     PyEval_ReleaseThread(myThreadState);",
          "119:     pkg_free(method_name.s);",
          "121:     return rval;",
          "123: error:",
          "125:     if (_mystr_s)",
          "126:         pkg_free(mystr.s);",
          "128:     return -1;",
          "129: }",
          "",
          "[Removed Lines]",
          "124:     pkg_free(method_name.s);",
          "",
          "[Added Lines]",
          "119:     if (_mystr_s)",
          "120:         pkg_free(mystr.s);",
          "128: e1: pkg_free(method_name.s);",
          "129: e0:",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d2496fed59868a676e594cd0594ad24e24897507",
      "candidate_info": {
        "commit_hash": "d2496fed59868a676e594cd0594ad24e24897507",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/d2496fed59868a676e594cd0594ad24e24897507",
        "files": [
          "Makefile.defs",
          "packaging/debian/changelog",
          "packaging/freebsd/Makefile",
          "packaging/netbsd/Makefile",
          "packaging/openbsd/Makefile",
          "packaging/redhat_fedora/opensips.spec",
          "packaging/solaris/base-pkginfo",
          "packaging/solaris/berkeley-pkginfo",
          "packaging/solaris/carrierroute-pkginfo",
          "packaging/solaris/identity-pkginfo",
          "packaging/solaris/ldap-pkginfo",
          "packaging/solaris/mmgeoip-pkginfo",
          "packaging/solaris/mysql-pkginfo",
          "packaging/solaris/perl-pkginfo",
          "packaging/solaris/pgsql-pkginfo",
          "packaging/solaris/pkginfo",
          "packaging/solaris/regex-pkginfo",
          "packaging/solaris/snmp-pkginfo",
          "packaging/solaris/tls-pkginfo",
          "packaging/solaris/xmlrpc-pkginfo"
        ],
        "message": "Bump version to 3.2.8",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs",
          "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "66: #version number",
          "67: VERSION_MAJOR = 3",
          "68: VERSION_MINOR = 2",
          "70: VERSION_BUILD =",
          "72: ifneq (,$(VERSION_BUILD))",
          "",
          "[Removed Lines]",
          "69: VERSION_SUBMINOR = 7",
          "",
          "[Added Lines]",
          "69: VERSION_SUBMINOR = 8",
          "",
          "---------------"
        ],
        "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec": [
          "File: packaging/redhat_fedora/opensips.spec -> packaging/redhat_fedora/opensips.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: Summary:  Very fast and configurable SIP server",
          "47: Name:     opensips",
          "49: Release:  1%{?dist}",
          "50: License:  GPLv2+",
          "51: Group:    System Environment/Daemons",
          "",
          "[Removed Lines]",
          "48: Version:  3.2.7",
          "",
          "[Added Lines]",
          "48: Version:  3.2.8",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b65796dd91b72a7df90fd27c99886a6d56a7811c",
      "candidate_info": {
        "commit_hash": "b65796dd91b72a7df90fd27c99886a6d56a7811c",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/b65796dd91b72a7df90fd27c99886a6d56a7811c",
        "files": [
          "modules/cachedb_local/cachedb_local_replication.c"
        ],
        "message": "cachedb_local: fix expiration of keys received through cluster sync\n\nCredits to Kingsley Tart from CallTracks for reporting.\n\n(cherry picked from commit d0c4fc48c7d46ac3588e540574a5a32b3d61992b)",
        "before_after_code_files": [
          "modules/cachedb_local/cachedb_local_replication.c||modules/cachedb_local/cachedb_local_replication.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/cachedb_local/cachedb_local_replication.c||modules/cachedb_local/cachedb_local_replication.c": [
          "File: modules/cachedb_local/cachedb_local_replication.c -> modules/cachedb_local/cachedb_local_replication.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "187:                                         bin_push_str(sync_packet, &col->col_name);",
          "188:                                         bin_push_str(sync_packet, &data->attr);",
          "189:                                         bin_push_str(sync_packet, &data->value);",
          "191:                                 }",
          "192:                                 data = data->next;",
          "193:                         }",
          "",
          "[Removed Lines]",
          "190:                                         bin_push_int(sync_packet, data->expires);",
          "",
          "[Added Lines]",
          "190:                                         bin_push_int(sync_packet, data->expires ?",
          "191:                                                 data->expires - get_ticks() : 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4f4543218df36b8bc0f9bce2870a898123deb06",
      "candidate_info": {
        "commit_hash": "e4f4543218df36b8bc0f9bce2870a898123deb06",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/e4f4543218df36b8bc0f9bce2870a898123deb06",
        "files": [
          "modules/call_center/call_center.c"
        ],
        "message": "[call_center] avoid a negative setup_time in CDR\n\nIn the DB schema, the setup_time is an unsigned, and a -1 value was computed while a call was rejected by an agent\n\n(cherry picked from commit 9dc28a91c68db792f1df4cf1d6ce8d0faf83ad0e)",
        "before_after_code_files": [
          "modules/call_center/call_center.c||modules/call_center/call_center.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/call_center/call_center.c||modules/call_center/call_center.c": [
          "File: modules/call_center/call_center.c -> modules/call_center/call_center.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "531:  lock_release( data->lock );",
          "537:  type = (stat==NULL) ? -1 : ((prev_state==CC_CALL_TOAGENT && stat->call_time)? 0 : 1);",
          "",
          "[Removed Lines]",
          "533:  if (call->setup_time==-1 && stat)",
          "534:   call->setup_time = stat->setup_time;",
          "",
          "[Added Lines]",
          "533:  if (call->setup_time==-1)",
          "534:   call->setup_time = stat ? stat->setup_time : 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9d41bfce8c09e22e44c68dd99c6291117e9ff172",
      "candidate_info": {
        "commit_hash": "9d41bfce8c09e22e44c68dd99c6291117e9ff172",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/9d41bfce8c09e22e44c68dd99c6291117e9ff172",
        "files": [
          "route.c"
        ],
        "message": "Throw startup error if event_route can never be run\n\nOpenSIPS would start without any error or warning if an event_route\nis used but the 'event_route' module is not loaded.\n\n(cherry picked from commit bb9bd920feb712cf8ec0c32d4e418056fae8cc81)",
        "before_after_code_files": [
          "route.c||route.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "route.c||route.c": [
          "File: route.c -> route.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1475:   }",
          "1476:  }",
          "1479: return 0;",
          "1480: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1478:  for(i = 1; i< EVENT_RT_NO; i++)",
          "1479:   if (sroutes->event[i].a && !module_loaded(\"event_route\")) {",
          "1480:    LM_ERR(\"event_route used but 'event_route' module not loaded!\\n\");",
          "1481:    return E_CFG;",
          "1482:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}