{
  "cve_id": "CVE-2015-6830",
  "cve_desc": "libraries/plugins/auth/AuthenticationCookie.class.php in phpMyAdmin 4.3.x before 4.3.13.2 and 4.4.x before 4.4.14.1 allows remote attackers to bypass a multiple-reCaptcha protection mechanism against brute-force credential guessing by providing a correct response to a single reCaptcha.",
  "repo": "phpmyadmin/phpmyadmin",
  "patch_hash": "785f4e2711848eb8945894199d5870253a88584e",
  "patch_info": {
    "commit_hash": "785f4e2711848eb8945894199d5870253a88584e",
    "repo": "phpmyadmin/phpmyadmin",
    "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/785f4e2711848eb8945894199d5870253a88584e",
    "files": [
      "ChangeLog",
      "libraries/plugins/auth/AuthenticationCookie.class.php",
      "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
    ],
    "message": "Fix reCaptcha bypass\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
    "before_after_code_files": [
      "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
      "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
    ]
  },
  "patch_diff": {
    "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
      "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "223:                 . $GLOBALS['server'] . '\" />';",
      "224:         } // end if (server choice)",
      "235:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
      "236:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
      "238:         ) {",
      "240:             echo '<script src=\"https://www.google.com/recaptcha/api.js?hl='",
      "",
      "[Removed Lines]",
      "227:         $skip = false;",
      "228:         if (  isset($_SESSION['last_valid_captcha'])",
      "229:             && $_SESSION['last_valid_captcha']",
      "230:         ) {",
      "231:             $skip = true;",
      "232:         }",
      "237:             && !$skip",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "337:             if (! defined('TESTSUITE')) {",
      "338:                 session_destroy();",
      "341:             }",
      "343:             if ($GLOBALS['cfg']['LoginCookieDeleteAll']) {",
      "",
      "[Removed Lines]",
      "340:                 $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "360:         if (! empty($_REQUEST['pma_username'])) {",
      "371:             if (! empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
      "372:                 && ! empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
      "374:             ) {",
      "375:                 if (! empty($_POST[\"g-recaptcha-response\"])) {",
      "",
      "[Removed Lines]",
      "363:             $skip = false;",
      "364:             if (isset($_SESSION['last_valid_captcha'])",
      "365:                 && $_SESSION['last_valid_captcha']",
      "366:             ) {",
      "367:                 $skip = true;",
      "368:             }",
      "373:                 && ! $skip",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "389:                     if ($resp == null || ! $resp->isSuccess()) {",
      "390:                         $conn_error = __('Entered captcha is wrong, try again!');",
      "392:                         return false;",
      "395:                     }",
      "396:                 } else {",
      "403:                 }",
      "404:             }",
      "",
      "[Removed Lines]",
      "391:                         $_SESSION['last_valid_captcha'] = false;",
      "393:                     } else {",
      "394:                         $_SESSION['last_valid_captcha'] = true;",
      "397:                     if (! isset($_SESSION['last_valid_captcha'])",
      "398:                         || ! $_SESSION['last_valid_captcha']",
      "399:                     ) {",
      "400:                         $conn_error = __('Please enter correct captcha!');",
      "401:                         return false;",
      "402:                     }",
      "",
      "[Added Lines]",
      "374:                     $conn_error = __('Please enter correct captcha!');",
      "375:                     return false;",
      "",
      "---------------"
    ],
    "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php": [
      "File: test/classes/plugin/auth/PMA_AuthenticationCookie_test.php -> test/classes/plugin/auth/PMA_AuthenticationCookie_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "186:         $GLOBALS['cfg']['Lang'] = 'en';",
      "187:         $GLOBALS['cfg']['AllowArbitraryServer'] = true;",
      "188:         $GLOBALS['cfg']['Servers'] = array(1, 2);",
      "190:         $GLOBALS['target'] = 'testTarget';",
      "191:         $GLOBALS['db'] = 'testDb';",
      "192:         $GLOBALS['table'] = 'testTable';",
      "",
      "[Removed Lines]",
      "189:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "189:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "190:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "308:         $GLOBALS['cfg']['Lang'] = '';",
      "309:         $GLOBALS['cfg']['AllowArbitraryServer'] = false;",
      "310:         $GLOBALS['cfg']['Servers'] = array(1);",
      "312:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
      "313:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
      "314:         $GLOBALS['server'] = 0;",
      "",
      "[Removed Lines]",
      "311:         $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "435:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
      "436:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
      "437:         $_POST[\"g-recaptcha-response\"] = '';",
      "",
      "[Removed Lines]",
      "434:         $_SESSION['last_valid_captcha'] = false;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "485:         $_REQUEST['old_usr'] = '';",
      "486:         $_REQUEST['pma_username'] = 'testPMAUser';",
      "487:         $_REQUEST['pma_servername'] = 'testPMAServer';",
      "",
      "[Removed Lines]",
      "484:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "483:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "484:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "611:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "612:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "613:         $_SESSION['last_access_time'] = '';",
      "617:         $this->object = $this->getMockBuilder('AuthenticationCookie')",
      "",
      "[Removed Lines]",
      "614:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "614:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "615:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "649:         $_COOKIE['pmaPass-1'] = 'pmaPass1';",
      "650:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "651:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "653:         $_SESSION['last_access_time'] = time() - 1000;",
      "654:         $GLOBALS['cfg']['LoginCookieValidity'] = 1440;",
      "",
      "[Removed Lines]",
      "652:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "653:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "654:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "694:         $_COOKIE['pma_iv-1'] = base64_encode('testiv09testiv09');",
      "695:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
      "696:         $_SESSION['last_access_time'] = 1;",
      "698:         $GLOBALS['cfg']['LoginCookieValidity'] = 0;",
      "699:         $_SESSION['last_access_time'] = -1;",
      "",
      "[Removed Lines]",
      "697:         $_SESSION['last_valid_captcha'] = true;",
      "",
      "[Added Lines]",
      "699:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
      "700:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0314e67900f01410bc8c81c58a40dc0515e3c91d",
      "candidate_info": {
        "commit_hash": "0314e67900f01410bc8c81c58a40dc0515e3c91d",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/0314e67900f01410bc8c81c58a40dc0515e3c91d",
        "files": [
          "ChangeLog",
          "libraries/plugins/auth/AuthenticationCookie.class.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ],
        "message": "Fix reCaptcha bypass\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
        "before_after_code_files": [
          "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
          "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ],
          "candidate": [
            "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php",
            "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/plugins/auth/AuthenticationCookie.class.php||libraries/plugins/auth/AuthenticationCookie.class.php": [
          "File: libraries/plugins/auth/AuthenticationCookie.class.php -> libraries/plugins/auth/AuthenticationCookie.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "218:                 . $GLOBALS['server'] . '\" />';",
          "219:         } // end if (server choice)",
          "230:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
          "231:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "233:         ) {",
          "235:             echo '<script type=\"text/javascript\">",
          "",
          "[Removed Lines]",
          "222:         $skip = false;",
          "223:         if (  isset($_SESSION['last_valid_captcha'])",
          "224:             && $_SESSION['last_valid_captcha']",
          "225:         ) {",
          "226:             $skip = true;",
          "227:         }",
          "232:             && !$skip",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "349:             return false;",
          "350:         }",
          "361:         if (  !empty($GLOBALS['cfg']['CaptchaLoginPrivateKey'])",
          "362:             && !empty($GLOBALS['cfg']['CaptchaLoginPublicKey'])",
          "364:         ) {",
          "365:             if (  !empty($_POST[\"recaptcha_challenge_field\"])",
          "366:                 && !empty($_POST[\"recaptcha_response_field\"])",
          "",
          "[Removed Lines]",
          "353:         $skip = false;",
          "354:         if (  isset($_SESSION['last_valid_captcha'])",
          "355:             && $_SESSION['last_valid_captcha']",
          "356:         ) {",
          "357:             $skip = true;",
          "358:         }",
          "363:             && !$skip",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "379:                 if ( !$resp->is_valid ) {",
          "380:                     $conn_error = __('Entered captcha is wrong, try again!');",
          "382:                     return false;",
          "385:                 }",
          "386:             } elseif (! empty($_POST[\"recaptcha_challenge_field\"])",
          "387:                 && empty($_POST[\"recaptcha_response_field\"])",
          "",
          "[Removed Lines]",
          "381:                     $_SESSION['last_valid_captcha'] = false;",
          "383:                 } else {",
          "384:                     $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "389:                 $conn_error = __('Please enter correct captcha!');",
          "390:                 return false;",
          "391:             } else {",
          "397:             }",
          "398:         }",
          "",
          "[Removed Lines]",
          "392:                 if (! isset($_SESSION['last_valid_captcha'])",
          "393:                     || ! $_SESSION['last_valid_captcha']",
          "394:                 ) {",
          "395:                     return false;",
          "396:                 }",
          "",
          "[Added Lines]",
          "371:                 return false;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "407:             if (! defined('TESTSUITE')) {",
          "408:                 session_destroy();",
          "411:             }",
          "413:             if ($GLOBALS['cfg']['LoginCookieDeleteAll']) {",
          "",
          "[Removed Lines]",
          "410:                 $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/classes/plugin/auth/PMA_AuthenticationCookie_test.php||test/classes/plugin/auth/PMA_AuthenticationCookie_test.php": [
          "File: test/classes/plugin/auth/PMA_AuthenticationCookie_test.php -> test/classes/plugin/auth/PMA_AuthenticationCookie_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "186:         $GLOBALS['cfg']['Lang'] = 'en';",
          "187:         $GLOBALS['cfg']['AllowArbitraryServer'] = true;",
          "188:         $GLOBALS['cfg']['Servers'] = array(1, 2);",
          "190:         $GLOBALS['target'] = 'testTarget';",
          "191:         $GLOBALS['db'] = 'testDb';",
          "192:         $GLOBALS['table'] = 'testTable';",
          "",
          "[Removed Lines]",
          "189:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "189:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "190:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "328:         $GLOBALS['cfg']['Lang'] = '';",
          "329:         $GLOBALS['cfg']['AllowArbitraryServer'] = false;",
          "330:         $GLOBALS['cfg']['Servers'] = array(1);",
          "332:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "333:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "334:         $GLOBALS['server'] = 0;",
          "",
          "[Removed Lines]",
          "331:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "474:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "475:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "476:         $_POST[\"recaptcha_challenge_field\"] = 'captcha1';",
          "",
          "[Removed Lines]",
          "473:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "491:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = 'testprivkey';",
          "492:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = 'testpubkey';",
          "493:         $_POST[\"recaptcha_challenge_field\"] = '';",
          "",
          "[Removed Lines]",
          "490:         $_SESSION['last_valid_captcha'] = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "536:         $_REQUEST['old_usr'] = '';",
          "537:         $_REQUEST['pma_username'] = 'testPMAUser';",
          "538:         $_REQUEST['pma_servername'] = 'testPMAServer';",
          "",
          "[Removed Lines]",
          "535:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "533:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "534:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "662:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "663:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "664:         $_SESSION['last_access_time'] = '';",
          "668:         $this->object = $this->getMockBuilder('AuthenticationCookie')",
          "669:             ->disableOriginalConstructor()",
          "",
          "[Removed Lines]",
          "665:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "664:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "665:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "700:         $_COOKIE['pmaPass-1'] = 'pmaPass1';",
          "701:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "702:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "704:         $_SESSION['last_access_time'] = time() - 1000;",
          "705:         $GLOBALS['cfg']['LoginCookieValidity'] = 1440;",
          "",
          "[Removed Lines]",
          "703:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "702:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "703:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "745:         $_COOKIE['pma_iv'] = base64_encode('testiv09testiv09');",
          "746:         $GLOBALS['cfg']['blowfish_secret'] = 'secret';",
          "747:         $_SESSION['last_access_time'] = 1;",
          "749:         $GLOBALS['cfg']['LoginCookieValidity'] = 0;",
          "750:         $_SESSION['last_access_time'] = -1;",
          "",
          "[Removed Lines]",
          "748:         $_SESSION['last_valid_captcha'] = true;",
          "",
          "[Added Lines]",
          "748:         $GLOBALS['cfg']['CaptchaLoginPrivateKey'] = '';",
          "749:         $GLOBALS['cfg']['CaptchaLoginPublicKey'] = '';",
          "",
          "---------------"
        ]
      }
    }
  ]
}