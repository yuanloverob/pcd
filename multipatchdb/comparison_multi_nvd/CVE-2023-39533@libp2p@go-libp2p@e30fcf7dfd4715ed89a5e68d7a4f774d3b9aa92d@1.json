{
  "cve_id": "CVE-2023-39533",
  "cve_desc": "go-libp2p is the Go implementation of the libp2p Networking Stack. Prior to versions 0.27.8, 0.28.2, and 0.29.1 malicious peer can use large RSA keys to run a resource exhaustion attack & force a node to spend time doing signature verification of the large key. This vulnerability is present in the core/crypto module of go-libp2p and can occur during the Noise handshake and the libp2p x509 extension verification step. To prevent this attack, go-libp2p versions 0.27.8, 0.28.2, and 0.29.1 restrict RSA keys to <= 8192 bits. To protect one's application, it is necessary to update to these patch releases and to use the updated Go compiler in 1.20.7 or 1.19.12. There are no known workarounds for this issue.",
  "repo": "libp2p/go-libp2p",
  "patch_hash": "e30fcf7dfd4715ed89a5e68d7a4f774d3b9aa92d",
  "patch_info": {
    "commit_hash": "e30fcf7dfd4715ed89a5e68d7a4f774d3b9aa92d",
    "repo": "libp2p/go-libp2p",
    "commit_url": "https://github.com/libp2p/go-libp2p/commit/e30fcf7dfd4715ed89a5e68d7a4f774d3b9aa92d",
    "files": [
      "core/crypto/rsa_common.go",
      "core/crypto/rsa_go.go",
      "core/crypto/rsa_test.go"
    ],
    "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
    "before_after_code_files": [
      "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
      "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
      "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
    ]
  },
  "patch_diff": {
    "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
      "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "13: var MinRsaKeyBits = 2048",
      "17: var ErrRsaKeyTooSmall error",
      "19: func init() {",
      "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "15: var maxRsaKeyBits = 8192",
      "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
      "",
      "---------------"
    ],
    "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
      "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "31:  if bits < MinRsaKeyBits {",
      "32:   return nil, nil, ErrRsaKeyTooSmall",
      "33:  }",
      "34:  priv, err := rsa.GenerateKey(src, bits)",
      "35:  if err != nil {",
      "36:   return nil, nil, err",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "34:  if bits > maxRsaKeyBits {",
      "35:   return nil, nil, ErrRsaKeyTooBig",
      "36:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "124:  if sk.N.BitLen() < MinRsaKeyBits {",
      "125:   return nil, ErrRsaKeyTooSmall",
      "126:  }",
      "127:  return &RsaPrivateKey{sk: *sk}, nil",
      "128: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "130:  if sk.N.BitLen() > maxRsaKeyBits {",
      "131:   return nil, ErrRsaKeyTooBig",
      "132:  }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "141:  if pk.N.BitLen() < MinRsaKeyBits {",
      "142:   return nil, ErrRsaKeyTooSmall",
      "143:  }",
      "145:  return &RsaPublicKey{k: *pk}, nil",
      "146: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "150:  if pk.N.BitLen() > maxRsaKeyBits {",
      "151:   return nil, ErrRsaKeyTooBig",
      "152:  }",
      "",
      "---------------"
    ],
    "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
      "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "68:  }",
      "69: }",
      "71: func TestRSASignZero(t *testing.T) {",
      "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
      "73:  if err != nil {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
      "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
      "73:  if err != ErrRsaKeyTooBig {",
      "74:   t.Fatal(\"should have refused to create too big RSA key\")",
      "75:  }",
      "76: }",
      "78: func TestRSABigKey(t *testing.T) {",
      "81:  origSize := maxRsaKeyBits",
      "82:  maxRsaKeyBits = 2048",
      "83:  defer func() { maxRsaKeyBits = origSize }() //",
      "85:  maxRsaKeyBits *= 2",
      "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
      "87:  if err != nil {",
      "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
      "89:  }",
      "90:  pubBytes, err := MarshalPublicKey(badPub)",
      "91:  if err != nil {",
      "92:   t.Fatal(err)",
      "93:  }",
      "94:  privBytes, err := MarshalPrivateKey(badPriv)",
      "95:  if err != nil {",
      "96:   t.Fatal(err)",
      "97:  }",
      "98:  maxRsaKeyBits /= 2",
      "99:  _, err = UnmarshalPublicKey(pubBytes)",
      "100:  if err != ErrRsaKeyTooBig {",
      "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
      "102:  }",
      "103:  _, err = UnmarshalPrivateKey(privBytes)",
      "104:  if err != ErrRsaKeyTooBig {",
      "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
      "106:  }",
      "107: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d73e06de501bb7f2a0dfaae98b1b7420a9495e88",
      "candidate_info": {
        "commit_hash": "d73e06de501bb7f2a0dfaae98b1b7420a9495e88",
        "repo": "libp2p/go-libp2p",
        "commit_url": "https://github.com/libp2p/go-libp2p/commit/d73e06de501bb7f2a0dfaae98b1b7420a9495e88",
        "files": [
          "core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go"
        ],
        "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
        "before_after_code_files": [
          "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ],
          "candidate": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ]
        }
      },
      "candidate_diff": {
        "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
          "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: var MinRsaKeyBits = 2048",
          "17: var ErrRsaKeyTooSmall error",
          "19: func init() {",
          "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: var maxRsaKeyBits = 8192",
          "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
          "",
          "---------------"
        ],
        "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
          "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  if bits < MinRsaKeyBits {",
          "32:   return nil, nil, ErrRsaKeyTooSmall",
          "33:  }",
          "34:  priv, err := rsa.GenerateKey(src, bits)",
          "35:  if err != nil {",
          "36:   return nil, nil, err",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34:  if bits > maxRsaKeyBits {",
          "35:   return nil, nil, ErrRsaKeyTooBig",
          "36:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  if sk.N.BitLen() < MinRsaKeyBits {",
          "125:   return nil, ErrRsaKeyTooSmall",
          "126:  }",
          "127:  return &RsaPrivateKey{sk: *sk}, nil",
          "128: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:  if sk.N.BitLen() > maxRsaKeyBits {",
          "131:   return nil, ErrRsaKeyTooBig",
          "132:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "141:  if pk.N.BitLen() < MinRsaKeyBits {",
          "142:   return nil, ErrRsaKeyTooSmall",
          "143:  }",
          "145:  return &RsaPublicKey{k: *pk}, nil",
          "146: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  if pk.N.BitLen() > maxRsaKeyBits {",
          "151:   return nil, ErrRsaKeyTooBig",
          "152:  }",
          "",
          "---------------"
        ],
        "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
          "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:  }",
          "69: }",
          "71: func TestRSASignZero(t *testing.T) {",
          "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
          "73:  if err != nil {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
          "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
          "73:  if err != ErrRsaKeyTooBig {",
          "74:   t.Fatal(\"should have refused to create too big RSA key\")",
          "75:  }",
          "76: }",
          "78: func TestRSABigKey(t *testing.T) {",
          "81:  origSize := maxRsaKeyBits",
          "82:  maxRsaKeyBits = 2048",
          "83:  defer func() { maxRsaKeyBits = origSize }() //",
          "85:  maxRsaKeyBits *= 2",
          "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
          "87:  if err != nil {",
          "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
          "89:  }",
          "90:  pubBytes, err := MarshalPublicKey(badPub)",
          "91:  if err != nil {",
          "92:   t.Fatal(err)",
          "93:  }",
          "94:  privBytes, err := MarshalPrivateKey(badPriv)",
          "95:  if err != nil {",
          "96:   t.Fatal(err)",
          "97:  }",
          "98:  maxRsaKeyBits /= 2",
          "99:  _, err = UnmarshalPublicKey(pubBytes)",
          "100:  if err != ErrRsaKeyTooBig {",
          "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "102:  }",
          "103:  _, err = UnmarshalPrivateKey(privBytes)",
          "104:  if err != ErrRsaKeyTooBig {",
          "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "106:  }",
          "107: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b79194a5a301e57f837c3bbe28154933ef325321",
      "candidate_info": {
        "commit_hash": "b79194a5a301e57f837c3bbe28154933ef325321",
        "repo": "libp2p/go-libp2p",
        "commit_url": "https://github.com/libp2p/go-libp2p/commit/b79194a5a301e57f837c3bbe28154933ef325321",
        "files": [
          "core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go"
        ],
        "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
        "before_after_code_files": [
          "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ],
          "candidate": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ]
        }
      },
      "candidate_diff": {
        "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
          "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: var MinRsaKeyBits = 2048",
          "17: var ErrRsaKeyTooSmall error",
          "19: func init() {",
          "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: var maxRsaKeyBits = 8192",
          "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
          "",
          "---------------"
        ],
        "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
          "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  if bits < MinRsaKeyBits {",
          "32:   return nil, nil, ErrRsaKeyTooSmall",
          "33:  }",
          "34:  priv, err := rsa.GenerateKey(src, bits)",
          "35:  if err != nil {",
          "36:   return nil, nil, err",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34:  if bits > maxRsaKeyBits {",
          "35:   return nil, nil, ErrRsaKeyTooBig",
          "36:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  if sk.N.BitLen() < MinRsaKeyBits {",
          "125:   return nil, ErrRsaKeyTooSmall",
          "126:  }",
          "127:  return &RsaPrivateKey{sk: *sk}, nil",
          "128: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:  if sk.N.BitLen() > maxRsaKeyBits {",
          "131:   return nil, ErrRsaKeyTooBig",
          "132:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "141:  if pk.N.BitLen() < MinRsaKeyBits {",
          "142:   return nil, ErrRsaKeyTooSmall",
          "143:  }",
          "145:  return &RsaPublicKey{k: *pk}, nil",
          "146: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  if pk.N.BitLen() > maxRsaKeyBits {",
          "151:   return nil, ErrRsaKeyTooBig",
          "152:  }",
          "",
          "---------------"
        ],
        "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
          "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:  }",
          "69: }",
          "71: func TestRSASignZero(t *testing.T) {",
          "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
          "73:  if err != nil {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
          "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
          "73:  if err != ErrRsaKeyTooBig {",
          "74:   t.Fatal(\"should have refused to create too big RSA key\")",
          "75:  }",
          "76: }",
          "78: func TestRSABigKey(t *testing.T) {",
          "81:  origSize := maxRsaKeyBits",
          "82:  maxRsaKeyBits = 2048",
          "83:  defer func() { maxRsaKeyBits = origSize }() //",
          "85:  maxRsaKeyBits *= 2",
          "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
          "87:  if err != nil {",
          "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
          "89:  }",
          "90:  pubBytes, err := MarshalPublicKey(badPub)",
          "91:  if err != nil {",
          "92:   t.Fatal(err)",
          "93:  }",
          "94:  privBytes, err := MarshalPrivateKey(badPriv)",
          "95:  if err != nil {",
          "96:   t.Fatal(err)",
          "97:  }",
          "98:  maxRsaKeyBits /= 2",
          "99:  _, err = UnmarshalPublicKey(pubBytes)",
          "100:  if err != ErrRsaKeyTooBig {",
          "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "102:  }",
          "103:  _, err = UnmarshalPrivateKey(privBytes)",
          "104:  if err != ErrRsaKeyTooBig {",
          "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "106:  }",
          "107: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0cce607219f3710addc7e18672cffd1f1d912fbb",
      "candidate_info": {
        "commit_hash": "0cce607219f3710addc7e18672cffd1f1d912fbb",
        "repo": "libp2p/go-libp2p",
        "commit_url": "https://github.com/libp2p/go-libp2p/commit/0cce607219f3710addc7e18672cffd1f1d912fbb",
        "files": [
          "core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go"
        ],
        "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
        "before_after_code_files": [
          "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ],
          "candidate": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ]
        }
      },
      "candidate_diff": {
        "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
          "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: var MinRsaKeyBits = 2048",
          "17: var ErrRsaKeyTooSmall error",
          "19: func init() {",
          "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: var maxRsaKeyBits = 8192",
          "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
          "",
          "---------------"
        ],
        "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
          "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  if bits < MinRsaKeyBits {",
          "32:   return nil, nil, ErrRsaKeyTooSmall",
          "33:  }",
          "34:  priv, err := rsa.GenerateKey(src, bits)",
          "35:  if err != nil {",
          "36:   return nil, nil, err",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34:  if bits > maxRsaKeyBits {",
          "35:   return nil, nil, ErrRsaKeyTooBig",
          "36:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  if sk.N.BitLen() < MinRsaKeyBits {",
          "125:   return nil, ErrRsaKeyTooSmall",
          "126:  }",
          "127:  return &RsaPrivateKey{sk: *sk}, nil",
          "128: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:  if sk.N.BitLen() > maxRsaKeyBits {",
          "131:   return nil, ErrRsaKeyTooBig",
          "132:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "141:  if pk.N.BitLen() < MinRsaKeyBits {",
          "142:   return nil, ErrRsaKeyTooSmall",
          "143:  }",
          "145:  return &RsaPublicKey{k: *pk}, nil",
          "146: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  if pk.N.BitLen() > maxRsaKeyBits {",
          "151:   return nil, ErrRsaKeyTooBig",
          "152:  }",
          "",
          "---------------"
        ],
        "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
          "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:  }",
          "69: }",
          "71: func TestRSASignZero(t *testing.T) {",
          "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
          "73:  if err != nil {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
          "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
          "73:  if err != ErrRsaKeyTooBig {",
          "74:   t.Fatal(\"should have refused to create too big RSA key\")",
          "75:  }",
          "76: }",
          "78: func TestRSABigKey(t *testing.T) {",
          "81:  origSize := maxRsaKeyBits",
          "82:  maxRsaKeyBits = 2048",
          "83:  defer func() { maxRsaKeyBits = origSize }() //",
          "85:  maxRsaKeyBits *= 2",
          "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
          "87:  if err != nil {",
          "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
          "89:  }",
          "90:  pubBytes, err := MarshalPublicKey(badPub)",
          "91:  if err != nil {",
          "92:   t.Fatal(err)",
          "93:  }",
          "94:  privBytes, err := MarshalPrivateKey(badPriv)",
          "95:  if err != nil {",
          "96:   t.Fatal(err)",
          "97:  }",
          "98:  maxRsaKeyBits /= 2",
          "99:  _, err = UnmarshalPublicKey(pubBytes)",
          "100:  if err != ErrRsaKeyTooBig {",
          "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "102:  }",
          "103:  _, err = UnmarshalPrivateKey(privBytes)",
          "104:  if err != ErrRsaKeyTooBig {",
          "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "106:  }",
          "107: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "445be526aea4ee0b1fa5388aa65d32b2816d3a00",
      "candidate_info": {
        "commit_hash": "445be526aea4ee0b1fa5388aa65d32b2816d3a00",
        "repo": "libp2p/go-libp2p",
        "commit_url": "https://github.com/libp2p/go-libp2p/commit/445be526aea4ee0b1fa5388aa65d32b2816d3a00",
        "files": [
          "core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go"
        ],
        "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
        "before_after_code_files": [
          "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ],
          "candidate": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ]
        }
      },
      "candidate_diff": {
        "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
          "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: var MinRsaKeyBits = 2048",
          "17: var ErrRsaKeyTooSmall error",
          "19: func init() {",
          "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: var maxRsaKeyBits = 8192",
          "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
          "",
          "---------------"
        ],
        "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
          "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  if bits < MinRsaKeyBits {",
          "32:   return nil, nil, ErrRsaKeyTooSmall",
          "33:  }",
          "34:  priv, err := rsa.GenerateKey(src, bits)",
          "35:  if err != nil {",
          "36:   return nil, nil, err",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34:  if bits > maxRsaKeyBits {",
          "35:   return nil, nil, ErrRsaKeyTooBig",
          "36:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  if sk.N.BitLen() < MinRsaKeyBits {",
          "125:   return nil, ErrRsaKeyTooSmall",
          "126:  }",
          "127:  return &RsaPrivateKey{sk: *sk}, nil",
          "128: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:  if sk.N.BitLen() > maxRsaKeyBits {",
          "131:   return nil, ErrRsaKeyTooBig",
          "132:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "141:  if pk.N.BitLen() < MinRsaKeyBits {",
          "142:   return nil, ErrRsaKeyTooSmall",
          "143:  }",
          "145:  return &RsaPublicKey{k: *pk}, nil",
          "146: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  if pk.N.BitLen() > maxRsaKeyBits {",
          "151:   return nil, ErrRsaKeyTooBig",
          "152:  }",
          "",
          "---------------"
        ],
        "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
          "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:  }",
          "69: }",
          "71: func TestRSASignZero(t *testing.T) {",
          "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
          "73:  if err != nil {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
          "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
          "73:  if err != ErrRsaKeyTooBig {",
          "74:   t.Fatal(\"should have refused to create too big RSA key\")",
          "75:  }",
          "76: }",
          "78: func TestRSABigKey(t *testing.T) {",
          "81:  origSize := maxRsaKeyBits",
          "82:  maxRsaKeyBits = 2048",
          "83:  defer func() { maxRsaKeyBits = origSize }() //",
          "85:  maxRsaKeyBits *= 2",
          "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
          "87:  if err != nil {",
          "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
          "89:  }",
          "90:  pubBytes, err := MarshalPublicKey(badPub)",
          "91:  if err != nil {",
          "92:   t.Fatal(err)",
          "93:  }",
          "94:  privBytes, err := MarshalPrivateKey(badPriv)",
          "95:  if err != nil {",
          "96:   t.Fatal(err)",
          "97:  }",
          "98:  maxRsaKeyBits /= 2",
          "99:  _, err = UnmarshalPublicKey(pubBytes)",
          "100:  if err != ErrRsaKeyTooBig {",
          "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "102:  }",
          "103:  _, err = UnmarshalPrivateKey(privBytes)",
          "104:  if err != ErrRsaKeyTooBig {",
          "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "106:  }",
          "107: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e51ee722686ef2b42674f31b9c69916d6ae13b7f",
      "candidate_info": {
        "commit_hash": "e51ee722686ef2b42674f31b9c69916d6ae13b7f",
        "repo": "libp2p/go-libp2p",
        "commit_url": "https://github.com/libp2p/go-libp2p/commit/e51ee722686ef2b42674f31b9c69916d6ae13b7f",
        "files": [
          "core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go"
        ],
        "message": "core/crypto: restrict RSA keys to <= 8192 bits (#2454)\n\n* Error if RSA key is too big\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Update core/crypto/rsa_common.go\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>\n\n* Fix rename\n\n* Make this var again so the tests work\n\n---------\n\nCo-authored-by: Marten Seemann <martenseemann@gmail.com>",
        "before_after_code_files": [
          "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
          "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
          "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ],
          "candidate": [
            "core/crypto/rsa_common.go||core/crypto/rsa_common.go",
            "core/crypto/rsa_go.go||core/crypto/rsa_go.go",
            "core/crypto/rsa_test.go||core/crypto/rsa_test.go"
          ]
        }
      },
      "candidate_diff": {
        "core/crypto/rsa_common.go||core/crypto/rsa_common.go": [
          "File: core/crypto/rsa_common.go -> core/crypto/rsa_common.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "13: var MinRsaKeyBits = 2048",
          "17: var ErrRsaKeyTooSmall error",
          "19: func init() {",
          "20:  if _, ok := os.LookupEnv(WeakRsaKeyEnv); ok {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: var maxRsaKeyBits = 8192",
          "20: var ErrRsaKeyTooBig error = fmt.Errorf(\"rsa keys must be <= %d bits\", maxRsaKeyBits)",
          "",
          "---------------"
        ],
        "core/crypto/rsa_go.go||core/crypto/rsa_go.go": [
          "File: core/crypto/rsa_go.go -> core/crypto/rsa_go.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  if bits < MinRsaKeyBits {",
          "32:   return nil, nil, ErrRsaKeyTooSmall",
          "33:  }",
          "34:  priv, err := rsa.GenerateKey(src, bits)",
          "35:  if err != nil {",
          "36:   return nil, nil, err",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34:  if bits > maxRsaKeyBits {",
          "35:   return nil, nil, ErrRsaKeyTooBig",
          "36:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  if sk.N.BitLen() < MinRsaKeyBits {",
          "125:   return nil, ErrRsaKeyTooSmall",
          "126:  }",
          "127:  return &RsaPrivateKey{sk: *sk}, nil",
          "128: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:  if sk.N.BitLen() > maxRsaKeyBits {",
          "131:   return nil, ErrRsaKeyTooBig",
          "132:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "141:  if pk.N.BitLen() < MinRsaKeyBits {",
          "142:   return nil, ErrRsaKeyTooSmall",
          "143:  }",
          "145:  return &RsaPublicKey{k: *pk}, nil",
          "146: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  if pk.N.BitLen() > maxRsaKeyBits {",
          "151:   return nil, ErrRsaKeyTooBig",
          "152:  }",
          "",
          "---------------"
        ],
        "core/crypto/rsa_test.go||core/crypto/rsa_test.go": [
          "File: core/crypto/rsa_test.go -> core/crypto/rsa_test.go",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:  }",
          "69: }",
          "71: func TestRSASignZero(t *testing.T) {",
          "72:  priv, pub, err := GenerateRSAKeyPair(2048, rand.Reader)",
          "73:  if err != nil {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: func TestRSABigKeyFailsToGenerate(t *testing.T) {",
          "72:  _, _, err := GenerateRSAKeyPair(maxRsaKeyBits*2, rand.Reader)",
          "73:  if err != ErrRsaKeyTooBig {",
          "74:   t.Fatal(\"should have refused to create too big RSA key\")",
          "75:  }",
          "76: }",
          "78: func TestRSABigKey(t *testing.T) {",
          "81:  origSize := maxRsaKeyBits",
          "82:  maxRsaKeyBits = 2048",
          "83:  defer func() { maxRsaKeyBits = origSize }() //",
          "85:  maxRsaKeyBits *= 2",
          "86:  badPriv, badPub, err := GenerateRSAKeyPair(maxRsaKeyBits, rand.Reader)",
          "87:  if err != nil {",
          "88:   t.Fatalf(\"should have succeeded, got: %s\", err)",
          "89:  }",
          "90:  pubBytes, err := MarshalPublicKey(badPub)",
          "91:  if err != nil {",
          "92:   t.Fatal(err)",
          "93:  }",
          "94:  privBytes, err := MarshalPrivateKey(badPriv)",
          "95:  if err != nil {",
          "96:   t.Fatal(err)",
          "97:  }",
          "98:  maxRsaKeyBits /= 2",
          "99:  _, err = UnmarshalPublicKey(pubBytes)",
          "100:  if err != ErrRsaKeyTooBig {",
          "101:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "102:  }",
          "103:  _, err = UnmarshalPrivateKey(privBytes)",
          "104:  if err != ErrRsaKeyTooBig {",
          "105:   t.Fatal(\"should have refused to unmarshal a too big key\")",
          "106:  }",
          "107: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}