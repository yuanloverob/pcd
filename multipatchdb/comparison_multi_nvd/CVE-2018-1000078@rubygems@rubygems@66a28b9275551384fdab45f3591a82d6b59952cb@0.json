{
  "cve_id": "CVE-2018-1000078",
  "cve_desc": "RubyGems version Ruby 2.2 series: 2.2.9 and earlier, Ruby 2.3 series: 2.3.6 and earlier, Ruby 2.4 series: 2.4.3 and earlier, Ruby 2.5 series: 2.5.0 and earlier, prior to trunk revision 62422 contains a Cross Site Scripting (XSS) vulnerability in gem server display of homepage attribute that can result in XSS. This attack appear to be exploitable via the victim must browse to a malicious gem on a vulnerable gem server. This vulnerability appears to have been fixed in 2.7.6.",
  "repo": "rubygems/rubygems",
  "patch_hash": "66a28b9275551384fdab45f3591a82d6b59952cb",
  "patch_info": {
    "commit_hash": "66a28b9275551384fdab45f3591a82d6b59952cb",
    "repo": "rubygems/rubygems",
    "commit_url": "https://github.com/rubygems/rubygems/commit/66a28b9275551384fdab45f3591a82d6b59952cb",
    "files": [
      "lib/rubygems/server.rb"
    ],
    "message": "Fix 289313",
    "before_after_code_files": [
      "lib/rubygems/server.rb||lib/rubygems/server.rb"
    ]
  },
  "patch_diff": {
    "lib/rubygems/server.rb||lib/rubygems/server.rb": [
      "File: lib/rubygems/server.rb -> lib/rubygems/server.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "632:         \"only_one_executable\" => (executables && executables.size == 1),",
      "633:         \"full_name\"           => spec.full_name,",
      "634:         \"has_deps\"            => !deps.empty?,",
      "636:         \"name\"                => spec.name,",
      "637:         \"rdoc_installed\"      => Gem::RDoc.new(spec).rdoc_installed?,",
      "638:         \"ri_installed\"        => Gem::RDoc.new(spec).ri_installed?,",
      "",
      "[Removed Lines]",
      "635:         \"homepage\"            => spec.homepage,",
      "",
      "[Added Lines]",
      "635:         \"homepage\"            => (URI.parse(spec.homepage).is_a?(URI::HTTP) || URI.parse(spec.homepage).is_a?(URI::HTTPS)) ? spec.homepage : \".\",",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "91ae1d2f1a913581200abf7b042c58bba5b88b24",
      "candidate_info": {
        "commit_hash": "91ae1d2f1a913581200abf7b042c58bba5b88b24",
        "repo": "rubygems/rubygems",
        "commit_url": "https://github.com/rubygems/rubygems/commit/91ae1d2f1a913581200abf7b042c58bba5b88b24",
        "files": [
          "lib/rubygems/server.rb",
          "test/rubygems/test_gem_server.rb"
        ],
        "message": "Add tests to validate spec.homepage setting behavior when rendered in gem server",
        "before_after_code_files": [
          "lib/rubygems/server.rb||lib/rubygems/server.rb",
          "test/rubygems/test_gem_server.rb||test/rubygems/test_gem_server.rb"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/rubygems/server.rb||lib/rubygems/server.rb"
          ],
          "candidate": [
            "lib/rubygems/server.rb||lib/rubygems/server.rb"
          ]
        }
      },
      "candidate_diff": {
        "lib/rubygems/server.rb||lib/rubygems/server.rb": [
          "File: lib/rubygems/server.rb -> lib/rubygems/server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "623:       executables = nil if executables.empty?",
          "624:       executables.last[\"is_last\"] = true if executables",
          "626:       specs << {",
          "627:         \"authors\"             => spec.authors.sort.join(\", \"),",
          "628:         \"date\"                => spec.date.to_s,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "626:       # Pre-process spec homepage for safety reasons",
          "627:       begin",
          "628:         homepage_uri = URI.parse(spec.homepage)",
          "629:         if [URI::HTTP, URI::HTTPS].member? homepage_uri.class",
          "630:           homepage_uri = spec.homepage",
          "631:         else",
          "632:           homepage_uri = \".\"",
          "633:         end",
          "634:       rescue URI::InvalidURIError",
          "635:         homepage_uri = \".\"",
          "636:       end",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "632:         \"only_one_executable\" => (executables && executables.size == 1),",
          "633:         \"full_name\"           => spec.full_name,",
          "634:         \"has_deps\"            => !deps.empty?,",
          "636:         \"name\"                => spec.name,",
          "637:         \"rdoc_installed\"      => Gem::RDoc.new(spec).rdoc_installed?,",
          "638:         \"ri_installed\"        => Gem::RDoc.new(spec).ri_installed?,",
          "",
          "[Removed Lines]",
          "635:         \"homepage\"            => (URI.parse(spec.homepage).is_a?(URI::HTTP) || URI.parse(spec.homepage).is_a?(URI::HTTPS)) ? spec.homepage : \".\",",
          "",
          "[Added Lines]",
          "647:         \"homepage\"            => homepage_uri,",
          "",
          "---------------"
        ],
        "test/rubygems/test_gem_server.rb||test/rubygems/test_gem_server.rb": [
          "File: test/rubygems/test_gem_server.rb -> test/rubygems/test_gem_server.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "353:     assert_match 'z 9', @res.body",
          "354:   end",
          "356:   def test_specs",
          "357:     data = StringIO.new \"GET /specs.#{Gem.marshal_version} HTTP/1.0\\r\\n\\r\\n\"",
          "358:     @req.parse data",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "357:   def test_xss_homepage_fix_289313",
          "358:     data = StringIO.new \"GET / HTTP/1.0\\r\\n\\r\\n\"",
          "359:     dir = \"#{@gemhome}2\"",
          "361:     spec = util_spec 'xsshomepagegem', 1",
          "362:     spec.homepage = \"javascript:confirm(document.domain)\"",
          "364:     specs_dir = File.join dir, 'specifications'",
          "365:     FileUtils.mkdir_p specs_dir",
          "367:     open File.join(specs_dir, spec.spec_name), 'w' do |io|",
          "368:       io.write spec.to_ruby",
          "369:     end",
          "371:     server = Gem::Server.new dir, process_based_port, false",
          "373:     @req.parse data",
          "375:     server.root @req, @res",
          "377:     assert_equal 200, @res.status",
          "378:     assert_match 'xsshomepagegem 1', @res.body",
          "380:     # This verifies that the homepage for this spec is not displayed and is set to \".\", because it's not a",
          "381:     # valid HTTP/HTTPS URL and could be unsafe in an HTML context.  We would prefer to throw an exception here,",
          "382:     # but spec.homepage is currently free form and not currently required to be a URL, this behavior may be",
          "383:     # validated in future versions of Gem::Specification.",
          "384:     #",
          "385:     # There are two variant we're checking here, one where rdoc is not present, and one where rdoc is present in the same regex:",
          "386:     #",
          "387:     # Variant #1 - rdoc not installed",
          "388:     #",
          "389:     #   <b>xsshomepagegem 1</b>",
          "390:     #",
          "391:     #",
          "392:     #  <span title=\"rdoc not installed\">[rdoc]</span>",
          "393:     #",
          "394:     #",
          "395:     #",
          "396:     #  <a href=\".\" title=\".\">[www]</a>",
          "397:     #",
          "398:     # Variant #2 - rdoc installed",
          "399:     #",
          "400:     #   <b>xsshomepagegem 1</b>",
          "401:     #",
          "402:     #",
          "403:     #  <a href=\"\\/doc_root\\/xsshomepagegem-1\\/\">\\[rdoc\\]<\\/a>",
          "404:     #",
          "405:     #",
          "406:     #",
          "407:     #  <a href=\".\" title=\".\">[www]</a>",
          "408:     regex_match = /xsshomepagegem 1<\\/b>[\\n\\s]+(<span title=\"rdoc not installed\">\\[rdoc\\]<\\/span>|<a href=\"\\/doc_root\\/xsshomepagegem-1\\/\">\\[rdoc\\]<\\/a>)[\\n\\s]+<a href=\"\\.\" title=\"\\.\">\\[www\\]<\\/a>/",
          "409:     assert_match regex_match, @res.body",
          "410:   end",
          "412:   def test_invalid_homepage",
          "413:     data = StringIO.new \"GET / HTTP/1.0\\r\\n\\r\\n\"",
          "414:     dir = \"#{@gemhome}2\"",
          "416:     spec = util_spec 'invalidhomepagegem', 1",
          "417:     spec.homepage = \"notavalidhomepageurl\"",
          "419:     specs_dir = File.join dir, 'specifications'",
          "420:     FileUtils.mkdir_p specs_dir",
          "422:     open File.join(specs_dir, spec.spec_name), 'w' do |io|",
          "423:       io.write spec.to_ruby",
          "424:     end",
          "426:     server = Gem::Server.new dir, process_based_port, false",
          "428:     @req.parse data",
          "430:     server.root @req, @res",
          "432:     assert_equal 200, @res.status",
          "433:     assert_match 'invalidhomepagegem 1', @res.body",
          "435:     # This verifies that the homepage for this spec is not displayed and is set to \".\", because it's not a",
          "436:     # valid HTTP/HTTPS URL and could be unsafe in an HTML context.  We would prefer to throw an exception here,",
          "437:     # but spec.homepage is currently free form and not currently required to be a URL, this behavior may be",
          "438:     # validated in future versions of Gem::Specification.",
          "439:     #",
          "440:     # There are two variant we're checking here, one where rdoc is not present, and one where rdoc is present in the same regex:",
          "441:     #",
          "442:     # Variant #1 - rdoc not installed",
          "443:     #",
          "444:     #   <b>invalidhomepagegem 1</b>",
          "445:     #",
          "446:     #",
          "447:     #  <span title=\"rdoc not installed\">[rdoc]</span>",
          "448:     #",
          "449:     #",
          "450:     #",
          "451:     #  <a href=\".\" title=\".\">[www]</a>",
          "452:     #",
          "453:     # Variant #2 - rdoc installed",
          "454:     #",
          "455:     #   <b>invalidhomepagegem 1</b>",
          "456:     #",
          "457:     #",
          "458:     #  <a href=\"\\/doc_root\\/invalidhomepagegem-1\\/\">\\[rdoc\\]<\\/a>",
          "459:     #",
          "460:     #",
          "461:     #",
          "462:     #  <a href=\".\" title=\".\">[www]</a>",
          "463:     regex_match = /invalidhomepagegem 1<\\/b>[\\n\\s]+(<span title=\"rdoc not installed\">\\[rdoc\\]<\\/span>|<a href=\"\\/doc_root\\/invalidhomepagegem-1\\/\">\\[rdoc\\]<\\/a>)[\\n\\s]+<a href=\"\\.\" title=\"\\.\">\\[www\\]<\\/a>/",
          "464:     assert_match regex_match, @res.body",
          "465:   end",
          "467:   def test_valid_homepage_http",
          "468:     data = StringIO.new \"GET / HTTP/1.0\\r\\n\\r\\n\"",
          "469:     dir = \"#{@gemhome}2\"",
          "471:     spec = util_spec 'validhomepagegemhttp', 1",
          "472:     spec.homepage = \"http://rubygems.org\"",
          "474:     specs_dir = File.join dir, 'specifications'",
          "475:     FileUtils.mkdir_p specs_dir",
          "477:     open File.join(specs_dir, spec.spec_name), 'w' do |io|",
          "478:       io.write spec.to_ruby",
          "479:     end",
          "481:     server = Gem::Server.new dir, process_based_port, false",
          "483:     @req.parse data",
          "485:     server.root @req, @res",
          "487:     assert_equal 200, @res.status",
          "488:     assert_match 'validhomepagegemhttp 1', @res.body",
          "490:     regex_match = /validhomepagegemhttp 1<\\/b>[\\n\\s]+(<span title=\"rdoc not installed\">\\[rdoc\\]<\\/span>|<a href=\"\\/doc_root\\/validhomepagegemhttp-1\\/\">\\[rdoc\\]<\\/a>)[\\n\\s]+<a href=\"http:\\/\\/rubygems\\.org\" title=\"http:\\/\\/rubygems\\.org\">\\[www\\]<\\/a>/",
          "491:     assert_match regex_match, @res.body",
          "492:   end",
          "494:   def test_valid_homepage_https",
          "495:     data = StringIO.new \"GET / HTTP/1.0\\r\\n\\r\\n\"",
          "496:     dir = \"#{@gemhome}2\"",
          "498:     spec = util_spec 'validhomepagegemhttps', 1",
          "499:     spec.homepage = \"https://rubygems.org\"",
          "501:     specs_dir = File.join dir, 'specifications'",
          "502:     FileUtils.mkdir_p specs_dir",
          "504:     open File.join(specs_dir, spec.spec_name), 'w' do |io|",
          "505:       io.write spec.to_ruby",
          "506:     end",
          "508:     server = Gem::Server.new dir, process_based_port, false",
          "510:     @req.parse data",
          "512:     server.root @req, @res",
          "514:     assert_equal 200, @res.status",
          "515:     assert_match 'validhomepagegemhttps 1', @res.body",
          "517:     regex_match = /validhomepagegemhttps 1<\\/b>[\\n\\s]+(<span title=\"rdoc not installed\">\\[rdoc\\]<\\/span>|<a href=\"\\/doc_root\\/validhomepagegemhttps-1\\/\">\\[rdoc\\]<\\/a>)[\\n\\s]+<a href=\"https:\\/\\/rubygems\\.org\" title=\"https:\\/\\/rubygems\\.org\">\\[www\\]<\\/a>/",
          "518:     assert_match regex_match, @res.body",
          "519:   end",
          "",
          "---------------"
        ]
      }
    }
  ]
}