{
  "cve_id": "CVE-2023-22487",
  "cve_desc": "Flarum is a forum software for building communities. Using the mentions feature provided by the flarum/mentions extension, users can mention any post ID on the forum with the special `@\"<username>\"#p<id>` syntax. The following behavior never changes no matter if the actor should be able to read the mentioned post or not: A URL to the mentioned post is inserted into the actor post HTML, leaking its discussion ID and post number. The `mentionsPosts` relationship included in the `POST /api/posts` and `PATCH /api/posts/<id>` JSON responses leaks the full JSON:API payload of all mentioned posts without any access control. This includes the content, date, number and attributes added by other extensions. An attacker only needs the ability to create new posts on the forum to exploit the vulnerability. This works even if new posts require approval. If they have the ability to edit posts, the attack can be performed even more discreetly by using a single post to scan any size of database and hiding the attack post content afterward. The attack allows the leaking of all posts in the forum database, including posts awaiting approval, posts in tags the user has no access to, and private discussions created by other extensions like FriendsOfFlarum Byobu. This also includes non-comment posts like tag changes or renaming events. The discussion payload is not leaked but using the mention HTML payload it's possible to extract the discussion ID of all posts and combine all posts back together into their original discussions even if the discussion title remains unknown. All Flarum versions prior to 1.6.3 are affected. The vulnerability has been fixed and published as flarum/core v1.6.3. As a workaround, user can disable the mentions extension.",
  "repo": "flarum/framework",
  "patch_hash": "ab1c868b978e8b0d09a5d682c54665dae17d0985",
  "patch_info": {
    "commit_hash": "ab1c868b978e8b0d09a5d682c54665dae17d0985",
    "repo": "flarum/framework",
    "commit_url": "https://github.com/flarum/framework/commit/ab1c868b978e8b0d09a5d682c54665dae17d0985",
    "files": [
      "extensions/mentions/composer.json",
      "extensions/mentions/extend.php",
      "extensions/mentions/src/ConfigureMentions.php",
      "extensions/mentions/tests/integration/api/PostMentionsTest.php",
      "framework/core/src/Formatter/Formatter.php",
      "framework/core/src/Post/PostRepository.php"
    ],
    "message": "Merge pull request from GHSA-22m9-m3ww-53h3\n\n* fix: check post visibility when mentioning\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\n* fix: `mentionsPosts` include is not used and leaks private posts\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\n* chre: use `PostRepository`\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>",
    "before_after_code_files": [
      "extensions/mentions/extend.php||extensions/mentions/extend.php",
      "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php",
      "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php",
      "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php",
      "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php"
    ]
  },
  "patch_diff": {
    "extensions/mentions/extend.php||extensions/mentions/extend.php": [
      "File: extensions/mentions/extend.php -> extensions/mentions/extend.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "91:         ]),",
      "93:     (new Extend\\ApiController(Controller\\CreatePostController::class))",
      "95:         ->addOptionalInclude('mentionsGroups'),",
      "97:     (new Extend\\ApiController(Controller\\UpdatePostController::class))",
      "99:         ->addOptionalInclude('mentionsGroups'),",
      "101:     (new Extend\\ApiController(Controller\\AbstractSerializeController::class))",
      "",
      "[Removed Lines]",
      "94:         ->addInclude(['mentionsPosts', 'mentionsPosts.mentionedBy'])",
      "98:         ->addInclude(['mentionsPosts', 'mentionsPosts.mentionedBy'])",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php": [
      "File: extensions/mentions/src/ConfigureMentions.php -> extensions/mentions/src/ConfigureMentions.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "12: use Flarum\\Group\\Group;",
      "13: use Flarum\\Http\\UrlGenerator;",
      "14: use Flarum\\Post\\CommentPost;",
      "15: use Flarum\\Settings\\SettingsRepositoryInterface;",
      "16: use Flarum\\User\\User;",
      "17: use Illuminate\\Support\\Str;",
      "18: use s9e\\TextFormatter\\Configurator;",
      "20: class ConfigureMentions",
      "21: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "15: use Flarum\\Post\\PostRepository;",
      "20: use s9e\\TextFormatter\\Parser;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "116:         $tag->filterChain",
      "117:             ->prepend([static::class, 'addPostId'])",
      "120:         $config->Preg->match('/\\B@[\"|\u201c](?<displayname>((?!\"#[a-z]{0,3}[0-9]+).)+)[\"|\u201d]#p(?<id>[0-9]+)\\b/', $tagName);",
      "121:     }",
      "",
      "[Removed Lines]",
      "118:             ->setJS('function(tag) { return flarum.extensions[\"flarum-mentions\"].filterPostMentions(tag); }');",
      "",
      "[Added Lines]",
      "120:             ->setJS('function(tag) { return flarum.extensions[\"flarum-mentions\"].filterPostMentions(tag); }')",
      "121:             ->addParameterByName('actor');",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "128:     {",
      "131:         if ($post) {",
      "132:             $tag->setAttribute('discussionid', (int) $post->discussion_id);",
      "",
      "[Removed Lines]",
      "127:     public static function addPostId($tag)",
      "129:         $post = CommentPost::find($tag->getAttribute('id'));",
      "",
      "[Added Lines]",
      "130:     public static function addPostId($tag, User $actor)",
      "132:         $post = resolve(PostRepository::class)",
      "133:             ->queryVisibleTo($actor)",
      "134:             ->find($tag->getAttribute('id'));",
      "",
      "---------------"
    ],
    "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php": [
      "File: extensions/mentions/tests/integration/api/PostMentionsTest.php -> extensions/mentions/tests/integration/api/PostMentionsTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "38:             ],",
      "39:             'discussions' => [",
      "40:                 ['id' => 2, 'title' => __CLASS__, 'created_at' => Carbon::now(), 'last_posted_at' => Carbon::now(), 'user_id' => 3, 'first_post_id' => 4, 'comment_count' => 2],",
      "41:             ],",
      "42:             'posts' => [",
      "43:                 ['id' => 4, 'number' => 2, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 3, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"TobyFlarum___\" id=\"5\" number=\"2\" discussionid=\"2\" username=\"toby\">@tobyuuu#5</POSTMENTION></r>'],",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "41:                 ['id' => 50, 'title' => __CLASS__, 'is_private' => true, 'created_at' => Carbon::now(), 'last_posted_at' => Carbon::now(), 'user_id' => 3, 'first_post_id' => 4, 'comment_count' => 1],",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "49:                 ['id' => 10, 'number' => 11, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 4, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"Bad &quot;#p6 User\" id=\"9\" number=\"10\" discussionid=\"2\">@\"Bad \"#p6 User\"#p9</POSTMENTION></r>'],",
      "50:                 ['id' => 11, 'number' => 12, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 40, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"Bad &quot;#p6 User\" id=\"9\" number=\"10\" discussionid=\"2\">@\"Bad \"#p6 User\"#p9</POSTMENTION></r>'],",
      "51:                 ['id' => 12, 'number' => 13, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 4, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"deleted_user\" id=\"11\" number=\"12\" discussionid=\"2\">@\"acme\"#p11</POSTMENTION></r>'],",
      "52:             ],",
      "53:             'post_mentions_post' => [",
      "54:                 ['post_id' => 4, 'mentions_post_id' => 5],",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "55:                 ['id' => 50, 'number' => 1, 'discussion_id' => 50, 'created_at' => Carbon::now(), 'user_id' => 3, 'type' => 'comment', 'content' => '<r>no</r>'],",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "128:         $this->assertNotNull(CommentPost::find($response['data']['id'])->mentionsPosts->find(4));",
      "129:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "138:     public function cannot_mention_a_post_without_access()",
      "139:     {",
      "140:         $response = $this->send(",
      "141:             $this->request('POST', '/api/posts', [",
      "142:                 'authenticatedAs' => 1,",
      "143:                 'json' => [",
      "144:                     'data' => [",
      "145:                         'attributes' => [",
      "146:                             'content' => '@\"potato\"#p50',",
      "147:                         ],",
      "148:                         'relationships' => [",
      "149:                             'discussion' => ['data' => ['id' => 2]],",
      "150:                         ],",
      "151:                     ],",
      "152:                 ],",
      "153:             ])",
      "154:         );",
      "156:         $this->assertEquals(201, $response->getStatusCode());",
      "158:         $response = json_decode($response->getBody(), true);",
      "160:         $this->assertStringContainsString('potato', $response['data']['attributes']['contentHtml']);",
      "161:         $this->assertEquals('@\"potato\"#p50', $response['data']['attributes']['content']);",
      "162:         $this->assertStringNotContainsString('PostMention', $response['data']['attributes']['contentHtml']);",
      "163:         $this->assertNull(CommentPost::find($response['data']['id'])->mentionsPosts->find(50));",
      "164:     }",
      "",
      "---------------"
    ],
    "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php": [
      "File: framework/core/src/Formatter/Formatter.php -> framework/core/src/Formatter/Formatter.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "91:     {",
      "92:         $parser = $this->getParser($context);",
      "94:         foreach ($this->parsingCallbacks as $callback) {",
      "95:             $text = $callback($parser, $context, $text, $user);",
      "96:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "99:         $parser->registeredVars['actor'] = $user;",
      "",
      "---------------"
    ],
    "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php": [
      "File: framework/core/src/Post/PostRepository.php -> framework/core/src/Post/PostRepository.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "33:     {",
      "34:         $query = $this->query();",
      "",
      "[Removed Lines]",
      "32:     protected function queryVisibleTo(User $user = null)",
      "",
      "[Added Lines]",
      "32:     public function queryVisibleTo(User $user = null)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "132fdea659754ef57b7e3eb4b28c957cca06c9c5",
      "candidate_info": {
        "commit_hash": "132fdea659754ef57b7e3eb4b28c957cca06c9c5",
        "repo": "flarum/framework",
        "commit_url": "https://github.com/flarum/framework/commit/132fdea659754ef57b7e3eb4b28c957cca06c9c5",
        "files": [
          "extensions/mentions/composer.json",
          "extensions/mentions/extend.php",
          "extensions/mentions/src/ConfigureMentions.php",
          "extensions/mentions/tests/integration/api/PostMentionsTest.php",
          "framework/core/src/Formatter/Formatter.php",
          "framework/core/src/Post/PostRepository.php"
        ],
        "message": "Merge pull request from GHSA-22m9-m3ww-53h3\n\n* fix: check post visibility when mentioning\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\n* fix: `mentionsPosts` include is not used and leaks private posts\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\n* chre: use `PostRepository`\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>\n\nSigned-off-by: Sami Mazouz <sychocouldy@gmail.com>",
        "before_after_code_files": [
          "extensions/mentions/extend.php||extensions/mentions/extend.php",
          "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php",
          "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php",
          "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php",
          "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "extensions/mentions/extend.php||extensions/mentions/extend.php",
            "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php",
            "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php",
            "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php",
            "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php"
          ],
          "candidate": [
            "extensions/mentions/extend.php||extensions/mentions/extend.php",
            "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php",
            "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php",
            "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php",
            "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php"
          ]
        }
      },
      "candidate_diff": {
        "extensions/mentions/extend.php||extensions/mentions/extend.php": [
          "File: extensions/mentions/extend.php -> extensions/mentions/extend.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:         ]),",
          "93:     (new Extend\\ApiController(Controller\\CreatePostController::class))",
          "95:         ->addOptionalInclude('mentionsGroups'),",
          "97:     (new Extend\\ApiController(Controller\\UpdatePostController::class))",
          "99:         ->addOptionalInclude('mentionsGroups'),",
          "101:     (new Extend\\ApiController(Controller\\AbstractSerializeController::class))",
          "",
          "[Removed Lines]",
          "94:         ->addInclude(['mentionsPosts', 'mentionsPosts.mentionedBy'])",
          "98:         ->addInclude(['mentionsPosts', 'mentionsPosts.mentionedBy'])",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "extensions/mentions/src/ConfigureMentions.php||extensions/mentions/src/ConfigureMentions.php": [
          "File: extensions/mentions/src/ConfigureMentions.php -> extensions/mentions/src/ConfigureMentions.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "12: use Flarum\\Group\\Group;",
          "13: use Flarum\\Http\\UrlGenerator;",
          "14: use Flarum\\Post\\CommentPost;",
          "15: use Flarum\\Settings\\SettingsRepositoryInterface;",
          "16: use Flarum\\User\\User;",
          "17: use Illuminate\\Support\\Str;",
          "18: use s9e\\TextFormatter\\Configurator;",
          "20: class ConfigureMentions",
          "21: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: use Flarum\\Post\\PostRepository;",
          "20: use s9e\\TextFormatter\\Parser;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "116:         $tag->filterChain",
          "117:             ->prepend([static::class, 'addPostId'])",
          "120:         $config->Preg->match('/\\B@[\"|\u201c](?<displayname>((?!\"#[a-z]{0,3}[0-9]+).)+)[\"|\u201d]#p(?<id>[0-9]+)\\b/', $tagName);",
          "121:     }",
          "",
          "[Removed Lines]",
          "118:             ->setJS('function(tag) { return flarum.extensions[\"flarum-mentions\"].filterPostMentions(tag); }');",
          "",
          "[Added Lines]",
          "120:             ->setJS('function(tag) { return flarum.extensions[\"flarum-mentions\"].filterPostMentions(tag); }')",
          "121:             ->addParameterByName('actor');",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "128:     {",
          "131:         if ($post) {",
          "132:             $tag->setAttribute('discussionid', (int) $post->discussion_id);",
          "",
          "[Removed Lines]",
          "127:     public static function addPostId($tag)",
          "129:         $post = CommentPost::find($tag->getAttribute('id'));",
          "",
          "[Added Lines]",
          "130:     public static function addPostId($tag, User $actor)",
          "132:         $post = resolve(PostRepository::class)",
          "133:             ->queryVisibleTo($actor)",
          "134:             ->find($tag->getAttribute('id'));",
          "",
          "---------------"
        ],
        "extensions/mentions/tests/integration/api/PostMentionsTest.php||extensions/mentions/tests/integration/api/PostMentionsTest.php": [
          "File: extensions/mentions/tests/integration/api/PostMentionsTest.php -> extensions/mentions/tests/integration/api/PostMentionsTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:             ],",
          "39:             'discussions' => [",
          "40:                 ['id' => 2, 'title' => __CLASS__, 'created_at' => Carbon::now(), 'last_posted_at' => Carbon::now(), 'user_id' => 3, 'first_post_id' => 4, 'comment_count' => 2],",
          "41:             ],",
          "42:             'posts' => [",
          "43:                 ['id' => 4, 'number' => 2, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 3, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"TobyFlarum___\" id=\"5\" number=\"2\" discussionid=\"2\" username=\"toby\">@tobyuuu#5</POSTMENTION></r>'],",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "41:                 ['id' => 50, 'title' => __CLASS__, 'is_private' => true, 'created_at' => Carbon::now(), 'last_posted_at' => Carbon::now(), 'user_id' => 3, 'first_post_id' => 4, 'comment_count' => 1],",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "49:                 ['id' => 10, 'number' => 11, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 4, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"Bad &quot;#p6 User\" id=\"9\" number=\"10\" discussionid=\"2\">@\"Bad \"#p6 User\"#p9</POSTMENTION></r>'],",
          "50:                 ['id' => 11, 'number' => 12, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 40, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"Bad &quot;#p6 User\" id=\"9\" number=\"10\" discussionid=\"2\">@\"Bad \"#p6 User\"#p9</POSTMENTION></r>'],",
          "51:                 ['id' => 12, 'number' => 13, 'discussion_id' => 2, 'created_at' => Carbon::now(), 'user_id' => 4, 'type' => 'comment', 'content' => '<r><POSTMENTION displayname=\"deleted_user\" id=\"11\" number=\"12\" discussionid=\"2\">@\"acme\"#p11</POSTMENTION></r>'],",
          "52:             ],",
          "53:             'post_mentions_post' => [",
          "54:                 ['post_id' => 4, 'mentions_post_id' => 5],",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:                 ['id' => 50, 'number' => 1, 'discussion_id' => 50, 'created_at' => Carbon::now(), 'user_id' => 3, 'type' => 'comment', 'content' => '<r>no</r>'],",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "128:         $this->assertNotNull(CommentPost::find($response['data']['id'])->mentionsPosts->find(4));",
          "129:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "138:     public function cannot_mention_a_post_without_access()",
          "139:     {",
          "140:         $response = $this->send(",
          "141:             $this->request('POST', '/api/posts', [",
          "142:                 'authenticatedAs' => 1,",
          "143:                 'json' => [",
          "144:                     'data' => [",
          "145:                         'attributes' => [",
          "146:                             'content' => '@\"potato\"#p50',",
          "147:                         ],",
          "148:                         'relationships' => [",
          "149:                             'discussion' => ['data' => ['id' => 2]],",
          "150:                         ],",
          "151:                     ],",
          "152:                 ],",
          "153:             ])",
          "154:         );",
          "156:         $this->assertEquals(201, $response->getStatusCode());",
          "158:         $response = json_decode($response->getBody(), true);",
          "160:         $this->assertStringContainsString('potato', $response['data']['attributes']['contentHtml']);",
          "161:         $this->assertEquals('@\"potato\"#p50', $response['data']['attributes']['content']);",
          "162:         $this->assertStringNotContainsString('PostMention', $response['data']['attributes']['contentHtml']);",
          "163:         $this->assertNull(CommentPost::find($response['data']['id'])->mentionsPosts->find(50));",
          "164:     }",
          "",
          "---------------"
        ],
        "framework/core/src/Formatter/Formatter.php||framework/core/src/Formatter/Formatter.php": [
          "File: framework/core/src/Formatter/Formatter.php -> framework/core/src/Formatter/Formatter.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:     {",
          "92:         $parser = $this->getParser($context);",
          "94:         foreach ($this->parsingCallbacks as $callback) {",
          "95:             $text = $callback($parser, $context, $text, $user);",
          "96:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99:         $parser->registeredVars['actor'] = $user;",
          "",
          "---------------"
        ],
        "framework/core/src/Post/PostRepository.php||framework/core/src/Post/PostRepository.php": [
          "File: framework/core/src/Post/PostRepository.php -> framework/core/src/Post/PostRepository.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "33:     {",
          "34:         $query = $this->query();",
          "",
          "[Removed Lines]",
          "32:     protected function queryVisibleTo(User $user = null)",
          "",
          "[Added Lines]",
          "32:     public function queryVisibleTo(User $user = null)",
          "",
          "---------------"
        ]
      }
    }
  ]
}