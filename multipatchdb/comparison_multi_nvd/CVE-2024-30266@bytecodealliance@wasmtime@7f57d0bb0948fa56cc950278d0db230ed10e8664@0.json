{
  "cve_id": "CVE-2024-30266",
  "cve_desc": "wasmtime is a runtime for WebAssembly. The 19.0.0 release of Wasmtime contains a regression introduced during its development which can lead to a guest WebAssembly module causing a panic in the host runtime. A valid WebAssembly module, when executed at runtime, may cause this panic. This vulnerability has been patched in version 19.0.1.",
  "repo": "bytecodealliance/wasmtime",
  "patch_hash": "7f57d0bb0948fa56cc950278d0db230ed10e8664",
  "patch_info": {
    "commit_hash": "7f57d0bb0948fa56cc950278d0db230ed10e8664",
    "repo": "bytecodealliance/wasmtime",
    "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/7f57d0bb0948fa56cc950278d0db230ed10e8664",
    "files": [
      "crates/runtime/src/instance.rs",
      "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
    ],
    "message": "Fix a panic using tables with the wrong type (#8283)\n\nThis commit fixes an accidental issue introduced in #8018 where using an\nelement segment which had been dropped with an `externref` table would\ncause a panic. The panic happened due to an assertion that tables are\nbeing used with the right type of item and that was being mismatched.\nThe underlying issue was that dropped element segments are modeled as an\nempty element segment but the empty element segment was using the\n\"functions\" encoding as opposed to the \"expressions\" encoding. This\nmeant that code later assumed that due to the use of functions the table\nmust be a table-of-functions, but this was not correct for\nexternref-based tables.\n\nThe fix in this commit is to instead model the encoding as an\n\"expressions\" list which means that the table type is dispatched on to\ncall the appropriate initializer.\n\nThere is no memory safety issue with this mistake as the assertion was\nspecifically targetted at preventing memory safety. This does, however,\nenable any WebAssembly module to panic a host.\n\nCloses #8281",
    "before_after_code_files": [
      "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
      "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
    ]
  },
  "patch_diff": {
    "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
      "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
      "--- Hunk 1 ---",
      "[Context before]",
      "802:         let module = self.module().clone();",
      "805:         let elements = match module.passive_elements_map.get(&elem_index) {",
      "806:             Some(index) if !self.dropped_elements.contains(elem_index) => {",
      "807:                 &module.passive_elements[*index]",
      "",
      "[Removed Lines]",
      "804:         let empty = TableSegmentElements::Functions(Box::new([]));",
      "",
      "[Added Lines]",
      "808:         let empty = TableSegmentElements::Expressions(Box::new([]));",
      "",
      "---------------"
    ],
    "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast": [
      "File: tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast -> tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: (module",
      "2:   (table $t 0 0 externref)",
      "4:   (func (export \"f1\")",
      "5:     (i32.const 0)",
      "6:     (i32.const 0)",
      "7:     (i32.const 0)",
      "8:     (table.init $t $declared)",
      "9:   )",
      "11:   (func (export \"f2\")",
      "12:     (i32.const 0)",
      "13:     (i32.const 0)",
      "14:     (i32.const 0)",
      "15:     (table.init $t $passive)",
      "17:     (elem.drop $passive)",
      "19:     (i32.const 0)",
      "20:     (i32.const 0)",
      "21:     (i32.const 0)",
      "22:     (table.init $t $passive)",
      "23:   )",
      "25:   (func (export \"f3\")",
      "26:     (i32.const 0)",
      "27:     (i32.const 0)",
      "28:     (i32.const 0)",
      "29:     (table.init $t $active)",
      "30:   )",
      "32:   (elem $declared declare externref)",
      "33:   (elem $passive externref)",
      "34:   (elem $active (i32.const 0) externref)",
      "35: )",
      "37: (assert_return (invoke \"f1\"))",
      "38: (assert_return (invoke \"f2\"))",
      "39: (assert_return (invoke \"f3\"))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "24f7f40f5ec5f96722e97abe4090195a0afa59d2",
      "candidate_info": {
        "commit_hash": "24f7f40f5ec5f96722e97abe4090195a0afa59d2",
        "repo": "bytecodealliance/wasmtime",
        "commit_url": "https://github.com/bytecodealliance/wasmtime/commit/24f7f40f5ec5f96722e97abe4090195a0afa59d2",
        "files": [
          "crates/runtime/src/instance.rs",
          "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
        ],
        "message": "Fix a panic using tables with the wrong type (#8283) (#8284)\n\nThis commit fixes an accidental issue introduced in #8018 where using an\nelement segment which had been dropped with an `externref` table would\ncause a panic. The panic happened due to an assertion that tables are\nbeing used with the right type of item and that was being mismatched.\nThe underlying issue was that dropped element segments are modeled as an\nempty element segment but the empty element segment was using the\n\"functions\" encoding as opposed to the \"expressions\" encoding. This\nmeant that code later assumed that due to the use of functions the table\nmust be a table-of-functions, but this was not correct for\nexternref-based tables.\n\nThe fix in this commit is to instead model the encoding as an\n\"expressions\" list which means that the table type is dispatched on to\ncall the appropriate initializer.\n\nThere is no memory safety issue with this mistake as the assertion was\nspecifically targetted at preventing memory safety. This does, however,\nenable any WebAssembly module to panic a host.\n\nCloses #8281",
        "before_after_code_files": [
          "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
          "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
          ],
          "candidate": [
            "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs",
            "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast"
          ]
        }
      },
      "candidate_diff": {
        "crates/runtime/src/instance.rs||crates/runtime/src/instance.rs": [
          "File: crates/runtime/src/instance.rs -> crates/runtime/src/instance.rs",
          "--- Hunk 1 ---",
          "[Context before]",
          "806:         let module = self.module().clone();",
          "809:         let elements = match module.passive_elements_map.get(&elem_index) {",
          "810:             Some(index) if !self.dropped_elements.contains(elem_index) => {",
          "811:                 &module.passive_elements[*index]",
          "",
          "[Removed Lines]",
          "808:         let empty = TableSegmentElements::Functions(Box::new([]));",
          "",
          "[Added Lines]",
          "812:         let empty = TableSegmentElements::Expressions(Box::new([]));",
          "",
          "---------------"
        ],
        "tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast||tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast": [
          "File: tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast -> tests/misc_testsuite/externref-table-dropped-segment-issue-8281.wast",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: (module",
          "2:   (table $t 0 0 externref)",
          "4:   (func (export \"f1\")",
          "5:     (i32.const 0)",
          "6:     (i32.const 0)",
          "7:     (i32.const 0)",
          "8:     (table.init $t $declared)",
          "9:   )",
          "11:   (func (export \"f2\")",
          "12:     (i32.const 0)",
          "13:     (i32.const 0)",
          "14:     (i32.const 0)",
          "15:     (table.init $t $passive)",
          "17:     (elem.drop $passive)",
          "19:     (i32.const 0)",
          "20:     (i32.const 0)",
          "21:     (i32.const 0)",
          "22:     (table.init $t $passive)",
          "23:   )",
          "25:   (func (export \"f3\")",
          "26:     (i32.const 0)",
          "27:     (i32.const 0)",
          "28:     (i32.const 0)",
          "29:     (table.init $t $active)",
          "30:   )",
          "32:   (elem $declared declare externref)",
          "33:   (elem $passive externref)",
          "34:   (elem $active (i32.const 0) externref)",
          "35: )",
          "37: (assert_return (invoke \"f1\"))",
          "38: (assert_return (invoke \"f2\"))",
          "39: (assert_return (invoke \"f3\"))",
          "",
          "---------------"
        ]
      }
    }
  ]
}