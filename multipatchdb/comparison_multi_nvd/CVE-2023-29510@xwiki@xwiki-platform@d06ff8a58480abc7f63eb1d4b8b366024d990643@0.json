{
  "cve_id": "CVE-2023-29510",
  "cve_desc": "XWiki Platform is a generic wiki platform offering runtime services for applications built on top of it. In XWiki, every user can add translations that are only applied to the current user. This also allows overriding existing translations. Such translations are often included in privileged contexts without any escaping which allows remote code execution for any user who has edit access on at least one document which could be the user's own profile where edit access is enabled by default. A mitigation for this vulnerability is part of XWiki 14.10.2 and XWiki 15.0 RC1: translations with user scope now require script right. This means that regular users cannot exploit this anymore as users don't have script right by default anymore starting with XWiki 14.10. There are no known workarounds apart from upgrading to a patched versions.",
  "repo": "xwiki/xwiki-platform",
  "patch_hash": "d06ff8a58480abc7f63eb1d4b8b366024d990643",
  "patch_info": {
    "commit_hash": "d06ff8a58480abc7f63eb1d4b8b366024d990643",
    "repo": "xwiki/xwiki-platform",
    "commit_url": "https://github.com/xwiki/xwiki-platform/commit/d06ff8a58480abc7f63eb1d4b8b366024d990643",
    "files": [
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/resources/META-INF/components.txt",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
      "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
    ],
    "message": "XWIKI-19749: Require script right for translations with user scope\n\n* Add a new configuration option.\n* Migrate tests to JUnit 5 and add a new test.",
    "before_after_code_files": [
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
      "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
      "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
    ]
  },
  "patch_diff": {
    "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java": [
      "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.localization.wiki.internal;",
      "22: import javax.inject.Inject;",
      "23: import javax.inject.Named;",
      "24: import javax.inject.Singleton;",
      "26: import org.xwiki.component.annotation.Component;",
      "27: import org.xwiki.configuration.ConfigurationSource;",
      "36: @Singleton",
      "37: @Component",
      "38: public class DefaultWikiTranslationConfiguration implements WikiTranslationConfiguration",
      "39: {",
      "40:     private static final String PREFIX = \"localization.wiki.\";",
      "42:     @Inject",
      "43:     @Named(\"xwikiproperties\")",
      "44:     private ConfigurationSource configuration;",
      "46:     @Override",
      "47:     public boolean isRestrictUserTranslations()",
      "48:     {",
      "49:         return this.configuration.getProperty(PREFIX + \"restrictUserTranslations\", true);",
      "50:     }",
      "51: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java": [
      "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "143:     @Inject",
      "144:     private AuthorizationManager authorizationManager;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "146:     @Inject",
      "147:     private WikiTranslationConfiguration configuration;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "447:                 this.authorizationManager.checkAccess(Right.ADMIN, document.getAuthorReference(), document",
      "448:                     .getDocumentReference().getWikiReference());",
      "449:                 break;",
      "450:             default:",
      "451:                 break;",
      "452:         }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "453:             case USER:",
      "454:                 if (this.configuration.isRestrictUserTranslations()) {",
      "455:                     this.authorizationManager.checkAccess(Right.SCRIPT, document.getAuthorReference(),",
      "456:                         document.getDocumentReference());",
      "457:                 }",
      "458:                 break;",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java": [
      "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: package org.xwiki.localization.wiki.internal;",
      "22: import org.xwiki.component.annotation.Role;",
      "31: @Role",
      "32: public interface WikiTranslationConfiguration",
      "33: {",
      "37:     boolean isRestrictUserTranslations();",
      "38: }",
      "",
      "---------------"
    ],
    "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java": [
      "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "22: import java.util.Collections;",
      "23: import java.util.Locale;",
      "29: import org.mockito.Mockito;",
      "30: import org.xwiki.component.manager.ComponentLookupException;",
      "32: import org.xwiki.localization.LocalizationManager;",
      "33: import org.xwiki.localization.Translation;",
      "34: import org.xwiki.localization.TranslationBundleDoesNotExistsException;",
      "35: import org.xwiki.localization.TranslationBundleFactory;",
      "36: import org.xwiki.localization.TranslationBundleFactoryDoesNotExistsException;",
      "37: import org.xwiki.localization.internal.DefaultTranslationBundleContext;",
      "38: import org.xwiki.localization.wiki.internal.TranslationDocumentModel.Scope;",
      "39: import org.xwiki.model.reference.DocumentReference;",
      "40: import org.xwiki.query.Query;",
      "41: import org.xwiki.query.QueryManager;",
      "42: import org.xwiki.rendering.syntax.Syntax;",
      "45: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
      "47: import com.xpn.xwiki.XWikiContext;",
      "48: import com.xpn.xwiki.XWikiException;",
      "49: import com.xpn.xwiki.doc.XWikiDocument;",
      "50: import com.xpn.xwiki.objects.BaseObject;",
      "53: import static org.mockito.Mockito.doReturn;",
      "54: import static org.mockito.Mockito.mock;",
      "55: import static org.mockito.Mockito.when;",
      "59: {",
      "63:     private QueryManager mockQueryManager;",
      "65:     private Query mockQuery;",
      "67:     private WikiDescriptorManager mockWikiDescriptorManager;",
      "69:     private LocalizationManager localization;",
      "72:     {",
      "73:         this.oldcore.notifyDocumentCreatedEvent(true);",
      "74:         this.oldcore.notifyDocumentUpdatedEvent(true);",
      "75:         this.oldcore.notifyDocumentDeletedEvent(true);",
      "81:         this.oldcore.getXWikiContext().setMainXWiki(\"xwiki\");",
      "82:         this.oldcore.getXWikiContext().setWikiId(\"xwiki\");",
      "84:         doReturn(\"plain/1.0\").when(this.oldcore.getSpyXWiki()).getCurrentContentSyntaxId(Mockito.any(String.class),",
      "85:             Mockito.any(XWikiContext.class));",
      "89:         when(this.mockQueryManager.createQuery(Mockito.any(String.class), Mockito.any(String.class)))",
      "90:             .thenReturn(this.mockQuery);",
      "93:         when(this.mockWikiDescriptorManager.getMainWikiId()).thenReturn(this.oldcore.getXWikiContext().getMainXWiki());",
      "94:         when(this.mockWikiDescriptorManager.getCurrentWikiId()).thenReturn(this.oldcore.getXWikiContext().getWikiId());",
      "97:         this.oldcore.getMocker().getInstance(TranslationBundleFactory.class, DocumentTranslationBundleFactory.ID);",
      "104:         this.oldcore.notifyComponentDescriptorEvent();",
      "105:     }",
      "114:     private void addTranslation(String key, String message, DocumentReference reference, Locale locale, Scope scope)",
      "115:         throws XWikiException",
      "116:     {",
      "",
      "[Removed Lines]",
      "25: import org.junit.Assert;",
      "26: import org.junit.Before;",
      "27: import org.junit.Rule;",
      "28: import org.junit.Test;",
      "31: import org.xwiki.configuration.ConfigurationSource;",
      "43: import org.xwiki.test.annotation.AfterComponent;",
      "44: import org.xwiki.test.annotation.AllComponents;",
      "51: import com.xpn.xwiki.test.MockitoOldcoreRule;",
      "57: @AllComponents",
      "58: public class DocumentTranslationBundleFactoryTest",
      "60:     @Rule",
      "61:     public MockitoOldcoreRule oldcore = new MockitoOldcoreRule();",
      "71:     public DocumentTranslationBundleFactoryTest()",
      "76:     }",
      "78:     @Before",
      "79:     public void before() throws Exception",
      "80:     {",
      "87:         this.mockQuery = mock(Query.class);",
      "91:         when(this.mockQuery.execute()).thenReturn(Collections.EMPTY_LIST);",
      "99:         this.localization = this.oldcore.getMocker().getInstance(LocalizationManager.class);",
      "101:         this.oldcore.getMocker().registerMockComponent(ConfigurationSource.class);",
      "107:     @AfterComponent",
      "108:     public void registerComponents() throws Exception",
      "109:     {",
      "110:         this.mockQueryManager = this.oldcore.getMocker().registerMockComponent(QueryManager.class);",
      "111:         this.mockWikiDescriptorManager = this.oldcore.getMocker().registerMockComponent(WikiDescriptorManager.class);",
      "112:     }",
      "",
      "[Added Lines]",
      "25: import javax.inject.Inject;",
      "27: import org.junit.jupiter.api.BeforeEach;",
      "28: import org.junit.jupiter.api.Test;",
      "29: import org.junit.jupiter.api.extension.RegisterExtension;",
      "30: import org.mockito.Mock;",
      "32: import org.xwiki.cache.infinispan.internal.InfinispanCacheFactory;",
      "33: import org.xwiki.cache.internal.DefaultCacheManager;",
      "34: import org.xwiki.cache.internal.DefaultCacheManagerConfiguration;",
      "35: import org.xwiki.component.internal.multi.ComponentManagerManager;",
      "37: import org.xwiki.component.manager.ComponentManager;",
      "43: import org.xwiki.localization.internal.DefaultLocalizationManager;",
      "45: import org.xwiki.localization.messagetool.internal.MessageToolTranslationMessageParser;",
      "47: import org.xwiki.model.internal.DefaultModelContext;",
      "49: import org.xwiki.observation.internal.DefaultObservationManager;",
      "52: import org.xwiki.rendering.internal.parser.plain.PlainTextBlockParser;",
      "53: import org.xwiki.rendering.internal.renderer.plain.PlainTextBlockRenderer;",
      "54: import org.xwiki.rendering.internal.renderer.plain.PlainTextRendererFactory;",
      "56: import org.xwiki.security.authorization.AccessDeniedException;",
      "57: import org.xwiki.security.authorization.Right;",
      "58: import org.xwiki.test.LogLevel;",
      "59: import org.xwiki.test.annotation.ComponentList;",
      "60: import org.xwiki.test.junit5.LogCaptureExtension;",
      "61: import org.xwiki.test.junit5.mockito.MockComponent;",
      "68: import com.xpn.xwiki.test.MockitoOldcore;",
      "69: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
      "70: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
      "71: import com.xpn.xwiki.test.reference.ReferenceComponentList;",
      "73: import static org.junit.jupiter.api.Assertions.assertEquals;",
      "74: import static org.junit.jupiter.api.Assertions.assertNotNull;",
      "75: import static org.junit.jupiter.api.Assertions.assertNull;",
      "77: import static org.mockito.Mockito.doThrow;",
      "86: @OldcoreTest",
      "87: @ComponentList({",
      "88:     DocumentTranslationBundleFactory.class,",
      "89:     DefaultLocalizationManager.class,",
      "90:     DefaultTranslationBundleContext.class,",
      "91:     DefaultModelContext.class,",
      "92:     PlainTextBlockRenderer.class,",
      "93:     PlainTextRendererFactory.class,",
      "94:     DefaultObservationManager.class,",
      "95:     DefaultCacheManager.class,",
      "96:     DefaultCacheManagerConfiguration.class,",
      "97:     MessageToolTranslationMessageParser.class,",
      "98:     PlainTextBlockParser.class,",
      "99:     InfinispanCacheFactory.class })",
      "100: @ReferenceComponentList",
      "101: class DocumentTranslationBundleFactoryTest",
      "103:     @InjectMockitoOldcore",
      "104:     private MockitoOldcore oldcore;",
      "106:     @MockComponent",
      "107:     private WikiTranslationConfiguration translationConfiguration;",
      "109:     @MockComponent",
      "112:     @Mock",
      "115:     @MockComponent",
      "118:     @MockComponent",
      "119:     private ComponentManagerManager componentManagerManager;",
      "121:     @Inject",
      "127:     @RegisterExtension",
      "128:     private LogCaptureExtension logCapture = new LogCaptureExtension(LogLevel.WARN);",
      "130:     @BeforeEach",
      "131:     public void before() throws Exception",
      "145:         when(this.mockQuery.execute()).thenReturn(Collections.emptyList());",
      "151:         when(this.componentManagerManager.getComponentManager(\"wiki:xwiki\", true)).thenReturn(this.oldcore.getMocker());",
      "152:         when(this.componentManagerManager.getComponentManager(\"wiki:otherwiki\", true))",
      "153:             .thenReturn(mock(ComponentManager.class));",
      "154:         when(this.componentManagerManager.getComponentManager(\"user:null\", true)).thenReturn(this.oldcore.getMocker());",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:         document.setSyntax(Syntax.PLAIN_1_0);",
      "154:         this.oldcore.getSpyXWiki().saveDocument(document, \"\", this.oldcore.getXWikiContext());",
      "155:     }",
      "",
      "[Removed Lines]",
      "145:         StringBuilder builder = new StringBuilder(document.getContent());",
      "147:         builder.append('\\n');",
      "148:         builder.append(key);",
      "149:         builder.append('=');",
      "150:         builder.append(message);",
      "152:         document.setContent(builder.toString());",
      "",
      "[Added Lines]",
      "194:         String content = document.getContent() + '\\n'",
      "195:             + key",
      "196:             + '='",
      "197:             + message;",
      "199:         document.setContent(content);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "159:         Translation translation = this.localization.getTranslation(key, locale);",
      "161:         if (message != null) {",
      "164:         } else {",
      "166:         }",
      "167:     }",
      "",
      "[Removed Lines]",
      "162:             Assert.assertNotNull(\"No translation could be found for key [\" + key + \"]\", translation);",
      "163:             Assert.assertEquals(message, translation.getRawSource());",
      "165:             Assert.assertNull(translation);",
      "",
      "[Added Lines]",
      "209:             assertNotNull(translation, \"No translation could be found for key [\" + key + \"]\");",
      "210:             assertEquals(message, translation.getRawSource());",
      "212:             assertNull(translation);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "176:     @Test",
      "178:     {",
      "179:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
      "",
      "[Removed Lines]",
      "177:     public void getTranslationScopeWiki() throws XWikiException, ComponentLookupException",
      "",
      "[Added Lines]",
      "224:     void getTranslationScopeWiki() throws XWikiException, ComponentLookupException",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "191:     }",
      "193:     @Test",
      "195:     {",
      "196:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
      "",
      "[Removed Lines]",
      "194:     public void getTranslationScopeWikiFromOtherWiki() throws XWikiException, ComponentLookupException",
      "",
      "[Added Lines]",
      "241:     void getTranslationScopeWikiFromOtherWiki() throws XWikiException, ComponentLookupException",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "207:     }",
      "209:     @Test",
      "211:         TranslationBundleFactoryDoesNotExistsException, ComponentLookupException",
      "212:     {",
      "213:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
      "",
      "[Removed Lines]",
      "210:     public void getTranslationScopeONDemand() throws XWikiException, TranslationBundleDoesNotExistsException,",
      "",
      "[Added Lines]",
      "257:     void getTranslationScopeONDemand() throws XWikiException, TranslationBundleDoesNotExistsException,",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "225:         assertTranslation(\"wiki.translation\", \"Wiki translation\", Locale.ROOT);",
      "226:     }",
      "227: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "275:     @Test",
      "276:     void restrictUserTranslations() throws XWikiException, AccessDeniedException",
      "277:     {",
      "278:         DocumentReference translationDocument =",
      "279:             new DocumentReference(this.oldcore.getXWikiContext().getWikiId(), \"space\", \"translation\");",
      "281:         when(this.translationConfiguration.isRestrictUserTranslations()).thenReturn(true);",
      "283:         addTranslation(\"user.translation\", \"User translation\", translationDocument, Locale.ROOT, Scope.USER);",
      "285:         assertTranslation(\"user.translation\", \"User translation\", Locale.ROOT);",
      "287:         doThrow(new AccessDeniedException(Right.SCRIPT, null, translationDocument))",
      "288:             .when(this.oldcore.getMockAuthorizationManager()).checkAccess(Right.SCRIPT, null, translationDocument);",
      "290:         addTranslation(\"user.translation2\", \"User translation\", translationDocument, Locale.ROOT, Scope.USER);",
      "292:         assertEquals(\"Failed to register translation bundle from document [xwiki:space.translation]\",",
      "293:             this.logCapture.getMessage(0));",
      "295:         assertTranslation(\"user.translation\", null, Locale.ROOT);",
      "296:     }",
      "",
      "---------------"
    ],
    "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm": [
      "File: xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm -> xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm",
      "--- Hunk 1 ---",
      "[Context before]",
      "1391: #-# The default value is:",
      "1392: # skinx.jsStrictModeEnabled = false",
      "1394: $!xwikiPropertiesAdditionalProperties",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1394: #-------------------------------------------------------------------------------------",
      "1395: # Localization",
      "1396: #-------------------------------------------------------------------------------------",
      "1398: #-# [Since 14.10.2, 15.0RC1]",
      "1399: #-# Indicate whether translations with user scope that are only applied for the user who created them shall be",
      "1400: #-# restricted to users with script right. The default value is true. Disable this option only when you absolutely",
      "1401: #-# trust all users on the wiki.",
      "1402: # localization.wiki.restrictUserTranslations = true",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a326452769097ed3bf0a25d2a5681d139478a6f1",
      "candidate_info": {
        "commit_hash": "a326452769097ed3bf0a25d2a5681d139478a6f1",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/a326452769097ed3bf0a25d2a5681d139478a6f1",
        "files": [
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/resources/META-INF/components.txt",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
          "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
        ],
        "message": "XWIKI-19749: Require script right for translations with user scope\n\n* Add a new configuration option.\n* Migrate tests to JUnit 5 and add a new test.\n\n(cherry picked from commit d06ff8a58480abc7f63eb1d4b8b366024d990643)",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
          "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
            "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
            "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DefaultWikiTranslationConfiguration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.localization.wiki.internal;",
          "22: import javax.inject.Inject;",
          "23: import javax.inject.Named;",
          "24: import javax.inject.Singleton;",
          "26: import org.xwiki.component.annotation.Component;",
          "27: import org.xwiki.configuration.ConfigurationSource;",
          "36: @Singleton",
          "37: @Component",
          "38: public class DefaultWikiTranslationConfiguration implements WikiTranslationConfiguration",
          "39: {",
          "40:     private static final String PREFIX = \"localization.wiki.\";",
          "42:     @Inject",
          "43:     @Named(\"xwikiproperties\")",
          "44:     private ConfigurationSource configuration;",
          "46:     @Override",
          "47:     public boolean isRestrictUserTranslations()",
          "48:     {",
          "49:         return this.configuration.getProperty(PREFIX + \"restrictUserTranslations\", true);",
          "50:     }",
          "51: }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "143:     @Inject",
          "144:     private AuthorizationManager authorizationManager;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "146:     @Inject",
          "147:     private WikiTranslationConfiguration configuration;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "447:                 this.authorizationManager.checkAccess(Right.ADMIN, document.getAuthorReference(), document",
          "448:                     .getDocumentReference().getWikiReference());",
          "449:                 break;",
          "450:             default:",
          "451:                 break;",
          "452:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "453:             case USER:",
          "454:                 if (this.configuration.isRestrictUserTranslations()) {",
          "455:                     this.authorizationManager.checkAccess(Right.SCRIPT, document.getAuthorReference(),",
          "456:                         document.getDocumentReference());",
          "457:                 }",
          "458:                 break;",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/WikiTranslationConfiguration.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.localization.wiki.internal;",
          "22: import org.xwiki.component.annotation.Role;",
          "31: @Role",
          "32: public interface WikiTranslationConfiguration",
          "33: {",
          "37:     boolean isRestrictUserTranslations();",
          "38: }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactoryTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: import java.util.Collections;",
          "23: import java.util.Locale;",
          "29: import org.mockito.Mockito;",
          "30: import org.xwiki.component.manager.ComponentLookupException;",
          "32: import org.xwiki.localization.LocalizationManager;",
          "33: import org.xwiki.localization.Translation;",
          "34: import org.xwiki.localization.TranslationBundleDoesNotExistsException;",
          "35: import org.xwiki.localization.TranslationBundleFactory;",
          "36: import org.xwiki.localization.TranslationBundleFactoryDoesNotExistsException;",
          "37: import org.xwiki.localization.internal.DefaultTranslationBundleContext;",
          "38: import org.xwiki.localization.wiki.internal.TranslationDocumentModel.Scope;",
          "39: import org.xwiki.model.reference.DocumentReference;",
          "40: import org.xwiki.query.Query;",
          "41: import org.xwiki.query.QueryManager;",
          "42: import org.xwiki.rendering.syntax.Syntax;",
          "45: import org.xwiki.wiki.descriptor.WikiDescriptorManager;",
          "47: import com.xpn.xwiki.XWikiContext;",
          "48: import com.xpn.xwiki.XWikiException;",
          "49: import com.xpn.xwiki.doc.XWikiDocument;",
          "50: import com.xpn.xwiki.objects.BaseObject;",
          "53: import static org.mockito.Mockito.doReturn;",
          "54: import static org.mockito.Mockito.mock;",
          "55: import static org.mockito.Mockito.when;",
          "59: {",
          "63:     private QueryManager mockQueryManager;",
          "65:     private Query mockQuery;",
          "67:     private WikiDescriptorManager mockWikiDescriptorManager;",
          "69:     private LocalizationManager localization;",
          "72:     {",
          "73:         this.oldcore.notifyDocumentCreatedEvent(true);",
          "74:         this.oldcore.notifyDocumentUpdatedEvent(true);",
          "75:         this.oldcore.notifyDocumentDeletedEvent(true);",
          "81:         this.oldcore.getXWikiContext().setMainXWiki(\"xwiki\");",
          "82:         this.oldcore.getXWikiContext().setWikiId(\"xwiki\");",
          "84:         doReturn(\"plain/1.0\").when(this.oldcore.getSpyXWiki()).getCurrentContentSyntaxId(Mockito.any(String.class),",
          "85:             Mockito.any(XWikiContext.class));",
          "89:         when(this.mockQueryManager.createQuery(Mockito.any(String.class), Mockito.any(String.class)))",
          "90:             .thenReturn(this.mockQuery);",
          "93:         when(this.mockWikiDescriptorManager.getMainWikiId()).thenReturn(this.oldcore.getXWikiContext().getMainXWiki());",
          "94:         when(this.mockWikiDescriptorManager.getCurrentWikiId()).thenReturn(this.oldcore.getXWikiContext().getWikiId());",
          "97:         this.oldcore.getMocker().getInstance(TranslationBundleFactory.class, DocumentTranslationBundleFactory.ID);",
          "104:         this.oldcore.notifyComponentDescriptorEvent();",
          "105:     }",
          "114:     private void addTranslation(String key, String message, DocumentReference reference, Locale locale, Scope scope)",
          "115:         throws XWikiException",
          "116:     {",
          "",
          "[Removed Lines]",
          "25: import org.junit.Assert;",
          "26: import org.junit.Before;",
          "27: import org.junit.Rule;",
          "28: import org.junit.Test;",
          "31: import org.xwiki.configuration.ConfigurationSource;",
          "43: import org.xwiki.test.annotation.AfterComponent;",
          "44: import org.xwiki.test.annotation.AllComponents;",
          "51: import com.xpn.xwiki.test.MockitoOldcoreRule;",
          "57: @AllComponents",
          "58: public class DocumentTranslationBundleFactoryTest",
          "60:     @Rule",
          "61:     public MockitoOldcoreRule oldcore = new MockitoOldcoreRule();",
          "71:     public DocumentTranslationBundleFactoryTest()",
          "76:     }",
          "78:     @Before",
          "79:     public void before() throws Exception",
          "80:     {",
          "87:         this.mockQuery = mock(Query.class);",
          "91:         when(this.mockQuery.execute()).thenReturn(Collections.EMPTY_LIST);",
          "99:         this.localization = this.oldcore.getMocker().getInstance(LocalizationManager.class);",
          "101:         this.oldcore.getMocker().registerMockComponent(ConfigurationSource.class);",
          "107:     @AfterComponent",
          "108:     public void registerComponents() throws Exception",
          "109:     {",
          "110:         this.mockQueryManager = this.oldcore.getMocker().registerMockComponent(QueryManager.class);",
          "111:         this.mockWikiDescriptorManager = this.oldcore.getMocker().registerMockComponent(WikiDescriptorManager.class);",
          "112:     }",
          "",
          "[Added Lines]",
          "25: import javax.inject.Inject;",
          "27: import org.junit.jupiter.api.BeforeEach;",
          "28: import org.junit.jupiter.api.Test;",
          "29: import org.junit.jupiter.api.extension.RegisterExtension;",
          "30: import org.mockito.Mock;",
          "32: import org.xwiki.cache.infinispan.internal.InfinispanCacheFactory;",
          "33: import org.xwiki.cache.internal.DefaultCacheManager;",
          "34: import org.xwiki.cache.internal.DefaultCacheManagerConfiguration;",
          "35: import org.xwiki.component.internal.multi.ComponentManagerManager;",
          "37: import org.xwiki.component.manager.ComponentManager;",
          "43: import org.xwiki.localization.internal.DefaultLocalizationManager;",
          "45: import org.xwiki.localization.messagetool.internal.MessageToolTranslationMessageParser;",
          "47: import org.xwiki.model.internal.DefaultModelContext;",
          "49: import org.xwiki.observation.internal.DefaultObservationManager;",
          "52: import org.xwiki.rendering.internal.parser.plain.PlainTextBlockParser;",
          "53: import org.xwiki.rendering.internal.renderer.plain.PlainTextBlockRenderer;",
          "54: import org.xwiki.rendering.internal.renderer.plain.PlainTextRendererFactory;",
          "56: import org.xwiki.security.authorization.AccessDeniedException;",
          "57: import org.xwiki.security.authorization.Right;",
          "58: import org.xwiki.test.LogLevel;",
          "59: import org.xwiki.test.annotation.ComponentList;",
          "60: import org.xwiki.test.junit5.LogCaptureExtension;",
          "61: import org.xwiki.test.junit5.mockito.MockComponent;",
          "68: import com.xpn.xwiki.test.MockitoOldcore;",
          "69: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "70: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "71: import com.xpn.xwiki.test.reference.ReferenceComponentList;",
          "73: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "74: import static org.junit.jupiter.api.Assertions.assertNotNull;",
          "75: import static org.junit.jupiter.api.Assertions.assertNull;",
          "77: import static org.mockito.Mockito.doThrow;",
          "86: @OldcoreTest",
          "87: @ComponentList({",
          "88:     DocumentTranslationBundleFactory.class,",
          "89:     DefaultLocalizationManager.class,",
          "90:     DefaultTranslationBundleContext.class,",
          "91:     DefaultModelContext.class,",
          "92:     PlainTextBlockRenderer.class,",
          "93:     PlainTextRendererFactory.class,",
          "94:     DefaultObservationManager.class,",
          "95:     DefaultCacheManager.class,",
          "96:     DefaultCacheManagerConfiguration.class,",
          "97:     MessageToolTranslationMessageParser.class,",
          "98:     PlainTextBlockParser.class,",
          "99:     InfinispanCacheFactory.class })",
          "100: @ReferenceComponentList",
          "101: class DocumentTranslationBundleFactoryTest",
          "103:     @InjectMockitoOldcore",
          "104:     private MockitoOldcore oldcore;",
          "106:     @MockComponent",
          "107:     private WikiTranslationConfiguration translationConfiguration;",
          "109:     @MockComponent",
          "112:     @Mock",
          "115:     @MockComponent",
          "118:     @MockComponent",
          "119:     private ComponentManagerManager componentManagerManager;",
          "121:     @Inject",
          "127:     @RegisterExtension",
          "128:     private LogCaptureExtension logCapture = new LogCaptureExtension(LogLevel.WARN);",
          "130:     @BeforeEach",
          "131:     public void before() throws Exception",
          "145:         when(this.mockQuery.execute()).thenReturn(Collections.emptyList());",
          "151:         when(this.componentManagerManager.getComponentManager(\"wiki:xwiki\", true)).thenReturn(this.oldcore.getMocker());",
          "152:         when(this.componentManagerManager.getComponentManager(\"wiki:otherwiki\", true))",
          "153:             .thenReturn(mock(ComponentManager.class));",
          "154:         when(this.componentManagerManager.getComponentManager(\"user:null\", true)).thenReturn(this.oldcore.getMocker());",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "143:         document.setSyntax(Syntax.PLAIN_1_0);",
          "154:         this.oldcore.getSpyXWiki().saveDocument(document, \"\", this.oldcore.getXWikiContext());",
          "155:     }",
          "",
          "[Removed Lines]",
          "145:         StringBuilder builder = new StringBuilder(document.getContent());",
          "147:         builder.append('\\n');",
          "148:         builder.append(key);",
          "149:         builder.append('=');",
          "150:         builder.append(message);",
          "152:         document.setContent(builder.toString());",
          "",
          "[Added Lines]",
          "194:         String content = document.getContent() + '\\n'",
          "195:             + key",
          "196:             + '='",
          "197:             + message;",
          "199:         document.setContent(content);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "159:         Translation translation = this.localization.getTranslation(key, locale);",
          "161:         if (message != null) {",
          "164:         } else {",
          "166:         }",
          "167:     }",
          "",
          "[Removed Lines]",
          "162:             Assert.assertNotNull(\"No translation could be found for key [\" + key + \"]\", translation);",
          "163:             Assert.assertEquals(message, translation.getRawSource());",
          "165:             Assert.assertNull(translation);",
          "",
          "[Added Lines]",
          "209:             assertNotNull(translation, \"No translation could be found for key [\" + key + \"]\");",
          "210:             assertEquals(message, translation.getRawSource());",
          "212:             assertNull(translation);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "176:     @Test",
          "178:     {",
          "179:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
          "",
          "[Removed Lines]",
          "177:     public void getTranslationScopeWiki() throws XWikiException, ComponentLookupException",
          "",
          "[Added Lines]",
          "224:     void getTranslationScopeWiki() throws XWikiException, ComponentLookupException",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "191:     }",
          "193:     @Test",
          "195:     {",
          "196:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
          "",
          "[Removed Lines]",
          "194:     public void getTranslationScopeWikiFromOtherWiki() throws XWikiException, ComponentLookupException",
          "",
          "[Added Lines]",
          "241:     void getTranslationScopeWikiFromOtherWiki() throws XWikiException, ComponentLookupException",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "207:     }",
          "209:     @Test",
          "211:         TranslationBundleFactoryDoesNotExistsException, ComponentLookupException",
          "212:     {",
          "213:         assertTranslation(\"wiki.translation\", null, Locale.ROOT);",
          "",
          "[Removed Lines]",
          "210:     public void getTranslationScopeONDemand() throws XWikiException, TranslationBundleDoesNotExistsException,",
          "",
          "[Added Lines]",
          "257:     void getTranslationScopeONDemand() throws XWikiException, TranslationBundleDoesNotExistsException,",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "225:         assertTranslation(\"wiki.translation\", \"Wiki translation\", Locale.ROOT);",
          "226:     }",
          "227: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "275:     @Test",
          "276:     void restrictUserTranslations() throws XWikiException, AccessDeniedException",
          "277:     {",
          "278:         DocumentReference translationDocument =",
          "279:             new DocumentReference(this.oldcore.getXWikiContext().getWikiId(), \"space\", \"translation\");",
          "281:         when(this.translationConfiguration.isRestrictUserTranslations()).thenReturn(true);",
          "283:         addTranslation(\"user.translation\", \"User translation\", translationDocument, Locale.ROOT, Scope.USER);",
          "285:         assertTranslation(\"user.translation\", \"User translation\", Locale.ROOT);",
          "287:         doThrow(new AccessDeniedException(Right.SCRIPT, null, translationDocument))",
          "288:             .when(this.oldcore.getMockAuthorizationManager()).checkAccess(Right.SCRIPT, null, translationDocument);",
          "290:         addTranslation(\"user.translation2\", \"User translation\", translationDocument, Locale.ROOT, Scope.USER);",
          "292:         assertEquals(\"Failed to register translation bundle from document [xwiki:space.translation]\",",
          "293:             this.logCapture.getMessage(0));",
          "295:         assertTranslation(\"user.translation\", null, Locale.ROOT);",
          "296:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm||xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm": [
          "File: xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm -> xwiki-platform-tools/xwiki-platform-tool-configuration-resources/src/main/resources/xwiki.properties.vm",
          "--- Hunk 1 ---",
          "[Context before]",
          "1391: #-# The default value is:",
          "1392: # skinx.jsStrictModeEnabled = false",
          "1394: $!xwikiPropertiesAdditionalProperties",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1394: #-------------------------------------------------------------------------------------",
          "1395: # Localization",
          "1396: #-------------------------------------------------------------------------------------",
          "1398: #-# [Since 14.10.2, 15.0RC1]",
          "1399: #-# Indicate whether translations with user scope that are only applied for the user who created them shall be",
          "1400: #-# restricted to users with script right. The default value is true. Disable this option only when you absolutely",
          "1401: #-# trust all users on the wiki.",
          "1402: # localization.wiki.restrictUserTranslations = true",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4c8d61c30de72298d805ccc82df2a307f131c54",
      "candidate_info": {
        "commit_hash": "c4c8d61c30de72298d805ccc82df2a307f131c54",
        "repo": "xwiki/xwiki-platform",
        "commit_url": "https://github.com/xwiki/xwiki-platform/commit/c4c8d61c30de72298d805ccc82df2a307f131c54",
        "files": [
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java"
        ],
        "message": "XWIKI-21411: Improve check of translation document author rights\n\n* Check both author and content author and improve JavaDoc",
        "before_after_code_files": [
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java"
          ],
          "candidate": [
            "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java"
          ]
        }
      },
      "candidate_diff": {
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/AbstractDocumentTranslationBundle.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:         setId(this.idPrefix + this.serializer.serialize(reference));",
          "139:     }",
          "142:     {",
          "143:         XWikiContext context = this.contextProvider.get();",
          "145:         if (context == null) {",
          "147:             return null;",
          "148:         }",
          "150:         XWiki xwiki = context.getWiki();",
          "152:         if (xwiki == null) {",
          "154:             return null;",
          "155:         }",
          "",
          "[Removed Lines]",
          "141:     protected LocalizedTranslationBundle loadDocumentLocaleBundle(Locale locale) throws Exception",
          "",
          "[Added Lines]",
          "147:     protected XWikiDocument getDocumentLocaleBundle(Locale locale) throws Exception",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "159:         if (locale != null && !locale.equals(Locale.ROOT) && !locale.equals(document.getDefaultLocale())) {",
          "160:             document = xwiki.getDocument(new DocumentReference(document.getDocumentReference(), locale), context);",
          "166:         }",
          "168:         String content = document.getContent();",
          "",
          "[Removed Lines]",
          "162:             if (document.isNew()) {",
          "164:                 return LocalizedTranslationBundle.EMPTY;",
          "165:             }",
          "",
          "[Added Lines]",
          "167:         }",
          "169:         return document;",
          "170:     }",
          "172:     protected LocalizedTranslationBundle loadDocumentLocaleBundle(Locale locale) throws Exception",
          "173:     {",
          "174:         XWikiDocument document = getDocumentLocaleBundle(locale);",
          "176:         if (document == null) {",
          "178:             return null;",
          "179:         }",
          "181:         if (document.isNew()) {",
          "183:             return LocalizedTranslationBundle.EMPTY;",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundle.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: package org.xwiki.localization.wiki.internal;",
          "22: import org.xwiki.bridge.event.WikiDeletedEvent;",
          "23: import org.xwiki.component.descriptor.ComponentDescriptor;",
          "24: import org.xwiki.component.manager.ComponentLookupException;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: import java.util.Locale;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "27: import org.xwiki.localization.message.TranslationMessageParser;",
          "28: import org.xwiki.model.reference.DocumentReference;",
          "29: import org.xwiki.observation.event.Event;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "32: import org.xwiki.security.authorization.AccessDeniedException;",
          "34: import com.xpn.xwiki.XWiki;",
          "35: import com.xpn.xwiki.XWikiContext;",
          "36: import com.xpn.xwiki.doc.XWikiDocument;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "38: public class ComponentDocumentTranslationBundle extends AbstractDocumentTranslationBundle",
          "39: {",
          "40:     private ComponentDescriptor<TranslationBundle> descriptor;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:     private DocumentTranslationBundleFactory factory;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "50:     public ComponentDocumentTranslationBundle(String idPrefix, DocumentReference documentReference,",
          "51:         ComponentManager componentManager, TranslationMessageParser translationMessageParser,",
          "53:     {",
          "54:         super(idPrefix, documentReference, componentManager, translationMessageParser);",
          "56:         this.descriptor = descriptor;",
          "57:     }",
          "59:     @Override",
          "60:     public void onEvent(Event event, Object source, Object data)",
          "61:     {",
          "",
          "[Removed Lines]",
          "52:         ComponentDescriptor<TranslationBundle> descriptor) throws ComponentLookupException",
          "",
          "[Added Lines]",
          "62:         ComponentDescriptor<TranslationBundle> descriptor, DocumentTranslationBundleFactory factory)",
          "63:         throws ComponentLookupException",
          "67:         this.factory = factory;",
          "79:     @Override",
          "80:     protected XWikiDocument getDocumentLocaleBundle(Locale locale) throws Exception",
          "81:     {",
          "82:         XWikiDocument document = super.getDocumentLocaleBundle(locale);",
          "84:         if (document != null && !document.isNew()) {",
          "85:             XWikiContext context = this.contextProvider.get();",
          "86:             XWiki xwiki = context.getWiki();",
          "87:             XWikiDocument defaultLocaleDocument = xwiki.getDocument(this.documentReference, context);",
          "89:             if (defaultLocaleDocument != document) {",
          "91:                 try {",
          "92:                     this.factory.checkRegistrationAuthorizationForDocumentLocaleBundle(document, defaultLocaleDocument);",
          "93:                 } catch (AccessDeniedException e) {",
          "94:                     this.logger.warn(\"Failed to load and register the translation for locale [{}] from document [{}]. \"",
          "95:                         + \"Falling back to default locale.\", locale, document.getDocumentReference());",
          "97:                     return defaultLocaleDocument;",
          "98:                 }",
          "99:             }",
          "100:         }",
          "102:         return document;",
          "103:     }",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/main/java/org/xwiki/localization/wiki/internal/DocumentTranslationBundleFactory.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "56: import org.xwiki.localization.wiki.internal.TranslationDocumentModel.Scope;",
          "57: import org.xwiki.model.reference.DocumentReference;",
          "58: import org.xwiki.model.reference.DocumentReferenceResolver;",
          "59: import org.xwiki.model.reference.EntityReferenceSerializer;",
          "60: import org.xwiki.model.reference.WikiReference;",
          "61: import org.xwiki.observation.EventListener;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59: import org.xwiki.model.reference.EntityReference;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "324:         try {",
          "325:             documentBundle =",
          "326:                 new ComponentDocumentTranslationBundle(ID_PREFIX, document.getDocumentReference(),",
          "328:         } catch (ComponentLookupException e) {",
          "329:             throw new TranslationBundleDoesNotExistsException(\"Failed to create document bundle\", e);",
          "330:         }",
          "",
          "[Removed Lines]",
          "327:                     this.componentManagerProvider.get(), this.translationParser, descriptor);",
          "",
          "[Added Lines]",
          "328:                     this.componentManagerProvider.get(), this.translationParser, descriptor, this);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "434:         }",
          "435:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "446:     protected void checkRegistrationAuthorizationForDocumentLocaleBundle(XWikiDocument document,",
          "447:         XWikiDocument defaultLocaleDocument) throws AccessDeniedException",
          "448:     {",
          "449:         Scope scope = getScope(defaultLocaleDocument);",
          "450:         if (scope != null && scope != Scope.ON_DEMAND) {",
          "451:             checkRegistrationAuthorization(document, scope);",
          "452:         }",
          "453:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "443:     private void checkRegistrationAuthorization(XWikiDocument document, Scope scope) throws AccessDeniedException",
          "444:     {",
          "445:         switch (scope) {",
          "446:             case GLOBAL:",
          "447:                 this.authorizationManager.checkAccess(Right.PROGRAM, document.getAuthorReference(), null);",
          "448:                 break;",
          "449:             case WIKI:",
          "452:                 break;",
          "453:             case USER:",
          "454:                 if (this.configuration.isRestrictUserTranslations()) {",
          "457:                 }",
          "458:                 break;",
          "459:             default:",
          "",
          "[Removed Lines]",
          "450:                 this.authorizationManager.checkAccess(Right.ADMIN, document.getAuthorReference(), document",
          "451:                     .getDocumentReference().getWikiReference());",
          "455:                     this.authorizationManager.checkAccess(Right.SCRIPT, document.getAuthorReference(),",
          "456:                         document.getDocumentReference());",
          "",
          "[Added Lines]",
          "463:         EntityReference entityReference;",
          "467:                 this.authorizationManager.checkAccess(Right.PROGRAM, document.getContentAuthorReference(), null);",
          "470:                 entityReference = document.getDocumentReference().getWikiReference();",
          "471:                 this.authorizationManager.checkAccess(Right.ADMIN, document.getAuthorReference(), entityReference);",
          "472:                 this.authorizationManager.checkAccess(Right.ADMIN, document.getContentAuthorReference(),",
          "473:                     entityReference);",
          "477:                     entityReference = document.getDocumentReference();",
          "478:                     this.authorizationManager.checkAccess(Right.SCRIPT, document.getAuthorReference(), entityReference);",
          "479:                     this.authorizationManager.checkAccess(Right.SCRIPT, document.getContentAuthorReference(),",
          "480:                         entityReference);",
          "",
          "---------------"
        ],
        "xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java||xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java": [
          "File: xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java -> xwiki-platform-core/xwiki-platform-localization/xwiki-platform-localization-sources/xwiki-platform-localization-source-wiki/src/test/java/org/xwiki/localization/wiki/internal/ComponentDocumentTranslationBundleTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: package org.xwiki.localization.wiki.internal;",
          "22: import java.util.Collections;",
          "23: import java.util.Locale;",
          "25: import javax.inject.Inject;",
          "27: import org.junit.jupiter.api.BeforeEach;",
          "28: import org.junit.jupiter.api.Test;",
          "29: import org.junit.jupiter.api.extension.RegisterExtension;",
          "30: import org.mockito.Mock;",
          "31: import org.xwiki.cache.Cache;",
          "32: import org.xwiki.cache.CacheManager;",
          "33: import org.xwiki.cache.config.CacheConfiguration;",
          "34: import org.xwiki.component.internal.multi.ComponentManagerManager;",
          "35: import org.xwiki.job.event.status.JobProgressManager;",
          "36: import org.xwiki.localization.LocalizationManager;",
          "37: import org.xwiki.localization.Translation;",
          "38: import org.xwiki.localization.TranslationBundleFactory;",
          "39: import org.xwiki.localization.internal.DefaultLocalizationManager;",
          "40: import org.xwiki.localization.internal.DefaultTranslationBundleContext;",
          "41: import org.xwiki.localization.messagetool.internal.MessageToolTranslationMessageParser;",
          "42: import org.xwiki.model.internal.DefaultModelContext;",
          "43: import org.xwiki.model.reference.DocumentReference;",
          "44: import org.xwiki.observation.internal.DefaultObservationManager;",
          "45: import org.xwiki.query.Query;",
          "46: import org.xwiki.query.QueryManager;",
          "47: import org.xwiki.rendering.internal.parser.plain.PlainTextBlockParser;",
          "48: import org.xwiki.rendering.internal.renderer.plain.PlainTextBlockRenderer;",
          "49: import org.xwiki.rendering.internal.renderer.plain.PlainTextRendererFactory;",
          "50: import org.xwiki.rendering.syntax.Syntax;",
          "51: import org.xwiki.security.authorization.AccessDeniedException;",
          "52: import org.xwiki.security.authorization.Right;",
          "53: import org.xwiki.test.LogLevel;",
          "54: import org.xwiki.test.annotation.BeforeComponent;",
          "55: import org.xwiki.test.annotation.ComponentList;",
          "56: import org.xwiki.test.junit5.LogCaptureExtension;",
          "57: import org.xwiki.test.junit5.mockito.MockComponent;",
          "59: import com.xpn.xwiki.doc.XWikiDocument;",
          "60: import com.xpn.xwiki.objects.BaseObject;",
          "61: import com.xpn.xwiki.test.MockitoOldcore;",
          "62: import com.xpn.xwiki.test.junit5.mockito.InjectMockitoOldcore;",
          "63: import com.xpn.xwiki.test.junit5.mockito.OldcoreTest;",
          "64: import com.xpn.xwiki.test.reference.ReferenceComponentList;",
          "66: import static org.junit.jupiter.api.Assertions.assertEquals;",
          "67: import static org.mockito.ArgumentMatchers.anyString;",
          "68: import static org.mockito.Mockito.any;",
          "69: import static org.mockito.Mockito.doThrow;",
          "70: import static org.mockito.Mockito.mock;",
          "71: import static org.mockito.Mockito.times;",
          "72: import static org.mockito.Mockito.verify;",
          "73: import static org.mockito.Mockito.when;",
          "80: @OldcoreTest",
          "81: @ComponentList({",
          "82:     DocumentTranslationBundleFactory.class,",
          "83:     DefaultLocalizationManager.class,",
          "84:     DefaultTranslationBundleContext.class,",
          "85:     TranslationDocumentClassInitializer.class,",
          "86:     DefaultModelContext.class,",
          "87:     PlainTextBlockRenderer.class,",
          "88:     PlainTextRendererFactory.class,",
          "89:     DefaultObservationManager.class,",
          "90:     MessageToolTranslationMessageParser.class,",
          "91:     PlainTextBlockParser.class",
          "92: })",
          "93: @ReferenceComponentList",
          "94: class ComponentDocumentTranslationBundleTest",
          "95: {",
          "96:     private static final DocumentReference TRANSLATION_ROOT_REFERENCE = new DocumentReference(\"xwiki\", \"space\",",
          "97:         \"Translations\");",
          "99:     private static final DocumentReference ADMIN_USER_REFERENCE = new DocumentReference(\"xwiki\", \"XWiki\", \"XWikiAdmin\");",
          "101:     @InjectMockitoOldcore",
          "102:     private MockitoOldcore oldcore;",
          "104:     @MockComponent",
          "105:     private WikiTranslationConfiguration translationConfiguration;",
          "107:     @MockComponent",
          "108:     private QueryManager mockQueryManager;",
          "110:     @Mock",
          "111:     private Query mockQuery;",
          "113:     @MockComponent",
          "114:     private ComponentManagerManager componentManagerManager;",
          "116:     @MockComponent",
          "117:     private JobProgressManager jobProgressManager;",
          "119:     @Inject",
          "120:     private LocalizationManager localization;",
          "122:     private XWikiDocument translationFrDocument;",
          "124:     private DocumentReference adminUserReference;",
          "129:     @RegisterExtension",
          "130:     private LogCaptureExtension logCapture = new LogCaptureExtension(LogLevel.WARN);",
          "132:     @MockComponent",
          "133:     private CacheManager cacheManager;",
          "135:     @BeforeComponent",
          "136:     void before() throws Exception",
          "137:     {",
          "138:         Cache<Object> cache = mock(Cache.class);",
          "139:         when(this.cacheManager.createNewCache(any(CacheConfiguration.class))).thenReturn(cache);",
          "140:     }",
          "142:     @BeforeEach",
          "143:     void setUp() throws Exception",
          "144:     {",
          "145:         this.oldcore.notifyDocumentCreatedEvent(true);",
          "147:         when(this.mockQueryManager.createQuery(anyString(), anyString())).thenReturn(this.mockQuery);",
          "148:         when(this.mockQuery.execute()).thenReturn(Collections.emptyList());",
          "150:         when(this.componentManagerManager.getComponentManager(\"wiki:xwiki\", true)).thenReturn(this.oldcore.getMocker());",
          "151:         this.oldcore.getMocker().getInstance(TranslationBundleFactory.class, DocumentTranslationBundleFactory.ID);",
          "153:         XWikiDocument translationRootDocument = this.oldcore.getSpyXWiki().getDocument(TRANSLATION_ROOT_REFERENCE,",
          "154:             this.oldcore.getXWikiContext());",
          "156:         BaseObject translationObject = translationRootDocument.newXObject(",
          "157:             new DocumentReference(\"xwiki\", \"XWiki\", \"TranslationDocumentClass\"),",
          "158:             this.oldcore.getXWikiContext());",
          "159:         translationObject.setStringValue(TranslationDocumentModel.TRANSLATIONCLASS_PROP_SCOPE,",
          "160:             TranslationDocumentModel.Scope.WIKI.toString());",
          "162:         translationRootDocument.setSyntax(Syntax.PLAIN_1_0);",
          "163:         translationRootDocument.setContent(\"xwiki.translation=root\");",
          "164:         translationRootDocument.setAuthorReference(ADMIN_USER_REFERENCE);",
          "165:         this.oldcore.getSpyXWiki().saveDocument(translationRootDocument, this.oldcore.getXWikiContext());",
          "167:         this.translationFrDocument = translationRootDocument.getTranslatedDocument(Locale.FRENCH,",
          "168:             this.oldcore.getXWikiContext());",
          "169:         if (this.translationFrDocument == translationRootDocument) {",
          "170:             this.translationFrDocument =",
          "171:                 new XWikiDocument(this.translationFrDocument.getDocumentReference(), Locale.FRENCH);",
          "172:             this.translationFrDocument.setDefaultLocale(this.translationFrDocument.getDefaultLocale());",
          "173:         }",
          "174:         this.translationFrDocument.setSyntax(Syntax.PLAIN_1_0);",
          "175:         this.translationFrDocument.setContent(\"xwiki.translation=fr\");",
          "176:         this.oldcore.getSpyXWiki().saveDocument(this.translationFrDocument, this.oldcore.getXWikiContext());",
          "178:         doThrow(new AccessDeniedException(Right.SCRIPT, null, translationRootDocument.getDocumentReference()))",
          "179:             .when(this.oldcore.getMockAuthorizationManager()).checkAccess(Right.ADMIN, null,",
          "180:                 TRANSLATION_ROOT_REFERENCE.getWikiReference());",
          "181:     }",
          "183:     @Test",
          "184:     void checkTranslationWithExpectedRights() throws Exception",
          "185:     {",
          "186:         this.translationFrDocument.setAuthorReference(ADMIN_USER_REFERENCE);",
          "187:         this.translationFrDocument.setContentAuthorReference(ADMIN_USER_REFERENCE);",
          "188:         this.oldcore.getSpyXWiki().saveDocument(this.translationFrDocument, this.oldcore.getXWikiContext());",
          "189:         Translation frTranslation = this.localization.getTranslation(\"xwiki.translation\", Locale.FRENCH);",
          "190:         assertEquals(\"fr\", frTranslation.getRawSource());",
          "192:         verify(this.oldcore.getMockAuthorizationManager(), times(4)).checkAccess(Right.ADMIN, ADMIN_USER_REFERENCE,",
          "193:             TRANSLATION_ROOT_REFERENCE.getWikiReference());",
          "194:     }",
          "196:     @Test",
          "197:     void checkTranslationWithoutExpectedRights() throws Exception",
          "198:     {",
          "199:         Translation frTranslation = this.localization.getTranslation(\"xwiki.translation\", Locale.FRENCH);",
          "200:         assertEquals(",
          "201:             \"Failed to load and register the translation for locale [fr] from document [xwiki:space.Translations]. \"",
          "202:                 + \"Falling back to default locale.\",",
          "203:             this.logCapture.getMessage(0));",
          "204:         assertEquals(\"root\", frTranslation.getRawSource());",
          "205:         verify(this.oldcore.getMockAuthorizationManager()).checkAccess(Right.ADMIN, null,",
          "206:             TRANSLATION_ROOT_REFERENCE.getWikiReference());",
          "207:     }",
          "208: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}