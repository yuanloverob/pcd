{
  "cve_id": "CVE-2021-28957",
  "cve_desc": "An XSS vulnerability was discovered in python-lxml's clean module versions before 4.6.3. When disabling the safe_attrs_only and forms arguments, the Cleaner class does not remove the formaction attribute allowing for JS to bypass the sanitizer. A remote attacker could exploit this flaw to run arbitrary JS code on users who interact with incorrectly sanitized HTML. This issue is patched in lxml 4.6.3.",
  "repo": "lxml/lxml",
  "patch_hash": "10ec1b4e9f93713513a3264ed6158af22492f270",
  "patch_info": {
    "commit_hash": "10ec1b4e9f93713513a3264ed6158af22492f270",
    "repo": "lxml/lxml",
    "commit_url": "https://github.com/lxml/lxml/pull/316/commits/10ec1b4e9f93713513a3264ed6158af22492f270",
    "files": [
      "src/lxml/html/defs.py"
    ],
    "message": "Add formaction attribute to defs.link_attrs",
    "before_after_code_files": [
      "src/lxml/html/defs.py||src/lxml/html/defs.py"
    ]
  },
  "patch_diff": {
    "src/lxml/html/defs.py||src/lxml/html/defs.py": [
      "File: src/lxml/html/defs.py -> src/lxml/html/defs.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "23:     'usemap',",
      "24:     # Not standard:",
      "25:     'dynsrc', 'lowsrc',",
      "26:     ])",
      "28: # Not in the HTML 4 spec:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "26:     # HTML5 formaction",
      "27:     'formaction'",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2d01a1ba8984e0483ce6619b972832377f208a0d",
      "candidate_info": {
        "commit_hash": "2d01a1ba8984e0483ce6619b972832377f208a0d",
        "repo": "lxml/lxml",
        "commit_url": "https://github.com/lxml/lxml/commit/2d01a1ba8984e0483ce6619b972832377f208a0d",
        "files": [
          "src/lxml/html/defs.py",
          "src/lxml/html/tests/test_clean.py"
        ],
        "message": "Add HTML-5 \"formaction\" attribute to \"defs.link_attrs\" (GH-316)\n\nResolves https://bugs.launchpad.net/lxml/+bug/1888153\nSee https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-28957",
        "before_after_code_files": [
          "src/lxml/html/defs.py||src/lxml/html/defs.py",
          "src/lxml/html/tests/test_clean.py||src/lxml/html/tests/test_clean.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/lxml/lxml/pull/316"
        ],
        "olp_code_files": {
          "patch": [
            "src/lxml/html/defs.py||src/lxml/html/defs.py"
          ],
          "candidate": [
            "src/lxml/html/defs.py||src/lxml/html/defs.py"
          ]
        }
      },
      "candidate_diff": {
        "src/lxml/html/defs.py||src/lxml/html/defs.py": [
          "File: src/lxml/html/defs.py -> src/lxml/html/defs.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "23:     'usemap',",
          "24:     # Not standard:",
          "25:     'dynsrc', 'lowsrc',",
          "26:     ])",
          "28: # Not in the HTML 4 spec:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "26:     # HTML5 formaction",
          "27:     'formaction'",
          "",
          "---------------"
        ],
        "src/lxml/html/tests/test_clean.py||src/lxml/html/tests/test_clean.py": [
          "File: src/lxml/html/tests/test_clean.py -> src/lxml/html/tests/test_clean.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "123:             b'<math><style>/* deleted */</style></math>',",
          "124:             lxml.html.tostring(clean_html(s)))",
          "127: def test_suite():",
          "128:     suite = unittest.TestSuite()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "126:     def test_formaction_attribute_in_button_input(self):",
          "127:         # The formaction attribute overrides the form's action and should be",
          "128:         # treated as a malicious link attribute",
          "129:         html = ('<form id=\"test\"><input type=\"submit\" formaction=\"javascript:alert(1)\"></form>'",
          "130:         '<button form=\"test\" formaction=\"javascript:alert(1)\">X</button>')",
          "131:         expected = ('<div><form id=\"test\"><input type=\"submit\" formaction=\"\"></form>'",
          "132:         '<button form=\"test\" formaction=\"\">X</button></div>')",
          "133:         cleaner = Cleaner(",
          "134:             forms=False,",
          "135:             safe_attrs_only=False,",
          "136:         )",
          "137:         self.assertEqual(",
          "138:             expected,",
          "139:             cleaner.clean_html(html))",
          "",
          "---------------"
        ]
      }
    }
  ]
}