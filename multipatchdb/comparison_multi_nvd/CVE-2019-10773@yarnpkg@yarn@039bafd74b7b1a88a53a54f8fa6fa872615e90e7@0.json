{
  "cve_id": "CVE-2019-10773",
  "cve_desc": "In Yarn before 1.21.1, the package install functionality can be abused to generate arbitrary symlinks on the host filesystem by using specially crafted \"bin\" keys. Existing files could be overwritten depending on the current user permission set.",
  "repo": "yarnpkg/yarn",
  "patch_hash": "039bafd74b7b1a88a53a54f8fa6fa872615e90e7",
  "patch_info": {
    "commit_hash": "039bafd74b7b1a88a53a54f8fa6fa872615e90e7",
    "repo": "yarnpkg/yarn",
    "commit_url": "https://github.com/yarnpkg/yarn/commit/039bafd74b7b1a88a53a54f8fa6fa872615e90e7",
    "files": [
      "__tests__/__snapshots__/normalize-manifest.js.snap",
      "__tests__/fixtures/normalize-manifest/dangerous bin name/actual.json",
      "__tests__/fixtures/normalize-manifest/dangerous bin name/expected.json",
      "__tests__/fixtures/normalize-manifest/dangerous bin values/actual.json",
      "__tests__/fixtures/normalize-manifest/dangerous bin values/expected.json",
      "__tests__/fixtures/normalize-manifest/empty bin string/expected.json",
      "src/reporters/lang/en.js",
      "src/util/normalize-manifest/fix.js",
      "src/util/normalize-manifest/util.js"
    ],
    "message": "Fixes bin overwrites (#7755)\n\n* Fixes potential file overwrite at install time\n\n* Fixes the regexp\n\n* Adds warnings\n\n* Fixes overzealous removals\n\n* Fixes test\n\n* Adds tests",
    "before_after_code_files": [
      "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap",
      "src/reporters/lang/en.js||src/reporters/lang/en.js",
      "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js",
      "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
    ]
  },
  "patch_diff": {
    "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap": [
      "File: __tests__/__snapshots__/normalize-manifest.js.snap -> __tests__/__snapshots__/normalize-manifest.js.snap",
      "--- Hunk 1 ---",
      "[Context before]",
      "60: ]",
      "61: `;",
      "63: exports[`dedupe all trivial dependencies: dedupe all trivial dependencies 1`] = `",
      "64: Array [",
      "65:   \"No license field\",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "63: exports[`dangerous bin name: dangerous bin name 1`] = `",
      "64: Array [",
      "65:   \"foo: Invalid bin entry for \\\\\"/tmp/foo\\\\\" (in \\\\\"foo\\\\\").\",",
      "66:   \"foo: Invalid bin entry for \\\\\"../tmp/foo\\\\\" (in \\\\\"foo\\\\\").\",",
      "67:   \"foo: Invalid bin entry for \\\\\"tmp/../../foo\\\\\" (in \\\\\"foo\\\\\").\",",
      "68:   \"foo: No license field\",",
      "69: ]",
      "70: `;",
      "72: exports[`dangerous bin values: dangerous bin values 1`] = `",
      "73: Array [",
      "74:   \"foo: Invalid bin entry for \\\\\"foo\\\\\" (in \\\\\"foo\\\\\").\",",
      "75:   \"foo: Invalid bin entry for \\\\\"bar\\\\\" (in \\\\\"foo\\\\\").\",",
      "76:   \"foo: Invalid bin entry for \\\\\"baz\\\\\" (in \\\\\"foo\\\\\").\",",
      "77:   \"foo: No license field\",",
      "78: ]",
      "79: `;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "93: exports[`empty bin string: empty bin string 1`] = `",
      "94: Array [",
      "95:   \"foo: No license field\",",
      "96: ]",
      "97: `;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "113:   \"foo: Invalid bin field for \\\\\"foo\\\\\".\",",
      "",
      "---------------"
    ],
    "src/reporters/lang/en.js||src/reporters/lang/en.js": [
      "File: src/reporters/lang/en.js -> src/reporters/lang/en.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "26:   couldntClearPackageFromCache: \"Couldn't clear package $0 from cache\",",
      "27:   clearedPackageFromCache: 'Cleared package $0 from cache',",
      "28:   packWroteTarball: 'Wrote tarball to $0.',",
      "30:   helpExamples: '  Examples:\\n$0\\n',",
      "31:   helpCommands: '  Commands:\\n$0\\n',",
      "32:   helpCommandsMore: '  Run `$0` for more information on specific commands.',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29:   invalidBinField: 'Invalid bin field for $0.',",
      "30:   invalidBinEntry: 'Invalid bin entry for $1 (in $0).',",
      "",
      "---------------"
    ],
    "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js": [
      "File: src/util/normalize-manifest/fix.js -> src/util/normalize-manifest/fix.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: import {MANIFEST_FIELDS} from '../../constants';",
      "4: import type {Reporter} from '../../reporters/index.js';",
      "6: import {normalizePerson, extractDescription} from './util.js';",
      "7: import {hostedGitFragmentToGitUrl} from '../../resolvers/index.js';",
      "8: import inferLicense from './infer-license.js';",
      "",
      "[Removed Lines]",
      "5: import {isValidLicense} from './util.js';",
      "",
      "[Added Lines]",
      "5: import {isValidBin, isValidLicense} from './util.js';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "12: const path = require('path');",
      "13: const url = require('url');",
      "15: const LICENSE_RENAMES: {[key: string]: ?string} = {",
      "16:   'MIT/X11': 'MIT',",
      "17:   X11: 'MIT',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "15: const VALID_BIN_KEYS = /^[a-z0-9_-]+$/i;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "159:     info.bin = {[name]: info.bin};",
      "160:   }",
      "163:   if (info.bundledDependencies) {",
      "164:     info.bundleDependencies = info.bundledDependencies;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "166:   if (typeof info.bin === 'object' && info.bin !== null) {",
      "167:     const bin: Object = info.bin;",
      "168:     for (const key of Object.keys(bin)) {",
      "169:       const target = bin[key];",
      "170:       if (!VALID_BIN_KEYS.test(key) || !isValidBin(target)) {",
      "171:         delete bin[key];",
      "172:         warn(reporter.lang('invalidBinEntry', info.name, key));",
      "173:       } else {",
      "174:         bin[key] = path.normalize(target);",
      "175:       }",
      "176:     }",
      "177:   } else if (typeof info.bin !== 'undefined') {",
      "178:     delete info.bin;",
      "179:     warn(reporter.lang('invalidBinField', info.name));",
      "180:   }",
      "",
      "---------------"
    ],
    "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js": [
      "File: src/util/normalize-manifest/util.js -> src/util/normalize-manifest/util.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: import type {PersonObject} from '../../types.js';",
      "5: const validateLicense = require('validate-npm-package-license');",
      "7: export function isValidLicense(license: string): boolean {",
      "8:   return !!license && validateLicense(license).validForNewPackages;",
      "9: }",
      "11: export function stringifyPerson(person: mixed): any {",
      "12:   if (!person || typeof person !== 'object') {",
      "13:     return person;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "5: const path = require('path');",
      "8: const PARENT_PATH = /^\\.\\.([\\\\\\/]|$)/;",
      "14: export function isValidBin(bin: string): boolean {",
      "15:   return !path.isAbsolute(bin) && !PARENT_PATH.test(path.normalize(bin));",
      "16: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "752ce39e0de09df42f17dc982b18f91c8130e613",
      "candidate_info": {
        "commit_hash": "752ce39e0de09df42f17dc982b18f91c8130e613",
        "repo": "yarnpkg/yarn",
        "commit_url": "https://github.com/yarnpkg/yarn/commit/752ce39e0de09df42f17dc982b18f91c8130e613",
        "files": [
          "src/util/normalize-manifest/fix.js",
          "src/util/normalize-manifest/util.js"
        ],
        "message": "Fixes potential file overwrite at install time",
        "before_after_code_files": [
          "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js",
          "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/yarnpkg/yarn/pull/7755"
        ],
        "olp_code_files": {
          "patch": [
            "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js",
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ],
          "candidate": [
            "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js",
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ]
        }
      },
      "candidate_diff": {
        "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js": [
          "File: src/util/normalize-manifest/fix.js -> src/util/normalize-manifest/fix.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import {MANIFEST_FIELDS} from '../../constants';",
          "4: import type {Reporter} from '../../reporters/index.js';",
          "6: import {normalizePerson, extractDescription} from './util.js';",
          "7: import {hostedGitFragmentToGitUrl} from '../../resolvers/index.js';",
          "8: import inferLicense from './infer-license.js';",
          "",
          "[Removed Lines]",
          "5: import {isValidLicense} from './util.js';",
          "",
          "[Added Lines]",
          "5: import {isValidBin, isValidLicense} from './util.js';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "12: const path = require('path');",
          "13: const url = require('url');",
          "15: const LICENSE_RENAMES: {[key: string]: ?string} = {",
          "16:   'MIT/X11': 'MIT',",
          "17:   X11: 'MIT',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15: const VALID_BIN_KEYS = /^[a-z0-9_-]+$/i;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "158:     const name = info.name.replace(/^@[^\\/]+\\//, '');",
          "159:     info.bin = {[name]: info.bin};",
          "160:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "162:   } else {",
          "163:     delete info.bin;",
          "164:   }",
          "168:   if (typeof info.bin === 'object' && info.bin !== null) {",
          "169:     const bin: Object = info.bin;",
          "170:     for (const key of Object.keys(bin)) {",
          "171:       const target = bin[key];",
          "172:       if (!VALID_BIN_KEYS.test(key) || !isValidBin(target)) {",
          "173:         delete bin[key];",
          "174:       } else {",
          "175:         bin[key] = path.normalize(target);",
          "176:       }",
          "177:     }",
          "",
          "---------------"
        ],
        "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js": [
          "File: src/util/normalize-manifest/util.js -> src/util/normalize-manifest/util.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: import type {PersonObject} from '../../types.js';",
          "5: const validateLicense = require('validate-npm-package-license');",
          "7: export function isValidLicense(license: string): boolean {",
          "8:   return !!license && validateLicense(license).validForNewPackages;",
          "9: }",
          "11: export function stringifyPerson(person: mixed): any {",
          "12:   if (!person || typeof person !== 'object') {",
          "13:     return person;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5: const path = require('path');",
          "8: const PARENT_PATH = /^\\.\\.([\\///]|$)/g;",
          "14: export function isValidBin(bin: string): boolean {",
          "15:   return !path.isAbsolute(bin) && !PARENT_PATH.test(path.normalize(bin));",
          "16: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4a752e8f7bb187b577b80a1bcb09d48cbc30e23",
      "candidate_info": {
        "commit_hash": "e4a752e8f7bb187b577b80a1bcb09d48cbc30e23",
        "repo": "yarnpkg/yarn",
        "commit_url": "https://github.com/yarnpkg/yarn/commit/e4a752e8f7bb187b577b80a1bcb09d48cbc30e23",
        "files": [
          "__tests__/__snapshots__/normalize-manifest.js.snap",
          "__tests__/fixtures/normalize-manifest/empty bin string/expected.json"
        ],
        "message": "Fixes test",
        "before_after_code_files": [
          "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/yarnpkg/yarn/pull/7755"
        ],
        "olp_code_files": {
          "patch": [
            "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap"
          ],
          "candidate": [
            "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap"
          ]
        }
      },
      "candidate_diff": {
        "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap": [
          "File: __tests__/__snapshots__/normalize-manifest.js.snap -> __tests__/__snapshots__/normalize-manifest.js.snap",
          "--- Hunk 1 ---",
          "[Context before]",
          "93: exports[`empty bin string: empty bin string 1`] = `",
          "94: Array [",
          "95:   \"foo: No license field\",",
          "96: ]",
          "97: `;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:   \"foo: Invalid bin field for \\\\\"foo\\\\\".\",",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "35a884ec448b4cad193feb08aa9ff20e7397894d",
      "candidate_info": {
        "commit_hash": "35a884ec448b4cad193feb08aa9ff20e7397894d",
        "repo": "yarnpkg/yarn",
        "commit_url": "https://github.com/yarnpkg/yarn/commit/35a884ec448b4cad193feb08aa9ff20e7397894d",
        "files": [
          "src/util/normalize-manifest/util.js"
        ],
        "message": "Fixes the regexp",
        "before_after_code_files": [
          "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/yarnpkg/yarn/pull/7755"
        ],
        "olp_code_files": {
          "patch": [
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ],
          "candidate": [
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ]
        }
      },
      "candidate_diff": {
        "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js": [
          "File: src/util/normalize-manifest/util.js -> src/util/normalize-manifest/util.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: const path = require('path');",
          "6: const validateLicense = require('validate-npm-package-license');",
          "10: export function isValidLicense(license: string): boolean {",
          "11:   return !!license && validateLicense(license).validForNewPackages;",
          "",
          "[Removed Lines]",
          "8: const PARENT_PATH = /^\\.\\.([\\///]|$)/g;",
          "",
          "[Added Lines]",
          "8: const PARENT_PATH = /^\\.\\.([\\\\\\/]|$)/g;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8cd85c9c463fb75df0621fc256126dca169bdc3f",
      "candidate_info": {
        "commit_hash": "8cd85c9c463fb75df0621fc256126dca169bdc3f",
        "repo": "yarnpkg/yarn",
        "commit_url": "https://github.com/yarnpkg/yarn/commit/8cd85c9c463fb75df0621fc256126dca169bdc3f",
        "files": [
          "__tests__/__snapshots__/normalize-manifest.js.snap",
          "__tests__/fixtures/normalize-manifest/dangerous bin name/actual.json",
          "__tests__/fixtures/normalize-manifest/dangerous bin name/expected.json",
          "__tests__/fixtures/normalize-manifest/dangerous bin values/actual.json",
          "__tests__/fixtures/normalize-manifest/dangerous bin values/expected.json",
          "src/util/normalize-manifest/util.js"
        ],
        "message": "Adds tests",
        "before_after_code_files": [
          "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap",
          "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/yarnpkg/yarn/pull/7755"
        ],
        "olp_code_files": {
          "patch": [
            "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap",
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ],
          "candidate": [
            "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap",
            "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js"
          ]
        }
      },
      "candidate_diff": {
        "__tests__/__snapshots__/normalize-manifest.js.snap||__tests__/__snapshots__/normalize-manifest.js.snap": [
          "File: __tests__/__snapshots__/normalize-manifest.js.snap -> __tests__/__snapshots__/normalize-manifest.js.snap",
          "--- Hunk 1 ---",
          "[Context before]",
          "60: ]",
          "61: `;",
          "63: exports[`dedupe all trivial dependencies: dedupe all trivial dependencies 1`] = `",
          "64: Array [",
          "65:   \"No license field\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "63: exports[`dangerous bin name: dangerous bin name 1`] = `",
          "64: Array [",
          "65:   \"foo: Invalid bin entry for \\\\\"/tmp/foo\\\\\" (in \\\\\"foo\\\\\").\",",
          "66:   \"foo: Invalid bin entry for \\\\\"../tmp/foo\\\\\" (in \\\\\"foo\\\\\").\",",
          "67:   \"foo: Invalid bin entry for \\\\\"tmp/../../foo\\\\\" (in \\\\\"foo\\\\\").\",",
          "68:   \"foo: No license field\",",
          "69: ]",
          "70: `;",
          "72: exports[`dangerous bin values: dangerous bin values 1`] = `",
          "73: Array [",
          "74:   \"foo: Invalid bin entry for \\\\\"foo\\\\\" (in \\\\\"foo\\\\\").\",",
          "75:   \"foo: Invalid bin entry for \\\\\"bar\\\\\" (in \\\\\"foo\\\\\").\",",
          "76:   \"foo: Invalid bin entry for \\\\\"baz\\\\\" (in \\\\\"foo\\\\\").\",",
          "77:   \"foo: No license field\",",
          "78: ]",
          "79: `;",
          "",
          "---------------"
        ],
        "src/util/normalize-manifest/util.js||src/util/normalize-manifest/util.js": [
          "File: src/util/normalize-manifest/util.js -> src/util/normalize-manifest/util.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: const path = require('path');",
          "6: const validateLicense = require('validate-npm-package-license');",
          "10: export function isValidLicense(license: string): boolean {",
          "11:   return !!license && validateLicense(license).validForNewPackages;",
          "",
          "[Removed Lines]",
          "8: const PARENT_PATH = /^\\.\\.([\\\\\\/]|$)/g;",
          "",
          "[Added Lines]",
          "8: const PARENT_PATH = /^\\.\\.([\\\\\\/]|$)/;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "85d8d79892e967f6529716a05cb4a9bc9769f811",
      "candidate_info": {
        "commit_hash": "85d8d79892e967f6529716a05cb4a9bc9769f811",
        "repo": "yarnpkg/yarn",
        "commit_url": "https://github.com/yarnpkg/yarn/commit/85d8d79892e967f6529716a05cb4a9bc9769f811",
        "files": [
          "src/util/normalize-manifest/fix.js"
        ],
        "message": "Fixes overzealous removals",
        "before_after_code_files": [
          "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/yarnpkg/yarn/pull/7755"
        ],
        "olp_code_files": {
          "patch": [
            "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js"
          ],
          "candidate": [
            "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js"
          ]
        }
      },
      "candidate_diff": {
        "src/util/normalize-manifest/fix.js||src/util/normalize-manifest/fix.js": [
          "File: src/util/normalize-manifest/fix.js -> src/util/normalize-manifest/fix.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "160:     const name = info.name.replace(/^@[^\\/]+\\//, '');",
          "161:     info.bin = {[name]: info.bin};",
          "164:   }",
          "",
          "[Removed Lines]",
          "162:   } else {",
          "163:     delete info.bin;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "171:       const target = bin[key];",
          "172:       if (!VALID_BIN_KEYS.test(key) || !isValidBin(target)) {",
          "173:         delete bin[key];",
          "175:       } else {",
          "176:         bin[key] = path.normalize(target);",
          "177:       }",
          "178:     }",
          "180:     delete info.bin;",
          "181:     warn(reporter.lang('invalidBinField', info.name));",
          "182:   }",
          "",
          "[Removed Lines]",
          "174:         warn(reporter.lang('invalidBinEntry', info.name));",
          "179:   } else {",
          "",
          "[Added Lines]",
          "172:         warn(reporter.lang('invalidBinEntry', info.name, key));",
          "177:   } else if (typeof info.bin !== 'undefined') {",
          "",
          "---------------"
        ]
      }
    }
  ]
}