{
  "cve_id": "CVE-2018-3728",
  "cve_desc": "hoek node module before 4.2.0 and 5.0.x before 5.0.3 suffers from a Modification of Assumed-Immutable Data (MAID) vulnerability via 'merge' and 'applyToDefaults' functions, which allows a malicious user to modify the prototype of \"Object\" via __proto__, causing the addition or modification of an existing property that will exist on all objects.",
  "repo": "hapijs/hoek",
  "patch_hash": "32ed5c9413321fbc37da5ca81a7cbab693786dee",
  "patch_info": {
    "commit_hash": "32ed5c9413321fbc37da5ca81a7cbab693786dee",
    "repo": "hapijs/hoek",
    "commit_url": "https://github.com/hapijs/hoek/commit/32ed5c9413321fbc37da5ca81a7cbab693786dee",
    "files": [
      "lib/index.js",
      "test/index.js"
    ],
    "message": "skip assignment to __proto__",
    "before_after_code_files": [
      "lib/index.js||lib/index.js",
      "test/index.js||test/index.js"
    ]
  },
  "patch_diff": {
    "lib/index.js||lib/index.js": [
      "File: lib/index.js -> lib/index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "115:     const keys = Object.keys(source);",
      "116:     for (let i = 0; i < keys.length; ++i) {",
      "117:         const key = keys[i];",
      "118:         const value = source[key];",
      "119:         if (value &&",
      "120:             typeof value === 'object') {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "118:         if (key === '__proto__') {",
      "119:             continue;",
      "120:         }",
      "",
      "---------------"
    ],
    "test/index.js||test/index.js": [
      "File: test/index.js -> test/index.js",
      "--- Hunk 1 ---",
      "[Context before]",
      "585:         Hoek.merge({ x: {} }, a);",
      "586:         expect(a.x.toString()).to.equal('abc');",
      "587:     });",
      "588: });",
      "590: describe('applyToDefaults()', () => {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "589:     it('skips __proto__', () => {",
      "591:         const a = '{ \"ok\": \"value\", \"__proto__\": { \"test\": \"value\" } }';",
      "593:         const b = Hoek.merge({}, JSON.parse(a));",
      "594:         expect(b).to.equal({ ok: 'value' });",
      "595:         expect(b.test).to.equal(undefined);",
      "596:     });",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "56f4849a179e398038c5e209a5bbfdbbe19b4b05",
      "candidate_info": {
        "commit_hash": "56f4849a179e398038c5e209a5bbfdbbe19b4b05",
        "repo": "hapijs/hoek",
        "commit_url": "https://github.com/hapijs/hoek/commit/56f4849a179e398038c5e209a5bbfdbbe19b4b05",
        "files": [
          "lib/index.js",
          "test/index.js"
        ],
        "message": "Support enumerable symbol properties in merge()",
        "before_after_code_files": [
          "lib/index.js||lib/index.js",
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/index.js||lib/index.js": [
          "File: lib/index.js -> lib/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "126:         return target;",
          "127:     }",
          "130:     for (let i = 0; i < keys.length; ++i) {",
          "131:         const key = keys[i];",
          "133:             continue;",
          "134:         }",
          "",
          "[Removed Lines]",
          "129:     const keys = Object.keys(source);",
          "132:         if (key === '__proto__') {",
          "",
          "[Added Lines]",
          "129:     const keys = Reflect.ownKeys(source);",
          "132:         if (key === '__proto__' ||",
          "133:             !Object.prototype.propertyIsEnumerable.call(source, key)) {",
          "",
          "---------------"
        ],
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "617:         expect(a.x).to.equal(/test/);",
          "618:     });",
          "620:     it('skips __proto__', () => {",
          "622:         const a = '{ \"ok\": \"value\", \"__proto__\": { \"test\": \"value\" } }';",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "620:     it('overrides Symbol properties', () => {",
          "622:         const sym = Symbol();",
          "623:         const a = { [sym]: 1 };",
          "625:         Hoek.merge({ [sym]: {} }, a);",
          "626:         expect(a[sym]).to.equal(1);",
          "627:     });",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5aed1a8c4a3d55722d1c799f2368857bf418d6df",
      "candidate_info": {
        "commit_hash": "5aed1a8c4a3d55722d1c799f2368857bf418d6df",
        "repo": "hapijs/hoek",
        "commit_url": "https://github.com/hapijs/hoek/commit/5aed1a8c4a3d55722d1c799f2368857bf418d6df",
        "files": [
          "lib/index.js",
          "test/index.js"
        ],
        "message": "skip assignment to __proto__",
        "before_after_code_files": [
          "lib/index.js||lib/index.js",
          "test/index.js||test/index.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ],
          "candidate": [
            "lib/index.js||lib/index.js",
            "test/index.js||test/index.js"
          ]
        }
      },
      "candidate_diff": {
        "lib/index.js||lib/index.js": [
          "File: lib/index.js -> lib/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "113:     const keys = Object.keys(source);",
          "114:     for (let i = 0; i < keys.length; ++i) {",
          "115:         const key = keys[i];",
          "116:         const value = source[key];",
          "117:         if (value &&",
          "118:             typeof value === 'object') {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116:         if (key === '__proto__') {",
          "117:             continue;",
          "118:         }",
          "",
          "---------------"
        ],
        "test/index.js||test/index.js": [
          "File: test/index.js -> test/index.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "614:         expect(a.x.toString()).to.equal('abc');",
          "615:         done();",
          "616:     });",
          "617: });",
          "619: describe('applyToDefaults()', () => {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "618:     it('skips __proto__', () => {",
          "620:         const a = '{ \"ok\": \"value\", \"__proto__\": { \"test\": \"value\" } }';",
          "622:         const b = Hoek.merge({}, JSON.parse(a));",
          "623:         expect(b).to.equal({ ok: 'value' });",
          "624:         expect(b.test).to.equal(undefined);",
          "625:     });",
          "",
          "---------------"
        ]
      }
    }
  ]
}