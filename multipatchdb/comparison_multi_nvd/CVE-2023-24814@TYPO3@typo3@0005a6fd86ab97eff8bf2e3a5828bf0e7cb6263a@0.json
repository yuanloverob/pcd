{
  "cve_id": "CVE-2023-24814",
  "cve_desc": "TYPO3 is a free and open source Content Management Framework released under the GNU General Public License. In affected versions the TYPO3 core component `GeneralUtility::getIndpEnv()` uses the unfiltered server environment variable `PATH_INFO`, which allows attackers to inject malicious content. In combination with the TypoScript setting `config.absRefPrefix=auto`, attackers can inject malicious HTML code to pages that have not been rendered and cached, yet. As a result, injected values would be cached and delivered to other website visitors (persisted cross-site scripting). Individual code which relies on the resolved value of `GeneralUtility::getIndpEnv('SCRIPT_NAME')` and corresponding usages (as shown below) are vulnerable as well. Additional investigations confirmed that at least Apache web server deployments using CGI (FPM, FCGI/FastCGI, and similar) are affected. However, there still might be the risk that other scenarios like nginx, IIS, or Apache/mod_php are vulnerable. The usage of server environment variable `PATH_INFO` has been removed from corresponding processings in `GeneralUtility::getIndpEnv()`. Besides that, the public property `TypoScriptFrontendController::$absRefPrefix` is encoded for both being used as a URI component and for being used as a prefix in an HTML context. This mitigates the cross-site scripting vulnerability. Users are advised to update to TYPO3 versions 8.7.51 ELTS, 9.5.40 ELTS, 10.4.35 LTS, 11.5.23 LTS and 12.2.0 which fix this problem. For users who are unable to patch in a timely manner the TypoScript setting `config.absRefPrefix` should at least be set to a static path value, instead of using auto - e.g. `config.absRefPrefix=/`. This workaround **does not fix all aspects of the vulnerability**, and is just considered to be an intermediate mitigation to the most prominent manifestation.",
  "repo": "TYPO3/typo3",
  "patch_hash": "0005a6fd86ab97eff8bf2e3a5828bf0e7cb6263a",
  "patch_info": {
    "commit_hash": "0005a6fd86ab97eff8bf2e3a5828bf0e7cb6263a",
    "repo": "TYPO3/typo3",
    "commit_url": "https://github.com/TYPO3/typo3/commit/0005a6fd86ab97eff8bf2e3a5828bf0e7cb6263a",
    "files": [
      "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
      "typo3/sysext/core/Classes/Http/NormalizedParams.php",
      "typo3/sysext/core/Classes/Utility/GeneralUtility.php",
      "typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php",
      "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
      "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
      "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
      "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
    ],
    "message": "[SECURITY] Prevent XSS due to wrong PATH_INFO evaluation\n\nAs already started in #88304 (but only for NormalizedParams)\nand later reverted in #89312 (because of cgi-bin problems),\nPATH_INFO is no longer considered as a preferable SCRIPT_NAME\nalternative. All known server configurations set SCRIPT_NAME\nthese days to a proper value when cgi.fix_pathinfo is set.\n\nThe fallback to PATH_INFO has been introduced with\nthe initial revision of TYPO3 and isn't needed at all nowadays,\nit's actually wrong, as a REQUEST_URI like /index.php/foo/bar\nwould incorrectly be interpreted as $scriptName == \"/foo/bar\",\nwhich let's all calculations on $scriptName fail and\neven leads to XSS where values derived from $scriptName are\nprinted without being escaped.\n\nAlso any ORIG_SCRIPT_NAME evaluation is dropped, as this variable\ncontains the SCRIPT_NAME that was set by the webserver configuration\nbefore PHP applied cgi.fix_pathinfo. Using ORIG_SCRIPT_NAME\neffectively meant bypassing PHP's pathinfo fix. It usually contains\nthe cgi-wrapper paths, which is why PATH_INFO was used to overrule\nwrong ORIG_SCRIPT_NAME values.\n\nGeneralUtility::getIndpEnv('PATH_INFO') is adapted to trust the\nservers PATH_INFO information, now that we no longer allow\nservers to send SCRIPT_NAME as PATH_INFO (we enforce\ncgi.fix_pathinfo=1 for CGI installations).\n\nThe normalized SCRIPT_NAME is now adapted to be encoded as a URL\npath by default, as all TYPO3 usages expect this to be an URL path.\nNote that $_SERVER['SCRIPT_NAME'] refers to the servers file\nsystem path, not the URL encoded value.\n\nThis SCRIPT_NAME sanitization actually enables:\n\na) TYPO3 to be run in a subfolder that contains characters\nthat need URL encoding\ne.g. `/test:site/` \u2013 url encoded that'd be `/test3Asite/`.\n\nb) prevention of XSS in case third party extensions\nmissed to escape any URL that is derived from SCRIPT_NAME\n(while making sure that properly escaped\noutput is not double escaped)\n\nResolves: #99651\nRelated: #88304\nRelated: #89312\nReleases: main, 11.5, 10.4\nChange-Id: Ief95253d764665db5182a15ce8ffd02ea02ee61e\nSecurity-Bulletin: TYPO3-CORE-SA-2023-001\nSecurity-References: CVE-2023-24814\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/77739\nTested-by: Oliver Hader <oliver.hader@typo3.org>\nReviewed-by: Oliver Hader <oliver.hader@typo3.org>",
    "before_after_code_files": [
      "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
      "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
      "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
      "typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php||typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php",
      "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
      "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
      "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
      "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
    ]
  },
  "patch_diff": {
    "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php": [
      "File: typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php -> typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "255:     }",
      "264:     protected static function getPathThisScriptNonCli()",
      "265:     {",
      "273:         }",
      "275:     }",
      "",
      "[Removed Lines]",
      "266:         $isCgi = Environment::isRunningOnCgiServer();",
      "267:         if ($isCgi && Environment::usesCgiFixPathInfo()) {",
      "268:             return $_SERVER['SCRIPT_FILENAME'];",
      "269:         }",
      "270:         $cgiPath = $_SERVER['ORIG_PATH_TRANSLATED'] ?? $_SERVER['PATH_TRANSLATED'] ?? '';",
      "271:         if ($cgiPath && $isCgi) {",
      "272:             return $cgiPath;",
      "274:         return $_SERVER['ORIG_SCRIPT_FILENAME'] ?? $_SERVER['SCRIPT_FILENAME'];",
      "",
      "[Added Lines]",
      "264:         if (Environment::isRunningOnCgiServer() && !Environment::usesCgiFixPathInfo()) {",
      "265:             throw new \\Exception('TYPO3 does only support being used with cgi.fix_pathinfo=1 on CGI server APIs.', 1675108421);",
      "268:         return $_SERVER['SCRIPT_FILENAME'];",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php": [
      "File: typo3/sysext/core/Classes/Http/NormalizedParams.php -> typo3/sysext/core/Classes/Http/NormalizedParams.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "311:         $requestHost = $this->requestHost = ($isHttps ? 'https://' : 'http://') . $httpHost;",
      "312:         $requestHostOnly = $this->requestHostOnly = self::determineRequestHostOnly($httpHost);",
      "313:         $this->requestPort = self::determineRequestPort($httpHost, $requestHostOnly);",
      "315:             $serverParams,",
      "316:             $configuration,",
      "317:             $isHttps,",
      "318:             $isBehindReverseProxy",
      "319:         );",
      "320:         $requestUri = $this->requestUri = self::determineRequestUri(",
      "321:             $serverParams,",
      "322:             $configuration,",
      "",
      "[Removed Lines]",
      "314:         $scriptName = $this->scriptName = self::determineScriptName(",
      "",
      "[Added Lines]",
      "314:         $scriptNameOnFileSystem = self::determineScriptName(",
      "320:         $scriptName = $this->scriptName = self::encodeFileSystemPathComponentForUrlPath($scriptNameOnFileSystem);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "329:         $requestDir = $this->requestDir = $requestHost . GeneralUtility::dirname($scriptName) . '/';",
      "330:         $this->remoteAddress = self::determineRemoteAddress($serverParams, $configuration, $isBehindReverseProxy);",
      "331:         $scriptFilename = $this->scriptFilename = $pathThisScript;",
      "333:         $siteUrl = $this->siteUrl = self::determineSiteUrl($requestDir, $pathThisScript, $pathSite . '/');",
      "334:         $this->sitePath = self::determineSitePath($requestHost, $siteUrl);",
      "335:         $this->siteScript = self::determineSiteScript($requestUrl, $siteUrl);",
      "",
      "[Removed Lines]",
      "332:         $this->documentRoot = self::determineDocumentRoot($scriptName, $scriptFilename);",
      "",
      "[Added Lines]",
      "333:         $this->documentRoot = self::determineDocumentRoot($scriptNameOnFileSystem, $scriptFilename);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "344:         $this->queryString = $serverParams['QUERY_STRING'] ?? '';",
      "345:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "348:     private static function encodeFileSystemPathComponentForUrlPath(string $path): string",
      "349:     {",
      "350:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
      "351:     }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "632:         bool $isHttps,",
      "633:         bool $isBehindReverseProxy",
      "634:     ): string {",
      "646:         if ($isBehindReverseProxy) {",
      "648:             if ($isHttps && !empty($configuration['reverseProxyPrefixSSL'])) {",
      "",
      "[Removed Lines]",
      "641:         $possiblePathInfo = ($serverParams['ORIG_PATH_INFO'] ?? '') ?: ($serverParams['PATH_INFO'] ?? '');",
      "642:         $possibleScriptName = ($serverParams['ORIG_SCRIPT_NAME'] ?? '') ?: ($serverParams['SCRIPT_NAME'] ?? '');",
      "643:         $scriptName = Environment::isRunningOnCgiServer() && $possiblePathInfo",
      "644:             ? $possiblePathInfo",
      "645:             : $possibleScriptName;",
      "",
      "[Added Lines]",
      "641:         $scriptName = $serverParams['SCRIPT_NAME'] ?? '';",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "786:     {",
      "",
      "[Removed Lines]",
      "785:     protected static function determineDocumentRoot(string $scriptName, string $scriptFilename): string",
      "",
      "[Added Lines]",
      "781:     protected static function determineDocumentRoot(string $scriptNameOnFileSystem, string $scriptFilename): string",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "792:         $webDocRoot = '';",
      "794:         $scriptFilenameArray = explode('/', strrev($scriptFilename));",
      "795:         $path = [];",
      "796:         foreach ($scriptNameArray as $segmentNumber => $segment) {",
      "",
      "[Removed Lines]",
      "793:         $scriptNameArray = explode('/', strrev($scriptName));",
      "",
      "[Added Lines]",
      "789:         $scriptNameArray = explode('/', strrev($scriptNameOnFileSystem));",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php": [
      "File: typo3/sysext/core/Classes/Utility/GeneralUtility.php -> typo3/sysext/core/Classes/Utility/GeneralUtility.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "2310:         $retVal = '';",
      "2311:         switch ((string)$getEnvName) {",
      "2312:             case 'SCRIPT_NAME':",
      "2318:                 if (self::cmpIP($_SERVER['REMOTE_ADDR'] ?? '', $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP'] ?? '')) {",
      "2319:                     if (self::getIndpEnv('TYPO3_SSL') && $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefixSSL']) {",
      "",
      "[Removed Lines]",
      "2313:                 $retVal = Environment::isRunningOnCgiServer()",
      "2314:                     && (($_SERVER['ORIG_PATH_INFO'] ?? false) ?: ($_SERVER['PATH_INFO'] ?? false))",
      "2315:                         ? (($_SERVER['ORIG_PATH_INFO'] ?? '') ?: ($_SERVER['PATH_INFO'] ?? ''))",
      "2316:                         : (($_SERVER['ORIG_SCRIPT_NAME'] ?? '') ?: ($_SERVER['SCRIPT_NAME'] ?? ''));",
      "",
      "[Added Lines]",
      "2313:                 $retVal = $_SERVER['SCRIPT_NAME'] ?? '';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2322:                         $retVal = $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefix'] . $retVal;",
      "2323:                     }",
      "2324:                 }",
      "2325:                 break;",
      "2326:             case 'SCRIPT_FILENAME':",
      "2327:                 $retVal = Environment::getCurrentScript();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2322:                 $retVal = self::encodeFileSystemPathComponentForUrlPath($retVal);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2350:                 }",
      "2351:                 break;",
      "2352:             case 'PATH_INFO':",
      "2364:                 break;",
      "2365:             case 'TYPO3_REV_PROXY':",
      "2366:                 $retVal = self::cmpIP($_SERVER['REMOTE_ADDR'] ?? '', $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP']);",
      "",
      "[Removed Lines]",
      "2361:                 if (!Environment::isRunningOnCgiServer()) {",
      "2362:                     $retVal = $_SERVER['PATH_INFO'] ?? '';",
      "2363:                 }",
      "",
      "[Added Lines]",
      "2351:                 $retVal = $_SERVER['PATH_INFO'] ?? '';",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2435:                 $SFN = self::getIndpEnv('SCRIPT_FILENAME');",
      "2437:                 $SFN_A = explode('/', strrev($SFN));",
      "2438:                 $acc = [];",
      "2439:                 foreach ($SN_A as $kk => $vv) {",
      "",
      "[Removed Lines]",
      "2436:                 $SN_A = explode('/', strrev(self::getIndpEnv('SCRIPT_NAME')));",
      "",
      "[Added Lines]",
      "2427:                 $SN_A = array_map('rawurldecode', explode('/', strrev(self::getIndpEnv('SCRIPT_NAME'))));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2558:         return !empty($_SERVER['HTTPS']) && strtolower($_SERVER['HTTPS']) !== 'off';",
      "2559:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2552:     protected static function encodeFileSystemPathComponentForUrlPath(string $path): string",
      "2553:     {",
      "2554:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
      "2555:     }",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php||typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php": [
      "File: typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php -> typo3/sysext/core/Tests/Acceptance/Support/Extension/ApplicationEnvironment.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "145:             'SCRIPT_NAME' => '/typo3/index.php',",
      "146:             'PHP_SELF' => '/typo3/index.php',",
      "147:             'SCRIPT_FILENAME' => $docRoot . '/index.php',",
      "149:             'QUERY_STRING' => $requestUrlParts['query'] ?? '',",
      "150:             'REQUEST_URI' => $requestUrlParts['path'] . (isset($requestUrlParts['query']) ? '?' . $requestUrlParts['query'] : ''),",
      "151:             'REQUEST_METHOD' => $method,",
      "",
      "[Removed Lines]",
      "148:             'PATH_TRANSLATED' => $docRoot . '/index.php',",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php": [
      "File: typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php -> typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "360:                 [],",
      "361:                 '',",
      "362:             ],",
      "412:                 [",
      "415:                     'SCRIPT_NAME' => '/script/name.php',",
      "416:                 ],",
      "417:                 [],",
      "418:                 '/script/name.php',",
      "419:             ],",
      "429:                 [",
      "431:                 ],",
      "432:                 [],",
      "434:             ],",
      "435:             'add proxy ssl prefix' => [",
      "436:                 [",
      "",
      "[Removed Lines]",
      "363:             'use ORIG_SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
      "364:                 [",
      "365:                     'ORIG_PATH_INFO' => '',",
      "366:                     'PATH_INFO' => '',",
      "367:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
      "368:                     'SCRIPT_NAME' => '/script/name.php',",
      "369:                 ],",
      "370:                 [],",
      "371:                 '/orig/script/name.php',",
      "372:             ],",
      "373:             'use ORIG_SCRIPT_NAME if PATH_INFO is set but empty' => [",
      "374:                 [",
      "375:                     'PATH_INFO' => '',",
      "376:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
      "377:                     'SCRIPT_NAME' => '/script/name.php',",
      "378:                 ],",
      "379:                 [],",
      "380:                 '/orig/script/name.php',",
      "381:             ],",
      "382:             'use SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
      "383:                 [",
      "384:                     'ORIG_PATH_INFO' => '',",
      "385:                     'PATH_INFO' => '',",
      "386:                     'ORIG_SCRIPT_NAME' => '',",
      "387:                     'SCRIPT_NAME' => '/script/name.php',",
      "388:                 ],",
      "389:                 [],",
      "390:                 '/script/name.php',",
      "391:             ],",
      "392:             'use SCRIPT_NAME if PATH_INFO is set but empty' => [",
      "393:                 [",
      "394:                     'PATH_INFO' => '',",
      "395:                     'ORIG_SCRIPT_NAME' => '',",
      "396:                     'SCRIPT_NAME' => '/script/name.php',",
      "397:                 ],",
      "398:                 [],",
      "399:                 '/script/name.php',",
      "400:             ],",
      "401:             'use SCRIPT_NAME if ORIG_PATH_INFO is set' => [",
      "402:                 [",
      "403:                     'ORIG_PATH_INFO' => '/foo/bar',",
      "404:                     'PATH_INFO' => '',",
      "405:                     'ORIG_SCRIPT_NAME' => '',",
      "406:                     'SCRIPT_NAME' => '/script/name.php',",
      "407:                 ],",
      "408:                 [],",
      "409:                 '/script/name.php',",
      "410:             ],",
      "411:             'use SCRIPT_NAME if PATH_INFO is set' => [",
      "413:                     'PATH_INFO' => '/foo/bar',",
      "414:                     'ORIG_SCRIPT_NAME' => '',",
      "420:             'use ORIG_SCRIPT_NAME' => [",
      "421:                 [",
      "422:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
      "423:                     'SCRIPT_NAME' => '/script/name.php',",
      "424:                 ],",
      "425:                 [],",
      "426:                 '/orig/script/name.php',",
      "427:             ],",
      "428:             'use SCRIPT_NAME' => [",
      "430:                     'SCRIPT_NAME' => '/script/name.php',",
      "433:                 '/script/name.php',",
      "",
      "[Added Lines]",
      "363:             'use SCRIPT_NAME' => [",
      "370:             'apply URL encoding to SCRIPT_NAME' => [",
      "372:                     'SCRIPT_NAME' => '/test:site/script/name.php',",
      "375:                 '/test%3Asite/script/name.php',",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "497:                 [],",
      "498:                 '/typo3/index.php?parameter=foo/bar&id=42',",
      "499:             ],",
      "500:             'prefix with proxy prefix with ssl if using REQUEST_URI' => [",
      "501:                 [",
      "502:                     'HTTP_HOST' => 'www.domain.com',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "442:             'use query string and script name in special subdirectory if REQUEST_URI is not set' => [",
      "443:                 [",
      "444:                     'QUERY_STRING' => 'parameter=foo/bar&id=42',",
      "445:                     'SCRIPT_NAME' => '/sub:dir/typo3/index.php',",
      "446:                 ],",
      "447:                 [],",
      "448:                 '/sub%3Adir/typo3/index.php?parameter=foo/bar&id=42',",
      "449:             ],",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "905:         $serverParams = [",
      "906:             'SCRIPT_NAME' => '/typo3/index.php',",
      "907:             'HTTP_HOST' => 'www.domain.com',",
      "909:         ];",
      "910:         $pathThisScript = '/var/www/myInstance/Web/typo3/index.php';",
      "911:         $pathSite = '/var/www/myInstance/Web';",
      "",
      "[Removed Lines]",
      "908:             'PATH_INFO' => '/typo3/index.php',",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "978:         return [",
      "979:             'not in a sub directory' => [",
      "980:                 [",
      "982:                     'HTTP_HOST' => 'www.domain.com',",
      "983:                 ],",
      "984:                 '/var/www/myInstance/Web/typo3/index.php',",
      "",
      "[Removed Lines]",
      "981:                     'SCRIPT_NAME' => '/typo3/index.php?id=42&foo=bar',",
      "",
      "[Added Lines]",
      "930:                     'SCRIPT_NAME' => '/typo3/index.php',",
      "931:                     'REQUEST_URI' => '/typo3/index.php?id=42&foo=bar',",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "987:             ],",
      "988:             'in a sub directory' => [",
      "989:                 [",
      "991:                     'HTTP_HOST' => 'www.domain.com',",
      "992:                 ],",
      "993:                 '/var/www/myInstance/Web/typo3/index.php',",
      "",
      "[Removed Lines]",
      "990:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
      "",
      "[Added Lines]",
      "940:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php',",
      "941:                     'REQUEST_URI' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1023:     public function getPathInfoReturnsExpectedValue(): void",
      "1024:     {",
      "1025:         $serverParams = [",
      "1027:         ];",
      "1029:         $serverRequestParameters = new NormalizedParams($serverParams, [], '', '');",
      "1030:         self::assertSame($expected, $serverRequestParameters->getPathInfo());",
      "1031:     }",
      "",
      "[Removed Lines]",
      "1026:             'PATH_INFO' => '/typo3/index.php',",
      "1028:         $expected = '/typo3/index.php';",
      "",
      "[Added Lines]",
      "977:             'PATH_INFO' => '/foo/bar',",
      "979:         $expected = '/foo/bar';",
      "",
      "---------------"
    ],
    "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php": [
      "File: typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php -> typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "31:     public function webProcessorAddsWebDataToLogRecord(): void",
      "32:     {",
      "34:         $_SERVER['REQUEST_URI'] = '';",
      "36:         $_SERVER['REMOTE_ADDR'] = '';",
      "37:         $_SERVER['QUERY_STRING'] = '';",
      "38:         $_SERVER['SSL_SESSION_ID'] = '';",
      "",
      "[Removed Lines]",
      "33:         $_SERVER['PATH_INFO'] = '';",
      "35:         $_SERVER['ORIG_SCRIPT_NAME'] = '';",
      "",
      "[Added Lines]",
      "34:         $_SERVER['SCRIPT_NAME'] = '';",
      "",
      "---------------"
    ],
    "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php": [
      "File: typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php -> typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "65:     protected function setUpFakeSitePathAndHost(): void",
      "66:     {",
      "68:         $_SERVER['HTTP_HOST'] = $this->testHostName;",
      "70:         $request = ServerRequestFactory::fromGlobals();",
      "",
      "[Removed Lines]",
      "67:         $_SERVER['ORIG_PATH_INFO'] = $_SERVER['PATH_INFO'] = $_SERVER['ORIG_SCRIPT_NAME'] = $_SERVER['SCRIPT_NAME'] = $this->testSitePath . 'index.php';",
      "",
      "[Added Lines]",
      "67:         $_SERVER['SCRIPT_NAME'] = $this->testSitePath . 'index.php';",
      "",
      "---------------"
    ],
    "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php": [
      "File: typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php -> typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "2423:         if (!$this->absRefPrefix) {",
      "2424:             return;",
      "2425:         }",
      "2426:         $search = [",
      "2427:             '\"_assets/',",
      "2428:             '\"typo3temp/',",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2426:         $encodedAbsRefPrefix = htmlspecialchars($this->absRefPrefix, ENT_QUOTES | ENT_HTML5);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2430:             '\"' . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
      "2431:         ];",
      "2432:         $replace = [",
      "2437:         ];",
      "2439:         $directories = GeneralUtility::trimExplode(',', $GLOBALS['TYPO3_CONF_VARS']['FE']['additionalAbsRefPrefixDirectories'], true);",
      "2440:         foreach ($directories as $directory) {",
      "2441:             $search[] = '\"' . $directory;",
      "2443:         }",
      "2444:         $this->content = str_replace(",
      "2445:             $search,",
      "",
      "[Removed Lines]",
      "2433:             '\"' . $this->absRefPrefix . '_assets/',",
      "2434:             '\"' . $this->absRefPrefix . 'typo3temp/',",
      "2435:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
      "2436:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
      "2442:             $replace[] = '\"' . $this->absRefPrefix . $directory;",
      "",
      "[Added Lines]",
      "2434:             '\"' . $encodedAbsRefPrefix . '_assets/',",
      "2435:             '\"' . $encodedAbsRefPrefix . 'typo3temp/',",
      "2436:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
      "2437:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
      "2443:             $replace[] = '\"' . $encodedAbsRefPrefix . $directory;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c568946b081ac3493d21c3bb6b5da767164e8c08",
      "candidate_info": {
        "commit_hash": "c568946b081ac3493d21c3bb6b5da767164e8c08",
        "repo": "TYPO3/typo3",
        "commit_url": "https://github.com/TYPO3/typo3/commit/c568946b081ac3493d21c3bb6b5da767164e8c08",
        "files": [
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php"
        ],
        "message": "[TASK] Modernize array function callbacks in GeneralUtility\n\nFunction callbacks are declared using the new PHP 8.1 feature\n\"first class callable\", which e.g. uses the named `trim(...)`\nfunction symbol, instead of the string `'trim'`.\n\nsee https://www.php.net/manual/en/functions.first_class_callable_syntax.php\n\nResolves: #100144\nReleases: main\nChange-Id: I708f86e022e397f3fcf32596043336b430e9c9ef\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/78097\nReviewed-by: Oliver Bartsch <bo@cedev.de>\nTested-by: core-ci <typo3@b13.com>\nTested-by: Oliver Bartsch <bo@cedev.de>\nReviewed-by: Christian Kuhn <lolli@schwarzbu.ch>\nReviewed-by: Benni Mack <benni@typo3.org>\nTested-by: Christian Kuhn <lolli@schwarzbu.ch>",
        "before_after_code_files": [
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php"
          ],
          "candidate": [
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php"
          ]
        }
      },
      "candidate_diff": {
        "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php": [
          "File: typo3/sysext/core/Classes/Utility/GeneralUtility.php -> typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "893:             return [$string];",
          "894:         }",
          "895:         $explodedValues = explode($delimiter, strrev($string), $limit);",
          "897:         return array_reverse($explodedValues);",
          "898:     }",
          "",
          "[Removed Lines]",
          "896:         $explodedValues = array_map('strrev', $explodedValues);",
          "",
          "[Added Lines]",
          "896:         $explodedValues = array_map(strrev(...), $explodedValues);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "918:         $result = explode($delim, (string)$string);",
          "919:         if ($removeEmptyValues) {",
          "922:         }",
          "924:         if ($limit === 0) {",
          "927:         }",
          "929:         if ($limit < 0) {",
          "932:         }",
          "",
          "[Removed Lines]",
          "921:             $result = array_values(array_filter($result, static fn ($item) => trim($item) !== ''));",
          "926:             return array_map('trim', $result);",
          "931:             return array_map('trim', array_slice($result, 0, $limit));",
          "",
          "[Added Lines]",
          "921:             $result = array_values(array_filter($result, static fn (string $item): bool => trim($item) !== ''));",
          "926:             return array_map(trim(...), $result);",
          "931:             return array_map(trim(...), array_slice($result, 0, $limit));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "937:         if ($tail) {",
          "938:             $result[] = implode($delim, $tail);",
          "939:         }",
          "941:     }",
          "",
          "[Removed Lines]",
          "940:         return array_map('trim', $result);",
          "",
          "[Added Lines]",
          "940:         return array_map(trim(...), $result);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2430:                 $SFN_A = explode('/', strrev($SFN));",
          "2431:                 $acc = [];",
          "2432:                 foreach ($SN_A as $kk => $vv) {",
          "",
          "[Removed Lines]",
          "2429:                 $SN_A = array_map('rawurldecode', explode('/', strrev(self::getIndpEnv('SCRIPT_NAME'))));",
          "",
          "[Added Lines]",
          "2429:                 $SN_A = array_map(rawurldecode(...), explode('/', strrev(self::getIndpEnv('SCRIPT_NAME'))));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2554:     protected static function encodeFileSystemPathComponentForUrlPath(string $path): string",
          "2555:     {",
          "2557:     }",
          "",
          "[Removed Lines]",
          "2556:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
          "",
          "[Added Lines]",
          "2556:         return implode('/', array_map(rawurlencode(...), explode('/', $path)));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fa9832df37101579d5d52498616cb31e37ac3804",
      "candidate_info": {
        "commit_hash": "fa9832df37101579d5d52498616cb31e37ac3804",
        "repo": "TYPO3/typo3",
        "commit_url": "https://github.com/TYPO3/typo3/commit/fa9832df37101579d5d52498616cb31e37ac3804",
        "files": [
          "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php",
          "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
        ],
        "message": "[SECURITY] Prevent XSS due to wrong PATH_INFO evaluation\n\nAs already started in #88304 (but only for NormalizedParams)\nand later reverted in #89312 (because of cgi-bin problems),\nPATH_INFO is no longer considered as a preferable SCRIPT_NAME\nalternative. All known server configurations set SCRIPT_NAME\nthese days to a proper value when cgi.fix_pathinfo is set.\n\nThe fallback to PATH_INFO has been introduced with\nthe initial revision of TYPO3 and isn't needed at all nowadays,\nit's actually wrong, as a REQUEST_URI like /index.php/foo/bar\nwould incorrectly be interpreted as $scriptName == \"/foo/bar\",\nwhich let's all calculations on $scriptName fail and\neven leads to XSS where values derived from $scriptName are\nprinted without being escaped.\n\nAlso any ORIG_SCRIPT_NAME evaluation is dropped, as this variable\ncontains the SCRIPT_NAME that was set by the webserver configuration\nbefore PHP applied cgi.fix_pathinfo. Using ORIG_SCRIPT_NAME\neffectively meant bypassing PHP's pathinfo fix. It usually contains\nthe cgi-wrapper paths, which is why PATH_INFO was used to overrule\nwrong ORIG_SCRIPT_NAME values.\n\nGeneralUtility::getIndpEnv('PATH_INFO') is adapted to trust the\nservers PATH_INFO information, now that we no longer allow\nservers to send SCRIPT_NAME as PATH_INFO (we enforce\ncgi.fix_pathinfo=1 for CGI installations).\n\nThe normalized SCRIPT_NAME is now adapted to be encoded as a URL\npath by default, as all TYPO3 usages expect this to be an URL path.\nNote that $_SERVER['SCRIPT_NAME'] refers to the servers file\nsystem path, not the URL encoded value.\n\nThis SCRIPT_NAME sanitization actually enables:\n\na) TYPO3 to be run in a subfolder that contains characters\nthat need URL encoding\ne.g. `/test:site/` \u2013 url encoded that'd be `/test3Asite/`.\n\nb) prevention of XSS in case third party extensions\nmissed to escape any URL that is derived from SCRIPT_NAME\n(while making sure that properly escaped\noutput is not double escaped)\n\nResolves: #99651\nRelated: #88304\nRelated: #89312\nReleases: main, 11.5, 10.4\nChange-Id: Ief95253d764665db5182a15ce8ffd02ea02ee61e\nSecurity-Bulletin: TYPO3-CORE-SA-2023-001\nSecurity-References: CVE-2023-24814\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/77737\nReviewed-by: Oliver Hader <oliver.hader@typo3.org>\nTested-by: Oliver Hader <oliver.hader@typo3.org>",
        "before_after_code_files": [
          "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php||typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php||typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php||typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php",
          "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
            "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
            "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
            "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
            "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
            "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
          ],
          "candidate": [
            "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
            "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
            "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
            "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
            "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
            "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
          ]
        }
      },
      "candidate_diff": {
        "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php": [
          "File: typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php -> typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "305:     }",
          "314:     protected static function getPathThisScriptNonCli()",
          "315:     {",
          "323:         }",
          "325:     }",
          "",
          "[Removed Lines]",
          "316:         $isCgi = Environment::isRunningOnCgiServer();",
          "317:         if ($isCgi && Environment::usesCgiFixPathInfo()) {",
          "318:             return $_SERVER['SCRIPT_FILENAME'];",
          "319:         }",
          "320:         $cgiPath = $_SERVER['ORIG_PATH_TRANSLATED'] ?? $_SERVER['PATH_TRANSLATED'] ?? '';",
          "321:         if ($cgiPath && $isCgi) {",
          "322:             return $cgiPath;",
          "324:         return $_SERVER['ORIG_SCRIPT_FILENAME'] ?? $_SERVER['SCRIPT_FILENAME'];",
          "",
          "[Added Lines]",
          "314:         if (Environment::isRunningOnCgiServer() && !Environment::usesCgiFixPathInfo()) {",
          "315:             throw new \\Exception('TYPO3 does only support being used with cgi.fix_pathinfo=1 on CGI server APIs.', 1675108421);",
          "318:         return $_SERVER['SCRIPT_FILENAME'];",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php": [
          "File: typo3/sysext/core/Classes/Http/NormalizedParams.php -> typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "304:         $requestHost = $this->requestHost = ($isHttps ? 'https://' : 'http://') . $httpHost;",
          "305:         $requestHostOnly = $this->requestHostOnly = self::determineRequestHostOnly($httpHost);",
          "306:         $this->requestPort = self::determineRequestPort($httpHost, $requestHostOnly);",
          "308:             $serverParams,",
          "309:             $configuration,",
          "310:             $isHttps,",
          "311:             $isBehindReverseProxy",
          "312:         );",
          "313:         $requestUri = $this->requestUri = self::determineRequestUri(",
          "314:             $serverParams,",
          "315:             $configuration,",
          "",
          "[Removed Lines]",
          "307:         $scriptName = $this->scriptName = self::determineScriptName(",
          "",
          "[Added Lines]",
          "307:         $scriptNameOnFileSystem = self::determineScriptName(",
          "313:         $scriptName = $this->scriptName = self::encodeFileSystemPathComponentForUrlPath($scriptNameOnFileSystem);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "322:         $requestDir = $this->requestDir = $requestHost . GeneralUtility::dirname($scriptName) . '/';",
          "323:         $this->remoteAddress = self::determineRemoteAddress($serverParams, $configuration, $isBehindReverseProxy);",
          "324:         $scriptFilename = $this->scriptFilename = $pathThisScript;",
          "326:         $siteUrl = $this->siteUrl = self::determineSiteUrl($requestDir, $pathThisScript, $pathSite . '/');",
          "327:         $this->sitePath = self::determineSitePath($requestHost, $siteUrl);",
          "328:         $this->siteScript = self::determineSiteScript($requestUrl, $siteUrl);",
          "",
          "[Removed Lines]",
          "325:         $this->documentRoot = self::determineDocumentRoot($scriptName, $scriptFilename);",
          "",
          "[Added Lines]",
          "326:         $this->documentRoot = self::determineDocumentRoot($scriptNameOnFileSystem, $scriptFilename);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "337:         $this->queryString = $serverParams['QUERY_STRING'] ?? '';",
          "338:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "341:     private static function encodeFileSystemPathComponentForUrlPath(string $path): string",
          "342:     {",
          "343:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
          "344:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "634:         bool $isHttps,",
          "635:         bool $isBehindReverseProxy",
          "636:     ): string {",
          "648:         if ($isBehindReverseProxy) {",
          "650:             if ($isHttps && !empty($configuration['reverseProxyPrefixSSL'])) {",
          "",
          "[Removed Lines]",
          "643:         $possiblePathInfo = ($serverParams['ORIG_PATH_INFO'] ?? '') ?: ($serverParams['PATH_INFO'] ?? '');",
          "644:         $possibleScriptName = ($serverParams['ORIG_SCRIPT_NAME'] ?? '') ?: ($serverParams['SCRIPT_NAME'] ?? '');",
          "645:         $scriptName = Environment::isRunningOnCgiServer() && $possiblePathInfo",
          "646:             ? $possiblePathInfo",
          "647:             : $possibleScriptName;",
          "",
          "[Added Lines]",
          "643:         $scriptName = $serverParams['SCRIPT_NAME'] ?? '';",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "788:     {",
          "",
          "[Removed Lines]",
          "787:     protected static function determineDocumentRoot(string $scriptName, string $scriptFilename): string",
          "",
          "[Added Lines]",
          "783:     protected static function determineDocumentRoot(string $scriptNameOnFileSystem, string $scriptFilename): string",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "794:         $webDocRoot = '';",
          "796:         $scriptFilenameArray = explode('/', strrev($scriptFilename));",
          "797:         $path = [];",
          "798:         foreach ($scriptNameArray as $segmentNumber => $segment) {",
          "",
          "[Removed Lines]",
          "795:         $scriptNameArray = explode('/', strrev($scriptName));",
          "",
          "[Added Lines]",
          "791:         $scriptNameArray = explode('/', strrev($scriptNameOnFileSystem));",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php": [
          "File: typo3/sysext/core/Classes/Utility/GeneralUtility.php -> typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2653:         $retVal = '';",
          "2654:         switch ((string)$getEnvName) {",
          "2655:             case 'SCRIPT_NAME':",
          "2661:                 if (self::cmpIP($_SERVER['REMOTE_ADDR'] ?? '', $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP'] ?? '')) {",
          "2662:                     if (self::getIndpEnv('TYPO3_SSL') && $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefixSSL']) {",
          "",
          "[Removed Lines]",
          "2656:                 $retVal = Environment::isRunningOnCgiServer()",
          "2657:                     && (($_SERVER['ORIG_PATH_INFO'] ?? false) ?: ($_SERVER['PATH_INFO'] ?? false))",
          "2658:                         ? (($_SERVER['ORIG_PATH_INFO'] ?? '') ?: ($_SERVER['PATH_INFO'] ?? ''))",
          "2659:                         : (($_SERVER['ORIG_SCRIPT_NAME'] ?? '') ?: ($_SERVER['SCRIPT_NAME'] ?? ''));",
          "",
          "[Added Lines]",
          "2656:                 $retVal = $_SERVER['SCRIPT_NAME'] ?? '';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2665:                         $retVal = $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefix'] . $retVal;",
          "2666:                     }",
          "2667:                 }",
          "2668:                 break;",
          "2669:             case 'SCRIPT_FILENAME':",
          "2670:                 $retVal = Environment::getCurrentScript();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2665:                 $retVal = self::encodeFileSystemPathComponentForUrlPath($retVal);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2693:                 }",
          "2694:                 break;",
          "2695:             case 'PATH_INFO':",
          "2707:                 break;",
          "2708:             case 'TYPO3_REV_PROXY':",
          "2709:                 $retVal = self::cmpIP($_SERVER['REMOTE_ADDR'], $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP']);",
          "",
          "[Removed Lines]",
          "2704:                 if (!Environment::isRunningOnCgiServer()) {",
          "2705:                     $retVal = $_SERVER['PATH_INFO'];",
          "2706:                 }",
          "",
          "[Added Lines]",
          "2694:                 $retVal = $_SERVER['PATH_INFO'] ?? '';",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2784:                 $SFN = self::getIndpEnv('SCRIPT_FILENAME');",
          "2786:                 $SFN_A = explode('/', strrev($SFN));",
          "2787:                 $acc = [];",
          "2788:                 foreach ($SN_A as $kk => $vv) {",
          "",
          "[Removed Lines]",
          "2785:                 $SN_A = explode('/', strrev(self::getIndpEnv('SCRIPT_NAME')));",
          "",
          "[Added Lines]",
          "2776:                 $SN_A = array_map('rawurldecode', explode('/', strrev(self::getIndpEnv('SCRIPT_NAME'))));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2973:         return !empty($_SERVER['HTTPS']) && strtolower($_SERVER['HTTPS']) !== 'off';",
          "2974:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2967:     protected static function encodeFileSystemPathComponentForUrlPath(string $path): string",
          "2968:     {",
          "2969:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
          "2970:     }",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php -> typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "369:                 [],",
          "370:                 ''",
          "371:             ],",
          "421:                 [",
          "424:                     'SCRIPT_NAME' => '/script/name.php',",
          "425:                 ],",
          "426:                 [],",
          "427:                 '/script/name.php',",
          "428:             ],",
          "430:                 [",
          "433:                 ],",
          "434:                 [],",
          "443:             ],",
          "444:             'add proxy ssl prefix' => [",
          "445:                 [",
          "",
          "[Removed Lines]",
          "372:             'use ORIG_SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
          "373:                 [",
          "374:                     'ORIG_PATH_INFO' => '',",
          "375:                     'PATH_INFO' => '',",
          "376:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "377:                     'SCRIPT_NAME' => '/script/name.php',",
          "378:                 ],",
          "379:                 [],",
          "380:                 '/orig/script/name.php',",
          "381:             ],",
          "382:             'use ORIG_SCRIPT_NAME if PATH_INFO is set but empty' => [",
          "383:                 [",
          "384:                     'PATH_INFO' => '',",
          "385:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "386:                     'SCRIPT_NAME' => '/script/name.php',",
          "387:                 ],",
          "388:                 [],",
          "389:                 '/orig/script/name.php',",
          "390:             ],",
          "391:             'use SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
          "392:                 [",
          "393:                     'ORIG_PATH_INFO' => '',",
          "394:                     'PATH_INFO' => '',",
          "395:                     'ORIG_SCRIPT_NAME' => '',",
          "396:                     'SCRIPT_NAME' => '/script/name.php',",
          "397:                 ],",
          "398:                 [],",
          "399:                 '/script/name.php',",
          "400:             ],",
          "401:             'use SCRIPT_NAME if PATH_INFO is set but empty' => [",
          "402:                 [",
          "403:                     'PATH_INFO' => '',",
          "404:                     'ORIG_SCRIPT_NAME' => '',",
          "405:                     'SCRIPT_NAME' => '/script/name.php',",
          "406:                 ],",
          "407:                 [],",
          "408:                 '/script/name.php',",
          "409:             ],",
          "410:             'use SCRIPT_NAME if ORIG_PATH_INFO is set' => [",
          "411:                 [",
          "412:                     'ORIG_PATH_INFO' => '/foo/bar',",
          "413:                     'PATH_INFO' => '',",
          "414:                     'ORIG_SCRIPT_NAME' => '',",
          "415:                     'SCRIPT_NAME' => '/script/name.php',",
          "416:                 ],",
          "417:                 [],",
          "418:                 '/script/name.php',",
          "419:             ],",
          "420:             'use SCRIPT_NAME if PATH_INFO is set' => [",
          "422:                     'PATH_INFO' => '/foo/bar',",
          "423:                     'ORIG_SCRIPT_NAME' => '',",
          "429:             'use ORIG_SCRIPT_NAME' => [",
          "431:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "432:                     'SCRIPT_NAME' => '/script/name.php',",
          "435:                 '/orig/script/name.php',",
          "436:             ],",
          "437:             'use SCRIPT_NAME' => [",
          "438:                 [",
          "439:                     'SCRIPT_NAME' => '/script/name.php',",
          "440:                 ],",
          "441:                 [],",
          "442:                 '/script/name.php',",
          "",
          "[Added Lines]",
          "372:             'use SCRIPT_NAME' => [",
          "379:             'apply URL encoding to SCRIPT_NAME' => [",
          "381:                     'SCRIPT_NAME' => '/test:site/script/name.php',",
          "384:                 '/test%3Asite/script/name.php',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "509:                 [],",
          "510:                 '/typo3/index.php?route=foo/bar&id=42',",
          "511:             ],",
          "512:             'prefix with proxy prefix with ssl if using REQUEST_URI' => [",
          "513:                 [",
          "514:                     'HTTP_HOST' => 'www.domain.com',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "454:             'use query string and script name in special subdirectory if REQUEST_URI is not set' => [",
          "455:                 [",
          "456:                     'QUERY_STRING' => 'parameter=foo/bar&id=42',",
          "457:                     'SCRIPT_NAME' => '/sub:dir/typo3/index.php',",
          "458:                 ],",
          "459:                 [],",
          "460:                 '/sub%3Adir/typo3/index.php?parameter=foo/bar&id=42',",
          "461:             ],",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "936:         $serverParams = [",
          "937:             'SCRIPT_NAME' => '/typo3/index.php',",
          "938:             'HTTP_HOST' => 'www.domain.com',",
          "940:         ];",
          "941:         $pathThisScript = '/var/www/myInstance/Web/typo3/index.php';",
          "942:         $pathSite = '/var/www/myInstance/Web';",
          "",
          "[Removed Lines]",
          "939:             'PATH_INFO' => '/typo3/index.php',",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1000:         return [",
          "1001:             'not in a sub directory' => [",
          "1002:                 [",
          "1004:                     'HTTP_HOST' => 'www.domain.com',",
          "1005:                 ],",
          "1006:                 '/var/www/myInstance/Web/typo3/index.php',",
          "",
          "[Removed Lines]",
          "1003:                     'SCRIPT_NAME' => '/typo3/index.php?id=42&foo=bar',",
          "",
          "[Added Lines]",
          "952:                     'SCRIPT_NAME' => '/typo3/index.php',",
          "953:                     'REQUEST_URI' => '/typo3/index.php?id=42&foo=bar',",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1009:             ],",
          "1010:             'in a sub directory' => [",
          "1011:                 [",
          "1013:                     'HTTP_HOST' => 'www.domain.com',",
          "1014:                 ],",
          "1015:                 '/var/www/myInstance/Web/typo3/index.php',",
          "",
          "[Removed Lines]",
          "1012:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
          "",
          "[Added Lines]",
          "962:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php',",
          "963:                     'REQUEST_URI' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1049:     public function getPathInfoReturnsExpectedValue()",
          "1050:     {",
          "1051:         $serverParams = [",
          "1053:         ];",
          "1055:         $serverRequestParameters = new NormalizedParams($serverParams, [], '', '');",
          "1056:         self::assertSame($expected, $serverRequestParameters->getPathInfo());",
          "1057:     }",
          "",
          "[Removed Lines]",
          "1052:             'PATH_INFO' => '/typo3/index.php',",
          "1054:         $expected = '/typo3/index.php';",
          "",
          "[Added Lines]",
          "1003:             'PATH_INFO' => '/foo/bar',",
          "1005:         $expected = '/foo/bar';",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php -> typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:     public function webProcessorAddsWebDataToLogRecord()",
          "35:     {",
          "37:         $_SERVER['REQUEST_URI'] = '';",
          "39:         $_SERVER['REMOTE_ADDR'] = '';",
          "40:         $_SERVER['QUERY_STRING'] = '';",
          "41:         $_SERVER['SSL_SESSION_ID'] = '';",
          "",
          "[Removed Lines]",
          "36:         $_SERVER['PATH_INFO'] = '';",
          "38:         $_SERVER['ORIG_SCRIPT_NAME'] = '';",
          "",
          "[Added Lines]",
          "37:         $_SERVER['SCRIPT_NAME'] = '';",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php||typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php -> typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "636:         $bePath = Environment::getBackendPath();",
          "637:         $subfolderFake = basename(Environment::getPublicPath());",
          "639:         Environment::initialize(",
          "640:             Environment::getContext(),",
          "641:             true,",
          "",
          "[Removed Lines]",
          "638:         $_SERVER['ORIG_SCRIPT_NAME'] = '/' . $subfolderFake . '/typo3/index.php';",
          "",
          "[Added Lines]",
          "638:         $_SERVER['SCRIPT_NAME'] = '/' . $subfolderFake . '/typo3/index.php';",
          "",
          "---------------"
        ],
        "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php||typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php": [
          "File: typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php -> typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "377:         $_GET['route'] = '/test/Path';",
          "378:         $_SERVER['HTTP_HOST'] = 'baseuri';",
          "379:         $_SERVER['SCRIPT_NAME'] = '/index.php';",
          "381:         $_SERVER['REMOTE_ADDR'] = '127.0.0.1';",
          "382:         $this->mockRequest->expects(self::any())->method('getBaseUri')->willReturn('http://baseuri');",
          "383:         $this->uriBuilder->setCreateAbsoluteUri(true);",
          "",
          "[Removed Lines]",
          "380:         $_SERVER['ORIG_SCRIPT_NAME'] = '/index.php';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "405:         $_GET['route'] = '/test/Path';",
          "406:         $_SERVER['HTTP_HOST'] = 'baseuri';",
          "407:         $_SERVER['SCRIPT_NAME'] = '/typo3/index.php';",
          "409:         $_SERVER['REMOTE_ADDR'] = '127.0.0.1';",
          "410:         $this->mockRequest->expects(self::any())->method('getBaseUri')->willReturn('http://baseuri');",
          "411:         $this->uriBuilder->setCreateAbsoluteUri(true);",
          "",
          "[Removed Lines]",
          "408:         $_SERVER['ORIG_SCRIPT_NAME'] = '/typo3/index.php';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php": [
          "File: typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php -> typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "76:     protected function setUpFakeSitePathAndHost()",
          "77:     {",
          "79:         $_SERVER['HTTP_HOST'] = $this->testHostName;",
          "80:     }",
          "",
          "[Removed Lines]",
          "78:         $_SERVER['ORIG_PATH_INFO'] = $_SERVER['PATH_INFO'] = $_SERVER['ORIG_SCRIPT_NAME'] = $_SERVER['SCRIPT_NAME'] = $this->testSitePath . TYPO3_mainDir;",
          "",
          "[Added Lines]",
          "78:         $_SERVER['SCRIPT_NAME'] = $this->testSitePath . TYPO3_mainDir;",
          "",
          "---------------"
        ],
        "typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php||typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php": [
          "File: typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php -> typo3/sysext/fluid/Tests/Unit/Core/Widget/WidgetRequestBuilderTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:             'REMOTE_ADDR' => 'foo',",
          "81:             'SSL_SESSION_ID' => 'foo',",
          "82:             'REQUEST_URI' => 'foo',",
          "84:             'REQUEST_METHOD' => 'foo'",
          "85:         ];",
          "86:         $_GET = [",
          "",
          "[Removed Lines]",
          "83:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "83:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "100:             'REMOTE_ADDR' => 'foo',",
          "101:             'SSL_SESSION_ID' => 'foo',",
          "102:             'REQUEST_URI' => 'foo',",
          "104:             'REQUEST_METHOD' => 'foo'",
          "105:         ];",
          "106:         $_GET = [",
          "",
          "[Removed Lines]",
          "103:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "103:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "121:             'REMOTE_ADDR' => 'foo',",
          "122:             'SSL_SESSION_ID' => 'foo',",
          "123:             'REQUEST_URI' => 'foo',",
          "125:             'REQUEST_METHOD' => 'foo'",
          "126:         ];",
          "127:         $_GET = [",
          "",
          "[Removed Lines]",
          "124:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "124:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "142:             'REMOTE_ADDR' => 'foo',",
          "143:             'SSL_SESSION_ID' => 'foo',",
          "144:             'REQUEST_URI' => 'foo',",
          "146:             'REQUEST_METHOD' => 'POST'",
          "147:         ];",
          "148:         $_GET = [",
          "",
          "[Removed Lines]",
          "145:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "145:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "162:             'REMOTE_ADDR' => 'foo',",
          "163:             'SSL_SESSION_ID' => 'foo',",
          "164:             'REQUEST_URI' => 'foo',",
          "166:             'REQUEST_METHOD' => 'POST'",
          "167:         ];",
          "168:         $_GET = [",
          "",
          "[Removed Lines]",
          "165:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "165:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "186:             'REMOTE_ADDR' => 'foo',",
          "187:             'SSL_SESSION_ID' => 'foo',",
          "188:             'REQUEST_URI' => 'foo',",
          "190:             'REQUEST_METHOD' => 'GET'",
          "191:         ];",
          "192:         $_GET = [",
          "",
          "[Removed Lines]",
          "189:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "189:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "210:             'REMOTE_ADDR' => 'foo',",
          "211:             'SSL_SESSION_ID' => 'foo',",
          "212:             'REQUEST_URI' => 'foo',",
          "214:             'REQUEST_METHOD' => 'foo'",
          "215:         ];",
          "216:         $_GET = [",
          "",
          "[Removed Lines]",
          "213:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "213:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "231:             'REMOTE_ADDR' => 'foo',",
          "232:             'SSL_SESSION_ID' => 'foo',",
          "233:             'REQUEST_URI' => 'foo',",
          "235:             'REQUEST_METHOD' => 'foo'",
          "236:         ];",
          "237:         $_GET = [",
          "",
          "[Removed Lines]",
          "234:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "234:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "252:             'REMOTE_ADDR' => 'foo',",
          "253:             'SSL_SESSION_ID' => 'foo',",
          "254:             'REQUEST_URI' => 'foo',",
          "256:             'REQUEST_METHOD' => 'foo'",
          "257:         ];",
          "258:         $_GET = [",
          "",
          "[Removed Lines]",
          "255:             'ORIG_SCRIPT_NAME' => 'foo',",
          "",
          "[Added Lines]",
          "255:             'SCRIPT_NAME' => 'foo',",
          "",
          "---------------"
        ],
        "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php": [
          "File: typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php -> typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3420:         if (!$this->absRefPrefix) {",
          "3421:             return;",
          "3422:         }",
          "3423:         $search = [",
          "3424:             '\"typo3temp/',",
          "3425:             '\"' . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3423:         $encodedAbsRefPrefix = htmlspecialchars($this->absRefPrefix, ENT_QUOTES | ENT_HTML5);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3427:             '\"' . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "3428:         ];",
          "3429:         $replace = [",
          "3434:         ];",
          "3436:         $storageRepository = GeneralUtility::makeInstance(StorageRepository::class);",
          "",
          "[Removed Lines]",
          "3430:             '\"' . $this->absRefPrefix . 'typo3temp/',",
          "3431:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
          "3432:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getBackendPath()) . '/ext/',",
          "3433:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "",
          "[Added Lines]",
          "3431:             '\"' . $encodedAbsRefPrefix . 'typo3temp/',",
          "3432:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
          "3433:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getBackendPath()) . '/ext/',",
          "3434:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3439:             if ($storage->getDriverType() === 'Local' && $storage->isPublic() && $storage->isOnline()) {",
          "3440:                 $folder = $storage->getPublicUrl($storage->getRootLevelFolder(), true);",
          "3441:                 $search[] = '\"' . $folder;",
          "3443:             }",
          "3444:         }",
          "3446:         $directories = GeneralUtility::trimExplode(',', $GLOBALS['TYPO3_CONF_VARS']['FE']['additionalAbsRefPrefixDirectories'], true);",
          "3447:         foreach ($directories as $directory) {",
          "3448:             $search[] = '\"' . $directory;",
          "3450:         }",
          "3451:         $this->content = str_replace(",
          "3452:             $search,",
          "",
          "[Removed Lines]",
          "3442:                 $replace[] = '\"' . $this->absRefPrefix . $folder;",
          "3449:             $replace[] = '\"' . $this->absRefPrefix . $directory;",
          "",
          "[Added Lines]",
          "3443:                 $replace[] = '\"' . $encodedAbsRefPrefix . $folder;",
          "3450:             $replace[] = '\"' . $encodedAbsRefPrefix . $directory;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b809408340b00569d4979b7c4a6bf1d334f9a580",
      "candidate_info": {
        "commit_hash": "b809408340b00569d4979b7c4a6bf1d334f9a580",
        "repo": "TYPO3/typo3",
        "commit_url": "https://github.com/TYPO3/typo3/commit/b809408340b00569d4979b7c4a6bf1d334f9a580",
        "files": [
          "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php",
          "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
        ],
        "message": "[SECURITY] Prevent XSS due to wrong PATH_INFO evaluation\n\nAs already started in #88304 (but only for NormalizedParams)\nand later reverted in #89312 (because of cgi-bin problems),\nPATH_INFO is no longer considered as a preferable SCRIPT_NAME\nalternative. All known server configurations set SCRIPT_NAME\nthese days to a proper value when cgi.fix_pathinfo is set.\n\nThe fallback to PATH_INFO has been introduced with\nthe initial revision of TYPO3 and isn't needed at all nowadays,\nit's actually wrong, as a REQUEST_URI like /index.php/foo/bar\nwould incorrectly be interpreted as $scriptName == \"/foo/bar\",\nwhich let's all calculations on $scriptName fail and\neven leads to XSS where values derived from $scriptName are\nprinted without being escaped.\n\nAlso any ORIG_SCRIPT_NAME evaluation is dropped, as this variable\ncontains the SCRIPT_NAME that was set by the webserver configuration\nbefore PHP applied cgi.fix_pathinfo. Using ORIG_SCRIPT_NAME\neffectively meant bypassing PHP's pathinfo fix. It usually contains\nthe cgi-wrapper paths, which is why PATH_INFO was used to overrule\nwrong ORIG_SCRIPT_NAME values.\n\nGeneralUtility::getIndpEnv('PATH_INFO') is adapted to trust the\nservers PATH_INFO information, now that we no longer allow\nservers to send SCRIPT_NAME as PATH_INFO (we enforce\ncgi.fix_pathinfo=1 for CGI installations).\n\nThe normalized SCRIPT_NAME is now adapted to be encoded as a URL\npath by default, as all TYPO3 usages expect this to be an URL path.\nNote that $_SERVER['SCRIPT_NAME'] refers to the servers file\nsystem path, not the URL encoded value.\n\nThis SCRIPT_NAME sanitization actually enables:\n\na) TYPO3 to be run in a subfolder that contains characters\nthat need URL encoding\ne.g. `/test:site/` \u2013 url encoded that'd be `/test3Asite/`.\n\nb) prevention of XSS in case third party extensions\nmissed to escape any URL that is derived from SCRIPT_NAME\n(while making sure that properly escaped\noutput is not double escaped)\n\nResolves: #99651\nRelated: #88304\nRelated: #89312\nReleases: main, 11.5, 10.4\nChange-Id: Ief95253d764665db5182a15ce8ffd02ea02ee61e\nSecurity-Bulletin: TYPO3-CORE-SA-2023-001\nSecurity-References: CVE-2023-24814\nReviewed-on: https://review.typo3.org/c/Packages/TYPO3.CMS/+/77738\nReviewed-by: Oliver Hader <oliver.hader@typo3.org>\nTested-by: Oliver Hader <oliver.hader@typo3.org>",
        "before_after_code_files": [
          "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php||typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php",
          "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php||typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php||typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
            "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
            "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
            "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
            "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
            "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
          ],
          "candidate": [
            "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
            "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php",
            "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php",
            "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
            "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
            "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
            "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php"
          ]
        }
      },
      "candidate_diff": {
        "typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php||typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php": [
          "File: typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php -> typo3/sysext/core/Classes/Core/SystemEnvironmentBuilder.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "264:     }",
          "273:     protected static function getPathThisScriptNonCli()",
          "274:     {",
          "282:         }",
          "284:     }",
          "",
          "[Removed Lines]",
          "275:         $isCgi = Environment::isRunningOnCgiServer();",
          "276:         if ($isCgi && Environment::usesCgiFixPathInfo()) {",
          "277:             return $_SERVER['SCRIPT_FILENAME'];",
          "278:         }",
          "279:         $cgiPath = $_SERVER['ORIG_PATH_TRANSLATED'] ?? $_SERVER['PATH_TRANSLATED'] ?? '';",
          "280:         if ($cgiPath && $isCgi) {",
          "281:             return $cgiPath;",
          "283:         return $_SERVER['ORIG_SCRIPT_FILENAME'] ?? $_SERVER['SCRIPT_FILENAME'];",
          "",
          "[Added Lines]",
          "273:         if (Environment::isRunningOnCgiServer() && !Environment::usesCgiFixPathInfo()) {",
          "274:             throw new \\Exception('TYPO3 does only support being used with cgi.fix_pathinfo=1 on CGI server APIs.', 1675108421);",
          "277:         return $_SERVER['SCRIPT_FILENAME'];",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Http/NormalizedParams.php||typo3/sysext/core/Classes/Http/NormalizedParams.php": [
          "File: typo3/sysext/core/Classes/Http/NormalizedParams.php -> typo3/sysext/core/Classes/Http/NormalizedParams.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "308:         $requestHost = $this->requestHost = ($isHttps ? 'https://' : 'http://') . $httpHost;",
          "309:         $requestHostOnly = $this->requestHostOnly = self::determineRequestHostOnly($httpHost);",
          "310:         $this->requestPort = self::determineRequestPort($httpHost, $requestHostOnly);",
          "312:             $serverParams,",
          "313:             $configuration,",
          "314:             $isHttps,",
          "315:             $isBehindReverseProxy",
          "316:         );",
          "317:         $requestUri = $this->requestUri = self::determineRequestUri(",
          "318:             $serverParams,",
          "319:             $configuration,",
          "",
          "[Removed Lines]",
          "311:         $scriptName = $this->scriptName = self::determineScriptName(",
          "",
          "[Added Lines]",
          "311:         $scriptNameOnFileSystem = self::determineScriptName(",
          "317:         $scriptName = $this->scriptName = self::encodeFileSystemPathComponentForUrlPath($scriptNameOnFileSystem);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "326:         $requestDir = $this->requestDir = $requestHost . GeneralUtility::dirname($scriptName) . '/';",
          "327:         $this->remoteAddress = self::determineRemoteAddress($serverParams, $configuration, $isBehindReverseProxy);",
          "328:         $scriptFilename = $this->scriptFilename = $pathThisScript;",
          "330:         $siteUrl = $this->siteUrl = self::determineSiteUrl($requestDir, $pathThisScript, $pathSite . '/');",
          "331:         $this->sitePath = self::determineSitePath($requestHost, $siteUrl);",
          "332:         $this->siteScript = self::determineSiteScript($requestUrl, $siteUrl);",
          "",
          "[Removed Lines]",
          "329:         $this->documentRoot = self::determineDocumentRoot($scriptName, $scriptFilename);",
          "",
          "[Added Lines]",
          "330:         $this->documentRoot = self::determineDocumentRoot($scriptNameOnFileSystem, $scriptFilename);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "341:         $this->queryString = $serverParams['QUERY_STRING'] ?? '';",
          "342:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:     private static function encodeFileSystemPathComponentForUrlPath(string $path): string",
          "346:     {",
          "347:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
          "348:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "629:         bool $isHttps,",
          "630:         bool $isBehindReverseProxy",
          "631:     ): string {",
          "643:         if ($isBehindReverseProxy) {",
          "645:             if ($isHttps && !empty($configuration['reverseProxyPrefixSSL'])) {",
          "",
          "[Removed Lines]",
          "638:         $possiblePathInfo = ($serverParams['ORIG_PATH_INFO'] ?? '') ?: ($serverParams['PATH_INFO'] ?? '');",
          "639:         $possibleScriptName = ($serverParams['ORIG_SCRIPT_NAME'] ?? '') ?: ($serverParams['SCRIPT_NAME'] ?? '');",
          "640:         $scriptName = Environment::isRunningOnCgiServer() && $possiblePathInfo",
          "641:             ? $possiblePathInfo",
          "642:             : $possibleScriptName;",
          "",
          "[Added Lines]",
          "638:         $scriptName = $serverParams['SCRIPT_NAME'] ?? '';",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "783:     {",
          "",
          "[Removed Lines]",
          "782:     protected static function determineDocumentRoot(string $scriptName, string $scriptFilename): string",
          "",
          "[Added Lines]",
          "778:     protected static function determineDocumentRoot(string $scriptNameOnFileSystem, string $scriptFilename): string",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "789:         $webDocRoot = '';",
          "791:         $scriptFilenameArray = explode('/', strrev($scriptFilename));",
          "792:         $path = [];",
          "793:         foreach ($scriptNameArray as $segmentNumber => $segment) {",
          "",
          "[Removed Lines]",
          "790:         $scriptNameArray = explode('/', strrev($scriptName));",
          "",
          "[Added Lines]",
          "786:         $scriptNameArray = explode('/', strrev($scriptNameOnFileSystem));",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Classes/Utility/GeneralUtility.php||typo3/sysext/core/Classes/Utility/GeneralUtility.php": [
          "File: typo3/sysext/core/Classes/Utility/GeneralUtility.php -> typo3/sysext/core/Classes/Utility/GeneralUtility.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "2478:         $retVal = '';",
          "2479:         switch ((string)$getEnvName) {",
          "2480:             case 'SCRIPT_NAME':",
          "2486:                 if (self::cmpIP($_SERVER['REMOTE_ADDR'] ?? '', $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP'] ?? '')) {",
          "2487:                     if (self::getIndpEnv('TYPO3_SSL') && $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefixSSL']) {",
          "",
          "[Removed Lines]",
          "2481:                 $retVal = Environment::isRunningOnCgiServer()",
          "2482:                     && (($_SERVER['ORIG_PATH_INFO'] ?? false) ?: ($_SERVER['PATH_INFO'] ?? false))",
          "2483:                         ? (($_SERVER['ORIG_PATH_INFO'] ?? '') ?: ($_SERVER['PATH_INFO'] ?? ''))",
          "2484:                         : (($_SERVER['ORIG_SCRIPT_NAME'] ?? '') ?: ($_SERVER['SCRIPT_NAME'] ?? ''));",
          "",
          "[Added Lines]",
          "2481:                 $retVal = $_SERVER['SCRIPT_NAME'] ?? '';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2490:                         $retVal = $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyPrefix'] . $retVal;",
          "2491:                     }",
          "2492:                 }",
          "2493:                 break;",
          "2494:             case 'SCRIPT_FILENAME':",
          "2495:                 $retVal = Environment::getCurrentScript();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2490:                 $retVal = self::encodeFileSystemPathComponentForUrlPath($retVal);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2518:                 }",
          "2519:                 break;",
          "2520:             case 'PATH_INFO':",
          "2532:                 break;",
          "2533:             case 'TYPO3_REV_PROXY':",
          "2534:                 $retVal = self::cmpIP($_SERVER['REMOTE_ADDR'] ?? '', $GLOBALS['TYPO3_CONF_VARS']['SYS']['reverseProxyIP']);",
          "",
          "[Removed Lines]",
          "2529:                 if (!Environment::isRunningOnCgiServer()) {",
          "2530:                     $retVal = $_SERVER['PATH_INFO'] ?? '';",
          "2531:                 }",
          "",
          "[Added Lines]",
          "2519:                 $retVal = $_SERVER['PATH_INFO'] ?? '';",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2603:                 $SFN = self::getIndpEnv('SCRIPT_FILENAME');",
          "2605:                 $SFN_A = explode('/', strrev($SFN));",
          "2606:                 $acc = [];",
          "2607:                 foreach ($SN_A as $kk => $vv) {",
          "",
          "[Removed Lines]",
          "2604:                 $SN_A = explode('/', strrev(self::getIndpEnv('SCRIPT_NAME')));",
          "",
          "[Added Lines]",
          "2595:                 $SN_A = array_map('rawurldecode', explode('/', strrev(self::getIndpEnv('SCRIPT_NAME'))));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2741:         return !empty($_SERVER['HTTPS']) && strtolower($_SERVER['HTTPS']) !== 'off';",
          "2742:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2735:     protected static function encodeFileSystemPathComponentForUrlPath(string $path): string",
          "2736:     {",
          "2737:         return implode('/', array_map('rawurlencode', explode('/', $path)));",
          "2738:     }",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php||typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php": [
          "File: typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php -> typo3/sysext/core/Tests/Acceptance/Support/Extension/BackendCoreEnvironment.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "155:             'SCRIPT_NAME' => '/typo3/index.php',",
          "156:             'PHP_SELF' => '/typo3/index.php',",
          "157:             'SCRIPT_FILENAME' => $docRoot . '/index.php',",
          "159:             'QUERY_STRING' => $requestUrlParts['query'] ?? '',",
          "160:             'REQUEST_URI' => $requestUrlParts['path'] . (isset($requestUrlParts['query']) ? '?' . $requestUrlParts['query'] : ''),",
          "161:             'REQUEST_METHOD' => $method,",
          "",
          "[Removed Lines]",
          "158:             'PATH_TRANSLATED' => $docRoot . '/index.php',",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php||typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php -> typo3/sysext/core/Tests/Unit/Http/NormalizedParamsTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "369:                 [],",
          "370:                 '',",
          "371:             ],",
          "421:                 [",
          "424:                     'SCRIPT_NAME' => '/script/name.php',",
          "425:                 ],",
          "426:                 [],",
          "427:                 '/script/name.php',",
          "428:             ],",
          "438:                 [",
          "440:                 ],",
          "441:                 [],",
          "443:             ],",
          "444:             'add proxy ssl prefix' => [",
          "445:                 [",
          "",
          "[Removed Lines]",
          "372:             'use ORIG_SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
          "373:                 [",
          "374:                     'ORIG_PATH_INFO' => '',",
          "375:                     'PATH_INFO' => '',",
          "376:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "377:                     'SCRIPT_NAME' => '/script/name.php',",
          "378:                 ],",
          "379:                 [],",
          "380:                 '/orig/script/name.php',",
          "381:             ],",
          "382:             'use ORIG_SCRIPT_NAME if PATH_INFO is set but empty' => [",
          "383:                 [",
          "384:                     'PATH_INFO' => '',",
          "385:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "386:                     'SCRIPT_NAME' => '/script/name.php',",
          "387:                 ],",
          "388:                 [],",
          "389:                 '/orig/script/name.php',",
          "390:             ],",
          "391:             'use SCRIPT_NAME if ORIG_PATH_INFO is set but empty' => [",
          "392:                 [",
          "393:                     'ORIG_PATH_INFO' => '',",
          "394:                     'PATH_INFO' => '',",
          "395:                     'ORIG_SCRIPT_NAME' => '',",
          "396:                     'SCRIPT_NAME' => '/script/name.php',",
          "397:                 ],",
          "398:                 [],",
          "399:                 '/script/name.php',",
          "400:             ],",
          "401:             'use SCRIPT_NAME if PATH_INFO is set but empty' => [",
          "402:                 [",
          "403:                     'PATH_INFO' => '',",
          "404:                     'ORIG_SCRIPT_NAME' => '',",
          "405:                     'SCRIPT_NAME' => '/script/name.php',",
          "406:                 ],",
          "407:                 [],",
          "408:                 '/script/name.php',",
          "409:             ],",
          "410:             'use SCRIPT_NAME if ORIG_PATH_INFO is set' => [",
          "411:                 [",
          "412:                     'ORIG_PATH_INFO' => '/foo/bar',",
          "413:                     'PATH_INFO' => '',",
          "414:                     'ORIG_SCRIPT_NAME' => '',",
          "415:                     'SCRIPT_NAME' => '/script/name.php',",
          "416:                 ],",
          "417:                 [],",
          "418:                 '/script/name.php',",
          "419:             ],",
          "420:             'use SCRIPT_NAME if PATH_INFO is set' => [",
          "422:                     'PATH_INFO' => '/foo/bar',",
          "423:                     'ORIG_SCRIPT_NAME' => '',",
          "429:             'use ORIG_SCRIPT_NAME' => [",
          "430:                 [",
          "431:                     'ORIG_SCRIPT_NAME' => '/orig/script/name.php',",
          "432:                     'SCRIPT_NAME' => '/script/name.php',",
          "433:                 ],",
          "434:                 [],",
          "435:                 '/orig/script/name.php',",
          "436:             ],",
          "437:             'use SCRIPT_NAME' => [",
          "439:                     'SCRIPT_NAME' => '/script/name.php',",
          "442:                 '/script/name.php',",
          "",
          "[Added Lines]",
          "372:             'use SCRIPT_NAME' => [",
          "379:             'apply URL encoding to SCRIPT_NAME' => [",
          "381:                     'SCRIPT_NAME' => '/test:site/script/name.php',",
          "384:                 '/test%3Asite/script/name.php',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "509:                 [],",
          "510:                 '/typo3/index.php?parameter=foo/bar&id=42',",
          "511:             ],",
          "512:             'prefix with proxy prefix with ssl if using REQUEST_URI' => [",
          "513:                 [",
          "514:                     'HTTP_HOST' => 'www.domain.com',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "454:             'use query string and script name in special subdirectory if REQUEST_URI is not set' => [",
          "455:                 [",
          "456:                     'QUERY_STRING' => 'parameter=foo/bar&id=42',",
          "457:                     'SCRIPT_NAME' => '/sub:dir/typo3/index.php',",
          "458:                 ],",
          "459:                 [],",
          "460:                 '/sub%3Adir/typo3/index.php?parameter=foo/bar&id=42',",
          "461:             ],",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "936:         $serverParams = [",
          "937:             'SCRIPT_NAME' => '/typo3/index.php',",
          "938:             'HTTP_HOST' => 'www.domain.com',",
          "940:         ];",
          "941:         $pathThisScript = '/var/www/myInstance/Web/typo3/index.php';",
          "942:         $pathSite = '/var/www/myInstance/Web';",
          "",
          "[Removed Lines]",
          "939:             'PATH_INFO' => '/typo3/index.php',",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1013:         return [",
          "1014:             'not in a sub directory' => [",
          "1015:                 [",
          "1017:                     'HTTP_HOST' => 'www.domain.com',",
          "1018:                 ],",
          "1019:                 '/var/www/myInstance/Web/typo3/index.php',",
          "",
          "[Removed Lines]",
          "1016:                     'SCRIPT_NAME' => '/typo3/index.php?id=42&foo=bar',",
          "",
          "[Added Lines]",
          "965:                     'SCRIPT_NAME' => '/typo3/index.php',",
          "966:                     'REQUEST_URI' => '/typo3/index.php?id=42&foo=bar',",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1022:             ],",
          "1023:             'in a sub directory' => [",
          "1024:                 [",
          "1026:                     'HTTP_HOST' => 'www.domain.com',",
          "1027:                 ],",
          "1028:                 '/var/www/myInstance/Web/typo3/index.php',",
          "",
          "[Removed Lines]",
          "1025:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
          "",
          "[Added Lines]",
          "975:                     'SCRIPT_NAME' => '/some/sub/dir/typo3/index.php',",
          "976:                     'REQUEST_URI' => '/some/sub/dir/typo3/index.php?id=42&foo=bar',",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1062:     public function getPathInfoReturnsExpectedValue(): void",
          "1063:     {",
          "1064:         $serverParams = [",
          "1066:         ];",
          "1068:         $serverRequestParameters = new NormalizedParams($serverParams, [], '', '');",
          "1069:         self::assertSame($expected, $serverRequestParameters->getPathInfo());",
          "1070:     }",
          "",
          "[Removed Lines]",
          "1065:             'PATH_INFO' => '/typo3/index.php',",
          "1067:         $expected = '/typo3/index.php';",
          "",
          "[Added Lines]",
          "1016:             'PATH_INFO' => '/foo/bar',",
          "1018:         $expected = '/foo/bar';",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php||typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php -> typo3/sysext/core/Tests/Unit/Log/Processor/WebProcessorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:     public function webProcessorAddsWebDataToLogRecord(): void",
          "35:     {",
          "37:         $_SERVER['REQUEST_URI'] = '';",
          "39:         $_SERVER['REMOTE_ADDR'] = '';",
          "40:         $_SERVER['QUERY_STRING'] = '';",
          "41:         $_SERVER['SSL_SESSION_ID'] = '';",
          "",
          "[Removed Lines]",
          "36:         $_SERVER['PATH_INFO'] = '';",
          "38:         $_SERVER['ORIG_SCRIPT_NAME'] = '';",
          "",
          "[Added Lines]",
          "37:         $_SERVER['SCRIPT_NAME'] = '';",
          "",
          "---------------"
        ],
        "typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php||typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php": [
          "File: typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php -> typo3/sysext/core/Tests/Unit/Resource/ResourceCompressorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "638:         $bePath = Environment::getBackendPath();",
          "639:         $subfolderFake = basename(Environment::getPublicPath());",
          "641:         Environment::initialize(",
          "642:             Environment::getContext(),",
          "643:             true,",
          "",
          "[Removed Lines]",
          "640:         $_SERVER['ORIG_SCRIPT_NAME'] = '/' . $subfolderFake . '/typo3/index.php';",
          "",
          "[Added Lines]",
          "640:         $_SERVER['SCRIPT_NAME'] = '/' . $subfolderFake . '/typo3/index.php';",
          "",
          "---------------"
        ],
        "typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php||typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php": [
          "File: typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php -> typo3/sysext/extbase/Tests/Unit/Mvc/Web/Routing/UriBuilderTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "379:         $GLOBALS['TYPO3_REQUEST'] = $this->getRequestWithRouteAttribute();",
          "380:         $_SERVER['HTTP_HOST'] = 'baseuri';",
          "381:         $_SERVER['SCRIPT_NAME'] = '/index.php';",
          "383:         $_SERVER['REMOTE_ADDR'] = '127.0.0.1';",
          "384:         $this->uriBuilder->setCreateAbsoluteUri(true);",
          "385:         $expectedResult = 'http://baseuri/' . TYPO3_mainDir . 'test/Path?token=dummyToken';",
          "",
          "[Removed Lines]",
          "382:         $_SERVER['ORIG_SCRIPT_NAME'] = '/index.php';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "406:         $GLOBALS['TYPO3_REQUEST'] = $this->getRequestWithRouteAttribute();",
          "407:         $_SERVER['HTTP_HOST'] = 'baseuri';",
          "408:         $_SERVER['SCRIPT_NAME'] = '/typo3/index.php';",
          "410:         $_SERVER['REMOTE_ADDR'] = '127.0.0.1';",
          "411:         $this->uriBuilder->setCreateAbsoluteUri(true);",
          "412:         $expectedResult = 'http://baseuri/' . TYPO3_mainDir . 'test/Path?token=dummyToken';",
          "",
          "[Removed Lines]",
          "409:         $_SERVER['ORIG_SCRIPT_NAME'] = '/typo3/index.php';",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php||typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php": [
          "File: typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php -> typo3/sysext/felogin/Tests/Unit/Validation/RedirectUrlValidatorTest.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:     protected function setUpFakeSitePathAndHost(): void",
          "80:     {",
          "82:         $_SERVER['HTTP_HOST'] = $this->testHostName;",
          "84:         $request = ServerRequestFactory::fromGlobals();",
          "",
          "[Removed Lines]",
          "81:         $_SERVER['ORIG_PATH_INFO'] = $_SERVER['PATH_INFO'] = $_SERVER['ORIG_SCRIPT_NAME'] = $_SERVER['SCRIPT_NAME'] = $this->testSitePath . TYPO3_mainDir;",
          "",
          "[Added Lines]",
          "81:         $_SERVER['SCRIPT_NAME'] = $this->testSitePath . TYPO3_mainDir;",
          "",
          "---------------"
        ],
        "typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php||typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php": [
          "File: typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php -> typo3/sysext/frontend/Classes/Controller/TypoScriptFrontendController.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "3026:         if (!$this->absRefPrefix) {",
          "3027:             return;",
          "3028:         }",
          "3029:         $search = [",
          "3030:             '\"_assets/',",
          "3031:             '\"typo3temp/',",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3029:         $encodedAbsRefPrefix = htmlspecialchars($this->absRefPrefix, ENT_QUOTES | ENT_HTML5);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3034:             '\"' . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "3035:         ];",
          "3036:         $replace = [",
          "3042:         ];",
          "3044:         $directories = GeneralUtility::trimExplode(',', $GLOBALS['TYPO3_CONF_VARS']['FE']['additionalAbsRefPrefixDirectories'], true);",
          "3045:         foreach ($directories as $directory) {",
          "3046:             $search[] = '\"' . $directory;",
          "3048:         }",
          "3049:         $this->content = str_replace(",
          "3050:             $search,",
          "",
          "[Removed Lines]",
          "3037:             '\"' . $this->absRefPrefix . '_assets/',",
          "3038:             '\"' . $this->absRefPrefix . 'typo3temp/',",
          "3039:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
          "3040:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getBackendPath()) . '/ext/',",
          "3041:             '\"' . $this->absRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "3047:             $replace[] = '\"' . $this->absRefPrefix . $directory;",
          "",
          "[Added Lines]",
          "3038:             '\"' . $encodedAbsRefPrefix . '_assets/',",
          "3039:             '\"' . $encodedAbsRefPrefix . 'typo3temp/',",
          "3040:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getExtensionsPath()) . '/',",
          "3041:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getBackendPath()) . '/ext/',",
          "3042:             '\"' . $encodedAbsRefPrefix . PathUtility::stripPathSitePrefix(Environment::getFrameworkBasePath()) . '/',",
          "3048:             $replace[] = '\"' . $encodedAbsRefPrefix . $directory;",
          "",
          "---------------"
        ]
      }
    }
  ]
}