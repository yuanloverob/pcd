{
  "cve_id": "CVE-2023-24818",
  "cve_desc": "RIOT-OS, an operating system that supports Internet of Things devices, contains a network stack with the ability to process 6LoWPAN frames. Prior to version 2022.10, an attacker can send a crafted frame to the device resulting in a NULL pointer dereference. During forwarding of a fragment an uninitialized entry in the reassembly buffer is used. The NULL pointer dereference triggers a hard fault exception resulting in denial of service. Version 2022.10 fixes this issue. As a workaround, disable support for fragmented IP datagrams or apply the patches manually.",
  "repo": "RIOT-OS/RIOT",
  "patch_hash": "0bec3e245ed3815ad6c8cae54673f0021777768b",
  "patch_info": {
    "commit_hash": "0bec3e245ed3815ad6c8cae54673f0021777768b",
    "repo": "RIOT-OS/RIOT",
    "commit_url": "https://github.com/RIOT-OS/RIOT/commit/0bec3e245ed3815ad6c8cae54673f0021777768b",
    "files": [
      "sys/net/link_layer/ieee802154/ieee802154.c"
    ],
    "message": "ieee802154: Adjust parsing of IEEE 802.15.4 frame header",
    "before_after_code_files": [
      "sys/net/link_layer/ieee802154/ieee802154.c||sys/net/link_layer/ieee802154/ieee802154.c"
    ]
  },
  "patch_diff": {
    "sys/net/link_layer/ieee802154/ieee802154.c||sys/net/link_layer/ieee802154/ieee802154.c": [
      "File: sys/net/link_layer/ieee802154/ieee802154.c -> sys/net/link_layer/ieee802154/ieee802154.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "115: size_t ieee802154_get_frame_hdr_len(const uint8_t *mhr)",
      "116: {",
      "134:         return 0;",
      "135:     }",
      "136:     tmp = (mhr[1] & IEEE802154_FCF_SRC_ADDR_MASK);",
      "137:     if (tmp == IEEE802154_FCF_SRC_ADDR_VOID) {",
      "139:     }",
      "140:     else {",
      "141:         if (!(mhr[0] & IEEE802154_FCF_PAN_COMP)) {",
      "",
      "[Removed Lines]",
      "118:     uint8_t tmp;",
      "122:     tmp = (mhr[1] & IEEE802154_FCF_DST_ADDR_MASK);",
      "123:     if (tmp == IEEE802154_FCF_DST_ADDR_SHORT) {",
      "125:     }",
      "126:     else if (tmp == IEEE802154_FCF_DST_ADDR_LONG) {",
      "128:     }",
      "129:     else if (tmp != IEEE802154_FCF_DST_ADDR_VOID) {",
      "130:         return 0;",
      "131:     }",
      "132:     else if (mhr[0] & IEEE802154_FCF_PAN_COMP) {",
      "138:         return len;",
      "",
      "[Added Lines]",
      "118:     uint8_t tmp, has_dst = 0;",
      "121:     tmp = (mhr[0] & IEEE802154_FCF_TYPE_MASK);",
      "122:     if (tmp == IEEE802154_FCF_TYPE_ACK) {",
      "124:         return len;",
      "125:     } else if (tmp != IEEE802154_FCF_TYPE_BEACON) {",
      "127:         tmp = (mhr[1] & IEEE802154_FCF_DST_ADDR_MASK);",
      "128:         if (tmp == IEEE802154_FCF_DST_ADDR_SHORT) {",
      "130:             has_dst = 1;",
      "131:         }",
      "132:         else if (tmp == IEEE802154_FCF_DST_ADDR_LONG) {",
      "134:             has_dst = 1;",
      "135:         }",
      "136:         else if (tmp != IEEE802154_FCF_DST_ADDR_VOID) {",
      "137:             return 0;",
      "138:         }",
      "139:         else if (mhr[0] & IEEE802154_FCF_PAN_COMP) {",
      "141:             return 0;",
      "142:         }",
      "143:     } else if (mhr[0] & IEEE802154_FCF_PAN_COMP) {",
      "150:         return has_dst ? len : 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2709fbd827b688fe62df2c77c316914f4a3a6d4a",
      "candidate_info": {
        "commit_hash": "2709fbd827b688fe62df2c77c316914f4a3a6d4a",
        "repo": "RIOT-OS/RIOT",
        "commit_url": "https://github.com/RIOT-OS/RIOT/commit/2709fbd827b688fe62df2c77c316914f4a3a6d4a",
        "files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ],
        "message": "gnrc_sixlowpan_iphc: fix integer underflow in gnrc_sixlowpan_iphc_recv()",
        "before_after_code_files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/RIOT-OS/RIOT/pull/18817"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c": [
          "File: sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c -> sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "760:     iface = gnrc_netif_hdr_get_netif(netif->data);",
          "761:     payload_offset = _iphc_ipv6_decode(iphc_hdr, netif->data, iface,",
          "762:                                        ipv6->data);",
          "765:         _recv_error_release(sixlo, ipv6, rbuf);",
          "766:         return;",
          "767:     }",
          "",
          "[Removed Lines]",
          "763:     if (payload_offset == 0) {",
          "",
          "[Added Lines]",
          "763:     if ((payload_offset == 0) || (payload_offset > sixlo->size)) {",
          "765:         DEBUG(\"6lo iphc: malformed IPHC header\\n\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "781:                                                            &prev_nh_offset,",
          "782:                                                            ipv6,",
          "783:                                                            &uncomp_hdr_len);",
          "785:                         _recv_error_release(sixlo, ipv6, rbuf);",
          "786:                         return;",
          "787:                     }",
          "",
          "[Removed Lines]",
          "784:                     if (payload_offset == 0) {",
          "",
          "[Added Lines]",
          "785:                     if ((payload_offset == 0) || (payload_offset > sixlo->size)) {",
          "787:                         DEBUG(\"6lo iphc: malformed IPHC NHC IPv6 header\\n\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "796:                                                           prev_nh_offset,",
          "797:                                                           ipv6,",
          "798:                                                           &uncomp_hdr_len);",
          "800:                         _recv_error_release(sixlo, ipv6, rbuf);",
          "801:                         return;",
          "802:                     }",
          "",
          "[Removed Lines]",
          "799:                     if (payload_offset == 0) {",
          "",
          "[Added Lines]",
          "802:                     if ((payload_offset == 0) || (payload_offset > sixlo->size)) {",
          "804:                         DEBUG(\"6lo iphc: malformed IPHC NHC IPv6 header\\n\");",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "899:     ipv6_hdr = ipv6->data;",
          "900:     ipv6_hdr->len = byteorder_htons(payload_len);",
          "904:     if (rbuf != NULL) {",
          "905:         rbuf->super.current_size += (uncomp_hdr_len - payload_offset);",
          "906: #ifdef MODULE_GNRC_SIXLOWPAN_FRAG_VRB",
          "",
          "[Removed Lines]",
          "901:     memcpy(((uint8_t *)ipv6->data) + uncomp_hdr_len,",
          "902:            ((uint8_t *)sixlo->data) + payload_offset,",
          "903:            sixlo->size - payload_offset);",
          "",
          "[Added Lines]",
          "906:     if (sixlo->size > payload_offset) {",
          "907:         memcpy(((uint8_t *)ipv6->data) + uncomp_hdr_len,",
          "908:                ((uint8_t *)sixlo->data) + payload_offset,",
          "909:                sixlo->size - payload_offset);",
          "910:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4a081f86616cb5c9dd0b5d7b286da03285d1652a",
      "candidate_info": {
        "commit_hash": "4a081f86616cb5c9dd0b5d7b286da03285d1652a",
        "repo": "RIOT-OS/RIOT",
        "commit_url": "https://github.com/RIOT-OS/RIOT/commit/4a081f86616cb5c9dd0b5d7b286da03285d1652a",
        "files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ],
        "message": "gnrc_sixlowpan_iphc: fix packet type confusion in _iphc_encode()",
        "before_after_code_files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/RIOT-OS/RIOT/pull/18817"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c": [
          "File: sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c -> sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1613:         else {",
          "1614:             dispatch->next = ptr;",
          "1615:         }",
          "1627:         ptr = ptr->next;",
          "1628:     }",
          "",
          "[Removed Lines]",
          "1616:         if (ptr->type == GNRC_NETTYPE_UNDEF) {",
          "1619:             dispatch_size += sizeof(udp_hdr_t);",
          "1620:             break;  /* nothing special after UDP so quit even if more UNDEF",
          "1622:         }",
          "1623:         else {",
          "1624:             dispatch_size += ptr->size;",
          "1625:         }",
          "",
          "[Added Lines]",
          "1616:         dispatch_size += ptr->size;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "36a099e1ec52187a21c767b6bcc32eaec5690b75",
      "candidate_info": {
        "commit_hash": "36a099e1ec52187a21c767b6bcc32eaec5690b75",
        "repo": "RIOT-OS/RIOT",
        "commit_url": "https://github.com/RIOT-OS/RIOT/commit/36a099e1ec52187a21c767b6bcc32eaec5690b75",
        "files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ],
        "message": "gnrc_sixlowpan_iphc.c: dereference ipv6_hdr in DEBUG() after assignment",
        "before_after_code_files": [
          "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/RIOT-OS/RIOT/pull/18817"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c||sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c": [
          "File: sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c -> sys/net/gnrc/network_layer/sixlowpan/iphc/gnrc_sixlowpan_iphc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "843:             payload_len = (uint16_t)(rbuf->super.datagram_size - sizeof(ipv6_hdr_t));",
          "844:         }",
          "845: #ifdef MODULE_GNRC_SIXLOWPAN_FRAG_VRB",
          "849:         ipv6_hdr = ipv6->data;",
          "",
          "[Removed Lines]",
          "846:         DEBUG(\"6lo iphc: VRB present, trying to create entry for dst %s\\n\",",
          "847:               ipv6_addr_to_str(addr_str, &ipv6_hdr->dst, sizeof(addr_str)));",
          "",
          "[Added Lines]",
          "848:         DEBUG(\"6lo iphc: VRB present, trying to create entry for dst %s\\n\",",
          "849:               ipv6_addr_to_str(addr_str, &ipv6_hdr->dst, sizeof(addr_str)));",
          "",
          "---------------"
        ]
      }
    }
  ]
}