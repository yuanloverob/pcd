{
  "cve_id": "CVE-2020-13249",
  "cve_desc": "libmariadb/mariadb_lib.c in MariaDB Connector/C before 3.1.8 does not properly validate the content of an OK packet received from a server. NOTE: although mariadb_lib.c was originally based on code shipped for MySQL, this issue does not affect any MySQL components supported by Oracle.",
  "repo": "mariadb-corporation/mariadb-connector-c",
  "patch_hash": "2759b87d72926b7c9b5426437a7c8dd15ff57945",
  "patch_info": {
    "commit_hash": "2759b87d72926b7c9b5426437a7c8dd15ff57945",
    "repo": "mariadb-corporation/mariadb-connector-c",
    "commit_url": "https://github.com/mariadb-corporation/mariadb-connector-c/commit/2759b87d72926b7c9b5426437a7c8dd15ff57945",
    "files": [
      "libmariadb/mariadb_lib.c"
    ],
    "message": "sanity checks for client-supplied OK packet content\n\nreported by Matthias Kaiser, Apple Information Security",
    "before_after_code_files": [
      "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c"
    ]
  },
  "patch_diff": {
    "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c": [
      "File: libmariadb/mariadb_lib.c -> libmariadb/mariadb_lib.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "81: #define ASYNC_CONTEXT_DEFAULT_STACK_SIZE (4096*15)",
      "82: #define MA_RPL_VERSION_HACK \"5.5.5-\"",
      "84: #undef max_allowed_packet",
      "85: #undef net_buffer_length",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "84: #define CHARSET_NAME_LEN 64",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2140: int ma_read_ok_packet(MYSQL *mysql, uchar *pos, ulong length)",
      "2141: {",
      "2142:   size_t item_len;",
      "2143:   mysql->affected_rows= net_field_length_ll(&pos);",
      "2144:   mysql->insert_id=   net_field_length_ll(&pos);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2144:   uchar *end= mysql->net.read_pos+length;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2146:   pos+=2;",
      "2147:   mysql->warning_count=uint2korr(pos);",
      "2148:   pos+=2;",
      "2150:   {",
      "2151:     if ((item_len= net_field_length(&pos)))",
      "2152:       mysql->info=(char*) pos;",
      "2155:     if (mysql->server_capabilities & CLIENT_SESSION_TRACKING)",
      "",
      "[Removed Lines]",
      "2149:   if (pos < mysql->net.read_pos+length)",
      "",
      "[Added Lines]",
      "2152:   if (pos > end)",
      "2153:     goto corrupted;",
      "2154:   if (pos < end)",
      "2158:     if (pos + item_len > end)",
      "2159:       goto corrupted;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2160:       if (mysql->server_status & SERVER_SESSION_STATE_CHANGED)",
      "2161:       {",
      "2162:         int i;",
      "2164:         {",
      "2165:           LIST *session_item;",
      "2166:           MYSQL_LEX_STRING *str= NULL;",
      "2167:           enum enum_session_state_type si_type;",
      "2168:           uchar *old_pos= pos;",
      "2172:           if (mysql->info)",
      "2176:           {",
      "2177:             size_t plen;",
      "2178:             char *data;",
      "2180:             si_type= (enum enum_session_state_type)net_field_length(&pos);",
      "2181:             switch(si_type) {",
      "2182:             case SESSION_TRACK_SCHEMA:",
      "",
      "[Removed Lines]",
      "2163:         if (pos < mysql->net.read_pos + length)",
      "2175:           while (item_len > 0)",
      "2179:             old_pos= pos;",
      "",
      "[Added Lines]",
      "2170:         if (pos < end)",
      "2178:           if (pos + item_len > end)",
      "2179:             goto corrupted;",
      "2180:           end= pos + item_len;",
      "2186:           while (pos < end)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2186:               if (si_type != SESSION_TRACK_STATE_CHANGE)",
      "2188:               plen= net_field_length(&pos);",
      "2189:               if (!(session_item= ma_multi_malloc(0,",
      "2190:                                   &session_item, sizeof(LIST),",
      "2191:                                   &str, sizeof(MYSQL_LEX_STRING),",
      "2192:                                   &data, plen,",
      "2193:                                   NULL)))",
      "2199:               str->length= plen;",
      "2200:               str->str= data;",
      "2201:               memcpy(str->str, (char *)pos, plen);",
      "",
      "[Removed Lines]",
      "2194:               {",
      "2195:                 ma_clear_session_state(mysql);",
      "2196:                 SET_CLIENT_ERROR(mysql, CR_OUT_OF_MEMORY, SQLSTATE_UNKNOWN, 0);",
      "2197:                 return -1;",
      "2198:               }",
      "",
      "[Added Lines]",
      "2199:               if (pos + plen > end)",
      "2200:                 goto corrupted;",
      "2206:                   goto oom;",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "2218:                 if (!strncmp(str->str, \"character_set_client\", str->length))",
      "2219:                   set_charset= 1;",
      "2220:                 plen= net_field_length(&pos);",
      "2221:                 if (!(session_item= ma_multi_malloc(0,",
      "2222:                                     &session_item, sizeof(LIST),",
      "2223:                                     &str, sizeof(MYSQL_LEX_STRING),",
      "2224:                                     &data, plen,",
      "2225:                                     NULL)))",
      "2231:                 str->length= plen;",
      "2232:                 str->str= data;",
      "2233:                 memcpy(str->str, (char *)pos, plen);",
      "2234:                 pos+= plen;",
      "2235:                 session_item->data= str;",
      "2236:                 mysql->extension->session_state[si_type].list= list_add(mysql->extension->session_state[si_type].list, session_item);",
      "2238:                     strncmp(mysql->charset->csname, str->str, str->length) != 0)",
      "2239:                 {",
      "2242:                   memcpy(cs_name, str->str, str->length);",
      "2243:                   cs_name[str->length]= 0;",
      "2245:                     mysql->charset= cs_info;",
      "2246:                 }",
      "2247:               }",
      "",
      "[Removed Lines]",
      "2226:                 {",
      "2227:                   ma_clear_session_state(mysql);",
      "2228:                   SET_CLIENT_ERROR(mysql, CR_OUT_OF_MEMORY, SQLSTATE_UNKNOWN, 0);",
      "2229:                   return -1;",
      "2230:                 }",
      "2237:                 if (set_charset &&",
      "2240:                   char cs_name[64];",
      "2241:                   MARIADB_CHARSET_INFO *cs_info;",
      "2244:                   if ((cs_info = (MARIADB_CHARSET_INFO *)mysql_find_charset_name(cs_name)))",
      "",
      "[Added Lines]",
      "2229:                 if (pos + plen > end)",
      "2230:                   goto corrupted;",
      "2236:                   goto oom;",
      "2243:                 if (set_charset && str->length < CHARSET_NAME_LEN &&",
      "2246:                   char cs_name[CHARSET_NAME_LEN];",
      "2247:                   const MARIADB_CHARSET_INFO *cs_info;",
      "2250:                   if ((cs_info = mysql_find_charset_name(cs_name)))",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "2249:             default:",
      "2251:               plen= net_field_length(&pos);",
      "2252:               pos+= plen;",
      "2253:               break;",
      "2254:             }",
      "2256:           }",
      "2257:         }",
      "2258:         for (i= SESSION_TRACK_BEGIN; i <= SESSION_TRACK_END; i++)",
      "",
      "[Removed Lines]",
      "2255:             item_len-= (pos - old_pos);",
      "",
      "[Added Lines]",
      "2258:               if (pos + plen > end)",
      "2259:                 goto corrupted;",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "2267:   else if (mysql->server_capabilities & CLIENT_SESSION_TRACKING)",
      "2268:     ma_clear_session_state(mysql);",
      "2269:   return(0);",
      "2270: }",
      "2272: int mthd_my_read_query_result(MYSQL *mysql)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2278: oom:",
      "2279:   ma_clear_session_state(mysql);",
      "2280:   SET_CLIENT_ERROR(mysql, CR_OUT_OF_MEMORY, SQLSTATE_UNKNOWN, 0);",
      "2281:   return -1;",
      "2283: corrupted:",
      "2284:   ma_clear_session_state(mysql);",
      "2285:   SET_CLIENT_ERROR(mysql, CR_MALFORMED_PACKET, SQLSTATE_UNKNOWN, 0);",
      "2286:   return -1;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "db7adf63fbf242a07c355f192a4d8c60323b5d89",
      "candidate_info": {
        "commit_hash": "db7adf63fbf242a07c355f192a4d8c60323b5d89",
        "repo": "mariadb-corporation/mariadb-connector-c",
        "commit_url": "https://github.com/mariadb-corporation/mariadb-connector-c/commit/db7adf63fbf242a07c355f192a4d8c60323b5d89",
        "files": [
          "include/mariadb_com.h",
          "libmariadb/mariadb_lib.c"
        ],
        "message": "MDEV-16470: switch off user variables (and fixes of its support)",
        "before_after_code_files": [
          "include/mariadb_com.h||include/mariadb_com.h",
          "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c"
          ],
          "candidate": [
            "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c"
          ]
        }
      },
      "candidate_diff": {
        "include/mariadb_com.h||include/mariadb_com.h": [
          "File: include/mariadb_com.h -> include/mariadb_com.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "311:   SESSION_TRACK_GTIDS,",
          "312:   SESSION_TRACK_TRANSACTION_CHARACTERISTICS,",
          "315: };",
          "317: #define SESSION_TRACK_BEGIN 0",
          "318: #define SESSION_TRACK_END SESSION_TRACK_TRANSACTION_TYPE",
          "319: #define SESSION_TRACK_TYPES (SESSION_TRACK_END + 1)",
          "321: enum enum_field_types { MYSQL_TYPE_DECIMAL, MYSQL_TYPE_TINY,",
          "",
          "[Removed Lines]",
          "313:   SESSION_TRACK_TRANSACTION_TYPE /* make sure that SESSION_TRACK_END always points",
          "",
          "[Added Lines]",
          "313:   SESSION_TRACK_TRANSACTION_TYPE",
          "314: #ifdef USER_VAR_TACKING",
          "315:   ,",
          "316:   SESSION_TRACK_MYSQL_RESERVED1,",
          "317:   SESSION_TRACK_MYSQL_RESERVED2,",
          "318:   SESSION_TRACK_MYSQL_RESERVED3,",
          "319:   SESSION_TRACK_MYSQL_RESERVED4,",
          "320:   SESSION_TRACK_MYSQL_RESERVED5,",
          "321:   SESSION_TRACK_MYSQL_RESERVED6,",
          "323:   SESSION_TRACK_USER_VARIABLES /* make sure that SESSION_TRACK_END always points",
          "325: #endif // USER_VAR_TACKING",
          "330: #ifdef USER_VAR_TACKING",
          "331: #define SESSION_TRACK_END SESSION_TRACK_USER_VARIABLES",
          "332: #else",
          "334: #endif // USER_VAR_TACKING",
          "",
          "---------------"
        ],
        "libmariadb/mariadb_lib.c||libmariadb/mariadb_lib.c": [
          "File: libmariadb/mariadb_lib.c -> libmariadb/mariadb_lib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2193:             case SESSION_TRACK_STATE_CHANGE:",
          "2194:             case SESSION_TRACK_TRANSACTION_CHARACTERISTICS:",
          "2195:             case SESSION_TRACK_SYSTEM_VARIABLES:",
          "2196:               if (si_type != SESSION_TRACK_STATE_CHANGE)",
          "2198:               plen= net_field_length(&pos);",
          "2199:               if (pos + plen > end)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2197: #ifdef USER_VAR_TACKING",
          "2198:             case SESSION_TRACK_USER_VARIABLES:",
          "2199: #endif // USER_VAR_TACKING",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2219:                 memcpy(mysql->db, str->str, plen);",
          "2220:                 mysql->db[plen]= 0;",
          "2221:               }",
          "2223:               {",
          "2224:                 my_bool set_charset= 0;",
          "2227:                   set_charset= 1;",
          "2243:                 if (set_charset && str->length < CHARSET_NAME_LEN &&",
          "2244:                     strncmp(mysql->charset->csname, str->str, str->length) != 0)",
          "2245:                 {",
          "",
          "[Removed Lines]",
          "2222:               else if (si_type == SESSION_TRACK_SYSTEM_VARIABLES)",
          "2226:                 if (!strncmp(str->str, \"character_set_client\", str->length))",
          "2228:                 plen= net_field_length(&pos);",
          "2229:                 if (pos + plen > end)",
          "2230:                   goto corrupted;",
          "2231:                 if (!(session_item= ma_multi_malloc(0,",
          "2232:                                     &session_item, sizeof(LIST),",
          "2233:                                     &str, sizeof(MYSQL_LEX_STRING),",
          "2234:                                     &data, plen,",
          "2235:                                     NULL)))",
          "2236:                   goto oom;",
          "2237:                 str->length= plen;",
          "2238:                 str->str= data;",
          "2239:                 memcpy(str->str, (char *)pos, plen);",
          "2240:                 pos+= plen;",
          "2241:                 session_item->data= str;",
          "2242:                 mysql->extension->session_state[si_type].list= list_add(mysql->extension->session_state[si_type].list, session_item);",
          "",
          "[Added Lines]",
          "2228:               else if ((si_type == SESSION_TRACK_SYSTEM_VARIABLES)",
          "2229: #ifdef USER_VAR_TACKING",
          "2230:                         || (si_type == SESSION_TRACK_USER_VARIABLES)",
          "2231: #endif // USER_VAR_TACKING",
          "2232:                        )",
          "2236:                 if (si_type == SESSION_TRACK_SYSTEM_VARIABLES &&",
          "2237:                     !strncmp(str->str, \"character_set_client\", str->length))",
          "2239:                 if ((plen= net_field_length(&pos)) == NULL_LENGTH)",
          "2240:                 {",
          "2241:                   if(!(session_item= (LIST*)malloc(sizeof(LIST))))",
          "2242:                     goto oom;",
          "2243:                   session_item->data= NULL; // NULL",
          "2244:                 }",
          "2245:                 else",
          "2246:                 {",
          "2247:                   if (pos + plen > end)",
          "2248:                     goto corrupted;",
          "2249:                   if (!(session_item= ma_multi_malloc(0,",
          "2250:                           &session_item, sizeof(LIST),",
          "2251:                           &str, sizeof(MYSQL_LEX_STRING),",
          "2252:                           &data, plen,",
          "2253:                           NULL)))",
          "2254:                     goto oom;",
          "2255:                   str->length= plen;",
          "2256:                   str->str= data;",
          "2257:                   memcpy(str->str, (char *)pos, plen);",
          "2258:                   pos+= plen;",
          "2259:                   session_item->data= str;",
          "2260:                 }",
          "2261:                 mysql->extension->session_state[si_type].list=",
          "2262:                   list_add(mysql->extension->session_state[si_type].list,",
          "2263:                       session_item);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2339:   str= (MYSQL_LEX_STRING *)mysql->extension->session_state[type].current->data;",
          "2340:   mysql->extension->session_state[type].current= mysql->extension->session_state[type].current->next;",
          "2344:   return 0;",
          "2345: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2363:   if (str)",
          "2364:   {",
          "2367:   }",
          "2368:   else",
          "2369:   {",
          "2372:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}