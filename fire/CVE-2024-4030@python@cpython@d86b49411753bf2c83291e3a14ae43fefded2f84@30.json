{
  "cve_id": "CVE-2024-4030",
  "cve_desc": "On Windows a directory returned by tempfile.mkdtemp() would not always have permissions set to restrict reading and writing to the temporary directory by other users, instead usually inheriting the correct permissions from the default location. Alternate configurations or users without a profile directory may not have the intended permissions.\n\nIf you\u2019re not using Windows or haven\u2019t changed the temporary directory location then you aren\u2019t affected by this vulnerability. On other platforms the returned directory is consistently readable and writable only by the current user.\n\nThis issue was caused by Python not supporting Unix permissions on Windows. The fix adds support for Unix \u201c700\u201d for the mkdir function on Windows which is used by mkdtemp() to ensure the newly created directory has the proper permissions.",
  "repo": "python/cpython",
  "patch_hash": "d86b49411753bf2c83291e3a14ae43fefded2f84",
  "patch_info": {
    "commit_hash": "d86b49411753bf2c83291e3a14ae43fefded2f84",
    "repo": "python/cpython",
    "commit_url": "https://github.com/python/cpython/commit/d86b49411753bf2c83291e3a14ae43fefded2f84",
    "files": [
      "Doc/whatsnew/3.13.rst",
      "Misc/NEWS.d/next/Security/2024-05-01-20-57-09.gh-issue-118486.K44KJG.rst"
    ],
    "message": "gh-118486: Update docs for CVE-2024-4030 reference (GH-118737)\n\nUpdate docs for CVE-2024-4030 reference",
    "before_after_code_files": []
  },
  "patch_diff": {},
  "candidates": [
    {
      "candidate_hash": "0a266f7e74ce1ff4ad6e88f05473cc6a22ab7e20",
      "candidate_info": {
        "commit_hash": "0a266f7e74ce1ff4ad6e88f05473cc6a22ab7e20",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/0a266f7e74ce1ff4ad6e88f05473cc6a22ab7e20",
        "files": [
          "Doc/c-api/reflection.rst",
          "Doc/data/refcounts.dat",
          "Doc/whatsnew/3.13.rst",
          "Lib/test/test_sys.py",
          "Objects/frameobject.c",
          "Python/bytecodes.c",
          "Python/executor_cases.c.h",
          "Python/generated_cases.c.h",
          "Python/sysmodule.c"
        ],
        "message": "[3.13] gh-74929: PEP 667 C API documentation (gh-119892)\n\n* Add docs for new APIs\n* Add soft-deprecation notices\n* Add What's New porting entries\n* Update comments referencing `PyFrame_LocalsToFast()` to mention the proxy instead\n* Other related cleanups found when looking for refs to the deprecated APIs\n\n(cherry picked from commit 3859e09e3d92d004978dd838f0511364e7edfb94)\n\nCo-authored-by: Alyssa Coghlan <ncoghlan@gmail.com>",
        "before_after_code_files": [
          "Lib/test/test_sys.py||Lib/test/test_sys.py",
          "Objects/frameobject.c||Objects/frameobject.c",
          "Python/bytecodes.c||Python/bytecodes.c",
          "Python/executor_cases.c.h||Python/executor_cases.c.h",
          "Python/generated_cases.c.h||Python/generated_cases.c.h",
          "Python/sysmodule.c||Python/sysmodule.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/test/test_sys.py||Lib/test/test_sys.py": [
          "File: Lib/test/test_sys.py -> Lib/test/test_sys.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "395:     @test.support.refcount_test",
          "396:     def test_refcount(self):",
          "401:         global n",
          "402:         self.assertRaises(TypeError, sys.getrefcount)",
          "403:         c = sys.getrefcount(None)",
          "",
          "[Removed Lines]",
          "397:         # n here must be a global in order for this test to pass while",
          "398:         # tracing with a python function.  Tracing calls PyFrame_FastToLocals",
          "399:         # which will add a copy of any locals to the frame object, causing",
          "400:         # the reference count to increase by 2 instead of 1.",
          "",
          "[Added Lines]",
          "397:         # n here originally had to be a global in order for this test to pass",
          "398:         # while tracing with a python function. Tracing used to call",
          "399:         # PyFrame_FastToLocals, which would add a copy of any locals to the",
          "400:         # frame object, causing the ref count to increase by 2 instead of 1.",
          "401:         # While that no longer happens (due to PEP 667), this test case retains",
          "402:         # its original global-based implementation",
          "403:         # PEP 683's immortal objects also made this point moot, since the",
          "404:         # refcount for None doesn't change anyway. Maybe this test should be",
          "405:         # using a different constant value? (e.g. an integer)",
          "",
          "---------------"
        ],
        "Objects/frameobject.c||Objects/frameobject.c": [
          "File: Objects/frameobject.c -> Objects/frameobject.c"
        ],
        "Python/bytecodes.c||Python/bytecodes.c": [
          "File: Python/bytecodes.c -> Python/bytecodes.c"
        ],
        "Python/executor_cases.c.h||Python/executor_cases.c.h": [
          "File: Python/executor_cases.c.h -> Python/executor_cases.c.h"
        ],
        "Python/generated_cases.c.h||Python/generated_cases.c.h": [
          "File: Python/generated_cases.c.h -> Python/generated_cases.c.h"
        ],
        "Python/sysmodule.c||Python/sysmodule.c": [
          "File: Python/sysmodule.c -> Python/sysmodule.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"pycore_sysmodule.h\"     // export _PySys_GetSizeOf()",
          "36: #include \"pycore_tuple.h\"         // _PyTuple_FromArray()",
          "39: #include \"pydtrace.h\"             // PyDTrace_AUDIT()",
          "40: #include \"osdefs.h\"               // DELIM",
          "41: #include \"stdlib_module_names.h\"  // _Py_stdlib_module_names",
          "",
          "[Removed Lines]",
          "38: #include \"frameobject.h\"          // PyFrame_FastToLocalsWithError()",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8860f83e4b451181e46b0400a4c5019387776b1d",
      "candidate_info": {
        "commit_hash": "8860f83e4b451181e46b0400a4c5019387776b1d",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/8860f83e4b451181e46b0400a4c5019387776b1d",
        "files": [
          "Lib/_pyrepl/keymap.py",
          "Lib/_pyrepl/reader.py"
        ],
        "message": "[3.13] gh-119035: Add Ctrl+\u2190 and Ctrl+\u2192 word-skipping keybindings to new repl (GH-119248) (#119323)\n\nadd word-skipping ctrl keybindings to new repl\n(cherry picked from commit 0398d9339217aa0710c0de45a7e9b587136e7129)\n\nCo-authored-by: Alastair Stanley <alastairstanley@ntlworld.com>",
        "before_after_code_files": [
          "Lib/_pyrepl/keymap.py||Lib/_pyrepl/keymap.py",
          "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/_pyrepl/keymap.py||Lib/_pyrepl/keymap.py": [
          "File: Lib/_pyrepl/keymap.py -> Lib/_pyrepl/keymap.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "177:             ret = key[s]",
          "178:             s += 1",
          "179:     if ctrl:",
          "183:     if meta:",
          "184:         ret = [\"\\033\", ret]",
          "185:     else:",
          "",
          "[Removed Lines]",
          "180:         if len(ret) > 1:",
          "181:             raise KeySpecError(\"\\\\C- must be followed by a character\")",
          "182:         ret = chr(ord(ret) & 0x1F)  # curses.ascii.ctrl()",
          "",
          "[Added Lines]",
          "180:         if len(ret) == 1:",
          "181:             ret = chr(ord(ret) & 0x1F)  # curses.ascii.ctrl()",
          "182:         elif ret in {\"left\", \"right\"}:",
          "183:             ret = f\"ctrl {ret}\"",
          "184:         else:",
          "185:             raise KeySpecError(\"\\\\C- followed by invalid key\")",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py": [
          "File: Lib/_pyrepl/reader.py -> Lib/_pyrepl/reader.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "136:         (r\"\\<up>\", \"up\"),",
          "137:         (r\"\\<down>\", \"down\"),",
          "138:         (r\"\\<left>\", \"left\"),",
          "139:         (r\"\\<right>\", \"right\"),",
          "140:         (r\"\\<delete>\", \"delete\"),",
          "141:         (r\"\\<backspace>\", \"backspace\"),",
          "142:         (r\"\\M-\\<backspace>\", \"backward-kill-word\"),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "139:         (r\"\\C-\\<left>\", \"backward-word\"),",
          "141:         (r\"\\C-\\<right>\", \"forward-word\"),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a6c4080aaa646d8d3a0e54a6de7557b230c09341",
      "candidate_info": {
        "commit_hash": "a6c4080aaa646d8d3a0e54a6de7557b230c09341",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/a6c4080aaa646d8d3a0e54a6de7557b230c09341",
        "files": [
          "Lib/test/test_free_threading/test_type.py",
          "Lib/test/test_super.py",
          "Misc/NEWS.d/next/Core and Builtins/2024-06-10-15-07-16.gh-issue-120198.WW_pjO.rst",
          "Objects/typeobject.c"
        ],
        "message": "gh-120198: Fix race condition when editing __class__ with an audit hook active (GH-120195)\n\n(cherry picked from commit 203565b2f9c74656ba519780049b46d4e5afcba1)\n\nCo-authored-by: Ken Jin <kenjin@python.org>",
        "before_after_code_files": [
          "Lib/test/test_free_threading/test_type.py||Lib/test/test_free_threading/test_type.py",
          "Lib/test/test_super.py||Lib/test/test_super.py",
          "Objects/typeobject.c||Objects/typeobject.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/test/test_free_threading/test_type.py||Lib/test/test_free_threading/test_type.py": [
          "File: Lib/test/test_free_threading/test_type.py -> Lib/test/test_free_threading/test_type.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import unittest",
          "3: from concurrent.futures import ThreadPoolExecutor",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import threading",
          "",
          "---------------"
        ],
        "Lib/test/test_super.py||Lib/test/test_super.py": [
          "File: Lib/test/test_super.py -> Lib/test/test_super.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: \"\"\"Unit tests for zero-argument super() & related machinery.\"\"\"",
          "3: import textwrap",
          "4: import unittest",
          "5: from unittest.mock import patch",
          "9: ADAPTIVE_WARMUP_DELAY = 2",
          "",
          "[Removed Lines]",
          "6: from test.support import import_helper",
          "",
          "[Added Lines]",
          "4: import threading",
          "7: from test.support import import_helper, threading_helper",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "505:         for _ in range(ADAPTIVE_WARMUP_DELAY):",
          "506:             C.some(C)",
          "509: if __name__ == \"__main__\":",
          "510:     unittest.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "509:     @threading_helper.requires_working_threading()",
          "510:     def test___class___modification_multithreaded(self):",
          "511:         \"\"\" Note: this test isn't actually testing anything on its own.",
          "512:         It requires a sys audithook to be set to crash on older Python.",
          "513:         This should be the case anyways as our test suite sets",
          "514:         an audit hook.",
          "515:         \"\"\"",
          "516:         class Foo:",
          "517:             pass",
          "519:         class Bar:",
          "520:             pass",
          "522:         thing = Foo()",
          "523:         def work():",
          "524:             foo = thing",
          "525:             for _ in range(5000):",
          "526:                 foo.__class__ = Bar",
          "527:                 type(foo)",
          "528:                 foo.__class__ = Foo",
          "529:                 type(foo)",
          "532:         threads = []",
          "533:         for _ in range(6):",
          "534:             thread = threading.Thread(target=work)",
          "535:             thread.start()",
          "536:             threads.append(thread)",
          "538:         for thread in threads:",
          "539:             thread.join()",
          "",
          "---------------"
        ],
        "Objects/typeobject.c||Objects/typeobject.c": [
          "File: Objects/typeobject.c -> Objects/typeobject.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6363: static int",
          "6364: object_set_class(PyObject *self, PyObject *value, void *closure)",
          "6365: {",
          "6368:     if (value == NULL) {",
          "6369:         PyErr_SetString(PyExc_TypeError,",
          "",
          "[Removed Lines]",
          "6366:     PyTypeObject *oldto = Py_TYPE(self);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6383:         return -1;",
          "6384:     }",
          "6387:        compatible_for_assignment was not set up to correctly check for memory",
          "6388:        layout / slot / etc. compatibility for non-HEAPTYPE classes, so we just",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6385:     PyTypeObject *oldto = Py_TYPE(self);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "58dbb4a4b053800bb802aaf9662e3977ad114a52",
      "candidate_info": {
        "commit_hash": "58dbb4a4b053800bb802aaf9662e3977ad114a52",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/58dbb4a4b053800bb802aaf9662e3977ad114a52",
        "files": [
          "Lib/_pyrepl/commands.py",
          "Lib/_pyrepl/reader.py",
          "Lib/_pyrepl/readline.py",
          "Lib/_pyrepl/simple_interact.py",
          "Lib/_pyrepl/utils.py",
          "Lib/test/test_pyrepl/test_pyrepl.py"
        ],
        "message": "[3.13] gh-111201: Speed up paste mode in the REPL (#119341) (GH-119432) (#119439)\n\n(cherry picked from commit e6572e8f98d33994d2d0dd3afa92a2a72ee642a9)\n\nAlso includes:\n\n* gh-111201: Use calc_complete_screen after bracketed paste in PyREPL (GH-119432)\n(cherry picked from commit 14b063cbf1bb11a489d04a31f277edba0fc8893c)\n\nCo-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>\nCo-authored-by: \u0141ukasz Langa <lukasz@langa.pl>\nCo-authored-by: Lysandros Nikolaou <lisandrosnik@gmail.com>",
        "before_after_code_files": [
          "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py",
          "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py",
          "Lib/_pyrepl/readline.py||Lib/_pyrepl/readline.py",
          "Lib/_pyrepl/simple_interact.py||Lib/_pyrepl/simple_interact.py",
          "Lib/_pyrepl/utils.py||Lib/_pyrepl/utils.py",
          "Lib/test/test_pyrepl/test_pyrepl.py||Lib/test/test_pyrepl/test_pyrepl.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py": [
          "File: Lib/_pyrepl/commands.py -> Lib/_pyrepl/commands.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "461: class paste_mode(Command):",
          "463:     def do(self) -> None:",
          "466:         self.reader.paste_mode = not self.reader.paste_mode",
          "467:         self.reader.dirty = True",
          "",
          "[Removed Lines]",
          "464:         if not self.reader.paste_mode:",
          "465:             self.reader.was_paste_mode_activated = True",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "470: class enable_bracketed_paste(Command):",
          "471:     def do(self) -> None:",
          "472:         self.reader.paste_mode = True",
          "475: class disable_bracketed_paste(Command):",
          "476:     def do(self) -> None:",
          "477:         self.reader.paste_mode = False",
          "478:         self.reader.dirty = True",
          "",
          "[Removed Lines]",
          "473:         self.reader.was_paste_mode_activated = True",
          "",
          "[Added Lines]",
          "471:         self.reader.in_bracketed_paste = True",
          "476:         self.reader.in_bracketed_paste = False",
          "478:         self.reader.calc_screen = self.reader.calc_complete_screen",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py": [
          "File: Lib/_pyrepl/reader.py -> Lib/_pyrepl/reader.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:     b: list[int] = []",
          "55:     s: list[str] = []",
          "56:     for c in buffer:",
          "58:             c = r\"\\u%04x\" % ord(c)",
          "59:         s.append(c)",
          "60:         b.append(wlen(c))",
          "",
          "[Removed Lines]",
          "57:         if unicodedata.category(c).startswith(\"C\"):",
          "",
          "[Added Lines]",
          "57:         if ord(c) > 128 and unicodedata.category(c).startswith(\"C\"):",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "225:     dirty: bool = False",
          "226:     finished: bool = False",
          "227:     paste_mode: bool = False",
          "229:     commands: dict[str, type[Command]] = field(default_factory=make_default_commands)",
          "230:     last_command: type[Command] | None = None",
          "231:     syntax_table: dict[str, int] = field(default_factory=make_default_syntax_table)",
          "",
          "[Removed Lines]",
          "228:     was_paste_mode_activated: bool = False",
          "",
          "[Added Lines]",
          "228:     in_bracketed_paste: bool = False",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "454:         elif \"\\n\" in self.buffer:",
          "455:             if lineno == 0:",
          "456:                 prompt = self.ps2",
          "458:                 prompt = self.ps4",
          "459:             else:",
          "460:                 prompt = self.ps3",
          "",
          "[Removed Lines]",
          "457:             elif lineno == self.buffer.count(\"\\n\"):",
          "",
          "[Added Lines]",
          "457:             elif self.ps4 and lineno == self.buffer.count(\"\\n\"):",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "618:         self.after_command(command)",
          "621:             self.refresh()",
          "622:         else:",
          "623:             self.update_cursor()",
          "",
          "[Removed Lines]",
          "620:         if self.dirty:",
          "",
          "[Added Lines]",
          "620:         if self.dirty and not self.in_bracketed_paste:",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/readline.py||Lib/_pyrepl/readline.py": [
          "File: Lib/_pyrepl/readline.py -> Lib/_pyrepl/readline.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "341:         reader.ps1 = str(prompt)",
          "342:         return reader.readline(startup_hook=self.startup_hook)",
          "345:         \"\"\"Read an input on possibly multiple lines, asking for more",
          "346:         lines as long as 'more_lines(unicodetext)' returns an object whose",
          "347:         boolean value is true.",
          "",
          "[Removed Lines]",
          "344:     def multiline_input(self, more_lines: MoreLinesCallable, ps1: str, ps2: str) -> tuple[str, bool]:",
          "",
          "[Added Lines]",
          "344:     def multiline_input(self, more_lines: MoreLinesCallable, ps1: str, ps2: str) -> str:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "350:         saved = reader.more_lines",
          "351:         try:",
          "352:             reader.more_lines = more_lines",
          "355:             with warnings.catch_warnings(action=\"ignore\"):",
          "357:         finally:",
          "358:             reader.more_lines = saved",
          "359:             reader.paste_mode = False",
          "362:     def parse_and_bind(self, string: str) -> None:",
          "363:         pass  # XXX we don't support parsing GNU-readline-style init files",
          "",
          "[Removed Lines]",
          "353:             reader.ps1 = reader.ps2 = ps1",
          "354:             reader.ps3 = reader.ps4 = ps2",
          "356:                 return reader.readline(), reader.was_paste_mode_activated",
          "360:             reader.was_paste_mode_activated = False",
          "",
          "[Added Lines]",
          "353:             reader.ps1 = ps1",
          "354:             reader.ps2 = ps1",
          "355:             reader.ps3 = ps2",
          "356:             reader.ps4 = \"\"",
          "358:                 return reader.readline()",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/simple_interact.py||Lib/_pyrepl/simple_interact.py": [
          "File: Lib/_pyrepl/simple_interact.py -> Lib/_pyrepl/simple_interact.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "62:     \"quit\": _sitebuiltins.Quitter('quit' ,''),",
          "63:     \"copyright\": _sitebuiltins._Printer('copyright', sys.copyright),",
          "64:     \"help\": \"help\",",
          "65: }",
          "67: class InteractiveColoredConsole(code.InteractiveConsole):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "65:     \"clear\": \"clear_screen\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "163:             ps1 = getattr(sys, \"ps1\", \">>> \")",
          "164:             ps2 = getattr(sys, \"ps2\", \"... \")",
          "165:             try:",
          "167:             except EOFError:",
          "168:                 break",
          "",
          "[Removed Lines]",
          "166:                 statement, contains_pasted_code = multiline_input(more_lines, ps1, ps2)",
          "",
          "[Added Lines]",
          "167:                 statement = multiline_input(more_lines, ps1, ps2)",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/utils.py||Lib/_pyrepl/utils.py": [
          "File: Lib/_pyrepl/utils.py -> Lib/_pyrepl/utils.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: import re",
          "2: import unicodedata",
          "4: ANSI_ESCAPE_SEQUENCE = re.compile(r\"\\x1b\\[[ -@]*[A-~]\")",
          "7: def str_width(c: str) -> int:",
          "8:     w = unicodedata.east_asian_width(c)",
          "9:     if w in ('N', 'Na', 'H', 'A'):",
          "10:         return 1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: import functools",
          "8: @functools.cache",
          "10:     if ord(c) < 128:",
          "11:         return 1",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14: def wlen(s: str) -> int:",
          "15:     length = sum(str_width(i) for i in s)",
          "17:     # remove lengths of any escape sequences",
          "",
          "[Removed Lines]",
          "18:     return length - sum(len(i) for i in ANSI_ESCAPE_SEQUENCE.findall(s))",
          "",
          "[Added Lines]",
          "21:     sequence = ANSI_ESCAPE_SEQUENCE.findall(s)",
          "22:     return length - sum(len(i) for i in sequence)",
          "",
          "---------------"
        ],
        "Lib/test/test_pyrepl/test_pyrepl.py||Lib/test/test_pyrepl/test_pyrepl.py": [
          "File: Lib/test/test_pyrepl/test_pyrepl.py -> Lib/test/test_pyrepl/test_pyrepl.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "587:         reader = self.prepare_reader(events, namespace)",
          "588:         mock_get_reader.return_value = reader",
          "589:         output = readline_multiline_input(more_lines, \">>>\", \"...\")",
          "591:         self.assertEqual(mock_stderr.getvalue(), \"\")",
          "",
          "[Removed Lines]",
          "590:         self.assertEqual(output[0], \"dummy.test_func.__\")",
          "",
          "[Added Lines]",
          "590:         self.assertEqual(output, \"dummy.test_func.__\")",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bfd9c3ea5336f2898e3c58e0c3999bfc25d7da89",
      "candidate_info": {
        "commit_hash": "bfd9c3ea5336f2898e3c58e0c3999bfc25d7da89",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/bfd9c3ea5336f2898e3c58e0c3999bfc25d7da89",
        "files": [
          "Include/internal/pycore_global_objects_fini_generated.h",
          "Include/internal/pycore_global_strings.h",
          "Include/internal/pycore_runtime_init_generated.h",
          "Include/internal/pycore_unicodeobject_generated.h",
          "Lib/test/test_capi/test_getargs.py",
          "Misc/NEWS.d/next/Core and Builtins/2024-05-21-11-27-14.gh-issue-119213.nxjxrt.rst",
          "Modules/_testinternalcapi.c",
          "Modules/clinic/_testinternalcapi.c.h",
          "Python/getargs.c",
          "Tools/clinic/libclinic/parse_args.py"
        ],
        "message": "[3.13] gh-119213: Be More Careful About _PyArg_Parser.kwtuple Across Interpreters (gh-119331) (gh-119410)\n\n_PyArg_Parser holds static global data generated for modules by Argument Clinic.  The _PyArg_Parser.kwtuple field is a tuple object, even though it's stored within a static global.  In some cases the tuple is statically allocated and thus it's okay that it gets shared by multiple interpreters.  However, in other cases the tuple is set lazily, allocated from the heap using the active interprepreter at the point the tuple is needed.\n\nThis is a problem once that interpreter is destroyed since _PyArg_Parser.kwtuple becomes at dangling pointer, leading to crashes.  It isn't a problem if the tuple is allocated under the main interpreter, since its lifetime is bound to the lifetime of the runtime.  The solution here is to temporarily switch to the main interpreter.  The alternative would be to always statically allocate the tuple.\n\nThis change also fixes a bug where only the most recent parser was added to the global linked list.\n\n(cherry picked from commit 81865002aee8eaaeb3c7e402f86183afa6de77bf)\n\nCo-authored-by: Eric Snow <ericsnowcurrently@gmail.com>",
        "before_after_code_files": [
          "Include/internal/pycore_global_objects_fini_generated.h||Include/internal/pycore_global_objects_fini_generated.h",
          "Include/internal/pycore_global_strings.h||Include/internal/pycore_global_strings.h",
          "Include/internal/pycore_runtime_init_generated.h||Include/internal/pycore_runtime_init_generated.h",
          "Include/internal/pycore_unicodeobject_generated.h||Include/internal/pycore_unicodeobject_generated.h",
          "Lib/test/test_capi/test_getargs.py||Lib/test/test_capi/test_getargs.py",
          "Modules/_testinternalcapi.c||Modules/_testinternalcapi.c",
          "Modules/clinic/_testinternalcapi.c.h||Modules/clinic/_testinternalcapi.c.h",
          "Python/getargs.c||Python/getargs.c",
          "Tools/clinic/libclinic/parse_args.py||Tools/clinic/libclinic/parse_args.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Include/internal/pycore_global_objects_fini_generated.h||Include/internal/pycore_global_objects_fini_generated.h": [
          "File: Include/internal/pycore_global_objects_fini_generated.h -> Include/internal/pycore_global_objects_fini_generated.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1221:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(sort));",
          "1222:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(source));",
          "1223:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(source_traceback));",
          "1224:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(src));",
          "1225:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(src_dir_fd));",
          "1226:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(stacklevel));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1224:     _PyStaticObject_CheckRefcnt((PyObject *)&_Py_ID(spam));",
          "",
          "---------------"
        ],
        "Include/internal/pycore_global_strings.h||Include/internal/pycore_global_strings.h": [
          "File: Include/internal/pycore_global_strings.h -> Include/internal/pycore_global_strings.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "710:         STRUCT_FOR_ID(sort)",
          "711:         STRUCT_FOR_ID(source)",
          "712:         STRUCT_FOR_ID(source_traceback)",
          "713:         STRUCT_FOR_ID(src)",
          "714:         STRUCT_FOR_ID(src_dir_fd)",
          "715:         STRUCT_FOR_ID(stacklevel)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "713:         STRUCT_FOR_ID(spam)",
          "",
          "---------------"
        ],
        "Include/internal/pycore_runtime_init_generated.h||Include/internal/pycore_runtime_init_generated.h": [
          "File: Include/internal/pycore_runtime_init_generated.h -> Include/internal/pycore_runtime_init_generated.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1219:     INIT_ID(sort), \\",
          "1220:     INIT_ID(source), \\",
          "1221:     INIT_ID(source_traceback), \\",
          "1222:     INIT_ID(src), \\",
          "1223:     INIT_ID(src_dir_fd), \\",
          "1224:     INIT_ID(stacklevel), \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1222:     INIT_ID(spam), \\",
          "",
          "---------------"
        ],
        "Include/internal/pycore_unicodeobject_generated.h||Include/internal/pycore_unicodeobject_generated.h": [
          "File: Include/internal/pycore_unicodeobject_generated.h -> Include/internal/pycore_unicodeobject_generated.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1971:     string = &_Py_ID(source_traceback);",
          "1972:     assert(_PyUnicode_CheckConsistency(string, 1));",
          "1973:     _PyUnicode_InternInPlace(interp, &string);",
          "1974:     string = &_Py_ID(src);",
          "1975:     assert(_PyUnicode_CheckConsistency(string, 1));",
          "1976:     _PyUnicode_InternInPlace(interp, &string);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1974:     string = &_Py_ID(spam);",
          "1975:     assert(_PyUnicode_CheckConsistency(string, 1));",
          "1976:     _PyUnicode_InternInPlace(interp, &string);",
          "",
          "---------------"
        ],
        "Lib/test/test_capi/test_getargs.py||Lib/test/test_capi/test_getargs.py": [
          "File: Lib/test/test_capi/test_getargs.py -> Lib/test/test_capi/test_getargs.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: import sys",
          "5: from test import support",
          "6: from test.support import import_helper",
          "7: from test.support import warnings_helper",
          "8: # Skip this test if the _testcapi module isn't available.",
          "9: _testcapi = import_helper.import_module('_testcapi')",
          "10: from _testcapi import getargs_keywords, getargs_keyword_only",
          "12: # > How about the following counterproposal. This also changes some of",
          "13: # > the other format codes to be a little more regular.",
          "14: # >",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: from test.support import script_helper",
          "13: try:",
          "14:     import _testinternalcapi",
          "15: except ImportError:",
          "16:     _testinternalcapi = NULL",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1346:                     \"argument 1 must be sequence of length 1, not 0\"):",
          "1347:                 parse(((),), {}, '(' + f + ')', ['a'])",
          "1350: if __name__ == \"__main__\":",
          "1351:     unittest.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1355:     @unittest.skipIf(_testinternalcapi is None, 'needs _testinternalcapi')",
          "1356:     def test_gh_119213(self):",
          "1357:         rc, out, err = script_helper.assert_python_ok(\"-c\", \"\"\"if True:",
          "1358:             from test import support",
          "1359:             script = '''if True:",
          "1360:                 import _testinternalcapi",
          "1361:                 _testinternalcapi.gh_119213_getargs(spam='eggs')",
          "1362:                 '''",
          "1363:             config = dict(",
          "1364:                 allow_fork=False,",
          "1365:                 allow_exec=False,",
          "1366:                 allow_threads=True,",
          "1367:                 allow_daemon_threads=False,",
          "1368:                 use_main_obmalloc=False,",
          "1369:                 gil=2,",
          "1370:                 check_multi_interp_extensions=True,",
          "1371:             )",
          "1372:             rc = support.run_in_subinterp_with_config(script, **config)",
          "1373:             assert rc == 0",
          "1375:             # The crash is different if the interpreter was not destroyed first.",
          "1376:             #interpid = _testinternalcapi.create_interpreter()",
          "1377:             #rc = _testinternalcapi.exec_interpreter(interpid, script)",
          "1378:             #assert rc == 0",
          "1379:             \"\"\")",
          "1380:         self.assertEqual(rc, 0)",
          "",
          "---------------"
        ],
        "Modules/_testinternalcapi.c||Modules/_testinternalcapi.c": [
          "File: Modules/_testinternalcapi.c -> Modules/_testinternalcapi.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2006:     Py_RETURN_FALSE;",
          "2007: }",
          "2009: static PyMethodDef module_functions[] = {",
          "2010:     {\"get_configs\", get_configs, METH_NOARGS},",
          "2011:     {\"get_recursion_depth\", get_recursion_depth, METH_NOARGS},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2011: gh_119213_getargs",
          "2013:     spam: object = None",
          "2015: Test _PyArg_Parser.kwtuple",
          "2018: static PyObject *",
          "2019: gh_119213_getargs_impl(PyObject *module, PyObject *spam)",
          "2021: {",
          "2023:     assert(!_Py_IsMainInterpreter(PyInterpreterState_Get()));",
          "2024:     return Py_NewRef(spam);",
          "2025: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2096: #ifdef _Py_TIER2",
          "2097:     {\"uop_symbols_test\", _Py_uop_symbols_test, METH_NOARGS},",
          "2098: #endif",
          "2100: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2118:     GH_119213_GETARGS_METHODDEF",
          "",
          "---------------"
        ],
        "Modules/clinic/_testinternalcapi.c.h||Modules/clinic/_testinternalcapi.c.h": [
          "File: Modules/clinic/_testinternalcapi.c.h -> Modules/clinic/_testinternalcapi.c.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "300: {",
          "301:     return _testinternalcapi_test_long_numbits_impl(module);",
          "302: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "304: PyDoc_STRVAR(gh_119213_getargs__doc__,",
          "305: \"gh_119213_getargs($module, /, spam=None)\\n\"",
          "306: \"--\\n\"",
          "307: \"\\n\"",
          "308: \"Test _PyArg_Parser.kwtuple\");",
          "310: #define GH_119213_GETARGS_METHODDEF    \\",
          "311:     {\"gh_119213_getargs\", _PyCFunction_CAST(gh_119213_getargs), METH_FASTCALL|METH_KEYWORDS, gh_119213_getargs__doc__},",
          "313: static PyObject *",
          "314: gh_119213_getargs_impl(PyObject *module, PyObject *spam);",
          "316: static PyObject *",
          "317: gh_119213_getargs(PyObject *module, PyObject *const *args, Py_ssize_t nargs, PyObject *kwnames)",
          "318: {",
          "319:     PyObject *return_value = NULL;",
          "320:     #if defined(Py_BUILD_CORE) && !defined(Py_BUILD_CORE_MODULE)",
          "322:     #define NUM_KEYWORDS 1",
          "323:     static struct {",
          "324:         PyGC_Head _this_is_not_used;",
          "325:         PyObject_VAR_HEAD",
          "326:         PyObject *ob_item[NUM_KEYWORDS];",
          "327:     } _kwtuple = {",
          "328:         .ob_base = PyVarObject_HEAD_INIT(&PyTuple_Type, NUM_KEYWORDS)",
          "329:         .ob_item = { &_Py_ID(spam), },",
          "330:     };",
          "331:     #undef NUM_KEYWORDS",
          "332:     #define KWTUPLE (&_kwtuple.ob_base.ob_base)",
          "334:     #else  // !Py_BUILD_CORE",
          "335:     #  define KWTUPLE NULL",
          "336:     #endif  // !Py_BUILD_CORE",
          "338:     static const char * const _keywords[] = {\"spam\", NULL};",
          "339:     static _PyArg_Parser _parser = {",
          "340:         .keywords = _keywords,",
          "341:         .fname = \"gh_119213_getargs\",",
          "342:         .kwtuple = KWTUPLE,",
          "343:     };",
          "344:     #undef KWTUPLE",
          "345:     PyObject *argsbuf[1];",
          "346:     Py_ssize_t noptargs = nargs + (kwnames ? PyTuple_GET_SIZE(kwnames) : 0) - 0;",
          "347:     PyObject *spam = Py_None;",
          "349:     args = _PyArg_UnpackKeywords(args, nargs, NULL, kwnames, &_parser, 0, 1, 0, argsbuf);",
          "350:     if (!args) {",
          "351:         goto exit;",
          "352:     }",
          "353:     if (!noptargs) {",
          "354:         goto skip_optional_pos;",
          "355:     }",
          "356:     spam = args[0];",
          "357: skip_optional_pos:",
          "358:     return_value = gh_119213_getargs_impl(module, spam);",
          "360: exit:",
          "361:     return return_value;",
          "362: }",
          "",
          "---------------"
        ],
        "Python/getargs.c||Python/getargs.c": [
          "File: Python/getargs.c -> Python/getargs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "7: #include \"pycore_dict.h\"          // _PyDict_HasOnlyStringKeys()",
          "8: #include \"pycore_modsupport.h\"    // export _PyArg_NoKeywords()",
          "9: #include \"pycore_pylifecycle.h\"   // _PyArg_Fini",
          "10: #include \"pycore_tuple.h\"         // _PyTuple_ITEMS()",
          "11: #include \"pycore_pyerrors.h\"      // _Py_CalculateSuggestions()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10: #include \"pycore_pystate.h\"       // _Py_IsMainInterpreter()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1947:     int owned;",
          "1948:     PyObject *kwtuple = parser->kwtuple;",
          "1949:     if (kwtuple == NULL) {",
          "1950:         kwtuple = new_kwtuple(keywords, len, pos);",
          "1951:         if (kwtuple == NULL) {",
          "1952:             return -1;",
          "1953:         }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1953:         PyThreadState *save_tstate = NULL;",
          "1954:         PyThreadState *temp_tstate = NULL;",
          "1955:         if (!_Py_IsMainInterpreter(PyInterpreterState_Get())) {",
          "1956:             temp_tstate = PyThreadState_New(_PyInterpreterState_Main());",
          "1957:             if (temp_tstate == NULL) {",
          "1958:                 return -1;",
          "1959:             }",
          "1960:             save_tstate = PyThreadState_Swap(temp_tstate);",
          "1961:         }",
          "1963:         if (temp_tstate != NULL) {",
          "1964:             PyThreadState_Clear(temp_tstate);",
          "1965:             (void)PyThreadState_Swap(save_tstate);",
          "1966:             PyThreadState_Delete(temp_tstate);",
          "1967:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1969:     parser->next = _Py_atomic_load_ptr(&_PyRuntime.getargs.static_parsers);",
          "1970:     do {",
          "1974:     return 0;",
          "1975: }",
          "",
          "[Removed Lines]",
          "1972:     } while (_Py_atomic_compare_exchange_ptr(&_PyRuntime.getargs.static_parsers,",
          "1973:                                              &parser->next, parser));",
          "",
          "[Added Lines]",
          "1989:     } while (!_Py_atomic_compare_exchange_ptr(&_PyRuntime.getargs.static_parsers,",
          "1990:                                               &parser->next, parser));",
          "",
          "---------------"
        ],
        "Tools/clinic/libclinic/parse_args.py||Tools/clinic/libclinic/parse_args.py": [
          "File: Tools/clinic/libclinic/parse_args.py -> Tools/clinic/libclinic/parse_args.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:             #endif",
          "52:         \"\"\"",
          "53:     else:",
          "54:         declarations = \"\"\"",
          "55:             #if defined(Py_BUILD_CORE) && !defined(Py_BUILD_CORE_MODULE)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54:         # XXX Why do we not statically allocate the tuple",
          "55:         # for non-builtin modules?",
          "",
          "---------------"
        ]
      }
    }
  ]
}