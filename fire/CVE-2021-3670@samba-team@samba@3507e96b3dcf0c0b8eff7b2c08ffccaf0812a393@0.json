{
  "cve_id": "CVE-2021-3670",
  "cve_desc": "MaxQueryDuration not honoured in Samba AD DC LDAP",
  "repo": "samba-team/samba",
  "patch_hash": "3507e96b3dcf0c0b8eff7b2c08ffccaf0812a393",
  "patch_info": {
    "commit_hash": "3507e96b3dcf0c0b8eff7b2c08ffccaf0812a393",
    "repo": "samba-team/samba",
    "commit_url": "https://github.com/samba-team/samba/commit/3507e96b3dcf0c0b8eff7b2c08ffccaf0812a393",
    "files": [
      "source4/ldap_server/ldap_backend.c"
    ],
    "message": "CVE-2021-3670 ldap_server: Clearly log LDAP queries and timeouts\n\nThis puts all the detail on one line so it can be searched\nby IP address and connecting SID.\n\nThis relies on the anr handling as otherwise this log\nbecomes the expanded query, not the original one.\n\nRN: Provide clear logs of the LDAP search and who made it, including\na warning (at log level 3) for queries that are 1/4 of the hard timeout.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>\n\nAutobuild-User(master): Douglas Bagnall <dbagnall@samba.org>\nAutobuild-Date(master): Thu Nov 25 02:30:42 UTC 2021 on sn-devel-184",
    "before_after_code_files": [
      "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
    ]
  },
  "patch_diff": {
    "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c": [
      "File: source4/ldap_server/ldap_backend.c -> source4/ldap_server/ldap_backend.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "729:  unsigned int i;",
      "730:  int extended_type = 1;",
      "733:  local_ctx = talloc_new(call);",
      "734:  NT_STATUS_HAVE_NO_MEMORY(local_ctx);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "736:  struct timeval start_time = timeval_current();",
      "737:  struct timeval warning_time",
      "738:   = timeval_add(&start_time,",
      "739:          call->conn->limits.search_timeout / 4,",
      "740:          0);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "736:  basedn = ldb_dn_new(local_ctx, samdb, req->basedn);",
      "737:  NT_STATUS_HAVE_NO_MEMORY(basedn);",
      "742:  switch (req->scope) {",
      "762:  }",
      "763:  DEBUG(10,(\"SearchRequest: scope: [%s]\\n\", scope_str));",
      "",
      "[Removed Lines]",
      "739:  DEBUG(10, (\"SearchRequest: basedn: [%s]\\n\", req->basedn));",
      "740:  DEBUG(10, (\"SearchRequest: filter: [%s]\\n\", ldb_filter_from_tree(call, req->tree)));",
      "743:   case LDAP_SEARCH_SCOPE_BASE:",
      "744:    scope_str = \"BASE\";",
      "745:    scope = LDB_SCOPE_BASE;",
      "746:    break;",
      "747:   case LDAP_SEARCH_SCOPE_SINGLE:",
      "748:    scope_str = \"ONE\";",
      "749:    scope = LDB_SCOPE_ONELEVEL;",
      "750:    break;",
      "751:   case LDAP_SEARCH_SCOPE_SUB:",
      "752:    scope_str = \"SUB\";",
      "753:    scope = LDB_SCOPE_SUBTREE;",
      "754:    break;",
      "755:          default:",
      "756:    result = LDAP_PROTOCOL_ERROR;",
      "757:    map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
      "758:     &errstr);",
      "759:    errstr = talloc_asprintf(local_ctx,",
      "760:     \"%s. Invalid scope\", errstr);",
      "761:    goto reply;",
      "",
      "[Added Lines]",
      "749:  case LDAP_SEARCH_SCOPE_BASE:",
      "750:   scope_str = \"BASE\";",
      "751:   scope = LDB_SCOPE_BASE;",
      "752:   break;",
      "753:  case LDAP_SEARCH_SCOPE_SINGLE:",
      "754:   scope_str = \"ONE\";",
      "755:   scope = LDB_SCOPE_ONELEVEL;",
      "756:   break;",
      "757:  case LDAP_SEARCH_SCOPE_SUB:",
      "758:   scope_str = \"SUB\";",
      "759:   scope = LDB_SCOPE_SUBTREE;",
      "760:   break;",
      "761:  default:",
      "762:   result = LDAP_PROTOCOL_ERROR;",
      "763:   map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
      "764:          &errstr);",
      "765:   scope_str = \"<Invalid scope>\";",
      "766:   errstr = talloc_asprintf(local_ctx,",
      "767:       \"%s. Invalid scope\", errstr);",
      "768:   goto reply;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "911:  }",
      "913: reply:",
      "914:  DLIST_REMOVE(call->conn->pending_calls, call);",
      "915:  call->notification.busy = false;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "930:  if ((req->timelimit == 0 || call->conn->limits.search_timeout < req->timelimit)",
      "931:      && ldb_ret == LDB_ERR_TIME_LIMIT_EXCEEDED) {",
      "932:   struct dom_sid_buf sid_buf;",
      "933:   DBG_WARNING(\"MaxQueryDuration(%d) timeout exceeded \"",
      "934:        \"in SearchRequest by %s from %s filter: [%s] \"",
      "935:        \"basedn: [%s] \"",
      "936:        \"scope: [%s]\\n\",",
      "937:        call->conn->limits.search_timeout,",
      "938:        dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
      "939:          &sid_buf),",
      "940:        tsocket_address_string(call->conn->connection->remote_address,",
      "941:          call),",
      "942:        ldb_filter_from_tree(call, req->tree),",
      "943:        ldb_dn_get_extended_linearized(call, basedn, 1),",
      "944:        scope_str);",
      "945:   for (i=0; i < req->num_attributes; i++) {",
      "946:    DBG_WARNING(\"MaxQueryDuration timeout exceeded attrs: [%s]\\n\",",
      "947:         req->attributes[i]);",
      "948:   }",
      "950:  } else if (timeval_expired(&warning_time)) {",
      "951:   struct dom_sid_buf sid_buf;",
      "952:   DBG_NOTICE(\"Long LDAP Query: Duration was %.2fs, \"",
      "953:       \"MaxQueryDuration(%d)/4 == %d \"",
      "954:       \"in SearchRequest by %s from %s filter: [%s] \"",
      "955:       \"basedn: [%s] \"",
      "956:       \"scope: [%s] \"",
      "957:       \"result: %s\\n\",",
      "958:       timeval_elapsed(&start_time),",
      "959:       call->conn->limits.search_timeout,",
      "960:       call->conn->limits.search_timeout / 4,",
      "961:       dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
      "962:         &sid_buf),",
      "963:       tsocket_address_string(call->conn->connection->remote_address,",
      "964:         call),",
      "965:       ldb_filter_from_tree(call, req->tree),",
      "966:       ldb_dn_get_extended_linearized(call, basedn, 1),",
      "967:       scope_str,",
      "968:       ldb_strerror(ldb_ret));",
      "969:   for (i=0; i < req->num_attributes; i++) {",
      "970:    DBG_NOTICE(\"Long LDAP Query attrs: [%s]\\n\",",
      "971:        req->attributes[i]);",
      "972:   }",
      "973:  } else {",
      "974:   struct dom_sid_buf sid_buf;",
      "975:   DBG_INFO(\"LDAP Query: Duration was %.2fs, \"",
      "976:     \"SearchRequest by %s from %s filter: [%s] \"",
      "977:     \"basedn: [%s] \"",
      "978:     \"scope: [%s] \"",
      "979:     \"result: %s\\n\",",
      "980:     timeval_elapsed(&start_time),",
      "981:     dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
      "982:       &sid_buf),",
      "983:     tsocket_address_string(call->conn->connection->remote_address,",
      "984:       call),",
      "985:     ldb_filter_from_tree(call, req->tree),",
      "986:     ldb_dn_get_extended_linearized(call, basedn, 1),",
      "987:     scope_str,",
      "988:     ldb_strerror(ldb_ret));",
      "989:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3e8d6e681f8dbe79e4595549f78c42649b3573a2",
      "candidate_info": {
        "commit_hash": "3e8d6e681f8dbe79e4595549f78c42649b3573a2",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/3e8d6e681f8dbe79e4595549f78c42649b3573a2",
        "files": [
          "source4/ldap_server/ldap_backend.c"
        ],
        "message": "CVE-2021-3670 ldap_server: Clearly log LDAP queries and timeouts\n\nThis puts all the detail on one line so it can be searched\nby IP address and connecting SID.\n\nThis relies on the anr handling as otherwise this log\nbecomes the expanded query, not the original one.\n\nRN: Provide clear logs of the LDAP search and who made it, including\na warning (at log level 3) for queries that are 1/4 of the hard timeout.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>\n\nAutobuild-User(master): Douglas Bagnall <dbagnall@samba.org>\nAutobuild-Date(master): Thu Nov 25 02:30:42 UTC 2021 on sn-devel-184\n\n(cherry picked from commit 3507e96b3dcf0c0b8eff7b2c08ffccaf0812a393)",
        "before_after_code_files": [
          "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
          ],
          "candidate": [
            "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c": [
          "File: source4/ldap_server/ldap_backend.c -> source4/ldap_server/ldap_backend.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "729:  unsigned int i;",
          "730:  int extended_type = 1;",
          "733:  local_ctx = talloc_new(call);",
          "734:  NT_STATUS_HAVE_NO_MEMORY(local_ctx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "736:  struct timeval start_time = timeval_current();",
          "737:  struct timeval warning_time",
          "738:   = timeval_add(&start_time,",
          "739:          call->conn->limits.search_timeout / 4,",
          "740:          0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "736:  basedn = ldb_dn_new(local_ctx, samdb, req->basedn);",
          "737:  NT_STATUS_HAVE_NO_MEMORY(basedn);",
          "742:  switch (req->scope) {",
          "762:  }",
          "763:  DEBUG(10,(\"SearchRequest: scope: [%s]\\n\", scope_str));",
          "",
          "[Removed Lines]",
          "739:  DEBUG(10, (\"SearchRequest: basedn: [%s]\\n\", req->basedn));",
          "740:  DEBUG(10, (\"SearchRequest: filter: [%s]\\n\", ldb_filter_from_tree(call, req->tree)));",
          "743:   case LDAP_SEARCH_SCOPE_BASE:",
          "744:    scope_str = \"BASE\";",
          "745:    scope = LDB_SCOPE_BASE;",
          "746:    break;",
          "747:   case LDAP_SEARCH_SCOPE_SINGLE:",
          "748:    scope_str = \"ONE\";",
          "749:    scope = LDB_SCOPE_ONELEVEL;",
          "750:    break;",
          "751:   case LDAP_SEARCH_SCOPE_SUB:",
          "752:    scope_str = \"SUB\";",
          "753:    scope = LDB_SCOPE_SUBTREE;",
          "754:    break;",
          "755:          default:",
          "756:    result = LDAP_PROTOCOL_ERROR;",
          "757:    map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
          "758:     &errstr);",
          "759:    errstr = talloc_asprintf(local_ctx,",
          "760:     \"%s. Invalid scope\", errstr);",
          "761:    goto reply;",
          "",
          "[Added Lines]",
          "749:  case LDAP_SEARCH_SCOPE_BASE:",
          "750:   scope_str = \"BASE\";",
          "751:   scope = LDB_SCOPE_BASE;",
          "752:   break;",
          "753:  case LDAP_SEARCH_SCOPE_SINGLE:",
          "754:   scope_str = \"ONE\";",
          "755:   scope = LDB_SCOPE_ONELEVEL;",
          "756:   break;",
          "757:  case LDAP_SEARCH_SCOPE_SUB:",
          "758:   scope_str = \"SUB\";",
          "759:   scope = LDB_SCOPE_SUBTREE;",
          "760:   break;",
          "761:  default:",
          "762:   result = LDAP_PROTOCOL_ERROR;",
          "763:   map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
          "764:          &errstr);",
          "765:   scope_str = \"<Invalid scope>\";",
          "766:   errstr = talloc_asprintf(local_ctx,",
          "767:       \"%s. Invalid scope\", errstr);",
          "768:   goto reply;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "911:  }",
          "913: reply:",
          "914:  DLIST_REMOVE(call->conn->pending_calls, call);",
          "915:  call->notification.busy = false;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "930:  if ((req->timelimit == 0 || call->conn->limits.search_timeout < req->timelimit)",
          "931:      && ldb_ret == LDB_ERR_TIME_LIMIT_EXCEEDED) {",
          "932:   struct dom_sid_buf sid_buf;",
          "933:   DBG_WARNING(\"MaxQueryDuration(%d) timeout exceeded \"",
          "934:        \"in SearchRequest by %s from %s filter: [%s] \"",
          "935:        \"basedn: [%s] \"",
          "936:        \"scope: [%s]\\n\",",
          "937:        call->conn->limits.search_timeout,",
          "938:        dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "939:          &sid_buf),",
          "940:        tsocket_address_string(call->conn->connection->remote_address,",
          "941:          call),",
          "942:        ldb_filter_from_tree(call, req->tree),",
          "943:        ldb_dn_get_extended_linearized(call, basedn, 1),",
          "944:        scope_str);",
          "945:   for (i=0; i < req->num_attributes; i++) {",
          "946:    DBG_WARNING(\"MaxQueryDuration timeout exceeded attrs: [%s]\\n\",",
          "947:         req->attributes[i]);",
          "948:   }",
          "950:  } else if (timeval_expired(&warning_time)) {",
          "951:   struct dom_sid_buf sid_buf;",
          "952:   DBG_NOTICE(\"Long LDAP Query: Duration was %.2fs, \"",
          "953:       \"MaxQueryDuration(%d)/4 == %d \"",
          "954:       \"in SearchRequest by %s from %s filter: [%s] \"",
          "955:       \"basedn: [%s] \"",
          "956:       \"scope: [%s] \"",
          "957:       \"result: %s\\n\",",
          "958:       timeval_elapsed(&start_time),",
          "959:       call->conn->limits.search_timeout,",
          "960:       call->conn->limits.search_timeout / 4,",
          "961:       dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "962:         &sid_buf),",
          "963:       tsocket_address_string(call->conn->connection->remote_address,",
          "964:         call),",
          "965:       ldb_filter_from_tree(call, req->tree),",
          "966:       ldb_dn_get_extended_linearized(call, basedn, 1),",
          "967:       scope_str,",
          "968:       ldb_strerror(ldb_ret));",
          "969:   for (i=0; i < req->num_attributes; i++) {",
          "970:    DBG_NOTICE(\"Long LDAP Query attrs: [%s]\\n\",",
          "971:        req->attributes[i]);",
          "972:   }",
          "973:  } else {",
          "974:   struct dom_sid_buf sid_buf;",
          "975:   DBG_INFO(\"LDAP Query: Duration was %.2fs, \"",
          "976:     \"SearchRequest by %s from %s filter: [%s] \"",
          "977:     \"basedn: [%s] \"",
          "978:     \"scope: [%s] \"",
          "979:     \"result: %s\\n\",",
          "980:     timeval_elapsed(&start_time),",
          "981:     dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "982:       &sid_buf),",
          "983:     tsocket_address_string(call->conn->connection->remote_address,",
          "984:       call),",
          "985:     ldb_filter_from_tree(call, req->tree),",
          "986:     ldb_dn_get_extended_linearized(call, basedn, 1),",
          "987:     scope_str,",
          "988:     ldb_strerror(ldb_ret));",
          "989:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9aa03f402b7af97384e44dd4417587ccf98e138d",
      "candidate_info": {
        "commit_hash": "9aa03f402b7af97384e44dd4417587ccf98e138d",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/9aa03f402b7af97384e44dd4417587ccf98e138d",
        "files": [
          "source4/ldap_server/ldap_backend.c"
        ],
        "message": "CVE-2021-3670 ldap_server: Clearly log LDAP queries and timeouts\n\nThis puts all the detail on one line so it can be searched\nby IP address and connecting SID.\n\nThis relies on the anr handling as otherwise this log\nbecomes the expanded query, not the original one.\n\nRN: Provide clear logs of the LDAP search and who made it, including\na warning (at log level 3) for queries that are 1/4 of the hard timeout.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>\n\nAutobuild-User(master): Douglas Bagnall <dbagnall@samba.org>\nAutobuild-Date(master): Thu Nov 25 02:30:42 UTC 2021 on sn-devel-184\n\n(cherry picked from commit 3507e96b3dcf0c0b8eff7b2c08ffccaf0812a393)",
        "before_after_code_files": [
          "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
          ],
          "candidate": [
            "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/ldap_server/ldap_backend.c||source4/ldap_server/ldap_backend.c": [
          "File: source4/ldap_server/ldap_backend.c -> source4/ldap_server/ldap_backend.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "729:  unsigned int i;",
          "730:  int extended_type = 1;",
          "733:  local_ctx = talloc_new(call);",
          "734:  NT_STATUS_HAVE_NO_MEMORY(local_ctx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "736:  struct timeval start_time = timeval_current();",
          "737:  struct timeval warning_time",
          "738:   = timeval_add(&start_time,",
          "739:          call->conn->limits.search_timeout / 4,",
          "740:          0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "736:  basedn = ldb_dn_new(local_ctx, samdb, req->basedn);",
          "737:  NT_STATUS_HAVE_NO_MEMORY(basedn);",
          "742:  switch (req->scope) {",
          "762:  }",
          "763:  DEBUG(10,(\"SearchRequest: scope: [%s]\\n\", scope_str));",
          "",
          "[Removed Lines]",
          "739:  DEBUG(10, (\"SearchRequest: basedn: [%s]\\n\", req->basedn));",
          "740:  DEBUG(10, (\"SearchRequest: filter: [%s]\\n\", ldb_filter_from_tree(call, req->tree)));",
          "743:   case LDAP_SEARCH_SCOPE_BASE:",
          "744:    scope_str = \"BASE\";",
          "745:    scope = LDB_SCOPE_BASE;",
          "746:    break;",
          "747:   case LDAP_SEARCH_SCOPE_SINGLE:",
          "748:    scope_str = \"ONE\";",
          "749:    scope = LDB_SCOPE_ONELEVEL;",
          "750:    break;",
          "751:   case LDAP_SEARCH_SCOPE_SUB:",
          "752:    scope_str = \"SUB\";",
          "753:    scope = LDB_SCOPE_SUBTREE;",
          "754:    break;",
          "755:          default:",
          "756:    result = LDAP_PROTOCOL_ERROR;",
          "757:    map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
          "758:     &errstr);",
          "759:    errstr = talloc_asprintf(local_ctx,",
          "760:     \"%s. Invalid scope\", errstr);",
          "761:    goto reply;",
          "",
          "[Added Lines]",
          "749:  case LDAP_SEARCH_SCOPE_BASE:",
          "750:   scope_str = \"BASE\";",
          "751:   scope = LDB_SCOPE_BASE;",
          "752:   break;",
          "753:  case LDAP_SEARCH_SCOPE_SINGLE:",
          "754:   scope_str = \"ONE\";",
          "755:   scope = LDB_SCOPE_ONELEVEL;",
          "756:   break;",
          "757:  case LDAP_SEARCH_SCOPE_SUB:",
          "758:   scope_str = \"SUB\";",
          "759:   scope = LDB_SCOPE_SUBTREE;",
          "760:   break;",
          "761:  default:",
          "762:   result = LDAP_PROTOCOL_ERROR;",
          "763:   map_ldb_error(local_ctx, LDB_ERR_PROTOCOL_ERROR, NULL,",
          "764:          &errstr);",
          "765:   scope_str = \"<Invalid scope>\";",
          "766:   errstr = talloc_asprintf(local_ctx,",
          "767:       \"%s. Invalid scope\", errstr);",
          "768:   goto reply;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "911:  }",
          "913: reply:",
          "914:  DLIST_REMOVE(call->conn->pending_calls, call);",
          "915:  call->notification.busy = false;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "930:  if ((req->timelimit == 0 || call->conn->limits.search_timeout < req->timelimit)",
          "931:      && ldb_ret == LDB_ERR_TIME_LIMIT_EXCEEDED) {",
          "932:   struct dom_sid_buf sid_buf;",
          "933:   DBG_WARNING(\"MaxQueryDuration(%d) timeout exceeded \"",
          "934:        \"in SearchRequest by %s from %s filter: [%s] \"",
          "935:        \"basedn: [%s] \"",
          "936:        \"scope: [%s]\\n\",",
          "937:        call->conn->limits.search_timeout,",
          "938:        dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "939:          &sid_buf),",
          "940:        tsocket_address_string(call->conn->connection->remote_address,",
          "941:          call),",
          "942:        ldb_filter_from_tree(call, req->tree),",
          "943:        ldb_dn_get_extended_linearized(call, basedn, 1),",
          "944:        scope_str);",
          "945:   for (i=0; i < req->num_attributes; i++) {",
          "946:    DBG_WARNING(\"MaxQueryDuration timeout exceeded attrs: [%s]\\n\",",
          "947:         req->attributes[i]);",
          "948:   }",
          "950:  } else if (timeval_expired(&warning_time)) {",
          "951:   struct dom_sid_buf sid_buf;",
          "952:   DBG_NOTICE(\"Long LDAP Query: Duration was %.2fs, \"",
          "953:       \"MaxQueryDuration(%d)/4 == %d \"",
          "954:       \"in SearchRequest by %s from %s filter: [%s] \"",
          "955:       \"basedn: [%s] \"",
          "956:       \"scope: [%s] \"",
          "957:       \"result: %s\\n\",",
          "958:       timeval_elapsed(&start_time),",
          "959:       call->conn->limits.search_timeout,",
          "960:       call->conn->limits.search_timeout / 4,",
          "961:       dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "962:         &sid_buf),",
          "963:       tsocket_address_string(call->conn->connection->remote_address,",
          "964:         call),",
          "965:       ldb_filter_from_tree(call, req->tree),",
          "966:       ldb_dn_get_extended_linearized(call, basedn, 1),",
          "967:       scope_str,",
          "968:       ldb_strerror(ldb_ret));",
          "969:   for (i=0; i < req->num_attributes; i++) {",
          "970:    DBG_NOTICE(\"Long LDAP Query attrs: [%s]\\n\",",
          "971:        req->attributes[i]);",
          "972:   }",
          "973:  } else {",
          "974:   struct dom_sid_buf sid_buf;",
          "975:   DBG_INFO(\"LDAP Query: Duration was %.2fs, \"",
          "976:     \"SearchRequest by %s from %s filter: [%s] \"",
          "977:     \"basedn: [%s] \"",
          "978:     \"scope: [%s] \"",
          "979:     \"result: %s\\n\",",
          "980:     timeval_elapsed(&start_time),",
          "981:     dom_sid_str_buf(&call->conn->session_info->security_token->sids[0],",
          "982:       &sid_buf),",
          "983:     tsocket_address_string(call->conn->connection->remote_address,",
          "984:       call),",
          "985:     ldb_filter_from_tree(call, req->tree),",
          "986:     ldb_dn_get_extended_linearized(call, basedn, 1),",
          "987:     scope_str,",
          "988:     ldb_strerror(ldb_ret));",
          "989:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}