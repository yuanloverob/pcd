{
  "cve_id": "CVE-2014-3219",
  "cve_desc": "fish before 2.1.1 allows local users to write to arbitrary files via a symlink attack on (1) /tmp/fishd.log.%s, (2) /tmp/.pac-cache.$USER, (3) /tmp/.yum-cache.$USER, or (4) /tmp/.rpm-cache.$USER.",
  "repo": "fish-shell/fish-shell",
  "patch_hash": "3225d7e169a9edb2f470c26989e7bc8e0d0355ce",
  "patch_info": {
    "commit_hash": "3225d7e169a9edb2f470c26989e7bc8e0d0355ce",
    "repo": "fish-shell/fish-shell",
    "commit_url": "https://github.com/fish-shell/fish-shell/commit/3225d7e169a9edb2f470c26989e7bc8e0d0355ce",
    "files": [
      "env.cpp",
      "share/functions/__fish_print_packages.fish"
    ],
    "message": "avoid symlink attacks in __fish_print_packages and spawning fishd\n\n * use $XDG_CACHE_HOME for __fish_print_packages completion caches\n * when starting fishd, redirect fishd output to /dev/null, not a\n   predictable path\n\nFix for CVE-2014-3219.\n\nCloses #1440.",
    "before_after_code_files": [
      "env.cpp||env.cpp",
      "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish"
    ]
  },
  "patch_diff": {
    "env.cpp||env.cpp": [
      "File: env.cpp -> env.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "58: #include \"fish_version.h\"",
      "",
      "[Removed Lines]",
      "61: #define FISHD_CMD L\"fishd ^ /tmp/fishd.log.%s\"",
      "",
      "[Added Lines]",
      "61: #define FISHD_CMD L\"fishd ^ /dev/null\"",
      "",
      "---------------"
    ],
    "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish": [
      "File: share/functions/__fish_print_packages.fish -> share/functions/__fish_print_packages.fish",
      "--- Hunk 1 ---",
      "[Context before]",
      "12:  #Get the word 'Package' in the current language",
      "13:  set -l package (_ Package)",
      "15:  if type -f apt-cache >/dev/null",
      "16:   # Do not generate the cache as apparently sometimes this is slow.",
      "17:   # http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=547550",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "15:  # Set up cache directory",
      "16:  if test -z \"$XDG_CACHE_HOME\"",
      "17:   set XDG_CACHE_HOME $HOME/.cache",
      "18:  end",
      "19:  mkdir -m 700 -p $XDG_CACHE_HOME",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "32:     # Caches for 5 minutes",
      "33:  if type -f pacman >/dev/null",
      "35:   if test -f $cache_file",
      "36:    cat $cache_file",
      "37:    set age (math (date +%s) - (stat -c '%Y' $cache_file))",
      "",
      "[Removed Lines]",
      "34:   set cache_file /tmp/.pac-cache.$USER",
      "",
      "[Added Lines]",
      "40:   set cache_file $XDG_CACHE_HOME/.pac-cache.$USER",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "52:   # If the cache is less than six hours old, we do not recalculate it",
      "55:    if test -f $cache_file",
      "56:    cat $cache_file",
      "57:    set age (math (date +%s) - (stat -c '%Y' $cache_file))",
      "",
      "[Removed Lines]",
      "54:   set cache_file /tmp/.yum-cache.$USER",
      "",
      "[Added Lines]",
      "60:   set cache_file $XDG_CACHE_HOME/.yum-cache.$USER",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "74:   # If the cache is less than five minutes old, we do not recalculate it",
      "77:    if test -f $cache_file",
      "78:    cat $cache_file",
      "79:    set age (math (date +%s) - (stat -c '%Y' $cache_file))",
      "",
      "[Removed Lines]",
      "76:   set cache_file /tmp/.rpm-cache.$USER",
      "",
      "[Added Lines]",
      "82:   set cache_file $XDG_CACHE_HOME/.rpm-cache.$USER",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9c78295a9a4eb243fc8876a89ee7edd11999293c",
      "candidate_info": {
        "commit_hash": "9c78295a9a4eb243fc8876a89ee7edd11999293c",
        "repo": "fish-shell/fish-shell",
        "commit_url": "https://github.com/fish-shell/fish-shell/commit/9c78295a9a4eb243fc8876a89ee7edd11999293c",
        "files": [
          "share/functions/__fish_print_packages.fish"
        ],
        "message": "avoid symlink attacks in __fish_print_packages\n\n * use $XDG_CACHE_HOME for __fish_print_packages completion caches\n\nFix for CVE-2014-3219.\n\nCloses #1440.",
        "before_after_code_files": [
          "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish"
          ],
          "candidate": [
            "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish"
          ]
        }
      },
      "candidate_diff": {
        "share/functions/__fish_print_packages.fish||share/functions/__fish_print_packages.fish": [
          "File: share/functions/__fish_print_packages.fish -> share/functions/__fish_print_packages.fish",
          "--- Hunk 1 ---",
          "[Context before]",
          "12:  #Get the word 'Package' in the current language",
          "13:  set -l package (_ Package)",
          "15:  if type -f apt-cache >/dev/null",
          "16:   # Do not generate the cache as apparently sometimes this is slow.",
          "17:   # http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=547550",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "15:  # Set up cache directory",
          "16:  if test -z \"$XDG_CACHE_HOME\"",
          "17:   set XDG_CACHE_HOME $HOME/.cache",
          "18:  end",
          "19:  mkdir -m 700 -p $XDG_CACHE_HOME",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "36:   # If the cache is less than six hours old, we do not recalculate it",
          "39:    if test -f $cache_file",
          "40:    cat $cache_file",
          "41:    set age (math (date +%s) - (stat -c '%Y' $cache_file))",
          "",
          "[Removed Lines]",
          "38:   set cache_file /tmp/.yum-cache.$USER",
          "",
          "[Added Lines]",
          "44:   set cache_file $XDG_CACHE_HOME/.yum-cache.$USER",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "57:   # If the cache is less than five minutes old, we do not recalculate it",
          "60:    if test -f $cache_file",
          "61:    cat $cache_file",
          "62:    set age (math (date +%s) - (stat -c '%Y' $cache_file))",
          "",
          "[Removed Lines]",
          "59:   set cache_file /tmp/.rpm-cache.$USER",
          "",
          "[Added Lines]",
          "65:   set cache_file $XDG_CACHE_HOME/.rpm-cache.$USER",
          "",
          "---------------"
        ]
      }
    }
  ]
}