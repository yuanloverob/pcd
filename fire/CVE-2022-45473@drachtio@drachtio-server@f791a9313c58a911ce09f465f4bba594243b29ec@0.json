{
  "cve_id": "CVE-2022-45473",
  "cve_desc": "In drachtio-server 0.8.18, /var/log/drachtio has mode 0777 and drachtio.log has mode 0666.",
  "repo": "drachtio/drachtio-server",
  "patch_hash": "f791a9313c58a911ce09f465f4bba594243b29ec",
  "patch_info": {
    "commit_hash": "f791a9313c58a911ce09f465f4bba594243b29ec",
    "repo": "drachtio/drachtio-server",
    "commit_url": "https://github.com/drachtio/drachtio-server/commit/f791a9313c58a911ce09f465f4bba594243b29ec",
    "files": [
      "src/controller.cpp"
    ],
    "message": "make drachtio log file not globally readable (#241)",
    "before_after_code_files": [
      "src/controller.cpp||src/controller.cpp"
    ]
  },
  "patch_diff": {
    "src/controller.cpp||src/controller.cpp": [
      "File: src/controller.cpp -> src/controller.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "68: #include <boost/log/sinks.hpp>",
      "69: #include <boost/log/sources/logger.hpp>",
      "70: #include <boost/algorithm/string/replace.hpp>",
      "72: #if defined(__clang__)",
      "73:     #pragma clang diagnostic pop",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "71: #include <boost/filesystem.hpp>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1006:                     ));",
      "1008:                     logging::core::get()->add_sink(m_sinkTextFile);",
      "1009:                 }",
      "1010:                 logging::core::get()->set_filter(",
      "1011:                    expr::attr<severity_levels>(\"Severity\") <= m_current_severity_threshold",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1010:                     boost::filesystem::permissions(name,",
      "1011:                         boost::filesystem::perms::owner_read |",
      "1012:                         boost::filesystem::perms::owner_write |",
      "1013:                         boost::filesystem::perms::group_read |",
      "1014:                         boost::filesystem::perms::group_write",
      "1015:                     );",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4f3530fed8bf6b688375d9f2594cf034fd906269",
      "candidate_info": {
        "commit_hash": "4f3530fed8bf6b688375d9f2594cf034fd906269",
        "repo": "drachtio/drachtio-server",
        "commit_url": "https://github.com/drachtio/drachtio-server/commit/4f3530fed8bf6b688375d9f2594cf034fd906269",
        "files": [
          "src/controller.cpp",
          "src/controller.hpp"
        ],
        "message": "add --globally-readable-logs as part of #241",
        "before_after_code_files": [
          "src/controller.cpp||src/controller.cpp",
          "src/controller.hpp||src/controller.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "src/controller.cpp||src/controller.cpp"
          ],
          "candidate": [
            "src/controller.cpp||src/controller.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/controller.cpp||src/controller.cpp": [
          "File: src/controller.cpp -> src/controller.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "291:         m_current_severity_threshold(log_none), m_nSofiaLoglevel(-1), m_bIsOutbound(false), m_bConsoleLogging(false),",
          "292:         m_nHomerPort(0), m_nHomerId(0), m_mtu(0), m_bAggressiveNatDetection(false), m_bMemoryDebug(false),",
          "293:         m_nPrometheusPort(0), m_strPrometheusAddress(\"0.0.0.0\"), m_tcpKeepaliveSecs(UINT16_MAX), m_bDumpMemory(false),",
          "296:         getEnv();",
          "",
          "[Removed Lines]",
          "294:         m_minTlsVersion(0), m_bDisableNatDetection(false), m_pBlacklist(nullptr), m_bAlwaysSend180(false) {",
          "",
          "[Added Lines]",
          "294:         m_minTlsVersion(0), m_bDisableNatDetection(false), m_pBlacklist(nullptr), m_bAlwaysSend180(false), m_bGloballyReadableLogs(false) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "455:                 {\"blacklist-refresh-secs\", required_argument, 0, 'R'},",
          "456:                 {\"always-send-180\", no_argument, 0, 'S'},",
          "457:                 {\"user-agent-options-auto-respond\", no_argument, 0, 'T'},",
          "458:                 {\"version\",    no_argument, 0, 'v'},",
          "459:                 {0, 0, 0, 0}",
          "460:             };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "458:                 {\"globally-readable-logs\", no_argument, 0, 'U'},",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "674:                 case 'T':",
          "675:                     m_strUserAgentAutoAnswerOptions = optarg;",
          "676:                     break;",
          "677:                 case 'v':",
          "678:                     cout << DRACHTIO_VERSION << endl ;",
          "679:                     exit(0) ;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "678:                 case 'U':",
          "679:                     m_bGloballyReadableLogs = true;",
          "680:                     break;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "978:                 unsigned int rotationSize, maxSize, minSize, maxFiles ;",
          "979:                 bool autoFlush ;",
          "980:                 if( m_Config->getFileLogTarget( name, archiveDirectory, rotationSize, autoFlush, maxSize, minSize, maxFiles ) ) {",
          "982:                     m_sinkTextFile.reset(",
          "983:                         new sinks::synchronous_sink< sinks::text_file_backend >(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "985:                    if (!m_bGloballyReadableLogs) {",
          "986:                    boost::filesystem::path p(name);",
          "987:                     boost::filesystem::path dir = p.parent_path();",
          "988:                     boost::filesystem::create_directory(dir);",
          "989:                     std::ofstream output(name, ofstream::out | ofstream::app);",
          "990:                     output.close();",
          "991:                     boost::filesystem::permissions(name,",
          "992:                         boost::filesystem::perms::owner_read |",
          "993:                         boost::filesystem::perms::owner_write |",
          "994:                         boost::filesystem::perms::group_read |",
          "995:                         boost::filesystem::perms::group_write",
          "996:                     );",
          "997:                    }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1007:                     ));",
          "1009:                     logging::core::get()->add_sink(m_sinkTextFile);",
          "1017:                 }",
          "1018:                 logging::core::get()->set_filter(",
          "1019:                    expr::attr<severity_levels>(\"Severity\") <= m_current_severity_threshold",
          "",
          "[Removed Lines]",
          "1010:                     boost::filesystem::permissions(name,",
          "1011:                         boost::filesystem::perms::owner_read |",
          "1012:                         boost::filesystem::perms::owner_write |",
          "1013:                         boost::filesystem::perms::group_read |",
          "1014:                         boost::filesystem::perms::group_write",
          "1015:                     );",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/controller.hpp||src/controller.hpp": [
          "File: src/controller.hpp -> src/controller.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "286:     bool m_bAlwaysSend180;",
          "288:     string  m_strUserAgentAutoAnswerOptions;",
          "289:   } ;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "288:     bool m_bGloballyReadableLogs;",
          "",
          "---------------"
        ]
      }
    }
  ]
}