{
  "cve_id": "CVE-2021-33035",
  "cve_desc": "Apache OpenOffice opens dBase/DBF documents and shows the contents as spreadsheets. DBF are database files with data organized in fields. When reading DBF data the size of certain fields is not checked: the data is just copied into local variables. A carefully crafted document could overflow the allocated space, leading to the execution of arbitrary code by altering the contents of the program stack. This issue affects Apache OpenOffice up to and including version 4.1.10",
  "repo": "apache/openoffice",
  "patch_hash": "efddaef0151af3be16078cc4d88c6bae0f911e56",
  "patch_info": {
    "commit_hash": "efddaef0151af3be16078cc4d88c6bae0f911e56",
    "repo": "apache/openoffice",
    "commit_url": "https://github.com/apache/openoffice/commit/efddaef0151af3be16078cc4d88c6bae0f911e56#diff-ea66e734dd358922aba12ad4ba39c96bdc6cbde587d07dbc63d04daa0a30e90f",
    "files": [
      "main/connectivity/source/drivers/dbase/DTable.cxx"
    ],
    "message": "add useful checks",
    "before_after_code_files": [
      "main/connectivity/source/drivers/dbase/DTable.cxx||main/connectivity/source/drivers/dbase/DTable.cxx"
    ]
  },
  "patch_diff": {
    "main/connectivity/source/drivers/dbase/DTable.cxx||main/connectivity/source/drivers/dbase/DTable.cxx": [
      "File: main/connectivity/source/drivers/dbase/DTable.cxx -> main/connectivity/source/drivers/dbase/DTable.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "896:         else if ( DataType::TIMESTAMP == nType )",
      "897:         {",
      "898:             sal_Int32 nDate = 0,nTime = 0;",
      "899:    memcpy(&nDate, pData, 4);",
      "900:             memcpy(&nTime, pData+ 4, 4);",
      "901:             if ( !nDate && !nTime )",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "899:             OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "900:             if (nLen != 8) {",
      "901:                 return false;",
      "902:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "911:         }",
      "912:         else if ( DataType::INTEGER == nType )",
      "913:         {",
      "914:             sal_Int32 nValue = 0;",
      "915:    memcpy(&nValue, pData, nLen);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "918:             OSL_ENSURE(nLen == 4, \"Invalid length for integer field\");",
      "919:             if (nLen != 4) {",
      "920:                 return false;",
      "921:             }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "918:         else if ( DataType::DOUBLE == nType )",
      "919:         {",
      "920:             double d = 0.0;",
      "921:             if (getBOOL((*aIter)->getPropertyValue(OMetaConnection::getPropMap().getNameByIndex(PROPERTY_ID_ISCURRENCY)))) // Currency wird gesondert behandelt",
      "922:             {",
      "923:                 sal_Int64 nValue = 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "929:             OSL_ENSURE(nLen == 8, \"Invalid length for double field\");",
      "930:             if (nLen != 8) {",
      "931:                 return false;",
      "932:             }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "959:    {",
      "960:     case DataType::DATE:",
      "961:     {",
      "962:      if (aStr.Len() != nLen)",
      "963:      {",
      "964:       (_rRow->get())[i]->setNull();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "974:                     OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "975:                     if (nLen != 8) {",
      "976:                         return false;",
      "977:                     }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "978:     break;",
      "979:     case DataType::BIT:",
      "980:     {",
      "981:      sal_Bool b;",
      "982:      switch (* ((const char *)pData))",
      "983:      {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "997:                     OSL_ENSURE(nLen == 1, \"Invalid length for bit field\");",
      "998:                     if (nLen != 1) {",
      "999:                         return false;",
      "1000:                     }",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1873:    {",
      "1874:                 case DataType::TIMESTAMP:",
      "1875:                     {",
      "1876:                         sal_Int32 nJulianDate = 0, nJulianTime = 0;",
      "1877:                         lcl_CalcJulDate(nJulianDate,nJulianTime,rRow.get()[nPos]->getValue());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1896:                         OSL_ENSURE(nLen == 8, \"Invalid length for timestamp field\");",
      "1897:                         if (nLen != 8) {",
      "1898:                             bHadError = true;",
      "1899:                             break;",
      "1900:                         }",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1882:                     break;",
      "1883:     case DataType::DATE:",
      "1884:     {",
      "1885:      ::com::sun::star::util::Date aDate;",
      "1886:      if(rRow.get()[nPos]->getValue().getTypeKind() == DataType::DOUBLE)",
      "1887:       aDate = ::dbtools::DBTypeConversion::toDate(rRow.get()[nPos]->getValue().getDouble());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1910:                     OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "1911:                     if (nLen != 8) {",
      "1912:                         bHadError = true;",
      "1913:                         break;",
      "1914:                     }",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1900:     } break;",
      "1901:                 case DataType::INTEGER:",
      "1902:                     {",
      "1903:                         sal_Int32 nValue = rRow.get()[nPos]->getValue();",
      "1904:                         memcpy(pData,&nValue,nLen);",
      "1905:                     }",
      "1906:                     break;",
      "1907:                 case DataType::DOUBLE:",
      "1908:                     {",
      "1909:                         const double d = rRow.get()[nPos]->getValue();",
      "1910:                         m_pColumns->getByIndex(i) >>= xCol;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1933:                         OSL_ENSURE(nLen == 4, \"Invalid length for integer field\");",
      "1934:                         if (nLen != 4) {",
      "1935:                             bHadError = true;",
      "1936:                             break;",
      "1937:                         }",
      "1944:                         OSL_ENSURE(nLen == 8, \"Invalid length for double field\");",
      "1945:                         if (nLen != 8) {",
      "1946:                             bHadError = true;",
      "1947:                             break;",
      "1948:                         }",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1958:      }",
      "1959:     } break;",
      "1960:     case DataType::BIT:",
      "1962:      break;",
      "1963:                 case DataType::LONGVARBINARY:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2001:                     OSL_ENSURE(nLen == 1, \"Invalid length for bit field\");",
      "2002:                     if (nLen != 1) {",
      "2003:                         bHadError = true;",
      "2004:                         break;",
      "2005:                     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3ecf8acb5dd569c5d2570948325c48da45ee8b06",
      "candidate_info": {
        "commit_hash": "3ecf8acb5dd569c5d2570948325c48da45ee8b06",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/3ecf8acb5dd569c5d2570948325c48da45ee8b06",
        "files": [
          "main/nss/makefile.mk"
        ],
        "message": "Fix nss build on Windows.\n\n(cherry picked from commit 71f9ed3af399651ba219cc7fdfd0a8b8178cb51f)",
        "before_after_code_files": [
          "main/nss/makefile.mk||main/nss/makefile.mk"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/nss/makefile.mk||main/nss/makefile.mk": [
          "File: main/nss/makefile.mk -> main/nss/makefile.mk",
          "--- Hunk 1 ---",
          "[Context before]",
          "117: .ELSE   # \"$(COM)\"==\"GCC\"",
          "118: MOZ_MSVCVERSION= 9",
          "119: .EXPORT : MOZ_MSVCVERSION",
          "121: moz_build:=$(shell cygpath -p $(MOZILLABUILD))",
          "123: #Using WINNT will cause at least that nspr4.dll, plc4.dll, plds4.dll",
          "",
          "[Removed Lines]",
          "120: PATCH_FILES+=nss_win.patch nss_bug_1437734.patch",
          "",
          "[Added Lines]",
          "120: PATCH_FILES+=nss_win.patch",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "152bbaf08a6a215faa6c9a8ce5d465b3d106865e",
      "candidate_info": {
        "commit_hash": "152bbaf08a6a215faa6c9a8ce5d465b3d106865e",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/152bbaf08a6a215faa6c9a8ce5d465b3d106865e",
        "files": [
          "main/helpcontent2/source/text/scalc/main0210.xhp",
          "main/sc/uiconfig/scalc/toolbar/previewbar.xml"
        ],
        "message": "Changed order of Zoom In/Out in Page Preview toolbar (Calc)\n\n(cherry picked from commit f21749b3994a33d5b98ab18d1bc479bc10695883)",
        "before_after_code_files": [
          "main/helpcontent2/source/text/scalc/main0210.xhp||main/helpcontent2/source/text/scalc/main0210.xhp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/helpcontent2/source/text/scalc/main0210.xhp||main/helpcontent2/source/text/scalc/main0210.xhp": [
          "File: main/helpcontent2/source/text/scalc/main0210.xhp -> main/helpcontent2/source/text/scalc/main0210.xhp",
          "--- Hunk 1 ---",
          "[Context before]",
          "50: <embed href=\"text/shared/02/10030000.xhp#syersteseite\"/>",
          "51: <embed href=\"text/shared/02/10040000.xhp#letzteseite\"/>",
          "52: <embed href=\"text/shared/02/10040000.xhp#syletzteseite\"/>",
          "55: <embed href=\"text/scalc/02/10060000.xhp#massstabverkleinern\"/>",
          "56: <embed href=\"text/scalc/02/10060000.xhp#syklein\"/>",
          "57: <paragraph role=\"heading\" id=\"hd_id3147394\" xml-lang=\"en-US\" level=\"2\" l10n=\"U\" oldref=\"3\"><link href=\"text/scalc/01/05070000.xhp\" name=\"Page Format\">Page Format</link></paragraph>",
          "58: <embed href=\"text/scalc/01/05070000.xhp#seitetext\"/>",
          "59: <embed href=\"text/shared/02/10100000.xhp#schliessen\"/>",
          "",
          "[Removed Lines]",
          "53: <embed href=\"text/scalc/02/10050000.xhp#massstabvergroessern\"/>",
          "54: <embed href=\"text/scalc/02/10050000.xhp#sygross\"/>",
          "",
          "[Added Lines]",
          "55: <embed href=\"text/scalc/02/10050000.xhp#massstabvergroessern\"/>",
          "56: <embed href=\"text/scalc/02/10050000.xhp#sygross\"/>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "35c52e30ce8de3423922dd263830daf871f51036",
      "candidate_info": {
        "commit_hash": "35c52e30ce8de3423922dd263830daf871f51036",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/35c52e30ce8de3423922dd263830daf871f51036",
        "files": [
          "main/sfx2/source/sidebar/Theme.cxx"
        ],
        "message": "Get rid of gradients in sidebar",
        "before_after_code_files": [
          "main/sfx2/source/sidebar/Theme.cxx||main/sfx2/source/sidebar/Theme.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/sfx2/source/sidebar/Theme.cxx||main/sfx2/source/sidebar/Theme.cxx": [
          "File: main/sfx2/source/sidebar/Theme.cxx -> main/sfx2/source/sidebar/Theme.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "226:   Color aBorderColor (aBaseBackgroundColor);",
          "228:   Color aSecondColor (aBaseBackgroundColor);",
          "231:   setPropertyValue(",
          "232:    maPropertyIdToNameMap[Paint_DeckBackground],",
          "",
          "[Removed Lines]",
          "227:   aBorderColor.DecreaseLuminance(15);",
          "229:   aSecondColor.DecreaseLuminance(15);",
          "",
          "[Added Lines]",
          "199:   aBorderColor.DecreaseLuminance(80);",
          "201:   aSecondColor.DecreaseLuminance(0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "385:      : A2S(\"private:graphicrepository/sfx2/res/symphony/morebutton.png\")));",
          "386:   setPropertyValue(",
          "387:    maPropertyIdToNameMap[Image_Closer],",
          "389:   setPropertyValue(",
          "390:    maPropertyIdToNameMap[Image_CloseIndicator],",
          "391:    Any(",
          "",
          "[Removed Lines]",
          "388:    Any(A2S(\"private:graphicrepository/sfx2/res/closedoc.png\")));",
          "",
          "[Added Lines]",
          "360:    Any(",
          "361:     mbIsHighContrastMode",
          "362:      ? A2S(\"private:graphicrepository/sfx2/res/closedochc.png\")",
          "363:      : A2S(\"private:graphicrepository/sfx2/res/closedoc.png\")));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "429:   Color aGradientStop2 (aBaseBackgroundColor);",
          "431:   Color aToolBoxBorderColor (aBaseBackgroundColor);",
          "433:   setPropertyValue(",
          "434:    maPropertyIdToNameMap[Paint_ToolBoxBackground],",
          "435:    Any(Tools::VclToAwtGradient(Gradient(",
          "",
          "[Removed Lines]",
          "430:   aGradientStop2.IncreaseLuminance(17);",
          "432:   aToolBoxBorderColor.DecreaseLuminance(12);",
          "",
          "[Added Lines]",
          "405:   aGradientStop2.IncreaseLuminance(0);",
          "407:   aToolBoxBorderColor.DecreaseLuminance(40);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c3df0d8d6c29bbe2662ee2db05e0890b0cd8658c",
      "candidate_info": {
        "commit_hash": "c3df0d8d6c29bbe2662ee2db05e0890b0cd8658c",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/c3df0d8d6c29bbe2662ee2db05e0890b0cd8658c",
        "files": [
          "extras/l10n/source/de/localize.sdf"
        ],
        "message": "Corrected string in German SDF",
        "before_after_code_files": [
          "extras/l10n/source/de/localize.sdf||extras/l10n/source/de/localize.sdf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "extras/l10n/source/de/localize.sdf||extras/l10n/source/de/localize.sdf": [
          "File: extras/l10n/source/de/localize.sdf -> extras/l10n/source/de/localize.sdf",
          "--- Hunk 1 ---",
          "[Context before]",
          "71276: svx source\\sidebar\\possize\\PosSizePropertyPanel.src 0 string RID_SIDEBAR_POSSIZE_PANEL STR_QH_VERT_FLIP   0 de Das gew\u00e4hlte Objekt vertikal spiegeln.    20130618 17:22:18",
          "71277: svx source\\sidebar\\text\\TextPropertyPanel.src 0 combobox RID_SIDEBAR_TEXT_PANEL CB_SBFONT_FONT HID_COMBO_FONT_NAME  0 de -  Schriftart  20130618 17:22:18",
          "71278: svx source\\sidebar\\text\\TextPropertyPanel.src 0 metricbox RID_SIDEBAR_TEXT_PANEL MB_SBFONT_FONTSIZE HID_METRIC_FONT_SIZE  0 de -  Schriftgr\u00f6\u00dfe  20130618 17:22:18",
          "71280: svx source\\sidebar\\text\\TextPropertyPanel.src 0 string RID_POPUPPANEL_TEXTPAGE_UNDERLINE STR_WITHOUT   0 de (Ohne)    20130618 17:22:18",
          "71281: svx source\\sidebar\\text\\TextPropertyPanel.src 0 string RID_POPUPPANEL_TEXTPAGE_UNDERLINE STR_SINGLE   0 de Einfach    20130618 17:22:18",
          "71282: svx source\\sidebar\\text\\TextPropertyPanel.src 0 string RID_POPUPPANEL_TEXTPAGE_UNDERLINE STR_DOUBLE   0 de Doppelt    20130618 17:22:18",
          "",
          "[Removed Lines]",
          "71279: svx source\\sidebar\\text\\TextPropertyPanel.src 0 pushbutton RID_POPUPPANEL_TEXTPAGE_UNDERLINE PB_OPTIONS HID_UNDERLINE_BTN  0 de Weitere ~Einstellungen...    20130618 17:22:18",
          "",
          "[Added Lines]",
          "71279: svx source\\sidebar\\text\\TextPropertyPanel.src 0 pushbutton RID_POPUPPANEL_TEXTPAGE_UNDERLINE PB_OPTIONS HID_UNDERLINE_BTN  0 de ~Mehr Optionen...    20130618 17:22:18",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e577397bf3f36959bc05b5f5a08c69ad5fbb7d61",
      "candidate_info": {
        "commit_hash": "e577397bf3f36959bc05b5f5a08c69ad5fbb7d61",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/e577397bf3f36959bc05b5f5a08c69ad5fbb7d61",
        "files": [
          "main/desktop/win32/source/setup/setup.cpp"
        ],
        "message": "Install MSVC runtimes silently\n\n(cherry picked from commit 908cc4a92408d9aa3bc9d002845a580a2175543f)",
        "before_after_code_files": [
          "main/desktop/win32/source/setup/setup.cpp||main/desktop/win32/source/setup/setup.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/desktop/win32/source/setup/setup.cpp||main/desktop/win32/source/setup/setup.cpp": [
          "File: main/desktop/win32/source/setup/setup.cpp -> main/desktop/win32/source/setup/setup.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "69: #define PARAM_PATCH         TEXT( \" /update \" )",
          "70: #define PARAM_REG_ALL_MSO_TYPES TEXT( \"REGISTER_ALL_MSO_TYPES=1 \" )",
          "71: #define PARAM_REG_NO_MSO_TYPES  TEXT( \"REGISTER_NO_MSO_TYPES=1 \" )",
          "74: #define PARAM_RUNNING           TEXT( \"ignore_running\" )",
          "75: #define CMDLN_REG_ALL_MSO_TYPES TEXT( \"msoreg=1\" )",
          "",
          "[Removed Lines]",
          "72: #define PARAM_SILENTINSTALL     TEXT( \" /QB\" )",
          "",
          "[Added Lines]",
          "72: #define PARAM_SILENTINSTALL     TEXT( \" /Q\" )",
          "",
          "---------------"
        ]
      }
    }
  ]
}