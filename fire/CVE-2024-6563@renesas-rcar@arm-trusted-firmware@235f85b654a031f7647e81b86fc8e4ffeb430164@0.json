{
  "cve_id": "CVE-2024-6563",
  "cve_desc": "Buffer Copy without Checking Size of Input ('Classic Buffer Overflow') vulnerability in Renesas arm-trusted-firmware allows Local Execution of Code. This vulnerability is associated with program files  https://github.Com/renesas-rcar/arm-trusted-firmware/blob/rcar_gen3_v2.5/drivers/renesas/common/io/i... https://github.Com/renesas-rcar/arm-trusted-firmware/blob/rcar_gen3_v2.5/drivers/renesas/common/io/io_rcar.C .\n\n\n\n\nIn line 313 \"addr_loaded_cnt\" is checked not to be \"CHECK_IMAGE_AREA_CNT\" (5) or larger, this check does not halt the function. Immediately after (line 317) there will be an overflow in the buffer and the value of \"dst\" will be written to the area immediately after the buffer, which is \"addr_loaded_cnt\". This will allow an attacker to freely control the value of \"addr_loaded_cnt\" and thus control the destination of the write immediately after (line 318). The write in line 318 will then be fully controlled by said attacker, with whichever address and whichever value (\"len\") they desire.",
  "repo": "renesas-rcar/arm-trusted-firmware",
  "patch_hash": "235f85b654a031f7647e81b86fc8e4ffeb430164",
  "patch_info": {
    "commit_hash": "235f85b654a031f7647e81b86fc8e4ffeb430164",
    "repo": "renesas-rcar/arm-trusted-firmware",
    "commit_url": "https://github.com/renesas-rcar/arm-trusted-firmware/commit/235f85b654a031f7647e81b86fc8e4ffeb430164",
    "files": [
      "drivers/renesas/common/io/io_rcar.c"
    ],
    "message": "rcar-gen3: plat: BL2: Enhanced buffer protection\n\nIf the parameter check is an error, the function is terminated immediately.\n\nReviewed-by: Ilay Levi <Ilay.levi@cymotive.com>\nSigned-off-by: Yoshifumi Hosoya <yoshifumi.hosoya.wj@renesas.com>",
    "before_after_code_files": [
      "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
    ]
  },
  "patch_diff": {
    "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c": [
      "File: drivers/renesas/common/io/io_rcar.c -> drivers/renesas/common/io/io_rcar.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "306:  if (dst >= prot_start && dst < prot_end) {",
      "307:   ERROR(\"BL2: dst address is on the protected area.\\n\");",
      "308:   result = IO_FAIL;",
      "309:  }",
      "311:  if ((dst < prot_start && dst > prot_start - len) || prot_start < len) {",
      "312:   ERROR(\"BL2: loaded data is on the protected area.\\n\");",
      "313:   result = IO_FAIL;",
      "318:  }",
      "320:  if (addr_loaded_cnt >= CHECK_IMAGE_AREA_CNT) {",
      "321:   ERROR(\"BL2: max loadable non secure images reached\\n\");",
      "322:   result = IO_FAIL;",
      "323:  }",
      "324:  addr_loaded[addr_loaded_cnt].dest = dst;",
      "325:  addr_loaded[addr_loaded_cnt].length = len;",
      "326:  for(int n=0; n<addr_loaded_cnt; n++) {",
      "",
      "[Removed Lines]",
      "314:  }",
      "315: done:",
      "316:  if (result == IO_FAIL) {",
      "317:   ERROR(\"BL2: Out of range : dst=0x%lx len=0x%lx\\n\", dst, len);",
      "",
      "[Added Lines]",
      "309:   goto done;",
      "315:   goto done;",
      "321:   goto done;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "348:        (dst + len >= addr_loaded[n].dest + addr_loaded[n].length))) {",
      "349:    ERROR(\"BL2: next image overlap a previous image area.\\n\");",
      "350:    result = IO_FAIL;",
      "351:   }",
      "352:  }",
      "353:  addr_loaded_cnt++;",
      "355:  return result;",
      "356: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "351:    goto done;",
      "356: done:",
      "357:  if (result == IO_FAIL) {",
      "358:   ERROR(\"BL2: Out of range : dst=0x%lx len=0x%lx\\n\", dst, len);",
      "359:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "64421e9195bfb01c09b42070353727536e58a5de",
      "candidate_info": {
        "commit_hash": "64421e9195bfb01c09b42070353727536e58a5de",
        "repo": "renesas-rcar/arm-trusted-firmware",
        "commit_url": "https://github.com/renesas-rcar/arm-trusted-firmware/commit/64421e9195bfb01c09b42070353727536e58a5de",
        "files": [
          "drivers/renesas/common/io/io_rcar.c"
        ],
        "message": "rcar-gen3: plat: BL2: Enhanced buffer protection\n\nIf the parameter check is an error, the function is terminated immediately.\n\nReviewed-by: Ilay Levi <Ilay.levi@cymotive.com>\nSigned-off-by: Yoshifumi Hosoya <yoshifumi.hosoya.wj@renesas.com>\nSigned-off-by: Dien Pham <dien.pham.ry@renesas.com>",
        "before_after_code_files": [
          "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
          ],
          "candidate": [
            "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c": [
          "File: drivers/renesas/common/io/io_rcar.c -> drivers/renesas/common/io/io_rcar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "312:  if (dst >= prot_start && dst < prot_end) {",
          "313:   ERROR(\"BL2: dst address is on the protected area.\\n\");",
          "314:   result = IO_FAIL;",
          "315:  }",
          "317:  if ((dst < prot_start && dst > prot_start - len) || prot_start < len) {",
          "318:   ERROR(\"BL2: loaded data is on the protected area.\\n\");",
          "319:   result = IO_FAIL;",
          "324:  }",
          "326:  if (addr_loaded_cnt >= CHECK_IMAGE_AREA_CNT) {",
          "327:   ERROR(\"BL2: max loadable non secure images reached\\n\");",
          "328:   result = IO_FAIL;",
          "329:  }",
          "330:  addr_loaded[addr_loaded_cnt].dest = dst;",
          "331:  addr_loaded[addr_loaded_cnt].length = len;",
          "332:  for(int n=0; n<addr_loaded_cnt; n++) {",
          "",
          "[Removed Lines]",
          "320:  }",
          "321: done:",
          "322:  if (result == IO_FAIL) {",
          "323:   ERROR(\"BL2: Out of range : dst=0x%lx len=0x%lx\\n\", dst, len);",
          "",
          "[Added Lines]",
          "315:   goto done;",
          "321:   goto done;",
          "327:   goto done;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "354:        (dst + len >= addr_loaded[n].dest + addr_loaded[n].length))) {",
          "355:    ERROR(\"BL2: next image overlap a previous image area.\\n\");",
          "356:    result = IO_FAIL;",
          "357:   }",
          "358:  }",
          "359:  addr_loaded_cnt++;",
          "361:  return result;",
          "362: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "357:    goto done;",
          "362: done:",
          "363:  if (result == IO_FAIL) {",
          "364:   ERROR(\"BL2: Out of range : dst=0x%lx len=0x%lx\\n\", dst, len);",
          "365:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}