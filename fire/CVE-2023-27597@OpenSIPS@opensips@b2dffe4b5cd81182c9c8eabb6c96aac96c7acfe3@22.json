{
  "cve_id": "CVE-2023-27597",
  "cve_desc": "OpenSIPS is a Session Initiation Protocol (SIP) server implementation. Prior to versions 3.1.8 and 3.2.5, when a specially crafted SIP message is processed by the function `rewrite_ruri`, a crash occurs due to a segmentation fault. This issue causes the server to crash. It affects configurations containing functions that make use of the affected code, such as the function `setport`. This issue has been fixed in version 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
  "patch_info": {
    "commit_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "files": [
      "parser/parse_uri.c"
    ],
    "message": "[core] fix parse_uri() parsing\n\nIssue discovered during OpenSIPS Security Audit 2022,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-358f-935m-7p9c",
    "before_after_code_files": [
      "parser/parse_uri.c||parser/parse_uri.c"
    ]
  },
  "patch_diff": {
    "parser/parse_uri.c||parser/parse_uri.c": [
      "File: parser/parse_uri.c -> parser/parse_uri.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1532:   case TELS_URI_T:",
      "1534:    uri->user=uri->host;",
      "1536:    uri->host.len=0;",
      "1537:    break;",
      "1538:   case SIP_URI_T:",
      "",
      "[Removed Lines]",
      "1535:    uri->host.s=\"\";",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1543:   case URN_NENA_SERVICE_URI_T:",
      "1544:    uri->user.s=0;",
      "1545:    uri->user.len=0;",
      "1548:    break;",
      "1549:   case ERROR_URI_T:",
      "1550:    LM_ERR(\"unexpected error (BUG?)\\n\");",
      "",
      "[Removed Lines]",
      "1546:    uri->host.s=\"\";",
      "1547:    uri->host.len=0;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f3dacc35a733b45af280da7be6ca2f84a1606901",
      "candidate_info": {
        "commit_hash": "f3dacc35a733b45af280da7be6ca2f84a1606901",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/f3dacc35a733b45af280da7be6ca2f84a1606901",
        "files": [
          "modules/ldap/ldap_api_fn.c",
          "modules/ldap/ldap_connect.c",
          "modules/ldap/ldap_connect.h",
          "modules/ldap/ldap_mod.c"
        ],
        "message": "Merge pull request #2779 from ppisar/openldap-2.6.1\n\nRename an ldap_connect() to opensips_ldap_connect()\n\n(cherry picked from commit 457111cebc2010225dffa668edd8155fdca6a62a)",
        "before_after_code_files": [
          "modules/ldap/ldap_api_fn.c||modules/ldap/ldap_api_fn.c",
          "modules/ldap/ldap_connect.c||modules/ldap/ldap_connect.c",
          "modules/ldap/ldap_connect.h||modules/ldap/ldap_connect.h",
          "modules/ldap/ldap_mod.c||modules/ldap/ldap_mod.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/ldap/ldap_api_fn.c||modules/ldap/ldap_api_fn.c": [
          "File: modules/ldap/ldap_api_fn.c -> modules/ldap/ldap_api_fn.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "118:   return NULL;",
          "119:  }",
          "122:    LM_ERR(\"failed to create new ldap connection!\\n\");",
          "123:    return NULL;",
          "124:  }",
          "",
          "[Removed Lines]",
          "121:  if (ldap_connect(lds->name, NULL) < 0) {",
          "",
          "[Added Lines]",
          "121:  if (opensips_ldap_connect(lds->name, NULL) < 0) {",
          "",
          "---------------"
        ],
        "modules/ldap/ldap_connect.c||modules/ldap/ldap_connect.c": [
          "File: modules/ldap/ldap_connect.c -> modules/ldap/ldap_connect.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "113: }",
          "117: {",
          "118:  int rc;",
          "119:  int ldap_proto_version;",
          "",
          "[Removed Lines]",
          "116: int ldap_connect(char* _ld_name, struct ld_conn* conn)",
          "",
          "[Added Lines]",
          "116: int opensips_ldap_connect(char* _ld_name, struct ld_conn* conn)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "411:   return -1;",
          "412:  }",
          "415:  {",
          "416:   LM_ERR(\"[%s]: reconnect failed\\n\",",
          "417:     _ld_name);",
          "",
          "[Removed Lines]",
          "414:  if ((rc = ldap_connect(_ld_name, conn)) != 0)",
          "",
          "[Added Lines]",
          "414:  if ((rc = opensips_ldap_connect(_ld_name, conn)) != 0)",
          "",
          "---------------"
        ],
        "modules/ldap/ldap_connect.h||modules/ldap/ldap_connect.h": [
          "File: modules/ldap/ldap_connect.h -> modules/ldap/ldap_connect.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "44: struct ld_conn;",
          "47: extern int ldap_disconnect(char* _ld_name, struct ld_conn* conn);",
          "48: extern int ldap_reconnect(char* _ld_name, struct ld_conn* conn);",
          "49: extern int ldap_get_vendor_version(char** _version);",
          "",
          "[Removed Lines]",
          "46: extern int ldap_connect(char* _ld_name, struct ld_conn* conn);",
          "",
          "[Added Lines]",
          "46: extern int opensips_ldap_connect(char* _ld_name, struct ld_conn* conn);",
          "",
          "---------------"
        ],
        "modules/ldap/ldap_mod.c||modules/ldap/ldap_mod.c": [
          "File: modules/ldap/ldap_mod.c -> modules/ldap/ldap_mod.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "186:   }",
          "190:   {",
          "191:    LM_ERR(\"[%s]: failed to connect to LDAP host(s)\\n\", ld_name);",
          "192:    ldap_disconnect(ld_name, NULL);",
          "",
          "[Removed Lines]",
          "189:   if (ldap_connect(ld_name, &get_ld_session(ld_name)->conn_s) != 0)",
          "",
          "[Added Lines]",
          "189:   if (opensips_ldap_connect(ld_name, &get_ld_session(ld_name)->conn_s) != 0)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0cca86fe789d77ea3e2b58326d6f282eb3433544",
      "candidate_info": {
        "commit_hash": "0cca86fe789d77ea3e2b58326d6f282eb3433544",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/0cca86fe789d77ea3e2b58326d6f282eb3433544",
        "files": [
          "modules/presence_dialoginfo/notify_body.c"
        ],
        "message": "[presence_dialoginfo] Fix aggregating dialoginfo XML\n\nFix the looping when aggregating the dialog info XML documents with multiple dialog elements. The xmlUnlinkNode() function inside the loop is breaking the looping (the \"next\" member is reset).\nCredits for reporting and fixing go to Damien Sandras (@dsandras)",
        "before_after_code_files": [
          "modules/presence_dialoginfo/notify_body.c||modules/presence_dialoginfo/notify_body.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/presence_dialoginfo/notify_body.c||modules/presence_dialoginfo/notify_body.c": [
          "File: modules/presence_dialoginfo/notify_body.c -> modules/presence_dialoginfo/notify_body.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "109: str* agregate_xmls(str* pres_user, str* pres_domain, str** body_array, int n, int partial)",
          "110: {",
          "111:  int i, j= 0;",
          "113:  xmlDocPtr  doc = NULL;",
          "114:  xmlNodePtr root_node = NULL;",
          "115:  xmlNsPtr   namespace = NULL;",
          "117:  xmlNodePtr p_root= NULL;",
          "118:  xmlDocPtr* xml_array ;",
          "119:  xmlNodePtr node = NULL;",
          "120:  char *state;",
          "121:  int winner_priority = -1, priority ;",
          "122:  xmlNodePtr winner_dialog_node = NULL ;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "118:  xmlNodePtr next_node = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "211:     goto error;",
          "212:    }",
          "213:    if (p_root->children) {",
          "215:     if (node->type == XML_ELEMENT_NODE) {",
          "216:      LM_DBG(\"node type: Element, name: %s\\n\", node->name);",
          "",
          "[Removed Lines]",
          "214:    for (node = p_root->children; node; node = node->next) {",
          "",
          "[Added Lines]",
          "213:    for (node = p_root->children; node; node = next_node) {",
          "214:     next_node = node->next;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e0325625ca9e8dceb79225455527af62a2e8e298",
      "candidate_info": {
        "commit_hash": "e0325625ca9e8dceb79225455527af62a2e8e298",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/e0325625ca9e8dceb79225455527af62a2e8e298",
        "files": [
          "db/schema/dr_carriers.xml",
          "modules/auth/doc/auth_admin.xml",
          "modules/cachedb_local/doc/cachedb_local_admin.xml",
          "modules/cfgutils/doc/cfgutils_admin.xml",
          "modules/dispatcher/doc/dispatcher_admin.xml",
          "modules/drouting/doc/drouting_admin.xml",
          "modules/fraud_detection/doc/fraud_detection_admin.xml",
          "modules/mid_registrar/doc/mid_registrar_admin.xml",
          "modules/permissions/doc/permissions_admin.xml",
          "modules/prometheus/doc/prometheus_admin.xml",
          "modules/rtpengine/doc/rtpengine_admin.xml",
          "modules/rtpproxy/doc/rtpproxy_admin.xml",
          "modules/sipmsgops/doc/sipmsgops_admin.xml",
          "modules/stir_shaken/stir_shaken.c",
          "modules/usrloc/doc/usrloc_admin.xml"
        ],
        "message": "Fix various doc typos; Improve wording\n\n(cherry picked from commit dd7b3da0397fe5ccc9978ec9138a6d4395c3f941)\n(cherry picked from commit 7cdbc996ee61eae1ed9757c9bb401c67d96b48fd)",
        "before_after_code_files": [
          "modules/stir_shaken/stir_shaken.c||modules/stir_shaken/stir_shaken.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/stir_shaken/stir_shaken.c||modules/stir_shaken/stir_shaken.c": [
          "File: modules/stir_shaken/stir_shaken.c -> modules/stir_shaken/stir_shaken.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "205:  if (ca_list || ca_dir) {",
          "206:   if (X509_STORE_load_locations(store, ca_list, ca_dir) != 1) {",
          "208:    return -1;",
          "209:   }",
          "210:   if (X509_STORE_set_default_paths(store) != 1) {",
          "",
          "[Removed Lines]",
          "207:    LM_ERR(\"Failed to load trustefd CAs\\n\");",
          "",
          "[Added Lines]",
          "207:    LM_ERR(\"Failed to load trusted CAs\\n\");",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c6cc088ffe6a2ac0ae87f04f1cf69de3094e6a29",
      "candidate_info": {
        "commit_hash": "c6cc088ffe6a2ac0ae87f04f1cf69de3094e6a29",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/c6cc088ffe6a2ac0ae87f04f1cf69de3094e6a29",
        "files": [
          "modules/clusterer/clusterer.c"
        ],
        "message": "clusterer: fix parameters for E_CLUSTERER_REQ_RECEIVED event\n\nFixes #2899",
        "before_after_code_files": [
          "modules/clusterer/clusterer.c||modules/clusterer/clusterer.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/clusterer/clusterer.c||modules/clusterer/clusterer.c": [
          "File: modules/clusterer/clusterer.c -> modules/clusterer/clusterer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "905:  bin_pop_str(packet, &rcv_tag);",
          "906:  bin_pop_str(packet, &rcv_msg);",
          "909:   LM_ERR(\"Failed to raise event for a received generic message!\\n\");",
          "910:   return;",
          "911:  }",
          "",
          "[Removed Lines]",
          "908:  if (raise_gen_msg_ev(cluster_id, source_id, req_like, &rcv_tag, &rcv_msg)) {",
          "",
          "[Added Lines]",
          "908:  if (raise_gen_msg_ev(cluster_id, source_id, req_like, &rcv_msg, &rcv_tag)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
      "candidate_info": {
        "commit_hash": "a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/a93ce0afb59ccd1a3b002740a4ca6422a2c5a96d",
        "files": [
          "modules/media_exchange/media_utils.c"
        ],
        "message": "media_exchange: make sure we do not unreference NULL dlg\n\n(cherry picked from commit 581a4b8e5b9575fb63c631886b58b051797f2642)",
        "before_after_code_files": [
          "modules/media_exchange/media_utils.c||modules/media_exchange/media_utils.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/media_exchange/media_utils.c||modules/media_exchange/media_utils.c": [
          "File: modules/media_exchange/media_utils.c -> modules/media_exchange/media_utils.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1331:    break;",
          "1332:  }",
          "1335:  return;",
          "1336: }",
          "",
          "[Removed Lines]",
          "1334:  media_dlg.dlg_unref(dlg, 1);",
          "",
          "[Added Lines]",
          "1334:  if (dlg)",
          "1335:   media_dlg.dlg_unref(dlg, 1);",
          "",
          "---------------"
        ]
      }
    }
  ]
}