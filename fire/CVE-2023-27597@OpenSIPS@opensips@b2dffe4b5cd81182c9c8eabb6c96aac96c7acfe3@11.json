{
  "cve_id": "CVE-2023-27597",
  "cve_desc": "OpenSIPS is a Session Initiation Protocol (SIP) server implementation. Prior to versions 3.1.8 and 3.2.5, when a specially crafted SIP message is processed by the function `rewrite_ruri`, a crash occurs due to a segmentation fault. This issue causes the server to crash. It affects configurations containing functions that make use of the affected code, such as the function `setport`. This issue has been fixed in version 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
  "patch_info": {
    "commit_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "files": [
      "parser/parse_uri.c"
    ],
    "message": "[core] fix parse_uri() parsing\n\nIssue discovered during OpenSIPS Security Audit 2022,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-358f-935m-7p9c",
    "before_after_code_files": [
      "parser/parse_uri.c||parser/parse_uri.c"
    ]
  },
  "patch_diff": {
    "parser/parse_uri.c||parser/parse_uri.c": [
      "File: parser/parse_uri.c -> parser/parse_uri.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1532:   case TELS_URI_T:",
      "1534:    uri->user=uri->host;",
      "1536:    uri->host.len=0;",
      "1537:    break;",
      "1538:   case SIP_URI_T:",
      "",
      "[Removed Lines]",
      "1535:    uri->host.s=\"\";",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1543:   case URN_NENA_SERVICE_URI_T:",
      "1544:    uri->user.s=0;",
      "1545:    uri->user.len=0;",
      "1548:    break;",
      "1549:   case ERROR_URI_T:",
      "1550:    LM_ERR(\"unexpected error (BUG?)\\n\");",
      "",
      "[Removed Lines]",
      "1546:    uri->host.s=\"\";",
      "1547:    uri->host.len=0;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a3419dce890b9d1b821d95216a47810a263da772",
      "candidate_info": {
        "commit_hash": "a3419dce890b9d1b821d95216a47810a263da772",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/a3419dce890b9d1b821d95216a47810a263da772",
        "files": [
          "modules/dialog/dlg_replication.c"
        ],
        "message": "dialog: don't drop synced dialogs with no sharing tag\n\n(cherry picked from commit 3e98325e8546bcbfefa15644c4835c72da4c7aee)",
        "before_after_code_files": [
          "modules/dialog/dlg_replication.c||modules/dialog/dlg_replication.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/dialog/dlg_replication.c||modules/dialog/dlg_replication.c": [
          "File: modules/dialog/dlg_replication.c -> modules/dialog/dlg_replication.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1801:  if (!dlg->shtag.s || dlg->shtag.len == 0) {",
          "1802:   LM_DBG(\"Sharing tag not set\\n\");",
          "1804:  }",
          "1806:  if ((rc = clusterer_api.shtag_get_sync_status(&dlg->shtag,",
          "",
          "[Removed Lines]",
          "1803:   return SHTAG_SYNC_NOT_REQUIRED;",
          "",
          "[Added Lines]",
          "1803:   return SHTAG_SYNC_REQUIRED;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
      "candidate_info": {
        "commit_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "files": [
          "Makefile.defs"
        ],
        "message": "Explicitly add fPIC and DPIC for gcc\n\nThis addresses linking on Fedora 34 and later with gcc 11:\n\n```\ngcc -shared -Wl,-z,relro -Wl,--as-needed  -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld  -Wl,-O2 -Wl,-E   alarm_checks.o hashTable.o interprocess_buffer.o openserMIBNotifications.o openserObjects.o openserSIPCommonObjects.o openserSIPContactTable.o openserSIPMethodSupportedTable.o openserSIPPortTable.o openserSIPRegUserLookupTable.o openserSIPRegUserTable.o openserSIPServerObjects.o openserSIPStatusCodesTable.o snmpstats.o sub_agent.o utilities.o  -L/usr/lib64 -lnetsnmpmibs -lnetsnmpagent -lnetsnmp -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lsensors -ldl -lm -lrpm -lrpmio -Wl,--enable-new-dtags -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lssl -lssl -lcrypto  -o snmpstats.so\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: warning: relocation against `event_shm_threshold' in read-only section `.text'\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: relocation R_X86_64_PC32 against undefined symbol `ctime_buf' can not be used when making a shared object; recompile with -fPIC\n/usr/bin/ld: final link failed: bad value\ncollect2: error: ld returned 1 exit status\nmake[1]: Leaving directory '/builddir/build/BUILD/opensips-3.1.7/modules/snmpstats'\nmake[1]: *** [../../Makefile.rules:39: snmpstats.so] Error 1\nmake: *** [Makefile:197: modules] Error 2\n```\n\nCloses #2734.\n\nSigned-off-by: Peter Lemenkov <lemenkov@gmail.com>\n(cherry picked from commit 0896f9a46700005a304a65ddf7e09419a3963b82)",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1340: else",
          "1341:   #gcc and maybe others, => gnu ld",
          "1342:   LDFLAGS+=-Wl,-O2 -Wl,-E $(PROFILE)",
          "1344: endif",
          "1345: endif",
          "1346: ifeq    ($(CC_NAME), clang)",
          "",
          "[Removed Lines]",
          "1343:   MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1343:   MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1372: else",
          "1373:    #gnu or other ld type",
          "1374:    LDFLAGS+=-Wl,-E $(PROFILE)",
          "1376: endif",
          "1377: endif",
          "1378: ifeq ($(CC_NAME), icc)",
          "",
          "[Removed Lines]",
          "1375:    MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1375:    MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "159ffbbf5c10138b1e8bc06e2b72c30510c0bac3",
      "candidate_info": {
        "commit_hash": "159ffbbf5c10138b1e8bc06e2b72c30510c0bac3",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/159ffbbf5c10138b1e8bc06e2b72c30510c0bac3",
        "files": [
          "modules/b2b_entities/client.c",
          "modules/b2b_entities/dlg.c",
          "modules/b2b_entities/dlg.h"
        ],
        "message": "b2b_entities: use the proxy from b2b_client_new() for all requests\n\nFixes #2759\n\n(cherry picked from commit ceb1d6a074383bca96df0e7a592719dda52bd60b)",
        "before_after_code_files": [
          "modules/b2b_entities/client.c||modules/b2b_entities/client.c",
          "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c",
          "modules/b2b_entities/dlg.h||modules/b2b_entities/dlg.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/b2b_entities/client.c||modules/b2b_entities/client.c": [
          "File: modules/b2b_entities/client.c -> modules/b2b_entities/client.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "115:  size = sizeof(b2b_dlg_t) + ci->to_uri.len + ci->from_uri.len",
          "117:   from_tag.len + ci->local_contact.len + B2B_MAX_KEY_SIZE +",
          "118:   B2BL_MAX_KEY_LEN + mod_name->len;",
          "",
          "[Removed Lines]",
          "116:   + ci->from_dname.len + ci->to_dname.len +",
          "",
          "[Added Lines]",
          "116:   + ci->from_dname.len + ci->to_dname.len + ci->dst_uri.len +",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "133:   CONT_COPY(dlg, dlg->to_dname, ci->to_dname);",
          "134:  if(ci->from_dname.s)",
          "135:   CONT_COPY(dlg, dlg->from_dname, ci->from_dname);",
          "136:  CONT_COPY(dlg, dlg->tag[CALLER_LEG], from_tag);",
          "137:  CONT_COPY(dlg, dlg->contact[CALLER_LEG], ci->local_contact);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "136:  if(ci->dst_uri.s)",
          "137:   CONT_COPY(dlg, dlg->proxy, ci->dst_uri);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "290:  td->loc_dname = dlg->from_dname;",
          "291:  td->rem_dname = dlg->to_dname;",
          "293:  if(leg)",
          "294:  {",
          "295:   if(leg->route_set.s && leg->route_set.len)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "295:  if(dlg->proxy.len)",
          "296:   td->obp = dlg->proxy;",
          "",
          "---------------"
        ],
        "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c": [
          "File: modules/b2b_entities/dlg.c -> modules/b2b_entities/dlg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "389:  b2b_dlg_t* new_dlg;",
          "390:  int size;",
          "393:   dlg->tag[0].len + dlg->tag[1].len+ dlg->route_set[0].len+ dlg->route_set[1].len+",
          "394:   dlg->contact[0].len+ dlg->contact[1].len+ dlg->ruri.len+ B2BL_MAX_KEY_LEN+",
          "395:   dlg->from_dname.len + dlg->to_dname.len + dlg->mod_name.len;",
          "",
          "[Removed Lines]",
          "392:  size = sizeof(b2b_dlg_t) + dlg->callid.len+ dlg->from_uri.len+ dlg->to_uri.len+",
          "",
          "[Added Lines]",
          "392:  size = sizeof(b2b_dlg_t) + dlg->callid.len+ dlg->from_uri.len+ dlg->to_uri.len+dlg->proxy.len+",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "406:  if(dlg->ruri.s)",
          "407:   CONT_COPY(new_dlg, new_dlg->ruri, dlg->ruri);",
          "408:  CONT_COPY(new_dlg, new_dlg->callid, dlg->callid);",
          "409:  CONT_COPY(new_dlg, new_dlg->from_uri, dlg->from_uri);",
          "410:  CONT_COPY(new_dlg, new_dlg->to_uri, dlg->to_uri);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "408:  if(dlg->proxy.s)",
          "409:   CONT_COPY(new_dlg, new_dlg->proxy, dlg->proxy);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1386:   dlg.to_dname = init_dlg->to_dname;",
          "1387:   dlg.from_uri = init_dlg->from_uri;",
          "1388:   dlg.from_dname = init_dlg->from_dname;",
          "1389:  }",
          "1390:  else",
          "1391:  {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1391:   dlg.proxy = init_dlg->proxy;",
          "",
          "---------------"
        ],
        "modules/b2b_entities/dlg.h||modules/b2b_entities/dlg.h": [
          "File: modules/b2b_entities/dlg.h -> modules/b2b_entities/dlg.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "85:  unsigned int         id;",
          "86:  b2b_state_t          state;",
          "87:  str                  ruri;",
          "88:  str                  callid;",
          "89:  str                  from_uri;",
          "90:  str                  from_dname;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "88:  str                  proxy;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "731c8ddcaf65f5b8468e692d6ec7709be2f33f41",
      "candidate_info": {
        "commit_hash": "731c8ddcaf65f5b8468e692d6ec7709be2f33f41",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/731c8ddcaf65f5b8468e692d6ec7709be2f33f41",
        "files": [
          "modules/clusterer/clusterer.c",
          "modules/clusterer/topology.c"
        ],
        "message": "clusterer: fix possible deadlocks when discovering a new node\n\nUse only standard RW locking operations for the global list lock instead of\nthe \"switchable\" mechanism (aquiring the lock for writing when necessary).\n\n(cherry picked from commit e0e9e2f943ca5bd35f653f6e55a89000e8b262e6)",
        "before_after_code_files": [
          "modules/clusterer/clusterer.c||modules/clusterer/clusterer.c",
          "modules/clusterer/topology.c||modules/clusterer/topology.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/clusterer/clusterer.c||modules/clusterer/clusterer.c": [
          "File: modules/clusterer/clusterer.c -> modules/clusterer/clusterer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "931: static void handle_remove_node(bin_packet_t *packet, cluster_info_t *cl)",
          "932: {",
          "933:  int target_node;",
          "935:  node_info_t *node;",
          "936:  int ev_actions_cl = 1;",
          "",
          "[Removed Lines]",
          "934:  int lock_old_flag;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "968:   return;",
          "969:  }",
          "972:  remove_node(cl, node);",
          "974: }",
          "976: void bin_rcv_cl_extra_packets(bin_packet_t *packet, int packet_type,",
          "",
          "[Removed Lines]",
          "971:  lock_switch_write(cl_list_lock, lock_old_flag);",
          "973:  lock_switch_read(cl_list_lock, lock_old_flag);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "997:  }",
          "999:  if (!db_mode && packet_type == CLUSTERER_REMOVE_NODE)",
          "1001:  else",
          "1002:   lock_start_read(cl_list_lock);",
          "",
          "[Removed Lines]",
          "1000:   lock_start_sw_read(cl_list_lock);",
          "",
          "[Added Lines]",
          "997:   lock_start_write(cl_list_lock);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1093: exit:",
          "1094:  if (!db_mode && packet_type == CLUSTERER_REMOVE_NODE)",
          "1096:  else",
          "1097:   lock_stop_read(cl_list_lock);",
          "1098: }",
          "",
          "[Removed Lines]",
          "1095:   lock_stop_sw_read(cl_list_lock);",
          "",
          "[Added Lines]",
          "1092:   lock_stop_write(cl_list_lock);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1125:  if (!db_mode && (packet_type == CLUSTERER_NODE_DESCRIPTION ||",
          "1126:   packet_type == CLUSTERER_FULL_TOP_UPDATE))",
          "1128:  else",
          "1129:   lock_start_read(cl_list_lock);",
          "",
          "[Removed Lines]",
          "1127:   lock_start_sw_read(cl_list_lock);",
          "",
          "[Added Lines]",
          "1124:   lock_start_write(cl_list_lock);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1172: exit:",
          "1173:  if (!db_mode && (packet_type == CLUSTERER_NODE_DESCRIPTION ||",
          "1174:   packet_type == CLUSTERER_FULL_TOP_UPDATE))",
          "1176:  else",
          "1177:   lock_stop_read(cl_list_lock);",
          "1178: }",
          "",
          "[Removed Lines]",
          "1175:   lock_stop_sw_read(cl_list_lock);",
          "",
          "[Added Lines]",
          "1172:   lock_stop_write(cl_list_lock);",
          "",
          "---------------"
        ],
        "modules/clusterer/topology.c||modules/clusterer/topology.c": [
          "File: modules/clusterer/topology.c -> modules/clusterer/topology.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "682:         int src_node_id, str *str_vals, int *int_vals)",
          "683: {",
          "684:  node_info_t *new_node = NULL;",
          "687:  str_vals[STR_VALS_FLAGS_COL].s = 0;",
          "688:  str_vals[STR_VALS_DESCRIPTION_COL].s = 0;",
          "",
          "[Removed Lines]",
          "685:  int lock_old_flag;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "691:  int_vals[INT_VALS_NODE_ID_COL] = src_node_id;",
          "696:  if (add_node_info(&new_node, &cl, int_vals, str_vals) != 0) {",
          "697:   LM_ERR(\"Unable to add node info to backing list\\n\");",
          "699:   return NULL;",
          "700:  }",
          "704:  return new_node;",
          "705: }",
          "",
          "[Removed Lines]",
          "694:  lock_switch_write(cl_list_lock, lock_old_flag);",
          "698:   lock_switch_read(cl_list_lock, lock_old_flag);",
          "702:  lock_switch_read(cl_list_lock, lock_old_flag);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81cb0903aedd2271e9a93789e83e1d96e28352f1",
      "candidate_info": {
        "commit_hash": "81cb0903aedd2271e9a93789e83e1d96e28352f1",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/81cb0903aedd2271e9a93789e83e1d96e28352f1",
        "files": [
          "modules/b2b_entities/dlg.c"
        ],
        "message": "b2b_entities: properly handle unexpected ACKs\n\nFixes an issue where a 487 reply is not relayed after an unexpected ACK is\nreceived following a CANCEL.\n\nThanks to David Escartin from Sonoc for reporting.",
        "before_after_code_files": [
          "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/b2b_entities/dlg.c||modules/b2b_entities/dlg.c": [
          "File: modules/b2b_entities/dlg.c -> modules/b2b_entities/dlg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "487:    dlg->state= B2B_TERMINATED;",
          "488:    break;",
          "489:   case METHOD_ACK:",
          "491:     dlg->state= B2B_ESTABLISHED;",
          "492:    break;",
          "493:   default:",
          "",
          "[Removed Lines]",
          "490:    if (dlg->state != B2B_MODIFIED || !dlg->uac_tran)",
          "",
          "[Added Lines]",
          "490:    if (dlg->state == B2B_CONFIRMED)",
          "",
          "---------------"
        ]
      }
    }
  ]
}