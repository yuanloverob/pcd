{
  "cve_id": "CVE-2023-25663",
  "cve_desc": "TensorFlow is an open source platform for machine learning. Prior to versions 2.12.0 and 2.11.1, when `ctx->step_containter()` is a null ptr, the Lookup function will be executed with a null pointer. A fix is included in TensorFlow 2.12.0 and 2.11.1.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "239139d2ae6a81ae9ba499ad78b56d9b2931538a",
  "patch_info": {
    "commit_hash": "239139d2ae6a81ae9ba499ad78b56d9b2931538a",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/239139d2ae6a81ae9ba499ad78b56d9b2931538a",
    "files": [
      "tensorflow/core/kernels/tensor_array_ops.cc",
      "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
    ],
    "message": "Fixing null pointer read in TensorArrayConcat when the step container is missing.\n\nPiperOrigin-RevId: 504332194",
    "before_after_code_files": [
      "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc",
      "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc": [
      "File: tensorflow/core/kernels/tensor_array_ops.cc -> tensorflow/core/kernels/tensor_array_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "80:     TF_RETURN_IF_ERROR(GetHandle(ctx, &container, &ta_handle));",
      "81:     ResourceMgr* rm = ctx->resource_manager();",
      "82:     if (rm == nullptr) return errors::Internal(\"No resource manager.\");",
      "85:     return OkStatus();",
      "86:   } else {",
      "87:     return LookupResource(ctx, HandleFromInput(ctx, 0), tensor_array);",
      "",
      "[Removed Lines]",
      "83:     TF_RETURN_IF_ERROR(",
      "84:         ctx->step_container()->Lookup(rm, container + ta_handle, tensor_array));",
      "",
      "[Added Lines]",
      "83:     ScopedStepContainer* sc = ctx->step_container();",
      "84:     if (sc == nullptr) return errors::Internal(\"No step container.\");",
      "85:     TF_RETURN_IF_ERROR(sc->Lookup(rm, container + ta_handle, tensor_array));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py": [
      "File: tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py -> tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1846:     ta = ta.write(0, [0])",
      "1847:     self.assertEqual([42, 1], ta.stack().shape.as_list())",
      "1850: class TensorArrayBenchmark(test.Benchmark):",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1849:   def testTensorArrayConcatFailsWhenMissingStepContainer(self):",
      "1850:     @def_function.function",
      "1851:     def func():",
      "1852:       y = data_flow_ops.TensorArrayConcatV2(",
      "1853:           handle=[\"a\", \"b\"],",
      "1854:           flow_in=0.1,",
      "1855:           dtype=dtypes.int32,",
      "1856:           element_shape_except0=1,",
      "1857:       )",
      "1858:       return y",
      "1860:     with self.assertRaisesRegex(",
      "1861:         errors.NotFoundError, \"Container .* does not exist\"",
      "1862:     ):",
      "1863:       self.evaluate(func())",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b33ee6dfbee399c976994604bca6528a55c87b2f",
      "candidate_info": {
        "commit_hash": "b33ee6dfbee399c976994604bca6528a55c87b2f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b33ee6dfbee399c976994604bca6528a55c87b2f",
        "files": [
          "tensorflow/core/kernels/tensor_array_ops.cc",
          "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
        ],
        "message": "Fixing null pointer read in TensorArrayConcat when the step container is missing.\n\nPiperOrigin-RevId: 504332194",
        "before_after_code_files": [
          "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc",
          "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc",
            "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc",
            "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/tensor_array_ops.cc||tensorflow/core/kernels/tensor_array_ops.cc": [
          "File: tensorflow/core/kernels/tensor_array_ops.cc -> tensorflow/core/kernels/tensor_array_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:     TF_RETURN_IF_ERROR(GetHandle(ctx, &container, &ta_handle));",
          "81:     ResourceMgr* rm = ctx->resource_manager();",
          "82:     if (rm == nullptr) return errors::Internal(\"No resource manager.\");",
          "85:     return OkStatus();",
          "86:   } else {",
          "87:     return LookupResource(ctx, HandleFromInput(ctx, 0), tensor_array);",
          "",
          "[Removed Lines]",
          "83:     TF_RETURN_IF_ERROR(",
          "84:         ctx->step_container()->Lookup(rm, container + ta_handle, tensor_array));",
          "",
          "[Added Lines]",
          "83:     ScopedStepContainer* sc = ctx->step_container();",
          "84:     if (sc == nullptr) return errors::Internal(\"No step container.\");",
          "85:     TF_RETURN_IF_ERROR(sc->Lookup(rm, container + ta_handle, tensor_array));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py||tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py": [
          "File: tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py -> tensorflow/python/kernel_tests/data_structures/tensor_array_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1833:     ta = ta.write(0, [0])",
          "1834:     self.assertEqual([42, 1], ta.stack().shape.as_list())",
          "1837: class TensorArrayBenchmark(test.Benchmark):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1836:   def testTensorArrayConcatFailsWhenMissingStepContainer(self):",
          "1837:     @def_function.function",
          "1838:     def func():",
          "1839:       y = data_flow_ops.TensorArrayConcatV2(",
          "1840:           handle=[\"a\", \"b\"],",
          "1841:           flow_in=0.1,",
          "1842:           dtype=dtypes.int32,",
          "1843:           element_shape_except0=1,",
          "1844:       )",
          "1845:       return y",
          "1847:     with self.assertRaisesRegex(",
          "1848:         errors.NotFoundError, \"Container .* does not exist\"",
          "1849:     ):",
          "1850:       self.evaluate(func())",
          "",
          "---------------"
        ]
      }
    }
  ]
}