{
  "cve_id": "CVE-2022-41911",
  "cve_desc": "TensorFlow is an open source platform for machine learning. When printing a tensor, we get it's data as a `const char*` array (since that's the underlying storage) and then we typecast it to the element type. However, conversions from `char` to `bool` are undefined if the `char` is not `0` or `1`, so sanitizers/fuzzers will crash. The issue has been patched in GitHub commit `1be74370327`. The fix will be included in TensorFlow 2.11.0. We will also cherrypick this commit on TensorFlow 2.10.1, TensorFlow 2.9.3, and TensorFlow 2.8.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "1be743703279782a357adbf9b77dcb994fe8b508",
  "patch_info": {
    "commit_hash": "1be743703279782a357adbf9b77dcb994fe8b508",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/1be743703279782a357adbf9b77dcb994fe8b508",
    "files": [
      "tensorflow/core/framework/tensor.cc"
    ],
    "message": "Resolve a sanitizer issue with invalid char -> bool conversion.\n\nWhen printing a tensor, we get it's data as a `const char*` array (since that's the underlying storage) and then we typecast it to the element type. However, conversions from `char` to `bool` are undefined if the `char` is not `0` or `1`, so sanitizers/fuzzers will crash.\n\nTo fix, we're creating a mutable `char` array to convert the chars to 0/1, according to bool rules.\n\nDiscovered via internal fuzzing.\n\nPiperOrigin-RevId: 482297563",
    "before_after_code_files": [
      "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc": [
      "File: tensorflow/core/framework/tensor.cc -> tensorflow/core/framework/tensor.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: #include \"tensorflow/core/framework/tensor.h\"",
      "32: #include <utility>",
      "34: #include \"absl/strings/escaping.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "32: #include <memory>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1183: }",
      "1185: template <typename T>",
      "1189:   string ret;",
      "1192:   const gtl::InlinedVector<int64_t, 4> shape = tensor_shape.dim_sizes();",
      "1193:   if (shape.empty()) {",
      "1194:     for (int64_t i = 0; i < limit; ++i) {",
      "",
      "[Removed Lines]",
      "1186: string SummarizeArray(int64_t limit, int64_t num_elts,",
      "1187:                       const TensorShape& tensor_shape, const char* data,",
      "1188:                       const bool print_v2) {",
      "1190:   const T* array = reinterpret_cast<const T*>(data);",
      "",
      "[Added Lines]",
      "1187: string SummarizeArrayInternal(int64_t limit, int64_t num_elts,",
      "1188:                               const TensorShape& tensor_shape, const T* array,",
      "1189:                               const bool print_v2) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1212:   return ret;",
      "1213: }",
      "1214: }  // namespace",
      "1216: string Tensor::SummarizeValue(int64_t max_entries, bool print_v2) const {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1214: template <typename T>",
      "1215: string SummarizeArray(int64_t limit, int64_t num_elts,",
      "1216:                       const TensorShape& tensor_shape, const char* data,",
      "1217:                       const bool print_v2) {",
      "1218:   const T* array = reinterpret_cast<const T*>(data);",
      "1219:   return SummarizeArrayInternal<T>(limit, num_elts, tensor_shape, array,",
      "1220:                                    print_v2);",
      "1221: }",
      "1223: template <>",
      "1224: string SummarizeArray<bool>(int64_t limit, int64_t num_elts,",
      "1225:                             const TensorShape& tensor_shape, const char* data,",
      "1226:                             const bool print_v2) {",
      "1229:   auto mutable_data = std::unique_ptr<char[]>(new char[num_elts]);",
      "1230:   for (int64_t i = 0; i < num_elts; ++i)",
      "1231:     mutable_data.get()[i] = data[i] ? 1 : 0;",
      "1232:   bool* array = reinterpret_cast<bool*>(mutable_data.get());",
      "1233:   return SummarizeArrayInternal<bool>(limit, num_elts, tensor_shape, array,",
      "1234:                                       print_v2);",
      "1235: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "408e4be1a25cb9d45499647e01fdb93be9d09a1a",
      "candidate_info": {
        "commit_hash": "408e4be1a25cb9d45499647e01fdb93be9d09a1a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/408e4be1a25cb9d45499647e01fdb93be9d09a1a",
        "files": [
          "tensorflow/core/framework/tensor.cc"
        ],
        "message": "Resolve a sanitizer issue with invalid char -> bool conversion.\n\nWhen printing a tensor, we get it's data as a `const char*` array (since that's the underlying storage) and then we typecast it to the element type. However, conversions from `char` to `bool` are undefined if the `char` is not `0` or `1`, so sanitizers/fuzzers will crash.\n\nTo fix, we're creating a mutable `char` array to convert the chars to 0/1, according to bool rules.\n\nDiscovered via internal fuzzing.\n\nPiperOrigin-RevId: 482297563",
        "before_after_code_files": [
          "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc"
          ],
          "candidate": [
            "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/framework/tensor.cc||tensorflow/core/framework/tensor.cc": [
          "File: tensorflow/core/framework/tensor.cc -> tensorflow/core/framework/tensor.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: #include \"tensorflow/core/framework/tensor.h\"",
          "32: #include <utility>",
          "34: #include \"absl/strings/escaping.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "32: #include <memory>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1183: }",
          "1185: template <typename T>",
          "1189:   string ret;",
          "1192:   const gtl::InlinedVector<int64_t, 4> shape = tensor_shape.dim_sizes();",
          "1193:   if (shape.empty()) {",
          "1194:     for (int64_t i = 0; i < limit; ++i) {",
          "",
          "[Removed Lines]",
          "1186: string SummarizeArray(int64_t limit, int64_t num_elts,",
          "1187:                       const TensorShape& tensor_shape, const char* data,",
          "1188:                       const bool print_v2) {",
          "1190:   const T* array = reinterpret_cast<const T*>(data);",
          "",
          "[Added Lines]",
          "1187: string SummarizeArrayInternal(int64_t limit, int64_t num_elts,",
          "1188:                               const TensorShape& tensor_shape, const T* array,",
          "1189:                               const bool print_v2) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1212:   return ret;",
          "1213: }",
          "1214: }  // namespace",
          "1216: string Tensor::SummarizeValue(int64_t max_entries, bool print_v2) const {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1214: template <typename T>",
          "1215: string SummarizeArray(int64_t limit, int64_t num_elts,",
          "1216:                       const TensorShape& tensor_shape, const char* data,",
          "1217:                       const bool print_v2) {",
          "1218:   const T* array = reinterpret_cast<const T*>(data);",
          "1219:   return SummarizeArrayInternal<T>(limit, num_elts, tensor_shape, array,",
          "1220:                                    print_v2);",
          "1221: }",
          "1223: template <>",
          "1224: string SummarizeArray<bool>(int64_t limit, int64_t num_elts,",
          "1225:                             const TensorShape& tensor_shape, const char* data,",
          "1226:                             const bool print_v2) {",
          "1229:   auto mutable_data = std::unique_ptr<char[]>(new char[num_elts]);",
          "1230:   for (int64_t i = 0; i < num_elts; ++i)",
          "1231:     mutable_data.get()[i] = data[i] ? 1 : 0;",
          "1232:   bool* array = reinterpret_cast<bool*>(mutable_data.get());",
          "1233:   return SummarizeArrayInternal<bool>(limit, num_elts, tensor_shape, array,",
          "1234:                                       print_v2);",
          "1235: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}