{
  "cve_id": "CVE-2024-28183",
  "cve_desc": "ESP-IDF is the development framework for Espressif SoCs supported on Windows, Linux and macOS. A Time-of-Check to Time-of-Use (TOCTOU) vulnerability was discovered in the implementation of the ESP-IDF bootloader which could allow an attacker with physical access to flash of the device to bypass anti-rollback protection. Anti-rollback prevents rollback to application with security version lower than one programmed in eFuse of chip. This attack can allow to boot past (passive) application partition having lower security version of the same device even in the presence of the flash encryption scheme. The attack requires carefully modifying the flash contents after the anti-rollback checks have been performed by the bootloader (before loading the application). The vulnerability is fixed in 4.4.7 and 5.2.1.",
  "repo": "espressif/esp-idf",
  "patch_hash": "4c95aa445d4e84f01f86b6f3a552aa299276abf3",
  "patch_info": {
    "commit_hash": "4c95aa445d4e84f01f86b6f3a552aa299276abf3",
    "repo": "espressif/esp-idf",
    "commit_url": "https://github.com/espressif/esp-idf/commit/4c95aa445d4e84f01f86b6f3a552aa299276abf3",
    "files": [
      "components/bootloader_support/include/esp_image_format.h",
      "components/bootloader_support/src/esp_image_format.c",
      "components/esp_app_format/include/esp_app_desc.h",
      "components/esp_system/startup.c",
      "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
    ],
    "message": "fix(ota): additional checks for secure version in anti-rollback case\n\nSome additional checks related to secure version of the application in\nanti-rollback case have been added to avoid any attempts to boot lower\nsecurity version but valid application (e.g., passive partition image).\n\n- Read secure_version under sha256 protection\n\n- First check has been added in the bootloader to ensure correct secure\n  version after application verification and loading stage. This check\n  happens before setting up the flash cache mapping and handling over\n  the final control to application. This check ensures that application\n  was not swapped (e.g., to lower security version but valid image) just\n  before the load stage in bootloader.\n\n- Second check has been added in the application startup code to ensure\n  that currently booting app has higher security version than the one\n  programmed in the eFuse for anti-rollback scenario. This will ensure\n  that only the legit application boots-up on the device for\n  anti-rollback case.",
    "before_after_code_files": [
      "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
      "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
      "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
      "components/esp_system/startup.c||components/esp_system/startup.c",
      "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
    ]
  },
  "patch_diff": {
    "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h": [
      "File: components/bootloader_support/include/esp_image_format.h -> components/bootloader_support/include/esp_image_format.h"
    ],
    "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c": [
      "File: components/bootloader_support/src/esp_image_format.c -> components/bootloader_support/src/esp_image_format.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: #include \"bootloader_util.h\"",
      "20: #include \"bootloader_common.h\"",
      "21: #include \"esp_rom_sys.h\"",
      "22: #include \"bootloader_memory_utils.h\"",
      "23: #include \"soc/soc_caps.h\"",
      "24: #include \"hal/cache_ll.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: #include \"esp_efuse.h\"",
      "23: #include \"esp_app_desc.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "90: static esp_err_t process_segments(esp_image_metadata_t *data, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
      "98: static esp_err_t verify_image_header(uint32_t src_addr, const esp_image_header_t *image, bool silent);",
      "",
      "[Removed Lines]",
      "92: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
      "95: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
      "",
      "[Added Lines]",
      "94: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
      "97: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "240:         cache_ll_writeback_all(CACHE_LL_LEVEL_INT_MEM, CACHE_TYPE_DATA, CACHE_LL_ID_ALL);",
      "241: #endif",
      "242:     }",
      "243: #endif // BOOTLOADER_BUILD",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "246: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "248:     bool sec_ver = false;",
      "249:     if (do_load) {",
      "250:         sec_ver = esp_efuse_check_secure_version(data->secure_version);",
      "251:         if (!sec_ver) {",
      "252:             err = ESP_FAIL;",
      "253:             goto err;",
      "254:         }",
      "255:     }",
      "257:     ESP_FAULT_ASSERT(!do_load || sec_ver == true);",
      "258: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "522:     for (int i = 0; i < data->image.segment_count; i++) {",
      "523:         esp_image_segment_header_t *header = &data->segments[i];",
      "524:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%\"PRIx32, i, next_addr);",
      "526:         next_addr += sizeof(esp_image_segment_header_t);",
      "527:         data->segment_data[i] = next_addr;",
      "528:         next_addr += header->data_len;",
      "",
      "[Removed Lines]",
      "525:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum));",
      "",
      "[Added Lines]",
      "542:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum, data));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "543:     return err;",
      "544: }",
      "547: {",
      "548:     esp_err_t err;",
      "",
      "[Removed Lines]",
      "546: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
      "",
      "[Added Lines]",
      "563: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "601:         uint32_t offset_page = ((data_addr & MMAP_ALIGNED_MASK) != 0) ? 1 : 0;",
      "603:         data_len = MIN(data_len_remain, ((free_page_count - offset_page) * SPI_FLASH_MMU_PAGE_SIZE));",
      "605:         data_addr += data_len;",
      "606:         data_len_remain -= data_len;",
      "607:     }",
      "",
      "[Removed Lines]",
      "604:         CHECK_ERR(process_segment_data(load_addr, data_addr, data_len, do_load, sha_handle, checksum));",
      "",
      "[Added Lines]",
      "621:         CHECK_ERR(process_segment_data(index, load_addr, data_addr, data_len, do_load, sha_handle, checksum, metadata));",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "616:     return err;",
      "617: }",
      "620: {",
      "",
      "[Removed Lines]",
      "619: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
      "",
      "[Added Lines]",
      "636: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "641: __attribute__((optimize(\"O0\")))",
      "642: static size_t process_esp_app_desc_data(const uint32_t *src, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
      "643: {",
      "655:     uint32_t data_buffer[2];",
      "656:     memcpy(data_buffer, src, sizeof(data_buffer));",
      "657:     assert(data_buffer[0] == ESP_APP_DESC_MAGIC_WORD);",
      "658:     metadata->secure_version = data_buffer[1];",
      "659:     if (checksum != NULL) {",
      "661:     }",
      "662:     if (sha_handle != NULL) {",
      "663:         bootloader_sha256_data(sha_handle, data_buffer, sizeof(data_buffer));",
      "664:     }",
      "665:     ESP_FAULT_ASSERT(memcmp(data_buffer, src, sizeof(data_buffer)) == 0);",
      "666:     ESP_FAULT_ASSERT(memcmp(&metadata->secure_version, &src[1], sizeof(uint32_t)) == 0);",
      "667:     return sizeof(data_buffer);",
      "668: }",
      "669: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "671: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "654:     const uint32_t *src = data;",
      "656:     for (size_t i = 0; i < data_len; i += 4) {",
      "657:         int w_i = i / 4; // Word index",
      "658:         uint32_t w = src[w_i];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "708: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "709:     if (segment == 0) {",
      "711:         size_t len = process_esp_app_desc_data(src, sha_handle, checksum, metadata);",
      "712:         data_len -= len;",
      "713:         src += len / 4;",
      "715:     }",
      "716: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "",
      "---------------"
    ],
    "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h": [
      "File: components/esp_app_format/include/esp_app_desc.h -> components/esp_app_format/include/esp_app_desc.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "40: ESP_STATIC_ASSERT(sizeof(esp_app_desc_t) == 256, \"esp_app_desc_t should be 256 bytes\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "41: ESP_STATIC_ASSERT(offsetof(esp_app_desc_t, secure_version) == 4, \"secure_version field must be at 4 offset\");",
      "",
      "---------------"
    ],
    "components/esp_system/startup.c||components/esp_system/startup.c": [
      "File: components/esp_system/startup.c -> components/esp_system/startup.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "340: #endif",
      "341: #endif",
      "343: #ifdef CONFIG_SECURE_FLASH_ENC_ENABLED",
      "344:     esp_flash_encryption_init_checks();",
      "345: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "343: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
      "345:     assert(esp_efuse_check_secure_version(esp_app_get_description()->secure_version) == true && \"Incorrect secure version of app\");",
      "346: #endif",
      "",
      "---------------"
    ],
    "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback": [
      "File: tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback -> tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y",
      "4: CONFIG_PARTITION_TABLE_CUSTOM=y",
      "5: CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"partitions_example.csv\"",
      "",
      "[Removed Lines]",
      "6: CONFIG_PARTITION_TABLE_OFFSET=0x9000",
      "",
      "[Added Lines]",
      "6: CONFIG_PARTITION_TABLE_OFFSET=0xA000",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b2cdc0678965790f49afeb6e6b0737cd24433a05",
      "candidate_info": {
        "commit_hash": "b2cdc0678965790f49afeb6e6b0737cd24433a05",
        "repo": "espressif/esp-idf",
        "commit_url": "https://github.com/espressif/esp-idf/commit/b2cdc0678965790f49afeb6e6b0737cd24433a05",
        "files": [
          "components/bootloader_support/src/esp_image_format.c"
        ],
        "message": "fix(bootloader_support): check the secure version only for app image\n\nSecure version in the image header is only available for the application\nimage. However, for certain security workflows, bootloader verifies\nitself (own image) and hence the secure version check during that must be\navoided.\n\nRegression introduced in recent commit-id: 3305cb4d\n\nTested that both secure boot and flash-enc workflows work correctly\nwith the anti-rollback scenario.",
        "before_after_code_files": [
          "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c"
          ],
          "candidate": [
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c"
          ]
        }
      },
      "candidate_diff": {
        "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c": [
          "File: components/bootloader_support/src/esp_image_format.c -> components/bootloader_support/src/esp_image_format.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "701: #endif",
          "702:     }",
          "703:     uint32_t *dest = (uint32_t *)load_addr;",
          "706:     const uint32_t *src = data;",
          "708: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "711:         size_t len = process_esp_app_desc_data(src, sha_handle, checksum, metadata);",
          "712:         data_len -= len;",
          "",
          "[Removed Lines]",
          "704: #endif",
          "709:     if (segment == 0) {",
          "",
          "[Added Lines]",
          "704: #endif // BOOTLOADER_BUILD",
          "712:     if (segment == 0 && metadata->start_addr != ESP_BOOTLOADER_OFFSET) {",
          "713:         ESP_LOGD(TAG, \"additional anti-rollback check 0x%\"PRIx32, data_addr);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f2743707b854141c6fd960891548f0d3db15ccb2",
      "candidate_info": {
        "commit_hash": "f2743707b854141c6fd960891548f0d3db15ccb2",
        "repo": "espressif/esp-idf",
        "commit_url": "https://github.com/espressif/esp-idf/commit/f2743707b854141c6fd960891548f0d3db15ccb2",
        "files": [
          "components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c",
          "components/esp_app_format/include/esp_app_desc.h",
          "components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ],
        "message": "fix(ota): additional checks for secure version in anti-rollback case\n\nSome additional checks related to secure version of the application in\nanti-rollback case have been added to avoid any attempts to boot lower\nsecurity version but valid application (e.g., passive partition image).\n\n- Read secure_version under sha256 protection\n\n- First check has been added in the bootloader to ensure correct secure\n  version after application verification and loading stage. This check\n  happens before setting up the flash cache mapping and handling over\n  the final control to application. This check ensures that application\n  was not swapped (e.g., to lower security version but valid image) just\n  before the load stage in bootloader.\n\n- Second check has been added in the application startup code to ensure\n  that currently booting app has higher security version than the one\n  programmed in the eFuse for anti-rollback scenario. This will ensure\n  that only the legit application boots-up on the device for\n  anti-rollback case.",
        "before_after_code_files": [
          "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
          "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
          "components/esp_system/startup.c||components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ],
          "candidate": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ]
        }
      },
      "candidate_diff": {
        "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h": [
          "File: components/bootloader_support/include/esp_image_format.h -> components/bootloader_support/include/esp_image_format.h"
        ],
        "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c": [
          "File: components/bootloader_support/src/esp_image_format.c -> components/bootloader_support/src/esp_image_format.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: #include \"bootloader_util.h\"",
          "20: #include \"bootloader_common.h\"",
          "21: #include \"esp_rom_sys.h\"",
          "22: #include \"bootloader_memory_utils.h\"",
          "23: #include \"soc/soc_caps.h\"",
          "24: #if CONFIG_IDF_TARGET_ESP32",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: #include \"esp_efuse.h\"",
          "23: #include \"esp_app_desc.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: static esp_err_t process_segments(esp_image_metadata_t *data, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "90: static esp_err_t verify_image_header(uint32_t src_addr, const esp_image_header_t *image, bool silent);",
          "",
          "[Removed Lines]",
          "84: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "87: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "",
          "[Added Lines]",
          "86: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "89: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "229:             }",
          "230:         }",
          "231:     }",
          "232: #endif // BOOTLOADER_BUILD",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "235: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "237:     bool sec_ver = false;",
          "238:     if (do_load) {",
          "239:         sec_ver = esp_efuse_check_secure_version(data->secure_version);",
          "240:         if (!sec_ver) {",
          "241:             err = ESP_FAIL;",
          "242:             goto err;",
          "243:         }",
          "244:     }",
          "246:     ESP_FAULT_ASSERT(!do_load || sec_ver == true);",
          "247: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "504:     uint32_t next_addr = start_segments;",
          "505:     for (int i = 0; i < data->image.segment_count; i++) {",
          "506:         esp_image_segment_header_t *header = &data->segments[i];",
          "509:         next_addr += sizeof(esp_image_segment_header_t);",
          "510:         data->segment_data[i] = next_addr;",
          "511:         next_addr += header->data_len;",
          "",
          "[Removed Lines]",
          "507:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%x\", i, next_addr);",
          "508:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "524:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%\"PRIx32, i, next_addr);",
          "525:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum, data));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "526:     return err;",
          "527: }",
          "530: {",
          "531:     esp_err_t err;",
          "",
          "[Removed Lines]",
          "529: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "546: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "584:         uint32_t offset_page = ((data_addr & MMAP_ALIGNED_MASK) != 0) ? 1 : 0;",
          "586:         data_len = MIN(data_len_remain, ((free_page_count - offset_page) * SPI_FLASH_MMU_PAGE_SIZE));",
          "588:         data_addr += data_len;",
          "589:         data_len_remain -= data_len;",
          "590:     }",
          "",
          "[Removed Lines]",
          "587:         CHECK_ERR(process_segment_data(load_addr, data_addr, data_len, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "604:         CHECK_ERR(process_segment_data(index, load_addr, data_addr, data_len, do_load, sha_handle, checksum, metadata));",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "599:     return err;",
          "600: }",
          "603: {",
          "",
          "[Removed Lines]",
          "602: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "619: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "624: __attribute__((optimize(\"O0\")))",
          "625: static size_t process_esp_app_desc_data(const uint32_t *src, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "626: {",
          "638:     uint32_t data_buffer[2];",
          "639:     memcpy(data_buffer, src, sizeof(data_buffer));",
          "640:     assert(data_buffer[0] == ESP_APP_DESC_MAGIC_WORD);",
          "641:     metadata->secure_version = data_buffer[1];",
          "642:     if (checksum != NULL) {",
          "644:     }",
          "645:     if (sha_handle != NULL) {",
          "646:         bootloader_sha256_data(sha_handle, data_buffer, sizeof(data_buffer));",
          "647:     }",
          "648:     ESP_FAULT_ASSERT(memcmp(data_buffer, src, sizeof(data_buffer)) == 0);",
          "649:     ESP_FAULT_ASSERT(memcmp(&metadata->secure_version, &src[1], sizeof(uint32_t)) == 0);",
          "650:     return sizeof(data_buffer);",
          "651: }",
          "652: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "654: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "637:     const uint32_t *src = data;",
          "639:     for (size_t i = 0; i < data_len; i += 4) {",
          "640:         int w_i = i / 4; // Word index",
          "641:         uint32_t w = src[w_i];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "691: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "692:     if (segment == 0) {",
          "694:         size_t len = process_esp_app_desc_data(src, sha_handle, checksum, metadata);",
          "695:         data_len -= len;",
          "696:         src += len / 4;",
          "698:     }",
          "699: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------"
        ],
        "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h": [
          "File: components/esp_app_format/include/esp_app_desc.h -> components/esp_app_format/include/esp_app_desc.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: ESP_STATIC_ASSERT(sizeof(esp_app_desc_t) == 256, \"esp_app_desc_t should be 256 bytes\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: ESP_STATIC_ASSERT(offsetof(esp_app_desc_t, secure_version) == 4, \"secure_version field must be at 4 offset\");",
          "",
          "---------------"
        ],
        "components/esp_system/startup.c||components/esp_system/startup.c": [
          "File: components/esp_system/startup.c -> components/esp_system/startup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "353: #endif",
          "354: #endif",
          "356: #ifdef CONFIG_SECURE_FLASH_ENC_ENABLED",
          "357:     esp_flash_encryption_init_checks();",
          "358: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "356: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "358:     assert(esp_efuse_check_secure_version(esp_app_get_description()->secure_version) == true && \"Incorrect secure version of app\");",
          "359: #endif",
          "",
          "---------------"
        ],
        "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback": [
          "File: tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback -> tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y",
          "4: CONFIG_PARTITION_TABLE_CUSTOM=y",
          "5: CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"partitions_example.csv\"",
          "",
          "[Removed Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0x9000",
          "",
          "[Added Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0xA000",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "83ec466b266a1fa92719f81c322561a1def0529d",
      "candidate_info": {
        "commit_hash": "83ec466b266a1fa92719f81c322561a1def0529d",
        "repo": "espressif/esp-idf",
        "commit_url": "https://github.com/espressif/esp-idf/commit/83ec466b266a1fa92719f81c322561a1def0529d",
        "files": [
          "components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c",
          "components/esp_app_format/include/esp_app_desc.h",
          "components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ],
        "message": "fix(ota): additional checks for secure version in anti-rollback case\n\nSome additional checks related to secure version of the application in\nanti-rollback case have been added to avoid any attempts to boot lower\nsecurity version but valid application (e.g., passive partition image).\n\n- Read secure_version under sha256 protection\n\n- First check has been added in the bootloader to ensure correct secure\n  version after application verification and loading stage. This check\n  happens before setting up the flash cache mapping and handling over\n  the final control to application. This check ensures that application\n  was not swapped (e.g., to lower security version but valid image) just\n  before the load stage in bootloader.\n\n- Second check has been added in the application startup code to ensure\n  that currently booting app has higher security version than the one\n  programmed in the eFuse for anti-rollback scenario. This will ensure\n  that only the legit application boots-up on the device for\n  anti-rollback case.",
        "before_after_code_files": [
          "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
          "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
          "components/esp_system/startup.c||components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ],
          "candidate": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ]
        }
      },
      "candidate_diff": {
        "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h": [
          "File: components/bootloader_support/include/esp_image_format.h -> components/bootloader_support/include/esp_image_format.h"
        ],
        "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c": [
          "File: components/bootloader_support/src/esp_image_format.c -> components/bootloader_support/src/esp_image_format.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: #include \"bootloader_util.h\"",
          "20: #include \"bootloader_common.h\"",
          "21: #include \"esp_rom_sys.h\"",
          "22: #include \"bootloader_memory_utils.h\"",
          "23: #include \"soc/soc_caps.h\"",
          "24: #if CONFIG_IDF_TARGET_ESP32",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: #include \"esp_efuse.h\"",
          "23: #include \"esp_app_desc.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "86: static esp_err_t process_segments(esp_image_metadata_t *data, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "94: static esp_err_t verify_image_header(uint32_t src_addr, const esp_image_header_t *image, bool silent);",
          "",
          "[Removed Lines]",
          "88: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "91: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "",
          "[Added Lines]",
          "90: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "93: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "233:             }",
          "234:         }",
          "235:     }",
          "236: #endif // BOOTLOADER_BUILD",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "239: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "241:     bool sec_ver = false;",
          "242:     if (do_load) {",
          "243:         sec_ver = esp_efuse_check_secure_version(data->secure_version);",
          "244:         if (!sec_ver) {",
          "245:             err = ESP_FAIL;",
          "246:             goto err;",
          "247:         }",
          "248:     }",
          "250:     ESP_FAULT_ASSERT(!do_load || sec_ver == true);",
          "251: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "509:     for (int i = 0; i < data->image.segment_count; i++) {",
          "510:         esp_image_segment_header_t *header = &data->segments[i];",
          "511:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%\"PRIx32, i, next_addr);",
          "513:         next_addr += sizeof(esp_image_segment_header_t);",
          "514:         data->segment_data[i] = next_addr;",
          "515:         next_addr += header->data_len;",
          "",
          "[Removed Lines]",
          "512:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "529:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum, data));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "530:     return err;",
          "531: }",
          "534: {",
          "535:     esp_err_t err;",
          "",
          "[Removed Lines]",
          "533: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "550: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "588:         uint32_t offset_page = ((data_addr & MMAP_ALIGNED_MASK) != 0) ? 1 : 0;",
          "590:         data_len = MIN(data_len_remain, ((free_page_count - offset_page) * SPI_FLASH_MMU_PAGE_SIZE));",
          "592:         data_addr += data_len;",
          "593:         data_len_remain -= data_len;",
          "594:     }",
          "",
          "[Removed Lines]",
          "591:         CHECK_ERR(process_segment_data(load_addr, data_addr, data_len, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "608:         CHECK_ERR(process_segment_data(index, load_addr, data_addr, data_len, do_load, sha_handle, checksum, metadata));",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "603:     return err;",
          "604: }",
          "607: {",
          "",
          "[Removed Lines]",
          "606: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "623: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "628: __attribute__((optimize(\"O0\")))",
          "629: static size_t process_esp_app_desc_data(const uint32_t *src, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "630: {",
          "642:     uint32_t data_buffer[2];",
          "643:     memcpy(data_buffer, src, sizeof(data_buffer));",
          "644:     assert(data_buffer[0] == ESP_APP_DESC_MAGIC_WORD);",
          "645:     metadata->secure_version = data_buffer[1];",
          "646:     if (checksum != NULL) {",
          "648:     }",
          "649:     if (sha_handle != NULL) {",
          "650:         bootloader_sha256_data(sha_handle, data_buffer, sizeof(data_buffer));",
          "651:     }",
          "652:     ESP_FAULT_ASSERT(memcmp(data_buffer, src, sizeof(data_buffer)) == 0);",
          "653:     ESP_FAULT_ASSERT(memcmp(&metadata->secure_version, &src[1], sizeof(uint32_t)) == 0);",
          "654:     return sizeof(data_buffer);",
          "655: }",
          "656: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "658: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "641:     const uint32_t *src = data;",
          "643:     for (size_t i = 0; i < data_len; i += 4) {",
          "644:         int w_i = i / 4; // Word index",
          "645:         uint32_t w = src[w_i];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "695: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "696:     if (segment == 0) {",
          "698:         size_t len = process_esp_app_desc_data(src, sha_handle, checksum, metadata);",
          "699:         data_len -= len;",
          "700:         src += len / 4;",
          "702:     }",
          "703: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------"
        ],
        "components/esp_app_format/include/esp_app_desc.h||components/esp_app_format/include/esp_app_desc.h": [
          "File: components/esp_app_format/include/esp_app_desc.h -> components/esp_app_format/include/esp_app_desc.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: ESP_STATIC_ASSERT(sizeof(esp_app_desc_t) == 256, \"esp_app_desc_t should be 256 bytes\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: ESP_STATIC_ASSERT(offsetof(esp_app_desc_t, secure_version) == 4, \"secure_version field must be at 4 offset\");",
          "",
          "---------------"
        ],
        "components/esp_system/startup.c||components/esp_system/startup.c": [
          "File: components/esp_system/startup.c -> components/esp_system/startup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "356: #endif",
          "357: #endif",
          "359: #ifdef CONFIG_SECURE_FLASH_ENC_ENABLED",
          "360:     esp_flash_encryption_init_checks();",
          "361: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "359: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "361:     assert(esp_efuse_check_secure_version(esp_app_get_description()->secure_version) == true && \"Incorrect secure version of app\");",
          "362: #endif",
          "",
          "---------------"
        ],
        "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback": [
          "File: tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback -> tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y",
          "4: CONFIG_PARTITION_TABLE_CUSTOM=y",
          "5: CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"partitions_example.csv\"",
          "",
          "[Removed Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0x9000",
          "",
          "[Added Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0xA000",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6d2153d703e2793c034cfa46cce0716d40543a6e",
      "candidate_info": {
        "commit_hash": "6d2153d703e2793c034cfa46cce0716d40543a6e",
        "repo": "espressif/esp-idf",
        "commit_url": "https://github.com/espressif/esp-idf/commit/6d2153d703e2793c034cfa46cce0716d40543a6e",
        "files": [
          "components/bootloader_support/include/esp_app_format.h",
          "components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c",
          "components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ],
        "message": "fix(ota): additional checks for secure version in anti-rollback case\n\nSome additional checks related to secure version of the application in\nanti-rollback case have been added to avoid any attempts to boot lower\nsecurity version but valid application (e.g., passive partition image).\n\n- Read secure_version under sha256 protection\n\n- First check has been added in the bootloader to ensure correct secure\n  version after application verification and loading stage. This check\n  happens before setting up the flash cache mapping and handling over\n  the final control to application. This check ensures that application\n  was not swapped (e.g., to lower security version but valid image) just\n  before the load stage in bootloader.\n\n- Second check has been added in the application startup code to ensure\n  that currently booting app has higher security version than the one\n  programmed in the eFuse for anti-rollback scenario. This will ensure\n  that only the legit application boots-up on the device for\n  anti-rollback case.",
        "before_after_code_files": [
          "components/bootloader_support/include/esp_app_format.h||components/bootloader_support/include/esp_app_format.h",
          "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
          "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
          "components/esp_system/startup.c||components/esp_system/startup.c",
          "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ],
          "candidate": [
            "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h",
            "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c",
            "components/esp_system/startup.c||components/esp_system/startup.c",
            "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback"
          ]
        }
      },
      "candidate_diff": {
        "components/bootloader_support/include/esp_app_format.h||components/bootloader_support/include/esp_app_format.h": [
          "File: components/bootloader_support/include/esp_app_format.h -> components/bootloader_support/include/esp_app_format.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "132: _Static_assert(sizeof(esp_app_desc_t) == 256, \"esp_app_desc_t should be 256 bytes\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "133: _Static_assert(offsetof(esp_app_desc_t, secure_version) == 4, \"secure_version field must be at 4 offset\");",
          "",
          "---------------"
        ],
        "components/bootloader_support/include/esp_image_format.h||components/bootloader_support/include/esp_image_format.h": [
          "File: components/bootloader_support/include/esp_image_format.h -> components/bootloader_support/include/esp_image_format.h"
        ],
        "components/bootloader_support/src/esp_image_format.c||components/bootloader_support/src/esp_image_format.c": [
          "File: components/bootloader_support/src/esp_image_format.c -> components/bootloader_support/src/esp_image_format.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: #include <bootloader_sha.h>",
          "18: #include \"bootloader_util.h\"",
          "19: #include \"bootloader_common.h\"",
          "20: #include \"esp_rom_sys.h\"",
          "21: #include \"soc/soc_memory_types.h\"",
          "22: #if CONFIG_IDF_TARGET_ESP32",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: #include \"esp_efuse.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77: static esp_err_t process_segments(esp_image_metadata_t *data, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "85: static esp_err_t verify_image_header(uint32_t src_addr, const esp_image_header_t *image, bool silent);",
          "",
          "[Removed Lines]",
          "79: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "82: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum);",
          "",
          "[Added Lines]",
          "80: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "83: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "222:             }",
          "223:         }",
          "224:     }",
          "225: #endif // BOOTLOADER_BUILD",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "227: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "229:     bool sec_ver = false;",
          "230:     if (do_load) {",
          "231:         sec_ver = esp_efuse_check_secure_version(data->secure_version);",
          "232:         if (!sec_ver) {",
          "233:             err = ESP_FAIL;",
          "234:             goto err;",
          "235:         }",
          "236:     }",
          "238:     ESP_FAULT_ASSERT(!do_load || sec_ver == true);",
          "239: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "488:     uint32_t next_addr = start_segments;",
          "489:     for (int i = 0; i < data->image.segment_count; i++) {",
          "490:         esp_image_segment_header_t *header = &data->segments[i];",
          "493:         next_addr += sizeof(esp_image_segment_header_t);",
          "494:         data->segment_data[i] = next_addr;",
          "495:         next_addr += header->data_len;",
          "",
          "[Removed Lines]",
          "491:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%x\", i, next_addr);",
          "492:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "507:         ESP_LOGV(TAG, \"loading segment header %d at offset 0x%\"PRIx32, i, next_addr);",
          "508:         CHECK_ERR(process_segment(i, next_addr, header, silent, do_load, sha_handle, checksum, data));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "510:     return err;",
          "511: }",
          "514: {",
          "515:     esp_err_t err;",
          "",
          "[Removed Lines]",
          "513: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "529: static esp_err_t process_segment(int index, uint32_t flash_addr, esp_image_segment_header_t *header, bool silent, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "568:         uint32_t offset_page = ((data_addr & MMAP_ALIGNED_MASK) != 0) ? 1 : 0;",
          "570:         data_len = MIN(data_len_remain, ((free_page_count - offset_page) * SPI_FLASH_MMU_PAGE_SIZE));",
          "572:         data_addr += data_len;",
          "573:         data_len_remain -= data_len;",
          "574:     }",
          "",
          "[Removed Lines]",
          "571:         CHECK_ERR(process_segment_data(load_addr, data_addr, data_len, do_load, sha_handle, checksum));",
          "",
          "[Added Lines]",
          "587:         CHECK_ERR(process_segment_data(index, load_addr, data_addr, data_len, do_load, sha_handle, checksum, metadata));",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "583:     return err;",
          "584: }",
          "587: {",
          "",
          "[Removed Lines]",
          "586: static esp_err_t process_segment_data(intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum)",
          "",
          "[Added Lines]",
          "602: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "607: __attribute__((optimize(\"O0\")))",
          "608: static size_t process_esp_app_desc_data(const uint32_t *src, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "609: {",
          "621:     uint32_t data_buffer[2];",
          "622:     memcpy(data_buffer, src, sizeof(data_buffer));",
          "623:     assert(data_buffer[0] == ESP_APP_DESC_MAGIC_WORD);",
          "624:     metadata->secure_version = data_buffer[1];",
          "625:     if (checksum != NULL) {",
          "627:     }",
          "628:     if (sha_handle != NULL) {",
          "629:         bootloader_sha256_data(sha_handle, data_buffer, sizeof(data_buffer));",
          "630:     }",
          "631:     ESP_FAULT_ASSERT(memcmp(data_buffer, src, sizeof(data_buffer)) == 0);",
          "632:     ESP_FAULT_ASSERT(memcmp(&metadata->secure_version, &src[1], sizeof(uint32_t)) == 0);",
          "633:     return sizeof(data_buffer);",
          "634: }",
          "635: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "637: static esp_err_t process_segment_data(int segment, intptr_t load_addr, uint32_t data_addr, uint32_t data_len, bool do_load, bootloader_sha256_handle_t sha_handle, uint32_t *checksum, esp_image_metadata_t *metadata)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "621:     const uint32_t *src = data;",
          "623:     for (size_t i = 0; i < data_len; i += 4) {",
          "624:         int w_i = i / 4; // Word index",
          "625:         uint32_t w = src[w_i];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "674: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "675:     if (segment == 0) {",
          "677:         size_t len = process_esp_app_desc_data(src, sha_handle, checksum, metadata);",
          "678:         data_len -= len;",
          "679:         src += len / 4;",
          "681:     }",
          "682: #endif // CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "",
          "---------------"
        ],
        "components/esp_system/startup.c||components/esp_system/startup.c": [
          "File: components/esp_system/startup.c -> components/esp_system/startup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "352:     esp_efuse_disable_basic_rom_console();",
          "353: #endif",
          "355: #ifdef CONFIG_SECURE_FLASH_ENC_ENABLED",
          "356:     esp_flash_encryption_init_checks();",
          "357: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "355: #if CONFIG_BOOTLOADER_APP_ANTI_ROLLBACK",
          "357:     assert(esp_efuse_check_secure_version(esp_ota_get_app_description()->secure_version) == true && \"Incorrect secure version of app\");",
          "358: #endif",
          "",
          "---------------"
        ],
        "tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback||tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback": [
          "File: tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback -> tools/test_apps/system/bootloader_sections/sdkconfig.ci.anti_rollback",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: CONFIG_ESPTOOLPY_FLASHSIZE_4MB=y",
          "4: CONFIG_PARTITION_TABLE_CUSTOM=y",
          "5: CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"partitions_example.csv\"",
          "",
          "[Removed Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0x9000",
          "",
          "[Added Lines]",
          "6: CONFIG_PARTITION_TABLE_OFFSET=0xA000",
          "",
          "---------------"
        ]
      }
    }
  ]
}