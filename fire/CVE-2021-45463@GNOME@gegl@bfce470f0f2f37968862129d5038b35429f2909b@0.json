{
  "cve_id": "CVE-2021-45463",
  "cve_desc": "load_cache in GEGL before 0.4.34 allows shell expansion when a pathname in a constructed command line is not escaped or filtered. This is caused by use of the system library function for execution of the ImageMagick convert fallback in magick-load. NOTE: GEGL releases before 0.4.34 are used in GIMP releases before 2.10.30; however, this does not imply that GIMP builds enable the vulnerable feature.",
  "repo": "GNOME/gegl",
  "patch_hash": "bfce470f0f2f37968862129d5038b35429f2909b",
  "patch_info": {
    "commit_hash": "bfce470f0f2f37968862129d5038b35429f2909b",
    "repo": "GNOME/gegl",
    "commit_url": "https://gitlab.gnome.org/GNOME/gegl/-/commit/bfce470f0f2f37968862129d5038b35429f2909b",
    "files": [
      "operations/common/magick-load.c"
    ],
    "message": "magick-load: use more robust g_spawn_async() instead of system()\n\nThis fixes issue #298 by avoiding the shell parsing being invoked at\nall, this less brittle than any forms of escaping characters, while\nretaining the ability to address all existing files.",
    "before_after_code_files": [
      "operations/common/magick-load.c||operations/common/magick-load.c"
    ]
  },
  "patch_diff": {
    "operations/common/magick-load.c||operations/common/magick-load.c": [
      "File: operations/common/magick-load.c -> operations/common/magick-load.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "41:   if (!op_magick_load->user_data)",
      "42:     {",
      "43:       gchar    *filename;",
      "45:       GeglNode *graph, *sink, *loader;",
      "46:       GeglBuffer *newbuf = NULL;",
      "52:       filename = g_build_filename (g_get_tmp_dir (), \"gegl-magick.png\", NULL);",
      "56:         g_warning (\"Error executing ImageMagick convert program\");",
      "59:       graph = gegl_node_new ();",
      "60:       sink = gegl_node_new_child (graph,",
      "",
      "[Removed Lines]",
      "44:       gchar    *cmd;",
      "53:       cmd = g_strdup_printf (\"convert \\\"%s\\\"'[0]' \\\"%s\\\"\",",
      "54:                              op_magick_load->path, filename);",
      "55:       if (system (cmd) == -1)",
      "",
      "[Added Lines]",
      "50:       char     *argv[4]  = {\"convert\", NULL, NULL, NULL};",
      "54:       argv[1] = g_strdup_printf (\"%s[0]\", op_magick_load->path);",
      "55:       argv[2] = filename;",
      "56:       if (!g_spawn_sync (NULL, argv, NULL, G_SPAWN_DEFAULT,",
      "57:                          NULL, NULL, NULL, NULL, NULL, NULL))",
      "60:       g_free (argv[1]);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "67:       gegl_node_process (sink);",
      "68:       op_magick_load->user_data = (gpointer) newbuf;",
      "69:       g_object_unref (graph);",
      "71:       g_free (filename);",
      "72:     }",
      "73: }",
      "",
      "[Removed Lines]",
      "70:       g_free (cmd);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "55513597dcbeb092d30d8d7aa00ae32b441ae35e",
      "candidate_info": {
        "commit_hash": "55513597dcbeb092d30d8d7aa00ae32b441ae35e",
        "repo": "GNOME/gegl",
        "commit_url": "https://github.com/GNOME/gegl/commit/55513597dcbeb092d30d8d7aa00ae32b441ae35e",
        "files": [
          "operations/common/magick-load.c"
        ],
        "message": "operations: add is_available() implementation to gegl:magick-load.\n\nSimilar to how we hide gegl:introspect, gegl:magick-load should not be\nmade available when Image-Magick's convert CLI tool is not present.",
        "before_after_code_files": [
          "operations/common/magick-load.c||operations/common/magick-load.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "operations/common/magick-load.c||operations/common/magick-load.c"
          ],
          "candidate": [
            "operations/common/magick-load.c||operations/common/magick-load.c"
          ]
        }
      },
      "candidate_diff": {
        "operations/common/magick-load.c||operations/common/magick-load.c": [
          "File: operations/common/magick-load.c -> operations/common/magick-load.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "38: static void",
          "39: load_cache (GeglProperties *op_magick_load)",
          "40: {",
          "42:     {",
          "43:       gchar    *filename;",
          "44:       GeglNode *graph, *sink, *loader;",
          "",
          "[Removed Lines]",
          "41:   if (!op_magick_load->user_data)",
          "",
          "[Added Lines]",
          "41:   gchar *convert;",
          "43:   convert = g_find_program_in_path (\"convert\");",
          "45:   if (convert && !op_magick_load->user_data)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:       filename = g_build_filename (g_get_tmp_dir (), \"gegl-magick.png\", NULL);",
          "",
          "[Removed Lines]",
          "50:       char     *argv[4]  = {\"convert\", NULL, NULL, NULL};",
          "",
          "[Added Lines]",
          "54:       char     *argv[4]  = {convert, NULL, NULL, NULL};",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "77:       g_object_unref (graph);",
          "78:       g_free (filename);",
          "79:     }",
          "80: }",
          "82: static GeglRectangle",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85:   g_free (convert);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "119:   return  TRUE;",
          "120: }",
          "122: static void finalize (GObject *object)",
          "123: {",
          "124:   GeglOperation *op = (void*) object;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128: static gboolean",
          "129: gegl_magick_load_is_available (void)",
          "130: {",
          "131:   gchar    *convert;",
          "132:   gboolean  found = FALSE;",
          "134:   convert = g_find_program_in_path (\"convert\");",
          "135:   found = (convert != NULL);",
          "136:   g_free (convert);",
          "138:   return found;",
          "139: }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "141:   object_class->finalize = finalize;",
          "143:   operation_class->process = process;",
          "145:   operation_class->get_cached_region = get_cached_region;;",
          "147:   gegl_operation_class_set_keys (operation_class,",
          "148:         \"name\"       , \"gegl:magick-load\",",
          "",
          "[Removed Lines]",
          "144:   operation_class->get_bounding_box = get_bounding_box;",
          "",
          "[Added Lines]",
          "163:   operation_class->get_bounding_box  = get_bounding_box;",
          "165:   operation_class->is_available      = gegl_magick_load_is_available;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2172cf7e8d7e8891ae2053d6eef213d5bef939cb",
      "candidate_info": {
        "commit_hash": "2172cf7e8d7e8891ae2053d6eef213d5bef939cb",
        "repo": "GNOME/gegl",
        "commit_url": "https://github.com/GNOME/gegl/commit/2172cf7e8d7e8891ae2053d6eef213d5bef939cb",
        "files": [
          "operations/common/magick-load.c"
        ],
        "message": "magick-load: pass redirect to /dev/null flags to g_spawn_async",
        "before_after_code_files": [
          "operations/common/magick-load.c||operations/common/magick-load.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "operations/common/magick-load.c||operations/common/magick-load.c"
          ],
          "candidate": [
            "operations/common/magick-load.c||operations/common/magick-load.c"
          ]
        }
      },
      "candidate_diff": {
        "operations/common/magick-load.c||operations/common/magick-load.c": [
          "File: operations/common/magick-load.c -> operations/common/magick-load.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:       argv[1] = g_strdup_printf (\"%s[0]\", op_magick_load->path);",
          "55:       argv[2] = filename;",
          "57:                          NULL, NULL, NULL, NULL, NULL, NULL))",
          "58:         g_warning (\"Error executing ImageMagick convert program\");",
          "",
          "[Removed Lines]",
          "56:       if (!g_spawn_sync (NULL, argv, NULL, G_SPAWN_DEFAULT,",
          "",
          "[Added Lines]",
          "56:       if (!g_spawn_sync (NULL, argv, NULL,",
          "57:                          G_SPAWN_STDOUT_TO_DEV_NULL|G_SPAWN_STDERR_TO_DEV_NULL,",
          "",
          "---------------"
        ]
      }
    }
  ]
}