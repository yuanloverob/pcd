{
  "cve_id": "CVE-2022-3109",
  "cve_desc": "An issue was discovered in the FFmpeg package, where vp3_decode_frame in libavcodec/vp3.c lacks check of the return value of av_malloc() and will cause a null pointer dereference, impacting availability.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "656cb0450aeb73b25d7d26980af342b37ac4c568",
  "patch_info": {
    "commit_hash": "656cb0450aeb73b25d7d26980af342b37ac4c568",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/656cb0450aeb73b25d7d26980af342b37ac4c568",
    "files": [
      "libavcodec/vp3.c"
    ],
    "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>",
    "before_after_code_files": [
      "libavcodec/vp3.c||libavcodec/vp3.c"
    ]
  },
  "patch_diff": {
    "libavcodec/vp3.c||libavcodec/vp3.c": [
      "File: libavcodec/vp3.c -> libavcodec/vp3.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2679:                                         AV_GET_BUFFER_FLAG_REF)) < 0)",
      "2680:         goto error;",
      "2683:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
      "2685:     if (s->keyframe) {",
      "2686:         if (!s->theora) {",
      "",
      "[Removed Lines]",
      "2682:     if (!s->edge_emu_buffer)",
      "",
      "[Added Lines]",
      "2682:     if (!s->edge_emu_buffer) {",
      "2684:         if (!s->edge_emu_buffer) {",
      "2685:             ret = AVERROR(ENOMEM);",
      "2686:             goto error;",
      "2687:         }",
      "2688:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2cdddcd6ec90c7a248ffe792d85faa4d89eab9f7",
      "candidate_info": {
        "commit_hash": "2cdddcd6ec90c7a248ffe792d85faa4d89eab9f7",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/2cdddcd6ec90c7a248ffe792d85faa4d89eab9f7",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2677:     if ((ret = ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF)) < 0)",
          "2678:         goto error;",
          "2681:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2683:     if (s->keyframe) {",
          "2684:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2680:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2680:     if (!s->edge_emu_buffer) {",
          "2682:         if (!s->edge_emu_buffer) {",
          "2683:             ret = AVERROR(ENOMEM);",
          "2684:             goto error;",
          "2685:         }",
          "2686:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "51efa68ec0b4f42b5b124b8987fb68f60a929c4f",
      "candidate_info": {
        "commit_hash": "51efa68ec0b4f42b5b124b8987fb68f60a929c4f",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/51efa68ec0b4f42b5b124b8987fb68f60a929c4f",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2136:     if (ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF) < 0)",
          "2137:         goto error;",
          "2140:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2142:     if (s->keyframe) {",
          "2143:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2139:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2139:     if (!s->edge_emu_buffer) {",
          "2141:         if (!s->edge_emu_buffer) {",
          "2142:             ret = AVERROR(ENOMEM);",
          "2143:             goto error;",
          "2144:         }",
          "2145:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e3bd8754ec4dbc5887fe1c02f15c775938509a86",
      "candidate_info": {
        "commit_hash": "e3bd8754ec4dbc5887fe1c02f15c775938509a86",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e3bd8754ec4dbc5887fe1c02f15c775938509a86",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2095:     if (ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF) < 0)",
          "2096:         goto error;",
          "2099:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2101:     if (s->keyframe) {",
          "2102:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2098:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2098:     if (!s->edge_emu_buffer) {",
          "2100:         if (!s->edge_emu_buffer) {",
          "2101:             ret = AVERROR(ENOMEM);",
          "2102:             goto error;",
          "2103:         }",
          "2104:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b2e1ee39f52e285cd630786019cff5d8d12aa1a1",
      "candidate_info": {
        "commit_hash": "b2e1ee39f52e285cd630786019cff5d8d12aa1a1",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b2e1ee39f52e285cd630786019cff5d8d12aa1a1",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2740:     if (ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF) < 0)",
          "2741:         goto error;",
          "2744:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2746:     if (s->keyframe) {",
          "2747:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2743:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2743:     if (!s->edge_emu_buffer) {",
          "2745:         if (!s->edge_emu_buffer) {",
          "2746:             ret = AVERROR(ENOMEM);",
          "2747:             goto error;",
          "2748:         }",
          "2749:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4d82b7bac42c9d35d4f9f145a85e6cbc1fe914f2",
      "candidate_info": {
        "commit_hash": "4d82b7bac42c9d35d4f9f145a85e6cbc1fe914f2",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/4d82b7bac42c9d35d4f9f145a85e6cbc1fe914f2",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2683:     if ((ret = ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF)) < 0)",
          "2684:         goto error;",
          "2687:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2689:     if (s->keyframe) {",
          "2690:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2686:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2686:     if (!s->edge_emu_buffer) {",
          "2688:         if (!s->edge_emu_buffer) {",
          "2689:             ret = AVERROR(ENOMEM);",
          "2690:             goto error;",
          "2691:         }",
          "2692:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}