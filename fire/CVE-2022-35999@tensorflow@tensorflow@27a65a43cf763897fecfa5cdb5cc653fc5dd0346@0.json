{
  "cve_id": "CVE-2022-35999",
  "cve_desc": "TensorFlow is an open source platform for machine learning. When `Conv2DBackpropInput` receives empty `out_backprop` inputs (e.g. `[3, 1, 0, 1]`), the current CPU/GPU kernels `CHECK` fail (one with dnnl, the other with cudnn). This can be used to trigger a denial of service attack. We have patched the issue in GitHub commit 27a65a43cf763897fecfa5cdb5cc653fc5dd0346. The fix will be included in TensorFlow 2.10.0. We will also cherrypick this commit on TensorFlow 2.9.1, TensorFlow 2.8.1, and TensorFlow 2.7.2, as these are also affected and still in supported range. There are no known workarounds for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "27a65a43cf763897fecfa5cdb5cc653fc5dd0346",
  "patch_info": {
    "commit_hash": "27a65a43cf763897fecfa5cdb5cc653fc5dd0346",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/27a65a43cf763897fecfa5cdb5cc653fc5dd0346",
    "files": [
      "tensorflow/core/kernels/conv_grad_input_ops.h",
      "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
    ],
    "message": "Fix GPU/CPU Conv2DBackpropInputOp check error.\n\nFor empty `out_backprop` inputs (e.g. `[3, 1, 0, 1]`), the current\nCPU/GPU kernels fail (one with dnnl, the other with cudnn). Added\na shortcut path to return a zero input.\n\nNote that the XLA test currently fails due to an incorrect result\nsize bug (b/239598470), so it is currently disabled.\n\nPiperOrigin-RevId: 462217998",
    "before_after_code_files": [
      "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
      "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h": [
      "File: tensorflow/core/kernels/conv_grad_input_ops.h -> tensorflow/core/kernels/conv_grad_input_ops.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "37: #include \"tensorflow/core/kernels/conv_2d.h\"",
      "38: #include \"tensorflow/core/kernels/conv_grad_ops.h\"",
      "39: #include \"tensorflow/core/kernels/conv_grad_shape_utils.h\"",
      "40: #ifdef TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS",
      "41: #include \"tensorflow/core/kernels/xsmm_conv2d.h\"",
      "42: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "40: #include \"tensorflow/core/kernels/fill_functor.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "436:       return;",
      "437:     }",
      "441:     const int stride_rows = GetTensorDim(strides_, data_format_, 'H');",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "442:     if (out_backprop.NumElements() == 0) {",
      "443:       functor::SetZeroFunctor<Device, T> set_zero;",
      "444:       set_zero(context->eigen_device<Device>(),",
      "445:                in_backprop->template flat<T>());",
      "446:       return;",
      "447:     }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "554:       return;",
      "555:     }",
      "559: #if defined TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS && \\",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "569:     if (out_backprop.NumElements() == 0) {",
      "570:       functor::SetZeroFunctor<Device, T> set_zero;",
      "571:       set_zero(context->eigen_device<Device>(),",
      "572:                in_backprop->template flat<T>());",
      "573:       return;",
      "574:     }",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py": [
      "File: tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py -> tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1103:           use_gpu=use_gpu,",
      "1104:           err=1e-5)",
      "1106:   # Testing for backprops",
      "1107:   def _RunAndVerifyBackpropFilter(self,",
      "1108:                                   input_sizes,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1106:   @test_util.run_in_graph_and_eager_modes",
      "1107:   @test_util.disable_xla(\"b/239598470\")",
      "1108:   def testConv2DBackpropInputDegenerateBackpropInput(self):",
      "1109:     input_sizes = [3, 1, 1, 2]",
      "1110:     expected_output = np.zeros(input_sizes).flatten()",
      "1111:     for (data_format, use_gpu) in GetTestConfigs():",
      "1112:       self._RunAndVerifyBackpropInput(",
      "1113:           input_sizes=input_sizes,",
      "1114:           filter_sizes=[1, 3, 2, 3],",
      "1115:           output_sizes=[3, 1, 0, 3],",
      "1116:           strides=[1, 2],",
      "1117:           padding=\"VALID\",",
      "1118:           expected=expected_output,",
      "1119:           data_format=data_format,",
      "1120:           use_gpu=use_gpu,",
      "1121:           err=1e-5)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d0bf8d0ce00defd0046003670f8d63542dcb4bd4",
      "candidate_info": {
        "commit_hash": "d0bf8d0ce00defd0046003670f8d63542dcb4bd4",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d0bf8d0ce00defd0046003670f8d63542dcb4bd4",
        "files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/conv_ops_test.py"
        ],
        "message": "Fix GPU/CPU Conv2DBackpropInputOp check error.\n\nFor empty `out_backprop` inputs (e.g. `[3, 1, 0, 1]`), the current\nCPU/GPU kernels fail (one with dnnl, the other with cudnn). Added\na shortcut path to return a zero input.\n\nNote that the XLA test currently fails due to an incorrect result\nsize bug (b/239598470), so it is currently disabled.\n\nPiperOrigin-RevId: 462217998",
        "before_after_code_files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/conv_ops_test.py||tensorflow/python/kernel_tests/conv_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h"
          ],
          "candidate": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h": [
          "File: tensorflow/core/kernels/conv_grad_input_ops.h -> tensorflow/core/kernels/conv_grad_input_ops.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: #include \"tensorflow/core/kernels/conv_2d.h\"",
          "38: #include \"tensorflow/core/kernels/conv_grad_ops.h\"",
          "39: #include \"tensorflow/core/kernels/conv_grad_shape_utils.h\"",
          "40: #ifdef TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS",
          "41: #include \"tensorflow/core/kernels/xsmm_conv2d.h\"",
          "42: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: #include \"tensorflow/core/kernels/fill_functor.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "436:       return;",
          "437:     }",
          "441:     const int stride_rows = GetTensorDim(strides_, data_format_, 'H');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "442:     if (out_backprop.NumElements() == 0) {",
          "443:       functor::SetZeroFunctor<Device, T> set_zero;",
          "444:       set_zero(context->eigen_device<Device>(),",
          "445:                in_backprop->template flat<T>());",
          "446:       return;",
          "447:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "551:       return;",
          "552:     }",
          "556: #if defined TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS && \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "566:     if (out_backprop.NumElements() == 0) {",
          "567:       functor::SetZeroFunctor<Device, T> set_zero;",
          "568:       set_zero(context->eigen_device<Device>(),",
          "569:                in_backprop->template flat<T>());",
          "570:       return;",
          "571:     }",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/conv_ops_test.py||tensorflow/python/kernel_tests/conv_ops_test.py": [
          "File: tensorflow/python/kernel_tests/conv_ops_test.py -> tensorflow/python/kernel_tests/conv_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1107:           use_gpu=use_gpu,",
          "1108:           err=1e-5)",
          "1110:   # Testing for backprops",
          "1111:   def _RunAndVerifyBackpropFilter(self,",
          "1112:                                   input_sizes,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1108:           err=1e-5)",
          "1110:   @test_util.run_in_graph_and_eager_modes",
          "1111:   @test_util.disable_xla(\"b/239598470\")",
          "1112:   def testConv2DBackpropInputDegenerateBackpropInput(self):",
          "1113:     input_sizes = [3, 1, 1, 2]",
          "1114:     expected_output = np.zeros(input_sizes).flatten()",
          "1115:     for (data_format, use_gpu) in GetTestConfigs():",
          "1116:       self._RunAndVerifyBackpropInput(",
          "1117:           input_sizes=input_sizes,",
          "1118:           filter_sizes=[1, 3, 2, 3],",
          "1119:           output_sizes=[3, 1, 0, 3],",
          "1120:           strides=[1, 2],",
          "1121:           padding=\"VALID\",",
          "1122:           expected=expected_output,",
          "1123:           data_format=data_format,",
          "1124:           use_gpu=use_gpu,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5d895642b569553863df4047a5d1f8f2c16c0f9a",
      "candidate_info": {
        "commit_hash": "5d895642b569553863df4047a5d1f8f2c16c0f9a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5d895642b569553863df4047a5d1f8f2c16c0f9a",
        "files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
        ],
        "message": "Fix GPU/CPU Conv2DBackpropInputOp check error.\n\nFor empty `out_backprop` inputs (e.g. `[3, 1, 0, 1]`), the current\nCPU/GPU kernels fail (one with dnnl, the other with cudnn). Added\na shortcut path to return a zero input.\n\nNote that the XLA test currently fails due to an incorrect result\nsize bug (b/239598470), so it is currently disabled.\n\nPiperOrigin-RevId: 462217998",
        "before_after_code_files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
            "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
            "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h": [
          "File: tensorflow/core/kernels/conv_grad_input_ops.h -> tensorflow/core/kernels/conv_grad_input_ops.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: #include \"tensorflow/core/kernels/conv_2d.h\"",
          "38: #include \"tensorflow/core/kernels/conv_grad_ops.h\"",
          "39: #include \"tensorflow/core/kernels/conv_grad_shape_utils.h\"",
          "40: #ifdef TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS",
          "41: #include \"tensorflow/core/kernels/xsmm_conv2d.h\"",
          "42: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: #include \"tensorflow/core/kernels/fill_functor.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "436:       return;",
          "437:     }",
          "441:     const int stride_rows = GetTensorDim(strides_, data_format_, 'H');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "442:     if (out_backprop.NumElements() == 0) {",
          "443:       functor::SetZeroFunctor<Device, T> set_zero;",
          "444:       set_zero(context->eigen_device<Device>(),",
          "445:                in_backprop->template flat<T>());",
          "446:       return;",
          "447:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "554:       return;",
          "555:     }",
          "559: #if defined TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS && \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "569:     if (out_backprop.NumElements() == 0) {",
          "570:       functor::SetZeroFunctor<Device, T> set_zero;",
          "571:       set_zero(context->eigen_device<Device>(),",
          "572:                in_backprop->template flat<T>());",
          "573:       return;",
          "574:     }",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py": [
          "File: tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py -> tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1103:           use_gpu=use_gpu,",
          "1104:           err=1e-5)",
          "1106:   # Testing for backprops",
          "1107:   def _RunAndVerifyBackpropFilter(self,",
          "1108:                                   input_sizes,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1106:   @test_util.run_in_graph_and_eager_modes",
          "1107:   @test_util.disable_xla(\"b/239598470\")",
          "1108:   def testConv2DBackpropInputDegenerateBackpropInput(self):",
          "1109:     input_sizes = [3, 1, 1, 2]",
          "1110:     expected_output = np.zeros(input_sizes).flatten()",
          "1111:     for (data_format, use_gpu) in GetTestConfigs():",
          "1112:       self._RunAndVerifyBackpropInput(",
          "1113:           input_sizes=input_sizes,",
          "1114:           filter_sizes=[1, 3, 2, 3],",
          "1115:           output_sizes=[3, 1, 0, 3],",
          "1116:           strides=[1, 2],",
          "1117:           padding=\"VALID\",",
          "1118:           expected=expected_output,",
          "1119:           data_format=data_format,",
          "1120:           use_gpu=use_gpu,",
          "1121:           err=1e-5)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c7fb62e7a404fba6bf6affc9dfe7438ae540d0a6",
      "candidate_info": {
        "commit_hash": "c7fb62e7a404fba6bf6affc9dfe7438ae540d0a6",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c7fb62e7a404fba6bf6affc9dfe7438ae540d0a6",
        "files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
        ],
        "message": "Fix GPU/CPU Conv2DBackpropInputOp check error.\n\nFor empty `out_backprop` inputs (e.g. `[3, 1, 0, 1]`), the current\nCPU/GPU kernels fail (one with dnnl, the other with cudnn). Added\na shortcut path to return a zero input.\n\nNote that the XLA test currently fails due to an incorrect result\nsize bug (b/239598470), so it is currently disabled.\n\nPiperOrigin-RevId: 462217998",
        "before_after_code_files": [
          "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
          "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
            "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h",
            "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/conv_grad_input_ops.h||tensorflow/core/kernels/conv_grad_input_ops.h": [
          "File: tensorflow/core/kernels/conv_grad_input_ops.h -> tensorflow/core/kernels/conv_grad_input_ops.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "37: #include \"tensorflow/core/kernels/conv_2d.h\"",
          "38: #include \"tensorflow/core/kernels/conv_grad_ops.h\"",
          "39: #include \"tensorflow/core/kernels/conv_grad_shape_utils.h\"",
          "40: #ifdef TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS",
          "41: #include \"tensorflow/core/kernels/xsmm_conv2d.h\"",
          "42: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40: #include \"tensorflow/core/kernels/fill_functor.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "436:       return;",
          "437:     }",
          "441:     const int stride_rows = GetTensorDim(strides_, data_format_, 'H');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "442:     if (out_backprop.NumElements() == 0) {",
          "443:       functor::SetZeroFunctor<Device, T> set_zero;",
          "444:       set_zero(context->eigen_device<Device>(),",
          "445:                in_backprop->template flat<T>());",
          "446:       return;",
          "447:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "554:       return;",
          "555:     }",
          "559: #if defined TENSORFLOW_USE_LIBXSMM_CONVOLUTIONS && \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "569:     if (out_backprop.NumElements() == 0) {",
          "570:       functor::SetZeroFunctor<Device, T> set_zero;",
          "571:       set_zero(context->eigen_device<Device>(),",
          "572:                in_backprop->template flat<T>());",
          "573:       return;",
          "574:     }",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py||tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py": [
          "File: tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py -> tensorflow/python/kernel_tests/nn_ops/conv_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1103:           use_gpu=use_gpu,",
          "1104:           err=1e-5)",
          "1106:   # Testing for backprops",
          "1107:   def _RunAndVerifyBackpropFilter(self,",
          "1108:                                   input_sizes,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1106:   @test_util.run_in_graph_and_eager_modes",
          "1107:   @test_util.disable_xla(\"b/239598470\")",
          "1108:   def testConv2DBackpropInputDegenerateBackpropInput(self):",
          "1109:     input_sizes = [3, 1, 1, 2]",
          "1110:     expected_output = np.zeros(input_sizes).flatten()",
          "1111:     for (data_format, use_gpu) in GetTestConfigs():",
          "1112:       self._RunAndVerifyBackpropInput(",
          "1113:           input_sizes=input_sizes,",
          "1114:           filter_sizes=[1, 3, 2, 3],",
          "1115:           output_sizes=[3, 1, 0, 3],",
          "1116:           strides=[1, 2],",
          "1117:           padding=\"VALID\",",
          "1118:           expected=expected_output,",
          "1119:           data_format=data_format,",
          "1120:           use_gpu=use_gpu,",
          "1121:           err=1e-5)",
          "",
          "---------------"
        ]
      }
    }
  ]
}