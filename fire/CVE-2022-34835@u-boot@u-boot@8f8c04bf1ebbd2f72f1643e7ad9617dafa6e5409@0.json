{
  "cve_id": "CVE-2022-34835",
  "cve_desc": "In Das U-Boot through 2022.07-rc5, an integer signedness error and resultant stack-based buffer overflow in the \"i2c md\" command enables the corruption of the return address pointer of the do_i2c_md function.",
  "repo": "u-boot/u-boot",
  "patch_hash": "8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409",
  "patch_info": {
    "commit_hash": "8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409",
    "repo": "u-boot/u-boot",
    "commit_url": "https://github.com/u-boot/u-boot/commit/8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409",
    "files": [
      "cmd/i2c.c"
    ],
    "message": "i2c: fix stack buffer overflow vulnerability in i2c md command\n\nWhen running \"i2c md 0 0 80000100\", the function do_i2c_md parses the\nlength into an unsigned int variable named length. The value is then\nmoved to a signed variable:\n\n    int nbytes = length;\n    #define DISP_LINE_LEN 16\n    int linebytes = (nbytes > DISP_LINE_LEN) ? DISP_LINE_LEN : nbytes;\n    ret = dm_i2c_read(dev, addr, linebuf, linebytes);\n\nOn systems where integers are 32 bits wide, 0x80000100 is a negative\nvalue to \"nbytes > DISP_LINE_LEN\" is false and linebytes gets assigned\n0x80000100 instead of 16.\n\nThe consequence is that the function which reads from the i2c device\n(dm_i2c_read or i2c_read) is called with a 16-byte stack buffer to fill\nbut with a size parameter which is too large. In some cases, this could\ntrigger a crash. But with some i2c drivers, such as drivers/i2c/nx_i2c.c\n(used with \"nexell,s5pxx18-i2c\" bus), the size is actually truncated to\na 16-bit integer. This is because function i2c_transfer expects an\nunsigned short length. In such a case, an attacker who can control the\nresponse of an i2c device can overwrite the return address of a function\nand execute arbitrary code through Return-Oriented Programming.\n\nFix this issue by using unsigned integers types in do_i2c_md. While at\nit, make also alen unsigned, as signed sizes can cause vulnerabilities\nwhen people forgot to check that they can be negative.\n\nSigned-off-by: Nicolas Iooss <nicolas.iooss+uboot@ledger.fr>\nReviewed-by: Heiko Schocher <hs@denx.de>",
    "before_after_code_files": [
      "cmd/i2c.c||cmd/i2c.c"
    ]
  },
  "patch_diff": {
    "cmd/i2c.c||cmd/i2c.c": [
      "File: cmd/i2c.c -> cmd/i2c.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "204: {",
      "208:  alen = default_len;",
      "209:  for (j = 0; j < 8; j++) {",
      "",
      "[Removed Lines]",
      "203: static uint get_alen(char *arg, int default_len)",
      "205:  int j;",
      "206:  int alen;",
      "",
      "[Added Lines]",
      "203: static uint get_alen(char *arg, uint default_len)",
      "205:  uint j;",
      "206:  uint alen;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "247: {",
      "248:  uint chip;",
      "249:  uint devaddr, length;",
      "251:  u_char  *memaddr;",
      "252:  int ret;",
      "253: #if CONFIG_IS_ENABLED(DM_I2C)",
      "",
      "[Removed Lines]",
      "250:  int alen;",
      "",
      "[Added Lines]",
      "250:  uint alen;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "301: {",
      "302:  uint chip;",
      "303:  uint devaddr, length;",
      "305:  u_char  *memaddr;",
      "306:  int ret;",
      "307: #if CONFIG_IS_ENABLED(DM_I2C)",
      "",
      "[Removed Lines]",
      "304:  int alen;",
      "",
      "[Added Lines]",
      "304:  uint alen;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "469: {",
      "470:  uint chip;",
      "471:  uint addr, length;",
      "474:  int ret;",
      "475: #if CONFIG_IS_ENABLED(DM_I2C)",
      "476:  struct udevice *dev;",
      "",
      "[Removed Lines]",
      "472:  int alen;",
      "473:  int j, nbytes, linebytes;",
      "",
      "[Added Lines]",
      "472:  uint alen;",
      "473:  uint j, nbytes, linebytes;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "589: {",
      "590:  uint chip;",
      "591:  ulong addr;",
      "593:  uchar byte;",
      "595:  int ret;",
      "596: #if CONFIG_IS_ENABLED(DM_I2C)",
      "597:  struct udevice *dev;",
      "",
      "[Removed Lines]",
      "592:  int alen;",
      "594:  int count;",
      "",
      "[Added Lines]",
      "592:  uint alen;",
      "594:  uint count;",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "676: {",
      "677:  uint chip;",
      "678:  ulong addr;",
      "681:  uchar byte;",
      "682:  ulong crc;",
      "683:  ulong err;",
      "",
      "[Removed Lines]",
      "679:  int alen;",
      "680:  int count;",
      "",
      "[Added Lines]",
      "679:  uint alen;",
      "680:  uint count;",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "985:          char *const argv[])",
      "986: {",
      "987:  uint chip;",
      "989:  uint addr;",
      "990:  uint length;",
      "991:  u_char bytes[16];",
      "",
      "[Removed Lines]",
      "988:  int alen;",
      "",
      "[Added Lines]",
      "988:  uint alen;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1aa9a04ff687b8d55b0fb68ae2a688c8705665cc",
      "candidate_info": {
        "commit_hash": "1aa9a04ff687b8d55b0fb68ae2a688c8705665cc",
        "repo": "u-boot/u-boot",
        "commit_url": "https://github.com/u-boot/u-boot/commit/1aa9a04ff687b8d55b0fb68ae2a688c8705665cc",
        "files": [
          "cmd/i2c.c"
        ],
        "message": "Revert \"i2c: fix stack buffer overflow vulnerability in i2c md command\"\n\nThis reverts commit 8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409.\n\nThe commit is largely wrong and breaks most of i2c command functionality.\nThe problem described in the aforementioned commit commit message is valid,\nhowever the commit itself does many more changes unrelated to fixing that\none problem it describes. Those extra changes, namely the handling of i2c\ndevice address length as unsigned instead of signed integer, breaks the\nexpectation that address length may be negative value. The negative value\nis used by DM to indicate that address length of device does not change.\n\nThe actual bug documented in commit 8f8c04bf1ebbd2f72f1643e7ad9617dafa6e5409\ncan be fixed by extra sanitization in separate patch.\n\nSigned-off-by: Marek Vasut <marex@denx.de>\nCc: Heiko Schocher <hs@denx.de>\nCc: Nicolas Iooss <nicolas.iooss+uboot@ledger.fr>\nCc: Simon Glass <sjg@chromium.org>\nCc: Tim Harvey <tharvey@gateworks.com>\nReviewed-by: Simon Glass <sjg@chromium.org>",
        "before_after_code_files": [
          "cmd/i2c.c||cmd/i2c.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "cmd/i2c.c||cmd/i2c.c"
          ],
          "candidate": [
            "cmd/i2c.c||cmd/i2c.c"
          ]
        }
      },
      "candidate_diff": {
        "cmd/i2c.c||cmd/i2c.c": [
          "File: cmd/i2c.c -> cmd/i2c.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "204: {",
          "208:  alen = default_len;",
          "209:  for (j = 0; j < 8; j++) {",
          "",
          "[Removed Lines]",
          "203: static uint get_alen(char *arg, uint default_len)",
          "205:  uint j;",
          "206:  uint alen;",
          "",
          "[Added Lines]",
          "203: static uint get_alen(char *arg, int default_len)",
          "205:  int j;",
          "206:  int alen;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "247: {",
          "248:  uint chip;",
          "249:  uint devaddr, length;",
          "251:  u_char  *memaddr;",
          "252:  int ret;",
          "253: #if CONFIG_IS_ENABLED(DM_I2C)",
          "",
          "[Removed Lines]",
          "250:  uint alen;",
          "",
          "[Added Lines]",
          "250:  int alen;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "301: {",
          "302:  uint chip;",
          "303:  uint devaddr, length;",
          "305:  u_char  *memaddr;",
          "306:  int ret;",
          "307: #if CONFIG_IS_ENABLED(DM_I2C)",
          "",
          "[Removed Lines]",
          "304:  uint alen;",
          "",
          "[Added Lines]",
          "304:  int alen;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "469: {",
          "470:  uint chip;",
          "471:  uint addr, length;",
          "474:  int ret;",
          "475: #if CONFIG_IS_ENABLED(DM_I2C)",
          "476:  struct udevice *dev;",
          "",
          "[Removed Lines]",
          "472:  uint alen;",
          "473:  uint j, nbytes, linebytes;",
          "",
          "[Added Lines]",
          "472:  int alen;",
          "473:  int j, nbytes, linebytes;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "589: {",
          "590:  uint chip;",
          "591:  ulong addr;",
          "593:  uchar byte;",
          "595:  int ret;",
          "596: #if CONFIG_IS_ENABLED(DM_I2C)",
          "597:  struct udevice *dev;",
          "",
          "[Removed Lines]",
          "592:  uint alen;",
          "594:  uint count;",
          "",
          "[Added Lines]",
          "592:  int alen;",
          "594:  int count;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "676: {",
          "677:  uint chip;",
          "678:  ulong addr;",
          "681:  uchar byte;",
          "682:  ulong crc;",
          "683:  ulong err;",
          "",
          "[Removed Lines]",
          "679:  uint alen;",
          "680:  uint count;",
          "",
          "[Added Lines]",
          "679:  int alen;",
          "680:  int count;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "985:          char *const argv[])",
          "986: {",
          "987:  uint chip;",
          "989:  uint addr;",
          "990:  uint length;",
          "991:  u_char bytes[16];",
          "",
          "[Removed Lines]",
          "988:  uint alen;",
          "",
          "[Added Lines]",
          "988:  int alen;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4573fef7701afc2df22924ce0a445b923475afc",
      "candidate_info": {
        "commit_hash": "e4573fef7701afc2df22924ce0a445b923475afc",
        "repo": "u-boot/u-boot",
        "commit_url": "https://github.com/u-boot/u-boot/commit/e4573fef7701afc2df22924ce0a445b923475afc",
        "files": [
          "cmd/i2c.c"
        ],
        "message": "i2c: fix stack buffer overflow vulnerability in i2c md command\n\nThis reinstates fix from commit 8f8c04bf1ebb (\"i2c: fix stack buffer\noverflow vulnerability in i2c md command\") without the changes unrelated\nto the actual fix. Avoid the underflow by setting only nbytes and\nlinebytes as unsigned integers.\n\nSigned-off-by: Marek Vasut <marex@denx.de>\nCc: Heiko Schocher <hs@denx.de>\nCc: Nicolas Iooss <nicolas.iooss+uboot@ledger.fr>\nCc: Simon Glass <sjg@chromium.org>\nCc: Tim Harvey <tharvey@gateworks.com>\nAcked-by: Tim Harvey <tharvey@gateworks.com>",
        "before_after_code_files": [
          "cmd/i2c.c||cmd/i2c.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "cmd/i2c.c||cmd/i2c.c"
          ],
          "candidate": [
            "cmd/i2c.c||cmd/i2c.c"
          ]
        }
      },
      "candidate_diff": {
        "cmd/i2c.c||cmd/i2c.c": [
          "File: cmd/i2c.c -> cmd/i2c.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "470:  uint chip;",
          "471:  uint addr, length;",
          "472:  int alen;",
          "474:  int ret;",
          "475: #if CONFIG_IS_ENABLED(DM_I2C)",
          "476:  struct udevice *dev;",
          "",
          "[Removed Lines]",
          "473:  int j, nbytes, linebytes;",
          "",
          "[Added Lines]",
          "473:  int j;",
          "474:  uint nbytes, linebytes;",
          "",
          "---------------"
        ]
      }
    }
  ]
}