{
  "cve_id": "CVE-2023-5217",
  "cve_desc": "Heap buffer overflow in vp8 encoding in libvpx in Google Chrome prior to 117.0.5938.132 and libvpx 1.13.1 allowed a remote attacker to potentially exploit heap corruption via a crafted HTML page. (Chromium security severity: High)",
  "repo": "webmproject/libvpx",
  "patch_hash": "3fbd1dca6a4d2dad332a2110d646e4ffef36d590",
  "patch_info": {
    "commit_hash": "3fbd1dca6a4d2dad332a2110d646e4ffef36d590",
    "repo": "webmproject/libvpx",
    "commit_url": "https://github.com/webmproject/libvpx/commit/3fbd1dca6a4d2dad332a2110d646e4ffef36d590",
    "files": [
      "test/encode_api_test.cc",
      "vp8/encoder/onyx_if.c"
    ],
    "message": "VP8: disallow thread count changes\n\nCurrently allocations are done at encoder creation time. Going from\nthreaded to non-threaded would cause a crash.\n\nBug: chromium:1486441\nChange-Id: Ie301c2a70847dff2f0daae408fbef1e4d42e73d4",
    "before_after_code_files": [
      "test/encode_api_test.cc||test/encode_api_test.cc",
      "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
    ]
  },
  "patch_diff": {
    "test/encode_api_test.cc||test/encode_api_test.cc": [
      "File: test/encode_api_test.cc -> test/encode_api_test.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "371:   for (const auto *iface : kCodecIfaces) {",
      "372:     SCOPED_TRACE(vpx_codec_iface_name(iface));",
      "377:     for (int i = 0; i < (IsVP9(iface) ? 2 : 1); ++i) {",
      "378:       vpx_codec_enc_cfg_t cfg = {};",
      "379:       struct Encoder {",
      "",
      "[Removed Lines]",
      "373:     if (!IsVP9(iface)) {",
      "374:       GTEST_SKIP() << \"TODO(https://crbug.com/1486441) remove this condition \"",
      "375:                       \"after VP8 is fixed.\";",
      "376:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c": [
      "File: vp8/encoder/onyx_if.c -> vp8/encoder/onyx_if.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1447:   last_h = cpi->oxcf.Height;",
      "1448:   prev_number_of_layers = cpi->oxcf.number_of_layers;",
      "1450:   cpi->oxcf = *oxcf;",
      "1452:   switch (cpi->oxcf.Mode) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1450:   if (cpi->initial_width) {",
      "1453:     oxcf->multi_threaded = cpi->oxcf.multi_threaded;",
      "1454:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "91ba9ad08a45e2bd1e0f34658dd4d3fd101b047b",
      "candidate_info": {
        "commit_hash": "91ba9ad08a45e2bd1e0f34658dd4d3fd101b047b",
        "repo": "webmproject/libvpx",
        "commit_url": "https://github.com/webmproject/libvpx/commit/91ba9ad08a45e2bd1e0f34658dd4d3fd101b047b",
        "files": [
          "test/encode_api_test.cc",
          "vp8/encoder/onyx_if.c"
        ],
        "message": "VP8: disallow thread count changes\n\nCurrently allocations are done at encoder creation time. Going from\nthreaded to non-threaded would cause a crash.\n\nBug: chromium:1486441\nChange-Id: Ie301c2a70847dff2f0daae408fbef1e4d42e73d4\n(cherry picked from commit 3fbd1dca6a4d2dad332a2110d646e4ffef36d590)",
        "before_after_code_files": [
          "test/encode_api_test.cc||test/encode_api_test.cc",
          "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "test/encode_api_test.cc||test/encode_api_test.cc",
            "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
          ],
          "candidate": [
            "test/encode_api_test.cc||test/encode_api_test.cc",
            "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
          ]
        }
      },
      "candidate_diff": {
        "test/encode_api_test.cc||test/encode_api_test.cc": [
          "File: test/encode_api_test.cc -> test/encode_api_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "367:   for (const auto *iface : kCodecIfaces) {",
          "368:     SCOPED_TRACE(vpx_codec_iface_name(iface));",
          "373:     for (int i = 0; i < (IsVP9(iface) ? 2 : 1); ++i) {",
          "374:       vpx_codec_enc_cfg_t cfg = {};",
          "375:       struct Encoder {",
          "",
          "[Removed Lines]",
          "369:     if (!IsVP9(iface)) {",
          "370:       GTEST_SKIP() << \"TODO(https://crbug.com/1486441) remove this condition \"",
          "371:                       \"after VP8 is fixed.\";",
          "372:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c": [
          "File: vp8/encoder/onyx_if.c -> vp8/encoder/onyx_if.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1443:   last_h = cpi->oxcf.Height;",
          "1444:   prev_number_of_layers = cpi->oxcf.number_of_layers;",
          "1446:   cpi->oxcf = *oxcf;",
          "1448:   switch (cpi->oxcf.Mode) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1446:   if (cpi->initial_width) {",
          "1449:     oxcf->multi_threaded = cpi->oxcf.multi_threaded;",
          "1450:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7aaffe2df4c9426ab204a272ca5ca52286ca86d4",
      "candidate_info": {
        "commit_hash": "7aaffe2df4c9426ab204a272ca5ca52286ca86d4",
        "repo": "webmproject/libvpx",
        "commit_url": "https://github.com/webmproject/libvpx/commit/7aaffe2df4c9426ab204a272ca5ca52286ca86d4",
        "files": [
          "test/encode_api_test.cc",
          "vp8/encoder/onyx_if.c"
        ],
        "message": "VP8: disallow thread count changes\n\nCurrently allocations are done at encoder creation time. Going from\nthreaded to non-threaded would cause a crash.\n\nBug: chromium:1486441\nChange-Id: Ie301c2a70847dff2f0daae408fbef1e4d42e73d4\n(cherry picked from commit 3fbd1dca6a4d2dad332a2110d646e4ffef36d590)",
        "before_after_code_files": [
          "test/encode_api_test.cc||test/encode_api_test.cc",
          "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "test/encode_api_test.cc||test/encode_api_test.cc",
            "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
          ],
          "candidate": [
            "test/encode_api_test.cc||test/encode_api_test.cc",
            "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c"
          ]
        }
      },
      "candidate_diff": {
        "test/encode_api_test.cc||test/encode_api_test.cc": [
          "File: test/encode_api_test.cc -> test/encode_api_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "367:   for (const auto *iface : kCodecIfaces) {",
          "368:     SCOPED_TRACE(vpx_codec_iface_name(iface));",
          "373:     for (int i = 0; i < (IsVP9(iface) ? 2 : 1); ++i) {",
          "374:       vpx_codec_enc_cfg_t cfg = {};",
          "375:       struct Encoder {",
          "",
          "[Removed Lines]",
          "369:     if (!IsVP9(iface)) {",
          "370:       GTEST_SKIP() << \"TODO(https://crbug.com/1486441) remove this condition \"",
          "371:                       \"after VP8 is fixed.\";",
          "372:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "vp8/encoder/onyx_if.c||vp8/encoder/onyx_if.c": [
          "File: vp8/encoder/onyx_if.c -> vp8/encoder/onyx_if.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1443:   last_h = cpi->oxcf.Height;",
          "1444:   prev_number_of_layers = cpi->oxcf.number_of_layers;",
          "1446:   cpi->oxcf = *oxcf;",
          "1448:   switch (cpi->oxcf.Mode) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1446:   if (cpi->initial_width) {",
          "1449:     oxcf->multi_threaded = cpi->oxcf.multi_threaded;",
          "1450:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "af6dedd715f4307669366944cca6e0417b290282",
      "candidate_info": {
        "commit_hash": "af6dedd715f4307669366944cca6e0417b290282",
        "repo": "webmproject/libvpx",
        "commit_url": "https://github.com/webmproject/libvpx/commit/af6dedd715f4307669366944cca6e0417b290282",
        "files": [
          "test/encode_api_test.cc"
        ],
        "message": "encode_api_test: add ConfigResizeChangeThreadCount\n\nUpdate thread counts and resolution to ensure allocations are updated\ncorrectly. VP8 is disabled to avoid a crash.\n\nBug: chromium:1486441\nChange-Id: Ie89776d9818d27dc351eff298a44c699e850761b",
        "before_after_code_files": [
          "test/encode_api_test.cc||test/encode_api_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "test/encode_api_test.cc||test/encode_api_test.cc"
          ],
          "candidate": [
            "test/encode_api_test.cc||test/encode_api_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "test/encode_api_test.cc||test/encode_api_test.cc": [
          "File: test/encode_api_test.cc -> test/encode_api_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "309: void InitCodec(const vpx_codec_iface_t &iface, int width, int height,",
          "310:                vpx_codec_ctx_t *enc, vpx_codec_enc_cfg_t *cfg) {",
          "312:   cfg->g_w = width;",
          "313:   cfg->g_h = height;",
          "314:   cfg->g_lag_in_frames = 0;",
          "",
          "[Removed Lines]",
          "311:   ASSERT_EQ(vpx_codec_enc_config_default(&iface, cfg, 0), VPX_CODEC_OK);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "346:         vpx_codec_ctx_t ctx = {};",
          "347:       } enc;",
          "349:       EXPECT_NO_FATAL_FAILURE(",
          "350:           InitCodec(*iface, kWidth, kHeight, &enc.ctx, &cfg));",
          "351:       if (IsVP9(iface)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "348:       ASSERT_EQ(vpx_codec_enc_config_default(iface, &cfg, 0), VPX_CODEC_OK);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "364:   }",
          "365: }",
          "367: #if CONFIG_VP9_ENCODER",
          "368: class EncodeApiGetTplStatsTest",
          "369:     : public ::libvpx_test::EncoderTest,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "367: TEST(EncodeAPI, ConfigResizeChangeThreadCount) {",
          "368:   constexpr int kInitWidth = 1024;",
          "369:   constexpr int kInitHeight = 1024;",
          "371:   for (const auto *iface : kCodecIfaces) {",
          "372:     SCOPED_TRACE(vpx_codec_iface_name(iface));",
          "373:     if (!IsVP9(iface)) {",
          "374:       GTEST_SKIP() << \"TODO(https://crbug.com/1486441) remove this condition \"",
          "375:                       \"after VP8 is fixed.\";",
          "376:     }",
          "377:     for (int i = 0; i < (IsVP9(iface) ? 2 : 1); ++i) {",
          "378:       vpx_codec_enc_cfg_t cfg = {};",
          "379:       struct Encoder {",
          "380:         ~Encoder() { EXPECT_EQ(vpx_codec_destroy(&ctx), VPX_CODEC_OK); }",
          "381:         vpx_codec_ctx_t ctx = {};",
          "382:       } enc;",
          "384:       ASSERT_EQ(vpx_codec_enc_config_default(iface, &cfg, 0), VPX_CODEC_OK);",
          "388:       cfg.g_threads = 4;",
          "389:       EXPECT_NO_FATAL_FAILURE(",
          "390:           InitCodec(*iface, kInitWidth, kInitHeight, &enc.ctx, &cfg));",
          "391:       if (IsVP9(iface)) {",
          "392:         EXPECT_EQ(vpx_codec_control_(&enc.ctx, VP9E_SET_TILE_COLUMNS, 6),",
          "393:                   VPX_CODEC_OK);",
          "394:         EXPECT_EQ(vpx_codec_control_(&enc.ctx, VP9E_SET_ROW_MT, i),",
          "395:                   VPX_CODEC_OK);",
          "396:       }",
          "398:       cfg.g_w = 1000;",
          "399:       cfg.g_h = 608;",
          "400:       EXPECT_EQ(vpx_codec_enc_config_set(&enc.ctx, &cfg), VPX_CODEC_OK)",
          "401:           << vpx_codec_error_detail(&enc.ctx);",
          "403:       cfg.g_w = 16;",
          "404:       cfg.g_h = 720;",
          "406:       for (const auto threads : { 1, 4, 8, 6, 2, 1 }) {",
          "407:         cfg.g_threads = threads;",
          "408:         EXPECT_NO_FATAL_FAILURE(EncodeWithConfig(cfg, &enc.ctx))",
          "409:             << \"iteration: \" << i << \" threads: \" << threads;",
          "410:       }",
          "411:     }",
          "412:   }",
          "413: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}