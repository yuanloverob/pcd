{
  "cve_id": "CVE-2017-13018",
  "cve_desc": "The PGM parser in tcpdump before 4.9.2 has a buffer over-read in print-pgm.c:pgm_print().",
  "repo": "the-tcpdump-group/tcpdump",
  "patch_hash": "26a6799b9ca80508c05cac7a9a3bef922991520b",
  "patch_info": {
    "commit_hash": "26a6799b9ca80508c05cac7a9a3bef922991520b",
    "repo": "the-tcpdump-group/tcpdump",
    "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/26a6799b9ca80508c05cac7a9a3bef922991520b",
    "files": [
      "print-pgm.c",
      "tests/TESTLIST",
      "tests/pgm_opts_asan.out",
      "tests/pgm_opts_asan.pcap"
    ],
    "message": "CVE-2017-13018/PGM: Add a missing bounds check.\n\nThis fixes a buffer over-read discovered by Bhargava Shastry,\nSecT/TU Berlin.\n\nAdd a test using the capture file supplied by the reporter(s), modified\nso the capture file won't be rejected as an invalid capture.",
    "before_after_code_files": [
      "print-pgm.c||print-pgm.c"
    ]
  },
  "patch_diff": {
    "print-pgm.c||print-pgm.c": [
      "File: print-pgm.c -> print-pgm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "457:       ND_PRINT((ndo, \"[Total option length leaves no room for final option]\"));",
      "458:       return;",
      "459:   }",
      "460:   opt_type = *bp++;",
      "461:   opt_len = *bp++;",
      "462:   if (opt_len < PGM_MIN_OPT_LEN) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "460:   if (!ND_TTEST2(*bp, 2)) {",
      "461:       ND_PRINT((ndo, \" [|OPT]\"));",
      "462:       return;",
      "463:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "00ecef01d7dd1f53c58ddeb0f906f3ec602283f0",
      "candidate_info": {
        "commit_hash": "00ecef01d7dd1f53c58ddeb0f906f3ec602283f0",
        "repo": "the-tcpdump-group/tcpdump",
        "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/00ecef01d7dd1f53c58ddeb0f906f3ec602283f0",
        "files": [
          "print-ah.c",
          "print-bfd.c",
          "print-bgp.c",
          "print-eap.c",
          "print-esp.c",
          "print-hncp.c",
          "print-ip6opts.c",
          "print-ipcomp.c",
          "print-lldp.c",
          "print-mpcp.c",
          "print-mpls.c",
          "print-otv.c",
          "print-pgm.c",
          "print-sflow.c",
          "print-vqp.c",
          "tests/bgp-aigp-oobr-nossl.out",
          "tests/bgp-aigp-oobr-ssl.out",
          "tests/bgp-as-path-oobr-nossl.out",
          "tests/bgp-as-path-oobr-ssl.out",
          "tests/bgp_infloop-v.out",
          "tests/bgp_mvpn_6_and_7.out",
          "tests/bgp_pmsi_tunnel-oobr.out",
          "tests/bgp_vpn_rt-oobr.out",
          "tests/eap_extract_read2_asan.out",
          "tests/hncp_dhcpv6data-oobr.out",
          "tests/hoobr_safeputs.out",
          "tests/ipcomp-heapoverflow.out",
          "tests/ipv6-next-header-oobr-2.out",
          "tests/ipv6hdr-heapoverflow-v.out",
          "tests/ipv6hdr-heapoverflow.out",
          "tests/lldp_8023_mtu-oobr.out",
          "tests/lldp_mgmt_addr_tlv_asan.out",
          "tests/mpls-label-heapoverflow.out",
          "tests/otv-heapoverflow-1.out",
          "tests/pgm_group_addr_asan.out",
          "tests/pgm_opts_asan.out",
          "tests/tok2str-oobr-1.out",
          "tests/vqp-oobr.out"
        ],
        "message": "Add more nd_print_trunc() calls\n\nUpdate the output of some tests accordingly.",
        "before_after_code_files": [
          "print-ah.c||print-ah.c",
          "print-bfd.c||print-bfd.c",
          "print-bgp.c||print-bgp.c",
          "print-eap.c||print-eap.c",
          "print-esp.c||print-esp.c",
          "print-hncp.c||print-hncp.c",
          "print-ip6opts.c||print-ip6opts.c",
          "print-ipcomp.c||print-ipcomp.c",
          "print-lldp.c||print-lldp.c",
          "print-mpcp.c||print-mpcp.c",
          "print-mpls.c||print-mpls.c",
          "print-otv.c||print-otv.c",
          "print-pgm.c||print-pgm.c",
          "print-sflow.c||print-sflow.c",
          "print-vqp.c||print-vqp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "print-pgm.c||print-pgm.c"
          ],
          "candidate": [
            "print-pgm.c||print-pgm.c"
          ]
        }
      },
      "candidate_diff": {
        "print-ah.c||print-ah.c": [
          "File: print-ah.c -> print-ah.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "61:  return sizeof(struct ah) + sumlen;",
          "62:  trunc:",
          "64:  return -1;",
          "65: }",
          "",
          "[Removed Lines]",
          "63:  ND_PRINT(\"[|AH]\");",
          "",
          "[Added Lines]",
          "63:  nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-bfd.c||print-bfd.c": [
          "File: print-bfd.c -> print-bfd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "403:         return;",
          "405: trunc:",
          "407: }",
          "",
          "[Removed Lines]",
          "406:         ND_PRINT(\"[|BFD]\");",
          "",
          "[Added Lines]",
          "406:         nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-bgp.c||print-bgp.c": [
          "File: print-bgp.c -> print-bgp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2595:     return;",
          "2597: trunc:",
          "2599: }",
          "2601: static void",
          "",
          "[Removed Lines]",
          "2598:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "2598:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2666:     }",
          "2667:     return;",
          "2668: trunc:",
          "2670: }",
          "2672: static void",
          "",
          "[Removed Lines]",
          "2669:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "2669:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2854:     }",
          "2855:     return;",
          "2856: trunc:",
          "2858: }",
          "2860: static void",
          "",
          "[Removed Lines]",
          "2857:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "2857:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2973:     return;",
          "2974: trunc:",
          "2976: }",
          "2978: static void",
          "",
          "[Removed Lines]",
          "2975:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "2975:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "3005:     return;",
          "3006: trunc:",
          "3008: }",
          "3010: static int",
          "",
          "[Removed Lines]",
          "3007:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "3007:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "3047:     }",
          "3048:     return 1;",
          "3049: trunc:",
          "3051:     return 0;",
          "3052: }",
          "",
          "[Removed Lines]",
          "3050:     ND_PRINT(\"[|BGP]\");",
          "",
          "[Added Lines]",
          "3050:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "3093:         bgp_header = (const struct bgp *)p;",
          "3095:         if (start != p)",
          "3098:         hlen = EXTRACT_BE_U_2(bgp_header->bgp_len);",
          "3099:         if (hlen < BGP_SIZE) {",
          "",
          "[Removed Lines]",
          "3096:             ND_PRINT(\" [|BGP]\");",
          "",
          "[Added Lines]",
          "3096:             nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "3119:     return;",
          "3121: trunc:",
          "3123: }",
          "",
          "[Removed Lines]",
          "3122:     ND_PRINT(\" [|BGP]\");",
          "",
          "[Added Lines]",
          "3122:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-eap.c||print-eap.c": [
          "File: print-eap.c -> print-eap.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "296:     return;",
          "298:  trunc:",
          "300: }",
          "",
          "[Removed Lines]",
          "299:     ND_PRINT(\"\\n\\t[|EAP]\");",
          "",
          "[Added Lines]",
          "299:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-esp.c||print-esp.c": [
          "File: print-esp.c -> print-esp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "687:  ep = ndo->ndo_snapend;",
          "689:  if ((const u_char *)(esp + 1) >= ep) {",
          "691:   goto fail;",
          "692:  }",
          "693:  ND_PRINT(\"ESP(spi=0x%08x\", EXTRACT_BE_U_4(esp->esp_spi));",
          "",
          "[Removed Lines]",
          "690:   ND_PRINT(\"[|ESP]\");",
          "",
          "[Added Lines]",
          "690:   nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-hncp.c||print-hncp.c": [
          "File: print-hncp.c -> print-hncp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "857:     return;",
          "859:  trunc:",
          "861:     return;",
          "863:  invalid:",
          "",
          "[Removed Lines]",
          "860:     ND_PRINT(\"%s\", \"[|hncp]\");",
          "",
          "[Added Lines]",
          "860:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-ip6opts.c||print-ip6opts.c": [
          "File: print-ip6opts.c -> print-ip6opts.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "187:     return(hbhlen);",
          "189:   trunc:",
          "191:     return(-1);",
          "192: }",
          "",
          "[Removed Lines]",
          "190:     ND_PRINT(\"[|HBH]\");",
          "",
          "[Added Lines]",
          "190:     nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "210:     return(dstoptlen);",
          "212:   trunc:",
          "214:     return(-1);",
          "215: }",
          "",
          "[Removed Lines]",
          "213:     ND_PRINT(\"[|DSTOPT]\");",
          "",
          "[Added Lines]",
          "213:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-ipcomp.c||print-ipcomp.c": [
          "File: print-ipcomp.c -> print-ipcomp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "65:  return;",
          "67: trunc:",
          "69:  return;",
          "70: }",
          "",
          "[Removed Lines]",
          "68:  ND_PRINT(\"[|IPCOMP]\");",
          "",
          "[Added Lines]",
          "68:  nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-lldp.c||print-lldp.c": [
          "File: print-lldp.c -> print-lldp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1663:     }",
          "1664:     return;",
          "1665:  trunc:",
          "1667: }",
          "",
          "[Removed Lines]",
          "1666:     ND_PRINT(\"\\n\\t[|LLDP]\");",
          "",
          "[Added Lines]",
          "1666:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-mpcp.c||print-mpcp.c": [
          "File: print-mpcp.c -> print-mpcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:     return;",
          "249: trunc:",
          "251: }",
          "",
          "[Removed Lines]",
          "250:     ND_PRINT(\"\\n\\t[|MPCP]\");",
          "",
          "[Added Lines]",
          "250:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-mpls.c||print-mpls.c": [
          "File: print-mpls.c -> print-mpls.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "211:  return;",
          "213: trunc:",
          "215: }",
          "",
          "[Removed Lines]",
          "214:  ND_PRINT(\"[|MPLS]\");",
          "",
          "[Added Lines]",
          "214:  nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-otv.c||print-otv.c": [
          "File: print-otv.c -> print-otv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:     return;",
          "73: trunc:",
          "75: }",
          "",
          "[Removed Lines]",
          "74:     ND_PRINT(\" [|OTV]\");",
          "",
          "[Added Lines]",
          "74:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-pgm.c||print-pgm.c": [
          "File: print-pgm.c -> print-pgm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "430:      if (!ND_TTEST_LEN(bp, PGM_MIN_OPT_LEN)) {",
          "432:   return;",
          "433:      }",
          "",
          "[Removed Lines]",
          "431:   ND_PRINT(\"[|OPT]\");",
          "",
          "[Added Lines]",
          "431:   nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "463:       return;",
          "464:   }",
          "465:   if (!ND_TTEST_2(bp)) {",
          "467:       return;",
          "468:   }",
          "469:   opt_type = EXTRACT_U_1(bp);",
          "",
          "[Removed Lines]",
          "466:       ND_PRINT(\" [|OPT]\");",
          "",
          "[Added Lines]",
          "466:       nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "480:       return;",
          "481:   }",
          "482:   if (!ND_TTEST_LEN(bp, opt_len - 2)) {",
          "484:       return;",
          "485:   }",
          "",
          "[Removed Lines]",
          "483:       ND_PRINT(\" [|OPT]\");",
          "",
          "[Added Lines]",
          "483:       nd_print_trunc(ndo);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "840:  return;",
          "842: trunc:",
          "844:  if (ch != '\\0')",
          "845:   ND_PRINT(\">\");",
          "846: }",
          "",
          "[Removed Lines]",
          "843:  ND_PRINT(\"[|pgm]\");",
          "",
          "[Added Lines]",
          "843:  nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-sflow.c||print-sflow.c": [
          "File: print-sflow.c -> print-sflow.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "971:     return;",
          "973:  trunc:",
          "975: }",
          "",
          "[Removed Lines]",
          "974:     ND_PRINT(\"[|SFLOW]\");",
          "",
          "[Added Lines]",
          "974:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ],
        "print-vqp.c||print-vqp.c": [
          "File: print-vqp.c -> print-vqp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "208:     }",
          "209:     return;",
          "210: trunc:",
          "212: }",
          "",
          "[Removed Lines]",
          "211:     ND_PRINT(\"\\n\\t[|VQP]\");",
          "",
          "[Added Lines]",
          "211:     nd_print_trunc(ndo);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bdad75a862a8b954ad872d5f8cec10f3385f7c17",
      "candidate_info": {
        "commit_hash": "bdad75a862a8b954ad872d5f8cec10f3385f7c17",
        "repo": "the-tcpdump-group/tcpdump",
        "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/bdad75a862a8b954ad872d5f8cec10f3385f7c17",
        "files": [
          "print-krb.c",
          "print-pgm.c"
        ],
        "message": "Replace some ND_TTEST_*() with ND_TCHECK_*()",
        "before_after_code_files": [
          "print-krb.c||print-krb.c",
          "print-pgm.c||print-pgm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "print-pgm.c||print-pgm.c"
          ],
          "candidate": [
            "print-pgm.c||print-pgm.c"
          ]
        }
      },
      "candidate_diff": {
        "print-krb.c||print-krb.c": [
          "File: print-krb.c -> print-krb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "169:  kp = (const struct krb *)cp;",
          "176:  type = EXTRACT_U_1(kp->type) & (0xFF << 1);",
          "",
          "[Removed Lines]",
          "171:  if (!ND_TTEST_1(kp->type)) {",
          "172:   nd_print_trunc(ndo);",
          "173:   return;",
          "174:  }",
          "",
          "[Added Lines]",
          "171:  ND_TCHECK_1(kp->type);",
          "",
          "---------------"
        ],
        "print-pgm.c||print-pgm.c": [
          "File: print-pgm.c -> print-pgm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "429:      if (!ND_TTEST_LEN(bp, PGM_MIN_OPT_LEN)) {",
          "430:   nd_print_trunc(ndo);",
          "431:   return;",
          "432:      }",
          "",
          "[Added Lines]",
          "429:      ND_TCHECK_LEN(bp, PGM_MIN_OPT_LEN);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "461:       ND_PRINT(\"[Total option length leaves no room for final option]\");",
          "462:       return;",
          "463:   }",
          "468:   opt_type = EXTRACT_U_1(bp);",
          "469:   bp++;",
          "470:   opt_len = EXTRACT_U_1(bp);",
          "",
          "[Removed Lines]",
          "464:   if (!ND_TTEST_2(bp)) {",
          "465:       nd_print_trunc(ndo);",
          "466:       return;",
          "467:   }",
          "",
          "[Added Lines]",
          "461:   ND_TCHECK_2(bp);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "478:       ND_PRINT(\"[Total option length leaves no room for final option]\");",
          "479:       return;",
          "480:   }",
          "486:   switch (opt_type & PGM_OPT_MASK) {",
          "487:   case PGM_OPT_LENGTH:",
          "",
          "[Removed Lines]",
          "481:   if (!ND_TTEST_LEN(bp, opt_len - 2)) {",
          "482:       nd_print_trunc(ndo);",
          "483:       return;",
          "484:   }",
          "",
          "[Added Lines]",
          "475:   ND_TCHECK_LEN(bp, opt_len - 2);",
          "",
          "---------------"
        ]
      }
    }
  ]
}