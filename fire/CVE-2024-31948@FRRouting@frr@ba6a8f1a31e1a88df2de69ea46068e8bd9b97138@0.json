{
  "cve_id": "CVE-2024-31948",
  "cve_desc": "In FRRouting (FRR) through 9.1, an attacker using a malformed Prefix SID attribute in a BGP UPDATE packet can cause the bgpd daemon to crash.",
  "repo": "FRRouting/frr",
  "patch_hash": "ba6a8f1a31e1a88df2de69ea46068e8bd9b97138",
  "patch_info": {
    "commit_hash": "ba6a8f1a31e1a88df2de69ea46068e8bd9b97138",
    "repo": "FRRouting/frr",
    "commit_url": "https://github.com/FRRouting/frr/commit/ba6a8f1a31e1a88df2de69ea46068e8bd9b97138",
    "files": [
      "bgpd/bgp_attr.c"
    ],
    "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>",
    "before_after_code_files": [
      "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
    ]
  },
  "patch_diff": {
    "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
      "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1398:  case BGP_ATTR_AS4_AGGREGATOR:",
      "1399:  case BGP_ATTR_AGGREGATOR:",
      "1400:  case BGP_ATTR_ATOMIC_AGGREGATE:",
      "1401:   return BGP_ATTR_PARSE_PROCEED;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1401:  case BGP_ATTR_PREFIX_SID:",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3163:  struct attr *const attr = args->attr;",
      "3164:  enum bgp_attr_parse_ret ret;",
      "3168:  uint8_t type;",
      "3169:  uint16_t length;",
      "3170:  size_t headersz = sizeof(type) + sizeof(length);",
      "",
      "[Removed Lines]",
      "3166:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "3214:   }",
      "3215:  }",
      "3217:  return BGP_ATTR_PARSE_PROCEED;",
      "3218: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3216:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0486f4f04dd1338dbfb5fb1cb4ae09d4be8f11ae",
      "candidate_info": {
        "commit_hash": "0486f4f04dd1338dbfb5fb1cb4ae09d4be8f11ae",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/0486f4f04dd1338dbfb5fb1cb4ae09d4be8f11ae",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit ba6a8f1a31e1a88df2de69ea46068e8bd9b97138)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1384:  case BGP_ATTR_AS4_AGGREGATOR:",
          "1385:  case BGP_ATTR_AGGREGATOR:",
          "1386:  case BGP_ATTR_ATOMIC_AGGREGATE:",
          "1387:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1387:  case BGP_ATTR_PREFIX_SID:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3108:  struct attr *const attr = args->attr;",
          "3109:  enum bgp_attr_parse_ret ret;",
          "3113:  uint8_t type;",
          "3114:  uint16_t length;",
          "3115:  size_t headersz = sizeof(type) + sizeof(length);",
          "",
          "[Removed Lines]",
          "3111:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3159:   }",
          "3160:  }",
          "3162:  return BGP_ATTR_PARSE_PROCEED;",
          "3163: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3161:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1cf60e53a4c841f179f9a7ebc79e810dcd15056f",
      "candidate_info": {
        "commit_hash": "1cf60e53a4c841f179f9a7ebc79e810dcd15056f",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/1cf60e53a4c841f179f9a7ebc79e810dcd15056f",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit ba6a8f1a31e1a88df2de69ea46068e8bd9b97138)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1390:  case BGP_ATTR_AS4_AGGREGATOR:",
          "1391:  case BGP_ATTR_AGGREGATOR:",
          "1392:  case BGP_ATTR_ATOMIC_AGGREGATE:",
          "1393:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1393:  case BGP_ATTR_PREFIX_SID:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3144:  struct attr *const attr = args->attr;",
          "3145:  enum bgp_attr_parse_ret ret;",
          "3149:  uint8_t type;",
          "3150:  uint16_t length;",
          "3151:  size_t headersz = sizeof(type) + sizeof(length);",
          "",
          "[Removed Lines]",
          "3147:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3195:   }",
          "3196:  }",
          "3198:  return BGP_ATTR_PARSE_PROCEED;",
          "3199: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3197:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9b0d3e7ce4ff1e4ed70639f49b8da583c20b41cc",
      "candidate_info": {
        "commit_hash": "9b0d3e7ce4ff1e4ed70639f49b8da583c20b41cc",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/9b0d3e7ce4ff1e4ed70639f49b8da583c20b41cc",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit ba6a8f1a31e1a88df2de69ea46068e8bd9b97138)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1285:  case BGP_ATTR_AS4_AGGREGATOR:",
          "1286:  case BGP_ATTR_AGGREGATOR:",
          "1287:  case BGP_ATTR_ATOMIC_AGGREGATE:",
          "1288:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1288:  case BGP_ATTR_PREFIX_SID:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2918:  struct attr *const attr = args->attr;",
          "2919:  enum bgp_attr_parse_ret ret;",
          "2923:  uint8_t type;",
          "2924:  uint16_t length;",
          "2925:  size_t headersz = sizeof(type) + sizeof(length);",
          "",
          "[Removed Lines]",
          "2921:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2969:   }",
          "2970:  }",
          "2972:  return BGP_ATTR_PARSE_PROCEED;",
          "2973: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2971:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81b536bff94cb44f3ae726e83b041faa9e203654",
      "candidate_info": {
        "commit_hash": "81b536bff94cb44f3ae726e83b041faa9e203654",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/81b536bff94cb44f3ae726e83b041faa9e203654",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit ba6a8f1a31e1a88df2de69ea46068e8bd9b97138)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1391:  case BGP_ATTR_AS4_AGGREGATOR:",
          "1392:  case BGP_ATTR_AGGREGATOR:",
          "1393:  case BGP_ATTR_ATOMIC_AGGREGATE:",
          "1394:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1394:  case BGP_ATTR_PREFIX_SID:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3144:  struct attr *const attr = args->attr;",
          "3145:  enum bgp_attr_parse_ret ret;",
          "3149:  uint8_t type;",
          "3150:  uint16_t length;",
          "3151:  size_t headersz = sizeof(type) + sizeof(length);",
          "",
          "[Removed Lines]",
          "3147:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3195:   }",
          "3196:  }",
          "3198:  return BGP_ATTR_PARSE_PROCEED;",
          "3199: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3197:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "51679e4504546584d98673b76ed8e12a8bc74fe0",
      "candidate_info": {
        "commit_hash": "51679e4504546584d98673b76ed8e12a8bc74fe0",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/51679e4504546584d98673b76ed8e12a8bc74fe0",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Fix error handling when receiving BGP Prefix SID attribute\n\nWithout this patch, we always set the BGP Prefix SID attribute flag without\nchecking if it's malformed or not. RFC8669 says that this attribute MUST be discarded.\n\nAlso, this fixes the bgpd crash when a malformed Prefix SID attribute is received,\nwith malformed transitive flags and/or TLVs.\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit ba6a8f1a31e1a88df2de69ea46068e8bd9b97138)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1400:  case BGP_ATTR_AS4_AGGREGATOR:",
          "1401:  case BGP_ATTR_AGGREGATOR:",
          "1402:  case BGP_ATTR_ATOMIC_AGGREGATE:",
          "1403:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1403:  case BGP_ATTR_PREFIX_SID:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3146:  struct attr *const attr = args->attr;",
          "3147:  enum bgp_attr_parse_ret ret;",
          "3151:  uint8_t type;",
          "3152:  uint16_t length;",
          "3153:  size_t headersz = sizeof(type) + sizeof(length);",
          "",
          "[Removed Lines]",
          "3149:  attr->flag |= ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3197:   }",
          "3198:  }",
          "3200:  return BGP_ATTR_PARSE_PROCEED;",
          "3201: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3199:  SET_FLAG(attr->flag, ATTR_FLAG_BIT(BGP_ATTR_PREFIX_SID));",
          "",
          "---------------"
        ]
      }
    }
  ]
}