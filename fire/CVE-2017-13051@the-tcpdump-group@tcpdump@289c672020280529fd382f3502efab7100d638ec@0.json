{
  "cve_id": "CVE-2017-13051",
  "cve_desc": "The RSVP parser in tcpdump before 4.9.2 has a buffer over-read in print-rsvp.c:rsvp_obj_print().",
  "repo": "the-tcpdump-group/tcpdump",
  "patch_hash": "289c672020280529fd382f3502efab7100d638ec",
  "patch_info": {
    "commit_hash": "289c672020280529fd382f3502efab7100d638ec",
    "repo": "the-tcpdump-group/tcpdump",
    "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/289c672020280529fd382f3502efab7100d638ec",
    "files": [
      "print-rsvp.c",
      "tests/TESTLIST",
      "tests/rsvp_uni-oobr-1.out",
      "tests/rsvp_uni-oobr-1.pcap",
      "tests/rsvp_uni-oobr-2.out",
      "tests/rsvp_uni-oobr-2.pcap",
      "tests/rsvp_uni-oobr-3.out",
      "tests/rsvp_uni-oobr-3.pcap"
    ],
    "message": "CVE-2017-13051/RSVP: fix bounds checks for UNI\n\nFixup the part of rsvp_obj_print() that decodes the GENERALIZED_UNI\nobject from RFC 3476 Section 3.1 to check the sub-objects inside that\nobject more thoroughly.\n\nThis fixes a buffer over-read discovered by Bhargava Shastry,\nSecT/TU Berlin.\n\nAdd a test using the capture file supplied by the reporter(s).",
    "before_after_code_files": [
      "print-rsvp.c||print-rsvp.c"
    ]
  },
  "patch_diff": {
    "print-rsvp.c||print-rsvp.c": [
      "File: print-rsvp.c -> print-rsvp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1206:   total_subobj_len = obj_tlen;",
      "1207:                 while(total_subobj_len > 0) {",
      "1208:                     subobj_len  = EXTRACT_16BITS(obj_tptr);",
      "1209:                     subobj_type = (EXTRACT_16BITS(obj_tptr+2))>>8;",
      "1210:                     af = (EXTRACT_16BITS(obj_tptr+2))&0x00FF;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1217:                     if (total_subobj_len < 4)",
      "1218:                         goto invalid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1216:                            tok2str(af_values, \"Unknown\", af), af,",
      "1217:                            subobj_len));",
      "1220:                         goto invalid;",
      "1222:                     switch(subobj_type) {",
      "",
      "[Removed Lines]",
      "1219:                     if(subobj_len == 0)",
      "",
      "[Added Lines]",
      "1236:                     if(subobj_len < 4 || subobj_len > total_subobj_len)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "32d1d15c5412b3a708ae2b45ed2016bdab9bb58b",
      "candidate_info": {
        "commit_hash": "32d1d15c5412b3a708ae2b45ed2016bdab9bb58b",
        "repo": "the-tcpdump-group/tcpdump",
        "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/32d1d15c5412b3a708ae2b45ed2016bdab9bb58b",
        "files": [
          "print-rsvp.c"
        ],
        "message": "Use nd_ types, add EXTRACT_ calls.",
        "before_after_code_files": [
          "print-rsvp.c||print-rsvp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "print-rsvp.c||print-rsvp.c"
          ],
          "candidate": [
            "print-rsvp.c||print-rsvp.c"
          ]
        }
      },
      "candidate_diff": {
        "print-rsvp.c||print-rsvp.c": [
          "File: print-rsvp.c -> print-rsvp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "48: struct rsvp_common_header {",
          "55: };",
          "",
          "[Removed Lines]",
          "49:     uint8_t version_flags;",
          "50:     uint8_t msg_type;",
          "51:     uint8_t checksum[2];",
          "52:     uint8_t ttl;",
          "53:     uint8_t reserved;",
          "54:     uint8_t length[2];",
          "",
          "[Added Lines]",
          "51:     nd_uint8_t  version_flags;",
          "52:     nd_uint8_t  msg_type;",
          "53:     nd_uint16_t checksum;",
          "54:     nd_uint8_t  ttl;",
          "55:     nd_byte     reserved[1];",
          "56:     nd_uint16_t length;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71: struct rsvp_object_header {",
          "75: };",
          "77: #define RSVP_VERSION            1",
          "",
          "[Removed Lines]",
          "72:     uint8_t length[2];",
          "73:     uint8_t class_num;",
          "74:     uint8_t ctype;",
          "",
          "[Added Lines]",
          "74:     nd_uint16_t length;",
          "75:     nd_uint8_t  class_num;",
          "76:     nd_uint8_t  ctype;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "670:         const struct rsvp_obj_frr_t *rsvp_obj_frr;",
          "671:     } obj_ptr;",
          "674:     u_int intserv_serv_tlen;",
          "676:     union {",
          "677:  float f;",
          "678:  uint32_t i;",
          "",
          "[Removed Lines]",
          "673:     u_short rsvp_obj_len,rsvp_obj_ctype,obj_tlen;",
          "675:     int hexdump,processed,padbytes,error_code,error_value,i,sigcheck;",
          "",
          "[Added Lines]",
          "675:     u_short rsvp_obj_len,rsvp_obj_ctype,rsvp_obj_class_num,obj_tlen;",
          "677:     int hexdump;",
          "678:     u_int processed,padbytes,error_code,error_value,i,sigcheck;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "688:         rsvp_obj_header = (const struct rsvp_object_header *)tptr;",
          "689:         rsvp_obj_len=EXTRACT_BE_U_2(rsvp_obj_header->length);",
          "692:         if(rsvp_obj_len % 4) {",
          "693:             ND_PRINT((ndo, \"%sERROR: object header size %u not a multiple of 4\", indent, rsvp_obj_len));",
          "",
          "[Removed Lines]",
          "690:         rsvp_obj_ctype=rsvp_obj_header->ctype;",
          "",
          "[Added Lines]",
          "693:         rsvp_obj_ctype=EXTRACT_U_1(rsvp_obj_header->ctype);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "699:             return -1;",
          "700:         }",
          "702:         ND_PRINT((ndo, \"%s%s Object (%u) Flags: [%s\",",
          "703:                indent,",
          "704:                tok2str(rsvp_obj_values,",
          "705:                        \"Unknown\",",
          "714:         ND_PRINT((ndo, \" if unknown], Class-Type: %s (%u), length: %u\",",
          "715:                tok2str(rsvp_ctype_values,",
          "716:                        \"Unknown\",",
          "718:                rsvp_obj_ctype,",
          "719:                rsvp_obj_len));",
          "",
          "[Removed Lines]",
          "706:                        rsvp_obj_header->class_num),",
          "707:                rsvp_obj_header->class_num,",
          "708:                ((rsvp_obj_header->class_num) & 0x80) ? \"ignore\" : \"reject\"));",
          "710:         if (rsvp_obj_header->class_num > 128)",
          "711:             ND_PRINT((ndo, \" %s\",",
          "712:                    ((rsvp_obj_header->class_num) & 0x40) ? \"and forward\" : \"silently\"));",
          "717:                        ((rsvp_obj_header->class_num)<<8)+rsvp_obj_ctype),",
          "",
          "[Added Lines]",
          "705:         rsvp_obj_class_num = EXTRACT_U_1(rsvp_obj_header->class_num);",
          "710:                        rsvp_obj_class_num),",
          "711:                rsvp_obj_class_num,",
          "712:                (rsvp_obj_class_num & 0x80) ?",
          "713:                    ((rsvp_obj_class_num & 0x40) ? \"ignore and forward\" :",
          "714:                                          \"ignore silently\") :",
          "715:                    \"reject\"));",
          "720:                        (rsvp_obj_class_num<<8)+rsvp_obj_ctype),",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "731:             return -1;",
          "732:         hexdump=FALSE;",
          "735:         case RSVP_OBJ_SESSION:",
          "736:             switch(rsvp_obj_ctype) {",
          "737:             case RSVP_CTYPE_IPV4:",
          "",
          "[Removed Lines]",
          "734:         switch(rsvp_obj_header->class_num) {",
          "",
          "[Added Lines]",
          "737:         switch(rsvp_obj_class_num) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1078:                                    \"Unknown %u\",",
          "1079:                                    RSVP_OBJ_XRO_MASK_SUBOBJ(EXTRACT_U_1(obj_tptr))),",
          "1080:                            length));",
          "1083:                         ND_PRINT((ndo, \"%s  ERROR: zero length ERO subtype\", indent));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1084:                     if (obj_tlen < length) {",
          "1085:                         ND_PRINT((ndo, \"%s  ERROR: ERO subobject length > object length\", indent));",
          "1086:                         break;",
          "1087:                     };",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1124:                                EXTRACT_U_1((obj_tptr + 3)),",
          "1125:                                EXTRACT_BE_U_4(obj_tptr + 4)));",
          "1126:                     }",
          "1129:                 }",
          "1130:                 break;",
          "1131:             default:",
          "",
          "[Removed Lines]",
          "1127:                     obj_tlen-=EXTRACT_U_1(obj_tptr + 1);",
          "1128:                     obj_tptr+=EXTRACT_U_1(obj_tptr + 1);",
          "",
          "[Added Lines]",
          "1134:                     obj_tlen-=length;",
          "1135:                     obj_tptr+=length;",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1187:                                   \"none\",",
          "1188:                                   EXTRACT_U_1((obj_tptr + 2))),",
          "1189:                        EXTRACT_U_1(obj_tptr + 2)));",
          "1192:                 break;",
          "1193:             default:",
          "1194:                 hexdump=TRUE;",
          "",
          "[Removed Lines]",
          "1190:                 obj_tlen-=4+EXTRACT_U_1((obj_tptr + 3));",
          "1191:                 obj_tptr+=4+EXTRACT_U_1((obj_tptr + 3));",
          "",
          "[Added Lines]",
          "1197:                 obj_tlen-=4+namelen;",
          "1198:                 obj_tptr+=4+namelen;",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1198:  case RSVP_OBJ_GENERALIZED_UNI:",
          "1199:             switch(rsvp_obj_ctype) {",
          "1202:             case RSVP_CTYPE_1:",
          "",
          "[Removed Lines]",
          "1200:   int subobj_type,af,subobj_len,total_subobj_len;",
          "",
          "[Added Lines]",
          "1207:   u_int subobj_type,af,subobj_len,total_subobj_len;",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1239:                         goto invalid;",
          "1241:                     switch(subobj_type) {",
          "",
          "[Removed Lines]",
          "1238:                     if(subobj_len < 4 || subobj_len > total_subobj_len)",
          "",
          "[Added Lines]",
          "1265:                     if(subobj_len < 4 || subobj_len > total_subobj_len ||",
          "1266:                        obj_tlen < subobj_len)",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1265:                         break;",
          "1267:                     case RSVP_GEN_UNI_SUBOBJ_DIVERSITY:",
          "1270:                             hexdump=TRUE;",
          "1271:                         }",
          "",
          "[Removed Lines]",
          "1268:                         if (subobj_len) {",
          "",
          "[Added Lines]",
          "1296:                         if (subobj_len > 4) {",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1651:                            tok2str(rsvp_obj_prop_tlv_values,\"unknown\",EXTRACT_U_1(obj_tptr)),",
          "1652:                            EXTRACT_U_1(obj_tptr),",
          "1653:                            EXTRACT_U_1(obj_tptr + 1)));",
          "1655:                         return-1;",
          "1656:                     if (EXTRACT_U_1(obj_tptr + 1) < 2)",
          "1657:                         return -1;",
          "",
          "[Removed Lines]",
          "1654:                     if (obj_tlen < EXTRACT_U_1((obj_tptr + 1)))",
          "",
          "[Added Lines]",
          "1682:                     if (obj_tlen < EXTRACT_U_1(obj_tptr + 1))",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1853:            const u_char *pptr, u_int len)",
          "1854: {",
          "1855:     const struct rsvp_common_header *rsvp_com_header;",
          "1856:     const u_char *tptr;",
          "1857:     u_short plen, tlen;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1884:     uint8_t version_flags, msg_type;",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1861:     rsvp_com_header = (const struct rsvp_common_header *)pptr;",
          "1862:     ND_TCHECK(*rsvp_com_header);",
          "1868:  ND_PRINT((ndo, \"ERROR: RSVP version %u packet not supported\",",
          "1870:  return;",
          "1871:     }",
          "1874:     if (ndo->ndo_vflag < 1) {",
          "1875:         ND_PRINT((ndo, \"RSVPv%u %s Message, length: %u\",",
          "1878:                len));",
          "1879:         return;",
          "1880:     }",
          "",
          "[Removed Lines]",
          "1867:     if (RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags) != RSVP_VERSION) {",
          "1869:                RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags)));",
          "1876:                RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags),",
          "1877:                tok2str(rsvp_msg_type_values, \"unknown (%u)\",rsvp_com_header->msg_type),",
          "",
          "[Added Lines]",
          "1892:     version_flags = EXTRACT_U_1(rsvp_com_header->version_flags);",
          "1897:     if (RSVP_EXTRACT_VERSION(version_flags) != RSVP_VERSION) {",
          "1899:                RSVP_EXTRACT_VERSION(version_flags)));",
          "1903:     msg_type = EXTRACT_U_1(rsvp_com_header->msg_type);",
          "1908:                RSVP_EXTRACT_VERSION(version_flags),",
          "1909:                tok2str(rsvp_msg_type_values, \"unknown (%u)\",msg_type),",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1884:     plen = tlen = EXTRACT_BE_U_2(rsvp_com_header->length);",
          "1886:     ND_PRINT((ndo, \"\\n\\tRSVPv%u %s Message (%u), Flags: [%s], length: %u, ttl: %u, checksum: 0x%04x\",",
          "1891:            tlen,",
          "1893:            EXTRACT_BE_U_2(rsvp_com_header->checksum)));",
          "1895:     if (tlen < sizeof(struct rsvp_common_header)) {",
          "",
          "[Removed Lines]",
          "1887:            RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags),",
          "1888:            tok2str(rsvp_msg_type_values, \"unknown, type: %u\",rsvp_com_header->msg_type),",
          "1889:            rsvp_com_header->msg_type,",
          "1890:            bittok2str(rsvp_header_flag_values,\"none\",RSVP_EXTRACT_FLAGS(rsvp_com_header->version_flags)),",
          "1892:            rsvp_com_header->ttl,",
          "",
          "[Added Lines]",
          "1919:            RSVP_EXTRACT_VERSION(version_flags),",
          "1920:            tok2str(rsvp_msg_type_values, \"unknown, type: %u\",msg_type),",
          "1921:            msg_type,",
          "1922:            bittok2str(rsvp_header_flag_values,\"none\",RSVP_EXTRACT_FLAGS(version_flags)),",
          "1924:            EXTRACT_U_1(rsvp_com_header->ttl),",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1901:     tptr+=sizeof(struct rsvp_common_header);",
          "1902:     tlen-=sizeof(struct rsvp_common_header);",
          "1906:     case RSVP_MSGTYPE_BUNDLE:",
          "",
          "[Removed Lines]",
          "1904:     switch(rsvp_com_header->msg_type) {",
          "",
          "[Added Lines]",
          "1936:     switch(msg_type) {",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "1918:             rsvp_com_header = (const struct rsvp_common_header *)subpptr;",
          "1919:             ND_TCHECK(*rsvp_com_header);",
          "1925:                 ND_PRINT((ndo, \"ERROR: RSVP version %u packet not supported\",",
          "1927:                 return;",
          "1928:             }",
          "1930:             subplen = subtlen = EXTRACT_BE_U_2(rsvp_com_header->length);",
          "1932:             ND_PRINT((ndo, \"\\n\\t  RSVPv%u %s Message (%u), Flags: [%s], length: %u, ttl: %u, checksum: 0x%04x\",",
          "1937:                    subtlen,",
          "1939:                    EXTRACT_BE_U_2(rsvp_com_header->checksum)));",
          "1941:             if (subtlen < sizeof(struct rsvp_common_header)) {",
          "",
          "[Removed Lines]",
          "1924:             if (RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags) != RSVP_VERSION) {",
          "1926:                        RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags)));",
          "1933:                    RSVP_EXTRACT_VERSION(rsvp_com_header->version_flags),",
          "1934:                    tok2str(rsvp_msg_type_values, \"unknown, type: %u\",rsvp_com_header->msg_type),",
          "1935:                    rsvp_com_header->msg_type,",
          "1936:                    bittok2str(rsvp_header_flag_values,\"none\",RSVP_EXTRACT_FLAGS(rsvp_com_header->version_flags)),",
          "1938:                    rsvp_com_header->ttl,",
          "",
          "[Added Lines]",
          "1952:             version_flags = EXTRACT_U_1(rsvp_com_header->version_flags);",
          "1957:             if (RSVP_EXTRACT_VERSION(version_flags) != RSVP_VERSION) {",
          "1959:                        RSVP_EXTRACT_VERSION(version_flags)));",
          "1965:             msg_type = EXTRACT_U_1(rsvp_com_header->msg_type);",
          "1967:                    RSVP_EXTRACT_VERSION(version_flags),",
          "1968:                    tok2str(rsvp_msg_type_values, \"unknown, type: %u\",msg_type),",
          "1969:                    msg_type,",
          "1970:                    bittok2str(rsvp_header_flag_values,\"none\",RSVP_EXTRACT_FLAGS(version_flags)),",
          "1972:                    EXTRACT_U_1(rsvp_com_header->ttl),",
          "",
          "---------------"
        ]
      }
    }
  ]
}