{
  "cve_id": "CVE-2022-39347",
  "cve_desc": "FreeRDP is a free remote desktop protocol library and clients. Affected versions of FreeRDP are missing path canonicalization and base path check for `drive` channel. A malicious server can trick a FreeRDP based client to read files outside the shared directory. This issue has been addressed in version 2.9.0 and all users are advised to upgrade. Users unable to upgrade should not use the `/drive`, `/drives` or `+home-drive` redirection switch.",
  "repo": "FreeRDP/FreeRDP",
  "patch_hash": "027424c2c6c0991cb9c22f9511478229c9b17e5d",
  "patch_info": {
    "commit_hash": "027424c2c6c0991cb9c22f9511478229c9b17e5d",
    "repo": "FreeRDP/FreeRDP",
    "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/027424c2c6c0991cb9c22f9511478229c9b17e5d",
    "files": [
      "channels/drive/client/drive_file.c",
      "channels/drive/client/drive_file.h",
      "channels/drive/client/drive_main.c"
    ],
    "message": "Fixed path validation in drive channel\n\nCheck that canonical path is a subpath of the shared directory\n\n(cherry picked from commit 844c94e6d0438fa7bd8ff8d5513c3f69c3018b85)",
    "before_after_code_files": [
      "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c",
      "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h",
      "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c"
    ]
  },
  "patch_diff": {
    "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c": [
      "File: channels/drive/client/drive_file.c -> channels/drive/client/drive_file.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "61:  } while (0)",
      "62: #endif",
      "65: {",
      "66:  size_t i;",
      "69:  for (i = 0; i < length; i++)",
      "70:  {",
      "",
      "[Removed Lines]",
      "64: static void drive_file_fix_path(WCHAR* path)",
      "67:  size_t length = _wcslen(path);",
      "",
      "[Added Lines]",
      "64: static BOOL drive_file_fix_path(WCHAR* path, size_t length)",
      "68:  if ((length == 0) || (length > UINT32_MAX))",
      "69:   return FALSE;",
      "71:  WINPR_ASSERT(path);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "75: #ifdef WIN32",
      "77:  if ((length == 3) && (path[1] == L':') && (path[2] == L'/'))",
      "80: #else",
      "82:  if ((length == 1) && (path[0] == L'/'))",
      "85: #endif",
      "87:  if ((length > 0) && (path[length - 1] == L'/'))",
      "88:   path[length - 1] = L'\\0';",
      "89: }",
      "91: static WCHAR* drive_file_combine_fullpath(const WCHAR* base_path, const WCHAR* path,",
      "93: {",
      "103:  if (!fullpath)",
      "104:  {",
      "107:  }",
      "113:  return fullpath;",
      "114: }",
      "116: static BOOL drive_file_remove_dir(const WCHAR* path)",
      "117: {",
      "119:  BOOL ret = TRUE;",
      "125:  if (!path)",
      "126:   return FALSE;",
      "131:  if (!path_slash)",
      "132:  {",
      "",
      "[Removed Lines]",
      "78:   return;",
      "83:   return;",
      "92:                                           size_t PathLength)",
      "94:  WCHAR* fullpath;",
      "95:  size_t base_path_length;",
      "97:  if (!base_path || (!path && (PathLength > 0)))",
      "98:   return NULL;",
      "100:  base_path_length = _wcslen(base_path) * 2;",
      "101:  fullpath = (WCHAR*)calloc(1, base_path_length + PathLength + sizeof(WCHAR));",
      "105:   WLog_ERR(TAG, \"malloc failed!\");",
      "106:   return NULL;",
      "109:  CopyMemory(fullpath, base_path, base_path_length);",
      "110:  if (path)",
      "111:   CopyMemory((char*)fullpath + base_path_length, path, PathLength);",
      "112:  drive_file_fix_path(fullpath);",
      "118:  WIN32_FIND_DATAW findFileData;",
      "120:  HANDLE dir;",
      "121:  WCHAR* fullpath;",
      "122:  WCHAR* path_slash;",
      "123:  size_t base_path_length;",
      "128:  base_path_length = _wcslen(path) * 2;",
      "129:  path_slash = (WCHAR*)calloc(1, base_path_length + sizeof(WCHAR) * 3);",
      "",
      "[Added Lines]",
      "82:   return FALSE;",
      "87:   return FALSE;",
      "94:  return TRUE;",
      "98:                                           size_t PathWCharLength)",
      "100:  BOOL ok = FALSE;",
      "101:  WCHAR* fullpath = NULL;",
      "102:  size_t length;",
      "104:  if (!base_path || (!path && (PathWCharLength > 0)))",
      "105:   goto fail;",
      "107:  const size_t base_path_length = _wcsnlen(base_path, MAX_PATH);",
      "108:  length = base_path_length + PathWCharLength + 1;",
      "109:  fullpath = (WCHAR*)calloc(length, sizeof(WCHAR));",
      "112:   goto fail;",
      "114:  CopyMemory(fullpath, base_path, base_path_length * sizeof(WCHAR));",
      "115:  if (path)",
      "116:   CopyMemory(&fullpath[base_path_length], path, PathWCharLength * sizeof(WCHAR));",
      "118:  if (!drive_file_fix_path(fullpath, length))",
      "119:   goto fail;",
      "122:  const WCHAR dotdot[] = { '.', '.', '\\0' };",
      "123:  if (_wcsstr(&fullpath[base_path_length], dotdot))",
      "125:   char abuffer[MAX_PATH] = { 0 };",
      "126:   ConvertFromUnicode(CP_UTF8, 0, &fullpath[base_path_length], -1, (char**)&abuffer,",
      "127:                      ARRAYSIZE(abuffer) - 1, NULL, NULL);",
      "129:   WLog_WARN(TAG, \"[rdpdr] received invalid file path '%s' from server, aborting!\",",
      "130:             &abuffer[base_path_length]);",
      "131:   goto fail;",
      "134:  ok = TRUE;",
      "135: fail:",
      "136:  if (!ok)",
      "137:  {",
      "138:   free(fullpath);",
      "139:   fullpath = NULL;",
      "140:  }",
      "146:  WIN32_FIND_DATAW findFileData = { 0 };",
      "148:  HANDLE dir = INVALID_HANDLE_VALUE;",
      "149:  WCHAR* fullpath = NULL;",
      "150:  WCHAR* path_slash = NULL;",
      "151:  size_t base_path_length = 0;",
      "156:  base_path_length = _wcslen(path);",
      "157:  path_slash = (WCHAR*)calloc(base_path_length + 3, sizeof(WCHAR));",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "134:   return FALSE;",
      "135:  }",
      "140:  DEBUG_WSTR(\"Search in %s\", path_slash);",
      "141:  dir = FindFirstFileW(path_slash, &findFileData);",
      "144:  if (dir == INVALID_HANDLE_VALUE)",
      "145:  {",
      "",
      "[Removed Lines]",
      "137:  CopyMemory(path_slash, path, base_path_length);",
      "138:  path_slash[base_path_length / 2] = L'/';",
      "139:  path_slash[base_path_length / 2 + 1] = L'*';",
      "142:  path_slash[base_path_length / 2 + 1] = 0;",
      "",
      "[Added Lines]",
      "165:  CopyMemory(path_slash, path, base_path_length * sizeof(WCHAR));",
      "166:  path_slash[base_path_length] = L'/';",
      "167:  path_slash[base_path_length + 1] = L'*';",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "150:  do",
      "151:  {",
      "154:   if ((len == 1 && findFileData.cFileName[0] == L'.') ||",
      "155:       (len == 2 && findFileData.cFileName[0] == L'.' && findFileData.cFileName[1] == L'.'))",
      "",
      "[Removed Lines]",
      "152:   size_t len = _wcslen(findFileData.cFileName);",
      "",
      "[Added Lines]",
      "179:   const size_t len = _wcsnlen(findFileData.cFileName, ARRAYSIZE(findFileData.cFileName));",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "157:    continue;",
      "158:   }",
      "161:   DEBUG_WSTR(\"Delete %s\", fullpath);",
      "163:   if (findFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)",
      "",
      "[Removed Lines]",
      "160:   fullpath = drive_file_combine_fullpath(path_slash, findFileData.cFileName, len * 2);",
      "",
      "[Added Lines]",
      "187:   fullpath = drive_file_combine_fullpath(path_slash, findFileData.cFileName, len);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "333:  return file->file_handle != INVALID_HANDLE_VALUE;",
      "334: }",
      "339: {",
      "340:  DRIVE_FILE* file;",
      "343:   return NULL;",
      "345:  file = (DRIVE_FILE*)calloc(1, sizeof(DRIVE_FILE));",
      "",
      "[Removed Lines]",
      "336: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathLength, UINT32 id,",
      "337:                            UINT32 DesiredAccess, UINT32 CreateDisposition, UINT32 CreateOptions,",
      "338:                            UINT32 FileAttributes, UINT32 SharedAccess)",
      "342:  if (!base_path || (!path && (PathLength > 0)))",
      "",
      "[Added Lines]",
      "363: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathWCharLength,",
      "364:                            UINT32 id, UINT32 DesiredAccess, UINT32 CreateDisposition,",
      "365:                            UINT32 CreateOptions, UINT32 FileAttributes, UINT32 SharedAccess)",
      "369:  if (!base_path || (!path && (PathWCharLength > 0)))",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "359:  file->CreateDisposition = CreateDisposition;",
      "360:  file->CreateOptions = CreateOptions;",
      "361:  file->SharedAccess = SharedAccess;",
      "364:  if (!drive_file_init(file))",
      "365:  {",
      "",
      "[Removed Lines]",
      "362:  drive_file_set_fullpath(file, drive_file_combine_fullpath(base_path, path, PathLength));",
      "",
      "[Added Lines]",
      "389:  drive_file_set_fullpath(file, drive_file_combine_fullpath(base_path, path, PathWCharLength));",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "714:     return FALSE;",
      "716:    fullpath = drive_file_combine_fullpath(file->basepath, (WCHAR*)Stream_Pointer(input),",
      "719:    if (!fullpath)",
      "722:     return FALSE;",
      "725: #ifdef _WIN32",
      "",
      "[Removed Lines]",
      "717:                                           FileNameLength);",
      "720:    {",
      "721:     WLog_ERR(TAG, \"drive_file_combine_fullpath failed!\");",
      "723:    }",
      "",
      "[Added Lines]",
      "744:                                           FileNameLength / sizeof(WCHAR));",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "759: }",
      "761: BOOL drive_file_query_directory(DRIVE_FILE* file, UINT32 FsInformationClass, BYTE InitialQuery,",
      "763: {",
      "764:  size_t length;",
      "765:  WCHAR* ent_path;",
      "",
      "[Removed Lines]",
      "762:                                 const WCHAR* path, UINT32 PathLength, wStream* output)",
      "",
      "[Added Lines]",
      "786:                                 const WCHAR* path, UINT32 PathWCharLength, wStream* output)",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "773:   if (file->find_handle != INVALID_HANDLE_VALUE)",
      "774:    FindClose(file->find_handle);",
      "778:   file->find_handle = FindFirstFileW(ent_path, &file->find_data);",
      "779:   free(ent_path);",
      "",
      "[Removed Lines]",
      "776:   ent_path = drive_file_combine_fullpath(file->basepath, path, PathLength);",
      "",
      "[Added Lines]",
      "800:   ent_path = drive_file_combine_fullpath(file->basepath, path, PathWCharLength);",
      "",
      "---------------"
    ],
    "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h": [
      "File: channels/drive/client/drive_file.h -> channels/drive/client/drive_file.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:  UINT32 CreateOptions;",
      "52: };",
      "57: BOOL drive_file_free(DRIVE_FILE* file);",
      "59: BOOL drive_file_open(DRIVE_FILE* file);",
      "",
      "[Removed Lines]",
      "54: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathLength, UINT32 id,",
      "55:                            UINT32 DesiredAccess, UINT32 CreateDisposition, UINT32 CreateOptions,",
      "56:                            UINT32 FileAttributes, UINT32 SharedAccess);",
      "",
      "[Added Lines]",
      "54: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathWCharLength,",
      "55:                            UINT32 id, UINT32 DesiredAccess, UINT32 CreateDisposition,",
      "56:                            UINT32 CreateOptions, UINT32 FileAttributes, UINT32 SharedAccess);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "64: BOOL drive_file_set_information(DRIVE_FILE* file, UINT32 FsInformationClass, UINT32 Length,",
      "65:                                 wStream* input);",
      "66: BOOL drive_file_query_directory(DRIVE_FILE* file, UINT32 FsInformationClass, BYTE InitialQuery,",
      "",
      "[Removed Lines]",
      "67:                                 const WCHAR* path, UINT32 PathLength, wStream* output);",
      "",
      "[Added Lines]",
      "67:                                 const WCHAR* path, UINT32 PathWCharLength, wStream* output);",
      "",
      "---------------"
    ],
    "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c": [
      "File: channels/drive/client/drive_main.c -> channels/drive/client/drive_main.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "185:  path = (const WCHAR*)Stream_Pointer(irp->input);",
      "186:  FileId = irp->devman->id_sequence++;",
      "190:  if (!file)",
      "191:  {",
      "",
      "[Removed Lines]",
      "187:  file = drive_file_new(drive->path, path, PathLength, FileId, DesiredAccess, CreateDisposition,",
      "188:                        CreateOptions, FileAttributes, SharedAccess);",
      "",
      "[Added Lines]",
      "187:  file = drive_file_new(drive->path, path, PathLength / sizeof(WCHAR), FileId, DesiredAccess,",
      "188:                        CreateDisposition, CreateOptions, FileAttributes, SharedAccess);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "639:   irp->IoStatus = STATUS_UNSUCCESSFUL;",
      "641:  }",
      "644:  {",
      "645:   irp->IoStatus = drive_map_windows_err(GetLastError());",
      "646:  }",
      "",
      "[Removed Lines]",
      "642:  else if (!drive_file_query_directory(file, FsInformationClass, InitialQuery, path, PathLength,",
      "643:                                       irp->output))",
      "",
      "[Added Lines]",
      "642:  else if (!drive_file_query_directory(file, FsInformationClass, InitialQuery, path,",
      "643:                                       PathLength / sizeof(WCHAR), irp->output))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f60ac59884676133bd936368ac2a47d88848397",
      "candidate_info": {
        "commit_hash": "0f60ac59884676133bd936368ac2a47d88848397",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/0f60ac59884676133bd936368ac2a47d88848397",
        "files": [
          "channels/drive/client/drive_file.c",
          "channels/drive/client/drive_file.h",
          "channels/drive/client/drive_main.c"
        ],
        "message": "Fixed path validation in drive channel\n\nCheck that canonical path is a subpath of the shared directory",
        "before_after_code_files": [
          "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c",
          "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h",
          "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c",
            "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h",
            "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c"
          ],
          "candidate": [
            "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c",
            "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h",
            "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c"
          ]
        }
      },
      "candidate_diff": {
        "channels/drive/client/drive_file.c||channels/drive/client/drive_file.c": [
          "File: channels/drive/client/drive_file.c -> channels/drive/client/drive_file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "59:  } while (0)",
          "60: #endif",
          "63: {",
          "64:  size_t i;",
          "67:  for (i = 0; i < length; i++)",
          "68:  {",
          "",
          "[Removed Lines]",
          "62: static void drive_file_fix_path(WCHAR* path)",
          "65:  size_t length = _wcslen(path);",
          "",
          "[Added Lines]",
          "62: static BOOL drive_file_fix_path(WCHAR* path, size_t length)",
          "66:  if ((length == 0) || (length > UINT32_MAX))",
          "67:   return FALSE;",
          "69:  WINPR_ASSERT(path);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73: #ifdef WIN32",
          "75:  if ((length == 3) && (path[1] == L':') && (path[2] == L'/'))",
          "78: #else",
          "80:  if ((length == 1) && (path[0] == L'/'))",
          "83: #endif",
          "85:  if ((length > 0) && (path[length - 1] == L'/'))",
          "86:   path[length - 1] = L'\\0';",
          "87: }",
          "89: static WCHAR* drive_file_combine_fullpath(const WCHAR* base_path, const WCHAR* path,",
          "91: {",
          "101:  if (!fullpath)",
          "102:  {",
          "105:  }",
          "111:  return fullpath;",
          "112: }",
          "114: static BOOL drive_file_remove_dir(const WCHAR* path)",
          "115: {",
          "117:  BOOL ret = TRUE;",
          "123:  if (!path)",
          "124:   return FALSE;",
          "129:  if (!path_slash)",
          "130:  {",
          "",
          "[Removed Lines]",
          "76:   return;",
          "81:   return;",
          "90:                                           size_t PathLength)",
          "92:  WCHAR* fullpath;",
          "93:  size_t base_path_length;",
          "95:  if (!base_path || (!path && (PathLength > 0)))",
          "96:   return NULL;",
          "98:  base_path_length = _wcslen(base_path) * 2;",
          "99:  fullpath = (WCHAR*)calloc(1, base_path_length + PathLength + sizeof(WCHAR));",
          "103:   WLog_ERR(TAG, \"malloc failed!\");",
          "104:   return NULL;",
          "107:  CopyMemory(fullpath, base_path, base_path_length);",
          "108:  if (path)",
          "109:   CopyMemory((char*)fullpath + base_path_length, path, PathLength);",
          "110:  drive_file_fix_path(fullpath);",
          "116:  WIN32_FIND_DATAW findFileData;",
          "118:  HANDLE dir;",
          "119:  WCHAR* fullpath;",
          "120:  WCHAR* path_slash;",
          "121:  size_t base_path_length;",
          "126:  base_path_length = _wcslen(path) * 2;",
          "127:  path_slash = (WCHAR*)calloc(1, base_path_length + sizeof(WCHAR) * 3);",
          "",
          "[Added Lines]",
          "80:   return FALSE;",
          "85:   return FALSE;",
          "92:  return TRUE;",
          "96:                                           size_t PathWCharLength)",
          "98:  BOOL ok = FALSE;",
          "99:  WCHAR* fullpath = NULL;",
          "100:  size_t length;",
          "102:  if (!base_path || (!path && (PathWCharLength > 0)))",
          "103:   goto fail;",
          "105:  const size_t base_path_length = _wcsnlen(base_path, MAX_PATH);",
          "106:  length = base_path_length + PathWCharLength + 1;",
          "107:  fullpath = (WCHAR*)calloc(length, sizeof(WCHAR));",
          "110:   goto fail;",
          "112:  CopyMemory(fullpath, base_path, base_path_length * sizeof(WCHAR));",
          "113:  if (path)",
          "114:   CopyMemory(&fullpath[base_path_length], path, PathWCharLength * sizeof(WCHAR));",
          "116:  if (!drive_file_fix_path(fullpath, length))",
          "117:   goto fail;",
          "120:  const WCHAR dotdot[] = { '.', '.', '\\0' };",
          "121:  if (_wcsstr(&fullpath[base_path_length], dotdot))",
          "123:   char abuffer[MAX_PATH] = { 0 };",
          "124:   ConvertFromUnicode(CP_UTF8, 0, &fullpath[base_path_length], -1, (char**)&abuffer,",
          "125:                      ARRAYSIZE(abuffer) - 1, NULL, NULL);",
          "127:   WLog_WARN(TAG, \"[rdpdr] received invalid file path '%s' from server, aborting!\",",
          "128:             &abuffer[base_path_length]);",
          "129:   goto fail;",
          "132:  ok = TRUE;",
          "133: fail:",
          "134:  if (!ok)",
          "135:  {",
          "136:   free(fullpath);",
          "137:   fullpath = NULL;",
          "138:  }",
          "144:  WIN32_FIND_DATAW findFileData = { 0 };",
          "146:  HANDLE dir = INVALID_HANDLE_VALUE;",
          "147:  WCHAR* fullpath = NULL;",
          "148:  WCHAR* path_slash = NULL;",
          "149:  size_t base_path_length = 0;",
          "154:  base_path_length = _wcslen(path);",
          "155:  path_slash = (WCHAR*)calloc(base_path_length + 3, sizeof(WCHAR));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "132:   return FALSE;",
          "133:  }",
          "138:  DEBUG_WSTR(\"Search in %s\", path_slash);",
          "139:  dir = FindFirstFileW(path_slash, &findFileData);",
          "142:  if (dir == INVALID_HANDLE_VALUE)",
          "143:  {",
          "",
          "[Removed Lines]",
          "135:  CopyMemory(path_slash, path, base_path_length);",
          "136:  path_slash[base_path_length / 2] = L'/';",
          "137:  path_slash[base_path_length / 2 + 1] = L'*';",
          "140:  path_slash[base_path_length / 2 + 1] = 0;",
          "",
          "[Added Lines]",
          "163:  CopyMemory(path_slash, path, base_path_length * sizeof(WCHAR));",
          "164:  path_slash[base_path_length] = L'/';",
          "165:  path_slash[base_path_length + 1] = L'*';",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "148:  do",
          "149:  {",
          "152:   if ((len == 1 && findFileData.cFileName[0] == L'.') ||",
          "153:       (len == 2 && findFileData.cFileName[0] == L'.' && findFileData.cFileName[1] == L'.'))",
          "",
          "[Removed Lines]",
          "150:   size_t len = _wcslen(findFileData.cFileName);",
          "",
          "[Added Lines]",
          "177:   const size_t len = _wcsnlen(findFileData.cFileName, ARRAYSIZE(findFileData.cFileName));",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "155:    continue;",
          "156:   }",
          "159:   DEBUG_WSTR(\"Delete %s\", fullpath);",
          "161:   if (findFileData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)",
          "",
          "[Removed Lines]",
          "158:   fullpath = drive_file_combine_fullpath(path_slash, findFileData.cFileName, len * 2);",
          "",
          "[Added Lines]",
          "185:   fullpath = drive_file_combine_fullpath(path_slash, findFileData.cFileName, len);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "331:  return file->file_handle != INVALID_HANDLE_VALUE;",
          "332: }",
          "337: {",
          "338:  DRIVE_FILE* file;",
          "341:   return NULL;",
          "343:  file = (DRIVE_FILE*)calloc(1, sizeof(DRIVE_FILE));",
          "",
          "[Removed Lines]",
          "334: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathLength, UINT32 id,",
          "335:                            UINT32 DesiredAccess, UINT32 CreateDisposition, UINT32 CreateOptions,",
          "336:                            UINT32 FileAttributes, UINT32 SharedAccess)",
          "340:  if (!base_path || (!path && (PathLength > 0)))",
          "",
          "[Added Lines]",
          "361: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathWCharLength,",
          "362:                            UINT32 id, UINT32 DesiredAccess, UINT32 CreateDisposition,",
          "363:                            UINT32 CreateOptions, UINT32 FileAttributes, UINT32 SharedAccess)",
          "367:  if (!base_path || (!path && (PathWCharLength > 0)))",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "357:  file->CreateDisposition = CreateDisposition;",
          "358:  file->CreateOptions = CreateOptions;",
          "359:  file->SharedAccess = SharedAccess;",
          "362:  if (!drive_file_init(file))",
          "363:  {",
          "",
          "[Removed Lines]",
          "360:  drive_file_set_fullpath(file, drive_file_combine_fullpath(base_path, path, PathLength));",
          "",
          "[Added Lines]",
          "387:  drive_file_set_fullpath(file, drive_file_combine_fullpath(base_path, path, PathWCharLength));",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "799:     return FALSE;",
          "801:    fullpath = drive_file_combine_fullpath(file->basepath, (WCHAR*)Stream_Pointer(input),",
          "804:    if (!fullpath)",
          "807:     return FALSE;",
          "810: #ifdef _WIN32",
          "",
          "[Removed Lines]",
          "802:                                           FileNameLength);",
          "805:    {",
          "806:     WLog_ERR(TAG, \"drive_file_combine_fullpath failed!\");",
          "808:    }",
          "",
          "[Added Lines]",
          "829:                                           FileNameLength / sizeof(WCHAR));",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "844: }",
          "846: BOOL drive_file_query_directory(DRIVE_FILE* file, UINT32 FsInformationClass, BYTE InitialQuery,",
          "848: {",
          "849:  size_t length;",
          "850:  WCHAR* ent_path;",
          "",
          "[Removed Lines]",
          "847:                                 const WCHAR* path, UINT32 PathLength, wStream* output)",
          "",
          "[Added Lines]",
          "871:                                 const WCHAR* path, UINT32 PathWCharLength, wStream* output)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "858:   if (file->find_handle != INVALID_HANDLE_VALUE)",
          "859:    FindClose(file->find_handle);",
          "863:   file->find_handle = FindFirstFileW(ent_path, &file->find_data);",
          "864:   free(ent_path);",
          "",
          "[Removed Lines]",
          "861:   ent_path = drive_file_combine_fullpath(file->basepath, path, PathLength);",
          "",
          "[Added Lines]",
          "885:   ent_path = drive_file_combine_fullpath(file->basepath, path, PathWCharLength);",
          "",
          "---------------"
        ],
        "channels/drive/client/drive_file.h||channels/drive/client/drive_file.h": [
          "File: channels/drive/client/drive_file.h -> channels/drive/client/drive_file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:  UINT32 CreateOptions;",
          "50: } DRIVE_FILE;",
          "55: BOOL drive_file_free(DRIVE_FILE* file);",
          "57: BOOL drive_file_open(DRIVE_FILE* file);",
          "",
          "[Removed Lines]",
          "52: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathLength, UINT32 id,",
          "53:                            UINT32 DesiredAccess, UINT32 CreateDisposition, UINT32 CreateOptions,",
          "54:                            UINT32 FileAttributes, UINT32 SharedAccess);",
          "",
          "[Added Lines]",
          "52: DRIVE_FILE* drive_file_new(const WCHAR* base_path, const WCHAR* path, UINT32 PathWCharLength,",
          "53:                            UINT32 id, UINT32 DesiredAccess, UINT32 CreateDisposition,",
          "54:                            UINT32 CreateOptions, UINT32 FileAttributes, UINT32 SharedAccess);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "62: BOOL drive_file_set_information(DRIVE_FILE* file, UINT32 FsInformationClass, UINT32 Length,",
          "63:                                 wStream* input);",
          "64: BOOL drive_file_query_directory(DRIVE_FILE* file, UINT32 FsInformationClass, BYTE InitialQuery,",
          "",
          "[Removed Lines]",
          "65:                                 const WCHAR* path, UINT32 PathLength, wStream* output);",
          "",
          "[Added Lines]",
          "65:                                 const WCHAR* path, UINT32 PathWCharLength, wStream* output);",
          "",
          "---------------"
        ],
        "channels/drive/client/drive_main.c||channels/drive/client/drive_main.c": [
          "File: channels/drive/client/drive_main.c -> channels/drive/client/drive_main.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "182:  path = (const WCHAR*)Stream_Pointer(irp->input);",
          "183:  FileId = irp->devman->id_sequence++;",
          "187:  if (!file)",
          "188:  {",
          "",
          "[Removed Lines]",
          "184:  file = drive_file_new(drive->path, path, PathLength, FileId, DesiredAccess, CreateDisposition,",
          "185:                        CreateOptions, FileAttributes, SharedAccess);",
          "",
          "[Added Lines]",
          "184:  file = drive_file_new(drive->path, path, PathLength / sizeof(WCHAR), FileId, DesiredAccess,",
          "185:                        CreateDisposition, CreateOptions, FileAttributes, SharedAccess);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "636:   irp->IoStatus = STATUS_UNSUCCESSFUL;",
          "638:  }",
          "641:  {",
          "642:   irp->IoStatus = drive_map_windows_err(GetLastError());",
          "643:  }",
          "",
          "[Removed Lines]",
          "639:  else if (!drive_file_query_directory(file, FsInformationClass, InitialQuery, path, PathLength,",
          "640:                                       irp->output))",
          "",
          "[Added Lines]",
          "639:  else if (!drive_file_query_directory(file, FsInformationClass, InitialQuery, path,",
          "640:                                       PathLength / sizeof(WCHAR), irp->output))",
          "",
          "---------------"
        ]
      }
    }
  ]
}