{
  "cve_id": "CVE-2013-1915",
  "cve_desc": "ModSecurity before 2.7.3 allows remote attackers to read arbitrary files, send HTTP requests to intranet servers, or cause a denial of service (CPU and memory consumption) via an XML external entity declaration in conjunction with an entity reference, aka an XML External Entity (XXE) vulnerability.",
  "repo": "SpiderLabs/ModSecurity",
  "patch_hash": "d4d80b38aa85eccb26e3c61b04d16e8ca5de76fe",
  "patch_info": {
    "commit_hash": "d4d80b38aa85eccb26e3c61b04d16e8ca5de76fe",
    "repo": "SpiderLabs/ModSecurity",
    "commit_url": "https://github.com/SpiderLabs/ModSecurity/commit/d4d80b38aa85eccb26e3c61b04d16e8ca5de76fe",
    "files": [
      "apache2/apache2_config.c",
      "apache2/modsecurity.h",
      "apache2/msc_xml.c"
    ],
    "message": "Added SecXmlExternalEntity",
    "before_after_code_files": [
      "apache2/apache2_config.c||apache2/apache2_config.c",
      "apache2/modsecurity.h||apache2/modsecurity.h",
      "apache2/msc_xml.c||apache2/msc_xml.c"
    ]
  },
  "patch_diff": {
    "apache2/apache2_config.c||apache2/apache2_config.c": [
      "File: apache2/apache2_config.c -> apache2/apache2_config.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "156:     dcfg->crypto_hash_framesrc_pm = NOT_SET;",
      "159:     return dcfg;",
      "160: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "160:     dcfg->xml_external_entity = NOT_SET;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "591:     merged->crypto_hash_framesrc_pm = (child->crypto_hash_framesrc_pm == NOT_SET",
      "592:         ? parent->crypto_hash_framesrc_pm : child->crypto_hash_framesrc_pm);",
      "594:     return merged;",
      "595: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "598:     merged->xml_external_entity = (child->xml_external_entity == NOT_SET",
      "599:         ? parent->xml_external_entity : child->xml_external_entity);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "711:     if (dcfg->crypto_hash_iframesrc_pm == NOT_SET) dcfg->crypto_hash_iframesrc_pm = 0;",
      "712:     if (dcfg->crypto_hash_framesrc_pm == NOT_SET) dcfg->crypto_hash_framesrc_pm = 0;",
      "714: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "722:     if (dcfg->xml_external_entity == NOT_SET) dcfg->xml_external_entity = 0;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2282:     return NULL;",
      "2283: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2305: static const char *cmd_xml_external_entity(cmd_parms *cmd, void *_dcfg, const char *p1)",
      "2306: {",
      "2307:     directory_config *dcfg = (directory_config *)_dcfg;",
      "2308:     if (dcfg == NULL) return NULL;",
      "2310:     if (strcasecmp(p1, \"on\") == 0)  {",
      "2311:         dcfg->xml_external_entity = 1;",
      "2312:     }",
      "2313:     else if (strcasecmp(p1, \"off\") == 0)    {",
      "2314:         dcfg->xml_external_entity = 0;",
      "2315:     }",
      "2316:     else return apr_psprintf(cmd->pool, \"ModSecurity: Invalid value for SecXmlExternalEntity: %s\", p1);",
      "2318:     return NULL;",
      "2319: }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2306:         dcfg->hash_is_enabled = HASH_DISABLED;",
      "2307:         dcfg->hash_enforcement = HASH_DISABLED;",
      "2308:     }",
      "2311:     return NULL;",
      "2312: }",
      "",
      "[Removed Lines]",
      "2309:     else return apr_psprintf(cmd->pool, \"ModSecurity: Invalid value for SecRuleEngine: %s\", p1);",
      "",
      "[Added Lines]",
      "2345:     else return apr_psprintf(cmd->pool, \"ModSecurity: Invalid value for SexHashEngine: %s\", p1);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "3223:         \"On or Off\"",
      "3224:     ),",
      "3226:     AP_INIT_FLAG (",
      "3227:         \"SecRuleInheritance\",",
      "3228:         cmd_rule_inheritance,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3262:     AP_INIT_TAKE1 (",
      "3263:         \"SecXmlExternalEntity\",",
      "3264:         cmd_xml_external_entity,",
      "3265:         NULL,",
      "3266:         CMD_SCOPE_ANY,",
      "3267:         \"On or Off\"",
      "3268:     ),",
      "",
      "---------------"
    ],
    "apache2/modsecurity.h||apache2/modsecurity.h": [
      "File: apache2/modsecurity.h -> apache2/modsecurity.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "595:     int                 crypto_hash_location_pm;",
      "596:     int                 crypto_hash_iframesrc_pm;",
      "597:     int                 crypto_hash_framesrc_pm;",
      "598: };",
      "600: struct error_message_t {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "600:     int                 xml_external_entity;",
      "",
      "---------------"
    ],
    "apache2/msc_xml.c||apache2/msc_xml.c": [
      "File: apache2/msc_xml.c -> apache2/msc_xml.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "15: #include \"msc_xml.h\"",
      "21: int xml_init(modsec_rec *msr, char **error_msg) {",
      "22:     if (error_msg == NULL) return -1;",
      "25:     msr->xml = apr_pcalloc(msr->mp, sizeof(xml_data));",
      "26:     if (msr->xml == NULL) return -1;",
      "28:     return 1;",
      "29: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "17: static xmlParserInputBufferPtr",
      "18: xml_unload_external_entity(const char *URI, xmlCharEncoding enc)    {",
      "19:     return NULL;",
      "20: }",
      "27:     xmlParserInputBufferCreateFilenameFunc entity;",
      "35:     if(msr->txcfg->xml_external_entity == 0)    {",
      "36:         entity = xmlParserInputBufferCreateFilenameDefault(xml_unload_external_entity);",
      "37:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a5c1492049a031506552ac747a22150e8e6cf781",
      "candidate_info": {
        "commit_hash": "a5c1492049a031506552ac747a22150e8e6cf781",
        "repo": "SpiderLabs/ModSecurity",
        "commit_url": "https://github.com/SpiderLabs/ModSecurity/commit/a5c1492049a031506552ac747a22150e8e6cf781",
        "files": [
          "apache2/apache2_config.c",
          "apache2/re.c"
        ],
        "message": "[MODSEC-386] Added error msg for update target by id function",
        "before_after_code_files": [
          "apache2/apache2_config.c||apache2/apache2_config.c",
          "apache2/re.c||apache2/re.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/owasp-modsecurity/ModSecurity/pull/52"
        ],
        "olp_code_files": {
          "patch": [
            "apache2/apache2_config.c||apache2/apache2_config.c"
          ],
          "candidate": [
            "apache2/apache2_config.c||apache2/apache2_config.c"
          ]
        }
      },
      "candidate_diff": {
        "apache2/apache2_config.c||apache2/apache2_config.c": [
          "File: apache2/apache2_config.c -> apache2/apache2_config.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1959:     re->param = p1;",
          "1961:     return msre_ruleset_rule_update_target_matching_exception(NULL, dcfg->ruleset, re, p2, p3);",
          "1962: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1961:     if(dcfg->ruleset == NULL) {",
          "1962:         return apr_psprintf(cmd->pool, \"Updating target by ID with no ruleset in this context\");",
          "1963:     }",
          "",
          "---------------"
        ],
        "apache2/re.c||apache2/re.c": [
          "File: apache2/re.c -> apache2/re.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "353:                         }",
          "354: #if !defined(MSC_TEST)",
          "355:                         else {",
          "357:                         }",
          "358: #endif",
          "359:                         goto end;",
          "",
          "[Removed Lines]",
          "356:                             ap_log_error(APLOG_MARK, APLOG_ERR, 0, NULL, \" ModSecurity: Error parseing rule targets to replace variable\");",
          "",
          "[Added Lines]",
          "356:                             ap_log_error(APLOG_MARK, APLOG_ERR, 0, NULL, \" ModSecurity: Error parsing rule targets to replace variable\");",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4db1f51f3998224e21d0a7992126cc0cbc25e9da",
      "candidate_info": {
        "commit_hash": "4db1f51f3998224e21d0a7992126cc0cbc25e9da",
        "repo": "SpiderLabs/ModSecurity",
        "commit_url": "https://github.com/SpiderLabs/ModSecurity/commit/4db1f51f3998224e21d0a7992126cc0cbc25e9da",
        "files": [
          "apache2/modsecurity.h",
          "apache2/msc_multipart.c",
          "apache2/re_variables.c"
        ],
        "message": "Added MULTIPART_NAME and MULTIPART_FILENAME variables",
        "before_after_code_files": [
          "apache2/modsecurity.h||apache2/modsecurity.h",
          "apache2/msc_multipart.c||apache2/msc_multipart.c",
          "apache2/re_variables.c||apache2/re_variables.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/owasp-modsecurity/ModSecurity/pull/52"
        ],
        "olp_code_files": {
          "patch": [
            "apache2/modsecurity.h||apache2/modsecurity.h"
          ],
          "candidate": [
            "apache2/modsecurity.h||apache2/modsecurity.h"
          ]
        }
      },
      "candidate_diff": {
        "apache2/modsecurity.h||apache2/modsecurity.h": [
          "File: apache2/modsecurity.h -> apache2/modsecurity.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "356:     apr_size_t           msc_reqbody_no_files_length;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "358:     char                *multipart_filename;",
          "359:     char                *multipart_name;",
          "",
          "---------------"
        ],
        "apache2/msc_multipart.c||apache2/msc_multipart.c": [
          "File: apache2/msc_multipart.c -> apache2/msc_multipart.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "185:             validate_quotes(msr, value);",
          "187:             if (msr->mpd->mpp->name != NULL) {",
          "188:                 msr_log(msr, 4, \"Multipart: Warning: Duplicate Content-Disposition name: %s\",",
          "189:                     log_escape_nq(msr->mp, value));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "187:             msr->multipart_name = apr_pstrdup(msr->mp, value);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "202:             validate_quotes(msr, value);",
          "204:             if (msr->mpd->mpp->filename != NULL) {",
          "205:                 msr_log(msr, 4, \"Multipart: Warning: Duplicate Content-Disposition filename: %s\",",
          "206:                     log_escape_nq(msr->mp, value));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "206:             msr->multipart_filename = apr_pstrdup(msr->mp, value);",
          "",
          "---------------"
        ],
        "apache2/re_variables.c||apache2/re_variables.c": [
          "File: apache2/re_variables.c -> apache2/re_variables.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1289:     return var_simple_generate(var, vartab, mptmp, modsec_build(mptmp));",
          "1290: }",
          "1294: static int var_multipart_boundary_quoted_generate(modsec_rec *msr, msre_var *var, msre_rule *rule,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1294: static int var_multipart_filename_generate(modsec_rec *msr, msre_var *var, msre_rule *rule,",
          "1295:     apr_table_t *vartab, apr_pool_t *mptmp)",
          "1296: {",
          "1297:     return var_simple_generate(var, vartab, mptmp, msr->multipart_filename);",
          "1298: }",
          "1302: static int var_multipart_name_generate(modsec_rec *msr, msre_var *var, msre_rule *rule,",
          "1303:     apr_table_t *vartab, apr_pool_t *mptmp)",
          "1304: {",
          "1305:     return var_simple_generate(var, vartab, mptmp, msr->multipart_name);",
          "1306: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2813:         PHASE_REQUEST_HEADERS",
          "2814:     );",
          "2817:     msre_engine_variable_register(engine,",
          "2818:         \"MULTIPART_BOUNDARY_QUOTED\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2833:     msre_engine_variable_register(engine,",
          "2834:         \"MULTIPART_FILENAME\",",
          "2835:         VAR_SIMPLE,",
          "2836:         0, 0,",
          "2837:         NULL,",
          "2838:         var_multipart_filename_generate,",
          "2839:         VAR_CACHE,",
          "2840:         PHASE_REQUEST_BODY",
          "2841:     );",
          "2844:     msre_engine_variable_register(engine,",
          "2845:         \"MULTIPART_NAME\",",
          "2846:         VAR_SIMPLE,",
          "2847:         0, 0,",
          "2848:         NULL,",
          "2849:         var_multipart_name_generate,",
          "2850:         VAR_CACHE,",
          "2851:         PHASE_REQUEST_BODY",
          "2852:     );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3da87da15de9b3264672c6f04c078a7ccbc9c832",
      "candidate_info": {
        "commit_hash": "3da87da15de9b3264672c6f04c078a7ccbc9c832",
        "repo": "SpiderLabs/ModSecurity",
        "commit_url": "https://github.com/SpiderLabs/ModSecurity/commit/3da87da15de9b3264672c6f04c078a7ccbc9c832",
        "files": [
          "apache2/apache2_config.c"
        ],
        "message": "Fixed: typo",
        "before_after_code_files": [
          "apache2/apache2_config.c||apache2/apache2_config.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "apache2/apache2_config.c||apache2/apache2_config.c"
          ],
          "candidate": [
            "apache2/apache2_config.c||apache2/apache2_config.c"
          ]
        }
      },
      "candidate_diff": {
        "apache2/apache2_config.c||apache2/apache2_config.c": [
          "File: apache2/apache2_config.c -> apache2/apache2_config.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2346:         dcfg->hash_is_enabled = HASH_DISABLED;",
          "2347:         dcfg->hash_enforcement = HASH_DISABLED;",
          "2348:     }",
          "2351:     return NULL;",
          "2352: }",
          "",
          "[Removed Lines]",
          "2349:     else return apr_psprintf(cmd->pool, \"ModSecurity: Invalid value for SexHashEngine: %s\", p1);",
          "",
          "[Added Lines]",
          "2349:     else return apr_psprintf(cmd->pool, \"ModSecurity: Invalid value for SecHashEngine: %s\", p1);",
          "",
          "---------------"
        ]
      }
    }
  ]
}