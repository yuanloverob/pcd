{
  "cve_id": "CVE-2024-31950",
  "cve_desc": "In FRRouting (FRR) through 9.1, there can be a buffer overflow and daemon crash in ospf_te_parse_ri for OSPF LSA packets during an attempt to read Segment Routing subTLVs (their size is not validated).",
  "repo": "FRRouting/frr",
  "patch_hash": "6b84541df71772f697a7f9e6b2aaf72536aab775",
  "patch_info": {
    "commit_hash": "6b84541df71772f697a7f9e6b2aaf72536aab775",
    "repo": "FRRouting/frr",
    "commit_url": "https://github.com/FRRouting/frr/commit/6b84541df71772f697a7f9e6b2aaf72536aab775",
    "files": [
      "ospfd/ospf_te.c"
    ],
    "message": "ospfd: Solved crash in RI parsing with OSPF TE\n\nIggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF\nLSA packets. The crash occurs in ospf_te_parse_ri() function when attemping to\nread Segment Routing subTLVs. The original code doesn't check if the size of\nthe SR subTLVs have the correct length. In presence of erronous LSA, this will\ncause a buffer overflow and ospfd crash.\n\nThis patch introduces new verification of the subTLVs size for Router\nInformation TLV.\n\nCo-authored-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Olivier Dugeon <olivier.dugeon@orange.com>",
    "before_after_code_files": [
      "ospfd/ospf_te.c||ospfd/ospf_te.c"
    ]
  },
  "patch_diff": {
    "ospfd/ospf_te.c||ospfd/ospf_te.c": [
      "File: ospfd/ospf_te.c -> ospfd/ospf_te.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2457:   switch (ntohs(tlvh->type)) {",
      "2458:   case RI_SR_TLV_SR_ALGORITHM:",
      "2459:    algo = (struct ri_sr_tlv_sr_algorithm *)tlvh;",
      "2461:    for (int i = 0; i < ntohs(algo->header.length); i++) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2459:    if (TLV_BODY_SIZE(tlvh) < 1",
      "2460:        || TLV_BODY_SIZE(tlvh) > ALGORITHM_COUNT)",
      "2461:     break;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2480:    break;",
      "2482:   case RI_SR_TLV_SRGB_LABEL_RANGE:",
      "2483:    range = (struct ri_sr_tlv_sid_label_range *)tlvh;",
      "2484:    size = GET_RANGE_SIZE(ntohl(range->size));",
      "2485:    lower = GET_LABEL(ntohl(range->lower.value));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2486:    if (TLV_BODY_SIZE(tlvh) != RI_SR_TLV_LABEL_RANGE_SIZE)",
      "2487:     break;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2497:    break;",
      "2499:   case RI_SR_TLV_SRLB_LABEL_RANGE:",
      "2500:    range = (struct ri_sr_tlv_sid_label_range *)tlvh;",
      "2501:    size = GET_RANGE_SIZE(ntohl(range->size));",
      "2502:    lower = GET_LABEL(ntohl(range->lower.value));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2505:    if (TLV_BODY_SIZE(tlvh) != RI_SR_TLV_LABEL_RANGE_SIZE)",
      "2506:     break;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2514:    break;",
      "2516:   case RI_SR_TLV_NODE_MSD:",
      "2517:    msd = (struct ri_sr_tlv_node_msd *)tlvh;",
      "2518:    if ((CHECK_FLAG(node->flags, LS_NODE_MSD))",
      "2519:        && (node->msd == msd->value))",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2524:    if (TLV_BODY_SIZE(tlvh) < RI_SR_TLV_NODE_MSD_SIZE)",
      "2525:     break;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "64bf99d572f66cfc6394b0d58cca2f7fc9f28b12",
      "candidate_info": {
        "commit_hash": "64bf99d572f66cfc6394b0d58cca2f7fc9f28b12",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/64bf99d572f66cfc6394b0d58cca2f7fc9f28b12",
        "files": [
          "ospfd/ospf_te.c"
        ],
        "message": "ospfd: Solved crash in RI parsing with OSPF TE\n\nIggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF\nLSA packets. The crash occurs in ospf_te_parse_ri() function when attemping to\nread Segment Routing subTLVs. The original code doesn't check if the size of\nthe SR subTLVs have the correct length. In presence of erronous LSA, this will\ncause a buffer overflow and ospfd crash.\n\nThis patch introduces new verification of the subTLVs size for Router\nInformation TLV.\n\nCo-authored-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Olivier Dugeon <olivier.dugeon@orange.com>\n(cherry picked from commit f69d1313b19047d3d83fc2b36a518355b861dfc4)",
        "before_after_code_files": [
          "ospfd/ospf_te.c||ospfd/ospf_te.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ospfd/ospf_te.c||ospfd/ospf_te.c"
          ],
          "candidate": [
            "ospfd/ospf_te.c||ospfd/ospf_te.c"
          ]
        }
      },
      "candidate_diff": {
        "ospfd/ospf_te.c||ospfd/ospf_te.c": [
          "File: ospfd/ospf_te.c -> ospfd/ospf_te.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2456:   switch (ntohs(tlvh->type)) {",
          "2457:   case RI_SR_TLV_SR_ALGORITHM:",
          "2458:    algo = (struct ri_sr_tlv_sr_algorithm *)tlvh;",
          "2460:    for (int i = 0; i < ntohs(algo->header.length); i++) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2458:    if (TLV_BODY_SIZE(tlvh) < 1 ||",
          "2459:        TLV_BODY_SIZE(tlvh) > ALGORITHM_COUNT)",
          "2460:     break;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2479:    break;",
          "2481:   case RI_SR_TLV_SRGB_LABEL_RANGE:",
          "2482:    range = (struct ri_sr_tlv_sid_label_range *)tlvh;",
          "2483:    size = GET_RANGE_SIZE(ntohl(range->size));",
          "2484:    lower = GET_LABEL(ntohl(range->lower.value));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2485:    if (TLV_BODY_SIZE(tlvh) != RI_SR_TLV_LABEL_RANGE_SIZE)",
          "2486:     break;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2496:    break;",
          "2498:   case RI_SR_TLV_SRLB_LABEL_RANGE:",
          "2499:    range = (struct ri_sr_tlv_sid_label_range *)tlvh;",
          "2500:    size = GET_RANGE_SIZE(ntohl(range->size));",
          "2501:    lower = GET_LABEL(ntohl(range->lower.value));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2504:    if (TLV_BODY_SIZE(tlvh) != RI_SR_TLV_LABEL_RANGE_SIZE)",
          "2505:     break;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2513:    break;",
          "2515:   case RI_SR_TLV_NODE_MSD:",
          "2516:    msd = (struct ri_sr_tlv_node_msd *)tlvh;",
          "2517:    if ((CHECK_FLAG(node->flags, LS_NODE_MSD))",
          "2518:        && (node->msd == msd->value))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2523:    if (TLV_BODY_SIZE(tlvh) < RI_SR_TLV_NODE_MSD_SIZE)",
          "2524:     break;",
          "",
          "---------------"
        ]
      }
    }
  ]
}