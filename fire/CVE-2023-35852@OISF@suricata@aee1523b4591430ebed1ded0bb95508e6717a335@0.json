{
  "cve_id": "CVE-2023-35852",
  "cve_desc": "In Suricata before 6.0.13 (when there is an adversary who controls an external source of rules), a dataset filename, that comes from a rule, may trigger absolute or relative directory traversal, and lead to write access to a local filesystem. This is addressed in 6.0.13 by requiring allow-absolute-filenames and allow-write (in the datasets rules configuration section) if an installation requires traversal/writing in this situation.",
  "repo": "OISF/suricata",
  "patch_hash": "aee1523b4591430ebed1ded0bb95508e6717a335",
  "patch_info": {
    "commit_hash": "aee1523b4591430ebed1ded0bb95508e6717a335",
    "repo": "OISF/suricata",
    "commit_url": "https://github.com/OISF/suricata/commit/aee1523b4591430ebed1ded0bb95508e6717a335",
    "files": [
      "src/detect-dataset.c",
      "src/util-path.c",
      "src/util-path.h",
      "suricata.yaml.in"
    ],
    "message": "datasets: don't allow absolute or paths with directory traversal\n\nFor dataset filenames coming from rules, do not allow filenames that\nare absolute or contain a directory traversal with \"..\". This prevents\ndatasets from escaping the define data-directory which may allow a bad\nrule to overwrite any file that Suricata has permission to write to.\n\nAdd a new configuration option,\n\"datasets.rules.allow-absolute-filenames\" to allow absolute filenames\nin dataset rules. This will be a way to revert back to the pre 6.0.13\nbehavior where save/state rules could use any filename.\n\nTicket: #6118",
    "before_after_code_files": [
      "src/detect-dataset.c||src/detect-dataset.c",
      "src/util-path.c||src/util-path.c",
      "src/util-path.h||src/util-path.h",
      "suricata.yaml.in||suricata.yaml.in"
    ]
  },
  "patch_diff": {
    "src/detect-dataset.c||src/detect-dataset.c": [
      "File: src/detect-dataset.c -> src/detect-dataset.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "302: {",
      "303:     SCLogDebug(\"save %s\", save);",
      "307:     }",
      "",
      "[Removed Lines]",
      "305:     if (PathIsAbsolute(save)) {",
      "306:         return 0;",
      "",
      "[Added Lines]",
      "305:     int allow_absolute = 0;",
      "306:     (void)ConfGetBool(\"datasets.rules.allow-absolute-filenames\", &allow_absolute);",
      "307:     if (allow_absolute) {",
      "308:         SCLogNotice(\"Allowing absolute filename for dataset rule: %s\", save);",
      "309:     } else {",
      "310:         if (PathIsAbsolute(save)) {",
      "311:             SCLogError(SC_ERR_INVALID_ARGUMENT, \"Absolute paths not allowed: %s\", save);",
      "312:             return -1;",
      "313:         }",
      "315:         if (SCPathContainsTraversal(save)) {",
      "316:             SCLogError(SC_ERR_INVALID_ARGUMENT, \"Directory traversals not allowed: %s\", save);",
      "317:             return -1;",
      "318:         }",
      "",
      "---------------"
    ],
    "src/util-path.c||src/util-path.c": [
      "File: src/util-path.c -> src/util-path.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "248:     return final + 1;",
      "249: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "258: bool SCPathContainsTraversal(const char *path)",
      "259: {",
      "260: #ifdef OS_WIN32",
      "261:     const char *pattern = \"..\\\\\";",
      "262: #else",
      "263:     const char *pattern = \"../\";",
      "264: #endif",
      "265:     return strstr(path, pattern) != NULL;",
      "266: }",
      "",
      "---------------"
    ],
    "src/util-path.h||src/util-path.h": [
      "File: src/util-path.h -> src/util-path.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "41: bool SCIsRegularFile(const struct dirent *const dir_entry);",
      "42: char *SCRealPath(const char *path, char *resolved_path);",
      "43: const char *SCBasename(const char *path);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "44: bool SCPathContainsTraversal(const char *path);",
      "",
      "---------------"
    ],
    "suricata.yaml.in||suricata.yaml.in": [
      "File: suricata.yaml.in -> suricata.yaml.in",
      "--- Hunk 1 ---",
      "[Context before]",
      "998: #   defaults:",
      "999: #     memcap: 100mb",
      "1000: #     hashsize: 2048",
      "1002: ##############################################################################",
      "1003: ##",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1001: #",
      "1002: #  rules:",
      "1003: #    # Set to true to allow absolute filenames and filenames that use",
      "1004: #    # \"..\" components to reference parent directories in rules that specify",
      "1005: #    # their filenames.",
      "1006: #    #allow-absolute-filenames: false",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bcb9edc9b05a1528a7a2d342e366631923c029a1",
      "candidate_info": {
        "commit_hash": "bcb9edc9b05a1528a7a2d342e366631923c029a1",
        "repo": "OISF/suricata",
        "commit_url": "https://github.com/OISF/suricata/commit/bcb9edc9b05a1528a7a2d342e366631923c029a1",
        "files": [
          "suricata.yaml.in"
        ],
        "message": "config: uncomment datasets configuration\n\nUncomment the datasets configuration for easier editing by users.  The\nvalues are left commented out as their defaults.",
        "before_after_code_files": [
          "suricata.yaml.in||suricata.yaml.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "suricata.yaml.in||suricata.yaml.in"
          ],
          "candidate": [
            "suricata.yaml.in||suricata.yaml.in"
          ]
        }
      },
      "candidate_diff": {
        "suricata.yaml.in||suricata.yaml.in": [
          "File: suricata.yaml.in -> suricata.yaml.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "992: asn1-max-frames: 256",
          "994: # Datasets default settings",
          "1013: ##############################################################################",
          "1014: ##",
          "",
          "[Removed Lines]",
          "995: # datasets:",
          "996: #   # Default fallback memcap and hashsize values for datasets in case these",
          "997: #   # were not explicitly defined.",
          "998: #   defaults:",
          "999: #     memcap: 100mb",
          "1000: #     hashsize: 2048",
          "1001: #",
          "1002: #  rules:",
          "1003: #    # Set to true to allow absolute filenames and filenames that use",
          "1004: #    # \"..\" components to reference parent directories in rules that specify",
          "1005: #    # their filenames.",
          "1006: #    #allow-absolute-filenames: false",
          "1007: #",
          "1008: #    # Allow datasets in rules write access for \"save\" and",
          "1009: #    # \"state\". This is enabled by default, however write access is",
          "1010: #    # limited to the data directory.",
          "1011: #    #allow-write: true",
          "",
          "[Added Lines]",
          "995: datasets:",
          "996:   # Default fallback memcap and hashsize values for datasets in case these",
          "997:   # were not explicitly defined.",
          "998:   defaults:",
          "999:     #memcap: 100mb",
          "1000:     #hashsize: 2048",
          "1002:   rules:",
          "1003:     # Set to true to allow absolute filenames and filenames that use",
          "1004:     # \"..\" components to reference parent directories in rules that specify",
          "1005:     # their filenames.",
          "1006:     #allow-absolute-filenames: false",
          "1008:     # Allow datasets in rules write access for \"save\" and",
          "1009:     # \"state\". This is enabled by default, however write access is",
          "1010:     # limited to the data directory.",
          "1011:     #allow-write: true",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "735f5aa9ca3b28cfacc7a443f93a44387fbacf17",
      "candidate_info": {
        "commit_hash": "735f5aa9ca3b28cfacc7a443f93a44387fbacf17",
        "repo": "OISF/suricata",
        "commit_url": "https://github.com/OISF/suricata/commit/735f5aa9ca3b28cfacc7a443f93a44387fbacf17",
        "files": [
          "src/detect-dataset.c",
          "suricata.yaml.in"
        ],
        "message": "datasets: flag to disable \"write\" actions\n\nAdd a new configuration flag, \"datasets.rules.allow-write\" to control\nif rules can contain \"save\" or \"state\" rules which allow write access\nto the file system.\n\nTicket: #6123",
        "before_after_code_files": [
          "src/detect-dataset.c||src/detect-dataset.c",
          "suricata.yaml.in||suricata.yaml.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/detect-dataset.c||src/detect-dataset.c",
            "suricata.yaml.in||suricata.yaml.in"
          ],
          "candidate": [
            "src/detect-dataset.c||src/detect-dataset.c",
            "suricata.yaml.in||suricata.yaml.in"
          ]
        }
      },
      "candidate_diff": {
        "src/detect-dataset.c||src/detect-dataset.c": [
          "File: src/detect-dataset.c -> src/detect-dataset.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "302: {",
          "303:     SCLogDebug(\"save %s\", save);",
          "305:     int allow_absolute = 0;",
          "306:     (void)ConfGetBool(\"datasets.rules.allow-absolute-filenames\", &allow_absolute);",
          "307:     if (allow_absolute) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "305:     int allow_save = 1;",
          "306:     if (ConfGetBool(\"datasets.rules.allow-write\", &allow_save)) {",
          "307:         if (!allow_save) {",
          "308:             SCLogError(SC_ERR_INVALID_SIGNATURE,",
          "309:                     \"Rules containing save/state datasets have been disabled\");",
          "310:             return -1;",
          "311:         }",
          "312:     }",
          "",
          "---------------"
        ],
        "suricata.yaml.in||suricata.yaml.in": [
          "File: suricata.yaml.in -> suricata.yaml.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1004: #    # \"..\" components to reference parent directories in rules that specify",
          "1005: #    # their filenames.",
          "1006: #    #allow-absolute-filenames: false",
          "1008: ##############################################################################",
          "1009: ##",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1007: #",
          "1008: #    # Allow datasets in rules write access for \"save\" and",
          "1009: #    # \"state\". This is enabled by default, however write access is",
          "1010: #    # limited to the data directory.",
          "1011: #    #allow-write: true",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fd79b337ca4618d9cf2ac7b37db98f81d97ffab2",
      "candidate_info": {
        "commit_hash": "fd79b337ca4618d9cf2ac7b37db98f81d97ffab2",
        "repo": "OISF/suricata",
        "commit_url": "https://github.com/OISF/suricata/commit/fd79b337ca4618d9cf2ac7b37db98f81d97ffab2",
        "files": [
          "src/detect-dataset.c",
          "src/util-path.c",
          "src/util-path.h",
          "suricata.yaml.in"
        ],
        "message": "datasets: don't allow absolute or paths with directory traversal\n\nFor dataset filenames coming from rules, do not allow filenames that\nare absolute or contain a directory traversal with \"..\". This prevents\ndatasets from escaping the define data-directory which may allow a bad\nrule to overwrite any file that Suricata has permission to write to.\n\nAdd a new configuration option,\n\"datasets.rules.allow-absolute-filenames\" to allow absolute filenames\nin dataset rules. This will be a way to revert back to the pre 6.0.13\nbehavior where save/state rules could use any filename.\n\nTicket: #6118",
        "before_after_code_files": [
          "src/detect-dataset.c||src/detect-dataset.c",
          "src/util-path.c||src/util-path.c",
          "src/util-path.h||src/util-path.h",
          "suricata.yaml.in||suricata.yaml.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/detect-dataset.c||src/detect-dataset.c",
            "src/util-path.c||src/util-path.c",
            "src/util-path.h||src/util-path.h",
            "suricata.yaml.in||suricata.yaml.in"
          ],
          "candidate": [
            "src/detect-dataset.c||src/detect-dataset.c",
            "src/util-path.c||src/util-path.c",
            "src/util-path.h||src/util-path.h",
            "suricata.yaml.in||suricata.yaml.in"
          ]
        }
      },
      "candidate_diff": {
        "src/detect-dataset.c||src/detect-dataset.c": [
          "File: src/detect-dataset.c -> src/detect-dataset.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "303: {",
          "304:     SCLogDebug(\"save %s\", save);",
          "308:     }",
          "",
          "[Removed Lines]",
          "306:     if (PathIsAbsolute(save)) {",
          "307:         return 0;",
          "",
          "[Added Lines]",
          "306:     int allow_absolute = 0;",
          "307:     (void)ConfGetBool(\"datasets.rules.allow-absolute-filenames\", &allow_absolute);",
          "308:     if (allow_absolute) {",
          "309:         SCLogNotice(\"Allowing absolute filename for dataset rule: %s\", save);",
          "310:     } else {",
          "311:         if (PathIsAbsolute(save)) {",
          "312:             SCLogError(\"Absolute paths not allowed: %s\", save);",
          "313:             return -1;",
          "314:         }",
          "316:         if (SCPathContainsTraversal(save)) {",
          "317:             SCLogError(\"Directory traversals not allowed: %s\", save);",
          "318:             return -1;",
          "319:         }",
          "",
          "---------------"
        ],
        "src/util-path.c||src/util-path.c": [
          "File: src/util-path.c -> src/util-path.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:     return final + 1;",
          "248: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "257: bool SCPathContainsTraversal(const char *path)",
          "258: {",
          "259: #ifdef OS_WIN32",
          "260:     const char *pattern = \"..\\\\\";",
          "261: #else",
          "262:     const char *pattern = \"../\";",
          "263: #endif",
          "264:     return strstr(path, pattern) != NULL;",
          "265: }",
          "",
          "---------------"
        ],
        "src/util-path.h||src/util-path.h": [
          "File: src/util-path.h -> src/util-path.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: bool SCIsRegularFile(const struct dirent *const dir_entry);",
          "42: char *SCRealPath(const char *path, char *resolved_path);",
          "43: const char *SCBasename(const char *path);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: bool SCPathContainsTraversal(const char *path);",
          "",
          "---------------"
        ],
        "suricata.yaml.in||suricata.yaml.in": [
          "File: suricata.yaml.in -> suricata.yaml.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1158: #   defaults:",
          "1159: #     memcap: 100mb",
          "1160: #     hashsize: 2048",
          "1162: ##############################################################################",
          "1163: ##",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1161: #",
          "1162: #  rules:",
          "1163: #    # Set to true to allow absolute filenames and filenames that use",
          "1164: #    # \"..\" components to reference parent directories in rules that specify",
          "1165: #    # their filenames.",
          "1166: #    #allow-absolute-filenames: false",
          "",
          "---------------"
        ]
      }
    }
  ]
}