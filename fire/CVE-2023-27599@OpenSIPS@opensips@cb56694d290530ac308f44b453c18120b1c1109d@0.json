{
  "cve_id": "CVE-2023-27599",
  "cve_desc": "OpenSIPS is a Session Initiation Protocol (SIP) server implementation. Prior to versions 3.1.7 and 3.2.4, when the function `append_hf` handles a SIP message with a malformed To header, a call to the function `abort()` is performed, resulting in a crash. This is due to the following check in `data_lump.c:399` in the function `anchor_lump`. An attacker abusing this vulnerability will crash OpenSIPS leading to Denial of Service. It affects configurations containing functions that make use of the affected code, such as the function `append_hf`. This issue has been fixed in versions 3.1.7 and 3.2.4.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "cb56694d290530ac308f44b453c18120b1c1109d",
  "patch_info": {
    "commit_hash": "cb56694d290530ac308f44b453c18120b1c1109d",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/cb56694d290530ac308f44b453c18120b1c1109d",
    "files": [
      "parser/parse_to.c"
    ],
    "message": "[sipmsgops] fix parse_to_param() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-qvj2-vqrg-f5jx",
    "before_after_code_files": [
      "parser/parse_to.c||parser/parse_to.c"
    ]
  },
  "patch_diff": {
    "parser/parse_to.c||parser/parse_to.c": [
      "File: parser/parse_to.c -> parser/parse_to.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "232:     switch (status)",
      "233:     {",
      "234:      case PARA_VALUE_QUOTED:",
      "235:       switch (*(tmp+1))",
      "236:       {",
      "237:        case '\\r':",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "235:       if (tmp+1==end)",
      "236:        goto parse_error;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "457: endofheader:",
      "458:  if (param) {",
      "459:   if (saved_status==S_EQUAL||saved_status==S_PARA_VALUE) {",
      "460:    saved_status = E_PARA_VALUE;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "458:  if (status==PARA_VALUE_QUOTED) {",
      "459:    LM_ERR(\"unexpected end of header in state %d\\n\", status);",
      "460:    goto parse_error;",
      "461:  }",
      "464:  LM_DBG(\"end of header reached, state=%d\\n\", status);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1d4e56fc1f4f96dbb811074fbf1ac4c72b2b7167",
      "candidate_info": {
        "commit_hash": "1d4e56fc1f4f96dbb811074fbf1ac4c72b2b7167",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/1d4e56fc1f4f96dbb811074fbf1ac4c72b2b7167",
        "files": [
          "parser/parse_to.c"
        ],
        "message": "[sipmsgops] fix parse_to_param() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-qvj2-vqrg-f5jx\n(cherry picked from commit cb56694d290530ac308f44b453c18120b1c1109d)",
        "before_after_code_files": [
          "parser/parse_to.c||parser/parse_to.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "parser/parse_to.c||parser/parse_to.c"
          ],
          "candidate": [
            "parser/parse_to.c||parser/parse_to.c"
          ]
        }
      },
      "candidate_diff": {
        "parser/parse_to.c||parser/parse_to.c": [
          "File: parser/parse_to.c -> parser/parse_to.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "232:     switch (status)",
          "233:     {",
          "234:      case PARA_VALUE_QUOTED:",
          "235:       switch (*(tmp+1))",
          "236:       {",
          "237:        case '\\r':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "235:       if (tmp+1==end)",
          "236:        goto parse_error;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "457: endofheader:",
          "458:  if (param) {",
          "459:   if (saved_status==S_EQUAL||saved_status==S_PARA_VALUE) {",
          "460:    saved_status = E_PARA_VALUE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "458:  if (status==PARA_VALUE_QUOTED) {",
          "459:    LM_ERR(\"unexpected end of header in state %d\\n\", status);",
          "460:    goto parse_error;",
          "461:  }",
          "464:  LM_DBG(\"end of header reached, state=%d\\n\", status);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eab8ff654bebaa04dda7bed78266844b385f928b",
      "candidate_info": {
        "commit_hash": "eab8ff654bebaa04dda7bed78266844b385f928b",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/eab8ff654bebaa04dda7bed78266844b385f928b",
        "files": [
          "parser/parse_to.c"
        ],
        "message": "[sipmsgops] fix parse_to_param() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-qvj2-vqrg-f5jx\n(cherry picked from commit cb56694d290530ac308f44b453c18120b1c1109d)",
        "before_after_code_files": [
          "parser/parse_to.c||parser/parse_to.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "parser/parse_to.c||parser/parse_to.c"
          ],
          "candidate": [
            "parser/parse_to.c||parser/parse_to.c"
          ]
        }
      },
      "candidate_diff": {
        "parser/parse_to.c||parser/parse_to.c": [
          "File: parser/parse_to.c -> parser/parse_to.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "232:     switch (status)",
          "233:     {",
          "234:      case PARA_VALUE_QUOTED:",
          "235:       switch (*(tmp+1))",
          "236:       {",
          "237:        case '\\r':",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "235:       if (tmp+1==end)",
          "236:        goto parse_error;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "457: endofheader:",
          "458:  if (param) {",
          "459:   if (saved_status==S_EQUAL||saved_status==S_PARA_VALUE) {",
          "460:    saved_status = E_PARA_VALUE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "458:  if (status==PARA_VALUE_QUOTED) {",
          "459:    LM_ERR(\"unexpected end of header in state %d\\n\", status);",
          "460:    goto parse_error;",
          "461:  }",
          "464:  LM_DBG(\"end of header reached, state=%d\\n\", status);",
          "",
          "---------------"
        ]
      }
    }
  ]
}