{
  "cve_id": "CVE-2014-8117",
  "cve_desc": "softmagic.c in file before 5.21 does not properly limit recursion, which allows remote attackers to cause a denial of service (CPU consumption or crash) via unspecified vectors.",
  "repo": "file/file",
  "patch_hash": "6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
  "patch_info": {
    "commit_hash": "6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
    "files": [
      "src/file.h",
      "src/funcs.c",
      "src/softmagic.c"
    ],
    "message": "- reduce recursion level from 20 to 10 and make a symbolic constant for it. - pull out the guts of saving and restoring the output buffer into functions   and take care not to overwrite the error message if an error happened.",
    "before_after_code_files": [
      "src/file.h||src/file.h",
      "src/funcs.c||src/funcs.c",
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/file.h||src/file.h": [
      "File: src/file.h -> src/file.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "495: protected void file_regfree(file_regex_t *);",
      "496: protected void file_regerror(file_regex_t *, int, struct magic_set *);",
      "498: #ifndef COMPILE_ONLY",
      "499: extern const char *file_names[];",
      "500: extern const size_t file_nnames;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "498: typedef struct {",
      "499:  char *buf;",
      "500:  uint32_t offset;",
      "501: } file_pushbuf_t;",
      "503: protected file_pushbuf_t *file_push_buffer(struct magic_set *);",
      "504: protected char  *file_pop_buffer(struct magic_set *, file_pushbuf_t *);",
      "",
      "---------------"
    ],
    "src/funcs.c||src/funcs.c": [
      "File: src/funcs.c -> src/funcs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "27: #include \"file.h\"",
      "29: #ifndef lint",
      "33: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.72 2014/05/14 23:15:42 christos Exp $\")",
      "",
      "[Added Lines]",
      "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.73 2014/09/10 18:41:51 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "491:  file_magerror(ms, \"regex error %d for `%s', (%s)\", rc, rx->pat,",
      "492:      errmsg);",
      "493: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "495: protected file_pushbuf_t *",
      "496: file_push_buffer(struct magic_set *ms)",
      "497: {",
      "498:  file_pushbuf_t *pb;",
      "500:  if (ms->event_flags & EVENT_HAD_ERR)",
      "501:   return NULL;",
      "503:  if ((pb = (CAST(file_pushbuf_t *, malloc(sizeof(*pb))))) == NULL)",
      "504:   return NULL;",
      "506:  pb->buf = ms->o.buf;",
      "507:  pb->offset = ms->offset;",
      "509:  ms->o.buf = NULL;",
      "510:  ms->offset = 0;",
      "512:  return pb;",
      "513: }",
      "515: protected char *",
      "516: file_pop_buffer(struct magic_set *ms, file_pushbuf_t *pb)",
      "517: {",
      "518:  char *rbuf;",
      "520:  if (ms->event_flags & EVENT_HAD_ERR) {",
      "521:   free(pb->buf);",
      "522:   free(pb);",
      "523:   return NULL;",
      "524:  }",
      "526:  rbuf = ms->o.buf;",
      "528:  ms->o.buf = pb->buf;",
      "529:  ms->offset = pb->offset;",
      "531:  free(pb);",
      "532:  return rbuf;",
      "533: }",
      "",
      "---------------"
    ],
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.197 2014/11/11 17:48:23 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "63: private void cvt_64(union VALUETYPE *, const struct magic *);",
      "65: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) > ((n) - (o)))",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "67: #define MAX_RECURSION_LEVEL 10",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1217:     int flip, int recursion_level, int *printed_something,",
      "1218:     int *need_separator, int *returnval)",
      "1219: {",
      "1221:  uint32_t lhs;",
      "1222:  int rv, oneed_separator, in_type;",
      "1224:  union VALUETYPE *p = &ms->ms_value;",
      "1225:  struct mlist ml;",
      "1228:   file_error(ms, 0, \"recursion nesting exceeded\");",
      "1229:   return -1;",
      "1230:  }",
      "",
      "[Removed Lines]",
      "1220:  uint32_t soffset, offset = ms->offset;",
      "1223:  char *sbuf, *rbuf;",
      "1227:  if (recursion_level >= 20) {",
      "",
      "[Added Lines]",
      "1223:  uint32_t offset = ms->offset;",
      "1225:  file_pushbuf_t *pb;",
      "1227:  char *rbuf;",
      "1231:  if (recursion_level >= MAX_RECURSION_LEVEL) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1669:  case FILE_INDIRECT:",
      "1670:   if (offset == 0)",
      "1671:    return 0;",
      "1672:   if (nbytes < offset)",
      "1673:    return 0;",
      "1678:   rv = file_softmagic(ms, s + offset, nbytes - offset,",
      "1679:       recursion_level, BINTEST, text);",
      "1680:   if ((ms->flags & MAGIC_DEBUG) != 0)",
      "1681:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
      "1685:   if (rv == 1) {",
      "1686:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
      "1687:        file_printf(ms, F(ms, m, \"%u\"), offset) == -1) {",
      "",
      "[Removed Lines]",
      "1674:   sbuf = ms->o.buf;",
      "1675:   soffset = ms->offset;",
      "1676:   ms->o.buf = NULL;",
      "1677:   ms->offset = 0;",
      "1682:   rbuf = ms->o.buf;",
      "1683:   ms->o.buf = sbuf;",
      "1684:   ms->offset = soffset;",
      "",
      "[Added Lines]",
      "1680:   if ((pb = file_push_buffer(ms)) == NULL)",
      "1681:    return -1;",
      "1689:   rbuf = file_pop_buffer(ms, pb);",
      "1690:   if (rbuf == NULL)",
      "1691:    return -1;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1699:  case FILE_USE:",
      "1700:   if (nbytes < offset)",
      "1701:    return 0;",
      "1705:    flip = !flip;",
      "1706:   }",
      "1709:    return -1;",
      "1710:   }",
      "",
      "[Removed Lines]",
      "1702:   sbuf = m->value.s;",
      "1703:   if (*sbuf == '^') {",
      "1704:    sbuf++;",
      "1707:   if (file_magicfind(ms, sbuf, &ml) == -1) {",
      "1708:    file_error(ms, 0, \"cannot find entry `%s'\", sbuf);",
      "",
      "[Added Lines]",
      "1710:   rbuf = m->value.s;",
      "1711:   if (*rbuf == '^') {",
      "1712:    rbuf++;",
      "1715:   if (file_magicfind(ms, rbuf, &ml) == -1) {",
      "1716:    file_error(ms, 0, \"cannot find entry `%s'\", rbuf);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c16df549fb92534c74fded61cad3c519a6806516",
      "candidate_info": {
        "commit_hash": "c16df549fb92534c74fded61cad3c519a6806516",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/c16df549fb92534c74fded61cad3c519a6806516",
        "files": [
          "src/funcs.c"
        ],
        "message": "remove unused variables",
        "before_after_code_files": [
          "src/funcs.c||src/funcs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/funcs.c||src/funcs.c"
          ],
          "candidate": [
            "src/funcs.c||src/funcs.c"
          ]
        }
      },
      "candidate_diff": {
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.84 2015/09/10 13:32:19 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.85 2015/09/17 01:10:51 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "178:     const void *buf, size_t nb)",
          "179: {",
          "180:  int m = 0, rv = 0, looks_text = 0;",
          "182:  const unsigned char *ubuf = CAST(const unsigned char *, buf);",
          "183:  unichar *u8buf = NULL;",
          "184:  size_t ulen;",
          "",
          "[Removed Lines]",
          "181:  int mime = ms->flags & MAGIC_MIME;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
      "candidate_info": {
        "commit_hash": "9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
        "files": [
          "ChangeLog",
          "TODO",
          "doc/file.man",
          "doc/libmagic.man",
          "magic/Magdir/jpeg",
          "magic/Magdir/mathematica",
          "src/apprentice.c",
          "src/ascmagic.c",
          "src/file.c",
          "src/file.h",
          "src/file_opts.h",
          "src/fsmagic.c",
          "src/is_tar.c",
          "src/readcdf.c",
          "src/readelf.c",
          "src/softmagic.c"
        ],
        "message": "Add --extension",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/ascmagic.c||src/ascmagic.c",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/file_opts.h||src/file_opts.h",
          "src/fsmagic.c||src/fsmagic.c",
          "src/is_tar.c||src/is_tar.c",
          "src/readcdf.c||src/readcdf.c",
          "src/readelf.c||src/readelf.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/file.h||src/file.h",
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/file.h||src/file.h",
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.230 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.231 2015/02/06 17:08:58 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "149: private int parse_mime(struct magic_set *, struct magic_entry *, const char *);",
          "150: private int parse_strength(struct magic_set *, struct magic_entry *, const char *);",
          "151: private int parse_apple(struct magic_set *, struct magic_entry *, const char *);",
          "154: private size_t magicsize = sizeof(struct magic);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152: private int parse_ext(struct magic_set *, struct magic_entry *, const char *);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "163: #define DECLARE_FIELD(name) { # name, sizeof(# name) - 1, parse_ ## name }",
          "164:  DECLARE_FIELD(mime),",
          "165:  DECLARE_FIELD(apple),",
          "166:  DECLARE_FIELD(strength),",
          "167: #undef DECLARE_FIELD",
          "168:  { NULL, 0, NULL }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:  DECLARE_FIELD(ext),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2254:      sizeof(m->apple), \"APPLE\", \"!+-./\", 0);",
          "2255: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2262: private int",
          "2263: parse_ext(struct magic_set *ms, struct magic_entry *me, const char *line)",
          "2264: {",
          "2265:  struct magic *m = &me->mp[0];",
          "2267:  return parse_extra(ms, me, line,",
          "2268:      CAST(off_t, offsetof(struct magic, ext)),",
          "2269:      sizeof(m->ext), \"EXTENSION\", \",!+-/\", 0);",
          "2270: }",
          "",
          "---------------"
        ],
        "src/ascmagic.c||src/ascmagic.c": [
          "File: src/ascmagic.c -> src/ascmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.90 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.91 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "79:  const char *code_mime = NULL;",
          "80:  const char *type = NULL;",
          "83:   return 0;",
          "85:  nbytes = trim_nuls(buf, nbytes);",
          "",
          "[Removed Lines]",
          "82:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "82:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123:  size_t last_line_end = (size_t)-1;",
          "124:  int has_long_lines = 0;",
          "127:   return 0;",
          "129:  nbytes = trim_nuls(buf, nbytes);",
          "",
          "[Removed Lines]",
          "126:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "126:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.161 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.162 2015/02/09 20:15:50 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "76: # define USAGE  \\",
          "77:     \"Usage: %s [\" FILE_FLAGS \\",
          "79:     \"            [-e testname] [-F separator] [-f namefile] [-m magicfiles] \" \\",
          "80:     \"file ...\\n\" \\",
          "81:     \"       %s -C [-m magicfiles]\\n\" \\",
          "",
          "[Removed Lines]",
          "78:  \"] [--apple] [--mime-encoding] [--mime-type]\\n\" \\",
          "",
          "[Added Lines]",
          "78:  \"] [--apple] [--extension] [--mime-encoding] [--mime-type]\\n\" \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "191:     flags |= MAGIC_APPLE;",
          "192:     break;",
          "193:    case 11:",
          "195:     break;",
          "196:    case 12:",
          "197:     flags |= MAGIC_MIME_ENCODING;",
          "198:     break;",
          "199:    }",
          "",
          "[Removed Lines]",
          "194:     flags |= MAGIC_MIME_TYPE;",
          "",
          "[Added Lines]",
          "194:     flags |= MAGIC_EXTENSION;",
          "197:     flags |= MAGIC_MIME_TYPE;",
          "198:     break;",
          "199:    case 13:",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: #define MAGICNO  0xF11E041C",
          "141: #define FILE_LOAD 0",
          "142: #define FILE_CHECK 1",
          "",
          "[Removed Lines]",
          "138: #define VERSIONNO 12",
          "139: #define FILE_MAGICSIZE 248",
          "",
          "[Added Lines]",
          "138: #define VERSIONNO 13",
          "139: #define FILE_MAGICSIZE 312",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "311: };",
          "313: #define BIT(A)   (1 << (A))",
          "",
          "[Removed Lines]",
          "310:  char apple[8];",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/file_opts.h||src/file_opts.h": [
          "File: src/file_opts.h -> src/file_opts.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: OPT('i', \"mime\", 0, \"                 output MIME type strings (--mime-type and\\n\"",
          "30:     \"                               --mime-encoding)\\n\")",
          "31: OPT_LONGONLY(\"apple\", 0, \"                output the Apple CREATOR/TYPE\\n\")",
          "32: OPT_LONGONLY(\"mime-type\", 0, \"            output the MIME type\\n\")",
          "33: OPT_LONGONLY(\"mime-encoding\", 0, \"        output the MIME encoding\\n\")",
          "34: OPT('k', \"keep-going\", 0, \"           don't stop at the first match\\n\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "32: OPT_LONGONLY(\"extension\", 0, \"            output a comma-separated list of extnsions\\n\")",
          "",
          "---------------"
        ],
        "src/fsmagic.c||src/fsmagic.c": [
          "File: src/fsmagic.c -> src/fsmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.74 2014/10/13 20:21:49 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.75 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "110:  struct stat tstatbuf;",
          "111: #endif",
          "114:   return 0;",
          "115:  if (fn == NULL)",
          "116:   return 0;",
          "",
          "[Removed Lines]",
          "113:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "113:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/is_tar.c||src/is_tar.c": [
          "File: src/is_tar.c -> src/is_tar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "40: #include \"file.h\"",
          "42: #ifndef lint",
          "44: #endif",
          "46: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "43: FILE_RCSID(\"@(#)$File: is_tar.c,v 1.36 2009/02/03 20:27:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "43: FILE_RCSID(\"@(#)$File: is_tar.c,v 1.37 2010/11/30 14:58:53 rrt Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "69:  int tar;",
          "70:  int mime = ms->flags & MAGIC_MIME;",
          "73:   return 0;",
          "75:  tar = is_tar(buf, nbytes);",
          "",
          "[Removed Lines]",
          "72:  if ((ms->flags & MAGIC_APPLE) != 0)",
          "",
          "[Added Lines]",
          "72:  if ((ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION)) != 0)",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.51 2015/01/11 16:58:25 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.52 2015/02/27 21:16:38 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "454:         info.i_fd = fd;",
          "455:         info.i_buf = buf;",
          "456:         info.i_len = nbytes;",
          "458:                 return 0;",
          "459:         if (cdf_read_header(&info, &h) == -1)",
          "460:                 return 0;",
          "",
          "[Removed Lines]",
          "457:         if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "457:         if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.117 2014/12/16 23:29:42 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.118 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1353:  Elf64_Ehdr elf64hdr;",
          "1354:  uint16_t type, phnum, shnum, notecount;",
          "1357:   return 0;",
          "",
          "[Removed Lines]",
          "1356:  if (ms->flags & (MAGIC_MIME|MAGIC_APPLE))",
          "",
          "[Added Lines]",
          "1356:  if (ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.212 2015/01/24 22:11:25 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.213 2015/02/14 18:43:12 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:  unsigned int cont_level = 0;",
          "152:  if (returnval == NULL)",
          "153:   returnval = &returnvalv;",
          "",
          "[Removed Lines]",
          "150:  int print = (ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0;",
          "",
          "[Added Lines]",
          "150:  int print = (ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION)) == 0;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1674:    return -1;",
          "1676:   if (rv == 1) {",
          "1678:        file_printf(ms, F(ms, m, \"%u\"), offset) == -1) {",
          "1679:     free(rbuf);",
          "1680:     return -1;",
          "",
          "[Removed Lines]",
          "1677:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
          "",
          "[Added Lines]",
          "1677:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION)) == 0 &&",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2136:    return -1;",
          "2137:   return 1;",
          "2138:  }",
          "2139:  if ((ms->flags & MAGIC_MIME_TYPE) && m->mimetype[0]) {",
          "2140:   if (file_printf(ms, \"%s\", m->mimetype) == -1)",
          "2141:    return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2139:  if (ms->flags & MAGIC_EXTENSION) {",
          "2140:   if (file_printf(ms, \"%s\", m->ext) == -1)",
          "2141:    return -1;",
          "2142:   return 1;",
          "2143:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d6f8888a02bda2e0c75bc50d99554c6641ed551d",
      "candidate_info": {
        "commit_hash": "d6f8888a02bda2e0c75bc50d99554c6641ed551d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/d6f8888a02bda2e0c75bc50d99554c6641ed551d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "handle line terminators better.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.207 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.208 2015/01/05 00:16:01 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "518:    t = ms->offset + strlen(str);",
          "520:    if (*m->value.s == '\\0')",
          "523:    if (m->str_flags & STRING_TRIM) {",
          "524:     char *last;",
          "",
          "[Removed Lines]",
          "521:     str[strcspn(str, \"\\n\")] = '\\0';",
          "",
          "[Added Lines]",
          "521:     str[strcspn(str, \"\\r\\n\")] = '\\0';",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "707:    uint32_t t;",
          "709:    if (*m->value.s == '\\0')",
          "711:    t = CAST(uint32_t, (ms->offset + strlen(p->s)));",
          "712:    if (m->type == FILE_PSTRING)",
          "713:     t += (uint32_t)file_pstring_length_size(m);",
          "",
          "[Removed Lines]",
          "710:     p->s[strcspn(p->s, \"\\n\")] = '\\0';",
          "",
          "[Added Lines]",
          "710:     p->s[strcspn(p->s, \"\\r\\n\")] = '\\0';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
      "candidate_info": {
        "commit_hash": "c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "annotations are attached to the first description entry, print them then.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.218 2015/09/11 17:24:09 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.219 2015/09/16 18:25:23 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "228:    continue;",
          "229:   }",
          "241:   if (*m->desc) {",
          "244:    if (print_sep(ms, firstline) == -1)",
          "",
          "[Removed Lines]",
          "231:   if ((e = handle_annotation(ms, m)) != 0) {",
          "235:    return e;",
          "236:   }",
          "",
          "[Added Lines]",
          "236:    if ((e = handle_annotation(ms, m)) != 0) {",
          "240:     return e;",
          "241:    }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "318:       break;",
          "319:     } else",
          "320:      ms->c.li[cont_level].got_match = 1;",
          "331:     if (*m->desc) {",
          "332:      if (!*printed_something) {",
          "334:       if (print_sep(ms, firstline)",
          "",
          "[Removed Lines]",
          "321:     if ((e = handle_annotation(ms, m)) != 0) {",
          "325:      return e;",
          "326:     }",
          "",
          "[Added Lines]",
          "326:      if ((e = handle_annotation(ms, m)) != 0) {",
          "330:       return e;",
          "331:      }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2166: private int",
          "2167: handle_annotation(struct magic_set *ms, struct magic *m)",
          "2168: {",
          "2169:  if (ms->flags & MAGIC_APPLE) {",
          "2170:   if (file_printf(ms, \"%.8s\", m->apple) == -1)",
          "2171:    return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2169: printf(\"desc = %s, ext = %s mime = %s\\n\", m->desc, m->ext, m->mimetype);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2388f81e5258f4b24986e44b454bb3ae9ccf89c0",
      "candidate_info": {
        "commit_hash": "2388f81e5258f4b24986e44b454bb3ae9ccf89c0",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/2388f81e5258f4b24986e44b454bb3ae9ccf89c0",
        "files": [
          "src/funcs.c"
        ],
        "message": "print a space between previous messages and error.",
        "before_after_code_files": [
          "src/funcs.c||src/funcs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/funcs.c||src/funcs.c"
          ],
          "candidate": [
            "src/funcs.c||src/funcs.c"
          ]
        }
      },
      "candidate_diff": {
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.81 2015/05/28 19:26:59 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.82 2015/06/03 18:01:20 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "107:  if (lineno != 0) {",
          "108:   free(ms->o.buf);",
          "109:   ms->o.buf = NULL;",
          "111:  }",
          "112:  file_vprintf(ms, f, va);",
          "113:  if (error > 0)",
          "114:   file_printf(ms, \" (%s)\", strerror(error));",
          "",
          "[Removed Lines]",
          "110:   file_printf(ms, \"line %\" SIZE_T_FORMAT \"u: \", lineno);",
          "",
          "[Added Lines]",
          "110:   file_printf(ms, \"line %\" SIZE_T_FORMAT \"u:\", lineno);",
          "112:  if (ms->o.buf && *ms->o.buf)",
          "113:   file_printf(ms, \" \");",
          "",
          "---------------"
        ]
      }
    }
  ]
}