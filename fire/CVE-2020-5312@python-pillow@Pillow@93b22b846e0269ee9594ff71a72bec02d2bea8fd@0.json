{
  "cve_id": "CVE-2020-5312",
  "cve_desc": "libImaging/PcxDecode.c in Pillow before 6.2.2 has a PCX P mode buffer overflow.",
  "repo": "python-pillow/Pillow",
  "patch_hash": "93b22b846e0269ee9594ff71a72bec02d2bea8fd",
  "patch_info": {
    "commit_hash": "93b22b846e0269ee9594ff71a72bec02d2bea8fd",
    "repo": "python-pillow/Pillow",
    "commit_url": "https://github.com/python-pillow/Pillow/commit/93b22b846e0269ee9594ff71a72bec02d2bea8fd",
    "files": [
      "Tests/images/pcx_overrun2.bin",
      "Tests/test_image.py",
      "src/libImaging/PcxDecode.c"
    ],
    "message": "Catch PCX P mode buffer overrun",
    "before_after_code_files": [
      "Tests/test_image.py||Tests/test_image.py",
      "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c"
    ]
  },
  "patch_diff": {
    "Tests/test_image.py||Tests/test_image.py": [
      "File: Tests/test_image.py -> Tests/test_image.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "590:             self.assertFalse(fp.closed)",
      "592:     def test_overrun(self):",
      "594:             im = Image.open(os.path.join(\"Tests/images\", file))",
      "595:             try:",
      "596:                 im.load()",
      "",
      "[Removed Lines]",
      "593:         for file in [\"fli_overrun.bin\", \"sgi_overrun.bin\", \"pcx_overrun.bin\"]:",
      "",
      "[Added Lines]",
      "593:         for file in [",
      "594:             \"fli_overrun.bin\",",
      "595:             \"sgi_overrun.bin\",",
      "596:             \"pcx_overrun.bin\",",
      "597:             \"pcx_overrun2.bin\",",
      "598:         ]:",
      "",
      "---------------"
    ],
    "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c": [
      "File: src/libImaging/PcxDecode.c -> src/libImaging/PcxDecode.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "25:     if (strcmp(im->mode, \"1\") == 0 && state->xsize > state->bytes * 8) {",
      "26:         state->errcode = IMAGING_CODEC_OVERRUN;",
      "27:         return -1;",
      "28:     }",
      "30:     ptr = buf;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "28:     } else if (strcmp(im->mode, \"P\") == 0 && state->xsize > state->bytes) {",
      "29:         state->errcode = IMAGING_CODEC_OVERRUN;",
      "30:         return -1;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8f0c8f731190f761180bed827d07b7a740d8555b",
      "candidate_info": {
        "commit_hash": "8f0c8f731190f761180bed827d07b7a740d8555b",
        "repo": "python-pillow/Pillow",
        "commit_url": "https://github.com/python-pillow/Pillow/commit/8f0c8f731190f761180bed827d07b7a740d8555b",
        "files": [
          "Tests/images/pcx_overrun2.bin",
          "Tests/test_image.py",
          "src/libImaging/PcxDecode.c"
        ],
        "message": "Catch PCX P mode buffer overrun",
        "before_after_code_files": [
          "Tests/test_image.py||Tests/test_image.py",
          "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "Tests/test_image.py||Tests/test_image.py",
            "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c"
          ],
          "candidate": [
            "Tests/test_image.py||Tests/test_image.py",
            "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c"
          ]
        }
      },
      "candidate_diff": {
        "Tests/test_image.py||Tests/test_image.py": [
          "File: Tests/test_image.py -> Tests/test_image.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "590:             self.assertFalse(fp.closed)",
          "592:     def test_overrun(self):",
          "594:             with Image.open(os.path.join(\"Tests/images\", file)) as im:",
          "595:                 try:",
          "596:                     im.load()",
          "",
          "[Removed Lines]",
          "593:         for file in [\"fli_overrun.bin\", \"sgi_overrun.bin\", \"pcx_overrun.bin\"]:",
          "",
          "[Added Lines]",
          "593:         for file in [",
          "594:             \"fli_overrun.bin\",",
          "595:             \"sgi_overrun.bin\",",
          "596:             \"pcx_overrun.bin\",",
          "597:             \"pcx_overrun2.bin\",",
          "598:         ]:",
          "",
          "---------------"
        ],
        "src/libImaging/PcxDecode.c||src/libImaging/PcxDecode.c": [
          "File: src/libImaging/PcxDecode.c -> src/libImaging/PcxDecode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "25:     if (strcmp(im->mode, \"1\") == 0 && state->xsize > state->bytes * 8) {",
          "26:         state->errcode = IMAGING_CODEC_OVERRUN;",
          "27:         return -1;",
          "28:     }",
          "30:     ptr = buf;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28:     } else if (strcmp(im->mode, \"P\") == 0 && state->xsize > state->bytes) {",
          "29:         state->errcode = IMAGING_CODEC_OVERRUN;",
          "30:         return -1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}