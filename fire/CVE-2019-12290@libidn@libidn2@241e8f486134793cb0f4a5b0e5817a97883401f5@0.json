{
  "cve_id": "CVE-2019-12290",
  "cve_desc": "GNU libidn2 before 2.2.0 fails to perform the roundtrip checks specified in RFC3490 Section 4.2 when converting A-labels to U-labels. This makes it possible in some circumstances for one domain to impersonate another. By creating a malicious domain that matches a target domain except for the inclusion of certain punycoded Unicode characters (that would be discarded when converted first to a Unicode label and then back to an ASCII label), arbitrary domains can be impersonated.",
  "repo": "libidn/libidn2",
  "patch_hash": "241e8f486134793cb0f4a5b0e5817a97883401f5",
  "patch_info": {
    "commit_hash": "241e8f486134793cb0f4a5b0e5817a97883401f5",
    "repo": "libidn/libidn2",
    "commit_url": "https://github.com/libidn/libidn2/commit/241e8f486134793cb0f4a5b0e5817a97883401f5",
    "files": [
      "lib/error.c",
      "lib/idn2.h.in",
      "lib/lookup.c",
      "src/blurbs.h",
      "src/idn2.c",
      "src/idn2.ggo"
    ],
    "message": "Perform A-Label roundtrip for lookup functions by default\n\nThis adds another check to avoid unexpected results.\nIt was a longstanding FIXME.\n\nThanks to  Jonathan Birch of Microsoft Corporation,\nFlorian Weimer (GNU glibc) and Nikos Mavrogiannopoulos (GnuTLS)\nfor investigation, discussion and testing.",
    "before_after_code_files": [
      "lib/error.c||lib/error.c",
      "lib/idn2.h.in||lib/idn2.h.in",
      "lib/lookup.c||lib/lookup.c",
      "src/blurbs.h||src/blurbs.h",
      "src/idn2.c||src/idn2.c",
      "src/idn2.ggo||src/idn2.ggo"
    ]
  },
  "patch_diff": {
    "lib/error.c||lib/error.c": [
      "File: lib/error.c -> lib/error.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "77:     case IDN2_DOT_IN_LABEL: return _(\"domain label has forbidden dot (TR46)\");",
      "78:     case IDN2_INVALID_TRANSITIONAL: return _(\"domain label has character forbidden in transitional mode (TR46)\");",
      "79:     case IDN2_INVALID_NONTRANSITIONAL: return _(\"domain label has character forbidden in non-transitional mode (TR46)\");",
      "80:     default: return _(\"Unknown error\");",
      "81:     }",
      "82: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "80:     case IDN2_ALABEL_ROUNDTRIP_FAILED: return _(\"Alabel roundtrip failed\");",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "129:     case IDN2_DOT_IN_LABEL: return ERR2STR (IDN2_DOT_IN_LABEL);",
      "130:     case IDN2_INVALID_TRANSITIONAL: return ERR2STR (IDN2_INVALID_TRANSITIONAL);",
      "131:     case IDN2_INVALID_NONTRANSITIONAL: return ERR2STR (IDN2_INVALID_NONTRANSITIONAL);",
      "132:     default: return \"IDN2_UNKNOWN\";",
      "133:     }",
      "134: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "133:     case IDN2_ALABEL_ROUNDTRIP_FAILED: return ERR2STR (IDN2_ALABEL_ROUNDTRIP_FAILED);",
      "",
      "---------------"
    ],
    "lib/idn2.h.in||lib/idn2.h.in": [
      "File: lib/idn2.h.in -> lib/idn2.h.in",
      "--- Hunk 1 ---",
      "[Context before]",
      "198:     IDN2_NONTRANSITIONAL = 8,",
      "199:     IDN2_ALLOW_UNASSIGNED = 16,",
      "200:     IDN2_USE_STD3_ASCII_RULES = 32,",
      "202:   } idn2_flags;",
      "",
      "[Removed Lines]",
      "201:     IDN2_NO_TR46 = 64",
      "",
      "[Added Lines]",
      "202:     IDN2_NO_TR46 = 64,",
      "203:     IDN2_NO_ALABEL_ROUNDTRIP = 128",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "287:     IDN2_DOT_IN_LABEL = -311,",
      "288:     IDN2_INVALID_TRANSITIONAL = -312,",
      "289:     IDN2_INVALID_NONTRANSITIONAL = -313,",
      "290:   } idn2_rc;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "293:     IDN2_ALABEL_ROUNDTRIP_FAILED = -314,",
      "",
      "---------------"
    ],
    "lib/lookup.c||lib/lookup.c": [
      "File: lib/lookup.c -> lib/lookup.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "51:   if (((*flags) & (IDN2_TRANSITIONAL|IDN2_NONTRANSITIONAL)) && ((*flags) & IDN2_NO_TR46))",
      "52:     return IDN2_INVALID_FLAGS;",
      "54:   if (!((*flags) & (IDN2_NO_TR46|IDN2_TRANSITIONAL)))",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "54:   if (((*flags) & IDN2_ALABEL_ROUNDTRIP) && ((*flags) & IDN2_NO_ALABEL_ROUNDTRIP))",
      "55:     return IDN2_INVALID_FLAGS;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "63: {",
      "64:   size_t plen;",
      "65:   uint32_t *p;",
      "83:       if (srclen > IDN2_LABEL_MAX_LENGTH)",
      "84:  return IDN2_TOO_BIG_LABEL;",
      "85:       if (srclen > *dstlen)",
      "",
      "[Removed Lines]",
      "66:   int rc;",
      "67:   size_t tmpl;",
      "69:   if (_idn2_ascii_p (src, srclen))",
      "70:     {",
      "71:       if (flags & IDN2_ALABEL_ROUNDTRIP)",
      "74:     If the input to this procedure appears to be an A-label",
      "75:     (i.e., it starts in \"xn--\", interpreted",
      "76:     case-insensitively), the lookup application MAY attempt to",
      "77:     convert it to a U-label, first ensuring that the A-label is",
      "78:     entirely in lowercase (converting it to lowercase if",
      "79:     necessary), and apply the tests of Section 5.4 and the",
      "81:  return IDN2_INVALID_FLAGS;",
      "",
      "[Added Lines]",
      "69:   const uint8_t *src_org = NULL;",
      "70:   uint8_t *src_allocated = NULL;",
      "71:   int rc, check_roundtrip = 0;",
      "72:   size_t tmpl, srclen_org = 0;",
      "73:   uint32_t label_u32[IDN2_LABEL_MAX_LENGTH];",
      "74:   size_t label32_len = IDN2_LABEL_MAX_LENGTH;",
      "76:   if (_idn2_ascii_p (src, srclen)) {",
      "77:     if (!(flags & IDN2_NO_ALABEL_ROUNDTRIP) && srclen >= 4 && memcmp (src, \"xn--\", 4) == 0) {",
      "79:   If the input to this procedure appears to be an A-label",
      "80:   (i.e., it starts in \"xn--\", interpreted",
      "81:   case-insensitively), the lookup application MAY attempt to",
      "82:   convert it to a U-label, first ensuring that the A-label is",
      "83:   entirely in lowercase (converting it to lowercase if",
      "84:   necessary), and apply the tests of Section 5.4 and the",
      "86:       rc = _idn2_punycode_decode (srclen - 4, (char *) src + 4, &label32_len, label_u32);",
      "87:       if (rc)",
      "88:  return rc;",
      "90:       check_roundtrip = 1;",
      "91:       src_org = src;",
      "92:       srclen_org = srclen;",
      "94:       srclen = IDN2_LABEL_MAX_LENGTH;",
      "95:       src = src_allocated = u32_to_u8 (label_u32, label32_len, NULL, &srclen);",
      "96:       if (!src) {",
      "97:  if (errno == ENOMEM)",
      "98:    return IDN2_MALLOC;",
      "99:  return IDN2_ENCODING_ERROR;",
      "100:       }",
      "101:     } else {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "90:       return IDN2_OK;",
      "91:     }",
      "93:   rc = _idn2_u8_to_u32_nfc (src, srclen, &p, &plen, flags & IDN2_NFC_INPUT);",
      "94:   if (rc != IDN2_OK)",
      "97:   if (!(flags & IDN2_TRANSITIONAL))",
      "98:     {",
      "",
      "[Removed Lines]",
      "95:     return rc;",
      "",
      "[Added Lines]",
      "111:   }",
      "115:     goto out;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "111:       if (rc != IDN2_OK)",
      "112:  {",
      "115:  }",
      "116:     }",
      "",
      "[Removed Lines]",
      "113:    free(p);",
      "114:    return rc;",
      "",
      "[Added Lines]",
      "133:    free (p);",
      "134:    goto out;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "124:   rc = _idn2_punycode_encode (plen, p, &tmpl, (char *) dst + 4);",
      "125:   free (p);",
      "126:   if (rc != IDN2_OK)",
      "132: }",
      "134: #define TR46_TRANSITIONAL_CHECK \\",
      "",
      "[Removed Lines]",
      "127:     return rc;",
      "131:   return IDN2_OK;",
      "",
      "[Added Lines]",
      "147:     goto out;",
      "152:   if (check_roundtrip)",
      "153:     {",
      "154:       if (srclen_org != *dstlen || memcmp (src_org, dst, srclen_org))",
      "155:       {",
      "156:         rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
      "157:  goto out;",
      "158:       }",
      "159:     }",
      "161:   rc = IDN2_OK;",
      "163: out:",
      "164:   free (src_allocated);",
      "165:   return rc;",
      "",
      "---------------"
    ],
    "src/blurbs.h||src/blurbs.h": [
      "File: src/blurbs.h -> src/blurbs.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "4:    This program is free software: you can redistribute it and/or modify",
      "5:    it under the terms of the GNU General Public License as published by",
      "",
      "[Removed Lines]",
      "2:    Copyright (C) 2011-2017 Simon Josefsson",
      "",
      "[Added Lines]",
      "2:    Copyright (C) 2011-2019 Simon Josefsson, Tim Ruehsen",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "18: #define GREETING       \\",
      "20:   \"This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.\\n\" \\",
      "21:   \"This is free software, and you are welcome to redistribute it\\n\" \\",
      "22:   \"under certain conditions; type `show c' for details.\\n\\n\"",
      "",
      "[Removed Lines]",
      "19:   \"Copyright (C) 2011-2017  Simon Josefsson\\n\"    \\",
      "",
      "[Added Lines]",
      "19:   \"Copyright (C) 2011-2019  Simon Josefsson, Tim Ruehsen\\n\"    \\",
      "",
      "---------------"
    ],
    "src/idn2.c||src/idn2.c": [
      "File: src/idn2.c -> src/idn2.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4:    This program is free software: you can redistribute it and/or modify",
      "5:    it under the terms of the GNU General Public License as published by",
      "",
      "[Removed Lines]",
      "2:    Copyright (C) 2011-2017 Simon Josefsson",
      "",
      "[Added Lines]",
      "2:    Copyright (C) 2011-2019 Simon Josefsson, Tim Ruehsen",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "51:      symbol suitable for this locale, and %d is the copyright",
      "55: static void",
      "56: usage (int status)",
      "",
      "[Removed Lines]",
      "53:   \"Copyright %s %d Simon Josefsson.\";",
      "",
      "[Added Lines]",
      "53:   \"Copyright 2011-%s %d Simon Josefsson, Tim Ruehsen.\";",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "78: Mandatory arguments to long options are mandatory for short options too.\\n\\",
      "79: \"), stdout);",
      "80:       fputs (_(\"\\",
      "83: \"), stdout);",
      "84:       fputs (_(\"\\",
      "88: \"), stdout);",
      "89:       fputs (_(\"\\",
      "93: \"), stdout);",
      "94:       fputs (_(\"\\",
      "98: \"), stdout);",
      "99:       emit_bug_reporting_address ();",
      "100:     }",
      "",
      "[Removed Lines]",
      "81:   -h, --help               Print help and exit\\n\\",
      "82:   -V, --version            Print version and exit\\n\\",
      "85:   -d, --decode             Decode (punycode) domain name\\n\\",
      "86:   -l, --lookup             Lookup domain name (default)\\n\\",
      "87:   -r, --register           Register label\\n\\",
      "90:   -T, --tr46t              Enable TR46 transitional processing\\n\\",
      "91:   -N, --tr46nt             Enable TR46 non-transitional processing\\n\\",
      "92:       --no-tr46            Disable TR46 processing\\n\\",
      "95:       --usestd3asciirules  Enable STD3 ASCII rules\\n\\",
      "96:       --debug              Print debugging information\\n\\",
      "97:       --quiet              Silent operation\\n\\",
      "",
      "[Added Lines]",
      "81:   -h, --help                Print help and exit\\n\\",
      "82:   -V, --version             Print version and exit\\n\\",
      "85:   -d, --decode              Decode (punycode) domain name\\n\\",
      "86:   -l, --lookup              Lookup domain name (default)\\n\\",
      "87:   -r, --register            Register label\\n\\",
      "90:   -T, --tr46t               Enable TR46 transitional processing\\n\\",
      "91:   -N, --tr46nt              Enable TR46 non-transitional processing\\n\\",
      "92:       --no-tr46             Disable TR46 processing\\n\\",
      "95:       --usestd3asciirules   Enable STD3 ASCII rules\\n\\",
      "96:       --no-alabelroundtrip  Disable ALabel rountrip for lookups\\n\\",
      "97:       --debug               Print debugging information\\n\\",
      "98:       --quiet               Silent operation\\n\\",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "201:   if (args_info.version_given)",
      "202:     {",
      "203:       version_etc (stdout, \"idn2\", PACKAGE_NAME, VERSION,",
      "205:       return EXIT_SUCCESS;",
      "206:     }",
      "",
      "[Removed Lines]",
      "204:      \"Simon Josefsson\", (char *) NULL);",
      "",
      "[Added Lines]",
      "205:      \"Simon Josefsson, Tim Ruehsen\", (char *) NULL);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "230:   if (flags && args_info.usestd3asciirules_given)",
      "231:     flags |= IDN2_USE_STD3_ASCII_RULES;",
      "233:   for (cmdn = 0; cmdn < args_info.inputs_num; cmdn++)",
      "234:     process_input (args_info.inputs[cmdn], flags | IDN2_NFC_INPUT);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "234:   if (flags && args_info.no_alabelroundtrip_given)",
      "235:     flags |= IDN2_NO_ALABEL_ROUNDTRIP;",
      "",
      "---------------"
    ],
    "src/idn2.ggo||src/idn2.ggo": [
      "File: src/idn2.ggo -> src/idn2.ggo",
      "--- Hunk 1 ---",
      "[Context before]",
      "20: option \"tr46nt\" N \"Enable TR46 non-transitional processing\" flag off",
      "21: option \"no-tr46\" - \"Disable TR46 processing\" flag off",
      "22: option \"usestd3asciirules\" - \"Enable STD3 ASCII rules\" flag off",
      "23: option \"debug\" - \"Print debugging information\" flag off",
      "24: option \"quiet\" - \"Silent operation\" flag off",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "23: option \"no-alabelroundtrip\" - \"Disable ALabel roundtrip for lookups\" flag off",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bf761c4327becf10b749cc4edf1115507ca45590",
      "candidate_info": {
        "commit_hash": "bf761c4327becf10b749cc4edf1115507ca45590",
        "repo": "libidn/libidn2",
        "commit_url": "https://github.com/libidn/libidn2/commit/bf761c4327becf10b749cc4edf1115507ca45590",
        "files": [
          "src/idn2.c"
        ],
        "message": "Fix copyright line for 'idn2 --version'",
        "before_after_code_files": [
          "src/idn2.c||src/idn2.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/idn2.c||src/idn2.c"
          ],
          "candidate": [
            "src/idn2.c||src/idn2.c"
          ]
        }
      },
      "candidate_diff": {
        "src/idn2.c||src/idn2.c": [
          "File: src/idn2.c -> src/idn2.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:      symbol suitable for this locale, and %d is the copyright",
          "55: static void",
          "56: usage (int status)",
          "",
          "[Removed Lines]",
          "53:   \"Copyright 2011-%s %d Simon Josefsson, Tim Ruehsen.\";",
          "",
          "[Added Lines]",
          "53:   \"Copyright %s 2011-%d Simon Josefsson, Tim Ruehsen.\";",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "089616574679a017f5d45c6bd40b05816ae4db6b",
      "candidate_info": {
        "commit_hash": "089616574679a017f5d45c6bd40b05816ae4db6b",
        "repo": "libidn/libidn2",
        "commit_url": "https://github.com/libidn/libidn2/commit/089616574679a017f5d45c6bd40b05816ae4db6b",
        "files": [
          "NEWS",
          "configure.ac",
          "contrib/libidn2-latest-x86_64.abi",
          "lib/decode.c",
          "lib/idn2.map",
          "lib/lookup.c",
          "lib/puny_decode.c",
          "lib/puny_encode.c",
          "lib/punycode.h",
          "lib/register.c",
          "tests/test-punycode.c"
        ],
        "message": "Turn _idn2_punycode_encode, _idn2_punycode_decode into compat symbols\n\nThese internal symbols should not be used by applications, but were\npreviously exported.  Contrary to our expectations, outright removal\nis not possible due to some use in old GNUTLS versions.\n\nThe aliases are required because internal hidden references turn the\ntarget symbol into a hidden symbol.  It would have been possible to\npreserve the internal API using another __asm__ alias, but this commit\nrenames the call sites instead, for simplicity.\n\nThe -export-symbols-regex argument in lib/Makefile.am is not adjusted\nbecause targets which do not support version scripts probably do not\nhave stringent backwards compatibility requirements.\n\nFixes libidn/libidn2#74.",
        "before_after_code_files": [
          "configure.ac||configure.ac",
          "contrib/libidn2-latest-x86_64.abi||contrib/libidn2-latest-x86_64.abi",
          "lib/decode.c||lib/decode.c",
          "lib/idn2.map||lib/idn2.map",
          "lib/lookup.c||lib/lookup.c",
          "lib/puny_decode.c||lib/puny_decode.c",
          "lib/puny_encode.c||lib/puny_encode.c",
          "lib/punycode.h||lib/punycode.h",
          "lib/register.c||lib/register.c",
          "tests/test-punycode.c||tests/test-punycode.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/lookup.c||lib/lookup.c"
          ],
          "candidate": [
            "lib/lookup.c||lib/lookup.c"
          ]
        }
      },
      "candidate_diff": {
        "configure.ac||configure.ac": [
          "File: configure.ac -> configure.ac",
          "--- Hunk 1 ---",
          "[Context before]",
          "49: gl_INIT",
          "50: unistring_INIT",
          "52: #",
          "53: # check for gtk-doc",
          "54: #",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: dnl Ideally, this should attempt a link, but this requires a separate",
          "53: dnl version file, so we only check for compiler support here.",
          "54: AC_COMPILE_IFELSE([AC_LANG_PROGRAM([",
          "55: __attribute__((visibility(\"hidden\")))",
          "56: int",
          "57: versioned_symbol_internal (void)",
          "58: {",
          "59: }",
          "60: __typeof__ (versioned_symbol_internal) versioned_symbol",
          "61:    __attribute__ ((visibility (\"default\"),",
          "62:                    alias (\"versioned_symbol_internal\")));",
          "63: __asm__ (\".symver versioned_symbol, versioned_symbol@IDN2_0.0.0\");",
          "64: ])], [AC_DEFINE([HAVE_SYMVER_ALIAS_SUPPORT], [1],",
          "65:      [The toolchain supports aliases and .symver.])])",
          "",
          "---------------"
        ],
        "contrib/libidn2-latest-x86_64.abi||contrib/libidn2-latest-x86_64.abi": [
          "File: contrib/libidn2-latest-x86_64.abi -> contrib/libidn2-latest-x86_64.abi",
          "--- Hunk 1 ---",
          "[Context before]",
          "4:     <dependency name='libc.so.6'/>",
          "5:   </elf-needed>",
          "6:   <elf-function-symbols>",
          "7:     <elf-symbol name='idn2_check_version' version='IDN2_0.0.0' is-default-version='yes' type='func-type' binding='global-binding' visibility='default-visibility' is-defined='yes'/>",
          "8:     <elf-symbol name='idn2_free' version='IDN2_0.0.0' is-default-version='yes' type='func-type' binding='global-binding' visibility='default-visibility' is-defined='yes'/>",
          "9:     <elf-symbol name='idn2_lookup_u8' version='IDN2_0.0.0' is-default-version='yes' type='func-type' binding='global-binding' visibility='default-visibility' is-defined='yes'/>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7:     <elf-symbol name='_idn2_punycode_decode' version='IDN2_0.0.0' is-default-version='no' type='func-type' binding='global-binding' visibility='default-visibility' is-defined='yes'/>",
          "8:     <elf-symbol name='_idn2_punycode_encode' version='IDN2_0.0.0' is-default-version='no' type='func-type' binding='global-binding' visibility='default-visibility' is-defined='yes'/>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "161:     <function-decl name='get_map_data' mangled-name='get_map_data' visibility='default' binding='global' size-in-bits='64'>",
          "162:       <return type-id='type-id-1'/>",
          "163:     </function-decl>",
          "165:       <return type-id='type-id-1'/>",
          "166:     </function-decl>",
          "167:     <function-decl name='_idn2_label_test' mangled-name='_idn2_label_test' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "[Removed Lines]",
          "164:     <function-decl name='_idn2_punycode_decode' mangled-name='_idn2_punycode_decode' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "[Added Lines]",
          "166:     <function-decl name='_idn2_punycode_decode_internal' mangled-name='_idn2_punycode_decode_internal' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "173:     <function-decl name='malloc' mangled-name='malloc' visibility='default' binding='global' size-in-bits='64'>",
          "174:       <return type-id='type-id-1'/>",
          "175:     </function-decl>",
          "176:     <function-decl name='_idn2_ascii_p' mangled-name='_idn2_ascii_p' visibility='default' binding='global' size-in-bits='64'>",
          "177:       <return type-id='type-id-1'/>",
          "178:     </function-decl>",
          "179:     <function-decl name='_idn2_u8_to_u32_nfc' mangled-name='_idn2_u8_to_u32_nfc' visibility='default' binding='global' size-in-bits='64'>",
          "180:       <return type-id='type-id-1'/>",
          "181:     </function-decl>",
          "183:       <return type-id='type-id-1'/>",
          "184:     </function-decl>",
          "185:     <function-decl name='c_strncasecmp' mangled-name='c_strncasecmp' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "[Removed Lines]",
          "182:     <function-decl name='_idn2_punycode_encode' mangled-name='_idn2_punycode_encode' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "[Added Lines]",
          "178:     <function-decl name='_idn2_punycode_decode' mangled-name='_idn2_punycode_decode' visibility='default' binding='global' size-in-bits='64'>",
          "179:       <return type-id='type-id-1'/>",
          "180:     </function-decl>",
          "187:     <function-decl name='_idn2_punycode_encode_internal' mangled-name='_idn2_punycode_encode_internal' visibility='default' binding='global' size-in-bits='64'>",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "293:       <return type-id='type-id-5'/>",
          "294:     </function-decl>",
          "295:   </abi-instr>",
          "296:   <abi-instr version='1.0' address-size='64' path='puny_decode.c' comp-dir-path='/home/nmav/cvs/libidn2/lib' language='LANG_C99'>",
          "297:     <function-decl name='memmove' mangled-name='memmove' visibility='default' binding='global' size-in-bits='64'>",
          "298:       <return type-id='type-id-1'/>",
          "299:     </function-decl>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "301:   <abi-instr version='1.0' address-size='64' path='puny_encode.c' comp-dir-path='/home/nmav/cvs/libidn2/lib' language='LANG_C99'>",
          "302:     <function-decl name='_idn2_punycode_encode_internal' mangled-name='_idn2_punycode_encode' visibility='default' binding='global' size-in-bits='64' elf-symbol-id='_idn2_punycode_encode@IDN2_0.0.0'>",
          "303:       <parameter type-id='type-id-14' name='input_length_orig'/>",
          "304:       <parameter type-id='type-id-12' name='input'/>",
          "305:       <parameter type-id='type-id-23' name='output_length'/>",
          "306:       <parameter type-id='type-id-6' name='output'/>",
          "307:       <return type-id='type-id-2'/>",
          "308:     </function-decl>",
          "309:   </abi-instr>",
          "311:     <function-decl name='_idn2_punycode_decode_internal' mangled-name='_idn2_punycode_decode' visibility='default' binding='global' size-in-bits='64' elf-symbol-id='_idn2_punycode_decode@IDN2_0.0.0'>",
          "312:       <parameter type-id='type-id-14' name='input_length'/>",
          "313:       <parameter type-id='type-id-5' name='input'/>",
          "314:       <parameter type-id='type-id-23' name='output_length'/>",
          "315:       <parameter type-id='type-id-22' name='output'/>",
          "316:       <return type-id='type-id-2'/>",
          "317:     </function-decl>",
          "",
          "---------------"
        ],
        "lib/decode.c||lib/decode.c": [
          "File: lib/decode.c -> lib/decode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:  {",
          "93:    s += 4;",
          "97:    if (rc)",
          "98:      return rc;",
          "",
          "[Removed Lines]",
          "95:    rc =",
          "96:      _idn2_punycode_decode (e - s, (char *) s, &label_len, label_u32);",
          "",
          "[Added Lines]",
          "95:    rc = _idn2_punycode_decode_internal (e - s, (char *) s,",
          "96:             &label_len, label_u32);",
          "",
          "---------------"
        ],
        "lib/idn2.map||lib/idn2.map": [
          "File: lib/idn2.map -> lib/idn2.map",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:     idn2_strerror;",
          "43:     idn2_strerror_name;",
          "45:   local:",
          "47: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "45:     # Compatibility symbols.",
          "46:     _idn2_punycode_encode;",
          "47:     _idn2_punycode_decode;",
          "",
          "---------------"
        ],
        "lib/lookup.c||lib/lookup.c": [
          "File: lib/lookup.c -> lib/lookup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "141:   entirely in lowercase (converting it to lowercase if",
          "142:   necessary), and apply the tests of Section 5.4 and the",
          "145:       if (rc)",
          "146:  return rc;",
          "",
          "[Removed Lines]",
          "144:       rc = _idn2_punycode_decode (srclen - 4, (char *) src + 4, &label32_len, label_u32);",
          "",
          "[Added Lines]",
          "144:       rc = _idn2_punycode_decode_internal (srclen - 4, (char *) src + 4, &label32_len, label_u32);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "199:   dst[3] = '-';",
          "201:   tmpl = *dstlen - 4;",
          "203:   free (p);",
          "204:   if (rc != IDN2_OK)",
          "205:     goto out;",
          "",
          "[Removed Lines]",
          "202:   rc = _idn2_punycode_encode (plen, p, &tmpl, (char *) dst + 4);",
          "",
          "[Added Lines]",
          "202:   rc = _idn2_punycode_encode_internal (plen, p, &tmpl, (char *) dst + 4);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "401:        return IDN2_ENCODING_ERROR;",
          "402:      }",
          "407:    free (ace);",
          "",
          "[Removed Lines]",
          "404:    rc =",
          "405:      _idn2_punycode_decode (ace_len, (char *) ace, &name_len, name_u32);",
          "",
          "[Added Lines]",
          "404:    rc = _idn2_punycode_decode_internal (ace_len, (char *) ace,",
          "405:             &name_len, name_u32);",
          "",
          "---------------"
        ],
        "lib/puny_decode.c||lib/puny_decode.c": [
          "File: lib/puny_decode.c -> lib/puny_decode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "69: #define punycode_overflow IDN2_PUNYCODE_OVERFLOW",
          "70: #define punycode_big_output IDN2_PUNYCODE_BIG_OUTPUT",
          "71: #define punycode_bad_input IDN2_PUNYCODE_BAD_INPUT",
          "",
          "[Removed Lines]",
          "72: #define punycode_decode _idn2_punycode_decode",
          "",
          "[Added Lines]",
          "72: #define punycode_decode _idn2_punycode_decode_internal",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "222:   return punycode_success;",
          "223: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "227: #ifdef HAVE_SYMVER_ALIAS_SUPPORT",
          "228: __typeof__ (_idn2_punycode_decode_internal) _idn2_punycode_decode",
          "229:    __attribute__ ((visibility (\"default\"),",
          "230:                    alias (\"_idn2_punycode_decode_internal\")));",
          "231: __asm__ (\".symver _idn2_punycode_decode, _idn2_punycode_decode@IDN2_0.0.0\");",
          "232: #endif",
          "",
          "---------------"
        ],
        "lib/puny_encode.c||lib/puny_encode.c": [
          "File: lib/puny_encode.c -> lib/puny_encode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "69: #define punycode_overflow IDN2_PUNYCODE_OVERFLOW",
          "70: #define punycode_big_output IDN2_PUNYCODE_BIG_OUTPUT",
          "71: #define punycode_bad_input IDN2_PUNYCODE_BAD_INPUT",
          "",
          "[Removed Lines]",
          "72: #define punycode_encode _idn2_punycode_encode",
          "",
          "[Added Lines]",
          "72: #define punycode_encode _idn2_punycode_encode_internal",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "223:   return punycode_success;",
          "224: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "228: #ifdef HAVE_SYMVER_ALIAS_SUPPORT",
          "229: __typeof__ (_idn2_punycode_encode_internal) _idn2_punycode_encode",
          "230:    __attribute__ ((visibility (\"default\"),",
          "231:                    alias (\"_idn2_punycode_encode_internal\")));",
          "232: __asm__ (\".symver _idn2_punycode_encode, _idn2_punycode_encode@IDN2_0.0.0\");",
          "233: #endif",
          "",
          "---------------"
        ],
        "lib/punycode.h||lib/punycode.h": [
          "File: lib/punycode.h -> lib/punycode.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include <stddef.h>",
          "33: #include <stdint.h>",
          "",
          "[Removed Lines]",
          "35: int",
          "36: _idn2_punycode_encode (size_t input_length,",
          "37:          const uint32_t input[],",
          "38:          size_t * output_length, char output[]);",
          "40: int",
          "41: _idn2_punycode_decode (size_t input_length,",
          "42:          const char input[],",
          "43:          size_t * output_length,",
          "44:          uint32_t output[]);",
          "",
          "[Added Lines]",
          "35: extern int",
          "36: _idn2_punycode_encode_internal (size_t input_length,",
          "37:     const uint32_t input[],",
          "38:     size_t * output_length, char output[]);",
          "40: extern int",
          "41: _idn2_punycode_decode_internal (size_t input_length,",
          "42:     const char input[],",
          "43:     size_t * output_length,",
          "44:     uint32_t output[]);",
          "",
          "---------------"
        ],
        "lib/register.c||lib/register.c": [
          "File: lib/register.c -> lib/register.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:       if (!_idn2_ascii_p (alabel, alabellen))",
          "105:  return IDN2_INVALID_ALABEL;",
          "109:       if (rc != IDN2_OK)",
          "110:  return rc;",
          "",
          "[Removed Lines]",
          "107:       rc = _idn2_punycode_decode (alabellen - 4, (char*)alabel + 4,",
          "108:       &u32len, u32);",
          "",
          "[Added Lines]",
          "107:       rc = _idn2_punycode_decode_internal (alabellen - 4, (char*)alabel + 4,",
          "108:         &u32len, u32);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "186:       tmp[3] = '-';",
          "188:       tmpl = IDN2_LABEL_MAX_LENGTH - 4;",
          "190:       free (u32);",
          "191:       if (rc != IDN2_OK)",
          "192:  return rc;",
          "",
          "[Removed Lines]",
          "189:       rc = _idn2_punycode_encode (u32len, u32, &tmpl, (char*)tmp + 4);",
          "",
          "[Added Lines]",
          "189:       rc = _idn2_punycode_encode_internal (u32len, u32, &tmpl, (char*)tmp + 4);",
          "",
          "---------------"
        ],
        "tests/test-punycode.c||tests/test-punycode.c": [
          "File: tests/test-punycode.c -> tests/test-punycode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "236:  }",
          "238:       outlen = BUFSIZ;",
          "241:       if (rc != punycode[i].rc)",
          "242:  {",
          "243:    fail (\"punycode_encode() entry %d failed: %d\\n\", (int) i, rc);",
          "",
          "[Removed Lines]",
          "239:       rc = _idn2_punycode_encode (",
          "240:  punycode[i].inlen, punycode[i].in, &outlen, p);",
          "",
          "[Added Lines]",
          "239:       rc = _idn2_punycode_encode_internal (punycode[i].inlen, punycode[i].in,",
          "240:         &outlen, p);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "278:  }",
          "280:       outlen = BUFSIZ;",
          "283:       if (rc != punycode[i].rc)",
          "284:  {",
          "285:    fail (\"punycode() entry %d failed: %d\\n\", (int) i, rc);",
          "",
          "[Removed Lines]",
          "281:       rc = _idn2_punycode_decode (strlen (punycode[i].out), punycode[i].out,",
          "282:         &outlen, q);",
          "",
          "[Added Lines]",
          "281:       rc = _idn2_punycode_decode_internal (strlen (punycode[i].out),",
          "282:         punycode[i].out, &outlen, q);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c6cb8ba531bb38be023c06ec01ed83d8ae4949c1",
      "candidate_info": {
        "commit_hash": "c6cb8ba531bb38be023c06ec01ed83d8ae4949c1",
        "repo": "libidn/libidn2",
        "commit_url": "https://github.com/libidn/libidn2/commit/c6cb8ba531bb38be023c06ec01ed83d8ae4949c1",
        "files": [
          "bootstrap.conf",
          "lib/lookup.c"
        ],
        "message": "Fix lookup round-trip check",
        "before_after_code_files": [
          "bootstrap.conf||bootstrap.conf",
          "lib/lookup.c||lib/lookup.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/lookup.c||lib/lookup.c"
          ],
          "candidate": [
            "lib/lookup.c||lib/lookup.c"
          ]
        }
      },
      "candidate_diff": {
        "bootstrap.conf||bootstrap.conf": [
          "File: bootstrap.conf -> bootstrap.conf",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: local_gl_dir=gl/override/",
          "27: gnulib_modules=\"",
          "28: error",
          "29: gendocs",
          "30: getline",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: c-strcase",
          "",
          "---------------"
        ],
        "lib/lookup.c||lib/lookup.c": [
          "File: lib/lookup.c -> lib/lookup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:   if (check_roundtrip)",
          "153:     {",
          "155:       {",
          "156:         rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
          "157:  goto out;",
          "",
          "[Removed Lines]",
          "154:       if (srclen_org != *dstlen || memcmp (src_org, dst, srclen_org))",
          "",
          "[Added Lines]",
          "155:       if (srclen_org != *dstlen || c_strncasecmp ((char *) src_org, (char *) dst, srclen_org))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c7b33a418d9426ee311db45473cb20bad94df26a",
      "candidate_info": {
        "commit_hash": "c7b33a418d9426ee311db45473cb20bad94df26a",
        "repo": "libidn/libidn2",
        "commit_url": "https://github.com/libidn/libidn2/commit/c7b33a418d9426ee311db45473cb20bad94df26a",
        "files": [
          "bootstrap.conf",
          "lib/lookup.c",
          "tests/test-lookup.c"
        ],
        "message": "Implement full roundtrip for lookup functionality\n\nWith TR64 enabled (default), '\u00e2\u02dc\u00bai' was converted to 'xn-- o-oia59s'.\nThe output contains an illegal space and thus could not be decoded any more.\n\nReferences:\nhttps://gitlab.com/libidn/libidn2/issues/78\nhttps://gitlab.isc.org/isc-projects/bind9/issues/1610\n\nReported-by: Chris Malton",
        "before_after_code_files": [
          "bootstrap.conf||bootstrap.conf",
          "lib/lookup.c||lib/lookup.c",
          "tests/test-lookup.c||tests/test-lookup.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/lookup.c||lib/lookup.c"
          ],
          "candidate": [
            "lib/lookup.c||lib/lookup.c"
          ]
        }
      },
      "candidate_diff": {
        "bootstrap.conf||bootstrap.conf": [
          "File: bootstrap.conf -> bootstrap.conf",
          "--- Hunk 1 ---",
          "[Context before]",
          "63: uninorm/u32-normalize",
          "64: unistr/u32-to-u8",
          "65: unistr/u8-to-u32",
          "66: \"",
          "68: # Build prerequisites",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "66: unistr/u32-cmp",
          "",
          "---------------"
        ],
        "lib/lookup.c||lib/lookup.c": [
          "File: lib/lookup.c -> lib/lookup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:    Copyright (C) 2011-2017 Simon Josefsson",
          "4:    Libidn2 is free software: you can redistribute it and/or modify it",
          "5:    under the terms of either:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3:    Copyright (C) 2017-2020 Tim Ruehsen",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "123:        int flags)",
          "124: {",
          "125:   size_t plen;",
          "127:   const uint8_t *src_org = NULL;",
          "128:   uint8_t *src_allocated = NULL;",
          "129:   int rc, check_roundtrip = 0;",
          "",
          "[Removed Lines]",
          "126:   uint32_t *p;",
          "",
          "[Added Lines]",
          "127:   uint32_t *p = NULL;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "187:  p, plen);",
          "189:       if (rc != IDN2_OK)",
          "194:     }",
          "196:   dst[0] = 'x';",
          "",
          "[Removed Lines]",
          "190:  {",
          "191:    free (p);",
          "192:    goto out;",
          "193:  }",
          "",
          "[Added Lines]",
          "191:  goto out;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "201:   tmpl = *dstlen - 4;",
          "202:   rc = _idn2_punycode_encode_internal (plen, p, &tmpl, (char *) dst + 4);",
          "204:   if (rc != IDN2_OK)",
          "205:     goto out;",
          "",
          "[Removed Lines]",
          "203:   free (p);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "210:   if (check_roundtrip)",
          "211:     {",
          "212:       if (srclen_org != *dstlen || c_strncasecmp ((char *) src_org, (char *) dst, srclen_org))",
          "217:     }",
          "219:   rc = IDN2_OK;",
          "221: out:",
          "222:   free (src_allocated);",
          "223:   return rc;",
          "224: }",
          "",
          "[Removed Lines]",
          "213:       {",
          "214:         rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
          "215:  goto out;",
          "216:       }",
          "",
          "[Added Lines]",
          "210:         {",
          "211:    rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
          "212:    goto out;",
          "213:         }",
          "214:     }",
          "215:   else if (!(flags & IDN2_NO_ALABEL_ROUNDTRIP))",
          "216:     {",
          "217:       rc = _idn2_punycode_decode_internal (*dstlen - 4, (char *) dst + 4, &label32_len, label_u32);",
          "218:       if (rc)",
          "219:         {",
          "220:    rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
          "221:    goto out;",
          "222:         }",
          "224:       if (plen != label32_len || u32_cmp (p, label_u32, label32_len))",
          "225:         {",
          "226:    rc = IDN2_ALABEL_ROUNDTRIP_FAILED;",
          "227:    goto out;",
          "228:         }",
          "234:   free (p);",
          "",
          "---------------"
        ],
        "tests/test-lookup.c||tests/test-lookup.c": [
          "File: tests/test-lookup.c -> tests/test-lookup.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:    Copyright (C) 2011-2017 Simon Josefsson",
          "4:    This program is free software: you can redistribute it and/or modify",
          "5:    it under the terms of the GNU General Public License as published by",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3:    Copyright (C) 2017-2020 Tim Ruehsen",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "838:   {\"\\xc3\\xa4_x\", \"xn--_x-uia\", IDN2_OK, IDN2_TRANSITIONAL},",
          "840:   {\"xn--te_\", \"\", IDN2_ALABEL_ROUNDTRIP_FAILED},",
          "841: };",
          "843: static int ok = 0, failed = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "843:   {\"\\xc3\\xa2\\xcb\\x9c\\xc2\\xba\", \"\", IDN2_DISALLOWED, IDN2_NO_TR46},",
          "844:   {\"\\xc3\\xa2\\xcb\\x9c\\xc2\\xba\", \"\", IDN2_ALABEL_ROUNDTRIP_FAILED, IDN2_TRANSITIONAL},",
          "845:   {\"\\xc3\\xa2\\xcb\\x9c\\xc2\\xba\", \"\", IDN2_ALABEL_ROUNDTRIP_FAILED, IDN2_NONTRANSITIONAL},",
          "",
          "---------------"
        ]
      }
    }
  ]
}