{
  "cve_id": "CVE-2024-36405",
  "cve_desc": "liboqs is a C-language cryptographic library that provides implementations of post-quantum cryptography algorithms. A control-flow timing lean has been identified in the reference implementation of the Kyber key encapsulation mechanism when it is compiled with Clang 15-18 for `-Os`, `-O1`, and other compilation options. A proof-of-concept local attack on the reference implementation leaks the entire ML-KEM 512 secret key in ~10 minutes using end-to-end decapsulation timing measurements. The issue has been fixed in version 0.10.1. As a possible workaround, some compiler options may produce vectorized code that does not leak secret information, however relying on these compiler options as a workaround may not be reliable.",
  "repo": "pq-crystals/kyber",
  "patch_hash": "9b8d30698a3e7449aeb34e62339d4176f11e3c6c",
  "patch_info": {
    "commit_hash": "9b8d30698a3e7449aeb34e62339d4176f11e3c6c",
    "repo": "pq-crystals/kyber",
    "commit_url": "https://github.com/pq-crystals/kyber/commit/9b8d30698a3e7449aeb34e62339d4176f11e3c6c",
    "files": [
      "ref/poly.c",
      "ref/verify.c",
      "ref/verify.h"
    ],
    "message": "Fixed secret-dependent branch in poly_frommsg introduced by recent versions of clang with some flags (Thanks to Antoon Purnal for pointing this out!)",
    "before_after_code_files": [
      "ref/poly.c||ref/poly.c",
      "ref/verify.c||ref/verify.c",
      "ref/verify.h||ref/verify.h"
    ]
  },
  "patch_diff": {
    "ref/poly.c||ref/poly.c": [
      "File: ref/poly.c -> ref/poly.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "5: #include \"reduce.h\"",
      "6: #include \"cbd.h\"",
      "7: #include \"symmetric.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "8: #include \"verify.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "166: void poly_frommsg(poly *r, const uint8_t msg[KYBER_INDCPA_MSGBYTES])",
      "167: {",
      "168:   unsigned int i,j;",
      "171: #if (KYBER_INDCPA_MSGBYTES != KYBER_N/8)",
      "172: #error \"KYBER_INDCPA_MSGBYTES must be equal to KYBER_N/8 bytes!\"",
      "",
      "[Removed Lines]",
      "169:   int16_t mask;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "175:   for(i=0;i<KYBER_N/8;i++) {",
      "176:     for(j=0;j<8;j++) {",
      "179:     }",
      "180:   }",
      "181: }",
      "",
      "[Removed Lines]",
      "177:       mask = -(int16_t)((msg[i] >> j)&1);",
      "178:       r->coeffs[8*i+j] = mask & ((KYBER_Q+1)/2);",
      "",
      "[Added Lines]",
      "177:       r->coeffs[8*i+j] = 0;",
      "178:       cmov_int16(r->coeffs+8*i+j, ((KYBER_Q+1)/2), (msg[i] >> j)&1);",
      "",
      "---------------"
    ],
    "ref/verify.c||ref/verify.c": [
      "File: ref/verify.c -> ref/verify.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "55:   for(i=0;i<len;i++)",
      "56:     r[i] ^= b & (r[i] ^ x[i]);",
      "57: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "60: void cmov_int16(int16_t *r, int16_t v, uint16_t b)",
      "61: {",
      "62:   b = -b;",
      "64: }",
      "",
      "---------------"
    ],
    "ref/verify.h||ref/verify.h": [
      "File: ref/verify.h -> ref/verify.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "11: #define cmov KYBER_NAMESPACE(cmov)",
      "12: void cmov(uint8_t *r, const uint8_t *x, size_t len, uint8_t b);",
      "14: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14: #define cmov_int16 KYBER_NAMESPACE(cmov_int16)",
      "15: void cmov_int16(int16_t *r, int16_t v, uint16_t b);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0264efacf18dd665d2066f21df3a3290b52ba240",
      "candidate_info": {
        "commit_hash": "0264efacf18dd665d2066f21df3a3290b52ba240",
        "repo": "pq-crystals/kyber",
        "commit_url": "https://github.com/pq-crystals/kyber/commit/0264efacf18dd665d2066f21df3a3290b52ba240",
        "files": [
          "ref/poly.c",
          "ref/verify.c",
          "ref/verify.h"
        ],
        "message": "Fixed secret-dependent branch in poly_frommsg introduced by recent versions of clang with some flags (Thanks to Antoon Purnal for pointing this out!)",
        "before_after_code_files": [
          "ref/poly.c||ref/poly.c",
          "ref/verify.c||ref/verify.c",
          "ref/verify.h||ref/verify.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ref/poly.c||ref/poly.c",
            "ref/verify.c||ref/verify.c",
            "ref/verify.h||ref/verify.h"
          ],
          "candidate": [
            "ref/poly.c||ref/poly.c",
            "ref/verify.c||ref/verify.c",
            "ref/verify.h||ref/verify.h"
          ]
        }
      },
      "candidate_diff": {
        "ref/poly.c||ref/poly.c": [
          "File: ref/poly.c -> ref/poly.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: #include \"reduce.h\"",
          "6: #include \"cbd.h\"",
          "7: #include \"symmetric.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8: #include \"verify.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "167: void poly_frommsg(poly *r, const uint8_t msg[KYBER_INDCPA_MSGBYTES])",
          "168: {",
          "169:   unsigned int i,j;",
          "172: #if (KYBER_INDCPA_MSGBYTES != KYBER_N/8)",
          "173: #error \"KYBER_INDCPA_MSGBYTES must be equal to KYBER_N/8 bytes!\"",
          "",
          "[Removed Lines]",
          "170:   int16_t mask;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "176:   for(i=0;i<KYBER_N/8;i++) {",
          "177:     for(j=0;j<8;j++) {",
          "180:     }",
          "181:   }",
          "182: }",
          "",
          "[Removed Lines]",
          "178:       mask = -(int16_t)((msg[i] >> j)&1);",
          "179:       r->coeffs[8*i+j] = mask & ((KYBER_Q+1)/2);",
          "",
          "[Added Lines]",
          "178:       r->coeffs[8*i+j] = 0;",
          "179:       cmov_int16(r->coeffs+8*i+j, ((KYBER_Q+1)/2), (msg[i] >> j)&1);",
          "",
          "---------------"
        ],
        "ref/verify.c||ref/verify.c": [
          "File: ref/verify.c -> ref/verify.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "45:   for(i=0;i<len;i++)",
          "46:     r[i] ^= b & (r[i] ^ x[i]);",
          "47: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "49: void cmov_int16(int16_t *r, int16_t v, uint16_t b)",
          "50: {",
          "51:   b = -b;",
          "53: }",
          "",
          "---------------"
        ],
        "ref/verify.h||ref/verify.h": [
          "File: ref/verify.h -> ref/verify.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: #define cmov KYBER_NAMESPACE(cmov)",
          "12: void cmov(uint8_t *r, const uint8_t *x, size_t len, uint8_t b);",
          "14: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14: #define cmov_int16 KYBER_NAMESPACE(cmov_int16)",
          "15: void cmov_int16(int16_t *r, int16_t v, uint16_t b);",
          "",
          "---------------"
        ]
      }
    }
  ]
}