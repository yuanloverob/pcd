{
  "cve_id": "CVE-2021-36144",
  "cve_desc": "The polling timer handler in ACRN before 2.5 has a use-after-free for a freed virtio device, related to devicemodel/hw/pci/virtio/*.c.",
  "repo": "projectacrn/acrn-hypervisor",
  "patch_hash": "dd88504804e186029f845a166dc5c31695e2cca2",
  "patch_info": {
    "commit_hash": "dd88504804e186029f845a166dc5c31695e2cca2",
    "repo": "projectacrn/acrn-hypervisor",
    "commit_url": "https://github.com/projectacrn/acrn-hypervisor/pull/6268/commits/dd88504804e186029f845a166dc5c31695e2cca2",
    "files": [
      "devicemodel/hw/pci/virtio/virtio_audio.c",
      "devicemodel/hw/pci/virtio/virtio_block.c",
      "devicemodel/hw/pci/virtio/virtio_console.c",
      "devicemodel/hw/pci/virtio/virtio_coreu.c",
      "devicemodel/hw/pci/virtio/virtio_gpio.c",
      "devicemodel/hw/pci/virtio/virtio_hdcp.c",
      "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
      "devicemodel/hw/pci/virtio/virtio_i2c.c",
      "devicemodel/hw/pci/virtio/virtio_input.c",
      "devicemodel/hw/pci/virtio/virtio_ipu.c",
      "devicemodel/hw/pci/virtio/virtio_mei.c",
      "devicemodel/hw/pci/virtio/virtio_net.c",
      "devicemodel/hw/pci/virtio/virtio_rnd.c",
      "devicemodel/hw/pci/virtio/virtio_rpmb.c"
    ],
    "message": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
    "before_after_code_files": [
      "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
      "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
      "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
      "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
      "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
      "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
      "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
      "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
      "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
      "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
      "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
      "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
      "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
      "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
    ]
  },
  "patch_diff": {
    "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c": [
      "File: devicemodel/hw/pci/virtio/virtio_audio.c -> devicemodel/hw/pci/virtio/virtio_audio.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "376:   close(virt_audio->vbs_k.audio_fd);",
      "377:   virt_audio->vbs_k.audio_fd = -1;",
      "378:  }",
      "379:  pthread_mutex_destroy(&virt_audio->mtx);",
      "380:  DPRINTF((\"%s: free struct virtio_audio!\\n\", __func__));",
      "381:  free((struct virtio_audio *)dev->arg);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "379:  virtio_audio_reset(virt_audio);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c": [
      "File: devicemodel/hw/pci/virtio/virtio_block.c -> devicemodel/hw/pci/virtio/virtio_block.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "587:     WPRINTF((\"vrito_blk: Failed to flush before close\\n\"));",
      "588:    blockif_close(bctxt);",
      "589:   }",
      "590:   free(blk);",
      "591:  }",
      "592: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "590:   virtio_reset_dev(&blk->base);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c": [
      "File: devicemodel/hw/pci/virtio/virtio_console.c -> devicemodel/hw/pci/virtio/virtio_console.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1009: virtio_console_destroy(struct virtio_console *console)",
      "1010: {",
      "1011:  if (console) {",
      "1012:   if (console->config)",
      "1013:    free(console->config);",
      "1014:   free(console);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1012:   virtio_console_reset(console);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c": [
      "File: devicemodel/hw/pci/virtio/virtio_coreu.c -> devicemodel/hw/pci/virtio/virtio_coreu.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "358:  pthread_cond_destroy(&vcoreu->rx_cond);",
      "359:  pthread_join(vcoreu->rx_tid, NULL);",
      "361:  free(vcoreu);",
      "362: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "361:  virtio_coreu_reset(vcoreu);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c": [
      "File: devicemodel/hw/pci/virtio/virtio_gpio.c -> devicemodel/hw/pci/virtio/virtio_gpio.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1433:   gpio_irq_deinit(gpio);",
      "1434:   for (i = 0; i < gpio->nchip; i++)",
      "1435:    native_gpio_close_chip(&gpio->chips[i]);",
      "1436:   free(gpio);",
      "1437:   dev->arg = NULL;",
      "1438:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1436:   virtio_gpio_reset(gpio);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c": [
      "File: devicemodel/hw/pci/virtio/virtio_hdcp.c -> devicemodel/hw/pci/virtio/virtio_hdcp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "481:  if (vhdcp) {",
      "482:   DPRINTF((\"free struct virtio_hdcp\\n\"));",
      "483:   free(vhdcp);",
      "484:  }",
      "485: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "483:   virtio_hdcp_reset(vhdcp);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c": [
      "File: devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c -> devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "348:   vbs_k_hyper_dmabuf_fd = -1;",
      "349:  }",
      "352:   free((struct virtio_hyper_dmabuf *)dev->arg);",
      "353: }",
      "355: struct pci_vdev_ops pci_ops_virtio_hyper_dmabuf = {",
      "",
      "[Removed Lines]",
      "351:  if (dev->arg)",
      "",
      "[Added Lines]",
      "351:  if (dev->arg) {",
      "352:   virtio_hyper_dmabuf_reset(dev->arg);",
      "354:  }",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c": [
      "File: devicemodel/hw/pci/virtio/virtio_i2c.c -> devicemodel/hw/pci/virtio/virtio_i2c.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "826:   native_adapter_remove(vi2c);",
      "827:   pthread_mutex_destroy(&vi2c->req_mtx);",
      "828:   pthread_mutex_destroy(&vi2c->mtx);",
      "829:   free(vi2c);",
      "830:   dev->arg = NULL;",
      "831:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "829:   virtio_i2c_reset(vi2c);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c": [
      "File: devicemodel/hw/pci/virtio/virtio_input.c -> devicemodel/hw/pci/virtio/virtio_input.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "585:    free(vi->evdev);",
      "586:   if (vi->serial)",
      "587:    free(vi->serial);",
      "588:   free(vi);",
      "589:   vi = NULL;",
      "590:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "589:   virtio_input_reset(vi);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c": [
      "File: devicemodel/hw/pci/virtio/virtio_ipu.c -> devicemodel/hw/pci/virtio/virtio_ipu.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "377:    close(ipu->vbs_k.ipu_fd);",
      "378:   ipu->vbs_k.ipu_fd = -1;",
      "379:  }",
      "380:  pthread_mutex_destroy(&ipu->mtx);",
      "381:  free(ipu);",
      "382: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "380:  virtio_ipu_reset(ipu);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c": [
      "File: devicemodel/hw/pci/virtio/virtio_mei.c -> devicemodel/hw/pci/virtio/virtio_mei.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "971:  vmei->reset_mevp = NULL;",
      "973:  pthread_mutex_destroy(&vmei->mutex);",
      "974:  free(vmei->config);",
      "975:  free(vmei);",
      "976: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "974:  virtio_reset_dev(&vmei->base);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c": [
      "File: devicemodel/hw/pci/virtio/virtio_net.c -> devicemodel/hw/pci/virtio/virtio_net.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1067:  } else",
      "1068:   pr_err(\"net->tapfd is -1!\\n\");",
      "1070:  free(net);",
      "1071: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1070:  virtio_reset_dev(&net->base);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c": [
      "File: devicemodel/hw/pci/virtio/virtio_rnd.c -> devicemodel/hw/pci/virtio/virtio_rnd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "510:   close(rnd->fd);",
      "511:   rnd->fd = -1;",
      "512:  }",
      "513:  DPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));",
      "514:  free(rnd);",
      "515: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "513:  virtio_rnd_reset(rnd);",
      "",
      "---------------"
    ],
    "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c": [
      "File: devicemodel/hw/pci/virtio/virtio_rpmb.c -> devicemodel/hw/pci/virtio/virtio_rpmb.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "794: {",
      "795:  if (dev->arg) {",
      "796:   DPRINTF((\"virtio_rpmb_be_deinit: free struct virtio_rpmb!\\n\"));",
      "797:   free((struct virtio_rpmb *)dev->arg);",
      "798:  }",
      "799: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "797:   virtio_rpmb_reset(dev->arg);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a65e01ae9547be78ccad26333a907743c8c8c5d7",
      "candidate_info": {
        "commit_hash": "a65e01ae9547be78ccad26333a907743c8c8c5d7",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/a65e01ae9547be78ccad26333a907743c8c8c5d7",
        "files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ],
        "message": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_audio.c -> devicemodel/hw/pci/virtio/virtio_audio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:   close(virt_audio->vbs_k.audio_fd);",
          "377:   virt_audio->vbs_k.audio_fd = -1;",
          "378:  }",
          "379:  pthread_mutex_destroy(&virt_audio->mtx);",
          "380:  DPRINTF((\"%s: free struct virtio_audio!\\n\", __func__));",
          "381:  free((struct virtio_audio *)dev->arg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "379:  virtio_audio_reset(virt_audio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c": [
          "File: devicemodel/hw/pci/virtio/virtio_block.c -> devicemodel/hw/pci/virtio/virtio_block.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "587:     WPRINTF((\"vrito_blk: Failed to flush before close\\n\"));",
          "588:    blockif_close(bctxt);",
          "589:   }",
          "590:   free(blk);",
          "591:  }",
          "592: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "590:   virtio_reset_dev(&blk->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c": [
          "File: devicemodel/hw/pci/virtio/virtio_console.c -> devicemodel/hw/pci/virtio/virtio_console.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1009: virtio_console_destroy(struct virtio_console *console)",
          "1010: {",
          "1011:  if (console) {",
          "1012:   if (console->config)",
          "1013:    free(console->config);",
          "1014:   free(console);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1012:   virtio_console_reset(console);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_coreu.c -> devicemodel/hw/pci/virtio/virtio_coreu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "358:  pthread_cond_destroy(&vcoreu->rx_cond);",
          "359:  pthread_join(vcoreu->rx_tid, NULL);",
          "361:  free(vcoreu);",
          "362: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361:  virtio_coreu_reset(vcoreu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_gpio.c -> devicemodel/hw/pci/virtio/virtio_gpio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1433:   gpio_irq_deinit(gpio);",
          "1434:   for (i = 0; i < gpio->nchip; i++)",
          "1435:    native_gpio_close_chip(&gpio->chips[i]);",
          "1436:   free(gpio);",
          "1437:   dev->arg = NULL;",
          "1438:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1436:   virtio_gpio_reset(gpio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hdcp.c -> devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:  if (vhdcp) {",
          "482:   DPRINTF((\"free struct virtio_hdcp\\n\"));",
          "483:   free(vhdcp);",
          "484:  }",
          "485: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "483:   virtio_hdcp_reset(vhdcp);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c -> devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "348:   vbs_k_hyper_dmabuf_fd = -1;",
          "349:  }",
          "352:   free((struct virtio_hyper_dmabuf *)dev->arg);",
          "353: }",
          "355: struct pci_vdev_ops pci_ops_virtio_hyper_dmabuf = {",
          "",
          "[Removed Lines]",
          "351:  if (dev->arg)",
          "",
          "[Added Lines]",
          "351:  if (dev->arg) {",
          "352:   virtio_hyper_dmabuf_reset(dev->arg);",
          "354:  }",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c": [
          "File: devicemodel/hw/pci/virtio/virtio_i2c.c -> devicemodel/hw/pci/virtio/virtio_i2c.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "826:   native_adapter_remove(vi2c);",
          "827:   pthread_mutex_destroy(&vi2c->req_mtx);",
          "828:   pthread_mutex_destroy(&vi2c->mtx);",
          "829:   free(vi2c);",
          "830:   dev->arg = NULL;",
          "831:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "829:   virtio_i2c_reset(vi2c);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c": [
          "File: devicemodel/hw/pci/virtio/virtio_input.c -> devicemodel/hw/pci/virtio/virtio_input.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "585:    free(vi->evdev);",
          "586:   if (vi->serial)",
          "587:    free(vi->serial);",
          "588:   free(vi);",
          "589:   vi = NULL;",
          "590:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "589:   virtio_input_reset(vi);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_ipu.c -> devicemodel/hw/pci/virtio/virtio_ipu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "377:    close(ipu->vbs_k.ipu_fd);",
          "378:   ipu->vbs_k.ipu_fd = -1;",
          "379:  }",
          "380:  pthread_mutex_destroy(&ipu->mtx);",
          "381:  free(ipu);",
          "382: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "380:  virtio_ipu_reset(ipu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c": [
          "File: devicemodel/hw/pci/virtio/virtio_mei.c -> devicemodel/hw/pci/virtio/virtio_mei.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "971:  vmei->reset_mevp = NULL;",
          "973:  pthread_mutex_destroy(&vmei->mutex);",
          "974:  free(vmei->config);",
          "975:  free(vmei);",
          "976: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "974:  virtio_reset_dev(&vmei->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c": [
          "File: devicemodel/hw/pci/virtio/virtio_net.c -> devicemodel/hw/pci/virtio/virtio_net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1067:  } else",
          "1068:   pr_err(\"net->tapfd is -1!\\n\");",
          "1070:  free(net);",
          "1071: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1070:  virtio_reset_dev(&net->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rnd.c -> devicemodel/hw/pci/virtio/virtio_rnd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "510:   close(rnd->fd);",
          "511:   rnd->fd = -1;",
          "512:  }",
          "513:  DPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));",
          "514:  free(rnd);",
          "515: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "513:  virtio_rnd_reset(rnd);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rpmb.c -> devicemodel/hw/pci/virtio/virtio_rpmb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "794: {",
          "795:  if (dev->arg) {",
          "796:   DPRINTF((\"virtio_rpmb_be_deinit: free struct virtio_rpmb!\\n\"));",
          "797:   free((struct virtio_rpmb *)dev->arg);",
          "798:  }",
          "799: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "797:   virtio_rpmb_reset(dev->arg);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e00c4176e14072be92bf126e6f6b61a20872a307",
      "candidate_info": {
        "commit_hash": "e00c4176e14072be92bf126e6f6b61a20872a307",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/e00c4176e14072be92bf126e6f6b61a20872a307",
        "files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ],
        "message": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_audio.c -> devicemodel/hw/pci/virtio/virtio_audio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:   close(virt_audio->vbs_k.audio_fd);",
          "377:   virt_audio->vbs_k.audio_fd = -1;",
          "378:  }",
          "379:  pthread_mutex_destroy(&virt_audio->mtx);",
          "380:  DPRINTF((\"%s: free struct virtio_audio!\\n\", __func__));",
          "381:  free((struct virtio_audio *)dev->arg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "379:  virtio_audio_reset(virt_audio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c": [
          "File: devicemodel/hw/pci/virtio/virtio_block.c -> devicemodel/hw/pci/virtio/virtio_block.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "587:     WPRINTF((\"vrito_blk: Failed to flush before close\\n\"));",
          "588:    blockif_close(bctxt);",
          "589:   }",
          "590:   free(blk);",
          "591:  }",
          "592: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "590:   virtio_reset_dev(&blk->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c": [
          "File: devicemodel/hw/pci/virtio/virtio_console.c -> devicemodel/hw/pci/virtio/virtio_console.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1007: virtio_console_destroy(struct virtio_console *console)",
          "1008: {",
          "1009:  if (console) {",
          "1010:   if (console->config)",
          "1011:    free(console->config);",
          "1012:   free(console);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1010:   virtio_console_reset(console);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_coreu.c -> devicemodel/hw/pci/virtio/virtio_coreu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "358:  pthread_cond_destroy(&vcoreu->rx_cond);",
          "359:  pthread_join(vcoreu->rx_tid, NULL);",
          "361:  free(vcoreu);",
          "362: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361:  virtio_coreu_reset(vcoreu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_gpio.c -> devicemodel/hw/pci/virtio/virtio_gpio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1433:   gpio_irq_deinit(gpio);",
          "1434:   for (i = 0; i < gpio->nchip; i++)",
          "1435:    native_gpio_close_chip(&gpio->chips[i]);",
          "1436:   free(gpio);",
          "1437:   dev->arg = NULL;",
          "1438:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1436:   virtio_gpio_reset(gpio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hdcp.c -> devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:  if (vhdcp) {",
          "482:   DPRINTF((\"free struct virtio_hdcp\\n\"));",
          "483:   free(vhdcp);",
          "484:  }",
          "485: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "483:   virtio_hdcp_reset(vhdcp);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c -> devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "348:   vbs_k_hyper_dmabuf_fd = -1;",
          "349:  }",
          "352:   free((struct virtio_hyper_dmabuf *)dev->arg);",
          "353: }",
          "355: struct pci_vdev_ops pci_ops_virtio_hyper_dmabuf = {",
          "",
          "[Removed Lines]",
          "351:  if (dev->arg)",
          "",
          "[Added Lines]",
          "351:  if (dev->arg) {",
          "352:   virtio_hyper_dmabuf_reset(dev->arg);",
          "354:  }",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c": [
          "File: devicemodel/hw/pci/virtio/virtio_i2c.c -> devicemodel/hw/pci/virtio/virtio_i2c.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "826:   native_adapter_remove(vi2c);",
          "827:   pthread_mutex_destroy(&vi2c->req_mtx);",
          "828:   pthread_mutex_destroy(&vi2c->mtx);",
          "829:   free(vi2c);",
          "830:   dev->arg = NULL;",
          "831:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "829:   virtio_i2c_reset(vi2c);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c": [
          "File: devicemodel/hw/pci/virtio/virtio_input.c -> devicemodel/hw/pci/virtio/virtio_input.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "585:    free(vi->evdev);",
          "586:   if (vi->serial)",
          "587:    free(vi->serial);",
          "588:   free(vi);",
          "589:   vi = NULL;",
          "590:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "589:   virtio_input_reset(vi);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_ipu.c -> devicemodel/hw/pci/virtio/virtio_ipu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "377:    close(ipu->vbs_k.ipu_fd);",
          "378:   ipu->vbs_k.ipu_fd = -1;",
          "379:  }",
          "380:  pthread_mutex_destroy(&ipu->mtx);",
          "381:  free(ipu);",
          "382: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "380:  virtio_ipu_reset(ipu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c": [
          "File: devicemodel/hw/pci/virtio/virtio_mei.c -> devicemodel/hw/pci/virtio/virtio_mei.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "971:  vmei->reset_mevp = NULL;",
          "973:  pthread_mutex_destroy(&vmei->mutex);",
          "974:  free(vmei->config);",
          "975:  free(vmei);",
          "976: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "974:  virtio_reset_dev(&vmei->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c": [
          "File: devicemodel/hw/pci/virtio/virtio_net.c -> devicemodel/hw/pci/virtio/virtio_net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1002:  } else",
          "1003:   pr_err(\"net->tapfd is -1!\\n\");",
          "1005:  free(net);",
          "1006: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1005:  virtio_reset_dev(&net->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rnd.c -> devicemodel/hw/pci/virtio/virtio_rnd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "510:   close(rnd->fd);",
          "511:   rnd->fd = -1;",
          "512:  }",
          "513:  DPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));",
          "514:  free(rnd);",
          "515: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "513:  virtio_rnd_reset(rnd);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rpmb.c -> devicemodel/hw/pci/virtio/virtio_rpmb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "794: {",
          "795:  if (dev->arg) {",
          "796:   DPRINTF((\"virtio_rpmb_be_deinit: free struct virtio_rpmb!\\n\"));",
          "797:   free((struct virtio_rpmb *)dev->arg);",
          "798:  }",
          "799: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "797:   virtio_rpmb_reset(dev->arg);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b1bb8ea4f1fd4c586e34eccb35969df3cd238925",
      "candidate_info": {
        "commit_hash": "b1bb8ea4f1fd4c586e34eccb35969df3cd238925",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/b1bb8ea4f1fd4c586e34eccb35969df3cd238925",
        "files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ],
        "message": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
          "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_audio.c -> devicemodel/hw/pci/virtio/virtio_audio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:   close(virt_audio->vbs_k.audio_fd);",
          "377:   virt_audio->vbs_k.audio_fd = -1;",
          "378:  }",
          "379:  pthread_mutex_destroy(&virt_audio->mtx);",
          "380:  DPRINTF((\"%s: free struct virtio_audio!\\n\", __func__));",
          "381:  free((struct virtio_audio *)dev->arg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "379:  virtio_audio_reset(virt_audio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c": [
          "File: devicemodel/hw/pci/virtio/virtio_block.c -> devicemodel/hw/pci/virtio/virtio_block.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "587:     WPRINTF((\"vrito_blk: Failed to flush before close\\n\"));",
          "588:    blockif_close(bctxt);",
          "589:   }",
          "590:   free(blk);",
          "591:  }",
          "592: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "590:   virtio_reset_dev(&blk->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c": [
          "File: devicemodel/hw/pci/virtio/virtio_console.c -> devicemodel/hw/pci/virtio/virtio_console.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1009: virtio_console_destroy(struct virtio_console *console)",
          "1010: {",
          "1011:  if (console) {",
          "1012:   if (console->config)",
          "1013:    free(console->config);",
          "1014:   free(console);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1012:   virtio_console_reset(console);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_coreu.c -> devicemodel/hw/pci/virtio/virtio_coreu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "358:  pthread_cond_destroy(&vcoreu->rx_cond);",
          "359:  pthread_join(vcoreu->rx_tid, NULL);",
          "361:  free(vcoreu);",
          "362: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361:  virtio_coreu_reset(vcoreu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_gpio.c||devicemodel/hw/pci/virtio/virtio_gpio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_gpio.c -> devicemodel/hw/pci/virtio/virtio_gpio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1433:   gpio_irq_deinit(gpio);",
          "1434:   for (i = 0; i < gpio->nchip; i++)",
          "1435:    native_gpio_close_chip(&gpio->chips[i]);",
          "1436:   free(gpio);",
          "1437:   dev->arg = NULL;",
          "1438:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1436:   virtio_gpio_reset(gpio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hdcp.c -> devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:  if (vhdcp) {",
          "482:   DPRINTF((\"free struct virtio_hdcp\\n\"));",
          "483:   free(vhdcp);",
          "484:  }",
          "485: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "483:   virtio_hdcp_reset(vhdcp);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c -> devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "348:   vbs_k_hyper_dmabuf_fd = -1;",
          "349:  }",
          "352:   free((struct virtio_hyper_dmabuf *)dev->arg);",
          "353: }",
          "355: struct pci_vdev_ops pci_ops_virtio_hyper_dmabuf = {",
          "",
          "[Removed Lines]",
          "351:  if (dev->arg)",
          "",
          "[Added Lines]",
          "351:  if (dev->arg) {",
          "352:   virtio_hyper_dmabuf_reset(dev->arg);",
          "354:  }",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_i2c.c||devicemodel/hw/pci/virtio/virtio_i2c.c": [
          "File: devicemodel/hw/pci/virtio/virtio_i2c.c -> devicemodel/hw/pci/virtio/virtio_i2c.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "826:   native_adapter_remove(vi2c);",
          "827:   pthread_mutex_destroy(&vi2c->req_mtx);",
          "828:   pthread_mutex_destroy(&vi2c->mtx);",
          "829:   free(vi2c);",
          "830:   dev->arg = NULL;",
          "831:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "829:   virtio_i2c_reset(vi2c);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c": [
          "File: devicemodel/hw/pci/virtio/virtio_input.c -> devicemodel/hw/pci/virtio/virtio_input.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "585:    free(vi->evdev);",
          "586:   if (vi->serial)",
          "587:    free(vi->serial);",
          "588:   free(vi);",
          "589:   vi = NULL;",
          "590:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "589:   virtio_input_reset(vi);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_ipu.c -> devicemodel/hw/pci/virtio/virtio_ipu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "377:    close(ipu->vbs_k.ipu_fd);",
          "378:   ipu->vbs_k.ipu_fd = -1;",
          "379:  }",
          "380:  pthread_mutex_destroy(&ipu->mtx);",
          "381:  free(ipu);",
          "382: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "380:  virtio_ipu_reset(ipu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c": [
          "File: devicemodel/hw/pci/virtio/virtio_mei.c -> devicemodel/hw/pci/virtio/virtio_mei.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "971:  vmei->reset_mevp = NULL;",
          "973:  pthread_mutex_destroy(&vmei->mutex);",
          "974:  free(vmei->config);",
          "975:  free(vmei);",
          "976: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "974:  virtio_reset_dev(&vmei->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c": [
          "File: devicemodel/hw/pci/virtio/virtio_net.c -> devicemodel/hw/pci/virtio/virtio_net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1067:  } else",
          "1068:   pr_err(\"net->tapfd is -1!\\n\");",
          "1070:  free(net);",
          "1071: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1070:  virtio_reset_dev(&net->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rnd.c -> devicemodel/hw/pci/virtio/virtio_rnd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "510:   close(rnd->fd);",
          "511:   rnd->fd = -1;",
          "512:  }",
          "513:  DPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));",
          "514:  free(rnd);",
          "515: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "513:  virtio_rnd_reset(rnd);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rpmb.c -> devicemodel/hw/pci/virtio/virtio_rpmb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "794: {",
          "795:  if (dev->arg) {",
          "796:   DPRINTF((\"virtio_rpmb_be_deinit: free struct virtio_rpmb!\\n\"));",
          "797:   free((struct virtio_rpmb *)dev->arg);",
          "798:  }",
          "799: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "797:   virtio_rpmb_reset(dev->arg);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2b91780b4e0d2a0c5a8715241739dccde478b720",
      "candidate_info": {
        "commit_hash": "2b91780b4e0d2a0c5a8715241739dccde478b720",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/2b91780b4e0d2a0c5a8715241739dccde478b720",
        "files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ],
        "message": "dm: Reset virtio device before release\n\nWith virtio polling mode enabled, a timer is running in the virtio\nbackend service. And the timer will also be triggered if its frondend\ndriver didn't do the device reset in shutdown. A freed virtio device\nwill be accessed in the polling timer handler.\n\nDo the virtio reset() callback specifically to clear the polling timer\nbefore the free.\n\nTracked-On: #6147\nSigned-off-by: Shuo A Liu <shuo.a.liu@intel.com>\nSigned-off-by: Yonghua Huang <yonghua.huang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
          "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
          "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
          "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
          "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
          "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
          "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
          "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
          "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
          "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c",
            "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c",
            "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c",
            "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c",
            "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c",
            "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
            "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c",
            "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c",
            "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c",
            "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c",
            "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c",
            "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/virtio/virtio_audio.c||devicemodel/hw/pci/virtio/virtio_audio.c": [
          "File: devicemodel/hw/pci/virtio/virtio_audio.c -> devicemodel/hw/pci/virtio/virtio_audio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "372:   close(virt_audio->vbs_k.audio_fd);",
          "373:   virt_audio->vbs_k.audio_fd = -1;",
          "374:  }",
          "375:  pthread_mutex_destroy(&virt_audio->mtx);",
          "376:  DPRINTF((\"%s: free struct virtio_audio!\\n\", __func__));",
          "377:  free((struct virtio_audio *)dev->arg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "375:  virtio_audio_reset(virt_audio);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_block.c||devicemodel/hw/pci/virtio/virtio_block.c": [
          "File: devicemodel/hw/pci/virtio/virtio_block.c -> devicemodel/hw/pci/virtio/virtio_block.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "482:    WPRINTF((\"vrito_blk:\"",
          "483:     \"Failed to flush before close\\n\"));",
          "484:   blockif_close(bctxt);",
          "485:   free(blk);",
          "486:  }",
          "487: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "485:   virtio_reset_dev(&blk->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_console.c||devicemodel/hw/pci/virtio/virtio_console.c": [
          "File: devicemodel/hw/pci/virtio/virtio_console.c -> devicemodel/hw/pci/virtio/virtio_console.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "740: virtio_console_destroy(struct virtio_console *console)",
          "741: {",
          "742:  if (console) {",
          "743:   if (console->config)",
          "744:    free(console->config);",
          "745:   free(console);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "743:   virtio_console_reset(console);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_coreu.c||devicemodel/hw/pci/virtio/virtio_coreu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_coreu.c -> devicemodel/hw/pci/virtio/virtio_coreu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "341:  pthread_cond_destroy(&vcoreu->rx_cond);",
          "342:  pthread_join(vcoreu->rx_tid, NULL);",
          "344:  free(vcoreu);",
          "345: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "344:  virtio_coreu_reset(vcoreu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hdcp.c||devicemodel/hw/pci/virtio/virtio_hdcp.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hdcp.c -> devicemodel/hw/pci/virtio/virtio_hdcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "467:  if (vhdcp) {",
          "468:   DPRINTF((\"free struct virtio_hdcp\\n\"));",
          "469:   free(vhdcp);",
          "470:  }",
          "471: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "469:   virtio_hdcp_reset(vhdcp);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c||devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c": [
          "File: devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c -> devicemodel/hw/pci/virtio/virtio_hyper_dmabuf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "348:   vbs_k_hyper_dmabuf_fd = -1;",
          "349:  }",
          "352:   free((struct virtio_hyper_dmabuf *)dev->arg);",
          "353: }",
          "355: struct pci_vdev_ops pci_ops_virtio_hyper_dmabuf = {",
          "",
          "[Removed Lines]",
          "351:  if (dev->arg)",
          "",
          "[Added Lines]",
          "351:  if (dev->arg) {",
          "352:   virtio_hyper_dmabuf_reset(dev->arg);",
          "354:  }",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_input.c||devicemodel/hw/pci/virtio/virtio_input.c": [
          "File: devicemodel/hw/pci/virtio/virtio_input.c -> devicemodel/hw/pci/virtio/virtio_input.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "559:    free(vi->evdev);",
          "560:   if (vi->serial)",
          "561:    free(vi->serial);",
          "562:   free(vi);",
          "563:   vi = NULL;",
          "564:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "563:   virtio_input_reset(vi);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_ipu.c||devicemodel/hw/pci/virtio/virtio_ipu.c": [
          "File: devicemodel/hw/pci/virtio/virtio_ipu.c -> devicemodel/hw/pci/virtio/virtio_ipu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "379:   close(ipu->vbs_k.ipu_fd);",
          "380:   ipu->vbs_k.ipu_fd = -1;",
          "381:  }",
          "382:  pthread_mutex_destroy(&ipu->mtx);",
          "383:  free(ipu);",
          "384: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "382:  virtio_ipu_reset(ipu);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_mei.c||devicemodel/hw/pci/virtio/virtio_mei.c": [
          "File: devicemodel/hw/pci/virtio/virtio_mei.c -> devicemodel/hw/pci/virtio/virtio_mei.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "976:  vmei->reset_mevp = NULL;",
          "978:  pthread_mutex_destroy(&vmei->mutex);",
          "979:  free(vmei->config);",
          "980:  free(vmei);",
          "981: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "979:  virtio_reset_dev(&vmei->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_net.c||devicemodel/hw/pci/virtio/virtio_net.c": [
          "File: devicemodel/hw/pci/virtio/virtio_net.c -> devicemodel/hw/pci/virtio/virtio_net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "975:  } else",
          "976:   fprintf(stderr, \"net->tapfd is -1!\\n\");",
          "978:  free(net);",
          "979: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "978:  virtio_reset_dev(&net->base);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rnd.c||devicemodel/hw/pci/virtio/virtio_rnd.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rnd.c -> devicemodel/hw/pci/virtio/virtio_rnd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "492:  assert(rnd->fd >= 0);",
          "493:  close(rnd->fd);",
          "494:  DPRINTF((\"%s: free struct virtio_rnd!\\n\", __func__));",
          "495:  free(rnd);",
          "496: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "495:  virtio_rnd_reset(rnd);",
          "",
          "---------------"
        ],
        "devicemodel/hw/pci/virtio/virtio_rpmb.c||devicemodel/hw/pci/virtio/virtio_rpmb.c": [
          "File: devicemodel/hw/pci/virtio/virtio_rpmb.c -> devicemodel/hw/pci/virtio/virtio_rpmb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "777: {",
          "778:  if (dev->arg) {",
          "779:   DPRINTF((\"virtio_rpmb_be_deinit: free struct virtio_rpmb!\\n\"));",
          "780:   free((struct virtio_rpmb *)dev->arg);",
          "781:  }",
          "782: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "780:   virtio_rpmb_reset(dev->arg);",
          "",
          "---------------"
        ]
      }
    }
  ]
}