{
  "cve_id": "CVE-2019-15691",
  "cve_desc": "TigerVNC version prior to 1.10.1 is vulnerable to stack use-after-return, which occurs due to incorrect usage of stack memory in ZRLEDecoder. If decoding routine would throw an exception, ZRLEDecoder may try to access stack variable, which has been already freed during the process of stack unwinding. Exploitation of this vulnerability could potentially result into remote code execution. This attack appear to be exploitable via network connectivity.",
  "repo": "CendioOssman/tigervnc",
  "patch_hash": "d61a767d6842b530ffb532ddd5a3d233119aad40",
  "patch_info": {
    "commit_hash": "d61a767d6842b530ffb532ddd5a3d233119aad40",
    "repo": "CendioOssman/tigervnc",
    "commit_url": "https://github.com/CendioOssman/tigervnc/commit/d61a767d6842b530ffb532ddd5a3d233119aad40",
    "files": [
      "common/rdr/ZlibInStream.cxx",
      "common/rdr/ZlibInStream.h",
      "common/rfb/CMsgReader.cxx",
      "common/rfb/SMsgReader.cxx",
      "common/rfb/TightDecoder.cxx",
      "common/rfb/zrleDecode.h"
    ],
    "message": "Make ZlibInStream more robust against failures\n\nMove the checks around to avoid missing cases where we might access\nmemory that is no longer valid. Also avoid touching the underlying\nstream implicitly (e.g. via the destructor) as it might also no\nlonger be valid.\n\nA malicious server could theoretically use this for remote code\nexecution in the client.\n\nIssue found by Pavel Cheremushkin from Kaspersky Lab",
    "before_after_code_files": [
      "common/rdr/ZlibInStream.cxx||common/rdr/ZlibInStream.cxx",
      "common/rdr/ZlibInStream.h||common/rdr/ZlibInStream.h",
      "common/rfb/CMsgReader.cxx||common/rfb/CMsgReader.cxx",
      "common/rfb/SMsgReader.cxx||common/rfb/SMsgReader.cxx",
      "common/rfb/TightDecoder.cxx||common/rfb/TightDecoder.cxx",
      "common/rfb/zrleDecode.h||common/rfb/zrleDecode.h"
    ]
  },
  "patch_diff": {
    "common/rdr/ZlibInStream.cxx||common/rdr/ZlibInStream.cxx": [
      "File: common/rdr/ZlibInStream.cxx -> common/rdr/ZlibInStream.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "52:   return offset + ptr - start;",
      "53: }",
      "56: {",
      "57:   ptr = end = start;",
      "60:   while (bytesIn > 0) {",
      "61:     decompress(true);",
      "62:     end = start; // throw away any data",
      "63:   }",
      "65: }",
      "67: void ZlibInStream::reset()",
      "",
      "[Removed Lines]",
      "55: void ZlibInStream::removeUnderlying()",
      "58:   if (!underlying) return;",
      "64:   underlying = 0;",
      "",
      "[Added Lines]",
      "55: void ZlibInStream::flushUnderlying()",
      "64:   setUnderlying(NULL, 0);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "90: void ZlibInStream::deinit()",
      "91: {",
      "92:   assert(zs != NULL);",
      "94:   inflateEnd(zs);",
      "95:   delete zs;",
      "96:   zs = NULL;",
      "",
      "[Removed Lines]",
      "93:   removeUnderlying();",
      "",
      "[Added Lines]",
      "93:   setUnderlying(NULL, 0);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "100: {",
      "101:   if (itemSize > bufSize)",
      "102:     throw Exception(\"ZlibInStream overrun: max itemSize exceeded\");",
      "106:   if (end - ptr != 0)",
      "107:     memmove(start, ptr, end - ptr);",
      "",
      "[Removed Lines]",
      "103:   if (!underlying)",
      "104:     throw Exception(\"ZlibInStream overrun: no underlying stream\");",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "128: bool ZlibInStream::decompress(bool wait)",
      "129: {",
      "130:   zs->next_out = (U8*)end;",
      "131:   zs->avail_out = start + bufSize - end;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "128:   if (!underlying)",
      "129:     throw Exception(\"ZlibInStream overrun: no underlying stream\");",
      "",
      "---------------"
    ],
    "common/rdr/ZlibInStream.h||common/rdr/ZlibInStream.h": [
      "File: common/rdr/ZlibInStream.h -> common/rdr/ZlibInStream.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "38:     virtual ~ZlibInStream();",
      "40:     void setUnderlying(InStream* is, int bytesIn);",
      "42:     int pos();",
      "43:     void reset();",
      "",
      "[Removed Lines]",
      "41:     void removeUnderlying();",
      "",
      "[Added Lines]",
      "41:     void flushUnderlying();",
      "",
      "---------------"
    ],
    "common/rfb/CMsgReader.cxx||common/rfb/CMsgReader.cxx": [
      "File: common/rfb/CMsgReader.cxx -> common/rfb/CMsgReader.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "242:       num++;",
      "243:     }",
      "247:     handler->handleClipboardProvide(flags, lengths, buffers);",
      "",
      "[Removed Lines]",
      "245:     zis.removeUnderlying();",
      "",
      "[Added Lines]",
      "245:     zis.flushUnderlying();",
      "246:     zis.setUnderlying(NULL, 0);",
      "",
      "---------------"
    ],
    "common/rfb/SMsgReader.cxx||common/rfb/SMsgReader.cxx": [
      "File: common/rfb/SMsgReader.cxx -> common/rfb/SMsgReader.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "293:       num++;",
      "294:     }",
      "298:     handler->handleClipboardProvide(flags, lengths, buffers);",
      "",
      "[Removed Lines]",
      "296:     zis.removeUnderlying();",
      "",
      "[Added Lines]",
      "296:     zis.flushUnderlying();",
      "297:     zis.setUnderlying(NULL, 0);",
      "",
      "---------------"
    ],
    "common/rfb/TightDecoder.cxx||common/rfb/TightDecoder.cxx": [
      "File: common/rfb/TightDecoder.cxx -> common/rfb/TightDecoder.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "342:     zis[streamId].readBytes(netbuf, dataSize);",
      "345:     delete ms;",
      "347:     bufptr = netbuf;",
      "",
      "[Removed Lines]",
      "344:     zis[streamId].removeUnderlying();",
      "",
      "[Added Lines]",
      "344:     zis[streamId].flushUnderlying();",
      "345:     zis[streamId].setUnderlying(NULL, 0);",
      "",
      "---------------"
    ],
    "common/rfb/zrleDecode.h||common/rfb/zrleDecode.h": [
      "File: common/rfb/zrleDecode.h -> common/rfb/zrleDecode.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "174:     }",
      "175:   }",
      "178: }",
      "180: #undef ZRLE_DECODE",
      "",
      "[Removed Lines]",
      "177:   zis->removeUnderlying();",
      "",
      "[Added Lines]",
      "177:   zis->flushUnderlying();",
      "178:   zis->setUnderlying(NULL, 0);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "05e28490873a861379c943bf616614b78b558b89",
      "candidate_info": {
        "commit_hash": "05e28490873a861379c943bf616614b78b558b89",
        "repo": "CendioOssman/tigervnc",
        "commit_url": "https://github.com/CendioOssman/tigervnc/commit/05e28490873a861379c943bf616614b78b558b89",
        "files": [
          "common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx"
        ],
        "message": "Handle pixel formats with odd shift values\n\nOur fast paths assume that each channel fits in to a separate byte.\nThat means the shift needs to be a multiple of 8. Start actually\nchecking this so that a client cannot trip us up and possibly cause\nincorrect code exection.\n\nIssue found by Pavel Cheremushkin from Kaspersky Lab.",
        "before_after_code_files": [
          "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/TigerVNC/tigervnc/pull/921"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx": [
          "File: common/rfb/PixelFormat.cxx -> common/rfb/PixelFormat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "206:     return false;",
          "207:   if (blueMax != 255)",
          "208:     return false;",
          "210:   return true;",
          "211: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "209:   if ((redShift & 0x7) != 0)",
          "210:     return false;",
          "211:   if ((greenShift & 0x7) != 0)",
          "212:     return false;",
          "213:   if ((blueShift & 0x7) != 0)",
          "214:     return false;",
          "",
          "---------------"
        ],
        "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx": [
          "File: tests/unit/pixelformat.cxx -> tests/unit/pixelformat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "171:     do888Test(false, 8, 8, false, false, 0, 0, 0, 0, 0, 0);",
          "173:     printf(\"\\n\");",
          "174: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "175:     do888Test(false, 32, 24, false, true, 255, 255, 255, 0, 8, 18);",
          "176:     do888Test(false, 32, 24, false, true, 255, 255, 255, 0, 11, 24);",
          "177:     do888Test(false, 32, 24, false, true, 255, 255, 255, 4, 16, 24);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "996356b6c65ca165ee1ea46a571c32a1dc3c3821",
      "candidate_info": {
        "commit_hash": "996356b6c65ca165ee1ea46a571c32a1dc3c3821",
        "repo": "CendioOssman/tigervnc",
        "commit_url": "https://github.com/CendioOssman/tigervnc/commit/996356b6c65ca165ee1ea46a571c32a1dc3c3821",
        "files": [
          "common/rfb/PixelBuffer.cxx"
        ],
        "message": "Restrict PixelBuffer dimensions to safe values\n\nWe do a lot of calculations based on pixel coordinates and we need\nto make sure they do not overflow. Restrict the maximum dimensions\nwe support rather than try to switch over all calculations to use\n64 bit integers.\n\nThis prevents attackers from from injecting code by specifying a\nhuge framebuffer size and relying on the values overflowing to\naccess invalid areas of the heap.\n\nThis primarily affects the client which gets both the screen\ndimensions and the pixel contents from the remote side. But the\nserver might also be affected as a client can adjust the screen\ndimensions, as can applications inside the session.\n\nIssue found by Pavel Cheremushkin from Kaspersky Lab.",
        "before_after_code_files": [
          "common/rfb/PixelBuffer.cxx||common/rfb/PixelBuffer.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/TigerVNC/tigervnc/pull/921"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "common/rfb/PixelBuffer.cxx||common/rfb/PixelBuffer.cxx": [
          "File: common/rfb/PixelBuffer.cxx -> common/rfb/PixelBuffer.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: static LogWriter vlog(\"PixelBuffer\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38: const int maxPixelBufferWidth = 16384;",
          "39: const int maxPixelBufferHeight = 16384;",
          "40: const int maxPixelBufferStride = 16384;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "109: void PixelBuffer::setSize(int width, int height)",
          "110: {",
          "111:   width_ = width;",
          "112:   height_ = height;",
          "113: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119:   if ((width < 0) || (width > maxPixelBufferWidth))",
          "120:     throw rfb::Exception(\"Invalid PixelBuffer width of %d pixels requested\", width);",
          "121:   if ((height < 0) || (height > maxPixelBufferHeight))",
          "122:     throw rfb::Exception(\"Invalid PixelBuffer height of %d pixels requested\", height);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "340: void FullFramePixelBuffer::setBuffer(int width, int height,",
          "341:                                      rdr::U8* data_, int stride_)",
          "342: {",
          "343:   ModifiablePixelBuffer::setSize(width, height);",
          "344:   stride = stride_;",
          "345:   data = data_;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "356:   if ((width < 0) || (width > maxPixelBufferWidth))",
          "357:     throw rfb::Exception(\"Invalid PixelBuffer width of %d pixels requested\", width);",
          "358:   if ((height < 0) || (height > maxPixelBufferHeight))",
          "359:     throw rfb::Exception(\"Invalid PixelBuffer height of %d pixels requested\", height);",
          "360:   if ((stride_ < 0) || (stride_ > maxPixelBufferStride) || (stride_ < width))",
          "361:     throw rfb::Exception(\"Invalid PixelBuffer stride of %d pixels requested\", stride_);",
          "362:   if ((width != 0) && (height != 0) && (data_ == NULL))",
          "363:     throw rfb::Exception(\"PixelBuffer requested without a valid memory area\");",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cd1d650c532a46e95a1229dffaf281c76a50cdfe",
      "candidate_info": {
        "commit_hash": "cd1d650c532a46e95a1229dffaf281c76a50cdfe",
        "repo": "CendioOssman/tigervnc",
        "commit_url": "https://github.com/CendioOssman/tigervnc/commit/cd1d650c532a46e95a1229dffaf281c76a50cdfe",
        "files": [
          "common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx"
        ],
        "message": "Add sanity checks for PixelFormat shift values\n\nOtherwise we might be tricked in to reading and writing things at\nincorrect offsets for pixels which ultimately could result in an\nattacker writing things to the stack or heap and executing things\nthey shouldn't.\n\nThis only affects the server as the client never uses the pixel\nformat suggested by th server.\n\nIssue found by Pavel Cheremushkin from Kaspersky Lab.",
        "before_after_code_files": [
          "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/TigerVNC/tigervnc/pull/921"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx": [
          "File: common/rfb/PixelFormat.cxx -> common/rfb/PixelFormat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "682:   if (totalBits > depth)",
          "683:     return false;",
          "685:   if (((redMax << redShift) & (greenMax << greenShift)) != 0)",
          "686:     return false;",
          "687:   if (((redMax << redShift) & (blueMax << blueShift)) != 0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "685:   if ((bits(redMax) + redShift) > bpp)",
          "686:     return false;",
          "687:   if ((bits(greenMax) + greenShift) > bpp)",
          "688:     return false;",
          "689:   if ((bits(blueMax) + blueShift) > bpp)",
          "690:     return false;",
          "",
          "---------------"
        ],
        "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx": [
          "File: tests/unit/pixelformat.cxx -> tests/unit/pixelformat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "109:     doTest(true, 32, 16, false, true, 255, 255, 255, 0, 8, 16);",
          "113:     doTest(true, 32, 24, false, true, 255, 255, 255, 0, 7, 16);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "113:     doTest(true, 32, 24, false, true, 255, 255, 255, 25, 8, 16);",
          "114:     doTest(true, 32, 24, false, true, 255, 255, 255, 0, 25, 16);",
          "115:     doTest(true, 32, 24, false, true, 255, 255, 255, 0, 8, 25);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4ff58f0acaeb566b79ae12cf013b376eaaaab834",
      "candidate_info": {
        "commit_hash": "4ff58f0acaeb566b79ae12cf013b376eaaaab834",
        "repo": "CendioOssman/tigervnc",
        "commit_url": "https://github.com/CendioOssman/tigervnc/commit/4ff58f0acaeb566b79ae12cf013b376eaaaab834",
        "files": [
          "common/rdr/FixedMemOutStream.h"
        ],
        "message": "Remove unused FixedMemOutStream",
        "before_after_code_files": [
          "common/rdr/FixedMemOutStream.h||common/rdr/FixedMemOutStream.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/TigerVNC/tigervnc/pull/921"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "common/rdr/FixedMemOutStream.h||common/rdr/FixedMemOutStream.h": [
          "File: common/rdr/FixedMemOutStream.h -> common/rdr/FixedMemOutStream.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f1b9b868ec943d51ef631f53a095d48d3f178f4f",
      "candidate_info": {
        "commit_hash": "f1b9b868ec943d51ef631f53a095d48d3f178f4f",
        "repo": "CendioOssman/tigervnc",
        "commit_url": "https://github.com/CendioOssman/tigervnc/commit/f1b9b868ec943d51ef631f53a095d48d3f178f4f",
        "files": [
          "common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx"
        ],
        "message": "Fix depth sanity test in PixelFormat",
        "before_after_code_files": [
          "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx",
          "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/TigerVNC/tigervnc/pull/921"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "common/rfb/PixelFormat.cxx||common/rfb/PixelFormat.cxx": [
          "File: common/rfb/PixelFormat.cxx -> common/rfb/PixelFormat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "679:     return false;",
          "681:   totalBits = bits(redMax) + bits(greenMax) + bits(blueMax);",
          "683:     return false;",
          "685:   if (((redMax << redShift) & (greenMax << greenShift)) != 0)",
          "",
          "[Removed Lines]",
          "682:   if (totalBits > bpp)",
          "",
          "[Added Lines]",
          "682:   if (totalBits > depth)",
          "",
          "---------------"
        ],
        "tests/unit/pixelformat.cxx||tests/unit/pixelformat.cxx": [
          "File: tests/unit/pixelformat.cxx -> tests/unit/pixelformat.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:     doTest(true, 32, 24, false, true, 127, 511, 127, 0, 4, 20);",
          "105:     doTest(true, 32, 24, false, true, 127, 127, 511, 0, 4, 8);",
          "109:     doTest(true, 32, 24, false, true, 255, 255, 255, 0, 7, 16);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "109:     doTest(true, 32, 16, false, true, 255, 255, 255, 0, 8, 16);",
          "",
          "---------------"
        ]
      }
    }
  ]
}