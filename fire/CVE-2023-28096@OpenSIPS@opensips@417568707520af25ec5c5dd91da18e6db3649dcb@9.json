{
  "cve_id": "CVE-2023-28096",
  "cve_desc": "OpenSIPS, a Session Initiation Protocol (SIP) server implementation, has a memory leak starting in the 2.3 branch and priot to versions 3.1.8 and 3.2.5. The memory leak was detected in the function `parse_mi_request` while performing coverage-guided fuzzing. This issue can be reproduced by sending multiple requests of the form `{\"jsonrpc\": \"2.0\",\"method\": \"log_le`. This malformed message was tested against an instance of OpenSIPS via FIFO transport layer and was found to increase the memory consumption over time.\n\nTo abuse this memory leak, attackers need to reach the management interface (MI) which typically should only be exposed on trusted interfaces. In cases where the MI is exposed to the internet without authentication, abuse of this issue will lead to memory exhaustion which may affect the underlying system\u2019s availability. No authentication is typically required to reproduce this issue. On the other hand, memory leaks may occur in other areas of OpenSIPS where the cJSON library is used for parsing JSON objects.\n\nThe issue has been fixed in versions 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
  "patch_info": {
    "commit_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/417568707520af25ec5c5dd91da18e6db3649dcb",
    "files": [
      "lib/cJSON.c"
    ],
    "message": "cJSON: fix memory leak on object parsing error\n\nIssue discovered during OpenSIPS Security Audit 2021/2022,\nby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-2mg2-g46r-j4qr",
    "before_after_code_files": [
      "lib/cJSON.c||lib/cJSON.c"
    ]
  },
  "patch_diff": {
    "lib/cJSON.c||lib/cJSON.c": [
      "File: lib/cJSON.c -> lib/cJSON.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1483: fail:",
      "1484:     if (item->child != NULL)",
      "1485:     {",
      "1487:         item->child = NULL;",
      "1488:     }",
      "",
      "[Removed Lines]",
      "1486:         cJSON_Delete(child);",
      "",
      "[Added Lines]",
      "1486:         cJSON_Delete(item->child);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "089daf6d35e126e0a83b71a17287961e91d6aa87",
      "candidate_info": {
        "commit_hash": "089daf6d35e126e0a83b71a17287961e91d6aa87",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/089daf6d35e126e0a83b71a17287961e91d6aa87",
        "files": [
          "Makefile.defs",
          "packaging/debian/changelog",
          "packaging/freebsd/Makefile",
          "packaging/netbsd/Makefile",
          "packaging/openbsd/Makefile",
          "packaging/redhat_fedora/opensips.spec",
          "packaging/solaris/base-pkginfo",
          "packaging/solaris/berkeley-pkginfo",
          "packaging/solaris/carrierroute-pkginfo",
          "packaging/solaris/identity-pkginfo",
          "packaging/solaris/ldap-pkginfo",
          "packaging/solaris/mmgeoip-pkginfo",
          "packaging/solaris/mysql-pkginfo",
          "packaging/solaris/perl-pkginfo",
          "packaging/solaris/pgsql-pkginfo",
          "packaging/solaris/pkginfo",
          "packaging/solaris/regex-pkginfo",
          "packaging/solaris/snmp-pkginfo",
          "packaging/solaris/tls-pkginfo",
          "packaging/solaris/xmlrpc-pkginfo"
        ],
        "message": "Bump version to 3.2.6",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs",
          "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "66: #version number",
          "67: VERSION_MAJOR = 3",
          "68: VERSION_MINOR = 2",
          "70: VERSION_BUILD =",
          "72: ifneq (,$(VERSION_BUILD))",
          "",
          "[Removed Lines]",
          "69: VERSION_SUBMINOR = 5",
          "",
          "[Added Lines]",
          "69: VERSION_SUBMINOR = 6",
          "",
          "---------------"
        ],
        "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec": [
          "File: packaging/redhat_fedora/opensips.spec -> packaging/redhat_fedora/opensips.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: Summary:  Very fast and configurable SIP server",
          "47: Name:     opensips",
          "49: Release:  1%{?dist}",
          "50: License:  GPLv2+",
          "51: Group:    System Environment/Daemons",
          "",
          "[Removed Lines]",
          "48: Version:  3.2.5",
          "",
          "[Added Lines]",
          "48: Version:  3.2.6",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c3de32c0618a22a6d05960da7dcf4b8927bba3a5",
      "candidate_info": {
        "commit_hash": "c3de32c0618a22a6d05960da7dcf4b8927bba3a5",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/c3de32c0618a22a6d05960da7dcf4b8927bba3a5",
        "files": [
          "modules/dialog/dlg_handlers.c"
        ],
        "message": "[dialog] fix bad unref leading to dialog leaking\n\nWhen using the dlg_on_timeout to set a new timeout for the dialog, due to the timer related operations (re-inserting in the list), an extra ref cnt happens. If not unref'ed, the dialog will stay (as terminated) forever in memory.\n\nCloses #2788\n\n(cherry picked from commit 4062de45d0ccfe62bb4f9475f6320d2726349bab)",
        "before_after_code_files": [
          "modules/dialog/dlg_handlers.c||modules/dialog/dlg_handlers.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/dialog/dlg_handlers.c||modules/dialog/dlg_handlers.c": [
          "File: modules/dialog/dlg_handlers.c -> modules/dialog/dlg_handlers.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2322:   run_dlg_script_route( dlg, dlg->rt_on_timeout);",
          "2324:   if (tl->timeout) {",
          "2328:    if (dialog_repl_cluster && dlg->flags&DLG_FLAG_VP_CHANGED)",
          "2329:     replicate_dialog_updated(dlg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2330:    unref_dlg(dlg, 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d2c4bebc4c90ce4fe5df12e7edde3eff6116a889",
      "candidate_info": {
        "commit_hash": "d2c4bebc4c90ce4fe5df12e7edde3eff6116a889",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/d2c4bebc4c90ce4fe5df12e7edde3eff6116a889",
        "files": [
          "re.c"
        ],
        "message": "re.subst transformation: Fix possible pkg memleak\n\nThe leak would only happen under these simultaneous conditions:\n  1. the \"subst\" (last) part of the RE is a variable\n  2. the variable is using an index (e.g. an AVP)\n  3. there are at least two different \"subst\" strings in the script,\n     which can run alternatively (see the global \"subst_re\" logic to\n     understand more about the \"reusage\" mechanism and this effect)\n\nMany thanks to Richard Revels for a detailed report on this bug!\n\nFixes #2761\n\n(cherry picked from commit c739c2f4de2b26767e894765bb5f47d908f88603)",
        "before_after_code_files": [
          "re.c||re.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "re.c||re.c": [
          "File: re.c -> re.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "45: void subst_expr_free(struct subst_expr* se)",
          "46: {",
          "47:  if (se->replacement.s) pkg_free(se->replacement.s);",
          "48:  if (se->re) { regfree(se->re); pkg_free(se->re); };",
          "49:  pkg_free(se);",
          "50: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47:  int i;",
          "51:  for (i = 0; i < se->n_escapes; i++)",
          "52:   if (se->replace[i].type == REPLACE_SPEC",
          "53:       && se->replace[i].u.spec.pvp.pvi.type == PV_IDX_PVAR)",
          "54:           pv_spec_free(se->replace[i].u.spec.pvp.pvi.u.dval);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6b7559920bd650042ef23f61d554c3e40674ca99",
      "candidate_info": {
        "commit_hash": "6b7559920bd650042ef23f61d554c3e40674ca99",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/6b7559920bd650042ef23f61d554c3e40674ca99",
        "files": [
          "modules/db_virtual/db_virtual.c"
        ],
        "message": "[db_virtual] fixed the MI db_get output\n\nFix typos leading to bad json structure\nReported by @bctff\nCloses opensips-cli/#94\n\n(cherry picked from commit 96d8113e9da6f01dc1222364b80d975284d42336)",
        "before_after_code_files": [
          "modules/db_virtual/db_virtual.c||modules/db_virtual/db_virtual.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/db_virtual/db_virtual.c||modules/db_virtual/db_virtual.c": [
          "File: modules/db_virtual/db_virtual.c -> modules/db_virtual/db_virtual.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "543:             buf,strlen(buf)) < 0)",
          "544:             goto error;",
          "547:         if (!dbs_arr)",
          "548:             goto error;",
          "",
          "[Removed Lines]",
          "546:         dbs_arr = add_mi_array(resp_obj, MI_SSTR(\"DBS\"));",
          "",
          "[Added Lines]",
          "546:         dbs_arr = add_mi_array(set_item, MI_SSTR(\"DBS\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "552:             if (!db_item)",
          "553:                 goto error;",
          "556:                 goto error;",
          "559:                 global->set_list[i].db_list[j].db_url.s,",
          "560:                 global->set_list[i].db_list[j].db_url.len) < 0)",
          "561:                 goto error;",
          "",
          "[Removed Lines]",
          "555:             if (add_mi_number(set_item, MI_SSTR(\"index\"), i) < 0)",
          "558:             if (add_mi_string(set_item, MI_SSTR(\"name\"),",
          "",
          "[Added Lines]",
          "555:             if (add_mi_number(db_item, MI_SSTR(\"index\"), j) < 0)",
          "558:             if (add_mi_string(db_item, MI_SSTR(\"name\"),",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "564:             may_use = (global->set_list[i].db_list[j].flags & MAY_USE) ? 1 : 0;",
          "565:             recon = (global->set_list[i].db_list[j].flags & RERECONNECT) ? 1 :0;",
          "568:                 goto error;",
          "570:                 goto error;",
          "572:                 goto error;",
          "573:         }",
          "574:     }",
          "",
          "[Removed Lines]",
          "567:             if (add_mi_number(set_item, MI_SSTR(\"can\"), can_use) < 0)",
          "569:             if (add_mi_number(set_item, MI_SSTR(\"may\"), may_use) < 0)",
          "571:             if (add_mi_number(set_item, MI_SSTR(\"r_rec\"), recon) < 0)",
          "",
          "[Added Lines]",
          "567:             if (add_mi_number(db_item, MI_SSTR(\"can\"), can_use) < 0)",
          "569:             if (add_mi_number(db_item, MI_SSTR(\"may\"), may_use) < 0)",
          "571:             if (add_mi_number(db_item, MI_SSTR(\"r_rec\"), recon) < 0)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "51aa2a8bc0a7cc814eff34e3639329ce8b33e304",
      "candidate_info": {
        "commit_hash": "51aa2a8bc0a7cc814eff34e3639329ce8b33e304",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/51aa2a8bc0a7cc814eff34e3639329ce8b33e304",
        "files": [
          "modules/rtpengine/rtpengine.c"
        ],
        "message": "rtpengine: do not specify interfaces for non-offer/answer\n\nAvoid getting bogus `no more memory` errors when trying to specify in\nin/out interface when `direction` node is NULL.\n\nClose #2880\n\n(cherry picked from commit bbb6f313bba3fdb7f32f80140ceb9c8dff1e8f1b)",
        "before_after_code_files": [
          "modules/rtpengine/rtpengine.c||modules/rtpengine/rtpengine.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/rtpengine/rtpengine.c||modules/rtpengine/rtpengine.c": [
          "File: modules/rtpengine/rtpengine.c -> modules/rtpengine/rtpengine.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1933:  }",
          "1935:  if (iniface.len != 0 && outiface.len != 0) {",
          "1946:   }",
          "1948:  } else if (iniface.len) {",
          "1949:   LM_ERR(\"in-iface value without out-iface\\n\");",
          "1950:   return -1;",
          "",
          "[Removed Lines]",
          "1936:   bitem = bencode_str(bencode_item_buffer(ng_flags->direction), &iniface);",
          "1937:   if (!bitem) {",
          "1938:    err = \"no more memory\";",
          "1939:    goto error;",
          "1940:   }",
          "1941:   BCHECK(bencode_list_add(ng_flags->direction, bitem));",
          "1942:   bitem = bencode_str(bencode_item_buffer(ng_flags->direction), &outiface);",
          "1943:   if (!bitem) {",
          "1944:    err = \"no more memory\";",
          "1945:    goto error;",
          "1947:   BCHECK(bencode_list_add(ng_flags->direction, bitem));",
          "",
          "[Added Lines]",
          "1936:   if (ng_flags->direction) {",
          "1937:    bitem = bencode_str(bencode_item_buffer(ng_flags->direction), &iniface);",
          "1938:    if (!bitem) {",
          "1939:     err = iniface.s;",
          "1940:     goto error;",
          "1941:    }",
          "1942:    BCHECK(bencode_list_add(ng_flags->direction, bitem));",
          "1943:    bitem = bencode_str(bencode_item_buffer(ng_flags->direction), &outiface);",
          "1944:    if (!bitem) {",
          "1945:     err = \"no more memory\";",
          "1946:     goto error;",
          "1947:    }",
          "1948:    BCHECK(bencode_list_add(ng_flags->direction, bitem));",
          "1949:   } else {",
          "1950:    LM_DBG(\"cannot set interfaces for non-offer/answer commands\\n\");",
          "",
          "---------------"
        ]
      }
    }
  ]
}