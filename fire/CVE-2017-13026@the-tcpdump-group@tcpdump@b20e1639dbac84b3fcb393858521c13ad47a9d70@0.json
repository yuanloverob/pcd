{
  "cve_id": "CVE-2017-13026",
  "cve_desc": "The ISO IS-IS parser in tcpdump before 4.9.2 has a buffer over-read in print-isoclns.c, several functions.",
  "repo": "the-tcpdump-group/tcpdump",
  "patch_hash": "b20e1639dbac84b3fcb393858521c13ad47a9d70",
  "patch_info": {
    "commit_hash": "b20e1639dbac84b3fcb393858521c13ad47a9d70",
    "repo": "the-tcpdump-group/tcpdump",
    "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/b20e1639dbac84b3fcb393858521c13ad47a9d70",
    "files": [
      "print-isoclns.c",
      "tests/TESTLIST",
      "tests/isis-extd-ipreach-oobr.out",
      "tests/isis-seg-fault-2-v.out",
      "tests/isis_stlv_asan-2.out",
      "tests/isis_stlv_asan-2.pcap",
      "tests/isis_stlv_asan-3.out",
      "tests/isis_stlv_asan-3.pcap",
      "tests/isis_stlv_asan-4.out",
      "tests/isis_stlv_asan-4.pcap",
      "tests/isis_stlv_asan.out",
      "tests/isis_stlv_asan.pcap",
      "tests/kday6.out"
    ],
    "message": "CVE-2017-13026/IS-IS: Clean up processing of subTLVs.\n\nAdd bounds checks, do a common check to make sure we captured the entire\nsubTLV, add checks to make sure the subTLV fits within the TLV.\n\nThis fixes a buffer over-read discovered by Bhargava Shastry,\nSecT/TU Berlin.\n\nAdd tests using the capture files supplied by the reporter(s), modified\nso the capture files won't be rejected as an invalid capture.\n\nUpdate existing tests for changes to IS-IS dissector.",
    "before_after_code_files": [
      "print-isoclns.c||print-isoclns.c"
    ]
  },
  "patch_diff": {
    "print-isoclns.c||print-isoclns.c": [
      "File: print-isoclns.c -> print-isoclns.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1404:   while (len > 2)",
      "1405:   {",
      "1406:     stlv_type = *(tptr++);",
      "1407:     stlv_len  = *(tptr++);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1406:     ND_TCHECK2(*tptr, 2);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1416:     len = len -2;",
      "1418:     switch (stlv_type)",
      "1419:     {",
      "1420:       case ISIS_SUBTLV_SPB_MCID:",
      "1421:       {",
      "1424:         subtlv_spb_mcid = (const struct isis_subtlv_spb_mcid *)tptr;",
      "",
      "[Removed Lines]",
      "1422:         ND_TCHECK2(*(tptr), ISIS_SUBTLV_SPB_MCID_MIN_LEN);",
      "",
      "[Added Lines]",
      "1420:     if (len < stlv_len)",
      "1421:       goto trunc;",
      "1423:     ND_TCHECK2(*(tptr), stlv_len);",
      "1429:        if (stlv_len < ISIS_SUBTLV_SPB_MCID_MIN_LEN)",
      "1430:          goto trunc;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1440:         break;",
      "1441:       }",
      "1443:       case ISIS_SUBTLV_SPB_DIGEST:",
      "1444:       {",
      "1447:         ND_PRINT((ndo, \"\\n\\t        RES: %d V: %d A: %d D: %d\",",
      "1448:                         (*(tptr) >> 5), (((*tptr)>> 4) & 0x01),",
      "",
      "[Removed Lines]",
      "1437:         tptr = tptr + sizeof(struct isis_subtlv_spb_mcid);",
      "1438:         len = len - sizeof(struct isis_subtlv_spb_mcid);",
      "1445:         ND_TCHECK2(*(tptr), ISIS_SUBTLV_SPB_DIGEST_MIN_LEN);",
      "",
      "[Added Lines]",
      "1445:         tptr = tptr + ISIS_SUBTLV_SPB_MCID_MIN_LEN;",
      "1446:         len = len - ISIS_SUBTLV_SPB_MCID_MIN_LEN;",
      "1447:         stlv_len = stlv_len - ISIS_SUBTLV_SPB_MCID_MIN_LEN;",
      "1454:         if (stlv_len < ISIS_SUBTLV_SPB_DIGEST_MIN_LEN)",
      "1455:           goto trunc;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1461:         }",
      "1463:         len = len - ISIS_SUBTLV_SPB_DIGEST_MIN_LEN;",
      "1465:         break;",
      "1466:       }",
      "1468:       case ISIS_SUBTLV_SPB_BVID:",
      "1469:       {",
      "1473:         {",
      "1476:           ND_PRINT((ndo, \"\\n\\t           ECT: %08x\",",
      "1477:                       EXTRACT_32BITS(tptr)));",
      "",
      "[Removed Lines]",
      "1470:         ND_TCHECK2(*(tptr), stlv_len);",
      "1472:         while (len >= ISIS_SUBTLV_SPB_BVID_MIN_LEN)",
      "1474:           ND_TCHECK2(*(tptr), ISIS_SUBTLV_SPB_BVID_MIN_LEN);",
      "",
      "[Added Lines]",
      "1474:         stlv_len = stlv_len - ISIS_SUBTLV_SPB_DIGEST_MIN_LEN;",
      "1481:         while (stlv_len >= ISIS_SUBTLV_SPB_BVID_MIN_LEN)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1486:           tptr = tptr + 2;",
      "1487:           len = len - ISIS_SUBTLV_SPB_BVID_MIN_LEN;",
      "1488:         }",
      "1490:         break;",
      "1491:       }",
      "1493:       default:",
      "1495:     }",
      "1496:   }",
      "1498:   return 0;",
      "",
      "[Removed Lines]",
      "1494:           break;",
      "",
      "[Added Lines]",
      "1495:           stlv_len = stlv_len - ISIS_SUBTLV_SPB_BVID_MIN_LEN;",
      "1502:         break;",
      "1504:     tptr += stlv_len;",
      "1505:     len -= stlv_len;",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1512:   while (len > 2)",
      "1513:   {",
      "1514:     stlv_type = *(tptr++);",
      "1515:     stlv_len  = *(tptr++);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1524:     ND_TCHECK2(*tptr, 2);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1523:     len = len - 2;",
      "1525:     switch (stlv_type)",
      "1526:     {",
      "1527:       case ISIS_SUBTLV_SPB_INSTANCE:",
      "1531:           ND_PRINT((ndo, \"\\n\\t        CIST Root-ID: %08x\", EXTRACT_32BITS(tptr)));",
      "1532:           tptr = tptr+4;",
      "",
      "[Removed Lines]",
      "1529:           ND_TCHECK2(*tptr, ISIS_SUBTLV_SPB_INSTANCE_MIN_LEN);",
      "",
      "[Added Lines]",
      "1537:     if (len < stlv_len)",
      "1538:       goto trunc;",
      "1540:     ND_TCHECK2(*(tptr), stlv_len);",
      "1545:           if (stlv_len < ISIS_SUBTLV_SPB_INSTANCE_MIN_LEN)",
      "1546:             goto trunc;",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1548:           tmp = *(tptr++);",
      "1550:           len = len - ISIS_SUBTLV_SPB_INSTANCE_MIN_LEN;",
      "1552:           while (tmp)",
      "1553:           {",
      "1556:             ND_PRINT((ndo, \"\\n\\t         U:%d, M:%d, A:%d, RES:%d\",",
      "",
      "[Removed Lines]",
      "1554:             ND_TCHECK2(*tptr, ISIS_SUBTLV_SPB_INSTANCE_VLAN_TUPLE_LEN);",
      "",
      "[Added Lines]",
      "1568:           stlv_len = stlv_len - ISIS_SUBTLV_SPB_INSTANCE_MIN_LEN;",
      "1572:             if (stlv_len < ISIS_SUBTLV_SPB_INSTANCE_VLAN_TUPLE_LEN)",
      "1573:               goto trunc;",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1570:             tptr = tptr + 3;",
      "1571:             len = len - ISIS_SUBTLV_SPB_INSTANCE_VLAN_TUPLE_LEN;",
      "1572:             tmp--;",
      "1573:           }",
      "1575:           break;",
      "1577:       case ISIS_SUBTLV_SPBM_SI:",
      "1581:           ND_PRINT((ndo, \"\\n\\t        BMAC: %08x\", EXTRACT_32BITS(tptr)));",
      "1582:           tptr = tptr+4;",
      "",
      "[Removed Lines]",
      "1579:           ND_TCHECK2(*tptr, 8);",
      "",
      "[Added Lines]",
      "1591:             stlv_len = stlv_len - ISIS_SUBTLV_SPB_INSTANCE_VLAN_TUPLE_LEN;",
      "1598:           if (stlv_len < 8)",
      "1599:             goto trunc;",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1608:       default:",
      "1609:         break;",
      "1610:     }",
      "1611:   }",
      "1612:   return 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1631:     tptr += stlv_len;",
      "1632:     len -= stlv_len;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3ecde94f0cdb6b1814a3a8acd7b1c7bf4705abe5",
      "candidate_info": {
        "commit_hash": "3ecde94f0cdb6b1814a3a8acd7b1c7bf4705abe5",
        "repo": "the-tcpdump-group/tcpdump",
        "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/3ecde94f0cdb6b1814a3a8acd7b1c7bf4705abe5",
        "files": [
          "print-cfm.c",
          "print-egp.c",
          "print-hncp.c",
          "print-icmp.c",
          "print-isoclns.c",
          "print-ospf.c"
        ],
        "message": "Use more ND_TCHECK_n() macros",
        "before_after_code_files": [
          "print-cfm.c||print-cfm.c",
          "print-egp.c||print-egp.c",
          "print-hncp.c||print-hncp.c",
          "print-icmp.c||print-icmp.c",
          "print-isoclns.c||print-isoclns.c",
          "print-ospf.c||print-ospf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "print-isoclns.c||print-isoclns.c"
          ],
          "candidate": [
            "print-isoclns.c||print-isoclns.c"
          ]
        }
      },
      "candidate_diff": {
        "print-cfm.c||print-cfm.c": [
          "File: print-cfm.c -> print-cfm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "529:         cfm_tlv_header = (const struct cfm_tlv_header_t *)tptr;",
          "533:         cfm_tlv_type=cfm_tlv_header->type;",
          "535:         ND_PRINT((ndo, \"\\n\\t%s TLV (0x%02x)\",",
          "",
          "[Removed Lines]",
          "532:         ND_TCHECK2(*tptr, 1);",
          "",
          "[Added Lines]",
          "532:         ND_TCHECK_1(tptr);",
          "",
          "---------------"
        ],
        "print-egp.c||print-egp.c": [
          "File: print-egp.c -> print-egp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "182:   length -= 4 - netlen;",
          "183:   if (length < 1)",
          "184:    goto trunc;",
          "186:   distances = EXTRACT_U_1(cp);",
          "187:   cp++;",
          "188:   length--;",
          "",
          "[Removed Lines]",
          "185:   ND_TCHECK2(cp[0], 1);",
          "",
          "[Added Lines]",
          "185:   ND_TCHECK_1(cp);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "195:   while (distances != 0) {",
          "196:    if (length < 2)",
          "197:     goto trunc;",
          "199:    ND_PRINT((ndo, \"%sd%d:\", comma, EXTRACT_U_1(cp)));",
          "200:    cp++;",
          "201:    comma = \", \";",
          "",
          "[Removed Lines]",
          "198:    ND_TCHECK2(cp[0], 2);",
          "",
          "[Added Lines]",
          "198:    ND_TCHECK_2(cp);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "207:     if (length < 1)",
          "208:      goto trunc;",
          "210:     addr = ((uint32_t) EXTRACT_U_1(cp)) << 24;",
          "211:     cp++;",
          "212:     length--;",
          "213:     if (IN_CLASSB(addr)) {",
          "214:      if (length < 1)",
          "215:       goto trunc;",
          "217:      addr |= ((uint32_t) EXTRACT_U_1(cp)) << 16;",
          "218:      cp++;",
          "219:      length--;",
          "220:     } else if (!IN_CLASSA(addr)) {",
          "221:      if (length < 2)",
          "222:       goto trunc;",
          "224:      addr |= ((uint32_t) EXTRACT_U_1(cp)) << 16;",
          "225:      cp++;",
          "226:      addr |= ((uint32_t) EXTRACT_U_1(cp)) << 8;",
          "",
          "[Removed Lines]",
          "209:     ND_TCHECK2(cp[0], 1);",
          "216:      ND_TCHECK2(cp[0], 1);",
          "223:      ND_TCHECK2(cp[0], 2);",
          "",
          "[Added Lines]",
          "209:     ND_TCHECK_1(cp);",
          "216:      ND_TCHECK_1(cp);",
          "223:      ND_TCHECK_2(cp);",
          "",
          "---------------"
        ],
        "print-hncp.c||print-hncp.c": [
          "File: print-hncp.c -> print-hncp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "422:                 ND_PRINT((ndo, \"\\t\"));",
          "423:         }",
          "426:         if (i + 4 > length)",
          "427:             goto invalid;",
          "",
          "[Removed Lines]",
          "425:         ND_TCHECK2(*tlv, 4);",
          "",
          "[Added Lines]",
          "425:         ND_TCHECK_4(tlv);",
          "",
          "---------------"
        ],
        "print-icmp.c||print-icmp.c": [
          "File: print-icmp.c -> print-icmp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "661:                 case 1:",
          "662:                     switch(obj_ctype) {",
          "663:                     case 1:",
          "665:                         raw_label = EXTRACT_BE_U_4(obj_tptr);",
          "666:                         ND_PRINT((ndo, \"\\n\\t    label %u, exp %u\", MPLS_LABEL(raw_label), MPLS_EXP(raw_label)));",
          "667:                         if (MPLS_STACK(raw_label))",
          "",
          "[Removed Lines]",
          "664:                         ND_TCHECK2(*obj_tptr, 4);",
          "",
          "[Added Lines]",
          "664:                         ND_TCHECK_4(obj_tptr);",
          "",
          "---------------"
        ],
        "print-isoclns.c||print-isoclns.c": [
          "File: print-isoclns.c -> print-isoclns.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "902:                 ND_PRINT((ndo, \", bad opts/li\"));",
          "903:                 return (0);",
          "904:             }",
          "906:             op = EXTRACT_U_1(pptr);",
          "907:             opli = EXTRACT_U_1(pptr + 1);",
          "908:             pptr += 2;",
          "",
          "[Removed Lines]",
          "905:             ND_TCHECK2(*pptr, 2);",
          "",
          "[Added Lines]",
          "905:             ND_TCHECK_2(pptr);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1313:                 ND_PRINT((ndo, \", bad opts/li\"));",
          "1314:                 return;",
          "1315:             }",
          "1317:             op = EXTRACT_U_1(pptr);",
          "1318:             opli = EXTRACT_U_1(pptr + 1);",
          "1319:             pptr += 2;",
          "",
          "[Removed Lines]",
          "1316:             ND_TCHECK2(*pptr, 2);",
          "",
          "[Added Lines]",
          "1316:             ND_TCHECK_2(pptr);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1335:             case ESIS_OPTION_ES_CONF_TIME:",
          "1336:                 if (opli == 2) {",
          "1338:                     ND_PRINT((ndo, \"%us\", EXTRACT_BE_U_2(tptr)));",
          "1339:                 } else",
          "1340:                     ND_PRINT((ndo, \"(bad length)\"));",
          "",
          "[Removed Lines]",
          "1337:                     ND_TCHECK2(*pptr, 2);",
          "",
          "[Added Lines]",
          "1337:                     ND_TCHECK_2(pptr);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1412:   while (len > 2)",
          "1413:   {",
          "1415:     stlv_type = EXTRACT_U_1(tptr);",
          "1416:     stlv_len  = EXTRACT_U_1(tptr + 1);",
          "",
          "[Removed Lines]",
          "1414:     ND_TCHECK2(*tptr, 2);",
          "",
          "[Added Lines]",
          "1414:     ND_TCHECK_2(tptr);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1533:   while (len > 2)",
          "1534:   {",
          "1536:     stlv_type = EXTRACT_U_1(tptr);",
          "1537:     stlv_len  = EXTRACT_U_1(tptr + 1);",
          "1538:     tptr = tptr + 2;",
          "",
          "[Removed Lines]",
          "1535:     ND_TCHECK2(*tptr, 2);",
          "",
          "[Added Lines]",
          "1535:     ND_TCHECK_2(tptr);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2563:     while (packet_len > 0) {",
          "2565:  if (packet_len < 2)",
          "2566:      goto trunc;",
          "2567:  tlv_type = EXTRACT_U_1(pptr);",
          "",
          "[Removed Lines]",
          "2564:  ND_TCHECK2(*pptr, 2);",
          "",
          "[Added Lines]",
          "2564:  ND_TCHECK_2(pptr);",
          "",
          "---------------"
        ],
        "print-ospf.c||print-ospf.c": [
          "File: print-ospf.c -> print-ospf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "189:     while (ls_length > 0) {",
          "191:         if (ls_length < 4) {",
          "192:             ND_PRINT((ndo, \"\\n\\t    Remaining LS length %u < 4\", ls_length));",
          "193:             return -1;",
          "",
          "[Removed Lines]",
          "190:         ND_TCHECK2(*tptr, 4);",
          "",
          "[Added Lines]",
          "190:         ND_TCHECK_4(tptr);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "274:     } bw;",
          "276:     while (ls_length != 0) {",
          "278:         if (ls_length < 4) {",
          "279:             ND_PRINT((ndo, \"\\n\\t    Remaining LS length %u < 4\", ls_length));",
          "280:             return -1;",
          "",
          "[Removed Lines]",
          "277:         ND_TCHECK2(*tptr, 4);",
          "",
          "[Added Lines]",
          "277:         ND_TCHECK_4(tptr);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "308:                            tlv_length));",
          "309:                     return -1;",
          "310:                 }",
          "312:                 subtlv_type = EXTRACT_BE_U_2(tptr);",
          "313:                 subtlv_length = EXTRACT_BE_U_2(tptr + 2);",
          "314:                 tptr+=4;",
          "",
          "[Removed Lines]",
          "311:                 ND_TCHECK2(*tptr, 4);",
          "",
          "[Added Lines]",
          "311:                 ND_TCHECK_4(tptr);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "483:                 ND_PRINT((ndo, \"\\n\\t    TLV length %u < 4\", tlv_length));",
          "484:                 return -1;",
          "485:             }",
          "487:             ND_PRINT((ndo, \", %s\", ipaddr_string(ndo, tptr)));",
          "488:             break;",
          "",
          "[Removed Lines]",
          "486:             ND_TCHECK2(*tptr, 4);",
          "",
          "[Added Lines]",
          "486:             ND_TCHECK_4(tptr);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "803:   tptr = (const uint8_t *)(&lsap->lsa_un.un_ri_tlv.type);",
          "805:   while (ls_length != 0) {",
          "807:       if (ls_length < 4) {",
          "808:                         ND_PRINT((ndo, \"\\n\\t    Remaining LS length %u < 4\", ls_length));",
          "809:                         return(ls_end);",
          "",
          "[Removed Lines]",
          "806:                     ND_TCHECK2(*tptr, 4);",
          "",
          "[Added Lines]",
          "806:                     ND_TCHECK_4(tptr);",
          "",
          "---------------"
        ]
      }
    }
  ]
}