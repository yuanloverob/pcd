{
  "cve_id": "CVE-2021-40985",
  "cve_desc": "A stack-based buffer under-read in htmldoc before 1.9.12, allows attackers to cause a denial of service via a crafted BMP image to image_load_bmp.",
  "repo": "michaelrsweet/htmldoc",
  "patch_hash": "f12b9666e582a8e7b70f11b28e5ffc49ad625d43",
  "patch_info": {
    "commit_hash": "f12b9666e582a8e7b70f11b28e5ffc49ad625d43",
    "repo": "michaelrsweet/htmldoc",
    "commit_url": "https://github.com/michaelrsweet/htmldoc/commit/f12b9666e582a8e7b70f11b28e5ffc49ad625d43",
    "files": [
      "CHANGES.md",
      "htmldoc/image.cxx"
    ],
    "message": "Fix BMP crash bug (Issue #444)",
    "before_after_code_files": [
      "htmldoc/image.cxx||htmldoc/image.cxx"
    ]
  },
  "patch_diff": {
    "htmldoc/image.cxx||htmldoc/image.cxx": [
      "File: htmldoc/image.cxx -> htmldoc/image.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "915:   colors_used      = (int)read_dword(fp);",
      "916:   read_dword(fp);",
      "918:   if (info_size > 40)",
      "919:     for (info_size -= 40; info_size > 0; info_size --)",
      "920:       getc(fp);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "918:   if (img->width <= 0 || img->width > 8192 || img->height <= 0 || img->height > 8192)",
      "919:     return (-1);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "926:   fread(colormap, (size_t)colors_used, 4, fp);",
      "",
      "[Removed Lines]",
      "929:   img->depth  = gray ? 1 : 3;",
      "",
      "[Added Lines]",
      "932:   img->depth = gray ? 1 : 3;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1076:             if (bit == 0xf0)",
      "1077:      {",
      "1078:               if (color < 0)",
      "1080:        else",
      "1081:   temp = color;",
      "",
      "[Removed Lines]",
      "1079:   temp = getc(fp);",
      "",
      "[Added Lines]",
      "1082:   temp = getc(fp) & 255;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "753c71bce6fd916458e31b30eb633a577731d8b8",
      "candidate_info": {
        "commit_hash": "753c71bce6fd916458e31b30eb633a577731d8b8",
        "repo": "michaelrsweet/htmldoc",
        "commit_url": "https://github.com/michaelrsweet/htmldoc/commit/753c71bce6fd916458e31b30eb633a577731d8b8",
        "files": [
          "CHANGES.md",
          "doc/1-intro.html",
          "doc/2-using.html",
          "doc/3-cmdref.html",
          "doc/4-htmlref.html",
          "htmldoc/image.cxx"
        ],
        "message": "Fix another potential stack overflow issue in the BMP image loader (Issue #456)\n\nDeprecate BMP support and document that it is going away in a future HTMLDOC\nrelease.",
        "before_after_code_files": [
          "htmldoc/image.cxx||htmldoc/image.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "htmldoc/image.cxx||htmldoc/image.cxx"
          ],
          "candidate": [
            "htmldoc/image.cxx||htmldoc/image.cxx"
          ]
        }
      },
      "candidate_diff": {
        "htmldoc/image.cxx||htmldoc/image.cxx": [
          "File: htmldoc/image.cxx -> htmldoc/image.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "916:   colors_used      = (int)read_dword(fp);",
          "917:   read_dword(fp);",
          "920:     return (-1);",
          "922:   if (info_size > 40)",
          "",
          "[Removed Lines]",
          "919:   if (img->width <= 0 || img->width > 8192 || img->height <= 0 || img->height > 8192)",
          "",
          "[Added Lines]",
          "919:   if (img->width <= 0 || img->width > 8192 || img->height <= 0 || img->height > 8192 || info_size < 0)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "929:   if (colors_used == 0 && depth <= 8)",
          "930:     colors_used = 1 << depth;",
          "932:     return (-1);",
          "934:   fread(colormap, (size_t)colors_used, 4, fp);",
          "",
          "[Removed Lines]",
          "931:   else if (colors_used > 256)",
          "",
          "[Added Lines]",
          "931:   else if (colors_used < 0 || colors_used > 256)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "31f780487e5ddc426888638786cdc47631687275",
      "candidate_info": {
        "commit_hash": "31f780487e5ddc426888638786cdc47631687275",
        "repo": "michaelrsweet/htmldoc",
        "commit_url": "https://github.com/michaelrsweet/htmldoc/commit/31f780487e5ddc426888638786cdc47631687275",
        "files": [
          "CHANGES.md",
          "htmldoc/image.cxx"
        ],
        "message": "Fix a potential integer overflow bug in the JPEG and PNG loaders (Issue #471)\n\nAll images are now limited to 4GiB of memory usage (37837x37837 pixels).",
        "before_after_code_files": [
          "htmldoc/image.cxx||htmldoc/image.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "htmldoc/image.cxx||htmldoc/image.cxx"
          ],
          "candidate": [
            "htmldoc/image.cxx||htmldoc/image.cxx"
          ]
        }
      },
      "candidate_diff": {
        "htmldoc/image.cxx||htmldoc/image.cxx": [
          "File: htmldoc/image.cxx -> htmldoc/image.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #endif // HAVE_LIBPNG",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: #define IMAGE_MAX_DIM 37837  // Maximum dimension - sqrt(4GiB / 3)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "926:   colors_used      = (int)read_dword(fp);",
          "927:   read_dword(fp);",
          "930:     return (-1);",
          "932:   if (info_size > 40)",
          "",
          "[Removed Lines]",
          "929:   if (img->width <= 0 || img->width > 8192 || img->height <= 0 || img->height > 8192 || info_size < 0)",
          "",
          "[Added Lines]",
          "936:   if (img->width <= 0 || img->width > IMAGE_MAX_DIM || img->height <= 0 || img->height > IMAGE_MAX_DIM || info_size < 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1278:   img->height = (buf[9] << 8) | buf[8];",
          "1279:   ncolors     = 2 << (buf[10] & 0x07);",
          "1282:     return (-1);",
          "",
          "[Removed Lines]",
          "1281:   if (img->width <= 0 || img->width > 32767 || img->height <= 0 || img->height > 32767)",
          "",
          "[Added Lines]",
          "1288:   if (img->width <= 0 || img->width > IMAGE_MAX_DIM || img->height <= 0 || img->height > IMAGE_MAX_DIM)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1326:           img->height = (buf[7] << 8) | buf[6];",
          "1327:           img->depth  = gray ? 1 : 3;",
          "1330:      return (-1);",
          "1332:           if (transparent >= 0)",
          "",
          "[Removed Lines]",
          "1329:    if (img->width <= 0 || img->width > 32767 || img->height <= 0 || img->height > 32767)",
          "",
          "[Added Lines]",
          "1336:    if (img->width <= 0 || img->width > IMAGE_MAX_DIM || img->height <= 0 || img->height > IMAGE_MAX_DIM)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1443:   img->height = (int)cinfo.output_height;",
          "1444:   img->depth  = (int)cinfo.output_components;",
          "1446:   if (!load_data)",
          "1447:   {",
          "1448:     jpeg_destroy_decompress(&cinfo);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1453:   if (img->width <= 0 || img->width > IMAGE_MAX_DIM || img->height <= 0 || img->height > IMAGE_MAX_DIM)",
          "1454:   {",
          "1455:     jpeg_destroy_decompress(&cinfo);",
          "1456:     return (-1);",
          "1457:   }",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1598:   img->width  = (int)png_get_image_width(pp, info);",
          "1599:   img->height = (int)png_get_image_height(pp, info);",
          "1601:   if (color_type & PNG_COLOR_MASK_ALPHA)",
          "1602:   {",
          "1603:     if ((PSLevel == 0 && PDFVersion >= 14) || PSLevel == 3)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1614:   if (img->width <= 0 || img->width > IMAGE_MAX_DIM || img->height <= 0 || img->height > IMAGE_MAX_DIM)",
          "1615:   {",
          "1616:     png_destroy_read_struct(&pp, &info, NULL);",
          "1617:     return (-1);",
          "1618:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}