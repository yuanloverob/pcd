{
  "cve_id": "CVE-2017-12897",
  "cve_desc": "The ISO CLNS parser in tcpdump before 4.9.2 has a buffer over-read in print-isoclns.c:isoclns_print().",
  "repo": "the-tcpdump-group/tcpdump",
  "patch_hash": "1dcd10aceabbc03bf571ea32b892c522cbe923de",
  "patch_info": {
    "commit_hash": "1dcd10aceabbc03bf571ea32b892c522cbe923de",
    "repo": "the-tcpdump-group/tcpdump",
    "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/1dcd10aceabbc03bf571ea32b892c522cbe923de",
    "files": [
      "netdissect.h",
      "print-atm.c",
      "print-chdlc.c",
      "print-ether.c",
      "print-fr.c",
      "print-gre.c",
      "print-isoclns.c",
      "print-juniper.c",
      "print-llc.c",
      "print-mpls.c",
      "print-null.c",
      "print-ppp.c",
      "tests/TESTLIST",
      "tests/isoclns-oobr.out",
      "tests/isoclns-oobr.pcap"
    ],
    "message": "CVE-2017-12897/ISO CLNS: Use ND_TTEST() for the bounds checks in isoclns_print().\n\nThis fixes a buffer over-read discovered by Kamil Frankowicz.\n\nDon't pass the remaining caplen - that's too hard to get right, and we\nwere getting it wrong in at least one case; just use ND_TTEST().\n\nAdd a test using the capture file supplied by the reporter(s).",
    "before_after_code_files": [
      "netdissect.h||netdissect.h",
      "print-atm.c||print-atm.c",
      "print-chdlc.c||print-chdlc.c",
      "print-ether.c||print-ether.c",
      "print-fr.c||print-fr.c",
      "print-gre.c||print-gre.c",
      "print-isoclns.c||print-isoclns.c",
      "print-juniper.c||print-juniper.c",
      "print-llc.c||print-llc.c",
      "print-mpls.c||print-mpls.c",
      "print-null.c||print-null.c",
      "print-ppp.c||print-ppp.c"
    ]
  },
  "patch_diff": {
    "netdissect.h||netdissect.h": [
      "File: netdissect.h -> netdissect.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "512: extern void ipx_print(netdissect_options *, const u_char *, u_int);",
      "513: extern void isakmp_print(netdissect_options *, const u_char *, u_int, const u_char *);",
      "514: extern void isakmp_rfc3948_print(netdissect_options *, const u_char *, u_int, const u_char *);",
      "516: extern void krb_print(netdissect_options *, const u_char *);",
      "517: extern void l2tp_print(netdissect_options *, const u_char *, u_int);",
      "518: extern void lane_print(netdissect_options *, const u_char *, u_int, u_int);",
      "",
      "[Removed Lines]",
      "515: extern void isoclns_print(netdissect_options *, const u_char *, u_int, u_int);",
      "",
      "[Added Lines]",
      "515: extern void isoclns_print(netdissect_options *, const u_char *, u_int);",
      "",
      "---------------"
    ],
    "print-atm.c||print-atm.c": [
      "File: print-atm.c -> print-atm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "262:         if (*p == LLC_UI) {",
      "263:             if (ndo->ndo_eflag)",
      "264:                 ND_PRINT((ndo, \"CNLPID \"));",
      "266:             return hdrlen;",
      "267:         }",
      "",
      "[Removed Lines]",
      "265:             isoclns_print(ndo, p + 1, length - 1, caplen - 1);",
      "",
      "[Added Lines]",
      "265:             isoclns_print(ndo, p + 1, length - 1);",
      "",
      "---------------"
    ],
    "print-chdlc.c||print-chdlc.c": [
      "File: print-chdlc.c -> print-chdlc.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "97:                 if (*(p+1) == 0x81 ||",
      "101:                 else",
      "103:                 break;",
      "104:  default:",
      "105:                 if (!ndo->ndo_eflag)",
      "",
      "[Removed Lines]",
      "100:                     isoclns_print(ndo, p + 1, length - 1, ndo->ndo_snapend - p - 1);",
      "102:                     isoclns_print(ndo, p, length, ndo->ndo_snapend - p);",
      "",
      "[Added Lines]",
      "100:                     isoclns_print(ndo, p + 1, length - 1);",
      "102:                     isoclns_print(ndo, p, length);",
      "",
      "---------------"
    ],
    "print-ether.c||print-ether.c": [
      "File: print-ether.c -> print-ether.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "367:    ND_PRINT((ndo, \" [|osi]\"));",
      "368:    return (1);",
      "369:   }",
      "371:   return(1);",
      "373:  case ETHERTYPE_PPPOED:",
      "",
      "[Removed Lines]",
      "370:   isoclns_print(ndo, p + 1, length - 1, caplen - 1);",
      "",
      "[Added Lines]",
      "370:   isoclns_print(ndo, p + 1, length - 1);",
      "",
      "---------------"
    ],
    "print-fr.c||print-fr.c": [
      "File: print-fr.c -> print-fr.c"
    ],
    "print-gre.c||print-gre.c": [
      "File: print-gre.c -> print-gre.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "227:   atalk_print(ndo, bp, len);",
      "228:   break;",
      "229:  case ETHERTYPE_GRE_ISO:",
      "231:   break;",
      "232:  case ETHERTYPE_TEB:",
      "233:   ether_print(ndo, bp, len, ndo->ndo_snapend - bp, NULL, NULL);",
      "",
      "[Removed Lines]",
      "230:   isoclns_print(ndo, bp, len, ndo->ndo_snapend - bp);",
      "",
      "[Added Lines]",
      "230:   isoclns_print(ndo, bp, len);",
      "",
      "---------------"
    ],
    "print-isoclns.c||print-isoclns.c": [
      "File: print-isoclns.c -> print-isoclns.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "670: #define ISIS_PSNP_HEADER_SIZE (sizeof(struct isis_psnp_header))",
      "672: void",
      "675: {",
      "677:   ND_PRINT((ndo, \"|OSI\"));",
      "678:   return;",
      "679:  }",
      "",
      "[Removed Lines]",
      "673: isoclns_print(netdissect_options *ndo,",
      "674:               const uint8_t *p, u_int length, u_int caplen)",
      "",
      "[Added Lines]",
      "673: isoclns_print(netdissect_options *ndo, const uint8_t *p, u_int length)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "686:  case NLPID_CLNP:",
      "687:   if (!clnp_print(ndo, p, length))",
      "689:   break;",
      "691:  case NLPID_ESIS:",
      "",
      "[Removed Lines]",
      "688:    print_unknown_data(ndo, p, \"\\n\\t\", caplen);",
      "",
      "[Added Lines]",
      "687:    print_unknown_data(ndo, p, \"\\n\\t\", length);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "695:  case NLPID_ISIS:",
      "696:   if (!isis_print(ndo, p, length))",
      "698:   break;",
      "700:  case NLPID_NULLNS:",
      "",
      "[Removed Lines]",
      "697:    print_unknown_data(ndo, p, \"\\n\\t\", caplen);",
      "",
      "[Added Lines]",
      "696:    print_unknown_data(ndo, p, \"\\n\\t\", length);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "721:   if (!ndo->ndo_eflag)",
      "722:    ND_PRINT((ndo, \"OSI NLPID 0x%02x unknown\", *p));",
      "723:   ND_PRINT((ndo, \"%slength: %u\", ndo->ndo_eflag ? \"\" : \", \", length));",
      "726:   break;",
      "727:  }",
      "728: }",
      "",
      "[Removed Lines]",
      "724:   if (caplen > 1)",
      "725:    print_unknown_data(ndo, p, \"\\n\\t\", caplen);",
      "",
      "[Added Lines]",
      "723:   if (length > 1)",
      "724:    print_unknown_data(ndo, p, \"\\n\\t\", length);",
      "",
      "---------------"
    ],
    "print-juniper.c||print-juniper.c": [
      "File: print-juniper.c -> print-juniper.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "793:             mpls_print(ndo, p, l2info.length);",
      "794:             return l2info.header_len;",
      "795:         case JUNIPER_LSQ_L3_PROTO_ISO:",
      "797:             return l2info.header_len;",
      "798:         default:",
      "799:             break;",
      "",
      "[Removed Lines]",
      "796:             isoclns_print(ndo, p, l2info.length, l2info.caplen);",
      "",
      "[Added Lines]",
      "796:             isoclns_print(ndo, p, l2info.length);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "848:                 mpls_print(ndo, p, l2info.length);",
      "849:                 return l2info.header_len;",
      "850:             case JUNIPER_LSQ_L3_PROTO_ISO:",
      "852:                 return l2info.header_len;",
      "853:             default:",
      "854:                 break;",
      "",
      "[Removed Lines]",
      "851:                 isoclns_print(ndo, p, l2info.length, l2info.caplen);",
      "",
      "[Added Lines]",
      "851:                 isoclns_print(ndo, p, l2info.length);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "861:             ND_PRINT((ndo, \"Bundle-ID %u, \", l2info.bundle));",
      "862:         switch (l2info.proto) {",
      "863:         case (LLCSAP_ISONS<<8 | LLCSAP_ISONS):",
      "865:             break;",
      "866:         case (LLC_UI<<8 | NLPID_Q933):",
      "867:         case (LLC_UI<<8 | NLPID_IP):",
      "868:         case (LLC_UI<<8 | NLPID_IP6):",
      "871:             break;",
      "872:         default:",
      "873:             ND_PRINT((ndo, \"unknown protocol 0x%04x, length %u\", l2info.proto, l2info.length));",
      "",
      "[Removed Lines]",
      "864:             isoclns_print(ndo, p + 1, l2info.length - 1, l2info.caplen - 1);",
      "870:             isoclns_print(ndo, p - 1, l2info.length + 1, l2info.caplen + 1);",
      "",
      "[Added Lines]",
      "864:             isoclns_print(ndo, p + 1, l2info.length - 1);",
      "870:             isoclns_print(ndo, p - 1, l2info.length + 1);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "896:         switch (l2info.proto) {",
      "897:         case (LLC_UI):",
      "898:         case (LLC_UI<<8):",
      "900:             break;",
      "901:         case (LLC_UI<<8 | NLPID_Q933):",
      "902:         case (LLC_UI<<8 | NLPID_IP):",
      "903:         case (LLC_UI<<8 | NLPID_IP6):",
      "906:             break;",
      "907:         default:",
      "908:             ND_PRINT((ndo, \"unknown protocol 0x%04x, length %u\", l2info.proto, l2info.length));",
      "",
      "[Removed Lines]",
      "899:             isoclns_print(ndo, p, l2info.length, l2info.caplen);",
      "905:             isoclns_print(ndo, p - 1, l2info.length + 1, l2info.caplen + 1);",
      "",
      "[Added Lines]",
      "899:             isoclns_print(ndo, p, l2info.length);",
      "905:             isoclns_print(ndo, p - 1, l2info.length + 1);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "949:         }",
      "954:             return l2info.header_len;",
      "955:         }",
      "",
      "[Removed Lines]",
      "952:             isoclns_print(ndo, p + 1, l2info.length - 1, l2info.caplen - 1);",
      "",
      "[Added Lines]",
      "952:             isoclns_print(ndo, p + 1, l2info.length - 1);",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1004:         }",
      "1009:             return l2info.header_len;",
      "1010:         }",
      "",
      "[Removed Lines]",
      "1007:             isoclns_print(ndo, p + 1, l2info.length - 1, l2info.caplen - 1);",
      "",
      "[Added Lines]",
      "1007:             isoclns_print(ndo, p + 1, l2info.length - 1);",
      "",
      "---------------"
    ],
    "print-llc.c||print-llc.c": [
      "File: print-llc.c -> print-llc.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "324: #endif",
      "325:  if (ssap == LLCSAP_ISONS && dsap == LLCSAP_ISONS",
      "326:      && control == LLC_UI) {",
      "328:   return (hdrlen);",
      "329:  }",
      "",
      "[Removed Lines]",
      "327:   isoclns_print(ndo, p, length, caplen);",
      "",
      "[Added Lines]",
      "327:   isoclns_print(ndo, p, length);",
      "",
      "---------------"
    ],
    "print-mpls.c||print-mpls.c": [
      "File: print-mpls.c -> print-mpls.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "201:   break;",
      "203:  case PT_OSI:",
      "205:   break;",
      "207:  default:",
      "",
      "[Removed Lines]",
      "204:   isoclns_print(ndo, p, length, length);",
      "",
      "[Added Lines]",
      "204:   isoclns_print(ndo, p, length);",
      "",
      "---------------"
    ],
    "print-null.c||print-null.c": [
      "File: print-null.c -> print-null.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "117:   break;",
      "119:  case BSD_AFNUM_ISO:",
      "121:   break;",
      "123:  case BSD_AFNUM_APPLETALK:",
      "",
      "[Removed Lines]",
      "120:   isoclns_print(ndo, p, length, caplen);",
      "",
      "[Added Lines]",
      "120:   isoclns_print(ndo, p, length);",
      "",
      "---------------"
    ],
    "print-ppp.c||print-ppp.c": [
      "File: print-ppp.c -> print-ppp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1484:   ipx_print(ndo, p, length);",
      "1485:   break;",
      "1486:  case PPP_OSI:",
      "1488:   break;",
      "1489:  case PPP_MPLS_UCAST:",
      "1490:  case PPP_MPLS_MCAST:",
      "",
      "[Removed Lines]",
      "1487:   isoclns_print(ndo, p, length, length);",
      "",
      "[Added Lines]",
      "1487:   isoclns_print(ndo, p, length);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "787ba23d07a46527cc5da899158d9127b78e4ef8",
      "candidate_info": {
        "commit_hash": "787ba23d07a46527cc5da899158d9127b78e4ef8",
        "repo": "the-tcpdump-group/tcpdump",
        "commit_url": "https://github.com/the-tcpdump-group/tcpdump/commit/787ba23d07a46527cc5da899158d9127b78e4ef8",
        "files": [
          "print-hsrp.c",
          "print-isoclns.c"
        ],
        "message": "Update for coherence between prototypes and definitions",
        "before_after_code_files": [
          "print-hsrp.c||print-hsrp.c",
          "print-isoclns.c||print-isoclns.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "print-isoclns.c||print-isoclns.c"
          ],
          "candidate": [
            "print-isoclns.c||print-isoclns.c"
          ]
        }
      },
      "candidate_diff": {
        "print-hsrp.c||print-hsrp.c": [
          "File: print-hsrp.c -> print-hsrp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "94: };",
          "96: void",
          "98: {",
          "99:  const struct hsrp *hp = (const struct hsrp *) bp;",
          "100:  uint8_t version;",
          "",
          "[Removed Lines]",
          "97: hsrp_print(netdissect_options *ndo, const uint8_t *bp, u_int len)",
          "",
          "[Added Lines]",
          "97: hsrp_print(netdissect_options *ndo, const u_char *bp, u_int len)",
          "",
          "---------------"
        ],
        "print-isoclns.c||print-isoclns.c": [
          "File: print-isoclns.c -> print-isoclns.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "677: #define ISIS_PSNP_HEADER_SIZE (sizeof(struct isis_psnp_header))",
          "679: void",
          "681: {",
          "683:   ND_PRINT(\"|OSI\");",
          "",
          "[Removed Lines]",
          "680: isoclns_print(netdissect_options *ndo, const uint8_t *p, u_int length)",
          "",
          "[Added Lines]",
          "680: isoclns_print(netdissect_options *ndo, const u_char *p, u_int length)",
          "",
          "---------------"
        ]
      }
    }
  ]
}