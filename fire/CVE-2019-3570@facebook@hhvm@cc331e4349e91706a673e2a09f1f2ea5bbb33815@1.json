{
  "cve_id": "CVE-2019-3570",
  "cve_desc": "Call to the scrypt_enc() function in HHVM can lead to heap corruption by using specifically crafted parameters (N, r and p). This happens if the parameters are configurable by an attacker for instance by providing the output of scrypt_enc() in a context where Hack/PHP code would attempt to verify it by re-running scrypt_enc() with the same parameters. This could result in information disclosure, memory being overwriten or crashes of the HHVM process. This issue affects versions 4.3.0, 4.4.0, 4.5.0, 4.6.0, 4.7.0, 4.8.0, versions 3.30.5 and below, and all versions in the 4.0, 4.1, and 4.2 series.",
  "repo": "facebook/hhvm",
  "patch_hash": "cc331e4349e91706a673e2a09f1f2ea5bbb33815",
  "patch_info": {
    "commit_hash": "cc331e4349e91706a673e2a09f1f2ea5bbb33815",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/cc331e4349e91706a673e2a09f1f2ea5bbb33815",
    "files": [
      "hphp/runtime/ext/scrypt/config.cmake",
      "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
      "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
      "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
      "hphp/runtime/ext/scrypt/crypto/memory.h",
      "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
      "hphp/runtime/ext/scrypt/crypto/sha256.h"
    ],
    "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142\n\nfbshipit-source-id: 2dcad7c6cb273d4ce4b3479ffa445841fa2d1107",
    "before_after_code_files": [
      "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
      "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
      "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
      "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
      "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
      "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
    ]
  },
  "patch_diff": {
    "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
      "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
      "--- Hunk 1 ---",
      "[Context before]",
      "2:   SOURCES",
      "3:     ext_scrypt.cpp",
      "7:     crypto/params.cpp",
      "8:   HEADERS",
      "9:     crypto/crypto_scrypt.h",
      "10:     crypto/params.h",
      "12:   SYSTEMLIB",
      "13:     ext_scrypt.php",
      "14: )",
      "",
      "[Removed Lines]",
      "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
      "4:     crypto/crypto_scrypt-sse.cpp",
      "5:     crypto/crypto_scrypt-nosse.cpp",
      "6:     crypto/sha256.cpp",
      "11:     crypto/sha256.h",
      "",
      "[Added Lines]",
      "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
      "4:     crypto/crypto_scrypt.cpp",
      "11:   DEPENDS",
      "12:     \"libsodium 1.0.9\"",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
      "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
      "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
      "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "3:    | HipHop for PHP                                                       |",
      "4:    +----------------------------------------------------------------------+",
      "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
      "6:    +----------------------------------------------------------------------+",
      "7:    | This source file is subject to version 3.01 of the PHP license,      |",
      "8:    | that is bundled with this package in the file LICENSE, and is        |",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "14:    +----------------------------------------------------------------------+",
      "33: }",
      "",
      "[Removed Lines]",
      "17: #pragma once",
      "19: #include <folly/portability/Memory.h>",
      "21: namespace folly_ext {",
      "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
      "26:   return folly::detail::aligned_malloc(size, alignment);",
      "27: }",
      "29: inline void aligned_free(void* ptr) {",
      "30:   folly::detail::aligned_free(ptr);",
      "31: }",
      "",
      "[Added Lines]",
      "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
      "20: #include <sodium.h>",
      "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
      "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
      "24:                   uint8_t* buf, size_t buflen) {",
      "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
      "26:                                                N, r, p, buf, buflen);",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
      "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
      "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e5c8c622f378be50703bfa547398be0d35f4e603",
      "candidate_info": {
        "commit_hash": "e5c8c622f378be50703bfa547398be0d35f4e603",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/e5c8c622f378be50703bfa547398be0d35f4e603",
        "files": [
          "hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h"
        ],
        "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142",
        "before_after_code_files": [
          "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ],
          "candidate": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
          "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   SOURCES",
          "3:     ext_scrypt.cpp",
          "7:     crypto/params.cpp",
          "8:   HEADERS",
          "9:     crypto/crypto_scrypt.h",
          "10:     crypto/params.h",
          "12:   SYSTEMLIB",
          "13:     ext_scrypt.php",
          "14: )",
          "",
          "[Removed Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
          "4:     crypto/crypto_scrypt-sse.cpp",
          "5:     crypto/crypto_scrypt-nosse.cpp",
          "6:     crypto/sha256.cpp",
          "11:     crypto/sha256.h",
          "",
          "[Added Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
          "4:     crypto/crypto_scrypt.cpp",
          "11:   DEPENDS",
          "12:     \"libsodium 1.0.9\"",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:    | HipHop for PHP                                                       |",
          "4:    +----------------------------------------------------------------------+",
          "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
          "6:    +----------------------------------------------------------------------+",
          "7:    | This source file is subject to version 3.01 of the PHP license,      |",
          "8:    | that is bundled with this package in the file LICENSE, and is        |",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:    +----------------------------------------------------------------------+",
          "33: }",
          "",
          "[Removed Lines]",
          "17: #pragma once",
          "19: #include <folly/portability/Memory.h>",
          "21: namespace folly_ext {",
          "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
          "26:   return folly::detail::aligned_malloc(size, alignment);",
          "27: }",
          "29: inline void aligned_free(void* ptr) {",
          "30:   folly::detail::aligned_free(ptr);",
          "31: }",
          "",
          "[Added Lines]",
          "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
          "20: #include <sodium.h>",
          "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
          "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
          "24:                   uint8_t* buf, size_t buflen) {",
          "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
          "26:                                                N, r, p, buf, buflen);",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b3973d3bd2beeb7e1ea41639cbc7251e16fe2d83",
      "candidate_info": {
        "commit_hash": "b3973d3bd2beeb7e1ea41639cbc7251e16fe2d83",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/b3973d3bd2beeb7e1ea41639cbc7251e16fe2d83",
        "files": [
          "hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h"
        ],
        "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142",
        "before_after_code_files": [
          "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ],
          "candidate": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
          "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   SOURCES",
          "3:     ext_scrypt.cpp",
          "7:     crypto/params.cpp",
          "8:   HEADERS",
          "9:     crypto/crypto_scrypt.h",
          "10:     crypto/params.h",
          "12:   SYSTEMLIB",
          "13:     ext_scrypt.php",
          "14: )",
          "",
          "[Removed Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
          "4:     crypto/crypto_scrypt-sse.cpp",
          "5:     crypto/crypto_scrypt-nosse.cpp",
          "6:     crypto/sha256.cpp",
          "11:     crypto/sha256.h",
          "",
          "[Added Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
          "4:     crypto/crypto_scrypt.cpp",
          "11:   DEPENDS",
          "12:     \"libsodium 1.0.9\"",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:    | HipHop for PHP                                                       |",
          "4:    +----------------------------------------------------------------------+",
          "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
          "6:    +----------------------------------------------------------------------+",
          "7:    | This source file is subject to version 3.01 of the PHP license,      |",
          "8:    | that is bundled with this package in the file LICENSE, and is        |",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:    +----------------------------------------------------------------------+",
          "33: }",
          "",
          "[Removed Lines]",
          "17: #pragma once",
          "19: #include <folly/portability/Memory.h>",
          "21: namespace folly_ext {",
          "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
          "26:   return folly::detail::aligned_malloc(size, alignment);",
          "27: }",
          "29: inline void aligned_free(void* ptr) {",
          "30:   folly::detail::aligned_free(ptr);",
          "31: }",
          "",
          "[Added Lines]",
          "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
          "20: #include <sodium.h>",
          "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
          "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
          "24:                   uint8_t* buf, size_t buflen) {",
          "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
          "26:                                                N, r, p, buf, buflen);",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4bef37f49e822fed0b8ad8cbaa1fbc1743fe1ac",
      "candidate_info": {
        "commit_hash": "c4bef37f49e822fed0b8ad8cbaa1fbc1743fe1ac",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/c4bef37f49e822fed0b8ad8cbaa1fbc1743fe1ac",
        "files": [
          "hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h"
        ],
        "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142",
        "before_after_code_files": [
          "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ],
          "candidate": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
          "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   SOURCES",
          "3:     ext_scrypt.cpp",
          "7:     crypto/params.cpp",
          "8:   HEADERS",
          "9:     crypto/crypto_scrypt.h",
          "10:     crypto/params.h",
          "12:   SYSTEMLIB",
          "13:     ext_scrypt.php",
          "14: )",
          "",
          "[Removed Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
          "4:     crypto/crypto_scrypt-sse.cpp",
          "5:     crypto/crypto_scrypt-nosse.cpp",
          "6:     crypto/sha256.cpp",
          "11:     crypto/sha256.h",
          "",
          "[Added Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
          "4:     crypto/crypto_scrypt.cpp",
          "11:   DEPENDS",
          "12:     \"libsodium 1.0.9\"",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:    | HipHop for PHP                                                       |",
          "4:    +----------------------------------------------------------------------+",
          "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
          "6:    +----------------------------------------------------------------------+",
          "7:    | This source file is subject to version 3.01 of the PHP license,      |",
          "8:    | that is bundled with this package in the file LICENSE, and is        |",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:    +----------------------------------------------------------------------+",
          "33: }",
          "",
          "[Removed Lines]",
          "17: #pragma once",
          "19: #include <folly/portability/Memory.h>",
          "21: namespace folly_ext {",
          "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
          "26:   return folly::detail::aligned_malloc(size, alignment);",
          "27: }",
          "29: inline void aligned_free(void* ptr) {",
          "30:   folly::detail::aligned_free(ptr);",
          "31: }",
          "",
          "[Added Lines]",
          "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
          "20: #include <sodium.h>",
          "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
          "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
          "24:                   uint8_t* buf, size_t buflen) {",
          "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
          "26:                                                N, r, p, buf, buflen);",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7b95110648f8a5bfef1ca8fda90ea230c085545e",
      "candidate_info": {
        "commit_hash": "7b95110648f8a5bfef1ca8fda90ea230c085545e",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/7b95110648f8a5bfef1ca8fda90ea230c085545e",
        "files": [
          "hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h"
        ],
        "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142",
        "before_after_code_files": [
          "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ],
          "candidate": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
          "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   SOURCES",
          "3:     ext_scrypt.cpp",
          "7:     crypto/params.cpp",
          "8:   HEADERS",
          "9:     crypto/crypto_scrypt.h",
          "10:     crypto/params.h",
          "12:   SYSTEMLIB",
          "13:     ext_scrypt.php",
          "14: )",
          "",
          "[Removed Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
          "4:     crypto/crypto_scrypt-sse.cpp",
          "5:     crypto/crypto_scrypt-nosse.cpp",
          "6:     crypto/sha256.cpp",
          "11:     crypto/sha256.h",
          "",
          "[Added Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
          "4:     crypto/crypto_scrypt.cpp",
          "11:   DEPENDS",
          "12:     \"libsodium 1.0.9\"",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:    | HipHop for PHP                                                       |",
          "4:    +----------------------------------------------------------------------+",
          "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
          "6:    +----------------------------------------------------------------------+",
          "7:    | This source file is subject to version 3.01 of the PHP license,      |",
          "8:    | that is bundled with this package in the file LICENSE, and is        |",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:    +----------------------------------------------------------------------+",
          "33: }",
          "",
          "[Removed Lines]",
          "17: #pragma once",
          "19: #include <folly/portability/Memory.h>",
          "21: namespace folly_ext {",
          "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
          "26:   return folly::detail::aligned_malloc(size, alignment);",
          "27: }",
          "29: inline void aligned_free(void* ptr) {",
          "30:   folly::detail::aligned_free(ptr);",
          "31: }",
          "",
          "[Added Lines]",
          "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
          "20: #include <sodium.h>",
          "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
          "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
          "24:                   uint8_t* buf, size_t buflen) {",
          "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
          "26:                                                N, r, p, buf, buflen);",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "928b8ae66a066e94276619f9d364cbf507f88a5e",
      "candidate_info": {
        "commit_hash": "928b8ae66a066e94276619f9d364cbf507f88a5e",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/928b8ae66a066e94276619f9d364cbf507f88a5e",
        "files": [
          "hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h"
        ],
        "message": "Replace copied scrypt implementation with call to libsodium\n\nSummary:\nlibsodium actually uses the same implementation; using libsodium means we don't\nneed to maintain a copy ourselves.\n\nKeep the `pickparams` implementation though, as that's not exposed in libsodium.\n\nWe should deprecate this extension, and strongly encourage directly using `ext_sodium` instead from Hack code; stored hashes from `ext_scrypt` can be verified like this:\n\n```\n$enc = scrypt_enc('foo', random_bytes(SODIUM_CRYPTO_PWHASH_SCRYPTSALSA208SHA256_SALTBYTES));\n\t\u200b\n\u200blist($_, $algo, $n, $r, $p, $salt, $out) = explode('$', $enc);\n\u200binvariant($algo === 's', 'did not get an scrypt result');\n\u200b$salt = base64_decode($salt);\n\u200b$out = base64_decode($out);\n\u200b\n\u200b$opslimit = (1 << $n) * $r * $p * 4;\n\u200b$memlimit = (1 << $n) * $r * 128;\n\u200b$sodium = sodium_crypto_pwhash_scryptsalsa208sha256(strlen($out), 'foo', $salt, $opslimit, $memlimit);\n\u200b\\var_dump($sodium === $out);\n```\n\nThis also makes the scrypt extension depend on libsodium; this is fine, libsodium's going to be a hard dependency for HHVM  anyway when the proxygen pin is next updated.\n\nReviewed By: alexeyt\n\nDifferential Revision: D15702142",
        "before_after_code_files": [
          "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ],
          "candidate": [
            "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
            "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
            "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp",
            "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/scrypt/config.cmake||hphp/runtime/ext/scrypt/config.cmake": [
          "File: hphp/runtime/ext/scrypt/config.cmake -> hphp/runtime/ext/scrypt/config.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "2:   SOURCES",
          "3:     ext_scrypt.cpp",
          "7:     crypto/params.cpp",
          "8:   HEADERS",
          "9:     crypto/crypto_scrypt.h",
          "10:     crypto/params.h",
          "12:   SYSTEMLIB",
          "13:     ext_scrypt.php",
          "14: )",
          "",
          "[Removed Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\"",
          "4:     crypto/crypto_scrypt-sse.cpp",
          "5:     crypto/crypto_scrypt-nosse.cpp",
          "6:     crypto/sha256.cpp",
          "11:     crypto/sha256.h",
          "",
          "[Added Lines]",
          "1: HHVM_DEFINE_EXTENSION(\"scrypt\" IMPLICIT",
          "4:     crypto/crypto_scrypt.cpp",
          "11:   DEPENDS",
          "12:     \"libsodium 1.0.9\"",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-nosse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp||hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt-sse.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/memory.h||hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/memory.h -> hphp/runtime/ext/scrypt/crypto/crypto_scrypt.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "3:    | HipHop for PHP                                                       |",
          "4:    +----------------------------------------------------------------------+",
          "5:    | Copyright (c) 2010-present Facebook, Inc. (http://www.facebook.com)  |",
          "6:    +----------------------------------------------------------------------+",
          "7:    | This source file is subject to version 3.01 of the PHP license,      |",
          "8:    | that is bundled with this package in the file LICENSE, and is        |",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6:    | Copyright (c) 1997-2010 The PHP Group                                |",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "14:    +----------------------------------------------------------------------+",
          "33: }",
          "",
          "[Removed Lines]",
          "17: #pragma once",
          "19: #include <folly/portability/Memory.h>",
          "21: namespace folly_ext {",
          "25: inline void* aligned_malloc(size_t size, size_t alignment) {",
          "26:   return folly::detail::aligned_malloc(size, alignment);",
          "27: }",
          "29: inline void aligned_free(void* ptr) {",
          "30:   folly::detail::aligned_free(ptr);",
          "31: }",
          "",
          "[Added Lines]",
          "18: #include \"hphp/runtime/ext/scrypt/crypto/crypto_scrypt.h\"",
          "20: #include <sodium.h>",
          "22: int crypto_scrypt(const uint8_t* password, size_t pwlen, const uint8_t* salt,",
          "23:                   size_t saltlen, uint64_t N, uint32_t r, uint32_t p,",
          "24:                   uint8_t* buf, size_t buflen) {",
          "25:   return crypto_pwhash_scryptsalsa208sha256_ll(password, pwlen, salt, saltlen,",
          "26:                                                N, r, p, buf, buflen);",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.cpp||hphp/runtime/ext/scrypt/crypto/sha256.cpp": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.cpp -> hphp/runtime/ext/scrypt/crypto/sha256.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/scrypt/crypto/sha256.h||hphp/runtime/ext/scrypt/crypto/sha256.h": [
          "File: hphp/runtime/ext/scrypt/crypto/sha256.h -> hphp/runtime/ext/scrypt/crypto/sha256.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}