{
  "cve_id": "CVE-2023-27590",
  "cve_desc": "Rizin is a UNIX-like reverse engineering framework and command-line toolset. In version 0.5.1 and prior, converting a GDB registers profile file into a Rizin register profile can result in a stack-based buffer overflow when the `name`, `type`, or `groups` fields have longer values than expected. Users opening untrusted GDB registers files (e.g. with the `drpg` or `arpg` commands) are affected by this flaw. Commit d6196703d89c84467b600ba2692534579dc25ed4 contains a patch for this issue. As a workaround, review the GDB register profiles before loading them with `drpg`/`arpg` commands.",
  "repo": "rizinorg/rizin",
  "patch_hash": "d6196703d89c84467b600ba2692534579dc25ed4",
  "patch_info": {
    "commit_hash": "d6196703d89c84467b600ba2692534579dc25ed4",
    "repo": "rizinorg/rizin",
    "commit_url": "https://github.com/rizinorg/rizin/commit/d6196703d89c84467b600ba2692534579dc25ed4",
    "files": [
      "librz/debug/p/debug_gdb.c",
      "librz/debug/p/debug_io.c",
      "librz/include/rz_types_base.h",
      "librz/reg/profile.c"
    ],
    "message": "Fix conversion from GDB register profile to rizin profile",
    "before_after_code_files": [
      "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c",
      "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c",
      "librz/include/rz_types_base.h||librz/include/rz_types_base.h",
      "librz/reg/profile.c||librz/reg/profile.c"
    ]
  },
  "patch_diff": {
    "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c": [
      "File: librz/debug/p/debug_gdb.c -> librz/debug/p/debug_gdb.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "15: #define UNSUPPORTED 0",
      "16: #define SUPPORTED   1",
      "18: typedef struct rz_debug_gdb_ctx_t {",
      "19:  RzIOGdb **origrziogdb;",
      "20:  libgdbr_t *desc;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "18: #define PROC_NAME_SZ   1024",
      "19: #define PROC_REGION_SZ 100",
      "22: #define PROC_REGION_LEFT_SZ 98",
      "23: #define PROC_PERM_SZ        5",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "189:  int unk = 0, perm, i;",
      "190:  char *ptr, *pos_1;",
      "191:  size_t line_len;",
      "193:  RzDebugMap *map = NULL;",
      "194:  region1[0] = region2[0] = '0';",
      "195:  region1[1] = region2[1] = 'x';",
      "",
      "[Removed Lines]",
      "192:  char name[1024], region1[100], region2[100], perms[5];",
      "",
      "[Added Lines]",
      "199:  char name[PROC_NAME_SZ + 1], region1[PROC_REGION_SZ + 1], region2[PROC_REGION_SZ + 1], perms[PROC_PERM_SZ + 1];",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "213:   }",
      "218:   if (ret == 3) {",
      "219:    name[0] = '\\0';",
      "220:   } else if (ret != 4) {",
      "",
      "[Removed Lines]",
      "216:   ret = sscanf(ptr, \"%s %s %\" PFMT64x \" %*s %*s %[^\\n]\", &region1[2],",
      "217:    perms, &offset, name);",
      "",
      "[Added Lines]",
      "223:   ret = sscanf(ptr, \"%\" RZ_STR_DEF(PROC_REGION_LEFT_SZ) \"s %\" RZ_STR_DEF(PROC_PERM_SZ) \"s %\" PFMT64x \" %*s %*s %\" RZ_STR_DEF(PROC_NAME_SZ) \"[^\\n]\",",
      "224:    &region1[2], perms, &offset, name);",
      "",
      "---------------"
    ],
    "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c": [
      "File: librz/debug/p/debug_io.c -> librz/debug/p/debug_io.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include <rz_io.h>",
      "5: #include <rz_debug.h>",
      "7: static int __io_step(RzDebug *dbg) {",
      "8:  free(dbg->iob.system(dbg->iob.io, \"ds\"));",
      "9:  return true;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7: #define IO_MAPS_PERM_SZ 32",
      "8: #define IO_MAPS_NAME_SZ 512",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "23:  }",
      "24:  char *ostr = str;",
      "25:  ut64 map_start, map_end;",
      "28:  for (;;) {",
      "29:   char *nl = strchr(str, '\\n');",
      "30:   if (nl) {",
      "",
      "[Removed Lines]",
      "26:  char perm[32];",
      "27:  char name[512];",
      "",
      "[Added Lines]",
      "29:  char perm[IO_MAPS_PERM_SZ + 1];",
      "30:  char name[IO_MAPS_NAME_SZ + 1];",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "48:    if (_s_) {",
      "49:     memmove(_s_, _s_ + 2, strlen(_s_));",
      "50:    }",
      "52:     &map_start, &map_end, perm, name);",
      "53:    if (map_end != 0LL) {",
      "54:     RzDebugMap *map = rz_debug_map_new(name, map_start, map_end, rz_str_rwx(perm), 0);",
      "",
      "[Removed Lines]",
      "51:    sscanf(str, \"0x%\" PFMT64x \" - 0x%\" PFMT64x \" %s %s\",",
      "",
      "[Added Lines]",
      "54:    sscanf(str, \"0x%\" PFMT64x \" - 0x%\" PFMT64x \" %\" RZ_STR_DEF(IO_MAPS_PERM_SZ) \"s %\" RZ_STR_DEF(IO_MAPS_NAME_SZ) \"s\",",
      "",
      "---------------"
    ],
    "librz/include/rz_types_base.h||librz/include/rz_types_base.h": [
      "File: librz/include/rz_types_base.h -> librz/include/rz_types_base.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "214:   return m ? *m = n, m : m; \\",
      "215:  }",
      "217: #endif // RZ_TYPES_BASE_H",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "217: #define RZ_STR_DEF(s) RZ_STR(s)",
      "218: #define RZ_STR(s)     #s",
      "",
      "---------------"
    ],
    "librz/reg/profile.c||librz/reg/profile.c": [
      "File: librz/reg/profile.c -> librz/reg/profile.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #include <rz_lib.h>",
      "11: #include <string.h>",
      "13: static void rz_reg_profile_def_free(RzRegProfileDef *def) {",
      "14:  if (!def) {",
      "15:   return;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13: #define GDB_NAME_SZ   16",
      "14: #define GDB_TYPE_SZ   16",
      "15: #define GDB_GROUPS_SZ 128",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "511:   return NULL;",
      "512:  }",
      "513:  char *ptr1, *gptr, *gptr1;",
      "515:  const int all = 1, gpr = 2, save = 4, restore = 8, float_ = 16,",
      "516:     sse = 32, vector = 64, system = 128, mmx = 256;",
      "517:  int number, rel, offset, size, type_bits, ret;",
      "",
      "[Removed Lines]",
      "514:  char name[16], groups[128], type[16];",
      "",
      "[Added Lines]",
      "518:  char name[GDB_NAME_SZ + 1], groups[GDB_GROUPS_SZ + 1], type[GDB_TYPE_SZ + 1];",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "542:    rz_strbuf_free(sb);",
      "543:    return false;",
      "544:   }",
      "548:   if (ret < 6) {",
      "549:    if (*ptr != '*') {",
      "",
      "[Removed Lines]",
      "545:   ret = sscanf(ptr, \" %s %d %d %d %d %s %s\", name, &number, &rel,",
      "546:    &offset, &size, type, groups);",
      "",
      "[Added Lines]",
      "549:   ret = sscanf(ptr, \" %\" RZ_STR_DEF(GDB_NAME_SZ) \"s %d %d %d %d %\" RZ_STR_DEF(GDB_TYPE_SZ) \"s %\" RZ_STR_DEF(GDB_GROUPS_SZ) \"s\",",
      "550:    name, &number, &rel, &offset, &size, type, groups);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2e6df3e395ef6afa2ee3e0b198b53d998a70af23",
      "candidate_info": {
        "commit_hash": "2e6df3e395ef6afa2ee3e0b198b53d998a70af23",
        "repo": "rizinorg/rizin",
        "commit_url": "https://github.com/rizinorg/rizin/commit/2e6df3e395ef6afa2ee3e0b198b53d998a70af23",
        "files": [
          "librz/debug/p/debug_gdb.c",
          "librz/debug/p/debug_io.c",
          "librz/include/rz_types_base.h",
          "librz/reg/profile.c"
        ],
        "message": "Fix conversion from GDB register profile to rizin profile",
        "before_after_code_files": [
          "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c",
          "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c",
          "librz/include/rz_types_base.h||librz/include/rz_types_base.h",
          "librz/reg/profile.c||librz/reg/profile.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c",
            "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c",
            "librz/include/rz_types_base.h||librz/include/rz_types_base.h",
            "librz/reg/profile.c||librz/reg/profile.c"
          ],
          "candidate": [
            "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c",
            "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c",
            "librz/include/rz_types_base.h||librz/include/rz_types_base.h",
            "librz/reg/profile.c||librz/reg/profile.c"
          ]
        }
      },
      "candidate_diff": {
        "librz/debug/p/debug_gdb.c||librz/debug/p/debug_gdb.c": [
          "File: librz/debug/p/debug_gdb.c -> librz/debug/p/debug_gdb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: #define UNSUPPORTED 0",
          "16: #define SUPPORTED   1",
          "18: typedef struct rz_debug_gdb_ctx_t {",
          "19:  RzIOGdb **origrziogdb;",
          "20:  libgdbr_t *desc;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "18: #define PROC_NAME_SZ   1024",
          "19: #define PROC_REGION_SZ 100",
          "22: #define PROC_REGION_LEFT_SZ 98",
          "23: #define PROC_PERM_SZ        5",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "189:  int unk = 0, perm, i;",
          "190:  char *ptr, *pos_1;",
          "191:  size_t line_len;",
          "193:  RzDebugMap *map = NULL;",
          "194:  region1[0] = region2[0] = '0';",
          "195:  region1[1] = region2[1] = 'x';",
          "",
          "[Removed Lines]",
          "192:  char name[1024], region1[100], region2[100], perms[5];",
          "",
          "[Added Lines]",
          "199:  char name[PROC_NAME_SZ + 1], region1[PROC_REGION_SZ + 1], region2[PROC_REGION_SZ + 1], perms[PROC_PERM_SZ + 1];",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "213:   }",
          "218:   if (ret == 3) {",
          "219:    name[0] = '\\0';",
          "220:   } else if (ret != 4) {",
          "",
          "[Removed Lines]",
          "216:   ret = sscanf(ptr, \"%s %s %\" PFMT64x \" %*s %*s %[^\\n]\", &region1[2],",
          "217:    perms, &offset, name);",
          "",
          "[Added Lines]",
          "223:   ret = sscanf(ptr, \"%\" RZ_STR_DEF(PROC_REGION_LEFT_SZ) \"s %\" RZ_STR_DEF(PROC_PERM_SZ) \"s %\" PFMT64x \" %*s %*s %\" RZ_STR_DEF(PROC_NAME_SZ) \"[^\\n]\",",
          "224:    &region1[2], perms, &offset, name);",
          "",
          "---------------"
        ],
        "librz/debug/p/debug_io.c||librz/debug/p/debug_io.c": [
          "File: librz/debug/p/debug_io.c -> librz/debug/p/debug_io.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: #include <rz_io.h>",
          "5: #include <rz_debug.h>",
          "7: static int __io_step(RzDebug *dbg) {",
          "8:  free(dbg->iob.system(dbg->iob.io, \"ds\"));",
          "9:  return true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: #define IO_MAPS_PERM_SZ 32",
          "8: #define IO_MAPS_NAME_SZ 512",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "23:  }",
          "24:  char *ostr = str;",
          "25:  ut64 map_start, map_end;",
          "28:  for (;;) {",
          "29:   char *nl = strchr(str, '\\n');",
          "30:   if (nl) {",
          "",
          "[Removed Lines]",
          "26:  char perm[32];",
          "27:  char name[512];",
          "",
          "[Added Lines]",
          "29:  char perm[IO_MAPS_PERM_SZ + 1];",
          "30:  char name[IO_MAPS_NAME_SZ + 1];",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "48:    if (_s_) {",
          "49:     memmove(_s_, _s_ + 2, strlen(_s_));",
          "50:    }",
          "52:     &map_start, &map_end, perm, name);",
          "53:    if (map_end != 0LL) {",
          "54:     RzDebugMap *map = rz_debug_map_new(name, map_start, map_end, rz_str_rwx(perm), 0);",
          "",
          "[Removed Lines]",
          "51:    sscanf(str, \"0x%\" PFMT64x \" - 0x%\" PFMT64x \" %s %s\",",
          "",
          "[Added Lines]",
          "54:    sscanf(str, \"0x%\" PFMT64x \" - 0x%\" PFMT64x \" %\" RZ_STR_DEF(IO_MAPS_PERM_SZ) \"s %\" RZ_STR_DEF(IO_MAPS_NAME_SZ) \"s\",",
          "",
          "---------------"
        ],
        "librz/include/rz_types_base.h||librz/include/rz_types_base.h": [
          "File: librz/include/rz_types_base.h -> librz/include/rz_types_base.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "224:   return m ? *m = n, m : m; \\",
          "225:  }",
          "227: #endif // RZ_TYPES_BASE_H",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "227: #define RZ_STR_DEF(s) RZ_STR(s)",
          "228: #define RZ_STR(s)     #s",
          "",
          "---------------"
        ],
        "librz/reg/profile.c||librz/reg/profile.c": [
          "File: librz/reg/profile.c -> librz/reg/profile.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #include <rz_lib.h>",
          "11: #include <string.h>",
          "13: static void rz_reg_profile_def_free(RzRegProfileDef *def) {",
          "14:  if (!def) {",
          "15:   return;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "13: #define GDB_NAME_SZ   16",
          "14: #define GDB_TYPE_SZ   16",
          "15: #define GDB_GROUPS_SZ 128",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "511:   return NULL;",
          "512:  }",
          "513:  char *ptr1, *gptr, *gptr1;",
          "515:  const int all = 1, gpr = 2, save = 4, restore = 8, float_ = 16,",
          "516:     sse = 32, vector = 64, system = 128, mmx = 256;",
          "517:  int number, rel, offset, size, type_bits, ret;",
          "",
          "[Removed Lines]",
          "514:  char name[16], groups[128], type[16];",
          "",
          "[Added Lines]",
          "518:  char name[GDB_NAME_SZ + 1], groups[GDB_GROUPS_SZ + 1], type[GDB_TYPE_SZ + 1];",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "542:    rz_strbuf_free(sb);",
          "543:    return false;",
          "544:   }",
          "548:   if (ret < 6) {",
          "549:    if (*ptr != '*') {",
          "",
          "[Removed Lines]",
          "545:   ret = sscanf(ptr, \" %s %d %d %d %d %s %s\", name, &number, &rel,",
          "546:    &offset, &size, type, groups);",
          "",
          "[Added Lines]",
          "549:   ret = sscanf(ptr, \" %\" RZ_STR_DEF(GDB_NAME_SZ) \"s %d %d %d %d %\" RZ_STR_DEF(GDB_TYPE_SZ) \"s %\" RZ_STR_DEF(GDB_GROUPS_SZ) \"s\",",
          "550:    name, &number, &rel, &offset, &size, type, groups);",
          "",
          "---------------"
        ]
      }
    }
  ]
}