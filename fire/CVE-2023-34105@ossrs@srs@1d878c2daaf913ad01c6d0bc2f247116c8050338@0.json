{
  "cve_id": "CVE-2023-34105",
  "cve_desc": "SRS is a real-time video server supporting RTMP, WebRTC, HLS, HTTP-FLV, SRT, MPEG-DASH, and GB28181. Prior to versions 5.0.157, 5.0-b1, and 6.0.48, SRS's `api-server` server is vulnerable to a drive-by command injection. An attacker may send a request to the `/api/v1/snapshots` endpoint containing any commands to be executed as part of the body of the POST request. This issue may lead to Remote Code Execution (RCE). Versions 5.0.157, 5.0-b1, and 6.0.48 contain a fix.",
  "repo": "ossrs/srs",
  "patch_hash": "1d878c2daaf913ad01c6d0bc2f247116c8050338",
  "patch_info": {
    "commit_hash": "1d878c2daaf913ad01c6d0bc2f247116c8050338",
    "repo": "ossrs/srs",
    "commit_url": "https://github.com/ossrs/srs/commit/1d878c2daaf913ad01c6d0bc2f247116c8050338",
    "files": [
      "trunk/doc/CHANGELOG.md",
      "trunk/research/api-server/server.go",
      "trunk/src/core/srs_core_version5.hpp",
      "trunk/src/core/srs_core_version6.hpp"
    ],
    "message": "Fix command injection in api-server for HTTP callback. v5.0.157, v6.0.48",
    "before_after_code_files": [
      "trunk/research/api-server/server.go||trunk/research/api-server/server.go",
      "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
      "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
    ]
  },
  "patch_diff": {
    "trunk/research/api-server/server.go||trunk/research/api-server/server.go": [
      "File: trunk/research/api-server/server.go -> trunk/research/api-server/server.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "400:  normalPicPath := path.Join(outputPicDir, fmt.Sprintf(\"%v\", v.Stream)+\"-%03d.png\")",
      "401:  bestPng := path.Join(outputPicDir, fmt.Sprintf(\"%v-best.png\", v.Stream))",
      "405:  timeoutCtx, _ := context.WithTimeout(v.cancelCtx, v.timeout)",
      "407:  if err = cmd.Run(); err != nil {",
      "408:   log.Println(fmt.Sprintf(\"run snapshot %v cmd failed, err is %v\", v.Tag(), err))",
      "409:   return",
      "",
      "[Removed Lines]",
      "403:  param := fmt.Sprintf(\"%v -i %v -vf fps=1 -vcodec png -f image2 -an -y -vframes %v -y %v\", ffmpegPath, inputUrl, v.vframes, normalPicPath)",
      "404:  log.Println(fmt.Sprintf(\"start snapshot, cmd param=%v\", param))",
      "406:  cmd := exec.CommandContext(timeoutCtx, \"/bin/bash\", \"-c\", param)",
      "",
      "[Added Lines]",
      "403:  params := []string{",
      "404:   \"-i\", inputUrl,",
      "405:   \"-vf\", \"fps=1\",",
      "406:   \"-vcodec\", \"png\",",
      "407:   \"-f\", \"image2\",",
      "408:   \"-an\",",
      "409:   \"-vframes\", strconv.Itoa(v.vframes),",
      "410:   \"-y\", normalPicPath,",
      "411:  }",
      "412:  log.Println(fmt.Sprintf(\"start snapshot, cmd param=%v %v\", ffmpegPath, strings.Join(params, \" \")))",
      "414:  cmd := exec.CommandContext(timeoutCtx, ffmpegPath, params...)",
      "",
      "---------------"
    ],
    "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
      "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #define VERSION_MAJOR       5",
      "11: #define VERSION_MINOR       0",
      "14: #endif",
      "",
      "[Removed Lines]",
      "12: #define VERSION_REVISION    156",
      "",
      "[Added Lines]",
      "12: #define VERSION_REVISION    157",
      "",
      "---------------"
    ],
    "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
      "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #define VERSION_MAJOR       6",
      "11: #define VERSION_MINOR       0",
      "14: #endif",
      "",
      "[Removed Lines]",
      "12: #define VERSION_REVISION    47",
      "",
      "[Added Lines]",
      "12: #define VERSION_REVISION    48",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fbb8c16496436d4d270cafa2ceef57b441495593",
      "candidate_info": {
        "commit_hash": "fbb8c16496436d4d270cafa2ceef57b441495593",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/fbb8c16496436d4d270cafa2ceef57b441495593",
        "files": [
          "trunk/auto/depends.sh",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "Build: Support sys-ssl for srt. v5.0.184 v6.0.82 (#3806)\n\nsupport sys-ssl for srt\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>",
        "before_after_code_files": [
          "trunk/auto/depends.sh||trunk/auto/depends.sh",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/auto/depends.sh||trunk/auto/depends.sh": [
          "File: trunk/auto/depends.sh -> trunk/auto/depends.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "682:         rm -rf ${SRS_OBJS}/srt && cp -rf ${SRS_OBJS}/${SRS_PLATFORM}/3rdparty/srt ${SRS_OBJS}/ &&",
          "683:         echo \"libsrt-1-fit is ok.\"",
          "684:     else",
          "686:             echo \"OpenSSL pkgconfig no found, build srt-1-fit failed.\"",
          "687:             exit -1",
          "688:         fi",
          "",
          "[Removed Lines]",
          "685:         if [[ ! -d ${SRS_OBJS}/openssl/lib/pkgconfig ]]; then",
          "",
          "[Added Lines]",
          "685:         if [[ $SRS_USE_SYS_SSL != YES && ! -d ${SRS_OBJS}/openssl/lib/pkgconfig ]]; then",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    183",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    184",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    81",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    82",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e7b629cd399dfc5c4399d1cde87cf6c96e0046bd",
      "candidate_info": {
        "commit_hash": "e7b629cd399dfc5c4399d1cde87cf6c96e0046bd",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/e7b629cd399dfc5c4399d1cde87cf6c96e0046bd",
        "files": [
          ".github/workflows/test.yml",
          "trunk/auto/options.sh",
          "trunk/doc/CHANGELOG.md",
          "trunk/research/players/js/srs.page.js",
          "trunk/research/players/srs_player.html",
          "trunk/research/players/whep.html",
          "trunk/research/players/whip.html",
          "trunk/src/app/srs_app_rtc_codec.cpp",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "RTC: Refine FFmpeg opus audio noisy issue. v5.0.197 v6.0.97 (#3852)\n\n### Description\n\nWhen converting between AAC and Opus formats (aac2opus or opus2aac), the\n`av_frame_get_buffer` API is frequently called.\n\n### Objective\n\nThe goal is to optimize the code logic and reduce the frequent\nallocation and deallocation of memory.\n\nIn the case of aac2opus, av_frame_get_buffer is still frequently called.\nIn the case of opus2aac, the goal is to avoid calling\nav_frame_get_buffer and reduce memory allocations.\n\n### Additional Note\n\nBefore calling the `av_audio_fifo_read` API, use\n`av_frame_make_writable` to check if the frame is writable. If it is not\nwritable, create a new frame.\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>",
        "before_after_code_files": [
          "trunk/auto/options.sh||trunk/auto/options.sh",
          "trunk/research/players/js/srs.page.js||trunk/research/players/js/srs.page.js",
          "trunk/research/players/srs_player.html||trunk/research/players/srs_player.html",
          "trunk/research/players/whep.html||trunk/research/players/whep.html",
          "trunk/research/players/whip.html||trunk/research/players/whip.html",
          "trunk/src/app/srs_app_rtc_codec.cpp||trunk/src/app/srs_app_rtc_codec.cpp",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/auto/options.sh||trunk/auto/options.sh": [
          "File: trunk/auto/options.sh -> trunk/auto/options.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "451:         --ffmpeg-tool)                  SRS_FFMPEG_TOOL=$(switch2value $value) ;;",
          "453:         # use cache for build.",
          "458:             echo \"$0: error: invalid option \\\"$option\\\"\"",
          "",
          "[Removed Lines]",
          "454:         --build-cache)                  SRS_BUILD_CACHE=YES         ;;",
          "455:         --without-build-cache)          SRS_BUILD_CACHE=NO          ;;",
          "",
          "[Added Lines]",
          "454:         --build-cache)                  SRS_BUILD_CACHE=$(switch2value $value) ;;",
          "",
          "---------------"
        ],
        "trunk/research/players/js/srs.page.js||trunk/research/players/js/srs.page.js": [
          "File: trunk/research/players/js/srs.page.js -> trunk/research/players/js/srs.page.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: function update_nav() {",
          "17:     $(\"#nav_srs_player\").attr(\"href\", \"srs_player.html\" + window.location.search);",
          "18:     $(\"#nav_rtc_player\").attr(\"href\", \"rtc_player.html\" + window.location.search);",
          "19:     $(\"#nav_rtc_publisher\").attr(\"href\", \"rtc_publisher.html\" + window.location.search);",
          "",
          "[Removed Lines]",
          "16:     $(\"#srs_index\").attr(\"href\", \"index.html\" + window.location.search);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "trunk/research/players/srs_player.html||trunk/research/players/srs_player.html": [
          "File: trunk/research/players/srs_player.html -> trunk/research/players/srs_player.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: <div class=\"navbar navbar-fixed-top\">",
          "16:     <div class=\"navbar-inner\">",
          "17:         <div class=\"container\">",
          "19:             <div class=\"nav-collapse collapse\">",
          "20:                 <ul class=\"nav\">",
          "21:                     <li class=\"active\"><a id=\"nav_srs_player\" href=\"srs_player.html\">LivePlayer</a></li>",
          "",
          "[Removed Lines]",
          "18:             <a id=\"srs_index\" class=\"brand\" href=\"#\">SRS</a>",
          "",
          "[Added Lines]",
          "18:             <a class=\"brand\" href=\"https://github.com/ossrs/srs\" target=\"_blank\">SRS</a>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "29:                     <!--<li><a id=\"nav_srs_bwt\" href=\"srs_bwt.html\">SRS\u6d4b\u7f51\u901f</a></li>-->",
          "30:                     <!--li><a id=\"nav_vlc\" href=\"vlc.html\">VLC\u64ad\u653e\u5668</a></li>-->",
          "31:                     <!--<li><a id=\"nav_gb28181\" href=\"srs_gb28181.html\">GB28181</a></li>-->",
          "33:                         <a href=\"https://github.com/ossrs/srs\">",
          "34:                             <img alt=\"GitHub Repo stars\" src=\"https://img.shields.io/github/stars/ossrs/srs?style=social\">",
          "35:                         </a>",
          "37:                 </ul>",
          "38:             </div>",
          "39:         </div>",
          "",
          "[Removed Lines]",
          "32:                     <li>",
          "36:                     </li>",
          "",
          "[Added Lines]",
          "32:                     <!--<li>",
          "36:                     </li>-->",
          "",
          "---------------"
        ],
        "trunk/research/players/whep.html||trunk/research/players/whep.html": [
          "File: trunk/research/players/whep.html -> trunk/research/players/whep.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: <div class=\"navbar navbar-fixed-top\">",
          "21:     <div class=\"navbar-inner\">",
          "22:         <div class=\"container\">",
          "24:             <div class=\"nav-collapse collapse\">",
          "25:                 <ul class=\"nav\">",
          "26:                     <li><a id=\"nav_srs_player\" href=\"srs_player.html\">LivePlayer</a></li>",
          "",
          "[Removed Lines]",
          "23:             <a id=\"srs_index\" class=\"brand\" href=\"https://github.com/ossrs/srs\">SRS</a>",
          "",
          "[Added Lines]",
          "23:             <a class=\"brand\" href=\"https://github.com/ossrs/srs\" target=\"_blank\">SRS</a>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:                     <!--<li><a id=\"nav_srs_bwt\" href=\"srs_bwt.html\">SRS\u6d4b\u7f51\u901f</a></li>-->",
          "35:                     <!--<li><a id=\"nav_vlc\" href=\"vlc.html\">VLC\u64ad\u653e\u5668</a></li>-->",
          "36:                     <!--<li><a id=\"nav_gb28181\" href=\"srs_gb28181.html\">GB28181</a></li>-->",
          "38:                         <a href=\"https://github.com/ossrs/srs\">",
          "39:                             <img alt=\"GitHub Repo stars\" src=\"https://img.shields.io/github/stars/ossrs/srs?style=social\">",
          "40:                         </a>",
          "42:                 </ul>",
          "43:             </div>",
          "44:         </div>",
          "",
          "[Removed Lines]",
          "37:                     <li>",
          "41:                     </li>",
          "",
          "[Added Lines]",
          "37:                     <!--<li>",
          "41:                     </li>-->",
          "",
          "---------------"
        ],
        "trunk/research/players/whip.html||trunk/research/players/whip.html": [
          "File: trunk/research/players/whip.html -> trunk/research/players/whip.html",
          "--- Hunk 1 ---",
          "[Context before]",
          "20: <div class=\"navbar navbar-fixed-top\">",
          "21:     <div class=\"navbar-inner\">",
          "22:         <div class=\"container\">",
          "24:             <div class=\"nav-collapse collapse\">",
          "25:                 <ul class=\"nav\">",
          "26:                     <li><a id=\"nav_srs_player\" href=\"srs_player.html\">LivePlayer</a></li>",
          "",
          "[Removed Lines]",
          "23:             <a id=\"srs_index\" class=\"brand\" href=\"https://github.com/ossrs/srs\">SRS</a>",
          "",
          "[Added Lines]",
          "23:             <a class=\"brand\" href=\"https://github.com/ossrs/srs\" target=\"_blank\">SRS</a>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34:                     <!--<li><a id=\"nav_srs_bwt\" href=\"srs_bwt.html\">SRS\u6d4b\u7f51\u901f</a></li>-->",
          "35:                     <!--<li><a id=\"nav_vlc\" href=\"vlc.html\">VLC\u64ad\u653e\u5668</a></li>-->",
          "36:                     <!--<li><a id=\"nav_gb28181\" href=\"srs_gb28181.html\">GB28181</a></li>-->",
          "38:                         <a href=\"https://github.com/ossrs/srs\">",
          "39:                             <img alt=\"GitHub Repo stars\" src=\"https://img.shields.io/github/stars/ossrs/srs?style=social\">",
          "40:                         </a>",
          "42:                 </ul>",
          "43:             </div>",
          "44:         </div>",
          "",
          "[Removed Lines]",
          "37:                     <li>",
          "41:                     </li>",
          "",
          "[Added Lines]",
          "37:                     <!--<li>",
          "41:                     </li>-->",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_rtc_codec.cpp||trunk/src/app/srs_app_rtc_codec.cpp": [
          "File: trunk/src/app/srs_app_rtc_codec.cpp -> trunk/src/app/srs_app_rtc_codec.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "260:     if (!enc_frame_) {",
          "261:         return srs_error_new(ERROR_RTC_RTP_MUXER, \"Could not allocate audio encode in frame\");",
          "262:     }",
          "264:     enc_packet_ = av_packet_alloc();",
          "265:     if (!enc_packet_) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "263:     enc_frame_->format = enc_->sample_fmt;",
          "264:     enc_frame_->nb_samples = enc_->frame_size;",
          "265:     enc_frame_->channel_layout = enc_->channel_layout;",
          "267:     if (av_frame_get_buffer(enc_frame_, 0) < 0) {",
          "268:         return srs_error_new(ERROR_RTC_RTP_MUXER, \"Could not get audio frame buffer\");",
          "269:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "381:     }",
          "383:     while (av_audio_fifo_size(fifo_) >= enc_->frame_size) {",
          "391:         }",
          "395:         if (av_audio_fifo_read(fifo_, (void **)enc_frame_->data, enc_->frame_size) < enc_->frame_size) {",
          "397:             return srs_error_new(ERROR_RTC_RTP_MUXER, \"Could not read data from FIFO\");",
          "398:         }",
          "400:         enc_frame_->pts = next_out_pts_;",
          "401:         next_out_pts_ += enc_->frame_size;",
          "402:         int error = avcodec_send_frame(enc_, enc_frame_);",
          "404:         if (error < 0) {",
          "405:             return srs_error_new(ERROR_RTC_RTP_MUXER, \"Error sending the frame to the encoder(%d,%s)\", error,",
          "406:                 av_make_error_string(err_buf, AV_ERROR_MAX_STRING_SIZE, error));",
          "",
          "[Removed Lines]",
          "384:         enc_frame_->format = enc_->sample_fmt;",
          "385:         enc_frame_->nb_samples = enc_->frame_size;",
          "386:         enc_frame_->channel_layout = enc_->channel_layout;",
          "388:         if (av_frame_get_buffer(enc_frame_, 0) < 0) {",
          "389:             av_frame_free(&enc_frame_);",
          "390:             return srs_error_new(ERROR_RTC_RTP_MUXER, \"Could not get audio frame buffer\");",
          "396:             av_frame_free(&enc_frame_);",
          "403:         av_frame_unref(enc_frame_);",
          "",
          "[Added Lines]",
          "392:         if (av_frame_make_writable(enc_frame_) < 0) {",
          "393:             return srs_error_new(ERROR_RTC_RTP_MUXER, \"Could not make writable frame\");",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    196",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    197",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    96",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    97",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1656391c6792baa98e2cd005d1338a0981fc75ed",
      "candidate_info": {
        "commit_hash": "1656391c6792baa98e2cd005d1338a0981fc75ed",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/1656391c6792baa98e2cd005d1338a0981fc75ed",
        "files": [
          "trunk/conf/full.conf",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/app/srs_app_config.cpp",
          "trunk/src/app/srs_app_config.hpp",
          "trunk/src/app/srs_app_rtc_source.cpp",
          "trunk/src/app/srs_app_rtc_source.hpp",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp",
          "trunk/src/kernel/srs_kernel_codec.cpp",
          "trunk/src/kernel/srs_kernel_codec.hpp",
          "trunk/src/kernel/srs_kernel_error.hpp",
          "trunk/src/utest/srs_utest_config.cpp"
        ],
        "message": "RTC: Support dropping h.264 SEI from NALUs. v5.0.213 v6.0.125 (#4057)\n\ntry to fix #4052.\n\n---------\n\nCo-authored-by: winlin <winlinvip@gmail.com>",
        "before_after_code_files": [
          "trunk/conf/full.conf||trunk/conf/full.conf",
          "trunk/src/app/srs_app_config.cpp||trunk/src/app/srs_app_config.cpp",
          "trunk/src/app/srs_app_config.hpp||trunk/src/app/srs_app_config.hpp",
          "trunk/src/app/srs_app_rtc_source.cpp||trunk/src/app/srs_app_rtc_source.cpp",
          "trunk/src/app/srs_app_rtc_source.hpp||trunk/src/app/srs_app_rtc_source.hpp",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp",
          "trunk/src/kernel/srs_kernel_codec.cpp||trunk/src/kernel/srs_kernel_codec.cpp",
          "trunk/src/kernel/srs_kernel_codec.hpp||trunk/src/kernel/srs_kernel_codec.hpp",
          "trunk/src/kernel/srs_kernel_error.hpp||trunk/src/kernel/srs_kernel_error.hpp",
          "trunk/src/utest/srs_utest_config.cpp||trunk/src/utest/srs_utest_config.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/conf/full.conf||trunk/conf/full.conf": [
          "File: trunk/conf/full.conf -> trunk/conf/full.conf",
          "--- Hunk 1 ---",
          "[Context before]",
          "562:         # Overwrite by env SRS_VHOST_RTC_KEEP_BFRAME for all vhosts.",
          "563:         # default: off",
          "564:         keep_bframe off;",
          "565:         # The transcode audio bitrate, for RTMP to RTC.",
          "566:         # Overwrite by env SRS_VHOST_RTC_OPUS_BITRATE for all vhosts.",
          "567:         # [8000, 320000]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "565:         # Whether to keep the h.264 SEI type NALU packet.",
          "566:         # DJI drone M30T will send many SEI type NALU packet, while iOS hardware decoder (Video Toolbox)",
          "567:         # dislike to feed it so many SEI NALU between NonIDR and IDR NALU packets.",
          "568:         # @see https://github.com/ossrs/srs/issues/4052",
          "569:         # Overwrite by env SRS_VHOST_RTC_KEEP_AVC_NALU_SEI for all vhosts.",
          "570:         # Default: on",
          "571:         keep_avc_nalu_sei on;",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_config.cpp||trunk/src/app/srs_app_config.cpp": [
          "File: trunk/src/app/srs_app_config.cpp -> trunk/src/app/srs_app_config.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "2726:                         && m != \"bframe\" && m != \"aac\" && m != \"stun_timeout\" && m != \"stun_strict_check\"",
          "2727:                         && m != \"dtls_role\" && m != \"dtls_version\" && m != \"drop_for_pt\" && m != \"rtc_to_rtmp\"",
          "2728:                         && m != \"pli_for_rtmp\" && m != \"rtmp_to_rtc\" && m != \"keep_bframe\" && m != \"opus_bitrate\"",
          "2730:                         return srs_error_new(ERROR_SYSTEM_CONFIG_INVALID, \"illegal vhost.rtc.%s of %s\", m.c_str(), vhost->arg0().c_str());",
          "2731:                     }",
          "2732:                 }",
          "",
          "[Removed Lines]",
          "2729:                         && m != \"aac_bitrate\") {",
          "",
          "[Added Lines]",
          "2729:                         && m != \"aac_bitrate\" && m != \"keep_avc_nalu_sei\") {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4474:     return SRS_CONF_PERFER_FALSE(conf->arg0());",
          "4475: }",
          "4477: bool SrsConfig::get_rtc_from_rtmp(string vhost)",
          "4478: {",
          "4479:     SRS_OVERWRITE_BY_ENV_BOOL(\"srs.vhost.rtc.rtmp_to_rtc\"); // SRS_VHOST_RTC_RTMP_TO_RTC",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4477: bool SrsConfig::get_rtc_keep_avc_nalu_sei(std::string vhost)",
          "4478: {",
          "4479:     SRS_OVERWRITE_BY_ENV_BOOL2(\"srs.vhost.rtc.keep_avc_nalu_sei\"); // SRS_VHOST_RTC_KEEP_AVC_NALU_SEI",
          "4481:     static bool DEFAULT = true;",
          "4483:     SrsConfDirective* conf = get_rtc(vhost);",
          "4485:     if (!conf) {",
          "4486:         return DEFAULT;",
          "4487:     }",
          "4489:     conf = conf->get(\"keep_avc_nalu_sei\");",
          "4490:     if (!conf || conf->arg0().empty()) {",
          "4491:         return DEFAULT;",
          "4492:     }",
          "4494:     return SRS_CONF_PERFER_TRUE(conf->arg0());",
          "4495: }",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_config.hpp||trunk/src/app/srs_app_config.hpp": [
          "File: trunk/src/app/srs_app_config.hpp -> trunk/src/app/srs_app_config.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     SrsConfDirective* get_rtc(std::string vhost);",
          "534:     bool get_rtc_enabled(std::string vhost);",
          "535:     bool get_rtc_keep_bframe(std::string vhost);",
          "536:     bool get_rtc_from_rtmp(std::string vhost);",
          "537:     srs_utime_t get_rtc_stun_timeout(std::string vhost);",
          "538:     bool get_rtc_stun_strict_check(std::string vhost);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "536:     bool get_rtc_keep_avc_nalu_sei(std::string vhost);",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_rtc_source.cpp||trunk/src/app/srs_app_rtc_source.cpp": [
          "File: trunk/src/app/srs_app_rtc_source.cpp -> trunk/src/app/srs_app_rtc_source.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "739:     codec_ = new SrsAudioTranscoder();",
          "740:     latest_codec_ = SrsAudioCodecIdForbidden;",
          "741:     keep_bframe = false;",
          "742:     merge_nalus = false;",
          "743:     meta = new SrsMetaCache();",
          "744:     audio_sequence = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "742:     keep_avc_nalu_sei = true;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "771:     format->try_annexb_first = _srs_config->try_annexb_first(r->vhost);",
          "773:     keep_bframe = _srs_config->get_rtc_keep_bframe(req->vhost);",
          "774:     merge_nalus = _srs_config->get_rtc_server_merge_nalus();",
          "777:     return err;",
          "778: }",
          "",
          "[Removed Lines]",
          "775:     srs_trace(\"RTC bridge from RTMP, keep_bframe=%d, merge_nalus=%d\", keep_bframe, merge_nalus);",
          "",
          "[Added Lines]",
          "775:     keep_avc_nalu_sei = _srs_config->get_rtc_keep_avc_nalu_sei(req->vhost);",
          "777:     srs_trace(\"RTC bridge from RTMP, keep_bframe=%d, keep_avc_nalu_sei=%d, merge_nalus=%d\",",
          "778:         keep_bframe, keep_avc_nalu_sei, merge_nalus);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1013:         for (int i = 0; i < nn_samples; i++) {",
          "1014:             SrsSample* sample = samples[i];",
          "1022:             if (sample->size <= kRtpMaxPayloadSize) {",
          "1023:                 if ((err = package_single_nalu(msg, sample, pkts)) != srs_success) {",
          "1024:                     return srs_error_wrap(err, \"package single nalu\");",
          "",
          "[Removed Lines]",
          "1018:             if (sample->bframe) {",
          "1019:                 continue;",
          "1020:             }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1051:     for (int i = 0; i < format->video->nb_samples; ++i) {",
          "1052:         SrsSample* sample = &format->video->samples[i];",
          "1058:                 return srs_error_wrap(err, \"parse bframe\");",
          "1059:             }",
          "1061:                 continue;",
          "1062:             }",
          "1063:         }",
          "",
          "[Removed Lines]",
          "1056:         if (!keep_bframe) {",
          "1057:             if ((err = sample->parse_bframe()) != srs_success) {",
          "1060:             if (sample->bframe) {",
          "",
          "[Added Lines]",
          "1051:         if (!keep_avc_nalu_sei && format->vcodec->id == SrsVideoCodecIdAVC) {",
          "1052:             SrsAvcNaluType avc_nalu_type;",
          "1054:             if ((err = SrsVideoFrame::parse_avc_nalu_type(sample, avc_nalu_type)) != srs_success) {",
          "1055:                 return srs_error_wrap(err, \"parse avc nalu_type\");",
          "1056:             }",
          "1057:             if (avc_nalu_type == SrsAvcNaluTypeSEI) {",
          "1059:                 continue;",
          "1060:             }",
          "1061:         }",
          "1065:         if (!keep_bframe && format->vcodec->id == SrsVideoCodecIdAVC) {",
          "1066:             bool is_b_frame;",
          "1067:             if ((err = SrsVideoFrame::parse_avc_b_frame(sample, is_b_frame)) != srs_success) {",
          "1070:             if (is_b_frame) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1137:     for (int i = 0; i < (int)samples.size(); i++) {",
          "1138:         SrsSample* sample = samples[i];",
          "1146:         if (!sample->size) {",
          "1147:             continue;",
          "1148:         }",
          "",
          "[Removed Lines]",
          "1142:         if (sample->bframe) {",
          "1143:             continue;",
          "1144:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_rtc_source.hpp||trunk/src/app/srs_app_rtc_source.hpp": [
          "File: trunk/src/app/srs_app_rtc_source.hpp -> trunk/src/app/srs_app_rtc_source.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "262:     SrsAudioCodecId latest_codec_;",
          "263:     SrsAudioTranscoder* codec_;",
          "264:     bool keep_bframe;",
          "265:     bool merge_nalus;",
          "266:     uint16_t audio_sequence;",
          "267:     uint16_t video_sequence;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "265:     bool keep_avc_nalu_sei;",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    212",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    213",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    124",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    125",
          "",
          "---------------"
        ],
        "trunk/src/kernel/srs_kernel_codec.cpp||trunk/src/kernel/srs_kernel_codec.cpp": [
          "File: trunk/src/kernel/srs_kernel_codec.cpp -> trunk/src/kernel/srs_kernel_codec.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "504: {",
          "505:     size = 0;",
          "506:     bytes = NULL;",
          "508: }",
          "510: SrsSample::SrsSample(char* b, int s)",
          "511: {",
          "512:     size = s;",
          "513:     bytes = b;",
          "515: }",
          "517: SrsSample::~SrsSample()",
          "518: {",
          "519: }",
          "558: SrsSample* SrsSample::copy()",
          "559: {",
          "560:     SrsSample* p = new SrsSample();",
          "561:     p->bytes = bytes;",
          "562:     p->size = size;",
          "564:     return p;",
          "565: }",
          "",
          "[Removed Lines]",
          "507:     bframe = false;",
          "514:     bframe = false;",
          "521: srs_error_t SrsSample::parse_bframe()",
          "522: {",
          "523:     srs_error_t err = srs_success;",
          "525:     uint8_t header = bytes[0];",
          "526:     SrsAvcNaluType nal_type = (SrsAvcNaluType)(header & kNalTypeMask);",
          "528:     if (nal_type != SrsAvcNaluTypeNonIDR && nal_type != SrsAvcNaluTypeDataPartitionA && nal_type != SrsAvcNaluTypeIDR) {",
          "529:         return err;",
          "530:     }",
          "532:     SrsBuffer* stream = new SrsBuffer(bytes, size);",
          "533:     SrsAutoFree(SrsBuffer, stream);",
          "536:     stream->skip(1);",
          "538:     SrsBitBuffer bitstream(stream);",
          "539:     int32_t first_mb_in_slice = 0;",
          "540:     if ((err = srs_avc_nalu_read_uev(&bitstream, first_mb_in_slice)) != srs_success) {",
          "541:         return srs_error_wrap(err, \"nalu read uev\");",
          "542:     }",
          "544:     int32_t slice_type_v = 0;",
          "545:     if ((err = srs_avc_nalu_read_uev(&bitstream, slice_type_v)) != srs_success) {",
          "546:         return srs_error_wrap(err, \"nalu read uev\");",
          "547:     }",
          "548:     SrsAvcSliceType slice_type = (SrsAvcSliceType)slice_type_v;",
          "550:     if (slice_type == SrsAvcSliceTypeB || slice_type == SrsAvcSliceTypeB1) {",
          "551:         bframe = true;",
          "552:         srs_verbose(\"nal_type=%d, slice type=%d\", nal_type, slice_type);",
          "553:     }",
          "555:     return err;",
          "556: }",
          "563:     p->bframe = bframe;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "655:     SrsSample* sample = &samples[nb_samples++];",
          "656:     sample->bytes = bytes;",
          "657:     sample->size = size;",
          "660:     return err;",
          "661: }",
          "",
          "[Removed Lines]",
          "658:     sample->bframe = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "739:     return (SrsVideoCodecConfig*)codec;",
          "740: }",
          "742: SrsFormat::SrsFormat()",
          "743: {",
          "744:     acodec = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "701: srs_error_t SrsVideoFrame::parse_avc_nalu_type(const SrsSample* sample, SrsAvcNaluType& avc_nalu_type)",
          "702: {",
          "703:     srs_error_t err = srs_success;",
          "705:     if (sample == NULL || sample->size < 1) {",
          "706:         return srs_error_new(ERROR_AVC_NALU_EMPTY, \"empty nalu\");",
          "707:     }",
          "709:     uint8_t header = sample->bytes[0];",
          "710:     avc_nalu_type = (SrsAvcNaluType)(header & kNalTypeMask);",
          "712:     return err;",
          "713: }",
          "715: srs_error_t SrsVideoFrame::parse_avc_b_frame(const SrsSample* sample, bool& is_b_frame)",
          "716: {",
          "717:     srs_error_t err = srs_success;",
          "719:     if (sample == NULL || sample->size < 1) {",
          "720:         return srs_error_new(ERROR_AVC_NALU_EMPTY, \"empty nalu\");",
          "721:     }",
          "723:     SrsAvcNaluType nalu_type;",
          "724:     if ((err = parse_avc_nalu_type(sample, nalu_type)) != srs_success) {",
          "725:         return srs_error_wrap(err, \"parse avc nalu type error\");",
          "726:     }",
          "728:     if (nalu_type != SrsAvcNaluTypeNonIDR && nalu_type != SrsAvcNaluTypeDataPartitionA && nalu_type != SrsAvcNaluTypeIDR) {",
          "729:         is_b_frame = false;",
          "730:         return err;",
          "731:     }",
          "733:     SrsBuffer* stream = new SrsBuffer(sample->bytes, sample->size);",
          "734:     SrsAutoFree(SrsBuffer, stream);",
          "737:     stream->skip(1);",
          "739:     SrsBitBuffer bitstream(stream);",
          "740:     int32_t first_mb_in_slice = 0;",
          "741:     if ((err = srs_avc_nalu_read_uev(&bitstream, first_mb_in_slice)) != srs_success) {",
          "742:         return srs_error_wrap(err, \"nalu read uev\");",
          "743:     }",
          "745:     int32_t slice_type_v = 0;",
          "746:     if ((err = srs_avc_nalu_read_uev(&bitstream, slice_type_v)) != srs_success) {",
          "747:         return srs_error_wrap(err, \"nalu read uev\");",
          "748:     }",
          "749:     SrsAvcSliceType slice_type = (SrsAvcSliceType)slice_type_v;",
          "751:     is_b_frame = slice_type == SrsAvcSliceTypeB || slice_type == SrsAvcSliceTypeB1;",
          "752:     if (is_b_frame) {",
          "753:         srs_verbose(\"nalu_type=%d, slice type=%d\", nalu_type, slice_type);",
          "754:     }",
          "756:     return err;",
          "757: }",
          "",
          "---------------"
        ],
        "trunk/src/kernel/srs_kernel_codec.hpp||trunk/src/kernel/srs_kernel_codec.hpp": [
          "File: trunk/src/kernel/srs_kernel_codec.hpp -> trunk/src/kernel/srs_kernel_codec.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "1131:     int size;",
          "1133:     char* bytes;",
          "1136: public:",
          "1137:     SrsSample();",
          "1138:     SrsSample(char* b, int s);",
          "1139:     ~SrsSample();",
          "1140: public:",
          "1144:     SrsSample* copy();",
          "1145: };",
          "",
          "[Removed Lines]",
          "1135:     bool bframe;",
          "1142:     srs_error_t parse_bframe();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1322:     virtual srs_error_t add_sample(char* bytes, int size);",
          "1323: public:",
          "1324:     virtual SrsVideoCodecConfig* vcodec();",
          "1325: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1321: public:",
          "1322:     static srs_error_t parse_avc_nalu_type(const SrsSample* sample, SrsAvcNaluType& avc_nalu_type);",
          "1323:     static srs_error_t parse_avc_b_frame(const SrsSample* sample, bool& is_b_frame);",
          "",
          "---------------"
        ],
        "trunk/src/kernel/srs_kernel_error.hpp||trunk/src/kernel/srs_kernel_error.hpp": [
          "File: trunk/src/kernel/srs_kernel_error.hpp -> trunk/src/kernel/srs_kernel_error.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "276:     XX(ERROR_HEVC_DISABLED                 , 3098, \"HevcDisabled\", \"HEVC is disabled\") \\",
          "277:     XX(ERROR_HEVC_DECODE_ERROR             , 3099, \"HevcDecode\", \"HEVC decode av stream failed\")  \\",
          "278:     XX(ERROR_MP4_HVCC_CHANGE               , 3100, \"Mp4HvcCChange\", \"MP4 does not support video HvcC change\") \\",
          "",
          "[Removed Lines]",
          "279:     XX(ERROR_HEVC_API_NO_PREFIXED          , 3101, \"HevcAnnexbPrefix\", \"No annexb prefix for HEVC decoder\")",
          "",
          "[Added Lines]",
          "279:     XX(ERROR_HEVC_API_NO_PREFIXED          , 3101, \"HevcAnnexbPrefix\", \"No annexb prefix for HEVC decoder\") \\",
          "280:     XX(ERROR_AVC_NALU_EMPTY                , 3102, \"AvcNaluEmpty\", \"AVC NALU is empty\")",
          "",
          "---------------"
        ],
        "trunk/src/utest/srs_utest_config.cpp||trunk/src/utest/srs_utest_config.cpp": [
          "File: trunk/src/utest/srs_utest_config.cpp -> trunk/src/utest/srs_utest_config.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "4406:         SrsSetEnvConfig(rtc_keep_bframe, \"SRS_VHOST_RTC_KEEP_BFRAME\", \"on\");",
          "4407:         EXPECT_TRUE(conf.get_rtc_keep_bframe(\"__defaultVhost__\"));",
          "4408:     }",
          "4410:     if (true) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4409:         {",
          "4411:             SrsSetEnvConfig(rtc_keep_bframe, \"SRS_VHOST_RTC_KEEP_BFRAME\", \"onn\");",
          "4412:             EXPECT_FALSE(conf.get_rtc_keep_bframe(\"__defaultVhost__\"));",
          "4414:         }",
          "4416:         {",
          "4417:             SrsSetEnvConfig(rtc_keep_avc_nalu_sei, \"SRS_VHOST_RTC_KEEP_AVC_NALU_SEI\", \"off\");",
          "4418:             EXPECT_FALSE(conf.get_rtc_keep_avc_nalu_sei(\"__defaultVhost__\"));",
          "4419:         }",
          "4421:         {",
          "4422:             SrsSetEnvConfig(rtc_keep_avc_nalu_sei, \"SRS_VHOST_RTC_KEEP_AVC_NALU_SEI\", \"on\");",
          "4423:             EXPECT_TRUE(conf.get_rtc_keep_avc_nalu_sei(\"__defaultVhost__\"));",
          "4424:         }",
          "4426:         {",
          "4428:             SrsSetEnvConfig(rtc_keep_avc_nalu_sei, \"SRS_VHOST_RTC_KEEP_AVC_NALU_SEI\", \"xx\");",
          "4429:             EXPECT_TRUE(conf.get_rtc_keep_avc_nalu_sei(\"__defaultVhost__\"));",
          "4430:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1b34fc4d4e4eab1fa69f5690d3a53fff69667a86",
      "candidate_info": {
        "commit_hash": "1b34fc4d4e4eab1fa69f5690d3a53fff69667a86",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/1b34fc4d4e4eab1fa69f5690d3a53fff69667a86",
        "files": [
          "trunk/auto/options.sh",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "fix 'sed' error in options.sh. v5.0.201 v6.0.103 (#3891)\n\nThe `-` character, when placed in the middle of a regular expression, is\ninterpreted as a range. It must be placed at the beginning or end to be\ninterpreted as a literal character.\n\n---------\n\n`TRANS_BY_GPT4`\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>",
        "before_after_code_files": [
          "trunk/auto/options.sh||trunk/auto/options.sh",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/auto/options.sh||trunk/auto/options.sh": [
          "File: trunk/auto/options.sh -> trunk/auto/options.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "446:     case \"$option\" in",
          "447:         -*=*)",
          "448:             value=`echo \"$option\" | sed -e 's|[-_a-zA-Z0-9/]*=||'`",
          "450:         ;;",
          "452:     esac",
          "",
          "[Removed Lines]",
          "449:             option=`echo \"$option\" | sed -e 's|=[,-_a-zA-Z0-9/. +]*||'`",
          "",
          "[Added Lines]",
          "449:             option=`echo \"$option\" | sed -e 's|=[-_a-zA-Z0-9/. +,]*||'`",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    200",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    201",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    102",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    103",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0649a6d400a037f08dfab3f7c305cd1cf2cb12c3",
      "candidate_info": {
        "commit_hash": "0649a6d400a037f08dfab3f7c305cd1cf2cb12c3",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/0649a6d400a037f08dfab3f7c305cd1cf2cb12c3",
        "files": [
          "trunk/doc/CHANGELOG.md",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp",
          "trunk/src/protocol/srs_protocol_rtmp_handshake.cpp"
        ],
        "message": "Fix bug for upgrading to OpenSSL 3.0. v5.0.189 v6.0.89 (#3827)\n\nThe fix is for the DH_set_length error. As shown in lines 2-5, OpenSSL\n3.0 added a check for length, which allowed this issue to be exposed.\n```\n1 if (dh->params.q == NULL) {\n2       /* secret exponent length, must satisfy 2^(l-1) <= p */\n3        if (dh->length != 0\n4            && dh->length >= BN_num_bits(dh->params.p))\n5            goto err;\n6        l = dh->length ? dh->length : BN_num_bits(dh->params.p) - 1;\n7        if (!BN_priv_rand_ex(priv_key, l, BN_RAND_TOP_ONE,\n8                             BN_RAND_BOTTOM_ANY, 0, ctx))\n9            goto err;\n        ... ...\n    }\n```\n\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>",
        "before_after_code_files": [
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp",
          "trunk/src/protocol/srs_protocol_rtmp_handshake.cpp||trunk/src/protocol/srs_protocol_rtmp_handshake.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    188",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    189",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    88",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    89",
          "",
          "---------------"
        ],
        "trunk/src/protocol/srs_protocol_rtmp_handshake.cpp||trunk/src/protocol/srs_protocol_rtmp_handshake.cpp": [
          "File: trunk/src/protocol/srs_protocol_rtmp_handshake.cpp -> trunk/src/protocol/srs_protocol_rtmp_handshake.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "327:             return srs_error_new(ERROR_OpenSslSetG, \"set word\");",
          "328:         }",
          "335:         if (!DH_generate_key(pdh)) {",
          "336:             return srs_error_new(ERROR_OpenSslGenerateDHKeys, \"dh generate key\");",
          "",
          "[Removed Lines]",
          "331:         DH_set_length(pdh, bits_count);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}