{
  "cve_id": "CVE-2024-31951",
  "cve_desc": "In the Opaque LSA Extended Link parser in FRRouting (FRR) through 9.1, there can be a buffer overflow and daemon crash in ospf_te_parse_ext_link for OSPF LSA packets during an attempt to read Segment Routing Adjacency SID subTLVs (lengths are not validated).",
  "repo": "FRRouting/frr",
  "patch_hash": "344fb4be2bc27316c74b17003c05ea40be395836",
  "patch_info": {
    "commit_hash": "344fb4be2bc27316c74b17003c05ea40be395836",
    "repo": "FRRouting/frr",
    "commit_url": "https://github.com/FRRouting/frr/commit/344fb4be2bc27316c74b17003c05ea40be395836",
    "files": [
      "ospfd/ospf_te.c"
    ],
    "message": "ospfd: Correct Opaque LSA Extended Link parser\n\nIggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF\nLSA packets. The crash occurs in ospf_te_parse_ext_link() function when\nattemping to read Segment Routing Adjacency SID subTLVs. The original code\ndoesn't check if the size of the Extended Link TLVs and subTLVs have the correct\nlength. In presence of erronous LSA, this will cause a buffer overflow and ospfd\ncrashes.\n\nThis patch introduces new verification of the subTLVs size for Extended Link\nTLVs and subTLVs.\n\nCo-authored-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Olivier Dugeon <olivier.dugeon@orange.com>",
    "before_after_code_files": [
      "ospfd/ospf_te.c||ospfd/ospf_te.c"
    ]
  },
  "patch_diff": {
    "ospfd/ospf_te.c||ospfd/ospf_te.c": [
      "File: ospfd/ospf_te.c -> ospfd/ospf_te.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2755:  len = TLV_BODY_SIZE(&ext->header) - EXT_TLV_LINK_SIZE;",
      "2756:  tlvh = (struct tlv_header *)((char *)(ext) + TLV_HDR_SIZE",
      "2757:          + EXT_TLV_LINK_SIZE);",
      "2758:  for (; sum < len; tlvh = TLV_HDR_NEXT(tlvh)) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2756:  i = lsa->size - (OSPF_LSA_HEADER_SIZE + TLV_HDR_SIZE);",
      "2757:  if (len != i || len <= 0) {",
      "2758:   ote_debug(\"  |- Wrong TLV size: %u instead of %u\",",
      "2759:    (uint32_t )len, (uint32_t )i);",
      "2760:   return -1;",
      "2761:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2763:   switch (ntohs(tlvh->type)) {",
      "2764:   case EXT_SUBTLV_ADJ_SID:",
      "2765:    adj = (struct ext_subtlv_adj_sid *)tlvh;",
      "2766:    label = CHECK_FLAG(adj->flags,",
      "2767:         EXT_SUBTLV_LINK_ADJ_SID_VFLG)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2772:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_ADJ_SID_SIZE)",
      "2773:     break;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2789:    break;",
      "2790:   case EXT_SUBTLV_LAN_ADJ_SID:",
      "2791:    ladj = (struct ext_subtlv_lan_adj_sid *)tlvh;",
      "2792:    label = CHECK_FLAG(ladj->flags,",
      "2793:         EXT_SUBTLV_LINK_ADJ_SID_VFLG)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2800:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_LAN_ADJ_SID_SIZE)",
      "2801:     break;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2818:    break;",
      "2819:   case EXT_SUBTLV_RMT_ITF_ADDR:",
      "2820:    rmt = (struct ext_subtlv_rmt_itf_addr *)tlvh;",
      "2821:    if (CHECK_FLAG(atr->flags, LS_ATTR_NEIGH_ADDR)",
      "2822:        && IPV4_ADDR_SAME(&atr->standard.remote,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2831:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_RMT_ITF_ADDR_SIZE)",
      "2832:     break;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "fcb339c4ea3134b977cebc910c45ad5bf0992feb",
      "candidate_info": {
        "commit_hash": "fcb339c4ea3134b977cebc910c45ad5bf0992feb",
        "repo": "FRRouting/frr",
        "commit_url": "https://github.com/FRRouting/frr/commit/fcb339c4ea3134b977cebc910c45ad5bf0992feb",
        "files": [
          "ospfd/ospf_te.c"
        ],
        "message": "ospfd: Correct Opaque LSA Extended parser\n\nIggy Frankovic discovered another ospfd crash when performing fuzzing of OSPF\nLSA packets. The crash occurs in ospf_te_parse_ext_link() function when\nattemping to read Segment Routing Adjacency SID subTLVs. The original code\ndoesn't check if the size of the Extended Link TLVs and subTLVs have the correct\nlength. In presence of erronous LSA, this will cause a buffer overflow and ospfd\ncrashes.\n\nThis patch introduces new verification of the subTLVs size for Extended Link\nTLVs and subTLVs. Similar check has been also introduced for the Extended\nPrefix TLV.\n\nCo-authored-by: Iggy Frankovic <iggyfran@amazon.com>\nSigned-off-by: Olivier Dugeon <olivier.dugeon@orange.com>\n(cherry picked from commit 5557a289acdaeec8cc63ffc97b5c2abf6dee7b3a)",
        "before_after_code_files": [
          "ospfd/ospf_te.c||ospfd/ospf_te.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ospfd/ospf_te.c||ospfd/ospf_te.c"
          ],
          "candidate": [
            "ospfd/ospf_te.c||ospfd/ospf_te.c"
          ]
        }
      },
      "candidate_diff": {
        "ospfd/ospf_te.c||ospfd/ospf_te.c": [
          "File: ospfd/ospf_te.c -> ospfd/ospf_te.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2620:  struct ext_tlv_prefix *ext;",
          "2621:  struct ext_subtlv_prefix_sid *pref_sid;",
          "2622:  uint32_t label;",
          "2625:  ext = (struct ext_tlv_prefix *)TLV_HDR_TOP(lsa->data);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2623:  uint16_t len, size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2641:  ote_debug(\"  |- Process Extended Prefix LSA %pI4 for subnet %pFX\",",
          "2642:     &lsa->data->id, &pref);",
          "2645:  ls_pref = subnet->ls_pref;",
          "2646:  pref_sid = (struct ext_subtlv_prefix_sid *)((char *)(ext) + TLV_HDR_SIZE",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2649:  len = TLV_BODY_SIZE(&ext->header);",
          "2650:  size = lsa->size - (OSPF_LSA_HEADER_SIZE + TLV_HDR_SIZE);",
          "2651:  if (len != size || len <= 0) {",
          "2652:   ote_debug(\"  |- Wrong TLV size: %u instead of %u\",",
          "2653:      (uint32_t)len, (uint32_t)size);",
          "2654:   return -1;",
          "2655:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2751:  ote_debug(\"  |- Process Extended Link LSA %pI4 for edge %pI4\",",
          "2752:     &lsa->data->id, &edge->attributes->standard.local);",
          "2756:  tlvh = (struct tlv_header *)((char *)(ext) + TLV_HDR_SIZE",
          "2757:          + EXT_TLV_LINK_SIZE);",
          "2758:  for (; sum < len; tlvh = TLV_HDR_NEXT(tlvh)) {",
          "",
          "[Removed Lines]",
          "2755:  len = TLV_BODY_SIZE(&ext->header) - EXT_TLV_LINK_SIZE;",
          "",
          "[Added Lines]",
          "2771:  len = TLV_BODY_SIZE(&ext->header);",
          "2772:  i = lsa->size - (OSPF_LSA_HEADER_SIZE + TLV_HDR_SIZE);",
          "2773:  if (len != i || len <= 0) {",
          "2774:   ote_debug(\"  |- Wrong TLV size: %u instead of %u\",",
          "2775:      (uint32_t)len, (uint32_t)i);",
          "2776:   return -1;",
          "2777:  }",
          "2780:  len -= EXT_TLV_LINK_SIZE;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2763:   switch (ntohs(tlvh->type)) {",
          "2764:   case EXT_SUBTLV_ADJ_SID:",
          "2765:    adj = (struct ext_subtlv_adj_sid *)tlvh;",
          "2766:    label = CHECK_FLAG(adj->flags,",
          "2767:         EXT_SUBTLV_LINK_ADJ_SID_VFLG)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2790:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_ADJ_SID_SIZE)",
          "2791:     break;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2789:    break;",
          "2790:   case EXT_SUBTLV_LAN_ADJ_SID:",
          "2791:    ladj = (struct ext_subtlv_lan_adj_sid *)tlvh;",
          "2792:    label = CHECK_FLAG(ladj->flags,",
          "2793:         EXT_SUBTLV_LINK_ADJ_SID_VFLG)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2818:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_LAN_ADJ_SID_SIZE)",
          "2819:     break;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2818:    break;",
          "2819:   case EXT_SUBTLV_RMT_ITF_ADDR:",
          "2820:    rmt = (struct ext_subtlv_rmt_itf_addr *)tlvh;",
          "2821:    if (CHECK_FLAG(atr->flags, LS_ATTR_NEIGH_ADDR)",
          "2822:        && IPV4_ADDR_SAME(&atr->standard.remote,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2849:    if (TLV_BODY_SIZE(tlvh) != EXT_SUBTLV_RMT_ITF_ADDR_SIZE)",
          "2850:     break;",
          "",
          "---------------"
        ]
      }
    }
  ]
}