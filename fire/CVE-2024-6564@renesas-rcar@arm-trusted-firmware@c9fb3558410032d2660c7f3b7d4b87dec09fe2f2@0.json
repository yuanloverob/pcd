{
  "cve_id": "CVE-2024-6564",
  "cve_desc": "Buffer overflow in \"rcar_dev_init\"  due to using due to using untrusted data (rcar_image_number) as a loop counter before verifying it against RCAR_MAX_BL3X_IMAGE. This could lead to a full bypass of secure boot.",
  "repo": "renesas-rcar/arm-trusted-firmware",
  "patch_hash": "c9fb3558410032d2660c7f3b7d4b87dec09fe2f2",
  "patch_info": {
    "commit_hash": "c9fb3558410032d2660c7f3b7d4b87dec09fe2f2",
    "repo": "renesas-rcar/arm-trusted-firmware",
    "commit_url": "https://github.com/renesas-rcar/arm-trusted-firmware/commit/c9fb3558410032d2660c7f3b7d4b87dec09fe2f2",
    "files": [
      "drivers/renesas/common/io/io_rcar.c"
    ],
    "message": "rcar-gen3: plat: BL2: Fix to check \"rcar_image_number\" variable before use\n\nReviewed-by: Tomer Fichman <Tomer.Fichman@cymotive.com>\nSigned-off-by: Yoshifumi Hosoya <yoshifumi.hosoya.wj@renesas.com>",
    "before_after_code_files": [
      "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
    ]
  },
  "patch_diff": {
    "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c": [
      "File: drivers/renesas/common/io/io_rcar.c -> drivers/renesas/common/io/io_rcar.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "496: #endif",
      "498:  rcar_image_number = header[0];",
      "504:  if (rcar_image_number == 0 || rcar_image_number > RCAR_MAX_BL3X_IMAGE) {",
      "505:   WARN(\"Firmware Image Package header check failed.\\n\");",
      "506:   rc = IO_FAIL;",
      "507:   goto error;",
      "508:  }",
      "510:  rc = io_seek(handle, IO_SEEK_SET, offset + RCAR_SECTOR6_CERT_OFFSET);",
      "511:  if (rc != IO_SUCCESS) {",
      "512:   WARN(\"Firmware Image Package header failed to seek cert\\n\");",
      "",
      "[Removed Lines]",
      "499:  for (i = 0; i < rcar_image_number + 2; i++) {",
      "500:   rcar_image_header[i] = header[i * 2 + 1];",
      "501:   rcar_image_header_prttn[i] = header[i * 2 + 2];",
      "502:  }",
      "",
      "[Added Lines]",
      "505:  for (i = 0; i < rcar_image_number + 2; i++) {",
      "506:   rcar_image_header[i] = header[i * 2 + 1];",
      "507:   rcar_image_header_prttn[i] = header[i * 2 + 2];",
      "508:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b469880e3b6b26849c3d43d3fe88a755a25249bc",
      "candidate_info": {
        "commit_hash": "b469880e3b6b26849c3d43d3fe88a755a25249bc",
        "repo": "renesas-rcar/arm-trusted-firmware",
        "commit_url": "https://github.com/renesas-rcar/arm-trusted-firmware/commit/b469880e3b6b26849c3d43d3fe88a755a25249bc",
        "files": [
          "drivers/renesas/common/io/io_rcar.c"
        ],
        "message": "fix(rcar3-drivers): check \"rcar_image_number\" variable before use\n\nValidate the content of rcar_image_number variable before use.\n\nReviewed-by: Tomer Fichman <Tomer.Fichman@cymotive.com>\nSigned-off-by: Yoshifumi Hosoya <yoshifumi.hosoya.wj@renesas.com>\nChange-Id: Ieeabafa8f709d25eebc4a8e490bf623ef32ccf9f",
        "before_after_code_files": [
          "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
          ],
          "candidate": [
            "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/renesas/common/io/io_rcar.c||drivers/renesas/common/io/io_rcar.c": [
          "File: drivers/renesas/common/io/io_rcar.c -> drivers/renesas/common/io/io_rcar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "451: #endif",
          "453:  rcar_image_number = header[0];",
          "459:  if (rcar_image_number == 0 || rcar_image_number > RCAR_MAX_BL3X_IMAGE) {",
          "460:   WARN(\"Firmware Image Package header check failed.\\n\");",
          "461:   rc = IO_FAIL;",
          "462:   goto error;",
          "463:  }",
          "465:  rc = io_seek(handle, IO_SEEK_SET, offset + RCAR_SECTOR6_CERT_OFFSET);",
          "466:  if (rc != IO_SUCCESS) {",
          "467:   WARN(\"Firmware Image Package header failed to seek cert\\n\");",
          "",
          "[Removed Lines]",
          "454:  for (i = 0; i < rcar_image_number + 2; i++) {",
          "455:   rcar_image_header[i] = header[i * 2 + 1];",
          "456:   rcar_image_header_prttn[i] = header[i * 2 + 2];",
          "457:  }",
          "",
          "[Added Lines]",
          "460:  for (i = 0; i < rcar_image_number + 2; i++) {",
          "461:   rcar_image_header[i] = header[i * 2 + 1];",
          "462:   rcar_image_header_prttn[i] = header[i * 2 + 2];",
          "463:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}