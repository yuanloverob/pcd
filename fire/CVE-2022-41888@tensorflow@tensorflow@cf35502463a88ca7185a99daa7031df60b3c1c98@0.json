{
  "cve_id": "CVE-2022-41888",
  "cve_desc": "TensorFlow is an open source platform for machine learning. When running on GPU, `tf.image.generate_bounding_box_proposals` receives a `scores` input that must be of rank 4 but is not checked. We have patched the issue in GitHub commit cf35502463a88ca7185a99daa7031df60b3c1c98. The fix will be included in TensorFlow 2.11. We will also cherrypick this commit on TensorFlow 2.10.1, 2.9.3, and TensorFlow 2.8.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "cf35502463a88ca7185a99daa7031df60b3c1c98",
  "patch_info": {
    "commit_hash": "cf35502463a88ca7185a99daa7031df60b3c1c98",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/cf35502463a88ca7185a99daa7031df60b3c1c98",
    "files": [
      "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
      "tensorflow/python/kernel_tests/image_ops/BUILD",
      "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
    ],
    "message": "Add rank checks to GenerateBoundingBoxProposals.\n\nPiperOrigin-RevId: 479681553",
    "before_after_code_files": [
      "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
      "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc": [
      "File: tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc -> tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "312:     const auto bbox_deltas = context->input(1);",
      "313:     const auto image_info = context->input(2);",
      "314:     const auto anchors = context->input(3);",
      "315:     const auto num_images = scores.dim_size(0);",
      "316:     const auto num_anchors = scores.dim_size(3);",
      "317:     const auto height = scores.dim_size(1);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "316:     OP_REQUIRES(context, scores.dims() == 4,",
      "317:                 errors::InvalidArgument(\"`scores` must be rank 4 but is rank \",",
      "318:                                         scores.dims()));",
      "319:     OP_REQUIRES(",
      "320:         context, bbox_deltas.dims() == 4,",
      "321:         errors::InvalidArgument(\"`bbox_deltas` must be rank 4 but is rank \",",
      "322:                                 bbox_deltas.dims()));",
      "323:     OP_REQUIRES(",
      "324:         context, image_info.dims() == 2,",
      "325:         errors::InvalidArgument(\"`image_info` must be rank 2 but is rank \",",
      "326:                                 image_info.dims()));",
      "327:     OP_REQUIRES(context, anchors.dims() == 3,",
      "328:                 errors::InvalidArgument(\"`anchors` must be rank 3 but is rank \",",
      "329:                                         anchors.dims()));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py": [
      "File: tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py -> tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "17: import numpy as np",
      "19: from tensorflow.python.framework import dtypes",
      "20: from tensorflow.python.framework import ops",
      "21: from tensorflow.python.ops import array_ops",
      "22: from tensorflow.python.ops import image_ops",
      "23: from tensorflow.python.ops import image_ops_impl",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "19: from tensorflow.python.framework import constant_op",
      "21: from tensorflow.python.framework import errors",
      "23: from tensorflow.python.framework import test_util",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "131:     self._testDrawBoundingBoxColorCycling(",
      "132:         image, dtype=dtypes.half, colors=colors)",
      "135: if __name__ == \"__main__\":",
      "136:   test.main()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "137:   # generate_bound_box_proposals is only available on GPU.",
      "138:   @test_util.run_gpu_only()",
      "139:   def testGenerateBoundingBoxProposals(self):",
      "140:     # Op only exists on GPU.",
      "141:     with self.cached_session(use_gpu=True):",
      "142:       with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
      "143:                                   \"must be rank 4\"):",
      "144:         scores = constant_op.constant(",
      "145:             value=[[[[1.0, 1.0], [1.0, 1.0], [1.0, 1.0], [1.0, 1.0]]]])",
      "146:         self.evaluate(",
      "147:             image_ops.generate_bounding_box_proposals(",
      "148:                 scores=scores,",
      "149:                 bbox_deltas=[],",
      "150:                 image_info=[],",
      "151:                 anchors=[],",
      "152:                 pre_nms_topn=1))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "26cbb6f473f9b4b49ce0dd108f4a63f915a90025",
      "candidate_info": {
        "commit_hash": "26cbb6f473f9b4b49ce0dd108f4a63f915a90025",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/26cbb6f473f9b4b49ce0dd108f4a63f915a90025",
        "files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/BUILD",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ],
        "message": "Add rank checks to GenerateBoundingBoxProposals.\n\nPiperOrigin-RevId: 479681553",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc": [
          "File: tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc -> tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "312:     const auto bbox_deltas = context->input(1);",
          "313:     const auto image_info = context->input(2);",
          "314:     const auto anchors = context->input(3);",
          "315:     const auto num_images = scores.dim_size(0);",
          "316:     const auto num_anchors = scores.dim_size(3);",
          "317:     const auto height = scores.dim_size(1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:     OP_REQUIRES(context, scores.dims() == 4,",
          "317:                 errors::InvalidArgument(\"`scores` must be rank 4 but is rank \",",
          "318:                                         scores.dims()));",
          "319:     OP_REQUIRES(",
          "320:         context, bbox_deltas.dims() == 4,",
          "321:         errors::InvalidArgument(\"`bbox_deltas` must be rank 4 but is rank \",",
          "322:                                 bbox_deltas.dims()));",
          "323:     OP_REQUIRES(",
          "324:         context, image_info.dims() == 2,",
          "325:         errors::InvalidArgument(\"`image_info` must be rank 2 but is rank \",",
          "326:                                 image_info.dims()));",
          "327:     OP_REQUIRES(context, anchors.dims() == 3,",
          "328:                 errors::InvalidArgument(\"`anchors` must be rank 3 but is rank \",",
          "329:                                         anchors.dims()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py": [
          "File: tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py -> tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: import numpy as np",
          "19: from tensorflow.python.framework import dtypes",
          "20: from tensorflow.python.framework import ops",
          "21: from tensorflow.python.ops import array_ops",
          "22: from tensorflow.python.ops import image_ops",
          "23: from tensorflow.python.ops import image_ops_impl",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from tensorflow.python.framework import constant_op",
          "21: from tensorflow.python.framework import errors",
          "23: from tensorflow.python.framework import test_util",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131:     self._testDrawBoundingBoxColorCycling(",
          "132:         image, dtype=dtypes.half, colors=colors)",
          "135: if __name__ == \"__main__\":",
          "136:   test.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "137:   # generate_bound_box_proposals is only available on GPU.",
          "138:   @test_util.run_gpu_only()",
          "139:   def testGenerateBoundingBoxProposals(self):",
          "140:     # Op only exists on GPU.",
          "141:     with self.cached_session(use_gpu=True):",
          "142:       with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
          "143:                                   \"must be rank 4\"):",
          "144:         scores = constant_op.constant(",
          "145:             value=[[[[1.0, 1.0], [1.0, 1.0], [1.0, 1.0], [1.0, 1.0]]]])",
          "146:         self.evaluate(",
          "147:             image_ops.generate_bounding_box_proposals(",
          "148:                 scores=scores,",
          "149:                 bbox_deltas=[],",
          "150:                 image_info=[],",
          "151:                 anchors=[],",
          "152:                 pre_nms_topn=1))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3b211b1762f2a38a1d9d4e3a255fc9c54333649a",
      "candidate_info": {
        "commit_hash": "3b211b1762f2a38a1d9d4e3a255fc9c54333649a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3b211b1762f2a38a1d9d4e3a255fc9c54333649a",
        "files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/BUILD",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ],
        "message": "Add rank checks to GenerateBoundingBoxProposals.\n\nPiperOrigin-RevId: 479681553",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc": [
          "File: tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc -> tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "312:     const auto bbox_deltas = context->input(1);",
          "313:     const auto image_info = context->input(2);",
          "314:     const auto anchors = context->input(3);",
          "315:     const auto num_images = scores.dim_size(0);",
          "316:     const auto num_anchors = scores.dim_size(3);",
          "317:     const auto height = scores.dim_size(1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:     OP_REQUIRES(context, scores.dims() == 4,",
          "317:                 errors::InvalidArgument(\"`scores` must be rank 4 but is rank \",",
          "318:                                         scores.dims()));",
          "319:     OP_REQUIRES(",
          "320:         context, bbox_deltas.dims() == 4,",
          "321:         errors::InvalidArgument(\"`bbox_deltas` must be rank 4 but is rank \",",
          "322:                                 bbox_deltas.dims()));",
          "323:     OP_REQUIRES(",
          "324:         context, image_info.dims() == 2,",
          "325:         errors::InvalidArgument(\"`image_info` must be rank 2 but is rank \",",
          "326:                                 image_info.dims()));",
          "327:     OP_REQUIRES(context, anchors.dims() == 3,",
          "328:                 errors::InvalidArgument(\"`anchors` must be rank 3 but is rank \",",
          "329:                                         anchors.dims()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py": [
          "File: tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py -> tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: import numpy as np",
          "19: from tensorflow.python.framework import dtypes",
          "20: from tensorflow.python.framework import ops",
          "21: from tensorflow.python.ops import array_ops",
          "22: from tensorflow.python.ops import image_ops",
          "23: from tensorflow.python.ops import image_ops_impl",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from tensorflow.python.framework import constant_op",
          "21: from tensorflow.python.framework import errors",
          "23: from tensorflow.python.framework import test_util",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131:     self._testDrawBoundingBoxColorCycling(",
          "132:         image, dtype=dtypes.half, colors=colors)",
          "135: if __name__ == \"__main__\":",
          "136:   test.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "137:   # generate_bound_box_proposals is only available on GPU.",
          "138:   @test_util.run_gpu_only()",
          "139:   def testGenerateBoundingBoxProposals(self):",
          "140:     # Op only exists on GPU.",
          "141:     with self.cached_session(use_gpu=True):",
          "142:       with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
          "143:                                   \"must be rank 4\"):",
          "144:         scores = constant_op.constant(",
          "145:             value=[[[[1.0, 1.0], [1.0, 1.0], [1.0, 1.0], [1.0, 1.0]]]])",
          "146:         self.evaluate(",
          "147:             image_ops.generate_bounding_box_proposals(",
          "148:                 scores=scores,",
          "149:                 bbox_deltas=[],",
          "150:                 image_info=[],",
          "151:                 anchors=[],",
          "152:                 pre_nms_topn=1))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9cf3dbaf3468f37d37ae490ccbbc9eddab65400f",
      "candidate_info": {
        "commit_hash": "9cf3dbaf3468f37d37ae490ccbbc9eddab65400f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/9cf3dbaf3468f37d37ae490ccbbc9eddab65400f",
        "files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/BUILD",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ],
        "message": "Add rank checks to GenerateBoundingBoxProposals.\n\nPiperOrigin-RevId: 479681553",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
            "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc||tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc": [
          "File: tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc -> tensorflow/core/kernels/image/generate_box_proposals_op.cu.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "312:     const auto bbox_deltas = context->input(1);",
          "313:     const auto image_info = context->input(2);",
          "314:     const auto anchors = context->input(3);",
          "315:     const auto num_images = scores.dim_size(0);",
          "316:     const auto num_anchors = scores.dim_size(3);",
          "317:     const auto height = scores.dim_size(1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "316:     OP_REQUIRES(context, scores.dims() == 4,",
          "317:                 errors::InvalidArgument(\"`scores` must be rank 4 but is rank \",",
          "318:                                         scores.dims()));",
          "319:     OP_REQUIRES(",
          "320:         context, bbox_deltas.dims() == 4,",
          "321:         errors::InvalidArgument(\"`bbox_deltas` must be rank 4 but is rank \",",
          "322:                                 bbox_deltas.dims()));",
          "323:     OP_REQUIRES(",
          "324:         context, image_info.dims() == 2,",
          "325:         errors::InvalidArgument(\"`image_info` must be rank 2 but is rank \",",
          "326:                                 image_info.dims()));",
          "327:     OP_REQUIRES(context, anchors.dims() == 3,",
          "328:                 errors::InvalidArgument(\"`anchors` must be rank 3 but is rank \",",
          "329:                                         anchors.dims()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py||tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py": [
          "File: tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py -> tensorflow/python/kernel_tests/image_ops/draw_bounding_box_op_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: import numpy as np",
          "19: from tensorflow.python.framework import dtypes",
          "20: from tensorflow.python.framework import ops",
          "21: from tensorflow.python.ops import array_ops",
          "22: from tensorflow.python.ops import image_ops",
          "23: from tensorflow.python.ops import image_ops_impl",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from tensorflow.python.framework import constant_op",
          "21: from tensorflow.python.framework import errors",
          "23: from tensorflow.python.framework import test_util",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131:     self._testDrawBoundingBoxColorCycling(",
          "132:         image, dtype=dtypes.half, colors=colors)",
          "135: if __name__ == \"__main__\":",
          "136:   test.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "137:   # generate_bound_box_proposals is only available on GPU.",
          "138:   @test_util.run_gpu_only()",
          "139:   def testGenerateBoundingBoxProposals(self):",
          "140:     # Op only exists on GPU.",
          "141:     with self.cached_session(use_gpu=True):",
          "142:       with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
          "143:                                   \"must be rank 4\"):",
          "144:         scores = constant_op.constant(",
          "145:             value=[[[[1.0, 1.0], [1.0, 1.0], [1.0, 1.0], [1.0, 1.0]]]])",
          "146:         self.evaluate(",
          "147:             image_ops.generate_bounding_box_proposals(",
          "148:                 scores=scores,",
          "149:                 bbox_deltas=[],",
          "150:                 image_info=[],",
          "151:                 anchors=[],",
          "152:                 pre_nms_topn=1))",
          "",
          "---------------"
        ]
      }
    }
  ]
}