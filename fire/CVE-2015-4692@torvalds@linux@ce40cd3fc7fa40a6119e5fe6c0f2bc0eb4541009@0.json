{
  "cve_id": "CVE-2015-4692",
  "cve_desc": "The kvm_apic_has_events function in arch/x86/kvm/lapic.h in the Linux kernel through 4.1.3 allows local users to cause a denial of service (NULL pointer dereference and system crash) or possibly have unspecified other impact by leveraging /dev/kvm access for an ioctl call.",
  "repo": "torvalds/linux",
  "patch_hash": "ce40cd3fc7fa40a6119e5fe6c0f2bc0eb4541009",
  "patch_info": {
    "commit_hash": "ce40cd3fc7fa40a6119e5fe6c0f2bc0eb4541009",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/ce40cd3fc7fa40a6119e5fe6c0f2bc0eb4541009",
    "files": [
      "arch/x86/kvm/lapic.h"
    ],
    "message": "kvm: x86: fix kvm_apic_has_events to check for NULL pointer\n\nMalicious (or egregiously buggy) userspace can trigger it, but it\nshould never happen in normal operation.\n\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
    "before_after_code_files": [
      "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h"
    ]
  },
  "patch_diff": {
    "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h": [
      "File: arch/x86/kvm/lapic.h -> arch/x86/kvm/lapic.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "151: static inline bool kvm_apic_has_events(struct kvm_vcpu *vcpu)",
      "152: {",
      "154: }",
      "156: static inline bool kvm_lowest_prio_delivery(struct kvm_lapic_irq *irq)",
      "",
      "[Removed Lines]",
      "153:  return vcpu->arch.apic->pending_events;",
      "",
      "[Added Lines]",
      "153:  return kvm_vcpu_has_lapic(vcpu) && vcpu->arch.apic->pending_events;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bce87cce88c71957c56479809db8316a836ec8b1",
      "candidate_info": {
        "commit_hash": "bce87cce88c71957c56479809db8316a836ec8b1",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/bce87cce88c71957c56479809db8316a836ec8b1",
        "files": [
          "arch/x86/kvm/irq.h",
          "arch/x86/kvm/lapic.c",
          "arch/x86/kvm/lapic.h",
          "arch/x86/kvm/pmu.c",
          "arch/x86/kvm/x86.c"
        ],
        "message": "KVM: x86: consolidate different ways to test for in-kernel LAPIC\n\nDifferent pieces of code checked for vcpu->arch.apic being (non-)NULL,\nor used kvm_vcpu_has_lapic (more optimized) or lapic_in_kernel.\nReplace everything with lapic_in_kernel's name and kvm_vcpu_has_lapic's\nimplementation.\n\nReviewed-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
        "before_after_code_files": [
          "arch/x86/kvm/irq.h||arch/x86/kvm/irq.h",
          "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c",
          "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h",
          "arch/x86/kvm/pmu.c||arch/x86/kvm/pmu.c",
          "arch/x86/kvm/x86.c||arch/x86/kvm/x86.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h"
          ],
          "candidate": [
            "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kvm/irq.h||arch/x86/kvm/irq.h": [
          "File: arch/x86/kvm/irq.h -> arch/x86/kvm/irq.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "109:  return ret;",
          "110: }",
          "120: void kvm_pic_reset(struct kvm_kpic_state *s);",
          "122: void kvm_inject_pending_timer_irqs(struct kvm_vcpu *vcpu);",
          "",
          "[Removed Lines]",
          "112: static inline int lapic_in_kernel(struct kvm_vcpu *vcpu)",
          "113: {",
          "117:  return vcpu->arch.apic != NULL;",
          "118: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c": [
          "File: arch/x86/kvm/lapic.c -> arch/x86/kvm/lapic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "281:  struct kvm_cpuid_entry2 *feat;",
          "282:  u32 v = APIC_VERSION;",
          "285:   return;",
          "287:  feat = kvm_find_cpuid_entry(apic->vcpu, 0x1, 0);",
          "",
          "[Removed Lines]",
          "284:  if (!kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "284:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1319:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "1320:  u64 guest_tsc, tsc_deadline;",
          "1323:   return;",
          "1325:  if (apic->lapic_timer.expired_tscdeadline == 0)",
          "",
          "[Removed Lines]",
          "1322:  if (!kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "1322:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1645: {",
          "1646:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "1649:    apic_lvtt_period(apic))",
          "1650:   return 0;",
          "",
          "[Removed Lines]",
          "1648:  if (!kvm_vcpu_has_lapic(vcpu) || apic_lvtt_oneshot(apic) ||",
          "",
          "[Added Lines]",
          "1648:  if (!lapic_in_kernel(vcpu) || apic_lvtt_oneshot(apic) ||",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1656: {",
          "1657:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "1660:    apic_lvtt_period(apic))",
          "1661:   return;",
          "",
          "[Removed Lines]",
          "1659:  if (!kvm_vcpu_has_lapic(vcpu) || apic_lvtt_oneshot(apic) ||",
          "",
          "[Added Lines]",
          "1659:  if (!lapic_in_kernel(vcpu) || apic_lvtt_oneshot(apic) ||",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2001: {",
          "2002:  struct hrtimer *timer;",
          "2005:   return;",
          "2007:  timer = &vcpu->arch.apic->lapic_timer.timer;",
          "",
          "[Removed Lines]",
          "2004:  if (!kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "2004:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2174: {",
          "2175:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "2178:   return 1;",
          "",
          "[Removed Lines]",
          "2177:  if (!kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "2177:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2188:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "2189:  u32 low, high = 0;",
          "2192:   return 1;",
          "2194:  if (apic_reg_read(apic, reg, 4, &low))",
          "",
          "[Removed Lines]",
          "2191:  if (!kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "2191:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2220:  u8 sipi_vector;",
          "2221:  unsigned long pe;",
          "2224:   return;",
          "",
          "[Removed Lines]",
          "2223:  if (!kvm_vcpu_has_lapic(vcpu) || !apic->pending_events)",
          "",
          "[Added Lines]",
          "2223:  if (!lapic_in_kernel(vcpu) || !apic->pending_events)",
          "",
          "---------------"
        ],
        "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h": [
          "File: arch/x86/kvm/lapic.h -> arch/x86/kvm/lapic.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "104: extern struct static_key kvm_no_apic_vcpu;",
          "107: {",
          "108:  if (static_key_false(&kvm_no_apic_vcpu))",
          "109:   return vcpu->arch.apic;",
          "",
          "[Removed Lines]",
          "106: static inline bool kvm_vcpu_has_lapic(struct kvm_vcpu *vcpu)",
          "",
          "[Added Lines]",
          "106: static inline bool lapic_in_kernel(struct kvm_vcpu *vcpu)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131: static inline bool kvm_apic_present(struct kvm_vcpu *vcpu)",
          "132: {",
          "134: }",
          "136: static inline int kvm_lapic_enabled(struct kvm_vcpu *vcpu)",
          "",
          "[Removed Lines]",
          "133:  return kvm_vcpu_has_lapic(vcpu) && kvm_apic_hw_enabled(vcpu->arch.apic);",
          "",
          "[Added Lines]",
          "133:  return lapic_in_kernel(vcpu) && kvm_apic_hw_enabled(vcpu->arch.apic);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "151: static inline bool kvm_apic_has_events(struct kvm_vcpu *vcpu)",
          "152: {",
          "154: }",
          "156: static inline bool kvm_lowest_prio_delivery(struct kvm_lapic_irq *irq)",
          "",
          "[Removed Lines]",
          "153:  return kvm_vcpu_has_lapic(vcpu) && vcpu->arch.apic->pending_events;",
          "",
          "[Added Lines]",
          "153:  return lapic_in_kernel(vcpu) && vcpu->arch.apic->pending_events;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "162: static inline int kvm_lapic_latched_init(struct kvm_vcpu *vcpu)",
          "163: {",
          "165: }",
          "167: static inline int kvm_apic_id(struct kvm_lapic *apic)",
          "",
          "[Removed Lines]",
          "164:  return kvm_vcpu_has_lapic(vcpu) && test_bit(KVM_APIC_INIT, &vcpu->arch.apic->pending_events);",
          "",
          "[Added Lines]",
          "164:  return lapic_in_kernel(vcpu) && test_bit(KVM_APIC_INIT, &vcpu->arch.apic->pending_events);",
          "",
          "---------------"
        ],
        "arch/x86/kvm/pmu.c||arch/x86/kvm/pmu.c": [
          "File: arch/x86/kvm/pmu.c -> arch/x86/kvm/pmu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "258: void kvm_pmu_deliver_pmi(struct kvm_vcpu *vcpu)",
          "259: {",
          "261:   kvm_apic_local_deliver(vcpu->arch.apic, APIC_LVTPC);",
          "262: }",
          "",
          "[Removed Lines]",
          "260:  if (vcpu->arch.apic)",
          "",
          "[Added Lines]",
          "260:  if (lapic_in_kernel(vcpu))",
          "",
          "---------------"
        ],
        "arch/x86/kvm/x86.c||arch/x86/kvm/x86.c": [
          "File: arch/x86/kvm/x86.c -> arch/x86/kvm/x86.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2984:  kvm_x86_ops->set_nmi_mask(vcpu, events->nmi.masked);",
          "2986:  if (events->flags & KVM_VCPUEVENT_VALID_SIPI_VECTOR &&",
          "2988:   vcpu->arch.apic->sipi_vector = events->sipi_vector;",
          "2990:  if (events->flags & KVM_VCPUEVENT_VALID_SMM) {",
          "",
          "[Removed Lines]",
          "2987:      kvm_vcpu_has_lapic(vcpu))",
          "",
          "[Added Lines]",
          "2987:      lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2997:    vcpu->arch.hflags |= HF_SMM_INSIDE_NMI_MASK;",
          "2998:   else",
          "2999:    vcpu->arch.hflags &= ~HF_SMM_INSIDE_NMI_MASK;",
          "3001:    if (events->smi.latched_init)",
          "3002:     set_bit(KVM_APIC_INIT, &vcpu->arch.apic->pending_events);",
          "3003:    else",
          "",
          "[Removed Lines]",
          "3000:   if (kvm_vcpu_has_lapic(vcpu)) {",
          "",
          "[Added Lines]",
          "3000:   if (lapic_in_kernel(vcpu)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3237:  switch (ioctl) {",
          "3238:  case KVM_GET_LAPIC: {",
          "3239:   r = -EINVAL;",
          "3241:    goto out;",
          "3242:   u.lapic = kzalloc(sizeof(struct kvm_lapic_state), GFP_KERNEL);",
          "",
          "[Removed Lines]",
          "3240:   if (!vcpu->arch.apic)",
          "",
          "[Added Lines]",
          "3240:   if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3255:  }",
          "3256:  case KVM_SET_LAPIC: {",
          "3257:   r = -EINVAL;",
          "3259:    goto out;",
          "3260:   u.lapic = memdup_user(argp, sizeof(*u.lapic));",
          "3261:   if (IS_ERR(u.lapic))",
          "",
          "[Removed Lines]",
          "3258:   if (!vcpu->arch.apic)",
          "",
          "[Added Lines]",
          "3258:   if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "4091:  do {",
          "4092:   n = min(len, 8);",
          "4094:         !kvm_iodevice_write(vcpu, &vcpu->arch.apic->dev, addr, n, v))",
          "4095:       && kvm_io_bus_write(vcpu, KVM_MMIO_BUS, addr, n, v))",
          "4096:    break;",
          "",
          "[Removed Lines]",
          "4093:   if (!(vcpu->arch.apic &&",
          "",
          "[Added Lines]",
          "4093:   if (!(lapic_in_kernel(vcpu) &&",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "4111:  do {",
          "4112:   n = min(len, 8);",
          "4114:         !kvm_iodevice_read(vcpu, &vcpu->arch.apic->dev,",
          "4115:       addr, n, v))",
          "4116:       && kvm_io_bus_read(vcpu, KVM_MMIO_BUS, addr, n, v))",
          "",
          "[Removed Lines]",
          "4113:   if (!(vcpu->arch.apic &&",
          "",
          "[Added Lines]",
          "4113:   if (!(lapic_in_kernel(vcpu) &&",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "6007:  if (!kvm_x86_ops->update_cr8_intercept)",
          "6008:   return;",
          "6011:   return;",
          "6013:  if (vcpu->arch.apicv_active)",
          "",
          "[Removed Lines]",
          "6010:  if (!vcpu->arch.apic)",
          "",
          "[Added Lines]",
          "6010:  if (!lapic_in_kernel(vcpu))",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "7035: int kvm_arch_vcpu_ioctl_set_mpstate(struct kvm_vcpu *vcpu,",
          "7036:         struct kvm_mp_state *mp_state)",
          "7037: {",
          "7039:      mp_state->mp_state != KVM_MP_STATE_RUNNABLE)",
          "7040:   return -EINVAL;",
          "",
          "[Removed Lines]",
          "7038:  if (!kvm_vcpu_has_lapic(vcpu) &&",
          "",
          "[Added Lines]",
          "7038:  if (!lapic_in_kernel(vcpu) &&",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "7590: }",
          "7592: struct static_key kvm_no_apic_vcpu __read_mostly;",
          "7594: int kvm_arch_vcpu_init(struct kvm_vcpu *vcpu)",
          "7595: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7593: EXPORT_SYMBOL_GPL(kvm_no_apic_vcpu);",
          "",
          "---------------"
        ]
      }
    }
  ]
}