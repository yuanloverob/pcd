{
  "cve_id": "CVE-2016-1249",
  "cve_desc": "The DBD::mysql module before 4.039 for Perl, when using server-side prepared statement support, allows attackers to cause a denial of service (out-of-bounds read) via vectors involving an unaligned number of placeholders in WHERE condition and output fields in SELECT expression.",
  "repo": "perl5-dbi/DBD-mysql",
  "patch_hash": "793b72b1a0baa5070adacaac0e12fd995a6fbabe",
  "patch_info": {
    "commit_hash": "793b72b1a0baa5070adacaac0e12fd995a6fbabe",
    "repo": "perl5-dbi/DBD-mysql",
    "commit_url": "https://github.com/perl5-dbi/DBD-mysql/commit/793b72b1a0baa5070adacaac0e12fd995a6fbabe",
    "files": [
      "Changes",
      "dbdimp.c",
      "lib/Bundle/DBD/mysql.pm",
      "lib/DBD/mysql.pm",
      "mysql.xs",
      "t/40server_prepare_crash.t"
    ],
    "message": "Added Pali's fix for CVE-2016-1249",
    "before_after_code_files": [
      "dbdimp.c||dbdimp.c",
      "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm",
      "lib/DBD/mysql.pm||lib/DBD/mysql.pm",
      "mysql.xs||mysql.xs",
      "t/40server_prepare_crash.t||t/40server_prepare_crash.t"
    ]
  },
  "patch_diff": {
    "dbdimp.c||dbdimp.c": [
      "File: dbdimp.c -> dbdimp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2750:   int limit_flag=0;",
      "2751: #endif",
      "2752: #endif",
      "2754:   MYSQL_BIND *bind, *bind_end;",
      "2755:   imp_sth_phb_t *fbind;",
      "2756: #endif",
      "",
      "[Removed Lines]",
      "2753:   int col_type, prepare_retval;",
      "",
      "[Added Lines]",
      "2753:   int prepare_retval;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2947:       if (DBIc_NUM_PARAMS(imp_sth) > 0)",
      "2948:       {",
      "2951:         imp_sth->bind=            alloc_bind(DBIc_NUM_PARAMS(imp_sth));",
      "2952:         imp_sth->fbind=           alloc_fbind(DBIc_NUM_PARAMS(imp_sth));",
      "",
      "[Removed Lines]",
      "2949:         int has_statement_fields= imp_sth->stmt->fields != 0;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2960:              bind < bind_end ;",
      "2961:              bind++, fbind++, i++ )",
      "2962:         {",
      "2977:           bind->buffer=       NULL;",
      "2978:           bind->length=       &(fbind->length);",
      "2979:           bind->is_null=      (char*) &(fbind->is_null);",
      "",
      "[Removed Lines]",
      "2964:             if this statement has a result set, field types will be",
      "2965:             correctly identified. If there is no result set, such as",
      "2966:             with an INSERT, fields will not be defined, and all buffer_type",
      "2967:             will default to MYSQL_TYPE_VAR_STRING",
      "2969:           col_type= (has_statement_fields ?",
      "2970:                      imp_sth->stmt->fields[i].type : MYSQL_TYPE_STRING);",
      "2972:           bind->buffer_type=  mysql_to_perl_type(col_type);",
      "2974:           if (DBIc_TRACE_LEVEL(imp_xxh) >= 2)",
      "2975:             PerlIO_printf(DBIc_LOGPIO(imp_xxh), \"\\t\\tmysql_to_perl_type returned %d\\n\", col_type);",
      "",
      "[Added Lines]",
      "2962:           bind->buffer_type=  MYSQL_TYPE_STRING;",
      "",
      "---------------"
    ],
    "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm": [
      "File: lib/Bundle/DBD/mysql.pm -> lib/Bundle/DBD/mysql.pm",
      "--- Hunk 1 ---",
      "[Context before]",
      "3: use strict;",
      "4: use warnings;",
      "8: 1;",
      "",
      "[Removed Lines]",
      "6: our $VERSION = '4.038_01';",
      "",
      "[Added Lines]",
      "6: our $VERSION = '4.039';",
      "",
      "---------------"
    ],
    "lib/DBD/mysql.pm||lib/DBD/mysql.pm": [
      "File: lib/DBD/mysql.pm -> lib/DBD/mysql.pm",
      "--- Hunk 1 ---",
      "[Context before]",
      "15: # SQL_DRIVER_VER is formatted as dd.dd.dddd",
      "16: # for version 5.x please switch to 5.00(_00) version numbering",
      "17: # keep $VERSION in Bundle/DBD/mysql.pm in sync",
      "20: bootstrap DBD::mysql $VERSION;",
      "",
      "[Removed Lines]",
      "18: our $VERSION = '4.038_01';",
      "",
      "[Added Lines]",
      "18: our $VERSION = '4.039';",
      "",
      "---------------"
    ],
    "mysql.xs||mysql.xs": [
      "File: mysql.xs -> mysql.xs",
      "--- Hunk 1 ---",
      "[Context before]",
      "266:   STRLEN slen;",
      "267:   char            *str_ptr, *buffer;",
      "268:   int             has_binded;",
      "271:   int             buffer_length= slen;",
      "272:   int             buffer_type= 0;",
      "274:   int             use_server_side_prepare= 0;",
      "275:   MYSQL_STMT      *stmt= NULL;",
      "276:   MYSQL_BIND      *bind= NULL;",
      "278: #endif",
      "279:     ASYNC_CHECK_XS(dbh);",
      "280: #if MYSQL_VERSION_ID >= MULTIPLE_RESULT_SET_VERSION",
      "",
      "[Removed Lines]",
      "269:   int             col_type= MYSQL_TYPE_STRING;",
      "270:   int             buffer_is_null= 0;",
      "273:   int             param_type= SQL_VARCHAR;",
      "277:   imp_sth_phb_t   *fbind= NULL;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "368:         int i;",
      "369:         num_params= items - 3;",
      "372:         Newz(0, bind, (unsigned int) num_params, MYSQL_BIND);",
      "375:         for (i = 0; i < num_params; i++)",
      "376:         {",
      "377:           int defined= 0;",
      "381:           {",
      "385:               defined= 1;",
      "386:           }",
      "387:           if (defined)",
      "388:           {",
      "391:             buffer_length= slen;",
      "392:           }",
      "393:           else",
      "394:           {",
      "395:             buffer= NULL;",
      "397:             buffer_length= 0;",
      "498:           }",
      "500:           bind[i].buffer_type = buffer_type;",
      "501:           bind[i].buffer_length= buffer_length;",
      "502:           bind[i].buffer= buffer;",
      "506:         }",
      "507:         has_binded= 0;",
      "508:       }",
      "",
      "[Removed Lines]",
      "371:         Newz(0, params, sizeof(*params)*num_params, struct imp_sth_ph_st);",
      "373:         Newz(0, fbind, (unsigned int) num_params, imp_sth_phb_t);",
      "378:           params[i].value= ST(i+3);",
      "380:           if (params[i].value)",
      "382:             if (SvMAGICAL(params[i].value))",
      "383:               mg_get(params[i].value);",
      "384:             if (SvOK(params[i].value))",
      "389:             buffer= SvPV(params[i].value, slen);",
      "390:             buffer_is_null= 0;",
      "396:             buffer_is_null= 1;",
      "398:           }",
      "401:             if this statement has a result set, field types will be",
      "402:             correctly identified. If there is no result set, such as",
      "403:             with an INSERT, fields will not be defined, and all",
      "404:             buffer_type will default to MYSQL_TYPE_VAR_STRING",
      "406:           col_type= (stmt->fields) ? stmt->fields[i].type : MYSQL_TYPE_STRING;",
      "408:           switch (col_type) {",
      "409: #if MYSQL_VERSION_ID > 50003",
      "410:           case MYSQL_TYPE_NEWDECIMAL:",
      "411: #endif",
      "412:           case MYSQL_TYPE_DECIMAL:",
      "413:             param_type= SQL_DECIMAL;",
      "414:             buffer_type= MYSQL_TYPE_DOUBLE;",
      "415:             break;",
      "417:           case MYSQL_TYPE_DOUBLE:",
      "418:             param_type= SQL_DOUBLE;",
      "419:             buffer_type= MYSQL_TYPE_DOUBLE;",
      "420:             break;",
      "422:           case MYSQL_TYPE_FLOAT:",
      "423:             buffer_type= MYSQL_TYPE_DOUBLE;",
      "424:             param_type= SQL_FLOAT;",
      "425:             break;",
      "427:           case MYSQL_TYPE_SHORT:",
      "428:             buffer_type= MYSQL_TYPE_DOUBLE;",
      "429:             param_type= SQL_FLOAT;",
      "430:             break;",
      "432:           case MYSQL_TYPE_TINY:",
      "433:             buffer_type= MYSQL_TYPE_DOUBLE;",
      "434:             param_type= SQL_FLOAT;",
      "435:             break;",
      "437:           case MYSQL_TYPE_LONG:",
      "438:             buffer_type= MYSQL_TYPE_LONG;",
      "439:             param_type= SQL_BIGINT;",
      "440:             break;",
      "442:           case MYSQL_TYPE_INT24:",
      "443:           case MYSQL_TYPE_YEAR:",
      "444:             buffer_type= MYSQL_TYPE_LONG;",
      "445:             param_type= SQL_INTEGER;",
      "446:             break;",
      "448:           case MYSQL_TYPE_LONGLONG:",
      "449: #if IVSIZE < 8",
      "452:             buffer_type= MYSQL_TYPE_STRING;",
      "453:             param_type= SQL_VARCHAR;",
      "454: #else",
      "455:             buffer_type= MYSQL_TYPE_LONG;",
      "456:             param_type= SQL_BIGINT;",
      "457: #endif",
      "458:             break;",
      "460:           case MYSQL_TYPE_NEWDATE:",
      "461:           case MYSQL_TYPE_DATE:",
      "462:             buffer_type= MYSQL_TYPE_STRING;",
      "463:             param_type= SQL_DATE;",
      "464:             break;",
      "466:           case MYSQL_TYPE_TIME:",
      "467:             buffer_type= MYSQL_TYPE_STRING;",
      "468:             param_type= SQL_TIME;",
      "469:             break;",
      "471:           case MYSQL_TYPE_TIMESTAMP:",
      "472:             buffer_type= MYSQL_TYPE_STRING;",
      "473:             param_type= SQL_TIMESTAMP;",
      "474:             break;",
      "476:           case MYSQL_TYPE_VAR_STRING:",
      "477:           case MYSQL_TYPE_STRING:",
      "478:           case MYSQL_TYPE_DATETIME:",
      "479:             buffer_type= MYSQL_TYPE_STRING;",
      "480:             param_type= SQL_VARCHAR;",
      "481:             break;",
      "483:           case MYSQL_TYPE_BLOB:",
      "484:             buffer_type= MYSQL_TYPE_BLOB;",
      "485:             param_type= SQL_BINARY;",
      "486:             break;",
      "488:           case MYSQL_TYPE_GEOMETRY:",
      "489:             buffer_type= MYSQL_TYPE_BLOB;",
      "490:             param_type= SQL_BINARY;",
      "491:             break;",
      "494:           default:",
      "495:             buffer_type= MYSQL_TYPE_STRING;",
      "496:             param_type= SQL_VARCHAR;",
      "497:             break;",
      "503:           fbind[i].length= buffer_length;",
      "504:           fbind[i].is_null= buffer_is_null;",
      "505:           params[i].type= param_type;",
      "",
      "[Added Lines]",
      "371:           SV *param= ST(i+3);",
      "373:           if (param)",
      "375:             if (SvMAGICAL(param))",
      "376:               mg_get(param);",
      "377:             if (SvOK(param))",
      "382:             buffer= SvPV(param, slen);",
      "384:             buffer_type= MYSQL_TYPE_STRING;",
      "390:             buffer_type= MYSQL_TYPE_NULL;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "514:                                            &has_binded);",
      "515:       if (bind)",
      "516:         Safefree(bind);",
      "520:       if(mysql_stmt_close(stmt))",
      "521:       {",
      "",
      "[Removed Lines]",
      "517:       if (fbind)",
      "518:         Safefree(fbind);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "t/40server_prepare_crash.t||t/40server_prepare_crash.t": [
      "File: t/40server_prepare_crash.t -> t/40server_prepare_crash.t",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: my $dbh = eval { DBI->connect($test_dsn, $test_user, $test_password, { PrintError => 1, RaiseError => 1, AutoCommit => 0, mysql_server_prepare => 1 }) };",
      "11: plan skip_all => \"no database connection\" if $@ or not $dbh;",
      "15: ok $dbh->do(\"CREATE TEMPORARY TABLE t (i INTEGER NOT NULL, n TEXT)\");",
      "",
      "[Removed Lines]",
      "13: plan tests => 13;",
      "",
      "[Added Lines]",
      "13: plan tests => 17;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "30: ok $sth->execute();",
      "31: ok $sth->finish();",
      "33: ok $dbh->disconnect();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "33: ok $sth = $dbh->prepare(\"SELECT 1 FROM t WHERE i = ?\" . (\" OR i = ?\" x 10000));",
      "34: ok $sth->execute((1) x (10001));",
      "35: ok $sth->finish();",
      "37: ok $dbh->do(\"SELECT 1 FROM t WHERE i = ?\" . (\" OR i = ?\" x 10000), {}, (1) x (10001));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ebdd95e4bea5c1de510f145c92be2d917bd263a1",
      "candidate_info": {
        "commit_hash": "ebdd95e4bea5c1de510f145c92be2d917bd263a1",
        "repo": "perl5-dbi/DBD-mysql",
        "commit_url": "https://github.com/perl5-dbi/DBD-mysql/commit/ebdd95e4bea5c1de510f145c92be2d917bd263a1",
        "files": [
          "Changes",
          "lib/Bundle/DBD/mysql.pm",
          "lib/DBD/mysql.pm"
        ],
        "message": "Release engineering for 4.040",
        "before_after_code_files": [
          "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm",
          "lib/DBD/mysql.pm||lib/DBD/mysql.pm"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm",
            "lib/DBD/mysql.pm||lib/DBD/mysql.pm"
          ],
          "candidate": [
            "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm",
            "lib/DBD/mysql.pm||lib/DBD/mysql.pm"
          ]
        }
      },
      "candidate_diff": {
        "lib/Bundle/DBD/mysql.pm||lib/Bundle/DBD/mysql.pm": [
          "File: lib/Bundle/DBD/mysql.pm -> lib/Bundle/DBD/mysql.pm",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: use strict;",
          "4: use warnings;",
          "8: 1;",
          "",
          "[Removed Lines]",
          "6: our $VERSION = '4.039';",
          "",
          "[Added Lines]",
          "6: our $VERSION = '4.040';",
          "",
          "---------------"
        ],
        "lib/DBD/mysql.pm||lib/DBD/mysql.pm": [
          "File: lib/DBD/mysql.pm -> lib/DBD/mysql.pm",
          "--- Hunk 1 ---",
          "[Context before]",
          "15: # SQL_DRIVER_VER is formatted as dd.dd.dddd",
          "16: # for version 5.x please switch to 5.00(_00) version numbering",
          "17: # keep $VERSION in Bundle/DBD/mysql.pm in sync",
          "20: bootstrap DBD::mysql $VERSION;",
          "",
          "[Removed Lines]",
          "18: our $VERSION = '4.039';",
          "",
          "[Added Lines]",
          "18: our $VERSION = '4.040';",
          "",
          "---------------"
        ]
      }
    }
  ]
}