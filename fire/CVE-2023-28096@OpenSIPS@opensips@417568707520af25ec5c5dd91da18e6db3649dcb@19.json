{
  "cve_id": "CVE-2023-28096",
  "cve_desc": "OpenSIPS, a Session Initiation Protocol (SIP) server implementation, has a memory leak starting in the 2.3 branch and priot to versions 3.1.8 and 3.2.5. The memory leak was detected in the function `parse_mi_request` while performing coverage-guided fuzzing. This issue can be reproduced by sending multiple requests of the form `{\"jsonrpc\": \"2.0\",\"method\": \"log_le`. This malformed message was tested against an instance of OpenSIPS via FIFO transport layer and was found to increase the memory consumption over time.\n\nTo abuse this memory leak, attackers need to reach the management interface (MI) which typically should only be exposed on trusted interfaces. In cases where the MI is exposed to the internet without authentication, abuse of this issue will lead to memory exhaustion which may affect the underlying system\u2019s availability. No authentication is typically required to reproduce this issue. On the other hand, memory leaks may occur in other areas of OpenSIPS where the cJSON library is used for parsing JSON objects.\n\nThe issue has been fixed in versions 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
  "patch_info": {
    "commit_hash": "417568707520af25ec5c5dd91da18e6db3649dcb",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/417568707520af25ec5c5dd91da18e6db3649dcb",
    "files": [
      "lib/cJSON.c"
    ],
    "message": "cJSON: fix memory leak on object parsing error\n\nIssue discovered during OpenSIPS Security Audit 2021/2022,\nby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-2mg2-g46r-j4qr",
    "before_after_code_files": [
      "lib/cJSON.c||lib/cJSON.c"
    ]
  },
  "patch_diff": {
    "lib/cJSON.c||lib/cJSON.c": [
      "File: lib/cJSON.c -> lib/cJSON.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1483: fail:",
      "1484:     if (item->child != NULL)",
      "1485:     {",
      "1487:         item->child = NULL;",
      "1488:     }",
      "",
      "[Removed Lines]",
      "1486:         cJSON_Delete(child);",
      "",
      "[Added Lines]",
      "1486:         cJSON_Delete(item->child);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "80179471cb4a4ce11469de2bdb720e6f866f78aa",
      "candidate_info": {
        "commit_hash": "80179471cb4a4ce11469de2bdb720e6f866f78aa",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/80179471cb4a4ce11469de2bdb720e6f866f78aa",
        "files": [
          "modules/tracer/tracer.c"
        ],
        "message": "tracer: fix trace_stop removal from list\n\nFix the way we detect the previous element when removing from list\nBefore this change, if there were multiple elements in the list, they\nwere leaking due to the bad handling of the list removal.\n\n(cherry picked from commit dae9817b313cb98ed3d4d449064c64c9a4ac7cd8)",
        "before_after_code_files": [
          "modules/tracer/tracer.c||modules/tracer/tracer.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/tracer/tracer.c||modules/tracer/tracer.c": [
          "File: modules/tracer/tracer.c -> modules/tracer/tracer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3253:  hash=it->hash;",
          "3257:   if (it->next->hash == hash)",
          "3258:    break;",
          "3259:   else",
          "",
          "[Removed Lines]",
          "3256:  for (prev=NULL, it=(*dyn_trace_list); it && it->next; it = it->next) {",
          "",
          "[Added Lines]",
          "3256:  for (prev=NULL, it=(*dyn_trace_list); it && it->hash != hash && it->next; it = it->next) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "852f9d9d71d92b870072b07d44cf55a258b88f0a",
      "candidate_info": {
        "commit_hash": "852f9d9d71d92b870072b07d44cf55a258b88f0a",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/852f9d9d71d92b870072b07d44cf55a258b88f0a",
        "files": [
          "parser/sdp/sdp_helpr_funcs.c"
        ],
        "message": "Fix crash in parse_sdp for fmtp, rtpmap and hold\n\nWhen invalid strings would have been passed, the remaining value would\nhave resulted in an invalid memory access.\n\nIssue discovered during OpenSIPS Security Audit 2021,\n    by Alfred Farrugia & Sandro Gauci (Enable Security)",
        "before_after_code_files": [
          "parser/sdp/sdp_helpr_funcs.c||parser/sdp/sdp_helpr_funcs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "parser/sdp/sdp_helpr_funcs.c||parser/sdp/sdp_helpr_funcs.c": [
          "File: parser/sdp/sdp_helpr_funcs.c -> parser/sdp/sdp_helpr_funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "57:  char *cp, *cp1;",
          "58:  int len;",
          "60:  if (strncasecmp(body->s, \"a=rtpmap:\", 9) !=0) {",
          "62:   return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "62:  if (body->len < 14)",
          "63:   return -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:  char *cp, *cp1;",
          "125:  int len;",
          "127:  if (strncasecmp(body->s, \"a=fmtp:\", 7) !=0) {",
          "129:   return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "134:  if (body->len < 10)",
          "135:   return -1;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "222: {",
          "223:  char *cp1;",
          "225:  cp1 = body->s;",
          "226:  if ( !( (strncasecmp(cp1, \"a=sendrecv\", 10) == 0) ||",
          "227:   (strncasecmp(cp1, \"a=recvonly\", 10) == 0))) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "235:  if (body->len < 10)",
          "236:   return -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
      "candidate_info": {
        "commit_hash": "c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/c2f62c45d48c8dbe43957970b7ec47dcbda85288",
        "files": [
          "Makefile.defs"
        ],
        "message": "Explicitly add fPIC and DPIC for gcc\n\nThis addresses linking on Fedora 34 and later with gcc 11:\n\n```\ngcc -shared -Wl,-z,relro -Wl,--as-needed  -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld  -Wl,-O2 -Wl,-E   alarm_checks.o hashTable.o interprocess_buffer.o openserMIBNotifications.o openserObjects.o openserSIPCommonObjects.o openserSIPContactTable.o openserSIPMethodSupportedTable.o openserSIPPortTable.o openserSIPRegUserLookupTable.o openserSIPRegUserTable.o openserSIPServerObjects.o openserSIPStatusCodesTable.o snmpstats.o sub_agent.o utilities.o  -L/usr/lib64 -lnetsnmpmibs -lnetsnmpagent -lnetsnmp -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lsensors -ldl -lm -lrpm -lrpmio -Wl,--enable-new-dtags -Wl,-z,relro -Wl,--as-needed -Wl,-z,now -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -lm -lssl -lssl -lcrypto  -o snmpstats.so\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: warning: relocation against `event_shm_threshold' in read-only section `.text'\n/usr/bin/ld: /tmp/cccfDV1K.ltrans0.ltrans.o: relocation R_X86_64_PC32 against undefined symbol `ctime_buf' can not be used when making a shared object; recompile with -fPIC\n/usr/bin/ld: final link failed: bad value\ncollect2: error: ld returned 1 exit status\nmake[1]: Leaving directory '/builddir/build/BUILD/opensips-3.1.7/modules/snmpstats'\nmake[1]: *** [../../Makefile.rules:39: snmpstats.so] Error 1\nmake: *** [Makefile:197: modules] Error 2\n```\n\nCloses #2734.\n\nSigned-off-by: Peter Lemenkov <lemenkov@gmail.com>\n(cherry picked from commit 0896f9a46700005a304a65ddf7e09419a3963b82)",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1340: else",
          "1341:   #gcc and maybe others, => gnu ld",
          "1342:   LDFLAGS+=-Wl,-O2 -Wl,-E $(PROFILE)",
          "1344: endif",
          "1345: endif",
          "1346: ifeq    ($(CC_NAME), clang)",
          "",
          "[Removed Lines]",
          "1343:   MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1343:   MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1372: else",
          "1373:    #gnu or other ld type",
          "1374:    LDFLAGS+=-Wl,-E $(PROFILE)",
          "1376: endif",
          "1377: endif",
          "1378: ifeq ($(CC_NAME), icc)",
          "",
          "[Removed Lines]",
          "1375:    MOD_LDFLAGS=-shared $(LDFLAGS)",
          "",
          "[Added Lines]",
          "1375:    MOD_LDFLAGS=-shared -fPIC -DPIC $(LDFLAGS)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5f99dd82e38bb98662f304a9ebe0e77ebac961d7",
      "candidate_info": {
        "commit_hash": "5f99dd82e38bb98662f304a9ebe0e77ebac961d7",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/5f99dd82e38bb98662f304a9ebe0e77ebac961d7",
        "files": [
          "modules/clusterer/sync.c"
        ],
        "message": "clusterer: properly compute sync fallback interval in all cases\n\nThe timestamp of the sync request was not saved when queueing the sync\nafter certain send errors.\n\n(cherry picked from commit 816ef38b7c97b811a5822ceab9ebbe81609b1b6b)",
        "before_after_code_files": [
          "modules/clusterer/sync.c||modules/clusterer/sync.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/clusterer/sync.c||modules/clusterer/sync.c": [
          "File: modules/clusterer/sync.c -> modules/clusterer/sync.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "158:    lock_get(cluster->lock);",
          "159:    lcap->flags |= CAP_SYNC_PENDING;",
          "160:    lock_release(cluster->lock);",
          "161:   } else if (rc == CLUSTERER_SEND_ERR)",
          "162:    return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "161:    if (cluster->current_node->flags & NODE_IS_SEED)",
          "162:     gettimeofday(&lcap->sync_req_time, NULL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7ed3f00e8b2c8bb9ec6ac5ae91598aa8d0a7792c",
      "candidate_info": {
        "commit_hash": "7ed3f00e8b2c8bb9ec6ac5ae91598aa8d0a7792c",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/7ed3f00e8b2c8bb9ec6ac5ae91598aa8d0a7792c",
        "files": [
          "modules/rtp_relay/rtp_relay_ctx.c"
        ],
        "message": "rtp_relay: reset late flag for new negotiations\n\n(cherry picked from commit 22fe3bef705e3de98b950065bb2a948789c8b3ae)",
        "before_after_code_files": [
          "modules/rtp_relay/rtp_relay_ctx.c||modules/rtp_relay/rtp_relay_ctx.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/5",
          "https://github.com/naveenecosmob/opensips/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/rtp_relay/rtp_relay_ctx.c||modules/rtp_relay/rtp_relay_ctx.c": [
          "File: modules/rtp_relay/rtp_relay_ctx.c -> modules/rtp_relay/rtp_relay_ctx.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "742:   } else {",
          "743:    rtp_sess_set_late(ctx->main);",
          "744:   }",
          "745:  }",
          "746:  RTP_RELAY_CTX_UNLOCK(ctx);",
          "747:  if (!ret)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "745:  } else if (body && msg->REQ_METHOD == METHOD_INVITE) {",
          "746:   rtp_sess_reset_late(ctx->main);",
          "",
          "---------------"
        ]
      }
    }
  ]
}