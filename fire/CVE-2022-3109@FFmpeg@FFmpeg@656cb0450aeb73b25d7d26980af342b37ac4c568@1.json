{
  "cve_id": "CVE-2022-3109",
  "cve_desc": "An issue was discovered in the FFmpeg package, where vp3_decode_frame in libavcodec/vp3.c lacks check of the return value of av_malloc() and will cause a null pointer dereference, impacting availability.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "656cb0450aeb73b25d7d26980af342b37ac4c568",
  "patch_info": {
    "commit_hash": "656cb0450aeb73b25d7d26980af342b37ac4c568",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/656cb0450aeb73b25d7d26980af342b37ac4c568",
    "files": [
      "libavcodec/vp3.c"
    ],
    "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>",
    "before_after_code_files": [
      "libavcodec/vp3.c||libavcodec/vp3.c"
    ]
  },
  "patch_diff": {
    "libavcodec/vp3.c||libavcodec/vp3.c": [
      "File: libavcodec/vp3.c -> libavcodec/vp3.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2679:                                         AV_GET_BUFFER_FLAG_REF)) < 0)",
      "2680:         goto error;",
      "2683:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
      "2685:     if (s->keyframe) {",
      "2686:         if (!s->theora) {",
      "",
      "[Removed Lines]",
      "2682:     if (!s->edge_emu_buffer)",
      "",
      "[Added Lines]",
      "2682:     if (!s->edge_emu_buffer) {",
      "2684:         if (!s->edge_emu_buffer) {",
      "2685:             ret = AVERROR(ENOMEM);",
      "2686:             goto error;",
      "2687:         }",
      "2688:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5cd450dd7ae5f0b25c961fe761f8dbb4c8a7ddae",
      "candidate_info": {
        "commit_hash": "5cd450dd7ae5f0b25c961fe761f8dbb4c8a7ddae",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/5cd450dd7ae5f0b25c961fe761f8dbb4c8a7ddae",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>\n(cherry picked from commit 656cb0450aeb73b25d7d26980af342b37ac4c568)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2099:     if (ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF) < 0)",
          "2100:         goto error;",
          "2103:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2105:     if (s->keyframe) {",
          "2106:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2102:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2102:     if (!s->edge_emu_buffer) {",
          "2104:         if (!s->edge_emu_buffer) {",
          "2105:             ret = AVERROR(ENOMEM);",
          "2106:             goto error;",
          "2107:         }",
          "2108:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7694a44baaaa4786995590a8ba2b16acd8ef8177",
      "candidate_info": {
        "commit_hash": "7694a44baaaa4786995590a8ba2b16acd8ef8177",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/7694a44baaaa4786995590a8ba2b16acd8ef8177",
        "files": [
          "libavcodec/vp3.c"
        ],
        "message": "avcodec/vp3: Add missing check for av_malloc\n\nSince the av_malloc() may fail and return NULL pointer,\nit is needed that the 's->edge_emu_buffer' should be checked\nwhether the new allocation is success.\n\nFixes: d14723861b (\"VP3: fix decoding of videos with stride > 2048\")\nReviewed-by: Peter Ross <pross@xvid.org>\nSigned-off-by: Jiasheng Jiang <jiasheng@iscas.ac.cn>",
        "before_after_code_files": [
          "libavcodec/vp3.c||libavcodec/vp3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ],
          "candidate": [
            "libavcodec/vp3.c||libavcodec/vp3.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vp3.c||libavcodec/vp3.c": [
          "File: libavcodec/vp3.c -> libavcodec/vp3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2733:     if ((ret = ff_thread_get_buffer(avctx, &s->current_frame, AV_GET_BUFFER_FLAG_REF)) < 0)",
          "2734:         goto error;",
          "2737:         s->edge_emu_buffer = av_malloc(9 * FFABS(s->current_frame.f->linesize[0]));",
          "2739:     if (s->keyframe) {",
          "2740:         if (!s->theora) {",
          "",
          "[Removed Lines]",
          "2736:     if (!s->edge_emu_buffer)",
          "",
          "[Added Lines]",
          "2736:     if (!s->edge_emu_buffer) {",
          "2738:         if (!s->edge_emu_buffer) {",
          "2739:             ret = AVERROR(ENOMEM);",
          "2740:             goto error;",
          "2741:         }",
          "2742:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}