{
  "cve_id": "CVE-2013-6412",
  "cve_desc": "The transform_save function in transform.c in Augeas 1.0.0 through 1.1.0 does not properly calculate the permission values when the umask contains a \"7,\" which causes world-writable permissions to be used for new files and allows local users to modify the files via unspecified vectors.",
  "repo": "hercules-team/augeas",
  "patch_hash": "f5b4fc0ceb0e5a2be5f3a19f63ad936897a3ac26",
  "patch_info": {
    "commit_hash": "f5b4fc0ceb0e5a2be5f3a19f63ad936897a3ac26",
    "repo": "hercules-team/augeas",
    "commit_url": "https://github.com/hercules-team/augeas/commit/f5b4fc0c",
    "files": [
      "src/transform.c",
      "tests/test-save.c"
    ],
    "message": "Fix umask handling when creating new files\n\n  * src/transform.c (transform_save): faulty umask arithmetic would cause\n    overly-open file modes when the umask contains \"7\", as the umask was\n    incorrectly subtracted from the target file mode\n\nFixes CVE-2013-6412, RHBZ#1034261",
    "before_after_code_files": [
      "src/transform.c||src/transform.c",
      "tests/test-save.c||tests/test-save.c"
    ]
  },
  "patch_diff": {
    "src/transform.c||src/transform.c": [
      "File: src/transform.c -> src/transform.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1144:         mode_t curumsk = umask(022);",
      "1145:         umask(curumsk);",
      "1148:             err_status = \"create_chmod\";",
      "1149:             return -1;",
      "1150:         }",
      "",
      "[Removed Lines]",
      "1147:         if (fchmod(fileno(fp), 0666 - curumsk) < 0) {",
      "",
      "[Added Lines]",
      "1147:         if (fchmod(fileno(fp), 0666 & ~curumsk) < 0) {",
      "",
      "---------------"
    ],
    "tests/test-save.c||tests/test-save.c": [
      "File: tests/test-save.c -> tests/test-save.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "26: #include \"cutest.h\"",
      "28: #include <stdio.h>",
      "29: #include <sys/types.h>",
      "30: #include <sys/wait.h>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "29: #include <sys/stat.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "51:     if (asprintf(&lensdir, \"%s/lenses\", abs_top_srcdir) < 0)",
      "52:         CuFail(tc, \"asprintf lensdir failed\");",
      "54:     run(tc, \"test -d %s && chmod -R u+w %s || :\", root, root);",
      "55:     run(tc, \"rm -rf %s\", root);",
      "56:     run(tc, \"mkdir -p %s\", root);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "55:     umask(0022);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "221:     CuAssertIntEquals(tc, 1, r);",
      "222: }",
      "224: int main(void) {",
      "225:     char *output = NULL;",
      "226:     CuSuite* suite = CuSuiteNew();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "228: static void testUmask(CuTest *tc, int tumask, mode_t expected_mode) {",
      "229:     int r;",
      "230:     struct stat buf;",
      "231:     char* fpath = NULL;",
      "233:     if (asprintf(&fpath, \"%s/etc/test\", root) < 0) {",
      "234:         CuFail(tc, \"failed to set root\");",
      "235:     }",
      "237:     umask(tumask);",
      "239:     r = aug_rm(aug, \"/augeas/load/*\");",
      "240:     CuAssertPositive(tc, r);",
      "242:     r = aug_set(aug, \"/augeas/load/Test/lens\", \"Simplelines.lns\");",
      "243:     CuAssertRetSuccess(tc, r);",
      "244:     r = aug_set(aug, \"/augeas/load/Test/incl\", \"/etc/test\");",
      "245:     CuAssertRetSuccess(tc, r);",
      "246:     r = aug_load(aug);",
      "247:     CuAssertRetSuccess(tc, r);",
      "248:     r = aug_set(aug, \"/files/etc/test/1\", \"test\");",
      "249:     CuAssertRetSuccess(tc, r);",
      "251:     r = aug_save(aug);",
      "252:     CuAssertRetSuccess(tc, r);",
      "253:     r = aug_match(aug, \"/augeas//error\", NULL);",
      "254:     CuAssertIntEquals(tc, 0, r);",
      "256:     CuAssertIntEquals(tc, 0, stat(fpath, &buf));",
      "257:     CuAssertIntEquals(tc, expected_mode, buf.st_mode & 0777);",
      "258: }",
      "259: static void testUmask077(CuTest *tc) {",
      "260:     testUmask(tc, 0077, 0600);",
      "261: }",
      "262: static void testUmask027(CuTest *tc) {",
      "263:     testUmask(tc, 0027, 0640);",
      "264: }",
      "265: static void testUmask022(CuTest *tc) {",
      "266:     testUmask(tc, 0022, 0644);",
      "267: }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "245:     SUITE_ADD_TEST(suite, testMtime);",
      "246:     SUITE_ADD_TEST(suite, testRelPath);",
      "247:     SUITE_ADD_TEST(suite, testDoubleSlashPath);",
      "249:     CuSuiteRun(suite);",
      "250:     CuSuiteSummary(suite, &output);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "293:     SUITE_ADD_TEST(suite, testUmask077);",
      "294:     SUITE_ADD_TEST(suite, testUmask027);",
      "295:     SUITE_ADD_TEST(suite, testUmask022);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9ebee189d3205dd3a5d229e9f3e42c693eea9fd1",
      "candidate_info": {
        "commit_hash": "9ebee189d3205dd3a5d229e9f3e42c693eea9fd1",
        "repo": "hercules-team/augeas",
        "commit_url": "https://github.com/hercules-team/augeas/commit/9ebee189d3205dd3a5d229e9f3e42c693eea9fd1",
        "files": [
          "src/transform.c",
          "tests/test-save.c"
        ],
        "message": "Fix umask handling when creating new files\n\n  * src/transform.c (transform_save): faulty umask arithmetic would cause\n    overly-open file modes when the umask contains \"7\", as the umask was\n    incorrectly subtracted from the target file mode\n\nFixes CVE-2013-6412, RHBZ#1034261\n\n(cherry picked from commit f5b4fc0ceb0e5a2be5f3a19f63ad936897a3ac26)",
        "before_after_code_files": [
          "src/transform.c||src/transform.c",
          "tests/test-save.c||tests/test-save.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/transform.c||src/transform.c",
            "tests/test-save.c||tests/test-save.c"
          ],
          "candidate": [
            "src/transform.c||src/transform.c",
            "tests/test-save.c||tests/test-save.c"
          ]
        }
      },
      "candidate_diff": {
        "src/transform.c||src/transform.c": [
          "File: src/transform.c -> src/transform.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1144:         mode_t curumsk = umask(022);",
          "1145:         umask(curumsk);",
          "1148:             err_status = \"create_chmod\";",
          "1149:             return -1;",
          "1150:         }",
          "",
          "[Removed Lines]",
          "1147:         if (fchmod(fileno(fp), 0666 - curumsk) < 0) {",
          "",
          "[Added Lines]",
          "1147:         if (fchmod(fileno(fp), 0666 & ~curumsk) < 0) {",
          "",
          "---------------"
        ],
        "tests/test-save.c||tests/test-save.c": [
          "File: tests/test-save.c -> tests/test-save.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"cutest.h\"",
          "28: #include <stdio.h>",
          "29: #include <sys/types.h>",
          "30: #include <sys/wait.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "29: #include <sys/stat.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:     if (asprintf(&lensdir, \"%s/lenses\", abs_top_srcdir) < 0)",
          "52:         CuFail(tc, \"asprintf lensdir failed\");",
          "54:     run(tc, \"test -d %s && chmod -R u+w %s || :\", root, root);",
          "55:     run(tc, \"rm -rf %s\", root);",
          "56:     run(tc, \"mkdir -p %s\", root);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "55:     umask(0022);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "221:     CuAssertIntEquals(tc, 1, r);",
          "222: }",
          "224: int main(void) {",
          "225:     char *output = NULL;",
          "226:     CuSuite* suite = CuSuiteNew();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "228: static void testUmask(CuTest *tc, int tumask, mode_t expected_mode) {",
          "229:     int r;",
          "230:     struct stat buf;",
          "231:     char* fpath = NULL;",
          "233:     if (asprintf(&fpath, \"%s/etc/test\", root) < 0) {",
          "234:         CuFail(tc, \"failed to set root\");",
          "235:     }",
          "237:     umask(tumask);",
          "239:     r = aug_rm(aug, \"/augeas/load/*\");",
          "240:     CuAssertPositive(tc, r);",
          "242:     r = aug_set(aug, \"/augeas/load/Test/lens\", \"Simplelines.lns\");",
          "243:     CuAssertRetSuccess(tc, r);",
          "244:     r = aug_set(aug, \"/augeas/load/Test/incl\", \"/etc/test\");",
          "245:     CuAssertRetSuccess(tc, r);",
          "246:     r = aug_load(aug);",
          "247:     CuAssertRetSuccess(tc, r);",
          "248:     r = aug_set(aug, \"/files/etc/test/1\", \"test\");",
          "249:     CuAssertRetSuccess(tc, r);",
          "251:     r = aug_save(aug);",
          "252:     CuAssertRetSuccess(tc, r);",
          "253:     r = aug_match(aug, \"/augeas//error\", NULL);",
          "254:     CuAssertIntEquals(tc, 0, r);",
          "256:     CuAssertIntEquals(tc, 0, stat(fpath, &buf));",
          "257:     CuAssertIntEquals(tc, expected_mode, buf.st_mode & 0777);",
          "258: }",
          "259: static void testUmask077(CuTest *tc) {",
          "260:     testUmask(tc, 0077, 0600);",
          "261: }",
          "262: static void testUmask027(CuTest *tc) {",
          "263:     testUmask(tc, 0027, 0640);",
          "264: }",
          "265: static void testUmask022(CuTest *tc) {",
          "266:     testUmask(tc, 0022, 0644);",
          "267: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "245:     SUITE_ADD_TEST(suite, testMtime);",
          "246:     SUITE_ADD_TEST(suite, testRelPath);",
          "247:     SUITE_ADD_TEST(suite, testDoubleSlashPath);",
          "249:     CuSuiteRun(suite);",
          "250:     CuSuiteSummary(suite, &output);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "293:     SUITE_ADD_TEST(suite, testUmask077);",
          "294:     SUITE_ADD_TEST(suite, testUmask027);",
          "295:     SUITE_ADD_TEST(suite, testUmask022);",
          "",
          "---------------"
        ]
      }
    }
  ]
}