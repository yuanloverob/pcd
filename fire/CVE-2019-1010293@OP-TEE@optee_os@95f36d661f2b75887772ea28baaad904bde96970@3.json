{
  "cve_id": "CVE-2019-1010293",
  "cve_desc": "Linaro/OP-TEE OP-TEE 3.3.0 and earlier is affected by: Boundary crossing. The impact is: Memory corruption of the TEE itself. The component is: optee_os. The fixed version is: 3.4.0 and later.",
  "repo": "OP-TEE/optee_os",
  "patch_hash": "95f36d661f2b75887772ea28baaad904bde96970",
  "patch_info": {
    "commit_hash": "95f36d661f2b75887772ea28baaad904bde96970",
    "repo": "OP-TEE/optee_os",
    "commit_url": "https://github.com/OP-TEE/optee_os/commit/95f36d661f2b75887772ea28baaad904bde96970",
    "files": [
      "core/arch/arm/mm/tee_mmu.c"
    ],
    "message": "core: tee_mmu_check_access_rights() check all pages\n\nPrior to this patch tee_mmu_check_access_rights() checks an address in\neach page of a supplied range. If both the start and length of that\nrange is unaligned the last page in the range is sometimes not checked.\nWith this patch the first address of each page in the range is checked\nto simplify the logic of checking each page and the range and also to\ncover the last page under all circumstances.\n\nFixes: OP-TEE-2018-0005: \"tee_mmu_check_access_rights does not check\nfinal page of TA buffer\"\n\nSigned-off-by: Jens Wiklander <jens.wiklander@linaro.org>\nTested-by: Joakim Bech <joakim.bech@linaro.org> (QEMU v7, v8)\nReviewed-by: Joakim Bech <joakim.bech@linaro.org>\nReported-by: Riscure <inforequest@riscure.com>\nReported-by: Alyssa Milburn <a.a.milburn@vu.nl>\nAcked-by: Etienne Carriere <etienne.carriere@linaro.org>",
    "before_after_code_files": [
      "core/arch/arm/mm/tee_mmu.c||core/arch/arm/mm/tee_mmu.c"
    ]
  },
  "patch_diff": {
    "core/arch/arm/mm/tee_mmu.c||core/arch/arm/mm/tee_mmu.c": [
      "File: core/arch/arm/mm/tee_mmu.c -> core/arch/arm/mm/tee_mmu.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "757:            size_t len)",
      "758: {",
      "759:  uaddr_t a;",
      "760:  size_t addr_incr = MIN(CORE_MMU_USER_CODE_SIZE,",
      "761:           CORE_MMU_USER_PARAM_SIZE);",
      "764:   return TEE_ERROR_ACCESS_DENIED;",
      "766:  if ((flags & TEE_MEMORY_ACCESS_NONSECURE) &&",
      "",
      "[Removed Lines]",
      "763:  if (ADD_OVERFLOW(uaddr, len, &a))",
      "",
      "[Added Lines]",
      "760:  uaddr_t end_addr = 0;",
      "764:  if (ADD_OVERFLOW(uaddr, len, &end_addr))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "775:     !tee_mmu_is_vbuf_inside_ta_private(utc, (void *)uaddr, len))",
      "776:   return TEE_ERROR_ACCESS_DENIED;",
      "779:   uint32_t attr;",
      "780:   TEE_Result res;",
      "",
      "[Removed Lines]",
      "778:  for (a = uaddr; a < (uaddr + len); a += addr_incr) {",
      "",
      "[Added Lines]",
      "779:  for (a = ROUNDDOWN(uaddr, addr_incr); a < end_addr; a += addr_incr) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "359324a2d577a98b4405c67e140b1cff41b1d7cd",
      "candidate_info": {
        "commit_hash": "359324a2d577a98b4405c67e140b1cff41b1d7cd",
        "repo": "OP-TEE/optee_os",
        "commit_url": "https://github.com/OP-TEE/optee_os/commit/359324a2d577a98b4405c67e140b1cff41b1d7cd",
        "files": [
          "core/tee/tee_svc.c"
        ],
        "message": "svc: Initialize tmp_va_buf to prevent a TOCTOU attack\n\ntmp_va_buf will be used if caller parameters points to private TA\nmemory. However, after doing the syscall to invoke the command it could\nbe that REE has changed caller parameters to point to regular shared\nmemory and that could potentially open for tmp_va_buf leaking old\ninformation on the stack.\n\nMitigate this by simplify tee_svc_update_out_param() by only taking\ntmp_buf_va[n] into account to tell if a temporary buffer is used or not.\n\nNote that tee_svc_copy_to_user() will make sure that only data writeable\nby the user TA can be updated.\n\nFixes: \"Double fetch can be used to copy from uninitialized pointer\" as\nreported by Riscure.\n\nSigned-off-by: Jens Wiklander <jens.wiklander@linaro.org>\nTested-by: Joakim Bech <joakim.bech@linaro.org> (QEMU v7, v8)\nReviewed-by: Joakim Bech <joakim.bech@linaro.org>\nReported-by: Riscure <inforequest@riscure.com>\nReported-by: Alyssa Milburn <a.a.milburn@vu.nl>\nAcked-by: Etienne Carriere <etienne.carriere@linaro.org>",
        "before_after_code_files": [
          "core/tee/tee_svc.c||core/tee/tee_svc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OP-TEE/optee_os/pull/2745"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/tee/tee_svc.c||core/tee/tee_svc.c": [
          "File: core/tee/tee_svc.c -> core/tee/tee_svc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "681: static TEE_Result tee_svc_update_out_param(",
          "684:   struct tee_ta_param *param,",
          "685:   void *tmp_buf_va[TEE_NUM_PARAMS],",
          "686:   struct utee_params *usr_param)",
          "687: {",
          "688:  size_t n;",
          "693:  for (n = 0; n < TEE_NUM_PARAMS; n++) {",
          "694:   switch (TEE_PARAM_TYPE_GET(param->types, n)) {",
          "695:   case TEE_PARAM_TYPE_MEMREF_OUTPUT:",
          "696:   case TEE_PARAM_TYPE_MEMREF_INOUT:",
          "715:     TEE_Result res;",
          "718:        param->u[n].mem.size);",
          "719:     if (res != TEE_SUCCESS)",
          "720:      return res;",
          "",
          "[Removed Lines]",
          "682:   struct tee_ta_session *sess,",
          "683:   struct tee_ta_session *called_sess,",
          "689:  void *p;",
          "690:  struct user_ta_ctx *utc = to_user_ta_ctx(sess->ctx);",
          "691:  bool have_private_mem_map = is_user_ta_ctx(called_sess->ctx);",
          "697:    p = (void *)(uintptr_t)usr_param->vals[n * 2];",
          "700:    if (!tee_mmu_is_vbuf_inside_ta_private(utc, p,",
          "701:      param->u[n].mem.size)) {",
          "702:     usr_param->vals[n * 2 + 1] =",
          "703:      param->u[n].mem.size;",
          "704:     break;",
          "705:    }",
          "711:    if (have_private_mem_map &&",
          "712:        param->u[n].mem.size <=",
          "713:        usr_param->vals[n * 2 + 1]) {",
          "714:     uint8_t *src = tmp_buf_va[n];",
          "717:     res = tee_svc_copy_to_user(p, src,",
          "",
          "[Added Lines]",
          "687:  uint64_t *vals = usr_param->vals;",
          "699:    if (tmp_buf_va[n] &&",
          "700:        param->u[n].mem.size <= vals[n * 2 + 1]) {",
          "701:     void *src = tmp_buf_va[n];",
          "702:     void *dst = (void *)(uintptr_t)vals[n * 2];",
          "705:     res = tee_svc_copy_to_user(dst, src,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "726:   case TEE_PARAM_TYPE_VALUE_OUTPUT:",
          "727:   case TEE_PARAM_TYPE_VALUE_INOUT:",
          "730:    break;",
          "732:   default:",
          "",
          "[Removed Lines]",
          "728:    usr_param->vals[n * 2] = param->u[n].val.a;",
          "729:    usr_param->vals[n * 2 + 1] = param->u[n].val.b;",
          "",
          "[Added Lines]",
          "716:    vals[n * 2] = param->u[n].val.a;",
          "717:    vals[n * 2 + 1] = param->u[n].val.b;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "751:  TEE_UUID *uuid = malloc(sizeof(TEE_UUID));",
          "752:  struct tee_ta_param *param = malloc(sizeof(struct tee_ta_param));",
          "753:  TEE_Identity *clnt_id = malloc(sizeof(TEE_Identity));",
          "755:  struct user_ta_ctx *utc;",
          "757:  if (uuid == NULL || param == NULL || clnt_id == NULL) {",
          "",
          "[Removed Lines]",
          "754:  void *tmp_buf_va[TEE_NUM_PARAMS];",
          "",
          "[Added Lines]",
          "742:  void *tmp_buf_va[TEE_NUM_PARAMS] = { NULL };",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "784:  if (res != TEE_SUCCESS)",
          "785:   goto function_exit;",
          "789: function_exit:",
          "790:  mobj_free(mobj_param);",
          "",
          "[Removed Lines]",
          "787:  res = tee_svc_update_out_param(sess, s, param, tmp_buf_va, usr_param);",
          "",
          "[Added Lines]",
          "775:  res = tee_svc_update_out_param(param, tmp_buf_va, usr_param);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "830:  struct tee_ta_session *sess;",
          "831:  struct tee_ta_session *called_sess;",
          "832:  struct mobj *mobj_param = NULL;",
          "834:  struct user_ta_ctx *utc;",
          "836:  res = tee_ta_get_current_session(&sess);",
          "",
          "[Removed Lines]",
          "833:  void *tmp_buf_va[TEE_NUM_PARAMS];",
          "",
          "[Added Lines]",
          "821:  void *tmp_buf_va[TEE_NUM_PARAMS] = { NULL };",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "855:  res = tee_ta_invoke_command(&ret_o, called_sess, &clnt_id,",
          "856:         cancel_req_to, cmd_id, &param);",
          "860:  if (res2 != TEE_SUCCESS) {",
          "",
          "[Removed Lines]",
          "858:  res2 = tee_svc_update_out_param(sess, called_sess, &param, tmp_buf_va,",
          "859:      usr_param);",
          "",
          "[Added Lines]",
          "846:  res2 = tee_svc_update_out_param(&param, tmp_buf_va, usr_param);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4ca89f5f94e9e21c3b07b93ad1c2fe3831463507",
      "candidate_info": {
        "commit_hash": "4ca89f5f94e9e21c3b07b93ad1c2fe3831463507",
        "repo": "OP-TEE/optee_os",
        "commit_url": "https://github.com/OP-TEE/optee_os/commit/4ca89f5f94e9e21c3b07b93ad1c2fe3831463507",
        "files": [
          "core/arch/arm/kernel/secstor_ta.c"
        ],
        "message": "tadb: set error condition on TA size mismatch\n\nIf tee_tadb_ta_read(..) is successful in secstor_ta_open(..), then we\nmust set an error code manually if the size check right after fails.\n\nFixes: \"Loading from secure storage returns success with uninitialized\npointer\" as reported by Riscure.\n\nSigned-off-by: Joakim Bech <joakim.bech@linaro.org>\nTested-by: Joakim Bech <joakim.bech@linaro.org> (QEMU v7, v8)\nReviewed-by: Jens Wiklander <jens.wiklander@linaro.org>\nReported-by: Riscure <inforequest@riscure.com>\nReported-by: Alyssa Milburn <a.a.milburn@vu.nl>\nAcked-by: Etienne Carriere <etienne.carriere@linaro.org>",
        "before_after_code_files": [
          "core/arch/arm/kernel/secstor_ta.c||core/arch/arm/kernel/secstor_ta.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OP-TEE/optee_os/pull/2745"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/arch/arm/kernel/secstor_ta.c||core/arch/arm/kernel/secstor_ta.c": [
          "File: core/arch/arm/kernel/secstor_ta.c -> core/arch/arm/kernel/secstor_ta.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "25:  res = tee_tadb_ta_read(ta, NULL, &l);",
          "26:  if (res)",
          "27:   goto err;",
          "29:   goto err;",
          "",
          "[Removed Lines]",
          "28:  if (l != prop->custom_size)",
          "",
          "[Added Lines]",
          "28:  if (l != prop->custom_size) {",
          "29:   res = TEE_ERROR_CORRUPT_OBJECT;",
          "31:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a637243270fc1faae16de059091795c32d86e65e",
      "candidate_info": {
        "commit_hash": "a637243270fc1faae16de059091795c32d86e65e",
        "repo": "OP-TEE/optee_os",
        "commit_url": "https://github.com/OP-TEE/optee_os/commit/a637243270fc1faae16de059091795c32d86e65e",
        "files": [
          "core/tee/tee_svc_cryp.c"
        ],
        "message": "svc: check for allocation overflow in crypto calls\n\nWithout checking for overflow there is a risk of allocating a buffer\nwith size smaller than anticipated and as a consequence of that it might\nlead to a heap based overflow with attacker controlled data written\noutside the boundaries of the buffer.\n\nFixes: OP-TEE-2018-0010: \"Integer overflow in crypto system calls (x2)\"\n\nSigned-off-by: Joakim Bech <joakim.bech@linaro.org>\nTested-by: Joakim Bech <joakim.bech@linaro.org> (QEMU v7, v8)\nReviewed-by: Jens Wiklander <jens.wiklander@linaro.org>\nReported-by: Riscure <inforequest@riscure.com>\nReported-by: Alyssa Milburn <a.a.milburn@vu.nl>\nAcked-by: Etienne Carriere <etienne.carriere@linaro.org>",
        "before_after_code_files": [
          "core/tee/tee_svc_cryp.c||core/tee/tee_svc_cryp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OP-TEE/optee_os/pull/2745"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/tee/tee_svc_cryp.c||core/tee/tee_svc_cryp.c": [
          "File: core/tee/tee_svc_cryp.c -> core/tee/tee_svc_cryp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1759:  if (key_size > type_props->max_size)",
          "1760:   return TEE_ERROR_NOT_SUPPORTED;",
          "1763:  if (!params)",
          "1764:   return TEE_ERROR_OUT_OF_MEMORY;",
          "1765:  res = copy_in_attrs(to_user_ta_ctx(sess->ctx), usr_params, param_count,",
          "",
          "[Removed Lines]",
          "1762:  params = malloc(sizeof(TEE_Attribute) * param_count);",
          "",
          "[Added Lines]",
          "1762:  size_t alloc_size = 0;",
          "1764:  if (MUL_OVERFLOW(sizeof(TEE_Attribute), param_count, &alloc_size))",
          "1765:   return TEE_ERROR_OVERFLOW;",
          "1767:  params = malloc(alloc_size);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2668:  if (res != TEE_SUCCESS)",
          "2669:   return res;",
          "2672:  if (!params)",
          "2673:   return TEE_ERROR_OUT_OF_MEMORY;",
          "2674:  res = copy_in_attrs(utc, usr_params, param_count, params);",
          "",
          "[Removed Lines]",
          "2671:  params = malloc(sizeof(TEE_Attribute) * param_count);",
          "",
          "[Added Lines]",
          "2676:  size_t alloc_size = 0;",
          "2678:  if (MUL_OVERFLOW(sizeof(TEE_Attribute), param_count, &alloc_size))",
          "2679:   return TEE_ERROR_OVERFLOW;",
          "2681:  params = malloc(alloc_size);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b60e1cee406a1ff521145ab9534370dfb85dd592",
      "candidate_info": {
        "commit_hash": "b60e1cee406a1ff521145ab9534370dfb85dd592",
        "repo": "OP-TEE/optee_os",
        "commit_url": "https://github.com/OP-TEE/optee_os/commit/b60e1cee406a1ff521145ab9534370dfb85dd592",
        "files": [
          "core/tee/tee_svc_cryp.c"
        ],
        "message": "svc: check for allocation overflow in syscall_cryp_obj_populate\n\nWithout checking for overflow there is a risk of allocating a buffer\nwith size smaller than anticipated and as a consequence of that it might\nlead to a heap based overflow with attacker controlled data written\noutside the boundaries of the buffer.\n\nFixes: OP-TEE-2018-0009: \"Integer overflow in crypto system calls\"\n\nSigned-off-by: Joakim Bech <joakim.bech@linaro.org>\nTested-by: Joakim Bech <joakim.bech@linaro.org> (QEMU v7, v8)\nReviewed-by: Jens Wiklander <jens.wiklander@linaro.org>\nReported-by: Riscure <inforequest@riscure.com>\nReported-by: Alyssa Milburn <a.a.milburn@vu.nl>\nAcked-by: Etienne Carriere <etienne.carriere@linaro.org>",
        "before_after_code_files": [
          "core/tee/tee_svc_cryp.c||core/tee/tee_svc_cryp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OP-TEE/optee_os/pull/2745"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "core/tee/tee_svc_cryp.c||core/tee/tee_svc_cryp.c": [
          "File: core/tee/tee_svc_cryp.c -> core/tee/tee_svc_cryp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: #include <assert.h>",
          "7: #include <crypto/crypto.h>",
          "8: #include <kernel/tee_ta_manager.h>",
          "9: #include <mm/tee_mmu.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: #include <compiler.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1547:  if (!type_props)",
          "1548:   return TEE_ERROR_NOT_IMPLEMENTED;",
          "1551:  if (!attrs)",
          "1552:   return TEE_ERROR_OUT_OF_MEMORY;",
          "1553:  res = copy_in_attrs(to_user_ta_ctx(sess->ctx), usr_attrs, attr_count,",
          "1554:        attrs);",
          "1555:  if (res != TEE_SUCCESS)",
          "",
          "[Removed Lines]",
          "1550:  attrs = malloc(sizeof(TEE_Attribute) * attr_count);",
          "",
          "[Added Lines]",
          "1551:  size_t alloc_size = 0;",
          "1553:  if (MUL_OVERFLOW(sizeof(TEE_Attribute), attr_count, &alloc_size))",
          "1554:   return TEE_ERROR_OVERFLOW;",
          "1556:  attrs = malloc(alloc_size);",
          "",
          "---------------"
        ]
      }
    }
  ]
}