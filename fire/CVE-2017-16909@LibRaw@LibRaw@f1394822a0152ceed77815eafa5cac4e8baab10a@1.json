{
  "cve_id": "CVE-2017-16909",
  "cve_desc": "An error related to the \"LibRaw::panasonic_load_raw()\" function (dcraw_common.cpp) in LibRaw versions prior to 0.18.6 can be exploited to cause a heap-based buffer overflow and subsequently cause a crash via a specially crafted TIFF image.",
  "repo": "LibRaw/LibRaw",
  "patch_hash": "f1394822a0152ceed77815eafa5cac4e8baab10a",
  "patch_info": {
    "commit_hash": "f1394822a0152ceed77815eafa5cac4e8baab10a",
    "repo": "LibRaw/LibRaw",
    "commit_url": "https://github.com/LibRaw/LibRaw/commit/f1394822a0152ceed77815eafa5cac4e8baab10a",
    "files": [
      "dcraw/dcraw.c",
      "internal/dcraw_common.cpp",
      "libraw/libraw_const.h"
    ],
    "message": "SECUNIA advisory 76000 #1 (wrong fuji width set via tiff tag",
    "before_after_code_files": [
      "dcraw/dcraw.c||dcraw/dcraw.c",
      "internal/dcraw_common.cpp||internal/dcraw_common.cpp",
      "libraw/libraw_const.h||libraw/libraw_const.h"
    ]
  },
  "patch_diff": {
    "dcraw/dcraw.c||dcraw/dcraw.c": [
      "File: dcraw/dcraw.c -> dcraw/dcraw.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3172:   int row, col, i, j, sh = 0, pred[2], nonz[2];",
      "3174:   pana_bits(0);",
      "3176:   {",
      "3177: #ifdef LIBRAW_LIBRARY_BUILD",
      "3178:     checkCancel();",
      "",
      "[Removed Lines]",
      "3175:   for (row = 0; row < height; row++)",
      "",
      "[Added Lines]",
      "3175:   for (row = 0; row < raw_height; row++)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3194:       }",
      "3195:       else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
      "3196:         pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
      "3198:         derror();",
      "3199:     }",
      "3200:   }",
      "",
      "[Removed Lines]",
      "3197:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width)",
      "",
      "[Added Lines]",
      "3197:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width && row < height)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "15037:   entries = get4();",
      "15038:   if (entries > 255)",
      "15039:     return;",
      "15040:   while (entries--)",
      "15041:   {",
      "15042:     tag = get2();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "15040: #ifdef LIBRAW_LIBRARY_BUILD",
      "15041:   imgdata.process_warnings |=  LIBRAW_WARN_PARSEFUJI_PROCESSED;",
      "15042: #endif",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "19580:     if (raw_color)",
      "19581:       adobe_coeff(\"Apple\", \"Quicktake\");",
      "19583:   if (fuji_width)",
      "19584:   {",
      "19585:     fuji_width = width >> !fuji_layout;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "19586: #ifdef LIBRAW_LIBRARY_BUILD",
      "19588:   if(fuji_width && !dng_version && !(imgdata.process_warnings & LIBRAW_WARN_PARSEFUJI_PROCESSED ))",
      "19589:      fuji_width = 0;",
      "19590: #endif",
      "",
      "---------------"
    ],
    "internal/dcraw_common.cpp||internal/dcraw_common.cpp": [
      "File: internal/dcraw_common.cpp -> internal/dcraw_common.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "2875:   int row, col, i, j, sh = 0, pred[2], nonz[2];",
      "2877:   pana_bits(0);",
      "2879:   {",
      "2880: #ifdef LIBRAW_LIBRARY_BUILD",
      "2881:     checkCancel();",
      "",
      "[Removed Lines]",
      "2878:   for (row = 0; row < height; row++)",
      "",
      "[Added Lines]",
      "2878:   for (row = 0; row < raw_height; row++)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2897:       }",
      "2898:       else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
      "2899:         pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
      "2901:         derror();",
      "2902:     }",
      "2903:   }",
      "",
      "[Removed Lines]",
      "2900:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width)",
      "",
      "[Added Lines]",
      "2900:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width && row < height)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "13708:   entries = get4();",
      "13709:   if (entries > 255)",
      "13710:     return;",
      "13711:   while (entries--)",
      "13712:   {",
      "13713:     tag = get2();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13711: #ifdef LIBRAW_LIBRARY_BUILD",
      "13712:   imgdata.process_warnings |=  LIBRAW_WARN_PARSEFUJI_PROCESSED;",
      "13713: #endif",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "18091:     if (raw_color)",
      "18092:       adobe_coeff(\"Apple\", \"Quicktake\");",
      "18094:   if (fuji_width)",
      "18095:   {",
      "18096:     fuji_width = width >> !fuji_layout;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "18097: #ifdef LIBRAW_LIBRARY_BUILD",
      "18099:   if(fuji_width && !dng_version && !(imgdata.process_warnings & LIBRAW_WARN_PARSEFUJI_PROCESSED ))",
      "18100:      fuji_width = 0;",
      "18101: #endif",
      "",
      "---------------"
    ],
    "libraw/libraw_const.h||libraw/libraw_const.h": [
      "File: libraw/libraw_const.h -> libraw/libraw_const.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "231:   LIBRAW_WARN_RAWSPEED_PROBLEM = 1 << 12,",
      "232:   LIBRAW_WARN_RAWSPEED_UNSUPPORTED = 1 << 13,",
      "233:   LIBRAW_WARN_RAWSPEED_PROCESSED = 1 << 14,",
      "235: };",
      "237: enum LibRaw_exceptions",
      "",
      "[Removed Lines]",
      "234:   LIBRAW_WARN_FALLBACK_TO_AHD = 1 << 15",
      "",
      "[Added Lines]",
      "234:   LIBRAW_WARN_FALLBACK_TO_AHD = 1 << 15,",
      "235:   LIBRAW_WARN_PARSEFUJI_PROCESSED = 1 << 16",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "dbd47d872116f8fafc269869820ff37014bc45c4",
      "candidate_info": {
        "commit_hash": "dbd47d872116f8fafc269869820ff37014bc45c4",
        "repo": "LibRaw/LibRaw",
        "commit_url": "https://github.com/LibRaw/LibRaw/commit/dbd47d872116f8fafc269869820ff37014bc45c4",
        "files": [
          "dcraw/dcraw.c",
          "internal/dcraw_common.cpp",
          "libraw/libraw_const.h"
        ],
        "message": "merged f1394822a0152ceed77815eafa5cac4e8baab10a from master",
        "before_after_code_files": [
          "dcraw/dcraw.c||dcraw/dcraw.c",
          "internal/dcraw_common.cpp||internal/dcraw_common.cpp",
          "libraw/libraw_const.h||libraw/libraw_const.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "dcraw/dcraw.c||dcraw/dcraw.c",
            "internal/dcraw_common.cpp||internal/dcraw_common.cpp",
            "libraw/libraw_const.h||libraw/libraw_const.h"
          ],
          "candidate": [
            "dcraw/dcraw.c||dcraw/dcraw.c",
            "internal/dcraw_common.cpp||internal/dcraw_common.cpp",
            "libraw/libraw_const.h||libraw/libraw_const.h"
          ]
        }
      },
      "candidate_diff": {
        "dcraw/dcraw.c||dcraw/dcraw.c": [
          "File: dcraw/dcraw.c -> dcraw/dcraw.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2761:   int row, col, i, j, sh=0, pred[2], nonz[2];",
          "2763:   pana_bits(0);",
          "2765:   {",
          "2766: #ifdef LIBRAW_LIBRARY_BUILD",
          "2767:     checkCancel();",
          "",
          "[Removed Lines]",
          "2764:   for (row=0; row < height; row++)",
          "",
          "[Added Lines]",
          "2764:   for (row = 0; row < raw_height; row++)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2774:  if ((j = pana_bits(8))) {",
          "2775:    if ((pred[i & 1] -= 0x80 << sh) < 0 || sh == 4)",
          "2776:             pred[i & 1] &= ~((~0u) << sh);",
          "2782:     }",
          "2783:   }",
          "2784: }",
          "",
          "[Removed Lines]",
          "2777:    pred[i & 1] += j << sh;",
          "2778:  }",
          "2779:       } else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
          "2780:  pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
          "2781:       if ((RAW(row,col) = pred[col & 1]) > 4098 && col < width) derror();",
          "",
          "[Added Lines]",
          "2777:           pred[i & 1] += j << sh;",
          "2778:         }",
          "2779:       }",
          "2780:       else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
          "2781:         pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
          "2782:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width && row < height)",
          "2783:         derror();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "13279:   fseek (ifp, offset, SEEK_SET);",
          "13280:   entries = get4();",
          "13283:     tag = get2();",
          "13284:     len = get2();",
          "13285:     save = ftell(ifp);",
          "",
          "[Removed Lines]",
          "13281:   if (entries > 255) return;",
          "13282:   while (entries--) {",
          "",
          "[Added Lines]",
          "13283:   if (entries > 255)",
          "13284:     return;",
          "13285: #ifdef LIBRAW_LIBRARY_BUILD",
          "13286:   imgdata.process_warnings |=  LIBRAW_WARN_PARSEFUJI_PROCESSED;",
          "13287: #endif",
          "13288:   while (entries--)",
          "13289:   {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "16736:   if (load_raw == &CLASS kodak_radc_load_raw)",
          "16737:     if (raw_color) adobe_coeff (\"Apple\",\"Quicktake\");",
          "16740:     fuji_width = width >> !fuji_layout;",
          "16741:     filters = fuji_width & 1 ? 0x94949494 : 0x49494949;",
          "16742:     width = (height >> fuji_layout) + fuji_width;",
          "",
          "[Removed Lines]",
          "16739:   if (fuji_width) {",
          "",
          "[Added Lines]",
          "16746: #ifdef LIBRAW_LIBRARY_BUILD",
          "16748:   if(fuji_width && !dng_version && !(imgdata.process_warnings & LIBRAW_WARN_PARSEFUJI_PROCESSED ))",
          "16749:      fuji_width = 0;",
          "16750: #endif",
          "16751:   if (fuji_width)",
          "16752:   {",
          "",
          "---------------"
        ],
        "internal/dcraw_common.cpp||internal/dcraw_common.cpp": [
          "File: internal/dcraw_common.cpp -> internal/dcraw_common.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "2473:   int row, col, i, j, sh=0, pred[2], nonz[2];",
          "2475:   pana_bits(0);",
          "2477:   {",
          "2478: #ifdef LIBRAW_LIBRARY_BUILD",
          "2479:     checkCancel();",
          "",
          "[Removed Lines]",
          "2476:   for (row=0; row < height; row++)",
          "",
          "[Added Lines]",
          "2476:   for (row = 0; row < raw_height; row++)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2486:  if ((j = pana_bits(8))) {",
          "2487:    if ((pred[i & 1] -= 0x80 << sh) < 0 || sh == 4)",
          "2488:             pred[i & 1] &= ~((~0u) << sh);",
          "2494:     }",
          "2495:   }",
          "2496: }",
          "",
          "[Removed Lines]",
          "2489:    pred[i & 1] += j << sh;",
          "2490:  }",
          "2491:       } else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
          "2492:  pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
          "2493:       if ((RAW(row,col) = pred[col & 1]) > 4098 && col < width) derror();",
          "",
          "[Added Lines]",
          "2489:           pred[i & 1] += j << sh;",
          "2490:         }",
          "2491:       }",
          "2492:       else if ((nonz[i & 1] = pana_bits(8)) || i > 11)",
          "2493:         pred[i & 1] = nonz[i & 1] << 4 | pana_bits(4);",
          "2494:       if ((RAW(row, col) = pred[col & 1]) > 4098 && col < width && row < height)",
          "2495:         derror();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "12090:   fseek (ifp, offset, SEEK_SET);",
          "12091:   entries = get4();",
          "12094:     tag = get2();",
          "12095:     len = get2();",
          "12096:     save = ftell(ifp);",
          "",
          "[Removed Lines]",
          "12092:   if (entries > 255) return;",
          "12093:   while (entries--) {",
          "",
          "[Added Lines]",
          "12094:   if (entries > 255)",
          "12095:     return;",
          "12096: #ifdef LIBRAW_LIBRARY_BUILD",
          "12097:   imgdata.process_warnings |=  LIBRAW_WARN_PARSEFUJI_PROCESSED;",
          "12098: #endif",
          "12099:   while (entries--)",
          "12100:   {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "15406:   if (load_raw == &CLASS kodak_radc_load_raw)",
          "15407:     if (raw_color) adobe_coeff (\"Apple\",\"Quicktake\");",
          "15410:     fuji_width = width >> !fuji_layout;",
          "15411:     filters = fuji_width & 1 ? 0x94949494 : 0x49494949;",
          "15412:     width = (height >> fuji_layout) + fuji_width;",
          "",
          "[Removed Lines]",
          "15409:   if (fuji_width) {",
          "",
          "[Added Lines]",
          "15416: #ifdef LIBRAW_LIBRARY_BUILD",
          "15418:   if(fuji_width && !dng_version && !(imgdata.process_warnings & LIBRAW_WARN_PARSEFUJI_PROCESSED ))",
          "15419:      fuji_width = 0;",
          "15420: #endif",
          "15421:   if (fuji_width)",
          "15422:   {",
          "",
          "---------------"
        ],
        "libraw/libraw_const.h||libraw/libraw_const.h": [
          "File: libraw/libraw_const.h -> libraw/libraw_const.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "167: enum LibRaw_warnings",
          "168: {",
          "186: };",
          "188: enum LibRaw_exceptions",
          "",
          "[Removed Lines]",
          "169:     LIBRAW_WARN_NONE            =0,",
          "170:     LIBRAW_WARN_FOVEON_NOMATRIX =1,",
          "171:     LIBRAW_WARN_FOVEON_INVALIDWB =1<<1,",
          "172:     LIBRAW_WARN_BAD_CAMERA_WB   =1<<2,",
          "173:     LIBRAW_WARN_NO_METADATA     =1<<3,",
          "174:     LIBRAW_WARN_NO_JPEGLIB     = 1<<4,",
          "175:     LIBRAW_WARN_NO_EMBEDDED_PROFILE = 1<<5,",
          "176:     LIBRAW_WARN_NO_INPUT_PROFILE = 1<<6,",
          "177:     LIBRAW_WARN_BAD_OUTPUT_PROFILE= 1<<7,",
          "178:     LIBRAW_WARN_NO_BADPIXELMAP=1<<8,",
          "179:     LIBRAW_WARN_BAD_DARKFRAME_FILE=1<<9,",
          "180:     LIBRAW_WARN_BAD_DARKFRAME_DIM=1<<10,",
          "181:     LIBRAW_WARN_NO_JASPER = 1<<11,",
          "182:     LIBRAW_WARN_RAWSPEED_PROBLEM = 1<<12,",
          "183:     LIBRAW_WARN_RAWSPEED_UNSUPPORTED = 1<<13,",
          "184:     LIBRAW_WARN_RAWSPEED_PROCESSED = 1<<14,",
          "185:     LIBRAW_WARN_FALLBACK_TO_AHD = 1<<15",
          "",
          "[Added Lines]",
          "169:   LIBRAW_WARN_NONE = 0,",
          "170:   LIBRAW_WARN_BAD_CAMERA_WB = 1 << 2,",
          "171:   LIBRAW_WARN_NO_METADATA = 1 << 3,",
          "172:   LIBRAW_WARN_NO_JPEGLIB = 1 << 4,",
          "173:   LIBRAW_WARN_NO_EMBEDDED_PROFILE = 1 << 5,",
          "174:   LIBRAW_WARN_NO_INPUT_PROFILE = 1 << 6,",
          "175:   LIBRAW_WARN_BAD_OUTPUT_PROFILE = 1 << 7,",
          "176:   LIBRAW_WARN_NO_BADPIXELMAP = 1 << 8,",
          "177:   LIBRAW_WARN_BAD_DARKFRAME_FILE = 1 << 9,",
          "178:   LIBRAW_WARN_BAD_DARKFRAME_DIM = 1 << 10,",
          "179:   LIBRAW_WARN_NO_JASPER = 1 << 11,",
          "180:   LIBRAW_WARN_RAWSPEED_PROBLEM = 1 << 12,",
          "181:   LIBRAW_WARN_RAWSPEED_UNSUPPORTED = 1 << 13,",
          "182:   LIBRAW_WARN_RAWSPEED_PROCESSED = 1 << 14,",
          "183:   LIBRAW_WARN_FALLBACK_TO_AHD = 1 << 15,",
          "184:   LIBRAW_WARN_PARSEFUJI_PROCESSED = 1 << 16",
          "",
          "---------------"
        ]
      }
    }
  ]
}