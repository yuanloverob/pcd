{
  "cve_id": "CVE-2023-28100",
  "cve_desc": "Flatpak is a system for building, distributing, and running sandboxed desktop applications on Linux. Versions prior to 1.10.8, 1.12.8, 1.14.4, and 1.15.4 contain a vulnerability similar to CVE-2017-5226, but using the `TIOCLINUX` ioctl command instead of `TIOCSTI`. If a Flatpak app is run on a Linux virtual console such as `/dev/tty1`, it can copy text from the virtual console and paste it into the command buffer, from which the command might be run after the Flatpak app has exited. Ordinary graphical terminal emulators like xterm, gnome-terminal and Konsole are unaffected. This vulnerability is specific to the Linux virtual consoles `/dev/tty1`, `/dev/tty2` and so on. A patch is available in versions 1.10.8, 1.12.8, 1.14.4, and 1.15.4. As a workaround, don't run Flatpak on a Linux virtual console. Flatpak is primarily designed to be used in a Wayland or X11 graphical environment.",
  "repo": "flatpak/flatpak",
  "patch_hash": "8e63de9a7d3124f91140fc74f8ca9ed73ed53be9",
  "patch_info": {
    "commit_hash": "8e63de9a7d3124f91140fc74f8ca9ed73ed53be9",
    "repo": "flatpak/flatpak",
    "commit_url": "https://github.com/flatpak/flatpak/commit/8e63de9a7d3124f91140fc74f8ca9ed73ed53be9",
    "files": [
      "common/flatpak-run.c",
      "tests/test-seccomp.sh",
      "tests/try-syscall.c"
    ],
    "message": "run: Prevent TIOCLINUX ioctl, the same as TIOCSTI\n\nThe TIOCLINUX ioctl is only available on Linux virtual consoles such as\n/dev/tty1. It has several Linux-specific functions, one of which is a\ncopy/paste operation which can be used for attacks similar to TIOCSTI.\n\nThis vulnerability does not affect typical graphical terminal emulators\nsuch as xterm, gnome-terminal and Konsole, and Flatpak is primarily\ndesigned to be run from a Wayland or X11 graphical environment, so this\nis relatively unlikely to be a practical problem.\n\nCVE-2023-28100, GHSA-7qpw-3vjv-xrqp\n\nResolves: https://github.com/flatpak/flatpak/security/advisories/GHSA-7qpw-3vjv-xrqp\nSigned-off-by: Simon McVittie <smcv@debian.org>",
    "before_after_code_files": [
      "common/flatpak-run.c||common/flatpak-run.c",
      "tests/test-seccomp.sh||tests/test-seccomp.sh",
      "tests/try-syscall.c||tests/try-syscall.c"
    ]
  },
  "patch_diff": {
    "common/flatpak-run.c||common/flatpak-run.c": [
      "File: common/flatpak-run.c -> common/flatpak-run.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3222:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCSTI)},",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3226:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCLINUX)},",
      "",
      "---------------"
    ],
    "tests/test-seccomp.sh||tests/test-seccomp.sh": [
      "File: tests/test-seccomp.sh -> tests/test-seccomp.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "9: skip_without_bwrap",
      "13: setup_repo",
      "14: install_repo",
      "",
      "[Removed Lines]",
      "11: echo \"1..16\"",
      "",
      "[Added Lines]",
      "11: echo \"1..18\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "80:     ok \"ioctl TIOCSTI with high bits blocked (CVE-2019-10063)\"",
      "81:   fi",
      "83:   echo \"# listen (benign)\"",
      "84:   e=0",
      "85:   try_syscall \"listen\" || e=\"$?\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "83:   echo \"# ioctl TIOCLINUX (CVE-2023-28100)\"",
      "84:   e=0",
      "85:   try_syscall \"ioctl TIOCLINUX\" || e=\"$?\"",
      "86:   assert_streq \"$e\" \"$EPERM\"",
      "87:   ok \"ioctl TIOCLINUX blocked\"",
      "",
      "---------------"
    ],
    "tests/try-syscall.c||tests/try-syscall.c": [
      "File: tests/try-syscall.c -> tests/try-syscall.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "151:             }",
      "152:         }",
      "153: #endif",
      "154:      else if (strcmp (arg, \"listen\") == 0)",
      "155:         {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "154:       else if (strcmp (arg, \"ioctl TIOCLINUX\") == 0)",
      "155:         {",
      "157:           if (ioctl (-1, TIOCLINUX, WRONG_POINTER) != 0)",
      "158:             {",
      "159:               errsv = errno;",
      "160:               perror (arg);",
      "161:             }",
      "162:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a9bf18040cc075a70657c6090a59d7f6fe78f893",
      "candidate_info": {
        "commit_hash": "a9bf18040cc075a70657c6090a59d7f6fe78f893",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/a9bf18040cc075a70657c6090a59d7f6fe78f893",
        "files": [
          "common/flatpak-run.c",
          "tests/test-seccomp.sh",
          "tests/try-syscall.c"
        ],
        "message": "run: Prevent TIOCLINUX ioctl, the same as TIOCSTI\n\nThe TIOCLINUX ioctl is only available on Linux virtual consoles such as\n/dev/tty1. It has several Linux-specific functions, one of which is a\ncopy/paste operation which can be used for attacks similar to TIOCSTI.\n\nThis vulnerability does not affect typical graphical terminal emulators\nsuch as xterm, gnome-terminal and Konsole, and Flatpak is primarily\ndesigned to be run from a Wayland or X11 graphical environment, so this\nis relatively unlikely to be a practical problem.\n\nCVE-2023-28100, GHSA-7qpw-3vjv-xrqp\n\nResolves: https://github.com/flatpak/flatpak/security/advisories/GHSA-7qpw-3vjv-xrqp\nSigned-off-by: Simon McVittie <smcv@debian.org>",
        "before_after_code_files": [
          "common/flatpak-run.c||common/flatpak-run.c",
          "tests/test-seccomp.sh||tests/test-seccomp.sh",
          "tests/try-syscall.c||tests/try-syscall.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ],
          "candidate": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ]
        }
      },
      "candidate_diff": {
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2874:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCSTI)},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2878:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCLINUX)},",
          "",
          "---------------"
        ],
        "tests/test-seccomp.sh||tests/test-seccomp.sh": [
          "File: tests/test-seccomp.sh -> tests/test-seccomp.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: skip_without_bwrap",
          "13: setup_repo",
          "14: install_repo",
          "",
          "[Removed Lines]",
          "11: echo \"1..16\"",
          "",
          "[Added Lines]",
          "11: echo \"1..18\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     ok \"ioctl TIOCSTI with high bits blocked (CVE-2019-10063)\"",
          "81:   fi",
          "83:   echo \"# listen (benign)\"",
          "84:   e=0",
          "85:   try_syscall \"listen\" || e=\"$?\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:   echo \"# ioctl TIOCLINUX (CVE-2023-28100)\"",
          "84:   e=0",
          "85:   try_syscall \"ioctl TIOCLINUX\" || e=\"$?\"",
          "86:   assert_streq \"$e\" \"$EPERM\"",
          "87:   ok \"ioctl TIOCLINUX blocked\"",
          "",
          "---------------"
        ],
        "tests/try-syscall.c||tests/try-syscall.c": [
          "File: tests/try-syscall.c -> tests/try-syscall.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "144:             }",
          "145:         }",
          "146: #endif",
          "147:      else if (strcmp (arg, \"listen\") == 0)",
          "148:         {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "147:       else if (strcmp (arg, \"ioctl TIOCLINUX\") == 0)",
          "148:         {",
          "150:           if (ioctl (-1, TIOCLINUX, WRONG_POINTER) != 0)",
          "151:             {",
          "152:               errsv = errno;",
          "153:               perror (arg);",
          "154:             }",
          "155:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f015f91dc3c54d2e0b64a0f0e560a48071d8b22e",
      "candidate_info": {
        "commit_hash": "f015f91dc3c54d2e0b64a0f0e560a48071d8b22e",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/f015f91dc3c54d2e0b64a0f0e560a48071d8b22e",
        "files": [
          "common/flatpak-run.c",
          "tests/test-seccomp.sh",
          "tests/try-syscall.c"
        ],
        "message": "run: Prevent TIOCLINUX ioctl, the same as TIOCSTI\n\nThe TIOCLINUX ioctl is only available on Linux virtual consoles such as\n/dev/tty1. It has several Linux-specific functions, one of which is a\ncopy/paste operation which can be used for attacks similar to TIOCSTI.\n\nThis vulnerability does not affect typical graphical terminal emulators\nsuch as xterm, gnome-terminal and Konsole, and Flatpak is primarily\ndesigned to be run from a Wayland or X11 graphical environment, so this\nis relatively unlikely to be a practical problem.\n\nCVE-2023-28100, GHSA-7qpw-3vjv-xrqp\n\nResolves: https://github.com/flatpak/flatpak/security/advisories/GHSA-7qpw-3vjv-xrqp\nSigned-off-by: Simon McVittie <smcv@debian.org>",
        "before_after_code_files": [
          "common/flatpak-run.c||common/flatpak-run.c",
          "tests/test-seccomp.sh||tests/test-seccomp.sh",
          "tests/try-syscall.c||tests/try-syscall.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ],
          "candidate": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ]
        }
      },
      "candidate_diff": {
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3212:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCSTI)},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3216:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCLINUX)},",
          "",
          "---------------"
        ],
        "tests/test-seccomp.sh||tests/test-seccomp.sh": [
          "File: tests/test-seccomp.sh -> tests/test-seccomp.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: skip_without_bwrap",
          "13: setup_repo",
          "14: install_repo",
          "",
          "[Removed Lines]",
          "11: echo \"1..16\"",
          "",
          "[Added Lines]",
          "11: echo \"1..18\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     ok \"ioctl TIOCSTI with high bits blocked (CVE-2019-10063)\"",
          "81:   fi",
          "83:   echo \"# listen (benign)\"",
          "84:   e=0",
          "85:   try_syscall \"listen\" || e=\"$?\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:   echo \"# ioctl TIOCLINUX (CVE-2023-28100)\"",
          "84:   e=0",
          "85:   try_syscall \"ioctl TIOCLINUX\" || e=\"$?\"",
          "86:   assert_streq \"$e\" \"$EPERM\"",
          "87:   ok \"ioctl TIOCLINUX blocked\"",
          "",
          "---------------"
        ],
        "tests/try-syscall.c||tests/try-syscall.c": [
          "File: tests/try-syscall.c -> tests/try-syscall.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:             }",
          "152:         }",
          "153: #endif",
          "154:      else if (strcmp (arg, \"listen\") == 0)",
          "155:         {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "154:       else if (strcmp (arg, \"ioctl TIOCLINUX\") == 0)",
          "155:         {",
          "157:           if (ioctl (-1, TIOCLINUX, WRONG_POINTER) != 0)",
          "158:             {",
          "159:               errsv = errno;",
          "160:               perror (arg);",
          "161:             }",
          "162:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "de68092f7f8b06189d42b5e682319cba0812ca2c",
      "candidate_info": {
        "commit_hash": "de68092f7f8b06189d42b5e682319cba0812ca2c",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/de68092f7f8b06189d42b5e682319cba0812ca2c",
        "files": [
          "common/flatpak-run.c",
          "tests/test-seccomp.sh",
          "tests/try-syscall.c"
        ],
        "message": "run: Prevent TIOCLINUX ioctl, the same as TIOCSTI\n\nThe TIOCLINUX ioctl is only available on Linux virtual consoles such as\n/dev/tty1. It has several Linux-specific functions, one of which is a\ncopy/paste operation which can be used for attacks similar to TIOCSTI.\n\nThis vulnerability does not affect typical graphical terminal emulators\nsuch as xterm, gnome-terminal and Konsole, and Flatpak is primarily\ndesigned to be run from a Wayland or X11 graphical environment, so this\nis relatively unlikely to be a practical problem.\n\nCVE-2023-28100, GHSA-7qpw-3vjv-xrqp\n\nResolves: https://github.com/flatpak/flatpak/security/advisories/GHSA-7qpw-3vjv-xrqp\nSigned-off-by: Simon McVittie <smcv@debian.org>",
        "before_after_code_files": [
          "common/flatpak-run.c||common/flatpak-run.c",
          "tests/test-seccomp.sh||tests/test-seccomp.sh",
          "tests/try-syscall.c||tests/try-syscall.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ],
          "candidate": [
            "common/flatpak-run.c||common/flatpak-run.c",
            "tests/test-seccomp.sh||tests/test-seccomp.sh",
            "tests/try-syscall.c||tests/try-syscall.c"
          ]
        }
      },
      "candidate_diff": {
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3152:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCSTI)},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3156:     {SCMP_SYS (ioctl), EPERM, &SCMP_A1 (SCMP_CMP_MASKED_EQ, 0xFFFFFFFFu, (int) TIOCLINUX)},",
          "",
          "---------------"
        ],
        "tests/test-seccomp.sh||tests/test-seccomp.sh": [
          "File: tests/test-seccomp.sh -> tests/test-seccomp.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: skip_without_bwrap",
          "13: setup_repo",
          "14: install_repo",
          "",
          "[Removed Lines]",
          "11: echo \"1..16\"",
          "",
          "[Added Lines]",
          "11: echo \"1..18\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     ok \"ioctl TIOCSTI with high bits blocked (CVE-2019-10063)\"",
          "81:   fi",
          "83:   echo \"# listen (benign)\"",
          "84:   e=0",
          "85:   try_syscall \"listen\" || e=\"$?\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:   echo \"# ioctl TIOCLINUX (CVE-2023-28100)\"",
          "84:   e=0",
          "85:   try_syscall \"ioctl TIOCLINUX\" || e=\"$?\"",
          "86:   assert_streq \"$e\" \"$EPERM\"",
          "87:   ok \"ioctl TIOCLINUX blocked\"",
          "",
          "---------------"
        ],
        "tests/try-syscall.c||tests/try-syscall.c": [
          "File: tests/try-syscall.c -> tests/try-syscall.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "144:             }",
          "145:         }",
          "146: #endif",
          "147:      else if (strcmp (arg, \"listen\") == 0)",
          "148:         {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "147:       else if (strcmp (arg, \"ioctl TIOCLINUX\") == 0)",
          "148:         {",
          "150:           if (ioctl (-1, TIOCLINUX, WRONG_POINTER) != 0)",
          "151:             {",
          "152:               errsv = errno;",
          "153:               perror (arg);",
          "154:             }",
          "155:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}