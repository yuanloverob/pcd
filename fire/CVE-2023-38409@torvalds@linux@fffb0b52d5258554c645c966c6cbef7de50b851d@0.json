{
  "cve_id": "CVE-2023-38409",
  "cve_desc": "An issue was discovered in set_con2fb_map in drivers/video/fbdev/core/fbcon.c in the Linux kernel before 6.2.12. Because an assignment occurs only for the first vc, the fbcon_registered_fb and fbcon_display arrays can be desynchronized in fbcon_mode_deleted (the con2fb_map points at the old fb_info).",
  "repo": "torvalds/linux",
  "patch_hash": "fffb0b52d5258554c645c966c6cbef7de50b851d",
  "patch_info": {
    "commit_hash": "fffb0b52d5258554c645c966c6cbef7de50b851d",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/fffb0b52d5258554c645c966c6cbef7de50b851d",
    "files": [
      "drivers/video/fbdev/core/fbcon.c"
    ],
    "message": "fbcon: set_con2fb_map needs to set con2fb_map!\n\nI got really badly confused in d443d9386472 (\"fbcon: move more common\ncode into fb_open()\") because we set the con2fb_map before the failure\npoints, which didn't look good.\n\nBut in trying to fix that I moved the assignment into the wrong path -\nwe need to do it for _all_ vc we take over, not just the first one\n(which additionally requires the call to con2fb_acquire_newinfo).\n\nI've figured this out because of a KASAN bug report, where the\nfbcon_registered_fb and fbcon_display arrays went out of sync in\nfbcon_mode_deleted() because the con2fb_map pointed at the old\nfb_info, but the modes and everything was updated for the new one.\n\nSigned-off-by: Daniel Vetter <daniel.vetter@intel.com>\nReviewed-by: Javier Martinez Canillas <javierm@redhat.com>\nAcked-by: Helge Deller <deller@gmx.de>\nTested-by: Xingyuan Mo <hdthky0@gmail.com>\nFixes: d443d9386472 (\"fbcon: move more common code into fb_open()\")\nReported-by: Xingyuan Mo <hdthky0@gmail.com>\nCc: Thomas Zimmermann <tzimmermann@suse.de>\nCc: Sam Ravnborg <sam@ravnborg.org>\nCc: Xingyuan Mo <hdthky0@gmail.com>\nCc: Thomas Zimmermann <tzimmermann@suse.de>\nCc: Helge Deller <deller@gmx.de>\nCc: <stable@vger.kernel.org> # v5.19+",
    "before_after_code_files": [
      "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c"
    ]
  },
  "patch_diff": {
    "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c": [
      "File: drivers/video/fbdev/core/fbcon.c -> drivers/video/fbdev/core/fbcon.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "846:   if (err)",
      "847:    return err;",
      "850:   fbcon_add_cursor_work(info);",
      "851:  }",
      "",
      "[Removed Lines]",
      "849:   con2fb_map[unit] = newidx;",
      "",
      "[Added Lines]",
      "852:  con2fb_map[unit] = newidx;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "edf79dd2172233452ff142dcc98b19d955fc8974",
      "candidate_info": {
        "commit_hash": "edf79dd2172233452ff142dcc98b19d955fc8974",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/edf79dd2172233452ff142dcc98b19d955fc8974",
        "files": [
          "drivers/video/fbdev/core/fbcon.c"
        ],
        "message": "fbcon: Fix error paths in set_con2fb_map\n\nThis is a regressoin introduced in b07db3958485 (\"fbcon: Ditch error\nhandling for con2fb_release_oldinfo\"). I failed to realize what the if\n(!err) checks. The mentioned commit was dropping the\ncon2fb_release_oldinfo() return value but the if (!err) was also\nchecking whether the con2fb_acquire_newinfo() function call above\nfailed or not.\n\nFix this with an early return statement.\n\nNote that there's still a difference compared to the orginal state of\nthe code, the below lines are now also skipped on error:\n\n\tif (!search_fb_in_map(info_idx))\n\t\tinfo_idx = newidx;\n\nThese are only needed when we've actually thrown out an old fb_info\nfrom the console mappings, which only happens later on.\n\nAlso move the fbcon_add_cursor_work() call into the same if block,\nit's all protected by console_lock so doesn't matter when we set up\nthe blinking cursor delayed work anyway. This further simplifies the\ncontrol flow and allows us to ditch the found local variable.\n\nv2: Clarify commit message (Javier)\n\nSigned-off-by: Daniel Vetter <daniel.vetter@intel.com>\nReviewed-by: Javier Martinez Canillas <javierm@redhat.com>\nAcked-by: Helge Deller <deller@gmx.de>\nTested-by: Xingyuan Mo <hdthky0@gmail.com>\nFixes: b07db3958485 (\"fbcon: Ditch error handling for con2fb_release_oldinfo\")\nCc: Thomas Zimmermann <tzimmermann@suse.de>\nCc: Sam Ravnborg <sam@ravnborg.org>\nCc: Xingyuan Mo <hdthky0@gmail.com>\nCc: Thomas Zimmermann <tzimmermann@suse.de>\nCc: Helge Deller <deller@gmx.de>\nCc: <stable@vger.kernel.org> # v5.19+",
        "before_after_code_files": [
          "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c"
          ],
          "candidate": [
            "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/video/fbdev/core/fbcon.c||drivers/video/fbdev/core/fbcon.c": [
          "File: drivers/video/fbdev/core/fbcon.c -> drivers/video/fbdev/core/fbcon.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "823:  int oldidx = con2fb_map[unit];",
          "824:  struct fb_info *info = fbcon_registered_fb[newidx];",
          "825:  struct fb_info *oldinfo = NULL;",
          "828:  WARN_CONSOLE_UNLOCKED();",
          "",
          "[Removed Lines]",
          "826:  int found, err = 0, show_logo;",
          "",
          "[Added Lines]",
          "826:  int err = 0, show_logo;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "841:  if (oldidx != -1)",
          "842:   oldinfo = fbcon_registered_fb[oldidx];",
          "847:   err = con2fb_acquire_newinfo(vc, info, unit);",
          "850:  }",
          "857:   con2fb_release_oldinfo(vc, oldinfo, info);",
          "859:  show_logo = (fg_console == 0 && !user &&",
          "860:     logo_shown != FBCON_LOGO_DONTSHOW);",
          "864:  con2fb_map_boot[unit] = newidx;",
          "865:  con2fb_init_display(vc, info, unit, show_logo);",
          "",
          "[Removed Lines]",
          "844:  found = search_fb_in_map(newidx);",
          "846:  if (!err && !found) {",
          "848:   if (!err)",
          "849:    con2fb_map[unit] = newidx;",
          "856:  if (!err && oldinfo && !search_fb_in_map(oldidx))",
          "862:  if (!found)",
          "863:   fbcon_add_cursor_work(info);",
          "",
          "[Added Lines]",
          "844:  if (!search_fb_in_map(newidx)) {",
          "846:   if (err)",
          "847:    return err;",
          "849:   con2fb_map[unit] = newidx;",
          "850:   fbcon_add_cursor_work(info);",
          "857:  if (oldinfo && !search_fb_in_map(oldidx))",
          "",
          "---------------"
        ]
      }
    }
  ]
}