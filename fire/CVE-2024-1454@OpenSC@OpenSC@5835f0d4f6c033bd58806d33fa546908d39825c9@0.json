{
  "cve_id": "CVE-2024-1454",
  "cve_desc": "The use-after-free vulnerability was found in the AuthentIC driver in OpenSC packages, occuring in the card enrolment process using pkcs15-init when a user or administrator enrols or modifies cards. An attacker must have physical access to the computer system and requires a crafted USB device or smart card to present the system with specially crafted responses to the APDUs, which are considered high complexity and low severity. This manipulation can allow for compromised card management operations during enrolment.",
  "repo": "OpenSC/OpenSC",
  "patch_hash": "5835f0d4f6c033bd58806d33fa546908d39825c9",
  "patch_info": {
    "commit_hash": "5835f0d4f6c033bd58806d33fa546908d39825c9",
    "repo": "OpenSC/OpenSC",
    "commit_url": "https://github.com/OpenSC/OpenSC/commit/5835f0d4f6c033bd58806d33fa546908d39825c9",
    "files": [
      "src/pkcs15init/pkcs15-authentic.c"
    ],
    "message": "authentic: Avoid use after free\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=64898",
    "before_after_code_files": [
      "src/pkcs15init/pkcs15-authentic.c||src/pkcs15init/pkcs15-authentic.c"
    ]
  },
  "patch_diff": {
    "src/pkcs15init/pkcs15-authentic.c||src/pkcs15init/pkcs15-authentic.c": [
      "File: src/pkcs15init/pkcs15-authentic.c -> src/pkcs15init/pkcs15-authentic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "868:  rv = sc_select_file(p15card->card, &path, &file);",
      "869:  if (!rv) {",
      "870:   rv = sc_get_challenge(p15card->card, buffer, sizeof(buffer));",
      "872:    sc_file_free(file);",
      "873:    LOG_TEST_RET(ctx, rv, \"Get challenge error\");",
      "874:   }",
      "",
      "[Removed Lines]",
      "871:   if (!rv) {",
      "",
      "[Added Lines]",
      "871:   if (rv < 0) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5def7eba302ba3686b481abca7c0e2c6b1b1cba3",
      "candidate_info": {
        "commit_hash": "5def7eba302ba3686b481abca7c0e2c6b1b1cba3",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/5def7eba302ba3686b481abca7c0e2c6b1b1cba3",
        "files": [
          "src/pkcs15init/pkcs15-setcos.c"
        ],
        "message": "setcos: Avoid memory leaks\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=64956",
        "before_after_code_files": [
          "src/pkcs15init/pkcs15-setcos.c||src/pkcs15init/pkcs15-setcos.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2962"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/pkcs15init/pkcs15-setcos.c||src/pkcs15init/pkcs15-setcos.c": [
          "File: src/pkcs15init/pkcs15-setcos.c -> src/pkcs15init/pkcs15-setcos.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "466:  r = sc_pkcs15init_authenticate(profile, p15card, file, SC_AC_OP_UPDATE);",
          "470:  memset(&args, 0, sizeof(args));",
          "",
          "[Removed Lines]",
          "467:  LOG_TEST_RET(ctx, r, \"No authorisation to store private key\");",
          "",
          "[Added Lines]",
          "467:  if (r != SC_SUCCESS) {",
          "468:   sc_file_free(file);",
          "469:   LOG_TEST_RET(ctx, r, \"No authorisation to store private key\");",
          "470:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "477:  r = sc_card_ctl(p15card->card, SC_CARDCTL_SETCOS_GENERATE_STORE_KEY, &args);",
          "481:  if (pubkey != NULL) {",
          "",
          "[Removed Lines]",
          "478:  LOG_TEST_RET(ctx, r, \"Card control 'GENERATE_STORE_KEY' failed\");",
          "",
          "[Added Lines]",
          "481:  if (r != SC_SUCCESS) {",
          "482:   sc_file_free(file);",
          "483:   LOG_TEST_RET(ctx, r, \"Card control 'GENERATE_STORE_KEY' failed\");",
          "484:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "490:   r = sc_select_file(p15card->card, &file->path, NULL);",
          "491:   LOG_TEST_RET(ctx, r, \"Cannot get key modulus: select key file failed\");",
          "493:   data_obj.P1 = 0x01;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "497:   sc_file_free(file);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "506:    LOG_TEST_RET(ctx, SC_ERROR_PKCS15INIT, \"Failed to generate key\");",
          "507:   }",
          "508:   memcpy (pubkey->u.rsa.modulus.data, &raw_pubkey[2], pubkey->u.rsa.modulus.len);",
          "509:  }",
          "512:  return r;",
          "513: }",
          "",
          "[Removed Lines]",
          "511:  sc_file_free(file);",
          "",
          "[Added Lines]",
          "516:  } else {",
          "517:   sc_file_free(file);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "846661ff8feb3d00ca6a7354b793e77528335157",
      "candidate_info": {
        "commit_hash": "846661ff8feb3d00ca6a7354b793e77528335157",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/846661ff8feb3d00ca6a7354b793e77528335157",
        "files": [
          "src/pkcs15init/pkcs15-oberthur.c"
        ],
        "message": "oberthur: avoid memory leaks\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=65153",
        "before_after_code_files": [
          "src/pkcs15init/pkcs15-oberthur.c||src/pkcs15init/pkcs15-oberthur.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2962"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/pkcs15init/pkcs15-oberthur.c||src/pkcs15init/pkcs15-oberthur.c": [
          "File: src/pkcs15init/pkcs15-oberthur.c -> src/pkcs15init/pkcs15-oberthur.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "619:  LOG_TEST_RET(ctx, rv, \"Cannot generate key: failed to select private object DF\");",
          "621:  rv = sc_pkcs15init_authenticate(profile, p15card, tmpf, SC_AC_OP_CRYPTO);",
          "624:  rv = sc_pkcs15init_authenticate(profile, p15card, tmpf, SC_AC_OP_CREATE);",
          "627:  sc_file_free(tmpf);",
          "628:  tmpf = NULL;",
          "630:  rv = sc_select_file(p15card->card, &key_info->path, &prkf);",
          "631:  LOG_TEST_RET(ctx, rv, \"Failed to generate key: cannot select private key file\");",
          "",
          "[Removed Lines]",
          "622:  LOG_TEST_RET(ctx, rv, \"Cannot generate key: 'CRYPTO' authentication failed\");",
          "625:  LOG_TEST_RET(ctx, rv, \"Cannot generate key: 'CREATE' authentication failed\");",
          "",
          "[Added Lines]",
          "622:  if (rv != SC_SUCCESS) {",
          "623:   sc_file_free(tmpf);",
          "624:   LOG_TEST_RET(ctx, rv, \"Cannot generate key: 'CRYPTO' authentication failed\");",
          "625:  }",
          "630:  LOG_TEST_RET(ctx, rv, \"Cannot generate key: 'CREATE' authentication failed\");",
          "",
          "---------------"
        ]
      }
    }
  ]
}