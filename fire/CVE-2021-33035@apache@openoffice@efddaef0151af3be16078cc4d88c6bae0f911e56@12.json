{
  "cve_id": "CVE-2021-33035",
  "cve_desc": "Apache OpenOffice opens dBase/DBF documents and shows the contents as spreadsheets. DBF are database files with data organized in fields. When reading DBF data the size of certain fields is not checked: the data is just copied into local variables. A carefully crafted document could overflow the allocated space, leading to the execution of arbitrary code by altering the contents of the program stack. This issue affects Apache OpenOffice up to and including version 4.1.10",
  "repo": "apache/openoffice",
  "patch_hash": "efddaef0151af3be16078cc4d88c6bae0f911e56",
  "patch_info": {
    "commit_hash": "efddaef0151af3be16078cc4d88c6bae0f911e56",
    "repo": "apache/openoffice",
    "commit_url": "https://github.com/apache/openoffice/commit/efddaef0151af3be16078cc4d88c6bae0f911e56#diff-ea66e734dd358922aba12ad4ba39c96bdc6cbde587d07dbc63d04daa0a30e90f",
    "files": [
      "main/connectivity/source/drivers/dbase/DTable.cxx"
    ],
    "message": "add useful checks",
    "before_after_code_files": [
      "main/connectivity/source/drivers/dbase/DTable.cxx||main/connectivity/source/drivers/dbase/DTable.cxx"
    ]
  },
  "patch_diff": {
    "main/connectivity/source/drivers/dbase/DTable.cxx||main/connectivity/source/drivers/dbase/DTable.cxx": [
      "File: main/connectivity/source/drivers/dbase/DTable.cxx -> main/connectivity/source/drivers/dbase/DTable.cxx",
      "--- Hunk 1 ---",
      "[Context before]",
      "896:         else if ( DataType::TIMESTAMP == nType )",
      "897:         {",
      "898:             sal_Int32 nDate = 0,nTime = 0;",
      "899:    memcpy(&nDate, pData, 4);",
      "900:             memcpy(&nTime, pData+ 4, 4);",
      "901:             if ( !nDate && !nTime )",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "899:             OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "900:             if (nLen != 8) {",
      "901:                 return false;",
      "902:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "911:         }",
      "912:         else if ( DataType::INTEGER == nType )",
      "913:         {",
      "914:             sal_Int32 nValue = 0;",
      "915:    memcpy(&nValue, pData, nLen);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "918:             OSL_ENSURE(nLen == 4, \"Invalid length for integer field\");",
      "919:             if (nLen != 4) {",
      "920:                 return false;",
      "921:             }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "918:         else if ( DataType::DOUBLE == nType )",
      "919:         {",
      "920:             double d = 0.0;",
      "921:             if (getBOOL((*aIter)->getPropertyValue(OMetaConnection::getPropMap().getNameByIndex(PROPERTY_ID_ISCURRENCY)))) // Currency wird gesondert behandelt",
      "922:             {",
      "923:                 sal_Int64 nValue = 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "929:             OSL_ENSURE(nLen == 8, \"Invalid length for double field\");",
      "930:             if (nLen != 8) {",
      "931:                 return false;",
      "932:             }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "959:    {",
      "960:     case DataType::DATE:",
      "961:     {",
      "962:      if (aStr.Len() != nLen)",
      "963:      {",
      "964:       (_rRow->get())[i]->setNull();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "974:                     OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "975:                     if (nLen != 8) {",
      "976:                         return false;",
      "977:                     }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "978:     break;",
      "979:     case DataType::BIT:",
      "980:     {",
      "981:      sal_Bool b;",
      "982:      switch (* ((const char *)pData))",
      "983:      {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "997:                     OSL_ENSURE(nLen == 1, \"Invalid length for bit field\");",
      "998:                     if (nLen != 1) {",
      "999:                         return false;",
      "1000:                     }",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1873:    {",
      "1874:                 case DataType::TIMESTAMP:",
      "1875:                     {",
      "1876:                         sal_Int32 nJulianDate = 0, nJulianTime = 0;",
      "1877:                         lcl_CalcJulDate(nJulianDate,nJulianTime,rRow.get()[nPos]->getValue());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1896:                         OSL_ENSURE(nLen == 8, \"Invalid length for timestamp field\");",
      "1897:                         if (nLen != 8) {",
      "1898:                             bHadError = true;",
      "1899:                             break;",
      "1900:                         }",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1882:                     break;",
      "1883:     case DataType::DATE:",
      "1884:     {",
      "1885:      ::com::sun::star::util::Date aDate;",
      "1886:      if(rRow.get()[nPos]->getValue().getTypeKind() == DataType::DOUBLE)",
      "1887:       aDate = ::dbtools::DBTypeConversion::toDate(rRow.get()[nPos]->getValue().getDouble());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1910:                     OSL_ENSURE(nLen == 8, \"Invalid length for date field\");",
      "1911:                     if (nLen != 8) {",
      "1912:                         bHadError = true;",
      "1913:                         break;",
      "1914:                     }",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1900:     } break;",
      "1901:                 case DataType::INTEGER:",
      "1902:                     {",
      "1903:                         sal_Int32 nValue = rRow.get()[nPos]->getValue();",
      "1904:                         memcpy(pData,&nValue,nLen);",
      "1905:                     }",
      "1906:                     break;",
      "1907:                 case DataType::DOUBLE:",
      "1908:                     {",
      "1909:                         const double d = rRow.get()[nPos]->getValue();",
      "1910:                         m_pColumns->getByIndex(i) >>= xCol;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1933:                         OSL_ENSURE(nLen == 4, \"Invalid length for integer field\");",
      "1934:                         if (nLen != 4) {",
      "1935:                             bHadError = true;",
      "1936:                             break;",
      "1937:                         }",
      "1944:                         OSL_ENSURE(nLen == 8, \"Invalid length for double field\");",
      "1945:                         if (nLen != 8) {",
      "1946:                             bHadError = true;",
      "1947:                             break;",
      "1948:                         }",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1958:      }",
      "1959:     } break;",
      "1960:     case DataType::BIT:",
      "1962:      break;",
      "1963:                 case DataType::LONGVARBINARY:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2001:                     OSL_ENSURE(nLen == 1, \"Invalid length for bit field\");",
      "2002:                     if (nLen != 1) {",
      "2003:                         bHadError = true;",
      "2004:                         break;",
      "2005:                     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a1f1a12a3d7d8d0eaf0714d9605d10b4a138a2a5",
      "candidate_info": {
        "commit_hash": "a1f1a12a3d7d8d0eaf0714d9605d10b4a138a2a5",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/a1f1a12a3d7d8d0eaf0714d9605d10b4a138a2a5",
        "files": [
          "main/starmath/source/view.cxx"
        ],
        "message": "Small visual changes to Math Command Window",
        "before_after_code_files": [
          "main/starmath/source/view.cxx||main/starmath/source/view.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/starmath/source/view.cxx||main/starmath/source/view.cxx": [
          "File: main/starmath/source/view.cxx -> main/starmath/source/view.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "543:  }",
          "545:  DecorationView aView(this);",
          "550:  aEdit.SetPosSizePixel(aRect.TopLeft(), aRect.GetSize());",
          "551:  SfxDockingWindow::Resize();",
          "",
          "[Removed Lines]",
          "546:  aRect.Left() += 8; aRect.Top()  += 8;",
          "547:  aRect.Right()-= 8; aRect.Bottom()-= 8;",
          "548:  aRect = aView.DrawFrame( aRect, FRAME_DRAW_DOUBLEIN );",
          "",
          "[Added Lines]",
          "546:  aRect.Left() += 6; aRect.Top()  += 6;",
          "547:  aRect.Right()-= 6; aRect.Bottom()-= 6;",
          "548:  aRect = aView.DrawFrame( aRect, FRAME_DRAW_IN );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "589:   DrawLine( aFrom, aTo );",
          "590:   aView.DrawFrame(aRect, FRAME_DRAW_OUT);",
          "591:  }",
          "595: }",
          "",
          "[Removed Lines]",
          "592:  aRect.Left() += 8; aRect.Top()  += 8;",
          "593:  aRect.Right()-= 8; aRect.Bottom()-= 8;",
          "594:  aRect = aView.DrawFrame( aRect, FRAME_DRAW_DOUBLEIN );",
          "",
          "[Added Lines]",
          "592:  aRect.Left() += 6; aRect.Top()  += 6;",
          "593:  aRect.Right()-= 6; aRect.Bottom()-= 6;",
          "594:  aRect = aView.DrawFrame( aRect, FRAME_DRAW_IN );",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1046: }",
          "1048: void SmViewShell::Impl_Print(",
          "1050:         const SmPrintUIOptions &rPrintUIOptions,",
          "1051:         Rectangle aOutRect, Point aZeroPoint )",
          "1052: {",
          "",
          "[Removed Lines]",
          "1049:         OutputDevice &rOutDev,",
          "",
          "[Added Lines]",
          "1049:         OutputDevice &rOutDev,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4dcbef3e4f42e9515ba2313db12f4aecd595a57f",
      "candidate_info": {
        "commit_hash": "4dcbef3e4f42e9515ba2313db12f4aecd595a57f",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/4dcbef3e4f42e9515ba2313db12f4aecd595a57f",
        "files": [
          "main/basic/source/comp/loops.cxx"
        ],
        "message": "Refs i126272 - fix for comment on single line if then else statement original commit to trunk: i126272 OpenOffice.org Basic compile error : if statement followed by End If - in next Line ???\n\nAllow the Else in a single-line If statement to be terminated by a comment instead of only EOL.\n\nPatch by: Damjan Jovanovic\nhttps://github.com/apache/openoffice/commit/07396187f6055b1e7cffa86f38cc88b274dfb1d6",
        "before_after_code_files": [
          "main/basic/source/comp/loops.cxx||main/basic/source/comp/loops.cxx"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/basic/source/comp/loops.cxx||main/basic/source/comp/loops.cxx": [
          "File: main/basic/source/comp/loops.cxx -> main/basic/source/comp/loops.cxx",
          "--- Hunk 1 ---",
          "[Context before]",
          "130:    {",
          "131:     if( !Parse() ) break;",
          "132:     eTok = Peek();",
          "134:      break;",
          "135:    }",
          "136:   }",
          "",
          "[Removed Lines]",
          "133:     if( eTok == EOLN )",
          "",
          "[Added Lines]",
          "133:     if( eTok == EOLN || eTok == REM )",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7d18142724f101f90a2eb118fd4e0b16eca32a99",
      "candidate_info": {
        "commit_hash": "7d18142724f101f90a2eb118fd4e0b16eca32a99",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/7d18142724f101f90a2eb118fd4e0b16eca32a99",
        "files": [
          "extras/l10n/source/de/localize.sdf"
        ],
        "message": "Fixed strings in German SDF",
        "before_after_code_files": [
          "extras/l10n/source/de/localize.sdf||extras/l10n/source/de/localize.sdf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "extras/l10n/source/de/localize.sdf||extras/l10n/source/de/localize.sdf": [
          "File: extras/l10n/source/de/localize.sdf -> extras/l10n/source/de/localize.sdf",
          "--- Hunk 1 ---",
          "[Context before]",
          "10685: cui source\\options\\optgdlg.src 0 checkbox OFA_TP_LANGUAGES CB_CURRENT_DOC   125 de Nur f\u00fcr das aktuelle Dokument    20130618 17:22:18",
          "10686: cui source\\options\\optgdlg.src 0 fixedline OFA_TP_LANGUAGES FL_ENHANCED   248 de Erweiterte Sprachunterst\u00fctzung    20130618 17:22:18",
          "10687: cui source\\options\\optgdlg.src 0 checkbox OFA_TP_LANGUAGES CB_ASIANSUPPORT   236 de Unterst\u00fctzung von ~asiatischen Sprachen aktiviert    20130618 17:22:18",
          "10689: cui source\\options\\optgdlg.src 0 infobox RID_SVX_MSGBOX_LANGUAGE_RESTART    260 de Die Spracheinstellung der Benutzeroberfl\u00e4che wurde ge\u00e4ndert und wird beim n\u00e4chsten Start von %PRODUCTNAME %PRODUCTVERSION wirksam    20130618 17:22:18",
          "10690: cui source\\options\\optgenrl.src 0 fixedtext RID_SFXPAGE_GENERAL FT_COMPANY   0 de ~Firma    20130618 17:22:18",
          "10691: cui source\\options\\optgenrl.src 0 fixedtext RID_SFXPAGE_GENERAL FT_NAME   0 de ~Vor-/Name/K\u00fcrzel    20130618 17:22:18",
          "",
          "[Removed Lines]",
          "10688: cui source\\options\\optgdlg.src 0 checkbox OFA_TP_LANGUAGES CB_CTLSUPPORT   236 de Unterst\u00fctzung von ~'Complex Text Layout' (CTL) aktiviert    20130618 17:22:18",
          "",
          "[Added Lines]",
          "10688: cui source\\options\\optgdlg.src 0 checkbox OFA_TP_LANGUAGES CB_CTLSUPPORT   236 de Unterst\u00fctzung von '~Complex Text Layout' (CTL) aktiviert    20130618 17:22:18",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "65060: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 fixedtext RID_PROPERTYPANEL_SWPAGE FT_ORIENTATION   0 de ~Ausrichtung    20130618 17:22:18",
          "65061: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 toolboxitem RID_PROPERTYPANEL_SWPAGE.TB_ORIENTATION TBI_ORIENTATION HID_SWPAGE_TBI_ORIENTATION  0 de Ausrichtung    20130618 17:22:18",
          "65062: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 string RID_PROPERTYPANEL_SWPAGE STR_QHELP_TB_ORIENTATION   0 de W\u00e4hlen Sie die Seitenausrichtung - vertikal (Hochformat) oder horizontal (Querformat) - f\u00fcr die aktuelle Seitenvorlage.    20130618 17:22:18",
          "65064: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 toolboxitem RID_PROPERTYPANEL_SWPAGE.TB_MARGIN TBI_MARGIN HID_SWPAGE_TBI_MARGIN  0 de Rand    20130618 17:22:18",
          "65065: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 string RID_PROPERTYPANEL_SWPAGE STR_QHELP_TB_MARGIN   0 de W\u00e4hlen sie die R\u00e4nder f\u00fcr die aktuelle Seitenvorlage    20130618 17:22:18",
          "65066: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 fixedtext RID_PROPERTYPANEL_SWPAGE FT_SIZE   0 de ~Gr\u00f6\u00dfe    20130618 17:22:18",
          "",
          "[Removed Lines]",
          "65063: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 fixedtext RID_PROPERTYPANEL_SWPAGE FT_MARGIN   0 de ~Rand:    20130618 17:22:18",
          "",
          "[Added Lines]",
          "65063: sw source\\ui\\sidebar\\PagePropertyPanel.src 0 fixedtext RID_PROPERTYPANEL_SWPAGE FT_MARGIN   0 de ~Rand    20130618 17:22:18",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f567b6ad91b52076fc4b0fd8a1ccaaa483b3091d",
      "candidate_info": {
        "commit_hash": "f567b6ad91b52076fc4b0fd8a1ccaaa483b3091d",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/f567b6ad91b52076fc4b0fd8a1ccaaa483b3091d",
        "files": [
          "main/extensions.lst"
        ],
        "message": "Updated Danish dictionary",
        "before_after_code_files": [
          "main/extensions.lst||main/extensions.lst"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/extensions.lst||main/extensions.lst": [
          "File: main/extensions.lst -> main/extensions.lst",
          "--- Hunk 1 ---",
          "[Context before]",
          "68: # Danish dictionary.",
          "69: [ language=da ]",
          "72: # Lithuanian dictionary.",
          "73: [ language=lt ]",
          "",
          "[Removed Lines]",
          "70:     1d5b284845cc66bff275085984800e39 https://sourceforge.net/projects/aoo-extensions/files/1429/10/da_dk-2.6.096.oxt/download \"dict-da_dk.oxt\"",
          "",
          "[Added Lines]",
          "70:     3e01a52f376b27cc01a44dad6fbe0cf7 https://sourceforge.net/projects/aoo-extensions/files/1429/11/da_dk-2.7.001.oxt/download \"dict-da_dk.oxt\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "746b6bc7ae13ad3795c273549dacb892726577b7",
      "candidate_info": {
        "commit_hash": "746b6bc7ae13ad3795c273549dacb892726577b7",
        "repo": "apache/openoffice",
        "commit_url": "https://github.com/apache/openoffice/commit/746b6bc7ae13ad3795c273549dacb892726577b7",
        "files": [
          "main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu"
        ],
        "message": "Fixed typo (0.5 -> Zoom 50%)",
        "before_after_code_files": [
          "main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu||main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/apache/openoffice/pull/366"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu||main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu": [
          "File: main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu -> main/officecfg/registry/data/org/openoffice/Office/UI/MathCommands.xcu",
          "--- Hunk 1 ---",
          "[Context before]",
          "165:             </node>",
          "166:             <node oor:name=\".uno:View50\" oor:op=\"replace\">",
          "167:                 <prop oor:name=\"Label\" oor:type=\"xs:string\">",
          "169:                 </prop>",
          "170:             </node>",
          "171:         </node>",
          "",
          "[Removed Lines]",
          "168:                     <value xml:lang=\"en-US\">0.5</value>",
          "",
          "[Added Lines]",
          "168:                     <value xml:lang=\"en-US\">Zoom 50%</value>",
          "",
          "---------------"
        ]
      }
    }
  ]
}