{
  "cve_id": "CVE-2024-23836",
  "cve_desc": "Suricata is a network Intrusion Detection System, Intrusion Prevention System and Network Security Monitoring engine. Prior to versions 6.0.16 and 7.0.3, an attacker can craft traffic to cause Suricata to use far more CPU and memory for processing the traffic than needed, which can lead to extreme slow downs and denial of service.  This vulnerability is patched in 6.0.16 or 7.0.3.  Workarounds include disabling the affected protocol app-layer parser in the yaml and reducing the `stream.reassembly.depth` value helps reduce the severity of the issue.",
  "repo": "OISF/suricata",
  "patch_hash": "18841a58da71e735ddf4e52cbfa6989755ecbeb7",
  "patch_info": {
    "commit_hash": "18841a58da71e735ddf4e52cbfa6989755ecbeb7",
    "repo": "OISF/suricata",
    "commit_url": "https://github.com/OISF/suricata/commit/18841a58da71e735ddf4e52cbfa6989755ecbeb7",
    "files": [
      "src/app-layer-htp.c",
      "src/app-layer-htp.h"
    ],
    "message": "http1: remove transactions from their list\n\ninstead of keeping a NULL pointer in an array\n\nTicket: #5921\n\n(cherry picked from commit 8f63a8f3bffbbaf8fae4985ee5f974ab326b08c0)",
    "before_after_code_files": [
      "src/app-layer-htp.c||src/app-layer-htp.c",
      "src/app-layer-htp.h||src/app-layer-htp.h"
    ]
  },
  "patch_diff": {
    "src/app-layer-htp.c||src/app-layer-htp.c": [
      "File: src/app-layer-htp.c -> src/app-layer-htp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "402:         uint64_t total_txs = HTPStateGetTxCnt(state);",
      "404:         if (s->conn != NULL) {",
      "406:                 htp_tx_t *tx = HTPStateGetTx(s, tx_id);",
      "407:                 if (tx != NULL) {",
      "408:                     HtpTxUserData *htud = (HtpTxUserData *) htp_tx_get_user_data(tx);",
      "",
      "[Removed Lines]",
      "405:             for (tx_id = 0; tx_id < total_txs; tx_id++) {",
      "",
      "[Added Lines]",
      "405:             for (tx_id = s->tx_freed; tx_id < total_txs; tx_id++) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "461:             tx->request_progress = HTP_REQUEST_COMPLETE;",
      "462:             tx->response_progress = HTP_RESPONSE_COMPLETE;",
      "463:         }",
      "464:         htp_tx_destroy(tx);",
      "465:     }",
      "466: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "467:     s->tx_freed += htp_connp_tx_freed(s->connp);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2976:         if (size < 0)",
      "2977:             return 0ULL;",
      "2978:         SCLogDebug(\"size %\"PRIu64, size);",
      "2980:     } else {",
      "2981:         return 0ULL;",
      "2982:     }",
      "",
      "[Removed Lines]",
      "2979:         return (uint64_t)size;",
      "",
      "[Added Lines]",
      "2981:         return (uint64_t)size + http_state->tx_freed;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2986: {",
      "2987:     HtpState *http_state = (HtpState *)alstate;",
      "2991:     else",
      "2992:         return NULL;",
      "2993: }",
      "",
      "[Removed Lines]",
      "2989:     if (http_state != NULL && http_state->conn != NULL)",
      "2990:         return htp_list_get(http_state->conn->transactions, tx_id);",
      "",
      "[Added Lines]",
      "2991:     if (http_state != NULL && http_state->conn != NULL && tx_id >= http_state->tx_freed)",
      "2992:         return htp_list_get(http_state->conn->transactions, tx_id - http_state->tx_freed);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2998:     HtpState *http_state = (HtpState *)alstate;",
      "2999:     if (http_state != NULL && http_state->conn != NULL) {",
      "3003:         }",
      "3004:     }",
      "3005:     return NULL;",
      "",
      "[Removed Lines]",
      "3000:         size_t txid = htp_list_array_size(http_state->conn->transactions);",
      "3001:         if (txid > 0) {",
      "3002:             return htp_list_get(http_state->conn->transactions, txid - 1);",
      "",
      "[Added Lines]",
      "3002:         size_t txid = HTPStateGetTxCnt(http_state);",
      "3003:         if (txid > http_state->tx_freed) {",
      "3004:             return htp_list_get(http_state->conn->transactions, txid - http_state->tx_freed - 1);",
      "",
      "---------------"
    ],
    "src/app-layer-htp.h||src/app-layer-htp.h": [
      "File: src/app-layer-htp.h -> src/app-layer-htp.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "252:     uint64_t store_tx_id;",
      "253:     FileContainer *files_ts;",
      "254:     FileContainer *files_tc;",
      "255:     const struct HTPCfgRec_ *cfg;",
      "256:     uint16_t flags;",
      "257:     uint16_t events;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "261:     uint64_t tx_freed;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8f63a8f3bffbbaf8fae4985ee5f974ab326b08c0",
      "candidate_info": {
        "commit_hash": "8f63a8f3bffbbaf8fae4985ee5f974ab326b08c0",
        "repo": "OISF/suricata",
        "commit_url": "https://github.com/OISF/suricata/commit/8f63a8f3bffbbaf8fae4985ee5f974ab326b08c0",
        "files": [
          "src/app-layer-htp-file.c",
          "src/app-layer-htp.c",
          "src/app-layer-htp.h"
        ],
        "message": "http1: remove transactions from their list\n\ninstead of keeping a NULL pointer in an array\n\nTicket: #5921",
        "before_after_code_files": [
          "src/app-layer-htp-file.c||src/app-layer-htp-file.c",
          "src/app-layer-htp.c||src/app-layer-htp.c",
          "src/app-layer-htp.h||src/app-layer-htp.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/app-layer-htp.c||src/app-layer-htp.c",
            "src/app-layer-htp.h||src/app-layer-htp.h"
          ],
          "candidate": [
            "src/app-layer-htp.c||src/app-layer-htp.c",
            "src/app-layer-htp.h||src/app-layer-htp.h"
          ]
        }
      },
      "candidate_diff": {
        "src/app-layer-htp-file.c||src/app-layer-htp-file.c": [
          "File: src/app-layer-htp-file.c -> src/app-layer-htp-file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "179:     }",
          "183:     if (!tx) {",
          "184:         SCReturnInt(-1);",
          "185:     }",
          "",
          "[Removed Lines]",
          "182:     htp_tx_t *tx = htp_list_get(s->conn->transactions, txid);",
          "",
          "[Added Lines]",
          "183:     htp_tx_t *tx = htp_list_get(s->conn->transactions, txid - s->tx_freed);",
          "",
          "---------------"
        ],
        "src/app-layer-htp.c||src/app-layer-htp.c": [
          "File: src/app-layer-htp.c -> src/app-layer-htp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "401:         uint64_t total_txs = HTPStateGetTxCnt(state);",
          "403:         if (s->conn != NULL) {",
          "405:                 htp_tx_t *tx = HTPStateGetTx(s, tx_id);",
          "406:                 if (tx != NULL) {",
          "407:                     HtpTxUserData *htud = (HtpTxUserData *) htp_tx_get_user_data(tx);",
          "",
          "[Removed Lines]",
          "404:             for (tx_id = 0; tx_id < total_txs; tx_id++) {",
          "",
          "[Added Lines]",
          "404:             for (tx_id = s->tx_freed; tx_id < total_txs; tx_id++) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "458:             tx->request_progress = HTP_REQUEST_COMPLETE;",
          "459:             tx->response_progress = HTP_RESPONSE_COMPLETE;",
          "460:         }",
          "461:         htp_tx_destroy(tx);",
          "462:     }",
          "463: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "464:     s->tx_freed += htp_connp_tx_freed(s->connp);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3076:         if (size < 0)",
          "3077:             return 0ULL;",
          "3078:         SCLogDebug(\"size %\"PRIu64, size);",
          "3080:     } else {",
          "3081:         return 0ULL;",
          "3082:     }",
          "",
          "[Removed Lines]",
          "3079:         return (uint64_t)size;",
          "",
          "[Added Lines]",
          "3081:         return (uint64_t)size + http_state->tx_freed;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3086: {",
          "3087:     HtpState *http_state = (HtpState *)alstate;",
          "3091:     else",
          "3092:         return NULL;",
          "3093: }",
          "",
          "[Removed Lines]",
          "3089:     if (http_state != NULL && http_state->conn != NULL)",
          "3090:         return htp_list_get(http_state->conn->transactions, tx_id);",
          "",
          "[Added Lines]",
          "3091:     if (http_state != NULL && http_state->conn != NULL && tx_id >= http_state->tx_freed)",
          "3092:         return htp_list_get(http_state->conn->transactions, tx_id - http_state->tx_freed);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "3098:     HtpState *http_state = (HtpState *)alstate;",
          "3099:     if (http_state != NULL && http_state->conn != NULL) {",
          "3103:         }",
          "3104:     }",
          "3105:     return NULL;",
          "",
          "[Removed Lines]",
          "3100:         size_t txid = htp_list_array_size(http_state->conn->transactions);",
          "3101:         if (txid > 0) {",
          "3102:             return htp_list_get(http_state->conn->transactions, txid - 1);",
          "",
          "[Added Lines]",
          "3102:         size_t txid = HTPStateGetTxCnt(http_state);",
          "3103:         if (txid > http_state->tx_freed) {",
          "3104:             return htp_list_get(http_state->conn->transactions, txid - http_state->tx_freed - 1);",
          "",
          "---------------"
        ],
        "src/app-layer-htp.h||src/app-layer-htp.h": [
          "File: src/app-layer-htp.h -> src/app-layer-htp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:     htp_conn_t *conn;",
          "249:     uint64_t transaction_cnt;",
          "250:     const struct HTPCfgRec_ *cfg;",
          "251:     uint16_t flags;",
          "252:     uint16_t events;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "256:     uint64_t tx_freed;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "97953998d2d60673ed6c30ddfb6a2d59b4230f97",
      "candidate_info": {
        "commit_hash": "97953998d2d60673ed6c30ddfb6a2d59b4230f97",
        "repo": "OISF/suricata",
        "commit_url": "https://github.com/OISF/suricata/commit/97953998d2d60673ed6c30ddfb6a2d59b4230f97",
        "files": [
          "src/app-layer-htp-file.c",
          "src/app-layer-htp.c",
          "src/app-layer-htp.h"
        ],
        "message": "http1: remove transactions from their list\n\ninstead of keeping a NULL pointer in an array\n\nTicket: #5921\n(cherry picked from commit 8f63a8f3bffbbaf8fae4985ee5f974ab326b08c0)",
        "before_after_code_files": [
          "src/app-layer-htp-file.c||src/app-layer-htp-file.c",
          "src/app-layer-htp.c||src/app-layer-htp.c",
          "src/app-layer-htp.h||src/app-layer-htp.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/app-layer-htp.c||src/app-layer-htp.c",
            "src/app-layer-htp.h||src/app-layer-htp.h"
          ],
          "candidate": [
            "src/app-layer-htp.c||src/app-layer-htp.c",
            "src/app-layer-htp.h||src/app-layer-htp.h"
          ]
        }
      },
      "candidate_diff": {
        "src/app-layer-htp-file.c||src/app-layer-htp-file.c": [
          "File: src/app-layer-htp-file.c -> src/app-layer-htp-file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "179:     }",
          "183:     if (!tx) {",
          "184:         SCReturnInt(-1);",
          "185:     }",
          "",
          "[Removed Lines]",
          "182:     htp_tx_t *tx = htp_list_get(s->conn->transactions, txid);",
          "",
          "[Added Lines]",
          "183:     htp_tx_t *tx = htp_list_get(s->conn->transactions, txid - s->tx_freed);",
          "",
          "---------------"
        ],
        "src/app-layer-htp.c||src/app-layer-htp.c": [
          "File: src/app-layer-htp.c -> src/app-layer-htp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "401:         uint64_t total_txs = HTPStateGetTxCnt(state);",
          "403:         if (s->conn != NULL) {",
          "405:                 htp_tx_t *tx = HTPStateGetTx(s, tx_id);",
          "406:                 if (tx != NULL) {",
          "407:                     HtpTxUserData *htud = (HtpTxUserData *) htp_tx_get_user_data(tx);",
          "",
          "[Removed Lines]",
          "404:             for (tx_id = 0; tx_id < total_txs; tx_id++) {",
          "",
          "[Added Lines]",
          "404:             for (tx_id = s->tx_freed; tx_id < total_txs; tx_id++) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "458:             tx->request_progress = HTP_REQUEST_COMPLETE;",
          "459:             tx->response_progress = HTP_RESPONSE_COMPLETE;",
          "460:         }",
          "461:         htp_tx_destroy(tx);",
          "462:     }",
          "463: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "464:     s->tx_freed += htp_connp_tx_freed(s->connp);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3077:         if (size < 0)",
          "3078:             return 0ULL;",
          "3079:         SCLogDebug(\"size %\"PRIu64, size);",
          "3081:     } else {",
          "3082:         return 0ULL;",
          "3083:     }",
          "",
          "[Removed Lines]",
          "3080:         return (uint64_t)size;",
          "",
          "[Added Lines]",
          "3082:         return (uint64_t)size + http_state->tx_freed;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3087: {",
          "3088:     HtpState *http_state = (HtpState *)alstate;",
          "3092:     else",
          "3093:         return NULL;",
          "3094: }",
          "",
          "[Removed Lines]",
          "3090:     if (http_state != NULL && http_state->conn != NULL)",
          "3091:         return htp_list_get(http_state->conn->transactions, tx_id);",
          "",
          "[Added Lines]",
          "3092:     if (http_state != NULL && http_state->conn != NULL && tx_id >= http_state->tx_freed)",
          "3093:         return htp_list_get(http_state->conn->transactions, tx_id - http_state->tx_freed);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "3099:     HtpState *http_state = (HtpState *)alstate;",
          "3100:     if (http_state != NULL && http_state->conn != NULL) {",
          "3104:         }",
          "3105:     }",
          "3106:     return NULL;",
          "",
          "[Removed Lines]",
          "3101:         size_t txid = htp_list_array_size(http_state->conn->transactions);",
          "3102:         if (txid > 0) {",
          "3103:             return htp_list_get(http_state->conn->transactions, txid - 1);",
          "",
          "[Added Lines]",
          "3103:         size_t txid = HTPStateGetTxCnt(http_state);",
          "3104:         if (txid > http_state->tx_freed) {",
          "3105:             return htp_list_get(http_state->conn->transactions, txid - http_state->tx_freed - 1);",
          "",
          "---------------"
        ],
        "src/app-layer-htp.h||src/app-layer-htp.h": [
          "File: src/app-layer-htp.h -> src/app-layer-htp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "247:     htp_conn_t *conn;",
          "249:     uint64_t transaction_cnt;",
          "250:     const struct HTPCfgRec_ *cfg;",
          "251:     uint16_t flags;",
          "252:     uint16_t events;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "256:     uint64_t tx_freed;",
          "",
          "---------------"
        ]
      }
    }
  ]
}