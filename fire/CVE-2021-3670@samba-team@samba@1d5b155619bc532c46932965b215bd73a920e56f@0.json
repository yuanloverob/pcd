{
  "cve_id": "CVE-2021-3670",
  "cve_desc": "MaxQueryDuration not honoured in Samba AD DC LDAP",
  "repo": "samba-team/samba",
  "patch_hash": "1d5b155619bc532c46932965b215bd73a920e56f",
  "patch_info": {
    "commit_hash": "1d5b155619bc532c46932965b215bd73a920e56f",
    "repo": "samba-team/samba",
    "commit_url": "https://github.com/samba-team/samba/commit/1d5b155619bc532c46932965b215bd73a920e56f",
    "files": [
      "lib/ldb/ldb_key_value/ldb_kv.c",
      "lib/ldb/ldb_key_value/ldb_kv.h",
      "lib/ldb/ldb_key_value/ldb_kv_index.c",
      "lib/ldb/ldb_key_value/ldb_kv_search.c",
      "selftest/knownfail.d/ldap-timeout"
    ],
    "message": "CVE-2021-3670 ldb: Confirm the request has not yet timed out in ldb filter processing\n\nThe LDB filter processing is where the time is spent in the LDB stack\nbut the timeout event will not get run while this is ongoing, so we\nmust confirm we have not yet timed out manually.\n\nRN: Ensure that the LDB request has not timed out during filter processing\nas the LDAP server MaxQueryDuration is otherwise not honoured.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
    "before_after_code_files": [
      "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
      "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
      "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
      "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
    ]
  },
  "patch_diff": {
    "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c": [
      "File: lib/ldb/ldb_key_value/ldb_kv.c -> lib/ldb/ldb_key_value/ldb_kv.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2078:   }",
      "2079:  }",
      "2083:  ac->spy = talloc(req, struct ldb_kv_req_spy);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2081:  ac->timeout_timeval = tv;",
      "",
      "---------------"
    ],
    "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h": [
      "File: lib/ldb/ldb_key_value/ldb_kv.h -> lib/ldb/ldb_key_value/ldb_kv.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "152:  struct ldb_module *module;",
      "153:  struct ldb_request *req;",
      "155:  bool request_terminated;",
      "156:  struct ldb_kv_req_spy *spy;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "160:  struct timeval timeout_timeval;",
      "163:  size_t timeout_counter;",
      "",
      "---------------"
    ],
    "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c": [
      "File: lib/ldb/ldb_key_value/ldb_kv_index.c -> lib/ldb/ldb_key_value/ldb_kv_index.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2352:  for (i = 0; i < num_keys; i++) {",
      "2353:   int ret;",
      "2354:   bool matched;",
      "2355:   msg = ldb_msg_new(ac);",
      "2356:   if (!msg) {",
      "2357:    talloc_free(keys);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2368:   if (i % 64 == 0) {",
      "2369:    struct timeval now = tevent_timeval_current();",
      "2370:    int timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
      "2371:          &now);",
      "2390:    if (timeval_cmp <= 0) {",
      "2391:     talloc_free(keys);",
      "2392:     return LDB_ERR_TIME_LIMIT_EXCEEDED;",
      "2393:    }",
      "2394:   }",
      "",
      "---------------"
    ],
    "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c": [
      "File: lib/ldb/ldb_key_value/ldb_kv_search.c -> lib/ldb/ldb_key_value/ldb_kv_search.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "314:  struct ldb_context *ldb;",
      "315:  struct ldb_kv_context *ac;",
      "316:  struct ldb_message *msg, *filtered_msg;",
      "318:  bool matched;",
      "320:  ac = talloc_get_type(state, struct ldb_kv_context);",
      "",
      "[Removed Lines]",
      "317:  int ret;",
      "",
      "[Added Lines]",
      "317:  struct timeval now;",
      "318:  int ret, timeval_cmp;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "341:   return 0;",
      "342:  }",
      "344:  msg = ldb_msg_new(ac);",
      "345:  if (!msg) {",
      "346:   ac->error = LDB_ERR_OPERATIONS_ERROR;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "353:  if (ac->timeout_counter++ % 64 == 0) {",
      "354:   now = tevent_timeval_current();",
      "355:   timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
      "356:            &now);",
      "369:   if (timeval_cmp <= 0) {",
      "370:    ac->error = LDB_ERR_TIME_LIMIT_EXCEEDED;",
      "371:    return -1;",
      "372:   }",
      "373:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "08c9016cb9f25105c39488770113a1b00f8a4223",
      "candidate_info": {
        "commit_hash": "08c9016cb9f25105c39488770113a1b00f8a4223",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/08c9016cb9f25105c39488770113a1b00f8a4223",
        "files": [
          "lib/ldb/ldb_key_value/ldb_kv.c",
          "lib/ldb/ldb_key_value/ldb_kv.h",
          "lib/ldb/ldb_key_value/ldb_kv_index.c",
          "lib/ldb/ldb_key_value/ldb_kv_search.c",
          "selftest/knownfail.d/ldap-timeout"
        ],
        "message": "CVE-2021-3670 ldb: Confirm the request has not yet timed out in ldb filter processing\n\nThe LDB filter processing is where the time is spent in the LDB stack\nbut the timeout event will not get run while this is ongoing, so we\nmust confirm we have not yet timed out manually.\n\nRN: Ensure that the LDB request has not timed out during filter processing\nas the LDAP server MaxQueryDuration is otherwise not honoured.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>\n(cherry picked from commit 1d5b155619bc532c46932965b215bd73a920e56f)",
        "before_after_code_files": [
          "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
          "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
          "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
          "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
            "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
            "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
            "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
          ],
          "candidate": [
            "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
            "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
            "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
            "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
          ]
        }
      },
      "candidate_diff": {
        "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv.c -> lib/ldb/ldb_key_value/ldb_kv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2078:   }",
          "2079:  }",
          "2083:  ac->spy = talloc(req, struct ldb_kv_req_spy);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2081:  ac->timeout_timeval = tv;",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h": [
          "File: lib/ldb/ldb_key_value/ldb_kv.h -> lib/ldb/ldb_key_value/ldb_kv.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:  struct ldb_module *module;",
          "153:  struct ldb_request *req;",
          "155:  bool request_terminated;",
          "156:  struct ldb_kv_req_spy *spy;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "160:  struct timeval timeout_timeval;",
          "163:  size_t timeout_counter;",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv_index.c -> lib/ldb/ldb_key_value/ldb_kv_index.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2352:  for (i = 0; i < num_keys; i++) {",
          "2353:   int ret;",
          "2354:   bool matched;",
          "2355:   msg = ldb_msg_new(ac);",
          "2356:   if (!msg) {",
          "2357:    talloc_free(keys);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2368:   if (i % 64 == 0) {",
          "2369:    struct timeval now = tevent_timeval_current();",
          "2370:    int timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
          "2371:          &now);",
          "2390:    if (timeval_cmp <= 0) {",
          "2391:     talloc_free(keys);",
          "2392:     return LDB_ERR_TIME_LIMIT_EXCEEDED;",
          "2393:    }",
          "2394:   }",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv_search.c -> lib/ldb/ldb_key_value/ldb_kv_search.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "314:  struct ldb_context *ldb;",
          "315:  struct ldb_kv_context *ac;",
          "316:  struct ldb_message *msg, *filtered_msg;",
          "318:  bool matched;",
          "320:  ac = talloc_get_type(state, struct ldb_kv_context);",
          "",
          "[Removed Lines]",
          "317:  int ret;",
          "",
          "[Added Lines]",
          "317:  struct timeval now;",
          "318:  int ret, timeval_cmp;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "341:   return 0;",
          "342:  }",
          "344:  msg = ldb_msg_new(ac);",
          "345:  if (!msg) {",
          "346:   ac->error = LDB_ERR_OPERATIONS_ERROR;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "353:  if (ac->timeout_counter++ % 64 == 0) {",
          "354:   now = tevent_timeval_current();",
          "355:   timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
          "356:            &now);",
          "369:   if (timeval_cmp <= 0) {",
          "370:    ac->error = LDB_ERR_TIME_LIMIT_EXCEEDED;",
          "371:    return -1;",
          "372:   }",
          "373:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4f1dbaf60b83967a0f60464ec4f803271e9915f1",
      "candidate_info": {
        "commit_hash": "4f1dbaf60b83967a0f60464ec4f803271e9915f1",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/4f1dbaf60b83967a0f60464ec4f803271e9915f1",
        "files": [
          "lib/ldb/ldb_key_value/ldb_kv.c",
          "lib/ldb/ldb_key_value/ldb_kv.h",
          "lib/ldb/ldb_key_value/ldb_kv_index.c",
          "lib/ldb/ldb_key_value/ldb_kv_search.c",
          "selftest/knownfail.d/ldap-timeout"
        ],
        "message": "CVE-2021-3670 ldb: Confirm the request has not yet timed out in ldb filter processing\n\nThe LDB filter processing is where the time is spent in the LDB stack\nbut the timeout event will not get run while this is ongoing, so we\nmust confirm we have not yet timed out manually.\n\nRN: Ensure that the LDB request has not timed out during filter processing\nas the LDAP server MaxQueryDuration is otherwise not honoured.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14694\n\nSigned-off-by: Andrew Bartlett <abartlet@samba.org>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>\n(cherry picked from commit 1d5b155619bc532c46932965b215bd73a920e56f)",
        "before_after_code_files": [
          "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
          "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
          "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
          "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
            "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
            "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
            "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
          ],
          "candidate": [
            "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c",
            "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h",
            "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c",
            "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c"
          ]
        }
      },
      "candidate_diff": {
        "lib/ldb/ldb_key_value/ldb_kv.c||lib/ldb/ldb_key_value/ldb_kv.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv.c -> lib/ldb/ldb_key_value/ldb_kv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2078:   }",
          "2079:  }",
          "2083:  ac->spy = talloc(req, struct ldb_kv_req_spy);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2081:  ac->timeout_timeval = tv;",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv.h||lib/ldb/ldb_key_value/ldb_kv.h": [
          "File: lib/ldb/ldb_key_value/ldb_kv.h -> lib/ldb/ldb_key_value/ldb_kv.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:  struct ldb_module *module;",
          "153:  struct ldb_request *req;",
          "155:  bool request_terminated;",
          "156:  struct ldb_kv_req_spy *spy;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "160:  struct timeval timeout_timeval;",
          "163:  size_t timeout_counter;",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv_index.c||lib/ldb/ldb_key_value/ldb_kv_index.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv_index.c -> lib/ldb/ldb_key_value/ldb_kv_index.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2352:  for (i = 0; i < num_keys; i++) {",
          "2353:   int ret;",
          "2354:   bool matched;",
          "2355:   msg = ldb_msg_new(ac);",
          "2356:   if (!msg) {",
          "2357:    talloc_free(keys);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2368:   if (i % 64 == 0) {",
          "2369:    struct timeval now = tevent_timeval_current();",
          "2370:    int timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
          "2371:          &now);",
          "2390:    if (timeval_cmp <= 0) {",
          "2391:     talloc_free(keys);",
          "2392:     return LDB_ERR_TIME_LIMIT_EXCEEDED;",
          "2393:    }",
          "2394:   }",
          "",
          "---------------"
        ],
        "lib/ldb/ldb_key_value/ldb_kv_search.c||lib/ldb/ldb_key_value/ldb_kv_search.c": [
          "File: lib/ldb/ldb_key_value/ldb_kv_search.c -> lib/ldb/ldb_key_value/ldb_kv_search.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "314:  struct ldb_context *ldb;",
          "315:  struct ldb_kv_context *ac;",
          "316:  struct ldb_message *msg, *filtered_msg;",
          "318:  bool matched;",
          "320:  ac = talloc_get_type(state, struct ldb_kv_context);",
          "",
          "[Removed Lines]",
          "317:  int ret;",
          "",
          "[Added Lines]",
          "317:  struct timeval now;",
          "318:  int ret, timeval_cmp;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "341:   return 0;",
          "342:  }",
          "344:  msg = ldb_msg_new(ac);",
          "345:  if (!msg) {",
          "346:   ac->error = LDB_ERR_OPERATIONS_ERROR;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "353:  if (ac->timeout_counter++ % 64 == 0) {",
          "354:   now = tevent_timeval_current();",
          "355:   timeval_cmp = tevent_timeval_compare(&ac->timeout_timeval,",
          "356:            &now);",
          "369:   if (timeval_cmp <= 0) {",
          "370:    ac->error = LDB_ERR_TIME_LIMIT_EXCEEDED;",
          "371:    return -1;",
          "372:   }",
          "373:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}