{
  "cve_id": "CVE-2019-15523",
  "cve_desc": "An issue was discovered in LINBIT csync2 through 2.0. It does not correctly check for the return value GNUTLS_E_WARNING_ALERT_RECEIVED of the gnutls_handshake() function. It neglects to call this function again, as required by the design of the API.",
  "repo": "LINBIT/csync2",
  "patch_hash": "92742544a56bcbcd9ec99ca15f898b31797e39e2",
  "patch_info": {
    "commit_hash": "92742544a56bcbcd9ec99ca15f898b31797e39e2",
    "repo": "LINBIT/csync2",
    "commit_url": "https://github.com/LINBIT/csync2/pull/13/commits/92742544a56bcbcd9ec99ca15f898b31797e39e2",
    "files": [
      "conn.c"
    ],
    "message": "repeat gnutls_handshake() call in case of warnings\n\nthat's what the semantics of this call require",
    "before_after_code_files": [
      "conn.c||conn.c"
    ]
  },
  "patch_diff": {
    "conn.c||conn.c": [
      "File: conn.c -> conn.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "276:  char *ssl_keyfile;",
      "277:  char *ssl_certfile;",
      "278:  int err;",
      "280:  if (csync_conn_usessl)",
      "281:   return 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "279:  int handshake_repeat = 0;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "333:   (gnutls_transport_ptr_t)(long)conn_fd_out",
      "334:  );",
      "371:  csync_conn_usessl = 1;",
      "",
      "[Removed Lines]",
      "336:  err = gnutls_handshake(conn_tls_session);",
      "337:  switch(err) {",
      "338:  case GNUTLS_E_SUCCESS:",
      "339:   break;",
      "341:  case GNUTLS_E_WARNING_ALERT_RECEIVED:",
      "342:   alrt = gnutls_alert_get(conn_tls_session);",
      "343:   fprintf(",
      "344:    csync_debug_out,",
      "345:    \"SSL: warning alert received from peer: %d (%s).\\n\",",
      "346:    alrt, gnutls_alert_get_name(alrt)",
      "347:   );",
      "348:   break;",
      "350:  case GNUTLS_E_FATAL_ALERT_RECEIVED:",
      "351:   alrt = gnutls_alert_get(conn_tls_session);",
      "352:   fprintf(",
      "353:    csync_debug_out,",
      "354:    \"SSL: fatal alert received from peer: %d (%s).\\n\",",
      "355:    alrt, gnutls_alert_get_name(alrt)",
      "356:   );",
      "358:  default:",
      "359:   gnutls_bye(conn_tls_session, GNUTLS_SHUT_RDWR);",
      "360:   gnutls_deinit(conn_tls_session);",
      "361:   gnutls_certificate_free_credentials(conn_x509_cred);",
      "362:   gnutls_global_deinit();",
      "364:   csync_fatal(",
      "365:    \"SSL: handshake failed: %s (%s)\\n\",",
      "366:    gnutls_strerror(err),",
      "367:    gnutls_strerror_name(err)",
      "368:   );",
      "369:  }",
      "",
      "[Added Lines]",
      "338:  do {",
      "339:   handshake_repeat = 0;",
      "340:   err = gnutls_handshake(conn_tls_session);",
      "341:   switch(err) {",
      "342:   case GNUTLS_E_SUCCESS:",
      "343:    break;",
      "345:   case GNUTLS_E_WARNING_ALERT_RECEIVED:",
      "346:    alrt = gnutls_alert_get(conn_tls_session);",
      "347:    fprintf(",
      "348:     csync_debug_out,",
      "349:     \"SSL: warning alert received from peer: %d (%s).\\n\",",
      "350:     alrt, gnutls_alert_get_name(alrt)",
      "351:    );",
      "352:    handshake_repeat = 1;",
      "353:    break;",
      "355:   case GNUTLS_E_FATAL_ALERT_RECEIVED:",
      "356:    alrt = gnutls_alert_get(conn_tls_session);",
      "357:    fprintf(",
      "358:     csync_debug_out,",
      "359:     \"SSL: fatal alert received from peer: %d (%s).\\n\",",
      "360:     alrt, gnutls_alert_get_name(alrt)",
      "361:    );",
      "364:   default:",
      "365:    gnutls_bye(conn_tls_session, GNUTLS_SHUT_RDWR);",
      "366:    gnutls_deinit(conn_tls_session);",
      "367:    gnutls_certificate_free_credentials(conn_x509_cred);",
      "368:    gnutls_global_deinit();",
      "370:    csync_fatal(",
      "371:     \"SSL: handshake failed: %s (%s)\\n\",",
      "372:     gnutls_strerror(err),",
      "373:     gnutls_strerror_name(err)",
      "374:    );",
      "375:   }",
      "376:  } while (handshake_repeat);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c0faaf9dda0c8301d46c2145a0bbaccf3de8bb14",
      "candidate_info": {
        "commit_hash": "c0faaf9dda0c8301d46c2145a0bbaccf3de8bb14",
        "repo": "LINBIT/csync2",
        "commit_url": "https://github.com/LINBIT/csync2/commit/c0faaf9dda0c8301d46c2145a0bbaccf3de8bb14",
        "files": [
          "conn.c"
        ],
        "message": "repeat gnutls_handshake() call in case of warnings\n\nthat's what the semantics of this call require",
        "before_after_code_files": [
          "conn.c||conn.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "conn.c||conn.c"
          ],
          "candidate": [
            "conn.c||conn.c"
          ]
        }
      },
      "candidate_diff": {
        "conn.c||conn.c": [
          "File: conn.c -> conn.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "276:  char *ssl_keyfile;",
          "277:  char *ssl_certfile;",
          "278:  int err;",
          "280:  if (csync_conn_usessl)",
          "281:   return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "279:  int handshake_repeat = 0;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "333:   (gnutls_transport_ptr_t)(long)conn_fd_out",
          "334:  );",
          "371:  csync_conn_usessl = 1;",
          "",
          "[Removed Lines]",
          "336:  err = gnutls_handshake(conn_tls_session);",
          "337:  switch(err) {",
          "338:  case GNUTLS_E_SUCCESS:",
          "339:   break;",
          "341:  case GNUTLS_E_WARNING_ALERT_RECEIVED:",
          "342:   alrt = gnutls_alert_get(conn_tls_session);",
          "343:   fprintf(",
          "344:    csync_debug_out,",
          "345:    \"SSL: warning alert received from peer: %d (%s).\\n\",",
          "346:    alrt, gnutls_alert_get_name(alrt)",
          "347:   );",
          "348:   break;",
          "350:  case GNUTLS_E_FATAL_ALERT_RECEIVED:",
          "351:   alrt = gnutls_alert_get(conn_tls_session);",
          "352:   fprintf(",
          "353:    csync_debug_out,",
          "354:    \"SSL: fatal alert received from peer: %d (%s).\\n\",",
          "355:    alrt, gnutls_alert_get_name(alrt)",
          "356:   );",
          "358:  default:",
          "359:   gnutls_bye(conn_tls_session, GNUTLS_SHUT_RDWR);",
          "360:   gnutls_deinit(conn_tls_session);",
          "361:   gnutls_certificate_free_credentials(conn_x509_cred);",
          "362:   gnutls_global_deinit();",
          "364:   csync_fatal(",
          "365:    \"SSL: handshake failed: %s (%s)\\n\",",
          "366:    gnutls_strerror(err),",
          "367:    gnutls_strerror_name(err)",
          "368:   );",
          "369:  }",
          "",
          "[Added Lines]",
          "338:  do {",
          "339:   handshake_repeat = 0;",
          "340:   err = gnutls_handshake(conn_tls_session);",
          "341:   switch(err) {",
          "342:   case GNUTLS_E_SUCCESS:",
          "343:    break;",
          "345:   case GNUTLS_E_WARNING_ALERT_RECEIVED:",
          "346:    alrt = gnutls_alert_get(conn_tls_session);",
          "347:    fprintf(",
          "348:     csync_debug_out,",
          "349:     \"SSL: warning alert received from peer: %d (%s).\\n\",",
          "350:     alrt, gnutls_alert_get_name(alrt)",
          "351:    );",
          "352:    handshake_repeat = 1;",
          "353:    break;",
          "355:   case GNUTLS_E_FATAL_ALERT_RECEIVED:",
          "356:    alrt = gnutls_alert_get(conn_tls_session);",
          "357:    fprintf(",
          "358:     csync_debug_out,",
          "359:     \"SSL: fatal alert received from peer: %d (%s).\\n\",",
          "360:     alrt, gnutls_alert_get_name(alrt)",
          "361:    );",
          "364:   default:",
          "365:    gnutls_bye(conn_tls_session, GNUTLS_SHUT_RDWR);",
          "366:    gnutls_deinit(conn_tls_session);",
          "367:    gnutls_certificate_free_credentials(conn_x509_cred);",
          "368:    gnutls_global_deinit();",
          "370:    csync_fatal(",
          "371:     \"SSL: handshake failed: %s (%s)\\n\",",
          "372:     gnutls_strerror(err),",
          "373:     gnutls_strerror_name(err)",
          "374:    );",
          "375:   }",
          "376:  } while (handshake_repeat);",
          "",
          "---------------"
        ]
      }
    }
  ]
}