{
  "cve_id": "CVE-2024-32462",
  "cve_desc": "Flatpak is a system for building, distributing, and running sandboxed desktop applications on Linux. in versions before 1.10.9, 1.12.9, 1.14.6, and 1.15.8, a malicious or compromised Flatpak app could execute arbitrary code outside its sandbox. Normally, the `--command` argument of `flatpak run` expects to be given a command to run in the specified Flatpak app, optionally along with some arguments. However it is possible to instead pass `bwrap` arguments to `--command=`, such as `--bind`. It's possible to pass an arbitrary `commandline` to the portal interface `org.freedesktop.portal.Background.RequestBackground` from within a Flatpak app. When this is converted into a `--command` and arguments, it achieves the same effect of passing arguments directly to `bwrap`, and thus can be used for a sandbox escape. The solution is to pass the `--` argument to `bwrap`, which makes it stop processing options. This has been supported since bubblewrap 0.3.0. All supported versions of Flatpak require at least that version of bubblewrap. xdg-desktop-portal version 1.18.4 will mitigate this vulnerability by only allowing Flatpak apps to create .desktop files for commands that do not start with --. The vulnerability is patched in 1.15.8, 1.10.9, 1.12.9, and 1.14.6.",
  "repo": "flatpak/flatpak",
  "patch_hash": "b7c1a558e58aaeb1d007d29529bbb270dc4ff11e",
  "patch_info": {
    "commit_hash": "b7c1a558e58aaeb1d007d29529bbb270dc4ff11e",
    "repo": "flatpak/flatpak",
    "commit_url": "https://github.com/flatpak/flatpak/commit/b7c1a558e58aaeb1d007d29529bbb270dc4ff11e",
    "files": [
      "app/flatpak-builtins-build.c",
      "common/flatpak-dir.c",
      "common/flatpak-run.c"
    ],
    "message": "When starting non-static command using bwrap use \"--\"\n\nThis ensures that the command is not taken to be a bwrap option.\n\nResolves: CVE-2024-32462\nResolves: GHSA-phv6-cpc2-2fgj\nSigned-off-by: Alexander Larsson <alexl@redhat.com>\n[smcv: Fix DISABLE_SANDBOXED_TRIGGERS code path]\n[smcv: Make flatpak_run_maybe_start_dbus_proxy() more obviously correct]\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
    "before_after_code_files": [
      "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
      "common/flatpak-dir.c||common/flatpak-dir.c",
      "common/flatpak-run.c||common/flatpak-run.c"
    ]
  },
  "patch_diff": {
    "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c": [
      "File: app/flatpak-builtins-build.c -> app/flatpak-builtins-build.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "587:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
      "588:     return FALSE;",
      "591:   flatpak_bwrap_append_argsv (bwrap,",
      "592:                               &argv[rest_argv_start + 2],",
      "593:                               rest_argc - 2);",
      "",
      "[Removed Lines]",
      "590:   flatpak_bwrap_add_args (bwrap, command, NULL);",
      "",
      "[Added Lines]",
      "590:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
      "",
      "---------------"
    ],
    "common/flatpak-dir.c||common/flatpak-dir.c": [
      "File: common/flatpak-dir.c -> common/flatpak-dir.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "7071:                                   \"--proc\", \"/proc\",",
      "7072:                                   \"--dev\", \"/dev\",",
      "7073:                                   \"--bind\", basedir, basedir,",
      "7074:                                   NULL);",
      "7075: #endif",
      "7076:           flatpak_bwrap_add_args (bwrap,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7074:                                   \"--\",",
      "",
      "---------------"
    ],
    "common/flatpak-run.c||common/flatpak-run.c": [
      "File: common/flatpak-run.c -> common/flatpak-run.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1299:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
      "1300:     return FALSE;",
      "1302:   return TRUE;",
      "1303: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1303:   flatpak_bwrap_add_arg (bwrap, \"--\");",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "4682:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
      "4683:     return FALSE;",
      "4687:   if (!add_rest_args (bwrap, app_id,",
      "4688:                       exports, (flags & FLATPAK_RUN_FLAG_FILE_FORWARDING) != 0,",
      "",
      "[Removed Lines]",
      "4685:   flatpak_bwrap_add_arg (bwrap, command);",
      "",
      "[Added Lines]",
      "4688:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bbab7ed1e672356d1a78b422462b210e8e875931",
      "candidate_info": {
        "commit_hash": "bbab7ed1e672356d1a78b422462b210e8e875931",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/bbab7ed1e672356d1a78b422462b210e8e875931",
        "files": [
          "app/flatpak-builtins-build.c",
          "common/flatpak-dir.c",
          "common/flatpak-run-dbus.c",
          "common/flatpak-run.c"
        ],
        "message": "When starting non-static command using bwrap use \"--\"\n\nThis ensures that the command is not taken to be a bwrap option.\n\nResolves: CVE-2024-32462\nResolves: GHSA-phv6-cpc2-2fgj\nSigned-off-by: Alexander Larsson <alexl@redhat.com>\n[smcv: Fix DISABLE_SANDBOXED_TRIGGERS code path]\n[smcv: Make flatpak_run_maybe_start_dbus_proxy() more obviously correct]\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
        "before_after_code_files": [
          "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
          "common/flatpak-dir.c||common/flatpak-dir.c",
          "common/flatpak-run-dbus.c||common/flatpak-run-dbus.c",
          "common/flatpak-run.c||common/flatpak-run.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ],
          "candidate": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ]
        }
      },
      "candidate_diff": {
        "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c": [
          "File: app/flatpak-builtins-build.c -> app/flatpak-builtins-build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "589:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "590:     return FALSE;",
          "593:   flatpak_bwrap_append_argsv (bwrap,",
          "594:                               &argv[rest_argv_start + 2],",
          "595:                               rest_argc - 2);",
          "",
          "[Removed Lines]",
          "592:   flatpak_bwrap_add_args (bwrap, command, NULL);",
          "",
          "[Added Lines]",
          "592:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ],
        "common/flatpak-dir.c||common/flatpak-dir.c": [
          "File: common/flatpak-dir.c -> common/flatpak-dir.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "7155:                                   \"--proc\", \"/proc\",",
          "7156:                                   \"--dev\", \"/dev\",",
          "7157:                                   \"--bind\", basedir, basedir,",
          "7158:                                   NULL);",
          "7159: #endif",
          "7160:           flatpak_bwrap_add_args (bwrap,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7158:                                   \"--\",",
          "",
          "---------------"
        ],
        "common/flatpak-run-dbus.c||common/flatpak-run-dbus.c": [
          "File: common/flatpak-run-dbus.c -> common/flatpak-run-dbus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "105:     return FALSE;",
          "107:   return TRUE;",
          "108: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "108:   flatpak_bwrap_add_arg (bwrap, \"--\");",
          "",
          "---------------"
        ],
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3425:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "3426:     return FALSE;",
          "3430:   if (!add_rest_args (bwrap, app_id,",
          "3431:                       exports, (flags & FLATPAK_RUN_FLAG_FILE_FORWARDING) != 0,",
          "",
          "[Removed Lines]",
          "3428:   flatpak_bwrap_add_arg (bwrap, command);",
          "",
          "[Added Lines]",
          "3428:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81abe2a37d363f5099c3d0bdcd0caad6efc5bf97",
      "candidate_info": {
        "commit_hash": "81abe2a37d363f5099c3d0bdcd0caad6efc5bf97",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/81abe2a37d363f5099c3d0bdcd0caad6efc5bf97",
        "files": [
          "app/flatpak-builtins-build.c",
          "common/flatpak-dir.c",
          "common/flatpak-run.c"
        ],
        "message": "When starting non-static command using bwrap use \"--\"\n\nThis ensures that the command is not taken to be a bwrap option.\n\nResolves: CVE-2024-32462\nResolves: GHSA-phv6-cpc2-2fgj\nSigned-off-by: Alexander Larsson <alexl@redhat.com>\n[smcv: Fix DISABLE_SANDBOXED_TRIGGERS code path]\n[smcv: Make flatpak_run_maybe_start_dbus_proxy() more obviously correct]\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
        "before_after_code_files": [
          "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
          "common/flatpak-dir.c||common/flatpak-dir.c",
          "common/flatpak-run.c||common/flatpak-run.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ],
          "candidate": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ]
        }
      },
      "candidate_diff": {
        "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c": [
          "File: app/flatpak-builtins-build.c -> app/flatpak-builtins-build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "587:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "588:     return FALSE;",
          "591:   flatpak_bwrap_append_argsv (bwrap,",
          "592:                               &argv[rest_argv_start + 2],",
          "593:                               rest_argc - 2);",
          "",
          "[Removed Lines]",
          "590:   flatpak_bwrap_add_args (bwrap, command, NULL);",
          "",
          "[Added Lines]",
          "590:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ],
        "common/flatpak-dir.c||common/flatpak-dir.c": [
          "File: common/flatpak-dir.c -> common/flatpak-dir.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6817:                                   \"--proc\", \"/proc\",",
          "6818:                                   \"--dev\", \"/dev\",",
          "6819:                                   \"--bind\", basedir, basedir,",
          "6820:                                   NULL);",
          "6821: #endif",
          "6822:           flatpak_bwrap_add_args (bwrap,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6820:                                   \"--\",",
          "",
          "---------------"
        ],
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1266:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "1267:     return FALSE;",
          "1269:   return TRUE;",
          "1270: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1270:   flatpak_bwrap_add_arg (bwrap, \"--\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4635:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "4636:     return FALSE;",
          "4640:   if (!add_rest_args (bwrap, app_id,",
          "4641:                       exports, (flags & FLATPAK_RUN_FLAG_FILE_FORWARDING) != 0,",
          "",
          "[Removed Lines]",
          "4638:   flatpak_bwrap_add_arg (bwrap, command);",
          "",
          "[Added Lines]",
          "4641:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "72016e3fce8fcbeab707daf4f1a02b931fcc004d",
      "candidate_info": {
        "commit_hash": "72016e3fce8fcbeab707daf4f1a02b931fcc004d",
        "repo": "flatpak/flatpak",
        "commit_url": "https://github.com/flatpak/flatpak/commit/72016e3fce8fcbeab707daf4f1a02b931fcc004d",
        "files": [
          "app/flatpak-builtins-build.c",
          "common/flatpak-dir.c",
          "common/flatpak-run.c"
        ],
        "message": "When starting non-static command using bwrap use \"--\"\n\nThis ensures that the command is not taken to be a bwrap option.\n\nResolves: CVE-2024-32462\nResolves: GHSA-phv6-cpc2-2fgj\nSigned-off-by: Alexander Larsson <alexl@redhat.com>\n[smcv: Fix DISABLE_SANDBOXED_TRIGGERS code path]\n[smcv: Make flatpak_run_maybe_start_dbus_proxy() more obviously correct]\nSigned-off-by: Simon McVittie <smcv@collabora.com>",
        "before_after_code_files": [
          "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
          "common/flatpak-dir.c||common/flatpak-dir.c",
          "common/flatpak-run.c||common/flatpak-run.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ],
          "candidate": [
            "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c",
            "common/flatpak-dir.c||common/flatpak-dir.c",
            "common/flatpak-run.c||common/flatpak-run.c"
          ]
        }
      },
      "candidate_diff": {
        "app/flatpak-builtins-build.c||app/flatpak-builtins-build.c": [
          "File: app/flatpak-builtins-build.c -> app/flatpak-builtins-build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "576:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "577:     return FALSE;",
          "580:   flatpak_bwrap_append_argsv (bwrap,",
          "581:                               &argv[rest_argv_start + 2],",
          "582:                               rest_argc - 2);",
          "",
          "[Removed Lines]",
          "579:   flatpak_bwrap_add_args (bwrap, command, NULL);",
          "",
          "[Added Lines]",
          "579:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ],
        "common/flatpak-dir.c||common/flatpak-dir.c": [
          "File: common/flatpak-dir.c -> common/flatpak-dir.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6653:                                   \"--proc\", \"/proc\",",
          "6654:                                   \"--dev\", \"/dev\",",
          "6655:                                   \"--bind\", basedir, basedir,",
          "6656:                                   NULL);",
          "6657: #endif",
          "6658:           flatpak_bwrap_add_args (bwrap,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6656:                                   \"--\",",
          "",
          "---------------"
        ],
        "common/flatpak-run.c||common/flatpak-run.c": [
          "File: common/flatpak-run.c -> common/flatpak-run.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1082:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "1083:     return FALSE;",
          "1085:   return TRUE;",
          "1086: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1086:   flatpak_bwrap_add_arg (bwrap, \"--\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4175:   if (!flatpak_bwrap_bundle_args (bwrap, 1, -1, FALSE, error))",
          "4176:     return FALSE;",
          "4180:   if (!add_rest_args (bwrap, app_id,",
          "4181:                       exports, (flags & FLATPAK_RUN_FLAG_FILE_FORWARDING) != 0,",
          "",
          "[Removed Lines]",
          "4178:   flatpak_bwrap_add_arg (bwrap, command);",
          "",
          "[Added Lines]",
          "4181:   flatpak_bwrap_add_args (bwrap, \"--\", command, NULL);",
          "",
          "---------------"
        ]
      }
    }
  ]
}