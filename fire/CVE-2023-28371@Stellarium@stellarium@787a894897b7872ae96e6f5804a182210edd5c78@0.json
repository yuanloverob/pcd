{
  "cve_id": "CVE-2023-28371",
  "cve_desc": "In Stellarium through 1.2, attackers can write to files that are typically unintended, such as ones with absolute pathnames or .. directory traversal.",
  "repo": "Stellarium/stellarium",
  "patch_hash": "787a894897b7872ae96e6f5804a182210edd5c78",
  "patch_info": {
    "commit_hash": "787a894897b7872ae96e6f5804a182210edd5c78",
    "repo": "Stellarium/stellarium",
    "commit_url": "https://github.com/Stellarium/stellarium/commit/787a894897b7872ae96e6f5804a182210edd5c78",
    "files": [
      "guide/app_config_ini.tex",
      "src/scripting/StelScriptMgr.cpp"
    ],
    "message": "Fix a possible security issue - Require manually set flag to run scripts from absolute pathname - Mostly applies to scripts given on the command line",
    "before_after_code_files": [
      "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp"
    ]
  },
  "patch_diff": {
    "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp": [
      "File: src/scripting/StelScriptMgr.cpp -> src/scripting/StelScriptMgr.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "794: bool StelScriptMgr::runScript(const QString& fileName, const QString& includePath)",
      "795: {",
      "796:  QString preprocessedScript;",
      "799: }",
      "801: bool StelScriptMgr::runScriptDirect(const QString scriptId, const QString &scriptCode, int &errLoc, const QString& includePath)",
      "",
      "[Removed Lines]",
      "797:  prepareScript(preprocessedScript,fileName,includePath);",
      "798:  return runPreprocessedScript(preprocessedScript,fileName);",
      "",
      "[Added Lines]",
      "797:  if (prepareScript(preprocessedScript,fileName,includePath))",
      "798:   return runPreprocessedScript(preprocessedScript,fileName);",
      "799:  else",
      "800:   return false;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "820: bool StelScriptMgr::prepareScript( QString &script, const QString &fileName, const QString &includePath)",
      "821: {",
      "822:  QString absPath;",
      "824:  if (QFileInfo(fileName).isAbsolute())",
      "826:  else",
      "827:   absPath = StelFileMgr::findFile(\"scripts/\" + fileName);",
      "",
      "[Removed Lines]",
      "825:   absPath = fileName;",
      "",
      "[Added Lines]",
      "825:  const bool okToRunScriptFromAbsolutePath=StelApp::getInstance().getSettings()->value(\"scripts/flag_script_allow_absolute_path\", false).toBool();",
      "828:  {",
      "830:   if (okToRunScriptFromAbsolutePath)",
      "831:    absPath = fileName;",
      "832:   else",
      "833:   {",
      "834:    qWarning() << \"SCRIPTING CONFIGURATION ISSUE: You are trying to run a script from absolute pathname.\";",
      "835:    qWarning() << \"  To enable this, edit config.ini and set [scripts]/flag_script_allow_absolute_path=true\";",
      "836:    return false;",
      "837:   }",
      "838:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7bf6f6dcf4d24b7bcd08caf0f34f1baaea5def13",
      "candidate_info": {
        "commit_hash": "7bf6f6dcf4d24b7bcd08caf0f34f1baaea5def13",
        "repo": "Stellarium/stellarium",
        "commit_url": "https://github.com/Stellarium/stellarium/commit/7bf6f6dcf4d24b7bcd08caf0f34f1baaea5def13",
        "files": [
          "guide/app_config_ini.tex",
          "src/scripting/StelScriptMgr.cpp"
        ],
        "message": "Re-allow scripts from any path. (Revert part of 787a894897b7872ae96e6f5804a182210edd5c78) - discussed in #3111",
        "before_after_code_files": [
          "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp"
          ],
          "candidate": [
            "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp"
          ]
        }
      },
      "candidate_diff": {
        "src/scripting/StelScriptMgr.cpp||src/scripting/StelScriptMgr.cpp": [
          "File: src/scripting/StelScriptMgr.cpp -> src/scripting/StelScriptMgr.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "825: bool StelScriptMgr::prepareScript( QString &script, const QString &fileName, const QString &includePath)",
          "826: {",
          "827:  QString absPath;",
          "830:  if (QFileInfo(fileName).isAbsolute())",
          "842:  else",
          "843:   absPath = StelFileMgr::findFile(\"scripts/\" + fileName);",
          "",
          "[Removed Lines]",
          "828:  const bool okToRunScriptFromAbsolutePath=StelApp::getInstance().getSettings()->value(\"scripts/flag_script_allow_absolute_path\", false).toBool();",
          "831:  {",
          "833:   if (okToRunScriptFromAbsolutePath)",
          "834:    absPath = fileName;",
          "835:   else",
          "836:   {",
          "837:    qWarning() << \"SCRIPTING CONFIGURATION ISSUE: You are trying to run a script from absolute pathname.\";",
          "838:    qWarning() << \"  To enable this, edit config.ini and set [scripts]/flag_script_allow_absolute_path=true\";",
          "839:    return false;",
          "840:   }",
          "841:  }",
          "",
          "[Added Lines]",
          "830:   absPath = fileName;",
          "",
          "---------------"
        ]
      }
    }
  ]
}