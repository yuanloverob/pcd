{
  "cve_id": "CVE-2022-35991",
  "cve_desc": "TensorFlow is an open source platform for machine learning. When `TensorListScatter` and `TensorListScatterV2` receive an `element_shape` of a rank greater than one, they give a `CHECK` fail that can trigger a denial of service attack. We have patched the issue in GitHub commit bb03fdf4aae944ab2e4b35c7daa051068a8b7f61. The fix will be included in TensorFlow 2.10.0. We will also cherrypick this commit on TensorFlow 2.9.1, TensorFlow 2.8.1, and TensorFlow 2.7.2, as these are also affected and still in supported range. There are no known workarounds for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "bb03fdf4aae944ab2e4b35c7daa051068a8b7f61",
  "patch_info": {
    "commit_hash": "bb03fdf4aae944ab2e4b35c7daa051068a8b7f61",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/bb03fdf4aae944ab2e4b35c7daa051068a8b7f61",
    "files": [
      "tensorflow/core/kernels/list_kernels.h",
      "tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
    ],
    "message": "Check for element_shape in TensorListScatter and TensorListScatterV2\n\nPiperOrigin-RevId: 462460346",
    "before_after_code_files": [
      "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
      "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h": [
      "File: tensorflow/core/kernels/list_kernels.h -> tensorflow/core/kernels/list_kernels.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "895:     OP_REQUIRES_OK(c, c->allocate_output(0, {}, &output_tensor, attr));",
      "896:     Tensor indices = c->input(1);",
      "897:     PartialTensorShape element_shape;",
      "898:     OP_REQUIRES_OK(c, TensorShapeFromTensor(c->input(2), &element_shape));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "898:     OP_REQUIRES(",
      "899:         c, !TensorShapeUtils::IsMatrixOrHigher(c->input(2).shape()),",
      "900:         errors::InvalidArgument(",
      "901:             \"TensorListScatter: element_shape must be at most rank 1 but has \",",
      "902:             \"the shape of \", c->input(2).shape().DebugString()));",
      "",
      "---------------"
    ],
    "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py": [
      "File: tensorflow/python/kernel_tests/data_structures/list_ops_test.py -> tensorflow/python/kernel_tests/data_structures/list_ops_test.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "481:     # TensorListScatter should return a list with size num_elements.",
      "482:     self.assertAllEqual(list_ops.tensor_list_length(l), 5)",
      "484:   def testScatterFailsWhenIndexLargerThanNumElements(self):",
      "485:     c0 = constant_op.constant([1.0, 2.0])",
      "486:     with self.assertRaisesRegex(",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "484:   def testScatterFailsWhenElementShapeIsNotVector(self):",
      "485:     c0 = constant_op.constant([1.0, 2.0])",
      "486:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
      "487:     # In graph mode, ValueError is generated by the shape function.",
      "488:     with self.assertRaisesRegex(",
      "489:         (errors.InvalidArgumentError, ValueError),",
      "490:         \"must be at most rank 1\"):",
      "491:       l = gen_list_ops.tensor_list_scatter(",
      "492:           # Wrong element_shape. Should be at most rank 1.",
      "493:           c0, [1, 3], element_shape=[[1]])",
      "494:       self.evaluate(l)",
      "496:   def testScatterV2FailsWhenElementShapeIsNotVector(self):",
      "497:     c0 = constant_op.constant([1.0, 2.0])",
      "498:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
      "499:     # In graph mode, ValueError is generated by the shape function.",
      "500:     with self.assertRaisesRegex(",
      "501:         (errors.InvalidArgumentError, ValueError),",
      "502:         \"must be at most rank 1\"):",
      "503:       l = gen_list_ops.tensor_list_scatter_v2(",
      "504:           # Wrong element_shape. Should be at most rank 1.",
      "505:           c0, [1, 3], element_shape=[[1]], num_elements=2)",
      "506:       self.evaluate(l)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3be002e8dd2e618261cbfb23364027f33a9de11c",
      "candidate_info": {
        "commit_hash": "3be002e8dd2e618261cbfb23364027f33a9de11c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3be002e8dd2e618261cbfb23364027f33a9de11c",
        "files": [
          "tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/list_ops_test.py"
        ],
        "message": "Check for element_shape in TensorListScatter and TensorListScatterV2\n\nPiperOrigin-RevId: 462460346",
        "before_after_code_files": [
          "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/list_ops_test.py||tensorflow/python/kernel_tests/list_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h"
          ],
          "candidate": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h": [
          "File: tensorflow/core/kernels/list_kernels.h -> tensorflow/core/kernels/list_kernels.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "894:     OP_REQUIRES_OK(c, c->allocate_output(0, {}, &output_tensor, attr));",
          "895:     Tensor indices = c->input(1);",
          "896:     PartialTensorShape element_shape;",
          "897:     OP_REQUIRES_OK(c, TensorShapeFromTensor(c->input(2), &element_shape));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "897:     OP_REQUIRES(",
          "898:         c, !TensorShapeUtils::IsMatrixOrHigher(c->input(2).shape()),",
          "899:         errors::InvalidArgument(",
          "900:             \"TensorListScatter: element_shape must be at most rank 1 but has \",",
          "901:             \"the shape of \", c->input(2).shape().DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/list_ops_test.py||tensorflow/python/kernel_tests/list_ops_test.py": [
          "File: tensorflow/python/kernel_tests/list_ops_test.py -> tensorflow/python/kernel_tests/list_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "485:     # TensorListScatter should return a list with size num_elements.",
          "486:     self.assertAllEqual(list_ops.tensor_list_length(l), 5)",
          "488:   def testScatterFailsWhenIndexLargerThanNumElements(self):",
          "489:     c0 = constant_op.constant([1.0, 2.0])",
          "490:     with self.assertRaisesRegex(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "488:   def testScatterFailsWhenElementShapeIsNotVector(self):",
          "489:     c0 = constant_op.constant([1.0, 2.0])",
          "490:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "491:     # In graph mode, ValueError is generated by the shape function.",
          "492:     with self.assertRaisesRegex(",
          "493:         (errors.InvalidArgumentError, ValueError),",
          "494:         \"must be at most rank 1\"):",
          "495:       l = gen_list_ops.tensor_list_scatter(",
          "496:           # Wrong element_shape. Should be at most rank 1.",
          "497:           c0, [1, 3], element_shape=[[1]])",
          "498:       self.evaluate(l)",
          "500:   def testScatterV2FailsWhenElementShapeIsNotVector(self):",
          "501:     c0 = constant_op.constant([1.0, 2.0])",
          "502:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "503:     # In graph mode, ValueError is generated by the shape function.",
          "504:     with self.assertRaisesRegex(",
          "505:         (errors.InvalidArgumentError, ValueError),",
          "506:         \"must be at most rank 1\"):",
          "507:       l = gen_list_ops.tensor_list_scatter_v2(",
          "508:           # Wrong element_shape. Should be at most rank 1.",
          "509:           c0, [1, 3], element_shape=[[1]], num_elements=2)",
          "510:       self.evaluate(l)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "721c8ec5cd07bfbd5db601fab68ef73a2a3e2837",
      "candidate_info": {
        "commit_hash": "721c8ec5cd07bfbd5db601fab68ef73a2a3e2837",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/721c8ec5cd07bfbd5db601fab68ef73a2a3e2837",
        "files": [
          "tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
        ],
        "message": "Check for element_shape in TensorListScatter and TensorListScatterV2\n\nPiperOrigin-RevId: 462460346",
        "before_after_code_files": [
          "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
            "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
            "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h": [
          "File: tensorflow/core/kernels/list_kernels.h -> tensorflow/core/kernels/list_kernels.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "894:     OP_REQUIRES_OK(c, c->allocate_output(0, {}, &output_tensor, attr));",
          "895:     Tensor indices = c->input(1);",
          "896:     PartialTensorShape element_shape;",
          "897:     OP_REQUIRES_OK(c, TensorShapeFromTensor(c->input(2), &element_shape));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "897:     OP_REQUIRES(",
          "898:         c, !TensorShapeUtils::IsMatrixOrHigher(c->input(2).shape()),",
          "899:         errors::InvalidArgument(",
          "900:             \"TensorListScatter: element_shape must be at most rank 1 but has \",",
          "901:             \"the shape of \", c->input(2).shape().DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py": [
          "File: tensorflow/python/kernel_tests/data_structures/list_ops_test.py -> tensorflow/python/kernel_tests/data_structures/list_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:     # TensorListScatter should return a list with size num_elements.",
          "482:     self.assertAllEqual(list_ops.tensor_list_length(l), 5)",
          "484:   def testScatterFailsWhenIndexLargerThanNumElements(self):",
          "485:     c0 = constant_op.constant([1.0, 2.0])",
          "486:     with self.assertRaisesRegex(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "484:   def testScatterFailsWhenElementShapeIsNotVector(self):",
          "485:     c0 = constant_op.constant([1.0, 2.0])",
          "486:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "487:     # In graph mode, ValueError is generated by the shape function.",
          "488:     with self.assertRaisesRegex(",
          "489:         (errors.InvalidArgumentError, ValueError),",
          "490:         \"must be at most rank 1\"):",
          "491:       l = gen_list_ops.tensor_list_scatter(",
          "492:           # Wrong element_shape. Should be at most rank 1.",
          "493:           c0, [1, 3], element_shape=[[1]])",
          "494:       self.evaluate(l)",
          "496:   def testScatterV2FailsWhenElementShapeIsNotVector(self):",
          "497:     c0 = constant_op.constant([1.0, 2.0])",
          "498:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "499:     # In graph mode, ValueError is generated by the shape function.",
          "500:     with self.assertRaisesRegex(",
          "501:         (errors.InvalidArgumentError, ValueError),",
          "502:         \"must be at most rank 1\"):",
          "503:       l = gen_list_ops.tensor_list_scatter_v2(",
          "504:           # Wrong element_shape. Should be at most rank 1.",
          "505:           c0, [1, 3], element_shape=[[1]], num_elements=2)",
          "506:       self.evaluate(l)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8e2837d02533e30e9fe09dddbce754bc205a4895",
      "candidate_info": {
        "commit_hash": "8e2837d02533e30e9fe09dddbce754bc205a4895",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8e2837d02533e30e9fe09dddbce754bc205a4895",
        "files": [
          "tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
        ],
        "message": "Check for element_shape in TensorListScatter and TensorListScatterV2\n\nPiperOrigin-RevId: 462460346",
        "before_after_code_files": [
          "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
          "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
            "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
          ],
          "candidate": [
            "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h",
            "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/list_kernels.h||tensorflow/core/kernels/list_kernels.h": [
          "File: tensorflow/core/kernels/list_kernels.h -> tensorflow/core/kernels/list_kernels.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "894:     OP_REQUIRES_OK(c, c->allocate_output(0, {}, &output_tensor, attr));",
          "895:     Tensor indices = c->input(1);",
          "896:     PartialTensorShape element_shape;",
          "897:     OP_REQUIRES_OK(c, TensorShapeFromTensor(c->input(2), &element_shape));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "897:     OP_REQUIRES(",
          "898:         c, !TensorShapeUtils::IsMatrixOrHigher(c->input(2).shape()),",
          "899:         errors::InvalidArgument(",
          "900:             \"TensorListScatter: element_shape must be at most rank 1 but has \",",
          "901:             \"the shape of \", c->input(2).shape().DebugString()));",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/data_structures/list_ops_test.py||tensorflow/python/kernel_tests/data_structures/list_ops_test.py": [
          "File: tensorflow/python/kernel_tests/data_structures/list_ops_test.py -> tensorflow/python/kernel_tests/data_structures/list_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:     # TensorListScatter should return a list with size num_elements.",
          "482:     self.assertAllEqual(list_ops.tensor_list_length(l), 5)",
          "484:   def testScatterFailsWhenIndexLargerThanNumElements(self):",
          "485:     c0 = constant_op.constant([1.0, 2.0])",
          "486:     with self.assertRaisesRegex(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "484:   def testScatterFailsWhenElementShapeIsNotVector(self):",
          "485:     c0 = constant_op.constant([1.0, 2.0])",
          "486:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "487:     # In graph mode, ValueError is generated by the shape function.",
          "488:     with self.assertRaisesRegex(",
          "489:         (errors.InvalidArgumentError, ValueError),",
          "490:         \"must be at most rank 1\"):",
          "491:       l = gen_list_ops.tensor_list_scatter(",
          "492:           # Wrong element_shape. Should be at most rank 1.",
          "493:           c0, [1, 3], element_shape=[[1]])",
          "494:       self.evaluate(l)",
          "496:   def testScatterV2FailsWhenElementShapeIsNotVector(self):",
          "497:     c0 = constant_op.constant([1.0, 2.0])",
          "498:     # In Eager mode, InvalidArgumentError is generated by the Compute function.",
          "499:     # In graph mode, ValueError is generated by the shape function.",
          "500:     with self.assertRaisesRegex(",
          "501:         (errors.InvalidArgumentError, ValueError),",
          "502:         \"must be at most rank 1\"):",
          "503:       l = gen_list_ops.tensor_list_scatter_v2(",
          "504:           # Wrong element_shape. Should be at most rank 1.",
          "505:           c0, [1, 3], element_shape=[[1]], num_elements=2)",
          "506:       self.evaluate(l)",
          "",
          "---------------"
        ]
      }
    }
  ]
}