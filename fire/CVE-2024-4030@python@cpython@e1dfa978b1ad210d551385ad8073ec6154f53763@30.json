{
  "cve_id": "CVE-2024-4030",
  "cve_desc": "On Windows a directory returned by tempfile.mkdtemp() would not always have permissions set to restrict reading and writing to the temporary directory by other users, instead usually inheriting the correct permissions from the default location. Alternate configurations or users without a profile directory may not have the intended permissions.\n\nIf you\u2019re not using Windows or haven\u2019t changed the temporary directory location then you aren\u2019t affected by this vulnerability. On other platforms the returned directory is consistently readable and writable only by the current user.\n\nThis issue was caused by Python not supporting Unix permissions on Windows. The fix adds support for Unix \u201c700\u201d for the mkdir function on Windows which is used by mkdtemp() to ensure the newly created directory has the proper permissions.",
  "repo": "python/cpython",
  "patch_hash": "e1dfa978b1ad210d551385ad8073ec6154f53763",
  "patch_info": {
    "commit_hash": "e1dfa978b1ad210d551385ad8073ec6154f53763",
    "repo": "python/cpython",
    "commit_url": "https://github.com/python/cpython/commit/e1dfa978b1ad210d551385ad8073ec6154f53763",
    "files": [
      "Lib/test/test_os.py",
      "Modules/posixmodule.c"
    ],
    "message": "gh-118486: Simplify test_win32_mkdir_700 to check the exact ACL (GH-119056)\n\n(cherry picked from commit 94591dca510c796c7d40e9b4167ea56f2fdf28ca)\n\nCo-authored-by: Steve Dower <steve.dower@python.org>",
    "before_after_code_files": [
      "Lib/test/test_os.py||Lib/test/test_os.py",
      "Modules/posixmodule.c||Modules/posixmodule.c"
    ]
  },
  "patch_diff": {
    "Lib/test/test_os.py||Lib/test/test_os.py": [
      "File: Lib/test/test_os.py -> Lib/test/test_os.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "1814:     @unittest.skipUnless(os.name == 'nt', \"requires Windows\")",
      "1815:     def test_win32_mkdir_700(self):",
      "1816:         base = os_helper.TESTFN",
      "1833:     def tearDown(self):",
      "1834:         path = os.path.join(os_helper.TESTFN, 'dir1', 'dir2', 'dir3',",
      "",
      "[Removed Lines]",
      "1817:         path1 = os.path.join(os_helper.TESTFN, 'dir1')",
      "1818:         path2 = os.path.join(os_helper.TESTFN, 'dir2')",
      "1819:         # mode=0o700 is special-cased to override ACLs on Windows",
      "1820:         # There's no way to know exactly how the ACLs will look, so we'll",
      "1821:         # check that they are different from a regularly created directory.",
      "1822:         os.mkdir(path1, mode=0o700)",
      "1823:         os.mkdir(path2, mode=0o777)",
      "1825:         out1 = subprocess.check_output([\"icacls.exe\", path1], encoding=\"oem\")",
      "1826:         out2 = subprocess.check_output([\"icacls.exe\", path2], encoding=\"oem\")",
      "1827:         os.rmdir(path1)",
      "1828:         os.rmdir(path2)",
      "1829:         out1 = out1.replace(path1, \"<PATH>\")",
      "1830:         out2 = out2.replace(path2, \"<PATH>\")",
      "1831:         self.assertNotEqual(out1, out2)",
      "",
      "[Added Lines]",
      "1817:         path = os.path.abspath(os.path.join(os_helper.TESTFN, 'dir'))",
      "1818:         os.mkdir(path, mode=0o700)",
      "1819:         out = subprocess.check_output([\"cacls.exe\", path, \"/s\"], encoding=\"oem\")",
      "1820:         os.rmdir(path)",
      "1821:         self.assertEqual(",
      "1822:             out.strip(),",
      "1823:             f'{path} \"D:P(A;OICI;FA;;;SY)(A;OICI;FA;;;BA)(A;OICI;FA;;;OW)\"',",
      "1824:         )",
      "",
      "---------------"
    ],
    "Modules/posixmodule.c||Modules/posixmodule.c": [
      "File: Modules/posixmodule.c -> Modules/posixmodule.c"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "93b95e91faa17520f2042b4f4ae88379df914666",
      "candidate_info": {
        "commit_hash": "93b95e91faa17520f2042b4f4ae88379df914666",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/93b95e91faa17520f2042b4f4ae88379df914666",
        "files": [
          "Lib/_pyrepl/commands.py",
          "Lib/test/test_pyrepl/support.py",
          "Lib/test/test_pyrepl/test_reader.py"
        ],
        "message": "[3.13] gh-119553: Clear reader on Ctrl-C command (GH-119801) (#120062)\n\n(cherry picked from commit 010ea93b2b888149561becefeee90826bf8a2934)\n\nCo-authored-by: Lysandros Nikolaou <lisandrosnik@gmail.com>\nCo-authored-by: \u0141ukasz Langa <lukasz@langa.pl>",
        "before_after_code_files": [
          "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py",
          "Lib/test/test_pyrepl/support.py||Lib/test/test_pyrepl/support.py",
          "Lib/test/test_pyrepl/test_reader.py||Lib/test/test_pyrepl/test_reader.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py": [
          "File: Lib/_pyrepl/commands.py -> Lib/_pyrepl/commands.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "222: class ctrl_c(Command):",
          "223:     def do(self) -> None:",
          "224:         raise KeyboardInterrupt",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "224:         self.reader.finish()",
          "",
          "---------------"
        ],
        "Lib/test/test_pyrepl/support.py||Lib/test/test_pyrepl/support.py": [
          "File: Lib/test/test_pyrepl/support.py -> Lib/test/test_pyrepl/support.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "75:             reader.handle1()",
          "76:     except StopIteration:",
          "77:         pass",
          "78:     return reader, console",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:     except KeyboardInterrupt:",
          "79:         pass",
          "",
          "---------------"
        ],
        "Lib/test/test_pyrepl/test_reader.py||Lib/test/test_pyrepl/test_reader.py": [
          "File: Lib/test/test_pyrepl/test_reader.py -> Lib/test/test_pyrepl/test_reader.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "179:         self.assert_screen_equals(reader, expected)",
          "180:         self.assertTrue(reader.finished)",
          "182:     def test_prompt_length(self):",
          "183:         # Handles simple ASCII prompt",
          "184:         ps1 = \">>> \"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "182:     def test_keyboard_interrupt_clears_screen(self):",
          "183:         namespace = {\"itertools\": itertools}",
          "184:         code = \"import itertools\\nitertools.\"",
          "185:         events = itertools.chain(code_to_events(code), [",
          "186:             Event(evt='key', data='\\t', raw=bytearray(b'\\t')),  # Two tabs for completion",
          "187:             Event(evt='key', data='\\t', raw=bytearray(b'\\t')),",
          "188:             Event(evt='key', data='\\x03', raw=bytearray(b'\\x03')),  # Ctrl-C",
          "189:         ])",
          "191:         completing_reader = functools.partial(",
          "192:             prepare_reader,",
          "193:             readline_completer=rlcompleter.Completer(namespace).complete",
          "194:         )",
          "195:         reader, _ = handle_all_events(events, prepare_reader=completing_reader)",
          "196:         self.assertEqual(reader.calc_screen(), code.split(\"\\n\"))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1c41aa78d85ee9224cc8609302f7a9b47c6186be",
      "candidate_info": {
        "commit_hash": "1c41aa78d85ee9224cc8609302f7a9b47c6186be",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/1c41aa78d85ee9224cc8609302f7a9b47c6186be",
        "files": [
          "Lib/pdb.py",
          "Lib/test/test_pdb.py",
          "Misc/NEWS.d/next/Library/2024-05-31-21-17-43.gh-issue-119824.CQlxWV.rst"
        ],
        "message": "[3.13] gh-119824: Print stack entry when user input is needed (GH-119882) (#120533)\n\nCo-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>",
        "before_after_code_files": [
          "Lib/pdb.py||Lib/pdb.py",
          "Lib/test/test_pdb.py||Lib/test/test_pdb.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/pdb.py||Lib/pdb.py": [
          "File: Lib/pdb.py -> Lib/pdb.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "605:             assert tb is not None, \"main exception must have a traceback\"",
          "606:         with self._hold_exceptions(_chained_exceptions):",
          "607:             self.setup(frame, tb)",
          "610:                 self.print_stack_entry(self.stack[self.curindex])",
          "611:             self._cmdloop()",
          "612:             self.forget()",
          "614:     def displayhook(self, obj):",
          "",
          "[Removed Lines]",
          "608:             # if we have more commands to process, do not show the stack entry",
          "609:             if not self.cmdqueue:",
          "",
          "[Added Lines]",
          "608:             # We should print the stack entry if and only if the user input",
          "609:             # is expected, and we should print it right before the user input.",
          "610:             # If self.cmdqueue is not empty, we append a \"w 0\" command to the",
          "611:             # queue, which is equivalent to print_stack_entry",
          "612:             if self.cmdqueue:",
          "613:                 self.cmdqueue.append('w 0')",
          "614:             else:",
          "617:             # If \"w 0\" is not used, pop it out",
          "618:             if self.cmdqueue and self.cmdqueue[-1] == 'w 0':",
          "619:                 self.cmdqueue.pop()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1403:     complete_cl = _complete_location",
          "1405:     def do_where(self, arg):",
          "1409:         An arrow indicates the \"current frame\", which determines the",
          "1410:         context of most commands.  'bt' is an alias for this command.",
          "1411:         \"\"\"",
          "1416:     do_w = do_where",
          "1417:     do_bt = do_where",
          "",
          "[Removed Lines]",
          "1406:         \"\"\"w(here)",
          "1408:         Print a stack trace, with the most recent frame at the bottom.",
          "1412:         if arg:",
          "1413:             self._print_invalid_arg(arg)",
          "1414:             return",
          "1415:         self.print_stack_trace()",
          "",
          "[Added Lines]",
          "1414:         \"\"\"w(here) [count]",
          "1416:         Print a stack trace. If count is not specified, print the full stack.",
          "1417:         If count is 0, print the current frame entry. If count is positive,",
          "1418:         print count entries from the most recent frame. If count is negative,",
          "1419:         print -count entries from the least recent frame.",
          "1423:         if not arg:",
          "1424:             count = None",
          "1425:         else:",
          "1426:             try:",
          "1427:                 count = int(arg)",
          "1428:             except ValueError:",
          "1429:                 self.error('Invalid count (%s)' % arg)",
          "1430:                 return",
          "1431:         self.print_stack_trace(count)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2067:     # It is also consistent with the up/down commands (which are",
          "2068:     # compatible with dbx and gdb: up moves towards 'main()'",
          "2069:     # and down moves towards the most recent stack frame).",
          "2072:         try:",
          "2074:                 self.print_stack_entry(frame_lineno)",
          "2075:         except KeyboardInterrupt:",
          "2076:             pass",
          "",
          "[Removed Lines]",
          "2071:     def print_stack_trace(self):",
          "2073:             for frame_lineno in self.stack:",
          "",
          "[Added Lines]",
          "2086:     #     * if count is None, prints the full stack",
          "2087:     #     * if count = 0, prints the current frame entry",
          "2088:     #     * if count < 0, prints -count least recent frame entries",
          "2089:     #     * if count > 0, prints count most recent frame entries",
          "2091:     def print_stack_trace(self, count=None):",
          "2092:         if count is None:",
          "2093:             stack_to_print = self.stack",
          "2094:         elif count == 0:",
          "2095:             stack_to_print = [self.stack[self.curindex]]",
          "2096:         elif count < 0:",
          "2097:             stack_to_print = self.stack[:-count]",
          "2098:         else:",
          "2099:             stack_to_print = self.stack[-count:]",
          "2101:             for frame_lineno in stack_to_print:",
          "",
          "---------------"
        ],
        "Lib/test/test_pdb.py||Lib/test/test_pdb.py": [
          "File: Lib/test/test_pdb.py -> Lib/test/test_pdb.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "781:     ...     import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "783:     >>> def f():",
          "786:     >>> def test_function():",
          "787:     ...     f()",
          "",
          "[Removed Lines]",
          "784:     ...     g();",
          "",
          "[Added Lines]",
          "784:     ...     g()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "789:     >>> with PdbTestInput([  # doctest: +ELLIPSIS",
          "790:     ...     'w',",
          "791:     ...     'where',",
          "792:     ...     'u',",
          "793:     ...     'w',",
          "794:     ...     'continue',",
          "795:     ... ]):",
          "796:     ...    test_function()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "792:     ...     'w 1',",
          "793:     ...     'w invalid',",
          "796:     ...     'w 0',",
          "797:     ...     'w 100',",
          "798:     ...     'w -100',",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "798:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "799:     (Pdb) w",
          "800:     ...",
          "802:     -> test_function()",
          "803:       <doctest test.test_pdb.test_pdb_where_command[2]>(2)test_function()",
          "804:     -> f()",
          "805:       <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "807:     > <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "808:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "809:     (Pdb) where",
          "810:     ...",
          "812:     -> test_function()",
          "813:       <doctest test.test_pdb.test_pdb_where_command[2]>(2)test_function()",
          "814:     -> f()",
          "815:       <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "817:     > <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "818:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "819:     (Pdb) u",
          "820:     > <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "822:     (Pdb) w",
          "823:     ...",
          "825:     -> test_function()",
          "826:       <doctest test.test_pdb.test_pdb_where_command[2]>(2)test_function()",
          "827:     -> f()",
          "828:     > <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "830:       <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "831:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "832:     (Pdb) continue",
          "",
          "[Removed Lines]",
          "801:       <doctest test.test_pdb.test_pdb_where_command[3]>(8)<module>()",
          "806:     -> g();",
          "811:       <doctest test.test_pdb.test_pdb_where_command[3]>(8)<module>()",
          "816:     -> g();",
          "821:     -> g();",
          "824:       <doctest test.test_pdb.test_pdb_where_command[3]>(8)<module>()",
          "829:     -> g();",
          "",
          "[Added Lines]",
          "806:       <doctest test.test_pdb.test_pdb_where_command[3]>(13)<module>()",
          "811:     -> g()",
          "816:       <doctest test.test_pdb.test_pdb_where_command[3]>(13)<module>()",
          "821:     -> g()",
          "824:     (Pdb) w 1",
          "825:     > <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "826:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "827:     (Pdb) w invalid",
          "831:     -> g()",
          "834:       <doctest test.test_pdb.test_pdb_where_command[3]>(13)<module>()",
          "835:     -> test_function()",
          "836:       <doctest test.test_pdb.test_pdb_where_command[2]>(2)test_function()",
          "837:     -> f()",
          "838:     > <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "839:     -> g()",
          "840:       <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "841:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "842:     (Pdb) w 0",
          "843:     > <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "844:     -> g()",
          "845:     (Pdb) w 100",
          "846:     ...",
          "847:       <doctest test.test_pdb.test_pdb_where_command[3]>(13)<module>()",
          "848:     -> test_function()",
          "849:       <doctest test.test_pdb.test_pdb_where_command[2]>(2)test_function()",
          "850:     -> f()",
          "851:     > <doctest test.test_pdb.test_pdb_where_command[1]>(2)f()",
          "852:     -> g()",
          "853:       <doctest test.test_pdb.test_pdb_where_command[0]>(2)g()",
          "854:     -> import pdb; pdb.Pdb(nosigint=True, readrc=False).set_trace()",
          "855:     (Pdb) w -100",
          "856:     ...",
          "857:       <doctest test.test_pdb.test_pdb_where_command[3]>(13)<module>()",
          "862:     -> g()",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3165:         stdout, stderr = self.run_pdb_script(script, 'q\\n', pdbrc=pdbrc, remove_home=True)",
          "3166:         self.assertNotIn(\"SyntaxError\", stdout)",
          "3167:         self.assertIn(\"a+8=9\", stdout)",
          "3169:     def test_pdbrc_empty_line(self):",
          "3170:         \"\"\"Test that empty lines in .pdbrc are ignored.\"\"\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3201:         self.assertIn(\"-> b = 2\", stdout)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "aefe2e626eeb2f05cda10a17926f8ba9b7a504ca",
      "candidate_info": {
        "commit_hash": "aefe2e626eeb2f05cda10a17926f8ba9b7a504ca",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/aefe2e626eeb2f05cda10a17926f8ba9b7a504ca",
        "files": [
          "Lib/_pyrepl/commands.py",
          "Lib/_pyrepl/completing_reader.py",
          "Lib/_pyrepl/reader.py",
          "Lib/_pyrepl/unix_console.py"
        ],
        "message": "[3.13] gh-111201: Add append to screen method to avoid recalculation (GH-119274) (#119405)\n\n(cherry picked from commit c886bece3b3a49f8a0f188aecfc1d6ff89d281e6)\n\nCo-authored-by: Lysandros Nikolaou <lisandrosnik@gmail.com>\nCo-authored-by: \u0141ukasz Langa <lukasz@langa.pl>",
        "before_after_code_files": [
          "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py",
          "Lib/_pyrepl/completing_reader.py||Lib/_pyrepl/completing_reader.py",
          "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py",
          "Lib/_pyrepl/unix_console.py||Lib/_pyrepl/unix_console.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/_pyrepl/commands.py||Lib/_pyrepl/commands.py": [
          "File: Lib/_pyrepl/commands.py -> Lib/_pyrepl/commands.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "358: class self_insert(EditCommand):",
          "359:     def do(self) -> None:",
          "360:         r = self.reader",
          "364: class insert_nl(EditCommand):",
          "",
          "[Removed Lines]",
          "361:         r.insert(self.event * r.get_arg())",
          "",
          "[Added Lines]",
          "361:         text = self.event * r.get_arg()",
          "362:         r.insert(text)",
          "363:         if len(text) == 1 and r.pos == len(r.buffer):",
          "364:             r.calc_screen = r.append_to_screen",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/completing_reader.py||Lib/_pyrepl/completing_reader.py": [
          "File: Lib/_pyrepl/completing_reader.py -> Lib/_pyrepl/completing_reader.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "187:             if p:",
          "188:                 r.insert(p)",
          "189:             if last_is_completer:",
          "192:                 r.cmpltn_menu, r.cmpltn_menu_end = build_menu(",
          "193:                     r.console, completions, r.cmpltn_menu_end,",
          "194:                     r.use_brackets, r.sort_in_column)",
          "",
          "[Removed Lines]",
          "190:                 if not r.cmpltn_menu_vis:",
          "191:                     r.cmpltn_menu_vis = 1",
          "",
          "[Added Lines]",
          "190:                 if not r.cmpltn_menu_visible:",
          "191:                     r.cmpltn_menu_visible = True",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "209:         commands.self_insert.do(self)",
          "212:             stem = r.get_stem()",
          "213:             if len(stem) < 1:",
          "214:                 r.cmpltn_reset()",
          "",
          "[Removed Lines]",
          "211:         if r.cmpltn_menu_vis:",
          "",
          "[Added Lines]",
          "211:         if r.cmpltn_menu_visible:",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "236:     ### Instance variables",
          "237:     cmpltn_menu: list[str] = field(init=False)",
          "239:     cmpltn_menu_end: int = field(init=False)",
          "240:     cmpltn_menu_choices: list[str] = field(init=False)",
          "",
          "[Removed Lines]",
          "238:     cmpltn_menu_vis: int = field(init=False)",
          "",
          "[Added Lines]",
          "238:     cmpltn_menu_visible: bool = field(init=False)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "255:         if not isinstance(cmd, (complete, self_insert)):",
          "256:             self.cmpltn_reset()",
          "261:             ly = self.lxy[1]",
          "262:             screen[ly:ly] = self.cmpltn_menu",
          "263:             self.screeninfo[ly:ly] = [(0, [])]*len(self.cmpltn_menu)",
          "",
          "[Removed Lines]",
          "258:     def calc_screen(self) -> list[str]:",
          "259:         screen = super().calc_screen()",
          "260:         if self.cmpltn_menu_vis:",
          "",
          "[Added Lines]",
          "258:     def calc_complete_screen(self) -> list[str]:",
          "259:         screen = super().calc_complete_screen()",
          "260:         if self.cmpltn_menu_visible:",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "271:     def cmpltn_reset(self) -> None:",
          "272:         self.cmpltn_menu = []",
          "274:         self.cmpltn_menu_end = 0",
          "275:         self.cmpltn_menu_choices = []",
          "",
          "[Removed Lines]",
          "273:         self.cmpltn_menu_vis = 0",
          "",
          "[Added Lines]",
          "273:         self.cmpltn_menu_visible = False",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/reader.py||Lib/_pyrepl/reader.py": [
          "File: Lib/_pyrepl/reader.py -> Lib/_pyrepl/reader.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: # types",
          "36: Command = commands.Command",
          "37: if False:",
          "38:     from .types import Callback, SimpleContextManager, KeySpec, CommandName",
          "41: def disp_str(buffer: str) -> tuple[str, list[int]]:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "38:     from typing import Callable",
          "40:     CalcScreen = Callable[[], list[str]]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "231:     keymap: tuple[tuple[str, str], ...] = ()",
          "232:     input_trans: input.KeymapTranslator = field(init=False)",
          "233:     input_trans_stack: list[input.KeymapTranslator] = field(default_factory=list)",
          "234:     screeninfo: list[tuple[int, list[int]]] = field(init=False)",
          "235:     cxy: tuple[int, int] = field(init=False)",
          "236:     lxy: tuple[int, int] = field(init=False)",
          "238:     def __post_init__(self) -> None:",
          "239:         # Enable the use of `insert` without a `prepare` call - necessary to",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "236:     screen: list[str] = field(default_factory=list)",
          "240:     calc_screen: CalcScreen = field(init=False)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "243:         self.input_trans = input.KeymapTranslator(",
          "244:             self.keymap, invalid_cls=\"invalid-key\", character_cls=\"self-insert\"",
          "245:         )",
          "247:         self.cxy = self.pos2xy()",
          "248:         self.lxy = (self.pos, 0)",
          "250:     def collect_keymap(self) -> tuple[tuple[KeySpec, CommandName], ...]:",
          "251:         return default_keymap",
          "254:         \"\"\"The purpose of this method is to translate changes in",
          "255:         self.buffer into changes in self.screen.  Currently it rips",
          "256:         everything down and starts from scratch, which whilst not",
          "",
          "[Removed Lines]",
          "246:         self.screeninfo = [(0, [0])]",
          "253:     def calc_screen(self) -> list[str]:",
          "",
          "[Added Lines]",
          "250:         self.screeninfo = [(0, [])]",
          "253:         self.calc_screen = self.calc_complete_screen",
          "258:     def append_to_screen(self) -> list[str]:",
          "259:         new_screen = self.screen.copy() or ['']",
          "261:         new_character = self.buffer[-1]",
          "262:         new_character_len = wlen(new_character)",
          "264:         last_line_len = wlen(new_screen[-1])",
          "265:         if last_line_len + new_character_len >= self.console.width:  # We need to wrap here",
          "266:             new_screen[-1] += '\\\\'",
          "267:             self.screeninfo[-1][1].append(1)",
          "268:             new_screen.append(self.buffer[-1])",
          "269:             self.screeninfo.append((0, [new_character_len]))",
          "270:         else:",
          "271:             new_screen[-1] += self.buffer[-1]",
          "272:             self.screeninfo[-1][1].append(new_character_len)",
          "273:         self.cxy = self.pos2xy()",
          "275:         # Reset the function that is used for completing the screen",
          "276:         self.calc_screen = self.calc_complete_screen",
          "277:         return new_screen",
          "279:     def calc_complete_screen(self) -> list[str]:",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "563:     def refresh(self) -> None:",
          "564:         \"\"\"Recalculate and refresh the screen.\"\"\"",
          "565:         # this call sets up self.cxy, so call it first.",
          "568:         self.dirty = False",
          "570:     def do_cmd(self, cmd: tuple[str, list[str]]) -> None:",
          "",
          "[Removed Lines]",
          "566:         screen = self.calc_screen()",
          "567:         self.console.refresh(screen, self.cxy)",
          "",
          "[Added Lines]",
          "592:         self.screen = self.calc_screen()",
          "593:         self.console.refresh(self.screen, self.cxy)",
          "",
          "---------------"
        ],
        "Lib/_pyrepl/unix_console.py||Lib/_pyrepl/unix_console.py": [
          "File: Lib/_pyrepl/unix_console.py -> Lib/_pyrepl/unix_console.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "284:         self.__show_cursor()",
          "287:         self.move_cursor(cx, cy)",
          "288:         self.flushoutput()",
          "",
          "[Removed Lines]",
          "286:         self.screen = screen",
          "",
          "[Added Lines]",
          "286:         self.screen = screen.copy()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "da40fa35263893f78e75205c54fa3bcd24a64468",
      "candidate_info": {
        "commit_hash": "da40fa35263893f78e75205c54fa3bcd24a64468",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/da40fa35263893f78e75205c54fa3bcd24a64468",
        "files": [
          "Doc/library/enum.rst",
          "Lib/test/test_enum.py"
        ],
        "message": "[3.13] gh-120361: Add `nonmember` test with enum flags inside to `test_enum` (GH-120364) (#120511)\n\ngh-120361: Add `nonmember` test with enum flags inside to `test_enum` (GH-120364)\n\n* gh-120361: Add `nonmember` test with enum flags inside to `test_enum`\n(cherry picked from commit 7fadfd82ebf6ea90b38cb3f2a046a51f8601a205)\n\nCo-authored-by: Nikita Sobolev <mail@sobolevn.me>",
        "before_after_code_files": [
          "Lib/test/test_enum.py||Lib/test/test_enum.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/test/test_enum.py||Lib/test/test_enum.py": [
          "File: Lib/test/test_enum.py -> Lib/test/test_enum.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "1495:             spam = nonmember(SpamEnumIsInner)",
          "1496:         self.assertTrue(SpamEnum.spam is SpamEnumIsInner)",
          "1498:     def test_nested_classes_in_enum_with_member(self):",
          "1499:         \"\"\"Support locally-defined nested classes.\"\"\"",
          "1500:         class Outer(Enum):",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1498:     def test_using_members_as_nonmember(self):",
          "1499:         class Example(Flag):",
          "1500:             A = 1",
          "1501:             B = 2",
          "1502:             ALL = nonmember(A | B)",
          "1504:         self.assertEqual(Example.A.value, 1)",
          "1505:         self.assertEqual(Example.B.value, 2)",
          "1506:         self.assertEqual(Example.ALL, 3)",
          "1507:         self.assertIs(type(Example.ALL), int)",
          "1509:         class Example(Flag):",
          "1510:             A = auto()",
          "1511:             B = auto()",
          "1512:             ALL = nonmember(A | B)",
          "1514:         self.assertEqual(Example.A.value, 1)",
          "1515:         self.assertEqual(Example.B.value, 2)",
          "1516:         self.assertEqual(Example.ALL, 3)",
          "1517:         self.assertIs(type(Example.ALL), int)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "08416065a78516b923c1232c76f5fb674cc59618",
      "candidate_info": {
        "commit_hash": "08416065a78516b923c1232c76f5fb674cc59618",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/08416065a78516b923c1232c76f5fb674cc59618",
        "files": [
          "Include/internal/pycore_critical_section.h",
          "Lib/test/test_free_threading/test_str.py",
          "Misc/NEWS.d/next/C API/2024-05-21-11-35-11.gh-issue-119247.U6n6mh.rst",
          "Objects/unicodeobject.c"
        ],
        "message": "[3.13] gh-119247: Add macros to use PySequence_Fast safely in free-threaded build (GH-119315) (#119419)\n\nAdd `Py_BEGIN_CRITICAL_SECTION_SEQUENCE_FAST` and\n`Py_END_CRITICAL_SECTION_SEQUENCE_FAST` macros and update `str.join` to use\nthem. Also add a regression test that would crash reliably without this\npatch.\n(cherry picked from commit baf347d91643a83483bae110092750d39471e0c2)\n\nCo-authored-by: Josh {*()} Rosenberg <26495692+MojoVampire@users.noreply.github.com>",
        "before_after_code_files": [
          "Include/internal/pycore_critical_section.h||Include/internal/pycore_critical_section.h",
          "Lib/test/test_free_threading/test_str.py||Lib/test/test_free_threading/test_str.py",
          "Objects/unicodeobject.c||Objects/unicodeobject.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Include/internal/pycore_critical_section.h||Include/internal/pycore_critical_section.h": [
          "File: Include/internal/pycore_critical_section.h -> Include/internal/pycore_critical_section.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "108:         _PyCriticalSection2_End(&_cs2);                                 \\",
          "109:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "116: # define Py_BEGIN_CRITICAL_SECTION_SEQUENCE_FAST(original)              \\",
          "117:     {                                                                   \\",
          "118:         PyObject *_orig_seq = _PyObject_CAST(original);                 \\",
          "119:         const bool _should_lock_cs = PyList_CheckExact(_orig_seq);      \\",
          "120:         _PyCriticalSection _cs;                                         \\",
          "121:         if (_should_lock_cs) {                                          \\",
          "122:             _PyCriticalSection_Begin(&_cs, &_orig_seq->ob_mutex);       \\",
          "123:         }",
          "125: # define Py_END_CRITICAL_SECTION_SEQUENCE_FAST()                        \\",
          "126:         if (_should_lock_cs) {                                          \\",
          "127:             _PyCriticalSection_End(&_cs);                               \\",
          "128:         }                                                               \\",
          "129:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "137: # define Py_END_CRITICAL_SECTION()",
          "138: # define Py_BEGIN_CRITICAL_SECTION2(a, b)",
          "139: # define Py_END_CRITICAL_SECTION2()",
          "140: # define _Py_CRITICAL_SECTION_ASSERT_MUTEX_LOCKED(mutex)",
          "141: # define _Py_CRITICAL_SECTION_ASSERT_OBJECT_LOCKED(op)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "160: # define Py_BEGIN_CRITICAL_SECTION_SEQUENCE_FAST(original)",
          "161: # define Py_END_CRITICAL_SECTION_SEQUENCE_FAST()",
          "",
          "---------------"
        ],
        "Lib/test/test_free_threading/test_str.py||Lib/test/test_free_threading/test_str.py": [
          "File: Lib/test/test_free_threading/test_str.py -> Lib/test/test_free_threading/test_str.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: import sys",
          "2: import unittest",
          "4: from itertools import cycle",
          "5: from threading import Event, Thread",
          "6: from unittest import TestCase",
          "8: from test.support import threading_helper",
          "10: @threading_helper.requires_working_threading()",
          "11: class TestStr(TestCase):",
          "12:     def test_racing_join_extend(self):",
          "13:         '''Test joining a string being extended by another thread'''",
          "14:         l = []",
          "15:         ITERS = 100",
          "16:         READERS = 10",
          "17:         done_event = Event()",
          "18:         def writer_func():",
          "19:             for i in range(ITERS):",
          "20:                 l.extend(map(str, range(i)))",
          "21:                 l.clear()",
          "22:             done_event.set()",
          "23:         def reader_func():",
          "24:             while not done_event.is_set():",
          "25:                 ''.join(l)",
          "26:         writer = Thread(target=writer_func)",
          "27:         readers = []",
          "28:         for x in range(READERS):",
          "29:             reader = Thread(target=reader_func)",
          "30:             readers.append(reader)",
          "31:             reader.start()",
          "33:         writer.start()",
          "34:         writer.join()",
          "35:         for reader in readers:",
          "36:             reader.join()",
          "38:     def test_racing_join_replace(self):",
          "39:         '''",
          "40:         Test joining a string of characters being replaced with ephemeral",
          "41:         strings by another thread.",
          "42:         '''",
          "43:         l = [*'abcdefg']",
          "44:         MAX_ORDINAL = 1_000",
          "45:         READERS = 10",
          "46:         done_event = Event()",
          "48:         def writer_func():",
          "49:             for i, c in zip(cycle(range(len(l))),",
          "50:                             map(chr, range(128, MAX_ORDINAL))):",
          "51:                 l[i] = c",
          "52:             done_event.set()",
          "54:         def reader_func():",
          "55:             while not done_event.is_set():",
          "56:                 ''.join(l)",
          "57:                 ''.join(l)",
          "58:                 ''.join(l)",
          "59:                 ''.join(l)",
          "61:         writer = Thread(target=writer_func)",
          "62:         readers = []",
          "63:         for x in range(READERS):",
          "64:             reader = Thread(target=reader_func)",
          "65:             readers.append(reader)",
          "66:             reader.start()",
          "68:         writer.start()",
          "69:         writer.join()",
          "70:         for reader in readers:",
          "71:             reader.join()",
          "74: if __name__ == \"__main__\":",
          "75:     unittest.main()",
          "",
          "---------------"
        ],
        "Objects/unicodeobject.c||Objects/unicodeobject.c": [
          "File: Objects/unicodeobject.c -> Objects/unicodeobject.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "44: #include \"pycore_bytesobject.h\"   // _PyBytes_Repeat()",
          "45: #include \"pycore_ceval.h\"         // _PyEval_GetBuiltin()",
          "46: #include \"pycore_codecs.h\"        // _PyCodec_Lookup()",
          "47: #include \"pycore_format.h\"        // F_LJUST",
          "48: #include \"pycore_initconfig.h\"    // _PyStatus_OK()",
          "49: #include \"pycore_interp.h\"        // PyInterpreterState.fs_codec",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47: #include \"pycore_critical_section.h\" // Py_*_CRITICAL_SECTION_SEQUENCE_FAST",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "9559:         return NULL;",
          "9560:     }",
          "9566:     items = PySequence_Fast_ITEMS(fseq);",
          "9567:     seqlen = PySequence_Fast_GET_SIZE(fseq);",
          "9568:     res = _PyUnicode_JoinArray(separator, items, seqlen);",
          "9569:     Py_DECREF(fseq);",
          "9570:     return res;",
          "9571: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9563:     Py_BEGIN_CRITICAL_SECTION_SEQUENCE_FAST(seq);",
          "9569:     Py_END_CRITICAL_SECTION_SEQUENCE_FAST();",
          "",
          "---------------"
        ]
      }
    }
  ]
}