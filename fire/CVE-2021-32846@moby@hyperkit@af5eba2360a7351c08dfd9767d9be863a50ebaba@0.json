{
  "cve_id": "CVE-2021-32846",
  "cve_desc": "HyperKit is a toolkit for embedding hypervisor capabilities in an application. In versions 0.20210107, function `pci_vtsock_proc_tx` in `virtio-sock` can lead to to uninitialized memory use. In this situation, there is a check for the return value to be less or equal to `VTSOCK_MAXSEGS`, but that check is not sufficient because the function can return `-1` if it finds an error it cannot recover from. Moreover, the negative return value will be used by `iovec_pull` in a while condition that can further lead to more corruption because the function is not designed to handle a negative `iov_len`. This issue may lead to a guest crashing the host causing a denial of service and, under certain circumstance, memory corruption. This issue is fixed in commit af5eba2360a7351c08dfd9767d9be863a50ebaba.",
  "repo": "moby/hyperkit",
  "patch_hash": "af5eba2360a7351c08dfd9767d9be863a50ebaba",
  "patch_info": {
    "commit_hash": "af5eba2360a7351c08dfd9767d9be863a50ebaba",
    "repo": "moby/hyperkit",
    "commit_url": "https://github.com/moby/hyperkit/commit/af5eba2360a7351c08dfd9767d9be863a50ebaba",
    "files": [
      "src/lib/pci_virtio_sock.c"
    ],
    "message": "Fix virtio-sock pci_vtsock_proc_tx uninitialized memory use (GHSL-2021-057)\n\nSigned-off-by: Frederic Dalleau <frederic.dalleau@docker.com>",
    "before_after_code_files": [
      "src/lib/pci_virtio_sock.c||src/lib/pci_virtio_sock.c"
    ]
  },
  "patch_diff": {
    "src/lib/pci_virtio_sock.c||src/lib/pci_virtio_sock.c": [
      "File: src/lib/pci_virtio_sock.c -> src/lib/pci_virtio_sock.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1121:  size_t pulled;",
      "1123:  iovec_len = vq_getchain(vq, &idx, iov, VTSOCK_MAXSEGS, flags);",
      "1124:  assert(iovec_len <= VTSOCK_MAXSEGS);",
      "1126:  DPRINTF((\"TX: chain with %d buffers at idx %\"PRIx16\"\\n\",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1124:  if (iovec_len < 0) {",
      "1125:   fprintf(stderr, \"TX: failed to get chain at idx %\"PRIx16\"\\n\", idx);",
      "1126:   return;",
      "1127:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "41272a980197917df8e58ff90642d14dec8fe948",
      "candidate_info": {
        "commit_hash": "41272a980197917df8e58ff90642d14dec8fe948",
        "repo": "moby/hyperkit",
        "commit_url": "https://github.com/moby/hyperkit/commit/41272a980197917df8e58ff90642d14dec8fe948",
        "files": [
          "src/lib/pci_virtio_rnd.c"
        ],
        "message": "Fix vtrnd pci_vtrnd_notify uninitialized memory use (GHSL-2021-056)\n\nSigned-off-by: Frederic Dalleau <frederic.dalleau@docker.com>",
        "before_after_code_files": [
          "src/lib/pci_virtio_rnd.c||src/lib/pci_virtio_rnd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/moby/hyperkit/pull/313"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/lib/pci_virtio_rnd.c||src/lib/pci_virtio_rnd.c": [
          "File: src/lib/pci_virtio_rnd.c -> src/lib/pci_virtio_rnd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "100: {",
          "101:  struct iovec iov;",
          "102:  struct pci_vtrnd_softc *sc;",
          "104:  uint16_t idx;",
          "106:  sc = vsc;",
          "",
          "[Removed Lines]",
          "103:  int len;",
          "",
          "[Added Lines]",
          "103:  int len, n;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "111:  }",
          "113:  while (vq_has_descs(vq)) {",
          "116:   len = (int) read(sc->vrsc_fd, iov.iov_base, iov.iov_len);",
          "",
          "[Removed Lines]",
          "114:   vq_getchain(vq, &idx, &iov, 1, NULL);",
          "",
          "[Added Lines]",
          "114:   n = vq_getchain(vq, &idx, &iov, 1, NULL);",
          "115:   if (n < 0) {",
          "116:    fprintf(stderr, \"vtrnd: vtrnd_notify(): n %d\\r\\n\", n);",
          "117:    return;",
          "118:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "df0e46c7dbfd81a957d85e449ba41b52f6f7beb4",
      "candidate_info": {
        "commit_hash": "df0e46c7dbfd81a957d85e449ba41b52f6f7beb4",
        "repo": "moby/hyperkit",
        "commit_url": "https://github.com/moby/hyperkit/commit/df0e46c7dbfd81a957d85e449ba41b52f6f7beb4",
        "files": [
          "src/lib/virtio.c"
        ],
        "message": "Fix vi_pci_read null vc_cfgread function pointer dereference (GHSL-2021-054)\n\nThis is backport of what is done in bhyve\n\nSigned-off-by: Frederic Dalleau <frederic.dalleau@docker.com>",
        "before_after_code_files": [
          "src/lib/virtio.c||src/lib/virtio.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/moby/hyperkit/pull/313"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/lib/virtio.c||src/lib/virtio.c": [
          "File: src/lib/virtio.c -> src/lib/virtio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "559:   max = vc->vc_cfgsize ? vc->vc_cfgsize : 0x100000000;",
          "560:   if ((newoff + ((unsigned) size)) > max)",
          "561:    goto bad;",
          "563:   if (!error)",
          "564:    goto done;",
          "565:  }",
          "",
          "[Removed Lines]",
          "562:   error = (*vc->vc_cfgread)(DEV_SOFTC(vs), ((int) newoff), size, &value);",
          "",
          "[Added Lines]",
          "562:   if (vc->vc_cfgread != NULL)",
          "563:    error = (*vc->vc_cfgread)(DEV_SOFTC(vs), ((int) newoff), size, &value);",
          "564:   else",
          "565:    error = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "451558fe8aaa8b24e02e34106e3bb9fe41d7ad13",
      "candidate_info": {
        "commit_hash": "451558fe8aaa8b24e02e34106e3bb9fe41d7ad13",
        "repo": "moby/hyperkit",
        "commit_url": "https://github.com/moby/hyperkit/commit/451558fe8aaa8b24e02e34106e3bb9fe41d7ad13",
        "files": [
          "src/lib/virtio.c"
        ],
        "message": "Fix vi_pci_write null vc_cfgwrite function pointer dereference (GHSL-2021-055)\n\nThis is a backport of what is done in bhyve.\n\nSigned-off-by: Frederic Dalleau <frederic.dalleau@docker.com>",
        "before_after_code_files": [
          "src/lib/virtio.c||src/lib/virtio.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/moby/hyperkit/pull/313"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/lib/virtio.c||src/lib/virtio.c": [
          "File: src/lib/virtio.c -> src/lib/virtio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "681:   max = vc->vc_cfgsize ? vc->vc_cfgsize : 0x100000000;",
          "682:   if ((newoff + ((unsigned) size)) > max)",
          "683:    goto bad;",
          "686:   if (!error)",
          "687:    goto done;",
          "688:  }",
          "",
          "[Removed Lines]",
          "684:   error = (*vc->vc_cfgwrite)(DEV_SOFTC(vs), ((int) newoff), size,",
          "685:    ((uint32_t) value));",
          "",
          "[Added Lines]",
          "684:   if (vc->vc_cfgwrite != NULL)",
          "685:    error = (*vc->vc_cfgwrite)(DEV_SOFTC(vs), ((int) newoff), size,",
          "686:     ((uint32_t) value));",
          "687:   else",
          "688:    error = 0;",
          "",
          "---------------"
        ]
      }
    }
  ]
}