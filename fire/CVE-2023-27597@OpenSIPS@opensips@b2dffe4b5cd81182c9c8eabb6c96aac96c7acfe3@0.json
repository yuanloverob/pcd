{
  "cve_id": "CVE-2023-27597",
  "cve_desc": "OpenSIPS is a Session Initiation Protocol (SIP) server implementation. Prior to versions 3.1.8 and 3.2.5, when a specially crafted SIP message is processed by the function `rewrite_ruri`, a crash occurs due to a segmentation fault. This issue causes the server to crash. It affects configurations containing functions that make use of the affected code, such as the function `setport`. This issue has been fixed in version 3.1.8 and 3.2.5.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
  "patch_info": {
    "commit_hash": "b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3",
    "files": [
      "parser/parse_uri.c"
    ],
    "message": "[core] fix parse_uri() parsing\n\nIssue discovered during OpenSIPS Security Audit 2022,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-358f-935m-7p9c",
    "before_after_code_files": [
      "parser/parse_uri.c||parser/parse_uri.c"
    ]
  },
  "patch_diff": {
    "parser/parse_uri.c||parser/parse_uri.c": [
      "File: parser/parse_uri.c -> parser/parse_uri.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1532:   case TELS_URI_T:",
      "1534:    uri->user=uri->host;",
      "1536:    uri->host.len=0;",
      "1537:    break;",
      "1538:   case SIP_URI_T:",
      "",
      "[Removed Lines]",
      "1535:    uri->host.s=\"\";",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1543:   case URN_NENA_SERVICE_URI_T:",
      "1544:    uri->user.s=0;",
      "1545:    uri->user.len=0;",
      "1548:    break;",
      "1549:   case ERROR_URI_T:",
      "1550:    LM_ERR(\"unexpected error (BUG?)\\n\");",
      "",
      "[Removed Lines]",
      "1546:    uri->host.s=\"\";",
      "1547:    uri->host.len=0;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "885e31628be065f4de4404e37f6b551fac927941",
      "candidate_info": {
        "commit_hash": "885e31628be065f4de4404e37f6b551fac927941",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/885e31628be065f4de4404e37f6b551fac927941",
        "files": [
          "parser/parse_uri.c"
        ],
        "message": "[core] fix parse_uri() parsing\n\nIssue discovered during OpenSIPS Security Audit 2022,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-358f-935m-7p9c\n(cherry picked from commit b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3)",
        "before_after_code_files": [
          "parser/parse_uri.c||parser/parse_uri.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "parser/parse_uri.c||parser/parse_uri.c"
          ],
          "candidate": [
            "parser/parse_uri.c||parser/parse_uri.c"
          ]
        }
      },
      "candidate_diff": {
        "parser/parse_uri.c||parser/parse_uri.c": [
          "File: parser/parse_uri.c -> parser/parse_uri.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1532:   case TELS_URI_T:",
          "1534:    uri->user=uri->host;",
          "1536:    uri->host.len=0;",
          "1537:    break;",
          "1538:   case SIP_URI_T:",
          "",
          "[Removed Lines]",
          "1535:    uri->host.s=\"\";",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1543:   case URN_NENA_SERVICE_URI_T:",
          "1544:    uri->user.s=0;",
          "1545:    uri->user.len=0;",
          "1548:    break;",
          "1549:   case ERROR_URI_T:",
          "1550:    LM_ERR(\"unexpected error (BUG?)\\n\");",
          "",
          "[Removed Lines]",
          "1546:    uri->host.s=\"\";",
          "1547:    uri->host.len=0;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "77fff20e6428918c646c6d8be2d536942bf79f52",
      "candidate_info": {
        "commit_hash": "77fff20e6428918c646c6d8be2d536942bf79f52",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/77fff20e6428918c646c6d8be2d536942bf79f52",
        "files": [
          "parser/parse_uri.c"
        ],
        "message": "[core] fix parse_uri() parsing\n\nIssue discovered during OpenSIPS Security Audit 2022,\n\tby Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-358f-935m-7p9c\n(cherry picked from commit b2dffe4b5cd81182c9c8eabb6c96aac96c7acfe3)",
        "before_after_code_files": [
          "parser/parse_uri.c||parser/parse_uri.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "parser/parse_uri.c||parser/parse_uri.c"
          ],
          "candidate": [
            "parser/parse_uri.c||parser/parse_uri.c"
          ]
        }
      },
      "candidate_diff": {
        "parser/parse_uri.c||parser/parse_uri.c": [
          "File: parser/parse_uri.c -> parser/parse_uri.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1532:   case TELS_URI_T:",
          "1534:    uri->user=uri->host;",
          "1536:    uri->host.len=0;",
          "1537:    break;",
          "1538:   case SIP_URI_T:",
          "",
          "[Removed Lines]",
          "1535:    uri->host.s=\"\";",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1543:   case URN_NENA_SERVICE_URI_T:",
          "1544:    uri->user.s=0;",
          "1545:    uri->user.len=0;",
          "1548:    break;",
          "1549:   case ERROR_URI_T:",
          "1550:    LM_ERR(\"unexpected error (BUG?)\\n\");",
          "",
          "[Removed Lines]",
          "1546:    uri->host.s=\"\";",
          "1547:    uri->host.len=0;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "62c7f0127fd7ab193c965d41e4f660600d6a1ede",
      "candidate_info": {
        "commit_hash": "62c7f0127fd7ab193c965d41e4f660600d6a1ede",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/62c7f0127fd7ab193c965d41e4f660600d6a1ede",
        "files": [
          "lib/hash.h"
        ],
        "message": "lib/hash: fix hash_insert\n\nThanks go to Bogdan Iancu for spotting the issue and providing the fix\n\n(cherry picked from commit 36a123856b9953a41a934f3efe0629757ab512a0)",
        "before_after_code_files": [
          "lib/hash.h||lib/hash.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/hash.h||lib/hash.h": [
          "File: lib/hash.h -> lib/hash.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "63: #define hash_get(_h, _e, _k) \\",
          "64:  map_get((_h)->entries[(_e)], _k)",
          "67: #define hash_get_key(_h, _k) \\",
          "68:  hash_get(_h, hash_entry(_h, _k), _k)",
          "",
          "[Removed Lines]",
          "72: #define hash_insert(_h, _e, _k) \\",
          "73:  map_insert((_h)->entries[(_e)], _k)",
          "76: #define hash_insert_key(_h, _k) \\",
          "77:  hash_insert(_h, hash_entry(_h, _k), _k)",
          "",
          "[Added Lines]",
          "72: #define hash_insert(_h, _e, _k, _v) \\",
          "73:  map_put((_h)->entries[(_e)], _k, _v)",
          "76: #define hash_insert_key(_h, _k, _v) \\",
          "77:  hash_insert(_h, hash_entry(_h, _k), _k, _v)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ed7a33a28ff52103e35d33a32e081c1d92c2a893",
      "candidate_info": {
        "commit_hash": "ed7a33a28ff52103e35d33a32e081c1d92c2a893",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/ed7a33a28ff52103e35d33a32e081c1d92c2a893",
        "files": [
          "modules/aaa_diameter/aaa_impl.c",
          "modules/aaa_diameter/aaa_impl.h"
        ],
        "message": "aaa_diameter: Avoid all pthread_cond race conditions\n\nThe recommended usage of the wait/signal pthread_cond_t functions\nincludes using a \"counter\" variable in order to keep track of any\n\"signal\" events happening before the actual \"wait\".\n\nMany thanks to Ryan Caicse (@ryancaicse) for reporting this bug and the\nexcellent fix suggestion!\n\nFixes #2789\n\n(cherry picked from commit 5422799e77662db58d23cbd38bc92875091f177a)",
        "before_after_code_files": [
          "modules/aaa_diameter/aaa_impl.c||modules/aaa_diameter/aaa_impl.c",
          "modules/aaa_diameter/aaa_impl.h||modules/aaa_diameter/aaa_impl.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "modules/aaa_diameter/aaa_impl.c||modules/aaa_diameter/aaa_impl.c": [
          "File: modules/aaa_diameter/aaa_impl.c -> modules/aaa_diameter/aaa_impl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:  pthread_mutex_lock(&rpl_cond->mutex);",
          "196:  pthread_mutex_unlock(&rpl_cond->mutex);",
          "198: out:",
          "",
          "[Removed Lines]",
          "195:  pthread_cond_signal(&rpl_cond->cond);",
          "",
          "[Added Lines]",
          "195:  if (rpl_cond->count == 0)",
          "196:   pthread_cond_signal(&rpl_cond->cond);",
          "197:  rpl_cond->count += 1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1240:   LM_DBG(\"awaiting auth reply...\\n\");",
          "1242:   pthread_mutex_lock(&my_reply_cond->mutex);",
          "1244:   pthread_mutex_unlock(&my_reply_cond->mutex);",
          "1246:   LM_DBG(\"reply received, Result-Code: %d (%s)\\n\", my_reply_cond->rc,",
          "",
          "[Removed Lines]",
          "1243:   pthread_cond_wait(&my_reply_cond->cond, &my_reply_cond->mutex);",
          "",
          "[Added Lines]",
          "1245:   while (my_reply_cond->count == 0)",
          "1246:    pthread_cond_wait(&my_reply_cond->cond, &my_reply_cond->mutex);",
          "1247:   my_reply_cond->count -= 1;",
          "",
          "---------------"
        ],
        "modules/aaa_diameter/aaa_impl.h||modules/aaa_diameter/aaa_impl.h": [
          "File: modules/aaa_diameter/aaa_impl.h -> modules/aaa_diameter/aaa_impl.h"
        ]
      }
    },
    {
      "candidate_hash": "d2496fed59868a676e594cd0594ad24e24897507",
      "candidate_info": {
        "commit_hash": "d2496fed59868a676e594cd0594ad24e24897507",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/d2496fed59868a676e594cd0594ad24e24897507",
        "files": [
          "Makefile.defs",
          "packaging/debian/changelog",
          "packaging/freebsd/Makefile",
          "packaging/netbsd/Makefile",
          "packaging/openbsd/Makefile",
          "packaging/redhat_fedora/opensips.spec",
          "packaging/solaris/base-pkginfo",
          "packaging/solaris/berkeley-pkginfo",
          "packaging/solaris/carrierroute-pkginfo",
          "packaging/solaris/identity-pkginfo",
          "packaging/solaris/ldap-pkginfo",
          "packaging/solaris/mmgeoip-pkginfo",
          "packaging/solaris/mysql-pkginfo",
          "packaging/solaris/perl-pkginfo",
          "packaging/solaris/pgsql-pkginfo",
          "packaging/solaris/pkginfo",
          "packaging/solaris/regex-pkginfo",
          "packaging/solaris/snmp-pkginfo",
          "packaging/solaris/tls-pkginfo",
          "packaging/solaris/xmlrpc-pkginfo"
        ],
        "message": "Bump version to 3.2.8",
        "before_after_code_files": [
          "Makefile.defs||Makefile.defs",
          "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/naveenecosmob/opensips/pull/1",
          "https://github.com/naveenecosmob/opensips/pull/5"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Makefile.defs||Makefile.defs": [
          "File: Makefile.defs -> Makefile.defs",
          "--- Hunk 1 ---",
          "[Context before]",
          "66: #version number",
          "67: VERSION_MAJOR = 3",
          "68: VERSION_MINOR = 2",
          "70: VERSION_BUILD =",
          "72: ifneq (,$(VERSION_BUILD))",
          "",
          "[Removed Lines]",
          "69: VERSION_SUBMINOR = 7",
          "",
          "[Added Lines]",
          "69: VERSION_SUBMINOR = 8",
          "",
          "---------------"
        ],
        "packaging/redhat_fedora/opensips.spec||packaging/redhat_fedora/opensips.spec": [
          "File: packaging/redhat_fedora/opensips.spec -> packaging/redhat_fedora/opensips.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "46: Summary:  Very fast and configurable SIP server",
          "47: Name:     opensips",
          "49: Release:  1%{?dist}",
          "50: License:  GPLv2+",
          "51: Group:    System Environment/Daemons",
          "",
          "[Removed Lines]",
          "48: Version:  3.2.7",
          "",
          "[Added Lines]",
          "48: Version:  3.2.8",
          "",
          "---------------"
        ]
      }
    }
  ]
}