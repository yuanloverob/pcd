{
  "cve_id": "CVE-2022-0336",
  "cve_desc": "The Samba AD DC includes checks when adding service principals names (SPNs) to an account to ensure that SPNs do not alias with those already in the database. Some of these checks are able to be bypassed if an account modification re-adds an SPN that was previously present on that account, such as one added when a computer is joined to a domain. An attacker who has the ability to write to an account can exploit this to perform a denial-of-service attack by adding an SPN that matches an existing service. Additionally, an attacker who can intercept traffic can impersonate existing services, resulting in a loss of confidentiality and integrity.",
  "repo": "samba-team/samba",
  "patch_hash": "1a5dc817c0c9379bbaab14c676681b42b0039a3c",
  "patch_info": {
    "commit_hash": "1a5dc817c0c9379bbaab14c676681b42b0039a3c",
    "repo": "samba-team/samba",
    "commit_url": "https://github.com/samba-team/samba/commit/1a5dc817c0c9379bbaab14c676681b42b0039a3c",
    "files": [
      "selftest/knownfail.d/ldap_spn",
      "source4/dsdb/samdb/ldb_modules/samldb.c"
    ],
    "message": "CVE-2022-0336: s4/dsdb/samldb: Don't return early when an SPN is re-added to an object\n\nIf an added SPN already exists on an object, we still want to check the\nrest of the element values for conflicts.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
    "before_after_code_files": [
      "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
    ]
  },
  "patch_diff": {
    "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c": [
      "File: source4/dsdb/samdb/ldb_modules/samldb.c -> source4/dsdb/samdb/ldb_modules/samldb.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4006:        ac->msg->dn);",
      "4007:   if (ret == LDB_ERR_COMPARE_TRUE) {",
      "4008:    DBG_INFO(\"SPN %s re-added to the same object\\n\", spn);",
      "4011:   }",
      "4012:   if (ret != LDB_SUCCESS) {",
      "4013:    DBG_ERR(\"SPN %s failed direct uniqueness check\\n\", spn);",
      "",
      "[Removed Lines]",
      "4009:    talloc_free(tmp_ctx);",
      "4010:    return LDB_SUCCESS;",
      "",
      "[Added Lines]",
      "4009:    continue;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8d0114ea973cfb610c0edf62f11c72ba1b525b03",
      "candidate_info": {
        "commit_hash": "8d0114ea973cfb610c0edf62f11c72ba1b525b03",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/8d0114ea973cfb610c0edf62f11c72ba1b525b03",
        "files": [
          "selftest/knownfail.d/ldap_spn",
          "source4/dsdb/samdb/ldb_modules/samldb.c"
        ],
        "message": "CVE-2022-0336: s4/dsdb/samldb: Don't return early when an SPN is re-added to an object\n\nIf an added SPN already exists on an object, we still want to check the\nrest of the element values for conflicts.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ],
          "candidate": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c": [
          "File: source4/dsdb/samdb/ldb_modules/samldb.c -> source4/dsdb/samdb/ldb_modules/samldb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4006:        ac->msg->dn);",
          "4007:   if (ret == LDB_ERR_COMPARE_TRUE) {",
          "4008:    DBG_INFO(\"SPN %s re-added to the same object\\n\", spn);",
          "4011:   }",
          "4012:   if (ret != LDB_SUCCESS) {",
          "4013:    DBG_ERR(\"SPN %s failed direct uniqueness check\\n\", spn);",
          "",
          "[Removed Lines]",
          "4009:    talloc_free(tmp_ctx);",
          "4010:    return LDB_SUCCESS;",
          "",
          "[Added Lines]",
          "4009:    continue;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4f18bfaec844f261fa03616c9e55924366dfcf9",
      "candidate_info": {
        "commit_hash": "e4f18bfaec844f261fa03616c9e55924366dfcf9",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/e4f18bfaec844f261fa03616c9e55924366dfcf9",
        "files": [
          "selftest/knownfail.d/ldap_spn",
          "source4/dsdb/samdb/ldb_modules/samldb.c"
        ],
        "message": "CVE-2022-0336: s4/dsdb/samldb: Don't return early when an SPN is re-added to an object\n\nIf an added SPN already exists on an object, we still want to check the\nrest of the element values for conflicts.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ],
          "candidate": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c": [
          "File: source4/dsdb/samdb/ldb_modules/samldb.c -> source4/dsdb/samdb/ldb_modules/samldb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4006:        ac->msg->dn);",
          "4007:   if (ret == LDB_ERR_COMPARE_TRUE) {",
          "4008:    DBG_INFO(\"SPN %s re-added to the same object\\n\", spn);",
          "4011:   }",
          "4012:   if (ret != LDB_SUCCESS) {",
          "4013:    DBG_ERR(\"SPN %s failed direct uniqueness check\\n\", spn);",
          "",
          "[Removed Lines]",
          "4009:    talloc_free(tmp_ctx);",
          "4010:    return LDB_SUCCESS;",
          "",
          "[Added Lines]",
          "4009:    continue;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7a516257ea310fa045bdf14e677eaa97f2a83c33",
      "candidate_info": {
        "commit_hash": "7a516257ea310fa045bdf14e677eaa97f2a83c33",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/7a516257ea310fa045bdf14e677eaa97f2a83c33",
        "files": [
          "selftest/knownfail.d/ldap_spn",
          "source4/dsdb/samdb/ldb_modules/samldb.c"
        ],
        "message": "CVE-2022-0336: s4/dsdb/samldb: Don't return early when an SPN is re-added to an object\n\nIf an added SPN already exists on an object, we still want to check the\nrest of the element values for conflicts.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ],
          "candidate": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c": [
          "File: source4/dsdb/samdb/ldb_modules/samldb.c -> source4/dsdb/samdb/ldb_modules/samldb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4006:        ac->msg->dn);",
          "4007:   if (ret == LDB_ERR_COMPARE_TRUE) {",
          "4008:    DBG_INFO(\"SPN %s re-added to the same object\\n\", spn);",
          "4011:   }",
          "4012:   if (ret != LDB_SUCCESS) {",
          "4013:    DBG_ERR(\"SPN %s failed direct uniqueness check\\n\", spn);",
          "",
          "[Removed Lines]",
          "4009:    talloc_free(tmp_ctx);",
          "4010:    return LDB_SUCCESS;",
          "",
          "[Added Lines]",
          "4009:    continue;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2802b7d8f3f77a639d0d69bced528f328655750b",
      "candidate_info": {
        "commit_hash": "2802b7d8f3f77a639d0d69bced528f328655750b",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/2802b7d8f3f77a639d0d69bced528f328655750b",
        "files": [
          "selftest/knownfail.d/ldap_spn",
          "source4/dsdb/samdb/ldb_modules/samldb.c"
        ],
        "message": "CVE-2022-0336: s4/dsdb/samldb: Don't return early when an SPN is re-added to an object\n\nIf an added SPN already exists on an object, we still want to check the\nrest of the element values for conflicts.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ],
          "candidate": [
            "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c"
          ]
        }
      },
      "candidate_diff": {
        "source4/dsdb/samdb/ldb_modules/samldb.c||source4/dsdb/samdb/ldb_modules/samldb.c": [
          "File: source4/dsdb/samdb/ldb_modules/samldb.c -> source4/dsdb/samdb/ldb_modules/samldb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4001:        ac->msg->dn);",
          "4002:   if (ret == LDB_ERR_COMPARE_TRUE) {",
          "4003:    DBG_INFO(\"SPN %s re-added to the same object\\n\", spn);",
          "4006:   }",
          "4007:   if (ret != LDB_SUCCESS) {",
          "4008:    DBG_ERR(\"SPN %s failed direct uniqueness check\\n\", spn);",
          "",
          "[Removed Lines]",
          "4004:    talloc_free(tmp_ctx);",
          "4005:    return LDB_SUCCESS;",
          "",
          "[Added Lines]",
          "4004:    continue;",
          "",
          "---------------"
        ]
      }
    }
  ]
}