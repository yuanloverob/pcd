{
  "cve_id": "CVE-2024-4030",
  "cve_desc": "On Windows a directory returned by tempfile.mkdtemp() would not always have permissions set to restrict reading and writing to the temporary directory by other users, instead usually inheriting the correct permissions from the default location. Alternate configurations or users without a profile directory may not have the intended permissions.\n\nIf you\u2019re not using Windows or haven\u2019t changed the temporary directory location then you aren\u2019t affected by this vulnerability. On other platforms the returned directory is consistently readable and writable only by the current user.\n\nThis issue was caused by Python not supporting Unix permissions on Windows. The fix adds support for Unix \u201c700\u201d for the mkdir function on Windows which is used by mkdtemp() to ensure the newly created directory has the proper permissions.",
  "repo": "python/cpython",
  "patch_hash": "d86b49411753bf2c83291e3a14ae43fefded2f84",
  "patch_info": {
    "commit_hash": "d86b49411753bf2c83291e3a14ae43fefded2f84",
    "repo": "python/cpython",
    "commit_url": "https://github.com/python/cpython/commit/d86b49411753bf2c83291e3a14ae43fefded2f84",
    "files": [
      "Doc/whatsnew/3.13.rst",
      "Misc/NEWS.d/next/Security/2024-05-01-20-57-09.gh-issue-118486.K44KJG.rst"
    ],
    "message": "gh-118486: Update docs for CVE-2024-4030 reference (GH-118737)\n\nUpdate docs for CVE-2024-4030 reference",
    "before_after_code_files": []
  },
  "patch_diff": {},
  "candidates": [
    {
      "candidate_hash": "2404cd94603bc585e617f0544e34560fa15b2713",
      "candidate_info": {
        "commit_hash": "2404cd94603bc585e617f0544e34560fa15b2713",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/2404cd94603bc585e617f0544e34560fa15b2713",
        "files": [
          "Lib/traceback.py"
        ],
        "message": "[3.13] gh-99180: Make `StackSummary.should_show_carets` private (GH-119554) (#119556)\n\nCo-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>",
        "before_after_code_files": [
          "Lib/traceback.py||Lib/traceback.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/traceback.py||Lib/traceback.py": [
          "File: Lib/traceback.py -> Lib/traceback.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "580:                 show_carets = False",
          "581:                 with suppress(Exception):",
          "582:                     anchors = _extract_caret_anchors_from_line_segment(segment)",
          "585:                 result = []",
          "",
          "[Removed Lines]",
          "583:                 show_carets = self.should_show_carets(start_offset, end_offset, all_lines, anchors)",
          "",
          "[Added Lines]",
          "583:                 show_carets = self._should_show_carets(start_offset, end_offset, all_lines, anchors)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "695:         return ''.join(row)",
          "698:         with suppress(SyntaxError, ImportError):",
          "699:             import ast",
          "700:             tree = ast.parse('\\n'.join(all_lines))",
          "",
          "[Removed Lines]",
          "697:     def should_show_carets(self, start_offset, end_offset, all_lines, anchors):",
          "",
          "[Added Lines]",
          "697:     def _should_show_carets(self, start_offset, end_offset, all_lines, anchors):",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9f0269d6aed1b61996b95dc0730a4008de012011",
      "candidate_info": {
        "commit_hash": "9f0269d6aed1b61996b95dc0730a4008de012011",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/9f0269d6aed1b61996b95dc0730a4008de012011",
        "files": [
          "Python/bltinmodule.c"
        ],
        "message": "[3.13] gh-120526: Correct signature of map() builtin (GH-120528) (GH-120539)\n\nmap() requires at least one iterable arg.\n\n(cherry picked from commit d4039d3f6f8cb7738c5cd272dde04171446dfd2b)\n\nSigned-off-by: Adam Williamson <awilliam@redhat.com>\nCo-authored-by: Adam Williamson <adam@blueradius.ca>",
        "before_after_code_files": [
          "Python/bltinmodule.c||Python/bltinmodule.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Python/bltinmodule.c||Python/bltinmodule.c": [
          "File: Python/bltinmodule.c -> Python/bltinmodule.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1477: PyDoc_STRVAR(map_doc,",
          "1479: --\\n\\",
          "1480: \\n\\",
          "1481: Make an iterator that computes the function using arguments from\\n\\",
          "",
          "[Removed Lines]",
          "1478: \"map(function, /, *iterables)\\n\\",
          "",
          "[Added Lines]",
          "1478: \"map(function, iterable, /, *iterables)\\n\\",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c052b192aaa05eeedb1bd50e0658e2d836ffa581",
      "candidate_info": {
        "commit_hash": "c052b192aaa05eeedb1bd50e0658e2d836ffa581",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/c052b192aaa05eeedb1bd50e0658e2d836ffa581",
        "files": [
          "Include/cpython/pystate.h",
          "Include/internal/pycore_pystate.h",
          "Include/internal/pycore_tstate.h",
          "Modules/_testinternalcapi.c",
          "Python/crossinterp.c",
          "Python/import.c",
          "Python/pylifecycle.c",
          "Python/pystate.c"
        ],
        "message": "[3.13] gh-120838: Add _PyThreadState_WHENCE_FINI (gh-121013)\n\nWe also add _PyThreadState_NewBound() and drop _PyThreadState_SetWhence().\n\nThis change only affects internal API.\n\n(cherry picked from commit a905721b9c5c15279e67c2f7785034b7356b2d46, AKA gh-121010)\n\nCo-authored-by: Eric Snow <ericsnowcurrently@gmail.com>",
        "before_after_code_files": [
          "Include/cpython/pystate.h||Include/cpython/pystate.h",
          "Include/internal/pycore_pystate.h||Include/internal/pycore_pystate.h",
          "Include/internal/pycore_tstate.h||Include/internal/pycore_tstate.h",
          "Modules/_testinternalcapi.c||Modules/_testinternalcapi.c",
          "Python/crossinterp.c||Python/crossinterp.c",
          "Python/import.c||Python/import.c",
          "Python/pylifecycle.c||Python/pylifecycle.c",
          "Python/pystate.c||Python/pystate.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Include/cpython/pystate.h||Include/cpython/pystate.h": [
          "File: Include/cpython/pystate.h -> Include/cpython/pystate.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "97: #ifdef Py_BUILD_CORE",
          "98: #  define _PyThreadState_WHENCE_NOTSET -1",
          "99: #  define _PyThreadState_WHENCE_UNKNOWN 0",
          "104: #endif",
          "105:     int _whence;",
          "",
          "[Removed Lines]",
          "100: #  define _PyThreadState_WHENCE_INTERP 1",
          "101: #  define _PyThreadState_WHENCE_THREADING 2",
          "102: #  define _PyThreadState_WHENCE_GILSTATE 3",
          "103: #  define _PyThreadState_WHENCE_EXEC 4",
          "",
          "[Added Lines]",
          "100: #  define _PyThreadState_WHENCE_INIT 1",
          "101: #  define _PyThreadState_WHENCE_FINI 2",
          "102: #  define _PyThreadState_WHENCE_THREADING 3",
          "103: #  define _PyThreadState_WHENCE_GILSTATE 4",
          "104: #  define _PyThreadState_WHENCE_EXEC 5",
          "",
          "---------------"
        ],
        "Include/internal/pycore_pystate.h||Include/internal/pycore_pystate.h": [
          "File: Include/internal/pycore_pystate.h -> Include/internal/pycore_pystate.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "221:     PyInterpreterState *interp,",
          "222:     int whence);",
          "223: extern void _PyThreadState_Bind(PyThreadState *tstate);",
          "224: extern PyThreadState * _PyThreadState_RemoveExcept(PyThreadState *tstate);",
          "225: extern void _PyThreadState_DeleteList(PyThreadState *list);",
          "226: extern void _PyThreadState_ClearMimallocHeaps(PyThreadState *tstate);",
          "",
          "[Removed Lines]",
          "220: extern PyThreadState * _PyThreadState_New(",
          "",
          "[Added Lines]",
          "221: PyAPI_FUNC(PyThreadState *) _PyThreadState_New(",
          "225: PyAPI_FUNC(PyThreadState *) _PyThreadState_NewBound(",
          "226:     PyInterpreterState *interp,",
          "227:     int whence);",
          "",
          "---------------"
        ],
        "Include/internal/pycore_tstate.h||Include/internal/pycore_tstate.h": [
          "File: Include/internal/pycore_tstate.h -> Include/internal/pycore_tstate.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: #include \"pycore_qsbr.h\"          // struct qsbr",
          "",
          "[Removed Lines]",
          "17: static inline void",
          "18: _PyThreadState_SetWhence(PyThreadState *tstate, int whence)",
          "19: {",
          "20:     tstate->_whence = whence;",
          "21: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "Modules/_testinternalcapi.c||Modules/_testinternalcapi.c": [
          "File: Modules/_testinternalcapi.c -> Modules/_testinternalcapi.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1585:     }",
          "1587:     PyObject *res = NULL;",
          "1591:     PyThreadState *save_tstate = PyThreadState_Swap(tstate);",
          "",
          "[Removed Lines]",
          "1588:     PyThreadState *tstate = PyThreadState_New(interp);",
          "1589:     _PyThreadState_SetWhence(tstate, _PyThreadState_WHENCE_EXEC);",
          "",
          "[Added Lines]",
          "1588:     PyThreadState *tstate =",
          "1589:         _PyThreadState_NewBound(interp, _PyThreadState_WHENCE_EXEC);",
          "",
          "---------------"
        ],
        "Python/crossinterp.c||Python/crossinterp.c": [
          "File: Python/crossinterp.c -> Python/crossinterp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1544:     PyThreadState *tstate = PyThreadState_Get();",
          "1545:     PyThreadState *prev = tstate;",
          "1546:     if (interp != tstate->interp) {",
          "1550:         session->prev_tstate = PyThreadState_Swap(tstate);",
          "1551:         assert(session->prev_tstate == prev);",
          "",
          "[Removed Lines]",
          "1547:         tstate = PyThreadState_New(interp);",
          "1548:         _PyThreadState_SetWhence(tstate, _PyThreadState_WHENCE_EXEC);",
          "",
          "[Added Lines]",
          "1547:         tstate = _PyThreadState_NewBound(interp, _PyThreadState_WHENCE_EXEC);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1895:             tstate = cur_tstate;",
          "1896:         }",
          "1897:         else {",
          "1900:             assert(tstate != NULL);",
          "1901:             save_tstate = PyThreadState_Swap(tstate);",
          "1902:         }",
          "",
          "[Removed Lines]",
          "1898:             tstate = PyThreadState_New(interp);",
          "1899:             _PyThreadState_SetWhence(tstate, _PyThreadState_WHENCE_INTERP);",
          "",
          "[Added Lines]",
          "1897:             tstate = _PyThreadState_NewBound(interp, _PyThreadState_WHENCE_FINI);",
          "",
          "---------------"
        ],
        "Python/import.c||Python/import.c": [
          "File: Python/import.c -> Python/import.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1518:     if (_Py_IsMainInterpreter(tstate->interp)) {",
          "1519:         return tstate;",
          "1520:     }",
          "1522:     if (main_tstate == NULL) {",
          "1523:         return NULL;",
          "1524:     }",
          "1526: #ifndef NDEBUG",
          "1527:     PyThreadState *old_tstate = PyThreadState_Swap(main_tstate);",
          "1528:     assert(old_tstate == tstate);",
          "",
          "[Removed Lines]",
          "1521:     PyThreadState *main_tstate = PyThreadState_New(_PyInterpreterState_Main());",
          "1525:     main_tstate->_whence = _PyThreadState_WHENCE_EXEC;",
          "",
          "[Added Lines]",
          "1521:     PyThreadState *main_tstate = _PyThreadState_NewBound(",
          "1522:             _PyInterpreterState_Main(), _PyThreadState_WHENCE_EXEC);",
          "",
          "---------------"
        ],
        "Python/pylifecycle.c||Python/pylifecycle.c": [
          "File: Python/pylifecycle.c -> Python/pylifecycle.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "677:     }",
          "679:     PyThreadState *tstate = _PyThreadState_New(interp,",
          "681:     if (tstate == NULL) {",
          "682:         return _PyStatus_ERR(\"can't make first thread\");",
          "683:     }",
          "",
          "[Removed Lines]",
          "680:                                                _PyThreadState_WHENCE_INTERP);",
          "",
          "[Added Lines]",
          "680:                                                _PyThreadState_WHENCE_INIT);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2233:         goto error;",
          "2234:     }",
          "2237:     if (tstate == NULL) {",
          "2238:         status = _PyStatus_NO_MEMORY();",
          "2239:         goto error;",
          "",
          "[Removed Lines]",
          "2236:     tstate = _PyThreadState_New(interp, _PyThreadState_WHENCE_INTERP);",
          "",
          "[Added Lines]",
          "2236:     tstate = _PyThreadState_New(interp, _PyThreadState_WHENCE_INIT);",
          "",
          "---------------"
        ],
        "Python/pystate.c||Python/pystate.c": [
          "File: Python/pystate.c -> Python/pystate.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1293:     PyThread_release_lock(interp->id_mutex);",
          "1295:     if (refcount == 0 && interp->requires_idref) {",
          "1301:         PyThreadState *save_tstate = _PyThreadState_Swap(runtime, tstate);",
          "",
          "[Removed Lines]",
          "1296:         PyThreadState *tstate = _PyThreadState_New(interp,",
          "1297:                                                    _PyThreadState_WHENCE_INTERP);",
          "1298:         _PyThreadState_Bind(tstate);",
          "",
          "[Added Lines]",
          "1296:         PyThreadState *tstate =",
          "1297:             _PyThreadState_NewBound(interp, _PyThreadState_WHENCE_FINI);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1603: PyThreadState *",
          "1604: PyThreadState_New(PyInterpreterState *interp)",
          "1605: {",
          "1608:     if (tstate) {",
          "1609:         bind_tstate(tstate);",
          "",
          "[Removed Lines]",
          "1606:     PyThreadState *tstate = new_threadstate(interp,",
          "1607:                                             _PyThreadState_WHENCE_UNKNOWN);",
          "",
          "[Added Lines]",
          "1605:     return _PyThreadState_NewBound(interp, _PyThreadState_WHENCE_UNKNOWN);",
          "1606: }",
          "1608: PyThreadState *",
          "1609: _PyThreadState_NewBound(PyInterpreterState *interp, int whence)",
          "1610: {",
          "1611:     PyThreadState *tstate = new_threadstate(interp, whence);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "312a32a74296229ae1c0c103a3ad2e31af79ff39",
      "candidate_info": {
        "commit_hash": "312a32a74296229ae1c0c103a3ad2e31af79ff39",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/312a32a74296229ae1c0c103a3ad2e31af79ff39",
        "files": [
          "Lib/test/exception_hierarchy.txt",
          "Lib/test/test_baseexception.py"
        ],
        "message": "[3.13] gh-119521: Remove _IncompleteInputError from the docs (GH-120993) (GH-121076)\n\ngh-119521: Remove _IncompleteInputError from the docs (GH-120993)\n(cherry picked from commit 1167a9a30b4b2f327ed987e845e378990d1ae6bf)\n\nCo-authored-by: Petr Viktorin <encukou@gmail.com>",
        "before_after_code_files": [
          "Lib/test/test_baseexception.py||Lib/test/test_baseexception.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/test/test_baseexception.py||Lib/test/test_baseexception.py": [
          "File: Lib/test/test_baseexception.py -> Lib/test/test_baseexception.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                 last_depth = depth",
          "79:         finally:",
          "80:             inheritance_tree.close()",
          "81:         self.assertEqual(len(exc_set), 0, \"%s not accounted for\" % exc_set)",
          "83:     interface_tests = (\"length\", \"args\", \"str\", \"repr\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82:         # Underscore-prefixed (private) exceptions don't need to be documented",
          "83:         exc_set = set(e for e in exc_set if not e.startswith('_'))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f021f9e50e3e4b82b3358dbc977043700179b0f5",
      "candidate_info": {
        "commit_hash": "f021f9e50e3e4b82b3358dbc977043700179b0f5",
        "repo": "python/cpython",
        "commit_url": "https://github.com/python/cpython/commit/f021f9e50e3e4b82b3358dbc977043700179b0f5",
        "files": [
          "Lib/test/test_interpreters/test_stress.py"
        ],
        "message": "[3.13] gh-120524: Temporarily Skip test_create_many_threaded In test_interpreters.test_stress (gh-120527)",
        "before_after_code_files": [
          "Lib/test/test_interpreters/test_stress.py||Lib/test/test_interpreters/test_stress.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/AcreetionOS-Linux/python/pull/2"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Lib/test/test_interpreters/test_stress.py||Lib/test/test_interpreters/test_stress.py": [
          "File: Lib/test/test_interpreters/test_stress.py -> Lib/test/test_interpreters/test_stress.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "22:             interp = interpreters.create()",
          "23:             alive.append(interp)",
          "25:     @support.requires_resource('cpu')",
          "26:     def test_create_many_threaded(self):",
          "27:         alive = []",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25:     @unittest.skip('(temporary) gh-120524: there is a race that needs fixing')",
          "",
          "---------------"
        ]
      }
    }
  ]
}