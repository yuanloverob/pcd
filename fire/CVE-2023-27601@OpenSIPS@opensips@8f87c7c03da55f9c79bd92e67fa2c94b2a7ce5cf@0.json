{
  "cve_id": "CVE-2023-27601",
  "cve_desc": "OpenSIPS is a Session Initiation Protocol (SIP) server implementation. Prior to versions 3.1.7 and 3.2.4, OpenSIPS crashes when a malformed SDP body is received and is processed by the `delete_sdp_line` function in the sipmsgops module. This issue can be reproduced by calling the function with an SDP body that does not terminate by a line feed (i.e. `\\n`).\n\nThe vulnerability was found while performing black-box fuzzing against an OpenSIPS server running a configuration that made use of the functions `codec_delete_except_re` and `codec_delete_re`. The same issue was also discovered while performing coverage guided fuzzing on the function `codec_delete_except_re`. The crash happens because the function `delete_sdp_line` expects that an SDP line is terminated by a line feed (`\\n`):\n\nBy abusing this vulnerability, an attacker is able to crash the server. It affects configurations containing functions that rely on the affected code, such as the function `codec_delete_except_re`. Due to the sanity check that is performed in the `del_lump` function, exploitation of this issue will generate an `abort` in the lumps processing function, resulting in a Denial of Service. This issue has been fixed in versions 3.1.7 and 3.2.4.",
  "repo": "OpenSIPS/opensips",
  "patch_hash": "8f87c7c03da55f9c79bd92e67fa2c94b2a7ce5cf",
  "patch_info": {
    "commit_hash": "8f87c7c03da55f9c79bd92e67fa2c94b2a7ce5cf",
    "repo": "OpenSIPS/opensips",
    "commit_url": "https://github.com/OpenSIPS/opensips/commit/8f87c7c03da55f9c79bd92e67fa2c94b2a7ce5cf",
    "files": [
      "modules/sipmsgops/codecs.c"
    ],
    "message": "[sipmsgops] fix codec_delete_XX() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n        by Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-xj5x-g52f-548h",
    "before_after_code_files": [
      "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
    ]
  },
  "patch_diff": {
    "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c": [
      "File: modules/sipmsgops/codecs.c -> modules/sipmsgops/codecs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "347: }",
      "351: {",
      "352:  char * start,*end;",
      "",
      "[Removed Lines]",
      "350: int delete_sdp_line( struct sip_msg * msg, char * s)",
      "",
      "[Added Lines]",
      "353: int delete_sdp_line( struct sip_msg * msg, char * s, struct sdp_stream_cell *stream)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "357:  start = s;",
      "358:  end  = s;",
      "361:   start--;",
      "362:  start++;",
      "365:   end++;",
      "366:  end++;",
      "",
      "[Removed Lines]",
      "360:  while(*start != '\\n')",
      "364:  while(*end != '\\n')",
      "",
      "[Added Lines]",
      "363:  while(*start != '\\n' && start > stream->body.s)",
      "367:  while(*end != '\\n' && end < (stream->body.s+stream->body.len) )",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "530:     {",
      "534:      {",
      "535:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
      "536:       ret = -1;",
      "537:       goto end;",
      "538:      }",
      "541:      {",
      "542:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
      "543:       ret = -1;",
      "",
      "[Removed Lines]",
      "533:      if( delete_sdp_line( msg, payload->rtp_enc.s) < 0 )",
      "540:      if( delete_sdp_line( msg, payload->fmtp_string.s) < 0 )",
      "",
      "[Added Lines]",
      "536:      if( delete_sdp_line( msg, payload->rtp_enc.s, cell) < 0 )",
      "543:      if( delete_sdp_line( msg, payload->fmtp_string.s, cell) < 0 )",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ee115c0e0cf9dd6e83d81fd22c136b30be7dd6d1",
      "candidate_info": {
        "commit_hash": "ee115c0e0cf9dd6e83d81fd22c136b30be7dd6d1",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/ee115c0e0cf9dd6e83d81fd22c136b30be7dd6d1",
        "files": [
          "modules/sipmsgops/codecs.c"
        ],
        "message": "[sipmsgops] fix codec_delete_XX() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n        by Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-xj5x-g52f-548h\n(cherry picked from commit 8f87c7c03da55f9c79bd92e67fa2c94b2a7ce5cf)",
        "before_after_code_files": [
          "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
          ],
          "candidate": [
            "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
          ]
        }
      },
      "candidate_diff": {
        "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c": [
          "File: modules/sipmsgops/codecs.c -> modules/sipmsgops/codecs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "347: }",
          "351: {",
          "352:  char * start,*end;",
          "",
          "[Removed Lines]",
          "350: int delete_sdp_line( struct sip_msg * msg, char * s)",
          "",
          "[Added Lines]",
          "353: int delete_sdp_line( struct sip_msg * msg, char * s, struct sdp_stream_cell *stream)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "357:  start = s;",
          "358:  end  = s;",
          "361:   start--;",
          "362:  start++;",
          "365:   end++;",
          "366:  end++;",
          "",
          "[Removed Lines]",
          "360:  while(*start != '\\n')",
          "364:  while(*end != '\\n')",
          "",
          "[Added Lines]",
          "363:  while(*start != '\\n' && start > stream->body.s)",
          "367:  while(*end != '\\n' && end < (stream->body.s+stream->body.len) )",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "530:     {",
          "534:      {",
          "535:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
          "536:       ret = -1;",
          "537:       goto end;",
          "538:      }",
          "541:      {",
          "542:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
          "543:       ret = -1;",
          "",
          "[Removed Lines]",
          "533:      if( delete_sdp_line( msg, payload->rtp_enc.s) < 0 )",
          "540:      if( delete_sdp_line( msg, payload->fmtp_string.s) < 0 )",
          "",
          "[Added Lines]",
          "536:      if( delete_sdp_line( msg, payload->rtp_enc.s, cell) < 0 )",
          "543:      if( delete_sdp_line( msg, payload->fmtp_string.s, cell) < 0 )",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b2f934cabd76a5788236d99661eb3baf4d7b3099",
      "candidate_info": {
        "commit_hash": "b2f934cabd76a5788236d99661eb3baf4d7b3099",
        "repo": "OpenSIPS/opensips",
        "commit_url": "https://github.com/OpenSIPS/opensips/commit/b2f934cabd76a5788236d99661eb3baf4d7b3099",
        "files": [
          "modules/sipmsgops/codecs.c"
        ],
        "message": "[sipmsgops] fix codec_delete_XX() parsing\n\nIssue discovered during OpenSIPS Security Audit 2021,\n        by Alfred Farrugia & Sandro Gauci (Enable Security)\n\nhttps://github.com/OpenSIPS/opensips/security/advisories/GHSA-xj5x-g52f-548h\n(cherry picked from commit 8f87c7c03da55f9c79bd92e67fa2c94b2a7ce5cf)",
        "before_after_code_files": [
          "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
          ],
          "candidate": [
            "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c"
          ]
        }
      },
      "candidate_diff": {
        "modules/sipmsgops/codecs.c||modules/sipmsgops/codecs.c": [
          "File: modules/sipmsgops/codecs.c -> modules/sipmsgops/codecs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "347: }",
          "351: {",
          "352:  char * start,*end;",
          "",
          "[Removed Lines]",
          "350: int delete_sdp_line( struct sip_msg * msg, char * s)",
          "",
          "[Added Lines]",
          "353: int delete_sdp_line( struct sip_msg * msg, char * s, struct sdp_stream_cell *stream)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "357:  start = s;",
          "358:  end  = s;",
          "361:   start--;",
          "362:  start++;",
          "365:   end++;",
          "366:  end++;",
          "",
          "[Removed Lines]",
          "360:  while(*start != '\\n')",
          "364:  while(*end != '\\n')",
          "",
          "[Added Lines]",
          "363:  while(*start != '\\n' && start > stream->body.s)",
          "367:  while(*end != '\\n' && end < (stream->body.s+stream->body.len) )",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "530:     {",
          "534:      {",
          "535:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
          "536:       ret = -1;",
          "537:       goto end;",
          "538:      }",
          "541:      {",
          "542:       LM_ERR(\"Unable to add delete lump for a=\\n\");",
          "543:       ret = -1;",
          "",
          "[Removed Lines]",
          "533:      if( delete_sdp_line( msg, payload->rtp_enc.s) < 0 )",
          "540:      if( delete_sdp_line( msg, payload->fmtp_string.s) < 0 )",
          "",
          "[Added Lines]",
          "536:      if( delete_sdp_line( msg, payload->rtp_enc.s, cell) < 0 )",
          "543:      if( delete_sdp_line( msg, payload->fmtp_string.s, cell) < 0 )",
          "",
          "---------------"
        ]
      }
    }
  ]
}