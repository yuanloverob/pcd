{
  "cve_id": "CVE-2024-22365",
  "cve_desc": "linux-pam (aka Linux PAM) before 1.6.0 allows attackers to cause a denial of service (blocked login process) via mkfifo because the openat call (for protect_dir) lacks O_DIRECTORY.",
  "repo": "linux-pam/linux-pam",
  "patch_hash": "031bb5a5d0d950253b68138b498dc93be69a64cb",
  "patch_info": {
    "commit_hash": "031bb5a5d0d950253b68138b498dc93be69a64cb",
    "repo": "linux-pam/linux-pam",
    "commit_url": "https://github.com/linux-pam/linux-pam/commit/031bb5a5d0d950253b68138b498dc93be69a64cb",
    "files": [
      "modules/pam_namespace/pam_namespace.c"
    ],
    "message": "pam_namespace: protect_dir(): use O_DIRECTORY to prevent local DoS situations\n\nWithout O_DIRECTORY the path crawling logic is subject to e.g. FIFOs\nbeing placed in user controlled directories, causing the PAM module to\nblock indefinitely during `openat()`.\n\nPass O_DIRECTORY to cause the `openat()` to fail if the path does not\nrefer to a directory.\n\nWith this the check whether the final path element is a directory\nbecomes unnecessary, drop it.",
    "before_after_code_files": [
      "modules/pam_namespace/pam_namespace.c||modules/pam_namespace/pam_namespace.c"
    ]
  },
  "patch_diff": {
    "modules/pam_namespace/pam_namespace.c||modules/pam_namespace/pam_namespace.c": [
      "File: modules/pam_namespace/pam_namespace.c -> modules/pam_namespace/pam_namespace.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1201:  int dfd = AT_FDCWD;",
      "1202:  int dfd_next;",
      "1203:  int save_errno;",
      "1205:  int rv = -1;",
      "1206:  struct stat st;",
      "",
      "[Removed Lines]",
      "1204:  int flags = O_RDONLY;",
      "",
      "[Added Lines]",
      "1204:  int flags = O_RDONLY | O_DIRECTORY;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1255:   rv = openat(dfd, dir, flags);",
      "1256:  }",
      "1274:  if (flags & O_NOFOLLOW) {",
      "1276:   if (protect_mount(rv, p, idata) == -1) {",
      "",
      "[Removed Lines]",
      "1258:  if (rv != -1) {",
      "1259:   if (fstat(rv, &st) != 0) {",
      "1260:    save_errno = errno;",
      "1261:    close(rv);",
      "1262:    rv = -1;",
      "1263:    errno = save_errno;",
      "1264:    goto error;",
      "1265:   }",
      "1266:   if (!S_ISDIR(st.st_mode)) {",
      "1267:    close(rv);",
      "1268:    errno = ENOTDIR;",
      "1269:    rv = -1;",
      "1270:    goto error;",
      "1271:   }",
      "1272:  }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2dc3367c5f593eb54af4ef31e7c2d100f73eb364",
      "candidate_info": {
        "commit_hash": "2dc3367c5f593eb54af4ef31e7c2d100f73eb364",
        "repo": "linux-pam/linux-pam",
        "commit_url": "https://github.com/linux-pam/linux-pam/commit/2dc3367c5f593eb54af4ef31e7c2d100f73eb364",
        "files": [
          "NEWS",
          "configure.ac",
          "po/Linux-PAM.pot"
        ],
        "message": "Prepare for 1.6.0 release\n\n* configure.ac (AC_INIT): Raise version to 1.6.0.\n* po/Linux-PAM.pot (Project-Id-Version): Likewise.\n* NEWS: Update.\n\nResolves: https://github.com/linux-pam/linux-pam/issues/690",
        "before_after_code_files": [
          "configure.ac||configure.ac",
          "po/Linux-PAM.pot||po/Linux-PAM.pot"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/linux-pam/linux-pam/pull/732"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "configure.ac||configure.ac": [
          "File: configure.ac -> configure.ac",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: dnl Process this file with autoconf to produce a configure script.",
          "3: AC_CONFIG_SRCDIR([conf/pam_conv1/pam_conv_y.y])",
          "4: AC_CONFIG_AUX_DIR([build-aux])",
          "5: AM_INIT_AUTOMAKE([-Wall -Wno-portability])",
          "",
          "[Removed Lines]",
          "2: AC_INIT([Linux-PAM], [1.5.3], , [Linux-PAM])",
          "",
          "[Added Lines]",
          "2: AC_INIT([Linux-PAM], [1.6.0], , [Linux-PAM])",
          "",
          "---------------"
        ],
        "po/Linux-PAM.pot||po/Linux-PAM.pot": [
          "File: po/Linux-PAM.pot -> po/Linux-PAM.pot",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: #, fuzzy",
          "7: msgid \"\"",
          "8: msgstr \"\"",
          "10: \"Report-Msgid-Bugs-To: https://github.com/linux-pam/linux-pam/issues\\n\"",
          "11: \"POT-Creation-Date: 2024-01-16 21:11+0000\\n\"",
          "12: \"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\\n\"",
          "",
          "[Removed Lines]",
          "9: \"Project-Id-Version: Linux-PAM 1.5.3\\n\"",
          "",
          "[Added Lines]",
          "9: \"Project-Id-Version: Linux-PAM 1.6.0\\n\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}