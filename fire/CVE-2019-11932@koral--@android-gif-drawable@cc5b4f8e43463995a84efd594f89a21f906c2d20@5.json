{
  "cve_id": "CVE-2019-11932",
  "cve_desc": "A double free vulnerability in the DDGifSlurp function in decoding.c in the android-gif-drawable library before version 1.2.18, as used in WhatsApp for Android before version 2.19.244 and many other Android applications, allows remote attackers to execute arbitrary code or cause a denial of service when the library is used to parse a specially crafted GIF image.",
  "repo": "koral--/android-gif-drawable",
  "patch_hash": "cc5b4f8e43463995a84efd594f89a21f906c2d20",
  "patch_info": {
    "commit_hash": "cc5b4f8e43463995a84efd594f89a21f906c2d20",
    "repo": "koral--/android-gif-drawable",
    "commit_url": "https://github.com/koral--/android-gif-drawable/commit/cc5b4f8e43463995a84efd594f89a21f906c2d20",
    "files": [
      "android-gif-drawable/src/main/c/decoding.c"
    ],
    "message": "Do not realloc array if new raster size is 0.\n\nif realloc() is called with 0 size it may return NULL and this will be incorrectly handled\nas not enough memory and (also) rasterBits will be freed by realloc but we will not update\nit.",
    "before_after_code_files": [
      "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c"
    ]
  },
  "patch_diff": {
    "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c": [
      "File: android-gif-drawable/src/main/c/decoding.c -> android-gif-drawable/src/main/c/decoding.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "56:     }",
      "58:     if (decode) {",
      "61:      const uint_fast32_t newRasterSize = gifFilePtr->Image.Width * gifFilePtr->Image.Height;",
      "62:      if (newRasterSize > info->rasterSize || widthOverflow > 0 || heightOverflow > 0) {",
      "63:       void *tmpRasterBits = reallocarray(info->rasterBits, newRasterSize, sizeof(GifPixelType));",
      "64:       if (tmpRasterBits == NULL) {",
      "",
      "[Removed Lines]",
      "59:      int_fast32_t widthOverflow = gifFilePtr->Image.Width - info->originalWidth;",
      "60:      int_fast32_t heightOverflow = gifFilePtr->Image.Height - info->originalHeight;",
      "",
      "[Added Lines]",
      "60:      if (newRasterSize == 0) {",
      "61:       free(info->rasterBits);",
      "62:       info->rasterBits = NULL;",
      "63:       info->rasterSize = newRasterSize;",
      "64:       return;",
      "65:      }",
      "66:      const int_fast32_t widthOverflow = gifFilePtr->Image.Width - info->originalWidth;",
      "67:      const int_fast32_t heightOverflow = gifFilePtr->Image.Height - info->originalHeight;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "78df8feb91d8d2557b808494bef24eec91a274d3",
      "candidate_info": {
        "commit_hash": "78df8feb91d8d2557b808494bef24eec91a274d3",
        "repo": "koral--/android-gif-drawable",
        "commit_url": "https://github.com/koral--/android-gif-drawable/commit/78df8feb91d8d2557b808494bef24eec91a274d3",
        "files": [
          "CHANGELOG.md",
          "README.md",
          "android-gif-drawable/gradle.properties"
        ],
        "message": "Release 1.2.18",
        "before_after_code_files": [
          "android-gif-drawable/gradle.properties||android-gif-drawable/gradle.properties"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/koral--/android-gif-drawable/pull/689"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "android-gif-drawable/gradle.properties||android-gif-drawable/gradle.properties": [
          "File: android-gif-drawable/gradle.properties -> android-gif-drawable/gradle.properties",
          "--- Hunk 1 ---",
          "[Context before]",
          "2: GROUP=pl.droidsonroids.gif",
          "4: POM_DESCRIPTION=Views and Drawable for displaying animated GIFs for Android",
          "",
          "[Removed Lines]",
          "1: VERSION_NAME=1.2.18-SNAPSHOT",
          "",
          "[Added Lines]",
          "1: VERSION_NAME=1.2.18",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fd9fd8e21e20c30e5d160b2aaf96c1126cf372d2",
      "candidate_info": {
        "commit_hash": "fd9fd8e21e20c30e5d160b2aaf96c1126cf372d2",
        "repo": "koral--/android-gif-drawable",
        "commit_url": "https://github.com/koral--/android-gif-drawable/commit/fd9fd8e21e20c30e5d160b2aaf96c1126cf372d2",
        "files": [
          "android-gif-drawable/build.gradle",
          "build.gradle",
          "sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt"
        ],
        "message": "Dependency versions bump Replace ReLinker coordinates with droidsonroids group",
        "before_after_code_files": [
          "android-gif-drawable/build.gradle||android-gif-drawable/build.gradle",
          "build.gradle||build.gradle",
          "sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt||sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/koral--/android-gif-drawable/pull/689"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "android-gif-drawable/build.gradle||android-gif-drawable/build.gradle": [
          "File: android-gif-drawable/build.gradle -> android-gif-drawable/build.gradle",
          "--- Hunk 1 ---",
          "[Context before]",
          "68: }",
          "70: dependencies {",
          "72:     compileOnly \"androidx.annotation:annotation:$versions.androidxAnnotations\"",
          "73:     testCompileOnly \"androidx.annotation:annotation:$versions.androidxAnnotations\"",
          "74:     testImplementation \"junit:junit:$versions.junit\"",
          "",
          "[Removed Lines]",
          "71:     implementation \"com.getkeepsafe.relinker:relinker:$versions.relinker\"",
          "",
          "[Added Lines]",
          "71:     implementation \"pl.droidsonroids.relinker:relinker:$versions.relinker\"",
          "",
          "---------------"
        ],
        "build.gradle||build.gradle": [
          "File: build.gradle -> build.gradle",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: buildscript {",
          "2:     ext {",
          "3:         versions = [",
          "6:                 minSdk             : 17,",
          "7:                 androidxAppcompat  : '1.0.2',",
          "8:                 androidxAnnotations: '1.0.0',",
          "11:                 leakCanary         : '1.6.3',",
          "12:                 kotlin             : '1.3.31',",
          "13:                 intellijAnnotations: '13.0',",
          "14:                 material           : '1.0.0',",
          "16:                 jacocoAndroid      : '0.1.4',",
          "18:                 junit              : '4.12',",
          "22:                 assertj1           : '1.7.1',",
          "23:                 concurrentunit     : '0.4.4',",
          "24:                 openglApi          : 'gl1.1-android-2.1_r1',",
          "26:                 relinker           : '1.3.1'",
          "27:         ]",
          "28:     }",
          "",
          "[Removed Lines]",
          "4:                 compileSdk         : 28,",
          "5:                 targetSdk          : 28,",
          "9:                 androidxTest       : '1.1.0',",
          "10:                 coroutines         : '1.1.1',",
          "15:                 androidXextJunit   : '1.0.0',",
          "17:                 androidGradlePlugin: '3.4.0',",
          "19:                 mockito            : '2.27.0',",
          "20:                 robolectric        : '4.2.1',",
          "21:                 assertj3           : '3.12.1',",
          "25:                 mockwebserver      : '3.14.1',",
          "",
          "[Added Lines]",
          "4:                 compileSdk         : 29,",
          "5:                 targetSdk          : 29,",
          "9:                 androidxTest       : '1.2.0',",
          "10:                 coroutines         : '1.2.1',",
          "15:                 androidXextJunit   : '1.1.0',",
          "17:                 androidGradlePlugin: '3.4.1',",
          "19:                 mockito            : '2.28.2',",
          "20:                 robolectric        : '4.3',",
          "21:                 assertj3           : '3.12.2',",
          "25:                 mockwebserver      : '3.14.2',",
          "",
          "---------------"
        ],
        "sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt||sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt": [
          "File: sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt -> sample/src/main/java/pl/droidsonroids/gif/sample/wallpaper/GifWallpaperService.kt",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:         private val eglConnection = OffscreenEGLConnection()",
          "31:         private val gifTexImage2DDrawer = GifTexImage2DProgram(gifTexImage2D)",
          "33:         private var frameIndex = 0",
          "35:         override fun getDesiredMinimumWidth() = gifTexImage2DDrawer.width",
          "",
          "[Removed Lines]",
          "32:         private var renderJob = Job()",
          "",
          "[Added Lines]",
          "32:         private var renderJob: Job = Job()",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "41c29a03d16be32b8174bda9fca2c0cc39673415",
      "candidate_info": {
        "commit_hash": "41c29a03d16be32b8174bda9fca2c0cc39673415",
        "repo": "koral--/android-gif-drawable",
        "commit_url": "https://github.com/koral--/android-gif-drawable/commit/41c29a03d16be32b8174bda9fca2c0cc39673415",
        "files": [
          "android-gif-drawable/src/main/c/gif.h"
        ],
        "message": "Let's defin LOGE as NOOP for release.\n\nThis way it is much easier to user logging.",
        "before_after_code_files": [
          "android-gif-drawable/src/main/c/gif.h||android-gif-drawable/src/main/c/gif.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/koral--/android-gif-drawable/pull/689"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "android-gif-drawable/src/main/c/gif.h||android-gif-drawable/src/main/c/gif.h": [
          "File: android-gif-drawable/src/main/c/gif.h -> android-gif-drawable/src/main/c/gif.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: #include <android/log.h>",
          "32: #define  LOG_TAG    \"libgif\"",
          "33: #define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)",
          "34: #endif",
          "36: #define THROW_ON_NONZERO_RESULT(fun, message) if ((fun) !=0) throwException(env, RUNTIME_EXCEPTION_ERRNO, message)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: #else",
          "35: #define  LOGE(...)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "41de612387e36fe0f7746b44801f81cc48717806",
      "candidate_info": {
        "commit_hash": "41de612387e36fe0f7746b44801f81cc48717806",
        "repo": "koral--/android-gif-drawable",
        "commit_url": "https://github.com/koral--/android-gif-drawable/commit/41de612387e36fe0f7746b44801f81cc48717806",
        "files": [
          "android-gif-drawable/src/main/c/decoding.c"
        ],
        "message": "Do not give up when unknown record type is encountered. Fixes #667",
        "before_after_code_files": [
          "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/koral--/android-gif-drawable/pull/689"
        ],
        "olp_code_files": {
          "patch": [
            "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c"
          ],
          "candidate": [
            "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c"
          ]
        }
      },
      "candidate_diff": {
        "android-gif-drawable/src/main/c/decoding.c||android-gif-drawable/src/main/c/decoding.c": [
          "File: android-gif-drawable/src/main/c/decoding.c -> android-gif-drawable/src/main/c/decoding.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "22:  gifFilePtr = info->gifFilePtr;",
          "23:  uint_fast32_t lastAllocatedGCBIndex = 0;",
          "24:  do {",
          "26:    break;",
          "27:   }",
          "28:   bool isInitialPass = !decode && !exitAfterFrame;",
          "",
          "[Removed Lines]",
          "25:   if (DGifGetRecordType(gifFilePtr, &RecordType) == GIF_ERROR) {",
          "",
          "[Added Lines]",
          "25:   if (DGifGetRecordType(gifFilePtr, &RecordType) == GIF_ERROR && gifFilePtr->Error != D_GIF_ERR_WRONG_RECORD) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "152:    case TERMINATE_RECORD_TYPE:",
          "153:     break;",
          "156:     break;",
          "157:   }",
          "158:  } while (RecordType != TERMINATE_RECORD_TYPE);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "155:    default:",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b30b0022b87b2c780267b02e60fa29e73911ff0f",
      "candidate_info": {
        "commit_hash": "b30b0022b87b2c780267b02e60fa29e73911ff0f",
        "repo": "koral--/android-gif-drawable",
        "commit_url": "https://github.com/koral--/android-gif-drawable/commit/b30b0022b87b2c780267b02e60fa29e73911ff0f",
        "files": [
          "android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java"
        ],
        "message": "Added blocking seekTo method",
        "before_after_code_files": [
          "android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java||android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/koral--/android-gif-drawable/pull/689"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java||android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java": [
          "File: android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java -> android-gif-drawable/src/main/java/pl/droidsonroids/gif/GifDrawable.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "536:   });",
          "537:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "545:  public void seekToBlocking(@IntRange(from = 0, to = Integer.MAX_VALUE) final int position) {",
          "546:   if (position < 0) {",
          "547:    throw new IllegalArgumentException(\"Position is not positive\");",
          "548:   }",
          "550:   synchronized (mNativeInfoHandle) {",
          "551:    mNativeInfoHandle.seekToTime(position, mBuffer);",
          "552:   }",
          "553:   mInvalidationHandler.sendEmptyMessageAtTime(MSG_TYPE_INVALIDATION, 0);",
          "554:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}