{
  "cve_id": "CVE-2021-36146",
  "cve_desc": "ACRN before 2.5 has a devicemodel/hw/pci/xhci.c NULL Pointer Dereference for a trb pointer.",
  "repo": "projectacrn/acrn-hypervisor",
  "patch_hash": "330359921e2e4c2f3f3a10b5bab86942d63c4428",
  "patch_info": {
    "commit_hash": "330359921e2e4c2f3f3a10b5bab86942d63c4428",
    "repo": "projectacrn/acrn-hypervisor",
    "commit_url": "https://github.com/projectacrn/acrn-hypervisor/pull/6173/commits/330359921e2e4c2f3f3a10b5bab86942d63c4428",
    "files": [
      "devicemodel/hw/pci/xhci.c"
    ],
    "message": "DM: xHCI: Check trb pointer before use it\n\nThe trb pointer may be NULL when get the address from user space, add\nthe pointer check before use the trb.\n\nTracked-On: #6172\nSigned-off-by: Liu Long <long.liu@intel.com>\nReviewed-by: Shuo A Liu <shuo.a.liu@intel.com>\nAcked-by: Yu Wang <yu1.wang@intel.com>",
    "before_after_code_files": [
      "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
    ]
  },
  "patch_diff": {
    "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c": [
      "File: devicemodel/hw/pci/xhci.c -> devicemodel/hw/pci/xhci.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2627:  trb = xdev->opregs.cr_p;",
      "2628:  ccs = xdev->opregs.crcr & XHCI_CRCR_LO_RCS;",
      "2629:  crcr = xdev->opregs.crcr & ~0xF;",
      "2631:  while (1) {",
      "2632:   xdev->opregs.cr_p = trb;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2630:  if (!trb) {",
      "2631:   UPRINTF(LDBG, \"Get the invalid guest address!\\r\\n\");",
      "2632:   goto out;",
      "2633:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2759:   }",
      "2760:  }",
      "2762:  xdev->opregs.crcr = crcr | (xdev->opregs.crcr & XHCI_CRCR_LO_CA) | ccs;",
      "2763:  xdev->opregs.crcr &= ~XHCI_CRCR_LO_CRR;",
      "2764:  return 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2766: out:",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "211a961e18efeb61a084664ba4be24cc447d8606",
      "candidate_info": {
        "commit_hash": "211a961e18efeb61a084664ba4be24cc447d8606",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/211a961e18efeb61a084664ba4be24cc447d8606",
        "files": [
          "devicemodel/hw/pci/xhci.c"
        ],
        "message": "DM: xHCI: Check trb pointer before use it\n\nThe trb pointer may be NULL when get the address from user space, add\nthe pointer check before use the trb.\n\nTracked-On: #6172\nSigned-off-by: Liu Long <long.liu@intel.com>\nReviewed-by: Shuo A Liu <shuo.a.liu@intel.com>\nAcked-by: Yu Wang <yu1.wang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c": [
          "File: devicemodel/hw/pci/xhci.c -> devicemodel/hw/pci/xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2627:  trb = xdev->opregs.cr_p;",
          "2628:  ccs = xdev->opregs.crcr & XHCI_CRCR_LO_RCS;",
          "2629:  crcr = xdev->opregs.crcr & ~0xF;",
          "2631:  while (1) {",
          "2632:   xdev->opregs.cr_p = trb;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2630:  if (!trb) {",
          "2631:   UPRINTF(LDBG, \"Get the invalid guest address!\\r\\n\");",
          "2632:   goto out;",
          "2633:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2759:   }",
          "2760:  }",
          "2762:  xdev->opregs.crcr = crcr | (xdev->opregs.crcr & XHCI_CRCR_LO_CA) | ccs;",
          "2763:  xdev->opregs.crcr &= ~XHCI_CRCR_LO_CRR;",
          "2764:  return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2766: out:",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4da04e3f04b8ea3aff613b136bd1dd29f7e25f13",
      "candidate_info": {
        "commit_hash": "4da04e3f04b8ea3aff613b136bd1dd29f7e25f13",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/4da04e3f04b8ea3aff613b136bd1dd29f7e25f13",
        "files": [
          "devicemodel/hw/pci/xhci.c"
        ],
        "message": "DM: xHCI: Check trb pointer before use it\n\nThe trb pointer may be NULL when get the address from user space, add\nthe pointer check before use the trb.\n\nTracked-On: #6172\nSigned-off-by: Liu Long <long.liu@intel.com>\nReviewed-by: Shuo A Liu <shuo.a.liu@intel.com>\nAcked-by: Yu Wang <yu1.wang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c": [
          "File: devicemodel/hw/pci/xhci.c -> devicemodel/hw/pci/xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2626:  trb = xdev->opregs.cr_p;",
          "2627:  ccs = xdev->opregs.crcr & XHCI_CRCR_LO_RCS;",
          "2628:  crcr = xdev->opregs.crcr & ~0xF;",
          "2630:  while (1) {",
          "2631:   xdev->opregs.cr_p = trb;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2629:  if (!trb) {",
          "2630:   UPRINTF(LDBG, \"Get the invalid guest address!\\r\\n\");",
          "2631:   goto out;",
          "2632:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2757:   }",
          "2758:  }",
          "2760:  xdev->opregs.crcr = crcr | (xdev->opregs.crcr & XHCI_CRCR_LO_CA) | ccs;",
          "2761:  xdev->opregs.crcr &= ~XHCI_CRCR_LO_CRR;",
          "2762:  return error;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2764: out:",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ea76e59d77ddf23c574a87a8cf2f2499eae5854f",
      "candidate_info": {
        "commit_hash": "ea76e59d77ddf23c574a87a8cf2f2499eae5854f",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/ea76e59d77ddf23c574a87a8cf2f2499eae5854f",
        "files": [
          "devicemodel/hw/pci/xhci.c"
        ],
        "message": "DM: xHCI: Check trb pointer before use it\n\nThe trb pointer may be NULL when get the address from user space, add\nthe pointer check before use the trb.\n\nTracked-On: #6172\nSigned-off-by: Liu Long <long.liu@intel.com>\nReviewed-by: Shuo A Liu <shuo.a.liu@intel.com>\nAcked-by: Yu Wang <yu1.wang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c": [
          "File: devicemodel/hw/pci/xhci.c -> devicemodel/hw/pci/xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2551:  trb = xdev->opregs.cr_p;",
          "2552:  ccs = xdev->opregs.crcr & XHCI_CRCR_LO_RCS;",
          "2553:  crcr = xdev->opregs.crcr & ~0xF;",
          "2555:  while (1) {",
          "2556:   xdev->opregs.cr_p = trb;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2554:  if (!trb) {",
          "2555:   UPRINTF(LDBG, \"Get the invalid guest address!\\r\\n\");",
          "2556:   goto out;",
          "2557:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2663:   trb = pci_xhci_trb_next(xdev, trb, &crcr);",
          "2664:  }",
          "2666:  xdev->opregs.crcr = crcr | (xdev->opregs.crcr & XHCI_CRCR_LO_CA) | ccs;",
          "2667:  xdev->opregs.crcr &= ~XHCI_CRCR_LO_CRR;",
          "2668:  return error;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2670: out:",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1f17d0f4acbb488f8ba63f43ccd5853c47000ad5",
      "candidate_info": {
        "commit_hash": "1f17d0f4acbb488f8ba63f43ccd5853c47000ad5",
        "repo": "projectacrn/acrn-hypervisor",
        "commit_url": "https://github.com/projectacrn/acrn-hypervisor/commit/1f17d0f4acbb488f8ba63f43ccd5853c47000ad5",
        "files": [
          "devicemodel/hw/pci/xhci.c"
        ],
        "message": "DM: xHCI: Check trb pointer before use it\n\nThe trb pointer may be NULL when get the address from user space, add\nthe pointer check before use the trb.\n\nTracked-On: #6172\nSigned-off-by: Liu Long <long.liu@intel.com>\nReviewed-by: Shuo A Liu <shuo.a.liu@intel.com>\nAcked-by: Yu Wang <yu1.wang@intel.com>",
        "before_after_code_files": [
          "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ],
          "candidate": [
            "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "devicemodel/hw/pci/xhci.c||devicemodel/hw/pci/xhci.c": [
          "File: devicemodel/hw/pci/xhci.c -> devicemodel/hw/pci/xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2552:  trb = xdev->opregs.cr_p;",
          "2553:  ccs = xdev->opregs.crcr & XHCI_CRCR_LO_RCS;",
          "2554:  crcr = xdev->opregs.crcr & ~0xF;",
          "2556:  while (1) {",
          "2557:   xdev->opregs.cr_p = trb;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2555:  if (!trb) {",
          "2556:   UPRINTF(LDBG, \"Get the invalid guest address!\\r\\n\");",
          "2557:   goto out;",
          "2558:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2677:   trb = pci_xhci_trb_next(xdev, trb, &crcr);",
          "2678:  }",
          "2680:  xdev->opregs.crcr = crcr | (xdev->opregs.crcr & XHCI_CRCR_LO_CA) | ccs;",
          "2681:  xdev->opregs.crcr &= ~XHCI_CRCR_LO_CRR;",
          "2682:  return error;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2684: out:",
          "",
          "---------------"
        ]
      }
    }
  ]
}