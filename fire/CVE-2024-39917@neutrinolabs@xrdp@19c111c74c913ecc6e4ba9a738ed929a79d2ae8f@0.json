{
  "cve_id": "CVE-2024-39917",
  "cve_desc": "xrdp is an open source RDP server. xrdp versions prior to 0.10.0 have a vulnerability that allows attackers to make an infinite number of login attempts. The number of max login attempts is supposed to be  limited by a configuration parameter `MaxLoginRetry` in `/etc/xrdp/sesman.ini`. However, this mechanism was not effectively working. As a result, xrdp allows an infinite number of login attempts. ",
  "repo": "neutrinolabs/xrdp",
  "patch_hash": "19c111c74c913ecc6e4ba9a738ed929a79d2ae8f",
  "patch_info": {
    "commit_hash": "19c111c74c913ecc6e4ba9a738ed929a79d2ae8f",
    "repo": "neutrinolabs/xrdp",
    "commit_url": "https://github.com/neutrinolabs/xrdp/commit/19c111c74c913ecc6e4ba9a738ed929a79d2ae8f",
    "files": [
      "docs/man/xrdp.ini.5.in",
      "libxrdp/xrdp_sec.c",
      "xrdp/xrdp.ini.in",
      "xrdp/xrdp_mm.c"
    ],
    "message": "Merge pull request from GHSA-7w22-h4w7-8j5j\n\nEnforce no login screen if require_credentials is set",
    "before_after_code_files": [
      "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
      "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
      "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
    ]
  },
  "patch_diff": {
    "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c": [
      "File: libxrdp/xrdp_sec.c -> libxrdp/xrdp_sec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1012:         return 1;",
      "1013:     }",
      "1015:     if (flags & RDP_LOGON_AUTO)",
      "1016:     {",
      "1017:         if (ts_info_utf16_in(s, len_password, self->rdp_layer->client_info.password, sizeof(self->rdp_layer->client_info.password)) != 0)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1016:     if (self->rdp_layer->client_info.require_credentials)",
      "1017:     {",
      "1018:         if ((flags & RDP_LOGON_AUTO) == 0)",
      "1019:         {",
      "1020:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
      "1021:                 \"client enable auto logon with credentials, but the client did \"",
      "1022:                 \"not request auto logon.\");",
      "1023:             return 1;",
      "1024:         }",
      "1025:         if (len_user == 0 || len_password == 0)",
      "1026:         {",
      "1027:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
      "1028:                 \"client enable auto logon with credentials, but the client did \"",
      "1029:                 \"not supply both a username and password.\");",
      "1030:             return 1;",
      "1031:         }",
      "1032:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1033:     }",
      "1034:     else",
      "1035:     {",
      "1036:         if (!s_check_rem_and_log(s, len_password + 2, \"Parsing [MS-RDPBCGR] TS_INFO_PACKET Password\"))",
      "1037:         {",
      "1038:             return 1;",
      "1039:         }",
      "1040:         in_uint8s(s, len_password + 2);",
      "1048:     }",
      "1049:     if (self->rdp_layer->client_info.domain_user_separator[0] != '\\0'",
      "1050:             && self->rdp_layer->client_info.domain[0] != '\\0')",
      "",
      "[Removed Lines]",
      "1041:         if (self->rdp_layer->client_info.require_credentials)",
      "1042:         {",
      "1043:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
      "1044:                 \"client enable auto logon with credentials, but the client did \"",
      "1045:                 \"not request auto logon.\");",
      "1047:         }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in": [
      "File: xrdp/xrdp.ini.in -> xrdp/xrdp.ini.in",
      "--- Hunk 1 ---",
      "[Context before]",
      "94: new_cursors=true",
      "95: ; fastpath - can be 'input', 'output', 'both', 'none'",
      "96: use_fastpath=both",
      "98: #require_credentials=true",
      "99: ; when true, the userid will be used to try to authenticate",
      "100: #enable_token_login=true",
      "",
      "[Removed Lines]",
      "97: ; when true, userid/password *must* be passed on cmd line",
      "",
      "[Added Lines]",
      "97: ; when true, userid/password *must* be passed on cmd line. If the password",
      "98: ; is incorrect, the login will fail",
      "",
      "---------------"
    ],
    "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c": [
      "File: xrdp/xrdp_mm.c -> xrdp/xrdp_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2803:                                 self->wm->pamerrortxt);",
      "2804:             }",
      "2806:             if (server_closed)",
      "2807:             {",
      "2808:                 if (login_result == E_SCP_LOGIN_NOT_AUTHENTICATED)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2806:             if (self->wm->client_info->require_credentials)",
      "2807:             {",
      "2809:                 g_set_wait_obj(self->wm->pro_layer->self_term_event);",
      "2810:                 LOG(LOG_LEVEL_ERROR, \"require_credentials is set, \"",
      "2811:                     \"but the user could not be logged in\");",
      "2812:             }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a7d583a46d9d23ca6885607e87edf5f12654caf9",
      "candidate_info": {
        "commit_hash": "a7d583a46d9d23ca6885607e87edf5f12654caf9",
        "repo": "neutrinolabs/xrdp",
        "commit_url": "https://github.com/neutrinolabs/xrdp/commit/a7d583a46d9d23ca6885607e87edf5f12654caf9",
        "files": [
          "docs/man/xrdp.ini.5.in",
          "libxrdp/xrdp_sec.c",
          "xrdp/xrdp.ini.in",
          "xrdp/xrdp_mm.c"
        ],
        "message": "Merge pull request from GHSA-7w22-h4w7-8j5j\n\nEnforce no login screen if require_credentials is set",
        "before_after_code_files": [
          "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
          "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
          "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
            "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
            "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
          ],
          "candidate": [
            "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
            "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
            "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
          ]
        }
      },
      "candidate_diff": {
        "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c": [
          "File: libxrdp/xrdp_sec.c -> libxrdp/xrdp_sec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1012:         return 1;",
          "1013:     }",
          "1015:     if (flags & RDP_LOGON_AUTO)",
          "1016:     {",
          "1017:         if (ts_info_utf16_in(s, len_password, self->rdp_layer->client_info.password, sizeof(self->rdp_layer->client_info.password)) != 0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1016:     if (self->rdp_layer->client_info.require_credentials)",
          "1017:     {",
          "1018:         if ((flags & RDP_LOGON_AUTO) == 0)",
          "1019:         {",
          "1020:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1021:                 \"client enable auto logon with credentials, but the client did \"",
          "1022:                 \"not request auto logon.\");",
          "1023:             return 1;",
          "1024:         }",
          "1025:         if (len_user == 0 || len_password == 0)",
          "1026:         {",
          "1027:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1028:                 \"client enable auto logon with credentials, but the client did \"",
          "1029:                 \"not supply both a username and password.\");",
          "1030:             return 1;",
          "1031:         }",
          "1032:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1033:     }",
          "1034:     else",
          "1035:     {",
          "1036:         if (!s_check_rem_and_log(s, len_password + 2, \"Parsing [MS-RDPBCGR] TS_INFO_PACKET Password\"))",
          "1037:         {",
          "1038:             return 1;",
          "1039:         }",
          "1040:         in_uint8s(s, len_password + 2);",
          "1048:     }",
          "1049:     if (self->rdp_layer->client_info.domain_user_separator[0] != '\\0'",
          "1050:             && self->rdp_layer->client_info.domain[0] != '\\0')",
          "",
          "[Removed Lines]",
          "1041:         if (self->rdp_layer->client_info.require_credentials)",
          "1042:         {",
          "1043:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1044:                 \"client enable auto logon with credentials, but the client did \"",
          "1045:                 \"not request auto logon.\");",
          "1047:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in": [
          "File: xrdp/xrdp.ini.in -> xrdp/xrdp.ini.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "88: new_cursors=true",
          "89: ; fastpath - can be 'input', 'output', 'both', 'none'",
          "90: use_fastpath=both",
          "92: #require_credentials=true",
          "93: ; when true, the userid will be used to try to authenticate",
          "94: #enable_token_login=true",
          "",
          "[Removed Lines]",
          "91: ; when true, userid/password *must* be passed on cmd line",
          "",
          "[Added Lines]",
          "91: ; when true, userid/password *must* be passed on cmd line. If the password",
          "92: ; is incorrect, the login will fail",
          "",
          "---------------"
        ],
        "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c": [
          "File: xrdp/xrdp_mm.c -> xrdp/xrdp_mm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2687:                                 self->wm->pamerrortxt);",
          "2688:             }",
          "2690:             if (server_closed)",
          "2691:             {",
          "2692:                 if (login_result == E_SCP_LOGIN_NOT_AUTHENTICATED)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2690:             if (self->wm->client_info->require_credentials)",
          "2691:             {",
          "2693:                 g_set_wait_obj(self->wm->pro_layer->self_term_event);",
          "2694:                 LOG(LOG_LEVEL_ERROR, \"require_credentials is set, \"",
          "2695:                     \"but the user could not be logged in\");",
          "2696:             }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dd69d3919da632107c489ec8bd1b82c17512561a",
      "candidate_info": {
        "commit_hash": "dd69d3919da632107c489ec8bd1b82c17512561a",
        "repo": "neutrinolabs/xrdp",
        "commit_url": "https://github.com/neutrinolabs/xrdp/commit/dd69d3919da632107c489ec8bd1b82c17512561a",
        "files": [
          "docs/man/xrdp.ini.5.in",
          "libxrdp/xrdp_sec.c",
          "xrdp/xrdp.ini.in",
          "xrdp/xrdp_mm.c"
        ],
        "message": "Merge pull request from GHSA-7w22-h4w7-8j5j\n\nEnforce no login screen if require_credentials is set",
        "before_after_code_files": [
          "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
          "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
          "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
            "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
            "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
          ],
          "candidate": [
            "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c",
            "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in",
            "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c"
          ]
        }
      },
      "candidate_diff": {
        "libxrdp/xrdp_sec.c||libxrdp/xrdp_sec.c": [
          "File: libxrdp/xrdp_sec.c -> libxrdp/xrdp_sec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1012:         return 1;",
          "1013:     }",
          "1015:     if (flags & RDP_LOGON_AUTO)",
          "1016:     {",
          "1017:         if (unicode_utf16_in(s, len_password, self->rdp_layer->client_info.password, sizeof(self->rdp_layer->client_info.password) - 1) != 0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1016:     if (self->rdp_layer->client_info.require_credentials)",
          "1017:     {",
          "1018:         if ((flags & RDP_LOGON_AUTO) == 0)",
          "1019:         {",
          "1020:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1021:                 \"client enable auto logon with credentials, but the client did \"",
          "1022:                 \"not request auto logon.\");",
          "1023:             return 1;",
          "1024:         }",
          "1025:         if (len_user == 0 || len_password == 0)",
          "1026:         {",
          "1027:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1028:                 \"client enable auto logon with credentials, but the client did \"",
          "1029:                 \"not supply both a username and password.\");",
          "1030:             return 1;",
          "1031:         }",
          "1032:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1033:     }",
          "1034:     else",
          "1035:     {",
          "1036:         if (!s_check_rem_and_log(s, len_password + 2, \"Parsing [MS-RDPBCGR] TS_INFO_PACKET Password\"))",
          "1037:         {",
          "1038:             return 1;",
          "1039:         }",
          "1040:         in_uint8s(s, len_password + 2);",
          "1048:     }",
          "1049:     if (self->rdp_layer->client_info.domain_user_separator[0] != '\\0'",
          "1050:             && self->rdp_layer->client_info.domain[0] != '\\0')",
          "",
          "[Removed Lines]",
          "1041:         if (self->rdp_layer->client_info.require_credentials)",
          "1042:         {",
          "1043:             LOG(LOG_LEVEL_ERROR, \"Server is configured to require that the \"",
          "1044:                 \"client enable auto logon with credentials, but the client did \"",
          "1045:                 \"not request auto logon.\");",
          "1047:         }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "xrdp/xrdp.ini.in||xrdp/xrdp.ini.in": [
          "File: xrdp/xrdp.ini.in -> xrdp/xrdp.ini.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "85: new_cursors=true",
          "86: ; fastpath - can be 'input', 'output', 'both', 'none'",
          "87: use_fastpath=both",
          "89: #require_credentials=true",
          "90: ; when true, the userid will be used to try to authenticate",
          "91: #enable_token_login=true",
          "",
          "[Removed Lines]",
          "88: ; when true, userid/password *must* be passed on cmd line",
          "",
          "[Added Lines]",
          "88: ; when true, userid/password *must* be passed on cmd line. If the password",
          "89: ; is incorrect, the login will fail",
          "",
          "---------------"
        ],
        "xrdp/xrdp_mm.c||xrdp/xrdp_mm.c": [
          "File: xrdp/xrdp_mm.c -> xrdp/xrdp_mm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1883:         {",
          "1885:             cleanup_sesman_connection(self);",
          "1886:             xrdp_wm_mod_connect_done(self->wm, 1);",
          "1887:         }",
          "1888:         else",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1886:             if (self->wm->client_info->require_credentials)",
          "1887:             {",
          "1889:                 g_set_wait_obj(self->wm->pro_layer->self_term_event);",
          "1890:                 LOG(LOG_LEVEL_ERROR, \"require_credentials is set, \"",
          "1891:                     \"but the user could not be logged in\");",
          "1892:             }",
          "",
          "---------------"
        ]
      }
    }
  ]
}