{
  "cve_id": "CVE-2022-0336",
  "cve_desc": "The Samba AD DC includes checks when adding service principals names (SPNs) to an account to ensure that SPNs do not alias with those already in the database. Some of these checks are able to be bypassed if an account modification re-adds an SPN that was previously present on that account, such as one added when a computer is joined to a domain. An attacker who has the ability to write to an account can exploit this to perform a denial-of-service attack by adding an SPN that matches an existing service. Additionally, an attacker who can intercept traffic can impersonate existing services, resulting in a loss of confidentiality and integrity.",
  "repo": "samba-team/samba",
  "patch_hash": "c58ede44f382bd0125f761f0479c8d48156be400",
  "patch_info": {
    "commit_hash": "c58ede44f382bd0125f761f0479c8d48156be400",
    "repo": "samba-team/samba",
    "commit_url": "https://github.com/samba-team/samba/commit/c58ede44f382bd0125f761f0479c8d48156be400",
    "files": [
      "python/samba/tests/ldap_spn.py",
      "selftest/knownfail.d/ldap_spn"
    ],
    "message": "CVE-2022-0336: pytest: Add a test for an SPN conflict with a re-added SPN\n\nThis test currently fails, as re-adding an SPN means that later checks\ndo not run.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
    "before_after_code_files": [
      "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
    ]
  },
  "patch_diff": {
    "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py": [
      "File: python/samba/tests/ldap_spn.py -> python/samba/tests/ldap_spn.py",
      "--- Hunk 1 ---",
      "[Context before]",
      "268:             for k in ('dNSHostName', 'servicePrincipalName'):",
      "269:                 if isinstance(m.get(k), str):",
      "270:                     m[k] = m[k].format(dnsname=f\"x.{REALM}\")",
      "272:             msg = ldb.Message.from_dict(samdb, m, op)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "271:                 elif isinstance(m.get(k), list):",
      "272:                     m[k] = [x.format(dnsname=f\"x.{REALM}\") for x in m[k]]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "727:          ('user:C', 'host/{dnsname}', '*', ok),",
      "728:          ('user:D', 'www/{dnsname}', 'D', denied),",
      "729:         ),",
      "731:         (\"changing dNSHostName after host\",",
      "732:          ('A', {'dNSHostName': '{dnsname}'}, '*', ok),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "732:         (\"add a conflict, along with a re-added SPN\",",
      "733:          ('A', 'cifs/{dnsname}', '*', ok),",
      "734:          ('B', 'cifs/heeble.example.net', 'B', ok),",
      "735:          ('B', ['cifs/heeble.example.net', 'host/{dnsname}'], 'B', constraint),",
      "736:         ),",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7368e0051a320fce48c1f303914b62985a40beb0",
      "candidate_info": {
        "commit_hash": "7368e0051a320fce48c1f303914b62985a40beb0",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/7368e0051a320fce48c1f303914b62985a40beb0",
        "files": [
          "python/samba/tests/ldap_spn.py",
          "selftest/knownfail.d/ldap_spn"
        ],
        "message": "CVE-2022-0336: pytest: Add a test for an SPN conflict with a re-added SPN\n\nThis test currently fails, as re-adding an SPN means that later checks\ndo not run.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ],
          "candidate": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ]
        }
      },
      "candidate_diff": {
        "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py": [
          "File: python/samba/tests/ldap_spn.py -> python/samba/tests/ldap_spn.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:             for k in ('dNSHostName', 'servicePrincipalName'):",
          "269:                 if isinstance(m.get(k), str):",
          "270:                     m[k] = m[k].format(dnsname=f\"x.{REALM}\")",
          "272:             msg = ldb.Message.from_dict(samdb, m, op)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271:                 elif isinstance(m.get(k), list):",
          "272:                     m[k] = [x.format(dnsname=f\"x.{REALM}\") for x in m[k]]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "727:          ('user:C', 'host/{dnsname}', '*', ok),",
          "728:          ('user:D', 'www/{dnsname}', 'D', denied),",
          "729:         ),",
          "731:         (\"changing dNSHostName after host\",",
          "732:          ('A', {'dNSHostName': '{dnsname}'}, '*', ok),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "732:         (\"add a conflict, along with a re-added SPN\",",
          "733:          ('A', 'cifs/{dnsname}', '*', ok),",
          "734:          ('B', 'cifs/heeble.example.net', 'B', ok),",
          "735:          ('B', ['cifs/heeble.example.net', 'host/{dnsname}'], 'B', constraint),",
          "736:         ),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eaede91afd6d171539aa5298644aa5fb107a6341",
      "candidate_info": {
        "commit_hash": "eaede91afd6d171539aa5298644aa5fb107a6341",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/eaede91afd6d171539aa5298644aa5fb107a6341",
        "files": [
          "python/samba/tests/ldap_spn.py",
          "selftest/knownfail.d/ldap_spn"
        ],
        "message": "CVE-2022-0336: pytest: Add a test for an SPN conflict with a re-added SPN\n\nThis test currently fails, as re-adding an SPN means that later checks\ndo not run.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ],
          "candidate": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ]
        }
      },
      "candidate_diff": {
        "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py": [
          "File: python/samba/tests/ldap_spn.py -> python/samba/tests/ldap_spn.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:             for k in ('dNSHostName', 'servicePrincipalName'):",
          "269:                 if isinstance(m.get(k), str):",
          "270:                     m[k] = m[k].format(dnsname=f\"x.{REALM}\")",
          "272:             msg = ldb.Message.from_dict(samdb, m, op)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271:                 elif isinstance(m.get(k), list):",
          "272:                     m[k] = [x.format(dnsname=f\"x.{REALM}\") for x in m[k]]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "727:          ('user:C', 'host/{dnsname}', '*', ok),",
          "728:          ('user:D', 'www/{dnsname}', 'D', denied),",
          "729:         ),",
          "731:         (\"changing dNSHostName after host\",",
          "732:          ('A', {'dNSHostName': '{dnsname}'}, '*', ok),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "732:         (\"add a conflict, along with a re-added SPN\",",
          "733:          ('A', 'cifs/{dnsname}', '*', ok),",
          "734:          ('B', 'cifs/heeble.example.net', 'B', ok),",
          "735:          ('B', ['cifs/heeble.example.net', 'host/{dnsname}'], 'B', constraint),",
          "736:         ),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c4d576baaf09c418db6e706a33b8424b0781e5fc",
      "candidate_info": {
        "commit_hash": "c4d576baaf09c418db6e706a33b8424b0781e5fc",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/c4d576baaf09c418db6e706a33b8424b0781e5fc",
        "files": [
          "python/samba/tests/ldap_spn.py",
          "selftest/knownfail.d/ldap_spn"
        ],
        "message": "CVE-2022-0336: pytest: Add a test for an SPN conflict with a re-added SPN\n\nThis test currently fails, as re-adding an SPN means that later checks\ndo not run.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ],
          "candidate": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ]
        }
      },
      "candidate_diff": {
        "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py": [
          "File: python/samba/tests/ldap_spn.py -> python/samba/tests/ldap_spn.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:             for k in ('dNSHostName', 'servicePrincipalName'):",
          "269:                 if isinstance(m.get(k), str):",
          "270:                     m[k] = m[k].format(dnsname=f\"x.{REALM}\")",
          "272:             msg = ldb.Message.from_dict(samdb, m, op)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271:                 elif isinstance(m.get(k), list):",
          "272:                     m[k] = [x.format(dnsname=f\"x.{REALM}\") for x in m[k]]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "727:          ('user:C', 'host/{dnsname}', '*', ok),",
          "728:          ('user:D', 'www/{dnsname}', 'D', denied),",
          "729:         ),",
          "731:         (\"changing dNSHostName after host\",",
          "732:          ('A', {'dNSHostName': '{dnsname}'}, '*', ok),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "732:         (\"add a conflict, along with a re-added SPN\",",
          "733:          ('A', 'cifs/{dnsname}', '*', ok),",
          "734:          ('B', 'cifs/heeble.example.net', 'B', ok),",
          "735:          ('B', ['cifs/heeble.example.net', 'host/{dnsname}'], 'B', constraint),",
          "736:         ),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d392b10c55bbcedda01fdd87fe6035fa3a6986b3",
      "candidate_info": {
        "commit_hash": "d392b10c55bbcedda01fdd87fe6035fa3a6986b3",
        "repo": "samba-team/samba",
        "commit_url": "https://github.com/samba-team/samba/commit/d392b10c55bbcedda01fdd87fe6035fa3a6986b3",
        "files": [
          "python/samba/tests/ldap_spn.py",
          "selftest/knownfail.d/ldap_spn"
        ],
        "message": "CVE-2022-0336: pytest: Add a test for an SPN conflict with a re-added SPN\n\nThis test currently fails, as re-adding an SPN means that later checks\ndo not run.\n\nBUG: https://bugzilla.samba.org/show_bug.cgi?id=14950\n\nSigned-off-by: Joseph Sutton <josephsutton@catalyst.net.nz>\nReviewed-by: Douglas Bagnall <douglas.bagnall@catalyst.net.nz>",
        "before_after_code_files": [
          "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ],
          "candidate": [
            "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py"
          ]
        }
      },
      "candidate_diff": {
        "python/samba/tests/ldap_spn.py||python/samba/tests/ldap_spn.py": [
          "File: python/samba/tests/ldap_spn.py -> python/samba/tests/ldap_spn.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "268:             for k in ('dNSHostName', 'servicePrincipalName'):",
          "269:                 if isinstance(m.get(k), str):",
          "270:                     m[k] = m[k].format(dnsname=f\"x.{REALM}\")",
          "272:             msg = ldb.Message.from_dict(samdb, m, op)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "271:                 elif isinstance(m.get(k), list):",
          "272:                     m[k] = [x.format(dnsname=f\"x.{REALM}\") for x in m[k]]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "727:          ('user:C', 'host/{dnsname}', '*', ok),",
          "728:          ('user:D', 'www/{dnsname}', 'D', denied),",
          "729:         ),",
          "731:         (\"changing dNSHostName after host\",",
          "732:          ('A', {'dNSHostName': '{dnsname}'}, '*', ok),",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "732:         (\"add a conflict, along with a re-added SPN\",",
          "733:          ('A', 'cifs/{dnsname}', '*', ok),",
          "734:          ('B', 'cifs/heeble.example.net', 'B', ok),",
          "735:          ('B', ['cifs/heeble.example.net', 'host/{dnsname}'], 'B', constraint),",
          "736:         ),",
          "",
          "---------------"
        ]
      }
    }
  ]
}