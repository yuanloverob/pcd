{
  "cve_id": "CVE-2022-3976",
  "cve_desc": "A vulnerability has been found in MZ Automation libiec61850 up to 1.4 and classified as critical. This vulnerability affects unknown code of the file src/mms/iso_mms/client/mms_client_files.c of the component MMS File Services. The manipulation of the argument filename leads to path traversal. Upgrading to version 1.5 is able to address this issue. The name of the patch is 10622ba36bb3910c151348f1569f039ecdd8786f. It is recommended to upgrade the affected component. The identifier of this vulnerability is VDB-213556.",
  "repo": "mz-automation/libiec61850",
  "patch_hash": "10622ba36bb3910c151348f1569f039ecdd8786f",
  "patch_info": {
    "commit_hash": "10622ba36bb3910c151348f1569f039ecdd8786f",
    "repo": "mz-automation/libiec61850",
    "commit_url": "https://github.com/mz-automation/libiec61850/commit/10622ba36bb3910c151348f1569f039ecdd8786f",
    "files": [
      "hal/filesystem/linux/file_provider_linux.c",
      "src/mms/inc_private/mms_common_internal.h",
      "src/mms/iso_mms/client/mms_client_files.c",
      "src/mms/iso_mms/common/mms_common_msg.c",
      "src/mms/iso_mms/server/mms_file_service.c"
    ],
    "message": "- fixed path traversal vulnerability in MMS file services (LIB61850-357)",
    "before_after_code_files": [
      "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c",
      "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h",
      "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c",
      "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c",
      "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c"
    ]
  },
  "patch_diff": {
    "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c": [
      "File: hal/filesystem/linux/file_provider_linux.c -> hal/filesystem/linux/file_provider_linux.c"
    ],
    "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h": [
      "File: src/mms/inc_private/mms_common_internal.h -> src/mms/inc_private/mms_common_internal.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "82: LIB61850_INTERNAL FileHandle",
      "83: mmsMsg_openFile(const char* basepath, char* fileName, bool readWrite);",
      "87: typedef struct sMmsServiceError",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "85: LIB61850_INTERNAL bool",
      "86: mmsMsg_isFilenameSave(const char* filename);",
      "",
      "---------------"
    ],
    "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c": [
      "File: src/mms/iso_mms/client/mms_client_files.c -> src/mms/iso_mms/client/mms_client_files.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "126:     if (hasFileName) {",
      "153:             }",
      "154:             else",
      "157:         }",
      "160:     }",
      "161:     else",
      "162:         goto exit_invalid_parameter;",
      "",
      "[Removed Lines]",
      "128:         MmsFileReadStateMachine* frsm = getFreeFrsm(connection);",
      "130:         if (frsm != NULL) {",
      "132:             MmsOutstandingCall obtainFileCall = mmsClient_getMatchingObtainFileRequest(connection, filename);",
      "134:             if (obtainFileCall) {",
      "136:                 if (DEBUG_MMS_CLIENT)",
      "137:                     printf(\"MMS_CLIENT: file open is matching obtain file request for file %s\\n\", filename);",
      "139:                 obtainFileCall->timeout = Hal_getTimeInMs() + connection->requestTimeout;",
      "140:             }",
      "142:             FileHandle fileHandle = mmsMsg_openFile(MmsConnection_getFilestoreBasepath(connection), filename, false);",
      "144:             if (fileHandle != NULL) {",
      "146:                 frsm->fileHandle = fileHandle;",
      "147:                 frsm->readPosition = filePosition;",
      "148:                 frsm->frsmId = getNextFrsmId(connection);",
      "149:                 frsm->obtainRequest = obtainFileCall;",
      "151:                 mmsMsg_createFileOpenResponse(MmsConnection_getFilestoreBasepath(connection),",
      "152:                         invokeId, response, filename, frsm);",
      "155:                 mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "158:         else",
      "159:             mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_RESOURCE_OTHER);",
      "",
      "[Added Lines]",
      "127:         if (mmsMsg_isFilenameSave(filename) == false) {",
      "130:             if (DEBUG_MMS_CLIENT)",
      "131:                 printf(\"MMS_CLIENT: client provided unsave filename -> rejected\\n\");",
      "133:              mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "134:         }",
      "135:         else {",
      "136:             MmsFileReadStateMachine* frsm = getFreeFrsm(connection);",
      "138:             if (frsm != NULL) {",
      "140:                 MmsOutstandingCall obtainFileCall = mmsClient_getMatchingObtainFileRequest(connection, filename);",
      "142:                 if (obtainFileCall) {",
      "144:                     if (DEBUG_MMS_CLIENT)",
      "145:                         printf(\"MMS_CLIENT: file open is matching obtain file request for file %s\\n\", filename);",
      "147:                     obtainFileCall->timeout = Hal_getTimeInMs() + connection->requestTimeout;",
      "148:                 }",
      "150:                 FileHandle fileHandle = mmsMsg_openFile(MmsConnection_getFilestoreBasepath(connection), filename, false);",
      "152:                 if (fileHandle != NULL) {",
      "154:                     frsm->fileHandle = fileHandle;",
      "155:                     frsm->readPosition = filePosition;",
      "156:                     frsm->frsmId = getNextFrsmId(connection);",
      "157:                     frsm->obtainRequest = obtainFileCall;",
      "159:                     mmsMsg_createFileOpenResponse(MmsConnection_getFilestoreBasepath(connection),",
      "160:                             invokeId, response, filename, frsm);",
      "161:                 }",
      "162:                 else",
      "163:                     mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "167:                 mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_RESOURCE_OTHER);",
      "",
      "---------------"
    ],
    "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c": [
      "File: src/mms/iso_mms/common/mms_common_msg.c -> src/mms/iso_mms/common/mms_common_msg.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "570: #endif",
      "571: }",
      "573: FileHandle",
      "574: mmsMsg_openFile(const char* basepath, char* fileName, bool readWrite)",
      "575: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "573: bool",
      "574: mmsMsg_isFilenameSave(const char* filename)",
      "575: {",
      "576:     if (filename)",
      "577:     {",
      "578:         if (strstr(filename, \"..\"))",
      "579:             return false;",
      "581:         if (strstr(filename, \"./\"))",
      "582:             return false;",
      "584:         return true;",
      "585:     }",
      "586:     else {",
      "587:         return false;",
      "588:     }",
      "589: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "622:     if (strstr(filename, \"..\") != NULL) {",
      "624:         return false;",
      "625:     }",
      "",
      "[Removed Lines]",
      "623:         mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILENAME_SYNTAX_ERROR);",
      "",
      "[Added Lines]",
      "641:         mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "",
      "---------------"
    ],
    "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c": [
      "File: src/mms/iso_mms/server/mms_file_service.c -> src/mms/iso_mms/server/mms_file_service.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "266:     if (DEBUG_MMS_SERVER)",
      "267:         printf(\"MMS_SERVER: mms_file_service.c: Delete file (%s)\\n\", filename);",
      "269:     if (connection->server->fileAccessHandler != NULL) {",
      "270:         MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
      "271:                             connection, MMS_FILE_ACCESS_TYPE_DELETE, filename, NULL);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "267:     if (mmsMsg_isFilenameSave(filename) == false)",
      "268:     {",
      "269:         if (DEBUG_MMS_SERVER)",
      "270:             printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
      "272:         mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "274:         return;",
      "275:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "345:     if (hasFileName) {",
      "347:         if (connection->server->fileAccessHandler != NULL) {",
      "348:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
      "349:                                 connection, MMS_FILE_ACCESS_TYPE_OPEN, filename, NULL);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "355:         if (mmsMsg_isFilenameSave(filename) == false) {",
      "358:             if (DEBUG_MMS_CLIENT)",
      "359:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
      "361:              mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "363:              return;",
      "364:         }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "691:     if (hasSourceFileName && hasDestinationFilename) {",
      "694:         if (connection->server->fileAccessHandler != NULL) {",
      "695:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "712:         if (mmsMsg_isFilenameSave(destinationFilename) == false) {",
      "715:             if (DEBUG_MMS_SERVER)",
      "716:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
      "718:             goto exit_invalid_parameter;",
      "719:         }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1023:             continueAfterFileName = NULL;",
      "1024:     }",
      "1026:     tempCurPos = addFileEntriesToResponse(basepath, buffer, tempCurPos, maxSize, directoryName, &continueAfterFileName, &moreFollows);",
      "1028:  if (tempCurPos < 0) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1054:     if ((directoryName && mmsMsg_isFilenameSave(directoryName) == false) ||",
      "1055:         (continueAfterFileName && mmsMsg_isFilenameSave(continueAfterFileName) == false))",
      "1056:     {",
      "1057:         if (DEBUG_MMS_SERVER)",
      "1058:             printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
      "1060:        mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "1062:        return;",
      "1063:     }",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1129:     if ((strlen(currentFileName) != 0) && (strlen(newFileName) != 0)) {",
      "1132:         if (connection->server->fileAccessHandler != NULL) {",
      "1133:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1170:         if ((mmsMsg_isFilenameSave(currentFileName) == false) || (mmsMsg_isFilenameSave(newFileName) == false))",
      "1171:         {",
      "1172:             if (DEBUG_MMS_SERVER)",
      "1173:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
      "1175:             mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
      "1177:             return;",
      "1178:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "795b6cfba8608a7edd0a51de5e88242472af0d87",
      "candidate_info": {
        "commit_hash": "795b6cfba8608a7edd0a51de5e88242472af0d87",
        "repo": "mz-automation/libiec61850",
        "commit_url": "https://github.com/mz-automation/libiec61850/commit/795b6cfba8608a7edd0a51de5e88242472af0d87",
        "files": [
          "hal/filesystem/linux/file_provider_linux.c",
          "src/mms/inc_private/mms_common_internal.h",
          "src/mms/iso_mms/client/mms_client_files.c",
          "src/mms/iso_mms/common/mms_common_msg.c",
          "src/mms/iso_mms/server/mms_file_service.c"
        ],
        "message": "- fixed path traversal vulnerability in MMS file services (LIB61850-357)",
        "before_after_code_files": [
          "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c",
          "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h",
          "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c",
          "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c",
          "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c",
            "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h",
            "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c",
            "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c",
            "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c"
          ],
          "candidate": [
            "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c",
            "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h",
            "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c",
            "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c",
            "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c"
          ]
        }
      },
      "candidate_diff": {
        "hal/filesystem/linux/file_provider_linux.c||hal/filesystem/linux/file_provider_linux.c": [
          "File: hal/filesystem/linux/file_provider_linux.c -> hal/filesystem/linux/file_provider_linux.c"
        ],
        "src/mms/inc_private/mms_common_internal.h||src/mms/inc_private/mms_common_internal.h": [
          "File: src/mms/inc_private/mms_common_internal.h -> src/mms/inc_private/mms_common_internal.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "82: LIB61850_INTERNAL FileHandle",
          "83: mmsMsg_openFile(const char* basepath, char* fileName, bool readWrite);",
          "87: typedef struct sMmsServiceError",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85: LIB61850_INTERNAL bool",
          "86: mmsMsg_isFilenameSave(const char* filename);",
          "",
          "---------------"
        ],
        "src/mms/iso_mms/client/mms_client_files.c||src/mms/iso_mms/client/mms_client_files.c": [
          "File: src/mms/iso_mms/client/mms_client_files.c -> src/mms/iso_mms/client/mms_client_files.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "126:     if (hasFileName) {",
          "153:             }",
          "154:             else",
          "157:         }",
          "160:     }",
          "161:     else",
          "162:         goto exit_invalid_parameter;",
          "",
          "[Removed Lines]",
          "128:         MmsFileReadStateMachine* frsm = getFreeFrsm(connection);",
          "130:         if (frsm != NULL) {",
          "132:             MmsOutstandingCall obtainFileCall = mmsClient_getMatchingObtainFileRequest(connection, filename);",
          "134:             if (obtainFileCall) {",
          "136:                 if (DEBUG_MMS_CLIENT)",
          "137:                     printf(\"MMS_CLIENT: file open is matching obtain file request for file %s\\n\", filename);",
          "139:                 obtainFileCall->timeout = Hal_getTimeInMs() + connection->requestTimeout;",
          "140:             }",
          "142:             FileHandle fileHandle = mmsMsg_openFile(MmsConnection_getFilestoreBasepath(connection), filename, false);",
          "144:             if (fileHandle != NULL) {",
          "146:                 frsm->fileHandle = fileHandle;",
          "147:                 frsm->readPosition = filePosition;",
          "148:                 frsm->frsmId = getNextFrsmId(connection);",
          "149:                 frsm->obtainRequest = obtainFileCall;",
          "151:                 mmsMsg_createFileOpenResponse(MmsConnection_getFilestoreBasepath(connection),",
          "152:                         invokeId, response, filename, frsm);",
          "155:                 mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "158:         else",
          "159:             mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_RESOURCE_OTHER);",
          "",
          "[Added Lines]",
          "127:         if (mmsMsg_isFilenameSave(filename) == false) {",
          "130:             if (DEBUG_MMS_CLIENT)",
          "131:                 printf(\"MMS_CLIENT: client provided unsave filename -> rejected\\n\");",
          "133:              mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "134:         }",
          "135:         else {",
          "136:             MmsFileReadStateMachine* frsm = getFreeFrsm(connection);",
          "138:             if (frsm != NULL) {",
          "140:                 MmsOutstandingCall obtainFileCall = mmsClient_getMatchingObtainFileRequest(connection, filename);",
          "142:                 if (obtainFileCall) {",
          "144:                     if (DEBUG_MMS_CLIENT)",
          "145:                         printf(\"MMS_CLIENT: file open is matching obtain file request for file %s\\n\", filename);",
          "147:                     obtainFileCall->timeout = Hal_getTimeInMs() + connection->requestTimeout;",
          "148:                 }",
          "150:                 FileHandle fileHandle = mmsMsg_openFile(MmsConnection_getFilestoreBasepath(connection), filename, false);",
          "152:                 if (fileHandle != NULL) {",
          "154:                     frsm->fileHandle = fileHandle;",
          "155:                     frsm->readPosition = filePosition;",
          "156:                     frsm->frsmId = getNextFrsmId(connection);",
          "157:                     frsm->obtainRequest = obtainFileCall;",
          "159:                     mmsMsg_createFileOpenResponse(MmsConnection_getFilestoreBasepath(connection),",
          "160:                             invokeId, response, filename, frsm);",
          "161:                 }",
          "162:                 else",
          "163:                     mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "167:                 mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_RESOURCE_OTHER);",
          "",
          "---------------"
        ],
        "src/mms/iso_mms/common/mms_common_msg.c||src/mms/iso_mms/common/mms_common_msg.c": [
          "File: src/mms/iso_mms/common/mms_common_msg.c -> src/mms/iso_mms/common/mms_common_msg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "570: #endif",
          "571: }",
          "573: FileHandle",
          "574: mmsMsg_openFile(const char* basepath, char* fileName, bool readWrite)",
          "575: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "573: bool",
          "574: mmsMsg_isFilenameSave(const char* filename)",
          "575: {",
          "576:     if (filename) {",
          "577:         if (filename[0] == '/' || filename[0] == '\\\\') {",
          "578:             return false;",
          "579:         }",
          "581:         if (strstr(filename, \"..\"))",
          "582:             return false;",
          "584:         if (strstr(filename, \"./\"))",
          "585:             return false;",
          "587:         return true;",
          "588:     }",
          "589:     else {",
          "590:         return false;",
          "591:     }",
          "592: }",
          "",
          "---------------"
        ],
        "src/mms/iso_mms/server/mms_file_service.c||src/mms/iso_mms/server/mms_file_service.c": [
          "File: src/mms/iso_mms/server/mms_file_service.c -> src/mms/iso_mms/server/mms_file_service.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "266:     if (DEBUG_MMS_SERVER)",
          "267:         printf(\"MMS_SERVER: mms_file_service.c: Delete file (%s)\\n\", filename);",
          "269:     if (connection->server->fileAccessHandler != NULL) {",
          "270:         MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
          "271:                             connection, MMS_FILE_ACCESS_TYPE_DELETE, filename, NULL);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "267:     if (mmsMsg_isFilenameSave(filename) == false)",
          "268:     {",
          "269:         if (DEBUG_MMS_SERVER)",
          "270:             printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
          "272:         mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "274:         return;",
          "275:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "345:     if (hasFileName) {",
          "347:         if (connection->server->fileAccessHandler != NULL) {",
          "348:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
          "349:                                 connection, MMS_FILE_ACCESS_TYPE_OPEN, filename, NULL);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "355:         if (mmsMsg_isFilenameSave(filename) == false) {",
          "358:             if (DEBUG_MMS_CLIENT)",
          "359:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
          "361:              mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "363:              return;",
          "364:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "688:     if (hasSourceFileName && hasDestinationFilename) {",
          "691:         if (connection->server->fileAccessHandler != NULL) {",
          "692:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "709:         if (mmsMsg_isFilenameSave(destinationFilename) == false) {",
          "712:             if (DEBUG_MMS_SERVER)",
          "713:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
          "715:             goto exit_invalid_parameter;",
          "716:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1020:             continueAfterFileName = NULL;",
          "1021:     }",
          "1023:     tempCurPos = addFileEntriesToResponse(basepath, buffer, tempCurPos, maxSize, directoryName, &continueAfterFileName, &moreFollows);",
          "1025:  if (tempCurPos < 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1051:     if ((mmsMsg_isFilenameSave(directoryName) == false) || (mmsMsg_isFilenameSave(continueAfterFileName) == false)) {",
          "1052:         if (DEBUG_MMS_SERVER)",
          "1053:             printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
          "1055:        mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "1057:        return;",
          "1058:     }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1126:     if ((strlen(currentFileName) != 0) && (strlen(newFileName) != 0)) {",
          "1129:         if (connection->server->fileAccessHandler != NULL) {",
          "1130:             MmsError access = connection->server->fileAccessHandler(connection->server->fileAccessHandlerParameter,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1165:         if ((mmsMsg_isFilenameSave(currentFileName) == false) || (mmsMsg_isFilenameSave(newFileName) == false))",
          "1166:         {",
          "1167:             if (DEBUG_MMS_SERVER)",
          "1168:                 printf(\"MMS_SERVER: remote provided unsave filename -> rejected\\n\");",
          "1170:             mmsMsg_createServiceErrorPdu(invokeId, response, MMS_ERROR_FILE_FILE_NON_EXISTENT);",
          "1172:             return;",
          "1173:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}