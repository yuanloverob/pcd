{
  "cve_id": "CVE-2023-3153",
  "cve_desc": "A flaw was found in Open Virtual Network where the service monitor MAC does not properly rate limit. This issue could allow an attacker to cause a denial of service, including on deployments with CoPP enabled and properly configured.",
  "repo": "ovn-org/ovn",
  "patch_hash": "9a3f7ed905e525ebdcb14541e775211cbb0203bd",
  "patch_info": {
    "commit_hash": "9a3f7ed905e525ebdcb14541e775211cbb0203bd",
    "repo": "ovn-org/ovn",
    "commit_url": "https://github.com/ovn-org/ovn/commit/9a3f7ed905e525ebdcb14541e775211cbb0203bd",
    "files": [
      "lib/copp.c",
      "lib/copp.h",
      "northd/northd.c",
      "ovn-nb.xml",
      "tests/ovn-northd.at",
      "tests/system-ovn.at"
    ],
    "message": "northd, controller: Add CoPP for SVC monitor\n\nThe SVC monitor was exposed without any limitation.\nAdd CoPP for the SVC monitor flow, which adds a way\nfor CMSs to limit the traffic that this flow accepts.\n\nSigned-off-by: Ales Musil <amusil@redhat.com>",
    "before_after_code_files": [
      "lib/copp.c||lib/copp.c",
      "lib/copp.h||lib/copp.h",
      "northd/northd.c||northd/northd.c",
      "tests/ovn-northd.at||tests/ovn-northd.at",
      "tests/system-ovn.at||tests/system-ovn.at"
    ]
  },
  "patch_diff": {
    "lib/copp.c||lib/copp.c": [
      "File: lib/copp.c -> lib/copp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "38:     [COPP_ND_RA_OPTS]    = \"nd-ra-opts\",",
      "39:     [COPP_TCP_RESET]     = \"tcp-reset\",",
      "40:     [COPP_REJECT]        = \"reject\",",
      "41:     [COPP_BFD]           = \"bfd\",",
      "42: };",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "41:     [COPP_SVC_MONITOR]   = \"svc-monitor\",",
      "",
      "---------------"
    ],
    "lib/copp.h||lib/copp.h": [
      "File: lib/copp.h -> lib/copp.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "37:     COPP_TCP_RESET,",
      "38:     COPP_BFD,",
      "39:     COPP_REJECT,",
      "40:     COPP_PROTO_MAX,",
      "41:     COPP_PROTO_INVALID = COPP_PROTO_MAX,",
      "42: };",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "40:     COPP_SVC_MONITOR,",
      "",
      "---------------"
    ],
    "northd/northd.c||northd/northd.c": [
      "File: northd/northd.c -> northd/northd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "8924: static void",
      "8925: build_lswitch_destination_lookup_bmcast(struct ovn_datapath *od,",
      "8929: {",
      "8930:     if (od->nbs) {",
      "",
      "[Removed Lines]",
      "8926:                                         struct hmap *lflows,",
      "8927:                                         struct ds *actions,",
      "8928:                                         const struct shash *meter_groups)",
      "",
      "[Added Lines]",
      "8926:                                         struct hmap *lflows,",
      "8927:                                         struct ds *actions,",
      "8928:                                         const struct shash *meter_groups)",
      "8929: {",
      "8930:     if (od->nbs) {",
      "",
      "---------------"
    ],
    "tests/ovn-northd.at||tests/ovn-northd.at": [
      "File: tests/ovn-northd.at -> tests/ovn-northd.at",
      "--- Hunk 1 ---",
      "[Context before]",
      "3545: # let's try to add an usupported protocol \"dhcp\"",
      "3546: AT_CHECK([ovn-nbctl --wait=hv copp-add copp5 dhcp meter1],[1],[],[dnl",
      "3548: ])",
      "3550: #Let's try to add a valid protocol to an unknown datapath",
      "",
      "[Removed Lines]",
      "3547: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject.",
      "",
      "[Added Lines]",
      "3547: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject, svc-monitor.",
      "",
      "---------------"
    ],
    "tests/system-ovn.at||tests/system-ovn.at": [
      "File: tests/system-ovn.at -> tests/system-ovn.at",
      "--- Hunk 1 ---",
      "[Context before]",
      "7282: ])",
      "7283: kill $(pidof tcpdump)",
      "7285: kill $(pidof ovn-controller)",
      "7287: as ovn-sb",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "7285: check ovn-nbctl set nb_global . options:svc_monitor_mac=\"33:33:33:33:33:33\"",
      "7286: check ovn-nbctl meter-add svc-meter drop 1 pktps 0",
      "7287: check ovn-nbctl --wait=hv copp-add copp4 svc-monitor svc-meter",
      "7288: check ovn-nbctl --wait=hv ls-copp-add copp4 sw0",
      "7289: check ovn-appctl -t ovn-controller vlog/set vconn:dbg",
      "7290: AT_CHECK([ovn-nbctl copp-list copp4], [0], [dnl",
      "7291: svc-monitor: svc-meter",
      "7292: ])",
      "7294: ip netns exec sw01 scapy -H <<-EOF",
      "7295: p = Ether(dst=\"33:33:33:33:33:33\", src=\"f0:00:00:01:02:03\") /\\",
      "7296:     IP(dst=\"192.168.1.100\", src=\"192.168.1.2\") / TCP(dport=1234, sport=1234)",
      "7297: sendp(p, iface='sw01', loop=0, verbose=0, count=20)",
      "7298: EOF",
      "7300: OVS_WAIT_UNTIL([test \"1\" = \"$(grep -c \"dl_dst=33:33:33:33:33:33\" ovn-controller.log)\"])",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "7296: as",
      "7297: OVS_TRAFFIC_VSWITCHD_STOP([\"/.*error receiving.*/d",
      "7300: AT_CLEANUP",
      "7301: ])",
      "",
      "[Removed Lines]",
      "7298: /.*terminating with signal 15.*/d\"])",
      "",
      "[Added Lines]",
      "7315: /.*terminating with signal 15.*/d",
      "7316: /.*Service monitor not found/d\"])",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f1b3112fb17457d865e5b47d6b79ae29632a13db",
      "candidate_info": {
        "commit_hash": "f1b3112fb17457d865e5b47d6b79ae29632a13db",
        "repo": "ovn-org/ovn",
        "commit_url": "https://github.com/ovn-org/ovn/commit/f1b3112fb17457d865e5b47d6b79ae29632a13db",
        "files": [
          "lib/copp.c",
          "lib/copp.h",
          "northd/northd.c",
          "ovn-nb.xml",
          "tests/ovn-northd.at",
          "tests/system-ovn.at"
        ],
        "message": "northd, controller: Add CoPP for SVC monitor\n\nThe SVC monitor was exposed without any limitation.\nAdd CoPP for the SVC monitor flow, which adds a way\nfor CMSs to limit the traffic that this flow accepts.\n\nSigned-off-by: Ales Musil <amusil@redhat.com>",
        "before_after_code_files": [
          "lib/copp.c||lib/copp.c",
          "lib/copp.h||lib/copp.h",
          "northd/northd.c||northd/northd.c",
          "tests/ovn-northd.at||tests/ovn-northd.at",
          "tests/system-ovn.at||tests/system-ovn.at"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/copp.c||lib/copp.c",
            "lib/copp.h||lib/copp.h",
            "northd/northd.c||northd/northd.c",
            "tests/ovn-northd.at||tests/ovn-northd.at",
            "tests/system-ovn.at||tests/system-ovn.at"
          ],
          "candidate": [
            "lib/copp.c||lib/copp.c",
            "lib/copp.h||lib/copp.h",
            "northd/northd.c||northd/northd.c",
            "tests/ovn-northd.at||tests/ovn-northd.at",
            "tests/system-ovn.at||tests/system-ovn.at"
          ]
        }
      },
      "candidate_diff": {
        "lib/copp.c||lib/copp.c": [
          "File: lib/copp.c -> lib/copp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     [COPP_ND_RA_OPTS]    = \"nd-ra-opts\",",
          "39:     [COPP_TCP_RESET]     = \"tcp-reset\",",
          "40:     [COPP_REJECT]        = \"reject\",",
          "41:     [COPP_BFD]           = \"bfd\",",
          "42: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "41:     [COPP_SVC_MONITOR]   = \"svc-monitor\",",
          "",
          "---------------"
        ],
        "lib/copp.h||lib/copp.h": [
          "File: lib/copp.h -> lib/copp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:     COPP_TCP_RESET,",
          "38:     COPP_BFD,",
          "39:     COPP_REJECT,",
          "40:     COPP_PROTO_MAX,",
          "41:     COPP_PROTO_INVALID = COPP_PROTO_MAX,",
          "42: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:     COPP_SVC_MONITOR,",
          "",
          "---------------"
        ],
        "northd/northd.c||northd/northd.c": [
          "File: northd/northd.c -> northd/northd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "9804: static void",
          "9805: build_lswitch_destination_lookup_bmcast(struct ovn_datapath *od,",
          "9806:                                         struct hmap *lflows,",
          "9810:     ovs_assert(od->nbs);",
          "9812:     ovn_lflow_add(lflows, od, S_SWITCH_IN_L2_LKUP, 110,",
          "",
          "[Removed Lines]",
          "9807:                                         struct ds *actions,",
          "9808:                                         const struct shash *meter_groups)",
          "9809: {",
          "",
          "[Added Lines]",
          "9807:                                         struct ds *actions,",
          "9808:                                         const struct shash *meter_groups)",
          "9809: {",
          "9810:     ovs_assert(od->nbs);",
          "",
          "---------------"
        ],
        "tests/ovn-northd.at||tests/ovn-northd.at": [
          "File: tests/ovn-northd.at -> tests/ovn-northd.at",
          "--- Hunk 1 ---",
          "[Context before]",
          "3656: # let's try to add an usupported protocol \"dhcp\"",
          "3657: AT_CHECK([ovn-nbctl --wait=hv copp-add copp5 dhcp meter1],[1],[],[dnl",
          "3659: ])",
          "3661: #Let's try to add a valid protocol to an unknown datapath",
          "",
          "[Removed Lines]",
          "3658: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject.",
          "",
          "[Added Lines]",
          "3658: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject, svc-monitor.",
          "",
          "---------------"
        ],
        "tests/system-ovn.at||tests/system-ovn.at": [
          "File: tests/system-ovn.at -> tests/system-ovn.at",
          "--- Hunk 1 ---",
          "[Context before]",
          "7469: ])",
          "7470: kill $(pidof tcpdump)",
          "7472: OVS_APP_EXIT_AND_WAIT([ovn-controller])",
          "7474: as ovn-sb",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7472: check ovn-nbctl set nb_global . options:svc_monitor_mac=\"33:33:33:33:33:33\"",
          "7473: check ovn-nbctl meter-add svc-meter drop 1 pktps 0",
          "7474: check ovn-nbctl --wait=hv copp-add copp4 svc-monitor svc-meter",
          "7475: check ovn-nbctl --wait=hv ls-copp-add copp4 sw0",
          "7476: check ovn-appctl -t ovn-controller vlog/set vconn:dbg",
          "7477: AT_CHECK([ovn-nbctl copp-list copp4], [0], [dnl",
          "7478: svc-monitor: svc-meter",
          "7479: ])",
          "7481: ip netns exec sw01 scapy -H <<-EOF",
          "7482: p = Ether(dst=\"33:33:33:33:33:33\", src=\"f0:00:00:01:02:03\") /\\",
          "7483:     IP(dst=\"192.168.1.100\", src=\"192.168.1.2\") / TCP(dport=1234, sport=1234)",
          "7484: sendp(p, iface='sw01', loop=0, verbose=0, count=20)",
          "7485: EOF",
          "7487: OVS_WAIT_UNTIL([test \"1\" = \"$(grep -c \"dl_dst=33:33:33:33:33:33\" ovn-controller.log)\"])",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "7483: as",
          "7484: OVS_TRAFFIC_VSWITCHD_STOP([\"/.*error receiving.*/d",
          "7487: AT_CLEANUP",
          "7488: ])",
          "",
          "[Removed Lines]",
          "7485: /.*terminating with signal 15.*/d\"])",
          "",
          "[Added Lines]",
          "7502: /.*terminating with signal 15.*/d",
          "7503: /.*Service monitor not found/d\"])",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "be6a9d9603be0b368c4552adfc5fd7cdb98f29b4",
      "candidate_info": {
        "commit_hash": "be6a9d9603be0b368c4552adfc5fd7cdb98f29b4",
        "repo": "ovn-org/ovn",
        "commit_url": "https://github.com/ovn-org/ovn/commit/be6a9d9603be0b368c4552adfc5fd7cdb98f29b4",
        "files": [
          "lib/copp.c",
          "lib/copp.h",
          "northd/northd.c",
          "ovn-nb.xml",
          "tests/ovn-northd.at",
          "tests/system-ovn.at"
        ],
        "message": "northd, controller: Add CoPP for SVC monitor\n\nThe SVC monitor was exposed without any limitation.\nAdd CoPP for the SVC monitor flow, which adds a way\nfor CMSs to limit the traffic that this flow accepts.\n\nSigned-off-by: Ales Musil <amusil@redhat.com>",
        "before_after_code_files": [
          "lib/copp.c||lib/copp.c",
          "lib/copp.h||lib/copp.h",
          "northd/northd.c||northd/northd.c",
          "tests/ovn-northd.at||tests/ovn-northd.at",
          "tests/system-ovn.at||tests/system-ovn.at"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/copp.c||lib/copp.c",
            "lib/copp.h||lib/copp.h",
            "northd/northd.c||northd/northd.c",
            "tests/ovn-northd.at||tests/ovn-northd.at",
            "tests/system-ovn.at||tests/system-ovn.at"
          ],
          "candidate": [
            "lib/copp.c||lib/copp.c",
            "lib/copp.h||lib/copp.h",
            "northd/northd.c||northd/northd.c",
            "tests/ovn-northd.at||tests/ovn-northd.at",
            "tests/system-ovn.at||tests/system-ovn.at"
          ]
        }
      },
      "candidate_diff": {
        "lib/copp.c||lib/copp.c": [
          "File: lib/copp.c -> lib/copp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     [COPP_ND_RA_OPTS]    = \"nd-ra-opts\",",
          "39:     [COPP_TCP_RESET]     = \"tcp-reset\",",
          "40:     [COPP_REJECT]        = \"reject\",",
          "41:     [COPP_BFD]           = \"bfd\",",
          "42: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "41:     [COPP_SVC_MONITOR]   = \"svc-monitor\",",
          "",
          "---------------"
        ],
        "lib/copp.h||lib/copp.h": [
          "File: lib/copp.h -> lib/copp.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:     COPP_TCP_RESET,",
          "38:     COPP_BFD,",
          "39:     COPP_REJECT,",
          "40:     COPP_PROTO_MAX,",
          "41:     COPP_PROTO_INVALID = COPP_PROTO_MAX,",
          "42: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "40:     COPP_SVC_MONITOR,",
          "",
          "---------------"
        ],
        "northd/northd.c||northd/northd.c": [
          "File: northd/northd.c -> northd/northd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "8427: static void",
          "8428: build_lswitch_destination_lookup_bmcast(struct ovn_datapath *od,",
          "8432: {",
          "8433:     if (od->nbs) {",
          "",
          "[Removed Lines]",
          "8429:                                         struct hmap *lflows,",
          "8430:                                         struct ds *actions,",
          "8431:                                         const struct shash *meter_groups)",
          "",
          "[Added Lines]",
          "8429:                                         struct hmap *lflows,",
          "8430:                                         struct ds *actions,",
          "8431:                                         const struct shash *meter_groups)",
          "8432: {",
          "8433:     if (od->nbs) {",
          "",
          "---------------"
        ],
        "tests/ovn-northd.at||tests/ovn-northd.at": [
          "File: tests/ovn-northd.at -> tests/ovn-northd.at",
          "--- Hunk 1 ---",
          "[Context before]",
          "3416: # let's try to add an usupported protocol \"dhcp\"",
          "3417: AT_CHECK([ovn-nbctl --wait=hv copp-add copp5 dhcp meter1],[1],[],[dnl",
          "3419: ])",
          "3421: #Let's try to add a valid protocol to an unknown datapath",
          "",
          "[Removed Lines]",
          "3418: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject.",
          "",
          "[Added Lines]",
          "3418: ovn-nbctl: Invalid control protocol. Allowed values: arp, arp-resolve, dhcpv4-opts, dhcpv6-opts, dns, event-elb, icmp4-error, icmp6-error, igmp, nd-na, nd-ns, nd-ns-resolve, nd-ra-opts, tcp-reset, bfd, reject, svc-monitor.",
          "",
          "---------------"
        ],
        "tests/system-ovn.at||tests/system-ovn.at": [
          "File: tests/system-ovn.at -> tests/system-ovn.at",
          "--- Hunk 1 ---",
          "[Context before]",
          "7078: ])",
          "7079: kill $(pidof tcpdump)",
          "7081: kill $(pidof ovn-controller)",
          "7083: as ovn-sb",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7081: check ovn-nbctl set nb_global . options:svc_monitor_mac=\"33:33:33:33:33:33\"",
          "7082: check ovn-nbctl meter-add svc-meter drop 1 pktps 0",
          "7083: check ovn-nbctl --wait=hv copp-add copp4 svc-monitor svc-meter",
          "7084: check ovn-nbctl --wait=hv ls-copp-add copp4 sw0",
          "7085: check ovn-appctl -t ovn-controller vlog/set vconn:dbg",
          "7086: AT_CHECK([ovn-nbctl copp-list copp4], [0], [dnl",
          "7087: svc-monitor: svc-meter",
          "7088: ])",
          "7090: ip netns exec sw01 scapy -H <<-EOF",
          "7091: p = Ether(dst=\"33:33:33:33:33:33\", src=\"f0:00:00:01:02:03\") /\\",
          "7092:     IP(dst=\"192.168.1.100\", src=\"192.168.1.2\") / TCP(dport=1234, sport=1234)",
          "7093: sendp(p, iface='sw01', loop=0, verbose=0, count=20)",
          "7094: EOF",
          "7096: OVS_WAIT_UNTIL([test \"1\" = \"$(grep -c \"dl_dst=33:33:33:33:33:33\" ovn-controller.log)\"])",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "7092: as",
          "7093: OVS_TRAFFIC_VSWITCHD_STOP([\"/.*error receiving.*/d",
          "7096: AT_CLEANUP",
          "7097: ])",
          "",
          "[Removed Lines]",
          "7094: /.*terminating with signal 15.*/d\"])",
          "",
          "[Added Lines]",
          "7111: /.*terminating with signal 15.*/d",
          "7112: /.*Service monitor not found/d\"])",
          "",
          "---------------"
        ]
      }
    }
  ]
}