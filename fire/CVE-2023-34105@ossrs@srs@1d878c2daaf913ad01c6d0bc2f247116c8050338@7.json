{
  "cve_id": "CVE-2023-34105",
  "cve_desc": "SRS is a real-time video server supporting RTMP, WebRTC, HLS, HTTP-FLV, SRT, MPEG-DASH, and GB28181. Prior to versions 5.0.157, 5.0-b1, and 6.0.48, SRS's `api-server` server is vulnerable to a drive-by command injection. An attacker may send a request to the `/api/v1/snapshots` endpoint containing any commands to be executed as part of the body of the POST request. This issue may lead to Remote Code Execution (RCE). Versions 5.0.157, 5.0-b1, and 6.0.48 contain a fix.",
  "repo": "ossrs/srs",
  "patch_hash": "1d878c2daaf913ad01c6d0bc2f247116c8050338",
  "patch_info": {
    "commit_hash": "1d878c2daaf913ad01c6d0bc2f247116c8050338",
    "repo": "ossrs/srs",
    "commit_url": "https://github.com/ossrs/srs/commit/1d878c2daaf913ad01c6d0bc2f247116c8050338",
    "files": [
      "trunk/doc/CHANGELOG.md",
      "trunk/research/api-server/server.go",
      "trunk/src/core/srs_core_version5.hpp",
      "trunk/src/core/srs_core_version6.hpp"
    ],
    "message": "Fix command injection in api-server for HTTP callback. v5.0.157, v6.0.48",
    "before_after_code_files": [
      "trunk/research/api-server/server.go||trunk/research/api-server/server.go",
      "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
      "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
    ]
  },
  "patch_diff": {
    "trunk/research/api-server/server.go||trunk/research/api-server/server.go": [
      "File: trunk/research/api-server/server.go -> trunk/research/api-server/server.go",
      "--- Hunk 1 ---",
      "[Context before]",
      "400:  normalPicPath := path.Join(outputPicDir, fmt.Sprintf(\"%v\", v.Stream)+\"-%03d.png\")",
      "401:  bestPng := path.Join(outputPicDir, fmt.Sprintf(\"%v-best.png\", v.Stream))",
      "405:  timeoutCtx, _ := context.WithTimeout(v.cancelCtx, v.timeout)",
      "407:  if err = cmd.Run(); err != nil {",
      "408:   log.Println(fmt.Sprintf(\"run snapshot %v cmd failed, err is %v\", v.Tag(), err))",
      "409:   return",
      "",
      "[Removed Lines]",
      "403:  param := fmt.Sprintf(\"%v -i %v -vf fps=1 -vcodec png -f image2 -an -y -vframes %v -y %v\", ffmpegPath, inputUrl, v.vframes, normalPicPath)",
      "404:  log.Println(fmt.Sprintf(\"start snapshot, cmd param=%v\", param))",
      "406:  cmd := exec.CommandContext(timeoutCtx, \"/bin/bash\", \"-c\", param)",
      "",
      "[Added Lines]",
      "403:  params := []string{",
      "404:   \"-i\", inputUrl,",
      "405:   \"-vf\", \"fps=1\",",
      "406:   \"-vcodec\", \"png\",",
      "407:   \"-f\", \"image2\",",
      "408:   \"-an\",",
      "409:   \"-vframes\", strconv.Itoa(v.vframes),",
      "410:   \"-y\", normalPicPath,",
      "411:  }",
      "412:  log.Println(fmt.Sprintf(\"start snapshot, cmd param=%v %v\", ffmpegPath, strings.Join(params, \" \")))",
      "414:  cmd := exec.CommandContext(timeoutCtx, ffmpegPath, params...)",
      "",
      "---------------"
    ],
    "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
      "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #define VERSION_MAJOR       5",
      "11: #define VERSION_MINOR       0",
      "14: #endif",
      "",
      "[Removed Lines]",
      "12: #define VERSION_REVISION    156",
      "",
      "[Added Lines]",
      "12: #define VERSION_REVISION    157",
      "",
      "---------------"
    ],
    "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
      "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "10: #define VERSION_MAJOR       6",
      "11: #define VERSION_MINOR       0",
      "14: #endif",
      "",
      "[Removed Lines]",
      "12: #define VERSION_REVISION    47",
      "",
      "[Added Lines]",
      "12: #define VERSION_REVISION    48",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2777351c4b01a6c3122d76e95586a4e240e60382",
      "candidate_info": {
        "commit_hash": "2777351c4b01a6c3122d76e95586a4e240e60382",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/2777351c4b01a6c3122d76e95586a4e240e60382",
        "files": [
          "trunk/auto/options.sh",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/app/srs_app_threads.cpp",
          "trunk/src/core/srs_core.hpp",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "Bugfix: Eliminate the redundant declaration of the _srs_rtc_manager variable. v5.0.169 v6.0.62 (#3699)\n\nIt is advised to eliminate any instances of _srs_rtc_manager that occur\nmultiple times.\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>\nCo-authored-by: chundonglinlin <chundonglinlin@163.com>",
        "before_after_code_files": [
          "trunk/auto/options.sh||trunk/auto/options.sh",
          "trunk/src/app/srs_app_threads.cpp||trunk/src/app/srs_app_threads.cpp",
          "trunk/src/core/srs_core.hpp||trunk/src/core/srs_core.hpp",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/auto/options.sh||trunk/auto/options.sh": [
          "File: trunk/auto/options.sh -> trunk/auto/options.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "70: # Experts options.",
          "71: SRS_USE_SYS_SSL=NO # Use system ssl(-lssl) if required.",
          "72: SRS_VALGRIND=NO",
          "74: SRS_SANITIZER_STATIC=NO",
          "75: SRS_SANITIZER_LOG=NO",
          "76: SRS_BUILD_TAG= # Set the object files tag name.",
          "",
          "[Removed Lines]",
          "73: SRS_SANITIZER=NO",
          "",
          "[Added Lines]",
          "73: SRS_SANITIZER=RESERVED",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "522:     # Enable asan, but disable for Centos",
          "523:     # @see https://github.com/ossrs/srs/issues/3347",
          "525:         echo \"Enable asan by auto options.\"",
          "526:         SRS_SANITIZER=YES",
          "527:     fi",
          "",
          "[Removed Lines]",
          "524:     if [[ $SRS_SANITIZER == NO && $OS_IS_CENTOS != YES ]]; then",
          "",
          "[Added Lines]",
          "524:     if [[ $SRS_SANITIZER == RESERVED && $OS_IS_CENTOS != YES ]]; then",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "594:     if [[ $SRS_HTTP_API == NO ]]; then SRS_HTTP_API=YES; echo -e \"${YELLOW}[WARN] Always enable HTTP API.${BLACK}\"; fi",
          "595:     if [[ $SRS_HLS == NO ]]; then SRS_HLS=YES; echo -e \"${YELLOW}[WARN] Always enable HLS.${BLACK}\"; fi",
          "596:     if [[ $SRS_DVR == NO ]]; then SRS_DVR=YES; echo -e \"${YELLOW}[WARN] Always enable DVR.${BLACK}\"; fi",
          "597: }",
          "598: apply_detail_options",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "598:     if [[ $SRS_SANITIZER == RESERVED ]]; then SRS_SANITIZER == NO; fi",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_threads.cpp||trunk/src/app/srs_app_threads.cpp": [
          "File: trunk/src/app/srs_app_threads.cpp -> trunk/src/app/srs_app_threads.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "64: extern SrsRtcBlackhole* _srs_blackhole;",
          "65: extern SrsResourceManager* _srs_rtc_manager;",
          "68: extern SrsDtlsCertificate* _srs_rtc_dtls_certificate;",
          "69: #endif",
          "71: #include <srs_protocol_kbps.hpp>",
          "77: SrsPps* _srs_pps_aloss2 = NULL;",
          "79: extern SrsPps* _srs_pps_ids;",
          "",
          "[Removed Lines]",
          "67: extern SrsResourceManager* _srs_rtc_manager;",
          "73: extern SrsPps* _srs_pps_snack2;",
          "74: extern SrsPps* _srs_pps_snack3;",
          "75: extern SrsPps* _srs_pps_snack4;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core.hpp||trunk/src/core/srs_core.hpp": [
          "File: trunk/src/core/srs_core.hpp -> trunk/src/core/srs_core.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: #define RTMP_SIG_SRS_DOMAIN \"ossrs.net\"",
          "33: #define VERSION_STABLE_BRANCH SRS_XSTR(VERSION_STABLE) \".0release\"",
          "",
          "[Removed Lines]",
          "32: #define VERSION_STABLE 4",
          "",
          "[Added Lines]",
          "32: #define VERSION_STABLE 5",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    168",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    169",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    61",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    62",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8f70206a3b6e362d04734310742c26b27a2f947d",
      "candidate_info": {
        "commit_hash": "8f70206a3b6e362d04734310742c26b27a2f947d",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/8f70206a3b6e362d04734310742c26b27a2f947d",
        "files": [
          "trunk/auto/options.sh",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "Enhancing the compatibility of options.sh. v5.0.204 v6.0.108 (#3916)\n\nAccommodate certain complex parameters that include the \"=\" character,\nfor example.\n`configure --extra-flags=\"-O2 -D_FORTIFY_SOURCE=2\"`\n\n---------\n\nCo-authored-by: john <hondaxiao@tencent.com>",
        "before_after_code_files": [
          "trunk/auto/options.sh||trunk/auto/options.sh",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/auto/options.sh||trunk/auto/options.sh": [
          "File: trunk/auto/options.sh -> trunk/auto/options.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "446:     case \"$option\" in",
          "447:         -*=*)",
          "448:             value=`echo \"$option\" | sed -e 's|[-_a-zA-Z0-9/]*=||'`",
          "450:         ;;",
          "452:     esac",
          "",
          "[Removed Lines]",
          "449:             option=`echo \"$option\" | sed -e 's|=[-_a-zA-Z0-9/. +,]*||'`",
          "",
          "[Added Lines]",
          "449:             option=`echo \"$option\" | sed -e 's|=[-_a-zA-Z0-9/. +,=]*||'`",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    203",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    204",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    107",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    108",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "77af3dc8c4e6db6195048bc72206cb1327654936",
      "candidate_info": {
        "commit_hash": "77af3dc8c4e6db6195048bc72206cb1327654936",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/77af3dc8c4e6db6195048bc72206cb1327654936",
        "files": [
          "trunk/configure",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "Configure: print enabled/disable sanitizer. v5.0.206 v6.0.110 (#3923)\n\n---------\n\nCo-authored-by: chundonglinlin <chundonglinlin@163.com>",
        "before_after_code_files": [
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    205",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    206",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    109",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    110",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f9bba0a9b0c62e553af887154ec22e3101b325b7",
      "candidate_info": {
        "commit_hash": "f9bba0a9b0c62e553af887154ec22e3101b325b7",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/f9bba0a9b0c62e553af887154ec22e3101b325b7",
        "files": [
          "trunk/doc/CHANGELOG.md",
          "trunk/research/players/js/srs.page.js",
          "trunk/research/players/js/srs.sdk.js",
          "trunk/src/app/srs_app_rtc_api.cpp",
          "trunk/src/app/srs_app_rtc_server.cpp",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "WebRTC: Support WHEP for play. v5.0.182 v6.0.80 (#3404)\n\nRFC for WHIP: https://datatracker.ietf.org/doc/draft-ietf-wish-whip/\n\nRFC for WHEP: https://datatracker.ietf.org/doc/draft-murillo-whep/\n\nPlease note that SRS 5.0 already had WHIP support. I didn't write a\ndocument about WHIP, because WHIP is not a RFC right now, but there are\nclues in\n[srs-unity](https://github.com/ossrs/srs-unity#usage-publisher). SRS\nWHIP url for publisher:\n`http://localhost:1985/rtc/v1/whip/?app=live&stream=livestream`\n\nThis PR is for WHEP, the url for player is\n`http://localhost:1985/rtc/v1/whep/?app=live&stream=livestream`\n\nPS: There is a great PR for OBS to have WHIP support, see\nhttps://github.com/obsproject/obs-studio/pull/7926 and #3581\n\nPS: WHIP for FFmpeg https://github.com/ossrs/ffmpeg-webrtc/pull/1\n\nSee #3170\n\n\n---------\n\nCo-authored-by: Haibo Chen <495810242@qq.com>\nCo-authored-by: john <hondaxiao@tencent.com>\nCo-authored-by: ChenGH <chengh_math@126.com>",
        "before_after_code_files": [
          "trunk/research/players/js/srs.page.js||trunk/research/players/js/srs.page.js",
          "trunk/research/players/js/srs.sdk.js||trunk/research/players/js/srs.sdk.js",
          "trunk/src/app/srs_app_rtc_api.cpp||trunk/src/app/srs_app_rtc_api.cpp",
          "trunk/src/app/srs_app_rtc_server.cpp||trunk/src/app/srs_app_rtc_server.cpp",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/research/players/js/srs.page.js||trunk/research/players/js/srs.page.js": [
          "File: trunk/research/players/js/srs.page.js -> trunk/research/players/js/srs.page.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "179: }",
          "180: function srs_init_whep(id, query) {",
          "181:     update_nav();",
          "183: }",
          "",
          "[Removed Lines]",
          "182:     $(id).val(build_default_whip_whep_url(query, '/rtc/v1/whip-play/'));",
          "",
          "[Added Lines]",
          "182:     $(id).val(build_default_whip_whep_url(query, '/rtc/v1/whep/'));",
          "",
          "---------------"
        ],
        "trunk/research/players/js/srs.sdk.js||trunk/research/players/js/srs.sdk.js": [
          "File: trunk/research/players/js/srs.sdk.js -> trunk/research/players/js/srs.sdk.js"
        ],
        "trunk/src/app/srs_app_rtc_api.cpp||trunk/src/app/srs_app_rtc_api.cpp": [
          "File: trunk/src/app/srs_app_rtc_api.cpp -> trunk/src/app/srs_app_rtc_api.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "678:     if (action.empty()) {",
          "679:         action = \"publish\";",
          "680:     }",
          "682:         action = \"play\";",
          "683:     }",
          "",
          "[Removed Lines]",
          "681:     if (srs_string_ends_with(r->path(), \"/whip-play/\")) {",
          "",
          "[Added Lines]",
          "682:     if (srs_string_ends_with(r->path(), \"/whip-play/\") || srs_string_ends_with(r->path(), \"/whep/\")) {",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_rtc_server.cpp||trunk/src/app/srs_app_rtc_server.cpp": [
          "File: trunk/src/app/srs_app_rtc_server.cpp -> trunk/src/app/srs_app_rtc_server.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "471:     }",
          "474:     if ((err = http_api_mux->handle(\"/rtc/v1/whip/\", new SrsGoApiRtcWhip(this))) != srs_success) {",
          "475:         return srs_error_wrap(err, \"handle whip\");",
          "476:     }",
          "479:     if ((err = http_api_mux->handle(\"/rtc/v1/whip-play/\", new SrsGoApiRtcWhip(this))) != srs_success) {",
          "481:     }",
          "483: #ifdef SRS_SIMULATOR",
          "",
          "[Removed Lines]",
          "480:         return srs_error_wrap(err, \"handle whip play\");",
          "",
          "[Added Lines]",
          "482:         return srs_error_wrap(err, \"handle whep play\");",
          "483:     }",
          "484:     if ((err = http_api_mux->handle(\"/rtc/v1/whep/\", new SrsGoApiRtcWhip(this))) != srs_success) {",
          "485:         return srs_error_wrap(err, \"handle whep play\");",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    181",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    182",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    79",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    80",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cff5064d0b463a863d7e3a061514f9ff44a39eed",
      "candidate_info": {
        "commit_hash": "cff5064d0b463a863d7e3a061514f9ff44a39eed",
        "repo": "ossrs/srs",
        "commit_url": "https://github.com/ossrs/srs/commit/cff5064d0b463a863d7e3a061514f9ff44a39eed",
        "files": [
          ".run/srs-stack.run.xml",
          "README.md",
          "trunk/doc/CHANGELOG.md",
          "trunk/src/app/srs_app_hls.cpp",
          "trunk/src/app/srs_app_hls.hpp",
          "trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp"
        ],
        "message": "HLS: Fix on_hls and hls_dispose critical zone issue. v5.0.174 v6.0.69 (#3781)\n\non_hls and hls_dispose are two coroutines, with potential race\nconditions. That is, during on_hls, if the API Server being accessed is\nslower, it will switch to the hls_dispose coroutine to start cleaning\nup. However, when the API Server is processing the slice, a situation\nmay occur where the slice does not exist, resulting in the following\nlog:\n\n```\n[2023-08-22 12:03:20.309][WARN][40][x5l48q7b][11] ignore task failed code=4005(HttpStatus)(Invalid HTTP status code) : callback on_hls http://localhost:2024/terraform/v1/hooks/srs/hls : http: post http://localhost:2024/terraform/v1/hooks/srs/hls with {\"server_id\":\"vid-5d7dxn8\",\"service_id\":\"cu153o7g\",\"action\":\"on_hls\",\"client_id\":\"x5l48q7b\",\"ip\":\"172.17.0.1\",\"vhost\":\"__defaultVhost__\",\"app\":\"live\",\"tcUrl\":\"srt://172.17.0.2/live\",\"stream\":\"stream-44572-2739617660809856576\",\"param\":\"secret=1ed8e0ffbc53439c8fc8da30ab8c19f0\",\"duration\":4.57,\"cwd\":\"/usr/local/srs-stack/platform\",\"file\":\"./objs/nginx/html/live/stream-44572-2739617660809856576-1.ts\",\"url\":\"live/stream-44572-2739617660809856576-1.ts\",\"m3u8\":\"./objs/nginx/html/live/stream-44572-2739617660809856576.m3u8\",\"m3u8_url\":\"live/stream-44572-2739617660809856576.m3u8\",\"seq_no\":1,\"stream_url\":\"/live/stream-44572-2739617660809856576\",\"stream_id\":\"vid-0n9zoz3\"}, status=500, res=invalid ts file ./objs/nginx/html/live/stream-44572-2739617660809856576-1.ts: stat ./objs/nginx/html/live/stream-44572-2739617660809856576-1.ts: no such file or directory\nthread [40][x5l48q7b]: call() [./src/app/srs_app_hls.cpp:122][errno=11]\nthread [40][x5l48q7b]: on_hls() [./src/app/srs_app_http_hooks.cpp:401][errno=11]\nthread [40][x5l48q7b]: do_post() [./src/app/srs_app_http_hooks.cpp:638][errno=11]\n\n[error] 2023/08/22 12:03:20.076984 [52][1001] Serve /terraform/v1/hooks/srs/hls failed, err is stat ./objs/nginx/html/live/stream-44572-2739617660809856576-1.ts: no such file or directory\ninvalid ts file ./objs/nginx/html/live/stream-44572-2739617660809856576-1.ts\nmain.handleOnHls.func1.1\n\t/g/platform/srs-hooks.go:684\nmain.handleOnHls.func1\n\t/g/platform/srs-hooks.go:720\nnet/http.HandlerFunc.ServeHTTP\n\t/usr/local/go/src/net/http/server.go:2084\nnet/http.(*ServeMux).ServeHTTP\n\t/usr/local/go/src/net/http/server.go:2462\nnet/http.serverHandler.ServeHTTP\n\t/usr/local/go/src/net/http/server.go:2916\nnet/http.(*conn).serve\n\t/usr/local/go/src/net/http/server.go:1966\nruntime.goexit\n\t/usr/local/go/src/runtime/asm_amd64.s:1571\n```\n\nSimilarly, when stopping the stream, on_hls will also be called to\nhandle the last slice. If the API Server is slower at this time, it will\nenter hls_dispose and call unpublish repeatedly. Since the previous\nunpublish is still blocked in on_hls, the following interference log\nwill appear:\n\n```\n[2023-08-22 12:03:18.748][INFO][40][6498088c] hls cycle to dispose hls /live/stream-44572-2739617660809856576, timeout=10000000ms\n[2023-08-22 12:03:18.752][WARN][40][6498088c][115] flush audio ignored, for segment is not open.\n[2023-08-22 12:03:18.752][WARN][40][6498088c][115] ignore the segment close, for segment is not open.\n```\n\nAlthough this log will not cause problems, it can interfere with\njudgment.\n\nThe solution is to add an 'unpublishing' status. If it is in the\n'unpublishing' status, then do not clean up the slices.\n\n---------\n\nCo-authored-by: Haibo Chen <495810242@qq.com>",
        "before_after_code_files": [
          "trunk/src/app/srs_app_hls.cpp||trunk/src/app/srs_app_hls.cpp",
          "trunk/src/app/srs_app_hls.hpp||trunk/src/app/srs_app_hls.hpp",
          "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
          "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ],
          "candidate": [
            "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp",
            "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp"
          ]
        }
      },
      "candidate_diff": {
        "trunk/src/app/srs_app_hls.cpp||trunk/src/app/srs_app_hls.cpp": [
          "File: trunk/src/app/srs_app_hls.cpp -> trunk/src/app/srs_app_hls.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "1137:     enabled = false;",
          "1138:     disposable = false;",
          "1139:     async_reload_ = reloading_ = false;",
          "1140:     last_update_time = 0;",
          "1141:     hls_dts_directly = false;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1139:     unpublishing_ = false;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1231:         return err;",
          "1232:     }",
          "1235:     if (async_reload_) return err;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1236:     if (unpublishing_) return err;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1297:     enabled = true;",
          "1300:     disposable = true;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1303:     unpublishing_ = false;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1310:     if (!enabled) {",
          "1311:         return;",
          "1312:     }",
          "1314:     if ((err = controller->on_unpublish()) != srs_success) {",
          "1315:         srs_warn(\"hls: ignore unpublish failed %s\", srs_error_desc(err).c_str());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1321:     if (unpublishing_) return;",
          "1322:     unpublishing_ = true;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1317:     }",
          "1319:     enabled = false;",
          "1320: }",
          "1322: srs_error_t SrsHls::on_audio(SrsSharedPtrMessage* shared_audio, SrsFormat* format)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1330:     unpublishing_ = false;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1324:     srs_error_t err = srs_success;",
          "1328:     if (async_reload_) return reload();",
          "",
          "[Removed Lines]",
          "1327:     if (!enabled) return err;",
          "",
          "[Added Lines]",
          "1338:     if (!enabled || unpublishing_) return err;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1406:     srs_error_t err = srs_success;",
          "1410:     if (async_reload_) return reload();",
          "",
          "[Removed Lines]",
          "1409:     if (!enabled) return err;",
          "",
          "[Added Lines]",
          "1420:     if (!enabled || unpublishing_) return err;",
          "",
          "---------------"
        ],
        "trunk/src/app/srs_app_hls.hpp||trunk/src/app/srs_app_hls.hpp": [
          "File: trunk/src/app/srs_app_hls.hpp -> trunk/src/app/srs_app_hls.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "279:     bool enabled;",
          "281:     bool disposable;",
          "283:     bool async_reload_;",
          "284:     bool reloading_;",
          "286:     srs_utime_t last_update_time;",
          "287: private:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "283:     bool unpublishing_;",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version5.hpp||trunk/src/core/srs_core_version5.hpp": [
          "File: trunk/src/core/srs_core_version5.hpp -> trunk/src/core/srs_core_version5.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       5",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    173",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    174",
          "",
          "---------------"
        ],
        "trunk/src/core/srs_core_version6.hpp||trunk/src/core/srs_core_version6.hpp": [
          "File: trunk/src/core/srs_core_version6.hpp -> trunk/src/core/srs_core_version6.hpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #define VERSION_MAJOR       6",
          "11: #define VERSION_MINOR       0",
          "14: #endif",
          "",
          "[Removed Lines]",
          "12: #define VERSION_REVISION    68",
          "",
          "[Added Lines]",
          "12: #define VERSION_REVISION    69",
          "",
          "---------------"
        ]
      }
    }
  ]
}