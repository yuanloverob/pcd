{
  "cve_id": "CVE-2014-9652",
  "cve_desc": "The mconvert function in softmagic.c in file before 5.21, as used in the Fileinfo component in PHP before 5.4.37, 5.5.x before 5.5.21, and 5.6.x before 5.6.5, does not properly handle a certain string-length field during a copy of a truncated version of a Pascal string, which might allow remote attackers to cause a denial of service (out-of-bounds memory access and application crash) via a crafted file.",
  "repo": "file/file",
  "patch_hash": "59e63838913eee47f5c120a6c53d4565af638158",
  "patch_info": {
    "commit_hash": "59e63838913eee47f5c120a6c53d4565af638158",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/59e63838913eee47f5c120a6c53d4565af638158",
    "files": [
      "src/softmagic.c"
    ],
    "message": "PR/398: Correctly truncate pascal strings (fixes out of bounds read of 1, 2, or 4 bytes).",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.195 2014/09/24 19:49:07 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "964:   size_t sz = file_pstring_length_size(m);",
      "965:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
      "966:   size_t len = file_pstring_get_length(m, ptr1);",
      "975:   }",
      "976:   while (len--)",
      "",
      "[Removed Lines]",
      "967:   if (len >= sizeof(p->s)) {",
      "974:    len = sizeof(p->s) - sz;",
      "",
      "[Added Lines]",
      "968:   if (len >= sz) {",
      "977:    len = sz;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
      "candidate_info": {
        "commit_hash": "6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/6f737ddfadb596d7d4a993f7ed2141ffd664a81c",
        "files": [
          "src/file.h",
          "src/funcs.c",
          "src/softmagic.c"
        ],
        "message": "- reduce recursion level from 20 to 10 and make a symbolic constant for it. - pull out the guts of saving and restoring the output buffer into functions   and take care not to overwrite the error message if an error happened.",
        "before_after_code_files": [
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "495: protected void file_regfree(file_regex_t *);",
          "496: protected void file_regerror(file_regex_t *, int, struct magic_set *);",
          "498: #ifndef COMPILE_ONLY",
          "499: extern const char *file_names[];",
          "500: extern const size_t file_nnames;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "498: typedef struct {",
          "499:  char *buf;",
          "500:  uint32_t offset;",
          "501: } file_pushbuf_t;",
          "503: protected file_pushbuf_t *file_push_buffer(struct magic_set *);",
          "504: protected char  *file_pop_buffer(struct magic_set *, file_pushbuf_t *);",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.72 2014/05/14 23:15:42 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.73 2014/09/10 18:41:51 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "491:  file_magerror(ms, \"regex error %d for `%s', (%s)\", rc, rx->pat,",
          "492:      errmsg);",
          "493: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "495: protected file_pushbuf_t *",
          "496: file_push_buffer(struct magic_set *ms)",
          "497: {",
          "498:  file_pushbuf_t *pb;",
          "500:  if (ms->event_flags & EVENT_HAD_ERR)",
          "501:   return NULL;",
          "503:  if ((pb = (CAST(file_pushbuf_t *, malloc(sizeof(*pb))))) == NULL)",
          "504:   return NULL;",
          "506:  pb->buf = ms->o.buf;",
          "507:  pb->offset = ms->offset;",
          "509:  ms->o.buf = NULL;",
          "510:  ms->offset = 0;",
          "512:  return pb;",
          "513: }",
          "515: protected char *",
          "516: file_pop_buffer(struct magic_set *ms, file_pushbuf_t *pb)",
          "517: {",
          "518:  char *rbuf;",
          "520:  if (ms->event_flags & EVENT_HAD_ERR) {",
          "521:   free(pb->buf);",
          "522:   free(pb);",
          "523:   return NULL;",
          "524:  }",
          "526:  rbuf = ms->o.buf;",
          "528:  ms->o.buf = pb->buf;",
          "529:  ms->offset = pb->offset;",
          "531:  free(pb);",
          "532:  return rbuf;",
          "533: }",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.197 2014/11/11 17:48:23 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "63: private void cvt_64(union VALUETYPE *, const struct magic *);",
          "65: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) > ((n) - (o)))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "67: #define MAX_RECURSION_LEVEL 10",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1217:     int flip, int recursion_level, int *printed_something,",
          "1218:     int *need_separator, int *returnval)",
          "1219: {",
          "1221:  uint32_t lhs;",
          "1222:  int rv, oneed_separator, in_type;",
          "1224:  union VALUETYPE *p = &ms->ms_value;",
          "1225:  struct mlist ml;",
          "1228:   file_error(ms, 0, \"recursion nesting exceeded\");",
          "1229:   return -1;",
          "1230:  }",
          "",
          "[Removed Lines]",
          "1220:  uint32_t soffset, offset = ms->offset;",
          "1223:  char *sbuf, *rbuf;",
          "1227:  if (recursion_level >= 20) {",
          "",
          "[Added Lines]",
          "1223:  uint32_t offset = ms->offset;",
          "1225:  file_pushbuf_t *pb;",
          "1227:  char *rbuf;",
          "1231:  if (recursion_level >= MAX_RECURSION_LEVEL) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1669:  case FILE_INDIRECT:",
          "1670:   if (offset == 0)",
          "1671:    return 0;",
          "1672:   if (nbytes < offset)",
          "1673:    return 0;",
          "1678:   rv = file_softmagic(ms, s + offset, nbytes - offset,",
          "1679:       recursion_level, BINTEST, text);",
          "1680:   if ((ms->flags & MAGIC_DEBUG) != 0)",
          "1681:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
          "1685:   if (rv == 1) {",
          "1686:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
          "1687:        file_printf(ms, F(ms, m, \"%u\"), offset) == -1) {",
          "",
          "[Removed Lines]",
          "1674:   sbuf = ms->o.buf;",
          "1675:   soffset = ms->offset;",
          "1676:   ms->o.buf = NULL;",
          "1677:   ms->offset = 0;",
          "1682:   rbuf = ms->o.buf;",
          "1683:   ms->o.buf = sbuf;",
          "1684:   ms->offset = soffset;",
          "",
          "[Added Lines]",
          "1680:   if ((pb = file_push_buffer(ms)) == NULL)",
          "1681:    return -1;",
          "1689:   rbuf = file_pop_buffer(ms, pb);",
          "1690:   if (rbuf == NULL)",
          "1691:    return -1;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1699:  case FILE_USE:",
          "1700:   if (nbytes < offset)",
          "1701:    return 0;",
          "1705:    flip = !flip;",
          "1706:   }",
          "1709:    return -1;",
          "1710:   }",
          "",
          "[Removed Lines]",
          "1702:   sbuf = m->value.s;",
          "1703:   if (*sbuf == '^') {",
          "1704:    sbuf++;",
          "1707:   if (file_magicfind(ms, sbuf, &ml) == -1) {",
          "1708:    file_error(ms, 0, \"cannot find entry `%s'\", sbuf);",
          "",
          "[Added Lines]",
          "1710:   rbuf = m->value.s;",
          "1711:   if (*rbuf == '^') {",
          "1712:    rbuf++;",
          "1715:   if (file_magicfind(ms, rbuf, &ml) == -1) {",
          "1716:    file_error(ms, 0, \"cannot find entry `%s'\", rbuf);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6bf45271eb8e0e6577b92042ce2003ba998d1686",
      "candidate_info": {
        "commit_hash": "6bf45271eb8e0e6577b92042ce2003ba998d1686",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/6bf45271eb8e0e6577b92042ce2003ba998d1686",
        "files": [
          "src/softmagic.c"
        ],
        "message": "Don't bail if there was no error, buf could have been NULL on entry.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.201 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.202 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1700:    fprintf(stderr, \"indirect @offs=%u[%d]\\n\", offset, rv);",
          "1702:   rbuf = file_pop_buffer(ms, pb);",
          "1704:    return -1;",
          "1706:   if (rv == 1) {",
          "",
          "[Removed Lines]",
          "1703:   if (rbuf == NULL)",
          "",
          "[Added Lines]",
          "1703:   if (rbuf == NULL && ms->event_flags & EVENT_HAD_ERR)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d3bc3aa5b5bdbd05de47c3db8118056435bed5e8",
      "candidate_info": {
        "commit_hash": "d3bc3aa5b5bdbd05de47c3db8118056435bed5e8",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/d3bc3aa5b5bdbd05de47c3db8118056435bed5e8",
        "files": [
          "src/file.h",
          "src/funcs.c",
          "src/softmagic.c"
        ],
        "message": "factor out all the duplicated regex code into a wrapper.",
        "before_after_code_files": [
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "468:     size_t);",
          "472: #ifndef COMPILE_ONLY",
          "473: extern const char *file_names[];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "471: typedef struct {",
          "472:  const char *pat;",
          "473:  char *old_lc_ctype;",
          "474:  int rc;",
          "475:  regex_t rx;",
          "476: } file_regex_t;",
          "478: protected int file_regcomp(file_regex_t *, const char *, int);",
          "479: protected int file_regexec(file_regex_t *, const char *, size_t, regmatch_t *,",
          "480:     int);",
          "481: protected void file_regfree(file_regex_t *);",
          "482: protected void file_regerror(file_regex_t *, int, struct magic_set *);",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.69 2014/03/06 16:03:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.70 2014/03/14 19:02:37 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "427: protected int",
          "428: file_replace(struct magic_set *ms, const char *pat, const char *rep)",
          "429: {",
          "431:  int rc, rv = -1;",
          "440:  if (rc) {",
          "444:  } else {",
          "445:   regmatch_t rm;",
          "446:   int nm = 0;",
          "448:    ms->o.buf[rm.rm_so] = '\\0';",
          "449:    if (file_printf(ms, \"%s%s\", rep,",
          "450:        rm.rm_eo != 0 ? ms->o.buf + rm.rm_eo : \"\") == -1)",
          "451:     goto out;",
          "452:    nm++;",
          "453:   }",
          "455:   rv = nm;",
          "456:  }",
          "457: out:",
          "460:  return rv;",
          "461: }",
          "",
          "[Removed Lines]",
          "430:  regex_t rx;",
          "432:  char *old_lc_ctype;",
          "434:  old_lc_ctype = setlocale(LC_CTYPE, NULL);",
          "435:  assert(old_lc_ctype != NULL);",
          "436:  old_lc_ctype = strdup(old_lc_ctype);",
          "437:  assert(old_lc_ctype != NULL);",
          "438:  (void)setlocale(LC_CTYPE, \"C\");",
          "439:  rc = regcomp(&rx, pat, REG_EXTENDED);",
          "441:   char errmsg[512];",
          "442:   (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "443:   file_magerror(ms, \"regex error %d, (%s)\", rc, errmsg);",
          "447:   while (regexec(&rx, ms->o.buf, 1, &rm, 0) == 0) {",
          "454:   regfree(&rx);",
          "458:  (void)setlocale(LC_CTYPE, old_lc_ctype);",
          "459:  free(old_lc_ctype);",
          "",
          "[Added Lines]",
          "430:  file_regex_t rx;",
          "433:  rc = file_regcomp(&rx, pat, REG_EXTENDED);",
          "435:   file_regerror(&rx, rc, ms);",
          "439:   while (file_regexec(&rx, ms->o.buf, 1, &rm, 0) == 0) {",
          "449:  file_regfree(&rx);",
          "453: protected int",
          "454: file_regcomp(file_regex_t *rx, const char *pat, int flags)",
          "455: {",
          "456:  rx->old_lc_ctype = setlocale(LC_CTYPE, NULL);",
          "457:  assert(rx->old_lc_ctype != NULL);",
          "458:  rx->old_lc_ctype = strdup(rx->old_lc_ctype);",
          "459:  assert(rx->old_lc_ctype != NULL);",
          "460:  rx->pat = pat;",
          "462:  (void)setlocale(LC_CTYPE, \"C\");",
          "463:  return rx->rc = regcomp(&rx->rx, pat, flags);",
          "464: }",
          "466: protected int",
          "467: file_regexec(file_regex_t *rx, const char *str, size_t nmatch,",
          "468:     regmatch_t* pmatch, int eflags)",
          "469: {",
          "470:  assert(rx->rc == 0);",
          "471:  return regexec(&rx->rx, str, nmatch, pmatch, eflags);",
          "472: }",
          "474: protected void",
          "475: file_regfree(file_regex_t *rx)",
          "476: {",
          "477:  if (rx->rc == 0)",
          "478:   regfree(&rx->rx);",
          "479:  (void)setlocale(LC_CTYPE, rx->old_lc_ctype);",
          "480:  free(rx->old_lc_ctype);",
          "481: }",
          "483: protected void",
          "484: file_regerror(file_regex_t *rx, int rc, struct magic_set *ms)",
          "485: {",
          "486:  char errmsg[512];",
          "488:  (void)regerror(rc, &rx->rx, errmsg, sizeof(errmsg));",
          "489:  file_magerror(ms, \"regex error %d for `%s', (%s)\", rc, rx->pat,",
          "490:      errmsg);",
          "491: }",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.184 2014/04/12 15:47:10 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.185 2014/04/30 21:41:02 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "364: private int",
          "365: check_fmt(struct magic_set *ms, struct magic *m)",
          "366: {",
          "368:  int rc, rv = -1;",
          "371:  if (strchr(m->desc, '%') == NULL)",
          "372:   return 0;",
          "380:  if (rc) {",
          "384:  } else {",
          "387:   rv = !rc;",
          "388:  }",
          "391:  return rv;",
          "392: }",
          "",
          "[Removed Lines]",
          "367:  regex_t rx;",
          "369:  char *old_lc_ctype;",
          "374:  old_lc_ctype = setlocale(LC_CTYPE, NULL);",
          "375:  assert(old_lc_ctype != NULL);",
          "376:  old_lc_ctype = strdup(old_lc_ctype);",
          "377:  assert(old_lc_ctype != NULL);",
          "378:  (void)setlocale(LC_CTYPE, \"C\");",
          "379:  rc = regcomp(&rx, \"%[-0-9\\\\.]*s\", REG_EXTENDED|REG_NOSUB);",
          "381:   char errmsg[512];",
          "382:   (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "383:   file_magerror(ms, \"regex error %d, (%s)\", rc, errmsg);",
          "385:   rc = regexec(&rx, m->desc, 0, 0, 0);",
          "386:   regfree(&rx);",
          "389:  (void)setlocale(LC_CTYPE, old_lc_ctype);",
          "390:  free(old_lc_ctype);",
          "",
          "[Added Lines]",
          "367:  file_regex_t rx;",
          "373:  rc = file_regcomp(&rx, \"%[-0-9\\\\.]*s\", REG_EXTENDED|REG_NOSUB);",
          "375:   file_regerror(&rx, rc, ms);",
          "377:   rc = file_regexec(&rx, m->desc, 0, 0, 0);",
          "380:  file_regfree(&rx);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1776:  double dl, dv;",
          "1777:  int matched;",
          "1778:  union VALUETYPE *p = &ms->ms_value;",
          "1781:  switch (m->type) {",
          "1782:  case FILE_BYTE:",
          "",
          "[Removed Lines]",
          "1779:  char *old_lc_ctype;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1929:  }",
          "1930:  case FILE_REGEX: {",
          "1931:   int rc;",
          "1935:   if (ms->search.s == NULL)",
          "1936:    return 0;",
          "1943:   l = 0;",
          "1945:       REG_EXTENDED|REG_NEWLINE|",
          "1946:       ((m->str_flags & STRING_IGNORE_CASE) ? REG_ICASE : 0));",
          "1947:   if (rc) {",
          "1951:    v = (uint64_t)-1;",
          "1954:    regmatch_t pmatch[1];",
          "1955: #ifndef REG_STARTEND",
          "1956: #define REG_STARTEND 0",
          "",
          "[Removed Lines]",
          "1932:   regex_t rx;",
          "1933:   char errmsg[512];",
          "1938:   old_lc_ctype = setlocale(LC_CTYPE, NULL);",
          "1939:   assert(old_lc_ctype != NULL);",
          "1940:   old_lc_ctype = strdup(old_lc_ctype);",
          "1941:   assert(old_lc_ctype != NULL);",
          "1942:   (void)setlocale(LC_CTYPE, \"C\");",
          "1944:   rc = regcomp(&rx, m->value.s,",
          "1948:    (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "1949:    file_magerror(ms, \"regex error %d, (%s)\",",
          "1950:        rc, errmsg);",
          "1952:   }",
          "1953:   else {",
          "",
          "[Added Lines]",
          "1921:   file_regex_t rx;",
          "1927:   rc = file_regcomp(&rx, m->value.s,",
          "1931:    file_regerror(&rx, rc, ms);",
          "1933:   } else {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1961:    pmatch[0].rm_so = 0;",
          "1962:    pmatch[0].rm_eo = ms->search.s_len;",
          "1963: #endif",
          "1965:        1, pmatch, REG_STARTEND);",
          "1966: #if REG_STARTEND == 0",
          "1967:    ((char *)(intptr_t)ms->search.s)[l] = c;",
          "",
          "[Removed Lines]",
          "1964:    rc = regexec(&rx, (const char *)ms->search.s,",
          "",
          "[Added Lines]",
          "1944:    rc = file_regexec(&rx, (const char *)ms->search.s,",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1980:     break;",
          "1982:    default:",
          "1986:     v = (uint64_t)-1;",
          "1987:     break;",
          "1988:    }",
          "1990:   }",
          "1993:   if (v == (uint64_t)-1)",
          "1994:    return -1;",
          "1995:   break;",
          "",
          "[Removed Lines]",
          "1983:     (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "1984:     file_magerror(ms, \"regexec error %d, (%s)\",",
          "1985:         rc, errmsg);",
          "1989:    regfree(&rx);",
          "1991:   (void)setlocale(LC_CTYPE, old_lc_ctype);",
          "1992:   free(old_lc_ctype);",
          "",
          "[Added Lines]",
          "1963:     file_regerror(&rx, rc, ms);",
          "1968:   file_regfree(&rx);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2091732d23c52d7e58c073cae832b2039486e04d",
      "candidate_info": {
        "commit_hash": "2091732d23c52d7e58c073cae832b2039486e04d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/2091732d23c52d7e58c073cae832b2039486e04d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "- always do arithmetic on dates - fix T_LOCAL reversed logic",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.209 2015/01/05 20:05:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.210 2015/01/05 20:21:30 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:  case FILE_LEDATE:",
          "549:  case FILE_MEDATE:",
          "550:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "552:    return -1;",
          "553:   t = ms->offset + sizeof(uint32_t);",
          "554:   break;",
          "",
          "[Removed Lines]",
          "551:       file_fmttime(p->l + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "551:       file_fmttime(p->l, 0, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "558:  case FILE_LELDATE:",
          "559:  case FILE_MELDATE:",
          "560:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "562:    return -1;",
          "563:   t = ms->offset + sizeof(uint32_t);",
          "564:   break;",
          "",
          "[Removed Lines]",
          "561:       file_fmttime(p->l + m->num_mask, 0, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "561:       file_fmttime(p->l, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "567:  case FILE_BEQDATE:",
          "568:  case FILE_LEQDATE:",
          "569:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "571:    return -1;",
          "572:   t = ms->offset + sizeof(uint64_t);",
          "573:   break;",
          "",
          "[Removed Lines]",
          "570:       file_fmttime(p->q + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "570:       file_fmttime(p->q, 0, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "576:  case FILE_BEQLDATE:",
          "577:  case FILE_LEQLDATE:",
          "578:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "580:    return -1;",
          "581:   t = ms->offset + sizeof(uint64_t);",
          "582:   break;",
          "",
          "[Removed Lines]",
          "579:       file_fmttime(p->q + m->num_mask, 0, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "579:       file_fmttime(p->q, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "585:  case FILE_BEQWDATE:",
          "586:  case FILE_LEQWDATE:",
          "587:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "589:    return -1;",
          "590:   t = ms->offset + sizeof(uint64_t);",
          "591:   break;",
          "",
          "[Removed Lines]",
          "588:       file_fmttime(p->q + m->num_mask, FILE_T_WINDOWS, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "588:       file_fmttime(p->q, FILE_T_WINDOWS, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "970:  case FILE_BELDATE:",
          "971:   p->l = (int32_t)",
          "972:       ((p->hl[0]<<24)|(p->hl[1]<<16)|(p->hl[2]<<8)|(p->hl[3]));",
          "975:   return 1;",
          "976:  case FILE_BEQUAD:",
          "977:  case FILE_BEQDATE:",
          "",
          "[Removed Lines]",
          "973:   if (type == FILE_BELONG)",
          "974:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "973:   cvt_32(p, m);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "982:        ((uint64_t)p->hq[2]<<40)|((uint64_t)p->hq[3]<<32)|",
          "983:        ((uint64_t)p->hq[4]<<24)|((uint64_t)p->hq[5]<<16)|",
          "984:        ((uint64_t)p->hq[6]<<8)|((uint64_t)p->hq[7]));",
          "987:   return 1;",
          "988:  case FILE_LESHORT:",
          "989:   p->h = (short)((p->hs[1]<<8)|(p->hs[0]));",
          "",
          "[Removed Lines]",
          "985:   if (type == FILE_BEQUAD)",
          "986:    cvt_64(p, m);",
          "",
          "[Added Lines]",
          "984:   cvt_64(p, m);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "994:  case FILE_LELDATE:",
          "995:   p->l = (int32_t)",
          "996:       ((p->hl[3]<<24)|(p->hl[2]<<16)|(p->hl[1]<<8)|(p->hl[0]));",
          "999:   return 1;",
          "1000:  case FILE_LEQUAD:",
          "1001:  case FILE_LEQDATE:",
          "",
          "[Removed Lines]",
          "997:   if (type == FILE_LELONG)",
          "998:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "995:   cvt_32(p, m);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1006:        ((uint64_t)p->hq[5]<<40)|((uint64_t)p->hq[4]<<32)|",
          "1007:        ((uint64_t)p->hq[3]<<24)|((uint64_t)p->hq[2]<<16)|",
          "1008:        ((uint64_t)p->hq[1]<<8)|((uint64_t)p->hq[0]));",
          "1011:   return 1;",
          "1012:  case FILE_MELONG:",
          "1013:  case FILE_MEDATE:",
          "1014:  case FILE_MELDATE:",
          "1015:   p->l = (int32_t)",
          "1016:       ((p->hl[1]<<24)|(p->hl[0]<<16)|(p->hl[3]<<8)|(p->hl[2]));",
          "1019:   return 1;",
          "1020:  case FILE_FLOAT:",
          "1021:   cvt_float(p, m);",
          "",
          "[Removed Lines]",
          "1009:   if (type == FILE_LEQUAD)",
          "1010:    cvt_64(p, m);",
          "1017:   if (type == FILE_MELONG)",
          "1018:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "1006:   cvt_64(p, m);",
          "1013:   cvt_32(p, m);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ac9f0f6061678a99f80bc8e65377a0e22b04dc6d",
      "candidate_info": {
        "commit_hash": "ac9f0f6061678a99f80bc8e65377a0e22b04dc6d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/ac9f0f6061678a99f80bc8e65377a0e22b04dc6d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "PR/398: Correctly truncate pascal strings (fixes out of bounds read of 1, 2, or 4 bytes).",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.197 2014/11/11 17:48:23 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "964:   size_t sz = file_pstring_length_size(m);",
          "965:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
          "966:   size_t len = file_pstring_get_length(m, ptr1);",
          "975:   }",
          "976:   while (len--)",
          "",
          "[Removed Lines]",
          "967:   if (len >= sizeof(p->s)) {",
          "974:    len = sizeof(p->s) - sz;",
          "",
          "[Added Lines]",
          "968:   if (len >= sz) {",
          "977:    len = sz;",
          "",
          "---------------"
        ]
      }
    }
  ]
}