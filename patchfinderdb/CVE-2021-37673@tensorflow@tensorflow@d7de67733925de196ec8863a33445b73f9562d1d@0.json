{
  "cve_id": "CVE-2021-37673",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions an attacker can trigger a denial of service via a `CHECK`-fail in `tf.raw_ops.MapStage`. The [implementation](https://github.com/tensorflow/tensorflow/blob/460e000de3a83278fb00b61a16d161b1964f15f4/tensorflow/core/kernels/map_stage_op.cc#L513) does not check that the `key` input is a valid non-empty tensor. We have patched the issue in GitHub commit d7de67733925de196ec8863a33445b73f9562d1d. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "d7de67733925de196ec8863a33445b73f9562d1d",
  "patch_info": {
    "commit_hash": "d7de67733925de196ec8863a33445b73f9562d1d",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/d7de67733925de196ec8863a33445b73f9562d1d",
    "files": [
      "tensorflow/core/kernels/map_stage_op.cc"
    ],
    "message": "Prevent a CHECK-fail due to empty tensor input in `map_stage_op.cc`\n\nPiperOrigin-RevId: 387737906\nChange-Id: Idc52df0c71c7ed6e2dd633b651a581932f277c8a",
    "before_after_code_files": [
      "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc": [
      "File: tensorflow/core/kernels/map_stage_op.cc -> tensorflow/core/kernels/map_stage_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "527:     OP_REQUIRES_OK(ctx, ctx->input(\"key\", &key_tensor));",
      "528:     OP_REQUIRES_OK(ctx, ctx->input(\"indices\", &indices_tensor));",
      "529:     OP_REQUIRES_OK(ctx, ctx->input_list(\"values\", &values_tensor));",
      "532:     Tensor key(*key_tensor);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "530:     OP_REQUIRES(ctx, key_tensor->NumElements() > 0,",
      "531:                 errors::InvalidArgument(\"key must not be empty\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "32aad6422daa23bbb4c47ab641c405139cfeaa91",
      "candidate_info": {
        "commit_hash": "32aad6422daa23bbb4c47ab641c405139cfeaa91",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/32aad6422daa23bbb4c47ab641c405139cfeaa91",
        "files": [
          "tensorflow/core/kernels/map_stage_op.cc"
        ],
        "message": "Prevent a CHECK-fail due to empty tensor input in `map_stage_op.cc`\n\nPiperOrigin-RevId: 387737906\nChange-Id: Idc52df0c71c7ed6e2dd633b651a581932f277c8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc": [
          "File: tensorflow/core/kernels/map_stage_op.cc -> tensorflow/core/kernels/map_stage_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "527:     OP_REQUIRES_OK(ctx, ctx->input(\"key\", &key_tensor));",
          "528:     OP_REQUIRES_OK(ctx, ctx->input(\"indices\", &indices_tensor));",
          "529:     OP_REQUIRES_OK(ctx, ctx->input_list(\"values\", &values_tensor));",
          "532:     Tensor key(*key_tensor);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "530:     OP_REQUIRES(ctx, key_tensor->NumElements() > 0,",
          "531:                 errors::InvalidArgument(\"key must not be empty\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "57f3e8efe96635ffe298a78cfa1b1af3884a5471",
      "candidate_info": {
        "commit_hash": "57f3e8efe96635ffe298a78cfa1b1af3884a5471",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/57f3e8efe96635ffe298a78cfa1b1af3884a5471",
        "files": [
          "tensorflow/core/kernels/map_stage_op.cc"
        ],
        "message": "Prevent a CHECK-fail due to empty tensor input in `map_stage_op.cc`\n\nPiperOrigin-RevId: 387737906\nChange-Id: Idc52df0c71c7ed6e2dd633b651a581932f277c8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc": [
          "File: tensorflow/core/kernels/map_stage_op.cc -> tensorflow/core/kernels/map_stage_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "527:     OP_REQUIRES_OK(ctx, ctx->input(\"key\", &key_tensor));",
          "528:     OP_REQUIRES_OK(ctx, ctx->input(\"indices\", &indices_tensor));",
          "529:     OP_REQUIRES_OK(ctx, ctx->input_list(\"values\", &values_tensor));",
          "532:     Tensor key(*key_tensor);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "530:     OP_REQUIRES(ctx, key_tensor->NumElements() > 0,",
          "531:                 errors::InvalidArgument(\"key must not be empty\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0e0d1bb4a75a86b4f469afb800fca094cb955a9a",
      "candidate_info": {
        "commit_hash": "0e0d1bb4a75a86b4f469afb800fca094cb955a9a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0e0d1bb4a75a86b4f469afb800fca094cb955a9a",
        "files": [
          "tensorflow/core/kernels/map_stage_op.cc"
        ],
        "message": "Prevent a CHECK-fail due to empty tensor input in `map_stage_op.cc`\n\nPiperOrigin-RevId: 387737906\nChange-Id: Idc52df0c71c7ed6e2dd633b651a581932f277c8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc": [
          "File: tensorflow/core/kernels/map_stage_op.cc -> tensorflow/core/kernels/map_stage_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "527:     OP_REQUIRES_OK(ctx, ctx->input(\"key\", &key_tensor));",
          "528:     OP_REQUIRES_OK(ctx, ctx->input(\"indices\", &indices_tensor));",
          "529:     OP_REQUIRES_OK(ctx, ctx->input_list(\"values\", &values_tensor));",
          "532:     Tensor key(*key_tensor);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "530:     OP_REQUIRES(ctx, key_tensor->NumElements() > 0,",
          "531:                 errors::InvalidArgument(\"key must not be empty\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cc96b0010c576e76c08248c2fe9f498f8a478f0a",
      "candidate_info": {
        "commit_hash": "cc96b0010c576e76c08248c2fe9f498f8a478f0a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/cc96b0010c576e76c08248c2fe9f498f8a478f0a",
        "files": [
          "tensorflow/core/kernels/map_stage_op.cc"
        ],
        "message": "Prevent a CHECK-fail due to empty tensor input in `map_stage_op.cc`\n\nPiperOrigin-RevId: 387737906\nChange-Id: Idc52df0c71c7ed6e2dd633b651a581932f277c8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/map_stage_op.cc||tensorflow/core/kernels/map_stage_op.cc": [
          "File: tensorflow/core/kernels/map_stage_op.cc -> tensorflow/core/kernels/map_stage_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "527:     OP_REQUIRES_OK(ctx, ctx->input(\"key\", &key_tensor));",
          "528:     OP_REQUIRES_OK(ctx, ctx->input(\"indices\", &indices_tensor));",
          "529:     OP_REQUIRES_OK(ctx, ctx->input_list(\"values\", &values_tensor));",
          "532:     Tensor key(*key_tensor);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "530:     OP_REQUIRES(ctx, key_tensor->NumElements() > 0,",
          "531:                 errors::InvalidArgument(\"key must not be empty\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}