{
  "cve_id": "CVE-2020-15210",
  "cve_desc": "In tensorflow-lite before versions 1.15.4, 2.0.3, 2.1.2, 2.2.1 and 2.3.1, if a TFLite saved model uses the same tensor as both input and output of an operator, then, depending on the operator, we can observe a segmentation fault or just memory corruption. We have patched the issue in d58c96946b and will release patch releases for all versions between 1.15 and 2.3. We recommend users to upgrade to TensorFlow 1.15.4, 2.0.3, 2.1.2, 2.2.1, or 2.3.1.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "d58c96946b2880991d63d1dacacb32f0a4dfa453",
  "patch_info": {
    "commit_hash": "d58c96946b2880991d63d1dacacb32f0a4dfa453",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/d58c96946b2880991d63d1dacacb32f0a4dfa453",
    "files": [
      "tensorflow/lite/BUILD",
      "tensorflow/lite/core/subgraph.cc",
      "tensorflow/lite/core/subgraph.h",
      "tensorflow/lite/model_test.cc",
      "tensorflow/lite/testdata/add_shared_tensors.bin",
      "tensorflow/lite/testdata/sparse_tensor.bin"
    ],
    "message": "[tflite] Ensure inputs and outputs don't overlap.\n\nIf a model uses the same tensor for both an input and an output then this can result in data loss and memory corruption. This should not happen.\n\nPiperOrigin-RevId: 332522916\nChange-Id: If0905b142415a9dfceaf2d181872f2a8fb88f48a",
    "before_after_code_files": [
      "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
      "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h",
      "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
      "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "581:   return kTfLiteOk;",
      "582: }",
      "584: namespace {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "594: TfLiteStatus Subgraph::CheckInputAndOutputForOverlap(const int* input_indices,",
      "595:                                                      int num_inputs,",
      "596:                                                      const int* output_indices,",
      "597:                                                      int num_outputs) {",
      "598:   for (int i = 0; i < num_inputs; i++) {",
      "599:     for (int j = 0; j < num_outputs; j++) {",
      "600:       if (input_indices[i] == output_indices[j]) {",
      "601:         ReportError(\"Tensor %d is both input %d and output %d\\n\",",
      "602:                     input_indices[i], i, j);",
      "603:         consistent_ = false;",
      "604:         return kTfLiteError;",
      "605:       }",
      "606:     }",
      "607:   }",
      "608:   return kTfLiteOk;",
      "609: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "707:       &context_,",
      "708:       CheckTensorIndices(\"node outputs\", outputs.data(), outputs.size()));",
      "710:   int new_node_index = nodes_and_registration_.size();",
      "711:   if (node_index) *node_index = new_node_index;",
      "712:   nodes_and_registration_.resize(nodes_and_registration_.size() + 1);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "741:   if (builtin_data != nullptr) {",
      "742:     TF_LITE_ENSURE_OK(&context_, CheckInputAndOutputForOverlap(",
      "743:                                      inputs.data(), inputs.size(),",
      "744:                                      outputs.data(), outputs.size()));",
      "745:   }",
      "",
      "---------------"
    ],
    "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h": [
      "File: tensorflow/lite/core/subgraph.h -> tensorflow/lite/core/subgraph.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "451:   TfLiteStatus CheckTensorIndices(const char* label, const int* indices,",
      "452:                                   int length);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "458:   TfLiteStatus CheckInputAndOutputForOverlap(const int* input_indices,",
      "459:                                              int num_inputs,",
      "460:                                              const int* output_indices,",
      "461:                                              int num_outputs);",
      "",
      "---------------"
    ],
    "tensorflow/lite/model_test.cc||tensorflow/lite/model_test.cc": [
      "File: tensorflow/lite/model_test.cc -> tensorflow/lite/model_test.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "438: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "441: TEST(BasicFlatBufferModel, TestHandleMalformedModel) {",
      "442:   const auto model_paths = {",
      "444:       \"tensorflow/lite/testdata/add_shared_tensors.bin\",",
      "445:   };",
      "447:   for (const auto& model_path : model_paths) {",
      "448:     std::unique_ptr<tflite::FlatBufferModel> model =",
      "449:         FlatBufferModel::BuildFromFile(model_path);",
      "450:     ASSERT_NE(model, nullptr);",
      "452:     tflite::ops::builtin::BuiltinOpResolver resolver;",
      "453:     InterpreterBuilder builder(*model, resolver);",
      "454:     std::unique_ptr<Interpreter> interpreter;",
      "455:     ASSERT_EQ(builder(&interpreter), kTfLiteOk);",
      "456:     ASSERT_NE(interpreter, nullptr);",
      "457:     ASSERT_NE(interpreter->AllocateTensors(), kTfLiteOk);",
      "458:   }",
      "459: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f4159ccef23d11eb58ee4263beaaeac1be3343c7",
      "candidate_info": {
        "commit_hash": "f4159ccef23d11eb58ee4263beaaeac1be3343c7",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f4159ccef23d11eb58ee4263beaaeac1be3343c7",
        "files": [
          "tensorflow/lite/core/subgraph.cc",
          "tensorflow/lite/core/subgraph.h"
        ],
        "message": "[tflite] Ensure inputs and outputs don't overlap.\n\nIf a model uses the same tensor for both an input and an output then this can result in data loss and memory corruption. This should not happen.\n\nPiperOrigin-RevId: 332522916\nChange-Id: If0905b142415a9dfceaf2d181872f2a8fb88f48a",
        "before_after_code_files": [
          "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
          "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
            "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h"
          ],
          "candidate": [
            "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc",
            "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/core/subgraph.cc||tensorflow/lite/core/subgraph.cc": [
          "File: tensorflow/lite/core/subgraph.cc -> tensorflow/lite/core/subgraph.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "464:   return kTfLiteOk;",
          "465: }",
          "467: TfLiteStatus Subgraph::BytesRequired(TfLiteType type, const int* dims,",
          "468:                                      size_t dims_size, size_t* bytes) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "477: TfLiteStatus Subgraph::CheckInputAndOutputForOverlap(const int* input_indices,",
          "478:                                                      int num_inputs,",
          "479:                                                      const int* output_indices,",
          "480:                                                      int num_outputs) {",
          "481:   for (int i = 0; i < num_inputs; i++) {",
          "482:     for (int j = 0; j < num_outputs; j++) {",
          "483:       if (input_indices[i] == output_indices[j]) {",
          "484:         ReportError(\"Tensor %d is both input %d and output %d\\n\",",
          "485:                     input_indices[i], i, j);",
          "486:         consistent_ = false;",
          "487:         return kTfLiteError;",
          "488:       }",
          "489:     }",
          "490:   }",
          "491:   return kTfLiteOk;",
          "492: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "553:       &context_,",
          "554:       CheckTensorIndices(\"node outputs\", outputs.data(), outputs.size()));",
          "556:   int new_node_index = nodes_and_registration_.size();",
          "557:   if (node_index) *node_index = new_node_index;",
          "558:   nodes_and_registration_.resize(nodes_and_registration_.size() + 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "587:   if (builtin_data != nullptr) {",
          "588:     TF_LITE_ENSURE_OK(&context_, CheckInputAndOutputForOverlap(",
          "589:                                      inputs.data(), inputs.size(),",
          "590:                                      outputs.data(), outputs.size()));",
          "591:   }",
          "",
          "---------------"
        ],
        "tensorflow/lite/core/subgraph.h||tensorflow/lite/core/subgraph.h": [
          "File: tensorflow/lite/core/subgraph.h -> tensorflow/lite/core/subgraph.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "358:   TfLiteStatus CheckTensorIndices(const char* label, const int* indices,",
          "359:                                   int length);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "365:   TfLiteStatus CheckInputAndOutputForOverlap(const int* input_indices,",
          "366:                                              int num_inputs,",
          "367:                                              const int* output_indices,",
          "368:                                              int num_outputs);",
          "",
          "---------------"
        ]
      }
    }
  ]
}