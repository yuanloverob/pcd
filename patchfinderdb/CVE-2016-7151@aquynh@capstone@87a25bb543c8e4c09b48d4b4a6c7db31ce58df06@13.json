{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1601b15f07f5d627c9150b2bdb1ef2dc58dc23d3",
      "candidate_info": {
        "commit_hash": "1601b15f07f5d627c9150b2bdb1ef2dc58dc23d3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/1601b15f07f5d627c9150b2bdb1ef2dc58dc23d3",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: cleanup",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "74: static void usage(char *prog)",
          "75: {",
          "76:  printf(\"Cstool v%s for Capstone Disassembler Engine (core v%u.%u)\\n\\n\", VERSION, CS_API_MAJOR, CS_API_MINOR);",
          "78:  printf(\"\\nThe following <arch+mode> options are supported:\\n\");",
          "80:  if (cs_support(CS_ARCH_X86)) {",
          "",
          "[Removed Lines]",
          "77:  printf(\"Syntax: %s [-d:print all detail information] <arch+mode> <assembly-hexstring> [start-address-in-hex-format]\\n\", prog);",
          "",
          "[Added Lines]",
          "77:  printf(\"Syntax: %s [-d] <arch+mode> <assembly-hexstring> [start-address-in-hex-format]\\n\", prog);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "358156320b6ad666ee29523d6794980651778c9a",
      "candidate_info": {
        "commit_hash": "358156320b6ad666ee29523d6794980651778c9a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/358156320b6ad666ee29523d6794980651778c9a",
        "files": [
          "arch/M68K/M68KDisassembler.c",
          "include/capstone/m68k.h"
        ],
        "message": "Changed register pair handling in M68K header\n\n* instead of using bit operations, we now leverage the size of the\n  enclosing union to avoid running code and provide a more convenient\n  interface to the library user.",
        "before_after_code_files": [
          "arch/M68K/M68KDisassembler.c||arch/M68K/M68KDisassembler.c",
          "include/capstone/m68k.h||include/capstone/m68k.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/M68K/M68KDisassembler.c||arch/M68K/M68KDisassembler.c": [
          "File: arch/M68K/M68KDisassembler.c -> arch/M68K/M68KDisassembler.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "980:  op0->address_mode = M68K_AM_NONE;",
          "981:  op0->type = M68K_OP_REG_PAIR;",
          "984:  op1->address_mode = M68K_AM_NONE;",
          "985:  op1->type = M68K_OP_REG_PAIR;",
          "988:  reg_0 = (extension >> 28) & 7;",
          "989:  reg_1 = (extension >> 12) & 7;",
          "991:  op2->address_mode = M68K_AM_NONE;",
          "992:  op2->type = M68K_OP_REG_PAIR;",
          "995: }",
          "997: static void build_chk2_cmp2(m68k_info *info, int size)",
          "",
          "[Removed Lines]",
          "982:  op0->register_bits = (((extension >> 16) & 7) << 4) | (extension & 7);",
          "986:  op1->register_bits = (((extension >> 22) & 7) << 4) | ((extension >> 6) & 7);",
          "993:  op2->register_bits = ((reg_0 + (BIT_1F(extension) ? 8 : 0)) << 4) |",
          "994:   (reg_1 + (BIT_F(extension) ? 8 : 0));",
          "",
          "[Added Lines]",
          "982:  op0->reg_pair.reg_0 = (extension >> 16) & 7;",
          "983:  op0->reg_pair.reg_1 = extension & 7;",
          "987:  op1->reg_pair.reg_0 = (extension >> 22) & 7;",
          "988:  op1->reg_pair.reg_1 = (extension >> 6) & 7;",
          "995:  op2->reg_pair.reg_0 = reg_0 + (BIT_1F(extension) ? 8 : 0);",
          "996:  op2->reg_pair.reg_1 = reg_1 + (BIT_F(extension) ? 8 : 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2245:  op1->address_mode = M68K_AM_NONE;",
          "2246:  op1->type = M68K_OP_REG_PAIR;",
          "2249:  if ((reg_0 == reg_1) || !BIT_A(extension)) {",
          "2250:   op1->type = M68K_OP_REG;",
          "",
          "[Removed Lines]",
          "2247:  op1->register_bits = (reg_0 << 4) | reg_1;",
          "",
          "[Added Lines]",
          "2249:  op1->reg_pair.reg_0 = reg_0;",
          "2250:  op1->reg_pair.reg_1 = reg_1;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2790:  op1->address_mode = M68K_AM_NONE;",
          "2791:  op1->type = M68K_OP_REG_PAIR;",
          "2794:  if (!BIT_A(extension)) {",
          "2795:   op1->type = M68K_OP_REG;",
          "",
          "[Removed Lines]",
          "2792:  op1->register_bits = (reg_0 << 4) | reg_1;",
          "",
          "[Added Lines]",
          "2795:  op1->reg_pair.reg_0 = reg_0;",
          "2796:  op1->reg_pair.reg_1 = reg_1;",
          "",
          "---------------"
        ],
        "include/capstone/m68k.h||include/capstone/m68k.h": [
          "File: include/capstone/m68k.h -> include/capstone/m68k.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "112:  M68K_OP_REG,         // = CS_OP_REG (Register operand).",
          "113:  M68K_OP_IMM,         // = CS_OP_IMM (Immediate operand).",
          "114:  M68K_OP_MEM,         // = CS_OP_MEM (Memory operand).",
          "116:  M68K_OP_REG_BITS,    // Register bits move",
          "117:  M68K_OP_REG_PAIR,    // Register pair in the same op (upper 4 bits for first reg, lower for second)",
          "118: } m68k_op_type;",
          "",
          "[Removed Lines]",
          "115:  M68K_OP_FP,          // = CS_OP_FP  (Floating-Point operand)",
          "",
          "[Added Lines]",
          "115:  M68K_OP_FP_SINGLE,   // single precision Floating-Point operand",
          "116:  M68K_OP_FP_DOUBLE,   // double precision Floating-Point operand",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "137: typedef struct cs_m68k_op {",
          "138:  union {",
          "140:   double dimm;       // double imm",
          "141:   float simm;       // float imm",
          "142:   m68k_reg reg;      // register value for REG operand",
          "143:   m68k_op_mem mem;      // data when operand is targeting memory",
          "145:  };",
          "146:  m68k_op_type type;",
          "147:  m68k_address_mode address_mode; // M68K addressing mode for this op",
          "",
          "[Removed Lines]",
          "139:   uint64_t imm;           // immediate value for IMM operand",
          "144:   uint32_t register_bits; // register bits for movem/cas2/etc (always in d0-d7, a0-a7, fp0 - fp7 order)",
          "",
          "[Added Lines]",
          "140:   uint64_t imm;               // immediate value for IMM operand",
          "144:   struct {      // register pair in one operand",
          "145:    m68k_reg reg_0;",
          "146:    m68k_reg reg_1;",
          "147:   } reg_pair;",
          "149:   uint32_t register_bits; // register bits for movem etc. (always in d0-d7, a0-a7, fp0 - fp7 order)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4f8d7999bfec38827fe0a9ddfbf4f40f91a0af2b",
      "candidate_info": {
        "commit_hash": "4f8d7999bfec38827fe0a9ddfbf4f40f91a0af2b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4f8d7999bfec38827fe0a9ddfbf4f40f91a0af2b",
        "files": [
          "cs.c"
        ],
        "message": "Update cs.c\n\nremove a dead code, suggested by @vit9696 on #867",
        "before_after_code_files": [
          "cs.c||cs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cs.c||cs.c": [
          "File: cs.c -> cs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "354: #ifndef CAPSTONE_DIET",
          "358:  mnem = insn->mnemonic;",
          "359:  for (sp = buffer; *sp; sp++) {",
          "360:   if (*sp == ' '|| *sp == '\\t')",
          "",
          "[Removed Lines]",
          "357:  sp = buffer;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ab93c00ea3ac8d5574d4e4996d58cddbd8e6374a",
      "candidate_info": {
        "commit_hash": "ab93c00ea3ac8d5574d4e4996d58cddbd8e6374a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/ab93c00ea3ac8d5574d4e4996d58cddbd8e6374a",
        "files": [
          "arch/Sparc/SparcInstPrinter.c"
        ],
        "message": "sparc: fix target address of CALL instruction. issue #653",
        "before_after_code_files": [
          "arch/Sparc/SparcInstPrinter.c||arch/Sparc/SparcInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/Sparc/SparcInstPrinter.c||arch/Sparc/SparcInstPrinter.c": [
          "File: arch/Sparc/SparcInstPrinter.c -> arch/Sparc/SparcInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "196:   switch (MI->Opcode) {",
          "197:    case SP_CALL:",
          "199:     Imm += (uint32_t)MI->address;",
          "200:     break;",
          "",
          "[Removed Lines]",
          "198:     Imm = SignExtend32(Imm, 30);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a1422bd8f6a41a6bc1dfc56eac19f2ef366e7bdc",
      "candidate_info": {
        "commit_hash": "a1422bd8f6a41a6bc1dfc56eac19f2ef366e7bdc",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/a1422bd8f6a41a6bc1dfc56eac19f2ef366e7bdc",
        "files": [
          "arch/ARM/ARMInstPrinter.c"
        ],
        "message": "arm: add IMM operand for printPostIdxImm8s4Operand(). issue #861",
        "before_after_code_files": [
          "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c": [
          "File: arch/ARM/ARMInstPrinter.c -> arch/ARM/ARMInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1266: {",
          "1267:  MCOperand *MO = MCInst_getOperand(MI, OpNum);",
          "1268:  unsigned Imm = (unsigned int)MCOperand_getImm(MO);",
          "1270:   SStream_concat(O, \"#%s0x%x\", ((Imm & 256) ? \"\" : \"-\"), ((Imm & 0xff) << 2));",
          "1272:   SStream_concat(O, \"#%s%u\", ((Imm & 256) ? \"\" : \"-\"), ((Imm & 0xff) << 2));",
          "1273: }",
          "1275: static void printAddrMode5Operand(MCInst *MI, unsigned OpNum, SStream *O,",
          "",
          "[Removed Lines]",
          "1269:  if (((Imm & 0xff) << 2) > HEX_THRESHOLD)",
          "1271:  else",
          "",
          "[Added Lines]",
          "1270:  if (((Imm & 0xff) << 2) > HEX_THRESHOLD) {",
          "1272:  } else {",
          "1274:  }",
          "1276:  if (MI->csh->detail) {",
          "1277:   int v = (Imm & 256) ? ((Imm & 0xff) << 2) : -((Imm & 0xff) << 2);",
          "1278:   MI->flat_insn->detail->arm.operands[MI->flat_insn->detail->arm.op_count].type = ARM_OP_IMM;",
          "1279:   MI->flat_insn->detail->arm.operands[MI->flat_insn->detail->arm.op_count].imm = v;",
          "1280:   MI->flat_insn->detail->arm.op_count++;",
          "1281:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}