{
  "cve_id": "CVE-2021-29559",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can access data outside of bounds of heap allocated array in `tf.raw_ops.UnicodeEncode`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/472c1f12ad9063405737679d4f6bd43094e1d36d/tensorflow/core/kernels/unicode_ops.cc) assumes that the `input_value`/`input_splits` pair specify a valid sparse tensor. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "51300ba1cc2f487aefec6e6631fef03b0e08b298",
  "patch_info": {
    "commit_hash": "51300ba1cc2f487aefec6e6631fef03b0e08b298",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/51300ba1cc2f487aefec6e6631fef03b0e08b298",
    "files": [
      "tensorflow/core/kernels/unicode_ops.cc"
    ],
    "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
    "before_after_code_files": [
      "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
      "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "533:     const Tensor& input_splits = context->input(1);",
      "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "539:     OP_REQUIRES(",
      "540:         context, input_splits_flat(0) == 0,",
      "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
      "542:     OP_REQUIRES(context,",
      "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
      "544:                     input_tensor_flat.size(),",
      "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
      "546:                                         \"equal to length of input_tensor.\"));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
      "549:       icu::UnicodeString unicode_string;",
      "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
      "551:       for (; idx < input_splits_flat(i); ++idx) {",
      "552:         int32 code_point = input_tensor_flat(idx);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "562:       OP_REQUIRES(",
      "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
      "564:           errors::InvalidArgument(",
      "565:               \"Values in input_splits must be equal or in ascending order.\"));",
      "566:       OP_REQUIRES(",
      "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
      "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
      "569:                                   \"equal to input_tensor length.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6fb000620442d7c8367c7acef169f67b7aeecedb",
      "candidate_info": {
        "commit_hash": "6fb000620442d7c8367c7acef169f67b7aeecedb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6fb000620442d7c8367c7acef169f67b7aeecedb",
        "files": [
          "tensorflow/core/kernels/unicode_ops.cc"
        ],
        "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
        "before_after_code_files": [
          "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
          "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     const Tensor& input_splits = context->input(1);",
          "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "539:     OP_REQUIRES(",
          "540:         context, input_splits_flat(0) == 0,",
          "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
          "542:     OP_REQUIRES(context,",
          "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
          "544:                     input_tensor_flat.size(),",
          "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
          "546:                                         \"equal to length of input_tensor.\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
          "549:       icu::UnicodeString unicode_string;",
          "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
          "551:       for (; idx < input_splits_flat(i); ++idx) {",
          "552:         int32 code_point = input_tensor_flat(idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562:       OP_REQUIRES(",
          "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
          "564:           errors::InvalidArgument(",
          "565:               \"Values in input_splits must be equal or in ascending order.\"));",
          "566:       OP_REQUIRES(",
          "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
          "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
          "569:                                   \"equal to input_tensor length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2418b1c7874caa3d156cff987fafc4f4b483f818",
      "candidate_info": {
        "commit_hash": "2418b1c7874caa3d156cff987fafc4f4b483f818",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/2418b1c7874caa3d156cff987fafc4f4b483f818",
        "files": [
          "tensorflow/core/kernels/unicode_ops.cc"
        ],
        "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
        "before_after_code_files": [
          "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
          "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     const Tensor& input_splits = context->input(1);",
          "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "539:     OP_REQUIRES(",
          "540:         context, input_splits_flat(0) == 0,",
          "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
          "542:     OP_REQUIRES(context,",
          "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
          "544:                     input_tensor_flat.size(),",
          "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
          "546:                                         \"equal to length of input_tensor.\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
          "549:       icu::UnicodeString unicode_string;",
          "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
          "551:       for (; idx < input_splits_flat(i); ++idx) {",
          "552:         int32 code_point = input_tensor_flat(idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562:       OP_REQUIRES(",
          "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
          "564:           errors::InvalidArgument(",
          "565:               \"Values in input_splits must be equal or in ascending order.\"));",
          "566:       OP_REQUIRES(",
          "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
          "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
          "569:                                   \"equal to input_tensor length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4f3a1bf4765dde9c35a6ae9797a9aa444752db7e",
      "candidate_info": {
        "commit_hash": "4f3a1bf4765dde9c35a6ae9797a9aa444752db7e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/4f3a1bf4765dde9c35a6ae9797a9aa444752db7e",
        "files": [
          "tensorflow/core/kernels/unicode_ops.cc"
        ],
        "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
        "before_after_code_files": [
          "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
          "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     const Tensor& input_splits = context->input(1);",
          "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "539:     OP_REQUIRES(",
          "540:         context, input_splits_flat(0) == 0,",
          "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
          "542:     OP_REQUIRES(context,",
          "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
          "544:                     input_tensor_flat.size(),",
          "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
          "546:                                         \"equal to length of input_tensor.\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
          "549:       icu::UnicodeString unicode_string;",
          "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
          "551:       for (; idx < input_splits_flat(i); ++idx) {",
          "552:         int32 code_point = input_tensor_flat(idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562:       OP_REQUIRES(",
          "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
          "564:           errors::InvalidArgument(",
          "565:               \"Values in input_splits must be equal or in ascending order.\"));",
          "566:       OP_REQUIRES(",
          "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
          "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
          "569:                                   \"equal to input_tensor length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c27493e6044ac20c3df47e6f84afb4c1645ce84f",
      "candidate_info": {
        "commit_hash": "c27493e6044ac20c3df47e6f84afb4c1645ce84f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c27493e6044ac20c3df47e6f84afb4c1645ce84f",
        "files": [
          "tensorflow/core/kernels/unicode_ops.cc"
        ],
        "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
        "before_after_code_files": [
          "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
          "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     const Tensor& input_splits = context->input(1);",
          "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "539:     OP_REQUIRES(",
          "540:         context, input_splits_flat(0) == 0,",
          "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
          "542:     OP_REQUIRES(context,",
          "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
          "544:                     input_tensor_flat.size(),",
          "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
          "546:                                         \"equal to length of input_tensor.\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
          "549:       icu::UnicodeString unicode_string;",
          "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
          "551:       for (; idx < input_splits_flat(i); ++idx) {",
          "552:         int32 code_point = input_tensor_flat(idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562:       OP_REQUIRES(",
          "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
          "564:           errors::InvalidArgument(",
          "565:               \"Values in input_splits must be equal or in ascending order.\"));",
          "566:       OP_REQUIRES(",
          "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
          "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
          "569:                                   \"equal to input_tensor length.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d16b7bd6db1cea2aeaf391f648529d54655ec04e",
      "candidate_info": {
        "commit_hash": "d16b7bd6db1cea2aeaf391f648529d54655ec04e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d16b7bd6db1cea2aeaf391f648529d54655ec04e",
        "files": [
          "tensorflow/core/kernels/unicode_ops.cc"
        ],
        "message": "Fix heap buffer overflow in tf.raw_ops.UnicodeEncode.\n\nPiperOrigin-RevId: 371717714\nChange-Id: If33443b28f158e58078f1268f6b92f2728d219e0",
        "before_after_code_files": [
          "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unicode_ops.cc||tensorflow/core/kernels/unicode_ops.cc": [
          "File: tensorflow/core/kernels/unicode_ops.cc -> tensorflow/core/kernels/unicode_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     const Tensor& input_splits = context->input(1);",
          "534:     const auto input_splits_flat = input_splits.flat<SPLITS_TYPE>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "539:     OP_REQUIRES(",
          "540:         context, input_splits_flat(0) == 0,",
          "541:         errors::InvalidArgument(\"First value in input_splits must be zero.\"));",
          "542:     OP_REQUIRES(context,",
          "543:                 input_splits_flat(input_splits_flat.size() - 1) ==",
          "544:                     input_tensor_flat.size(),",
          "545:                 errors::InvalidArgument(\"Last value in input_splits must be \"",
          "546:                                         \"equal to length of input_tensor.\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:     for (int i = 1; i < input_splits_flat.size(); ++i) {",
          "549:       icu::UnicodeString unicode_string;",
          "550:       icu::UnicodeStringAppendable appendable_unicode_string(unicode_string);",
          "551:       for (; idx < input_splits_flat(i); ++idx) {",
          "552:         int32 code_point = input_tensor_flat(idx);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "562:       OP_REQUIRES(",
          "563:           context, input_splits_flat(i - 1) <= input_splits_flat(i),",
          "564:           errors::InvalidArgument(",
          "565:               \"Values in input_splits must be equal or in ascending order.\"));",
          "566:       OP_REQUIRES(",
          "567:           context, input_splits_flat(i) <= input_tensor_flat.size(),",
          "568:           errors::InvalidArgument(\"Values in input_splits must be less than or \"",
          "569:                                   \"equal to input_tensor length.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}