{
  "cve_id": "CVE-2020-11947",
  "cve_desc": "iscsi_aio_ioctl_cb in block/iscsi.c in QEMU 4.1.0 has a heap-based buffer over-read that may disclose unrelated information from process memory to an attacker.",
  "repo": "qemu/qemu",
  "patch_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
  "patch_info": {
    "commit_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "files": [
      "block/iscsi.c"
    ],
    "message": "block/iscsi:fix heap-buffer-overflow in iscsi_aio_ioctl_cb\n\nThere is an overflow, the source 'datain.data[2]' is 100 bytes,\n but the 'ss' is 252 bytes.This may cause a security issue because\n we can access a lot of unrelated memory data.\n\nThe len for sbp copy data should take the minimum of mx_sb_len and\n sb_len_wr, not the maximum.\n\nIf we use iscsi device for VM backend storage, ASAN show stack:\n\nREAD of size 252 at 0xfffd149dcfc4 thread T0\n    #0 0xaaad433d0d34 in __asan_memcpy (aarch64-softmmu/qemu-system-aarch64+0x2cb0d34)\n    #1 0xaaad45f9d6d0 in iscsi_aio_ioctl_cb /qemu/block/iscsi.c:996:9\n    #2 0xfffd1af0e2dc  (/usr/lib64/iscsi/libiscsi.so.8+0xe2dc)\n    #3 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #4 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #5 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #6 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #7 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #8 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #9 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #10 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #11 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #12 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #13 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #14 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #15 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #16 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #17 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\n0xfffd149dcfc4 is located 0 bytes to the right of 100-byte region [0xfffd149dcf60,0xfffd149dcfc4)\nallocated by thread T0 here:\n    #0 0xaaad433d1e70 in __interceptor_malloc (aarch64-softmmu/qemu-system-aarch64+0x2cb1e70)\n    #1 0xfffd1af0e254  (/usr/lib64/iscsi/libiscsi.so.8+0xe254)\n    #2 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #3 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #4 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #5 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #6 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #7 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #8 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #9 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #10 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #11 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #12 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #13 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #14 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #15 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #16 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Chen Qun <kuhn.chenqun@huawei.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nMessage-id: 20200418062602.10776-1-kuhn.chenqun@huawei.com\nReviewed-by: Daniel P. Berrang\u00e9 <berrange@redhat.com>\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
    "before_after_code_files": [
      "block/iscsi.c||block/iscsi.c"
    ]
  },
  "patch_diff": {
    "block/iscsi.c||block/iscsi.c": [
      "File: block/iscsi.c -> block/iscsi.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "991:         acb->ioh->driver_status |= SG_ERR_DRIVER_SENSE;",
      "993:         acb->ioh->sb_len_wr = acb->task->datain.size - 2;",
      "996:         memcpy(acb->ioh->sbp, &acb->task->datain.data[2], ss);",
      "997:     }",
      "",
      "[Removed Lines]",
      "994:         ss = (acb->ioh->mx_sb_len >= acb->ioh->sb_len_wr) ?",
      "995:              acb->ioh->mx_sb_len : acb->ioh->sb_len_wr;",
      "",
      "[Added Lines]",
      "994:         ss = MIN(acb->ioh->mx_sb_len, acb->ioh->sb_len_wr);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9cbc36497c9c0ab92008f3dc71748640035be3af",
      "candidate_info": {
        "commit_hash": "9cbc36497c9c0ab92008f3dc71748640035be3af",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/9cbc36497c9c0ab92008f3dc71748640035be3af",
        "files": [
          "migration/migration.c"
        ],
        "message": "migration: fix cleanup_bh leak on resume\n\nSince commit 8c6b0356b53977bcfdea5299db07884915425b0c (\"util/async:\nmake bh_aio_poll() O(1)\"), migration-test reveals a leak:\n\nQTEST_QEMU_BINARY=x86_64-softmmu/qemu-system-x86_64\ntests/qtest/migration-test  -p /x86_64/migration/postcopy/recovery\ntests/qtest/libqtest.c:140: kill_qemu() tried to terminate QEMU\nprocess but encountered exit status 1 (expected 0)\n\n=================================================================\n==2082571==ERROR: LeakSanitizer: detected memory leaks\n\nDirect leak of 40 byte(s) in 1 object(s) allocated from:\n    #0 0x7f25971dfc58 in __interceptor_malloc (/lib64/libasan.so.5+0x10dc58)\n    #1 0x7f2596d08358 in g_malloc (/lib64/libglib-2.0.so.0+0x57358)\n    #2 0x560970d006f8 in qemu_bh_new /home/elmarco/src/qemu/util/main-loop.c:532\n    #3 0x5609704afa02 in migrate_fd_connect\n/home/elmarco/src/qemu/migration/migration.c:3407\n    #4 0x5609704b6b6f in migration_channel_connect\n/home/elmarco/src/qemu/migration/channel.c:92\n    #5 0x5609704b2bfb in socket_outgoing_migration\n/home/elmarco/src/qemu/migration/socket.c:108\n    #6 0x560970b9bd6c in qio_task_complete /home/elmarco/src/qemu/io/task.c:196\n    #7 0x560970b9aa97 in qio_task_thread_result\n/home/elmarco/src/qemu/io/task.c:111\n    #8 0x7f2596cfee3a  (/lib64/libglib-2.0.so.0+0x4de3a)\n\nSigned-off-by: Marc-Andr\u00e9 Lureau <marcandre.lureau@redhat.com>\nMessage-Id: <20200325184723.2029630-2-marcandre.lureau@redhat.com>\nReviewed-by: Juan Quintela <quintela@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
        "before_after_code_files": [
          "migration/migration.c||migration/migration.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "migration/migration.c||migration/migration.c": [
          "File: migration/migration.c -> migration/migration.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3478:     bool resume = s->state == MIGRATION_STATUS_POSTCOPY_PAUSED;",
          "3480:     s->expected_downtime = s->parameters.downtime_limit;",
          "3482:     if (error_in) {",
          "3483:         migrate_fd_error(s, error_in);",
          "3484:         migrate_fd_cleanup(s);",
          "",
          "[Removed Lines]",
          "3481:     s->cleanup_bh = qemu_bh_new(migrate_fd_cleanup_bh, s);",
          "",
          "[Added Lines]",
          "3481:     if (resume) {",
          "3482:         assert(s->cleanup_bh);",
          "3483:     } else {",
          "3484:         assert(!s->cleanup_bh);",
          "3485:         s->cleanup_bh = qemu_bh_new(migrate_fd_cleanup_bh, s);",
          "3486:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4aebf0f0da4a57204f568deed14661cb37b4ac30",
      "candidate_info": {
        "commit_hash": "4aebf0f0da4a57204f568deed14661cb37b4ac30",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/4aebf0f0da4a57204f568deed14661cb37b4ac30",
        "files": [
          "block/qcow2.c"
        ],
        "message": "block/qcow2: do free crypto_opts in qcow2_close()\n\n'crypto_opts' forgot to free in qcow2_close(), this patch fix the bellow leak stack:\n\nDirect leak of 24 byte(s) in 1 object(s) allocated from:\n    #0 0x7f0edd81f970 in __interceptor_calloc (/lib64/libasan.so.5+0xef970)\n    #1 0x7f0edc6d149d in g_malloc0 (/lib64/libglib-2.0.so.0+0x5249d)\n    #2 0x55d7eaede63d in qobject_input_start_struct /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qobject-input-visitor.c:295\n    #3 0x55d7eaed78b8 in visit_start_struct /mnt/sdb/qemu-new/qemu_test/qemu/qapi/qapi-visit-core.c:49\n    #4 0x55d7eaf5140b in visit_type_QCryptoBlockOpenOptions qapi/qapi-visit-crypto.c:290\n    #5 0x55d7eae43af3 in block_crypto_open_opts_init /mnt/sdb/qemu-new/qemu_test/qemu/block/crypto.c:163\n    #6 0x55d7eacd2924 in qcow2_update_options_prepare /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:1148\n    #7 0x55d7eacd33f7 in qcow2_update_options /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:1232\n    #8 0x55d7eacd9680 in qcow2_do_open /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:1512\n    #9 0x55d7eacdc55e in qcow2_open_entry /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:1792\n    #10 0x55d7eacdc8fe in qcow2_open /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:1819\n    #11 0x55d7eac3742d in bdrv_open_driver /mnt/sdb/qemu-new/qemu_test/qemu/block.c:1317\n    #12 0x55d7eac3e990 in bdrv_open_common /mnt/sdb/qemu-new/qemu_test/qemu/block.c:1575\n    #13 0x55d7eac4442c in bdrv_open_inherit /mnt/sdb/qemu-new/qemu_test/qemu/block.c:3126\n    #14 0x55d7eac45c3f in bdrv_open /mnt/sdb/qemu-new/qemu_test/qemu/block.c:3219\n    #15 0x55d7ead8e8a4 in blk_new_open /mnt/sdb/qemu-new/qemu_test/qemu/block/block-backend.c:397\n    #16 0x55d7eacde74c in qcow2_co_create /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:3534\n    #17 0x55d7eacdfa6d in qcow2_co_create_opts /mnt/sdb/qemu-new/qemu_test/qemu/block/qcow2.c:3668\n    #18 0x55d7eac1c678 in bdrv_create_co_entry /mnt/sdb/qemu-new/qemu_test/qemu/block.c:485\n    #19 0x55d7eb0024d2 in coroutine_trampoline /mnt/sdb/qemu-new/qemu_test/qemu/util/coroutine-ucontext.c:115\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nMessage-Id: <20200227012950.12256-2-pannengyuan@huawei.com>\nSigned-off-by: Max Reitz <mreitz@redhat.com>",
        "before_after_code_files": [
          "block/qcow2.c||block/qcow2.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "block/qcow2.c||block/qcow2.c": [
          "File: block/qcow2.c -> block/qcow2.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2611:     qcrypto_block_free(s->crypto);",
          "2612:     s->crypto = NULL;",
          "2614:     g_free(s->unknown_header_fields);",
          "2615:     cleanup_unknown_header_ext(bs);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2613:     qapi_free_QCryptoBlockOpenOptions(s->crypto_opts);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b3fbb328123575e5b39e35e13ecbd4927569a82b",
      "candidate_info": {
        "commit_hash": "b3fbb328123575e5b39e35e13ecbd4927569a82b",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/b3fbb328123575e5b39e35e13ecbd4927569a82b",
        "files": [
          "qapi/qmp-dispatch.c"
        ],
        "message": "qmp: fix leak on callbacks that return both value and error\n\nDirect leak of 4120 byte(s) in 1 object(s) allocated from:\n    #0 0x7fa114931887 in __interceptor_calloc (/lib64/libasan.so.6+0xb0887)\n    #1 0x7fa1144ad8f0 in g_malloc0 (/lib64/libglib-2.0.so.0+0x588f0)\n    #2 0x561e3c9c8897 in qmp_object_add /home/elmarco/src/qemu/qom/qom-qmp-cmds.c:291\n    #3 0x561e3cf48736 in qmp_dispatch /home/elmarco/src/qemu/qapi/qmp-dispatch.c:155\n    #4 0x561e3c8efb36 in monitor_qmp_dispatch /home/elmarco/src/qemu/monitor/qmp.c:145\n    #5 0x561e3c8f09ed in monitor_qmp_bh_dispatcher /home/elmarco/src/qemu/monitor/qmp.c:234\n    #6 0x561e3d08c993 in aio_bh_call /home/elmarco/src/qemu/util/async.c:136\n    #7 0x561e3d08d0a5 in aio_bh_poll /home/elmarco/src/qemu/util/async.c:164\n    #8 0x561e3d0a535a in aio_dispatch /home/elmarco/src/qemu/util/aio-posix.c:380\n    #9 0x561e3d08e3ca in aio_ctx_dispatch /home/elmarco/src/qemu/util/async.c:298\n    #10 0x7fa1144a776e in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x5276e)\n\nSigned-off-by: Marc-Andr\u00e9 Lureau <marcandre.lureau@redhat.com>\nMessage-Id: <20200325184723.2029630-3-marcandre.lureau@redhat.com>\nReviewed-by: Markus Armbruster <armbru@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
        "before_after_code_files": [
          "qapi/qmp-dispatch.c||qapi/qmp-dispatch.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "qapi/qmp-dispatch.c||qapi/qmp-dispatch.c": [
          "File: qapi/qmp-dispatch.c -> qapi/qmp-dispatch.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "155:     cmd->fn(args, &ret, &err);",
          "156:     qobject_unref(args);",
          "157:     if (err) {",
          "158:         goto out;",
          "159:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "159:         qobject_unref(ret);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0ac2e63575b5af918e333cc687bbd8e1ab7bb6fe",
      "candidate_info": {
        "commit_hash": "0ac2e63575b5af918e333cc687bbd8e1ab7bb6fe",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/0ac2e63575b5af918e333cc687bbd8e1ab7bb6fe",
        "files": [
          "hw/block/vhost-user-blk.c",
          "hw/virtio/vhost.c"
        ],
        "message": "vhost-user-blk: fix invalid memory access\n\nwhen s->inflight is freed, vhost_dev_free_inflight may try to access\ns->inflight->addr, it will retrigger the following issue.\n\n==7309==ERROR: AddressSanitizer: heap-use-after-free on address 0x604001020d18 at pc 0x555555ce948a bp 0x7fffffffb170 sp 0x7fffffffb160\nREAD of size 8 at 0x604001020d18 thread T0\n    #0 0x555555ce9489 in vhost_dev_free_inflight /root/smartx/qemu-el7/qemu-test/hw/virtio/vhost.c:1473\n    #1 0x555555cd86eb in virtio_reset /root/smartx/qemu-el7/qemu-test/hw/virtio/virtio.c:1214\n    #2 0x5555560d3eff in virtio_pci_reset hw/virtio/virtio-pci.c:1859\n    #3 0x555555f2ac53 in device_set_realized hw/core/qdev.c:893\n    #4 0x5555561d572c in property_set_bool qom/object.c:1925\n    #5 0x5555561de8de in object_property_set_qobject qom/qom-qobject.c:27\n    #6 0x5555561d99f4 in object_property_set_bool qom/object.c:1188\n    #7 0x555555e50ae7 in qdev_device_add /root/smartx/qemu-el7/qemu-test/qdev-monitor.c:626\n    #8 0x555555e51213 in qmp_device_add /root/smartx/qemu-el7/qemu-test/qdev-monitor.c:806\n    #9 0x555555e8ff40 in hmp_device_add /root/smartx/qemu-el7/qemu-test/hmp.c:1951\n    #10 0x555555be889a in handle_hmp_command /root/smartx/qemu-el7/qemu-test/monitor.c:3404\n    #11 0x555555beac8b in monitor_command_cb /root/smartx/qemu-el7/qemu-test/monitor.c:4296\n    #12 0x555556433eb7 in readline_handle_byte util/readline.c:393\n    #13 0x555555be89ec in monitor_read /root/smartx/qemu-el7/qemu-test/monitor.c:4279\n    #14 0x5555563285cc in tcp_chr_read chardev/char-socket.c:470\n    #15 0x7ffff670b968 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x4a968)\n    #16 0x55555640727c in glib_pollfds_poll util/main-loop.c:215\n    #17 0x55555640727c in os_host_main_loop_wait util/main-loop.c:238\n    #18 0x55555640727c in main_loop_wait util/main-loop.c:497\n    #19 0x555555b2d0bf in main_loop /root/smartx/qemu-el7/qemu-test/vl.c:2013\n    #20 0x555555b2d0bf in main /root/smartx/qemu-el7/qemu-test/vl.c:4776\n    #21 0x7fffdd2eb444 in __libc_start_main (/lib64/libc.so.6+0x22444)\n    #22 0x555555b3767a  (/root/smartx/qemu-el7/qemu-test/x86_64-softmmu/qemu-system-x86_64+0x5e367a)\n\n0x604001020d18 is located 8 bytes inside of 40-byte region [0x604001020d10,0x604001020d38)\nfreed by thread T0 here:\n    #0 0x7ffff6f00508 in __interceptor_free (/lib64/libasan.so.4+0xde508)\n    #1 0x7ffff671107d in g_free (/lib64/libglib-2.0.so.0+0x5007d)\n\npreviously allocated by thread T0 here:\n    #0 0x7ffff6f00a88 in __interceptor_calloc (/lib64/libasan.so.4+0xdea88)\n    #1 0x7ffff6710fc5 in g_malloc0 (/lib64/libglib-2.0.so.0+0x4ffc5)\n\nSUMMARY: AddressSanitizer: heap-use-after-free /root/smartx/qemu-el7/qemu-test/hw/virtio/vhost.c:1473 in vhost_dev_free_inflight\nShadow bytes around the buggy address:\n  0x0c08801fc150: fa fa 00 00 00 00 04 fa fa fa fd fd fd fd fd fa\n  0x0c08801fc160: fa fa fd fd fd fd fd fd fa fa 00 00 00 00 04 fa\n  0x0c08801fc170: fa fa 00 00 00 00 00 01 fa fa 00 00 00 00 04 fa\n  0x0c08801fc180: fa fa 00 00 00 00 00 01 fa fa 00 00 00 00 00 01\n  0x0c08801fc190: fa fa 00 00 00 00 00 fa fa fa 00 00 00 00 04 fa\n=>0x0c08801fc1a0: fa fa fd[fd]fd fd fd fa fa fa fd fd fd fd fd fa\n  0x0c08801fc1b0: fa fa fd fd fd fd fd fa fa fa fd fd fd fd fd fa\n  0x0c08801fc1c0: fa fa 00 00 00 00 00 fa fa fa fd fd fd fd fd fd\n  0x0c08801fc1d0: fa fa 00 00 00 00 00 01 fa fa fd fd fd fd fd fa\n  0x0c08801fc1e0: fa fa fd fd fd fd fd fa fa fa fd fd fd fd fd fd\n  0x0c08801fc1f0: fa fa 00 00 00 00 00 01 fa fa fd fd fd fd fd fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==7309==ABORTING\n\nSigned-off-by: Li Feng <fengli@smartx.com>\nMessage-Id: <20200417101707.14467-1-fengli@smartx.com>\nReviewed-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Raphael Norwitz <raphael.norwitz@nutanix.com>",
        "before_after_code_files": [
          "hw/block/vhost-user-blk.c||hw/block/vhost-user-blk.c",
          "hw/virtio/vhost.c||hw/virtio/vhost.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hw/block/vhost-user-blk.c||hw/block/vhost-user-blk.c": [
          "File: hw/block/vhost-user-blk.c -> hw/block/vhost-user-blk.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "442: virtio_err:",
          "443:     g_free(s->vhost_vqs);",
          "444:     g_free(s->inflight);",
          "445:     for (i = 0; i < s->num_queues; i++) {",
          "446:         virtio_delete_queue(s->virtqs[i]);",
          "447:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "444:     s->vhost_vqs = NULL;",
          "446:     s->inflight = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "462:     vhost_dev_cleanup(&s->dev);",
          "463:     vhost_dev_free_inflight(s->inflight);",
          "464:     g_free(s->vhost_vqs);",
          "465:     g_free(s->inflight);",
          "467:     for (i = 0; i < s->num_queues; i++) {",
          "468:         virtio_delete_queue(s->virtqs[i]);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "467:     s->vhost_vqs = NULL;",
          "469:     s->inflight = NULL;",
          "",
          "---------------"
        ],
        "hw/virtio/vhost.c||hw/virtio/vhost.c": [
          "File: hw/virtio/vhost.c -> hw/virtio/vhost.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1515: void vhost_dev_free_inflight(struct vhost_inflight *inflight)",
          "1516: {",
          "1518:         qemu_memfd_free(inflight->addr, inflight->size, inflight->fd);",
          "1519:         inflight->addr = NULL;",
          "1520:         inflight->fd = -1;",
          "",
          "[Removed Lines]",
          "1517:     if (inflight->addr) {",
          "",
          "[Added Lines]",
          "1517:     if (inflight && inflight->addr) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0d930b870a87fe12648e5674288a2bcb6ae4a144",
      "candidate_info": {
        "commit_hash": "0d930b870a87fe12648e5674288a2bcb6ae4a144",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/0d930b870a87fe12648e5674288a2bcb6ae4a144",
        "files": [
          "hw/char/virtio-serial-bus.c"
        ],
        "message": "virtio-serial-bus: Plug memory leak on realize() error paths\n\nWe neglect to free port->bh on the error paths.  Fix that.\nReproducer:\n    {'execute': 'device_add', 'arguments': {'id': 'virtio_serial_pci0', 'driver': 'virtio-serial-pci', 'bus': 'pci.0', 'addr': '0x5'}, 'id': 'yVkZcGgV'}\n    {'execute': 'device_add', 'arguments': {'id': 'port1', 'driver': 'virtserialport', 'name': 'port1', 'chardev': 'channel1', 'bus': 'virtio_serial_pci0.0', 'nr': 1}, 'id': '3dXdUgJA'}\n    {'execute': 'device_add', 'arguments': {'id': 'port2', 'driver': 'virtserialport', 'name': 'port2', 'chardev': 'channel2', 'bus': 'virtio_serial_pci0.0', 'nr': 1}, 'id': 'qLzcCkob'}\n    {'execute': 'device_add', 'arguments': {'id': 'port2', 'driver': 'virtserialport', 'name': 'port2', 'chardev': 'channel2', 'bus': 'virtio_serial_pci0.0', 'nr': 2}, 'id': 'qLzcCkob'}\n\nThe leak stack:\nDirect leak of 40 byte(s) in 1 object(s) allocated from:\n    #0 0x7f04a8008ae8 in __interceptor_malloc (/lib64/libasan.so.5+0xefae8)\n    #1 0x7f04a73cf1d5 in g_malloc (/lib64/libglib-2.0.so.0+0x531d5)\n    #2 0x56273eaee484 in aio_bh_new /mnt/sdb/backup/qemu/util/async.c:125\n    #3 0x56273eafe9a8 in qemu_bh_new /mnt/sdb/backup/qemu/util/main-loop.c:532\n    #4 0x56273d52e62e in virtser_port_device_realize /mnt/sdb/backup/qemu/hw/char/virtio-serial-bus.c:946\n    #5 0x56273dcc5040 in device_set_realized /mnt/sdb/backup/qemu/hw/core/qdev.c:891\n    #6 0x56273e5ebbce in property_set_bool /mnt/sdb/backup/qemu/qom/object.c:2238\n    #7 0x56273e5e5a9c in object_property_set /mnt/sdb/backup/qemu/qom/object.c:1324\n    #8 0x56273e5ef5f8 in object_property_set_qobject /mnt/sdb/backup/qemu/qom/qom-qobject.c:26\n    #9 0x56273e5e5e6a in object_property_set_bool /mnt/sdb/backup/qemu/qom/object.c:1390\n    #10 0x56273daa40de in qdev_device_add /mnt/sdb/backup/qemu/qdev-monitor.c:680\n    #11 0x56273daa53e9 in qmp_device_add /mnt/sdb/backup/qemu/qdev-monitor.c:805\n\nFixes: 199646d81522509ac2dba6d28c31e8c7d807bc93\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nReviewed-by: Markus Armbruster <armbru@redhat.com>\nReviewed-by: Amit Shah <amit@kernel.org>\nMessage-Id: <20200309021738.30072-1-pannengyuan@huawei.com>\nReviewed-by: Laurent Vivier <lvivier@redhat.com>\nReviewed-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "hw/char/virtio-serial-bus.c||hw/char/virtio-serial-bus.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hw/char/virtio-serial-bus.c||hw/char/virtio-serial-bus.c": [
          "File: hw/char/virtio-serial-bus.c -> hw/char/virtio-serial-bus.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "943:     Error *err = NULL;",
          "945:     port->vser = bus->vser;",
          "948:     assert(vsc->have_data);",
          "",
          "[Removed Lines]",
          "946:     port->bh = qemu_bh_new(flush_queued_data_bh, port);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "992:         return;",
          "993:     }",
          "995:     port->elem = NULL;",
          "996: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "994:     port->bh = qemu_bh_new(flush_queued_data_bh, port);",
          "",
          "---------------"
        ]
      }
    }
  ]
}