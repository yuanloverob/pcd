{
  "cve_id": "CVE-2022-35935",
  "cve_desc": "TensorFlow is an open source platform for machine learning. The implementation of SobolSampleOp is vulnerable to a denial of service via CHECK-failure (assertion failure) caused by assuming `input(0)`, `input(1)`, and `input(2)` to be scalar. This issue has been patched in GitHub commit c65c67f88ad770662e8f191269a907bf2b94b1bf. The fix will be included in TensorFlow 2.10.0. We will also cherrypick this commit on TensorFlow 2.9.1, TensorFlow 2.8.1, and TensorFlow 2.7.2, as these are also affected and still in supported range. There are no known workarounds for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "c65c67f88ad770662e8f191269a907bf2b94b1bf",
  "patch_info": {
    "commit_hash": "c65c67f88ad770662e8f191269a907bf2b94b1bf",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/c65c67f88ad770662e8f191269a907bf2b94b1bf",
    "files": [
      "tensorflow/core/kernels/sobol_op.cc"
    ],
    "message": "Fix `CHECK`-fail due to passing invalid tensors in `SobolOp`.\n\nPiperOrigin-RevId: 460794378",
    "before_after_code_files": [
      "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
      "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: #include \"sobol_data.h\"  // from @sobol_data",
      "25: #include \"tensorflow/core/framework/device_base.h\"",
      "26: #include \"tensorflow/core/framework/op_kernel.h\"",
      "27: #include \"tensorflow/core/lib/core/threadpool.h\"",
      "28: #include \"tensorflow/core/platform/platform_strings.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27: #include \"tensorflow/core/framework/tensor_shape.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "134:       : OpKernel(context) {}",
      "136:   void Compute(OpKernelContext* context) override {",
      "137:     int32_t dim = context->input(0).scalar<int32_t>()();",
      "138:     int32_t num_results = context->input(1).scalar<int32_t>()();",
      "139:     int32_t skip = context->input(2).scalar<int32_t>()();",
      "141:     OP_REQUIRES(context, dim >= 1,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
      "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
      "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
      "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
      "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
      "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "95fa85b46f308521ed1f50aa700bd2be01a77399",
      "candidate_info": {
        "commit_hash": "95fa85b46f308521ed1f50aa700bd2be01a77399",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/95fa85b46f308521ed1f50aa700bd2be01a77399",
        "files": [
          "tensorflow/core/kernels/sobol_op.cc",
          "tensorflow/python/ops/sobol_ops_test.py"
        ],
        "message": "Fix tf.math.sobol_sample vulnerability with non-scalar inputs.\n\nCheck that given inputs are valid.\nAdd graph/eager unit tests. Graph mode was already ok but eager mode was not.\n\nPiperOrigin-RevId: 476117492",
        "before_after_code_files": [
          "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc",
          "tensorflow/python/ops/sobol_ops_test.py||tensorflow/python/ops/sobol_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
          "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
          "140:     int32_t dim = context->input(0).scalar<int32_t>()();",
          "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
          "143:     int32_t num_results = context->input(1).scalar<int32_t>()();",
          "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
          "146:     int32_t skip = context->input(2).scalar<int32_t>()();",
          "",
          "[Removed Lines]",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "",
          "[Added Lines]",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(1).shape()),",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(2).shape()),",
          "",
          "---------------"
        ],
        "tensorflow/python/ops/sobol_ops_test.py||tensorflow/python/ops/sobol_ops_test.py": [
          "File: tensorflow/python/ops/sobol_ops_test.py -> tensorflow/python/ops/sobol_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: import numpy as np",
          "18: from tensorflow.python.eager import def_function",
          "19: from tensorflow.python.framework import dtypes",
          "20: from tensorflow.python.framework import tensor_spec",
          "21: from tensorflow.python.framework import test_util",
          "22: from tensorflow.python.ops import math_ops",
          "23: from tensorflow.python.platform import googletest",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from tensorflow.python.framework import constant_op",
          "21: from tensorflow.python.framework import errors",
          "24: from tensorflow.python.ops import gen_math_ops",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "126:     s = math_ops.sobol_sample(10, 100)",
          "127:     self.assertEqual(dtypes.float32, s.dtype)",
          "129: if __name__ == '__main__':",
          "130:   googletest.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "132:   @test_util.run_in_graph_and_eager_modes",
          "133:   def test_non_scalar_input(self):",
          "134:     with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
          "135:                                 r'Shape must be rank 0 but is rank 1|'",
          "136:                                 r'\\w+ must be a scalar'):",
          "137:       self.evaluate(gen_math_ops.sobol_sample(",
          "138:           dim=7,",
          "139:           num_results=constant_op.constant([1, 0]),",
          "140:           skip=constant_op.constant([1])))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "02400ea266bd811fc016a848445de1bbff3a23a0",
      "candidate_info": {
        "commit_hash": "02400ea266bd811fc016a848445de1bbff3a23a0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/02400ea266bd811fc016a848445de1bbff3a23a0",
        "files": [
          "tensorflow/core/kernels/sobol_op.cc",
          "tensorflow/python/ops/sobol_ops_test.py"
        ],
        "message": "Fix tf.math.sobol_sample vulnerability with non-scalar inputs.\n\nCheck that given inputs are valid.\nAdd graph/eager unit tests. Graph mode was already ok but eager mode was not.\n\nPiperOrigin-RevId: 476117492",
        "before_after_code_files": [
          "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc",
          "tensorflow/python/ops/sobol_ops_test.py||tensorflow/python/ops/sobol_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
          "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
          "140:     int32_t dim = context->input(0).scalar<int32_t>()();",
          "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
          "143:     int32_t num_results = context->input(1).scalar<int32_t>()();",
          "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
          "146:     int32_t skip = context->input(2).scalar<int32_t>()();",
          "",
          "[Removed Lines]",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "",
          "[Added Lines]",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(1).shape()),",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(2).shape()),",
          "",
          "---------------"
        ],
        "tensorflow/python/ops/sobol_ops_test.py||tensorflow/python/ops/sobol_ops_test.py": [
          "File: tensorflow/python/ops/sobol_ops_test.py -> tensorflow/python/ops/sobol_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "16: import numpy as np",
          "18: from tensorflow.python.eager import def_function",
          "19: from tensorflow.python.framework import dtypes",
          "20: from tensorflow.python.framework import tensor_spec",
          "21: from tensorflow.python.framework import test_util",
          "22: from tensorflow.python.ops import math_ops",
          "23: from tensorflow.python.platform import googletest",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "19: from tensorflow.python.framework import constant_op",
          "21: from tensorflow.python.framework import errors",
          "24: from tensorflow.python.ops import gen_math_ops",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "126:     s = math_ops.sobol_sample(10, 100)",
          "127:     self.assertEqual(dtypes.float32, s.dtype)",
          "129: if __name__ == '__main__':",
          "130:   googletest.main()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "132:   @test_util.run_in_graph_and_eager_modes",
          "133:   def test_non_scalar_input(self):",
          "134:     with self.assertRaisesRegex((ValueError, errors.InvalidArgumentError),",
          "135:                                 r'Shape must be rank 0 but is rank 1|'",
          "136:                                 r'\\w+ must be a scalar'):",
          "137:       self.evaluate(gen_math_ops.sobol_sample(",
          "138:           dim=7,",
          "139:           num_results=constant_op.constant([1, 0]),",
          "140:           skip=constant_op.constant([1])))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "516930f8a609f43f61f313e8943319ea3e379036",
      "candidate_info": {
        "commit_hash": "516930f8a609f43f61f313e8943319ea3e379036",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/516930f8a609f43f61f313e8943319ea3e379036",
        "files": [
          "tensorflow/core/kernels/sobol_op.cc"
        ],
        "message": "Fix `CHECK`-fail due to passing invalid tensors in `SobolOp`.\n\nPiperOrigin-RevId: 460794378",
        "before_after_code_files": [
          "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
          "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"sobol_data.h\"  // from @sobol_data",
          "25: #include \"tensorflow/core/framework/device_base.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/lib/core/threadpool.h\"",
          "28: #include \"tensorflow/core/platform/platform_strings.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "134:       : OpKernel(context) {}",
          "136:   void Compute(OpKernelContext* context) override {",
          "137:     int32_t dim = context->input(0).scalar<int32_t>()();",
          "138:     int32_t num_results = context->input(1).scalar<int32_t>()();",
          "139:     int32_t skip = context->input(2).scalar<int32_t>()();",
          "141:     OP_REQUIRES(context, dim >= 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dc6df952a1de69fd93ea63285cd40e02493619e4",
      "candidate_info": {
        "commit_hash": "dc6df952a1de69fd93ea63285cd40e02493619e4",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/dc6df952a1de69fd93ea63285cd40e02493619e4",
        "files": [
          "tensorflow/core/kernels/sobol_op.cc"
        ],
        "message": "Fix `CHECK`-fail due to passing invalid tensors in `SobolOp`.\n\nPiperOrigin-RevId: 460794378",
        "before_after_code_files": [
          "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
          "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"sobol_data.h\"  // from @sobol_data",
          "25: #include \"tensorflow/core/framework/device_base.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/lib/core/threadpool.h\"",
          "28: #include \"tensorflow/core/platform/platform_strings.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "134:       : OpKernel(context) {}",
          "136:   void Compute(OpKernelContext* context) override {",
          "137:     int32_t dim = context->input(0).scalar<int32_t>()();",
          "138:     int32_t num_results = context->input(1).scalar<int32_t>()();",
          "139:     int32_t skip = context->input(2).scalar<int32_t>()();",
          "141:     OP_REQUIRES(context, dim >= 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b47c1b88d9b104f6f59fe87576692c2bb8bca3d4",
      "candidate_info": {
        "commit_hash": "b47c1b88d9b104f6f59fe87576692c2bb8bca3d4",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b47c1b88d9b104f6f59fe87576692c2bb8bca3d4",
        "files": [
          "tensorflow/core/kernels/sobol_op.cc"
        ],
        "message": "Fix `CHECK`-fail due to passing invalid tensors in `SobolOp`.\n\nPiperOrigin-RevId: 460794378",
        "before_after_code_files": [
          "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sobol_op.cc||tensorflow/core/kernels/sobol_op.cc": [
          "File: tensorflow/core/kernels/sobol_op.cc -> tensorflow/core/kernels/sobol_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"sobol_data.h\"  // from @sobol_data",
          "25: #include \"tensorflow/core/framework/device_base.h\"",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/lib/core/threadpool.h\"",
          "28: #include \"tensorflow/core/platform/platform_strings.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/tensor_shape.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "134:       : OpKernel(context) {}",
          "136:   void Compute(OpKernelContext* context) override {",
          "137:     int32_t dim = context->input(0).scalar<int32_t>()();",
          "138:     int32_t num_results = context->input(1).scalar<int32_t>()();",
          "139:     int32_t skip = context->input(2).scalar<int32_t>()();",
          "141:     OP_REQUIRES(context, dim >= 1,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "138:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "139:                 errors::InvalidArgument(\"dim must be a scalar\"));",
          "141:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "142:                 errors::InvalidArgument(\"num_results must be a scalar\"));",
          "144:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(context->input(0).shape()),",
          "145:                 errors::InvalidArgument(\"skip must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}