{
  "cve_id": "CVE-2010-4704",
  "cve_desc": "libavcodec/vorbis_dec.c in the Vorbis decoder in FFmpeg 0.6.1 and earlier allows remote attackers to cause a denial of service (application crash) via a crafted .ogg file, related to the vorbis_floor0_decode function.  NOTE: this might overlap CVE-2011-0480.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "3dde66752d59dfdd0f3727efd66e7202b3c75078",
  "patch_info": {
    "commit_hash": "3dde66752d59dfdd0f3727efd66e7202b3c75078",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/3dde66752d59dfdd0f3727efd66e7202b3c75078",
    "files": [
      "libavcodec/vorbis_dec.c"
    ],
    "message": "Fix crashes in vorbis decoding found by zzuf Fixes issue 2322.\n\nOriginally committed as revision 25591 to svn://svn.ffmpeg.org/ffmpeg/trunk",
    "before_after_code_files": [
      "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c": [
      "File: libavcodec/vorbis_dec.c -> libavcodec/vorbis_dec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "61: typedef struct vorbis_floor1_s vorbis_floor1;",
      "62: struct vorbis_context_s;",
      "63: typedef",
      "66: typedef struct {",
      "67:     uint_fast8_t floor_type;",
      "68:     vorbis_floor_decode_func decode;",
      "",
      "[Removed Lines]",
      "64: uint_fast8_t (* vorbis_floor_decode_func)",
      "65:              (struct vorbis_context_s *, vorbis_floor_data *, float *);",
      "",
      "[Added Lines]",
      "64: int (* vorbis_floor_decode_func)",
      "65:     (struct vorbis_context_s *, vorbis_floor_data *, float *);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "464: static void create_map(vorbis_context *vc, uint_fast8_t floor_number);",
      "467: static int vorbis_parse_setup_hdr_floors(vorbis_context *vc)",
      "468: {",
      "469:     GetBitContext *gb = &vc->gb;",
      "",
      "[Removed Lines]",
      "462: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
      "463:                                          vorbis_floor_data *vfu, float *vec);",
      "465: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc,",
      "466:                                          vorbis_floor_data *vfu, float *vec);",
      "",
      "[Added Lines]",
      "462: static int vorbis_floor0_decode(vorbis_context *vc,",
      "463:                                 vorbis_floor_data *vfu, float *vec);",
      "465: static int vorbis_floor1_decode(vorbis_context *vc,",
      "466:                                 vorbis_floor_data *vfu, float *vec);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1020: {",
      "1021:     vorbis_floor0 *vf = &vfu->t0;",
      "1022:     float *lsp = vf->lsp;",
      "",
      "[Removed Lines]",
      "1018: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
      "1019:                                          vorbis_floor_data *vfu, float *vec)",
      "",
      "[Added Lines]",
      "1018: static int vorbis_floor0_decode(vorbis_context *vc,",
      "1019:                                 vorbis_floor_data *vfu, float *vec)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1040:         }",
      "1041:         AV_DEBUG(\"floor0 dec: booknumber: %u\\n\", book_idx);",
      "1042:         codebook = vc->codebooks[vf->book_list[book_idx]];",
      "1044:         while (lsp_len<vf->order) {",
      "1045:             int vec_off;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1044:         if (!codebook.codevectors)",
      "1045:             return -1;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1125:     return 0;",
      "1126: }",
      "1130: {",
      "1131:     vorbis_floor1 *vf = &vfu->t1;",
      "1132:     GetBitContext *gb = &vc->gb;",
      "",
      "[Removed Lines]",
      "1128: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc,",
      "1129:                                          vorbis_floor_data *vfu, float *vec)",
      "",
      "[Added Lines]",
      "1131: static int vorbis_floor1_decode(vorbis_context *vc,",
      "1132:                                 vorbis_floor_data *vfu, float *vec)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1503:     for (i = 0; i < vc->audio_channels; ++i) {",
      "1504:         vorbis_floor *floor;",
      "1505:         if (mapping->submaps > 1) {",
      "1506:             floor = &vc->floors[mapping->submap_floor[mapping->mux[i]]];",
      "1507:         } else {",
      "1508:             floor = &vc->floors[mapping->submap_floor[0]];",
      "1509:         }",
      "1512:         ch_floor_ptr += blocksize / 2;",
      "1513:     }",
      "",
      "[Removed Lines]",
      "1511:         no_residue[i] = floor->decode(vc, &floor->data, ch_floor_ptr);",
      "",
      "[Added Lines]",
      "1508:         int ret;",
      "1515:         ret = floor->decode(vc, &floor->data, ch_floor_ptr);",
      "1517:         if (ret < 0) {",
      "1518:             av_log(vc->avccontext, AV_LOG_ERROR, \"Invalid codebook in vorbis_floor_decode.\\n\");",
      "1519:             return -1;",
      "1520:         }",
      "1521:         no_residue[i] = ret;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d6860fb653ed42a9d35e134f843f03cc049b74f1",
      "candidate_info": {
        "commit_hash": "d6860fb653ed42a9d35e134f843f03cc049b74f1",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/d6860fb653ed42a9d35e134f843f03cc049b74f1",
        "files": [
          "libavcodec/vorbis_dec.c"
        ],
        "message": "Fix crashes in vorbis decoding found by zzuf Fixes issue 2322.\n\nOriginally committed as revision 25591 to svn://svn.ffmpeg.org/ffmpeg/trunk\n(cherry picked from commit 3dde66752d59dfdd0f3727efd66e7202b3c75078)\n\nAddresses: CVE-2010-4704",
        "before_after_code_files": [
          "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
          ],
          "candidate": [
            "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c": [
          "File: libavcodec/vorbis_dec.c -> libavcodec/vorbis_dec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "60: typedef struct vorbis_floor1_s vorbis_floor1;",
          "61: struct vorbis_context_s;",
          "62: typedef",
          "65: typedef struct {",
          "66:     uint_fast8_t floor_type;",
          "67:     vorbis_floor_decode_func decode;",
          "",
          "[Removed Lines]",
          "63: uint_fast8_t (* vorbis_floor_decode_func)",
          "64:              (struct vorbis_context_s *, vorbis_floor_data *, float *);",
          "",
          "[Added Lines]",
          "63: int (* vorbis_floor_decode_func)",
          "64:     (struct vorbis_context_s *, vorbis_floor_data *, float *);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "447:                                          vorbis_floor_data *vfu, float *vec);",
          "448: static void create_map( vorbis_context * vc, uint_fast8_t floor_number );",
          "450:                                          vorbis_floor_data *vfu, float *vec);",
          "451: static int vorbis_parse_setup_hdr_floors(vorbis_context *vc) {",
          "452:     GetBitContext *gb=&vc->gb;",
          "455:     vc->floor_count=get_bits(gb, 6)+1;",
          "",
          "[Removed Lines]",
          "446: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
          "449: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc,",
          "453:     uint_fast16_t i,j,k;",
          "",
          "[Added Lines]",
          "446: static int vorbis_floor0_decode(vorbis_context *vc,",
          "449: static int vorbis_floor1_decode(vorbis_context *vc,",
          "453:     int i,j,k;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1042:                                          vorbis_floor_data *vfu, float *vec) {",
          "1043:     vorbis_floor0 * vf=&vfu->t0;",
          "1044:     float * lsp=vf->lsp;",
          "",
          "[Removed Lines]",
          "1041: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
          "",
          "[Added Lines]",
          "1041: static int vorbis_floor0_decode(vorbis_context *vc,",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1062:         }",
          "1063:         AV_DEBUG( \"floor0 dec: booknumber: %u\\n\", book_idx );",
          "1064:         codebook=vc->codebooks[vf->book_list[book_idx]];",
          "1066:         while (lsp_len<vf->order) {",
          "1067:             int vec_off;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1066:         if (!codebook.codevectors)",
          "1067:             return -1;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1151:     return 0;",
          "1152: }",
          "1155:     vorbis_floor1 * vf=&vfu->t1;",
          "1156:     GetBitContext *gb=&vc->gb;",
          "1157:     uint_fast16_t range_v[4]={ 256, 128, 86, 64 };",
          "",
          "[Removed Lines]",
          "1154: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc, vorbis_floor_data *vfu, float *vec) {",
          "",
          "[Added Lines]",
          "1157: static int vorbis_floor1_decode(vorbis_context *vc, vorbis_floor_data *vfu, float *vec) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1528:     for(i=0;i<vc->audio_channels;++i) {",
          "1529:         vorbis_floor *floor;",
          "1530:         if (mapping->submaps>1) {",
          "1531:             floor=&vc->floors[mapping->submap_floor[mapping->mux[i]]];",
          "1532:         } else {",
          "1533:             floor=&vc->floors[mapping->submap_floor[0]];",
          "1534:         }",
          "1538:     }",
          "",
          "[Removed Lines]",
          "1536:         no_residue[i]=floor->decode(vc, &floor->data, ch_floor_ptr);",
          "1537:         ch_floor_ptr+=blocksize/2;",
          "",
          "[Added Lines]",
          "1533:         int ret;",
          "1540:         ret = floor->decode(vc, &floor->data, ch_floor_ptr);",
          "1542:         if (ret < 0) {",
          "1543:             av_log(vc->avccontext, AV_LOG_ERROR, \"Invalid codebook in vorbis_floor_decode.\\n\");",
          "1544:             return -1;",
          "1545:         }",
          "1546:         no_residue[i] = ret;",
          "1547:         ch_floor_ptr += blocksize / 2;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4ac56bf7dc2c617c9fe6dce9167d499dbb8a9b76",
      "candidate_info": {
        "commit_hash": "4ac56bf7dc2c617c9fe6dce9167d499dbb8a9b76",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/4ac56bf7dc2c617c9fe6dce9167d499dbb8a9b76",
        "files": [
          "libavcodec/vorbis_dec.c"
        ],
        "message": "Fix crashes in vorbis decoding found by zzuf\n\nFixes issue 2322.\n\nOriginally committed as revision 25591 to svn://svn.ffmpeg.org/ffmpeg/trunk\n(cherry picked from commit 3dde66752d59dfdd0f3727efd66e7202b3c75078)\n\nSigned-off-by: Janne Grunau <janne-ffmpeg@jannau.net>",
        "before_after_code_files": [
          "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
          ],
          "candidate": [
            "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/vorbis_dec.c||libavcodec/vorbis_dec.c": [
          "File: libavcodec/vorbis_dec.c -> libavcodec/vorbis_dec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: typedef struct vorbis_floor1_s vorbis_floor1;",
          "62: struct vorbis_context_s;",
          "63: typedef",
          "66: typedef struct {",
          "67:     uint_fast8_t floor_type;",
          "68:     vorbis_floor_decode_func decode;",
          "",
          "[Removed Lines]",
          "64: uint_fast8_t (* vorbis_floor_decode_func)",
          "65:              (struct vorbis_context_s *, vorbis_floor_data *, float *);",
          "",
          "[Added Lines]",
          "64: int (* vorbis_floor_decode_func)",
          "65:     (struct vorbis_context_s *, vorbis_floor_data *, float *);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "458: static void create_map(vorbis_context *vc, uint_fast8_t floor_number);",
          "461: static int vorbis_parse_setup_hdr_floors(vorbis_context *vc)",
          "462: {",
          "463:     GetBitContext *gb = &vc->gb;",
          "",
          "[Removed Lines]",
          "456: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
          "457:                                          vorbis_floor_data *vfu, float *vec);",
          "459: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc,",
          "460:                                          vorbis_floor_data *vfu, float *vec);",
          "",
          "[Added Lines]",
          "456: static int vorbis_floor0_decode(vorbis_context *vc,",
          "457:                                 vorbis_floor_data *vfu, float *vec);",
          "459: static int vorbis_floor1_decode(vorbis_context *vc,",
          "460:                                 vorbis_floor_data *vfu, float *vec);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1007: {",
          "1008:     vorbis_floor0 *vf = &vfu->t0;",
          "1009:     float *lsp = vf->lsp;",
          "",
          "[Removed Lines]",
          "1005: static uint_fast8_t vorbis_floor0_decode(vorbis_context *vc,",
          "1006:                                          vorbis_floor_data *vfu, float *vec)",
          "",
          "[Added Lines]",
          "1005: static int vorbis_floor0_decode(vorbis_context *vc,",
          "1006:                                 vorbis_floor_data *vfu, float *vec)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1027:         }",
          "1028:         AV_DEBUG(\"floor0 dec: booknumber: %u\\n\", book_idx);",
          "1029:         codebook = vc->codebooks[vf->book_list[book_idx]];",
          "1031:         while (lsp_len<vf->order) {",
          "1032:             int vec_off;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1031:         if (!codebook.codevectors)",
          "1032:             return -1;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1112:     return 0;",
          "1113: }",
          "1117: {",
          "1118:     vorbis_floor1 *vf = &vfu->t1;",
          "1119:     GetBitContext *gb = &vc->gb;",
          "",
          "[Removed Lines]",
          "1115: static uint_fast8_t vorbis_floor1_decode(vorbis_context *vc,",
          "1116:                                          vorbis_floor_data *vfu, float *vec)",
          "",
          "[Added Lines]",
          "1118: static int vorbis_floor1_decode(vorbis_context *vc,",
          "1119:                                 vorbis_floor_data *vfu, float *vec)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1491:     for (i = 0; i < vc->audio_channels; ++i) {",
          "1492:         vorbis_floor *floor;",
          "1493:         if (mapping->submaps > 1) {",
          "1494:             floor = &vc->floors[mapping->submap_floor[mapping->mux[i]]];",
          "1495:         } else {",
          "1496:             floor = &vc->floors[mapping->submap_floor[0]];",
          "1497:         }",
          "1500:         ch_floor_ptr += blocksize / 2;",
          "1501:     }",
          "",
          "[Removed Lines]",
          "1499:         no_residue[i] = floor->decode(vc, &floor->data, ch_floor_ptr);",
          "",
          "[Added Lines]",
          "1496:         int ret;",
          "1503:         ret = floor->decode(vc, &floor->data, ch_floor_ptr);",
          "1505:         if (ret < 0) {",
          "1506:             av_log(vc->avccontext, AV_LOG_ERROR, \"Invalid codebook in vorbis_floor_decode.\\n\");",
          "1507:             return -1;",
          "1508:         }",
          "1509:         no_residue[i] = ret;",
          "",
          "---------------"
        ]
      }
    }
  ]
}