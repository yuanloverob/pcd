{
  "cve_id": "CVE-2017-3731",
  "cve_desc": "If an SSL/TLS server or client is running on a 32-bit host, and a specific cipher is being used, then a truncated packet can cause that server or client to perform an out-of-bounds read, usually resulting in a crash. For OpenSSL 1.1.0, the crash can be triggered when using CHACHA20/POLY1305; users should upgrade to 1.1.0d. For Openssl 1.0.2, the crash can be triggered when using RC4-MD5; users who have not disabled that algorithm should update to 1.0.2k.",
  "repo": "openssl/openssl",
  "patch_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
  "patch_info": {
    "commit_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/00d965474b22b54e4275232bc71ee0c699c5cd21",
    "files": [
      "crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c"
    ],
    "message": "crypto/evp: harden AEAD ciphers.\n\nOriginally a crash in 32-bit build was reported CHACHA20-POLY1305\ncipher. The crash is triggered by truncated packet and is result\nof excessive hashing to the edge of accessible memory. Since hash\noperation is read-only it is not considered to be exploitable\nbeyond a DoS condition. Other ciphers were hardened.\n\nThanks to Robert \u015awi\u0119cki for report.\n\nCVE-2017-3731\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "crypto/evp/e_aes.c||crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c"
    ]
  },
  "patch_diff": {
    "crypto/evp/e_aes.c||crypto/evp/e_aes.c": [
      "File: crypto/evp/e_aes.c -> crypto/evp/e_aes.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1388:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1389:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1391:             len -= EVP_GCM_TLS_EXPLICIT_IV_LEN;",
      "1394:                 len -= EVP_GCM_TLS_TAG_LEN;",
      "1395:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1396:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1397:         }",
      "",
      "[Removed Lines]",
      "1393:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1391:             if (len < EVP_GCM_TLS_EXPLICIT_IV_LEN)",
      "1392:                 return 0;",
      "1395:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1396:                 if (len < EVP_GCM_TLS_TAG_LEN)",
      "1397:                     return 0;",
      "1399:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1946:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1947:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1949:             len -= EVP_CCM_TLS_EXPLICIT_IV_LEN;",
      "1952:                 len -= cctx->M;",
      "1953:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1954:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1955:         }",
      "",
      "[Removed Lines]",
      "1951:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1954:             if (len < EVP_CCM_TLS_EXPLICIT_IV_LEN)",
      "1955:                 return 0;",
      "1958:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1959:                 if (len < cctx->M)",
      "1960:                     return 0;",
      "1962:             }",
      "",
      "---------------"
    ],
    "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c": [
      "File: crypto/evp/e_chacha20_poly1305.c -> crypto/evp/e_chacha20_poly1305.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "398:             len = aad[EVP_AEAD_TLS1_AAD_LEN - 2] << 8 |",
      "399:                   aad[EVP_AEAD_TLS1_AAD_LEN - 1];",
      "400:             if (!ctx->encrypt) {",
      "402:                 memcpy(temp, aad, EVP_AEAD_TLS1_AAD_LEN - 2);",
      "403:                 aad = temp;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "401:                 if (len < POLY1305_BLOCK_SIZE)",
      "402:                     return 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c565e99a14bf43f11d006d36612fe7943f9e817f",
      "candidate_info": {
        "commit_hash": "c565e99a14bf43f11d006d36612fe7943f9e817f",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/c565e99a14bf43f11d006d36612fe7943f9e817f",
        "files": [
          "crypto/x509/t_crl.c",
          "crypto/x509/t_req.c"
        ],
        "message": "Fix undefined behaviour when printing the X509 and CRL version\n\nFound by oss-fuzz\n\nReviewed-by: Andy Polyakov <appro@openssl.org>\nGH: #2231\n(cherry picked from commit c2ce477f1f3c0a98802fb087b0cf4b0a99ea2b1d)",
        "before_after_code_files": [
          "crypto/x509/t_crl.c||crypto/x509/t_crl.c",
          "crypto/x509/t_req.c||crypto/x509/t_req.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/x509/t_crl.c||crypto/x509/t_crl.c": [
          "File: crypto/x509/t_crl.c -> crypto/x509/t_crl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "45:     BIO_printf(out, \"Certificate Revocation List (CRL):\\n\");",
          "46:     l = X509_CRL_get_version(x);",
          "48:     X509_CRL_get0_signature(x, &sig, &sig_alg);",
          "49:     X509_signature_print(out, sig_alg, NULL);",
          "50:     p = X509_NAME_oneline(X509_CRL_get_issuer(x), NULL, 0);",
          "",
          "[Removed Lines]",
          "47:     BIO_printf(out, \"%8sVersion %lu (0x%lx)\\n\", \"\", l + 1, l);",
          "",
          "[Added Lines]",
          "47:     if (l >= 0 && l <= 1)",
          "48:         BIO_printf(out, \"%8sVersion %ld (0x%lx)\\n\", \"\", l + 1, (unsigned long)l);",
          "49:     else",
          "50:         BIO_printf(out, \"%8sVersion unknown (%ld)\\n\", \"\", l);",
          "",
          "---------------"
        ],
        "crypto/x509/t_req.c||crypto/x509/t_req.c": [
          "File: crypto/x509/t_req.c -> crypto/x509/t_req.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     }",
          "61:     if (!(cflag & X509_FLAG_NO_VERSION)) {",
          "62:         l = X509_REQ_get_version(x);",
          "65:     }",
          "66:     if (!(cflag & X509_FLAG_NO_SUBJECT)) {",
          "67:         if (BIO_printf(bp, \"        Subject:%c\", mlch) <= 0)",
          "",
          "[Removed Lines]",
          "63:         if (BIO_printf(bp, \"%8sVersion: %ld (0x%lx)\\n\", \"\", l + 1, l) <= 0)",
          "64:             goto err;",
          "",
          "[Added Lines]",
          "63:         if (l >= 0 && l <= 2) {",
          "64:             if (BIO_printf(bp, \"%8sVersion: %ld (0x%lx)\\n\", \"\", l + 1, (unsigned long)l) <= 0)",
          "65:                 goto err;",
          "66:         } else {",
          "67:             if (BIO_printf(bp, \"%8sVersion: Unknown (%ld)\\n\", \"\", l) <= 0)",
          "68:                 goto err;",
          "69:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "41371618f72b93bdf3e0a4be369e4df6b65334cd",
      "candidate_info": {
        "commit_hash": "41371618f72b93bdf3e0a4be369e4df6b65334cd",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/41371618f72b93bdf3e0a4be369e4df6b65334cd",
        "files": [
          "INSTALL",
          "NOTES.UNIX"
        ],
        "message": "Add NOTES.UNIX, with a description on how to deal with runpaths\n\n[skip ci]\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2818)\n(cherry picked from commit 45632ee3bb7ab4ed405d5251d76dd5b94d782adb)",
        "before_after_code_files": [
          "NOTES.UNIX||NOTES.UNIX"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "NOTES.UNIX||NOTES.UNIX": [
          "File: NOTES.UNIX -> NOTES.UNIX",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2:  NOTES FOR UNIX LIKE PLATFORMS",
          "3:  =============================",
          "5:  For Unix/POSIX runtime systems on Windows, please see NOTES.WIN.",
          "8:  Shared libraries and installation in non-standard locations",
          "9:  -----------------------------------------------------------",
          "11:  Binaries on Unix variants expect to find shared libraries in standard",
          "12:  locations, such as /usr/lib, /usr/local/lib and some other locations",
          "13:  configured in the system (for example /etc/ld.so.conf on some systems).",
          "14:  If the libraries are installed in non-standard locations, binaries",
          "15:  will not find them and therefore fail to run unless they get a bit of",
          "16:  help from a defined RPATH or RUNPATH.  This can be applied by adding",
          "17:  the appropriate linker flags to the configuration command, such as",
          "18:  this (/usr/local/ssl was the default location for OpenSSL installation",
          "19:  in versions before 1.1.0):",
          "21:     $ ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl \\",
          "22:         -Wl,-rpath,/usr/local/ssl/lib",
          "24:  Because the actual library location may vary further (for example on",
          "25:  multilib installations), there is a convenience variable in Makefile",
          "26:  that holds the exact installation directory and that can be used like",
          "27:  this:",
          "29:     $ ./config --prefix=/usr/local/ssl --openssldir=/usr/local/ssl \\",
          "30:         -Wl,-rpath,'$(LIBRPATH)'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b81aadde0c7d35038aec89c5350512d7d2914cdb",
      "candidate_info": {
        "commit_hash": "b81aadde0c7d35038aec89c5350512d7d2914cdb",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/b81aadde0c7d35038aec89c5350512d7d2914cdb",
        "files": [
          "crypto/rand/rand_egd.c"
        ],
        "message": "RAND_egd_bytes: No need to check RAND_status on connection error.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1886)\n(cherry picked from commit c2114afc1622ff0113974b3696e557ea8bf7ffb4)",
        "before_after_code_files": [
          "crypto/rand/rand_egd.c||crypto/rand/rand_egd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/rand/rand_egd.c||crypto/rand/rand_egd.c": [
          "File: crypto/rand/rand_egd.c -> crypto/rand/rand_egd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "231:     int num, ret = -1;",
          "233:     num = RAND_query_egd_bytes(path, NULL, bytes);",
          "234:     if (RAND_status() == 1)",
          "235:         ret = num;",
          "236:  err:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "234:     if (num < 0)",
          "235:         goto err;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d7155335a56c2bc0d399336c46fefb497cc1131c",
      "candidate_info": {
        "commit_hash": "d7155335a56c2bc0d399336c46fefb497cc1131c",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/d7155335a56c2bc0d399336c46fefb497cc1131c",
        "files": [
          "Configurations/unix-Makefile.tmpl"
        ],
        "message": "remove test/.rnd on make clean\n\nReviewed-by: Richard Levitte <levitte@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2344)\n(cherry picked from commit 122fa088524571a3b60ebf301873f69afdac8f7a)",
        "before_after_code_files": [
          "Configurations/unix-Makefile.tmpl||Configurations/unix-Makefile.tmpl"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Configurations/unix-Makefile.tmpl||Configurations/unix-Makefile.tmpl": [
          "File: Configurations/unix-Makefile.tmpl -> Configurations/unix-Makefile.tmpl",
          "--- Hunk 1 ---",
          "[Context before]",
          "285:  -$(RM) `find . -name '*{- $objext -}' -a \\! -path \"./.git/*\"`",
          "286:  $(RM) core",
          "287:  $(RM) tags TAGS",
          "288:  $(RM) openssl.pc libcrypto.pc libssl.pc",
          "289:  -$(RM) `find . -type l -a \\! -path \"./.git/*\"`",
          "290:  $(RM) $(TARFILE)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "288:  $(RM) test/.rnd",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b5cd178f9dd057a76147ccd307bd3cb0672ac098",
      "candidate_info": {
        "commit_hash": "b5cd178f9dd057a76147ccd307bd3cb0672ac098",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/b5cd178f9dd057a76147ccd307bd3cb0672ac098",
        "files": [
          "crypto/ec/eck_prn.c"
        ],
        "message": "Increase the size of the stack buffer to prevent an overflow.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Andy Polyakov <appro@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2721)\n(cherry picked from commit 8fce04ee3540ba3039bb66df34ea3f076a599ab9)",
        "before_after_code_files": [
          "crypto/ec/eck_prn.c||crypto/ec/eck_prn.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/ec/eck_prn.c||crypto/ec/eck_prn.c": [
          "File: crypto/ec/eck_prn.c -> crypto/ec/eck_prn.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "238:                      size_t len, int off)",
          "239: {",
          "240:     size_t i;",
          "243:     if (buf == NULL)",
          "244:         return 1;",
          "",
          "[Removed Lines]",
          "241:     char str[128];",
          "",
          "[Added Lines]",
          "241:     char str[128 + 1 + 4];",
          "",
          "---------------"
        ]
      }
    }
  ]
}