{
  "cve_id": "CVE-2020-15852",
  "cve_desc": "An issue was discovered in the Linux kernel 5.5 through 5.7.9, as used in Xen through 4.13.x for x86 PV guests. An attacker may be granted the I/O port permissions of an unrelated task. This occurs because tss_invalidate_io_bitmap mishandling causes a loss of synchronization between the I/O bitmaps of TSS and Xen, aka CID-cadfad870154.",
  "repo": "torvalds/linux",
  "patch_hash": "cadfad870154e14f745ec845708bc17d166065f2",
  "patch_info": {
    "commit_hash": "cadfad870154e14f745ec845708bc17d166065f2",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/cadfad870154e14f745ec845708bc17d166065f2",
    "files": [
      "arch/x86/include/asm/io_bitmap.h",
      "arch/x86/include/asm/paravirt.h",
      "arch/x86/include/asm/paravirt_types.h",
      "arch/x86/kernel/paravirt.c",
      "arch/x86/kernel/process.c",
      "arch/x86/xen/enlighten_pv.c"
    ],
    "message": "x86/ioperm: Fix io bitmap invalidation on Xen PV\n\ntss_invalidate_io_bitmap() wasn't wired up properly through the pvop\nmachinery, so the TSS and Xen's io bitmap would get out of sync\nwhenever disabling a valid io bitmap.\n\nAdd a new pvop for tss_invalidate_io_bitmap() to fix it.\n\nThis is XSA-329.\n\nFixes: 22fe5b0439dd (\"x86/ioperm: Move TSS bitmap update to exit to user work\")\nSigned-off-by: Andy Lutomirski <luto@kernel.org>\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\nReviewed-by: Juergen Gross <jgross@suse.com>\nReviewed-by: Thomas Gleixner <tglx@linutronix.de>\nCc: stable@vger.kernel.org\nLink: https://lkml.kernel.org/r/d53075590e1f91c19f8af705059d3ff99424c020.1595030016.git.luto@kernel.org",
    "before_after_code_files": [
      "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
      "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h",
      "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h",
      "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c",
      "arch/x86/kernel/process.c||arch/x86/kernel/process.c",
      "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
    ]
  },
  "patch_diff": {
    "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h": [
      "File: arch/x86/include/asm/io_bitmap.h -> arch/x86/include/asm/io_bitmap.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: void io_bitmap_share(struct task_struct *tsk);",
      "20: void io_bitmap_exit(struct task_struct *tsk);",
      "22: void native_tss_update_io_bitmap(void);",
      "24: #ifdef CONFIG_PARAVIRT_XXL",
      "25: #include <asm/paravirt.h>",
      "26: #else",
      "27: #define tss_update_io_bitmap native_tss_update_io_bitmap",
      "28: #endif",
      "30: #else",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: static inline void native_tss_invalidate_io_bitmap(void)",
      "23: {",
      "33:  this_cpu_write(cpu_tss_rw.x86_tss.io_bitmap_base,",
      "34:          IO_BITMAP_OFFSET_INVALID);",
      "35: }",
      "43: #define tss_invalidate_io_bitmap native_tss_invalidate_io_bitmap",
      "",
      "---------------"
    ],
    "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h": [
      "File: arch/x86/include/asm/paravirt.h -> arch/x86/include/asm/paravirt.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "302: }",
      "304: #ifdef CONFIG_X86_IOPL_IOPERM",
      "305: static inline void tss_update_io_bitmap(void)",
      "306: {",
      "307:  PVOP_VCALL0(cpu.update_io_bitmap);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "305: static inline void tss_invalidate_io_bitmap(void)",
      "306: {",
      "307:  PVOP_VCALL0(cpu.invalidate_io_bitmap);",
      "308: }",
      "",
      "---------------"
    ],
    "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h": [
      "File: arch/x86/include/asm/paravirt_types.h -> arch/x86/include/asm/paravirt_types.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "141:  void (*load_sp0)(unsigned long sp0);",
      "143: #ifdef CONFIG_X86_IOPL_IOPERM",
      "144:  void (*update_io_bitmap)(void);",
      "145: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "144:  void (*invalidate_io_bitmap)(void);",
      "",
      "---------------"
    ],
    "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c": [
      "File: arch/x86/kernel/paravirt.c -> arch/x86/kernel/paravirt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "324:  .cpu.swapgs  = native_swapgs,",
      "326: #ifdef CONFIG_X86_IOPL_IOPERM",
      "328: #endif",
      "330:  .cpu.start_context_switch = paravirt_nop,",
      "",
      "[Removed Lines]",
      "327:  .cpu.update_io_bitmap = native_tss_update_io_bitmap,",
      "",
      "[Added Lines]",
      "327:  .cpu.invalidate_io_bitmap = native_tss_invalidate_io_bitmap,",
      "328:  .cpu.update_io_bitmap  = native_tss_update_io_bitmap,",
      "",
      "---------------"
    ],
    "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
      "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "322: }",
      "324: #ifdef CONFIG_X86_IOPL_IOPERM",
      "339: static inline void switch_to_bitmap(unsigned long tifp)",
      "340: {",
      "",
      "[Removed Lines]",
      "325: static inline void tss_invalidate_io_bitmap(struct tss_struct *tss)",
      "326: {",
      "336:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
      "337: }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "348:  if (tifp & _TIF_IO_BITMAP)",
      "350: }",
      "352: static void tss_copy_io_bitmap(struct tss_struct *tss, struct io_bitmap *iobm)",
      "",
      "[Removed Lines]",
      "349:   tss_invalidate_io_bitmap(this_cpu_ptr(&cpu_tss_rw));",
      "",
      "[Added Lines]",
      "335:   tss_invalidate_io_bitmap();",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "380:  u16 *base = &tss->x86_tss.io_bitmap_base;",
      "382:  if (!test_thread_flag(TIF_IO_BITMAP)) {",
      "384:   return;",
      "385:  }",
      "",
      "[Removed Lines]",
      "383:   tss_invalidate_io_bitmap(tss);",
      "",
      "[Added Lines]",
      "369:   native_tss_invalidate_io_bitmap();",
      "",
      "---------------"
    ],
    "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c": [
      "File: arch/x86/xen/enlighten_pv.c -> arch/x86/xen/enlighten_pv.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "870: }",
      "872: #ifdef CONFIG_X86_IOPL_IOPERM",
      "873: static void xen_update_io_bitmap(void)",
      "874: {",
      "875:  struct physdev_set_iobitmap iobitmap;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "873: static void xen_invalidate_io_bitmap(void)",
      "874: {",
      "875:  struct physdev_set_iobitmap iobitmap = {",
      "876:   .bitmap = 0,",
      "877:   .nr_ports = 0,",
      "878:  };",
      "880:  native_tss_invalidate_io_bitmap();",
      "881:  HYPERVISOR_physdev_op(PHYSDEVOP_set_iobitmap, &iobitmap);",
      "882: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1099:  .load_sp0 = xen_load_sp0,",
      "1101: #ifdef CONFIG_X86_IOPL_IOPERM",
      "1102:  .update_io_bitmap = xen_update_io_bitmap,",
      "1103: #endif",
      "1104:  .io_delay = xen_io_delay,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1113:  .invalidate_io_bitmap = xen_invalidate_io_bitmap,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ecc7e37d4dadd16f6be125ca496feccd05454da4",
      "candidate_info": {
        "commit_hash": "ecc7e37d4dadd16f6be125ca496feccd05454da4",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/ecc7e37d4dadd16f6be125ca496feccd05454da4",
        "files": [
          "arch/x86/include/asm/processor.h",
          "arch/x86/kernel/cpu/common.c",
          "arch/x86/kernel/doublefault.c",
          "arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c"
        ],
        "message": "x86/io: Speedup schedule out of I/O bitmap user\n\nThere is no requirement to update the TSS I/O bitmap when a thread using it is\nscheduled out and the incoming thread does not use it.\n\nFor the permission check based on the TSS I/O bitmap the CPU calculates the memory\nlocation of the I/O bitmap by the address of the TSS and the io_bitmap_base member\nof the tss_struct. The easiest way to invalidate the I/O bitmap is to switch the\noffset to an address outside of the TSS limit.\n\nIf an I/O instruction is issued from user space the TSS limit causes #GP to be\nraised in the same was as valid I/O bitmap with all bits set to 1 would do.\n\nThis removes the extra work when an I/O bitmap using task is scheduled out\nand puts the burden on the rare I/O bitmap users when they are scheduled\nin.\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>",
        "before_after_code_files": [
          "arch/x86/include/asm/processor.h||arch/x86/include/asm/processor.h",
          "arch/x86/kernel/cpu/common.c||arch/x86/kernel/cpu/common.c",
          "arch/x86/kernel/doublefault.c||arch/x86/kernel/doublefault.c",
          "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ],
          "candidate": [
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/include/asm/processor.h||arch/x86/include/asm/processor.h": [
          "File: arch/x86/include/asm/processor.h -> arch/x86/include/asm/processor.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "330: #define IO_BITMAP_BITS   65536",
          "331: #define IO_BITMAP_BYTES   (IO_BITMAP_BITS/8)",
          "332: #define IO_BITMAP_LONGS   (IO_BITMAP_BYTES/sizeof(long))",
          "336: struct entry_stack {",
          "337:  unsigned long  words[64];",
          "",
          "[Removed Lines]",
          "333: #define IO_BITMAP_OFFSET  (offsetof(struct tss_struct, io_bitmap) - offsetof(struct tss_struct, x86_tss))",
          "334: #define INVALID_IO_BITMAP_OFFSET 0x8000",
          "",
          "[Added Lines]",
          "334: #define IO_BITMAP_OFFSET_VALID    \\",
          "335:  (offsetof(struct tss_struct, io_bitmap) - \\",
          "336:   offsetof(struct tss_struct, x86_tss))",
          "345: #define __KERNEL_TSS_LIMIT \\",
          "346:  (IO_BITMAP_OFFSET_VALID + IO_BITMAP_BYTES + sizeof(unsigned long) - 1)",
          "349: #define IO_BITMAP_OFFSET_INVALID (__KERNEL_TSS_LIMIT + 1)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "350:  struct x86_hw_tss x86_tss;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "374:  unsigned int  io_bitmap_prev_max;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "361: DECLARE_PER_CPU_PAGE_ALIGNED(struct tss_struct, cpu_tss_rw);",
          "374: struct irq_stack {",
          "375:  char  stack[IRQ_STACK_SIZE];",
          "",
          "[Removed Lines]",
          "370: #define __KERNEL_TSS_LIMIT \\",
          "371:  (IO_BITMAP_OFFSET + IO_BITMAP_BYTES + sizeof(unsigned long) - 1)",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "arch/x86/kernel/cpu/common.c||arch/x86/kernel/cpu/common.c": [
          "File: arch/x86/kernel/cpu/common.c -> arch/x86/kernel/cpu/common.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1862:  tss_setup_ist(tss);",
          "1864:  memset(tss->io_bitmap, 0xff, sizeof(tss->io_bitmap));",
          "1865:  set_tss_desc(cpu, &get_cpu_entry_area(cpu)->tss.x86_tss);",
          "",
          "[Removed Lines]",
          "1863:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET;",
          "",
          "[Added Lines]",
          "1863:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "1864:  tss->io_bitmap_prev_max = 0;",
          "",
          "---------------"
        ],
        "arch/x86/kernel/doublefault.c||arch/x86/kernel/doublefault.c": [
          "File: arch/x86/kernel/doublefault.c -> arch/x86/kernel/doublefault.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:  .sp0  = STACK_START,",
          "55:  .ss0  = __KERNEL_DS,",
          "56:  .ldt  = 0,",
          "59:  .ip  = (unsigned long) doublefault_fn,",
          "",
          "[Removed Lines]",
          "57:  .io_bitmap_base = INVALID_IO_BITMAP_OFFSET,",
          "",
          "[Added Lines]",
          "57:  .io_bitmap_base = IO_BITMAP_OFFSET_INVALID,",
          "",
          "---------------"
        ],
        "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c": [
          "File: arch/x86/kernel/ioport.c -> arch/x86/kernel/ioport.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:  tss = this_cpu_ptr(&cpu_tss_rw);",
          "84:  memcpy(tss->io_bitmap, t->io_bitmap_ptr, bytes_updated);",
          "86:  refresh_tss_limit();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:  tss->io_bitmap_prev_max = bytes;",
          "88:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_VALID;",
          "",
          "---------------"
        ],
        "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
          "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "72: #ifdef CONFIG_X86_32",
          "73:   .ss0 = __KERNEL_DS,",
          "74:   .ss1 = __KERNEL_CS,",
          "76: #endif",
          "77:   },",
          "87: };",
          "88: EXPORT_PER_CPU_SYMBOL(cpu_tss_rw);",
          "",
          "[Removed Lines]",
          "75:   .io_bitmap_base = INVALID_IO_BITMAP_OFFSET,",
          "78: #ifdef CONFIG_X86_32",
          "85:  .io_bitmap  = { [0 ... IO_BITMAP_LONGS] = ~0 },",
          "86: #endif",
          "",
          "[Added Lines]",
          "76:   .io_bitmap_base = IO_BITMAP_OFFSET_INVALID,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "112:  struct thread_struct *t = &tsk->thread;",
          "113:  unsigned long *bp = t->io_bitmap_ptr;",
          "114:  struct fpu *fpu = &t->fpu;",
          "116:  if (bp) {",
          "119:   t->io_bitmap_ptr = NULL;",
          "125:   t->io_bitmap_max = 0;",
          "127:   kfree(bp);",
          "128:  }",
          "",
          "[Removed Lines]",
          "117:   struct tss_struct *tss = &per_cpu(cpu_tss_rw, get_cpu());",
          "120:   clear_thread_flag(TIF_IO_BITMAP);",
          "124:   memset(tss->io_bitmap, 0xff, t->io_bitmap_max);",
          "126:   put_cpu();",
          "",
          "[Added Lines]",
          "106:  struct tss_struct *tss;",
          "109:   preempt_disable();",
          "110:   tss = this_cpu_ptr(&cpu_tss_rw);",
          "114:   clear_thread_flag(TIF_IO_BITMAP);",
          "116:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "117:   preempt_enable();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "369:  }",
          "370: }",
          "374:         unsigned long tifp, unsigned long tifn)",
          "375: {",
          "376:  struct tss_struct *tss = this_cpu_ptr(&cpu_tss_rw);",
          "378:  if (tifn & _TIF_IO_BITMAP) {",
          "383:   memcpy(tss->io_bitmap, next->io_bitmap_ptr,",
          "389:   refresh_tss_limit();",
          "390:  } else if (tifp & _TIF_IO_BITMAP) {",
          "395:  }",
          "396: }",
          "",
          "[Removed Lines]",
          "372: static inline void switch_to_bitmap(struct thread_struct *prev,",
          "373:         struct thread_struct *next,",
          "384:          max(prev->io_bitmap_max, next->io_bitmap_max));",
          "394:   memset(tss->io_bitmap, 0xff, prev->io_bitmap_max);",
          "",
          "[Added Lines]",
          "363: static inline void switch_to_bitmap(struct thread_struct *next,",
          "378:          max(tss->io_bitmap_prev_max, next->io_bitmap_max));",
          "381:   tss->io_bitmap_prev_max = next->io_bitmap_max;",
          "382:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_VALID;",
          "403:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "606:  tifn = READ_ONCE(task_thread_info(next_p)->flags);",
          "607:  tifp = READ_ONCE(task_thread_info(prev_p)->flags);",
          "610:  propagate_user_return_notify(prev_p, next_p);",
          "",
          "[Removed Lines]",
          "608:  switch_to_bitmap(prev, next, tifp, tifn);",
          "",
          "[Added Lines]",
          "617:  switch_to_bitmap(next, tifp, tifn);",
          "",
          "---------------"
        ]
      }
    }
  ]
}