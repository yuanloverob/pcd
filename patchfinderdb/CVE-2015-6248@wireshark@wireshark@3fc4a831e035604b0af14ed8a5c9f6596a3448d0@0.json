{
  "cve_id": "CVE-2015-6248",
  "cve_desc": "The ptvcursor_add function in the ptvcursor implementation in epan/proto.c in Wireshark 1.12.x before 1.12.7 does not check whether the expected amount of data is available, which allows remote attackers to cause a denial of service (application crash) via a crafted packet.",
  "repo": "wireshark/wireshark",
  "patch_hash": "3fc4a831e035604b0af14ed8a5c9f6596a3448d0",
  "patch_info": {
    "commit_hash": "3fc4a831e035604b0af14ed8a5c9f6596a3448d0",
    "repo": "wireshark/wireshark",
    "commit_url": "https://github.com/wireshark/wireshark/commit/3fc4a831e035604b0af14ed8a5c9f6596a3448d0",
    "files": [
      "epan/proto.c"
    ],
    "message": "Fix ptvcursor_add() so it can dissect the last bytes in a TVB again.\n\nptvc->offset has already been incremented by the item length so don't use it as\nthe offset to test_length(); we need to use the original offset.\n\nProblem introduced by Idfd258c734e7a946300b2564bebf6e4cb374c8d1 .\n\nChange-Id: I0421539bde6e8eb7b5aa3e22dbb0ca8098e88d6f\nReviewed-on: https://code.wireshark.org/review/9779\nReviewed-by: Michael Mann <mmann78@netscape.net>\nReviewed-by: Anders Broman <a.broman58@gmail.com>",
    "before_after_code_files": [
      "epan/proto.c||epan/proto.c"
    ]
  },
  "patch_diff": {
    "epan/proto.c||epan/proto.c": [
      "File: epan/proto.c -> epan/proto.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2230:   ptvc->offset += n;",
      "2231:  }",
      "2236:  TRY_TO_FAKE_THIS_ITEM(ptvc->tree, hfindex, hfinfo);",
      "",
      "[Removed Lines]",
      "2233:  test_length(hfinfo, ptvc->tvb, ptvc->offset, item_length);",
      "",
      "[Added Lines]",
      "2233:  test_length(hfinfo, ptvc->tvb, offset, item_length);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5b53445e815fd6b652d49df03ec3d60b088c4fbc",
      "candidate_info": {
        "commit_hash": "5b53445e815fd6b652d49df03ec3d60b088c4fbc",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/5b53445e815fd6b652d49df03ec3d60b088c4fbc",
        "files": [
          "epan/proto.c"
        ],
        "message": "Add test_length to ptvcursor_add so it can do some bounds checking.\n\nPing-Bug: 11358\nChange-Id: Idfd258c734e7a946300b2564bebf6e4cb374c8d1\nReviewed-on: https://code.wireshark.org/review/9655\nReviewed-by: Michael Mann <mmann78@netscape.net>\nPetri-Dish: Michael Mann <mmann78@netscape.net>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Anders Broman <a.broman58@gmail.com>",
        "before_after_code_files": [
          "epan/proto.c||epan/proto.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "epan/proto.c||epan/proto.c"
          ],
          "candidate": [
            "epan/proto.c||epan/proto.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/proto.c||epan/proto.c": [
          "File: epan/proto.c -> epan/proto.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2177:  return proto_tree_add_node(tree, new_fi);",
          "2178: }",
          "2182: proto_item *",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2185: static void",
          "2186: test_length(header_field_info *hfinfo, tvbuff_t *tvb,",
          "2187:      gint start, gint length)",
          "2188: {",
          "2189:  gint size = length;",
          "2191:  if (!tvb)",
          "2192:   return;",
          "2194:  if (hfinfo->type == FT_STRINGZ) {",
          "2198:   if (length == -1)",
          "2199:    size = 0;",
          "2200:  }",
          "2202:  tvb_ensure_bytes_exist(tvb, start, size);",
          "2203: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2205:   ptvc->offset += n;",
          "2206:  }",
          "2209:  TRY_TO_FAKE_THIS_ITEM(ptvc->tree, hfindex, hfinfo);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2233:  test_length(hfinfo, ptvc->tvb, ptvc->offset, item_length);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2214:   offset, length, encoding);",
          "2215: }",
          "2243: proto_item *",
          "",
          "[Removed Lines]",
          "2221: static void",
          "2222: test_length(header_field_info *hfinfo, tvbuff_t *tvb,",
          "2223:      gint start, gint length)",
          "2224: {",
          "2225:  gint size = length;",
          "2227:  if (!tvb)",
          "2228:   return;",
          "2230:  if (hfinfo->type == FT_STRINGZ) {",
          "2234:   if (length == -1)",
          "2235:    size = 0;",
          "2236:  }",
          "2238:  tvb_ensure_bytes_exist(tvb, start, size);",
          "2239: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e0190908fd9d20741fdb76b57062b0013554b464",
      "candidate_info": {
        "commit_hash": "e0190908fd9d20741fdb76b57062b0013554b464",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/e0190908fd9d20741fdb76b57062b0013554b464",
        "files": [
          "epan/proto.c"
        ],
        "message": "Fix ptvcursor_add() so it can dissect the last bytes in a TVB again.\n\nptvc->offset has already been incremented by the item length so don't use it as\nthe offset to test_length(); we need to use the original offset.\n\nProblem introduced by Idfd258c734e7a946300b2564bebf6e4cb374c8d1 .\n\nChange-Id: I0421539bde6e8eb7b5aa3e22dbb0ca8098e88d6f\nReviewed-on: https://code.wireshark.org/review/9783\nReviewed-by: Anders Broman <a.broman58@gmail.com>\n(cherry picked from commit 9831d16cb06a08b4de1857ba35935edd0a8996af)\nReviewed-on: https://code.wireshark.org/review/10589\nReviewed-by: Balint Reczey <balint@balintreczey.hu>\n(cherry picked from commit 870b8892d40ef89946be6eff6d078eb750d4944d)\nReviewed-on: https://code.wireshark.org/review/11257",
        "before_after_code_files": [
          "epan/proto.c||epan/proto.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/proto.c||epan/proto.c"
          ],
          "candidate": [
            "epan/proto.c||epan/proto.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/proto.c||epan/proto.c": [
          "File: epan/proto.c -> epan/proto.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1744:   ptvc->offset += n;",
          "1745:  }",
          "1750:  TRY_TO_FAKE_THIS_ITEM(ptvc->tree, hfindex, hfinfo);",
          "",
          "[Removed Lines]",
          "1747:  test_length(hfinfo, ptvc->tvb, ptvc->offset, item_length);",
          "",
          "[Added Lines]",
          "1747:  test_length(hfinfo, ptvc->tvb, offset, item_length);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "870b8892d40ef89946be6eff6d078eb750d4944d",
      "candidate_info": {
        "commit_hash": "870b8892d40ef89946be6eff6d078eb750d4944d",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/870b8892d40ef89946be6eff6d078eb750d4944d",
        "files": [
          "epan/proto.c"
        ],
        "message": "Fix ptvcursor_add() so it can dissect the last bytes in a TVB again.\n\nptvc->offset has already been incremented by the item length so don't use it as\nthe offset to test_length(); we need to use the original offset.\n\nProblem introduced by Idfd258c734e7a946300b2564bebf6e4cb374c8d1 .\n\nChange-Id: I0421539bde6e8eb7b5aa3e22dbb0ca8098e88d6f\nReviewed-on: https://code.wireshark.org/review/9783\nReviewed-by: Anders Broman <a.broman58@gmail.com>\n(cherry picked from commit 9831d16cb06a08b4de1857ba35935edd0a8996af)\nReviewed-on: https://code.wireshark.org/review/10589\nReviewed-by: Balint Reczey <balint@balintreczey.hu>",
        "before_after_code_files": [
          "epan/proto.c||epan/proto.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/proto.c||epan/proto.c"
          ],
          "candidate": [
            "epan/proto.c||epan/proto.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/proto.c||epan/proto.c": [
          "File: epan/proto.c -> epan/proto.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1950:   ptvc->offset += n;",
          "1951:  }",
          "1956:  TRY_TO_FAKE_THIS_ITEM(ptvc->tree, hfindex, hfinfo);",
          "",
          "[Removed Lines]",
          "1953:  test_length(hfinfo, ptvc->tvb, ptvc->offset, item_length);",
          "",
          "[Added Lines]",
          "1953:  test_length(hfinfo, ptvc->tvb, offset, item_length);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9831d16cb06a08b4de1857ba35935edd0a8996af",
      "candidate_info": {
        "commit_hash": "9831d16cb06a08b4de1857ba35935edd0a8996af",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/9831d16cb06a08b4de1857ba35935edd0a8996af",
        "files": [
          "epan/proto.c"
        ],
        "message": "Fix ptvcursor_add() so it can dissect the last bytes in a TVB again.\n\nptvc->offset has already been incremented by the item length so don't use it as\nthe offset to test_length(); we need to use the original offset.\n\nProblem introduced by Idfd258c734e7a946300b2564bebf6e4cb374c8d1 .\n\nChange-Id: I0421539bde6e8eb7b5aa3e22dbb0ca8098e88d6f\nReviewed-on: https://code.wireshark.org/review/9783\nReviewed-by: Anders Broman <a.broman58@gmail.com>",
        "before_after_code_files": [
          "epan/proto.c||epan/proto.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/proto.c||epan/proto.c"
          ],
          "candidate": [
            "epan/proto.c||epan/proto.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/proto.c||epan/proto.c": [
          "File: epan/proto.c -> epan/proto.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1966:   ptvc->offset += n;",
          "1967:  }",
          "1972:  TRY_TO_FAKE_THIS_ITEM(ptvc->tree, hfindex, hfinfo);",
          "",
          "[Removed Lines]",
          "1969:  test_length(hfinfo, ptvc->tvb, ptvc->offset, item_length);",
          "",
          "[Added Lines]",
          "1969:  test_length(hfinfo, ptvc->tvb, offset, item_length);",
          "",
          "---------------"
        ]
      }
    }
  ]
}