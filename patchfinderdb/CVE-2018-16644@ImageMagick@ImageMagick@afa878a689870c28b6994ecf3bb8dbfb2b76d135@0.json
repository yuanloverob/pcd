{
  "cve_id": "CVE-2018-16644",
  "cve_desc": "There is a missing check for length in the functions ReadDCMImage of coders/dcm.c and ReadPICTImage of coders/pict.c in ImageMagick 7.0.8-11, which allows remote attackers to cause a denial of service via a crafted image.",
  "repo": "ImageMagick/ImageMagick",
  "patch_hash": "afa878a689870c28b6994ecf3bb8dbfb2b76d135",
  "patch_info": {
    "commit_hash": "afa878a689870c28b6994ecf3bb8dbfb2b76d135",
    "repo": "ImageMagick/ImageMagick",
    "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/afa878a689870c28b6994ecf3bb8dbfb2b76d135",
    "files": [
      "coders/pict.c"
    ],
    "message": "https://github.com/ImageMagick/ImageMagick/issues/1269",
    "before_after_code_files": [
      "coders/pict.c||coders/pict.c"
    ]
  },
  "patch_diff": {
    "coders/pict.c||coders/pict.c": [
      "File: coders/pict.c -> coders/pict.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "982:             \"  %04X %s: %s\",code,codes[code].name,codes[code].description);",
      "983:         switch (code)",
      "984:         {",
      "985:           case 0x01:",
      "986:           {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "985:           case 0x01:",
      "986:           {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1030:               {",
      "1031:                 for (i=0; i < 5; i++)",
      "1032:                   if (ReadBlobByte(image) == EOF)",
      "1033:                     break;",
      "1034:                 break;",
      "1035:               }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1036:                     break;",
      "1037:                 break;",
      "1038:               }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1041:             if (ReadPixmap(image,&pixmap) == MagickFalse)",
      "1042:               ThrowPICTException(CorruptImageError,\"ImproperImageHeader\");",
      "1043:             image->depth=(size_t) pixmap.component_size;",
      "1044:             image->resolution.x=1.0*pixmap.horizontal_resolution;",
      "1045:             image->resolution.y=1.0*pixmap.vertical_resolution;",
      "1046:             image->units=PixelsPerInchResolution;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1050:             image->resolution.x=1.0*pixmap.horizontal_resolution;",
      "1051:             image->resolution.y=1.0*pixmap.vertical_resolution;",
      "1052:             image->units=PixelsPerInchResolution;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1101:           case 0x74:",
      "1102:           case 0x75:",
      "1103:           case 0x76:",
      "1104:           case 0x77:",
      "1105:           {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1113:           case 0x77:",
      "1114:           {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1223:             if (ReadRectangle(image,&destination) == MagickFalse)",
      "1224:               ThrowPICTException(CorruptImageError,\"ImproperImageHeader\");",
      "1225:             (void) ReadBlobMSBShort(image);",
      "1226:             if ((code == 0x91) || (code == 0x99) || (code == 0x9b))",
      "1227:               {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1238:             if ((code == 0x91) || (code == 0x99) || (code == 0x9b))",
      "1239:               {",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1346:             size_t",
      "1347:               type;",
      "1350:               Comment.",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1365:               Comment.",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1454:           file=fdopen(unique_file,\"wb\");",
      "1455:         if ((unique_file == -1) || (file == (FILE *) NULL))",
      "1456:           {",
      "1457:             (void) RelinquishUniqueFileResource(read_info->filename);",
      "1458:             (void) CopyMagickString(image->filename,read_info->filename,",
      "1459:               MagickPathExtent);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1475:             (void) RelinquishUniqueFileResource(read_info->filename);",
      "1476:             (void) CopyMagickString(image->filename,read_info->filename,",
      "1477:               MagickPathExtent);",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1505:     if ((code == 0xff) || (code == 0xffff))",
      "1506:       break;",
      "1507:     if (((code >= 0xd0) && (code <= 0xfe)) ||",
      "1508:         ((code >= 0x8100) && (code <= 0xffff)))",
      "1509:       {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1529:         ((code >= 0x8100) && (code <= 0xffff)))",
      "1530:       {",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1516:             break;",
      "1517:         continue;",
      "1518:       }",
      "1519:     if ((code >= 0x100) && (code <= 0x7fff))",
      "1520:       {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1543:     if ((code >= 0x100) && (code <= 0x7fff))",
      "1544:       {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2b4fee3b265bd8333bea89a495e37a18a445da86",
      "candidate_info": {
        "commit_hash": "2b4fee3b265bd8333bea89a495e37a18a445da86",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/2b4fee3b265bd8333bea89a495e37a18a445da86",
        "files": [
          "coders/pict.c"
        ],
        "message": "...",
        "before_after_code_files": [
          "coders/pict.c||coders/pict.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/pict.c||coders/pict.c"
          ],
          "candidate": [
            "coders/pict.c||coders/pict.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/pict.c||coders/pict.c": [
          "File: coders/pict.c -> coders/pict.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "325: %    o bits_per_pixel: the number of bits in a pixel.",
          "326: %",
          "327: %    o extent: the number of pixels allocated.",
          "331: static unsigned char *ExpandBuffer(unsigned char *pixels,",
          "332:   MagickSizeType *bytes_per_line,const unsigned int bits_per_pixel)",
          "333: {",
          "334:   register ssize_t",
          "335:     i;",
          "337:   register unsigned char",
          "",
          "[Removed Lines]",
          "328: %",
          "",
          "[Added Lines]",
          "328: %",
          "331: static const unsigned char *ExpandBuffer(const unsigned char *restrict pixels,",
          "332:   const unsigned int bits_per_pixel,MagickSizeType *bytes_per_line)",
          "333: {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "402:   MagickBooleanType",
          "403:     status;",
          "405:   MagickSizeType",
          "406:     number_pixels;",
          "408:   register ssize_t",
          "409:     i;",
          "411:   register unsigned char",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "407:   MagickSizeType",
          "408:     number_pixels;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "478:         count=ReadBlob(blob,(size_t) number_pixels,scanline);",
          "479:         if (count != (ssize_t) number_pixels)",
          "480:           {",
          "482:             break;",
          "483:           }",
          "484:         p=ExpandBuffer(scanline,&number_pixels,bits_per_pixel);",
          "",
          "[Removed Lines]",
          "481:             status=MagickFalse;",
          "",
          "[Added Lines]",
          "485:             status=MagickFalse;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "517:       }",
          "518:     for (j=0; j < (ssize_t) scanline_length; )",
          "519:       if ((scanline[j] & 0x80) == 0)",
          "521:           length=(size_t) ((scanline[j] & 0xff)+1);",
          "522:           number_pixels=length*bytes_per_pixel;",
          "523:           p=ExpandBuffer(scanline+j+1,&number_pixels,bits_per_pixel);",
          "",
          "[Removed Lines]",
          "520:         {",
          "",
          "[Added Lines]",
          "524:         {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "527:           j+=(ssize_t) (length*bytes_per_pixel+1);",
          "528:         }",
          "529:       else",
          "531:           length=(size_t) (((scanline[j] ^ 0xff) & 0xff)+2);",
          "532:           number_pixels=bytes_per_pixel;",
          "533:           p=ExpandBuffer(scanline+j+1,&number_pixels,bits_per_pixel);",
          "",
          "[Removed Lines]",
          "530:         {",
          "",
          "[Added Lines]",
          "534:         {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "982:             \"  %04X %s: %s\",code,codes[code].name,codes[code].description);",
          "983:         switch (code)",
          "984:         {",
          "986:           {",
          "988:               Clipping rectangle.",
          "",
          "[Removed Lines]",
          "985:           case 0x01:",
          "",
          "[Added Lines]",
          "989:           case 0x01:",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1033:               {",
          "1034:                 for (i=0; i < 5; i++)",
          "1035:                   if (ReadBlobByte(image) == EOF)",
          "1037:                 break;",
          "1038:               }",
          "1039:             if (pattern != 1)",
          "",
          "[Removed Lines]",
          "1036:                     break;",
          "",
          "[Added Lines]",
          "1040:                     break;",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1047:             if (ReadPixmap(image,&pixmap) == MagickFalse)",
          "1048:               ThrowPICTException(CorruptImageError,\"ImproperImageHeader\");",
          "1049:             image->depth=(size_t) pixmap.component_size;",
          "1051:             image->resolution.y=1.0*pixmap.vertical_resolution;",
          "1052:             image->units=PixelsPerInchResolution;",
          "1053:             (void) ReadBlobMSBLong(image);",
          "",
          "[Removed Lines]",
          "1050:             image->resolution.x=1.0*pixmap.horizontal_resolution;",
          "",
          "[Added Lines]",
          "1054:             image->resolution.x=1.0*pixmap.horizontal_resolution;",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1110:           case 0x74:",
          "1111:           case 0x75:",
          "1112:           case 0x76:",
          "1114:           {",
          "1116:               Skip polygon or region.",
          "",
          "[Removed Lines]",
          "1113:           case 0x77:",
          "",
          "[Added Lines]",
          "1117:           case 0x77:",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1235:             if (ReadRectangle(image,&destination) == MagickFalse)",
          "1236:               ThrowPICTException(CorruptImageError,\"ImproperImageHeader\");",
          "1237:             (void) ReadBlobMSBShort(image);",
          "1239:               {",
          "1241:                   Skip region.",
          "",
          "[Removed Lines]",
          "1238:             if ((code == 0x91) || (code == 0x99) || (code == 0x9b))",
          "",
          "[Added Lines]",
          "1242:             if ((code == 0x91) || (code == 0x99) || (code == 0x9b))",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1361:             size_t",
          "1362:               type;",
          "1365:               Comment.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1472:           file=fdopen(unique_file,\"wb\");",
          "1473:         if ((unique_file == -1) || (file == (FILE *) NULL))",
          "1474:           {",
          "1476:             (void) CopyMagickString(image->filename,read_info->filename,",
          "1477:               MagickPathExtent);",
          "1478:             ThrowPICTException(FileOpenError,\"UnableToCreateTemporaryFile\");",
          "",
          "[Removed Lines]",
          "1475:             (void) RelinquishUniqueFileResource(read_info->filename);",
          "",
          "[Added Lines]",
          "1479:             (void) RelinquishUniqueFileResource(read_info->filename);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1526:     if ((code == 0xff) || (code == 0xffff))",
          "1527:       break;",
          "1528:     if (((code >= 0xd0) && (code <= 0xfe)) ||",
          "1530:       {",
          "1532:           Skip reserved.",
          "",
          "[Removed Lines]",
          "1529:         ((code >= 0x8100) && (code <= 0xffff)))",
          "",
          "[Added Lines]",
          "1533:         ((code >= 0x8100) && (code <= 0xffff)))",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1540:             break;",
          "1541:         continue;",
          "1542:       }",
          "1544:       {",
          "1546:           Skip reserved.",
          "",
          "[Removed Lines]",
          "1543:     if ((code >= 0x100) && (code <= 0x7fff))",
          "",
          "[Added Lines]",
          "1547:     if ((code >= 0x100) && (code <= 0x7fff))",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1928:       (void) WriteBlobMSBLong(image,0x00000000U);",
          "1929:       (void) WriteBlobMSBLong(image,0x00000001U);",
          "1930:       (void) WriteBlobMSBLong(image,0x00016170U);",
          "1932:       (void) WriteBlobMSBLong(image,0x00000000U);",
          "1933:       (void) WriteBlobMSBShort(image,768);",
          "1934:       (void) WriteBlobMSBShort(image,(unsigned short) image->columns);",
          "",
          "[Removed Lines]",
          "1931:       (void) WriteBlobMSBLong(image,0x706C0000U);",
          "",
          "[Added Lines]",
          "1935:       (void) WriteBlobMSBLong(image,0x706C0000U);",
          "",
          "---------------"
        ]
      }
    }
  ]
}