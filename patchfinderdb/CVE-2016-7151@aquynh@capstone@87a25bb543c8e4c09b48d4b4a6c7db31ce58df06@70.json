{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "23fe9f36622573c747e2bab6119ff245437bf276",
      "candidate_info": {
        "commit_hash": "23fe9f36622573c747e2bab6119ff245437bf276",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/23fe9f36622573c747e2bab6119ff245437bf276",
        "files": [
          "bindings/python/setup.py"
        ],
        "message": "python-bindings: fix setup.py for wheel installation\n\nWhen the python bindings are installed using the new wheels\ninfrastructure, data_files are relative to the site-packages directory\neven if using absolute paths.\n\nThe following example demonstrates the bug fixed by this commit: (ran on archlinux)\n\n```bash\n$ pip install wheel       # if this package is installed, wheel installation is made the default\nCollecting wheel\n  Downloading wheel-0.29.0-py2.py3-none-any.whl (66kB)\n    100% |################################| 71kB 124kB/s\nInstalling collected packages: wheel\nSuccessfully installed wheel-0.29.0\n\n$ pip install capstone    # this will use the wheel installation method now\nCollecting capstone\n  Using cached capstone-3.0.4.tar.gz\nBuilding wheels for collected packages: capstone\n  Running setup.py bdist_wheel for capstone ... done\n  Stored in directory: /root/.cache/pip/wheels/7c/d1/d0/db6e2c5ef1063aabb9de2dd8b92b4c27ee6f9fd213240099b8\nSuccessfully built capstone\nInstalling collected packages: capstone\nSuccessfully installed capstone-3.0.4\n\n$ find /usr/lib/ -name \"libcapstone.so\"\n/usr/lib/python3.5/site-packages/usr/lib/python3.5/site-packages/capstone/libcapstone.so\n```\n\nSo the path `SITE_PACKAGES` in the `data_files` specification of the\nsetup.py file was interpreted relative to the python site-packages\ndirectory. The fix for this is simple: use `/capstone` instead of an\nabsolute path for `SITE_PACKAGES`.",
        "before_after_code_files": [
          "bindings/python/setup.py||bindings/python/setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "33:     except ImportError:",
          "34:         pass",
          "37: # adapted from commit e504b81 of Nguyen Tan Cong",
          "38: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36: # If building a wheel, the path listed in data_files is interpreted relative to",
          "37: # python's site-packages directory, even if it starts with a slash. So we need",
          "38: # to use only `/capstone` as path in this case.",
          "39: #",
          "40: # Note: using `capstone` does not work, since that for some reason is interpreted",
          "41: # relative to the the python installation prefix, not to the site-packages directory.",
          "42: if \"bdist_wheel\" in sys.argv:",
          "43:     SITE_PACKAGES = \"/capstone\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b3d38cfa7186514f1cc5517f6872b7646a1bdb7d",
      "candidate_info": {
        "commit_hash": "b3d38cfa7186514f1cc5517f6872b7646a1bdb7d",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/b3d38cfa7186514f1cc5517f6872b7646a1bdb7d",
        "files": [
          "cs.c"
        ],
        "message": "fix #673",
        "before_after_code_files": [
          "cs.c||cs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cs.c||cs.c": [
          "File: cs.c -> cs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "233:   ud->errnum = CS_ERR_OK;",
          "234:   ud->arch = arch;",
          "235:   ud->mode = mode;",
          "238:   ud->detail = CS_OPT_OFF;",
          "",
          "[Removed Lines]",
          "236:   ud->big_endian = mode & CS_MODE_BIG_ENDIAN;",
          "",
          "[Added Lines]",
          "236:   ud->big_endian = (mode & CS_MODE_BIG_ENDIAN) != 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8308ace3a0393d9742515019d11ba4254b1d3951",
      "candidate_info": {
        "commit_hash": "8308ace3a0393d9742515019d11ba4254b1d3951",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/8308ace3a0393d9742515019d11ba4254b1d3951",
        "files": [
          "arch/X86/X86GenAsmWriter.inc"
        ],
        "message": "x86: fix (AT&T) instruction SLDT for issue #807",
        "before_after_code_files": [
          "arch/X86/X86GenAsmWriter.inc||arch/X86/X86GenAsmWriter.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86GenAsmWriter.inc||arch/X86/X86GenAsmWriter.inc": [
          "File: arch/X86/X86GenAsmWriter.inc -> arch/X86/X86GenAsmWriter.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "14184:       case X86_LGS64rm:",
          "14185:         SStream_concat0(O, \"lgs\\t\");",
          "14186:         break;",
          "14187:     }",
          "14188: #endif",
          "14189:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14187:       case X86_SLDT64m:",
          "14188:         SStream_concat0(O, \"sldt\\t\");",
          "14189:         break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "db77204caada405f937c9bd906bf305908269cd1",
      "candidate_info": {
        "commit_hash": "db77204caada405f937c9bd906bf305908269cd1",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/db77204caada405f937c9bd906bf305908269cd1",
        "files": [
          "include/capstone.h"
        ],
        "message": "minor mode: fixed argument name (code documentation)",
        "before_after_code_files": [
          "include/capstone.h||include/capstone.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/capstone.h||include/capstone.h": [
          "File: include/capstone.h -> include/capstone.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "510:  @handle: handle returned by cs_open()",
          "511:  @code: buffer containing raw binary code to be disassembled",
          "513:  @address: address of the first insn in given raw code buffer",
          "514:  @insn: pointer to instruction to be filled in by this API.",
          "",
          "[Removed Lines]",
          "512:  @code_size: size of above code",
          "",
          "[Added Lines]",
          "512:  @size: size of above code",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9cdd2031ed74f1ed71f1c8ef8e10bb4b3a7b637f",
      "candidate_info": {
        "commit_hash": "9cdd2031ed74f1ed71f1c8ef8e10bb4b3a7b637f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/9cdd2031ed74f1ed71f1c8ef8e10bb4b3a7b637f",
        "files": [
          "arch/X86/X86Mapping.c"
        ],
        "message": "LOOP* instructions are conditional branches\n\nLOOP, LOOPE and LOOPNE are basically conditional branches http://x86.renejeschke.de/html/file_module_x86_id_161.html",
        "before_after_code_files": [
          "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ],
          "candidate": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
          "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41893:  {",
          "41894:   X86_LOOP, X86_INS_LOOP,",
          "41895: #ifndef CAPSTONE_DIET",
          "41897: #endif",
          "41898:  },",
          "41899:  {",
          "41900:   X86_LOOPE, X86_INS_LOOPE,",
          "41901: #ifndef CAPSTONE_DIET",
          "41903: #endif",
          "41904:  },",
          "41905:  {",
          "41906:   X86_LOOPNE, X86_INS_LOOPNE,",
          "41907: #ifndef CAPSTONE_DIET",
          "41909: #endif",
          "41910:  },",
          "41911:  {",
          "",
          "[Removed Lines]",
          "41896:   { 0 }, { 0 }, { 0 }, 0, 0",
          "41902:   { 0 }, { 0 }, { 0 }, 0, 0",
          "41908:   { 0 }, { 0 }, { 0 }, 0, 0",
          "",
          "[Added Lines]",
          "41896:   { 0 }, { 0 }, { 0 }, 1, 0",
          "41902:   { 0 }, { 0 }, { 0 }, 1, 0",
          "41908:   { 0 }, { 0 }, { 0 }, 1, 0",
          "",
          "---------------"
        ]
      }
    }
  ]
}