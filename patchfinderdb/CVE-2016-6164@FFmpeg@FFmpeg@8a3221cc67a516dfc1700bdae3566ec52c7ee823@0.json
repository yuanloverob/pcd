{
  "cve_id": "CVE-2016-6164",
  "cve_desc": "Integer overflow in the mov_build_index function in libavformat/mov.c in FFmpeg before 2.8.8, 3.0.x before 3.0.3 and 3.1.x before 3.1.1 allows remote attackers to have unspecified impact via vectors involving sample size.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "8a3221cc67a516dfc1700bdae3566ec52c7ee823",
  "patch_info": {
    "commit_hash": "8a3221cc67a516dfc1700bdae3566ec52c7ee823",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/8a3221cc67a516dfc1700bdae3566ec52c7ee823",
    "files": [
      "libavformat/mov.c"
    ],
    "message": "avformat/mov: Check sample size\n\nFixes integer overflow\nFixes: poc.mp4\n\nFound-by: ajax secure <ajax4sec@hotmail.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavformat/mov.c||libavformat/mov.c"
    ]
  },
  "patch_diff": {
    "libavformat/mov.c||libavformat/mov.c": [
      "File: libavformat/mov.c -> libavformat/mov.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2843:                 sample_size = sc->stsz_sample_size > 0 ? sc->stsz_sample_size : sc->sample_sizes[current_sample];",
      "2844:                 if (sc->pseudo_stream_id == -1 ||",
      "2845:                    sc->stsc_data[stsc_index].id - 1 == sc->pseudo_stream_id) {",
      "2847:                     e->pos = current_offset;",
      "2848:                     e->timestamp = current_dts;",
      "2849:                     e->size = sample_size;",
      "",
      "[Removed Lines]",
      "2846:                     AVIndexEntry *e = &st->index_entries[st->nb_index_entries++];",
      "",
      "[Added Lines]",
      "2846:                     AVIndexEntry *e;",
      "2847:                     if (sample_size > 0x3FFFFFFF) {",
      "2848:                         av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", sample_size);",
      "2849:                         return;",
      "2850:                     }",
      "2851:                     e = &st->index_entries[st->nb_index_entries++];",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2968:                     av_log(mov->fc, AV_LOG_ERROR, \"wrong chunk count %d\\n\", total);",
      "2969:                     return;",
      "2970:                 }",
      "2971:                 e = &st->index_entries[st->nb_index_entries++];",
      "2972:                 e->pos = current_offset;",
      "2973:                 e->timestamp = current_dts;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2976:                 if (size > 0x3FFFFFFF) {",
      "2977:                     av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", size);",
      "2978:                     return;",
      "2979:                 }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "054db631200c9940bc72e4dec2cb3c75e613abaf",
      "candidate_info": {
        "commit_hash": "054db631200c9940bc72e4dec2cb3c75e613abaf",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/054db631200c9940bc72e4dec2cb3c75e613abaf",
        "files": [
          "libavformat/mov.c"
        ],
        "message": "avformat/mov: Check sample size\n\nFixes integer overflow\nFixes: poc.mp4\n\nFound-by: ajax secure <ajax4sec@hotmail.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 8a3221cc67a516dfc1700bdae3566ec52c7ee823)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/mov.c||libavformat/mov.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/mov.c||libavformat/mov.c"
          ],
          "candidate": [
            "libavformat/mov.c||libavformat/mov.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/mov.c||libavformat/mov.c": [
          "File: libavformat/mov.c -> libavformat/mov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2704:                 sample_size = sc->stsz_sample_size > 0 ? sc->stsz_sample_size : sc->sample_sizes[current_sample];",
          "2705:                 if (sc->pseudo_stream_id == -1 ||",
          "2706:                    sc->stsc_data[stsc_index].id - 1 == sc->pseudo_stream_id) {",
          "2708:                     e->pos = current_offset;",
          "2709:                     e->timestamp = current_dts;",
          "2710:                     e->size = sample_size;",
          "",
          "[Removed Lines]",
          "2707:                     AVIndexEntry *e = &st->index_entries[st->nb_index_entries++];",
          "",
          "[Added Lines]",
          "2707:                     AVIndexEntry *e;",
          "2708:                     if (sample_size > 0x3FFFFFFF) {",
          "2709:                         av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", sample_size);",
          "2710:                         return;",
          "2711:                     }",
          "2712:                     e = &st->index_entries[st->nb_index_entries++];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2829:                     av_log(mov->fc, AV_LOG_ERROR, \"wrong chunk count %d\\n\", total);",
          "2830:                     return;",
          "2831:                 }",
          "2832:                 e = &st->index_entries[st->nb_index_entries++];",
          "2833:                 e->pos = current_offset;",
          "2834:                 e->timestamp = current_dts;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2837:                 if (size > 0x3FFFFFFF) {",
          "2838:                     av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", size);",
          "2839:                     return;",
          "2840:                 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3e730278f5a8e5ec3f9593700488a940f38dfac1",
      "candidate_info": {
        "commit_hash": "3e730278f5a8e5ec3f9593700488a940f38dfac1",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/3e730278f5a8e5ec3f9593700488a940f38dfac1",
        "files": [
          "libavformat/mov.c"
        ],
        "message": "avformat/mov: Check sample size\n\nFixes integer overflow\nFixes: poc.mp4\n\nFound-by: ajax secure <ajax4sec@hotmail.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 8a3221cc67a516dfc1700bdae3566ec52c7ee823)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/mov.c||libavformat/mov.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/mov.c||libavformat/mov.c"
          ],
          "candidate": [
            "libavformat/mov.c||libavformat/mov.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/mov.c||libavformat/mov.c": [
          "File: libavformat/mov.c -> libavformat/mov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2843:                 sample_size = sc->stsz_sample_size > 0 ? sc->stsz_sample_size : sc->sample_sizes[current_sample];",
          "2844:                 if (sc->pseudo_stream_id == -1 ||",
          "2845:                    sc->stsc_data[stsc_index].id - 1 == sc->pseudo_stream_id) {",
          "2847:                     e->pos = current_offset;",
          "2848:                     e->timestamp = current_dts;",
          "2849:                     e->size = sample_size;",
          "",
          "[Removed Lines]",
          "2846:                     AVIndexEntry *e = &st->index_entries[st->nb_index_entries++];",
          "",
          "[Added Lines]",
          "2846:                     AVIndexEntry *e;",
          "2847:                     if (sample_size > 0x3FFFFFFF) {",
          "2848:                         av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", sample_size);",
          "2849:                         return;",
          "2850:                     }",
          "2851:                     e = &st->index_entries[st->nb_index_entries++];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2968:                     av_log(mov->fc, AV_LOG_ERROR, \"wrong chunk count %d\\n\", total);",
          "2969:                     return;",
          "2970:                 }",
          "2971:                 e = &st->index_entries[st->nb_index_entries++];",
          "2972:                 e->pos = current_offset;",
          "2973:                 e->timestamp = current_dts;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2976:                 if (size > 0x3FFFFFFF) {",
          "2977:                     av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", size);",
          "2978:                     return;",
          "2979:                 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d7ab6e93a688688ad27c03ba3ba15711e59036dc",
      "candidate_info": {
        "commit_hash": "d7ab6e93a688688ad27c03ba3ba15711e59036dc",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/d7ab6e93a688688ad27c03ba3ba15711e59036dc",
        "files": [
          "libavformat/mov.c"
        ],
        "message": "avformat/mov: Check sample size\n\nFixes integer overflow\nFixes: poc.mp4\n\nFound-by: ajax secure <ajax4sec@hotmail.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 8a3221cc67a516dfc1700bdae3566ec52c7ee823)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/mov.c||libavformat/mov.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/mov.c||libavformat/mov.c"
          ],
          "candidate": [
            "libavformat/mov.c||libavformat/mov.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/mov.c||libavformat/mov.c": [
          "File: libavformat/mov.c -> libavformat/mov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2250:                 sample_size = sc->stsz_sample_size > 0 ? sc->stsz_sample_size : sc->sample_sizes[current_sample];",
          "2251:                 if (sc->pseudo_stream_id == -1 ||",
          "2252:                    sc->stsc_data[stsc_index].id - 1 == sc->pseudo_stream_id) {",
          "2254:                     e->pos = current_offset;",
          "2255:                     e->timestamp = current_dts;",
          "2256:                     e->size = sample_size;",
          "",
          "[Removed Lines]",
          "2253:                     AVIndexEntry *e = &st->index_entries[st->nb_index_entries++];",
          "",
          "[Added Lines]",
          "2253:                     AVIndexEntry *e;",
          "2254:                     if (sample_size > 0x3FFFFFFF) {",
          "2255:                         av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", sample_size);",
          "2256:                         return;",
          "2257:                     }",
          "2258:                     e = &st->index_entries[st->nb_index_entries++];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2348:                     av_log(mov->fc, AV_LOG_ERROR, \"wrong chunk count %d\\n\", total);",
          "2349:                     return;",
          "2350:                 }",
          "2351:                 e = &st->index_entries[st->nb_index_entries++];",
          "2352:                 e->pos = current_offset;",
          "2353:                 e->timestamp = current_dts;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2356:                 if (size > 0x3FFFFFFF) {",
          "2357:                     av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", size);",
          "2358:                     return;",
          "2359:                 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a5680d83af26d4e6cfb9fe2eb8f51247bf36a41f",
      "candidate_info": {
        "commit_hash": "a5680d83af26d4e6cfb9fe2eb8f51247bf36a41f",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/a5680d83af26d4e6cfb9fe2eb8f51247bf36a41f",
        "files": [
          "libavformat/mov.c"
        ],
        "message": "avformat/mov: Check sample size\n\nFixes integer overflow\nFixes: poc.mp4\n\nFound-by: ajax secure <ajax4sec@hotmail.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 8a3221cc67a516dfc1700bdae3566ec52c7ee823)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavformat/mov.c||libavformat/mov.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavformat/mov.c||libavformat/mov.c"
          ],
          "candidate": [
            "libavformat/mov.c||libavformat/mov.c"
          ]
        }
      },
      "candidate_diff": {
        "libavformat/mov.c||libavformat/mov.c": [
          "File: libavformat/mov.c -> libavformat/mov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2750:                 sample_size = sc->stsz_sample_size > 0 ? sc->stsz_sample_size : sc->sample_sizes[current_sample];",
          "2751:                 if (sc->pseudo_stream_id == -1 ||",
          "2752:                    sc->stsc_data[stsc_index].id - 1 == sc->pseudo_stream_id) {",
          "2754:                     e->pos = current_offset;",
          "2755:                     e->timestamp = current_dts;",
          "2756:                     e->size = sample_size;",
          "",
          "[Removed Lines]",
          "2753:                     AVIndexEntry *e = &st->index_entries[st->nb_index_entries++];",
          "",
          "[Added Lines]",
          "2753:                     AVIndexEntry *e;",
          "2754:                     if (sample_size > 0x3FFFFFFF) {",
          "2755:                         av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", sample_size);",
          "2756:                         return;",
          "2757:                     }",
          "2758:                     e = &st->index_entries[st->nb_index_entries++];",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2875:                     av_log(mov->fc, AV_LOG_ERROR, \"wrong chunk count %d\\n\", total);",
          "2876:                     return;",
          "2877:                 }",
          "2878:                 e = &st->index_entries[st->nb_index_entries++];",
          "2879:                 e->pos = current_offset;",
          "2880:                 e->timestamp = current_dts;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2883:                 if (size > 0x3FFFFFFF) {",
          "2884:                     av_log(mov->fc, AV_LOG_ERROR, \"Sample size %u is too large\\n\", size);",
          "2885:                     return;",
          "2886:                 }",
          "",
          "---------------"
        ]
      }
    }
  ]
}