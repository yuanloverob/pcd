{
  "cve_id": "CVE-2019-19925",
  "cve_desc": "zipfileUpdate in ext/misc/zipfile.c in SQLite 3.30.1 mishandles a NULL pathname during an update of a ZIP archive.",
  "repo": "sqlite/sqlite",
  "patch_hash": "54d501092d88c0cf89bec4279951f548fb0b8618",
  "patch_info": {
    "commit_hash": "54d501092d88c0cf89bec4279951f548fb0b8618",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/54d501092d88c0cf89bec4279951f548fb0b8618",
    "files": [
      "ext/misc/zipfile.c",
      "manifest",
      "manifest.uuid",
      "test/zipfile.test"
    ],
    "message": "Fix the zipfile extension so that INSERT works even if the pathname of the file being inserted is a NULL.  Bug discovered by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: a80f84b511231204658304226de3e075a55afc2e3f39ac063716f7a57f585c06",
    "before_after_code_files": [
      "ext/misc/zipfile.c||ext/misc/zipfile.c",
      "manifest.uuid||manifest.uuid",
      "test/zipfile.test||test/zipfile.test"
    ]
  },
  "patch_diff": {
    "ext/misc/zipfile.c||ext/misc/zipfile.c": [
      "File: ext/misc/zipfile.c -> ext/misc/zipfile.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1620:     if( rc==SQLITE_OK ){",
      "1621:       zPath = (const char*)sqlite3_value_text(apVal[2]);",
      "1622:       nPath = (int)strlen(zPath);",
      "1623:       mTime = zipfileGetTime(apVal[4]);",
      "1624:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1622:       if( zPath==0 ) zPath = \"\";",
      "",
      "---------------"
    ],
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: fccfb8a9ed3c1df9f23762bb8df6fdf36a21118899e3fae41f451169a5f2c08e",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "test/zipfile.test||test/zipfile.test": [
      "File: test/zipfile.test -> test/zipfile.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "795:   } {. ./x1.txt ./x2.txt}",
      "796: }",
      "798: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "798: # 2019-12-18 Yongheng and Rui fuzzer",
      "799: #",
      "800: do_execsql_test 13.10 {",
      "801:   DROP TABLE IF EXISTS t0;",
      "802:   DROP TABLE IF EXISTS t1;",
      "803:   CREATE TABLE t0(a,b,c,d,e,f,g);",
      "804:   REPLACE INTO t0(c,b,f) VALUES(10,10,10);",
      "805:   CREATE VIRTUAL TABLE t1 USING zipfile('h.zip');",
      "806:   REPLACE INTO t1 SELECT * FROM t0;",
      "807:   SELECT quote(name),quote(mode),quote(mtime),quote(sz),quote(rawdata),",
      "808:          quote(data),quote(method) FROM t1;",
      "809: } {'' 10 10 2 X'3130' X'3130' 0}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "65c29fd3ebd4e64e12dbdb5d540d417b50c25a69",
      "candidate_info": {
        "commit_hash": "65c29fd3ebd4e64e12dbdb5d540d417b50c25a69",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/65c29fd3ebd4e64e12dbdb5d540d417b50c25a69",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "In the CLI, code the \"sqlite_parameters\" name directly rather than using a macro, for clarity of presentation for users who are reading the code for the purpose of seeing how the CLI implements parameter binding.\n\nFossilOrigin-Name: e775ef002dd33e6bcbeec8d4b6ad7f59749e35548c7a59c9fa3bcfdc5cc50730",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 9b20ee10ff86c1f79706180310e02b6f78863e02b179062d8966573ae33a252f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "2747: #endif",
          "2748: }",
          "2754: static void bind_table_init(ShellState *p){",
          "2755:   int wrSchema = 0;",
          "2756:   sqlite3_db_config(p->db, SQLITE_DBCONFIG_WRITABLE_SCHEMA, -1, &wrSchema);",
          "2757:   sqlite3_db_config(p->db, SQLITE_DBCONFIG_WRITABLE_SCHEMA, 1, 0);",
          "2758:   sqlite3_exec(p->db,",
          "2760:     \"  key TEXT PRIMARY KEY,\\n\"",
          "2761:     \"  value ANY\\n\"",
          "2762:     \") WITHOUT ROWID;\",",
          "",
          "[Removed Lines]",
          "2751: #define BIND_PARAM_TABLE \"sqlite_parameters\"",
          "2759:     \"CREATE TABLE IF NOT EXISTS temp.\" BIND_PARAM_TABLE \"(\\n\"",
          "",
          "[Added Lines]",
          "2756:     \"CREATE TABLE IF NOT EXISTS temp.sqlite_parameters(\\n\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2785:   nVar = sqlite3_bind_parameter_count(pStmt);",
          "2788:                                     \"key\", 0, 0, 0, 0, 0)!=SQLITE_OK ){",
          "2790:   }",
          "2791:   rc = sqlite3_prepare_v2(pArg->db,",
          "2793:           \" WHERE key=?1\", -1, &pQ, 0);",
          "2794:   if( rc || pQ==0 ) return;",
          "2795:   for(i=1; i<=nVar; i++){",
          "",
          "[Removed Lines]",
          "2787:   if( sqlite3_table_column_metadata(pArg->db, \"TEMP\", BIND_PARAM_TABLE,",
          "2792:           \"SELECT value FROM temp.\" BIND_PARAM_TABLE",
          "",
          "[Added Lines]",
          "2784:   if( sqlite3_table_column_metadata(pArg->db, \"TEMP\", \"sqlite_parameters\",",
          "2789:           \"SELECT value FROM temp.sqlite_parameters\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "7149:       int wrSchema = 0;",
          "7150:       sqlite3_db_config(p->db, SQLITE_DBCONFIG_WRITABLE_SCHEMA, -1, &wrSchema);",
          "7151:       sqlite3_db_config(p->db, SQLITE_DBCONFIG_WRITABLE_SCHEMA, 1, 0);",
          "7153:                    0, 0, 0);",
          "7154:       sqlite3_db_config(p->db, SQLITE_DBCONFIG_WRITABLE_SCHEMA, wrSchema, 0);",
          "7155:     }else",
          "",
          "[Removed Lines]",
          "7152:       sqlite3_exec(p->db, \"DROP TABLE IF EXISTS temp.\" BIND_PARAM_TABLE \";\",",
          "",
          "[Added Lines]",
          "7149:       sqlite3_exec(p->db, \"DROP TABLE IF EXISTS temp.sqlite_parameters;\",",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "7163:       int len = 0;",
          "7164:       rx = sqlite3_prepare_v2(p->db,",
          "7165:              \"SELECT max(length(key)) \"",
          "7167:       if( rx==SQLITE_OK && sqlite3_step(pStmt)==SQLITE_ROW ){",
          "7168:         len = sqlite3_column_int(pStmt, 0);",
          "7169:         if( len>40 ) len = 40;",
          "",
          "[Removed Lines]",
          "7166:              \"FROM temp.\" BIND_PARAM_TABLE \";\", -1, &pStmt, 0);",
          "",
          "[Added Lines]",
          "7163:              \"FROM temp.sqlite_parameters;\", -1, &pStmt, 0);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "7173:       if( len ){",
          "7174:         rx = sqlite3_prepare_v2(p->db,",
          "7175:              \"SELECT key, quote(value) \"",
          "7177:         while( sqlite3_step(pStmt)==SQLITE_ROW ){",
          "7178:           utf8_printf(p->out, \"%-*s %s\\n\", len, sqlite3_column_text(pStmt,0),",
          "7179:                       sqlite3_column_text(pStmt,1));",
          "",
          "[Removed Lines]",
          "7176:              \"FROM temp.\" BIND_PARAM_TABLE \";\", -1, &pStmt, 0);",
          "",
          "[Added Lines]",
          "7173:              \"FROM temp.sqlite_parameters;\", -1, &pStmt, 0);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "7204:       const char *zValue = azArg[3];",
          "7205:       bind_table_init(p);",
          "7206:       zSql = sqlite3_mprintf(",
          "7208:                   \"VALUES(%Q,%s);\", zKey, zValue);",
          "7209:       if( zSql==0 ) shell_out_of_memory();",
          "7210:       pStmt = 0;",
          "",
          "[Removed Lines]",
          "7207:                   \"REPLACE INTO temp.\" BIND_PARAM_TABLE \"(key,value)\"",
          "",
          "[Added Lines]",
          "7204:                   \"REPLACE INTO temp.sqlite_parameters(key,value)\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "7214:         sqlite3_finalize(pStmt);",
          "7215:         pStmt = 0;",
          "7216:         zSql = sqlite3_mprintf(",
          "7218:                    \"VALUES(%Q,%Q);\", zKey, zValue);",
          "7219:         if( zSql==0 ) shell_out_of_memory();",
          "7220:         rx = sqlite3_prepare_v2(p->db, zSql, -1, &pStmt, 0);",
          "",
          "[Removed Lines]",
          "7217:                    \"REPLACE INTO temp.\" BIND_PARAM_TABLE \"(key,value)\"",
          "",
          "[Added Lines]",
          "7214:                    \"REPLACE INTO temp.sqlite_parameters(key,value)\"",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "7237:     if( nArg==3 && strcmp(azArg[1],\"unset\")==0 ){",
          "7238:       char *zSql = sqlite3_mprintf(",
          "7240:       if( zSql==0 ) shell_out_of_memory();",
          "7241:       sqlite3_exec(p->db, zSql, 0, 0, 0);",
          "7242:       sqlite3_free(zSql);",
          "",
          "[Removed Lines]",
          "7239:           \"DELETE FROM temp.\" BIND_PARAM_TABLE \" WHERE key=%Q\", azArg[2]);",
          "",
          "[Added Lines]",
          "7236:           \"DELETE FROM temp.sqlite_parameters WHERE key=%Q\", azArg[2]);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "29e780068b7ffde99f105282fd170de8d94af9b3",
      "candidate_info": {
        "commit_hash": "29e780068b7ffde99f105282fd170de8d94af9b3",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/29e780068b7ffde99f105282fd170de8d94af9b3",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vacuum.c"
        ],
        "message": "Make no atttempt to generate VDBE code for VACUUM after a syntax error.\n\nFossilOrigin-Name: 930842470da27d72650033ef2c1df413e70f7c40eb46f91027b35f5ee156af38",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vacuum.c||src/vacuum.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 4258e42d92b0113ba59f407197fc24f21734900e5b02952deed07818be3e3e5d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vacuum.c||src/vacuum.c": [
          "File: src/vacuum.c -> src/vacuum.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:   Vdbe *v = sqlite3GetVdbe(pParse);",
          "107:   int iDb = 0;",
          "108:   if( v==0 ) goto build_vacuum_end;",
          "109:   if( pNm ){",
          "110: #ifndef SQLITE_BUG_COMPATIBLE_20160819",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "109:   if( pParse->nErr ) goto build_vacuum_end;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a2dc7494ef94292c30316626d89336d41e134692",
      "candidate_info": {
        "commit_hash": "a2dc7494ef94292c30316626d89336d41e134692",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/a2dc7494ef94292c30316626d89336d41e134692",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/fts3corrupt4.test"
        ],
        "message": "Indicate that the database may be corrupt in the fts3corrupt4.test test script.\n\nFossilOrigin-Name: 473626d5579dd19023abccaf7c1822ac0c883a0b98904837ea096fa16e4f41c4",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/fts3corrupt4.test||test/fts3corrupt4.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b49d56a0faf012978c50fb8662125ea21bdf5054fddf5975644cbc941c153e70",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/fts3corrupt4.test||test/fts3corrupt4.test": [
          "File: test/fts3corrupt4.test -> test/fts3corrupt4.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "253: #-------------------------------------------------------------------------",
          "254: reset_db",
          "255: do_execsql_test 6.0 {",
          "256:   CREATE VIRTUAL TABLE Table0 USING fts3();",
          "257:   INSERT INTO Table0_segdir VALUES(1,NULL,1,NULL,NULL,NULL);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "255: database_may_be_corrupt",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ee3fa87fd7ca53713cffb9ff662a61f797b760d",
      "candidate_info": {
        "commit_hash": "6ee3fa87fd7ca53713cffb9ff662a61f797b760d",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/6ee3fa87fd7ca53713cffb9ff662a61f797b760d",
        "files": [
          "manifest",
          "manifest.uuid",
          "tool/lempar.c"
        ],
        "message": "Fix an unreachable branch in sqlite3ParserFallback()\n\nFossilOrigin-Name: e059178b47109caee2c2211b2db6e594c014af636677118a64e10edf01ac017d",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "tool/lempar.c||tool/lempar.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 47d3e091ae49eb7947af5abef9b5b96b16b86d349e51fe0677795649be6db473",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "tool/lempar.c||tool/lempar.c": [
          "File: tool/lempar.c -> tool/lempar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1065: int ParseFallback(int iToken){",
          "1066: #ifdef YYFALLBACK",
          "1070: #else",
          "1071:   (void)iToken;",
          "1072: #endif",
          "",
          "[Removed Lines]",
          "1067:   if( iToken<(int)(sizeof(yyFallback)/sizeof(yyFallback[0])) ){",
          "1068:     return yyFallback[iToken];",
          "1069:   }",
          "",
          "[Added Lines]",
          "1067:   assert( iToken<(int)(sizeof(yyFallback)/sizeof(yyFallback[0])) );",
          "1068:   return yyFallback[iToken];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7d683394f1d27561cbf22c56e3c6be2413f1eb5d",
      "candidate_info": {
        "commit_hash": "7d683394f1d27561cbf22c56e3c6be2413f1eb5d",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/7d683394f1d27561cbf22c56e3c6be2413f1eb5d",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbeInt.h",
          "src/vdbemem.c",
          "test/fuzzdata8.db"
        ],
        "message": "Fix a faulty assert() in the sqlite3VdbeMemExpandBlob() routine.\n\nFossilOrigin-Name: df58774e994bd306b1a2e1f259e7e4408f01c5b1dc104673698168bbf8a63ce5",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbeInt.h||src/vdbeInt.h",
          "src/vdbemem.c||src/vdbemem.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: edb095a9a679c8c702abd0a487e55ed4b09110b54bcd7d5275020576f2713a39",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbeInt.h||src/vdbeInt.h": [
          "File: src/vdbeInt.h -> src/vdbeInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "282: #define MemSetTypeFlag(p, f) \\",
          "283:    ((p)->flags = ((p)->flags&~(MEM_TypeMask|MEM_Zero))|f)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "288: #define MemNullNochng(X) \\",
          "289:   ((X)->flags==(MEM_Null|MEM_Zero) && (X)->n==0 && (X)->u.nZero==0)",
          "",
          "---------------"
        ],
        "src/vdbemem.c||src/vdbemem.c": [
          "File: src/vdbemem.c -> src/vdbemem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "196:   testcase( bPreserve && pMem->z==0 );",
          "198:   assert( pMem->szMalloc==0",
          "",
          "[Removed Lines]",
          "195:   assert( bPreserve==0 || pMem->flags&(MEM_Blob|MEM_Str) );",
          "",
          "[Added Lines]",
          "195:   assert( bPreserve==0",
          "196:        || pMem->flags&(MEM_Blob|MEM_Str)",
          "197:        || MemNullNochng(pMem)",
          "198:   );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "298: int sqlite3VdbeMemExpandBlob(Mem *pMem){",
          "299:   int nByte;",
          "300:   assert( pMem->flags & MEM_Zero );",
          "302:   assert( !sqlite3VdbeMemIsRowSet(pMem) );",
          "303:   assert( pMem->db==0 || sqlite3_mutex_held(pMem->db->mutex) );",
          "",
          "[Removed Lines]",
          "301:   assert( pMem->flags&MEM_Blob );",
          "",
          "[Added Lines]",
          "304:   assert( (pMem->flags&MEM_Blob)!=0 || MemNullNochng(pMem) );",
          "305:   testcase( MemNullNochng(pMem) )",
          "",
          "---------------"
        ]
      }
    }
  ]
}