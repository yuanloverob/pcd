{
  "cve_id": "CVE-2019-20422",
  "cve_desc": "In the Linux kernel before 5.3.4, fib6_rule_lookup in net/ipv6/ip6_fib.c mishandles the RT6_LOOKUP_F_DST_NOREF flag in a reference-count decision, leading to (for example) a crash that was identified by syzkaller, aka CID-7b09c2d052db.",
  "repo": "torvalds/linux",
  "patch_hash": "7b09c2d052db4b4ad0b27b97918b46a7746966fa",
  "patch_info": {
    "commit_hash": "7b09c2d052db4b4ad0b27b97918b46a7746966fa",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/7b09c2d052db4b4ad0b27b97918b46a7746966fa",
    "files": [
      "net/ipv6/ip6_fib.c"
    ],
    "message": "ipv6: fix a typo in fib6_rule_lookup()\n\nYi Ren reported an issue discovered by syzkaller, and bisected\nto the cited commit.\n\nMany thanks to Yi, this trivial patch does not reflect the patient\nwork that has been done.\n\nFixes: d64a1f574a29 (\"ipv6: honor RT6_LOOKUP_F_DST_NOREF in rule lookup logic\")\nSigned-off-by: Eric Dumazet <edumazet@google.com>\nAcked-by: Wei Wang <weiwan@google.com>\nBisected-and-reported-by: Yi Ren <c4tren@gmail.com>\nSigned-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>",
    "before_after_code_files": [
      "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c"
    ]
  },
  "patch_diff": {
    "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c": [
      "File: net/ipv6/ip6_fib.c -> net/ipv6/ip6_fib.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "318:  if (rt->dst.error == -EAGAIN) {",
      "319:   ip6_rt_put_flags(rt, flags);",
      "320:   rt = net->ipv6.ip6_null_entry;",
      "322:    dst_hold(&rt->dst);",
      "323:  }",
      "",
      "[Removed Lines]",
      "321:   if (!(flags | RT6_LOOKUP_F_DST_NOREF))",
      "",
      "[Added Lines]",
      "321:   if (!(flags & RT6_LOOKUP_F_DST_NOREF))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d64a1f574a2957b4bcb06452d36cc1c6bf16e9fc",
      "candidate_info": {
        "commit_hash": "d64a1f574a2957b4bcb06452d36cc1c6bf16e9fc",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/d64a1f574a2957b4bcb06452d36cc1c6bf16e9fc",
        "files": [
          "include/net/ip6_route.h",
          "net/ipv6/fib6_rules.c",
          "net/ipv6/ip6_fib.c"
        ],
        "message": "ipv6: honor RT6_LOOKUP_F_DST_NOREF in rule lookup logic\n\nThis patch specifically converts the rule lookup logic to honor this\nflag and not release refcnt when traversing each rule and calling\nlookup() on each routing table.\nSimilar to previous patch, we also need some special handling of dst\nentries in uncached list because there is always 1 refcnt taken for them\neven if RT6_LOOKUP_F_DST_NOREF flag is set.\n\nSigned-off-by: Wei Wang <weiwan@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "include/net/ip6_route.h||include/net/ip6_route.h",
          "net/ipv6/fib6_rules.c||net/ipv6/fib6_rules.c",
          "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c"
          ],
          "candidate": [
            "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c"
          ]
        }
      },
      "candidate_diff": {
        "include/net/ip6_route.h||include/net/ip6_route.h": [
          "File: include/net/ip6_route.h -> include/net/ip6_route.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "94:  return ip6_route_output_flags(net, sk, fl6, 0);",
          "95: }",
          "97: struct dst_entry *ip6_route_lookup(struct net *net, struct flowi6 *fl6,",
          "98:        const struct sk_buff *skb, int flags);",
          "99: struct rt6_info *ip6_pol_route(struct net *net, struct fib6_table *table,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "100: static inline void ip6_rt_put_flags(struct rt6_info *rt, int flags)",
          "101: {",
          "102:  if (!(flags & RT6_LOOKUP_F_DST_NOREF) ||",
          "103:      !list_empty(&rt->rt6i_uncached))",
          "104:   ip6_rt_put(rt);",
          "105: }",
          "",
          "---------------"
        ],
        "net/ipv6/fib6_rules.c||net/ipv6/fib6_rules.c": [
          "File: net/ipv6/fib6_rules.c -> net/ipv6/fib6_rules.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "113:   rt = lookup(net, net->ipv6.fib6_local_tbl, fl6, skb, flags);",
          "114:   if (rt != net->ipv6.ip6_null_entry && rt->dst.error != -EAGAIN)",
          "115:    return &rt->dst;",
          "117:   rt = lookup(net, net->ipv6.fib6_main_tbl, fl6, skb, flags);",
          "118:   if (rt->dst.error != -EAGAIN)",
          "119:    return &rt->dst;",
          "121:  }",
          "124:  return &net->ipv6.ip6_null_entry->dst;",
          "125: }",
          "",
          "[Removed Lines]",
          "116:   ip6_rt_put(rt);",
          "120:   ip6_rt_put(rt);",
          "123:  dst_hold(&net->ipv6.ip6_null_entry->dst);",
          "",
          "[Added Lines]",
          "116:   ip6_rt_put_flags(rt, flags);",
          "120:   ip6_rt_put_flags(rt, flags);",
          "123:  if (!(flags & RT6_LOOKUP_F_DST_NOREF))",
          "124:   dst_hold(&net->ipv6.ip6_null_entry->dst);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "237:    goto out;",
          "238:  }",
          "239: again:",
          "241:  err = -EAGAIN;",
          "242:  rt = NULL;",
          "243:  goto out;",
          "245: discard_pkt:",
          "247: out:",
          "248:  res->rt6 = rt;",
          "249:  return err;",
          "",
          "[Removed Lines]",
          "240:  ip6_rt_put(rt);",
          "246:  dst_hold(&rt->dst);",
          "",
          "[Added Lines]",
          "241:  ip6_rt_put_flags(rt, flags);",
          "247:  if (!(flags & RT6_LOOKUP_F_DST_NOREF))",
          "248:   dst_hold(&rt->dst);",
          "",
          "---------------"
        ],
        "net/ipv6/ip6_fib.c||net/ipv6/ip6_fib.c": [
          "File: net/ipv6/ip6_fib.c -> net/ipv6/ip6_fib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "317:  rt = lookup(net, net->ipv6.fib6_main_tbl, fl6, skb, flags);",
          "318:  if (rt->dst.error == -EAGAIN) {",
          "320:   rt = net->ipv6.ip6_null_entry;",
          "322:  }",
          "324:  return &rt->dst;",
          "",
          "[Removed Lines]",
          "319:   ip6_rt_put(rt);",
          "321:   dst_hold(&rt->dst);",
          "",
          "[Added Lines]",
          "319:   ip6_rt_put_flags(rt, flags);",
          "321:   if (!(flags | RT6_LOOKUP_F_DST_NOREF))",
          "322:    dst_hold(&rt->dst);",
          "",
          "---------------"
        ]
      }
    }
  ]
}