{
  "cve_id": "CVE-2021-37639",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. When restoring tensors via raw APIs, if the tensor name is not provided, TensorFlow can be tricked into dereferencing a null pointer. Alternatively, attackers can read memory outside the bounds of heap allocated data by providing some tensor names but not enough for a successful restoration. The [implementation](https://github.com/tensorflow/tensorflow/blob/47a06f40411a69c99f381495f490536972152ac0/tensorflow/core/kernels/save_restore_tensor.cc#L158-L159) retrieves the tensor list corresponding to the `tensor_name` user controlled input and immediately retrieves the tensor at the restoration index (controlled via `preferred_shard` argument). This occurs without validating that the provided list has enough values. If the list is empty this results in dereferencing a null pointer (undefined behavior). If, however, the list has some elements, if the restoration index is outside the bounds this results in heap OOB read. We have patched the issue in GitHub commit 9e82dce6e6bd1f36a57e08fa85af213e2b2f2622. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "9e82dce6e6bd1f36a57e08fa85af213e2b2f2622",
  "patch_info": {
    "commit_hash": "9e82dce6e6bd1f36a57e08fa85af213e2b2f2622",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/9e82dce6e6bd1f36a57e08fa85af213e2b2f2622",
    "files": [
      "tensorflow/core/kernels/save_restore_tensor.cc"
    ],
    "message": "Fix NPE in restoring code.\n\nPiperOrigin-RevId: 388303253\nChange-Id: Ia8c68568cb854bca538909a182b31a618d68ce55",
    "before_after_code_files": [
      "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc": [
      "File: tensorflow/core/kernels/save_restore_tensor.cc -> tensorflow/core/kernels/save_restore_tensor.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "151:         context, size == 1,",
      "152:         errors::InvalidArgument(",
      "153:             \"Input 0 (file_pattern) must be a string scalar; got a tensor of \",",
      "155:   }",
      "156:   const string& file_pattern = file_pattern_t.flat<tstring>()(0);",
      "158:   const Tensor& tensor_name_t = context->input(1);",
      "159:   const string& tensor_name = tensor_name_t.flat<tstring>()(restore_index);",
      "",
      "[Removed Lines]",
      "154:             size, \"elements\"));",
      "",
      "[Added Lines]",
      "154:             size, \" elements\"));",
      "159:   {",
      "160:     const int64_t size = tensor_name_t.NumElements();",
      "161:     OP_REQUIRES(context, size > restore_index,",
      "162:                 errors::InvalidArgument(",
      "163:                     \"Input 1 (file_pattern) must be a have at least \",",
      "164:                     restore_index + 1, \" elements\"));",
      "165:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "30ae9295359a81ebbbd12f49bf18cc8bb5a458d2",
      "candidate_info": {
        "commit_hash": "30ae9295359a81ebbbd12f49bf18cc8bb5a458d2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/30ae9295359a81ebbbd12f49bf18cc8bb5a458d2",
        "files": [
          "tensorflow/core/kernels/save_restore_tensor.cc"
        ],
        "message": "Fix NPE in restoring code.\n\nPiperOrigin-RevId: 388303253\nChange-Id: Ia8c68568cb854bca538909a182b31a618d68ce55",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc": [
          "File: tensorflow/core/kernels/save_restore_tensor.cc -> tensorflow/core/kernels/save_restore_tensor.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:         context, size == 1,",
          "152:         errors::InvalidArgument(",
          "153:             \"Input 0 (file_pattern) must be a string scalar; got a tensor of \",",
          "155:   }",
          "156:   const string& file_pattern = file_pattern_t.flat<tstring>()(0);",
          "158:   const Tensor& tensor_name_t = context->input(1);",
          "159:   const string& tensor_name = tensor_name_t.flat<tstring>()(restore_index);",
          "",
          "[Removed Lines]",
          "154:             size, \"elements\"));",
          "",
          "[Added Lines]",
          "154:             size, \" elements\"));",
          "159:   {",
          "160:     const int64_t size = tensor_name_t.NumElements();",
          "161:     OP_REQUIRES(context, size > restore_index,",
          "162:                 errors::InvalidArgument(",
          "163:                     \"Input 1 (file_pattern) must be a have at least \",",
          "164:                     restore_index + 1, \" elements\"));",
          "165:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3e82d1113d4e005694f6bc9a637c06585ca063a2",
      "candidate_info": {
        "commit_hash": "3e82d1113d4e005694f6bc9a637c06585ca063a2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3e82d1113d4e005694f6bc9a637c06585ca063a2",
        "files": [
          "tensorflow/core/kernels/save_restore_tensor.cc"
        ],
        "message": "Fix NPE in restoring code.\n\nPiperOrigin-RevId: 388303253\nChange-Id: Ia8c68568cb854bca538909a182b31a618d68ce55",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc": [
          "File: tensorflow/core/kernels/save_restore_tensor.cc -> tensorflow/core/kernels/save_restore_tensor.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:         context, size == 1,",
          "152:         errors::InvalidArgument(",
          "153:             \"Input 0 (file_pattern) must be a string scalar; got a tensor of \",",
          "155:   }",
          "156:   const string& file_pattern = file_pattern_t.flat<tstring>()(0);",
          "158:   const Tensor& tensor_name_t = context->input(1);",
          "159:   const string& tensor_name = tensor_name_t.flat<tstring>()(restore_index);",
          "",
          "[Removed Lines]",
          "154:             size, \"elements\"));",
          "",
          "[Added Lines]",
          "154:             size, \" elements\"));",
          "159:   {",
          "160:     const int64_t size = tensor_name_t.NumElements();",
          "161:     OP_REQUIRES(context, size > restore_index,",
          "162:                 errors::InvalidArgument(",
          "163:                     \"Input 1 (file_pattern) must be a have at least \",",
          "164:                     restore_index + 1, \" elements\"));",
          "165:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "575ad42ad406994f2c1df60d79795a96d7091305",
      "candidate_info": {
        "commit_hash": "575ad42ad406994f2c1df60d79795a96d7091305",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/575ad42ad406994f2c1df60d79795a96d7091305",
        "files": [
          "tensorflow/core/kernels/save_restore_tensor.cc"
        ],
        "message": "Fix NPE in restoring code.\n\nPiperOrigin-RevId: 388303253\nChange-Id: Ia8c68568cb854bca538909a182b31a618d68ce55",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc": [
          "File: tensorflow/core/kernels/save_restore_tensor.cc -> tensorflow/core/kernels/save_restore_tensor.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:         context, size == 1,",
          "152:         errors::InvalidArgument(",
          "153:             \"Input 0 (file_pattern) must be a string scalar; got a tensor of \",",
          "155:   }",
          "156:   const string& file_pattern = file_pattern_t.flat<tstring>()(0);",
          "158:   const Tensor& tensor_name_t = context->input(1);",
          "159:   const string& tensor_name = tensor_name_t.flat<tstring>()(restore_index);",
          "",
          "[Removed Lines]",
          "154:             size, \"elements\"));",
          "",
          "[Added Lines]",
          "154:             size, \" elements\"));",
          "159:   {",
          "160:     const int64_t size = tensor_name_t.NumElements();",
          "161:     OP_REQUIRES(context, size > restore_index,",
          "162:                 errors::InvalidArgument(",
          "163:                     \"Input 1 (file_pattern) must be a have at least \",",
          "164:                     restore_index + 1, \" elements\"));",
          "165:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6fbb40b18c90feebaff6e16853b3db5490a07a8b",
      "candidate_info": {
        "commit_hash": "6fbb40b18c90feebaff6e16853b3db5490a07a8b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6fbb40b18c90feebaff6e16853b3db5490a07a8b",
        "files": [
          "tensorflow/core/kernels/save_restore_tensor.cc"
        ],
        "message": "Fix NPE in restoring code.\n\nPiperOrigin-RevId: 388303253\nChange-Id: Ia8c68568cb854bca538909a182b31a618d68ce55",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_tensor.cc||tensorflow/core/kernels/save_restore_tensor.cc": [
          "File: tensorflow/core/kernels/save_restore_tensor.cc -> tensorflow/core/kernels/save_restore_tensor.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "151:         context, size == 1,",
          "152:         errors::InvalidArgument(",
          "153:             \"Input 0 (file_pattern) must be a string scalar; got a tensor of \",",
          "155:   }",
          "156:   const string& file_pattern = file_pattern_t.flat<tstring>()(0);",
          "158:   const Tensor& tensor_name_t = context->input(1);",
          "159:   const string& tensor_name = tensor_name_t.flat<tstring>()(restore_index);",
          "",
          "[Removed Lines]",
          "154:             size, \"elements\"));",
          "",
          "[Added Lines]",
          "154:             size, \" elements\"));",
          "159:   {",
          "160:     const int64_t size = tensor_name_t.NumElements();",
          "161:     OP_REQUIRES(context, size > restore_index,",
          "162:                 errors::InvalidArgument(",
          "163:                     \"Input 1 (file_pattern) must be a have at least \",",
          "164:                     restore_index + 1, \" elements\"));",
          "165:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}