{
  "cve_id": "CVE-2014-9059",
  "cve_desc": "lib/setup.php in Moodle through 2.4.11, 2.5.x before 2.5.9, 2.6.x before 2.6.6, and 2.7.x before 2.7.3 does not provide charset information in HTTP headers, which might allow remote attackers to conduct cross-site scripting (XSS) attacks via UTF-7 characters during interaction with AJAX scripts.",
  "repo": "moodle/moodle",
  "patch_hash": "3c98b7a5ad1bb596a738e550fc3bf966d6415fe0",
  "patch_info": {
    "commit_hash": "3c98b7a5ad1bb596a738e550fc3bf966d6415fe0",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/3c98b7a5ad1bb596a738e550fc3bf966d6415fe0",
    "files": [
      "lib/setup.php"
    ],
    "message": "MDL-47966 Add default content type and encoding",
    "before_after_code_files": [
      "lib/setup.php||lib/setup.php"
    ]
  },
  "patch_diff": {
    "lib/setup.php||lib/setup.php": [
      "File: lib/setup.php -> lib/setup.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "772: }",
      "773: \\core\\session\\manager::start();",
      "776: if (!isset($CFG->filelifetime)) {",
      "777:     $CFG->filelifetime = 60*60*6;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "778: if (AJAX_SCRIPT) {",
      "779:     if (!core_useragent::supports_json_contenttype()) {",
      "781:         @header('Content-type: text/plain; charset=utf-8');",
      "782:         @header('X-Content-Type-Options: nosniff');",
      "783:     } else if (!empty($_FILES)) {",
      "785:         @header('Content-type: text/plain; charset=utf-8');",
      "786:     } else {",
      "787:         @header('Content-type: application/json; charset=utf-8');",
      "788:     }",
      "789: } else if (!CLI_SCRIPT) {",
      "790:     @header('Content-type: text/html; charset=utf-8');",
      "791: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ac6e453d11024bf6ad99ada1bfc641c6b91ebed6",
      "candidate_info": {
        "commit_hash": "ac6e453d11024bf6ad99ada1bfc641c6b91ebed6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ac6e453d11024bf6ad99ada1bfc641c6b91ebed6",
        "files": [
          "lib/setup.php"
        ],
        "message": "MDL-47966 Add default content type and encoding",
        "before_after_code_files": [
          "lib/setup.php||lib/setup.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setup.php||lib/setup.php"
          ],
          "candidate": [
            "lib/setup.php||lib/setup.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setup.php||lib/setup.php": [
          "File: lib/setup.php -> lib/setup.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "774: }",
          "775: \\core\\session\\manager::start();",
          "778: if (!isset($CFG->filelifetime)) {",
          "779:     $CFG->filelifetime = 60*60*6;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "780: if (AJAX_SCRIPT) {",
          "781:     if (!core_useragent::supports_json_contenttype()) {",
          "783:         @header('Content-type: text/plain; charset=utf-8');",
          "784:         @header('X-Content-Type-Options: nosniff');",
          "785:     } else if (!empty($_FILES)) {",
          "787:         @header('Content-type: text/plain; charset=utf-8');",
          "788:     } else {",
          "789:         @header('Content-type: application/json; charset=utf-8');",
          "790:     }",
          "791: } else if (!CLI_SCRIPT) {",
          "792:     @header('Content-type: text/html; charset=utf-8');",
          "793: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0a0145c5e8041aadeff303a9f9984c86706b4e42",
      "candidate_info": {
        "commit_hash": "0a0145c5e8041aadeff303a9f9984c86706b4e42",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0a0145c5e8041aadeff303a9f9984c86706b4e42",
        "files": [
          "lib/setup.php"
        ],
        "message": "MDL-47966 Add default content type and encoding",
        "before_after_code_files": [
          "lib/setup.php||lib/setup.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setup.php||lib/setup.php"
          ],
          "candidate": [
            "lib/setup.php||lib/setup.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setup.php||lib/setup.php": [
          "File: lib/setup.php -> lib/setup.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "805: }",
          "806: \\core\\session\\manager::start();",
          "809: if (!isset($CFG->filelifetime)) {",
          "810:     $CFG->filelifetime = 60*60*6;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "811: if (AJAX_SCRIPT) {",
          "812:     if (!core_useragent::supports_json_contenttype()) {",
          "814:         @header('Content-type: text/plain; charset=utf-8');",
          "815:         @header('X-Content-Type-Options: nosniff');",
          "816:     } else if (!empty($_FILES)) {",
          "818:         @header('Content-type: text/plain; charset=utf-8');",
          "819:     } else {",
          "820:         @header('Content-type: application/json; charset=utf-8');",
          "821:     }",
          "822: } else if (!CLI_SCRIPT) {",
          "823:     @header('Content-type: text/html; charset=utf-8');",
          "824: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "293e4bbcb71f0a801c2539ea051c58688314b23a",
      "candidate_info": {
        "commit_hash": "293e4bbcb71f0a801c2539ea051c58688314b23a",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/293e4bbcb71f0a801c2539ea051c58688314b23a",
        "files": [
          "lib/setup.php"
        ],
        "message": "MDL-47966 Add default content type and encoding",
        "before_after_code_files": [
          "lib/setup.php||lib/setup.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "lib/setup.php||lib/setup.php"
          ],
          "candidate": [
            "lib/setup.php||lib/setup.php"
          ]
        }
      },
      "candidate_diff": {
        "lib/setup.php||lib/setup.php": [
          "File: lib/setup.php -> lib/setup.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "798: $SESSION = &$_SESSION['SESSION'];",
          "799: $USER    = &$_SESSION['USER'];",
          "802: if (!empty($CFG->profilingenabled)) {",
          "803:     require_once($CFG->libdir . '/xhprof/xhprof_moodle.php');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "804: if (AJAX_SCRIPT) {",
          "805:     $supportsjsoncontenttype = !check_browser_version('MSIE') ||",
          "806:         (check_browser_version('MSIE', 8) &&",
          "807:             !(preg_match(\"/MSIE 7.0/\", $_SERVER['HTTP_USER_AGENT']) && preg_match(\"/Trident\\/([0-9\\.]+)/\", $_SERVER['HTTP_USER_AGENT'])));",
          "808:     if (!$supportsjsoncontenttype) {",
          "810:         @header('Content-type: text/plain; charset=utf-8');",
          "811:         @header('X-Content-Type-Options: nosniff');",
          "812:     } else if (!empty($_FILES)) {",
          "814:         @header('Content-type: text/plain; charset=utf-8');",
          "815:     } else {",
          "816:         @header('Content-type: application/json; charset=utf-8');",
          "817:     }",
          "818: } else if (!CLI_SCRIPT) {",
          "819:     @header('Content-type: text/html; charset=utf-8');",
          "820: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}