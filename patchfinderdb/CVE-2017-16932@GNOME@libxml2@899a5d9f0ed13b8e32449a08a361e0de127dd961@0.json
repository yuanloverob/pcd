{
  "cve_id": "CVE-2017-16932",
  "cve_desc": "parser.c in libxml2 before 2.9.5 does not prevent infinite recursion in parameter entities.",
  "repo": "GNOME/libxml2",
  "patch_hash": "899a5d9f0ed13b8e32449a08a361e0de127dd961",
  "patch_info": {
    "commit_hash": "899a5d9f0ed13b8e32449a08a361e0de127dd961",
    "repo": "GNOME/libxml2",
    "commit_url": "https://github.com/GNOME/libxml2/commit/899a5d9f0ed13b8e32449a08a361e0de127dd961",
    "files": [
      "parser.c",
      "result/errors/759579.xml",
      "result/errors/759579.xml.err",
      "result/errors/759579.xml.str",
      "test/errors/759579.xml"
    ],
    "message": "Detect infinite recursion in parameter entities\n\nWhen expanding a parameter entity in a DTD, infinite recursion could\nlead to an infinite loop or memory exhaustion.\n\nThanks to Wei Lei for the first of many reports.\n\nFixes bug 759579.",
    "before_after_code_files": [
      "parser.c||parser.c",
      "result/errors/759579.xml.err||result/errors/759579.xml.err",
      "result/errors/759579.xml.str||result/errors/759579.xml.str"
    ]
  },
  "patch_diff": {
    "parser.c||parser.c": [
      "File: parser.c -> parser.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2250:  xmlGenericError(xmlGenericErrorContext,",
      "2251:   \"Pushing input %d : %.30s\\n\", ctxt->inputNr+1, input->cur);",
      "2252:     }",
      "2253:     ret = inputPush(ctxt, input);",
      "2254:     if (ctxt->instate == XML_PARSER_EOF)",
      "2255:         return(-1);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2253:     if (((ctxt->inputNr > 40) && ((ctxt->options & XML_PARSE_HUGE) == 0)) ||",
      "2254:         (ctxt->inputNr > 1024)) {",
      "2255:         xmlFatalErr(ctxt, XML_ERR_ENTITY_LOOP, NULL);",
      "2256:         while (ctxt->inputNr > 1)",
      "2257:             xmlFreeInputStream(inputPop(ctxt));",
      "2258:  return(-1);",
      "2259:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "7916:   return;",
      "7918:      input = xmlNewEntityInputStream(ctxt, entity);",
      "7920:   return;",
      "7922:      if (entity->etype == XML_EXTERNAL_PARAMETER_ENTITY) {",
      "",
      "[Removed Lines]",
      "7919:      if (xmlPushInput(ctxt, input) < 0)",
      "",
      "[Added Lines]",
      "7926:      if (xmlPushInput(ctxt, input) < 0) {",
      "7927:                 xmlFreeInputStream(input);",
      "7929:             }",
      "",
      "---------------"
    ],
    "result/errors/759579.xml.err||result/errors/759579.xml.err": [
      "File: result/errors/759579.xml.err -> result/errors/759579.xml.err",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: Entity: line 2: parser error : Detected an entity reference loop",
      "2:         %z; %z; %z; %z; %z;",
      "3:            ^",
      "4: Entity: line 2:",
      "5:         %z; %z; %z; %z; %z;",
      "6:            ^",
      "",
      "---------------"
    ],
    "result/errors/759579.xml.str||result/errors/759579.xml.str": [
      "File: result/errors/759579.xml.str -> result/errors/759579.xml.str",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: Entity: line 2: parser error : Detected an entity reference loop",
      "2:         %z; %z; %z; %z; %z;",
      "3:            ^",
      "4: Entity: line 2:",
      "5:         %z; %z; %z; %z; %z;",
      "6:            ^",
      "7: ./test/errors/759579.xml : failed to parse",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "90ccb58242866b0ba3edbef8fe44214a101c2b3e",
      "candidate_info": {
        "commit_hash": "90ccb58242866b0ba3edbef8fe44214a101c2b3e",
        "repo": "GNOME/libxml2",
        "commit_url": "https://github.com/GNOME/libxml2/commit/90ccb58242866b0ba3edbef8fe44214a101c2b3e",
        "files": [
          "parser.c"
        ],
        "message": "Prevent unwanted external entity reference\n\nFor https://bugzilla.gnome.org/show_bug.cgi?id=780691\n\n* parser.c: add a specific check to avoid PE reference",
        "before_after_code_files": [
          "parser.c||parser.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "parser.c||parser.c"
          ],
          "candidate": [
            "parser.c||parser.c"
          ]
        }
      },
      "candidate_diff": {
        "parser.c||parser.c": [
          "File: parser.c -> parser.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "8123:      if (xmlPushInput(ctxt, input) < 0)",
          "8124:   return;",
          "8125:  } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8126:      if ((entity->etype == XML_EXTERNAL_PARAMETER_ENTITY) &&",
          "8127:          ((ctxt->options & XML_PARSE_NOENT) == 0) &&",
          "8128:   ((ctxt->options & XML_PARSE_DTDVALID) == 0) &&",
          "8129:   ((ctxt->options & XML_PARSE_DTDLOAD) == 0) &&",
          "8130:   ((ctxt->options & XML_PARSE_DTDATTR) == 0) &&",
          "8131:   (ctxt->replaceEntities == 0) &&",
          "8132:   (ctxt->validate == 0))",
          "8133:   return;",
          "",
          "---------------"
        ]
      }
    }
  ]
}