{
  "cve_id": "CVE-2016-2329",
  "cve_desc": "libavcodec/tiff.c in FFmpeg before 2.8.6 does not properly validate RowsPerStrip values and YCbCr chrominance subsampling factors, which allows remote attackers to cause a denial of service (out-of-bounds array access) or possibly have unspecified other impact via a crafted TIFF file, related to the tiff_decode_tag and decode_frame functions.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "89f464e9c229006e16f6bb5403c5529fdd0a9edd",
  "patch_info": {
    "commit_hash": "89f464e9c229006e16f6bb5403c5529fdd0a9edd",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/89f464e9c229006e16f6bb5403c5529fdd0a9edd",
    "files": [
      "libavcodec/tiff.c"
    ],
    "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavcodec/tiff.c||libavcodec/tiff.c"
    ]
  },
  "patch_diff": {
    "libavcodec/tiff.c||libavcodec/tiff.c": [
      "File: libavcodec/tiff.c -> libavcodec/tiff.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1004:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
      "1005:             return AVERROR_INVALIDDATA;",
      "1006:         }",
      "1008:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
      "1009:         break;",
      "1010:     case TIFF_T4OPTIONS:",
      "1011:         if (s->compr == TIFF_G3)",
      "",
      "[Removed Lines]",
      "1007:         for (i = 0; i < count; i++)",
      "",
      "[Added Lines]",
      "1007:         for (i = 0; i < count; i++) {",
      "1009:             if (s->subsampling[i] <= 0) {",
      "1010:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
      "1011:                 return AVERROR_INVALIDDATA;",
      "1012:             }",
      "1013:         }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1253:                          avpkt->size - s->strippos);",
      "1254:     }",
      "1257:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
      "1258:         return AVERROR_INVALIDDATA;",
      "1259:     }",
      "",
      "[Removed Lines]",
      "1256:     if (s->rps <= 0) {",
      "",
      "[Added Lines]",
      "1261:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "524ee420502cdc387af000a67ab6f7d67eed8497",
      "candidate_info": {
        "commit_hash": "524ee420502cdc387af000a67ab6f7d67eed8497",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/524ee420502cdc387af000a67ab6f7d67eed8497",
        "files": [
          "libavcodec/tiff.c"
        ],
        "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 89f464e9c229006e16f6bb5403c5529fdd0a9edd)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/tiff.c||libavcodec/tiff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ],
          "candidate": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/tiff.c||libavcodec/tiff.c": [
          "File: libavcodec/tiff.c -> libavcodec/tiff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1000:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
          "1001:             return AVERROR_INVALIDDATA;",
          "1002:         }",
          "1004:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
          "1005:         break;",
          "1006:     case TIFF_T4OPTIONS:",
          "1007:         if (s->compr == TIFF_G3)",
          "",
          "[Removed Lines]",
          "1003:         for (i = 0; i < count; i++)",
          "",
          "[Added Lines]",
          "1003:         for (i = 0; i < count; i++) {",
          "1005:             if (s->subsampling[i] <= 0) {",
          "1006:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
          "1007:                 return AVERROR_INVALIDDATA;",
          "1008:             }",
          "1009:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1249:                          avpkt->size - s->strippos);",
          "1250:     }",
          "1253:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
          "1254:         return AVERROR_INVALIDDATA;",
          "1255:     }",
          "",
          "[Removed Lines]",
          "1252:     if (s->rps <= 0) {",
          "",
          "[Added Lines]",
          "1257:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7142ddcf92c695cce2530761331844adca1300a2",
      "candidate_info": {
        "commit_hash": "7142ddcf92c695cce2530761331844adca1300a2",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/7142ddcf92c695cce2530761331844adca1300a2",
        "files": [
          "libavcodec/tiff.c"
        ],
        "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 89f464e9c229006e16f6bb5403c5529fdd0a9edd)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/tiff.c||libavcodec/tiff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ],
          "candidate": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/tiff.c||libavcodec/tiff.c": [
          "File: libavcodec/tiff.c -> libavcodec/tiff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1005:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
          "1006:             return AVERROR_INVALIDDATA;",
          "1007:         }",
          "1009:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
          "1010:         break;",
          "1011:     case TIFF_T4OPTIONS:",
          "1012:         if (s->compr == TIFF_G3)",
          "",
          "[Removed Lines]",
          "1008:         for (i = 0; i < count; i++)",
          "",
          "[Added Lines]",
          "1008:         for (i = 0; i < count; i++) {",
          "1010:             if (s->subsampling[i] <= 0) {",
          "1011:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
          "1012:                 return AVERROR_INVALIDDATA;",
          "1013:             }",
          "1014:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1254:                          avpkt->size - s->strippos);",
          "1255:     }",
          "1258:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
          "1259:         return AVERROR_INVALIDDATA;",
          "1260:     }",
          "",
          "[Removed Lines]",
          "1257:     if (s->rps <= 0) {",
          "",
          "[Added Lines]",
          "1262:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eb0872335f0118d7081f05df7f441d8edf0171cd",
      "candidate_info": {
        "commit_hash": "eb0872335f0118d7081f05df7f441d8edf0171cd",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/eb0872335f0118d7081f05df7f441d8edf0171cd",
        "files": [
          "libavcodec/tiff.c"
        ],
        "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 89f464e9c229006e16f6bb5403c5529fdd0a9edd)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/tiff.c||libavcodec/tiff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ],
          "candidate": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/tiff.c||libavcodec/tiff.c": [
          "File: libavcodec/tiff.c -> libavcodec/tiff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1008:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
          "1009:             return AVERROR_INVALIDDATA;",
          "1010:         }",
          "1012:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
          "1013:         break;",
          "1014:     case TIFF_T4OPTIONS:",
          "1015:         if (s->compr == TIFF_G3)",
          "",
          "[Removed Lines]",
          "1011:         for (i = 0; i < count; i++)",
          "",
          "[Added Lines]",
          "1011:         for (i = 0; i < count; i++) {",
          "1013:             if (s->subsampling[i] <= 0) {",
          "1014:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
          "1015:                 return AVERROR_INVALIDDATA;",
          "1016:             }",
          "1017:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1257:                          avpkt->size - s->strippos);",
          "1258:     }",
          "1261:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
          "1262:         return AVERROR_INVALIDDATA;",
          "1263:     }",
          "",
          "[Removed Lines]",
          "1260:     if (s->rps <= 0) {",
          "",
          "[Added Lines]",
          "1265:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dee25a5fa5da52acf720dc74a5534471b18eb13f",
      "candidate_info": {
        "commit_hash": "dee25a5fa5da52acf720dc74a5534471b18eb13f",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/dee25a5fa5da52acf720dc74a5534471b18eb13f",
        "files": [
          "libavcodec/tiff.c"
        ],
        "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 89f464e9c229006e16f6bb5403c5529fdd0a9edd)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/tiff.c||libavcodec/tiff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ],
          "candidate": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/tiff.c||libavcodec/tiff.c": [
          "File: libavcodec/tiff.c -> libavcodec/tiff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1000:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
          "1001:             return AVERROR_INVALIDDATA;",
          "1002:         }",
          "1004:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
          "1005:         break;",
          "1006:     case TIFF_T4OPTIONS:",
          "1007:         if (s->compr == TIFF_G3)",
          "",
          "[Removed Lines]",
          "1003:         for (i = 0; i < count; i++)",
          "",
          "[Added Lines]",
          "1003:         for (i = 0; i < count; i++) {",
          "1005:             if (s->subsampling[i] <= 0) {",
          "1006:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
          "1007:                 return AVERROR_INVALIDDATA;",
          "1008:             }",
          "1009:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1249:                          avpkt->size - s->strippos);",
          "1250:     }",
          "1253:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
          "1254:         return AVERROR_INVALIDDATA;",
          "1255:     }",
          "",
          "[Removed Lines]",
          "1252:     if (s->rps <= 0) {",
          "",
          "[Added Lines]",
          "1257:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "61850f1c84237897d475c2b483ece28ddc294860",
      "candidate_info": {
        "commit_hash": "61850f1c84237897d475c2b483ece28ddc294860",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/61850f1c84237897d475c2b483ece28ddc294860",
        "files": [
          "libavcodec/tiff.c"
        ],
        "message": "avcodec/tiff: Check subsample & rps values more completely\n\nFixes out of array access\nFixes: 83aedfb29af669c4d6e10f1bfad974d2/asan_heap-oob_1ab42fe_4984_9f6ec14462f8d8a00ea24b320572a963.tif\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 89f464e9c229006e16f6bb5403c5529fdd0a9edd)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/tiff.c||libavcodec/tiff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ],
          "candidate": [
            "libavcodec/tiff.c||libavcodec/tiff.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/tiff.c||libavcodec/tiff.c": [
          "File: libavcodec/tiff.c -> libavcodec/tiff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1004:             av_log(s->avctx, AV_LOG_ERROR, \"subsample count invalid\\n\");",
          "1005:             return AVERROR_INVALIDDATA;",
          "1006:         }",
          "1008:             s->subsampling[i] = ff_tget(&s->gb, type, s->le);",
          "1009:         break;",
          "1010:     case TIFF_T4OPTIONS:",
          "1011:         if (s->compr == TIFF_G3)",
          "",
          "[Removed Lines]",
          "1007:         for (i = 0; i < count; i++)",
          "",
          "[Added Lines]",
          "1007:         for (i = 0; i < count; i++) {",
          "1009:             if (s->subsampling[i] <= 0) {",
          "1010:                 av_log(s->avctx, AV_LOG_ERROR, \"subsampling %d is invalid\\n\", s->subsampling[i]);",
          "1011:                 return AVERROR_INVALIDDATA;",
          "1012:             }",
          "1013:         }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1253:                          avpkt->size - s->strippos);",
          "1254:     }",
          "1257:         av_log(avctx, AV_LOG_ERROR, \"rps %d invalid\\n\", s->rps);",
          "1258:         return AVERROR_INVALIDDATA;",
          "1259:     }",
          "",
          "[Removed Lines]",
          "1256:     if (s->rps <= 0) {",
          "",
          "[Added Lines]",
          "1261:     if (s->rps <= 0 || s->rps % s->subsampling[1]) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}