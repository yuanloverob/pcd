{
  "cve_id": "CVE-2019-3850",
  "cve_desc": "A vulnerability was found in moodle before versions 3.6.3, 3.5.5, 3.4.8 and 3.1.17. Links within assignment submission comments would open directly (in the same window). Although links themselves may be valid, opening within the same window and without the no-referrer header policy made them more susceptible to exploits.",
  "repo": "moodle/moodle",
  "patch_hash": "5d87464bc6283e72969cd251ce4f399aacebd608",
  "patch_info": {
    "commit_hash": "5d87464bc6283e72969cd251ce4f399aacebd608",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/5d87464bc6283e72969cd251ce4f399aacebd608",
    "files": [
      "comment/classes/external.php",
      "comment/lib.php",
      "comment/locallib.php"
    ],
    "message": "MDL-64651 comments: Do not send referrer\n\nUse blanktarget option on all comments to prevent malicious links.",
    "before_after_code_files": [
      "comment/classes/external.php||comment/classes/external.php",
      "comment/lib.php||comment/lib.php",
      "comment/locallib.php||comment/locallib.php"
    ]
  },
  "patch_diff": {
    "comment/classes/external.php||comment/classes/external.php": [
      "File: comment/classes/external.php -> comment/classes/external.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "102:         if ($comments === false) {",
      "103:             throw new moodle_exception('nopermissions', 'error', '', 'view comments');",
      "104:         }",
      "106:         foreach ($comments as $key => $comment) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "105:         $options = array('blanktarget' => true);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "110:                                                                                                  $context->id,",
      "111:                                                                                                  $params['component'],",
      "112:                                                                                                  '',",
      "114:         }",
      "116:         $results = array(",
      "",
      "[Removed Lines]",
      "113:                                                                                                  0);",
      "",
      "[Added Lines]",
      "114:                                                                                                  0,",
      "115:                                                                                                  $options);",
      "",
      "---------------"
    ],
    "comment/lib.php||comment/lib.php": [
      "File: comment/lib.php -> comment/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "570:         $params['itemid'] = $this->itemid;",
      "572:         $comments = array();",
      "574:         $rs = $DB->get_recordset_sql($sql, $params, $start, $perpage);",
      "575:         foreach ($rs as $u) {",
      "576:             $c = new stdClass();",
      "",
      "[Removed Lines]",
      "573:         $formatoptions = array('overflowdiv' => true);",
      "",
      "[Added Lines]",
      "573:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "717:             $newcmt->fullname = fullname($USER);",
      "718:             $url = new moodle_url('/user/view.php', array('id' => $USER->id, 'course' => $this->courseid));",
      "719:             $newcmt->profileurl = $url->out();",
      "721:             $newcmt->avatar = $OUTPUT->user_picture($USER, array('size'=>16));",
      "723:             $commentlist = array($newcmt);",
      "",
      "[Removed Lines]",
      "720:             $newcmt->content = format_text($newcmt->content, $newcmt->format, array('overflowdiv'=>true));",
      "",
      "[Added Lines]",
      "720:             $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
      "721:             $newcmt->content = format_text($newcmt->content, $newcmt->format, $formatoptions);",
      "",
      "---------------"
    ],
    "comment/locallib.php||comment/locallib.php": [
      "File: comment/locallib.php -> comment/locallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "68:                        ON u.id=c.userid",
      "69:               ORDER BY c.timecreated ASC\";",
      "70:         $rs = $DB->get_recordset_sql($sql, null, $start, $this->perpage);",
      "72:         foreach ($rs as $item) {",
      "74:             $item->fullname = fullname($item);",
      "",
      "[Removed Lines]",
      "71:         $formatoptions = array('overflowdiv' => true);",
      "",
      "[Added Lines]",
      "71:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "772c908d40a944efd91d897d524b255626d330d4",
      "candidate_info": {
        "commit_hash": "772c908d40a944efd91d897d524b255626d330d4",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/772c908d40a944efd91d897d524b255626d330d4",
        "files": [
          "comment/classes/external.php",
          "comment/lib.php",
          "comment/locallib.php"
        ],
        "message": "MDL-64651 comments: Do not send referrer\n\nUse blanktarget option on all comments to prevent malicious links.",
        "before_after_code_files": [
          "comment/classes/external.php||comment/classes/external.php",
          "comment/lib.php||comment/lib.php",
          "comment/locallib.php||comment/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ],
          "candidate": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "comment/classes/external.php||comment/classes/external.php": [
          "File: comment/classes/external.php -> comment/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:         if ($comments === false) {",
          "101:             throw new moodle_exception('nopermissions', 'error', '', 'view comments');",
          "102:         }",
          "104:         foreach ($comments as $key => $comment) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:         $options = array('blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108:                                                                                                  $context->id,",
          "109:                                                                                                  $params['component'],",
          "110:                                                                                                  '',",
          "112:         }",
          "114:         $results = array(",
          "",
          "[Removed Lines]",
          "111:                                                                                                  0);",
          "",
          "[Added Lines]",
          "112:                                                                                                  0,",
          "113:                                                                                                  $options);",
          "",
          "---------------"
        ],
        "comment/lib.php||comment/lib.php": [
          "File: comment/lib.php -> comment/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "569:         $params['itemid'] = $this->itemid;",
          "571:         $comments = array();",
          "573:         $rs = $DB->get_recordset_sql($sql, $params, $start, $perpage);",
          "574:         foreach ($rs as $u) {",
          "575:             $c = new stdClass();",
          "",
          "[Removed Lines]",
          "572:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "572:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "716:             $newcmt->fullname = fullname($USER);",
          "717:             $url = new moodle_url('/user/view.php', array('id' => $USER->id, 'course' => $this->courseid));",
          "718:             $newcmt->profileurl = $url->out();",
          "720:             $newcmt->avatar = $OUTPUT->user_picture($USER, array('size'=>16));",
          "722:             $commentlist = array($newcmt);",
          "",
          "[Removed Lines]",
          "719:             $newcmt->content = format_text($newcmt->content, $newcmt->format, array('overflowdiv'=>true));",
          "",
          "[Added Lines]",
          "719:             $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "720:             $newcmt->content = format_text($newcmt->content, $newcmt->format, $formatoptions);",
          "",
          "---------------"
        ],
        "comment/locallib.php||comment/locallib.php": [
          "File: comment/locallib.php -> comment/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:                        ON u.id=c.userid",
          "69:               ORDER BY c.timecreated ASC\";",
          "70:         $rs = $DB->get_recordset_sql($sql, null, $start, $this->perpage);",
          "72:         foreach ($rs as $item) {",
          "74:             $item->fullname = fullname($item);",
          "",
          "[Removed Lines]",
          "71:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "71:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d3f2f990dd3c5d4e6073a77154c6423d1c304647",
      "candidate_info": {
        "commit_hash": "d3f2f990dd3c5d4e6073a77154c6423d1c304647",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d3f2f990dd3c5d4e6073a77154c6423d1c304647",
        "files": [
          "comment/classes/external.php",
          "comment/lib.php",
          "comment/locallib.php"
        ],
        "message": "MDL-64651 comments: Do not send referrer\n\nUse blanktarget option on all comments to prevent malicious links.",
        "before_after_code_files": [
          "comment/classes/external.php||comment/classes/external.php",
          "comment/lib.php||comment/lib.php",
          "comment/locallib.php||comment/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ],
          "candidate": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "comment/classes/external.php||comment/classes/external.php": [
          "File: comment/classes/external.php -> comment/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:         if ($comments === false) {",
          "103:             throw new moodle_exception('nopermissions', 'error', '', 'view comments');",
          "104:         }",
          "106:         foreach ($comments as $key => $comment) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "105:         $options = array('blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "110:                                                                                                  $context->id,",
          "111:                                                                                                  $params['component'],",
          "112:                                                                                                  '',",
          "114:         }",
          "116:         $results = array(",
          "",
          "[Removed Lines]",
          "113:                                                                                                  0);",
          "",
          "[Added Lines]",
          "114:                                                                                                  0,",
          "115:                                                                                                  $options);",
          "",
          "---------------"
        ],
        "comment/lib.php||comment/lib.php": [
          "File: comment/lib.php -> comment/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "570:         $params['itemid'] = $this->itemid;",
          "572:         $comments = array();",
          "574:         $rs = $DB->get_recordset_sql($sql, $params, $start, $perpage);",
          "575:         foreach ($rs as $u) {",
          "576:             $c = new stdClass();",
          "",
          "[Removed Lines]",
          "573:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "573:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "717:             $newcmt->fullname = fullname($USER);",
          "718:             $url = new moodle_url('/user/view.php', array('id' => $USER->id, 'course' => $this->courseid));",
          "719:             $newcmt->profileurl = $url->out();",
          "721:             $newcmt->avatar = $OUTPUT->user_picture($USER, array('size'=>16));",
          "723:             $commentlist = array($newcmt);",
          "",
          "[Removed Lines]",
          "720:             $newcmt->content = format_text($newcmt->content, $newcmt->format, array('overflowdiv'=>true));",
          "",
          "[Added Lines]",
          "720:             $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "721:             $newcmt->content = format_text($newcmt->content, $newcmt->format, $formatoptions);",
          "",
          "---------------"
        ],
        "comment/locallib.php||comment/locallib.php": [
          "File: comment/locallib.php -> comment/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:                        ON u.id=c.userid",
          "69:               ORDER BY c.timecreated ASC\";",
          "70:         $rs = $DB->get_recordset_sql($sql, null, $start, $this->perpage);",
          "72:         foreach ($rs as $item) {",
          "74:             $item->fullname = fullname($item);",
          "",
          "[Removed Lines]",
          "71:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "71:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "907b377e51c32ea37feef53e10684b504e103273",
      "candidate_info": {
        "commit_hash": "907b377e51c32ea37feef53e10684b504e103273",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/907b377e51c32ea37feef53e10684b504e103273",
        "files": [
          "comment/classes/external.php",
          "comment/lib.php",
          "comment/locallib.php"
        ],
        "message": "MDL-64651 comments: Do not send referrer\n\nUse blanktarget option on all comments to prevent malicious links.",
        "before_after_code_files": [
          "comment/classes/external.php||comment/classes/external.php",
          "comment/lib.php||comment/lib.php",
          "comment/locallib.php||comment/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ],
          "candidate": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "comment/classes/external.php||comment/classes/external.php": [
          "File: comment/classes/external.php -> comment/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:         if ($comments === false) {",
          "103:             throw new moodle_exception('nopermissions', 'error', '', 'view comments');",
          "104:         }",
          "106:         foreach ($comments as $key => $comment) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "105:         $options = array('blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "110:                                                                                                  $context->id,",
          "111:                                                                                                  $params['component'],",
          "112:                                                                                                  '',",
          "114:         }",
          "116:         $results = array(",
          "",
          "[Removed Lines]",
          "113:                                                                                                  0);",
          "",
          "[Added Lines]",
          "114:                                                                                                  0,",
          "115:                                                                                                  $options);",
          "",
          "---------------"
        ],
        "comment/lib.php||comment/lib.php": [
          "File: comment/lib.php -> comment/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "570:         $params['itemid'] = $this->itemid;",
          "572:         $comments = array();",
          "574:         $rs = $DB->get_recordset_sql($sql, $params, $start, $perpage);",
          "575:         foreach ($rs as $u) {",
          "576:             $c = new stdClass();",
          "",
          "[Removed Lines]",
          "573:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "573:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "717:             $newcmt->fullname = fullname($USER);",
          "718:             $url = new moodle_url('/user/view.php', array('id' => $USER->id, 'course' => $this->courseid));",
          "719:             $newcmt->profileurl = $url->out();",
          "721:             $newcmt->avatar = $OUTPUT->user_picture($USER, array('size'=>16));",
          "723:             $commentlist = array($newcmt);",
          "",
          "[Removed Lines]",
          "720:             $newcmt->content = format_text($newcmt->content, $newcmt->format, array('overflowdiv'=>true));",
          "",
          "[Added Lines]",
          "720:             $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "721:             $newcmt->content = format_text($newcmt->content, $newcmt->format, $formatoptions);",
          "",
          "---------------"
        ],
        "comment/locallib.php||comment/locallib.php": [
          "File: comment/locallib.php -> comment/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:                        ON u.id=c.userid",
          "69:               ORDER BY c.timecreated ASC\";",
          "70:         $rs = $DB->get_recordset_sql($sql, null, $start, $this->perpage);",
          "72:         foreach ($rs as $item) {",
          "74:             $item->fullname = fullname($item);",
          "",
          "[Removed Lines]",
          "71:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "71:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1fc481dd7b09e08e85824c1fe6733b303a36bdce",
      "candidate_info": {
        "commit_hash": "1fc481dd7b09e08e85824c1fe6733b303a36bdce",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/1fc481dd7b09e08e85824c1fe6733b303a36bdce",
        "files": [
          "comment/classes/external.php",
          "comment/lib.php",
          "comment/locallib.php"
        ],
        "message": "MDL-64651 comments: Do not send referrer\n\nUse blanktarget option on all comments to prevent malicious links.",
        "before_after_code_files": [
          "comment/classes/external.php||comment/classes/external.php",
          "comment/lib.php||comment/lib.php",
          "comment/locallib.php||comment/locallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ],
          "candidate": [
            "comment/classes/external.php||comment/classes/external.php",
            "comment/lib.php||comment/lib.php",
            "comment/locallib.php||comment/locallib.php"
          ]
        }
      },
      "candidate_diff": {
        "comment/classes/external.php||comment/classes/external.php": [
          "File: comment/classes/external.php -> comment/classes/external.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:         if ($comments === false) {",
          "103:             throw new moodle_exception('nopermissions', 'error', '', 'view comments');",
          "104:         }",
          "106:         foreach ($comments as $key => $comment) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "105:         $options = array('blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "110:                                                                                                  $context->id,",
          "111:                                                                                                  $params['component'],",
          "112:                                                                                                  '',",
          "114:         }",
          "116:         $results = array(",
          "",
          "[Removed Lines]",
          "113:                                                                                                  0);",
          "",
          "[Added Lines]",
          "114:                                                                                                  0,",
          "115:                                                                                                  $options);",
          "",
          "---------------"
        ],
        "comment/lib.php||comment/lib.php": [
          "File: comment/lib.php -> comment/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "570:         $params['itemid'] = $this->itemid;",
          "572:         $comments = array();",
          "574:         $rs = $DB->get_recordset_sql($sql, $params, $start, $perpage);",
          "575:         foreach ($rs as $u) {",
          "576:             $c = new stdClass();",
          "",
          "[Removed Lines]",
          "573:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "573:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "717:             $newcmt->fullname = fullname($USER);",
          "718:             $url = new moodle_url('/user/view.php', array('id' => $USER->id, 'course' => $this->courseid));",
          "719:             $newcmt->profileurl = $url->out();",
          "721:             $newcmt->avatar = $OUTPUT->user_picture($USER, array('size'=>16));",
          "723:             $commentlist = array($newcmt);",
          "",
          "[Removed Lines]",
          "720:             $newcmt->content = format_text($newcmt->content, $newcmt->format, array('overflowdiv'=>true));",
          "",
          "[Added Lines]",
          "720:             $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "721:             $newcmt->content = format_text($newcmt->content, $newcmt->format, $formatoptions);",
          "",
          "---------------"
        ],
        "comment/locallib.php||comment/locallib.php": [
          "File: comment/locallib.php -> comment/locallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:                        ON u.id=c.userid",
          "69:               ORDER BY c.timecreated ASC\";",
          "70:         $rs = $DB->get_recordset_sql($sql, null, $start, $this->perpage);",
          "72:         foreach ($rs as $item) {",
          "74:             $item->fullname = fullname($item);",
          "",
          "[Removed Lines]",
          "71:         $formatoptions = array('overflowdiv' => true);",
          "",
          "[Added Lines]",
          "71:         $formatoptions = array('overflowdiv' => true, 'blanktarget' => true);",
          "",
          "---------------"
        ]
      }
    }
  ]
}