{
  "cve_id": "CVE-2014-0145",
  "cve_desc": "Multiple buffer overflows in QEMU before 1.7.2 and 2.x before 2.0.0, allow local users to cause a denial of service (crash) or possibly execute arbitrary code via a large (1) L1 table in the qcow2_snapshot_load_tmp in the QCOW 2 block driver (block/qcow2-snapshot.c) or (2) uncompressed chunk, (3) chunk length, or (4) number of sectors in the DMG block driver (block/dmg.c).",
  "repo": "qemu/qemu",
  "patch_hash": "c05e4667be91b46ab42b5a11babf8e84d476cc6b",
  "patch_info": {
    "commit_hash": "c05e4667be91b46ab42b5a11babf8e84d476cc6b",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/c05e4667be91b46ab42b5a11babf8e84d476cc6b",
    "files": [
      "block/qcow2-snapshot.c",
      "tests/qemu-iotests/029",
      "tests/qemu-iotests/029.out"
    ],
    "message": "qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)\n\nFor the L1 table to loaded for an internal snapshot, the code allocated\nonly enough memory to hold the currently active L1 table. If the\nsnapshot's L1 table is actually larger than the current one, this leads\nto a buffer overflow.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "before_after_code_files": [
      "block/qcow2-snapshot.c||block/qcow2-snapshot.c"
    ]
  },
  "patch_diff": {
    "block/qcow2-snapshot.c||block/qcow2-snapshot.c": [
      "File: block/qcow2-snapshot.c -> block/qcow2-snapshot.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "680:     sn = &s->snapshots[snapshot_index];",
      "684:     new_l1_table = g_malloc0(align_offset(new_l1_bytes, 512));",
      "686:     ret = bdrv_pread(bs->file, sn->l1_table_offset, new_l1_table, new_l1_bytes);",
      "",
      "[Removed Lines]",
      "683:     new_l1_bytes = s->l1_size * sizeof(uint64_t);",
      "",
      "[Added Lines]",
      "683:     new_l1_bytes = sn->l1_size * sizeof(uint64_t);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d99c4e2d857fbd5e95bf61971d59eb10499289c0",
      "candidate_info": {
        "commit_hash": "d99c4e2d857fbd5e95bf61971d59eb10499289c0",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/d99c4e2d857fbd5e95bf61971d59eb10499289c0",
        "files": [
          "block/qcow2-snapshot.c",
          "tests/qemu-iotests/029",
          "tests/qemu-iotests/029.out"
        ],
        "message": "qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)\n\nFor the L1 table to loaded for an internal snapshot, the code allocated\nonly enough memory to hold the currently active L1 table. If the\nsnapshot's L1 table is actually larger than the current one, this leads\nto a buffer overflow.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>\n(cherry picked from commit c05e4667be91b46ab42b5a11babf8e84d476cc6b)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "block/qcow2-snapshot.c||block/qcow2-snapshot.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "block/qcow2-snapshot.c||block/qcow2-snapshot.c"
          ],
          "candidate": [
            "block/qcow2-snapshot.c||block/qcow2-snapshot.c"
          ]
        }
      },
      "candidate_diff": {
        "block/qcow2-snapshot.c||block/qcow2-snapshot.c": [
          "File: block/qcow2-snapshot.c -> block/qcow2-snapshot.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "673:     sn = &s->snapshots[snapshot_index];",
          "677:     new_l1_table = g_malloc0(align_offset(new_l1_bytes, 512));",
          "679:     ret = bdrv_pread(bs->file, sn->l1_table_offset, new_l1_table, new_l1_bytes);",
          "",
          "[Removed Lines]",
          "676:     new_l1_bytes = s->l1_size * sizeof(uint64_t);",
          "",
          "[Added Lines]",
          "676:     new_l1_bytes = sn->l1_size * sizeof(uint64_t);",
          "",
          "---------------"
        ]
      }
    }
  ]
}