{
  "cve_id": "CVE-2021-29578",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The implementation of `tf.raw_ops.FractionalAvgPoolGrad` is vulnerable to a heap buffer overflow. The implementation(https://github.com/tensorflow/tensorflow/blob/dcba796a28364d6d7f003f6fe733d82726dda713/tensorflow/core/kernels/fractional_avg_pool_op.cc#L216) fails to validate that the pooling sequence arguments have enough elements as required by the `out_backprop` tensor shape. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "12c727cee857fa19be717f336943d95fca4ffe4f",
  "patch_info": {
    "commit_hash": "12c727cee857fa19be717f336943d95fca4ffe4f",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/12c727cee857fa19be717f336943d95fca4ffe4f",
    "files": [
      "tensorflow/core/kernels/fractional_avg_pool_op.cc"
    ],
    "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
    "before_after_code_files": [
      "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
      "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "250:     const int64 out_cols = out_backprop.dim_size(2);",
      "251:     const int64 out_depth = out_backprop.dim_size(3);",
      "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
      "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
      "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
      "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
      "255:                                         out_backprop.shape().DebugString(),",
      "256:                                         \", row_seq_tensor must have at least \",",
      "257:                                         out_rows + 1, \" elements, but got \",",
      "258:                                         row_seq_tensor.NumElements()));",
      "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
      "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
      "261:                                         out_backprop.shape().DebugString(),",
      "262:                                         \", col_seq_tensor must have at least \",",
      "263:                                         out_cols + 1, \" elements, but got \",",
      "264:                                         col_seq_tensor.NumElements()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "87c455ec4649f0bca8ebbb00ae377d7565aa30be",
      "candidate_info": {
        "commit_hash": "87c455ec4649f0bca8ebbb00ae377d7565aa30be",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/87c455ec4649f0bca8ebbb00ae377d7565aa30be",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     const int64 out_cols = out_backprop.dim_size(2);",
          "251:     const int64 out_depth = out_backprop.dim_size(3);",
          "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
          "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
          "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
          "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "255:                                         out_backprop.shape().DebugString(),",
          "256:                                         \", row_seq_tensor must have at least \",",
          "257:                                         out_rows + 1, \" elements, but got \",",
          "258:                                         row_seq_tensor.NumElements()));",
          "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
          "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "261:                                         out_backprop.shape().DebugString(),",
          "262:                                         \", col_seq_tensor must have at least \",",
          "263:                                         out_cols + 1, \" elements, but got \",",
          "264:                                         col_seq_tensor.NumElements()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "68308c973679698d2f4bb837b5007a045b2d5bf2",
      "candidate_info": {
        "commit_hash": "68308c973679698d2f4bb837b5007a045b2d5bf2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/68308c973679698d2f4bb837b5007a045b2d5bf2",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     const int64 out_cols = out_backprop.dim_size(2);",
          "251:     const int64 out_depth = out_backprop.dim_size(3);",
          "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
          "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
          "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
          "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "255:                                         out_backprop.shape().DebugString(),",
          "256:                                         \", row_seq_tensor must have at least \",",
          "257:                                         out_rows + 1, \" elements, but got \",",
          "258:                                         row_seq_tensor.NumElements()));",
          "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
          "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "261:                                         out_backprop.shape().DebugString(),",
          "262:                                         \", col_seq_tensor must have at least \",",
          "263:                                         out_cols + 1, \" elements, but got \",",
          "264:                                         col_seq_tensor.NumElements()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4458cb353933bda9e4c60d58b2204269ba82d815",
      "candidate_info": {
        "commit_hash": "4458cb353933bda9e4c60d58b2204269ba82d815",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/4458cb353933bda9e4c60d58b2204269ba82d815",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     const int64 out_cols = out_backprop.dim_size(2);",
          "251:     const int64 out_depth = out_backprop.dim_size(3);",
          "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
          "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
          "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
          "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "255:                                         out_backprop.shape().DebugString(),",
          "256:                                         \", row_seq_tensor must have at least \",",
          "257:                                         out_rows + 1, \" elements, but got \",",
          "258:                                         row_seq_tensor.NumElements()));",
          "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
          "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "261:                                         out_backprop.shape().DebugString(),",
          "262:                                         \", col_seq_tensor must have at least \",",
          "263:                                         out_cols + 1, \" elements, but got \",",
          "264:                                         col_seq_tensor.NumElements()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "74aa416faac70924d780ebaf67e47a8d0defedeb",
      "candidate_info": {
        "commit_hash": "74aa416faac70924d780ebaf67e47a8d0defedeb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/74aa416faac70924d780ebaf67e47a8d0defedeb",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     const int64 out_cols = out_backprop.dim_size(2);",
          "251:     const int64 out_depth = out_backprop.dim_size(3);",
          "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
          "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
          "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
          "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "255:                                         out_backprop.shape().DebugString(),",
          "256:                                         \", row_seq_tensor must have at least \",",
          "257:                                         out_rows + 1, \" elements, but got \",",
          "258:                                         row_seq_tensor.NumElements()));",
          "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
          "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "261:                                         out_backprop.shape().DebugString(),",
          "262:                                         \", col_seq_tensor must have at least \",",
          "263:                                         out_cols + 1, \" elements, but got \",",
          "264:                                         col_seq_tensor.NumElements()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "08bef9b82863e0aebc4738b3d1d167436c3a3f60",
      "candidate_info": {
        "commit_hash": "08bef9b82863e0aebc4738b3d1d167436c3a3f60",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/08bef9b82863e0aebc4738b3d1d167436c3a3f60",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate inputs of `FractionalAvgPoolGrad`.\n\nPiperOrigin-RevId: 372420640\nChange-Id: Icc583928e6cdc3062e12498e4d2337a8fe3da016",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     const int64 out_cols = out_backprop.dim_size(2);",
          "251:     const int64 out_depth = out_backprop.dim_size(3);",
          "253:     auto row_seq_tensor_flat = row_seq_tensor.flat<int64>();",
          "254:     auto col_seq_tensor_flat = col_seq_tensor.flat<int64>();",
          "255:     auto orig_input_tensor_shape_flat = orig_input_tensor_shape.flat<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "253:     OP_REQUIRES(context, row_seq_tensor.NumElements() > out_rows,",
          "254:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "255:                                         out_backprop.shape().DebugString(),",
          "256:                                         \", row_seq_tensor must have at least \",",
          "257:                                         out_rows + 1, \" elements, but got \",",
          "258:                                         row_seq_tensor.NumElements()));",
          "259:     OP_REQUIRES(context, col_seq_tensor.NumElements() > out_cols,",
          "260:                 errors::InvalidArgument(\"Given out_backprop shape \",",
          "261:                                         out_backprop.shape().DebugString(),",
          "262:                                         \", col_seq_tensor must have at least \",",
          "263:                                         out_cols + 1, \" elements, but got \",",
          "264:                                         col_seq_tensor.NumElements()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}