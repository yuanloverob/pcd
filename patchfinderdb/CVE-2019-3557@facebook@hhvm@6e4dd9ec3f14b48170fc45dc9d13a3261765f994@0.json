{
  "cve_id": "CVE-2019-3557",
  "cve_desc": "The implementations of streams for bz2 and php://output improperly implemented their readImpl functions, returning -1 consistently. This behavior caused some stream functions, such as stream_get_line, to trigger an out-of-bounds read when operating on such malformed streams. The implementations were updated to return valid values consistently. This affects all supported versions of HHVM (3.30 and 3.27.4 and below).",
  "repo": "facebook/hhvm",
  "patch_hash": "6e4dd9ec3f14b48170fc45dc9d13a3261765f994",
  "patch_info": {
    "commit_hash": "6e4dd9ec3f14b48170fc45dc9d13a3261765f994",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/6e4dd9ec3f14b48170fc45dc9d13a3261765f994",
    "files": [
      "hphp/runtime/base/output-file.cpp",
      "hphp/runtime/ext/bz2/bz2-file.cpp",
      "hphp/test/slow/oob_read_file.php",
      "hphp/test/slow/oob_read_file.php.expectf"
    ],
    "message": "CVE-2019-3557: Fix OOB read in readRecord on BZ2Files/OutputFiles\n\nSummary:\nThese File subclasses return -1 on read errors which is not what is\nexpected for readImpl--this made File::readRecord behave unusually if the read\nfails, causing it to read (size_t)(-1) bytes from its stream buffer; which,\nunsurprisingly produces a out-of-bounds heap read.\n\nReviewed By: leikahing, jjgriego\n\nDifferential Revision: D13659395\n\nfbshipit-source-id: 359ed6e3ff9f9cf49b752b666f51c4e0b3ce4b8a",
    "before_after_code_files": [
      "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
      "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
      "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
      "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
    ]
  },
  "patch_diff": {
    "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp": [
      "File: hphp/runtime/base/output-file.cpp -> hphp/runtime/base/output-file.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "67: int64_t OutputFile::readImpl(char* /*buffer*/, int64_t /*length*/) {",
      "68:   raise_warning(\"cannot read from a php://output stream\");",
      "70: }",
      "72: int OutputFile::getc() {",
      "",
      "[Removed Lines]",
      "69:   return -1;",
      "",
      "[Added Lines]",
      "69:   return 0;",
      "",
      "---------------"
    ],
    "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp": [
      "File: hphp/runtime/ext/bz2/bz2-file.cpp -> hphp/runtime/ext/bz2/bz2-file.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "95:   if (len <= 0) {",
      "96:     setEof(true);",
      "97:     if (len < 0) {",
      "99:     }",
      "100:   }",
      "101:   return len;",
      "",
      "[Removed Lines]",
      "98:       return -1;",
      "",
      "[Added Lines]",
      "98:       return 0;",
      "",
      "---------------"
    ],
    "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php": [
      "File: hphp/test/slow/oob_read_file.php -> hphp/test/slow/oob_read_file.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?hh",
      "3: <<__EntryPoint>>",
      "4: function main() {",
      "5:     $a = bzopen(\"/dev/null\", \"w\");",
      "6:     $tmp = stream_get_line($a, 1, \"1\");",
      "7:     var_dump($tmp);",
      "9:     $a = fopen(\"php://output\", \"w\");",
      "10:     $tmp = stream_get_line($a, 1, \"1\");",
      "11:     var_dump($tmp);",
      "12: }",
      "",
      "---------------"
    ],
    "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf": [
      "File: hphp/test/slow/oob_read_file.php.expectf -> hphp/test/slow/oob_read_file.php.expectf",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: string(0) \"\"",
      "3: Warning: cannot read from a php://output stream in %s on line %d",
      "4: string(0) \"\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b43a31bb49fb2213c8a7cb415796cdcd17b67cda",
      "candidate_info": {
        "commit_hash": "b43a31bb49fb2213c8a7cb415796cdcd17b67cda",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/b43a31bb49fb2213c8a7cb415796cdcd17b67cda",
        "files": [
          "hphp/runtime/base/output-file.cpp",
          "hphp/runtime/ext/bz2/bz2-file.cpp",
          "hphp/test/slow/oob_read_file.php",
          "hphp/test/slow/oob_read_file.php.expectf"
        ],
        "message": "Fix OOB read in readRecord on BZ2Files/OutputFiles\n\nSummary:\nThese File subclasses return -1 on read errors which is not what is\nexpected for readImpl--this made File::readRecord behave unusually if the read\nfails, causing it to read (size_t)(-1) bytes from its stream buffer; which,\nunsurprisingly produces a out-of-bounds heap read.\n\nReviewed By: markw65\n\nDifferential Revision: D13601735",
        "before_after_code_files": [
          "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
          "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
          "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
          "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
            "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
            "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
            "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
            "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
            "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
            "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp": [
          "File: hphp/runtime/base/output-file.cpp -> hphp/runtime/base/output-file.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: int64_t OutputFile::readImpl(char* /*buffer*/, int64_t /*length*/) {",
          "68:   raise_warning(\"cannot read from a php://output stream\");",
          "70: }",
          "72: int OutputFile::getc() {",
          "",
          "[Removed Lines]",
          "69:   return -1;",
          "",
          "[Added Lines]",
          "69:   return 0;",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp": [
          "File: hphp/runtime/ext/bz2/bz2-file.cpp -> hphp/runtime/ext/bz2/bz2-file.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:   if (len <= 0) {",
          "96:     setEof(true);",
          "97:     if (len < 0) {",
          "99:     }",
          "100:   }",
          "101:   return len;",
          "",
          "[Removed Lines]",
          "98:       return -1;",
          "",
          "[Added Lines]",
          "98:       return 0;",
          "",
          "---------------"
        ],
        "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php": [
          "File: hphp/test/slow/oob_read_file.php -> hphp/test/slow/oob_read_file.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main() {",
          "5:     $a = bzopen(\"/dev/null\", \"w\");",
          "6:     $tmp = stream_get_line($a, 1, \"1\");",
          "7:     var_dump($tmp);",
          "9:     $a = fopen(\"php://output\", \"w\");",
          "10:     $tmp = stream_get_line($a, 1, \"1\");",
          "11:     var_dump($tmp);",
          "12: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf": [
          "File: hphp/test/slow/oob_read_file.php.expectf -> hphp/test/slow/oob_read_file.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: string(0) \"\"",
          "3: Warning: cannot read from a php://output stream in %s on line %d",
          "4: string(0) \"\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "08e1f6a8cd526f7bc892206d7fde2d3351878e47",
      "candidate_info": {
        "commit_hash": "08e1f6a8cd526f7bc892206d7fde2d3351878e47",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/08e1f6a8cd526f7bc892206d7fde2d3351878e47",
        "files": [
          "hphp/runtime/base/output-file.cpp",
          "hphp/runtime/ext/bz2/bz2-file.cpp",
          "hphp/test/slow/oob_read_file.php",
          "hphp/test/slow/oob_read_file.php.expectf"
        ],
        "message": "[CVE-2019-3557] Fix OOB read in readRecord on BZ2Files/OutputFiles\n\nSummary:\nThese File subclasses return -1 on read errors which is not what is\nexpected for readImpl--this made File::readRecord behave unusually if the read\nfails, causing it to read (size_t)(-1) bytes from its stream buffer; which,\nunsurprisingly produces a out-of-bounds heap read.\n\nReviewed By: markw65\n\nDifferential Revision: D13601735",
        "before_after_code_files": [
          "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
          "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
          "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
          "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
            "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
            "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
            "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp",
            "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp",
            "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php",
            "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/output-file.cpp||hphp/runtime/base/output-file.cpp": [
          "File: hphp/runtime/base/output-file.cpp -> hphp/runtime/base/output-file.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: int64_t OutputFile::readImpl(char* /*buffer*/, int64_t /*length*/) {",
          "68:   raise_warning(\"cannot read from a php://output stream\");",
          "70: }",
          "72: int OutputFile::getc() {",
          "",
          "[Removed Lines]",
          "69:   return -1;",
          "",
          "[Added Lines]",
          "69:   return 0;",
          "",
          "---------------"
        ],
        "hphp/runtime/ext/bz2/bz2-file.cpp||hphp/runtime/ext/bz2/bz2-file.cpp": [
          "File: hphp/runtime/ext/bz2/bz2-file.cpp -> hphp/runtime/ext/bz2/bz2-file.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:   if (len <= 0) {",
          "96:     setEof(true);",
          "97:     if (len < 0) {",
          "99:     }",
          "100:   }",
          "101:   return len;",
          "",
          "[Removed Lines]",
          "98:       return -1;",
          "",
          "[Added Lines]",
          "98:       return 0;",
          "",
          "---------------"
        ],
        "hphp/test/slow/oob_read_file.php||hphp/test/slow/oob_read_file.php": [
          "File: hphp/test/slow/oob_read_file.php -> hphp/test/slow/oob_read_file.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "3: <<__EntryPoint>>",
          "4: function main() {",
          "5:     $a = bzopen(\"/dev/null\", \"w\");",
          "6:     $tmp = stream_get_line($a, 1, \"1\");",
          "7:     var_dump($tmp);",
          "9:     $a = fopen(\"php://output\", \"w\");",
          "10:     $tmp = stream_get_line($a, 1, \"1\");",
          "11:     var_dump($tmp);",
          "12: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/oob_read_file.php.expectf||hphp/test/slow/oob_read_file.php.expectf": [
          "File: hphp/test/slow/oob_read_file.php.expectf -> hphp/test/slow/oob_read_file.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: string(0) \"\"",
          "3: Warning: cannot read from a php://output stream in %s on line %d",
          "4: string(0) \"\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}