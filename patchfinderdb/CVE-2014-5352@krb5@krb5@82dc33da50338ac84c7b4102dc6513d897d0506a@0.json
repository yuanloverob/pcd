{
  "cve_id": "CVE-2014-5352",
  "cve_desc": "The krb5_gss_process_context_token function in lib/gssapi/krb5/process_context_token.c in the libgssapi_krb5 library in MIT Kerberos 5 (aka krb5) through 1.11.5, 1.12.x through 1.12.2, and 1.13.x before 1.13.1 does not properly maintain security-context handles, which allows remote authenticated users to cause a denial of service (use-after-free and double free, and daemon crash) or possibly execute arbitrary code via crafted GSSAPI traffic, as demonstrated by traffic to kadmind.",
  "repo": "krb5/krb5",
  "patch_hash": "82dc33da50338ac84c7b4102dc6513d897d0506a",
  "patch_info": {
    "commit_hash": "82dc33da50338ac84c7b4102dc6513d897d0506a",
    "repo": "krb5/krb5",
    "commit_url": "https://github.com/krb5/krb5/commit/82dc33da50338ac84c7b4102dc6513d897d0506a",
    "files": [
      "src/lib/gssapi/krb5/context_time.c",
      "src/lib/gssapi/krb5/export_sec_context.c",
      "src/lib/gssapi/krb5/gssapiP_krb5.h",
      "src/lib/gssapi/krb5/gssapi_krb5.c",
      "src/lib/gssapi/krb5/inq_context.c",
      "src/lib/gssapi/krb5/k5seal.c",
      "src/lib/gssapi/krb5/k5sealiov.c",
      "src/lib/gssapi/krb5/k5unseal.c",
      "src/lib/gssapi/krb5/k5unsealiov.c",
      "src/lib/gssapi/krb5/lucid_context.c",
      "src/lib/gssapi/krb5/prf.c",
      "src/lib/gssapi/krb5/process_context_token.c",
      "src/lib/gssapi/krb5/wrap_size_limit.c",
      "src/tests/gssapi/t_prf.c"
    ],
    "message": "Fix gss_process_context_token() [CVE-2014-5352]\n\n[MITKRB5-SA-2015-001] The krb5 gss_process_context_token() should not\nactually delete the context; that leaves the caller with a dangling\npointer and no way to know that it is invalid.  Instead, mark the\ncontext as terminated, and check for terminated contexts in the GSS\nfunctions which expect established contexts.  Also add checks in\nexport_sec_context and pseudo_random, and adjust t_prf.c for the\npseudo_random check.\n\nticket: 8055 (new)\ntarget_version: 1.13.1\ntags: pullup",
    "before_after_code_files": [
      "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
      "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
      "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
      "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
      "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
      "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
      "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
      "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
      "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
      "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
      "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
      "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
      "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c",
      "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c"
    ]
  },
  "patch_diff": {
    "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c": [
      "File: src/lib/gssapi/krb5/context_time.c -> src/lib/gssapi/krb5/context_time.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "41:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "45:         return(GSS_S_NO_CONTEXT);",
      "46:     }",
      "",
      "[Removed Lines]",
      "43:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "43:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c": [
      "File: src/lib/gssapi/krb5/export_sec_context.c -> src/lib/gssapi/krb5/export_sec_context.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "47:     ctx = (krb5_gss_ctx_id_t) *context_handle;",
      "48:     context = ctx->k5_context;",
      "49:     kret = krb5_gss_ser_init(context);",
      "50:     if (kret)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "48:     if (ctx->terminated) {",
      "50:         return (GSS_S_NO_CONTEXT);",
      "51:     }",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h": [
      "File: src/lib/gssapi/krb5/gssapiP_krb5.h -> src/lib/gssapi/krb5/gssapiP_krb5.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "206:     unsigned int established : 1;",
      "207:     unsigned int have_acceptor_subkey : 1;",
      "209:     OM_uint32 gss_flags;",
      "210:     unsigned char seed[16];",
      "211:     krb5_gss_name_t here;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "209:     unsigned int terminated : 1;",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c": [
      "File: src/lib/gssapi/krb5/gssapi_krb5.c -> src/lib/gssapi/krb5/gssapi_krb5.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "370:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "373:         return GSS_S_NO_CONTEXT;",
      "375:     for (i = 0; i < sizeof(krb5_gss_inquire_sec_context_by_oid_ops)/",
      "",
      "[Removed Lines]",
      "372:     if (!ctx->established)",
      "",
      "[Added Lines]",
      "372:     if (ctx->terminated || !ctx->established)",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c": [
      "File: src/lib/gssapi/krb5/inq_context.c -> src/lib/gssapi/krb5/inq_context.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "106:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "110:         return(GSS_S_NO_CONTEXT);",
      "111:     }",
      "",
      "[Removed Lines]",
      "108:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "108:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c": [
      "File: src/lib/gssapi/krb5/k5seal.c -> src/lib/gssapi/krb5/k5seal.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "343:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "347:         return(GSS_S_NO_CONTEXT);",
      "348:     }",
      "",
      "[Removed Lines]",
      "345:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "345:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c": [
      "File: src/lib/gssapi/krb5/k5sealiov.c -> src/lib/gssapi/krb5/k5sealiov.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "281:     }",
      "283:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
      "286:         return GSS_S_NO_CONTEXT;",
      "287:     }",
      "",
      "[Removed Lines]",
      "284:     if (!ctx->established) {",
      "",
      "[Added Lines]",
      "284:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c": [
      "File: src/lib/gssapi/krb5/k5unseal.c -> src/lib/gssapi/krb5/k5unseal.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "493:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "497:         return(GSS_S_NO_CONTEXT);",
      "498:     }",
      "",
      "[Removed Lines]",
      "495:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "495:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c": [
      "File: src/lib/gssapi/krb5/k5unsealiov.c -> src/lib/gssapi/krb5/k5unsealiov.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "625:     OM_uint32 code;",
      "627:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
      "630:         return GSS_S_NO_CONTEXT;",
      "631:     }",
      "",
      "[Removed Lines]",
      "628:     if (!ctx->established) {",
      "",
      "[Added Lines]",
      "628:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c": [
      "File: src/lib/gssapi/krb5/lucid_context.c -> src/lib/gssapi/krb5/lucid_context.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "78:     retval = generic_gss_oid_decompose(minor_status,",
      "79:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID,",
      "80:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID_LENGTH,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "78:     if (ctx->terminated || !ctx->established) {",
      "80:         return GSS_S_NO_CONTEXT;",
      "81:     }",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c": [
      "File: src/lib/gssapi/krb5/prf.c -> src/lib/gssapi/krb5/prf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "58:     ns.data = NULL;",
      "60:     ctx = (krb5_gss_ctx_id_t)context;",
      "62:     switch (prf_key) {",
      "63:     case GSS_C_PRF_KEY_FULL:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "61:     if (ctx->terminated || !ctx->established) {",
      "63:         return GSS_S_NO_CONTEXT;",
      "64:     }",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c": [
      "File: src/lib/gssapi/krb5/process_context_token.c -> src/lib/gssapi/krb5/process_context_token.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "40:     ctx = (krb5_gss_ctx_id_t) context_handle;",
      "44:         return(GSS_S_NO_CONTEXT);",
      "45:     }",
      "49:     if (GSS_ERROR(majerr = kg_unseal(minor_status, context_handle,",
      "",
      "[Removed Lines]",
      "42:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "42:     if (ctx->terminated || !ctx->established) {",
      "49:     if (ctx->proto) {",
      "51:         return(GSS_S_DEFECTIVE_TOKEN);",
      "52:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "52:                                      KG_TOK_DEL_CTX)))",
      "53:         return(majerr);",
      "59: }",
      "",
      "[Removed Lines]",
      "57:     return(krb5_gss_delete_sec_context(minor_status, &context_handle,",
      "58:                                        GSS_C_NO_BUFFER));",
      "",
      "[Added Lines]",
      "64:     ctx->terminated = 1;",
      "65:     return(GSS_S_COMPLETE);",
      "",
      "---------------"
    ],
    "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c": [
      "File: src/lib/gssapi/krb5/wrap_size_limit.c -> src/lib/gssapi/krb5/wrap_size_limit.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "95:     }",
      "97:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
      "100:         return(GSS_S_NO_CONTEXT);",
      "101:     }",
      "",
      "[Removed Lines]",
      "98:     if (! ctx->established) {",
      "",
      "[Added Lines]",
      "98:     if (ctx->terminated || !ctx->established) {",
      "",
      "---------------"
    ],
    "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c": [
      "File: src/tests/gssapi/t_prf.c -> src/tests/gssapi/t_prf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "127:     uctx.mech_type = &mech_krb5;",
      "128:     uctx.internal_ctx_id = (gss_ctx_id_t)&kgctx;",
      "129:     kgctx.k5_context = NULL;",
      "130:     kgctx.have_acceptor_subkey = 1;",
      "131:     kb1.contents = k1buf;",
      "132:     kb2.contents = k2buf;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "130:     kgctx.established = 1;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e76dbd8d163e235d821011ed9ea3baa5376da854",
      "candidate_info": {
        "commit_hash": "e76dbd8d163e235d821011ed9ea3baa5376da854",
        "repo": "krb5/krb5",
        "commit_url": "https://github.com/krb5/krb5/commit/e76dbd8d163e235d821011ed9ea3baa5376da854",
        "files": [
          "src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c"
        ],
        "message": "Fix gss_process_context_token() [CVE-2014-5352]\n\n[MITKRB5-SA-2015-001] The krb5 gss_process_context_token() should not\nactually delete the context; that leaves the caller with a dangling\npointer and no way to know that it is invalid.  Instead, mark the\ncontext as terminated, and check for terminated contexts in the GSS\nfunctions which expect established contexts.  Also add checks in\nexport_sec_context and pseudo_random, and adjust t_prf.c for the\npseudo_random check.\n\n(back ported from commit 82dc33da50338ac84c7b4102dc6513d897d0506a)\n\nticket: 8067 (new)\nversion_fixed: 1.12.3\nstatus: resolved",
        "before_after_code_files": [
          "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
          ],
          "candidate": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c": [
          "File: src/lib/gssapi/krb5/context_time.c -> src/lib/gssapi/krb5/context_time.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "45:         return(GSS_S_NO_CONTEXT);",
          "46:     }",
          "",
          "[Removed Lines]",
          "43:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "43:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c": [
          "File: src/lib/gssapi/krb5/export_sec_context.c -> src/lib/gssapi/krb5/export_sec_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     ctx = (krb5_gss_ctx_id_t) *context_handle;",
          "48:     context = ctx->k5_context;",
          "49:     kret = krb5_gss_ser_init(context);",
          "50:     if (kret)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "48:     if (ctx->terminated) {",
          "50:         return (GSS_S_NO_CONTEXT);",
          "51:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h": [
          "File: src/lib/gssapi/krb5/gssapiP_krb5.h -> src/lib/gssapi/krb5/gssapiP_krb5.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "204:     unsigned int established : 1;",
          "205:     unsigned int have_acceptor_subkey : 1;",
          "207:     OM_uint32 gss_flags;",
          "208:     unsigned char seed[16];",
          "209:     krb5_gss_name_t here;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "207:     unsigned int terminated : 1;",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c": [
          "File: src/lib/gssapi/krb5/gssapi_krb5.c -> src/lib/gssapi/krb5/gssapi_krb5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "370:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "373:         return GSS_S_NO_CONTEXT;",
          "375:     for (i = 0; i < sizeof(krb5_gss_inquire_sec_context_by_oid_ops)/",
          "",
          "[Removed Lines]",
          "372:     if (!ctx->established)",
          "",
          "[Added Lines]",
          "372:     if (ctx->terminated || !ctx->established)",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c": [
          "File: src/lib/gssapi/krb5/inq_context.c -> src/lib/gssapi/krb5/inq_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "110:         return(GSS_S_NO_CONTEXT);",
          "111:     }",
          "",
          "[Removed Lines]",
          "108:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "108:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c": [
          "File: src/lib/gssapi/krb5/k5seal.c -> src/lib/gssapi/krb5/k5seal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "343:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "347:         return(GSS_S_NO_CONTEXT);",
          "348:     }",
          "",
          "[Removed Lines]",
          "345:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "345:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c": [
          "File: src/lib/gssapi/krb5/k5sealiov.c -> src/lib/gssapi/krb5/k5sealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "284:     }",
          "286:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "289:         return GSS_S_NO_CONTEXT;",
          "290:     }",
          "",
          "[Removed Lines]",
          "287:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "287:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c": [
          "File: src/lib/gssapi/krb5/k5unseal.c -> src/lib/gssapi/krb5/k5unseal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "493:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "497:         return(GSS_S_NO_CONTEXT);",
          "498:     }",
          "",
          "[Removed Lines]",
          "495:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "495:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c": [
          "File: src/lib/gssapi/krb5/k5unsealiov.c -> src/lib/gssapi/krb5/k5unsealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "628:     OM_uint32 code;",
          "630:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "633:         return GSS_S_NO_CONTEXT;",
          "634:     }",
          "",
          "[Removed Lines]",
          "631:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "631:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c": [
          "File: src/lib/gssapi/krb5/lucid_context.c -> src/lib/gssapi/krb5/lucid_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     retval = generic_gss_oid_decompose(minor_status,",
          "79:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID,",
          "80:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID_LENGTH,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:     if (ctx->terminated || !ctx->established) {",
          "80:         return GSS_S_NO_CONTEXT;",
          "81:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c": [
          "File: src/lib/gssapi/krb5/prf.c -> src/lib/gssapi/krb5/prf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     ns.data = NULL;",
          "62:     ctx = (krb5_gss_ctx_id_t)context;",
          "64:     switch (prf_key) {",
          "65:     case GSS_C_PRF_KEY_FULL:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "63:     if (ctx->terminated || !ctx->established) {",
          "65:         return GSS_S_NO_CONTEXT;",
          "66:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c": [
          "File: src/lib/gssapi/krb5/process_context_token.c -> src/lib/gssapi/krb5/process_context_token.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "40:     ctx = (krb5_gss_ctx_id_t) context_handle;",
          "44:         return(GSS_S_NO_CONTEXT);",
          "45:     }",
          "49:     if (GSS_ERROR(majerr = kg_unseal(minor_status, context_handle,",
          "",
          "[Removed Lines]",
          "42:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "42:     if (ctx->terminated || !ctx->established) {",
          "49:     if (ctx->proto) {",
          "51:         return(GSS_S_DEFECTIVE_TOKEN);",
          "52:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:                                      KG_TOK_DEL_CTX)))",
          "53:         return(majerr);",
          "59: }",
          "",
          "[Removed Lines]",
          "57:     return(krb5_gss_delete_sec_context(minor_status, &context_handle,",
          "58:                                        GSS_C_NO_BUFFER));",
          "",
          "[Added Lines]",
          "64:     ctx->terminated = 1;",
          "65:     return(GSS_S_COMPLETE);",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c": [
          "File: src/lib/gssapi/krb5/wrap_size_limit.c -> src/lib/gssapi/krb5/wrap_size_limit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     }",
          "97:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "100:         return(GSS_S_NO_CONTEXT);",
          "101:     }",
          "",
          "[Removed Lines]",
          "98:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "98:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3cb9368472ba824bbaefad5e88006769fbc097e8",
      "candidate_info": {
        "commit_hash": "3cb9368472ba824bbaefad5e88006769fbc097e8",
        "repo": "krb5/krb5",
        "commit_url": "https://github.com/krb5/krb5/commit/3cb9368472ba824bbaefad5e88006769fbc097e8",
        "files": [
          "src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c"
        ],
        "message": "Fix gss_process_context_token() [CVE-2014-5352]\n\n[MITKRB5-SA-2015-001] The krb5 gss_process_context_token() should not\nactually delete the context; that leaves the caller with a dangling\npointer and no way to know that it is invalid.  Instead, mark the\ncontext as terminated, and check for terminated contexts in the GSS\nfunctions which expect established contexts.  Also add checks in\nexport_sec_context and pseudo_random, and adjust t_prf.c for the\npseudo_random check.\n\n(back ported from commit 82dc33da50338ac84c7b4102dc6513d897d0506a)\n\nticket: 8073 (new)\nversion_fixed: 1.11.6\nstatus: resolved",
        "before_after_code_files": [
          "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
          ],
          "candidate": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c": [
          "File: src/lib/gssapi/krb5/context_time.c -> src/lib/gssapi/krb5/context_time.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "45:         return(GSS_S_NO_CONTEXT);",
          "46:     }",
          "",
          "[Removed Lines]",
          "43:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "43:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c": [
          "File: src/lib/gssapi/krb5/export_sec_context.c -> src/lib/gssapi/krb5/export_sec_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     ctx = (krb5_gss_ctx_id_t) *context_handle;",
          "48:     context = ctx->k5_context;",
          "49:     kret = krb5_gss_ser_init(context);",
          "50:     if (kret)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "48:     if (ctx->terminated) {",
          "50:         return (GSS_S_NO_CONTEXT);",
          "51:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h": [
          "File: src/lib/gssapi/krb5/gssapiP_krb5.h -> src/lib/gssapi/krb5/gssapiP_krb5.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "204:     unsigned int established : 1;",
          "205:     unsigned int have_acceptor_subkey : 1;",
          "207:     OM_uint32 gss_flags;",
          "208:     unsigned char seed[16];",
          "209:     krb5_gss_name_t here;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "207:     unsigned int terminated : 1;",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c": [
          "File: src/lib/gssapi/krb5/gssapi_krb5.c -> src/lib/gssapi/krb5/gssapi_krb5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "370:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "373:         return GSS_S_NO_CONTEXT;",
          "375:     for (i = 0; i < sizeof(krb5_gss_inquire_sec_context_by_oid_ops)/",
          "",
          "[Removed Lines]",
          "372:     if (!ctx->established)",
          "",
          "[Added Lines]",
          "372:     if (ctx->terminated || !ctx->established)",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c": [
          "File: src/lib/gssapi/krb5/inq_context.c -> src/lib/gssapi/krb5/inq_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "110:         return(GSS_S_NO_CONTEXT);",
          "111:     }",
          "",
          "[Removed Lines]",
          "108:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "108:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c": [
          "File: src/lib/gssapi/krb5/k5seal.c -> src/lib/gssapi/krb5/k5seal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "343:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "347:         return(GSS_S_NO_CONTEXT);",
          "348:     }",
          "",
          "[Removed Lines]",
          "345:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "345:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c": [
          "File: src/lib/gssapi/krb5/k5sealiov.c -> src/lib/gssapi/krb5/k5sealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "285:     }",
          "287:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "290:         return GSS_S_NO_CONTEXT;",
          "291:     }",
          "",
          "[Removed Lines]",
          "288:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "288:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c": [
          "File: src/lib/gssapi/krb5/k5unseal.c -> src/lib/gssapi/krb5/k5unseal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "493:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "497:         return(GSS_S_NO_CONTEXT);",
          "498:     }",
          "",
          "[Removed Lines]",
          "495:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "495:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c": [
          "File: src/lib/gssapi/krb5/k5unsealiov.c -> src/lib/gssapi/krb5/k5unsealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "633:     OM_uint32 code;",
          "635:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "638:         return GSS_S_NO_CONTEXT;",
          "639:     }",
          "",
          "[Removed Lines]",
          "636:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "636:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c": [
          "File: src/lib/gssapi/krb5/lucid_context.c -> src/lib/gssapi/krb5/lucid_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     retval = generic_gss_oid_decompose(minor_status,",
          "79:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID,",
          "80:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID_LENGTH,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:     if (ctx->terminated || !ctx->established) {",
          "80:         return GSS_S_NO_CONTEXT;",
          "81:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c": [
          "File: src/lib/gssapi/krb5/prf.c -> src/lib/gssapi/krb5/prf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     ns.data = NULL;",
          "62:     ctx = (krb5_gss_ctx_id_t)context;",
          "64:     switch (prf_key) {",
          "65:     case GSS_C_PRF_KEY_FULL:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "63:     if (ctx->terminated || !ctx->established) {",
          "65:         return GSS_S_NO_CONTEXT;",
          "66:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c": [
          "File: src/lib/gssapi/krb5/process_context_token.c -> src/lib/gssapi/krb5/process_context_token.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "40:     ctx = (krb5_gss_ctx_id_t) context_handle;",
          "44:         return(GSS_S_NO_CONTEXT);",
          "45:     }",
          "49:     if (GSS_ERROR(majerr = kg_unseal(minor_status, context_handle,",
          "",
          "[Removed Lines]",
          "42:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "42:     if (ctx->terminated || !ctx->established) {",
          "49:     if (ctx->proto) {",
          "51:         return(GSS_S_DEFECTIVE_TOKEN);",
          "52:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:                                      KG_TOK_DEL_CTX)))",
          "53:         return(majerr);",
          "59: }",
          "",
          "[Removed Lines]",
          "57:     return(krb5_gss_delete_sec_context(minor_status, &context_handle,",
          "58:                                        GSS_C_NO_BUFFER));",
          "",
          "[Added Lines]",
          "64:     ctx->terminated = 1;",
          "65:     return(GSS_S_COMPLETE);",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c": [
          "File: src/lib/gssapi/krb5/wrap_size_limit.c -> src/lib/gssapi/krb5/wrap_size_limit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     }",
          "97:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "100:         return(GSS_S_NO_CONTEXT);",
          "101:     }",
          "",
          "[Removed Lines]",
          "98:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "98:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3cfd4bd9e7c09c3b9024d83ab6e3bba2218eb48b",
      "candidate_info": {
        "commit_hash": "3cfd4bd9e7c09c3b9024d83ab6e3bba2218eb48b",
        "repo": "krb5/krb5",
        "commit_url": "https://github.com/krb5/krb5/commit/3cfd4bd9e7c09c3b9024d83ab6e3bba2218eb48b",
        "files": [
          "src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c",
          "src/tests/gssapi/t_prf.c"
        ],
        "message": "Fix gss_process_context_token() [CVE-2014-5352]\n\n[MITKRB5-SA-2015-001] The krb5 gss_process_context_token() should not\nactually delete the context; that leaves the caller with a dangling\npointer and no way to know that it is invalid.  Instead, mark the\ncontext as terminated, and check for terminated contexts in the GSS\nfunctions which expect established contexts.  Also add checks in\nexport_sec_context and pseudo_random, and adjust t_prf.c for the\npseudo_random check.\n\n(cherry picked from commit 82dc33da50338ac84c7b4102dc6513d897d0506a)\n\nticket: 8055\nversion_fixed: 1.13.1\nstatus: resolved",
        "before_after_code_files": [
          "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
          "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
          "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
          "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
          "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
          "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
          "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
          "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
          "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
          "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
          "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
          "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
          "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c",
          "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c",
            "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c"
          ],
          "candidate": [
            "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c",
            "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c",
            "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h",
            "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c",
            "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c",
            "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c",
            "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c",
            "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c",
            "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c",
            "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c",
            "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c",
            "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c",
            "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c",
            "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/gssapi/krb5/context_time.c||src/lib/gssapi/krb5/context_time.c": [
          "File: src/lib/gssapi/krb5/context_time.c -> src/lib/gssapi/krb5/context_time.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "45:         return(GSS_S_NO_CONTEXT);",
          "46:     }",
          "",
          "[Removed Lines]",
          "43:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "43:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/export_sec_context.c||src/lib/gssapi/krb5/export_sec_context.c": [
          "File: src/lib/gssapi/krb5/export_sec_context.c -> src/lib/gssapi/krb5/export_sec_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:     ctx = (krb5_gss_ctx_id_t) *context_handle;",
          "48:     context = ctx->k5_context;",
          "49:     kret = krb5_gss_ser_init(context);",
          "50:     if (kret)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "48:     if (ctx->terminated) {",
          "50:         return (GSS_S_NO_CONTEXT);",
          "51:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapiP_krb5.h||src/lib/gssapi/krb5/gssapiP_krb5.h": [
          "File: src/lib/gssapi/krb5/gssapiP_krb5.h -> src/lib/gssapi/krb5/gssapiP_krb5.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "206:     unsigned int established : 1;",
          "207:     unsigned int have_acceptor_subkey : 1;",
          "209:     OM_uint32 gss_flags;",
          "210:     unsigned char seed[16];",
          "211:     krb5_gss_name_t here;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "209:     unsigned int terminated : 1;",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/gssapi_krb5.c||src/lib/gssapi/krb5/gssapi_krb5.c": [
          "File: src/lib/gssapi/krb5/gssapi_krb5.c -> src/lib/gssapi/krb5/gssapi_krb5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "370:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "373:         return GSS_S_NO_CONTEXT;",
          "375:     for (i = 0; i < sizeof(krb5_gss_inquire_sec_context_by_oid_ops)/",
          "",
          "[Removed Lines]",
          "372:     if (!ctx->established)",
          "",
          "[Added Lines]",
          "372:     if (ctx->terminated || !ctx->established)",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/inq_context.c||src/lib/gssapi/krb5/inq_context.c": [
          "File: src/lib/gssapi/krb5/inq_context.c -> src/lib/gssapi/krb5/inq_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "106:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "110:         return(GSS_S_NO_CONTEXT);",
          "111:     }",
          "",
          "[Removed Lines]",
          "108:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "108:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5seal.c||src/lib/gssapi/krb5/k5seal.c": [
          "File: src/lib/gssapi/krb5/k5seal.c -> src/lib/gssapi/krb5/k5seal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "343:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "347:         return(GSS_S_NO_CONTEXT);",
          "348:     }",
          "",
          "[Removed Lines]",
          "345:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "345:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5sealiov.c||src/lib/gssapi/krb5/k5sealiov.c": [
          "File: src/lib/gssapi/krb5/k5sealiov.c -> src/lib/gssapi/krb5/k5sealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "281:     }",
          "283:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "286:         return GSS_S_NO_CONTEXT;",
          "287:     }",
          "",
          "[Removed Lines]",
          "284:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "284:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unseal.c||src/lib/gssapi/krb5/k5unseal.c": [
          "File: src/lib/gssapi/krb5/k5unseal.c -> src/lib/gssapi/krb5/k5unseal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "493:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "497:         return(GSS_S_NO_CONTEXT);",
          "498:     }",
          "",
          "[Removed Lines]",
          "495:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "495:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/k5unsealiov.c||src/lib/gssapi/krb5/k5unsealiov.c": [
          "File: src/lib/gssapi/krb5/k5unsealiov.c -> src/lib/gssapi/krb5/k5unsealiov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "625:     OM_uint32 code;",
          "627:     ctx = (krb5_gss_ctx_id_rec *)context_handle;",
          "630:         return GSS_S_NO_CONTEXT;",
          "631:     }",
          "",
          "[Removed Lines]",
          "628:     if (!ctx->established) {",
          "",
          "[Added Lines]",
          "628:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/lucid_context.c||src/lib/gssapi/krb5/lucid_context.c": [
          "File: src/lib/gssapi/krb5/lucid_context.c -> src/lib/gssapi/krb5/lucid_context.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     retval = generic_gss_oid_decompose(minor_status,",
          "79:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID,",
          "80:                                        GSS_KRB5_EXPORT_LUCID_SEC_CONTEXT_OID_LENGTH,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:     if (ctx->terminated || !ctx->established) {",
          "80:         return GSS_S_NO_CONTEXT;",
          "81:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/prf.c||src/lib/gssapi/krb5/prf.c": [
          "File: src/lib/gssapi/krb5/prf.c -> src/lib/gssapi/krb5/prf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "58:     ns.data = NULL;",
          "60:     ctx = (krb5_gss_ctx_id_t)context;",
          "62:     switch (prf_key) {",
          "63:     case GSS_C_PRF_KEY_FULL:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61:     if (ctx->terminated || !ctx->established) {",
          "63:         return GSS_S_NO_CONTEXT;",
          "64:     }",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/process_context_token.c||src/lib/gssapi/krb5/process_context_token.c": [
          "File: src/lib/gssapi/krb5/process_context_token.c -> src/lib/gssapi/krb5/process_context_token.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "40:     ctx = (krb5_gss_ctx_id_t) context_handle;",
          "44:         return(GSS_S_NO_CONTEXT);",
          "45:     }",
          "49:     if (GSS_ERROR(majerr = kg_unseal(minor_status, context_handle,",
          "",
          "[Removed Lines]",
          "42:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "42:     if (ctx->terminated || !ctx->established) {",
          "49:     if (ctx->proto) {",
          "51:         return(GSS_S_DEFECTIVE_TOKEN);",
          "52:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "52:                                      KG_TOK_DEL_CTX)))",
          "53:         return(majerr);",
          "59: }",
          "",
          "[Removed Lines]",
          "57:     return(krb5_gss_delete_sec_context(minor_status, &context_handle,",
          "58:                                        GSS_C_NO_BUFFER));",
          "",
          "[Added Lines]",
          "64:     ctx->terminated = 1;",
          "65:     return(GSS_S_COMPLETE);",
          "",
          "---------------"
        ],
        "src/lib/gssapi/krb5/wrap_size_limit.c||src/lib/gssapi/krb5/wrap_size_limit.c": [
          "File: src/lib/gssapi/krb5/wrap_size_limit.c -> src/lib/gssapi/krb5/wrap_size_limit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     }",
          "97:     ctx = (krb5_gss_ctx_id_rec *) context_handle;",
          "100:         return(GSS_S_NO_CONTEXT);",
          "101:     }",
          "",
          "[Removed Lines]",
          "98:     if (! ctx->established) {",
          "",
          "[Added Lines]",
          "98:     if (ctx->terminated || !ctx->established) {",
          "",
          "---------------"
        ],
        "src/tests/gssapi/t_prf.c||src/tests/gssapi/t_prf.c": [
          "File: src/tests/gssapi/t_prf.c -> src/tests/gssapi/t_prf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "127:     uctx.mech_type = &mech_krb5;",
          "128:     uctx.internal_ctx_id = (gss_ctx_id_t)&kgctx;",
          "129:     kgctx.k5_context = NULL;",
          "130:     kgctx.have_acceptor_subkey = 1;",
          "131:     kb1.contents = k1buf;",
          "132:     kb2.contents = k2buf;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130:     kgctx.established = 1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}