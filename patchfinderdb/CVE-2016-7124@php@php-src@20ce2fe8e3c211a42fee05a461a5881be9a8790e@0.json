{
  "cve_id": "CVE-2016-7124",
  "cve_desc": "ext/standard/var_unserializer.c in PHP before 5.6.25 and 7.x before 7.0.10 mishandles certain invalid objects, which allows remote attackers to cause a denial of service or possibly have unspecified other impact via crafted serialized data that leads to a (1) __destruct call or (2) magic method call.",
  "repo": "php/php-src",
  "patch_hash": "20ce2fe8e3c211a42fee05a461a5881be9a8790e",
  "patch_info": {
    "commit_hash": "20ce2fe8e3c211a42fee05a461a5881be9a8790e",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/20ce2fe8e3c211a42fee05a461a5881be9a8790e",
    "files": [
      "ext/standard/tests/strings/bug72663.phpt",
      "ext/standard/tests/strings/bug72663_2.phpt",
      "ext/standard/var_unserializer.c"
    ],
    "message": "Fix bug #72663 - destroy broken object when unserializing\n\n(cherry picked from commit 448c9be157f4147e121f1a2a524536c75c9c6059)",
    "before_after_code_files": [
      "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt",
      "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt",
      "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
    ]
  },
  "patch_diff": {
    "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt": [
      "File: ext/standard/tests/strings/bug72663.phpt -> ext/standard/tests/strings/bug72663.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #72663: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization",
      "3: --FILE--",
      "4: <?php",
      "5: class obj implements Serializable {",
      "6:     var $data;",
      "7:     function serialize() {",
      "8:         return serialize($this->data);",
      "9:     }",
      "10:     function unserialize($data) {",
      "11:         $this->data = unserialize($data);",
      "12:     }",
      "13: }",
      "15: $inner = 'a:1:{i:0;O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:4;}';",
      "16: $exploit = 'a:2:{i:0;C:3:\"obj\":'.strlen($inner).':{'.$inner.'}i:1;R:4;}';",
      "18: $data = unserialize($exploit);",
      "19: echo $data[1];",
      "20: ?>",
      "21: DONE",
      "22: --EXPECTF--",
      "23: Notice: unserialize(): Unexpected end of serialized data in %sbug72663.php on line %d",
      "25: Notice: unserialize(): Error at offset 46 of 47 bytes in %sbug72663.php on line %d",
      "26: DONE",
      "",
      "---------------"
    ],
    "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt": [
      "File: ext/standard/tests/strings/bug72663_2.phpt -> ext/standard/tests/strings/bug72663_2.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #72663: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization",
      "3: --FILE--",
      "4: <?php",
      "6: ini_set('session.serialize_handler', 'php_serialize');",
      "7: session_start();",
      "8: $sess = 'O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:1;}';",
      "9: session_decode($sess);",
      "10: var_dump($_SESSION);",
      "11: ?>",
      "12: DONE",
      "13: --EXPECTF--",
      "14: Notice: session_decode(): Unexpected end of serialized data in %sbug72663_2.php on line %d",
      "15: array(0) {",
      "16: }",
      "17: DONE",
      "",
      "---------------"
    ],
    "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
      "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "687:  if (yybm[0+yych] & 128) {",
      "688:   goto yy20;",
      "689:  }",
      "691:  yych = *++YYCURSOR;",
      "692:  if (yych != '\"') goto yy18;",
      "693:  ++YYCURSOR;",
      "",
      "[Removed Lines]",
      "690:  if (yych != ':') goto yy18;",
      "",
      "[Added Lines]",
      "690:  if (yych <= '/') goto yy18;",
      "691:  if (yych >= ';') goto yy18;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "837:  return object_common2(UNSERIALIZE_PASSTHRU, elements);",
      "838: }",
      "840: yy25:",
      "841:  yych = *++YYCURSOR;",
      "842:  if (yych <= ',') {",
      "",
      "[Removed Lines]",
      "839: #line 804 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "840: #line 805 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "868:  return object_common2(UNSERIALIZE_PASSTHRU,",
      "869:    object_common1(UNSERIALIZE_PASSTHRU, ZEND_STANDARD_CLASS_DEF_PTR));",
      "870: }",
      "872: yy32:",
      "873:  yych = *++YYCURSOR;",
      "874:  if (yych == '+') goto yy33;",
      "",
      "[Removed Lines]",
      "871: #line 836 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "872: #line 837 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "914:  return finish_nested_data(UNSERIALIZE_PASSTHRU);",
      "915: }",
      "917: yy39:",
      "918:  yych = *++YYCURSOR;",
      "919:  if (yych == '+') goto yy40;",
      "",
      "[Removed Lines]",
      "916: #line 881 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "917: #line 882 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "968:  ZVAL_STR(rval, str);",
      "969:  return 1;",
      "970: }",
      "972: yy46:",
      "973:  yych = *++YYCURSOR;",
      "974:  if (yych == '+') goto yy47;",
      "",
      "[Removed Lines]",
      "971: #line 936 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "972: #line 937 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1021:  ZVAL_STRINGL(rval, str, len);",
      "1022:  return 1;",
      "1023: }",
      "1025: yy53:",
      "1026:  yych = *++YYCURSOR;",
      "1027:  if (yych <= '/') {",
      "",
      "[Removed Lines]",
      "1024: #line 989 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1025: #line 990 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1118:  ZVAL_DOUBLE(rval, zend_strtod((const char *)start + 2, NULL));",
      "1119:  return 1;",
      "1120: }",
      "1122: yy65:",
      "1123:  yych = *++YYCURSOR;",
      "1124:  if (yych <= ',') {",
      "",
      "[Removed Lines]",
      "1121: #line 1086 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1122: #line 1087 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1194:  return 1;",
      "1195: }",
      "1197: yy76:",
      "1198:  yych = *++YYCURSOR;",
      "1199:  if (yych == 'N') goto yy73;",
      "",
      "[Removed Lines]",
      "1196: #line 1161 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1197: #line 1162 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1246:  ZVAL_LONG(rval, parse_iv(start + 2));",
      "1247:  return 1;",
      "1248: }",
      "1250: yy83:",
      "1251:  yych = *++YYCURSOR;",
      "1252:  if (yych <= '/') goto yy18;",
      "",
      "[Removed Lines]",
      "1249: #line 1214 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1250: #line 1215 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1260:  ZVAL_BOOL(rval, parse_iv(start + 2));",
      "1261:  return 1;",
      "1262: }",
      "1264: yy87:",
      "1265:  ++YYCURSOR;",
      "1266: #line 573 \"ext/standard/var_unserializer.re\"",
      "",
      "[Removed Lines]",
      "1263: #line 1228 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1264: #line 1229 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1269:  ZVAL_NULL(rval);",
      "1270:  return 1;",
      "1271: }",
      "1273: yy89:",
      "1274:  yych = *++YYCURSOR;",
      "1275:  if (yych <= ',') {",
      "",
      "[Removed Lines]",
      "1272: #line 1237 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1273: #line 1238 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1318:  return 1;",
      "1319: }",
      "1321: yy95:",
      "1322:  yych = *++YYCURSOR;",
      "1323:  if (yych <= ',') {",
      "",
      "[Removed Lines]",
      "1320: #line 1285 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1321: #line 1286 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1367:  return 1;",
      "1368: }",
      "1370: }",
      "1371: #line 886 \"ext/standard/var_unserializer.re\"",
      "",
      "[Removed Lines]",
      "1369: #line 1334 \"ext/standard/var_unserializer.c\"",
      "",
      "[Added Lines]",
      "1370: #line 1335 \"ext/standard/var_unserializer.c\"",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "448c9be157f4147e121f1a2a524536c75c9c6059",
      "candidate_info": {
        "commit_hash": "448c9be157f4147e121f1a2a524536c75c9c6059",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/448c9be157f4147e121f1a2a524536c75c9c6059",
        "files": [
          "ext/standard/tests/strings/bug72663.phpt",
          "ext/standard/tests/strings/bug72663_2.phpt",
          "ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re"
        ],
        "message": "Fix bug #72663 - destroy broken object when unserializing",
        "before_after_code_files": [
          "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt",
          "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt",
          "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt",
            "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt",
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ],
          "candidate": [
            "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt",
            "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt",
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/strings/bug72663.phpt||ext/standard/tests/strings/bug72663.phpt": [
          "File: ext/standard/tests/strings/bug72663.phpt -> ext/standard/tests/strings/bug72663.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72663: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization",
          "3: --FILE--",
          "4: <?php",
          "5: class obj implements Serializable {",
          "6:     var $data;",
          "7:     function serialize() {",
          "8:         return serialize($this->data);",
          "9:     }",
          "10:     function unserialize($data) {",
          "11:         $this->data = unserialize($data);",
          "12:     }",
          "13: }",
          "15: $inner = 'a:1:{i:0;O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:4;}';",
          "16: $exploit = 'a:2:{i:0;C:3:\"obj\":'.strlen($inner).':{'.$inner.'}i:1;R:4;}';",
          "18: $data = unserialize($exploit);",
          "19: echo $data[1];",
          "20: ?>",
          "21: DONE",
          "22: --EXPECTF--",
          "23: Notice: unserialize(): Unexpected end of serialized data in %sbug72663.php on line %d",
          "25: Notice: unserialize(): Error at offset 46 of 47 bytes in %sbug72663.php on line %d",
          "26: DONE",
          "",
          "---------------"
        ],
        "ext/standard/tests/strings/bug72663_2.phpt||ext/standard/tests/strings/bug72663_2.phpt": [
          "File: ext/standard/tests/strings/bug72663_2.phpt -> ext/standard/tests/strings/bug72663_2.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72663: Create an Unexpected Object and Don't Invoke __wakeup() in Deserialization",
          "3: --FILE--",
          "4: <?php",
          "6: ini_set('session.serialize_handler', 'php_serialize');",
          "7: session_start();",
          "8: $sess = 'O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:1;}';",
          "9: session_decode($sess);",
          "10: var_dump($_SESSION);",
          "11: ?>",
          "12: DONE",
          "13: --EXPECTF--",
          "14: Notice: session_decode(): Unexpected end of serialized data in %sbug72663_2.php on line %d",
          "15: array(0) {",
          "16: }",
          "17: DONE",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
          "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "434:  }",
          "436:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {",
          "437:   return 0;",
          "438:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "438:      zend_hash_clean(Z_OBJPROP_PP(rval));",
          "439:      ZVAL_NULL(*rval);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "486: {",
          "487:  YYCTYPE yych;",
          "488:  static const unsigned char yybm[] = {",
          "",
          "[Removed Lines]",
          "485: #line 486 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "488: #line 489 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "542:  yych = *(YYMARKER = ++YYCURSOR);",
          "543:  if (yych == ':') goto yy95;",
          "544: yy3:",
          "546:  { return 0; }",
          "548: yy4:",
          "549:  yych = *(YYMARKER = ++YYCURSOR);",
          "550:  if (yych == ':') goto yy89;",
          "",
          "[Removed Lines]",
          "545: #line 851 \"ext/standard/var_unserializer.re\"",
          "547: #line 548 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "548: #line 854 \"ext/standard/var_unserializer.re\"",
          "550: #line 551 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "587:  goto yy3;",
          "588: yy14:",
          "589:  ++YYCURSOR;",
          "591:  {",
          "593:  php_error_docref(NULL TSRMLS_CC, E_NOTICE, \"Unexpected end of serialized data\");",
          "595: }",
          "597: yy16:",
          "598:  yych = *++YYCURSOR;",
          "599:  goto yy3;",
          "",
          "[Removed Lines]",
          "590: #line 845 \"ext/standard/var_unserializer.re\"",
          "596: #line 597 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "593: #line 848 \"ext/standard/var_unserializer.re\"",
          "599: #line 600 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "619:  if (yybm[0+yych] & 128) {",
          "620:   goto yy20;",
          "621:  }",
          "623:  yych = *++YYCURSOR;",
          "624:  if (yych != '\"') goto yy18;",
          "625:  ++YYCURSOR;",
          "627:  {",
          "628:  size_t len, len2, len3, maxlen;",
          "629:  long elements;",
          "",
          "[Removed Lines]",
          "622:  if (yych != ':') goto yy18;",
          "626: #line 698 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "625:  if (yych <= '/') goto yy18;",
          "626:  if (yych >= ';') goto yy18;",
          "630: #line 701 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "771:  return object_common2(UNSERIALIZE_PASSTHRU, elements);",
          "772: }",
          "774: yy25:",
          "775:  yych = *++YYCURSOR;",
          "776:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "773: #line 774 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "777: #line 778 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "795:  yych = *++YYCURSOR;",
          "796:  if (yych != '\"') goto yy18;",
          "797:  ++YYCURSOR;",
          "799:  {",
          "800:     if (!var_hash) return 0;",
          "",
          "[Removed Lines]",
          "798: #line 689 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "802: #line 692 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "804:  return object_common2(UNSERIALIZE_PASSTHRU,",
          "805:    object_common1(UNSERIALIZE_PASSTHRU, ZEND_STANDARD_CLASS_DEF_PTR));",
          "806: }",
          "808: yy32:",
          "809:  yych = *++YYCURSOR;",
          "810:  if (yych == '+') goto yy33;",
          "",
          "[Removed Lines]",
          "807: #line 808 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "811: #line 812 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "825:  yych = *++YYCURSOR;",
          "826:  if (yych != '{') goto yy18;",
          "827:  ++YYCURSOR;",
          "829:  {",
          "830:  long elements = parse_iv(start + 2);",
          "",
          "[Removed Lines]",
          "828: #line 668 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "832: #line 671 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "847:  return finish_nested_data(UNSERIALIZE_PASSTHRU);",
          "848: }",
          "850: yy39:",
          "851:  yych = *++YYCURSOR;",
          "852:  if (yych == '+') goto yy40;",
          "",
          "[Removed Lines]",
          "849: #line 850 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "853: #line 854 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "867:  yych = *++YYCURSOR;",
          "868:  if (yych != '\"') goto yy18;",
          "869:  ++YYCURSOR;",
          "871:  {",
          "872:  size_t len, maxlen;",
          "873:  char *str;",
          "",
          "[Removed Lines]",
          "870: #line 633 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "874: #line 636 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "902:  ZVAL_STRINGL(*rval, str, len, 0);",
          "903:  return 1;",
          "904: }",
          "906: yy46:",
          "907:  yych = *++YYCURSOR;",
          "908:  if (yych == '+') goto yy47;",
          "",
          "[Removed Lines]",
          "905: #line 906 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "909: #line 910 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "923:  yych = *++YYCURSOR;",
          "924:  if (yych != '\"') goto yy18;",
          "925:  ++YYCURSOR;",
          "927:  {",
          "928:  size_t len, maxlen;",
          "929:  char *str;",
          "",
          "[Removed Lines]",
          "926: #line 600 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "930: #line 603 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "956:  ZVAL_STRINGL(*rval, str, len, 1);",
          "957:  return 1;",
          "958: }",
          "960: yy53:",
          "961:  yych = *++YYCURSOR;",
          "962:  if (yych <= '/') {",
          "",
          "[Removed Lines]",
          "959: #line 960 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "963: #line 964 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1044:  }",
          "1045: yy63:",
          "1046:  ++YYCURSOR;",
          "1048:  {",
          "1049: #if SIZEOF_LONG == 4",
          "1050: use_double:",
          "",
          "[Removed Lines]",
          "1047: #line 590 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1051: #line 593 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1054:  ZVAL_DOUBLE(*rval, zend_strtod((const char *)start + 2, NULL));",
          "1055:  return 1;",
          "1056: }",
          "1058: yy65:",
          "1059:  yych = *++YYCURSOR;",
          "1060:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1057: #line 1058 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1061: #line 1062 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1113:  yych = *++YYCURSOR;",
          "1114:  if (yych != ';') goto yy18;",
          "1115:  ++YYCURSOR;",
          "1117:  {",
          "1119:  INIT_PZVAL(*rval);",
          "",
          "[Removed Lines]",
          "1116: #line 575 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1120: #line 578 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "1129:  return 1;",
          "1130: }",
          "1132: yy76:",
          "1133:  yych = *++YYCURSOR;",
          "1134:  if (yych == 'N') goto yy73;",
          "",
          "[Removed Lines]",
          "1131: #line 1132 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1135: #line 1136 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "1155:  if (yych <= '9') goto yy79;",
          "1156:  if (yych != ';') goto yy18;",
          "1157:  ++YYCURSOR;",
          "1159:  {",
          "1160: #if SIZEOF_LONG == 4",
          "1161:  int digits = YYCURSOR - start - 3;",
          "",
          "[Removed Lines]",
          "1158: #line 548 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1162: #line 551 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "1182:  ZVAL_LONG(*rval, parse_iv(start + 2));",
          "1183:  return 1;",
          "1184: }",
          "1186: yy83:",
          "1187:  yych = *++YYCURSOR;",
          "1188:  if (yych <= '/') goto yy18;",
          "",
          "[Removed Lines]",
          "1185: #line 1186 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1189: #line 1190 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "1190:  yych = *++YYCURSOR;",
          "1191:  if (yych != ';') goto yy18;",
          "1192:  ++YYCURSOR;",
          "1194:  {",
          "1196:  INIT_PZVAL(*rval);",
          "1197:  ZVAL_BOOL(*rval, parse_iv(start + 2));",
          "1198:  return 1;",
          "1199: }",
          "1201: yy87:",
          "1202:  ++YYCURSOR;",
          "1204:  {",
          "1206:  INIT_PZVAL(*rval);",
          "1207:  ZVAL_NULL(*rval);",
          "1208:  return 1;",
          "1209: }",
          "1211: yy89:",
          "1212:  yych = *++YYCURSOR;",
          "1213:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1193: #line 541 \"ext/standard/var_unserializer.re\"",
          "1200: #line 1201 \"ext/standard/var_unserializer.c\"",
          "1203: #line 534 \"ext/standard/var_unserializer.re\"",
          "1210: #line 1211 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1197: #line 544 \"ext/standard/var_unserializer.re\"",
          "1204: #line 1205 \"ext/standard/var_unserializer.c\"",
          "1207: #line 537 \"ext/standard/var_unserializer.re\"",
          "1214: #line 1215 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 22 ---",
          "[Context before]",
          "1230:  if (yych <= '9') goto yy91;",
          "1231:  if (yych != ';') goto yy18;",
          "1232:  ++YYCURSOR;",
          "1234:  {",
          "1235:  long id;",
          "",
          "[Removed Lines]",
          "1233: #line 511 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1237: #line 514 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 23 ---",
          "[Context before]",
          "1254:  return 1;",
          "1255: }",
          "1257: yy95:",
          "1258:  yych = *++YYCURSOR;",
          "1259:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1256: #line 1257 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1260: #line 1261 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 24 ---",
          "[Context before]",
          "1276:  if (yych <= '9') goto yy97;",
          "1277:  if (yych != ';') goto yy18;",
          "1278:  ++YYCURSOR;",
          "1280:  {",
          "1281:  long id;",
          "",
          "[Removed Lines]",
          "1279: #line 490 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1283: #line 493 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 25 ---",
          "[Context before]",
          "1298:  return 1;",
          "1299: }",
          "1301: }",
          "1305:  return 0;",
          "",
          "[Removed Lines]",
          "1300: #line 1301 \"ext/standard/var_unserializer.c\"",
          "1302: #line 853 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1304: #line 1305 \"ext/standard/var_unserializer.c\"",
          "1306: #line 856 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re": [
          "File: ext/standard/var_unserializer.re -> ext/standard/var_unserializer.re",
          "--- Hunk 1 ---",
          "[Context before]",
          "438:  }",
          "440:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_OBJPROP_PP(rval), elements, 1)) {",
          "441:   return 0;",
          "442:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "442:      zend_hash_clean(Z_OBJPROP_PP(rval));",
          "443:      ZVAL_NULL(*rval);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d3221181c3a27e7f1e23c6db1266fde820d471d7",
      "candidate_info": {
        "commit_hash": "d3221181c3a27e7f1e23c6db1266fde820d471d7",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/d3221181c3a27e7f1e23c6db1266fde820d471d7",
        "files": [
          "ext/standard/tests/serialize/bug72663_2.phpt",
          "ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re"
        ],
        "message": "Bug #72663 - part 2\n\nIf a (nested) unserialize() call fails, we remove all the values\nthat were inserted into var_hash during that call. This prevents\ntheir use in other unserializations in the same context.\n\n(cherry picked from commit 61f2f5a0f760157f9c9d32d7d3df2be47a73e74d)",
        "before_after_code_files": [
          "ext/standard/tests/serialize/bug72663_2.phpt||ext/standard/tests/serialize/bug72663_2.phpt",
          "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ],
          "candidate": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/serialize/bug72663_2.phpt||ext/standard/tests/serialize/bug72663_2.phpt": [
          "File: ext/standard/tests/serialize/bug72663_2.phpt -> ext/standard/tests/serialize/bug72663_2.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72663 (2): Don't allow references into failed unserialize",
          "3: --FILE--",
          "4: <?php",
          "6: class obj implements Serializable {",
          "7:     public $data;",
          "8:     function serialize() {",
          "9:         return serialize($this->data);",
          "10:     }",
          "11:     function unserialize($data) {",
          "12:         $this->data = unserialize($data);",
          "13:     }",
          "14: }",
          "16: $inner = 'a:1:{i:0;O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:4;}';",
          "17: $exploit = 'a:2:{i:0;C:3:\"obj\":'.strlen($inner).':{'.$inner.'}i:1;R:4;}';",
          "18: var_dump(unserialize($exploit));",
          "20: ?>",
          "21: --EXPECTF--",
          "22: Notice: unserialize(): Unexpected end of serialized data in %s on line %d",
          "24: Notice: unserialize(): Error at offset 46 of 47 bytes in %s on line %d",
          "26: Notice: unserialize(): Error at offset 79 of 80 bytes in %s on line %d",
          "27: bool(false)",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
          "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "301: #define UNSERIALIZE_PARAMETER zval *rval, const unsigned char **p, const unsigned char *max, php_unserialize_data_t *var_hash, HashTable *classes",
          "302: #define UNSERIALIZE_PASSTHRU rval, p, max, var_hash, classes",
          "304: static zend_always_inline int process_nested_data(UNSERIALIZE_PARAMETER, HashTable *ht, zend_long elements, int objprops)",
          "305: {",
          "306:  while (elements-- > 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "304: static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "310:   ZVAL_UNDEF(&key);",
          "313:    zval_dtor(&key);",
          "314:    return 0;",
          "315:   }",
          "",
          "[Removed Lines]",
          "312:   if (!php_var_unserialize_ex(&key, p, max, NULL, classes)) {",
          "",
          "[Added Lines]",
          "314:   if (!php_var_unserialize_internal(&key, p, max, NULL, classes)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "365:    }",
          "366:   }",
          "369:    zval_dtor(&key);",
          "370:    return 0;",
          "371:   }",
          "",
          "[Removed Lines]",
          "368:   if (!php_var_unserialize_ex(data, p, max, var_hash, classes)) {",
          "",
          "[Added Lines]",
          "370:   if (!php_var_unserialize_internal(data, p, max, var_hash, classes)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "502:  return php_var_unserialize_ex(UNSERIALIZE_PASSTHRU);",
          "503: }",
          "506: PHPAPI int php_var_unserialize_ex(UNSERIALIZE_PARAMETER)",
          "507: {",
          "508:  const unsigned char *cursor, *limit, *marker, *start;",
          "509:  zval *rval_ref;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "508: {",
          "509:  var_entries *orig_var_entries = (*var_hash)->last;",
          "510:  zend_long orig_used_slots = orig_var_entries ? orig_var_entries->used_slots : 0;",
          "511:  int result;",
          "513:  result = php_var_unserialize_internal(UNSERIALIZE_PASSTHRU);",
          "515:  if (!result) {",
          "519:   var_entries *e = orig_var_entries;",
          "520:   zend_long s = orig_used_slots;",
          "521:   while (e) {",
          "522:    for (; s < e->used_slots; s++) {",
          "523:     e->data[s] = NULL;",
          "524:    }",
          "526:    e = e->next;",
          "527:    s = 0;",
          "528:   }",
          "529:  }",
          "531:  return result;",
          "532: }",
          "534: static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "522:  start = cursor;",
          "526: {",
          "527:  YYCTYPE yych;",
          "528:  static const unsigned char yybm[] = {",
          "",
          "[Removed Lines]",
          "525: #line 526 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "553: #line 554 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re": [
          "File: ext/standard/var_unserializer.re -> ext/standard/var_unserializer.re",
          "--- Hunk 1 ---",
          "[Context before]",
          "305: #define UNSERIALIZE_PARAMETER zval *rval, const unsigned char **p, const unsigned char *max, php_unserialize_data_t *var_hash, HashTable *classes",
          "306: #define UNSERIALIZE_PASSTHRU rval, p, max, var_hash, classes",
          "308: static zend_always_inline int process_nested_data(UNSERIALIZE_PARAMETER, HashTable *ht, zend_long elements, int objprops)",
          "309: {",
          "310:  while (elements-- > 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "308: static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "314:   ZVAL_UNDEF(&key);",
          "317:    zval_dtor(&key);",
          "318:    return 0;",
          "319:   }",
          "",
          "[Removed Lines]",
          "316:   if (!php_var_unserialize_ex(&key, p, max, NULL, classes)) {",
          "",
          "[Added Lines]",
          "318:   if (!php_var_unserialize_internal(&key, p, max, NULL, classes)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "369:    }",
          "370:   }",
          "373:    zval_dtor(&key);",
          "374:    return 0;",
          "375:   }",
          "",
          "[Removed Lines]",
          "372:   if (!php_var_unserialize_ex(data, p, max, var_hash, classes)) {",
          "",
          "[Added Lines]",
          "374:   if (!php_var_unserialize_internal(data, p, max, var_hash, classes)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "506:  return php_var_unserialize_ex(UNSERIALIZE_PASSTHRU);",
          "507: }",
          "510: PHPAPI int php_var_unserialize_ex(UNSERIALIZE_PARAMETER)",
          "511: {",
          "512:  const unsigned char *cursor, *limit, *marker, *start;",
          "513:  zval *rval_ref;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "512: {",
          "513:  var_entries *orig_var_entries = (*var_hash)->last;",
          "514:  zend_long orig_used_slots = orig_var_entries ? orig_var_entries->used_slots : 0;",
          "515:  int result;",
          "517:  result = php_var_unserialize_internal(UNSERIALIZE_PASSTHRU);",
          "519:  if (!result) {",
          "523:   var_entries *e = orig_var_entries;",
          "524:   zend_long s = orig_used_slots;",
          "525:   while (e) {",
          "526:    for (; s < e->used_slots; s++) {",
          "527:     e->data[s] = NULL;",
          "528:    }",
          "530:    e = e->next;",
          "531:    s = 0;",
          "532:   }",
          "533:  }",
          "535:  return result;",
          "536: }",
          "538: static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "686f4e01e67da63642f709688aa578bf054c8a32",
      "candidate_info": {
        "commit_hash": "686f4e01e67da63642f709688aa578bf054c8a32",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/686f4e01e67da63642f709688aa578bf054c8a32",
        "files": [
          "ext/standard/tests/serialize/bug72663.phpt",
          "ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re"
        ],
        "message": "Bug #72663 - part 1\n\nDon't call __destruct() on an unserialized object that has a\n__wakeup() method if either\na) unserialization of its properties fails or\nb) the __wakeup() call fails (e.g. by throwing).\n\nThis basically treats __wakeup() as a form of constructor and\naligns us with the usual behavior that if the constructor call\nfails the destructor should not be called.\n\nThe security aspect here is that people use __wakeup() to prevent\nunserialization of objects with dangerous __destruct() methods,\nbut this is ineffective if __destruct() can still be called while\n__wakeup() was skipped.\n\n(cherry picked from commit 2135fdef9b588a34f8805b2bbf10704e36163d5a)",
        "before_after_code_files": [
          "ext/standard/tests/serialize/bug72663.phpt||ext/standard/tests/serialize/bug72663.phpt",
          "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ],
          "candidate": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/serialize/bug72663.phpt||ext/standard/tests/serialize/bug72663.phpt": [
          "File: ext/standard/tests/serialize/bug72663.phpt -> ext/standard/tests/serialize/bug72663.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72663 (1): Don't call __destruct if __wakeup not called or fails",
          "3: --FILE--",
          "4: <?php",
          "6: class Test1 {",
          "7:     public function __wakeup() {",
          "8:         echo \"Wakeup\\n\";",
          "9:     }",
          "10:     public function __destruct() {",
          "11:         echo \"Dtor\\n\";",
          "12:     }",
          "13: }",
          "15: class Test2 {",
          "16:     public function __wakeup() {",
          "17:         throw new Exception('Unserialization forbidden');",
          "18:     }",
          "19:     public function __destruct() {",
          "20:         echo \"Dtor\\n\";",
          "21:     }",
          "22: }",
          "25: $s = 'O:5:\"Test1\":1:{s:10:\"\";}';",
          "26: var_dump(unserialize($s));",
          "29: $s = 'O:5:\"Test1\":2:{i:0;R:1;s:10:\"\";}';",
          "30: var_dump(unserialize($s));",
          "33: $s = 'O:5:\"Test2\":0:{}';",
          "34: try {",
          "35:     var_dump(unserialize($s));",
          "36: } catch (Exception $e) {",
          "37:     echo \"Caught\\n\";",
          "38: }",
          "41: $s = 'O:5:\"Test2\":1:{i:0;R:1;}';",
          "42: try {",
          "43:     var_dump(unserialize($s));",
          "44: } catch (Exception $e) {",
          "45:     echo \"Caught\\n\";",
          "46: }",
          "48: ?>",
          "49: --EXPECTF--",
          "50: Notice: unserialize(): Error at offset 17 of 24 bytes in %s on line %d",
          "51: bool(false)",
          "53: Notice: unserialize(): Error at offset 25 of 32 bytes in %s on line %d",
          "54: bool(false)",
          "55: Caught",
          "56: Caught",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
          "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "455:  zval retval;",
          "456:  zval fname;",
          "457:  HashTable *ht;",
          "459:  if (Z_TYPE_P(rval) != IS_OBJECT) {",
          "460:   return 0;",
          "461:  }",
          "463:  ht = Z_OBJPROP_P(rval);",
          "464:  zend_hash_extend(ht, zend_hash_num_elements(ht) + elements, (ht->u.flags & HASH_FLAG_PACKED));",
          "465:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, ht, elements, 1)) {",
          "466:   return 0;",
          "467:  }",
          "469:  ZVAL_DEREF(rval);",
          "472:   ZVAL_STRINGL(&fname, \"__wakeup\", sizeof(\"__wakeup\") - 1);",
          "473:   BG(serialize_lock)++;",
          "475:   BG(serialize_lock)--;",
          "476:   zval_dtor(&fname);",
          "477:   zval_dtor(&retval);",
          "",
          "[Removed Lines]",
          "470:  if (Z_OBJCE_P(rval) != PHP_IC_ENTRY &&",
          "471:   zend_hash_str_exists(&Z_OBJCE_P(rval)->function_table, \"__wakeup\", sizeof(\"__wakeup\")-1)) {",
          "474:   call_user_function_ex(CG(function_table), rval, &fname, &retval, 0, 0, 1, NULL);",
          "",
          "[Added Lines]",
          "458:  zend_bool has_wakeup;",
          "464:  has_wakeup = Z_OBJCE_P(rval) != PHP_IC_ENTRY",
          "465:   && zend_hash_str_exists(&Z_OBJCE_P(rval)->function_table, \"__wakeup\", sizeof(\"__wakeup\")-1);",
          "470:   if (has_wakeup) {",
          "471:    ZVAL_DEREF(rval);",
          "472:    GC_FLAGS(Z_OBJ_P(rval)) |= IS_OBJ_DESTRUCTOR_CALLED;",
          "473:   }",
          "478:  if (has_wakeup) {",
          "481:   if (call_user_function_ex(CG(function_table), rval, &fname, &retval, 0, 0, 1, NULL) == FAILURE || Z_ISUNDEF(retval)) {",
          "482:    GC_FLAGS(Z_OBJ_P(rval)) |= IS_OBJ_DESTRUCTOR_CALLED;",
          "483:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "514:  start = cursor;",
          "518: {",
          "519:  YYCTYPE yych;",
          "520:  static const unsigned char yybm[] = {",
          "",
          "[Removed Lines]",
          "517: #line 518 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "525: #line 526 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re": [
          "File: ext/standard/var_unserializer.re -> ext/standard/var_unserializer.re",
          "--- Hunk 1 ---",
          "[Context before]",
          "459:  zval retval;",
          "460:  zval fname;",
          "461:  HashTable *ht;",
          "463:  if (Z_TYPE_P(rval) != IS_OBJECT) {",
          "464:   return 0;",
          "465:  }",
          "467:  ht = Z_OBJPROP_P(rval);",
          "468:  zend_hash_extend(ht, zend_hash_num_elements(ht) + elements, (ht->u.flags & HASH_FLAG_PACKED));",
          "469:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, ht, elements, 1)) {",
          "470:   return 0;",
          "471:  }",
          "473:  ZVAL_DEREF(rval);",
          "476:   ZVAL_STRINGL(&fname, \"__wakeup\", sizeof(\"__wakeup\") - 1);",
          "477:   BG(serialize_lock)++;",
          "479:   BG(serialize_lock)--;",
          "480:   zval_dtor(&fname);",
          "481:   zval_dtor(&retval);",
          "",
          "[Removed Lines]",
          "474:  if (Z_OBJCE_P(rval) != PHP_IC_ENTRY &&",
          "475:   zend_hash_str_exists(&Z_OBJCE_P(rval)->function_table, \"__wakeup\", sizeof(\"__wakeup\")-1)) {",
          "478:   call_user_function_ex(CG(function_table), rval, &fname, &retval, 0, 0, 1, NULL);",
          "",
          "[Added Lines]",
          "462:  zend_bool has_wakeup;",
          "468:  has_wakeup = Z_OBJCE_P(rval) != PHP_IC_ENTRY",
          "469:   && zend_hash_str_exists(&Z_OBJCE_P(rval)->function_table, \"__wakeup\", sizeof(\"__wakeup\")-1);",
          "474:   if (has_wakeup) {",
          "475:    ZVAL_DEREF(rval);",
          "476:    GC_FLAGS(Z_OBJ_P(rval)) |= IS_OBJ_DESTRUCTOR_CALLED;",
          "477:   }",
          "482:  if (has_wakeup) {",
          "485:   if (call_user_function_ex(CG(function_table), rval, &fname, &retval, 0, 0, 1, NULL) == FAILURE || Z_ISUNDEF(retval)) {",
          "486:    GC_FLAGS(Z_OBJ_P(rval)) |= IS_OBJ_DESTRUCTOR_CALLED;",
          "487:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "758a0cd8b3941935b5ec10256c336544e0d6ad41",
      "candidate_info": {
        "commit_hash": "758a0cd8b3941935b5ec10256c336544e0d6ad41",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/758a0cd8b3941935b5ec10256c336544e0d6ad41",
        "files": [
          "ext/session/session.c",
          "ext/standard/tests/serialize/bug72663_3.phpt",
          "ext/wddx/wddx.c"
        ],
        "message": "Bug #72663 - part 3\n\nWhen using the php_serialize session serialization handler, do\nnot use the result of the unserialization if it failed.\n\n(cherry picked from commit e0f9fbdfa61012101de7f4a8653ca5538c404a71)",
        "before_after_code_files": [
          "ext/session/session.c||ext/session/session.c",
          "ext/standard/tests/serialize/bug72663_3.phpt||ext/standard/tests/serialize/bug72663_3.phpt",
          "ext/wddx/wddx.c||ext/wddx/wddx.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "ext/session/session.c||ext/session/session.c": [
          "File: ext/session/session.c -> ext/session/session.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "905:  const char *endptr = val + vallen;",
          "906:  zval session_vars;",
          "907:  php_unserialize_data_t var_hash;",
          "908:  zend_string *var_name = zend_string_init(\"_SESSION\", sizeof(\"_SESSION\") - 1, 0);",
          "910:  ZVAL_NULL(&session_vars);",
          "911:  PHP_VAR_UNSERIALIZE_INIT(var_hash);",
          "913:  PHP_VAR_UNSERIALIZE_DESTROY(var_hash);",
          "914:  if (!Z_ISUNDEF(PS(http_session_vars))) {",
          "915:   zval_ptr_dtor(&PS(http_session_vars));",
          "916:  }",
          "",
          "[Removed Lines]",
          "912:  php_var_unserialize(&session_vars, (const unsigned char **)&val, (const unsigned char *)endptr, &var_hash);",
          "",
          "[Added Lines]",
          "908:  int result;",
          "913:  result = php_var_unserialize(",
          "914:   &session_vars, (const unsigned char **)&val, (const unsigned char *)endptr, &var_hash);",
          "916:  if (!result) {",
          "917:   zval_ptr_dtor(&session_vars);",
          "918:   ZVAL_NULL(&session_vars);",
          "919:  }",
          "",
          "---------------"
        ],
        "ext/standard/tests/serialize/bug72663_3.phpt||ext/standard/tests/serialize/bug72663_3.phpt": [
          "File: ext/standard/tests/serialize/bug72663_3.phpt -> ext/standard/tests/serialize/bug72663_3.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72663 (3): If unserialization fails, don't initialize the session with the result",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded('session')) die('skip Session extension required'); ?>",
          "5: --INI--",
          "6: session.serialize_handler=php_serialize",
          "7: --FILE--",
          "8: <?php",
          "9: session_start();",
          "10: $sess = 'O:9:\"Exception\":2:{s:7:\"'.\"\\0\".'*'.\"\\0\".'file\";R:1;}';",
          "11: session_decode($sess);",
          "12: var_dump($_SESSION);",
          "13: ?>",
          "14: --EXPECTF--",
          "15: Notice: session_decode(): Unexpected end of serialized data in %s on line %d",
          "16: array(0) {",
          "17: }",
          "",
          "---------------"
        ],
        "ext/wddx/wddx.c||ext/wddx/wddx.c": [
          "File: ext/wddx/wddx.c -> ext/wddx/wddx.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1090:  if (stack.top == 1) {",
          "1091:   wddx_stack_top(&stack, (void**)&ent);",
          "1094:  } else {",
          "1095:   retval = FAILURE;",
          "1096:  }",
          "",
          "[Removed Lines]",
          "1092:   ZVAL_COPY(return_value, &ent->data);",
          "1093:   retval = SUCCESS;",
          "",
          "[Added Lines]",
          "1092:   if (Z_ISUNDEF(ent->data)) {",
          "1093:    retval = FAILURE;",
          "1094:   } else {",
          "1095:    ZVAL_COPY(return_value, &ent->data);",
          "1096:    retval = SUCCESS;",
          "1097:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8fe171a3e046717ec0109297bcd765bdee3e939c",
      "candidate_info": {
        "commit_hash": "8fe171a3e046717ec0109297bcd765bdee3e939c",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/8fe171a3e046717ec0109297bcd765bdee3e939c",
        "files": [
          "ext/standard/array.c",
          "ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re"
        ],
        "message": "Don't allocate memory for empty HashTables.",
        "before_after_code_files": [
          "ext/standard/array.c||ext/standard/array.c",
          "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c",
          "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ],
          "candidate": [
            "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/array.c||ext/standard/array.c": [
          "File: ext/standard/array.c -> ext/standard/array.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3308:   }",
          "3309:  } else {",
          "3310:   array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(input)));",
          "3311:   zend_hash_real_init(Z_ARRVAL_P(return_value), 1);",
          "3312:   ZEND_HASH_FILL_PACKED(Z_ARRVAL_P(return_value)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3311:   if (!zend_hash_num_elements(Z_ARRVAL_P(input))) {",
          "3312:    return;",
          "3313:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3345:  array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(input)));",
          "3346:  zend_hash_real_init(Z_ARRVAL_P(return_value), 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3350:  if (!zend_hash_num_elements(Z_ARRVAL_P(input))) {",
          "3351:   return;",
          "3352:  }",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.c||ext/standard/var_unserializer.c": [
          "File: ext/standard/var_unserializer.c -> ext/standard/var_unserializer.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "599:  yych = *(YYMARKER = ++YYCURSOR);",
          "600:  if (yych == ':') goto yy95;",
          "601: yy3:",
          "603:  { return 0; }",
          "604: #line 605 \"ext/standard/var_unserializer.c\"",
          "605: yy4:",
          "",
          "[Removed Lines]",
          "602: #line 893 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "602: #line 895 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "644:  goto yy3;",
          "645: yy14:",
          "646:  ++YYCURSOR;",
          "648:  {",
          "650:  php_error_docref(NULL, E_NOTICE, \"Unexpected end of serialized data\");",
          "",
          "[Removed Lines]",
          "647: #line 887 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "647: #line 889 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "676:  if (yybm[0+yych] & 128) {",
          "677:   goto yy20;",
          "678:  }",
          "681:  yych = *++YYCURSOR;",
          "682:  if (yych != '\"') goto yy18;",
          "683:  ++YYCURSOR;",
          "685:  {",
          "686:  size_t len, len2, len3, maxlen;",
          "687:  zend_long elements;",
          "",
          "[Removed Lines]",
          "679:  if (yych <= '/') goto yy18;",
          "680:  if (yych >= ';') goto yy18;",
          "684: #line 741 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "679:  if (yych != ':') goto yy18;",
          "683: #line 743 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "828:  return object_common2(UNSERIALIZE_PASSTHRU, elements);",
          "829: }",
          "831: yy25:",
          "832:  yych = *++YYCURSOR;",
          "833:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "830: #line 831 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "829: #line 830 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "852:  yych = *++YYCURSOR;",
          "853:  if (yych != '\"') goto yy18;",
          "854:  ++YYCURSOR;",
          "856:  {",
          "857:     if (!var_hash) return 0;",
          "",
          "[Removed Lines]",
          "855: #line 732 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "854: #line 734 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "861:  return object_common2(UNSERIALIZE_PASSTHRU,",
          "862:    object_common1(UNSERIALIZE_PASSTHRU, ZEND_STANDARD_CLASS_DEF_PTR));",
          "863: }",
          "865: yy32:",
          "866:  yych = *++YYCURSOR;",
          "867:  if (yych == '+') goto yy33;",
          "",
          "[Removed Lines]",
          "864: #line 865 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "863: #line 864 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "896:  array_init_size(rval, elements);",
          "901:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {",
          "902:   return 0;",
          "",
          "[Removed Lines]",
          "899:  zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "",
          "[Added Lines]",
          "898:  if (elements) {",
          "899:   zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "900:  }",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "905:  return finish_nested_data(UNSERIALIZE_PASSTHRU);",
          "906: }",
          "908: yy39:",
          "909:  yych = *++YYCURSOR;",
          "910:  if (yych == '+') goto yy40;",
          "",
          "[Removed Lines]",
          "907: #line 908 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "908: #line 909 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "953:  ZVAL_STR(rval, str);",
          "954:  return 1;",
          "955: }",
          "957: yy46:",
          "958:  yych = *++YYCURSOR;",
          "959:  if (yych == '+') goto yy47;",
          "",
          "[Removed Lines]",
          "956: #line 957 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "957: #line 958 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1001:  ZVAL_STRINGL(rval, str, len);",
          "1002:  return 1;",
          "1003: }",
          "1005: yy53:",
          "1006:  yych = *++YYCURSOR;",
          "1007:  if (yych <= '/') {",
          "",
          "[Removed Lines]",
          "1004: #line 1005 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1005: #line 1006 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1098:  ZVAL_DOUBLE(rval, zend_strtod((const char *)start + 2, NULL));",
          "1099:  return 1;",
          "1100: }",
          "1102: yy65:",
          "1103:  yych = *++YYCURSOR;",
          "1104:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1101: #line 1102 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1102: #line 1103 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1174:  return 1;",
          "1175: }",
          "1177: yy76:",
          "1178:  yych = *++YYCURSOR;",
          "1179:  if (yych == 'N') goto yy73;",
          "",
          "[Removed Lines]",
          "1176: #line 1177 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1177: #line 1178 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1226:  ZVAL_LONG(rval, parse_iv(start + 2));",
          "1227:  return 1;",
          "1228: }",
          "1230: yy83:",
          "1231:  yych = *++YYCURSOR;",
          "1232:  if (yych <= '/') goto yy18;",
          "",
          "[Removed Lines]",
          "1229: #line 1230 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1230: #line 1231 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "1240:  ZVAL_BOOL(rval, parse_iv(start + 2));",
          "1241:  return 1;",
          "1242: }",
          "1244: yy87:",
          "1245:  ++YYCURSOR;",
          "1246: #line 592 \"ext/standard/var_unserializer.re\"",
          "",
          "[Removed Lines]",
          "1243: #line 1244 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1244: #line 1245 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "1249:  ZVAL_NULL(rval);",
          "1250:  return 1;",
          "1251: }",
          "1253: yy89:",
          "1254:  yych = *++YYCURSOR;",
          "1255:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1252: #line 1253 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1253: #line 1254 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "1296:  return 1;",
          "1297: }",
          "1299: yy95:",
          "1300:  yych = *++YYCURSOR;",
          "1301:  if (yych <= ',') {",
          "",
          "[Removed Lines]",
          "1298: #line 1299 \"ext/standard/var_unserializer.c\"",
          "",
          "[Added Lines]",
          "1299: #line 1300 \"ext/standard/var_unserializer.c\"",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "1341:  return 1;",
          "1342: }",
          "1344: }",
          "1348:  return 0;",
          "",
          "[Removed Lines]",
          "1343: #line 1344 \"ext/standard/var_unserializer.c\"",
          "1345: #line 895 \"ext/standard/var_unserializer.re\"",
          "",
          "[Added Lines]",
          "1344: #line 1345 \"ext/standard/var_unserializer.c\"",
          "1346: #line 897 \"ext/standard/var_unserializer.re\"",
          "",
          "---------------"
        ],
        "ext/standard/var_unserializer.re||ext/standard/var_unserializer.re": [
          "File: ext/standard/var_unserializer.re -> ext/standard/var_unserializer.re",
          "--- Hunk 1 ---",
          "[Context before]",
          "720:  array_init_size(rval, elements);",
          "725:  if (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {",
          "726:   return 0;",
          "",
          "[Removed Lines]",
          "723:  zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "",
          "[Added Lines]",
          "723:  if (elements) {",
          "724:   zend_hash_real_init(Z_ARRVAL_P(rval), 0);",
          "725:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}