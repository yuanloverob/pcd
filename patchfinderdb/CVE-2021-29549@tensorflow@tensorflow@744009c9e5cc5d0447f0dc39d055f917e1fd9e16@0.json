{
  "cve_id": "CVE-2021-29549",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can cause a runtime division by zero error and denial of service in `tf.raw_ops.QuantizedBatchNormWithGlobalNormalization`. This is because the implementation(https://github.com/tensorflow/tensorflow/blob/6f26b3f3418201479c264f2a02000880d8df151c/tensorflow/core/kernels/quantized_add_op.cc#L289-L295) computes a modulo operation without validating that the divisor is not zero. Since `vector_num_elements` is determined based on input shapes(https://github.com/tensorflow/tensorflow/blob/6f26b3f3418201479c264f2a02000880d8df151c/tensorflow/core/kernels/quantized_add_op.cc#L522-L544), a user can trigger scenarios where this quantity is 0. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "744009c9e5cc5d0447f0dc39d055f917e1fd9e16",
  "patch_info": {
    "commit_hash": "744009c9e5cc5d0447f0dc39d055f917e1fd9e16",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/744009c9e5cc5d0447f0dc39d055f917e1fd9e16",
    "files": [
      "tensorflow/core/kernels/quantized_add_op.cc"
    ],
    "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
    "before_after_code_files": [
      "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
      "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "538:         tensor_min = min_x;",
      "539:         tensor_max = max_x;",
      "540:       }",
      "541:       VectorTensorAddition<T, Toutput>(",
      "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
      "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "541:       OP_REQUIRES(context, vector_num_elements > 0,",
      "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cac81f4123b88df0b4c3c6dfbce948c87e98c8ec",
      "candidate_info": {
        "commit_hash": "cac81f4123b88df0b4c3c6dfbce948c87e98c8ec",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/cac81f4123b88df0b4c3c6dfbce948c87e98c8ec",
        "files": [
          "tensorflow/core/kernels/quantized_add_op.cc"
        ],
        "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
          "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:         tensor_min = min_x;",
          "539:         tensor_max = max_x;",
          "540:       }",
          "541:       VectorTensorAddition<T, Toutput>(",
          "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
          "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:       OP_REQUIRES(context, vector_num_elements > 0,",
          "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1e3aaf668d3d29d742fa0dc330bc0f017ba3d990",
      "candidate_info": {
        "commit_hash": "1e3aaf668d3d29d742fa0dc330bc0f017ba3d990",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/1e3aaf668d3d29d742fa0dc330bc0f017ba3d990",
        "files": [
          "tensorflow/core/kernels/quantized_add_op.cc"
        ],
        "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
          "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:         tensor_min = min_x;",
          "539:         tensor_max = max_x;",
          "540:       }",
          "541:       VectorTensorAddition<T, Toutput>(",
          "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
          "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:       OP_REQUIRES(context, vector_num_elements > 0,",
          "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ea6f8df3b5f3f79abf1fa7912d26a1a563e5c29d",
      "candidate_info": {
        "commit_hash": "ea6f8df3b5f3f79abf1fa7912d26a1a563e5c29d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ea6f8df3b5f3f79abf1fa7912d26a1a563e5c29d",
        "files": [
          "tensorflow/core/kernels/quantized_add_op.cc"
        ],
        "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
          "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:         tensor_min = min_x;",
          "539:         tensor_max = max_x;",
          "540:       }",
          "541:       VectorTensorAddition<T, Toutput>(",
          "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
          "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:       OP_REQUIRES(context, vector_num_elements > 0,",
          "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5b52d0f44d5a5ae8d7d4e3a58377c8483cc51d3b",
      "candidate_info": {
        "commit_hash": "5b52d0f44d5a5ae8d7d4e3a58377c8483cc51d3b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5b52d0f44d5a5ae8d7d4e3a58377c8483cc51d3b",
        "files": [
          "tensorflow/core/kernels/quantized_add_op.cc"
        ],
        "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
          "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:         tensor_min = min_x;",
          "539:         tensor_max = max_x;",
          "540:       }",
          "541:       VectorTensorAddition<T, Toutput>(",
          "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
          "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:       OP_REQUIRES(context, vector_num_elements > 0,",
          "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e6e49c800342fb34ff900985faee9061b8d211b8",
      "candidate_info": {
        "commit_hash": "e6e49c800342fb34ff900985faee9061b8d211b8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e6e49c800342fb34ff900985faee9061b8d211b8",
        "files": [
          "tensorflow/core/kernels/quantized_add_op.cc"
        ],
        "message": "Validate work in `QuantizedAdd`, ensure at least one element.\n\nPiperOrigin-RevId: 370127996\nChange-Id: I57c6f3e01afdeada84737820a131590137463855",
        "before_after_code_files": [
          "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/quantized_add_op.cc||tensorflow/core/kernels/quantized_add_op.cc": [
          "File: tensorflow/core/kernels/quantized_add_op.cc -> tensorflow/core/kernels/quantized_add_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:         tensor_min = min_x;",
          "539:         tensor_max = max_x;",
          "540:       }",
          "541:       VectorTensorAddition<T, Toutput>(",
          "542:           vector_data, vector_min, vector_max, vector_num_elements, tensor_data,",
          "543:           tensor_min, tensor_max, tensor_num_elements, min_z_value, max_z_value,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:       OP_REQUIRES(context, vector_num_elements > 0,",
          "542:                   errors::InvalidArgument(\"Must have some elements to add\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}