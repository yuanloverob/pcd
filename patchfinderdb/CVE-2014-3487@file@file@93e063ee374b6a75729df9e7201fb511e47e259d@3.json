{
  "cve_id": "CVE-2014-3487",
  "cve_desc": "The cdf_read_property_info function in file before 5.19, as used in the Fileinfo component in PHP before 5.4.30 and 5.5.x before 5.5.14, does not properly validate a stream offset, which allows remote attackers to cause a denial of service (application crash) via a crafted CDF file.",
  "repo": "file/file",
  "patch_hash": "93e063ee374b6a75729df9e7201fb511e47e259d",
  "patch_info": {
    "commit_hash": "93e063ee374b6a75729df9e7201fb511e47e259d",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/93e063ee374b6a75729df9e7201fb511e47e259d",
    "files": [
      "src/cdf.c"
    ],
    "message": "Add missing check offset test (Francisco Alonso, Jan Kaluza at RedHat)",
    "before_after_code_files": [
      "src/cdf.c||src/cdf.c"
    ]
  },
  "patch_diff": {
    "src/cdf.c||src/cdf.c": [
      "File: src/cdf.c -> src/cdf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "35: #include \"file.h\"",
      "37: #ifndef lint",
      "39: #endif",
      "41: #include <assert.h>",
      "",
      "[Removed Lines]",
      "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.61 2014/06/04 17:23:19 christos Exp $\")",
      "",
      "[Added Lines]",
      "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.62 2014/06/04 17:26:07 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "816:  if (cdf_check_stream_offset(sst, h, e, 0, __LINE__) == -1)",
      "817:   goto out;",
      "818:  for (i = 0; i < sh.sh_properties; i++) {",
      "820:   q = (const uint8_t *)(const void *)",
      "821:       ((const char *)(const void *)p + ofs",
      "822:       - 2 * sizeof(uint32_t));",
      "",
      "[Removed Lines]",
      "819:   size_t ofs = CDF_GETUINT32(p, (i << 1) + 1);",
      "",
      "[Added Lines]",
      "819:   size_t tail = (i << 1) + 1;",
      "820:   if (cdf_check_stream_offset(sst, h, p, tail * sizeof(uint32_t),",
      "821:       __LINE__) == -1)",
      "822:    goto out;",
      "823:   size_t ofs = CDF_GETUINT32(p, tail);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "40bade80cbe2af1d0b2cd0420cebd5d5905a2382",
      "candidate_info": {
        "commit_hash": "40bade80cbe2af1d0b2cd0420cebd5d5905a2382",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/40bade80cbe2af1d0b2cd0420cebd5d5905a2382",
        "files": [
          "src/cdf.c"
        ],
        "message": "Fix incorrect bounds check for sector count. (Francisco Alonso and Jan Kaluza at RedHat)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.59 2014/05/14 23:22:48 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.60 2014/05/21 13:04:38 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "455: cdf_count_chain(const cdf_sat_t *sat, cdf_secid_t sid, size_t size)",
          "456: {",
          "457:  size_t i, j;",
          "460:  DPRINTF((\"Chain:\"));",
          "461:  for (j = i = 0; sid >= 0; i++, j++) {",
          "",
          "[Removed Lines]",
          "458:  cdf_secid_t maxsector = (cdf_secid_t)(sat->sat_len * size);",
          "",
          "[Added Lines]",
          "458:  cdf_secid_t maxsector = (cdf_secid_t)((sat->sat_len * size)",
          "459:      / sizeof(maxsector));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "465:    errno = EFTYPE;",
          "466:    return (size_t)-1;",
          "467:   }",
          "470:    errno = EFTYPE;",
          "471:    return (size_t)-1;",
          "472:   }",
          "",
          "[Removed Lines]",
          "468:   if (sid > maxsector) {",
          "469:    DPRINTF((\"Sector %d > %d\\n\", sid, maxsector));",
          "",
          "[Added Lines]",
          "469:   if (sid >= maxsector) {",
          "470:    DPRINTF((\"Sector %d >= %d\\n\", sid, maxsector));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0641e56be1af003aa02c7c6b0184466540637233",
      "candidate_info": {
        "commit_hash": "0641e56be1af003aa02c7c6b0184466540637233",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/0641e56be1af003aa02c7c6b0184466540637233",
        "files": [
          "src/cdf.c"
        ],
        "message": "Prevent wrap around (Remi Collet at redhat)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.63 2014/06/09 13:04:37 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.64 2014/07/24 19:35:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "835:   q = (const uint8_t *)(const void *)",
          "836:       ((const char *)(const void *)p + ofs",
          "837:       - 2 * sizeof(uint32_t));",
          "838:   if (q > e) {",
          "839:    DPRINTF((\"Ran of the end %p > %p\\n\", q, e));",
          "840:    goto out;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "838:   if (q < p) {",
          "839:    DPRINTF((\"Wrapped around %p < %p\\n\", q, p));",
          "840:    goto out;",
          "841:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4ac219a350cd13c01d790e48fd636330168a9e85",
      "candidate_info": {
        "commit_hash": "4ac219a350cd13c01d790e48fd636330168a9e85",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/4ac219a350cd13c01d790e48fd636330168a9e85",
        "files": [
          "src/cdf.c"
        ],
        "message": "Don't treat empty chains as an error (Guy Helmer)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.66 2014/08/27 06:59:35 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.67 2014/09/24 19:49:07 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "463:      / sizeof(maxsector));",
          "465:  DPRINTF((\"Chain:\"));",
          "466:  for (j = i = 0; sid >= 0; i++, j++) {",
          "467:   DPRINTF((\" %d\", sid));",
          "468:   if (j >= CDF_LOOP_LIMIT) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "466:  if (sid == CDF_SECID_END_OF_CHAIN) {",
          "468:   DPRINTF((\" empty\\n\"));",
          "469:   return 0;",
          "470:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "961f3849dd0ed90dd658a7126cc0f1c91d6e4bcf",
      "candidate_info": {
        "commit_hash": "961f3849dd0ed90dd658a7126cc0f1c91d6e4bcf",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/961f3849dd0ed90dd658a7126cc0f1c91d6e4bcf",
        "files": [
          "src/cdf.c"
        ],
        "message": "Roman I Khimov: If cdf_count_chain() is called with sid < 0, then we end up returning zero length, which in turn leads to calloc() calls for 0 bytes in cdf_read_long_sector_chain(), cdf_read_short_sector_chain() and cdf_read_ssat(). Depending on calloc() implementation we can end up returning -1 or 0 from those. As negative sid is probably wrong case anyway, it might be better to always return -1. Issue found by clang static analysis.",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.56 2014/05/05 16:11:21 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.57 2014/05/06 18:20:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "472:   }",
          "473:   sid = CDF_TOLE4((uint32_t)sat->sat_tab[sid]);",
          "474:  }",
          "475:  DPRINTF((\"\\n\"));",
          "476:  return i;",
          "477: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "475:  if (i == 0) {",
          "476:   DPRINTF((\" none, sid: %d\\n\", sid));",
          "477:   return (size_t)-1;",
          "479:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "36fadd29849b8087af9f4586f89dbf74ea45be67",
      "candidate_info": {
        "commit_hash": "36fadd29849b8087af9f4586f89dbf74ea45be67",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/36fadd29849b8087af9f4586f89dbf74ea45be67",
        "files": [
          "src/cdf.c"
        ],
        "message": "Use the proper sector size when checking stream offsets (Francisco Alonso and Jan Kaluza at RedHat)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.60 2014/05/21 13:04:38 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.61 2014/06/04 17:23:19 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "267: {",
          "268:  const char *b = (const char *)sst->sst_tab;",
          "269:  const char *e = ((const char *)p) + tail;",
          "270:  (void)&line;",
          "272:   return 0;",
          "273:  DPRINTF((\"%d: offset begin %p < end %p || %\" SIZE_T_FORMAT \"u\"",
          "274:      \" > %\" SIZE_T_FORMAT \"u [%\" SIZE_T_FORMAT \"u %\"",
          "275:      SIZE_T_FORMAT \"u]\\n\", line, b, e, (size_t)(e - b),",
          "277:  errno = EFTYPE;",
          "278:  return -1;",
          "279: }",
          "",
          "[Removed Lines]",
          "271:  if (e >= b && (size_t)(e - b) <= CDF_SEC_SIZE(h) * sst->sst_len)",
          "276:      CDF_SEC_SIZE(h) * sst->sst_len, CDF_SEC_SIZE(h), sst->sst_len));",
          "",
          "[Added Lines]",
          "270:  size_t ss = sst->sst_dirlen < h->h_min_size_standard_stream ?",
          "271:      CDF_SHORT_SEC_SIZE(h) : CDF_SEC_SIZE(h);",
          "273:  if (e >= b && (size_t)(e - b) <= ss * sst->sst_len)",
          "278:      ss * sst->sst_len, ss, sst->sst_len));",
          "",
          "---------------"
        ]
      }
    }
  ]
}