{
  "cve_id": "CVE-2015-3329",
  "cve_desc": "Multiple stack-based buffer overflows in the phar_set_inode function in phar_internal.h in PHP before 5.4.40, 5.5.x before 5.5.24, and 5.6.x before 5.6.8 allow remote attackers to execute arbitrary code via a crafted length value in a (1) tar, (2) phar, or (3) ZIP archive.",
  "repo": "php/php-src",
  "patch_hash": "f59b67ae50064560d7bfcdb0d6a8ab284179053c",
  "patch_info": {
    "commit_hash": "f59b67ae50064560d7bfcdb0d6a8ab284179053c",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/f59b67ae50064560d7bfcdb0d6a8ab284179053c",
    "files": [
      "ext/phar/phar_internal.h",
      "ext/phar/tests/bug69441.phar",
      "ext/phar/tests/bug69441.phpt"
    ],
    "message": "Fix bug #69441 (Buffer Overflow when parsing tar/zip/phar in phar_set_inode)",
    "before_after_code_files": [
      "ext/phar/phar_internal.h||ext/phar/phar_internal.h",
      "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt"
    ]
  },
  "patch_diff": {
    "ext/phar/phar_internal.h||ext/phar/phar_internal.h": [
      "File: ext/phar/phar_internal.h -> ext/phar/phar_internal.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "618: {",
      "619:  char tmp[MAXPATHLEN];",
      "620:  int tmp_len;",
      "625:  entry->inode = (unsigned short)zend_get_hash_value(tmp, tmp_len);",
      "626: }",
      "",
      "[Removed Lines]",
      "622:  tmp_len = entry->filename_len + entry->phar->fname_len;",
      "623:  memcpy(tmp, entry->phar->fname, entry->phar->fname_len);",
      "624:  memcpy(tmp + entry->phar->fname_len, entry->filename, entry->filename_len);",
      "",
      "[Added Lines]",
      "621:  size_t len;",
      "623:  tmp_len = MIN(MAXPATHLEN, entry->filename_len + entry->phar->fname_len);",
      "624:  len = MIN(entry->phar->fname_len, tmp_len);",
      "625:  memcpy(tmp, entry->phar->fname, len);",
      "626:  len = MIN(tmp_len - len, entry->filename_len);",
      "627:  memcpy(tmp + entry->phar->fname_len, entry->filename, len);",
      "",
      "---------------"
    ],
    "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt": [
      "File: ext/phar/tests/bug69441.phpt -> ext/phar/tests/bug69441.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Phar: bug #69441: Buffer Overflow when parsing tar/zip/phar in phar_set_inode",
      "3: --SKIPIF--",
      "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
      "5: --FILE--",
      "6: <?php",
      "7: $fname = dirname(__FILE__) . '/bug69441.phar';",
      "8: try {",
      "9: $r = new Phar($fname, 0);",
      "10: } catch(UnexpectedValueException $e) {",
      "11:  echo $e;",
      "12: }",
      "13: ?>",
      "15: ==DONE==",
      "16: --EXPECTF--",
      "17: exception 'UnexpectedValueException' with message 'phar error: corrupted central directory entry, no magic signature in zip-based phar \"%s/bug69441.phar\"' in %s/bug69441.php:%d",
      "18: Stack trace:",
      "19: #0 %s/bug69441.php(%d): Phar->__construct('%s', 0)",
      "20: #1 {main}",
      "21: ==DONE==",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "945b9ffee666e147231a1f37da69eb8d05e3193c",
      "candidate_info": {
        "commit_hash": "945b9ffee666e147231a1f37da69eb8d05e3193c",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/945b9ffee666e147231a1f37da69eb8d05e3193c",
        "files": [
          "ext/phar/phar_internal.h",
          "ext/phar/tests/bug69441.phar",
          "ext/phar/tests/bug69441.phpt"
        ],
        "message": "Fix bug #69441 (Buffer Overflow when parsing tar/zip/phar in phar_set_inode)",
        "before_after_code_files": [
          "ext/phar/phar_internal.h||ext/phar/phar_internal.h",
          "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/phar_internal.h||ext/phar/phar_internal.h",
            "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt"
          ],
          "candidate": [
            "ext/phar/phar_internal.h||ext/phar/phar_internal.h",
            "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/phar_internal.h||ext/phar/phar_internal.h": [
          "File: ext/phar/phar_internal.h -> ext/phar/phar_internal.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "561: {",
          "562:  char tmp[MAXPATHLEN];",
          "563:  int tmp_len;",
          "568:  entry->inode = (unsigned short)zend_get_hash_value(tmp, tmp_len);",
          "569: }",
          "",
          "[Removed Lines]",
          "565:  tmp_len = entry->filename_len + entry->phar->fname_len;",
          "566:  memcpy(tmp, entry->phar->fname, entry->phar->fname_len);",
          "567:  memcpy(tmp + entry->phar->fname_len, entry->filename, entry->filename_len);",
          "",
          "[Added Lines]",
          "564:  size_t len;",
          "566:  tmp_len = MIN(MAXPATHLEN, entry->filename_len + entry->phar->fname_len);",
          "567:  len = MIN(entry->phar->fname_len, tmp_len);",
          "568:  memcpy(tmp, entry->phar->fname, len);",
          "569:  len = MIN(tmp_len - len, entry->filename_len);",
          "570:  memcpy(tmp + entry->phar->fname_len, entry->filename, len);",
          "",
          "---------------"
        ],
        "ext/phar/tests/bug69441.phpt||ext/phar/tests/bug69441.phpt": [
          "File: ext/phar/tests/bug69441.phpt -> ext/phar/tests/bug69441.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Phar: bug #69441: Buffer Overflow when parsing tar/zip/phar in phar_set_inode",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
          "5: --FILE--",
          "6: <?php",
          "7: $fname = dirname(__FILE__) . '/bug69441.phar';",
          "8: try {",
          "9: $r = new Phar($fname, 0);",
          "10: } catch(UnexpectedValueException $e) {",
          "11:  echo $e;",
          "12: }",
          "13: ?>",
          "15: ==DONE==",
          "16: --EXPECTF--",
          "17: exception 'UnexpectedValueException' with message 'phar error: corrupted central directory entry, no magic signature in zip-based phar \"%s/bug69441.phar\"' in %s/bug69441.php:%d",
          "18: Stack trace:",
          "19: #0 %s/bug69441.php(%d): Phar->__construct('%s', 0)",
          "20: #1 {main}",
          "21: ==DONE==",
          "",
          "---------------"
        ]
      }
    }
  ]
}