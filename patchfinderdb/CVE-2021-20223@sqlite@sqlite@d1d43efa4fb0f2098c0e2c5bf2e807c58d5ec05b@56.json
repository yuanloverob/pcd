{
  "cve_id": "CVE-2021-20223",
  "cve_desc": "",
  "repo": "sqlite/sqlite",
  "patch_hash": "d1d43efa4fb0f2098c0e2c5bf2e807c58d5ec05b",
  "patch_info": {
    "commit_hash": "d1d43efa4fb0f2098c0e2c5bf2e807c58d5ec05b",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/d1d43efa4fb0f2098c0e2c5bf2e807c58d5ec05b",
    "files": [
      "ext/fts5/fts5_unicode2.c",
      "ext/fts5/test/fts5tok1.test",
      "manifest",
      "manifest.uuid"
    ],
    "message": "Prevent fts5 tokenizer unicode61 from considering '\\0' to be a token characters, even if other characters of class \"Cc\" are.\n\nFossilOrigin-Name: b7b7bde9b7a03665e3691c6d51118965f216d2dfb1617f138b9f9e60e418ed2f",
    "before_after_code_files": [
      "ext/fts5/fts5_unicode2.c||ext/fts5/fts5_unicode2.c",
      "ext/fts5/test/fts5tok1.test||ext/fts5/test/fts5tok1.test",
      "manifest.uuid||manifest.uuid"
    ]
  },
  "patch_diff": {
    "ext/fts5/fts5_unicode2.c||ext/fts5/fts5_unicode2.c": [
      "File: ext/fts5/fts5_unicode2.c -> ext/fts5/fts5_unicode2.c"
    ],
    "ext/fts5/test/fts5tok1.test||ext/fts5/test/fts5tok1.test": [
      "File: ext/fts5/test/fts5tok1.test -> ext/fts5/test/fts5tok1.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "111:   SELECT * FROM t4;",
      "112: } {1 {SQL logic error}}",
      "115: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "114: #-------------------------------------------------------------------------",
      "115: # Embedded 0x00 characters.",
      "116: #",
      "117: reset_db",
      "118: do_execsql_test 3.1.0 {",
      "119:   CREATE VIRTUAL TABLE t1 USING fts5(z);",
      "120:   CREATE VIRTUAL TABLE tt USING fts5vocab(t1, 'instance');",
      "121:   INSERT INTO t1 VALUES('abc' || char(0) || 'def');",
      "122:   SELECT * FROM tt;",
      "123: } { abc 1 z 0 def 1 z 1 }",
      "124: do_execsql_test 3.1.1 {",
      "125:   SELECT hex(z) FROM t1;",
      "126: } {61626300646566}",
      "127: do_execsql_test 3.1.2 {",
      "128:   INSERT INTO t1(t1) VALUES('integrity-check');",
      "129: } {}",
      "131: do_execsql_test 3.2.0 {",
      "132:   CREATE VIRTUAL TABLE t2 USING fts5(z,",
      "133:       tokenize=\"unicode61 categories 'L* N* Co Cc'\"",
      "134:   );",
      "135:   CREATE VIRTUAL TABLE tu USING fts5vocab(t2, 'instance');",
      "137:   INSERT INTO t2 VALUES('abc' || char(0) || 'def');",
      "138:   SELECT * FROM tu;",
      "139: } { abc 1 z 0 def 1 z 1 }",
      "141: do_execsql_test 3.2.1 {",
      "142:   SELECT hex(z) FROM t1;",
      "143: } {61626300646566}",
      "145: do_execsql_test 3.2.2 {",
      "146:   INSERT INTO t1(t1) VALUES('integrity-check');",
      "147: } {}",
      "",
      "---------------"
    ],
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 0e7e113d9f2c929c1f8a85e2cfad8e2e60f0e8770212b5e5320fb2a2c42911f8",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ded33ccea4203e0b3c7519c9c60063632bf4eccf",
      "candidate_info": {
        "commit_hash": "ded33ccea4203e0b3c7519c9c60063632bf4eccf",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/ded33ccea4203e0b3c7519c9c60063632bf4eccf",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c"
        ],
        "message": "Fix a minor formatting error in the display of BLOB values during VDBE tracing.\n\nFossilOrigin-Name: 295442887a3cd5868df26c5be244649ffb3bae8367f5cf02fe513424a1c9f6a7",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fa866aec56deca8cc1b70814215bbdc683f41bc0826da0f8804d952de429820c",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "499:     }else{",
          "500:       c = 's';",
          "501:     }",
          "503:     for(i=0; i<25 && i<pMem->n; i++){",
          "504:       sqlite3_str_appendf(pStr, \"%02X\", ((int)pMem->z[i] & 0xFF));",
          "505:     }",
          "",
          "[Removed Lines]",
          "502:     sqlite3_str_appendf(pStr, \"%cx\", c);",
          "",
          "[Added Lines]",
          "502:     sqlite3_str_appendf(pStr, \"%cx[\", c);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "35d3cb80c4eeeb7a583ba67bff6ad5d2bf8853e2",
      "candidate_info": {
        "commit_hash": "35d3cb80c4eeeb7a583ba67bff6ad5d2bf8853e2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/35d3cb80c4eeeb7a583ba67bff6ad5d2bf8853e2",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/analyzeG.test"
        ],
        "message": "Disable the new analyzeG.test module if not building with STAT4.\n\nFossilOrigin-Name: 4a9d3005769e0398183b03a3e132e3946b9d1c48073af2e0559d7beeac3245c0",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/analyzeG.test||test/analyzeG.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b542dee9de843c19664c19df7435c6034d23d0d213804d588ec0ff599082d576",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/analyzeG.test||test/analyzeG.test": [
          "File: test/analyzeG.test -> test/analyzeG.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: set testdir [file dirname $argv0]",
          "15: source $testdir/tester.tcl",
          "17: set testprefix analyzeG",
          "19: proc do_scan_order_test {tn sql expect} {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "17: ifcapable !stat4 {",
          "18:   finish_test",
          "19:   return",
          "20: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8654186b0236d556aa85528c2573ee0b6ab71be3",
      "candidate_info": {
        "commit_hash": "8654186b0236d556aa85528c2573ee0b6ab71be3",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/8654186b0236d556aa85528c2573ee0b6ab71be3",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "src/vdbeaux.c",
          "src/window.c"
        ],
        "message": "When an error occurs while rewriting the parser tree for window functions in the sqlite3WindowRewrite() routine, make sure that pParse->nErr is set, and make sure that this shuts down any subsequent code generation that might depend on the transformations that were implemented.  This fixes a problem discovered by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: e2bddcd4c55ba3cbe0130332679ff4b048630d0ced9a8899982edb5a3569ba7f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "src/vdbeaux.c||src/vdbeaux.c",
          "src/window.c||src/window.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 4417c5bf0aabb34ed174f01afd981c924ae965a42128719d8d6735536631d12f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:   int addr;",
          "377:   CollSeq *p4;",
          "379:   if( isCommuted ){",
          "380:     p4 = sqlite3BinaryCompareCollSeq(pParse, pRight, pLeft);",
          "381:   }else{",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "379:   if( pParse->nErr ) return 0;",
          "",
          "---------------"
        ],
        "src/vdbeaux.c||src/vdbeaux.c": [
          "File: src/vdbeaux.c -> src/vdbeaux.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1304: static void vdbeVComment(Vdbe *p, const char *zFormat, va_list ap){",
          "1305:   assert( p->nOp>0 || p->aOp==0 );",
          "1307:   if( p->nOp ){",
          "1308:     assert( p->aOp );",
          "1309:     sqlite3DbFree(p->db, p->aOp[p->nOp-1].zComment);",
          "",
          "[Removed Lines]",
          "1306:   assert( p->aOp==0 || p->aOp[p->nOp-1].zComment==0 || p->db->mallocFailed );",
          "",
          "[Added Lines]",
          "1306:   assert( p->aOp==0 || p->aOp[p->nOp-1].zComment==0 || p->db->mallocFailed",
          "1307:           || p->pParse->nErr>0 );",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "935:     pTab = sqlite3DbMallocZero(db, sizeof(Table));",
          "936:     if( pTab==0 ){",
          "938:     }",
          "940:     p->pSrc = 0;",
          "",
          "[Removed Lines]",
          "937:       return SQLITE_NOMEM;",
          "",
          "[Added Lines]",
          "937:       return sqlite3ErrorToParser(db, SQLITE_NOMEM);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1039:     sqlite3DbFree(db, pTab);",
          "1040:   }",
          "1042:   return rc;",
          "1043: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1042:   if( rc && pParse->nErr==0 ){",
          "1043:     assert( pParse->db->mallocFailed );",
          "1044:     return sqlite3ErrorToParser(pParse->db, SQLITE_NOMEM);",
          "1045:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dfa15270c4108fedd817a99751fc73d43d7fb29d",
      "candidate_info": {
        "commit_hash": "dfa15270c4108fedd817a99751fc73d43d7fb29d",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/dfa15270c4108fedd817a99751fc73d43d7fb29d",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "src/insert.c",
          "src/sqliteInt.h",
          "test/gencol1.test"
        ],
        "message": "Change the way generated columns are computed so that no column is computed inside branch code that might not be taken.  Ticket [4fc08501f4e56692]\n\nFossilOrigin-Name: 9e07b48934e9a972dcf62e3538b3b21ffa044c553feba0441675ac0bbe13bcb2",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "src/insert.c||src/insert.c",
          "src/sqliteInt.h||src/sqliteInt.h",
          "test/gencol1.test||test/gencol1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 7bc8205dd9c1657c736a9c6a1a90dd9dad442accfbb77d296eaae2c09ab46bd1",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3645:           iSrc = sqlite3TableColumnToStorage(pTab, iCol) - pParse->iSelfTab;",
          "3646: #ifndef SQLITE_OMIT_GENERATED_COLUMNS",
          "3647:           if( pCol->colFlags & COLFLAG_GENERATED ){",
          "3658:             return iSrc;",
          "3659:           }else",
          "",
          "[Removed Lines]",
          "3648:             if( pCol->colFlags & COLFLAG_BUSY ){",
          "3649:               sqlite3ErrorMsg(pParse, \"generated column loop on \\\"%s\\\"\",",
          "3650:                               pCol->zName);",
          "3651:               return 0;",
          "3652:             }",
          "3653:             pCol->colFlags |= COLFLAG_BUSY;",
          "3654:             if( pCol->colFlags & COLFLAG_NOTAVAIL ){",
          "3655:               sqlite3ExprCodeGeneratedColumn(pParse, pCol, iSrc);",
          "3656:             }",
          "3657:             pCol->colFlags &= ~(COLFLAG_BUSY|COLFLAG_NOTAVAIL);",
          "",
          "[Added Lines]",
          "3648:             sqlite3ExprCodeGeneratedColumn(pParse, pCol, iSrc);",
          "",
          "---------------"
        ],
        "src/insert.c||src/insert.c": [
          "File: src/insert.c -> src/insert.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "201:   return 0;",
          "202: }",
          "204: #ifndef SQLITE_OMIT_GENERATED_COLUMNS",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "207: static int exprColumnFlagUnion(Walker *pWalker, Expr *pExpr){",
          "208:   if( pExpr->op==TK_COLUMN ){",
          "209:     pWalker->eCode |= pWalker->u.pTab->aCol[pExpr->iColumn].colFlags;",
          "210:   }",
          "211:   return WRC_Continue;",
          "212: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "216: ){",
          "217:   int i;",
          "",
          "[Removed Lines]",
          "218:   int nv;",
          "",
          "[Added Lines]",
          "228:   Walker w;",
          "229:   Column *pRedo;",
          "230:   int eProgress;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "227:       pTab->aCol[i].colFlags |= COLFLAG_NOTAVAIL;",
          "228:     }",
          "229:   }",
          "235:   pParse->iSelfTab = -iRegStore;",
          "249:       }",
          "251:     }",
          "253:   }",
          "254:   pParse->iSelfTab = 0;",
          "255: }",
          "",
          "[Removed Lines]",
          "236:   for(i=nv=0; i<pTab->nCol; i++){",
          "237:     u32 colFlags = pTab->aCol[i].colFlags;",
          "238:     if( (colFlags & COLFLAG_NOTAVAIL)!=0 ){",
          "239:       assert( colFlags & COLFLAG_GENERATED );",
          "240:       if( colFlags & COLFLAG_VIRTUAL ){",
          "242:         assert( pTab->nNVCol+nv == sqlite3TableColumnToStorage(pTab,i) );",
          "243:         sqlite3ExprCodeGeneratedColumn(pParse, &pTab->aCol[i],",
          "244:                                        iRegStore+pTab->nNVCol+nv);",
          "245:       }else{",
          "247:         assert( i-nv == sqlite3TableColumnToStorage(pTab,i) );",
          "248:         sqlite3ExprCodeGeneratedColumn(pParse, &pTab->aCol[i], iRegStore+i-nv);",
          "250:       pTab->aCol[i].colFlags &= ~COLFLAG_NOTAVAIL;",
          "252:     if( (colFlags & COLFLAG_VIRTUAL)!=0 ) nv++;",
          "",
          "[Added Lines]",
          "244:   w.u.pTab = pTab;",
          "245:   w.xExprCallback = exprColumnFlagUnion;",
          "246:   w.xSelectCallback = 0;",
          "247:   w.xSelectCallback2 = 0;",
          "255:   do{",
          "256:     eProgress = 0;",
          "257:     pRedo = 0;",
          "258:     for(i=0; i<pTab->nCol; i++){",
          "259:       Column *pCol = pTab->aCol + i;",
          "260:       if( (pCol->colFlags & COLFLAG_NOTAVAIL)!=0 ){",
          "261:         int x;",
          "262:         pCol->colFlags |= COLFLAG_BUSY;",
          "263:         w.eCode = 0;",
          "264:         sqlite3WalkExpr(&w, pCol->pDflt);",
          "265:         pCol->colFlags &= ~COLFLAG_BUSY;",
          "266:         if( w.eCode & COLFLAG_NOTAVAIL ){",
          "267:           pRedo = pCol;",
          "268:           continue;",
          "269:         }",
          "270:         eProgress = 1;",
          "271:         assert( pCol->colFlags & COLFLAG_GENERATED );",
          "272:         x = sqlite3TableColumnToStorage(pTab, i) + iRegStore;",
          "273:         sqlite3ExprCodeGeneratedColumn(pParse, pCol, x);",
          "274:         pCol->colFlags &= ~COLFLAG_NOTAVAIL;",
          "277:   }while( pRedo && eProgress );",
          "278:   if( pRedo ){",
          "279:     sqlite3ErrorMsg(pParse, \"generated column loop on \\\"%s\\\"\", pRedo->zName);",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h"
        ],
        "test/gencol1.test||test/gencol1.test": [
          "File: test/gencol1.test -> test/gencol1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "222:   SELECT 99 FROM t0 WHERE 0 = t0.c2 OR t0.c1 BETWEEN t0.c2 AND 1;",
          "223: } {}",
          "225: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "225: # 2019-11-06 ticket 4fc08501f4e56692",
          "226: do_execsql_test gencol1-8.10 {",
          "227:   DROP TABLE IF EXISTS t0;",
          "228:   CREATE TABLE t0(",
          "229:     c0 AS (('a', 9) < ('b', c1)),",
          "230:     c1 AS (1),",
          "231:     c2 CHECK (1 = c1)",
          "232:   );",
          "233:   INSERT INTO t0 VALUES (0),(99);",
          "234:   SELECT * FROM t0;",
          "235: } {1 1 0 1 1 99}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5f0d37b57e692353a8412454c02572f3177753f7",
      "candidate_info": {
        "commit_hash": "5f0d37b57e692353a8412454c02572f3177753f7",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/5f0d37b57e692353a8412454c02572f3177753f7",
        "files": [
          "doc/lemon.html",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Update the lemon documentation to match recent enhancements.\n\nFossilOrigin-Name: ca7630a5772ab919482a3629e11627143a1e1ec290a570ce4188189e671f9015",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 1f96a29dd8654ee30d36982a8bcd3f17a4b9193d3879fdb38fa3f03eeeff3080",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}