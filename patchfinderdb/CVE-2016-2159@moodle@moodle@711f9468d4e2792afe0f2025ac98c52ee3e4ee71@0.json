{
  "cve_id": "CVE-2016-2159",
  "cve_desc": "The save_submission function in mod/assign/externallib.php in Moodle through 2.6.11, 2.7.x before 2.7.13, 2.8.x before 2.8.11, 2.9.x before 2.9.5, and 3.0.x before 3.0.3 allows remote authenticated users to bypass intended due-date restrictions by leveraging the student role for a web-service request.",
  "repo": "moodle/moodle",
  "patch_hash": "711f9468d4e2792afe0f2025ac98c52ee3e4ee71",
  "patch_info": {
    "commit_hash": "711f9468d4e2792afe0f2025ac98c52ee3e4ee71",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/711f9468d4e2792afe0f2025ac98c52ee3e4ee71",
    "files": [
      "mod/assign/externallib.php",
      "mod/assign/tests/externallib_test.php"
    ],
    "message": "MDL-52901 mod_assign: Check due dates in external save_submission",
    "before_after_code_files": [
      "mod/assign/externallib.php||mod/assign/externallib.php",
      "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
    ]
  },
  "patch_diff": {
    "mod/assign/externallib.php||mod/assign/externallib.php": [
      "File: mod/assign/externallib.php -> mod/assign/externallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1682:         $notices = array();",
      "1688:         $warnings = array();",
      "1689:         foreach ($notices as $notice) {",
      "",
      "[Removed Lines]",
      "1684:         $submissiondata = (object)$params['plugindata'];",
      "1686:         $assignment->save_submission($submissiondata, $notices);",
      "",
      "[Added Lines]",
      "1684:         if (!$assignment->submissions_open($USER->id)) {",
      "1685:             $notices[] = get_string('duedatereached', 'assign');",
      "1686:         } else {",
      "1687:             $submissiondata = (object)$params['plugindata'];",
      "1688:             $assignment->save_submission($submissiondata, $notices);",
      "1689:         }",
      "",
      "---------------"
    ],
    "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php": [
      "File: mod/assign/tests/externallib_test.php -> mod/assign/tests/externallib_test.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "947:         $this->assertEquals(0, count($result));",
      "949:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "950:         $instance->duedate = time() - WEEKSECS;",
      "951:         $instance->cutoffdate = time() - WEEKSECS;",
      "952:         $DB->update_record('assign', $instance);",
      "954:         $result = mod_assign_external::save_submission($instance->id, $submissionpluginparams);",
      "955:         $result = external_api::clean_returnvalue(mod_assign_external::save_submission_returns(), $result);",
      "957:         $this->assertCount(1, $result);",
      "958:         $this->assertEquals(get_string('duedatereached', 'assign'), $result[0]['item']);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0f989a4c70a6d516196f4e85db537593f9d10b39",
      "candidate_info": {
        "commit_hash": "0f989a4c70a6d516196f4e85db537593f9d10b39",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/0f989a4c70a6d516196f4e85db537593f9d10b39",
        "files": [
          "mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php"
        ],
        "message": "MDL-52901 mod_assign: Check due dates in external save_submission",
        "before_after_code_files": [
          "mod/assign/externallib.php||mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ],
          "candidate": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/assign/externallib.php||mod/assign/externallib.php": [
          "File: mod/assign/externallib.php -> mod/assign/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1637:         $notices = array();",
          "1643:         $warnings = array();",
          "1644:         foreach ($notices as $notice) {",
          "",
          "[Removed Lines]",
          "1639:         $submissiondata = (object)$params['plugindata'];",
          "1641:         $assignment->save_submission($submissiondata, $notices);",
          "",
          "[Added Lines]",
          "1639:         if (!$assignment->submissions_open($USER->id)) {",
          "1640:             $notices[] = get_string('duedatereached', 'assign');",
          "1641:         } else {",
          "1642:             $submissiondata = (object)$params['plugindata'];",
          "1643:             $assignment->save_submission($submissiondata, $notices);",
          "1644:         }",
          "",
          "---------------"
        ],
        "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php": [
          "File: mod/assign/tests/externallib_test.php -> mod/assign/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "929:         $this->assertEquals(0, count($result));",
          "931:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "932:         $instance->duedate = time() - WEEKSECS;",
          "933:         $instance->cutoffdate = time() - WEEKSECS;",
          "934:         $DB->update_record('assign', $instance);",
          "936:         $result = mod_assign_external::save_submission($instance->id, $submissionpluginparams);",
          "937:         $result = external_api::clean_returnvalue(mod_assign_external::save_submission_returns(), $result);",
          "939:         $this->assertCount(1, $result);",
          "940:         $this->assertEquals(get_string('duedatereached', 'assign'), $result[0]['item']);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fe5146d598b9b11ff3230c7616c09b7924c6e159",
      "candidate_info": {
        "commit_hash": "fe5146d598b9b11ff3230c7616c09b7924c6e159",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/fe5146d598b9b11ff3230c7616c09b7924c6e159",
        "files": [
          "mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php"
        ],
        "message": "MDL-52901 mod_assign: Check due dates in external save_submission",
        "before_after_code_files": [
          "mod/assign/externallib.php||mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ],
          "candidate": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/assign/externallib.php||mod/assign/externallib.php": [
          "File: mod/assign/externallib.php -> mod/assign/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1680:         $notices = array();",
          "1686:         $warnings = array();",
          "1687:         foreach ($notices as $notice) {",
          "",
          "[Removed Lines]",
          "1682:         $submissiondata = (object)$params['plugindata'];",
          "1684:         $assignment->save_submission($submissiondata, $notices);",
          "",
          "[Added Lines]",
          "1682:         if (!$assignment->submissions_open($USER->id)) {",
          "1683:             $notices[] = get_string('duedatereached', 'assign');",
          "1684:         } else {",
          "1685:             $submissiondata = (object)$params['plugindata'];",
          "1686:             $assignment->save_submission($submissiondata, $notices);",
          "1687:         }",
          "",
          "---------------"
        ],
        "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php": [
          "File: mod/assign/tests/externallib_test.php -> mod/assign/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "947:         $this->assertEquals(0, count($result));",
          "949:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "950:         $instance->duedate = time() - WEEKSECS;",
          "951:         $instance->cutoffdate = time() - WEEKSECS;",
          "952:         $DB->update_record('assign', $instance);",
          "954:         $result = mod_assign_external::save_submission($instance->id, $submissionpluginparams);",
          "955:         $result = external_api::clean_returnvalue(mod_assign_external::save_submission_returns(), $result);",
          "957:         $this->assertCount(1, $result);",
          "958:         $this->assertEquals(get_string('duedatereached', 'assign'), $result[0]['item']);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "11106f6cee220119fcdcd101850741de7141399c",
      "candidate_info": {
        "commit_hash": "11106f6cee220119fcdcd101850741de7141399c",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/11106f6cee220119fcdcd101850741de7141399c",
        "files": [
          "mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php"
        ],
        "message": "MDL-52901 mod_assign: Check due dates in external save_submission",
        "before_after_code_files": [
          "mod/assign/externallib.php||mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ],
          "candidate": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/assign/externallib.php||mod/assign/externallib.php": [
          "File: mod/assign/externallib.php -> mod/assign/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1635:         $notices = array();",
          "1641:         $warnings = array();",
          "1642:         foreach ($notices as $notice) {",
          "",
          "[Removed Lines]",
          "1637:         $submissiondata = (object)$params['plugindata'];",
          "1639:         $assignment->save_submission($submissiondata, $notices);",
          "",
          "[Added Lines]",
          "1637:         if (!$assignment->submissions_open($USER->id)) {",
          "1638:             $notices[] = get_string('duedatereached', 'assign');",
          "1639:         } else {",
          "1640:             $submissiondata = (object)$params['plugindata'];",
          "1641:             $assignment->save_submission($submissiondata, $notices);",
          "1642:         }",
          "",
          "---------------"
        ],
        "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php": [
          "File: mod/assign/tests/externallib_test.php -> mod/assign/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "904:         $this->assertEquals(0, count($result));",
          "906:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "907:         $instance->duedate = time() - WEEKSECS;",
          "908:         $instance->cutoffdate = time() - WEEKSECS;",
          "909:         $DB->update_record('assign', $instance);",
          "911:         $result = mod_assign_external::save_submission($instance->id, $submissionpluginparams);",
          "912:         $result = external_api::clean_returnvalue(mod_assign_external::save_submission_returns(), $result);",
          "914:         $this->assertCount(1, $result);",
          "915:         $this->assertEquals(get_string('duedatereached', 'assign'), $result[0]['item']);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "56a067e7c199e0b303c5f29f88a8eb7e19dfdb27",
      "candidate_info": {
        "commit_hash": "56a067e7c199e0b303c5f29f88a8eb7e19dfdb27",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/56a067e7c199e0b303c5f29f88a8eb7e19dfdb27",
        "files": [
          "mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php"
        ],
        "message": "MDL-52901 mod_assign: Check due dates in external save_submission",
        "before_after_code_files": [
          "mod/assign/externallib.php||mod/assign/externallib.php",
          "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ],
          "candidate": [
            "mod/assign/externallib.php||mod/assign/externallib.php",
            "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/assign/externallib.php||mod/assign/externallib.php": [
          "File: mod/assign/externallib.php -> mod/assign/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1680:         $notices = array();",
          "1686:         $warnings = array();",
          "1687:         foreach ($notices as $notice) {",
          "",
          "[Removed Lines]",
          "1682:         $submissiondata = (object)$params['plugindata'];",
          "1684:         $assignment->save_submission($submissiondata, $notices);",
          "",
          "[Added Lines]",
          "1682:         if (!$assignment->submissions_open($USER->id)) {",
          "1683:             $notices[] = get_string('duedatereached', 'assign');",
          "1684:         } else {",
          "1685:             $submissiondata = (object)$params['plugindata'];",
          "1686:             $assignment->save_submission($submissiondata, $notices);",
          "1687:         }",
          "",
          "---------------"
        ],
        "mod/assign/tests/externallib_test.php||mod/assign/tests/externallib_test.php": [
          "File: mod/assign/tests/externallib_test.php -> mod/assign/tests/externallib_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "947:         $this->assertEquals(0, count($result));",
          "949:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "950:         $instance->duedate = time() - WEEKSECS;",
          "951:         $instance->cutoffdate = time() - WEEKSECS;",
          "952:         $DB->update_record('assign', $instance);",
          "954:         $result = mod_assign_external::save_submission($instance->id, $submissionpluginparams);",
          "955:         $result = external_api::clean_returnvalue(mod_assign_external::save_submission_returns(), $result);",
          "957:         $this->assertCount(1, $result);",
          "958:         $this->assertEquals(get_string('duedatereached', 'assign'), $result[0]['item']);",
          "",
          "---------------"
        ]
      }
    }
  ]
}