{
  "cve_id": "CVE-2019-19923",
  "cve_desc": "flattenSubquery in select.c in SQLite 3.30.1 mishandles certain uses of SELECT DISTINCT involving a LEFT JOIN in which the right-hand side is a view. This can cause a NULL pointer dereference (or incorrect results).",
  "repo": "sqlite/sqlite",
  "patch_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
  "patch_info": {
    "commit_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/join.test"
    ],
    "message": "Continue to back away from the LEFT JOIN optimization of check-in [41c27bc0ff1d3135] by disallowing query flattening if the outer query is DISTINCT.  Without this fix, if an index scan is run on the table within the view on the right-hand side of the LEFT JOIN, stale result registers might be accessed yielding incorrect results, and/or an OP_IfNullRow opcode might be invoked on the un-opened table, resulting in a NULL-pointer dereference.  This problem was found by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: 862974312edf00e9d1068115d1a39b7235b7db68b6d86b81d38a12f025a4748e",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/join.test||test/join.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 289158aa24b066c453d2bce4bc2dead1c56fb0b23c3f7c4810b34b13627cef34",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3797:   if( (pSubitem->fg.jointype & JT_OUTER)!=0 ){",
      "3798:     isLeftJoin = 1;",
      "3801:       return 0;",
      "3802:     }",
      "3803:   }",
      "",
      "[Removed Lines]",
      "3799:     if( pSubSrc->nSrc>1 || isAgg || IsVirtual(pSubSrc->a[0].pTab) ){",
      "",
      "[Added Lines]",
      "3804:     ){",
      "",
      "---------------"
    ],
    "test/join.test||test/join.test": [
      "File: test/join.test -> test/join.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
      "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
      "978: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "978: # 2019-12-18 problem with a LEFT JOIN where the RHS is a view.",
      "979: # Detected by Yongheng and Rui.",
      "980: # Follows from the optimization attempt of check-in 41c27bc0ff1d3135",
      "981: # on 2017-04-18",
      "982: #",
      "983: reset_db",
      "984: do_execsql_test join-22.10 {",
      "985:   CREATE TABLE t0(a, b);",
      "986:   CREATE INDEX t0a ON t0(a);",
      "987:   INSERT INTO t0 VALUES(10,10),(10,11),(10,12);",
      "988:   SELECT DISTINCT c FROM t0 LEFT JOIN (SELECT a+1 AS c FROM t0) ORDER BY c ;",
      "989: } {11}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3db3d12cd11b60c47e52050eb3e83a67b7664d0f",
      "candidate_info": {
        "commit_hash": "3db3d12cd11b60c47e52050eb3e83a67b7664d0f",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/3db3d12cd11b60c47e52050eb3e83a67b7664d0f",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c",
          "src/pragma.c",
          "test/vtab1.test",
          "test/without_rowid1.test",
          "test/without_rowid6.test",
          "test/without_rowid7.test"
        ],
        "message": "Fix the WITHOUT ROWID table logic so that it generates a correct KeyInfo object for tables that have a PRIMARY KEY containing the same column used more than once with different collating sequences.  Enhance the index_xinfo pragma to assist in testing the above. Fix for ticket [fd3aec0c7e3e2998].\n\nFossilOrigin-Name: 84a51a755c18ac8253080db6eec505df894ee3b1e97cfa8e61039ac38001e270",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c",
          "src/pragma.c||src/pragma.c",
          "test/vtab1.test||test/vtab1.test",
          "test/without_rowid1.test||test/without_rowid1.test",
          "test/without_rowid6.test||test/without_rowid6.test",
          "test/without_rowid7.test||test/without_rowid7.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fe014288ac03cdf0dc5410b7d45cad4768759b52746c0a22bce2fc03779c5d5a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1831:   Index *pIdx;",
          "1832:   Index *pPk;",
          "1833:   int nPk;",
          "1834:   int i, j;",
          "1835:   sqlite3 *db = pParse->db;",
          "1836:   Vdbe *v = pParse->pVdbe;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1834:   int nExtra;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1873:                        SQLITE_IDXTYPE_PRIMARYKEY);",
          "1874:     if( db->mallocFailed || pParse->nErr ) return;",
          "1875:     pPk = sqlite3PrimaryKeyIndex(pTab);",
          "1876:   }else{",
          "1877:     pPk = sqlite3PrimaryKeyIndex(pTab);",
          "1878:     assert( pPk!=0 );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1877:     assert( pPk->nKeyCol==1 );",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1887:         pPk->nColumn--;",
          "1888:       }else{",
          "1889:         testcase( hasColumn(pPk->aiColumn, j, pPk->aiColumn[i]) );",
          "1890:         pPk->aiColumn[j++] = pPk->aiColumn[i];",
          "1891:       }",
          "1892:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1892:         pPk->azColl[j] = pPk->azColl[i];",
          "1893:         pPk->aSortOrder[j] = pPk->aSortOrder[i];",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1895:   assert( pPk!=0 );",
          "1896:   pPk->isCovering = 1;",
          "1897:   if( !db->init.imposterTable ) pPk->uniqNotNull = 1;",
          "",
          "[Removed Lines]",
          "1898:   nPk = pPk->nKeyCol;",
          "",
          "[Added Lines]",
          "1902:   nPk = pPk->nColumn = pPk->nKeyCol;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1957:     }",
          "1962:   }",
          "1963:   recomputeColumnsNotIndexed(pPk);",
          "1964: }",
          "",
          "[Removed Lines]",
          "1948:   if( nPk<pTab->nCol ){",
          "1949:     if( resizeIndexObject(db, pPk, pTab->nCol) ) return;",
          "1950:     for(i=0, j=nPk; i<pTab->nCol; i++){",
          "1951:       if( !hasColumn(pPk->aiColumn, j, i) ){",
          "1952:         assert( j<pPk->nColumn );",
          "1953:         pPk->aiColumn[j] = i;",
          "1954:         pPk->azColl[j] = sqlite3StrBINARY;",
          "1955:         j++;",
          "1956:       }",
          "1958:     assert( pPk->nColumn==j );",
          "1959:     assert( pTab->nCol==j );",
          "1960:   }else{",
          "1961:     pPk->nColumn = pTab->nCol;",
          "",
          "[Added Lines]",
          "1952:   nExtra = 0;",
          "1953:   for(i=0; i<pTab->nCol; i++){",
          "1954:     if( !hasColumn(pPk->aiColumn, nPk, i) ) nExtra++;",
          "1955:   }",
          "1956:   if( resizeIndexObject(db, pPk, nPk+nExtra) ) return;",
          "1957:   for(i=0, j=nPk; i<pTab->nCol; i++){",
          "1958:     if( !hasColumn(pPk->aiColumn, j, i) ){",
          "1959:       assert( j<pPk->nColumn );",
          "1960:       pPk->aiColumn[j] = i;",
          "1961:       pPk->azColl[j] = sqlite3StrBINARY;",
          "1962:       j++;",
          "1965:   assert( pPk->nColumn==j );",
          "1966:   assert( pTab->nCol<=j );",
          "",
          "---------------"
        ],
        "src/pragma.c||src/pragma.c": [
          "File: src/pragma.c -> src/pragma.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1157:     Index *pIdx;",
          "1158:     Table *pTab;",
          "1159:     pIdx = sqlite3FindIndex(db, zRight, zDb);",
          "1160:     if( pIdx ){",
          "1161:       int iIdxDb = sqlite3SchemaToIndex(db, pIdx->pSchema);",
          "1162:       int i;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1160:     if( pIdx==0 ){",
          "1164:       pTab = sqlite3LocateTable(pParse, LOCATE_NOERR, zRight, zDb);",
          "1165:       if( pTab && !HasRowid(pTab) ){",
          "1166:         pIdx = sqlite3PrimaryKeyIndex(pTab);",
          "1167:       }",
          "1168:     }",
          "",
          "---------------"
        ],
        "test/vtab1.test||test/vtab1.test": [
          "File: test/vtab1.test -> test/vtab1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "875:   }",
          "876: } {}",
          "878: ifcapable attach {",
          "879:   do_test vtab1.8-1 {",
          "880:     set echo_module \"\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "878: # PRAGMA index_info and index_xinfo are no-ops on a virtual table",
          "879: do_test vtab1.7-14 {",
          "880:   execsql {",
          "881:     PRAGMA index_info('echo_abc');",
          "882:     PRAGMA index_xinfo('echo_abc');",
          "883:   }",
          "884: } {}",
          "",
          "---------------"
        ],
        "test/without_rowid1.test||test/without_rowid1.test": [
          "File: test/without_rowid1.test -> test/without_rowid1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: integrity_check without_rowid1-1.0ic",
          "34: do_execsql_test without_rowid1-1.1 {",
          "35:   SELECT *, '|' FROM t1 ORDER BY +c, a;",
          "36: } {arctic sleep ammonia helena | journal sherman ammonia helena | dynamic juliet flipper command | journal sherman gamma patriot |}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: do_execsql_test without_rowid1-1.0ixi {",
          "35:   SELECT name, key FROM pragma_index_xinfo('t1');",
          "36: } {c 1 a 1 b 0 d 0}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "120:   UPDATE t4 SET a = 'ABC';",
          "121:   SELECT * FROM t4;",
          "122: } {ABC def}",
          "124: do_execsql_test 2.2.1 {",
          "125:   DROP TABLE t4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "127: do_execsql_test 2.1.3 {",
          "128:   SELECT name, coll, key FROM pragma_index_xinfo('t4');",
          "129: } {a nocase 1 b BINARY 0}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "133:   SELECT * FROM t4;",
          "134: } {xyz ABC}",
          "136: do_execsql_test 2.3.1 {",
          "137:   CREATE TABLE t5 (a, b, PRIMARY KEY(b, a)) WITHOUT ROWID;",
          "138:   INSERT INTO t5(a, b) VALUES('abc', 'def');",
          "139:   UPDATE t5 SET a='abc', b='def';",
          "140: } {}",
          "142: do_execsql_test 2.4.1 {",
          "143:   CREATE TABLE t6 (",
          "144:     a COLLATE nocase, b, c UNIQUE, PRIMARY KEY(b, a)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "143: do_execsql_test 2.2.3 {",
          "144:   SELECT name, coll, key FROM pragma_index_xinfo('t4');",
          "145: } {a nocase 1 b BINARY 0}",
          "154: do_execsql_test 2.3.2 {",
          "155:   SELECT name, coll, key FROM pragma_index_xinfo('t5');",
          "156: } {b BINARY 1 a BINARY 1}",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "153:   SELECT * FROM t6 ORDER BY c;",
          "154: } {ABC def ghi ABC def ghi}",
          "156: #-------------------------------------------------------------------------",
          "157: # Unless the destination table is completely empty, the xfer optimization",
          "158: # is disabled for WITHOUT ROWID tables. The following tests check for",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "173: do_execsql_test 2.4.3 {",
          "174:   SELECT name, coll, key FROM pragma_index_xinfo('t6');",
          "175: } {b BINARY 1 a nocase 1 c BINARY 0}",
          "",
          "---------------"
        ],
        "test/without_rowid6.test||test/without_rowid6.test": [
          "File: test/without_rowid6.test -> test/without_rowid6.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "24:   INSERT INTO t1(a,b,c,d,e) SELECT i, i+1000, printf('x%dy',i), 0, 0 FROM c;",
          "25:   ANALYZE;",
          "26: } {}",
          "27: do_execsql_test without_rowid6-110 {",
          "28:   SELECT c FROM t1 WHERE a=123;",
          "29: } {x123y}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: do_execsql_test without_rowid6-101 {",
          "28:   SELECT name, key FROM pragma_index_xinfo('t1');",
          "29: } {a 1 b 1 c 1 d 1 e 0}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:   INSERT INTO t1(a,b,c) VALUES(1,8,3),(4,5,6),(7,2,9);",
          "52:   SELECT a FROM t1 WHERE b>3 ORDER BY b;",
          "53: } {4 1}",
          "54: do_execsql_test without_rowid6-210 {",
          "55:   EXPLAIN QUERY PLAN",
          "56:   SELECT a FROM t1 WHERE b>3 ORDER BY b;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "57: do_execsql_test without_rowid6-201 {",
          "58:   SELECT name, key FROM pragma_index_xinfo('t1');",
          "59: } {b 1 a 0 c 0}",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "105:   INSERT INTO t1(a,b,c) VALUES(1,8,3),(4,5,6),(7,2,9);",
          "106:   SELECT a FROM t1 WHERE b>3 ORDER BY b;",
          "107: } {4 1}",
          "108: do_execsql_test without_rowid6-510 {",
          "109:   EXPLAIN QUERY PLAN",
          "110:   SELECT a FROM t1 WHERE b>3 ORDER BY b;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "114: do_execsql_test without_rowid6-501 {",
          "115:   SELECT name, key FROM pragma_index_xinfo('t1');",
          "116: } {b 1 c 1 a 0}",
          "",
          "---------------"
        ],
        "test/without_rowid7.test||test/without_rowid7.test": [
          "File: test/without_rowid7.test -> test/without_rowid7.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # 2019 July 17",
          "2: #",
          "3: # The author disclaims copyright to this source code.  In place of",
          "4: # a legal notice, here is a blessing:",
          "5: #",
          "6: #    May you do good and not evil.",
          "7: #    May you find forgiveness for yourself and forgive others.",
          "8: #    May you share freely, never taking more than you give.",
          "9: #",
          "10: #*************************************************************************",
          "11: # This file implements regression tests for SQLite library.",
          "12: #",
          "14: set testdir [file dirname $argv0]",
          "15: source $testdir/tester.tcl",
          "16: set testprefix without_rowid7",
          "18: do_execsql_test 1.0 {",
          "19:   CREATE TABLE t1(a, b COLLATE nocase, PRIMARY KEY(a, a, b)) WITHOUT ROWID;",
          "20: }",
          "22: do_catchsql_test 1.1 {",
          "23:   INSERT INTO t1 VALUES(1, 'one'), (1, 'ONE');",
          "24: } {1 {UNIQUE constraint failed: t1.a, t1.b}}",
          "27: do_execsql_test 2.0 {",
          "28:   CREATE TABLE t2(a, b, PRIMARY KEY(a COLLATE nocase, a)) WITHOUT ROWID;",
          "29: }",
          "31: do_execsql_test 2.1 {",
          "32:   INSERT INTO t2 VALUES(1, 'one');",
          "33:   SELECT b FROM t2;",
          "34: } {one}",
          "36: do_execsql_test 2.2a {",
          "37:   PRAGMA index_info(t2);",
          "38: } {0 0 a 1 0 a}",
          "39: do_execsql_test 2.2b {",
          "40:   SELECT *, '|' FROM pragma_index_info('t2');",
          "41: } {0 0 a | 1 0 a |}",
          "42: do_execsql_test 2.3a {",
          "43:   PRAGMA index_xinfo(t2);",
          "44: } {0 0 a 0 nocase 1 1 0 a 0 BINARY 1 2 1 b 0 BINARY 0}",
          "45: do_execsql_test 2.3b {",
          "46:   SELECT *, '|' FROM pragma_index_xinfo('t2');",
          "47: } {0 0 a 0 nocase 1 | 1 0 a 0 BINARY 1 | 2 1 b 0 BINARY 0 |}",
          "49: do_execsql_test 2.4 {",
          "50:   CREATE TABLE t3(a, b, PRIMARY KEY(a COLLATE nocase, a));",
          "51:   PRAGMA index_info(t3);",
          "52: } {}",
          "56: finish_test",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "480c572f2da02cb6446a55df6c8b2df271446a66",
      "candidate_info": {
        "commit_hash": "480c572f2da02cb6446a55df6c8b2df271446a66",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/480c572f2da02cb6446a55df6c8b2df271446a66",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c",
          "test/indexfault.test"
        ],
        "message": "In sqlite3NestedParse() be sure to detect all SQLITE_NOMEM and SQLITE_TOOBIG errors and to distinguish between them.\n\nFossilOrigin-Name: 73056b314bd63288c662752e9bd469b70264c38031c1c857460e64fdb1ed4e2e",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c",
          "test/indexfault.test||test/indexfault.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: e7144ffd21294d7aebbfa6aa5a262797a6d16de11193f1bf6b75f5f27b04c940",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "260:   zSql = sqlite3VMPrintf(db, zFormat, ap);",
          "261:   va_end(ap);",
          "262:   if( zSql==0 ){",
          "264:   }",
          "265:   pParse->nested++;",
          "266:   memcpy(saveBuf, PARSE_TAIL(pParse), PARSE_TAIL_SZ);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "266:     if( !db->mallocFailed ) pParse->rc = SQLITE_TOOBIG;",
          "267:     return;",
          "",
          "---------------"
        ],
        "test/indexfault.test||test/indexfault.test": [
          "File: test/indexfault.test -> test/indexfault.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "337:   faultsim_test_result {0 {}}",
          "338: }",
          "340: uninstall_custom_faultsim",
          "342: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "340: do_faultsim_test 5 -prep {",
          "341:   reset_db",
          "342: } -body {",
          "343:   execsql {",
          "344:  CREATE TABLE reallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallyreallylongname(a PRIMARY KEY) WITHOUT ROWID;",
          "345:   }",
          "346: } -test {",
          "347:   faultsim_test_result {0 {}}",
          "348: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ca7a26b5a16dfa0c1b4fdfcadb67397428a2e90a",
      "candidate_info": {
        "commit_hash": "ca7a26b5a16dfa0c1b4fdfcadb67397428a2e90a",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/ca7a26b5a16dfa0c1b4fdfcadb67397428a2e90a",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/where.c",
          "test/join.test"
        ],
        "message": "Do not allow a term in the WHERE clause of the query to qualify a partial index on the right table of a LEFT JOIN.  Ticket [7f39060a24b47353]\n\nFossilOrigin-Name: 4066a34da7bcdcece6c438c27f3a11bc49b8c8373b7e1603f30f6225e2bc800a",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c",
          "test/join.test||test/join.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "test/join.test||test/join.test"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "test/join.test||test/join.test"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 2c4f714892327a1a9a303267b1f9685e310cca5dcea9c61287d95e26291b0506",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2794:   int i;",
          "2795:   WhereTerm *pTerm;",
          "2796:   Parse *pParse = pWC->pWInfo->pParse;",
          "2797:   while( pWhere->op==TK_AND ){",
          "2799:     pWhere = pWhere->pRight;",
          "2800:   }",
          "2801:   if( pParse->db->flags & SQLITE_EnableQPSG ) pParse = 0;",
          "",
          "[Removed Lines]",
          "2793: static int whereUsablePartialIndex(int iTab, WhereClause *pWC, Expr *pWhere){",
          "2798:     if( !whereUsablePartialIndex(iTab,pWC,pWhere->pLeft) ) return 0;",
          "",
          "[Added Lines]",
          "2793: static int whereUsablePartialIndex(",
          "2798: ){",
          "2803:     if( !whereUsablePartialIndex(iTab,isLeft,pWC,pWhere->pLeft) ) return 0;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2803:     Expr *pExpr;",
          "2804:     pExpr = pTerm->pExpr;",
          "2805:     if( (!ExprHasProperty(pExpr, EP_FromJoin) || pExpr->iRightJoinTable==iTab)",
          "2806:      && sqlite3ExprImpliesExpr(pParse, pExpr, pWhere, iTab)",
          "2807:     ){",
          "2808:       return 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2811:      && (isLeft==0 || ExprHasProperty(pExpr, EP_FromJoin))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2965:   for(; rc==SQLITE_OK && pProbe;",
          "2966:       pProbe=(pSrc->pIBIndex ? 0 : pProbe->pNext), iSortIdx++",
          "2967:   ){",
          "2968:     if( pProbe->pPartIdxWhere!=0",
          "2972:     }",
          "",
          "[Removed Lines]",
          "2969:      && !whereUsablePartialIndex(pSrc->iCursor, pWC, pProbe->pPartIdxWhere) ){",
          "",
          "[Added Lines]",
          "2974:     int isLeft = (pSrc->fg.jointype & JT_OUTER)!=0;",
          "2976:      && !whereUsablePartialIndex(pSrc->iCursor, isLeft, pWC,",
          "2977:                                  pProbe->pPartIdxWhere)",
          "2978:     ){",
          "",
          "---------------"
        ],
        "test/join.test||test/join.test": [
          "File: test/join.test -> test/join.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "953:   SELECT * FROM t0 LEFT JOIN t1 WHERE NULL IN (c1);",
          "954: } {}",
          "956: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "956: # 2019-11-30 ticket 7f39060a24b47353",
          "957: # Do not allow a WHERE clause term to qualify a partial index on the",
          "958: # right table of a LEFT JOIN.",
          "959: #",
          "960: do_execsql_test join-21.10 {",
          "961:   DROP TABLE t0;",
          "962:   DROP TABLE t1;",
          "963:   CREATE TABLE t0(aa);",
          "964:   CREATE TABLE t1(bb);",
          "965:   INSERT INTO t0(aa) VALUES (1);",
          "966:   INSERT INTO t1(bb) VALUES (1);",
          "967:   SELECT 11, * FROM t1 LEFT JOIN t0 WHERE aa ISNULL;",
          "968:   SELECT 12, * FROM t1 LEFT JOIN t0 WHERE +aa ISNULL;",
          "969:   SELECT 13, * FROM t1 LEFT JOIN t0 ON aa ISNULL;",
          "970:   SELECT 14, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
          "971:   CREATE INDEX i0 ON t0(aa) WHERE aa ISNULL;",
          "972:   SELECT 21, * FROM t1 LEFT JOIN t0 WHERE aa ISNULL;",
          "973:   SELECT 22, * FROM t1 LEFT JOIN t0 WHERE +aa ISNULL;",
          "974:   SELECT 23, * FROM t1 LEFT JOIN t0 ON aa ISNULL;",
          "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
          "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "94e02d9c2cabefe2ebcef47c4fb68cdb88d3e47a",
      "candidate_info": {
        "commit_hash": "94e02d9c2cabefe2ebcef47c4fb68cdb88d3e47a",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/94e02d9c2cabefe2ebcef47c4fb68cdb88d3e47a",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/shmlock.test"
        ],
        "message": "Fix the shmlock.test script so that it works with the Windows restriction that UnlockFile must exactly correspond to a prior LockFile.\n\nFossilOrigin-Name: df939c89fa90b7f9ccf961027ca4eca4f987c49eabf530b5719a83e5ab0d346d",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/shmlock.test||test/shmlock.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fbcd72565f4425016cebbbf5dfd6aa510234cfb31c785cf364f04fff444aacae",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/shmlock.test||test/shmlock.test": [
          "File: test/shmlock.test -> test/shmlock.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "114: sqlite3 db1 test.db",
          "115: do_test 3.1 { execsql { SELECT * FROM t1 } db0 } {1 2}",
          "116: do_test 3.2 { execsql { SELECT * FROM t1 } db1 } {1 2}",
          "118: set L(0) {n n n n n n n n}",
          "119: set L(1) {n n n n n n n n}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "117: if {$tcl_platform(platform)==\"windows\"} {",
          "118:   set isWindows 1",
          "119: } else {",
          "120:   set isWindows 0",
          "121: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "134:       if {$locktype==\"e\"} {",
          "135:         for {set l $iSlot} {$l<8 && [lindex $L($idx) $l]==\"n\"} {incr l} {}",
          "136:         set n [expr int(rand()*($l-$iSlot))+1]",
          "137:         # puts \"iSlot=$iSlot l=$l L=$L($idx)\"",
          "138:         # puts \"$iSlot $n\"",
          "139:       }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "142:         # The LockFile() and UnlockFile() apis on windows require that",
          "143:         # every unlock correspond exactly to a prior lock.  Hence, we cannot",
          "144:         # lock arbitrary ranges in this test on windows.",
          "145:         if {$::isWindows} {set n 1}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1d07f1d8c7bc6781e118ed6d36a651b52531e282",
      "candidate_info": {
        "commit_hash": "1d07f1d8c7bc6781e118ed6d36a651b52531e282",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/1d07f1d8c7bc6781e118ed6d36a651b52531e282",
        "files": [
          "Makefile.in",
          "Makefile.msc",
          "main.mk",
          "manifest",
          "manifest.uuid",
          "src/test_tclsh.c",
          "src/test_vdbecov.c",
          "test/tester.tcl",
          "test/windowerr.tcl",
          "test/windowerr.test"
        ],
        "message": "If the library is built with SQLITE_VDBE_COVERAGE defined, have the Tcl tests generate a vdbe coverage report in file testdir/vdbe_coverage.txt.\n\nFossilOrigin-Name: f0ed714637bf30443d0551d9b6fececa00fc9dfe9669fe720c4598ef71c61e2c",
        "before_after_code_files": [
          "Makefile.in||Makefile.in",
          "Makefile.msc||Makefile.msc",
          "main.mk||main.mk",
          "manifest.uuid||manifest.uuid",
          "src/test_tclsh.c||src/test_tclsh.c",
          "src/test_vdbecov.c||src/test_vdbecov.c",
          "test/tester.tcl||test/tester.tcl",
          "test/windowerr.tcl||test/windowerr.tcl",
          "test/windowerr.test||test/windowerr.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "Makefile.in||Makefile.in": [
          "File: Makefile.in -> Makefile.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "422:   $(TOP)/src/test_tclsh.c \\",
          "423:   $(TOP)/src/test_tclvar.c \\",
          "424:   $(TOP)/src/test_thread.c \\",
          "425:   $(TOP)/src/test_vfs.c \\",
          "426:   $(TOP)/src/test_windirent.c \\",
          "427:   $(TOP)/src/test_window.c \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "425:   $(TOP)/src/test_vdbecov.c \\",
          "",
          "---------------"
        ],
        "Makefile.msc||Makefile.msc": [
          "File: Makefile.msc -> Makefile.msc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1517:   $(TOP)\\src\\test_tclsh.c \\",
          "1518:   $(TOP)\\src\\test_tclvar.c \\",
          "1519:   $(TOP)\\src\\test_thread.c \\",
          "1520:   $(TOP)\\src\\test_vfs.c \\",
          "1521:   $(TOP)\\src\\test_windirent.c \\",
          "1522:   $(TOP)\\src\\test_window.c \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1520:   $(TOP)\\src\\test_vdbecov.c \\",
          "",
          "---------------"
        ],
        "main.mk||main.mk": [
          "File: main.mk -> main.mk",
          "--- Hunk 1 ---",
          "[Context before]",
          "348:   $(TOP)/src/test_tclsh.c \\",
          "349:   $(TOP)/src/test_tclvar.c \\",
          "350:   $(TOP)/src/test_thread.c \\",
          "351:   $(TOP)/src/test_vfs.c \\",
          "352:   $(TOP)/src/test_windirent.c \\",
          "353:   $(TOP)/src/test_window.c \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "351:   $(TOP)/src/test_vdbecov.c \\",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fa37cf9a6aa3e4325674cb6af68f617d25e349c3f694d0117a19a36fc42daf15",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/test_tclsh.c||src/test_tclsh.c": [
          "File: src/test_tclsh.c -> src/test_tclsh.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "106: #endif",
          "107:   extern int TestExpert_Init(Tcl_Interp*);",
          "108:   extern int Sqlitetest_window_Init(Tcl_Interp *);",
          "110:   Tcl_CmdInfo cmdInfo;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "109:   extern int Sqlitetestvdbecov_Init(Tcl_Interp *);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "171: #endif",
          "172:   TestExpert_Init(interp);",
          "173:   Sqlitetest_window_Init(interp);",
          "175:   Tcl_CreateObjCommand(",
          "176:       interp, \"load_testfixture_extensions\", load_testfixture_extensions,0,0",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "175:   Sqlitetestvdbecov_Init(interp);",
          "",
          "---------------"
        ],
        "src/test_vdbecov.c||src/test_vdbecov.c": [
          "File: src/test_vdbecov.c -> src/test_vdbecov.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "16: #include \"sqlite3.h\"",
          "17: #include \"sqliteInt.h\"",
          "18: #if defined(INCLUDE_SQLITE_TCL_H)",
          "19: #  include \"sqlite_tcl.h\"",
          "20: #else",
          "21: #  include \"tcl.h\"",
          "22: #endif",
          "24: #ifdef SQLITE_VDBE_COVERAGE",
          "26: static u8 aBranchArray[200000];",
          "28: static void test_vdbe_branch(",
          "29:   void *pCtx,",
          "30:   unsigned int iSrc,",
          "31:   unsigned char iBranch,",
          "32:   unsigned char iType",
          "33: ){",
          "34:   if( iSrc<sizeof(aBranchArray) ){",
          "35:     aBranchArray[iSrc] |= iBranch;",
          "36:   }",
          "37: }",
          "39: static void appendToList(Tcl_Obj *pList, int iLine, int iPath){",
          "40:   Tcl_Obj *pNew = Tcl_NewObj();",
          "41:   Tcl_IncrRefCount(pNew);",
          "42:   Tcl_ListObjAppendElement(0, pNew, Tcl_NewIntObj(iLine));",
          "43:   Tcl_ListObjAppendElement(0, pNew, Tcl_NewIntObj(iPath));",
          "44:   Tcl_ListObjAppendElement(0, pList, pNew);",
          "45:   Tcl_DecrRefCount(pNew);",
          "46: }",
          "49: static int SQLITE_TCLAPI test_vdbe_coverage(",
          "50:   ClientData cd,",
          "51:   Tcl_Interp *interp,",
          "52:   int objc,",
          "53:   Tcl_Obj *CONST objv[]",
          "54: ){",
          "55:   const char *aSub[] = { \"start\", \"report\", \"stop\", 0 };",
          "56:   int iSub = -1;",
          "57:   if( objc!=2 ){",
          "58:     Tcl_WrongNumArgs(interp, 1, objv, \"sub-command\");",
          "59:     return TCL_ERROR;",
          "60:   }",
          "62:   if( Tcl_GetIndexFromObj(interp, objv[1], aSub, \"sub-command\", 0, &iSub) ){",
          "63:     return TCL_ERROR;",
          "64:   }",
          "66:   Tcl_ResetResult(interp);",
          "67:   assert( iSub==0 || iSub==1 || iSub==2 );",
          "68:   switch( iSub ){",
          "70:       memset(aBranchArray, 0, sizeof(aBranchArray));",
          "71:       sqlite3_test_control(SQLITE_TESTCTRL_VDBE_COVERAGE, test_vdbe_branch, 0);",
          "72:       break;",
          "74:       int i;",
          "75:       Tcl_Obj *pRes = Tcl_NewObj();",
          "76:       Tcl_IncrRefCount(pRes);",
          "77:       for(i=0; i<sizeof(aBranchArray); i++){",
          "78:         u8 b = aBranchArray[i];",
          "79:         if( b ){",
          "80:           if( (b & 0x01)==0 ) appendToList(pRes, i, 0);",
          "81:           if( (b & 0x02)==0 ) appendToList(pRes, i, 1);",
          "82:           if( (b & 0x04)==0 ) appendToList(pRes, i, 2);",
          "83:         }",
          "84:       }",
          "85:       Tcl_SetObjResult(interp, pRes);",
          "86:       Tcl_DecrRefCount(pRes);",
          "87:       break;",
          "88:     };",
          "91:       sqlite3_test_control(SQLITE_TESTCTRL_VDBE_COVERAGE, 0, 0);",
          "92:       break;",
          "93:   }",
          "95:   return TCL_OK;",
          "96: }",
          "100: int Sqlitetestvdbecov_Init(Tcl_Interp *interp){",
          "101: #ifdef SQLITE_VDBE_COVERAGE",
          "102:   Tcl_CreateObjCommand(interp, \"vdbe_coverage\", test_vdbe_coverage, 0, 0);",
          "103: #endif",
          "104:   return TCL_OK;",
          "105: }",
          "107: #endif",
          "",
          "---------------"
        ],
        "test/tester.tcl||test/tester.tcl": [
          "File: test/tester.tcl -> test/tester.tcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "576:   if {$cmdlinearg(verbose)==\"\"} {",
          "577:     set cmdlinearg(verbose) 1",
          "578:   }",
          "579: }",
          "581: # Update the soft-heap-limit each time this script is run. In that",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "580:   if {[info commands vdbe_coverage]!=\"\"} {",
          "581:     vdbe_coverage start",
          "582:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1296:       memdebug_log_sql leaks.tcl",
          "1297:     }",
          "1298:   }",
          "1299:   foreach f [glob -nocomplain test.db-*-journal] {",
          "1300:     forcedelete $f",
          "1301:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1303:   if {[info commands vdbe_coverage]!=\"\"} {",
          "1304:     vdbe_coverage_report",
          "1305:   }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1305:   exit [expr {$nErr>0}]",
          "1306: }",
          "1308: # Display memory statistics for analysis and debugging purposes.",
          "1309: #",
          "1310: proc show_memstats {} {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1315: proc vdbe_coverage_report {} {",
          "1316:   puts \"Writing vdbe coverage report to vdbe_coverage.txt\"",
          "1317:   set lSrc [list]",
          "1318:   set iLine 0",
          "1319:   if {[file exists ../sqlite3.c]} {",
          "1320:     set fd [open ../sqlite3.c]",
          "1321:     set iLine",
          "1322:     while { ![eof $fd] } {",
          "1323:       set line [gets $fd]",
          "1324:       incr iLine",
          "1325:       if {[regexp {^/\\** Begin file (.*\\.c) \\**/} $line -> file]} {",
          "1326:         lappend lSrc [list $iLine $file]",
          "1327:       }",
          "1328:     }",
          "1329:     close $fd",
          "1330:   }",
          "1331:   set fd [open vdbe_coverage.txt w]",
          "1332:   foreach miss [vdbe_coverage report] {",
          "1333:     foreach {line branch} $miss {}",
          "1334:     set nextfile \"\"",
          "1335:     while {[llength $lSrc]>0 && [lindex $lSrc 0 0] < $line} {",
          "1336:       set nextfile [lindex $lSrc 0 1]",
          "1337:       set lSrc [lrange $lSrc 1 end]",
          "1338:     }",
          "1339:     if {$nextfile != \"\"} {",
          "1340:       puts $fd \"\"",
          "1341:       puts $fd \"### $nextfile ###\"",
          "1342:     }",
          "1343:     puts $fd \"Vdbe branch $line: path $branch never taken\"",
          "1344:   }",
          "1345:   close $fd",
          "1346: }",
          "",
          "---------------"
        ],
        "test/windowerr.tcl||test/windowerr.tcl": [
          "File: test/windowerr.tcl -> test/windowerr.tcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "55:   SELECT sum(a) OVER () AS xyz FROM t1 ORDER BY sum(xyz);",
          "56: }",
          "59: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58: errorsql_test 3.0 {",
          "59:   SELECT sum(a) OVER win FROM t1",
          "60:   WINDOW win AS (ROWS BETWEEN 'hello' PRECEDING AND 10 FOLLOWING)",
          "61: }",
          "62: errorsql_test 3.2 {",
          "63:   SELECT sum(a) OVER win FROM t1",
          "64:   WINDOW win AS (ROWS BETWEEN 10 PRECEDING AND x'ABCD' FOLLOWING)",
          "65: }",
          "",
          "---------------"
        ],
        "test/windowerr.test||test/windowerr.test": [
          "File: test/windowerr.test -> test/windowerr.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "96:   SELECT sum(a) OVER () AS xyz FROM t1 ORDER BY sum(xyz);",
          "97: } } } 1",
          "99: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "99: # PG says ERROR:  invalid input syntax for integer: \"hello\"",
          "100: do_test 3.0 { catch { execsql {",
          "101:   SELECT sum(a) OVER win FROM t1",
          "102:   WINDOW win AS (ROWS BETWEEN 'hello' PRECEDING AND 10 FOLLOWING)",
          "103: } } } 1",
          "105: # PG says ERROR:  argument of ROWS must be type bigint, not type bit",
          "106: do_test 3.2 { catch { execsql {",
          "107:   SELECT sum(a) OVER win FROM t1",
          "108:   WINDOW win AS (ROWS BETWEEN 10 PRECEDING AND x'ABCD' FOLLOWING)",
          "109: } } } 1",
          "",
          "---------------"
        ]
      }
    }
  ]
}