{
  "cve_id": "CVE-2021-29579",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. The implementation of `tf.raw_ops.MaxPoolGrad` is vulnerable to a heap buffer overflow. The implementation(https://github.com/tensorflow/tensorflow/blob/ab1e644b48c82cb71493f4362b4dd38f4577a1cf/tensorflow/core/kernels/maxpooling_op.cc#L194-L203) fails to validate that indices used to access elements of input/output arrays are valid. Whereas accesses to `input_backprop_flat` are guarded by `FastBoundsCheck`, the indexing in `out_backprop_flat` can result in OOB access. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "a74768f8e4efbda4def9f16ee7e13cf3922ac5f7",
  "patch_info": {
    "commit_hash": "a74768f8e4efbda4def9f16ee7e13cf3922ac5f7",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/a74768f8e4efbda4def9f16ee7e13cf3922ac5f7",
    "files": [
      "tensorflow/core/kernels/maxpooling_op.cc"
    ],
    "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
    "before_after_code_files": [
      "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
      "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "201:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
      "203:       }",
      "204:     }",
      "205:   };",
      "",
      "[Removed Lines]",
      "202:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
      "",
      "[Added Lines]",
      "202:         if (index < out_backprop.NumElements()) {",
      "203:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
      "204:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4382af500f7422144e3d98301e389d39b09b7678",
      "candidate_info": {
        "commit_hash": "4382af500f7422144e3d98301e389d39b09b7678",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/4382af500f7422144e3d98301e389d39b09b7678",
        "files": [
          "tensorflow/core/kernels/maxpooling_op.cc"
        ],
        "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
        "before_after_code_files": [
          "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
          "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
          "196:       }",
          "197:     }",
          "198:   };",
          "",
          "[Removed Lines]",
          "195:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "",
          "[Added Lines]",
          "195:         if (index < out_backprop.NumElements()) {",
          "196:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "197:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bbce6de5a12d4b4ef00bd5f7522acc431d2fbbf5",
      "candidate_info": {
        "commit_hash": "bbce6de5a12d4b4ef00bd5f7522acc431d2fbbf5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/bbce6de5a12d4b4ef00bd5f7522acc431d2fbbf5",
        "files": [
          "tensorflow/core/kernels/maxpooling_op.cc"
        ],
        "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
        "before_after_code_files": [
          "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
          "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "201:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
          "203:       }",
          "204:     }",
          "205:   };",
          "",
          "[Removed Lines]",
          "202:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "",
          "[Added Lines]",
          "202:         if (index < out_backprop.NumElements()) {",
          "203:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "204:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7155a0ba42441ffbd32bb1edc72eff1a32313f2b",
      "candidate_info": {
        "commit_hash": "7155a0ba42441ffbd32bb1edc72eff1a32313f2b",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/7155a0ba42441ffbd32bb1edc72eff1a32313f2b",
        "files": [
          "tensorflow/core/kernels/maxpooling_op.cc"
        ],
        "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
        "before_after_code_files": [
          "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
          "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
          "196:       }",
          "197:     }",
          "198:   };",
          "",
          "[Removed Lines]",
          "195:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "",
          "[Added Lines]",
          "195:         if (index < out_backprop.NumElements()) {",
          "196:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "197:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c29463adea245860e33fcfaccf600e176e8bf247",
      "candidate_info": {
        "commit_hash": "c29463adea245860e33fcfaccf600e176e8bf247",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c29463adea245860e33fcfaccf600e176e8bf247",
        "files": [
          "tensorflow/core/kernels/maxpooling_op.cc"
        ],
        "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
        "before_after_code_files": [
          "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
          "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
          "196:       }",
          "197:     }",
          "198:   };",
          "",
          "[Removed Lines]",
          "195:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "",
          "[Added Lines]",
          "195:         if (index < out_backprop.NumElements()) {",
          "196:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "197:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1a8fcce5b507b372fe1d7e0f45ea8a2a8553b0b4",
      "candidate_info": {
        "commit_hash": "1a8fcce5b507b372fe1d7e0f45ea8a2a8553b0b4",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/1a8fcce5b507b372fe1d7e0f45ea8a2a8553b0b4",
        "files": [
          "tensorflow/core/kernels/maxpooling_op.cc"
        ],
        "message": "Prevent heap OOB error in `MaxPoolGrad`\n\nPiperOrigin-RevId: 372424854\nChange-Id: Idac0f23867ad8b0601cafbaaa52d5e64269e63a7",
        "before_after_code_files": [
          "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/maxpooling_op.cc||tensorflow/core/kernels/maxpooling_op.cc": [
          "File: tensorflow/core/kernels/maxpooling_op.cc -> tensorflow/core/kernels/maxpooling_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:         FastBoundsCheck(input_backprop_index - in_start, in_end - in_start);",
          "196:       }",
          "197:     }",
          "198:   };",
          "",
          "[Removed Lines]",
          "195:         input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "",
          "[Added Lines]",
          "195:         if (index < out_backprop.NumElements()) {",
          "196:           input_backprop_flat(input_backprop_index) += out_backprop_flat(index);",
          "197:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}