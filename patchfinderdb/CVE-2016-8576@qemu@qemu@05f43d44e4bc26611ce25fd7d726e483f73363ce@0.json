{
  "cve_id": "CVE-2016-8576",
  "cve_desc": "The xhci_ring_fetch function in hw/usb/hcd-xhci.c in QEMU (aka Quick Emulator) allows local guest OS administrators to cause a denial of service (infinite loop and QEMU process crash) by leveraging failure to limit the number of link Transfer Request Blocks (TRB) to process.",
  "repo": "qemu/qemu",
  "patch_hash": "05f43d44e4bc26611ce25fd7d726e483f73363ce",
  "patch_info": {
    "commit_hash": "05f43d44e4bc26611ce25fd7d726e483f73363ce",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/05f43d44e4bc26611ce25fd7d726e483f73363ce",
    "files": [
      "hw/usb/hcd-xhci.c"
    ],
    "message": "xhci: limit the number of link trbs we are willing to process\n\nNeeded to avoid we run in circles forever in case the guest builds\nan endless loop with link trbs.\n\nReported-by: Li Qiang <liqiang6-s@360.cn>\nTested-by: P J P <ppandit@redhat.com>\nSigned-off-by: Gerd Hoffmann <kraxel@redhat.com>\nMessage-id: 1476096382-7981-1-git-send-email-kraxel@redhat.com",
    "before_after_code_files": [
      "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
    ]
  },
  "patch_diff": {
    "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c": [
      "File: hw/usb/hcd-xhci.c -> hw/usb/hcd-xhci.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "55: #define ER_FULL_HACK",
      "57: #define LEN_CAP         0x40",
      "58: #define LEN_OPER        (0x400 + 0x10 * MAXPORTS)",
      "59: #define LEN_RUNTIME     ((MAXINTRS + 1) * 0x20)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "57: #define TRB_LINK_LIMIT  4",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1000:                                dma_addr_t *addr)",
      "1001: {",
      "1002:     PCIDevice *pci_dev = PCI_DEVICE(xhci);",
      "1004:     while (1) {",
      "1005:         TRBType type;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1005:     uint32_t link_cnt = 0;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1026:             ring->dequeue += TRB_SIZE;",
      "1027:             return type;",
      "1028:         } else {",
      "1029:             ring->dequeue = xhci_mask64(trb->parameter);",
      "1030:             if (trb->control & TRB_LK_TC) {",
      "1031:                 ring->ccs = !ring->ccs;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1032:             if (++link_cnt > TRB_LINK_LIMIT) {",
      "1033:                 return 0;",
      "1034:             }",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1043:     bool ccs = ring->ccs;",
      "1045:     bool control_td_set = 0;",
      "1047:     while (1) {",
      "1048:         TRBType type;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1052:     uint32_t link_cnt = 0;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1058:         type = TRB_TYPE(trb);",
      "1060:         if (type == TR_LINK) {",
      "1061:             dequeue = xhci_mask64(trb.parameter);",
      "1062:             if (trb.control & TRB_LK_TC) {",
      "1063:                 ccs = !ccs;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1068:             if (++link_cnt > TRB_LINK_LIMIT) {",
      "1069:                 return -length;",
      "1070:             }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "99f9aeba5d461f79c9ce73f968ba0feb77fc1f5a",
      "candidate_info": {
        "commit_hash": "99f9aeba5d461f79c9ce73f968ba0feb77fc1f5a",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/99f9aeba5d461f79c9ce73f968ba0feb77fc1f5a",
        "files": [
          "hw/usb/hcd-xhci.c"
        ],
        "message": "xhci: relax link check\n\nThe strict td link limit added by commit \"05f43d4 xhci: limit the\nnumber of link trbs we are willing to process\" causes problems with\nWindows guests. Let's raise the limit.\n\nThis change is analogous to:\n\n  commit ab6b1105a2259c7072905887f71caa850ce63190\n  Author: Gerd Hoffmann <kraxel@redhat.com>\n  Date:   Tue Mar 7 09:40:18 2017 +0100\n\n      ohci: relax link check\n\nSigned-off-by: Ladi Prosek <lprosek@redhat.com>\nMessage-id: 20170512102100.22675-1-lprosek@redhat.com\nSigned-off-by: Gerd Hoffmann <kraxel@redhat.com>",
        "before_after_code_files": [
          "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
          ],
          "candidate": [
            "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c": [
          "File: hw/usb/hcd-xhci.c -> hw/usb/hcd-xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "51: #define EV_QUEUE (((3 * 24) + 16) * MAXSLOTS)",
          "54: #define COMMAND_LIMIT   256",
          "55: #define TRANSFER_LIMIT  256",
          "",
          "[Removed Lines]",
          "53: #define TRB_LINK_LIMIT  4",
          "",
          "[Added Lines]",
          "53: #define TRB_LINK_LIMIT  32",
          "",
          "---------------"
        ]
      }
    }
  ]
}