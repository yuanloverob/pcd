{
  "cve_id": "CVE-2017-3731",
  "cve_desc": "If an SSL/TLS server or client is running on a 32-bit host, and a specific cipher is being used, then a truncated packet can cause that server or client to perform an out-of-bounds read, usually resulting in a crash. For OpenSSL 1.1.0, the crash can be triggered when using CHACHA20/POLY1305; users should upgrade to 1.1.0d. For Openssl 1.0.2, the crash can be triggered when using RC4-MD5; users who have not disabled that algorithm should update to 1.0.2k.",
  "repo": "openssl/openssl",
  "patch_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
  "patch_info": {
    "commit_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/00d965474b22b54e4275232bc71ee0c699c5cd21",
    "files": [
      "crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c"
    ],
    "message": "crypto/evp: harden AEAD ciphers.\n\nOriginally a crash in 32-bit build was reported CHACHA20-POLY1305\ncipher. The crash is triggered by truncated packet and is result\nof excessive hashing to the edge of accessible memory. Since hash\noperation is read-only it is not considered to be exploitable\nbeyond a DoS condition. Other ciphers were hardened.\n\nThanks to Robert \u015awi\u0119cki for report.\n\nCVE-2017-3731\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "crypto/evp/e_aes.c||crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c"
    ]
  },
  "patch_diff": {
    "crypto/evp/e_aes.c||crypto/evp/e_aes.c": [
      "File: crypto/evp/e_aes.c -> crypto/evp/e_aes.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1388:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1389:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1391:             len -= EVP_GCM_TLS_EXPLICIT_IV_LEN;",
      "1394:                 len -= EVP_GCM_TLS_TAG_LEN;",
      "1395:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1396:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1397:         }",
      "",
      "[Removed Lines]",
      "1393:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1391:             if (len < EVP_GCM_TLS_EXPLICIT_IV_LEN)",
      "1392:                 return 0;",
      "1395:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1396:                 if (len < EVP_GCM_TLS_TAG_LEN)",
      "1397:                     return 0;",
      "1399:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1946:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1947:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1949:             len -= EVP_CCM_TLS_EXPLICIT_IV_LEN;",
      "1952:                 len -= cctx->M;",
      "1953:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1954:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1955:         }",
      "",
      "[Removed Lines]",
      "1951:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1954:             if (len < EVP_CCM_TLS_EXPLICIT_IV_LEN)",
      "1955:                 return 0;",
      "1958:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1959:                 if (len < cctx->M)",
      "1960:                     return 0;",
      "1962:             }",
      "",
      "---------------"
    ],
    "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c": [
      "File: crypto/evp/e_chacha20_poly1305.c -> crypto/evp/e_chacha20_poly1305.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "398:             len = aad[EVP_AEAD_TLS1_AAD_LEN - 2] << 8 |",
      "399:                   aad[EVP_AEAD_TLS1_AAD_LEN - 1];",
      "400:             if (!ctx->encrypt) {",
      "402:                 memcpy(temp, aad, EVP_AEAD_TLS1_AAD_LEN - 2);",
      "403:                 aad = temp;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "401:                 if (len < POLY1305_BLOCK_SIZE)",
      "402:                     return 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4b684b54d6418727372200557b0386729e2ee8e5",
      "candidate_info": {
        "commit_hash": "4b684b54d6418727372200557b0386729e2ee8e5",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/4b684b54d6418727372200557b0386729e2ee8e5",
        "files": [
          "util/TLSProxy/Proxy.pm"
        ],
        "message": "Support renegotiation in TLSProxy\n\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1983)",
        "before_after_code_files": [
          "util/TLSProxy/Proxy.pm||util/TLSProxy/Proxy.pm"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "util/TLSProxy/Proxy.pm||util/TLSProxy/Proxy.pm": [
          "File: util/TLSProxy/Proxy.pm -> util/TLSProxy/Proxy.pm",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:         clientflags => \"\",",
          "43:         serverconnects => 1,",
          "44:         serverpid => 0,",
          "46:         #Public read",
          "47:         execute => $execute,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "45:         reneg => 0,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "117:     $self->{serverflags} = \"\";",
          "118:     $self->{serverconnects} = 1;",
          "119:     $self->{serverpid} = 0;",
          "120: }",
          "122: sub restart",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "121:     $self->{reneg} = 0;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "200:                     or die \"Failed to redirect stdout: $!\";",
          "201:                 open(STDERR, \">&STDOUT\");",
          "202:             }",
          "204:                  .\" s_client -engine ossltest -connect \"",
          "205:                  .($self->proxy_addr).\":\".($self->proxy_port);",
          "206:             if ($self->cipherc ne \"\") {",
          "",
          "[Removed Lines]",
          "203:             my $execcmd = \"echo test | \".$self->execute",
          "",
          "[Added Lines]",
          "205:             my $echostr;",
          "206:             if ($self->reneg()) {",
          "207:                 $echostr = \"R\";",
          "208:             } else {",
          "209:                 $echostr = \"test\";",
          "210:             }",
          "211:             my $execcmd = \"echo \".$echostr.\" | \".$self->execute",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "505:     return $ret;",
          "506: }",
          "508: 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "516: sub reneg",
          "517: {",
          "518:     my $self = shift;",
          "519:     if (@_) {",
          "520:       $self->{reneg} = shift;",
          "521:     }",
          "522:     return $self->{reneg};",
          "523: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f5eab25a7c03c5fb1d3fab55c506907f8fbd427e",
      "candidate_info": {
        "commit_hash": "f5eab25a7c03c5fb1d3fab55c506907f8fbd427e",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/f5eab25a7c03c5fb1d3fab55c506907f8fbd427e",
        "files": [
          "apps/speed.c",
          "crypto/evp/e_aes_cbc_hmac_sha1.c",
          "crypto/evp/e_aes_cbc_hmac_sha256.c",
          "crypto/evp/e_rc4.c",
          "crypto/evp/e_rc4_hmac_md5.c",
          "crypto/include/internal/evp_int.h",
          "ssl/record/rec_layer_s3.c"
        ],
        "message": "Cleanup EVP_CIPH/EP_CTRL duplicate defines\n\nRemove duplicate defines from EVP source files.\nMost of them were in evp.h, which is always included.\nAdd new ones evp_int.h\nEVP_CIPH_FLAG_TLS1_1_MULTIBLOCK is now always defined in evp.h, so\nremove conditionals on it\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2201)\n(cherry picked from commit 9d6fcd4295fef7ebc4232aab85718a99d36cc50a)",
        "before_after_code_files": [
          "apps/speed.c||apps/speed.c",
          "crypto/evp/e_aes_cbc_hmac_sha1.c||crypto/evp/e_aes_cbc_hmac_sha1.c",
          "crypto/evp/e_aes_cbc_hmac_sha256.c||crypto/evp/e_aes_cbc_hmac_sha256.c",
          "crypto/evp/e_rc4.c||crypto/evp/e_rc4.c",
          "crypto/evp/e_rc4_hmac_md5.c||crypto/evp/e_rc4_hmac_md5.c",
          "crypto/include/internal/evp_int.h||crypto/include/internal/evp_int.h",
          "ssl/record/rec_layer_s3.c||ssl/record/rec_layer_s3.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "apps/speed.c||apps/speed.c": [
          "File: apps/speed.c -> apps/speed.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2273: #endif",
          "2275:     if (doit[D_EVP]) {",
          "2277:         if (multiblock && evp_cipher) {",
          "2278:             if (!",
          "2279:                 (EVP_CIPHER_flags(evp_cipher) &",
          "",
          "[Removed Lines]",
          "2276: #ifdef EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2290:             ret = 0;",
          "2291:             goto end;",
          "2292:         }",
          "2294:         for (testnum = 0; testnum < SIZE_NUM; testnum++) {",
          "2295:             if (evp_cipher) {",
          "",
          "[Removed Lines]",
          "2293: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "crypto/evp/e_aes_cbc_hmac_sha1.c||crypto/evp/e_aes_cbc_hmac_sha1.c": [
          "File: crypto/evp/e_aes_cbc_hmac_sha1.c -> crypto/evp/e_aes_cbc_hmac_sha1.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: #include \"internal/evp_int.h\"",
          "22: #include \"internal/constant_time_locl.h\"",
          "40: typedef struct {",
          "41:     AES_KEY ks;",
          "42:     SHA_CTX head, tail, md;",
          "",
          "[Removed Lines]",
          "24: #ifndef EVP_CIPH_FLAG_AEAD_CIPHER",
          "25: # define EVP_CIPH_FLAG_AEAD_CIPHER       0x200000",
          "26: # define EVP_CTRL_AEAD_TLS1_AAD          0x16",
          "27: # define EVP_CTRL_AEAD_SET_MAC_KEY       0x17",
          "28: #endif",
          "30: #if !defined(EVP_CIPH_FLAG_DEFAULT_ASN1)",
          "31: # define EVP_CIPH_FLAG_DEFAULT_ASN1 0",
          "32: #endif",
          "34: #if !defined(EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK)",
          "35: # define EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK 0",
          "36: #endif",
          "38: #define TLS1_1_VERSION 0x0302",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "146: # endif",
          "147: # define SHA1_Update sha1_update",
          "151: typedef struct {",
          "152:     unsigned int A[8], B[8], C[8], D[8], E[8];",
          "",
          "[Removed Lines]",
          "149: # if !defined(OPENSSL_NO_MULTIBLOCK) && EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "",
          "[Added Lines]",
          "133: # if !defined(OPENSSL_NO_MULTIBLOCK)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "842:                 return SHA_DIGEST_LENGTH;",
          "843:             }",
          "844:         }",
          "846:     case EVP_CTRL_TLS1_1_MULTIBLOCK_MAX_BUFSIZE:",
          "847:         return (int)(5 + 16 + ((arg + 20 + 16) & -16));",
          "848:     case EVP_CTRL_TLS1_1_MULTIBLOCK_AAD:",
          "",
          "[Removed Lines]",
          "845: # if !defined(OPENSSL_NO_MULTIBLOCK) && EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "",
          "[Added Lines]",
          "829: # if !defined(OPENSSL_NO_MULTIBLOCK)",
          "",
          "---------------"
        ],
        "crypto/evp/e_aes_cbc_hmac_sha256.c||crypto/evp/e_aes_cbc_hmac_sha256.c": [
          "File: crypto/evp/e_aes_cbc_hmac_sha256.c -> crypto/evp/e_aes_cbc_hmac_sha256.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: #include \"internal/constant_time_locl.h\"",
          "23: #include \"internal/evp_int.h\"",
          "41: typedef struct {",
          "42:     AES_KEY ks;",
          "43:     SHA256_CTX head, tail, md;",
          "",
          "[Removed Lines]",
          "25: #ifndef EVP_CIPH_FLAG_AEAD_CIPHER",
          "26: # define EVP_CIPH_FLAG_AEAD_CIPHER       0x200000",
          "27: # define EVP_CTRL_AEAD_TLS1_AAD          0x16",
          "28: # define EVP_CTRL_AEAD_SET_MAC_KEY       0x17",
          "29: #endif",
          "31: #if !defined(EVP_CIPH_FLAG_DEFAULT_ASN1)",
          "32: # define EVP_CIPH_FLAG_DEFAULT_ASN1 0",
          "33: #endif",
          "35: #if !defined(EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK)",
          "36: # define EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK 0",
          "37: #endif",
          "39: #define TLS1_1_VERSION 0x0302",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "142: # endif",
          "143: # define SHA256_Update sha256_update",
          "147: typedef struct {",
          "148:     unsigned int A[8], B[8], C[8], D[8], E[8], F[8], G[8], H[8];",
          "",
          "[Removed Lines]",
          "145: # if !defined(OPENSSL_NO_MULTIBLOCK) && EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "",
          "[Added Lines]",
          "129: # if !defined(OPENSSL_NO_MULTIBLOCK)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "819:                 return SHA256_DIGEST_LENGTH;",
          "820:             }",
          "821:         }",
          "823:     case EVP_CTRL_TLS1_1_MULTIBLOCK_MAX_BUFSIZE:",
          "824:         return (int)(5 + 16 + ((arg + 32 + 16) & -16));",
          "825:     case EVP_CTRL_TLS1_1_MULTIBLOCK_AAD:",
          "",
          "[Removed Lines]",
          "822: # if !defined(OPENSSL_NO_MULTIBLOCK) && EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "",
          "[Added Lines]",
          "806: # if !defined(OPENSSL_NO_MULTIBLOCK)",
          "",
          "---------------"
        ],
        "crypto/evp/e_rc4.c||crypto/evp/e_rc4.c": [
          "File: crypto/evp/e_rc4.c -> crypto/evp/e_rc4.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: # include \"internal/evp_int.h\"",
          "24: typedef struct {",
          "26: } EVP_RC4_KEY;",
          "",
          "[Removed Lines]",
          "22: # define EVP_RC4_KEY_SIZE                16",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "crypto/evp/e_rc4_hmac_md5.c||crypto/evp/e_rc4_hmac_md5.c": [
          "File: crypto/evp/e_rc4_hmac_md5.c -> crypto/evp/e_rc4_hmac_md5.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: # include <openssl/md5.h>",
          "22: # include \"internal/evp_int.h\"",
          "33: typedef struct {",
          "34:     RC4_KEY ks;",
          "35:     MD5_CTX head, tail, md;",
          "",
          "[Removed Lines]",
          "24: # ifndef EVP_CIPH_FLAG_AEAD_CIPHER",
          "25: #  define EVP_CIPH_FLAG_AEAD_CIPHER       0x200000",
          "26: #  define EVP_CTRL_AEAD_TLS1_AAD          0x16",
          "27: #  define EVP_CTRL_AEAD_SET_MAC_KEY       0x17",
          "28: # endif",
          "31: # define EVP_RC4_KEY_SIZE                16",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "crypto/include/internal/evp_int.h||crypto/include/internal/evp_int.h": [
          "File: crypto/include/internal/evp_int.h -> crypto/include/internal/evp_int.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "380: void openssl_add_all_ciphers_int(void);",
          "381: void openssl_add_all_digests_int(void);",
          "382: void evp_cleanup_int(void);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "386: #define EVP_RC4_KEY_SIZE 16",
          "387: #ifndef TLS1_1_VERSION",
          "388: # define TLS1_1_VERSION   0x0302",
          "389: #endif",
          "",
          "---------------"
        ],
        "ssl/record/rec_layer_s3.c||ssl/record/rec_layer_s3.c": [
          "File: ssl/record/rec_layer_s3.c -> ssl/record/rec_layer_s3.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: #include <openssl/rand.h>",
          "18: #include \"record_locl.h\"",
          "24: #if     defined(OPENSSL_SMALL_FOOTPRINT) || \\",
          "25:         !(      defined(AES_ASM) &&     ( \\",
          "26:                 defined(__x86_64)       || defined(__x86_64__)  || \\",
          "",
          "[Removed Lines]",
          "20: #ifndef  EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK",
          "21: # define EVP_CIPH_FLAG_TLS1_1_MULTIBLOCK 0",
          "22: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "389d4655b143bc6d495ca6c48809aac8f4356e01",
      "candidate_info": {
        "commit_hash": "389d4655b143bc6d495ca6c48809aac8f4356e01",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/389d4655b143bc6d495ca6c48809aac8f4356e01",
        "files": [
          "test/build.info",
          "test/recipes/90-test_shlibload.t",
          "test/shlibloadtest.c"
        ],
        "message": "Add a test to dynamically load and unload the libraries\n\nThis should demonstrate that the atexit() handling is working properly (or\nat least not crashing) on process exit.\n\nReviewed-by: Tim Hudson <tjh@openssl.org>\n(cherry picked from commit b987d748e46d4ec19a45e5ec9e890a9003a361d6)",
        "before_after_code_files": [
          "test/build.info||test/build.info",
          "test/recipes/90-test_shlibload.t||test/recipes/90-test_shlibload.t",
          "test/shlibloadtest.c||test/shlibloadtest.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/build.info||test/build.info": [
          "File: test/build.info -> test/build.info",
          "--- Hunk 1 ---",
          "[Context before]",
          "274:   SOURCE[bio_enc_test]=bio_enc_test.c",
          "275:   INCLUDE[bio_enc_test]=../include",
          "276:   DEPEND[bio_enc_test]=../libcrypto",
          "277: ENDIF",
          "279: {-",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "278:   IF[{- !disabled{shared} -}]",
          "279:     PROGRAMS_NO_INST=shlibloadtest",
          "280:     SOURCE[shlibloadtest]=shlibloadtest.c",
          "281:     INCLUDE[shlibloadtest]=../include",
          "282:   ENDIF",
          "",
          "---------------"
        ],
        "test/recipes/90-test_shlibload.t||test/recipes/90-test_shlibload.t": [
          "File: test/recipes/90-test_shlibload.t -> test/recipes/90-test_shlibload.t",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: #! /usr/bin/env perl",
          "2: # Copyright 2016 The OpenSSL Project Authors. All Rights Reserved.",
          "3: #",
          "4: # Licensed under the OpenSSL license (the \"License\").  You may not use",
          "5: # this file except in compliance with the License.  You can obtain a copy",
          "6: # in the file LICENSE in the source distribution or at",
          "7: # https://www.openssl.org/source/license.html",
          "10: use OpenSSL::Test qw/:DEFAULT bldtop_dir/;",
          "11: use OpenSSL::Test::Utils;",
          "13: #Load configdata.pm",
          "15: BEGIN {",
          "16:     setup(\"test_shlibload\");",
          "17: }",
          "18: use lib bldtop_dir('.');",
          "19: use configdata;",
          "21: plan skip_all => \"Test only supported in a shared build\" if disabled(\"shared\");",
          "23: plan tests => 3;",
          "25: ok(run(test([\"shlibloadtest\", \"-crypto_first\",",
          "26:              $unified_info{sharednames}->{libcrypto},",
          "27:              $unified_info{sharednames}->{libssl}])),",
          "28:    \"running shlibloadtest -crypto_first\");",
          "29: ok(run(test([\"shlibloadtest\", \"-ssl_first\",",
          "30:              $unified_info{sharednames}->{libcrypto},",
          "31:              $unified_info{sharednames}->{libssl}])),",
          "32:    \"running shlibloadtest -ssl_first\");",
          "33: ok(run(test([\"shlibloadtest\", \"-just_crypto\",",
          "34:              $unified_info{sharednames}->{libcrypto},",
          "35:              $unified_info{sharednames}->{libssl}])),",
          "36:    \"running shlibloadtest -just_crypto\");",
          "",
          "---------------"
        ],
        "test/shlibloadtest.c||test/shlibloadtest.c": [
          "File: test/shlibloadtest.c -> test/shlibloadtest.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "10: #include <stdio.h>",
          "11: #include <string.h>",
          "12: #include <stdlib.h>",
          "13: #include <openssl/opensslv.h>",
          "15: #define SSL_CTX_NEW \"SSL_CTX_new\"",
          "16: #define SSL_CTX_FREE \"SSL_CTX_free\"",
          "17: #define TLS_METHOD \"TLS_method\"",
          "19: #define ERR_GET_ERROR \"ERR_get_error\"",
          "20: #define OPENSSL_VERSION_NUM_FUNC \"OpenSSL_version_num\"",
          "22: typedef struct ssl_ctx_st SSL_CTX;",
          "23: typedef struct ssl_method_st SSL_METHOD;",
          "24: typedef const SSL_METHOD * (*TLS_method_t)(void);",
          "25: typedef SSL_CTX * (*SSL_CTX_new_t)(const SSL_METHOD *meth);",
          "26: typedef void (*SSL_CTX_free_t)(SSL_CTX *);",
          "28: typedef unsigned long (*ERR_get_error_t)(void);",
          "29: typedef unsigned long (*OpenSSL_version_num_t)(void);",
          "31: TLS_method_t TLS_method;",
          "32: SSL_CTX_new_t SSL_CTX_new;",
          "33: SSL_CTX_free_t SSL_CTX_free;",
          "35: ERR_get_error_t ERR_get_error;",
          "36: OpenSSL_version_num_t OpenSSL_version_num;",
          "39: #ifdef DSO_DLFCN",
          "41: # include <dlfcn.h>",
          "43: typedef void * SHLIB;",
          "44: typedef void * SHLIB_SYM;",
          "46: # define SHARED_LIBRARY_SUFFIX \".so\"",
          "48: static int shlib_load(char *filename, SHLIB *lib)",
          "49: {",
          "50:     char *tmpfile;",
          "51:     size_t filenamelen = strlen(filename);",
          "54:     tmpfile = malloc(filenamelen + sizeof(SHARED_LIBRARY_SUFFIX) + 1);",
          "55:     if (tmpfile == NULL)",
          "56:         return 0;",
          "57:     strcpy(tmpfile, filename);",
          "58:     strcpy(tmpfile + filenamelen, SHARED_LIBRARY_SUFFIX);",
          "61:     free(tmpfile);",
          "63:     if (*lib == NULL)",
          "64:         return 0;",
          "66:     return 1;",
          "67: }",
          "69: static int shlib_sym(SHLIB lib, const char *symname, SHLIB_SYM *sym)",
          "70: {",
          "73:     return *sym != NULL;",
          "74: }",
          "76: static int shlib_close(SHLIB lib)",
          "77: {",
          "78:     if (dlclose(lib) != 0)",
          "79:         return 0;",
          "81:     return 1;",
          "82: }",
          "84: #elif defined(DSO_WIN32)",
          "86: # include <windows.h>",
          "88: typedef HINSTANCE SHLIB;",
          "89: typedef void * SHLIB_SYM;",
          "91: static int shlib_load(char *filename, SHLIB *lib)",
          "92: {",
          "94:     if (*lib == NULL)",
          "95:         return 0;",
          "97:     return 1;",
          "98: }",
          "100: static int shlib_sym(SHLIB lib, const char *symname, SHLIB_SYM *sym)",
          "101: {",
          "104:     return *sym != NULL;",
          "105: }",
          "107: static int shlib_close(SHLIB lib)",
          "108: {",
          "109:     if (FreeLibrary(lib) == 0)",
          "110:         return 0;",
          "112:     return 1;",
          "113: }",
          "115: #endif",
          "118: #if defined(DSO_DLFCN) || defined(DSO_WIN32)",
          "120: # define CRYPTO_FIRST_OPT    \"-crypto_first\"",
          "121: # define SSL_FIRST_OPT       \"-ssl_first\"",
          "122: # define JUST_CRYPTO_OPT     \"-just_crypto\"",
          "124: enum test_types_en {",
          "125:     CRYPTO_FIRST,",
          "126:     SSL_FIRST,",
          "127:     JUST_CRYPTO",
          "128: };",
          "130: int main(int argc, char **argv)",
          "131: {",
          "132:     SHLIB ssllib, cryptolib;",
          "133:     SSL_CTX *ctx;",
          "134:     union {",
          "135:         void (*func) (void);",
          "136:         SHLIB_SYM sym;",
          "137:     } tls_method_sym, ssl_ctx_new_sym, ssl_ctx_free_sym, err_get_error_sym,",
          "138:     openssl_version_num_sym;",
          "139:     enum test_types_en test_type;",
          "140:     int i;",
          "142:     if (argc != 4) {",
          "143:         printf(\"Unexpected number of arguments\\n\");",
          "144:         return 1;",
          "145:     }",
          "147:     if (strcmp(argv[1], CRYPTO_FIRST_OPT) == 0) {",
          "148:         test_type = CRYPTO_FIRST;",
          "149:     } else if (strcmp(argv[1], SSL_FIRST_OPT) == 0) {",
          "150:             test_type = SSL_FIRST;",
          "151:     } else if (strcmp(argv[1], JUST_CRYPTO_OPT) == 0) {",
          "152:             test_type = JUST_CRYPTO;",
          "153:     } else {",
          "154:         printf(\"Unrecognised argument\\n\");",
          "155:         return 1;",
          "156:     }",
          "158:     for (i = 0; i < 2; i++) {",
          "159:         if ((i == 0 && (test_type == CRYPTO_FIRST",
          "160:                        || test_type == JUST_CRYPTO))",
          "161:                || (i == 1 && test_type == SSL_FIRST)) {",
          "162:             if (!shlib_load(argv[2], &cryptolib)) {",
          "163:                 printf(\"Unable to load libcrypto\\n\");",
          "164:                 return 1;",
          "165:             }",
          "166:         }",
          "167:         if ((i == 0 && test_type == SSL_FIRST)",
          "168:                 || (i == 1 && test_type == CRYPTO_FIRST)) {",
          "169:             if (!shlib_load(argv[3], &ssllib)) {",
          "170:                 printf(\"Unable to load libssl\\n\");",
          "171:                 return 1;",
          "172:             }",
          "173:         }",
          "174:     }",
          "176:     if (test_type != JUST_CRYPTO) {",
          "177:         if (!shlib_sym(ssllib, TLS_METHOD, &tls_method_sym.sym)",
          "178:                 || !shlib_sym(ssllib, SSL_CTX_NEW, &ssl_ctx_new_sym.sym)",
          "179:                 || !shlib_sym(ssllib, SSL_CTX_FREE, &ssl_ctx_free_sym.sym)) {",
          "180:             printf(\"Unable to load ssl symbols\\n\");",
          "181:             return 1;",
          "182:         }",
          "184:         TLS_method = (TLS_method_t)tls_method_sym.func;",
          "185:         SSL_CTX_new = (SSL_CTX_new_t)ssl_ctx_new_sym.func;",
          "186:         SSL_CTX_free = (SSL_CTX_free_t)ssl_ctx_free_sym.func;",
          "188:         ctx = SSL_CTX_new(TLS_method());",
          "189:         if (ctx == NULL) {",
          "190:             printf(\"Unable to create SSL_CTX\\n\");",
          "191:             return 1;",
          "192:         }",
          "193:         SSL_CTX_free(ctx);",
          "194:     }",
          "196:     if (!shlib_sym(cryptolib, ERR_GET_ERROR, &err_get_error_sym.sym)",
          "197:             || !shlib_sym(cryptolib, OPENSSL_VERSION_NUM_FUNC,",
          "198:                           &openssl_version_num_sym.sym)) {",
          "199:         printf(\"Unable to load crypto symbols\\n\");",
          "200:         return 1;",
          "201:     }",
          "203:     ERR_get_error = (ERR_get_error_t)err_get_error_sym.func;",
          "204:     OpenSSL_version_num = (OpenSSL_version_num_t)openssl_version_num_sym.func;",
          "206:     if (ERR_get_error() != 0) {",
          "207:         printf(\"Unexpected error in error queue\\n\");",
          "208:         return 1;",
          "209:     }",
          "211:     if (OpenSSL_version_num() != OPENSSL_VERSION_NUMBER) {",
          "212:         printf(\"Unexpected library version loaded\\n\");",
          "213:         return 1;",
          "214:     }",
          "216:     for (i = 0; i < 2; i++) {",
          "217:         if ((i == 0 && test_type == CRYPTO_FIRST)",
          "218:                 || (i == 1 && test_type == SSL_FIRST)) {",
          "219:             if (!shlib_close(ssllib)) {",
          "220:                 printf(\"Unable to close libssl\\n\");",
          "221:                 return 1;",
          "222:             }",
          "223:         }",
          "224:         if ((i == 0 && (test_type == SSL_FIRST",
          "225:                        || test_type == JUST_CRYPTO))",
          "226:                 || (i == 1 && test_type == CRYPTO_FIRST)) {",
          "227:             if (!shlib_close(cryptolib)) {",
          "228:                 printf(\"Unable to close libcrypto\\n\");",
          "229:                 return 1;",
          "230:             }",
          "231:         }",
          "232:     }",
          "234:     printf(\"Success\\n\");",
          "235:     return 0;",
          "236: }",
          "237: #else",
          "238: int main(void)",
          "239: {",
          "240:     printf(\"Test not implemented on this platform\\n\");",
          "241:     return 0;",
          "242: }",
          "243: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8e4d861c81977db1a914513fc3c00474b897b13d",
      "candidate_info": {
        "commit_hash": "8e4d861c81977db1a914513fc3c00474b897b13d",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/8e4d861c81977db1a914513fc3c00474b897b13d",
        "files": [
          "crypto/x86_64cpuid.pl",
          "crypto/x86cpuid.pl"
        ],
        "message": "crypto/x86*cpuid.pl: move extended feature detection.\n\nExteneded feature flags were not pulled on AMD processors, as result\na number of extensions were effectively masked on Ryzen. Original fix\nfor x86_64cpuid.pl addressed this problem, but messed up processor\nvendor detection. This fix moves extended feature detection past\nbasic feature detection where it belongs. 32-bit counterpart is\nharmonized too.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(cherry picked from commit 1aed5e1ac28790cc915ad03e86e2d5e896a4ea13)",
        "before_after_code_files": [
          "crypto/x86_64cpuid.pl||crypto/x86_64cpuid.pl",
          "crypto/x86cpuid.pl||crypto/x86cpuid.pl"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/x86_64cpuid.pl||crypto/x86_64cpuid.pl": [
          "File: crypto/x86_64cpuid.pl -> crypto/x86_64cpuid.pl",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:  mov %rbx,%r8  # save %rbx",
          "68:  xor %eax,%eax",
          "70:  cpuid",
          "71:  mov %eax,%r11d  # max value for standard query level",
          "83:  xor %eax,%eax",
          "84:  cmp \\$0x756e6547,%ebx # \"Genu\"",
          "85:  setne %al",
          "",
          "[Removed Lines]",
          "69:  mov %eax,8(%rdi)  # clear 3rd word",
          "73:  cmp \\$7,%eax",
          "74:  jb .Lno_extended_info",
          "76:  mov \\$7,%eax",
          "77:  xor %ecx,%ecx",
          "78:  cpuid",
          "79:  mov %ebx,8(%rdi)",
          "81: .Lno_extended_info:",
          "",
          "[Added Lines]",
          "69:  mov %eax,8(%rdi)  # clear extended feature flags",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "173:  or %ecx,%r9d  # merge AMD XOP flag",
          "175:  mov %edx,%r10d  # %r9d:%r10d is copy of %ecx:%edx",
          "176:  bt \\$27,%r9d  # check OSXSAVE bit",
          "177:  jnc .Lclear_avx",
          "178:  xor %ecx,%ecx  # XCR0",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:  cmp \\$7,%r11d",
          "168:  jb .Lno_extended_info",
          "169:  mov \\$7,%eax",
          "170:  xor %ecx,%ecx",
          "171:  cpuid",
          "172:  mov %ebx,8(%rdi)  # save extended feature flags",
          "173: .Lno_extended_info:",
          "",
          "---------------"
        ],
        "crypto/x86cpuid.pl||crypto/x86cpuid.pl": [
          "File: crypto/x86cpuid.pl -> crypto/x86cpuid.pl",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:  &pop (\"eax\");",
          "31:  &xor (\"ecx\",\"eax\");",
          "32:  &xor (\"eax\",\"eax\");",
          "33:  &bt (\"ecx\",21);",
          "34:  &jnc (&label(\"nocpuid\"));",
          "37:  &cpuid ();",
          "38:  &mov (\"edi\",\"eax\");  # max value for standard query level",
          "",
          "[Removed Lines]",
          "35:  &mov (\"esi\",&wparam(0));",
          "36:  &mov (&DWP(8,\"esi\"),\"eax\"); # clear 3rd word",
          "",
          "[Added Lines]",
          "33:  &mov (\"esi\",&wparam(0));",
          "34:  &mov (&DWP(8,\"esi\"),\"eax\"); # clear extended feature flags",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "91:  &jmp (&label(\"generic\"));",
          "93: &set_label(\"intel\");",
          "104:  &cmp (\"edi\",4);",
          "106:  &jb (&label(\"nocacheinfo\"));",
          "108:  &mov (\"eax\",4);",
          "109:  &mov (\"ecx\",0);  # query L1D",
          "110:  &cpuid ();",
          "115: &set_label(\"nocacheinfo\");",
          "116:  &mov (\"eax\",1);",
          "",
          "[Removed Lines]",
          "94:  &cmp (\"edi\",7);",
          "95:  &jb (&label(\"cacheinfo\"));",
          "97:  &mov (\"esi\",&wparam(0));",
          "98:  &mov (\"eax\",7);",
          "99:  &xor (\"ecx\",\"ecx\");",
          "100:  &cpuid ();",
          "101:  &mov (&DWP(8,\"esi\"),\"ebx\");",
          "103: &set_label(\"cacheinfo\");",
          "105:  &mov (\"edi\",-1);",
          "111:  &mov (\"edi\",\"eax\");",
          "112:  &shr (\"edi\",14);",
          "113:  &and (\"edi\",0xfff);  # number of cores -1 per L1D",
          "",
          "[Added Lines]",
          "95:  &mov (\"esi\",-1);",
          "101:  &mov (\"esi\",\"eax\");",
          "102:  &shr (\"esi\",14);",
          "103:  &and (\"esi\",0xfff);  # number of cores -1 per L1D",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "128:  &bt (\"edx\",28);  # test hyper-threading bit",
          "129:  &jnc (&label(\"generic\"));",
          "130:  &and (\"edx\",0xefffffff);",
          "132:  &je (&label(\"generic\"));",
          "134:  &or (\"edx\",0x10000000);",
          "",
          "[Removed Lines]",
          "131:  &cmp (\"edi\",0);",
          "",
          "[Added Lines]",
          "121:  &cmp (\"esi\",0);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "140: &set_label(\"generic\");",
          "141:  &and (\"ebp\",1<<11);  # isolate AMD XOP flag",
          "142:  &and (\"ecx\",0xfffff7ff); # force 11th bit to 0",
          "144:  &or (\"ebp\",\"ecx\");  # merge AMD XOP flag",
          "147:  &jnc (&label(\"clear_avx\"));",
          "148:  &xor (\"ecx\",\"ecx\");",
          "149:  &data_byte(0x0f,0x01,0xd0); # xgetbv",
          "",
          "[Removed Lines]",
          "143:  &mov (\"esi\",\"edx\");",
          "146:  &bt (\"ecx\",27);  # check OSXSAVE bit",
          "",
          "[Added Lines]",
          "133:  &mov (\"esi\",\"edx\");  # %ebp:%esi is copy of %ecx:%edx",
          "136:  &cmp (\"edi\",7);",
          "137:  &mov (\"edi\",&wparam(0));",
          "138:  &jb (&label(\"no_extended_info\"));",
          "139:  &mov (\"eax\",7);",
          "140:  &xor (\"ecx\",\"ecx\");",
          "141:  &cpuid ();",
          "142:  &mov (&DWP(8,\"edi\"),\"ebx\"); # save extended feature flag",
          "143: &set_label(\"no_extended_info\");",
          "145:  &bt (\"ebp\",27);  # check OSXSAVE bit",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "157:  &and (\"esi\",0xfeffffff); # clear FXSR",
          "158: &set_label(\"clear_avx\");",
          "159:  &and (\"ebp\",0xefffe7ff); # clear AVX, FMA and AMD XOP bits",
          "161:  &and (&DWP(8,\"edi\"),0xffffffdf); # clear AVX2",
          "162: &set_label(\"done\");",
          "163:  &mov (\"eax\",\"esi\");",
          "",
          "[Removed Lines]",
          "160:  &mov (\"edi\",&wparam(0));",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "45789c2819e1cb93150061ddaa95fe97da2c0cba",
      "candidate_info": {
        "commit_hash": "45789c2819e1cb93150061ddaa95fe97da2c0cba",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/45789c2819e1cb93150061ddaa95fe97da2c0cba",
        "files": [
          "apps/ca.c"
        ],
        "message": "Fix use before assignment\n\n it was getting the SerialNumber of a previous cert.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Matt Caswell <matt@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2272)\n(cherry picked from commit 0db1fb3fc13c4b1a2b916efbb374f40579b1398f)",
        "before_after_code_files": [
          "apps/ca.c||apps/ca.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "apps/ca.c||apps/ca.c": [
          "File: apps/ca.c -> apps/ca.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "983:             BIO_printf(bio_err, \"writing new certificates\\n\");",
          "984:         for (i = 0; i < sk_X509_num(cert_sk); i++) {",
          "985:             BIO *Cout = NULL;",
          "987:             int k;",
          "988:             char *n;",
          "992:             j = ASN1_STRING_length(serialNumber);",
          "993:             p = (const char *)ASN1_STRING_get0_data(serialNumber);",
          "",
          "[Removed Lines]",
          "986:             ASN1_INTEGER *serialNumber = X509_get_serialNumber(x);",
          "990:             x = sk_X509_value(cert_sk, i);",
          "",
          "[Added Lines]",
          "986:             X509 *xi = sk_X509_value(cert_sk, i);",
          "987:             ASN1_INTEGER *serialNumber = X509_get_serialNumber(xi);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1030:                 perror(buf[2]);",
          "1031:                 goto end;",
          "1032:             }",
          "1035:             BIO_free_all(Cout);",
          "1036:         }",
          "",
          "[Removed Lines]",
          "1033:             write_new_certificate(Cout, x, 0, notext);",
          "1034:             write_new_certificate(Sout, x, output_der, notext);",
          "",
          "[Added Lines]",
          "1032:             write_new_certificate(Cout, xi, 0, notext);",
          "1033:             write_new_certificate(Sout, xi, output_der, notext);",
          "",
          "---------------"
        ]
      }
    }
  ]
}