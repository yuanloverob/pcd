{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "647ca2f679ae4d91ea840a50a388404bc41647a1",
      "candidate_info": {
        "commit_hash": "647ca2f679ae4d91ea840a50a388404bc41647a1",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/647ca2f679ae4d91ea840a50a388404bc41647a1",
        "files": [
          "arch/X86/X86MappingInsnOp.inc",
          "arch/X86/X86MappingInsnOp_reduce.inc"
        ],
        "message": "Changed X86_INS_POP flags",
        "before_after_code_files": [
          "arch/X86/X86MappingInsnOp.inc||arch/X86/X86MappingInsnOp.inc",
          "arch/X86/X86MappingInsnOp_reduce.inc||arch/X86/X86MappingInsnOp_reduce.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86MappingInsnOp.inc||arch/X86/X86MappingInsnOp.inc": [
          "File: arch/X86/X86MappingInsnOp.inc -> arch/X86/X86MappingInsnOp.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "7803: },",
          "7805:  0,",
          "7807: },",
          "7809:  0,",
          "",
          "[Removed Lines]",
          "7806:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "7806:  { CS_AC_WRITE, 0 }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "7815: },",
          "7817:  0,",
          "7819: },",
          "7821:  0,",
          "",
          "[Removed Lines]",
          "7818:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "7818:  { CS_AC_WRITE, 0 }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "7827: },",
          "7829:  0,",
          "7831: },",
          "7833:  0,",
          "",
          "[Removed Lines]",
          "7830:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "7830:  { CS_AC_WRITE, 0 }",
          "",
          "---------------"
        ],
        "arch/X86/X86MappingInsnOp_reduce.inc||arch/X86/X86MappingInsnOp_reduce.inc": [
          "File: arch/X86/X86MappingInsnOp_reduce.inc -> arch/X86/X86MappingInsnOp_reduce.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "3771: },",
          "3773:  0,",
          "3775: },",
          "3777:  0,",
          "",
          "[Removed Lines]",
          "3774:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "3774:  { CS_AC_WRITE, 0 }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3783: },",
          "3785:  0,",
          "3787: },",
          "3789:  0,",
          "",
          "[Removed Lines]",
          "3786:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "3786:  { CS_AC_WRITE, 0 }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3795: },",
          "3797:  0,",
          "3799: },",
          "3801:  0,",
          "",
          "[Removed Lines]",
          "3798:  { CS_AC_READ, 0 }",
          "",
          "[Added Lines]",
          "3798:  { CS_AC_WRITE, 0 }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4582a67b85b2cc1936305fdf1562250bef0c4ffc",
      "candidate_info": {
        "commit_hash": "4582a67b85b2cc1936305fdf1562250bef0c4ffc",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4582a67b85b2cc1936305fdf1562250bef0c4ffc",
        "files": [
          "arch/SystemZ/SystemZInstPrinter.c"
        ],
        "message": "systemz: fix #1062",
        "before_after_code_files": [
          "arch/SystemZ/SystemZInstPrinter.c||arch/SystemZ/SystemZInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/SystemZ/SystemZInstPrinter.c||arch/SystemZ/SystemZInstPrinter.c": [
          "File: arch/SystemZ/SystemZInstPrinter.c -> arch/SystemZ/SystemZInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "302:     SStream_concat(O, \"%u\", imm);",
          "303:   } else {",
          "304:    if (imm < -HEX_THRESHOLD)",
          "306:    else",
          "307:     SStream_concat(O, \"-%u\", -imm);",
          "308:   }",
          "",
          "[Removed Lines]",
          "305:     SStream_concat(O, \"-0x%x\", -imm);",
          "",
          "[Added Lines]",
          "305:     SStream_concat(O, \"-0x%x\", (unsigned int)-imm);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "003f50ee2d17ff7ef257cff28d047840ca5ed89a",
      "candidate_info": {
        "commit_hash": "003f50ee2d17ff7ef257cff28d047840ca5ed89a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/003f50ee2d17ff7ef257cff28d047840ca5ed89a",
        "files": [
          "bindings/python/setup.py",
          "bindings/python/setup_cython.py"
        ],
        "message": "python: version 4.0.0",
        "before_after_code_files": [
          "bindings/python/setup.py||bindings/python/setup.py",
          "bindings/python/setup_cython.py||bindings/python/setup_cython.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: from setuptools.command.bdist_egg import bdist_egg",
          "16: SYSTEM = sys.platform",
          "19: # adapted from commit e504b81 of Nguyen Tan Cong",
          "20: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "",
          "[Removed Lines]",
          "17: VERSION = '4.0'",
          "",
          "[Added Lines]",
          "17: VERSION = '4.0.0'",
          "",
          "---------------"
        ],
        "bindings/python/setup_cython.py||bindings/python/setup_cython.py": [
          "File: bindings/python/setup_cython.py -> bindings/python/setup_cython.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: from distutils.command.build import build",
          "9: from Cython.Distutils import build_ext",
          "12: SYSTEM = sys.platform",
          "14: # adapted from commit e504b81 of Nguyen Tan Cong",
          "15: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "",
          "[Removed Lines]",
          "11: VERSION = '4.0'",
          "",
          "[Added Lines]",
          "12: VERSION = '4.0.0'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e12e2de2cf9b0f5529ad91e9e4f1f13398d07f1a",
      "candidate_info": {
        "commit_hash": "e12e2de2cf9b0f5529ad91e9e4f1f13398d07f1a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/e12e2de2cf9b0f5529ad91e9e4f1f13398d07f1a",
        "files": [
          "cstool/cstool_x86.c"
        ],
        "message": "cstool: cs_op_count() can return -1. fix #978",
        "before_after_code_files": [
          "cstool/cstool_x86.c||cstool/cstool_x86.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool_x86.c||cstool/cstool_x86.c": [
          "File: cstool/cstool_x86.c -> cstool/cstool_x86.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "237:  count = cs_op_count(ud, ins, X86_OP_IMM);",
          "239:   printf(\"\\timm_count: %u\\n\", count);",
          "240:   for (i = 1; i < count + 1; i++) {",
          "241:    int index = cs_op_index(ud, ins, X86_OP_IMM, i);",
          "",
          "[Removed Lines]",
          "238:  if (count) {",
          "",
          "[Added Lines]",
          "238:  if (count > 0) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "53b8174c6a3c7fd92266ce45729975e76ed21d8a",
      "candidate_info": {
        "commit_hash": "53b8174c6a3c7fd92266ce45729975e76ed21d8a",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/53b8174c6a3c7fd92266ce45729975e76ed21d8a",
        "files": [
          "bindings/python/test_m68k.py",
          "tests/test_m68k.c"
        ],
        "message": "Further refinements to the tests + python test fix for M68K",
        "before_after_code_files": [
          "bindings/python/test_m68k.py||bindings/python/test_m68k.py",
          "tests/test_m68k.c||tests/test_m68k.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/test_m68k.py||bindings/python/test_m68k.py": [
          "File: bindings/python/test_m68k.py -> bindings/python/test_m68k.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "50:     for i, op in enumerate(insn.operands):",
          "51:         if op.type == M68K_OP_REG:",
          "52:             print(\"\\t\\toperands[%u].type: REG = %s\" % (i, insn.reg_name(op.reg)))",
          "63:             print(\"\\t\\toperands[%u].type: IMM = 0x%x\" % (i, op.imm & 0xffffffff))",
          "66:             print(\"\\t\\toperands[%u].type: MEM\" % (i))",
          "67:             if op.mem.base_reg != M68K_REG_INVALID:",
          "68:                 print(\"\\t\\t\\toperands[%u].mem.base: REG = %s\" % (i, insn.reg_name(op.mem.base_reg)))",
          "",
          "[Removed Lines]",
          "54:         if op.type == M68K_OP_IMM:",
          "55:             if insn.op_size.type == M68K_SIZE_TYPE_FPU:",
          "56:                 if insn.op_size.size == M68K_FPU_SIZE_SINGLE:",
          "57:                     print(\"\\t\\toperands[%u].type: IMM = %f\" % (i, op.simm))",
          "58:                 elif insn.op_size.size == M68K_FPU_SIZE_DOUBLE:",
          "59:                     print(\"\\t\\toperands[%u].type: IMM = %lf\" % (i, op.dimm))",
          "60:                 else:",
          "61:                     print(\"\\t\\toperands[%u].type: IMM = <unsupported>\" % (i))",
          "62:                 continue",
          "65:         if op.type == M68K_OP_MEM:",
          "",
          "[Added Lines]",
          "53:         elif op.type == M68K_OP_IMM:",
          "55:         elif op.type == M68K_OP_MEM:",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "77:             if op.mem.scale != 0:",
          "78:                 print(\"\\t\\t\\toperands[%u].mem.scale: %d\" % (i, op.mem.scale))",
          "79:             print(\"\\t\\taddress mode: %s\" % (s_addressing_modes[op.address_mode]))",
          "80:     print()",
          "82: # ## Test class Cs",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70:         elif op.type == M68K_OP_FP_SINGLE:",
          "71:             print(\"\\t\\toperands[%u].type: FP_SINGLE\" % i)",
          "72:             print(\"\\t\\\u0167\\toperands[%u].simm: %f\", i, op.simm)",
          "73:         elif op.type == M68K_OP_FP_DOUBLE:",
          "74:             print(\"\\t\\toperands[%u].type: FP_DOUBLE\" % i)",
          "75:             print(\"\\t\\\u0167\\toperands[%u].dimm: %lf\", i, op.dimm)",
          "",
          "---------------"
        ],
        "tests/test_m68k.c||tests/test_m68k.c": [
          "File: tests/test_m68k.c -> tests/test_m68k.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "85:     printf(\"\\t\\toperands[%u].type: REG = %s\\n\", i, cs_reg_name(handle, op->reg));",
          "86:     break;",
          "87:    case M68K_OP_IMM:",
          "98:     printf(\"\\t\\toperands[%u].type: IMM = 0x%x\\n\", i, (int)op->imm);",
          "99:     break;",
          "100:    case M68K_OP_MEM:",
          "",
          "[Removed Lines]",
          "88:     if (m68k->op_size.type == M68K_SIZE_TYPE_FPU) {",
          "89:      if (m68k->op_size.fpu_size == M68K_FPU_SIZE_SINGLE)",
          "90:       printf(\"\\t\\toperands[%u].type: IMM = %f\\n\", i, op->simm);",
          "91:      else if (m68k->op_size.fpu_size == M68K_FPU_SIZE_DOUBLE)",
          "92:       printf(\"\\t\\toperands[%u].type: IMM = %lf\\n\", i, op->dimm);",
          "93:      else",
          "94:       printf(\"\\t\\toperands[%u].type: IMM = <unsupported>\\n\", i);",
          "95:      break;",
          "96:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "119:     printf(\"\\t\\toperands[%u].type: FP_SINGLE\\n\", i);",
          "120:     printf(\"\\t\\t\\toperands[%u].simm: %f\\n\", i, op->simm);",
          "121:     break;",
          "122:   }",
          "123:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "112:    case M68K_OP_FP_DOUBLE:",
          "113:     printf(\"\\t\\toperands[%u].type: FP_DOUBLE\\n\", i);",
          "114:     printf(\"\\t\\t\\toperands[%u].dimm: %lf\\n\", i, op->dimm);",
          "115:     break;",
          "",
          "---------------"
        ]
      }
    }
  ]
}