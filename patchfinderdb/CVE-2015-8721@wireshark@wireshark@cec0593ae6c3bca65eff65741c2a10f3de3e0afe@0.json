{
  "cve_id": "CVE-2015-8721",
  "cve_desc": "Buffer overflow in the tvb_uncompress function in epan/tvbuff_zlib.c in Wireshark 1.12.x before 1.12.9 and 2.0.x before 2.0.1 allows remote attackers to cause a denial of service (application crash) via a crafted packet with zlib compression.",
  "repo": "wireshark/wireshark",
  "patch_hash": "cec0593ae6c3bca65eff65741c2a10f3de3e0afe",
  "patch_info": {
    "commit_hash": "cec0593ae6c3bca65eff65741c2a10f3de3e0afe",
    "repo": "wireshark/wireshark",
    "commit_url": "https://github.com/wireshark/wireshark/commit/cec0593ae6c3bca65eff65741c2a10f3de3e0afe",
    "files": [
      "epan/tvbuff_zlib.c"
    ],
    "message": "Fix buffer overrun in zlib decompression\n\nAfter updating next_in (to remove the gzip header), avail_in must also\nbe updated. Failing to do makes zlib read past the input buffer. In\ntheory this would resukt in a buffer overrun of at most double the input\nlength, in practice zlib returns as soon as the compression fails (after\nreading a few bytes).\n\nBug: 11548\nChange-Id: If71691a2846338f46d866964a77cc4e74a9b61dd\nReviewed-on: https://code.wireshark.org/review/12038\nPetri-Dish: Peter Wu <peter@lekensteyn.nl>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Peter Wu <peter@lekensteyn.nl>",
    "before_after_code_files": [
      "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
    ]
  },
  "patch_diff": {
    "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c": [
      "File: epan/tvbuff_zlib.c -> epan/tvbuff_zlib.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "246:    }",
      "252:    if (c - compr > comprlen) {",
      "253:     inflateEnd(strm);",
      "254:     g_free(strm);",
      "",
      "[Removed Lines]",
      "249:    inflateReset(strm);",
      "250:    next = c;",
      "251:    strm->next_in = next;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "256:     g_free(strmbuf);",
      "257:     return NULL;",
      "258:    }",
      "259:    comprlen -= (int) (c - compr);",
      "261:    inflateEnd(strm);",
      "262:    inflateInit2(strm, wbits);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "258:    next = c;",
      "260:    inflateReset(strm);",
      "261:    strm->next_in   = next;",
      "262:    strm->avail_in  = comprlen;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7ea63cf9fe49bd58c4507ff583aac17a549a9e87",
      "candidate_info": {
        "commit_hash": "7ea63cf9fe49bd58c4507ff583aac17a549a9e87",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/7ea63cf9fe49bd58c4507ff583aac17a549a9e87",
        "files": [
          "epan/tvbuff_zlib.c"
        ],
        "message": "Fix buffer overrun in zlib decompression\n\nAfter updating next_in (to remove the gzip header), avail_in must also\nbe updated. Failing to do makes zlib read past the input buffer. In\ntheory this would resukt in a buffer overrun of at most double the input\nlength, in practice zlib returns as soon as the compression fails (after\nreading a few bytes).\n\nBug: 11548\nChange-Id: If71691a2846338f46d866964a77cc4e74a9b61dd\nReviewed-on: https://code.wireshark.org/review/12038\nPetri-Dish: Peter Wu <peter@lekensteyn.nl>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Peter Wu <peter@lekensteyn.nl>\n(cherry picked from commit cec0593ae6c3bca65eff65741c2a10f3de3e0afe)\nReviewed-on: https://code.wireshark.org/review/12137",
        "before_after_code_files": [
          "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ],
          "candidate": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c": [
          "File: epan/tvbuff_zlib.c -> epan/tvbuff_zlib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "246:    }",
          "252:    if (c - compr > comprlen) {",
          "253:     inflateEnd(strm);",
          "254:     g_free(strm);",
          "",
          "[Removed Lines]",
          "249:    inflateReset(strm);",
          "250:    next = c;",
          "251:    strm->next_in = next;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "256:     g_free(strmbuf);",
          "257:     return NULL;",
          "258:    }",
          "259:    comprlen -= (int) (c - compr);",
          "261:    inflateEnd(strm);",
          "262:    inflateInit2(strm, wbits);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "258:    next = c;",
          "260:    inflateReset(strm);",
          "261:    strm->next_in   = next;",
          "262:    strm->avail_in  = comprlen;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ceee21db98c76c602f17b154beb09e8f4966bd66",
      "candidate_info": {
        "commit_hash": "ceee21db98c76c602f17b154beb09e8f4966bd66",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/ceee21db98c76c602f17b154beb09e8f4966bd66",
        "files": [
          "epan/tvbuff.c"
        ],
        "message": "Fix buffer overrun in zlib decompression\n\nAfter updating next_in (to remove the gzip header), avail_in must also\nbe updated. Failing to do makes zlib read past the input buffer. In\ntheory this would resukt in a buffer overrun of at most double the input\nlength, in practice zlib returns as soon as the compression fails (after\nreading a few bytes).\n\nConflicts:\n\tepan/tvbuff_zlib.c\n\nBug: 11548\nChange-Id: If71691a2846338f46d866964a77cc4e74a9b61dd\nReviewed-on: https://code.wireshark.org/review/12038\nPetri-Dish: Peter Wu <peter@lekensteyn.nl>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Peter Wu <peter@lekensteyn.nl>\n(cherry picked from commit cec0593ae6c3bca65eff65741c2a10f3de3e0afe)\nReviewed-on: https://code.wireshark.org/review/12138\n(cherry picked from commit ff0220fda472b0b08796dbd8aa4c22dd665d9223)\nReviewed-on: https://code.wireshark.org/review/13759\nReviewed-by: Balint Reczey <balint@balintreczey.hu>\nReviewed-on: https://code.wireshark.org/review/14249",
        "before_after_code_files": [
          "epan/tvbuff.c||epan/tvbuff.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "epan/tvbuff.c||epan/tvbuff.c": [
          "File: epan/tvbuff.c -> epan/tvbuff.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3522:    }",
          "3528:    if (c - compr > comprlen) {",
          "3529:     inflateEnd(strm);",
          "3530:     g_free(strm);",
          "",
          "[Removed Lines]",
          "3525:    inflateReset(strm);",
          "3526:    next = c;",
          "3527:    strm->next_in = next;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3533:     return NULL;",
          "3534:    }",
          "3535:    comprlen -= (int) (c - compr);",
          "3537:    inflateEnd(strm);",
          "3538:    inflateInit2(strm, wbits);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3533:    next = c;",
          "3535:    inflateReset(strm);",
          "3536:    strm->next_in   = next;",
          "3537:    strm->avail_in  = comprlen;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3d2e2a209cf34108ca71c6be576bebeea1f9570d",
      "candidate_info": {
        "commit_hash": "3d2e2a209cf34108ca71c6be576bebeea1f9570d",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/3d2e2a209cf34108ca71c6be576bebeea1f9570d",
        "files": [
          "epan/tvbuff_zlib.c"
        ],
        "message": "Fix buffer overrun in zlib decompression\n\nAfter updating next_in (to remove the gzip header), avail_in must also\nbe updated. Failing to do makes zlib read past the input buffer. In\ntheory this would resukt in a buffer overrun of at most double the input\nlength, in practice zlib returns as soon as the compression fails (after\nreading a few bytes).\n\nBug: 11548\nChange-Id: If71691a2846338f46d866964a77cc4e74a9b61dd\nReviewed-on: https://code.wireshark.org/review/12038\nPetri-Dish: Peter Wu <peter@lekensteyn.nl>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Peter Wu <peter@lekensteyn.nl>\n(cherry picked from commit cec0593ae6c3bca65eff65741c2a10f3de3e0afe)\nReviewed-on: https://code.wireshark.org/review/12138\n(cherry picked from commit ff0220fda472b0b08796dbd8aa4c22dd665d9223)\nReviewed-on: https://code.wireshark.org/review/13759\nReviewed-by: Balint Reczey <balint@balintreczey.hu>",
        "before_after_code_files": [
          "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ],
          "candidate": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c": [
          "File: epan/tvbuff_zlib.c -> epan/tvbuff_zlib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "228:    }",
          "234:    if (c - compr > comprlen) {",
          "235:     inflateEnd(strm);",
          "236:     g_free(strm);",
          "",
          "[Removed Lines]",
          "231:    inflateReset(strm);",
          "232:    next = c;",
          "233:    strm->next_in = next;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "238:     g_free(strmbuf);",
          "239:     return NULL;",
          "240:    }",
          "241:    comprlen -= (int) (c - compr);",
          "243:    inflateEnd(strm);",
          "244:    inflateInit2(strm, wbits);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "240:    next = c;",
          "242:    inflateReset(strm);",
          "243:    strm->next_in   = next;",
          "244:    strm->avail_in  = comprlen;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ff0220fda472b0b08796dbd8aa4c22dd665d9223",
      "candidate_info": {
        "commit_hash": "ff0220fda472b0b08796dbd8aa4c22dd665d9223",
        "repo": "wireshark/wireshark",
        "commit_url": "https://github.com/wireshark/wireshark/commit/ff0220fda472b0b08796dbd8aa4c22dd665d9223",
        "files": [
          "epan/tvbuff_zlib.c"
        ],
        "message": "Fix buffer overrun in zlib decompression\n\nAfter updating next_in (to remove the gzip header), avail_in must also\nbe updated. Failing to do makes zlib read past the input buffer. In\ntheory this would resukt in a buffer overrun of at most double the input\nlength, in practice zlib returns as soon as the compression fails (after\nreading a few bytes).\n\nBug: 11548\nChange-Id: If71691a2846338f46d866964a77cc4e74a9b61dd\nReviewed-on: https://code.wireshark.org/review/12038\nPetri-Dish: Peter Wu <peter@lekensteyn.nl>\nTested-by: Petri Dish Buildbot <buildbot-no-reply@wireshark.org>\nReviewed-by: Peter Wu <peter@lekensteyn.nl>\n(cherry picked from commit cec0593ae6c3bca65eff65741c2a10f3de3e0afe)\nReviewed-on: https://code.wireshark.org/review/12138",
        "before_after_code_files": [
          "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ],
          "candidate": [
            "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c"
          ]
        }
      },
      "candidate_diff": {
        "epan/tvbuff_zlib.c||epan/tvbuff_zlib.c": [
          "File: epan/tvbuff_zlib.c -> epan/tvbuff_zlib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "228:    }",
          "234:    if (c - compr > comprlen) {",
          "235:     inflateEnd(strm);",
          "236:     g_free(strm);",
          "",
          "[Removed Lines]",
          "231:    inflateReset(strm);",
          "232:    next = c;",
          "233:    strm->next_in = next;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "238:     g_free(strmbuf);",
          "239:     return NULL;",
          "240:    }",
          "241:    comprlen -= (int) (c - compr);",
          "243:    inflateEnd(strm);",
          "244:    inflateInit2(strm, wbits);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "240:    next = c;",
          "242:    inflateReset(strm);",
          "243:    strm->next_in   = next;",
          "244:    strm->avail_in  = comprlen;",
          "",
          "---------------"
        ]
      }
    }
  ]
}