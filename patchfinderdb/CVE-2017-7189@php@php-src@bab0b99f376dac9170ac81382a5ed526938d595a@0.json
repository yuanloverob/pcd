{
  "cve_id": "CVE-2017-7189",
  "cve_desc": "main/streams/xp_socket.c in PHP 7.x before 2017-03-07 misparses fsockopen calls, such as by interpreting fsockopen('127.0.0.1:80', 443) as if the address/port were 127.0.0.1:80:443, which is later truncated to 127.0.0.1:80. This behavior has a security risk if the explicitly provided port number (i.e., 443 in this example) is hardcoded into an application as a security policy, but the hostname argument (i.e., 127.0.0.1:80 in this example) is obtained from untrusted input.",
  "repo": "php/php-src",
  "patch_hash": "bab0b99f376dac9170ac81382a5ed526938d595a",
  "patch_info": {
    "commit_hash": "bab0b99f376dac9170ac81382a5ed526938d595a",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/bab0b99f376dac9170ac81382a5ed526938d595a",
    "files": [
      "ext/standard/tests/streams/parseip-001.phpt",
      "main/streams/xp_socket.c"
    ],
    "message": "Detect invalid port in xp_socket parse ip address\n\nFor historical reasons, fsockopen() accepts the port and hostname\nseparately: fsockopen('127.0.0.1', 80)\n\nHowever, with the introdcution of stream transports in PHP 4.3,\nit became possible to include the port in the hostname specifier:\n\nfsockopen('127.0.0.1:80')\nOr more formally: fsockopen('tcp://127.0.0.1:80')\n\nConfusing results when these two forms are combined, however.\nfsockopen('127.0.0.1:80', 443) results in fsockopen() attempting\nto connect to '127.0.0.1:80:443' which any reasonable stack would\nconsider invalid.\n\nUnfortunately, PHP parses the address looking for the first colon\n(with special handling for IPv6, don't worry) and calls atoi()\nfrom there.  atoi() in turn, simply stops parsing at the first\nnon-numeric character and returns the value so far.\n\nThe end result is that the explicitly supplied port is treated\nas ignored garbage, rather than producing an error.\n\nThis diff replaces atoi() with strtol() and inspects the\nstop character.  If additional \"garbage\" of any kind is found,\nit fails and returns an error.",
    "before_after_code_files": [
      "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
      "main/streams/xp_socket.c||main/streams/xp_socket.c"
    ]
  },
  "patch_diff": {
    "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt": [
      "File: ext/standard/tests/streams/parseip-001.phpt -> ext/standard/tests/streams/parseip-001.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Use of double-port in fsockopen()",
      "3: --FILE--",
      "4: <?php",
      "6: $try = [",
      "7:   '127.0.0.1:80',",
      "8:   'tcp://127.0.0.1:80',",
      "9:   '[::1]:80',",
      "10:   'tcp://[::1]:80',",
      "11:   'localhost:80',",
      "12:   'tcp://localhost:80',",
      "13: ];",
      "15: foreach ($try as $addr) {",
      "16:   echo \"== $addr ==\\n\";",
      "17:   var_dump(@fsockopen($addr, 81, $errno, $errstr), $errstr);",
      "18: }",
      "19: --EXPECTF--",
      "20: == 127.0.0.1:80 ==",
      "21: bool(false)",
      "22: string(41) \"Failed to parse address \"127.0.0.1:80:81\"\"",
      "23: == tcp://127.0.0.1:80 ==",
      "24: bool(false)",
      "25: string(41) \"Failed to parse address \"127.0.0.1:80:81\"\"",
      "26: == [::1]:80 ==",
      "27: bool(false)",
      "28: string(37) \"Failed to parse address \"[::1]:80:81\"\"",
      "29: == tcp://[::1]:80 ==",
      "30: bool(false)",
      "31: string(37) \"Failed to parse address \"[::1]:80:81\"\"",
      "32: == localhost:80 ==",
      "33: bool(false)",
      "34: string(41) \"Failed to parse address \"localhost:80:81\"\"",
      "35: == tcp://localhost:80 ==",
      "36: bool(false)",
      "37: string(41) \"Failed to parse address \"localhost:80:81\"\"",
      "",
      "---------------"
    ],
    "main/streams/xp_socket.c||main/streams/xp_socket.c": [
      "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "571:  char *host = NULL;",
      "573: #ifdef HAVE_IPV6",
      "576:  if (*(str) == '[' && str_len > 1) {",
      "579:   if (!p || *(p + 1) != ':') {",
      "580:    if (get_err) {",
      "582:    }",
      "583:    return NULL;",
      "584:   }",
      "586:   return estrndup(str + 1, p - str - 1);",
      "587:  }",
      "588: #endif",
      "589:  if (str_len) {",
      "590:   colon = memchr(str, ':', str_len - 1);",
      "591:  } else {",
      "592:   colon = NULL;",
      "593:  }",
      "594:  if (colon) {",
      "600:   }",
      "602:  }",
      "605: }",
      "607: static inline char *parse_ip_address(php_stream_xport_param *xparam, int *portno)",
      "",
      "[Removed Lines]",
      "574:  char *p;",
      "578:   p = memchr(str + 1, ']', str_len - 2);",
      "596:   host = estrndup(str, colon - str);",
      "597:  } else {",
      "598:   if (get_err) {",
      "601:   return NULL;",
      "604:  return host;",
      "",
      "[Added Lines]",
      "576:   char *p = memchr(str + 1, ']', str_len - 2), *e = NULL;",
      "584:   if (e && *e) {",
      "585:    if (get_err) {",
      "587:    }",
      "588:    return NULL;",
      "589:   }",
      "601:   char *e = NULL;",
      "603:   if (!e || !*e) {",
      "604:    return estrndup(str, colon - str);",
      "608:  if (get_err) {",
      "610:  }",
      "611:  return NULL;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bf3e2dce7b54988d82f16ee3564c14f1b5cd936b",
      "candidate_info": {
        "commit_hash": "bf3e2dce7b54988d82f16ee3564c14f1b5cd936b",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/bf3e2dce7b54988d82f16ee3564c14f1b5cd936b",
        "files": [
          "main/streams/xp_socket.c"
        ],
        "message": "Revert \"Follow up patch regarding bug #74216, see bug #74429\"\n\nThis reverts commit cda7dcf4cacef3346f9dc2a4dc947e6a74769259.",
        "before_after_code_files": [
          "main/streams/xp_socket.c||main/streams/xp_socket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ],
          "candidate": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ]
        }
      },
      "candidate_diff": {
        "main/streams/xp_socket.c||main/streams/xp_socket.c": [
          "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "581:    return NULL;",
          "582:   }",
          "585:    if (get_err) {",
          "587:    }",
          "",
          "[Removed Lines]",
          "584:   if (e && *e && *e != '/') {",
          "",
          "[Added Lines]",
          "584:   if (e && *e) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "600:  if (colon) {",
          "601:   char *e = NULL;",
          "604:    return estrndup(str, colon - str);",
          "605:   }",
          "606:  }",
          "",
          "[Removed Lines]",
          "603:   if (!e || !*e || *e == '/') {",
          "",
          "[Added Lines]",
          "603:   if (!e || !*e) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c070353420e5fd880f79dc2d7121765d15f41e29",
      "candidate_info": {
        "commit_hash": "c070353420e5fd880f79dc2d7121765d15f41e29",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/c070353420e5fd880f79dc2d7121765d15f41e29",
        "files": [
          "main/streams/xp_socket.c"
        ],
        "message": "Revert \"Follow up patch regarding bug #74216, see bug #74429\"\n\nThis reverts commit cda7dcf4cacef3346f9dc2a4dc947e6a74769259.\n\n(cherry picked from commit bf3e2dce7b54988d82f16ee3564c14f1b5cd936b)",
        "before_after_code_files": [
          "main/streams/xp_socket.c||main/streams/xp_socket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ],
          "candidate": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ]
        }
      },
      "candidate_diff": {
        "main/streams/xp_socket.c||main/streams/xp_socket.c": [
          "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "581:    return NULL;",
          "582:   }",
          "585:    if (get_err) {",
          "587:    }",
          "",
          "[Removed Lines]",
          "584:   if (e && *e && *e != '/') {",
          "",
          "[Added Lines]",
          "584:   if (e && *e) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "600:  if (colon) {",
          "601:   char *e = NULL;",
          "604:    return estrndup(str, colon - str);",
          "605:   }",
          "606:  }",
          "",
          "[Removed Lines]",
          "603:   if (!e || !*e || *e == '/') {",
          "",
          "[Added Lines]",
          "603:   if (!e || !*e) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3b77751bb180189b97e7c0062b3012fd433e3cda",
      "candidate_info": {
        "commit_hash": "3b77751bb180189b97e7c0062b3012fd433e3cda",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/3b77751bb180189b97e7c0062b3012fd433e3cda",
        "files": [
          "ext/standard/tests/streams/parseip-001.phpt",
          "main/streams/xp_socket.c"
        ],
        "message": "Revert \"Detect invalid port in xp_socket parse ip address\"\n\nThis reverts commit bab0b99f376dac9170ac81382a5ed526938d595a.\n\n(cherry picked from commit 09ef61e3ca33d8f91b188cd0ad2512987671962b)",
        "before_after_code_files": [
          "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
          "main/streams/xp_socket.c||main/streams/xp_socket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ],
          "candidate": [
            "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt": [
          "File: ext/standard/tests/streams/parseip-001.phpt -> ext/standard/tests/streams/parseip-001.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "main/streams/xp_socket.c||main/streams/xp_socket.c": [
          "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:  char *host = NULL;",
          "573: #ifdef HAVE_IPV6",
          "574:  if (*(str) == '[' && str_len > 1) {",
          "577:   if (!p || *(p + 1) != ':') {",
          "578:    if (get_err) {",
          "580:    }",
          "581:    return NULL;",
          "582:   }",
          "590:   return estrndup(str + 1, p - str - 1);",
          "591:  }",
          "592: #endif",
          "594:  if (str_len) {",
          "595:   colon = memchr(str, ':', str_len - 1);",
          "596:  } else {",
          "597:   colon = NULL;",
          "598:  }",
          "600:  if (colon) {",
          "605:   }",
          "606:  }",
          "612: }",
          "614: static inline char *parse_ip_address(php_stream_xport_param *xparam, int *portno)",
          "",
          "[Removed Lines]",
          "576:   char *p = memchr(str + 1, ']', str_len - 2), *e = NULL;",
          "584:   if (e && *e) {",
          "585:    if (get_err) {",
          "587:    }",
          "588:    return NULL;",
          "589:   }",
          "601:   char *e = NULL;",
          "603:   if (!e || !*e) {",
          "604:    return estrndup(str, colon - str);",
          "608:  if (get_err) {",
          "610:  }",
          "611:  return NULL;",
          "",
          "[Added Lines]",
          "574:  char *p;",
          "578:   p = memchr(str + 1, ']', str_len - 2);",
          "596:   host = estrndup(str, colon - str);",
          "597:  } else {",
          "598:   if (get_err) {",
          "601:   return NULL;",
          "604:  return host;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee9650c3d2b0ccc9bdeec3de33ad1950b8362005",
      "candidate_info": {
        "commit_hash": "ee9650c3d2b0ccc9bdeec3de33ad1950b8362005",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/ee9650c3d2b0ccc9bdeec3de33ad1950b8362005",
        "files": [
          "ext/standard/tests/streams/parseip-001.phpt",
          "main/streams/xp_socket.c"
        ],
        "message": "Merge branch 'PHP-7.0' into PHP-7.1\n\n* PHP-7.0:\n  Revert \"Detect invalid port in xp_socket parse ip address\"\n  Revert \"Follow up patch regarding bug #74216, see bug #74429\"",
        "before_after_code_files": [
          "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
          "main/streams/xp_socket.c||main/streams/xp_socket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ],
          "candidate": [
            "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt",
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/streams/parseip-001.phpt||ext/standard/tests/streams/parseip-001.phpt": [
          "File: ext/standard/tests/streams/parseip-001.phpt -> ext/standard/tests/streams/parseip-001.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "main/streams/xp_socket.c||main/streams/xp_socket.c": [
          "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "571:  char *host = NULL;",
          "573: #ifdef HAVE_IPV6",
          "574:  if (*(str) == '[' && str_len > 1) {",
          "577:   if (!p || *(p + 1) != ':') {",
          "578:    if (get_err) {",
          "580:    }",
          "581:    return NULL;",
          "582:   }",
          "590:   return estrndup(str + 1, p - str - 1);",
          "591:  }",
          "592: #endif",
          "594:  if (str_len) {",
          "595:   colon = memchr(str, ':', str_len - 1);",
          "596:  } else {",
          "597:   colon = NULL;",
          "598:  }",
          "600:  if (colon) {",
          "605:   }",
          "606:  }",
          "612: }",
          "614: static inline char *parse_ip_address(php_stream_xport_param *xparam, int *portno)",
          "",
          "[Removed Lines]",
          "576:   char *p = memchr(str + 1, ']', str_len - 2), *e = NULL;",
          "584:   if (e && *e && *e != '/') {",
          "585:    if (get_err) {",
          "587:    }",
          "588:    return NULL;",
          "589:   }",
          "601:   char *e = NULL;",
          "603:   if (!e || !*e || *e == '/') {",
          "604:    return estrndup(str, colon - str);",
          "608:  if (get_err) {",
          "610:  }",
          "611:  return NULL;",
          "",
          "[Added Lines]",
          "574:  char *p;",
          "578:   p = memchr(str + 1, ']', str_len - 2);",
          "596:   host = estrndup(str, colon - str);",
          "597:  } else {",
          "598:   if (get_err) {",
          "601:   return NULL;",
          "604:  return host;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cda7dcf4cacef3346f9dc2a4dc947e6a74769259",
      "candidate_info": {
        "commit_hash": "cda7dcf4cacef3346f9dc2a4dc947e6a74769259",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/cda7dcf4cacef3346f9dc2a4dc947e6a74769259",
        "files": [
          "main/streams/xp_socket.c"
        ],
        "message": "Follow up patch regarding bug #74216, see bug #74429\n\nWhile the case in bug #74429 is not documented and is only worky due to\nan implementation bug, the strength seems to breach some real world\napps. Given this patch doesn't impact the initial security fix for\nbug #74216, it is reasonable to let the apps keep working. As mentioned\nin the ticket, this behavior is a subject to change in future versions\nand should not be abused.",
        "before_after_code_files": [
          "main/streams/xp_socket.c||main/streams/xp_socket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ],
          "candidate": [
            "main/streams/xp_socket.c||main/streams/xp_socket.c"
          ]
        }
      },
      "candidate_diff": {
        "main/streams/xp_socket.c||main/streams/xp_socket.c": [
          "File: main/streams/xp_socket.c -> main/streams/xp_socket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "581:    return NULL;",
          "582:   }",
          "585:    if (get_err) {",
          "587:    }",
          "",
          "[Removed Lines]",
          "584:   if (e && *e) {",
          "",
          "[Added Lines]",
          "584:   if (e && *e && *e != '/') {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "600:  if (colon) {",
          "601:   char *e = NULL;",
          "604:    return estrndup(str, colon - str);",
          "605:   }",
          "606:  }",
          "",
          "[Removed Lines]",
          "603:   if (!e || !*e) {",
          "",
          "[Added Lines]",
          "603:   if (!e || !*e || *e == '/') {",
          "",
          "---------------"
        ]
      }
    }
  ]
}