{
  "cve_id": "CVE-2017-2603",
  "cve_desc": "Jenkins before versions 2.44, 2.32.2 is vulnerable to a user data leak in disconnected agents' config.xml API. This could leak sensitive data such as API tokens (SECURITY-362).",
  "repo": "jenkinsci/jenkins",
  "patch_hash": "3cd946cbef82c6da5ccccf3890d0ae4e091c4265",
  "patch_info": {
    "commit_hash": "3cd946cbef82c6da5ccccf3890d0ae4e091c4265",
    "repo": "jenkinsci/jenkins",
    "commit_url": "https://github.com/jenkinsci/jenkins/commit/3cd946cbef82c6da5ccccf3890d0ae4e091c4265",
    "files": [
      "core/src/main/java/hudson/slaves/OfflineCause.java",
      "test/src/test/java/hudson/model/ComputerTest.java",
      "test/src/test/resources/hudson/model/ComputerTest/removeUserDetailsFromOfflineCause/config.xml",
      "test/src/test/resources/hudson/model/ComputerTest/removeUserDetailsFromOfflineCause/nodes/deserialized/config.xml",
      "test/src/test/resources/hudson/model/ComputerTest/removeUserDetailsFromOfflineCause/users/username/config.xml"
    ],
    "message": "Merge pull request #80 from jenkinsci-cert/SECURITY-362\n\n[SECURITY-362] Do not persist User in OfflineCause.UserCause",
    "before_after_code_files": [
      "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java",
      "test/src/test/java/hudson/model/ComputerTest.java||test/src/test/java/hudson/model/ComputerTest.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java": [
      "File: core/src/main/java/hudson/slaves/OfflineCause.java -> core/src/main/java/hudson/slaves/OfflineCause.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "25: package hudson.slaves;",
      "28: import hudson.Functions;",
      "29: import hudson.model.Computer;",
      "30: import hudson.model.User;",
      "",
      "[Removed Lines]",
      "27: import jenkins.model.Jenkins;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "33: import org.kohsuke.stapler.export.ExportedBean;",
      "34: import org.kohsuke.stapler.export.Exported;",
      "36: import javax.annotation.Nonnull;",
      "37: import java.util.Date;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "35: import javax.annotation.CheckForNull;",
      "37: import java.io.ObjectStreamException;",
      "38: import java.util.Collections;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "133:     public static class UserCause extends SimpleOfflineCause {",
      "139:                     message != null ? \" : \" + message : \"\"",
      "142:         }",
      "144:         public User getUser() {",
      "146:         }",
      "147:     }",
      "",
      "[Removed Lines]",
      "134:         private final User user;",
      "136:         public UserCause(User user, String message) {",
      "137:             super(hudson.slaves.Messages._SlaveComputer_DisconnectedBy(",
      "138:                     user!=null ? user.getId() : Jenkins.ANONYMOUS.getName(),",
      "140:             ));",
      "141:             this.user = user;",
      "145:             return user;",
      "",
      "[Added Lines]",
      "137:         @Deprecated",
      "138:         private transient User user;",
      "140:         private /*final*/ @CheckForNull String userId;",
      "142:         public UserCause(@CheckForNull User user, @CheckForNull String message) {",
      "143:             this(",
      "144:                     user != null ? user.getId() : null,",
      "146:             );",
      "147:         }",
      "149:         private UserCause(String userId, String message) {",
      "150:             super(hudson.slaves.Messages._SlaveComputer_DisconnectedBy(userId, message));",
      "151:             this.userId = userId;",
      "155:             return userId == null",
      "156:                     ? User.getUnknown()",
      "157:                     : User.getById(userId, true)",
      "158:             ;",
      "159:         }",
      "162:         @SuppressWarnings(\"deprecation\")",
      "163:         private Object readResolve() throws ObjectStreamException {",
      "164:             if (user != null) {",
      "165:                 String id = user.getId();",
      "166:                 if (id != null) {",
      "167:                     userId = id;",
      "168:                 } else {",
      "170:                     User user = User.get(this.user.getFullName(), true, Collections.emptyMap());",
      "171:                     userId = user.getId();",
      "172:                 }",
      "173:                 this.user = null;",
      "174:             }",
      "175:             return this;",
      "",
      "---------------"
    ],
    "test/src/test/java/hudson/model/ComputerTest.java||test/src/test/java/hudson/model/ComputerTest.java": [
      "File: test/src/test/java/hudson/model/ComputerTest.java -> test/src/test/java/hudson/model/ComputerTest.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: package hudson.model;",
      "26: import static org.junit.Assert.*;",
      "28: import java.io.File;",
      "30: import jenkins.model.Jenkins;",
      "31: import hudson.slaves.DumbSlave;",
      "33: import org.junit.Rule;",
      "34: import org.junit.Test;",
      "35: import org.jvnet.hudson.test.JenkinsRule;",
      "37: public class ComputerTest {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "26: import static org.hamcrest.Matchers.containsString;",
      "27: import static org.hamcrest.Matchers.not;",
      "33: import com.gargoylesoftware.htmlunit.xml.XmlPage;",
      "34: import hudson.slaves.OfflineCause;",
      "41: import org.jvnet.hudson.test.recipes.LocalData;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "53:         assertTrue(\"Slave log should be kept\", keep.toComputer().getLogFile().exists());",
      "54:     }",
      "55: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "62:     @Test",
      "63:     public void doNotShowUserDetailsInOfflineCause() throws Exception {",
      "64:         DumbSlave slave = j.createOnlineSlave();",
      "65:         final Computer computer = slave.toComputer();",
      "66:         computer.setTemporarilyOffline(true, new OfflineCause.UserCause(User.get(\"username\"), \"msg\"));",
      "67:         verifyOfflineCause(computer);",
      "68:     }",
      "70:     @Test @LocalData",
      "71:     public void removeUserDetailsFromOfflineCause() throws Exception {",
      "72:         Computer computer = j.jenkins.getComputer(\"deserialized\");",
      "73:         verifyOfflineCause(computer);",
      "74:     }",
      "76:     private void verifyOfflineCause(Computer computer) throws Exception {",
      "77:         XmlPage page = j.createWebClient().goToXml(\"computer/\" + computer.getName() + \"/config.xml\");",
      "78:         String content = page.getWebResponse().getContentAsString(\"UTF-8\");",
      "79:         assertThat(content, containsString(\"temporaryOfflineCause\"));",
      "80:         assertThat(content, containsString(\"<userId>username</userId>\"));",
      "81:         assertThat(content, not(containsString(\"ApiTokenProperty\")));",
      "82:         assertThat(content, not(containsString(\"apiToken\")));",
      "83:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b6c74960187ff140ed052cc14cd49ed59ebd60f8",
      "candidate_info": {
        "commit_hash": "b6c74960187ff140ed052cc14cd49ed59ebd60f8",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/b6c74960187ff140ed052cc14cd49ed59ebd60f8",
        "files": [
          "core/src/main/java/hudson/slaves/OfflineCause.java",
          "test/src/test/java/hudson/model/NodeTest.java"
        ],
        "message": "Fix NPE when toggleOffline is performed by anonymous\n\nRegression from SECURITY-362",
        "before_after_code_files": [
          "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java",
          "test/src/test/java/hudson/model/NodeTest.java||test/src/test/java/hudson/model/NodeTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java"
          ],
          "candidate": [
            "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java"
          ]
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/slaves/OfflineCause.java||core/src/main/java/hudson/slaves/OfflineCause.java": [
          "File: core/src/main/java/hudson/slaves/OfflineCause.java -> core/src/main/java/hudson/slaves/OfflineCause.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: import hudson.model.Computer;",
          "29: import hudson.model.User;",
          "31: import org.jvnet.localizer.Localizable;",
          "32: import org.kohsuke.stapler.export.ExportedBean;",
          "33: import org.kohsuke.stapler.export.Exported;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: import jenkins.model.Jenkins;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:         }",
          "149:         private UserCause(String userId, String message) {",
          "151:             this.userId = userId;",
          "152:         }",
          "",
          "[Removed Lines]",
          "150:             super(hudson.slaves.Messages._SlaveComputer_DisconnectedBy(userId, message));",
          "",
          "[Added Lines]",
          "151:             super(hudson.slaves.Messages._SlaveComputer_DisconnectedBy(userId != null ? userId : Jenkins.ANONYMOUS.getName(), message));",
          "",
          "---------------"
        ],
        "test/src/test/java/hudson/model/NodeTest.java||test/src/test/java/hudson/model/NodeTest.java": [
          "File: test/src/test/java/hudson/model/NodeTest.java -> test/src/test/java/hudson/model/NodeTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "51: import java.util.concurrent.Callable;",
          "53: import jenkins.model.Jenkins;",
          "54: import jenkins.security.QueueItemAuthenticatorConfiguration;",
          "55: import org.acegisecurity.context.SecurityContextHolder;",
          "56: import static org.junit.Assert.*;",
          "58: import org.junit.Before;",
          "59: import org.junit.Rule;",
          "60: import org.junit.Test;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "54: import jenkins.security.NotReallyRoleSensitiveCallable;",
          "56: import org.acegisecurity.Authentication;",
          "59: import static org.hamcrest.core.StringEndsWith.endsWith;",
          "62: import org.jenkinsci.remoting.RoleChecker;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "123:         assertNull(computer.getOfflineCause());",
          "124:     }",
          "126:     @Test",
          "127:     public void testGetLabelCloud() throws Exception {",
          "128:         Node node = j.createOnlineSlave();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "131:     @Test",
          "132:     public void testOfflineCauseAsAnonymous() throws Exception {",
          "133:         Node node = j.createOnlineSlave();",
          "134:         final Computer computer = node.toComputer();",
          "135:         OfflineCause.UserCause cause;",
          "136:         ACL.impersonate(Jenkins.ANONYMOUS, new NotReallyRoleSensitiveCallable() {",
          "137:             @Override",
          "138:             public Void call() throws Exception {",
          "139:                 computer.doToggleOffline(\"original message\");",
          "140:                 return null;",
          "141:             }",
          "142:         });",
          "144:         cause = (UserCause) computer.getOfflineCause();",
          "145:         assertThat(cause.toString(), endsWith(\"Disconnected by anonymous : original message\"));",
          "146:         assertEquals(User.getUnknown(), cause.getUser());",
          "149:         final User root = User.get(\"root@localhost\");",
          "150:         ACL.impersonate(root.impersonate(), new NotReallyRoleSensitiveCallable() {",
          "151:             @Override",
          "152:             public Void call() throws Exception {",
          "153:                 computer.doChangeOfflineCause(\"new message\");",
          "154:                 return null;",
          "155:             }",
          "156:         });",
          "157:         cause = (UserCause) computer.getOfflineCause();",
          "158:         assertThat(cause.toString(), endsWith(\"Disconnected by root@localhost : new message\"));",
          "159:         assertEquals(root, cause.getUser());",
          "161:         computer.doToggleOffline(null);",
          "162:         assertNull(computer.getOfflineCause());",
          "163:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}