{
  "cve_id": "CVE-2021-37689",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions an attacker can craft a TFLite model that would trigger a null pointer dereference, which would result in a crash and denial of service. This is caused by the MLIR optimization of `L2NormalizeReduceAxis` operator. The [implementation](https://github.com/tensorflow/tensorflow/blob/149562d49faa709ea80df1d99fc41d005b81082a/tensorflow/compiler/mlir/lite/transforms/optimize.cc#L67-L70) unconditionally dereferences a pointer to an iterator to a vector without checking that the vector has elements. We have patched the issue in GitHub commit d6b57f461b39fd1aa8c1b870f1b974aac3554955. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "d6b57f461b39fd1aa8c1b870f1b974aac3554955",
  "patch_info": {
    "commit_hash": "d6b57f461b39fd1aa8c1b870f1b974aac3554955",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/d6b57f461b39fd1aa8c1b870f1b974aac3554955",
    "files": [
      "tensorflow/compiler/mlir/lite/transforms/optimize.cc"
    ],
    "message": "Prevent nullptr dereference in MLIR TFLite dialect/optimizer.\n\nPiperOrigin-RevId: 387220762\nChange-Id: Id136ef04bb3d36123b4685d316ae81a9ec924d6b",
    "before_after_code_files": [
      "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc": [
      "File: tensorflow/compiler/mlir/lite/transforms/optimize.cc -> tensorflow/compiler/mlir/lite/transforms/optimize.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "68: constexpr char kRelu1[] = \"RELU_N1_TO_1\";",
      "70: bool L2NormalizeReduceAxis(Value sq_op, DenseElementsAttr axis) {",
      "71:   if (sq_op.getType().cast<ShapedType>().getRank() - 1 ==",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "71:   if (axis.getNumElements() == 0) {",
      "72:     return false;",
      "73:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "88075f3f3d320604cea4619faf7bf178ca8329dd",
      "candidate_info": {
        "commit_hash": "88075f3f3d320604cea4619faf7bf178ca8329dd",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/88075f3f3d320604cea4619faf7bf178ca8329dd",
        "files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ],
        "message": "Prevent nullptr dereference in MLIR TFLite dialect/optimizer.\n\nPiperOrigin-RevId: 387220762\nChange-Id: Id136ef04bb3d36123b4685d316ae81a9ec924d6b",
        "before_after_code_files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ],
          "candidate": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc": [
          "File: tensorflow/compiler/mlir/lite/transforms/optimize.cc -> tensorflow/compiler/mlir/lite/transforms/optimize.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "61: constexpr char kRelu1[] = \"RELU_N1_TO_1\";",
          "63: bool L2NormalizeReduceAxis(Value sq_op, DenseElementsAttr axis) {",
          "64:   if (sq_op.getType().cast<ShapedType>().getRank() - 1 ==",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "64:   if (axis.getNumElements() == 0) {",
          "65:     return false;",
          "66:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "565f2155f693227cbf6f129da4671943ccd190ad",
      "candidate_info": {
        "commit_hash": "565f2155f693227cbf6f129da4671943ccd190ad",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/565f2155f693227cbf6f129da4671943ccd190ad",
        "files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ],
        "message": "Prevent nullptr dereference in MLIR TFLite dialect/optimizer.\n\nPiperOrigin-RevId: 387220762\nChange-Id: Id136ef04bb3d36123b4685d316ae81a9ec924d6b",
        "before_after_code_files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ],
          "candidate": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc": [
          "File: tensorflow/compiler/mlir/lite/transforms/optimize.cc -> tensorflow/compiler/mlir/lite/transforms/optimize.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "65: constexpr char kRelu1[] = \"RELU_N1_TO_1\";",
          "67: bool L2NormalizeReduceAxis(Value sq_op, DenseElementsAttr axis) {",
          "68:   if (sq_op.getType().cast<ShapedType>().getRank() - 1 ==",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "68:   if (axis.getNumElements() == 0) {",
          "69:     return false;",
          "70:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dcdb7df5694d83d3a20b7e4f3b6edbce146a843d",
      "candidate_info": {
        "commit_hash": "dcdb7df5694d83d3a20b7e4f3b6edbce146a843d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/dcdb7df5694d83d3a20b7e4f3b6edbce146a843d",
        "files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ],
        "message": "Prevent nullptr dereference in MLIR TFLite dialect/optimizer.\n\nPiperOrigin-RevId: 387220762\nChange-Id: Id136ef04bb3d36123b4685d316ae81a9ec924d6b",
        "before_after_code_files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ],
          "candidate": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc": [
          "File: tensorflow/compiler/mlir/lite/transforms/optimize.cc -> tensorflow/compiler/mlir/lite/transforms/optimize.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "68: constexpr char kRelu1[] = \"RELU_N1_TO_1\";",
          "70: bool L2NormalizeReduceAxis(Value sq_op, DenseElementsAttr axis) {",
          "71:   if (sq_op.getType().cast<ShapedType>().getRank() - 1 ==",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71:   if (axis.getNumElements() == 0) {",
          "72:     return false;",
          "73:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e05490e73face64921faecbfcd09a22bd707fa59",
      "candidate_info": {
        "commit_hash": "e05490e73face64921faecbfcd09a22bd707fa59",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e05490e73face64921faecbfcd09a22bd707fa59",
        "files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ],
        "message": "Prevent nullptr dereference in MLIR TFLite dialect/optimizer.\n\nPiperOrigin-RevId: 387220762\nChange-Id: Id136ef04bb3d36123b4685d316ae81a9ec924d6b",
        "before_after_code_files": [
          "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ],
          "candidate": [
            "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/compiler/mlir/lite/transforms/optimize.cc||tensorflow/compiler/mlir/lite/transforms/optimize.cc": [
          "File: tensorflow/compiler/mlir/lite/transforms/optimize.cc -> tensorflow/compiler/mlir/lite/transforms/optimize.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "56: constexpr char kRelu1[] = \"RELU_N1_TO_1\";",
          "58: bool L2NormalizeReduceAxis(Value sq_op, DenseElementsAttr axis) {",
          "59:   if (sq_op.getType().cast<ShapedType>().getRank() - 1 ==",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:   if (axis.getNumElements() == 0) {",
          "60:     return false;",
          "61:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}