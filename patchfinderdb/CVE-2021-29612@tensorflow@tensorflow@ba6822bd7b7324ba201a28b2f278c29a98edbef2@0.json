{
  "cve_id": "CVE-2021-29612",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can trigger a heap buffer overflow in Eigen implementation of `tf.raw_ops.BandedTriangularSolve`. The implementation(https://github.com/tensorflow/tensorflow/blob/eccb7ec454e6617738554a255d77f08e60ee0808/tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc#L269-L278) calls `ValidateInputTensors` for input validation but fails to validate that the two tensors are not empty. Furthermore, since `OP_REQUIRES` macro only stops execution of current function after setting `ctx->status()` to a non-OK value, callers of helper functions that use `OP_REQUIRES` must check value of `ctx->status()` before continuing. This doesn't happen in this op's implementation(https://github.com/tensorflow/tensorflow/blob/eccb7ec454e6617738554a255d77f08e60ee0808/tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc#L219), hence the validation that is present is also not effective. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "ba6822bd7b7324ba201a28b2f278c29a98edbef2",
  "patch_info": {
    "commit_hash": "ba6822bd7b7324ba201a28b2f278c29a98edbef2",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/ba6822bd7b7324ba201a28b2f278c29a98edbef2",
    "files": [
      "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
    ],
    "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
      "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "180:                                           \" for dimension \", i));",
      "181:     }",
      "183:     const int num_dims = a_indices_t->dim_size(1);",
      "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
      "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "183:     OP_REQUIRES(",
      "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
      "185:         errors::InvalidArgument(",
      "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
      "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "85f34f4ba5ab09ac7ba934b94aab0943eb5643eb",
      "candidate_info": {
        "commit_hash": "85f34f4ba5ab09ac7ba934b94aab0943eb5643eb",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/85f34f4ba5ab09ac7ba934b94aab0943eb5643eb",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "183:     const int num_dims = a_indices_t->dim_size(1);",
          "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ae35e4ad96de8e423026864bea31ffba8274d298",
      "candidate_info": {
        "commit_hash": "ae35e4ad96de8e423026864bea31ffba8274d298",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ae35e4ad96de8e423026864bea31ffba8274d298",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "183:     const int num_dims = a_indices_t->dim_size(1);",
          "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "34c0efb676dda51a3f0abe88e170f9b4f0f6490f",
      "candidate_info": {
        "commit_hash": "34c0efb676dda51a3f0abe88e170f9b4f0f6490f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/34c0efb676dda51a3f0abe88e170f9b4f0f6490f",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "183:     const int num_dims = a_indices_t->dim_size(1);",
          "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f9fac192d67207dcb8badfd1c34d6fd1350bbc5",
      "candidate_info": {
        "commit_hash": "3f9fac192d67207dcb8badfd1c34d6fd1350bbc5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3f9fac192d67207dcb8badfd1c34d6fd1350bbc5",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "183:     const int num_dims = a_indices_t->dim_size(1);",
          "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "de904d9c3a075d86914b931d633e42081b7ca49e",
      "candidate_info": {
        "commit_hash": "de904d9c3a075d86914b931d633e42081b7ca49e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/de904d9c3a075d86914b931d633e42081b7ca49e",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Fix OOB issue with `tf.raw_ops.SparseSparseMinimum`.\n\nPiperOrigin-RevId: 371005787\nChange-Id: Ib686ccc077836e8b980b8b5a03936d36a8ecaf71",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "183:     const int num_dims = a_indices_t->dim_size(1);",
          "184:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "185:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}