{
  "cve_id": "CVE-2018-6758",
  "cve_desc": "The uwsgi_expand_path function in core/utils.c in Unbit uWSGI through 2.0.15 has a stack-based buffer overflow via a large directory length.",
  "repo": "unbit/uwsgi",
  "patch_hash": "cb4636f7c0af2e97a4eef7a3cdcbd85a71247bfe",
  "patch_info": {
    "commit_hash": "cb4636f7c0af2e97a4eef7a3cdcbd85a71247bfe",
    "repo": "unbit/uwsgi",
    "commit_url": "https://github.com/unbit/uwsgi/commit/cb4636f7c0af2e97a4eef7a3cdcbd85a71247bfe",
    "files": [
      "core/utils.c"
    ],
    "message": "improve uwsgi_expand_path() to sanitize input, avoiding stack corruption and potential security issue",
    "before_after_code_files": [
      "core/utils.c||core/utils.c"
    ]
  },
  "patch_diff": {
    "core/utils.c||core/utils.c": [
      "File: core/utils.c -> core/utils.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3674: }",
      "3676: char *uwsgi_expand_path(char *dir, int dir_len, char *ptr) {",
      "3680:  char *dst = ptr;",
      "3681:  if (!dst)",
      "3682:   dst = uwsgi_malloc(PATH_MAX + 1);",
      "",
      "[Removed Lines]",
      "3677:  char src[PATH_MAX + 1];",
      "3678:  memcpy(src, dir, dir_len);",
      "3679:  src[dir_len] = 0;",
      "",
      "[Added Lines]",
      "3677:  if (dir_len > PATH_MAX)",
      "3678:  {",
      "3679:   uwsgi_log(\"invalid path size: %d (max %d)\\n\", dir_len, PATH_MAX);",
      "3680:   return NULL;",
      "3681:  }",
      "3682:  char *src = uwsgi_concat2n(dir, dir_len, \"\", 0);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "3684:   uwsgi_error_realpath(src);",
      "3685:   if (!ptr)",
      "3686:    free(dst);",
      "3687:   return NULL;",
      "3688:  }",
      "3689:  return dst;",
      "3690: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3690:   free(src);",
      "3693:  free(src);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ed1c3bbc6cfc4d566401526fd21ba0984dd7b22a",
      "candidate_info": {
        "commit_hash": "ed1c3bbc6cfc4d566401526fd21ba0984dd7b22a",
        "repo": "unbit/uwsgi",
        "commit_url": "https://github.com/unbit/uwsgi/commit/ed1c3bbc6cfc4d566401526fd21ba0984dd7b22a",
        "files": [
          "core/utils.c"
        ],
        "message": "improve uwsgi_expand_path() to sanitize input, avoiding stack corruption and potential security issue",
        "before_after_code_files": [
          "core/utils.c||core/utils.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "core/utils.c||core/utils.c"
          ],
          "candidate": [
            "core/utils.c||core/utils.c"
          ]
        }
      },
      "candidate_diff": {
        "core/utils.c||core/utils.c": [
          "File: core/utils.c -> core/utils.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3625: }",
          "3627: char *uwsgi_expand_path(char *dir, int dir_len, char *ptr) {",
          "3631:  char *dst = ptr;",
          "3632:  if (!dst)",
          "3633:   dst = uwsgi_malloc(PATH_MAX + 1);",
          "",
          "[Removed Lines]",
          "3628:  char src[PATH_MAX + 1];",
          "3629:  memcpy(src, dir, dir_len);",
          "3630:  src[dir_len] = 0;",
          "",
          "[Added Lines]",
          "3628:  if (dir_len > PATH_MAX)",
          "3629:  {",
          "3630:   uwsgi_log(\"invalid path size: %d (max %d)\\n\", dir_len, PATH_MAX);",
          "3631:   return NULL;",
          "3632:  }",
          "3633:  char *src = uwsgi_concat2n(dir, dir_len, \"\", 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3635:   uwsgi_error_realpath(src);",
          "3636:   if (!ptr)",
          "3637:    free(dst);",
          "3638:   return NULL;",
          "3639:  }",
          "3640:  return dst;",
          "3641: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3641:   free(src);",
          "3644:  free(src);",
          "",
          "---------------"
        ]
      }
    }
  ]
}