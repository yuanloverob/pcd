{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cc8cc60ce04c92c0d4c0fa28a4f424a5f3ce089b",
      "candidate_info": {
        "commit_hash": "cc8cc60ce04c92c0d4c0fa28a4f424a5f3ce089b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/cc8cc60ce04c92c0d4c0fa28a4f424a5f3ce089b",
        "files": [
          "tests/test_basic.c"
        ],
        "message": "cleanup",
        "before_after_code_files": [
          "tests/test_basic.c||tests/test_basic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/test_basic.c||tests/test_basic.c": [
          "File: tests/test_basic.c -> tests/test_basic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "334: {",
          "335:  test();",
          "357:  return 0;",
          "358: }",
          "",
          "[Removed Lines]",
          "337: #if 0",
          "338: #define offsetof(st, m) __builtin_offsetof(st, m)",
          "340:  cs_insn insn;",
          "341:  printf(\"size: %lu\\n\", sizeof(insn));",
          "342:  printf(\"@id: %lu\\n\", offsetof(cs_insn, id));",
          "343:  printf(\"@address: %lu\\n\", offsetof(cs_insn, address));",
          "344:  printf(\"@size: %lu\\n\", offsetof(cs_insn, size));",
          "345:  printf(\"@bytes: %lu\\n\", offsetof(cs_insn, bytes));",
          "346:  printf(\"@mnemonic: %lu\\n\", offsetof(cs_insn, mnemonic));",
          "347:  printf(\"@op_str: %lu\\n\", offsetof(cs_insn, op_str));",
          "348:  printf(\"@regs_read: %lu\\n\", offsetof(cs_insn, regs_read));",
          "349:  printf(\"@regs_read_count: %lu\\n\", offsetof(cs_insn, regs_read_count));",
          "350:  printf(\"@regs_write: %lu\\n\", offsetof(cs_insn, regs_write));",
          "351:  printf(\"@regs_write_count: %lu\\n\", offsetof(cs_insn, regs_write_count));",
          "352:  printf(\"@groups: %lu\\n\", offsetof(cs_insn, groups));",
          "353:  printf(\"@groups_count: %lu\\n\", offsetof(cs_insn, groups_count));",
          "354:  printf(\"@arch: %lu\\n\", offsetof(cs_insn, x86));",
          "355: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e18496fe5dd7c7f0bc5ad01bd7257ff96a072c5d",
      "candidate_info": {
        "commit_hash": "e18496fe5dd7c7f0bc5ad01bd7257ff96a072c5d",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/e18496fe5dd7c7f0bc5ad01bd7257ff96a072c5d",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: cleanup",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "74: static void usage(char *prog)",
          "75: {",
          "76:  printf(\"Cstool v%s for Capstone Disassembler Engine (core v%u.%u)\\n\\n\", VERSION, CS_API_MAJOR, CS_API_MINOR);",
          "78:  printf(\"\\nThe following <arch+mode> options are supported:\\n\");",
          "80:  if (cs_support(CS_ARCH_X86)) {",
          "",
          "[Removed Lines]",
          "77:  printf(\"Syntax: %s [-d:print all detail information] <arch+mode> <assembly-hexstring> [start-address-in-hex-format]\\n\", prog);",
          "",
          "[Added Lines]",
          "77:  printf(\"Syntax: %s [-d] <arch+mode> <assembly-hexstring> [start-address-in-hex-format]\\n\", prog);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "45f81ff5b7a5c85310665fc941e1692335096602",
      "candidate_info": {
        "commit_hash": "45f81ff5b7a5c85310665fc941e1692335096602",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/45f81ff5b7a5c85310665fc941e1692335096602",
        "files": [
          "arch/X86/X86Mapping.c"
        ],
        "message": "x86: RET read/write stack register. this fixes issue #790",
        "before_after_code_files": [
          "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ],
          "candidate": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
          "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2616:        break;",
          "2617:      }",
          "2618:      break;",
          "2619:    }",
          "2621:    memcpy(insn->detail->groups, insns[i].groups, sizeof(insns[i].groups));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2620:     case X86_INS_RET:",
          "2621:      switch(h->mode) {",
          "2622:       case CS_MODE_16:",
          "2623:        insn->detail->regs_write[0] = X86_REG_SP;",
          "2624:        insn->detail->regs_read[0] = X86_REG_SP;",
          "2625:        break;",
          "2626:       case CS_MODE_32:",
          "2627:        insn->detail->regs_write[0] = X86_REG_ESP;",
          "2628:        insn->detail->regs_read[0] = X86_REG_ESP;",
          "2629:        break;",
          "2630:       default: // 64-bit",
          "2631:        insn->detail->regs_write[0] = X86_REG_RSP;",
          "2632:        insn->detail->regs_read[0] = X86_REG_RSP;",
          "2633:        break;",
          "2634:      }",
          "2635:      insn->detail->regs_write_count = 1;",
          "2636:      insn->detail->regs_read_count = 1;",
          "2637:      break;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d0afd01e882b86952106cf8c29cb78e6b7deb89f",
      "candidate_info": {
        "commit_hash": "d0afd01e882b86952106cf8c29cb78e6b7deb89f",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/d0afd01e882b86952106cf8c29cb78e6b7deb89f",
        "files": [
          "bindings/python/capstone/__init__.py"
        ],
        "message": "Python: Actually attempt to load .so.3 extension on linux",
        "before_after_code_files": [
          "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py": [
          "File: bindings/python/capstone/__init__.py -> bindings/python/capstone/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "249: else:",
          "250:     _lib = \"libcapstone.so\"",
          "253: _found = False",
          "255: def _load_lib(path):",
          "",
          "[Removed Lines]",
          "252: _all_libs = ['capstone.dll', 'libcapstone.so.3', 'libcapstone.so', 'libcapstone.dylib']",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "260:         # if we're on linux, try again with .so.3 extension",
          "261:         if lib_file.endswith('.so'):",
          "262:             try:",
          "264:             except OSError:",
          "265:                 return None",
          "266:         return None",
          "",
          "[Removed Lines]",
          "263:                 return ctypes.cdll.LoadLibrary(lib_file)",
          "",
          "[Added Lines]",
          "262:                 return ctypes.cdll.LoadLibrary(lib_file + '.3')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8ac54c5d65c22a413b8fdfd2d4322f384479ae1b",
      "candidate_info": {
        "commit_hash": "8ac54c5d65c22a413b8fdfd2d4322f384479ae1b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/8ac54c5d65c22a413b8fdfd2d4322f384479ae1b",
        "files": [
          "arch/ARM/ARMInstPrinter.c"
        ],
        "message": "arm: fix issue #760",
        "before_after_code_files": [
          "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c": [
          "File: arch/ARM/ARMInstPrinter.c -> arch/ARM/ARMInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "660:        if (Opcode == ARM_t2LDMIA_UPD)",
          "661:         SStream_concat0(O, \".w\");",
          "662:        SStream_concat0(O, \"\\t\");",
          "663:        if (MI->csh->detail) {",
          "664:         MI->flat_insn->detail->regs_read[MI->flat_insn->detail->regs_read_count] = ARM_REG_SP;",
          "665:         MI->flat_insn->detail->regs_read_count++;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "664:        MI->ac_idx = 1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}