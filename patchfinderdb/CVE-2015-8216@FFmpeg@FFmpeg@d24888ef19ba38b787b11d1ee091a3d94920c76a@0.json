{
  "cve_id": "CVE-2015-8216",
  "cve_desc": "The ljpeg_decode_yuv_scan function in libavcodec/mjpegdec.c in FFmpeg before 2.8.2 omits certain width and height checks, which allows remote attackers to cause a denial of service (out-of-bounds array access) or possibly have unspecified other impact via crafted MJPEG data.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "d24888ef19ba38b787b11d1ee091a3d94920c76a",
  "patch_info": {
    "commit_hash": "d24888ef19ba38b787b11d1ee091a3d94920c76a",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/d24888ef19ba38b787b11d1ee091a3d94920c76a",
    "files": [
      "libavcodec/mjpegdec.c"
    ],
    "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
      "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1093:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
      "1094:                         if(dc == 0xFFFFF)",
      "1095:                             return -1;",
      "1097:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
      "1098:                         if(y==0 && toprow){",
      "1099:                             if(x==0 && leftcol){",
      "",
      "[Removed Lines]",
      "1096:                         if(bits<=8){",
      "",
      "[Added Lines]",
      "1096:                         if (   h * mb_x + x >= s->width",
      "1097:                             || v * mb_y + y >= s->height) {",
      "1099:                         } else if (bits<=8) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1161:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
      "1162:                         if(dc == 0xFFFFF)",
      "1163:                             return -1;",
      "1165:                             ptr = s->picture_ptr->data[c] +",
      "1166:                               (linesize * (v * mb_y + y)) +",
      "1167:                               (h * mb_x + x); //FIXME optimize this crap",
      "",
      "[Removed Lines]",
      "1164:                         if(bits<=8){",
      "",
      "[Added Lines]",
      "1167:                         if (   h * mb_x + x >= s->width",
      "1168:                             || v * mb_y + y >= s->height) {",
      "1170:                         } else if (bits<=8) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2f89546333b53e626d710cde357f0d13ea450474",
      "candidate_info": {
        "commit_hash": "2f89546333b53e626d710cde357f0d13ea450474",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/2f89546333b53e626d710cde357f0d13ea450474",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit d24888ef19ba38b787b11d1ee091a3d94920c76a)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1044:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1045:                         if(dc == 0xFFFFF)",
          "1046:                             return -1;",
          "1048:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
          "1049:                         if(y==0 && toprow){",
          "1050:                             if(x==0 && leftcol){",
          "",
          "[Removed Lines]",
          "1047:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1047:                         if (   h * mb_x + x >= s->width",
          "1048:                             || v * mb_y + y >= s->height) {",
          "1050:                         } else if (bits<=8) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1112:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1113:                         if(dc == 0xFFFFF)",
          "1114:                             return -1;",
          "1116:                             ptr = s->picture_ptr->data[c] +",
          "1117:                               (linesize * (v * mb_y + y)) +",
          "1118:                               (h * mb_x + x); //FIXME optimize this crap",
          "",
          "[Removed Lines]",
          "1115:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1118:                         if (   h * mb_x + x >= s->width",
          "1119:                             || v * mb_y + y >= s->height) {",
          "1121:                         } else if (bits<=8) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fdb884263974b19584a4f37508d71bc60189f512",
      "candidate_info": {
        "commit_hash": "fdb884263974b19584a4f37508d71bc60189f512",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/fdb884263974b19584a4f37508d71bc60189f512",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit d24888ef19ba38b787b11d1ee091a3d94920c76a)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1093:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1094:                         if(dc == 0xFFFFF)",
          "1095:                             return -1;",
          "1097:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
          "1098:                         if(y==0 && toprow){",
          "1099:                             if(x==0 && leftcol){",
          "",
          "[Removed Lines]",
          "1096:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1096:                         if (   h * mb_x + x >= s->width",
          "1097:                             || v * mb_y + y >= s->height) {",
          "1099:                         } else if (bits<=8) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1161:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1162:                         if(dc == 0xFFFFF)",
          "1163:                             return -1;",
          "1165:                             ptr = s->picture_ptr->data[c] +",
          "1166:                               (linesize * (v * mb_y + y)) +",
          "1167:                               (h * mb_x + x); //FIXME optimize this crap",
          "",
          "[Removed Lines]",
          "1164:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1167:                         if (   h * mb_x + x >= s->width",
          "1168:                             || v * mb_y + y >= s->height) {",
          "1170:                         } else if (bits<=8) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f2b161319d29d19d9113b4d06bc28be8745fa35c",
      "candidate_info": {
        "commit_hash": "f2b161319d29d19d9113b4d06bc28be8745fa35c",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/f2b161319d29d19d9113b4d06bc28be8745fa35c",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit d24888ef19ba38b787b11d1ee091a3d94920c76a)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1069:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1070:                         if(dc == 0xFFFFF)",
          "1071:                             return -1;",
          "1073:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
          "1074:                         if(y==0 && toprow){",
          "1075:                             if(x==0 && leftcol){",
          "",
          "[Removed Lines]",
          "1072:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1072:                         if (   h * mb_x + x >= s->width",
          "1073:                             || v * mb_y + y >= s->height) {",
          "1075:                         } else if (bits<=8) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1137:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1138:                         if(dc == 0xFFFFF)",
          "1139:                             return -1;",
          "1141:                             ptr = s->picture_ptr->data[c] +",
          "1142:                               (linesize * (v * mb_y + y)) +",
          "1143:                               (h * mb_x + x); //FIXME optimize this crap",
          "",
          "[Removed Lines]",
          "1140:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1143:                         if (   h * mb_x + x >= s->width",
          "1144:                             || v * mb_y + y >= s->height) {",
          "1146:                         } else if (bits<=8) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4fec2df719b31d37f4af0b230d0876c4eee7e5df",
      "candidate_info": {
        "commit_hash": "4fec2df719b31d37f4af0b230d0876c4eee7e5df",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/4fec2df719b31d37f4af0b230d0876c4eee7e5df",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit d24888ef19ba38b787b11d1ee091a3d94920c76a)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1066:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1067:                         if(dc == 0xFFFFF)",
          "1068:                             return -1;",
          "1070:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
          "1071:                         if(y==0 && toprow){",
          "1072:                             if(x==0 && leftcol){",
          "",
          "[Removed Lines]",
          "1069:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1069:                         if (   h * mb_x + x >= s->width",
          "1070:                             || v * mb_y + y >= s->height) {",
          "1072:                         } else if (bits<=8) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1134:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1135:                         if(dc == 0xFFFFF)",
          "1136:                             return -1;",
          "1138:                             ptr = s->picture_ptr->data[c] +",
          "1139:                               (linesize * (v * mb_y + y)) +",
          "1140:                               (h * mb_x + x); //FIXME optimize this crap",
          "",
          "[Removed Lines]",
          "1137:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1140:                         if (   h * mb_x + x >= s->width",
          "1141:                             || v * mb_y + y >= s->height) {",
          "1143:                         } else if (bits<=8) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "edf06a056253267bb1f2fba3bbc17f4b323f92b1",
      "candidate_info": {
        "commit_hash": "edf06a056253267bb1f2fba3bbc17f4b323f92b1",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/edf06a056253267bb1f2fba3bbc17f4b323f92b1",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Check index in ljpeg_decode_yuv_scan() before using it\n\nFixes: 04715144ba237443010554be0d05343f/asan_heap-oob_1eafc76_1737_c685b48041a563461839e4e7ab97abb8.jpg\nFixes out of array access\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit d24888ef19ba38b787b11d1ee091a3d94920c76a)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1088:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1089:                         if(dc == 0xFFFFF)",
          "1090:                             return -1;",
          "1092:                         ptr = s->picture_ptr->data[c] + (linesize * (v * mb_y + y)) + (h * mb_x + x); //FIXME optimize this crap",
          "1093:                         if(y==0 && toprow){",
          "1094:                             if(x==0 && leftcol){",
          "",
          "[Removed Lines]",
          "1091:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1091:                         if (   h * mb_x + x >= s->width",
          "1092:                             || v * mb_y + y >= s->height) {",
          "1094:                         } else if (bits<=8) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1156:                         dc = mjpeg_decode_dc(s, s->dc_index[i]);",
          "1157:                         if(dc == 0xFFFFF)",
          "1158:                             return -1;",
          "1160:                             ptr = s->picture_ptr->data[c] +",
          "1161:                               (linesize * (v * mb_y + y)) +",
          "1162:                               (h * mb_x + x); //FIXME optimize this crap",
          "",
          "[Removed Lines]",
          "1159:                         if(bits<=8){",
          "",
          "[Added Lines]",
          "1162:                         if (   h * mb_x + x >= s->width",
          "1163:                             || v * mb_y + y >= s->height) {",
          "1165:                         } else if (bits<=8) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}