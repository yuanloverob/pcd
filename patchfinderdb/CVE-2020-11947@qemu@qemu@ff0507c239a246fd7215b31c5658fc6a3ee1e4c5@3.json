{
  "cve_id": "CVE-2020-11947",
  "cve_desc": "iscsi_aio_ioctl_cb in block/iscsi.c in QEMU 4.1.0 has a heap-based buffer over-read that may disclose unrelated information from process memory to an attacker.",
  "repo": "qemu/qemu",
  "patch_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
  "patch_info": {
    "commit_hash": "ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/ff0507c239a246fd7215b31c5658fc6a3ee1e4c5",
    "files": [
      "block/iscsi.c"
    ],
    "message": "block/iscsi:fix heap-buffer-overflow in iscsi_aio_ioctl_cb\n\nThere is an overflow, the source 'datain.data[2]' is 100 bytes,\n but the 'ss' is 252 bytes.This may cause a security issue because\n we can access a lot of unrelated memory data.\n\nThe len for sbp copy data should take the minimum of mx_sb_len and\n sb_len_wr, not the maximum.\n\nIf we use iscsi device for VM backend storage, ASAN show stack:\n\nREAD of size 252 at 0xfffd149dcfc4 thread T0\n    #0 0xaaad433d0d34 in __asan_memcpy (aarch64-softmmu/qemu-system-aarch64+0x2cb0d34)\n    #1 0xaaad45f9d6d0 in iscsi_aio_ioctl_cb /qemu/block/iscsi.c:996:9\n    #2 0xfffd1af0e2dc  (/usr/lib64/iscsi/libiscsi.so.8+0xe2dc)\n    #3 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #4 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #5 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #6 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #7 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #8 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #9 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #10 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #11 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #12 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #13 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #14 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #15 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #16 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #17 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\n0xfffd149dcfc4 is located 0 bytes to the right of 100-byte region [0xfffd149dcf60,0xfffd149dcfc4)\nallocated by thread T0 here:\n    #0 0xaaad433d1e70 in __interceptor_malloc (aarch64-softmmu/qemu-system-aarch64+0x2cb1e70)\n    #1 0xfffd1af0e254  (/usr/lib64/iscsi/libiscsi.so.8+0xe254)\n    #2 0xfffd1af0d174  (/usr/lib64/iscsi/libiscsi.so.8+0xd174)\n    #3 0xfffd1af19fac  (/usr/lib64/iscsi/libiscsi.so.8+0x19fac)\n    #4 0xaaad45f9acc8 in iscsi_process_read /qemu/block/iscsi.c:403:5\n    #5 0xaaad4623733c in aio_dispatch_handler /qemu/util/aio-posix.c:467:9\n    #6 0xaaad4622f350 in aio_dispatch_handlers /qemu/util/aio-posix.c:510:20\n    #7 0xaaad4622f350 in aio_dispatch /qemu/util/aio-posix.c:520\n    #8 0xaaad46215944 in aio_ctx_dispatch /qemu/util/async.c:298:5\n    #9 0xfffd1bed12f4 in g_main_context_dispatch (/lib64/libglib-2.0.so.0+0x512f4)\n    #10 0xaaad46227de0 in glib_pollfds_poll /qemu/util/main-loop.c:219:9\n    #11 0xaaad46227de0 in os_host_main_loop_wait /qemu/util/main-loop.c:242\n    #12 0xaaad46227de0 in main_loop_wait /qemu/util/main-loop.c:518\n    #13 0xaaad43d9d60c in qemu_main_loop /qemu/softmmu/vl.c:1662:9\n    #14 0xaaad4607a5b0 in main /qemu/softmmu/main.c:49:5\n    #15 0xfffd1a460b9c in __libc_start_main (/lib64/libc.so.6+0x20b9c)\n    #16 0xaaad43320740 in _start (aarch64-softmmu/qemu-system-aarch64+0x2c00740)\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Chen Qun <kuhn.chenqun@huawei.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nMessage-id: 20200418062602.10776-1-kuhn.chenqun@huawei.com\nReviewed-by: Daniel P. Berrang\u00e9 <berrange@redhat.com>\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
    "before_after_code_files": [
      "block/iscsi.c||block/iscsi.c"
    ]
  },
  "patch_diff": {
    "block/iscsi.c||block/iscsi.c": [
      "File: block/iscsi.c -> block/iscsi.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "991:         acb->ioh->driver_status |= SG_ERR_DRIVER_SENSE;",
      "993:         acb->ioh->sb_len_wr = acb->task->datain.size - 2;",
      "996:         memcpy(acb->ioh->sbp, &acb->task->datain.data[2], ss);",
      "997:     }",
      "",
      "[Removed Lines]",
      "994:         ss = (acb->ioh->mx_sb_len >= acb->ioh->sb_len_wr) ?",
      "995:              acb->ioh->mx_sb_len : acb->ioh->sb_len_wr;",
      "",
      "[Added Lines]",
      "994:         ss = MIN(acb->ioh->mx_sb_len, acb->ioh->sb_len_wr);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "59c59c67ee6b0327ae932deb303caa47919aeb1e",
      "candidate_info": {
        "commit_hash": "59c59c67ee6b0327ae932deb303caa47919aeb1e",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/59c59c67ee6b0327ae932deb303caa47919aeb1e",
        "files": [
          "migration/rdma.c"
        ],
        "message": "migration/rdma: fix a memleak on error path in rdma_start_incoming_migration\n\n'rdma->host' is malloced in qemu_rdma_data_init, but forgot to free on the error\npath in rdma_start_incoming_migration(), this patch fix that.\n\nThe leak stack:\nDirect leak of 2 byte(s) in 1 object(s) allocated from:\n    #0 0x7fb7add18ae8 in __interceptor_malloc (/lib64/libasan.so.5+0xefae8)\n    #1 0x7fb7ad0df1d5 in g_malloc (/lib64/libglib-2.0.so.0+0x531d5)\n    #2 0x7fb7ad0f8b32 in g_strdup (/lib64/libglib-2.0.so.0+0x6cb32)\n    #3 0x55a0464a0f6f in qemu_rdma_data_init /mnt/sdb/qemu/migration/rdma.c:2647\n    #4 0x55a0464b0e76 in rdma_start_incoming_migration /mnt/sdb/qemu/migration/rdma.c:4020\n    #5 0x55a0463f898a in qemu_start_incoming_migration /mnt/sdb/qemu/migration/migration.c:365\n    #6 0x55a0458c75d3 in qemu_init /mnt/sdb/qemu/softmmu/vl.c:4438\n    #7 0x55a046a3d811 in main /mnt/sdb/qemu/softmmu/main.c:48\n    #8 0x7fb7a8417872 in __libc_start_main (/lib64/libc.so.6+0x23872)\n    #9 0x55a04536b26d in _start (/mnt/sdb/qemu/build/x86_64-softmmu/qemu-system-x86_64+0x286926d)\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nMessage-Id: <20200420102727.17339-1-pannengyuan@huawei.com>\nReviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>\nSigned-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>",
        "before_after_code_files": [
          "migration/rdma.c||migration/rdma.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "migration/rdma.c||migration/rdma.c": [
          "File: migration/rdma.c -> migration/rdma.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4056:     return;",
          "4057: err:",
          "4058:     error_propagate(errp, local_err);",
          "4059:     g_free(rdma);",
          "4060:     g_free(rdma_return_path);",
          "4061: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4059:     g_free(rdma->host);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "de2749bcb2459d0722022fb70c70310a04413fc1",
      "candidate_info": {
        "commit_hash": "de2749bcb2459d0722022fb70c70310a04413fc1",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/de2749bcb2459d0722022fb70c70310a04413fc1",
        "files": [
          "tests/acceptance/boot_linux_console.py"
        ],
        "message": "tests/boot_linux_console: Add a SD card test for the OrangePi PC board\n\nThe kernel image and DeviceTree blob are built by the Armbian\nproject (based on Debian):\nhttps://www.armbian.com/orange-pi-pc/\n\nThe SD image is from the kernelci.org project:\nhttps://kernelci.org/faq/#the-code\n\nIf ARM is a target being built, \"make check-acceptance\" will\nautomatically include this test by the use of the \"arch:arm\" tags.\n\nAlternatively, this test can be run using:\n\n  $ avocado --show=console run -t machine:orangepi-pc tests/acceptance/boot_linux_console.py\n  console: Uncompressing Linux... done, booting the kernel.\n  console: Booting Linux on physical CPU 0x0\n  console: Linux version 4.20.7-sunxi (root@armbian.com) (gcc version 7.2.1 20171011 (Linaro GCC 7.2-2017.11)) #5.75 SMP Fri Feb 8 09:02:10 CET 2019\n  console: CPU: ARMv7 Processor [410fc075] revision 5 (ARMv7), cr=50c5387d\n  [...]\n  console: sunxi-wdt 1c20ca0.watchdog: Watchdog enabled (timeout=16 sec, nowayout=0)\n  console: sunxi-mmc 1c0f000.mmc: Linked as a consumer to regulator.2\n  console: sunxi-mmc 1c0f000.mmc: Got CD GPIO\n  console: ledtrig-cpu: registered to indicate activity on CPUs\n  console: hidraw: raw HID events driver (C) Jiri Kosina\n  console: usbcore: registered new interface driver usbhid\n  console: usbhid: USB HID core driver\n  console: Initializing XFRM netlink socket\n  console: sunxi-mmc 1c0f000.mmc: initialized, max. request size: 16384 KB\n  console: NET: Registered protocol family 10\n  console: mmc0: host does not support reading read-only switch, assuming write-enable\n  console: mmc0: Problem switching card into high-speed mode!\n  console: mmc0: new SD card at address 4567\n  console: mmcblk0: mmc0:4567 QEMU! 60.0 MiB\n  [...]\n  console: EXT4-fs (mmcblk0): mounting ext2 file system using the ext4 subsystem\n  console: EXT4-fs (mmcblk0): mounted filesystem without journal. Opts: (null)\n  console: VFS: Mounted root (ext2 filesystem) on device 179:0.\n  console: Run /sbin/init as init process\n  console: EXT4-fs (mmcblk0): re-mounted. Opts: block_validity,barrier,user_xattr,acl\n  console: Starting syslogd: OK\n  console: Starting klogd: OK\n  console: Populating /dev using udev: udevd[203]: starting version 3.2.7\n  console: /bin/sh: can't access tty; job control turned off\n  console: cat /proc/partitions\n  console: / # cat /proc/partitions\n  console: major minor  #blocks  name\n  console: 1        0       4096 ram0\n  console: 1        1       4096 ram1\n  console: 1        2       4096 ram2\n  console: 1        3       4096 ram3\n  console: 179        0      61440 mmcblk0\n  console: reboot\n  console: / # reboot\n  console: umount: devtmpfs busy - remounted read-only\n  console: EXT4-fs (mmcblk0): re-mounted. Opts: (null)\n  console: The system is going down NOW!\n  console: Sent SIGTERM to all processes\n  console: Sent SIGKILL to all processes\n  console: Requesting system reboot\n  console: reboot: Restarting system\n  JOB TIME   : 68.64 s\n\nSigned-off-by: Philippe Mathieu-Daud\u00e9 <f4bug@amsat.org>\nSigned-off-by: Niek Linnenbank <nieklinnenbank@gmail.com>\nReviewed-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nTested-by: Alex Benn\u00e9e <alex.bennee@linaro.org>\nMessage-id: 20200311221854.30370-16-nieklinnenbank@gmail.com\n[NL: rename in commit message Raspbian to Armbian, remove vm.set_machine()]\n[NL: extend test with ethernet device checks]\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
        "before_after_code_files": [
          "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/acceptance/boot_linux_console.py||tests/acceptance/boot_linux_console.py": [
          "File: tests/acceptance/boot_linux_console.py -> tests/acceptance/boot_linux_console.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "572:         exec_command_and_wait_for_pattern(self, 'reboot',",
          "573:                                                 'reboot: Restarting system')",
          "575:     def test_s390x_s390_ccw_virtio(self):",
          "576:         \"\"\"",
          "577:         :avocado: tags=arch:s390x",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "575:     def test_arm_orangepi_sd(self):",
          "576:         \"\"\"",
          "577:         :avocado: tags=arch:arm",
          "578:         :avocado: tags=machine:orangepi-pc",
          "579:         \"\"\"",
          "580:         deb_url = ('https://apt.armbian.com/pool/main/l/'",
          "581:                    'linux-4.20.7-sunxi/linux-image-dev-sunxi_5.75_armhf.deb')",
          "582:         deb_hash = '1334c29c44d984ffa05ed10de8c3361f33d78315'",
          "583:         deb_path = self.fetch_asset(deb_url, asset_hash=deb_hash)",
          "584:         kernel_path = self.extract_from_deb(deb_path,",
          "585:                                             '/boot/vmlinuz-4.20.7-sunxi')",
          "586:         dtb_path = '/usr/lib/linux-image-dev-sunxi/sun8i-h3-orangepi-pc.dtb'",
          "587:         dtb_path = self.extract_from_deb(deb_path, dtb_path)",
          "588:         rootfs_url = ('http://storage.kernelci.org/images/rootfs/buildroot/'",
          "589:                       'kci-2019.02/armel/base/rootfs.ext2.xz')",
          "590:         rootfs_hash = '692510cb625efda31640d1de0a8d60e26040f061'",
          "591:         rootfs_path_xz = self.fetch_asset(rootfs_url, asset_hash=rootfs_hash)",
          "592:         rootfs_path = os.path.join(self.workdir, 'rootfs.cpio')",
          "593:         archive.lzma_uncompress(rootfs_path_xz, rootfs_path)",
          "595:         self.vm.set_console()",
          "596:         kernel_command_line = (self.KERNEL_COMMON_COMMAND_LINE +",
          "597:                                'console=ttyS0,115200 '",
          "598:                                'root=/dev/mmcblk0 rootwait rw '",
          "599:                                'panic=-1 noreboot')",
          "600:         self.vm.add_args('-kernel', kernel_path,",
          "601:                          '-dtb', dtb_path,",
          "602:                          '-drive', 'file=' + rootfs_path + ',if=sd,format=raw',",
          "603:                          '-append', kernel_command_line,",
          "604:                          '-no-reboot')",
          "605:         self.vm.launch()",
          "606:         shell_ready = \"/bin/sh: can't access tty; job control turned off\"",
          "607:         self.wait_for_console_pattern(shell_ready)",
          "609:         exec_command_and_wait_for_pattern(self, 'cat /proc/cpuinfo',",
          "610:                                                 'Allwinner sun8i Family')",
          "611:         exec_command_and_wait_for_pattern(self, 'cat /proc/partitions',",
          "612:                                                 'mmcblk0')",
          "613:         exec_command_and_wait_for_pattern(self, 'ifconfig eth0 up',",
          "614:                                                  'eth0: Link is Up')",
          "615:         exec_command_and_wait_for_pattern(self, 'udhcpc eth0',",
          "616:             'udhcpc: lease of 10.0.2.15 obtained')",
          "617:         exec_command_and_wait_for_pattern(self, 'ping -c 3 10.0.2.2',",
          "618:             '3 packets transmitted, 3 packets received, 0% packet loss')",
          "619:         exec_command_and_wait_for_pattern(self, 'reboot',",
          "620:                                                 'reboot: Restarting system')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ad31b8af73b8c5df62bd5c82fb543e44aa856cd4",
      "candidate_info": {
        "commit_hash": "ad31b8af73b8c5df62bd5c82fb543e44aa856cd4",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/ad31b8af73b8c5df62bd5c82fb543e44aa856cd4",
        "files": [
          "migration/multifd.c"
        ],
        "message": "migration/multifd: fix memleaks in multifd_new_send_channel_async\n\nWhen error happen in multifd_new_send_channel_async, 'sioc' will not be used\nto create the multifd_send_thread. Let's free it to avoid a memleak. And also\ndo error_free after migrate_set_error() to avoid another leak in the same place.\n\nThe leak stack:\nDirect leak of 2880 byte(s) in 8 object(s) allocated from:\n    #0 0x7f20b5118ae8 in __interceptor_malloc (/lib64/libasan.so.5+0xefae8)\n    #1 0x7f20b44df1d5 in g_malloc (/lib64/libglib-2.0.so.0+0x531d5)\n    #2 0x564133bce18b in object_new_with_type /mnt/sdb/backup/qemu/qom/object.c:683\n    #3 0x564133eea950 in qio_channel_socket_new /mnt/sdb/backup/qemu/io/channel-socket.c:56\n    #4 0x5641339cfe4f in socket_send_channel_create /mnt/sdb/backup/qemu/migration/socket.c:37\n    #5 0x564133a10328 in multifd_save_setup /mnt/sdb/backup/qemu/migration/multifd.c:772\n    #6 0x5641339cebed in migrate_fd_connect /mnt/sdb/backup/qemu/migration/migration.c:3530\n    #7 0x5641339d15e4 in migration_channel_connect /mnt/sdb/backup/qemu/migration/channel.c:92\n    #8 0x5641339cf5b7 in socket_outgoing_migration /mnt/sdb/backup/qemu/migration/socket.c:108\n\nDirect leak of 384 byte(s) in 8 object(s) allocated from:\n    #0 0x7f20b5118cf0 in calloc (/lib64/libasan.so.5+0xefcf0)\n    #1 0x7f20b44df22d in g_malloc0 (/lib64/libglib-2.0.so.0+0x5322d)\n    #2 0x56413406fc17 in error_setv /mnt/sdb/backup/qemu/util/error.c:61\n    #3 0x564134070464 in error_setg_errno_internal /mnt/sdb/backup/qemu/util/error.c:109\n    #4 0x5641340851be in inet_connect_addr /mnt/sdb/backup/qemu/util/qemu-sockets.c:379\n    #5 0x5641340851be in inet_connect_saddr /mnt/sdb/backup/qemu/util/qemu-sockets.c:458\n    #6 0x5641340870ab in socket_connect /mnt/sdb/backup/qemu/util/qemu-sockets.c:1105\n    #7 0x564133eeaabf in qio_channel_socket_connect_sync /mnt/sdb/backup/qemu/io/channel-socket.c:145\n    #8 0x564133eeabf5 in qio_channel_socket_connect_worker /mnt/sdb/backup/qemu/io/channel-socket.c:168\n\nIndirect leak of 360 byte(s) in 8 object(s) allocated from:\n    #0 0x7f20b5118ae8 in __interceptor_malloc (/lib64/libasan.so.5+0xefae8)\n    #1 0x7f20af901817 in __GI___vasprintf_chk (/lib64/libc.so.6+0x10d817)\n    #2 0x7f20b451fa6c in g_vasprintf (/lib64/libglib-2.0.so.0+0x93a6c)\n    #3 0x7f20b44f8cd0 in g_strdup_vprintf (/lib64/libglib-2.0.so.0+0x6ccd0)\n    #4 0x7f20b44f8d8c in g_strdup_printf (/lib64/libglib-2.0.so.0+0x6cd8c)\n    #5 0x56413406fc86 in error_setv /mnt/sdb/backup/qemu/util/error.c:65\n    #6 0x564134070464 in error_setg_errno_internal /mnt/sdb/backup/qemu/util/error.c:109\n    #7 0x5641340851be in inet_connect_addr /mnt/sdb/backup/qemu/util/qemu-sockets.c:379\n    #8 0x5641340851be in inet_connect_saddr /mnt/sdb/backup/qemu/util/qemu-sockets.c:458\n    #9 0x5641340870ab in socket_connect /mnt/sdb/backup/qemu/util/qemu-sockets.c:1105\n    #10 0x564133eeaabf in qio_channel_socket_connect_sync /mnt/sdb/backup/qemu/io/channel-socket.c:145\n    #11 0x564133eeabf5 in qio_channel_socket_connect_worker /mnt/sdb/backup/qemu/io/channel-socket.c:168\n\nReported-by: Euler Robot <euler.robot@huawei.com>\nSigned-off-by: Pan Nengyuan <pannengyuan@huawei.com>\nMessage-Id: <20200506095416.26099-2-pannengyuan@huawei.com>\nReviewed-by: Juan Quintela <quintela@redhat.com>\nSigned-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>",
        "before_after_code_files": [
          "migration/multifd.c||migration/multifd.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "migration/multifd.c||migration/multifd.c": [
          "File: migration/multifd.c -> migration/multifd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "729:         p->quit = true;",
          "730:     } else {",
          "731:         p->c = QIO_CHANNEL(sioc);",
          "732:         qio_channel_set_delay(p->c, false);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "730:         object_unref(OBJECT(sioc));",
          "731:         error_free(local_err);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "843c4cfcf445fc3d6458ff31136c44e03dda8866",
      "candidate_info": {
        "commit_hash": "843c4cfcf445fc3d6458ff31136c44e03dda8866",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/843c4cfcf445fc3d6458ff31136c44e03dda8866",
        "files": [
          "hw/net/virtio-net.c"
        ],
        "message": "virtio-net: Fix duplex=... and speed=... error handling\n\nvirtio_net_device_realize() rejects invalid duplex and speed values.\nThe error handling is broken:\n\n    $ ../qemu/bld-sani/x86_64-softmmu/qemu-system-x86_64 -S -display none -monitor stdio\n    QEMU 4.2.93 monitor - type 'help' for more information\n    (qemu) device_add virtio-net,duplex=x\n    Error: 'duplex' must be 'half' or 'full'\n    (qemu) c\n    =================================================================\n    ==15654==ERROR: AddressSanitizer: heap-use-after-free on address 0x62e000014590 at pc 0x560b75c8dc13 bp 0x7fffdf1a6950 sp 0x7fffdf1a6940\n    READ of size 8 at 0x62e000014590 thread T0\n\t#0 0x560b75c8dc12 in object_dynamic_cast_assert /work/armbru/qemu/qom/object.c:826\n\t#1 0x560b74c38ac0 in virtio_vmstate_change /work/armbru/qemu/hw/virtio/virtio.c:3210\n\t#2 0x560b74d9765e in vm_state_notify /work/armbru/qemu/softmmu/vl.c:1271\n\t#3 0x560b7494ba72 in vm_prepare_start /work/armbru/qemu/cpus.c:2156\n\t#4 0x560b7494bacd in vm_start /work/armbru/qemu/cpus.c:2162\n\t#5 0x560b75a7d890 in qmp_cont /work/armbru/qemu/monitor/qmp-cmds.c:160\n\t#6 0x560b75a8d70a in hmp_cont /work/armbru/qemu/monitor/hmp-cmds.c:1043\n\t#7 0x560b75a799f2 in handle_hmp_command /work/armbru/qemu/monitor/hmp.c:1082\n    [...]\n\n    0x62e000014590 is located 33168 bytes inside of 42288-byte region [0x62e00000c400,0x62e000016930)\n    freed by thread T1 here:\n\t#0 0x7feadd39491f in __interceptor_free (/lib64/libasan.so.5+0x10d91f)\n\t#1 0x7feadcebcd7c in g_free (/lib64/libglib-2.0.so.0+0x55d7c)\n\t#2 0x560b75c8fd40 in object_unref /work/armbru/qemu/qom/object.c:1128\n\t#3 0x560b7498a625 in memory_region_unref /work/armbru/qemu/memory.c:1762\n\t#4 0x560b74999fa4 in do_address_space_destroy /work/armbru/qemu/memory.c:2788\n\t#5 0x560b762362fc in call_rcu_thread /work/armbru/qemu/util/rcu.c:283\n\t#6 0x560b761c8884 in qemu_thread_start /work/armbru/qemu/util/qemu-thread-posix.c:519\n\t#7 0x7fead9be34bf in start_thread (/lib64/libpthread.so.0+0x84bf)\n\n    previously allocated by thread T0 here:\n\t#0 0x7feadd394d18 in __interceptor_malloc (/lib64/libasan.so.5+0x10dd18)\n\t#1 0x7feadcebcc88 in g_malloc (/lib64/libglib-2.0.so.0+0x55c88)\n\t#2 0x560b75c8cf8a in object_new /work/armbru/qemu/qom/object.c:699\n\t#3 0x560b75010ad9 in qdev_device_add /work/armbru/qemu/qdev-monitor.c:654\n\t#4 0x560b750120c2 in qmp_device_add /work/armbru/qemu/qdev-monitor.c:805\n\t#5 0x560b75012c1b in hmp_device_add /work/armbru/qemu/qdev-monitor.c:905\n    [...]\n    ==15654==ABORTING\n\nCause: virtio_net_device_realize() neglects to bail out after setting\nthe error.  Fix that.\n\nFixes: 9473939ed7addcaaeb8fde5c093918fb7fa0919c\nCc: \"Michael S. Tsirkin\" <mst@redhat.com>\nCc: Jason Wang <jasowang@redhat.com>\nSigned-off-by: Markus Armbruster <armbru@redhat.com>\nReviewed-by: Philippe Mathieu-Daud\u00e9 <philmd@redhat.com>\nMessage-Id: <20200422130719.28225-9-armbru@redhat.com>\nAcked-by: Michael S. Tsirkin <mst@redhat.com>",
        "before_after_code_files": [
          "hw/net/virtio-net.c||hw/net/virtio-net.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "hw/net/virtio-net.c||hw/net/virtio-net.c": [
          "File: hw/net/virtio-net.c -> hw/net/virtio-net.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2947:             n->net_conf.duplex = DUPLEX_FULL;",
          "2948:         } else {",
          "2949:             error_setg(errp, \"'duplex' must be 'half' or 'full'\");",
          "2950:         }",
          "2951:         n->host_features |= (1ULL << VIRTIO_NET_F_SPEED_DUPLEX);",
          "2952:     } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2950:             return;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2956:     if (n->net_conf.speed < SPEED_UNKNOWN) {",
          "2957:         error_setg(errp, \"'speed' must be between 0 and INT_MAX\");",
          "2959:         n->host_features |= (1ULL << VIRTIO_NET_F_SPEED_DUPLEX);",
          "2960:     }",
          "",
          "[Removed Lines]",
          "2958:     } else if (n->net_conf.speed >= 0) {",
          "",
          "[Added Lines]",
          "2959:         return;",
          "2960:     }",
          "2961:     if (n->net_conf.speed >= 0) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6e57963a77df1e275a73dab4c6a7ec9a9d3468d4",
      "candidate_info": {
        "commit_hash": "6e57963a77df1e275a73dab4c6a7ec9a9d3468d4",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/6e57963a77df1e275a73dab4c6a7ec9a9d3468d4",
        "files": [
          "block.c"
        ],
        "message": "block: bdrv_set_backing_bs: fix use-after-free\n\nThere is a use-after-free possible: bdrv_unref_child() leaves\nbs->backing freed but not NULL. bdrv_attach_child may produce nested\npolling loop due to drain, than access of freed pointer is possible.\n\nI've produced the following crash on 30 iotest with modified code. It\ndoes not reproduce on master, but still seems possible:\n\n    #0  __strcmp_avx2 () at /lib64/libc.so.6\n    #1  bdrv_backing_overridden (bs=0x55c9d3cc2060) at block.c:6350\n    #2  bdrv_refresh_filename (bs=0x55c9d3cc2060) at block.c:6404\n    #3  bdrv_backing_attach (c=0x55c9d48e5520) at block.c:1063\n    #4  bdrv_replace_child_noperm\n        (child=child@entry=0x55c9d48e5520,\n        new_bs=new_bs@entry=0x55c9d3cc2060) at block.c:2290\n    #5  bdrv_replace_child\n        (child=child@entry=0x55c9d48e5520,\n        new_bs=new_bs@entry=0x55c9d3cc2060) at block.c:2320\n    #6  bdrv_root_attach_child\n        (child_bs=child_bs@entry=0x55c9d3cc2060,\n        child_name=child_name@entry=0x55c9d241d478 \"backing\",\n        child_role=child_role@entry=0x55c9d26ecee0 <child_backing>,\n        ctx=<optimized out>, perm=<optimized out>, shared_perm=21,\n        opaque=0x55c9d3c5a3d0, errp=0x7ffd117108e0) at block.c:2424\n    #7  bdrv_attach_child\n        (parent_bs=parent_bs@entry=0x55c9d3c5a3d0,\n        child_bs=child_bs@entry=0x55c9d3cc2060,\n        child_name=child_name@entry=0x55c9d241d478 \"backing\",\n        child_role=child_role@entry=0x55c9d26ecee0 <child_backing>,\n        errp=errp@entry=0x7ffd117108e0) at block.c:5876\n    #8  in bdrv_set_backing_hd\n        (bs=bs@entry=0x55c9d3c5a3d0,\n        backing_hd=backing_hd@entry=0x55c9d3cc2060,\n        errp=errp@entry=0x7ffd117108e0)\n        at block.c:2576\n    #9  stream_prepare (job=0x55c9d49d84a0) at block/stream.c:150\n    #10 job_prepare (job=0x55c9d49d84a0) at job.c:761\n    #11 job_txn_apply (txn=<optimized out>, fn=<optimized out>) at\n        job.c:145\n    #12 job_do_finalize (job=0x55c9d49d84a0) at job.c:778\n    #13 job_completed_txn_success (job=0x55c9d49d84a0) at job.c:832\n    #14 job_completed (job=0x55c9d49d84a0) at job.c:845\n    #15 job_completed (job=0x55c9d49d84a0) at job.c:836\n    #16 job_exit (opaque=0x55c9d49d84a0) at job.c:864\n    #17 aio_bh_call (bh=0x55c9d471a160) at util/async.c:117\n    #18 aio_bh_poll (ctx=ctx@entry=0x55c9d3c46720) at util/async.c:117\n    #19 aio_poll (ctx=ctx@entry=0x55c9d3c46720,\n        blocking=blocking@entry=true)\n        at util/aio-posix.c:728\n    #20 bdrv_parent_drained_begin_single (poll=true, c=0x55c9d3d558f0)\n        at block/io.c:121\n    #21 bdrv_parent_drained_begin_single (c=c@entry=0x55c9d3d558f0,\n        poll=poll@entry=true)\n        at block/io.c:114\n    #22 bdrv_replace_child_noperm\n        (child=child@entry=0x55c9d3d558f0,\n        new_bs=new_bs@entry=0x55c9d3d27300) at block.c:2258\n    #23 bdrv_replace_child\n        (child=child@entry=0x55c9d3d558f0,\n        new_bs=new_bs@entry=0x55c9d3d27300) at block.c:2320\n    #24 bdrv_root_attach_child\n        (child_bs=child_bs@entry=0x55c9d3d27300,\n        child_name=child_name@entry=0x55c9d241d478 \"backing\",\n        child_role=child_role@entry=0x55c9d26ecee0 <child_backing>,\n        ctx=<optimized out>, perm=<optimized out>, shared_perm=21,\n        opaque=0x55c9d3cc2060, errp=0x7ffd11710c60) at block.c:2424\n    #25 bdrv_attach_child\n        (parent_bs=parent_bs@entry=0x55c9d3cc2060,\n        child_bs=child_bs@entry=0x55c9d3d27300,\n        child_name=child_name@entry=0x55c9d241d478 \"backing\",\n        child_role=child_role@entry=0x55c9d26ecee0 <child_backing>,\n        errp=errp@entry=0x7ffd11710c60) at block.c:5876\n    #26 bdrv_set_backing_hd\n        (bs=bs@entry=0x55c9d3cc2060,\n        backing_hd=backing_hd@entry=0x55c9d3d27300,\n        errp=errp@entry=0x7ffd11710c60)\n        at block.c:2576\n    #27 stream_prepare (job=0x55c9d495ead0) at block/stream.c:150\n    ...\n\nSigned-off-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>\nMessage-Id: <20200316060631.30052-2-vsementsov@virtuozzo.com>\nReviewed-by: Philippe Mathieu-Daud\u00e9 <philmd@redhat.com>\nReviewed-by: John Snow <jsnow@redhat.com>\nSigned-off-by: Max Reitz <mreitz@redhat.com>",
        "before_after_code_files": [
          "block.c||block.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "block.c||block.c": [
          "File: block.c -> block.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2761:     if (bs->backing) {",
          "2762:         bdrv_unref_child(bs, bs->backing);",
          "2763:     }",
          "2765:     if (!backing_hd) {",
          "2767:         goto out;",
          "2768:     }",
          "",
          "[Removed Lines]",
          "2766:         bs->backing = NULL;",
          "",
          "[Added Lines]",
          "2763:         bs->backing = NULL;",
          "",
          "---------------"
        ]
      }
    }
  ]
}