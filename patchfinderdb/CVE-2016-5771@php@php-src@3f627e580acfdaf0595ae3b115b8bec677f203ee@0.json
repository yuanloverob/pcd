{
  "cve_id": "CVE-2016-5771",
  "cve_desc": "spl_array.c in the SPL extension in PHP before 5.5.37 and 5.6.x before 5.6.23 improperly interacts with the unserialize implementation and garbage collection, which allows remote attackers to execute arbitrary code or cause a denial of service (use-after-free and application crash) via crafted serialized data.",
  "repo": "php/php-src",
  "patch_hash": "3f627e580acfdaf0595ae3b115b8bec677f203ee",
  "patch_info": {
    "commit_hash": "3f627e580acfdaf0595ae3b115b8bec677f203ee",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/3f627e580acfdaf0595ae3b115b8bec677f203ee",
    "files": [
      "Zend/tests/gc_024.phpt",
      "ext/spl/spl_array.c",
      "ext/standard/tests/strings/bug72433.phpt"
    ],
    "message": "Fixed ##72433: Use After Free Vulnerability in PHP's GC algorithm and unserialize",
    "before_after_code_files": [
      "Zend/tests/gc_024.phpt||Zend/tests/gc_024.phpt",
      "ext/spl/spl_array.c||ext/spl/spl_array.c",
      "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt"
    ]
  },
  "patch_diff": {
    "Zend/tests/gc_024.phpt||Zend/tests/gc_024.phpt": [
      "File: Zend/tests/gc_024.phpt -> Zend/tests/gc_024.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "13: echo \"ok\\n\";",
      "14: ?>",
      "15: --EXPECT--",
      "17: ok",
      "",
      "[Removed Lines]",
      "16: int(1)",
      "",
      "[Added Lines]",
      "16: int(2)",
      "",
      "---------------"
    ],
    "ext/spl/spl_array.c||ext/spl/spl_array.c": [
      "File: ext/spl/spl_array.c -> ext/spl/spl_array.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "831: }",
      "835: {",
      "836:  spl_array_object *intern = (spl_array_object*)zend_object_store_get_object(object TSRMLS_CC);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "835: {",
      "836:  spl_array_object *intern = (spl_array_object*)zend_object_store_get_object(object TSRMLS_CC);",
      "840:  return zend_std_get_properties(object);",
      "841: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1962:  spl_handler_ArrayObject.get_properties = spl_array_get_properties;",
      "1963:  spl_handler_ArrayObject.get_debug_info = spl_array_get_debug_info;",
      "1964:  spl_handler_ArrayObject.read_property = spl_array_read_property;",
      "1965:  spl_handler_ArrayObject.write_property = spl_array_write_property;",
      "1966:  spl_handler_ArrayObject.get_property_ptr_ptr = spl_array_get_property_ptr_ptr;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1974:  spl_handler_ArrayObject.get_gc = spl_array_get_gc;",
      "",
      "---------------"
    ],
    "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt": [
      "File: ext/standard/tests/strings/bug72433.phpt -> ext/standard/tests/strings/bug72433.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #72433: Use After Free Vulnerability in PHP's GC algorithm and unserialize",
      "3: --FILE--",
      "4: <?php",
      "6: $filler = array();",
      "7: for($i = 0; $i < 100; $i++)",
      "8:  $filler[] = \"\";",
      "10: $serialized_payload = 'a:3:{i:0;r:1;i:1;r:1;i:2;C:11:\"ArrayObject\":19:{x:i:0;r:1;;m:a:0:{}}}';",
      "11: $free_me = unserialize($serialized_payload);",
      "13: $inc_ref_by_one = $free_me[2];",
      "15: gc_collect_cycles();",
      "17: $fill_freed_space_1 = \"filler_zval_1\";",
      "18: $fill_freed_space_2 = \"filler_zval_2\";",
      "19: var_dump($free_me);",
      "20: ?>",
      "21: --EXPECTF--",
      "22: array(3) {",
      "23:   [0]=>",
      "25:   [1]=>",
      "27:   [2]=>",
      "28:   object(ArrayObject)#%d (1) {",
      "29:     [\"storage\":\"ArrayObject\":private]=>",
      "31:   }",
      "32: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ed10168b30268ff533c710d6f0b31098e1d1dd5d",
      "candidate_info": {
        "commit_hash": "ed10168b30268ff533c710d6f0b31098e1d1dd5d",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/ed10168b30268ff533c710d6f0b31098e1d1dd5d",
        "files": [
          "ext/standard/tests/strings/bug72433.phpt",
          "ext/standard/tests/strings/bug72434.phpt"
        ],
        "message": "fix two remaining tests",
        "before_after_code_files": [
          "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt",
          "ext/standard/tests/strings/bug72434.phpt||ext/standard/tests/strings/bug72434.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt"
          ],
          "candidate": [
            "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt": [
          "File: ext/standard/tests/strings/bug72433.phpt -> ext/standard/tests/strings/bug72433.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: --EXPECTF--",
          "22: array(3) {",
          "23:   [0]=>",
          "25:   [1]=>",
          "27:   [2]=>",
          "28:   object(ArrayObject)#%d (1) {",
          "29:     [\"storage\":\"ArrayObject\":private]=>",
          "31:   }",
          "32: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24:   array(3) {",
          "25:     [0]=>",
          "27:     [1]=>",
          "29:     [2]=>",
          "30:     object(ArrayObject)#%d (1) {",
          "31:       [\"storage\":\"ArrayObject\":private]=>",
          "33:     }",
          "34:   }",
          "36:   array(3) {",
          "37:     [0]=>",
          "39:     [1]=>",
          "41:     [2]=>",
          "42:     object(ArrayObject)#%d (1) {",
          "43:       [\"storage\":\"ArrayObject\":private]=>",
          "45:     }",
          "46:   }",
          "50:     array(3) {",
          "51:       [0]=>",
          "53:       [1]=>",
          "55:       [2]=>",
          "57:     }",
          "",
          "---------------"
        ],
        "ext/standard/tests/strings/bug72434.phpt||ext/standard/tests/strings/bug72434.phpt": [
          "File: ext/standard/tests/strings/bug72434.phpt -> ext/standard/tests/strings/bug72434.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: debug_zval_dump($unserialized_payload[1]);",
          "27: ?>",
          "28: --EXPECTF--",
          "30:   [0]=>",
          "32:   }",
          "33: }",
          "",
          "[Removed Lines]",
          "29: array(1) refcount(1){",
          "31:   object(stdClass)#%d (0) refcount(3){",
          "",
          "[Added Lines]",
          "29: array(1) refcount(3){",
          "31:   object(stdClass)#%d (0) refcount(1){",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "305d93c7e531256feb94524f91d88d1b0cbea6b4",
      "candidate_info": {
        "commit_hash": "305d93c7e531256feb94524f91d88d1b0cbea6b4",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/305d93c7e531256feb94524f91d88d1b0cbea6b4",
        "files": [
          "ext/standard/tests/strings/bug72433.phpt",
          "ext/standard/tests/strings/bug72434.phpt"
        ],
        "message": "fix two remaining tests",
        "before_after_code_files": [
          "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt",
          "ext/standard/tests/strings/bug72434.phpt||ext/standard/tests/strings/bug72434.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt"
          ],
          "candidate": [
            "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/standard/tests/strings/bug72433.phpt||ext/standard/tests/strings/bug72433.phpt": [
          "File: ext/standard/tests/strings/bug72433.phpt -> ext/standard/tests/strings/bug72433.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: --EXPECTF--",
          "22: array(3) {",
          "23:   [0]=>",
          "25:   [1]=>",
          "27:   [2]=>",
          "28:   object(ArrayObject)#%d (1) {",
          "29:     [\"storage\":\"ArrayObject\":private]=>",
          "31:   }",
          "32: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "24:   array(3) {",
          "25:     [0]=>",
          "27:     [1]=>",
          "29:     [2]=>",
          "30:     object(ArrayObject)#%d (1) {",
          "31:       [\"storage\":\"ArrayObject\":private]=>",
          "33:     }",
          "34:   }",
          "36:   array(3) {",
          "37:     [0]=>",
          "39:     [1]=>",
          "41:     [2]=>",
          "42:     object(ArrayObject)#%d (1) {",
          "43:       [\"storage\":\"ArrayObject\":private]=>",
          "45:     }",
          "46:   }",
          "50:     array(3) {",
          "51:       [0]=>",
          "53:       [1]=>",
          "55:       [2]=>",
          "57:     }",
          "",
          "---------------"
        ],
        "ext/standard/tests/strings/bug72434.phpt||ext/standard/tests/strings/bug72434.phpt": [
          "File: ext/standard/tests/strings/bug72434.phpt -> ext/standard/tests/strings/bug72434.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: debug_zval_dump($unserialized_payload[1]);",
          "27: ?>",
          "28: --EXPECTF--",
          "30:   [0]=>",
          "32:   }",
          "33: }",
          "",
          "[Removed Lines]",
          "29: array(1) refcount(1){",
          "31:   object(stdClass)#%d (0) refcount(3){",
          "",
          "[Added Lines]",
          "29: array(1) refcount(3){",
          "31:   object(stdClass)#%d (0) refcount(1){",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7f428cae88f1294052087e6729f1ecb924b8a18d",
      "candidate_info": {
        "commit_hash": "7f428cae88f1294052087e6729f1ecb924b8a18d",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/7f428cae88f1294052087e6729f1ecb924b8a18d",
        "files": [
          "ext/spl/spl_array.c"
        ],
        "message": "fix build",
        "before_after_code_files": [
          "ext/spl/spl_array.c||ext/spl/spl_array.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c"
          ],
          "candidate": [
            "ext/spl/spl_array.c||ext/spl/spl_array.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/spl/spl_array.c||ext/spl/spl_array.c": [
          "File: ext/spl/spl_array.c -> ext/spl/spl_array.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "841: }",
          "",
          "[Removed Lines]",
          "840:  return zend_std_get_properties(object);",
          "",
          "[Added Lines]",
          "840:  return zend_std_get_properties(object TSRMLS_CC);",
          "",
          "---------------"
        ]
      }
    }
  ]
}