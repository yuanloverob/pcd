{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3c49d92b9cda0881e3fb00af364b2556174bcc04",
      "candidate_info": {
        "commit_hash": "3c49d92b9cda0881e3fb00af364b2556174bcc04",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/3c49d92b9cda0881e3fb00af364b2556174bcc04",
        "files": [
          "include/platform.h",
          "myinttypes.h"
        ],
        "message": "move contents of myinttype.h to platform.h",
        "before_after_code_files": [
          "include/platform.h||include/platform.h",
          "myinttypes.h||myinttypes.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/platform.h||include/platform.h": [
          "File: include/platform.h -> include/platform.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "21: #include <stdbool.h>",
          "22: #endif",
          "25: #include <stdbool.h>",
          "26: #endif",
          "28: #endif",
          "",
          "[Removed Lines]",
          "24: #else // not MSVC -> C99 is supported",
          "",
          "[Added Lines]",
          "25: #else",
          "32: #if defined(CAPSTONE_HAS_OSXKERNEL) || (defined(_MSC_VER) && (_MSC_VER <= 1700 || defined(_KERNEL_MODE)))",
          "35: #if defined(_MSC_VER) && (_MSC_VER <= 1700 || defined(_KERNEL_MODE))",
          "36: typedef signed char  int8_t;",
          "37: typedef signed short int16_t;",
          "38: typedef signed int   int32_t;",
          "39: typedef unsigned char  uint8_t;",
          "40: typedef unsigned short uint16_t;",
          "41: typedef unsigned int   uint32_t;",
          "42: typedef signed long long   int64_t;",
          "43: typedef unsigned long long uint64_t;",
          "44: #endif",
          "46: #define __PRI_8_LENGTH_MODIFIER__ \"hh\"",
          "47: #define __PRI_64_LENGTH_MODIFIER__ \"ll\"",
          "49: #define PRId8         __PRI_8_LENGTH_MODIFIER__ \"d\"",
          "50: #define PRIi8         __PRI_8_LENGTH_MODIFIER__ \"i\"",
          "51: #define PRIo8         __PRI_8_LENGTH_MODIFIER__ \"o\"",
          "52: #define PRIu8         __PRI_8_LENGTH_MODIFIER__ \"u\"",
          "53: #define PRIx8         __PRI_8_LENGTH_MODIFIER__ \"x\"",
          "54: #define PRIX8         __PRI_8_LENGTH_MODIFIER__ \"X\"",
          "56: #define PRId16        \"hd\"",
          "57: #define PRIi16        \"hi\"",
          "58: #define PRIo16        \"ho\"",
          "59: #define PRIu16        \"hu\"",
          "60: #define PRIx16        \"hx\"",
          "61: #define PRIX16        \"hX\"",
          "63: #if defined(_MSC_VER) && _MSC_VER <= 1700",
          "64: #define PRId32        \"ld\"",
          "65: #define PRIi32        \"li\"",
          "66: #define PRIo32        \"lo\"",
          "67: #define PRIu32        \"lu\"",
          "68: #define PRIx32        \"lx\"",
          "69: #define PRIX32        \"lX\"",
          "70: #else // OSX",
          "71: #define PRId32        \"d\"",
          "72: #define PRIi32        \"i\"",
          "73: #define PRIo32        \"o\"",
          "74: #define PRIu32        \"u\"",
          "75: #define PRIx32        \"x\"",
          "76: #define PRIX32        \"X\"",
          "77: #endif",
          "79: #define PRId64        __PRI_64_LENGTH_MODIFIER__ \"d\"",
          "80: #define PRIi64        __PRI_64_LENGTH_MODIFIER__ \"i\"",
          "81: #define PRIo64        __PRI_64_LENGTH_MODIFIER__ \"o\"",
          "82: #define PRIu64        __PRI_64_LENGTH_MODIFIER__ \"u\"",
          "83: #define PRIx64        __PRI_64_LENGTH_MODIFIER__ \"x\"",
          "84: #define PRIX64        __PRI_64_LENGTH_MODIFIER__ \"X\"",
          "86: #else",
          "88: #include <inttypes.h>",
          "89: #endif",
          "",
          "---------------"
        ],
        "myinttypes.h||myinttypes.h": [
          "File: myinttypes.h -> myinttypes.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: #ifndef CS_MYINTTYPES_H",
          "5: #define CS_MYINTTYPES_H",
          "65: #endif",
          "",
          "[Removed Lines]",
          "7: #if defined(CAPSTONE_HAS_OSXKERNEL) || (defined(_MSC_VER) && (_MSC_VER <= 1700 || defined(_KERNEL_MODE)))",
          "10: #if defined(_MSC_VER) && (_MSC_VER <= 1700 || defined(_KERNEL_MODE))",
          "11: typedef signed char  int8_t;",
          "12: typedef signed short int16_t;",
          "13: typedef signed int   int32_t;",
          "14: typedef unsigned char  uint8_t;",
          "15: typedef unsigned short uint16_t;",
          "16: typedef unsigned int   uint32_t;",
          "17: typedef signed long long   int64_t;",
          "18: typedef unsigned long long uint64_t;",
          "19: #endif",
          "21: #define __PRI_8_LENGTH_MODIFIER__ \"hh\"",
          "22: #define __PRI_64_LENGTH_MODIFIER__ \"ll\"",
          "24: #define PRId8         __PRI_8_LENGTH_MODIFIER__ \"d\"",
          "25: #define PRIi8         __PRI_8_LENGTH_MODIFIER__ \"i\"",
          "26: #define PRIo8         __PRI_8_LENGTH_MODIFIER__ \"o\"",
          "27: #define PRIu8         __PRI_8_LENGTH_MODIFIER__ \"u\"",
          "28: #define PRIx8         __PRI_8_LENGTH_MODIFIER__ \"x\"",
          "29: #define PRIX8         __PRI_8_LENGTH_MODIFIER__ \"X\"",
          "31: #define PRId16        \"hd\"",
          "32: #define PRIi16        \"hi\"",
          "33: #define PRIo16        \"ho\"",
          "34: #define PRIu16        \"hu\"",
          "35: #define PRIx16        \"hx\"",
          "36: #define PRIX16        \"hX\"",
          "38: #if defined(_MSC_VER) && _MSC_VER <= 1700",
          "39: #define PRId32        \"ld\"",
          "40: #define PRIi32        \"li\"",
          "41: #define PRIo32        \"lo\"",
          "42: #define PRIu32        \"lu\"",
          "43: #define PRIx32        \"lx\"",
          "44: #define PRIX32        \"lX\"",
          "45: #else // OSX",
          "46: #define PRId32        \"d\"",
          "47: #define PRIi32        \"i\"",
          "48: #define PRIo32        \"o\"",
          "49: #define PRIu32        \"u\"",
          "50: #define PRIx32        \"x\"",
          "51: #define PRIX32        \"X\"",
          "52: #endif",
          "54: #define PRId64        __PRI_64_LENGTH_MODIFIER__ \"d\"",
          "55: #define PRIi64        __PRI_64_LENGTH_MODIFIER__ \"i\"",
          "56: #define PRIo64        __PRI_64_LENGTH_MODIFIER__ \"o\"",
          "57: #define PRIu64        __PRI_64_LENGTH_MODIFIER__ \"u\"",
          "58: #define PRIx64        __PRI_64_LENGTH_MODIFIER__ \"x\"",
          "59: #define PRIX64        __PRI_64_LENGTH_MODIFIER__ \"X\"",
          "61: #else // this system has inttypes.h by default",
          "62: #include <inttypes.h>",
          "63: #endif",
          "",
          "[Added Lines]",
          "8: #include <platform.h>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "26cb22a0ff99983c5e881b578eaadcd11c1fa408",
      "candidate_info": {
        "commit_hash": "26cb22a0ff99983c5e881b578eaadcd11c1fa408",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/26cb22a0ff99983c5e881b578eaadcd11c1fa408",
        "files": [
          "arch/ARM/ARMInstPrinter.c"
        ],
        "message": "arm: UADD8 updates flags. fix #980",
        "before_after_code_files": [
          "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/ARM/ARMInstPrinter.c||arch/ARM/ARMInstPrinter.c": [
          "File: arch/ARM/ARMInstPrinter.c -> arch/ARM/ARMInstPrinter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "266:  { ARM_INS_SUB, \"subs\" },",
          "267:  { ARM_INS_UMLAL, \"umlals\" },",
          "268:  { ARM_INS_UMULL, \"umulls\" },",
          "269: };",
          "271: void ARM_post_printer(csh ud, cs_insn *insn, char *insn_asm, MCInst *mci)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "270:  { ARM_INS_UADD8, \"uadd8\" },",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ce8a822c79ac39a7d6d1070cdfd1bd8d6f527a35",
      "candidate_info": {
        "commit_hash": "ce8a822c79ac39a7d6d1070cdfd1bd8d6f527a35",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/ce8a822c79ac39a7d6d1070cdfd1bd8d6f527a35",
        "files": [
          "arch/X86/X86DisassemblerDecoder.c"
        ],
        "message": "x86: handle f2/f3 prefix for 16bit. see issue #452",
        "before_after_code_files": [
          "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c": [
          "File: arch/X86/X86DisassemblerDecoder.c -> arch/X86/X86DisassemblerDecoder.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1238:    attrMask |= ATTR_OPSIZE;",
          "1239:   } else if (isPrefixAtLocation(insn, 0x67, insn->necessaryPrefixLocation)) {",
          "1240:    attrMask |= ATTR_ADSIZE;",
          "1242:    attrMask |= ATTR_XS;",
          "1244:    attrMask |= ATTR_XD;",
          "1245:   }",
          "1246:  }",
          "",
          "[Removed Lines]",
          "1241:   } else if (isPrefixAtLocation(insn, 0xf3, insn->necessaryPrefixLocation)) {",
          "1243:   } else if (isPrefixAtLocation(insn, 0xf2, insn->necessaryPrefixLocation)) {",
          "",
          "[Added Lines]",
          "1241:   } else if (insn->mode != MODE_16BIT && isPrefixAtLocation(insn, 0xf3, insn->necessaryPrefixLocation)) {",
          "1243:   } else if (insn->mode != MODE_16BIT && isPrefixAtLocation(insn, 0xf2, insn->necessaryPrefixLocation)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c2cb0e7d9cc6f5251598cee0b89b36eca359570e",
      "candidate_info": {
        "commit_hash": "c2cb0e7d9cc6f5251598cee0b89b36eca359570e",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c2cb0e7d9cc6f5251598cee0b89b36eca359570e",
        "files": [
          "cs.c"
        ],
        "message": "arm: reset IT block before cs_disasm(). this fixes issue #643",
        "before_after_code_files": [
          "cs.c||cs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cs.c||cs.c": [
          "File: cs.c -> cs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "467:  handle->errnum = CS_ERR_OK;",
          "469: #ifdef CAPSTONE_USE_SYS_DYN_MEM",
          "470:  if (count > 0 && count <= INSN_CACHE_SIZE)",
          "471:   cache_size = (unsigned int) count;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "470:  handle->ITBlock.size = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4a098bbd5d952cde5abc66d034bf5de12dc8f8b6",
      "candidate_info": {
        "commit_hash": "4a098bbd5d952cde5abc66d034bf5de12dc8f8b6",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/4a098bbd5d952cde5abc66d034bf5de12dc8f8b6",
        "files": [
          "bindings/java/capstone/Capstone.java"
        ],
        "message": "Fix NPE when first instruction to disassemble is broken.\n\nReturn null instead.",
        "before_after_code_files": [
          "bindings/javcapstone/Capstone.java||bindings/java/capstone/Capstone.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javcapstone/Capstone.java||bindings/java/capstone/Capstone.java": [
          "File: bindings/javcapstone/Capstone.java -> bindings/java/capstone/Capstone.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "457:     if (0 == c.intValue()) {",
          "458:      return null;",
          "459:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}