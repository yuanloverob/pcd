{
  "cve_id": "CVE-2015-1335",
  "cve_desc": "lxc-start in lxc before 1.0.8 and 1.1.x before 1.1.4 allows local container administrators to escape AppArmor confinement via a symlink attack on a (1) mount target or (2) bind mount source.",
  "repo": "lxc/lxc",
  "patch_hash": "592fd47a6245508b79fe6ac819fe6d3b2c1289be",
  "patch_info": {
    "commit_hash": "592fd47a6245508b79fe6ac819fe6d3b2c1289be",
    "repo": "lxc/lxc",
    "commit_url": "https://github.com/lxc/lxc/commit/592fd47a6245508b79fe6ac819fe6d3b2c1289be",
    "files": [
      "doc/lxc.container.conf.sgml.in",
      "src/lxc/cgfs.c",
      "src/lxc/cgmanager.c",
      "src/lxc/conf.c",
      "src/lxc/utils.c",
      "src/lxc/utils.h",
      "src/tests/Makefile.am",
      "src/tests/lxc-test-symlink"
    ],
    "message": "CVE-2015-1335: Protect container mounts against symlinks\n\nWhen a container starts up, lxc sets up the container's inital fstree\nby doing a bunch of mounting, guided by the container configuration\nfile.  The container config is owned by the admin or user on the host,\nso we do not try to guard against bad entries.  However, since the\nmount target is in the container, it's possible that the container admin\ncould divert the mount with symbolic links.  This could bypass proper\ncontainer startup (i.e. confinement of a root-owned container by the\nrestrictive apparmor policy, by diverting the required write to\n/proc/self/attr/current), or bypass the (path-based) apparmor policy\nby diverting, say, /proc to /mnt in the container.\n\nTo prevent this,\n\n1. do not allow mounts to paths containing symbolic links\n\n2. do not allow bind mounts from relative paths containing symbolic\nlinks.\n\nDetails:\n\nDefine safe_mount which ensures that the container has not inserted any\nsymbolic links into any mount targets for mounts to be done during\ncontainer setup.\n\nThe host's mount path may contain symbolic links.  As it is under the\ncontrol of the administrator, that's ok.  So safe_mount begins the check\nfor symbolic links after the rootfs->mount, by opening that directory.\n\nIt opens each directory along the path using openat() relative to the\nparent directory using O_NOFOLLOW.  When the target is reached, it\nmounts onto /proc/self/fd/<targetfd>.\n\nUse safe_mount() in mount_entry(), when mounting container proc,\nand when needed.  In particular, safe_mount() need not be used in\nany case where:\n\n1. the mount is done in the container's namespace\n2. the mount is for the container's rootfs\n3. the mount is relative to a tmpfs or proc/sysfs which we have\n   just safe_mount()ed ourselves\n\nSince we were using proc/net as a temporary placeholder for /proc/sys/net\nduring container startup, and proc/net is a symbolic link, use proc/tty\ninstead.\n\nUpdate the lxc.container.conf manpage with details about the new\nrestrictions.\n\nFinally, add a testcase to test some symbolic link possibilities.\n\nReported-by: Roman Fiedler\nSigned-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>\nAcked-by: St\u00e9phane Graber <stgraber@ubuntu.com>",
    "before_after_code_files": [
      "src/lxc/cgfs.c||src/lxc/cgfs.c",
      "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
      "src/lxc/conf.c||src/lxc/conf.c",
      "src/lxc/utils.c||src/lxc/utils.c",
      "src/lxc/utils.h||src/lxc/utils.h",
      "src/tests/Makefile.am||src/tests/Makefile.am"
    ]
  },
  "patch_diff": {
    "src/lxc/cgfs.c||src/lxc/cgfs.c": [
      "File: src/lxc/cgfs.c -> src/lxc/cgfs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1363:  if (!path)",
      "1364:   return false;",
      "1365:  snprintf(path, bufsz, \"%s/sys/fs/cgroup\", root);",
      "1367:  if (r < 0) {",
      "1368:   SYSERROR(\"could not mount tmpfs to /sys/fs/cgroup in the container\");",
      "1369:   return false;",
      "",
      "[Removed Lines]",
      "1366:  r = mount(\"cgroup_root\", path, \"tmpfs\", MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME, \"size=10240k,mode=755\");",
      "",
      "[Added Lines]",
      "1366:  r = safe_mount(\"cgroup_root\", path, \"tmpfs\",",
      "1367:    MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME,",
      "1368:    \"size=10240k,mode=755\",",
      "1369:    root);",
      "",
      "---------------"
    ],
    "src/lxc/cgmanager.c||src/lxc/cgmanager.c": [
      "File: src/lxc/cgmanager.c -> src/lxc/cgmanager.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1477:  }",
      "1481:   SYSERROR(\"Failed to mount tmpfs at %s\", cgpath);",
      "1482:   return false;",
      "1483:  }",
      "",
      "[Removed Lines]",
      "1480:  if (mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\")) {",
      "",
      "[Added Lines]",
      "1480:  if (safe_mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\", root)) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1488:   return false;",
      "1489:  }",
      "1492:   SYSERROR(\"Failed to bind mount %s to %s\", dirname, cgpath);",
      "1493:   return false;",
      "1494:  }",
      "",
      "[Removed Lines]",
      "1491:  if (mount(dirname, cgpath, \"none\", MS_BIND, 0)) {",
      "",
      "[Added Lines]",
      "1491:  if (safe_mount(dirname, cgpath, \"none\", MS_BIND, 0, root)) {",
      "",
      "---------------"
    ],
    "src/lxc/conf.c||src/lxc/conf.c": [
      "File: src/lxc/conf.c -> src/lxc/conf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "771:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"proc\",                                              \"%r/proc\",                      \"proc\",     MS_NODEV|MS_NOEXEC|MS_NOSUID,   NULL },",
      "773:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys\",                                       \"%r/proc/sys\",                  NULL,       MS_BIND,                        NULL },",
      "774:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, NULL,                                                \"%r/proc/sys\",                  NULL,       MS_REMOUNT|MS_BIND|MS_RDONLY,   NULL },",
      "776:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sysrq-trigger\",                             \"%r/proc/sysrq-trigger\",        NULL,       MS_BIND,                        NULL },",
      "777:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, NULL,                                                \"%r/proc/sysrq-trigger\",        NULL,       MS_REMOUNT|MS_BIND|MS_RDONLY,   NULL },",
      "778:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_RW,    \"proc\",                                              \"%r/proc\",                      \"proc\",     MS_NODEV|MS_NOEXEC|MS_NOSUID,   NULL },",
      "",
      "[Removed Lines]",
      "772:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys/net\",                                   \"%r/proc/net\",                  NULL,       MS_BIND,                        NULL },",
      "775:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/net\",                                       \"%r/proc/sys/net\",              NULL,       MS_MOVE,                        NULL },",
      "",
      "[Added Lines]",
      "773:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys/net\",                                   \"%r/proc/tty\",                  NULL,       MS_BIND,                        NULL },",
      "776:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/tty\",                                       \"%r/proc/sys/net\",              NULL,       MS_MOVE,                        NULL },",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "815:    }",
      "816:    mflags = add_required_remount_flags(source, destination,",
      "817:      default_mounts[i].flags);",
      "819:    saved_errno = errno;",
      "820:    if (r < 0 && errno == ENOENT) {",
      "821:     INFO(\"Mount source or target for %s on %s doesn't exist. Skipping.\", source, destination);",
      "",
      "[Removed Lines]",
      "818:    r = mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options);",
      "",
      "[Added Lines]",
      "819:    r = safe_mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options, conf->rootfs.path ? conf->rootfs.mount : NULL);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1167:   return 0;",
      "1168:  }",
      "1171:   SYSERROR(\"Failed mounting tmpfs onto %s\\n\", path);",
      "1172:   return false;",
      "1173:  }",
      "",
      "[Removed Lines]",
      "1170:  if (mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\")) {",
      "",
      "[Added Lines]",
      "1171:  if (safe_mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\",",
      "1172:     rootfs->path ? rootfs->mount : NULL)) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1252:     return -1;",
      "1253:    }",
      "1254:    fclose(pathfile);",
      "1256:     SYSERROR(\"Failed bind mounting device %s from host into container\",",
      "1257:      d->name);",
      "1258:     return -1;",
      "",
      "[Removed Lines]",
      "1255:    if (mount(hostpath, path, 0, MS_BIND, NULL) != 0) {",
      "",
      "[Added Lines]",
      "1257:    if (safe_mount(hostpath, path, 0, MS_BIND, NULL,",
      "1258:       rootfs->path ? rootfs->mount : NULL) != 0) {",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1505:   return -1;",
      "1506:  }",
      "1509:   ERROR(\"failed to mount '%s' on '%s'\", console->name, path);",
      "1510:   return -1;",
      "1511:  }",
      "",
      "[Removed Lines]",
      "1508:  if (mount(console->name, path, \"none\", MS_BIND, 0)) {",
      "",
      "[Added Lines]",
      "1511:  if (safe_mount(console->name, path, \"none\", MS_BIND, 0, rootfs->mount)) {",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1560:   return 0;",
      "1561:  }",
      "1564:   ERROR(\"failed to mount '%s' on '%s'\", console->name, lxcpath);",
      "1565:   return -1;",
      "1566:  }",
      "",
      "[Removed Lines]",
      "1563:  if (mount(console->name, lxcpath, \"none\", MS_BIND, 0)) {",
      "",
      "[Added Lines]",
      "1566:  if (safe_mount(console->name, lxcpath, \"none\", MS_BIND, 0, rootfs->mount)) {",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1711: static int mount_entry(const char *fsname, const char *target,",
      "1712:          const char *fstype, unsigned long mountflags,",
      "1714: {",
      "1715: #ifdef HAVE_STATVFS",
      "1716:  struct statvfs sb;",
      "1717: #endif",
      "1720:   if (optional) {",
      "1721:    INFO(\"failed to mount '%s' on '%s' (optional): %s\", fsname,",
      "1722:         target, strerror(errno));",
      "",
      "[Removed Lines]",
      "1713:          const char *data, int optional)",
      "1719:  if (mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data)) {",
      "",
      "[Added Lines]",
      "1716:          const char *data, int optional, const char *rootfs)",
      "1722:  if (safe_mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data, rootfs)) {",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1763: #endif",
      "1765:   if (mount(fsname, target, fstype,",
      "1767:    if (optional) {",
      "1768:     INFO(\"failed to mount '%s' on '%s' (optional): %s\",",
      "1769:       fsname, target, strerror(errno));",
      "",
      "[Removed Lines]",
      "1766:      mountflags | MS_REMOUNT, data)) {",
      "",
      "[Added Lines]",
      "1769:      mountflags | MS_REMOUNT, data) < 0) {",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1843: }",
      "1845: static inline int mount_entry_on_generic(struct mntent *mntent,",
      "1847: {",
      "1848:  unsigned long mntflags;",
      "1849:  char *mntdata;",
      "",
      "[Removed Lines]",
      "1846:                  const char* path)",
      "",
      "[Added Lines]",
      "1849:                  const char* path, const char *rootfs)",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1863:  }",
      "1865:  ret = mount_entry(mntent->mnt_fsname, path, mntent->mnt_type,",
      "1868:  free(mntdata);",
      "",
      "[Removed Lines]",
      "1866:      mntflags, mntdata, optional);",
      "",
      "[Added Lines]",
      "1869:      mntflags, mntdata, optional, rootfs);",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1873: static inline int mount_entry_on_systemfs(struct mntent *mntent)",
      "1874: {",
      "1876: }",
      "1878: static int mount_entry_on_absolute_rootfs(struct mntent *mntent,",
      "",
      "[Removed Lines]",
      "1875:   return mount_entry_on_generic(mntent, mntent->mnt_dir);",
      "",
      "[Added Lines]",
      "1878:   return mount_entry_on_generic(mntent, mntent->mnt_dir, NULL);",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1919:   return -1;",
      "1920:  }",
      "1923: }",
      "1925: static int mount_entry_on_relative_rootfs(struct mntent *mntent,",
      "",
      "[Removed Lines]",
      "1922:  return mount_entry_on_generic(mntent, path);",
      "",
      "[Added Lines]",
      "1925:  return mount_entry_on_generic(mntent, path, rootfs->mount);",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1935:   return -1;",
      "1936:  }",
      "1939: }",
      "1941: static int mount_file_entries(const struct lxc_rootfs *rootfs, FILE *file,",
      "",
      "[Removed Lines]",
      "1938:  return mount_entry_on_generic(mntent, path);",
      "",
      "[Added Lines]",
      "1941:  return mount_entry_on_generic(mntent, path, rootfs);",
      "",
      "---------------",
      "--- Hunk 14 ---",
      "[Context before]",
      "3602:   fclose(pathfile);",
      "3603:  }",
      "3606:  if (ret < 0)",
      "3607:   SYSERROR(\"Failed to bind lxc.init.static into container\");",
      "3608:  INFO(\"lxc.init.static bound into container at %s\", path);",
      "",
      "[Removed Lines]",
      "3605:  ret = mount(path, destpath, \"none\", MS_BIND, NULL);",
      "",
      "[Added Lines]",
      "3608:  ret = safe_mount(path, destpath, \"none\", MS_BIND, NULL, conf->rootfs.mount);",
      "",
      "---------------"
    ],
    "src/lxc/utils.c||src/lxc/utils.c": [
      "File: src/lxc/utils.c -> src/lxc/utils.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1404:  return ret;",
      "1405: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1414: static char *get_nextpath(char *path, int *offsetp, int fulllen)",
      "1415: {",
      "1416:  int offset = *offsetp;",
      "1418:  if (offset >= fulllen)",
      "1419:   return NULL;",
      "1421:  while (path[offset] != '\\0' && offset < fulllen)",
      "1422:   offset++;",
      "1423:  while (path[offset] == '\\0' && offset < fulllen)",
      "1424:   offset++;",
      "1427:  return (offset < fulllen) ? &path[offset] : NULL;",
      "1428: }",
      "1434: static bool is_subdir(const char *subdir, const char *dir, size_t len)",
      "1435: {",
      "1436:  size_t subdirlen = strlen(subdir);",
      "1438:  if (subdirlen < len)",
      "1439:   return false;",
      "1440:  if (strncmp(subdir, dir, len) != 0)",
      "1441:   return false;",
      "1442:  if (dir[len-1] == '/')",
      "1443:   return true;",
      "1444:  if (subdir[len] == '/' || subdirlen == len)",
      "1445:   return true;",
      "1446:  return false;",
      "1447: }",
      "1453: static int check_symlink(int fd)",
      "1454: {",
      "1455:  struct stat sb;",
      "1456:  int ret = fstat(fd, &sb);",
      "1457:  if (ret < 0)",
      "1458:   return -ENOENT;",
      "1459:  if (S_ISLNK(sb.st_mode))",
      "1460:   return -ELOOP;",
      "1461:  return 0;",
      "1462: }",
      "1470: static int open_if_safe(int dirfd, const char *nextpath)",
      "1471: {",
      "1472:  int newfd = openat(dirfd, nextpath, O_RDONLY | O_NOFOLLOW);",
      "1473:  if (newfd >= 0) // was not a symlink, all good",
      "1474:   return newfd;",
      "1476:  if (errno == ELOOP)",
      "1477:   return newfd;",
      "1479:  if (errno == EPERM || errno == EACCES) {",
      "1482:   newfd = openat(dirfd, nextpath, O_PATH | O_NOFOLLOW);",
      "1483:   if (newfd >= 0) {",
      "1488:    int ret = check_symlink(newfd);",
      "1489:    if (ret < 0) {",
      "1490:     close(newfd);",
      "1491:     newfd = ret;",
      "1492:    }",
      "1493:   }",
      "1494:  }",
      "1496:  return newfd;",
      "1497: }",
      "1512: static int open_without_symlink(const char *target, const char *prefix_skip)",
      "1513: {",
      "1514:  int curlen = 0, dirfd, fulllen, i;",
      "1515:  char *dup = NULL;",
      "1517:  fulllen = strlen(target);",
      "1520:  if (prefix_skip) {",
      "1521:   curlen = strlen(prefix_skip);",
      "1522:   if (!is_subdir(target, prefix_skip, curlen)) {",
      "1523:    ERROR(\"WHOA there - target '%s' didn't start with prefix '%s'\",",
      "1524:     target, prefix_skip);",
      "1525:    return -EINVAL;",
      "1526:   }",
      "1532:   if (curlen)",
      "1533:    curlen--;",
      "1534:  } else {",
      "1535:   prefix_skip = \"/\";",
      "1536:   curlen = 0;",
      "1537:  }",
      "1540:  if ((dup = strdup(target)) == NULL) {",
      "1541:   SYSERROR(\"Out of memory checking for symbolic link\");",
      "1542:   return -ENOMEM;",
      "1543:  }",
      "1544:  for (i = 0; i < fulllen; i++) {",
      "1545:   if (dup[i] == '/')",
      "1546:    dup[i] = '\\0';",
      "1547:  }",
      "1549:  dirfd = open(prefix_skip, O_RDONLY);",
      "1550:  if (dirfd < 0)",
      "1551:   goto out;",
      "1552:  while (1) {",
      "1553:   int newfd, saved_errno;",
      "1554:   char *nextpath;",
      "1556:   if ((nextpath = get_nextpath(dup, &curlen, fulllen)) == NULL)",
      "1557:    goto out;",
      "1558:   newfd = open_if_safe(dirfd, nextpath);",
      "1559:   saved_errno = errno;",
      "1560:   close(dirfd);",
      "1561:   dirfd = newfd;",
      "1562:   if (newfd < 0) {",
      "1563:    errno = saved_errno;",
      "1564:    if (errno == ELOOP)",
      "1565:     SYSERROR(\"%s in %s was a symbolic link!\", nextpath, target);",
      "1566:    else",
      "1567:     SYSERROR(\"Error examining %s in %s\", nextpath, target);",
      "1568:    goto out;",
      "1569:   }",
      "1570:  }",
      "1572: out:",
      "1573:  free(dup);",
      "1574:  return dirfd;",
      "1575: }",
      "1585: int safe_mount(const char *src, const char *dest, const char *fstype,",
      "1586:   unsigned long flags, const void *data, const char *rootfs)",
      "1587: {",
      "1588:  int srcfd = -1, destfd, ret, saved_errno;",
      "1589:  char srcbuf[50], destbuf[50]; // only needs enough for /proc/self/fd/<fd>",
      "1590:  const char *mntsrc = src;",
      "1592:  if (!rootfs)",
      "1593:   rootfs = \"\";",
      "1596:  if (flags & MS_BIND && src && src[0] != '/') {",
      "1597:   INFO(\"this is a relative bind mount\");",
      "1598:   srcfd = open_without_symlink(src, NULL);",
      "1599:   if (srcfd < 0)",
      "1600:    return srcfd;",
      "1601:   ret = snprintf(srcbuf, 50, \"/proc/self/fd/%d\", srcfd);",
      "1602:   if (ret < 0 || ret > 50) {",
      "1603:    close(srcfd);",
      "1604:    ERROR(\"Out of memory\");",
      "1605:    return -EINVAL;",
      "1606:   }",
      "1607:   mntsrc = srcbuf;",
      "1608:  }",
      "1610:  destfd = open_without_symlink(dest, rootfs);",
      "1611:  if (destfd < 0) {",
      "1612:   if (srcfd != -1)",
      "1613:    close(srcfd);",
      "1614:   return destfd;",
      "1615:  }",
      "1617:  ret = snprintf(destbuf, 50, \"/proc/self/fd/%d\", destfd);",
      "1618:  if (ret < 0 || ret > 50) {",
      "1619:   if (srcfd != -1)",
      "1620:    close(srcfd);",
      "1621:   close(destfd);",
      "1622:   ERROR(\"Out of memory\");",
      "1623:   return -EINVAL;",
      "1624:  }",
      "1626:  ret = mount(mntsrc, destbuf, fstype, flags, data);",
      "1627:  saved_errno = errno;",
      "1628:  if (srcfd != -1)",
      "1629:   close(srcfd);",
      "1630:  close(destfd);",
      "1631:  if (ret < 0) {",
      "1632:   errno = saved_errno;",
      "1633:   SYSERROR(\"Failed to mount %s onto %s\", src, dest);",
      "1634:   return ret;",
      "1635:  }",
      "1637:  return 0;",
      "1638: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1446:  return 0;",
      "1448: domount:",
      "1450:   return -1;",
      "1451:  INFO(\"Mounted /proc in container for security transition\");",
      "1452:  return 1;",
      "",
      "[Removed Lines]",
      "1449:  if (mount(\"proc\", path, \"proc\", 0, NULL))",
      "",
      "[Added Lines]",
      "1682:  if (safe_mount(\"proc\", path, \"proc\", 0, NULL, rootfs) < 0)",
      "",
      "---------------"
    ],
    "src/lxc/utils.h||src/lxc/utils.h": [
      "File: src/lxc/utils.h -> src/lxc/utils.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "279: int is_dir(const char *path);",
      "280: char *get_template_path(const char *t);",
      "281: int setproctitle(char *title);",
      "282: int mount_proc_if_needed(const char *rootfs);",
      "283: int null_stdfds(void);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "282: int safe_mount(const char *src, const char *dest, const char *fstype,",
      "283:   unsigned long flags, const void *data, const char *rootfs);",
      "",
      "---------------"
    ],
    "src/tests/Makefile.am||src/tests/Makefile.am": [
      "File: src/tests/Makefile.am -> src/tests/Makefile.am",
      "--- Hunk 1 ---",
      "[Context before]",
      "55:  lxc-test-apparmor-mount \\",
      "56:  lxc-test-checkpoint-restore \\",
      "57:  lxc-test-snapdeps \\",
      "58:  lxc-test-ubuntu \\",
      "59:  lxc-test-unpriv \\",
      "60:  lxc-test-usernic",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "58:  lxc-test-symlink \\",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "82:  lxc-test-cloneconfig \\",
      "83:  lxc-test-createconfig \\",
      "84:  lxc-test-snapdeps \\",
      "85:  lxc-test-ubuntu \\",
      "86:  lxc-test-unpriv \\",
      "87:  may_control.c \\",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "86:  lxc-test-symlink \\",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6de26af93d3dd87c8b21a42fdf20f30fa1c1948d",
      "candidate_info": {
        "commit_hash": "6de26af93d3dd87c8b21a42fdf20f30fa1c1948d",
        "repo": "lxc/lxc",
        "commit_url": "https://github.com/lxc/lxc/commit/6de26af93d3dd87c8b21a42fdf20f30fa1c1948d",
        "files": [
          "doc/lxc.container.conf.sgml.in",
          "src/lxc/cgfs.c",
          "src/lxc/cgmanager.c",
          "src/lxc/conf.c",
          "src/lxc/utils.c",
          "src/lxc/utils.h",
          "src/tests/Makefile.am",
          "src/tests/lxc-test-symlink"
        ],
        "message": "CVE-2015-1335: Protect container mounts against symlinks\n\nWhen a container starts up, lxc sets up the container's inital fstree\nby doing a bunch of mounting, guided by the container configuration\nfile.  The container config is owned by the admin or user on the host,\nso we do not try to guard against bad entries.  However, since the\nmount target is in the container, it's possible that the container admin\ncould divert the mount with symbolic links.  This could bypass proper\ncontainer startup (i.e. confinement of a root-owned container by the\nrestrictive apparmor policy, by diverting the required write to\n/proc/self/attr/current), or bypass the (path-based) apparmor policy\nby diverting, say, /proc to /mnt in the container.\n\nTo prevent this,\n\n1. do not allow mounts to paths containing symbolic links\n\n2. do not allow bind mounts from relative paths containing symbolic\nlinks.\n\nDetails:\n\nDefine safe_mount which ensures that the container has not inserted any\nsymbolic links into any mount targets for mounts to be done during\ncontainer setup.\n\nThe host's mount path may contain symbolic links.  As it is under the\ncontrol of the administrator, that's ok.  So safe_mount begins the check\nfor symbolic links after the rootfs->mount, by opening that directory.\n\nIt opens each directory along the path using openat() relative to the\nparent directory using O_NOFOLLOW.  When the target is reached, it\nmounts onto /proc/self/fd/<targetfd>.\n\nUse safe_mount() in mount_entry(), when mounting container proc,\nand when needed.  In particular, safe_mount() need not be used in\nany case where:\n\n1. the mount is done in the container's namespace\n2. the mount is for the container's rootfs\n3. the mount is relative to a tmpfs or proc/sysfs which we have\n   just safe_mount()ed ourselves\n\nSince we were using proc/net as a temporary placeholder for /proc/sys/net\nduring container startup, and proc/net is a symbolic link, use proc/tty\ninstead.\n\nUpdate the lxc.container.conf manpage with details about the new\nrestrictions.\n\nFinally, add a testcase to test some symbolic link possibilities.\n\nReported-by: Roman Fiedler\nSigned-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>\nAcked-by: St\u00e9phane Graber <stgraber@ubuntu.com>",
        "before_after_code_files": [
          "src/lxc/cgfs.c||src/lxc/cgfs.c",
          "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
          "src/lxc/conf.c||src/lxc/conf.c",
          "src/lxc/utils.c||src/lxc/utils.c",
          "src/lxc/utils.h||src/lxc/utils.h",
          "src/tests/Makefile.am||src/tests/Makefile.am"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/lxc/cgfs.c||src/lxc/cgfs.c",
            "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
            "src/lxc/conf.c||src/lxc/conf.c",
            "src/lxc/utils.c||src/lxc/utils.c",
            "src/lxc/utils.h||src/lxc/utils.h",
            "src/tests/Makefile.am||src/tests/Makefile.am"
          ],
          "candidate": [
            "src/lxc/cgfs.c||src/lxc/cgfs.c",
            "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
            "src/lxc/conf.c||src/lxc/conf.c",
            "src/lxc/utils.c||src/lxc/utils.c",
            "src/lxc/utils.h||src/lxc/utils.h",
            "src/tests/Makefile.am||src/tests/Makefile.am"
          ]
        }
      },
      "candidate_diff": {
        "src/lxc/cgfs.c||src/lxc/cgfs.c": [
          "File: src/lxc/cgfs.c -> src/lxc/cgfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1363:  if (!path)",
          "1364:   return false;",
          "1365:  snprintf(path, bufsz, \"%s/sys/fs/cgroup\", root);",
          "1367:  if (r < 0) {",
          "1368:   SYSERROR(\"could not mount tmpfs to /sys/fs/cgroup in the container\");",
          "1369:   return false;",
          "",
          "[Removed Lines]",
          "1366:  r = mount(\"cgroup_root\", path, \"tmpfs\", MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME, \"size=10240k,mode=755\");",
          "",
          "[Added Lines]",
          "1366:  r = safe_mount(\"cgroup_root\", path, \"tmpfs\",",
          "1367:    MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME,",
          "1368:    \"size=10240k,mode=755\",",
          "1369:    root);",
          "",
          "---------------"
        ],
        "src/lxc/cgmanager.c||src/lxc/cgmanager.c": [
          "File: src/lxc/cgmanager.c -> src/lxc/cgmanager.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1477:  }",
          "1481:   SYSERROR(\"Failed to mount tmpfs at %s\", cgpath);",
          "1482:   return false;",
          "1483:  }",
          "",
          "[Removed Lines]",
          "1480:  if (mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\")) {",
          "",
          "[Added Lines]",
          "1480:  if (safe_mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\", root)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1488:   return false;",
          "1489:  }",
          "1492:   SYSERROR(\"Failed to bind mount %s to %s\", dirname, cgpath);",
          "1493:   return false;",
          "1494:  }",
          "",
          "[Removed Lines]",
          "1491:  if (mount(dirname, cgpath, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1491:  if (safe_mount(dirname, cgpath, \"none\", MS_BIND, 0, root)) {",
          "",
          "---------------"
        ],
        "src/lxc/conf.c||src/lxc/conf.c": [
          "File: src/lxc/conf.c -> src/lxc/conf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "765:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"proc\",                                              \"%r/proc\",                      \"proc\",     MS_NODEV|MS_NOEXEC|MS_NOSUID,   NULL },",
          "767:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys\",                                       \"%r/proc/sys\",                  NULL,       MS_BIND,                        NULL },",
          "768:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, NULL,                                                \"%r/proc/sys\",                  NULL,       MS_REMOUNT|MS_BIND|MS_RDONLY,   NULL },",
          "770:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sysrq-trigger\",                             \"%r/proc/sysrq-trigger\",        NULL,       MS_BIND,                        NULL },",
          "771:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, NULL,                                                \"%r/proc/sysrq-trigger\",        NULL,       MS_REMOUNT|MS_BIND|MS_RDONLY,   NULL },",
          "772:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_RW,    \"proc\",                                              \"%r/proc\",                      \"proc\",     MS_NODEV|MS_NOEXEC|MS_NOSUID,   NULL },",
          "",
          "[Removed Lines]",
          "766:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys/net\",                                   \"%r/proc/net\",                  NULL,       MS_BIND,                        NULL },",
          "769:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/net\",                                       \"%r/proc/sys/net\",              NULL,       MS_MOVE,                        NULL },",
          "",
          "[Added Lines]",
          "767:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/sys/net\",                                   \"%r/proc/tty\",                  NULL,       MS_BIND,                        NULL },",
          "770:   { LXC_AUTO_PROC_MASK, LXC_AUTO_PROC_MIXED, \"%r/proc/tty\",                                       \"%r/proc/sys/net\",              NULL,       MS_MOVE,                        NULL },",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "809:    }",
          "810:    mflags = add_required_remount_flags(source, destination,",
          "811:      default_mounts[i].flags);",
          "813:    saved_errno = errno;",
          "814:    if (r < 0 && errno == ENOENT) {",
          "815:     INFO(\"Mount source or target for %s on %s doesn't exist. Skipping.\", source, destination);",
          "",
          "[Removed Lines]",
          "812:    r = mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options);",
          "",
          "[Added Lines]",
          "813:    r = safe_mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options, conf->rootfs.path ? conf->rootfs.mount : NULL);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1161:   return 0;",
          "1162:  }",
          "1165:   SYSERROR(\"Failed mounting tmpfs onto %s\\n\", path);",
          "1166:   return false;",
          "1167:  }",
          "",
          "[Removed Lines]",
          "1164:  if (mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\")) {",
          "",
          "[Added Lines]",
          "1165:  if (safe_mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\",",
          "1166:     rootfs->path ? rootfs->mount : NULL)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1246:     return -1;",
          "1247:    }",
          "1248:    fclose(pathfile);",
          "1250:     SYSERROR(\"Failed bind mounting device %s from host into container\",",
          "1251:      d->name);",
          "1252:     return -1;",
          "",
          "[Removed Lines]",
          "1249:    if (mount(hostpath, path, 0, MS_BIND, NULL) != 0) {",
          "",
          "[Added Lines]",
          "1251:    if (safe_mount(hostpath, path, 0, MS_BIND, NULL,",
          "1252:       rootfs->path ? rootfs->mount : NULL) != 0) {",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1499:   return -1;",
          "1500:  }",
          "1503:   ERROR(\"failed to mount '%s' on '%s'\", console->name, path);",
          "1504:   return -1;",
          "1505:  }",
          "",
          "[Removed Lines]",
          "1502:  if (mount(console->name, path, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1505:  if (safe_mount(console->name, path, \"none\", MS_BIND, 0, rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1554:   return 0;",
          "1555:  }",
          "1558:   ERROR(\"failed to mount '%s' on '%s'\", console->name, lxcpath);",
          "1559:   return -1;",
          "1560:  }",
          "",
          "[Removed Lines]",
          "1557:  if (mount(console->name, lxcpath, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1560:  if (safe_mount(console->name, lxcpath, \"none\", MS_BIND, 0, rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1705: static int mount_entry(const char *fsname, const char *target,",
          "1706:          const char *fstype, unsigned long mountflags,",
          "1708: {",
          "1709: #ifdef HAVE_STATVFS",
          "1710:  struct statvfs sb;",
          "1711: #endif",
          "1714:   if (optional) {",
          "1715:    INFO(\"failed to mount '%s' on '%s' (optional): %s\", fsname,",
          "1716:         target, strerror(errno));",
          "",
          "[Removed Lines]",
          "1707:          const char *data, int optional)",
          "1713:  if (mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data)) {",
          "",
          "[Added Lines]",
          "1710:          const char *data, int optional, const char *rootfs)",
          "1716:  if (safe_mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data, rootfs)) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1757: #endif",
          "1759:   if (mount(fsname, target, fstype,",
          "1761:    if (optional) {",
          "1762:     INFO(\"failed to mount '%s' on '%s' (optional): %s\",",
          "1763:       fsname, target, strerror(errno));",
          "",
          "[Removed Lines]",
          "1760:      mountflags | MS_REMOUNT, data)) {",
          "",
          "[Added Lines]",
          "1763:      mountflags | MS_REMOUNT, data) < 0) {",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1837: }",
          "1839: static inline int mount_entry_on_generic(struct mntent *mntent,",
          "1841: {",
          "1842:  unsigned long mntflags;",
          "1843:  char *mntdata;",
          "",
          "[Removed Lines]",
          "1840:                  const char* path)",
          "",
          "[Added Lines]",
          "1843:                  const char* path, const char *rootfs)",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1860:  }",
          "1862:  ret = mount_entry(mntent->mnt_fsname, path, mntent->mnt_type,",
          "1865:  free(mntdata);",
          "",
          "[Removed Lines]",
          "1863:      mntflags, mntdata, optional);",
          "",
          "[Added Lines]",
          "1866:      mntflags, mntdata, optional, rootfs);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1870: static inline int mount_entry_on_systemfs(struct mntent *mntent)",
          "1871: {",
          "1873: }",
          "1875: static int mount_entry_on_absolute_rootfs(struct mntent *mntent,",
          "",
          "[Removed Lines]",
          "1872:   return mount_entry_on_generic(mntent, mntent->mnt_dir);",
          "",
          "[Added Lines]",
          "1875:   return mount_entry_on_generic(mntent, mntent->mnt_dir, NULL);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "1916:   return -1;",
          "1917:  }",
          "1920: }",
          "1922: static int mount_entry_on_relative_rootfs(struct mntent *mntent,",
          "",
          "[Removed Lines]",
          "1919:  return mount_entry_on_generic(mntent, path);",
          "",
          "[Added Lines]",
          "1922:  return mount_entry_on_generic(mntent, path, rootfs->mount);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "1932:   return -1;",
          "1933:  }",
          "1936: }",
          "1938: static int mount_file_entries(const struct lxc_rootfs *rootfs, FILE *file,",
          "",
          "[Removed Lines]",
          "1935:  return mount_entry_on_generic(mntent, path);",
          "",
          "[Added Lines]",
          "1938:  return mount_entry_on_generic(mntent, path, rootfs);",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "3582:   fclose(pathfile);",
          "3583:  }",
          "3586:  if (ret < 0)",
          "3587:   SYSERROR(\"Failed to bind lxc.init.static into container\");",
          "3588:  INFO(\"lxc.init.static bound into container at %s\", path);",
          "",
          "[Removed Lines]",
          "3585:  ret = mount(path, destpath, \"none\", MS_BIND, NULL);",
          "",
          "[Added Lines]",
          "3588:  ret = safe_mount(path, destpath, \"none\", MS_BIND, NULL, conf->rootfs.mount);",
          "",
          "---------------"
        ],
        "src/lxc/utils.c||src/lxc/utils.c": [
          "File: src/lxc/utils.c -> src/lxc/utils.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1404:  return ret;",
          "1405: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1414: static char *get_nextpath(char *path, int *offsetp, int fulllen)",
          "1415: {",
          "1416:  int offset = *offsetp;",
          "1418:  if (offset >= fulllen)",
          "1419:   return NULL;",
          "1421:  while (path[offset] != '\\0' && offset < fulllen)",
          "1422:   offset++;",
          "1423:  while (path[offset] == '\\0' && offset < fulllen)",
          "1424:   offset++;",
          "1427:  return (offset < fulllen) ? &path[offset] : NULL;",
          "1428: }",
          "1434: static bool is_subdir(const char *subdir, const char *dir, size_t len)",
          "1435: {",
          "1436:  size_t subdirlen = strlen(subdir);",
          "1438:  if (subdirlen < len)",
          "1439:   return false;",
          "1440:  if (strncmp(subdir, dir, len) != 0)",
          "1441:   return false;",
          "1442:  if (dir[len-1] == '/')",
          "1443:   return true;",
          "1444:  if (subdir[len] == '/' || subdirlen == len)",
          "1445:   return true;",
          "1446:  return false;",
          "1447: }",
          "1453: static int check_symlink(int fd)",
          "1454: {",
          "1455:  struct stat sb;",
          "1456:  int ret = fstat(fd, &sb);",
          "1457:  if (ret < 0)",
          "1458:   return -ENOENT;",
          "1459:  if (S_ISLNK(sb.st_mode))",
          "1460:   return -ELOOP;",
          "1461:  return 0;",
          "1462: }",
          "1470: static int open_if_safe(int dirfd, const char *nextpath)",
          "1471: {",
          "1472:  int newfd = openat(dirfd, nextpath, O_RDONLY | O_NOFOLLOW);",
          "1473:  if (newfd >= 0) // was not a symlink, all good",
          "1474:   return newfd;",
          "1476:  if (errno == ELOOP)",
          "1477:   return newfd;",
          "1479:  if (errno == EPERM || errno == EACCES) {",
          "1482:   newfd = openat(dirfd, nextpath, O_PATH | O_NOFOLLOW);",
          "1483:   if (newfd >= 0) {",
          "1488:    int ret = check_symlink(newfd);",
          "1489:    if (ret < 0) {",
          "1490:     close(newfd);",
          "1491:     newfd = ret;",
          "1492:    }",
          "1493:   }",
          "1494:  }",
          "1496:  return newfd;",
          "1497: }",
          "1512: static int open_without_symlink(const char *target, const char *prefix_skip)",
          "1513: {",
          "1514:  int curlen = 0, dirfd, fulllen, i;",
          "1515:  char *dup = NULL;",
          "1517:  fulllen = strlen(target);",
          "1520:  if (prefix_skip) {",
          "1521:   curlen = strlen(prefix_skip);",
          "1522:   if (!is_subdir(target, prefix_skip, curlen)) {",
          "1523:    ERROR(\"WHOA there - target '%s' didn't start with prefix '%s'\",",
          "1524:     target, prefix_skip);",
          "1525:    return -EINVAL;",
          "1526:   }",
          "1532:   if (curlen)",
          "1533:    curlen--;",
          "1534:  } else {",
          "1535:   prefix_skip = \"/\";",
          "1536:   curlen = 0;",
          "1537:  }",
          "1540:  if ((dup = strdup(target)) == NULL) {",
          "1541:   SYSERROR(\"Out of memory checking for symbolic link\");",
          "1542:   return -ENOMEM;",
          "1543:  }",
          "1544:  for (i = 0; i < fulllen; i++) {",
          "1545:   if (dup[i] == '/')",
          "1546:    dup[i] = '\\0';",
          "1547:  }",
          "1549:  dirfd = open(prefix_skip, O_RDONLY);",
          "1550:  if (dirfd < 0)",
          "1551:   goto out;",
          "1552:  while (1) {",
          "1553:   int newfd, saved_errno;",
          "1554:   char *nextpath;",
          "1556:   if ((nextpath = get_nextpath(dup, &curlen, fulllen)) == NULL)",
          "1557:    goto out;",
          "1558:   newfd = open_if_safe(dirfd, nextpath);",
          "1559:   saved_errno = errno;",
          "1560:   close(dirfd);",
          "1561:   dirfd = newfd;",
          "1562:   if (newfd < 0) {",
          "1563:    errno = saved_errno;",
          "1564:    if (errno == ELOOP)",
          "1565:     SYSERROR(\"%s in %s was a symbolic link!\", nextpath, target);",
          "1566:    else",
          "1567:     SYSERROR(\"Error examining %s in %s\", nextpath, target);",
          "1568:    goto out;",
          "1569:   }",
          "1570:  }",
          "1572: out:",
          "1573:  free(dup);",
          "1574:  return dirfd;",
          "1575: }",
          "1585: int safe_mount(const char *src, const char *dest, const char *fstype,",
          "1586:   unsigned long flags, const void *data, const char *rootfs)",
          "1587: {",
          "1588:  int srcfd = -1, destfd, ret, saved_errno;",
          "1589:  char srcbuf[50], destbuf[50]; // only needs enough for /proc/self/fd/<fd>",
          "1590:  const char *mntsrc = src;",
          "1592:  if (!rootfs)",
          "1593:   rootfs = \"\";",
          "1596:  if (flags & MS_BIND && src && src[0] != '/') {",
          "1597:   INFO(\"this is a relative bind mount\");",
          "1598:   srcfd = open_without_symlink(src, NULL);",
          "1599:   if (srcfd < 0)",
          "1600:    return srcfd;",
          "1601:   ret = snprintf(srcbuf, 50, \"/proc/self/fd/%d\", srcfd);",
          "1602:   if (ret < 0 || ret > 50) {",
          "1603:    close(srcfd);",
          "1604:    ERROR(\"Out of memory\");",
          "1605:    return -EINVAL;",
          "1606:   }",
          "1607:   mntsrc = srcbuf;",
          "1608:  }",
          "1610:  destfd = open_without_symlink(dest, rootfs);",
          "1611:  if (destfd < 0) {",
          "1612:   if (srcfd != -1)",
          "1613:    close(srcfd);",
          "1614:   return destfd;",
          "1615:  }",
          "1617:  ret = snprintf(destbuf, 50, \"/proc/self/fd/%d\", destfd);",
          "1618:  if (ret < 0 || ret > 50) {",
          "1619:   if (srcfd != -1)",
          "1620:    close(srcfd);",
          "1621:   close(destfd);",
          "1622:   ERROR(\"Out of memory\");",
          "1623:   return -EINVAL;",
          "1624:  }",
          "1626:  ret = mount(mntsrc, destbuf, fstype, flags, data);",
          "1627:  saved_errno = errno;",
          "1628:  if (srcfd != -1)",
          "1629:   close(srcfd);",
          "1630:  close(destfd);",
          "1631:  if (ret < 0) {",
          "1632:   errno = saved_errno;",
          "1633:   SYSERROR(\"Failed to mount %s onto %s\", src, dest);",
          "1634:   return ret;",
          "1635:  }",
          "1637:  return 0;",
          "1638: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1442:  return 0;",
          "1444: domount:",
          "1446:   return -1;",
          "1447:  INFO(\"Mounted /proc in container for security transition\");",
          "1448:  return 1;",
          "",
          "[Removed Lines]",
          "1445:  if (mount(\"proc\", path, \"proc\", 0, NULL))",
          "",
          "[Added Lines]",
          "1678:  if (safe_mount(\"proc\", path, \"proc\", 0, NULL, rootfs) < 0)",
          "",
          "---------------"
        ],
        "src/lxc/utils.h||src/lxc/utils.h": [
          "File: src/lxc/utils.h -> src/lxc/utils.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "279: int is_dir(const char *path);",
          "280: char *get_template_path(const char *t);",
          "281: int setproctitle(char *title);",
          "282: int mount_proc_if_needed(const char *rootfs);",
          "283: int null_stdfds(void);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "282: int safe_mount(const char *src, const char *dest, const char *fstype,",
          "283:   unsigned long flags, const void *data, const char *rootfs);",
          "",
          "---------------"
        ],
        "src/tests/Makefile.am||src/tests/Makefile.am": [
          "File: src/tests/Makefile.am -> src/tests/Makefile.am",
          "--- Hunk 1 ---",
          "[Context before]",
          "54: bin_SCRIPTS += \\",
          "55:  lxc-test-apparmor-mount \\",
          "56:  lxc-test-checkpoint-restore \\",
          "57:  lxc-test-ubuntu \\",
          "58:  lxc-test-unpriv \\",
          "59:  lxc-test-usernic",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "57:  lxc-test-symlink \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:  lxc-test-checkpoint-restore \\",
          "81:  lxc-test-cloneconfig \\",
          "82:  lxc-test-createconfig \\",
          "83:  lxc-test-ubuntu \\",
          "84:  lxc-test-unpriv \\",
          "85:  may_control.c \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "84:  lxc-test-symlink \\",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6bbb8100c4dec4b1c71758c27104985a694a4eac",
      "candidate_info": {
        "commit_hash": "6bbb8100c4dec4b1c71758c27104985a694a4eac",
        "repo": "lxc/lxc",
        "commit_url": "https://github.com/lxc/lxc/commit/6bbb8100c4dec4b1c71758c27104985a694a4eac",
        "files": [
          "doc/lxc.container.conf.sgml.in",
          "src/lxc/cgfs.c",
          "src/lxc/cgmanager.c",
          "src/lxc/conf.c",
          "src/lxc/utils.c",
          "src/lxc/utils.h",
          "src/tests/Makefile.am",
          "src/tests/lxc-test-symlink"
        ],
        "message": "CVE-2015-1335: Protect container mounts against symlinks\n\nWhen a container starts up, lxc sets up the container's inital fstree\nby doing a bunch of mounting, guided by the container configuration\nfile.  The container config is owned by the admin or user on the host,\nso we do not try to guard against bad entries.  However, since the\nmount target is in the container, it's possible that the container admin\ncould divert the mount with symbolic links.  This could bypass proper\ncontainer startup (i.e. confinement of a root-owned container by the\nrestrictive apparmor policy, by diverting the required write to\n/proc/self/attr/current), or bypass the (path-based) apparmor policy\nby diverting, say, /proc to /mnt in the container.\n\nTo prevent this,\n\n1. do not allow mounts to paths containing symbolic links\n\n2. do not allow bind mounts from relative paths containing symbolic\nlinks.\n\nDetails:\n\nDefine safe_mount which ensures that the container has not inserted any\nsymbolic links into any mount targets for mounts to be done during\ncontainer setup.\n\nThe host's mount path may contain symbolic links.  As it is under the\ncontrol of the administrator, that's ok.  So safe_mount begins the check\nfor symbolic links after the rootfs->mount, by opening that directory.\n\nIt opens each directory along the path using openat() relative to the\nparent directory using O_NOFOLLOW.  When the target is reached, it\nmounts onto /proc/self/fd/<targetfd>.\n\nUse safe_mount() in mount_entry(), when mounting container proc,\nand when needed.  In particular, safe_mount() need not be used in\nany case where:\n\n1. the mount is done in the container's namespace\n2. the mount is for the container's rootfs\n3. the mount is relative to a tmpfs or proc/sysfs which we have\n   just safe_mount()ed ourselves\n\nSince we were using proc/net as a temporary placeholder for /proc/sys/net\nduring container startup, and proc/net is a symbolic link, use proc/tty\ninstead.\n\nUpdate the lxc.container.conf manpage with details about the new\nrestrictions.\n\nFinally, add a testcase to test some symbolic link possibilities.\n\nReported-by: Roman Fiedler\nSigned-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>\nACked-by: St\u00e9phane Graber <stgraber@ubuntu.com>",
        "before_after_code_files": [
          "src/lxc/cgfs.c||src/lxc/cgfs.c",
          "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
          "src/lxc/conf.c||src/lxc/conf.c",
          "src/lxc/utils.c||src/lxc/utils.c",
          "src/lxc/utils.h||src/lxc/utils.h",
          "src/tests/Makefile.am||src/tests/Makefile.am"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/lxc/cgfs.c||src/lxc/cgfs.c",
            "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
            "src/lxc/conf.c||src/lxc/conf.c",
            "src/lxc/utils.c||src/lxc/utils.c",
            "src/lxc/utils.h||src/lxc/utils.h",
            "src/tests/Makefile.am||src/tests/Makefile.am"
          ],
          "candidate": [
            "src/lxc/cgfs.c||src/lxc/cgfs.c",
            "src/lxc/cgmanager.c||src/lxc/cgmanager.c",
            "src/lxc/conf.c||src/lxc/conf.c",
            "src/lxc/utils.c||src/lxc/utils.c",
            "src/lxc/utils.h||src/lxc/utils.h",
            "src/tests/Makefile.am||src/tests/Makefile.am"
          ]
        }
      },
      "candidate_diff": {
        "src/lxc/cgfs.c||src/lxc/cgfs.c": [
          "File: src/lxc/cgfs.c -> src/lxc/cgfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1363:  if (!path)",
          "1364:   return false;",
          "1365:  snprintf(path, bufsz, \"%s/sys/fs/cgroup\", root);",
          "1367:  if (r < 0) {",
          "1368:   SYSERROR(\"could not mount tmpfs to /sys/fs/cgroup in the container\");",
          "1369:   return false;",
          "",
          "[Removed Lines]",
          "1366:  r = mount(\"cgroup_root\", path, \"tmpfs\", MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME, \"size=10240k,mode=755\");",
          "",
          "[Added Lines]",
          "1366:  r = safe_mount(\"cgroup_root\", path, \"tmpfs\",",
          "1367:    MS_NOSUID|MS_NODEV|MS_NOEXEC|MS_RELATIME,",
          "1368:    \"size=10240k,mode=755\",",
          "1369:    root);",
          "",
          "---------------"
        ],
        "src/lxc/cgmanager.c||src/lxc/cgmanager.c": [
          "File: src/lxc/cgmanager.c -> src/lxc/cgmanager.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1468:  }",
          "1472:   SYSERROR(\"Failed to mount tmpfs at %s\", cgpath);",
          "1473:   return false;",
          "1474:  }",
          "",
          "[Removed Lines]",
          "1471:  if (mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\")) {",
          "",
          "[Added Lines]",
          "1471:  if (safe_mount(\"cgroup\", cgpath, \"tmpfs\", 0, \"size=10000,mode=755\", root)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1479:   return false;",
          "1480:  }",
          "1483:   SYSERROR(\"Failed to bind mount %s to %s\", dirname, cgpath);",
          "1484:   return false;",
          "1485:  }",
          "",
          "[Removed Lines]",
          "1482:  if (mount(dirname, cgpath, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1482:  if (safe_mount(dirname, cgpath, \"none\", MS_BIND, 0, root)) {",
          "",
          "---------------"
        ],
        "src/lxc/conf.c||src/lxc/conf.c": [
          "File: src/lxc/conf.c -> src/lxc/conf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "795:    }",
          "796:    mflags = add_required_remount_flags(source, destination,",
          "797:      default_mounts[i].flags);",
          "799:    saved_errno = errno;",
          "800:    if (r < 0 && errno == ENOENT) {",
          "801:     INFO(\"Mount source or target for %s on %s doesn't exist. Skipping.\", source, destination);",
          "",
          "[Removed Lines]",
          "798:    r = mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options);",
          "",
          "[Added Lines]",
          "798:    r = safe_mount(source, destination, default_mounts[i].fstype, mflags, default_mounts[i].options, conf->rootfs.path ? conf->rootfs.mount : NULL);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "993:     return -1;",
          "994:    }",
          "997:     WARN(\"failed to mount '%s'->'%s'\",",
          "998:          pty_info->name, path);",
          "999:     continue;",
          "",
          "[Removed Lines]",
          "996:    if (mount(pty_info->name, lxcpath, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "996:    if (safe_mount(pty_info->name, lxcpath, \"none\", MS_BIND, 0,",
          "997:      rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1020:      close(ret);",
          "1021:     }",
          "1022:    }",
          "1024:     WARN(\"failed to mount '%s'->'%s'\",",
          "1025:       pty_info->name, path);",
          "1026:     continue;",
          "",
          "[Removed Lines]",
          "1023:    if (mount(pty_info->name, path, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1024:    if (safe_mount(pty_info->name, path, \"none\", MS_BIND, 0,",
          "1025:      rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1446:    SYSERROR(\"WARNING: Failed to create symlink '%s'->'%s'\", host_path, devtmpfs_path);",
          "1447:   }",
          "1448:   DEBUG(\"Bind mounting %s to %s\", devtmpfs_path , path );",
          "1450:  } else {",
          "1452:   if ( ! mount_check_fs( host_path, NULL ) ) {",
          "1453:    DEBUG(\"Mounting tmpfs to %s\", host_path );",
          "1455:   } else {",
          "1457:    DEBUG(\"Bind mounting %s to %s\", host_path, path );",
          "1459:   }",
          "1460:  }",
          "1461:  if (ret) {",
          "",
          "[Removed Lines]",
          "1449:   ret = mount(devtmpfs_path, path, NULL, MS_BIND, 0 );",
          "1454:    ret = mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\");",
          "1458:    ret = mount(host_path , path, NULL, MS_BIND, 0 );",
          "",
          "[Added Lines]",
          "1451:   ret = safe_mount(devtmpfs_path, path, NULL, MS_BIND, 0, rootfs->path ? rootfs->mount : NULL );",
          "1456:    ret = safe_mount(\"none\", path, \"tmpfs\", 0, \"size=100000,mode=755\", rootfs->path ? rootfs->mount : NULL);",
          "1460:    ret = safe_mount(host_path , path, NULL, MS_BIND, 0, rootfs->path ? rootfs->mount : NULL );",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1830:   return -1;",
          "1831:  }",
          "1834:   ERROR(\"failed to mount '%s' on '%s'\", console->name, path);",
          "1835:   return -1;",
          "1836:  }",
          "",
          "[Removed Lines]",
          "1833:  if (mount(console->name, path, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1835:  if (safe_mount(console->name, path, \"none\", MS_BIND, 0, rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1885:   return 0;",
          "1886:  }",
          "1889:   ERROR(\"failed to mount '%s' on '%s'\", console->name, lxcpath);",
          "1890:   return -1;",
          "1891:  }",
          "",
          "[Removed Lines]",
          "1888:  if (mount(console->name, lxcpath, \"none\", MS_BIND, 0)) {",
          "",
          "[Added Lines]",
          "1890:  if (safe_mount(console->name, lxcpath, \"none\", MS_BIND, 0, rootfs->mount)) {",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2036: static int mount_entry(const char *fsname, const char *target,",
          "2037:          const char *fstype, unsigned long mountflags,",
          "2039: {",
          "2040: #ifdef HAVE_STATVFS",
          "2041:  struct statvfs sb;",
          "2042: #endif",
          "2045:   if (optional) {",
          "2046:    INFO(\"failed to mount '%s' on '%s' (optional): %s\", fsname,",
          "2047:         target, strerror(errno));",
          "",
          "[Removed Lines]",
          "2038:          const char *data, int optional)",
          "2044:  if (mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data)) {",
          "",
          "[Added Lines]",
          "2040:          const char *data, int optional, const char *rootfs)",
          "2046:  if (safe_mount(fsname, target, fstype, mountflags & ~MS_REMOUNT, data, rootfs)) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2168: }",
          "2170: static inline int mount_entry_on_generic(struct mntent *mntent,",
          "2172: {",
          "2173:  unsigned long mntflags;",
          "2174:  char *mntdata;",
          "",
          "[Removed Lines]",
          "2171:                  const char* path)",
          "",
          "[Added Lines]",
          "2173:                  const char* path, const char *rootfs)",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2191:  }",
          "2193:  ret = mount_entry(mntent->mnt_fsname, path, mntent->mnt_type,",
          "2196:  free(mntdata);",
          "",
          "[Removed Lines]",
          "2194:      mntflags, mntdata, optional);",
          "",
          "[Added Lines]",
          "2196:      mntflags, mntdata, optional, rootfs);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2201: static inline int mount_entry_on_systemfs(struct mntent *mntent)",
          "2202: {",
          "2204: }",
          "2206: static int mount_entry_on_absolute_rootfs(struct mntent *mntent,",
          "",
          "[Removed Lines]",
          "2203:   return mount_entry_on_generic(mntent, mntent->mnt_dir);",
          "",
          "[Added Lines]",
          "2205:   return mount_entry_on_generic(mntent, mntent->mnt_dir, NULL);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2247:   return -1;",
          "2248:  }",
          "2251: }",
          "2253: static int mount_entry_on_relative_rootfs(struct mntent *mntent,",
          "",
          "[Removed Lines]",
          "2250:  return mount_entry_on_generic(mntent, path);",
          "",
          "[Added Lines]",
          "2252:  return mount_entry_on_generic(mntent, path, rootfs->mount);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2263:   return -1;",
          "2264:  }",
          "2267: }",
          "2269: static int mount_file_entries(const struct lxc_rootfs *rootfs, FILE *file,",
          "",
          "[Removed Lines]",
          "2266:  return mount_entry_on_generic(mntent, path);",
          "",
          "[Added Lines]",
          "2268:  return mount_entry_on_generic(mntent, path, rootfs);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "3924:  return 0;",
          "3926: domount:",
          "3928:   return -1;",
          "3929:  INFO(\"Mounted /proc in container for security transition\");",
          "3930:  return 1;",
          "",
          "[Removed Lines]",
          "3927:  if (mount(\"proc\", path, \"proc\", 0, NULL))",
          "",
          "[Added Lines]",
          "3929:  if (safe_mount(\"proc\", path, \"proc\", 0, NULL, rootfs))",
          "",
          "---------------"
        ],
        "src/lxc/utils.c||src/lxc/utils.c": [
          "File: src/lxc/utils.c -> src/lxc/utils.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1145:  close(fd);",
          "1146:  return ret;",
          "1147: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1156: static char *get_nextpath(char *path, int *offsetp, int fulllen)",
          "1157: {",
          "1158:  int offset = *offsetp;",
          "1160:  if (offset >= fulllen)",
          "1161:   return NULL;",
          "1163:  while (path[offset] != '\\0' && offset < fulllen)",
          "1164:   offset++;",
          "1165:  while (path[offset] == '\\0' && offset < fulllen)",
          "1166:   offset++;",
          "1169:  return (offset < fulllen) ? &path[offset] : NULL;",
          "1170: }",
          "1176: static bool is_subdir(const char *subdir, const char *dir, size_t len)",
          "1177: {",
          "1178:  size_t subdirlen = strlen(subdir);",
          "1180:  if (subdirlen < len)",
          "1181:   return false;",
          "1182:  if (strncmp(subdir, dir, len) != 0)",
          "1183:   return false;",
          "1184:  if (dir[len-1] == '/')",
          "1185:   return true;",
          "1186:  if (subdir[len] == '/' || subdirlen == len)",
          "1187:   return true;",
          "1188:  return false;",
          "1189: }",
          "1195: static int check_symlink(int fd)",
          "1196: {",
          "1197:  struct stat sb;",
          "1198:  int ret = fstat(fd, &sb);",
          "1199:  if (ret < 0)",
          "1200:   return -ENOENT;",
          "1201:  if (S_ISLNK(sb.st_mode))",
          "1202:   return -ELOOP;",
          "1203:  return 0;",
          "1204: }",
          "1212: static int open_if_safe(int dirfd, const char *nextpath)",
          "1213: {",
          "1214:  int newfd = openat(dirfd, nextpath, O_RDONLY | O_NOFOLLOW);",
          "1215:  if (newfd >= 0) // was not a symlink, all good",
          "1216:   return newfd;",
          "1218:  if (errno == ELOOP)",
          "1219:   return newfd;",
          "1221:  if (errno == EPERM || errno == EACCES) {",
          "1224:   newfd = openat(dirfd, nextpath, O_PATH | O_NOFOLLOW);",
          "1225:   if (newfd >= 0) {",
          "1230:    int ret = check_symlink(newfd);",
          "1231:    if (ret < 0) {",
          "1232:     close(newfd);",
          "1233:     newfd = ret;",
          "1234:    }",
          "1235:   }",
          "1236:  }",
          "1238:  return newfd;",
          "1239: }",
          "1254: static int open_without_symlink(const char *target, const char *prefix_skip)",
          "1255: {",
          "1256:  int curlen = 0, dirfd, fulllen, i;",
          "1257:  char *dup = NULL;",
          "1259:  fulllen = strlen(target);",
          "1262:  if (prefix_skip) {",
          "1263:   curlen = strlen(prefix_skip);",
          "1264:   if (!is_subdir(target, prefix_skip, curlen)) {",
          "1265:    ERROR(\"WHOA there - target '%s' didn't start with prefix '%s'\",",
          "1266:     target, prefix_skip);",
          "1267:    return -EINVAL;",
          "1268:   }",
          "1274:   if (curlen)",
          "1275:    curlen--;",
          "1276:  } else {",
          "1277:   prefix_skip = \"/\";",
          "1278:   curlen = 0;",
          "1279:  }",
          "1282:  if ((dup = strdup(target)) == NULL) {",
          "1283:   SYSERROR(\"Out of memory checking for symbolic link\");",
          "1284:   return -ENOMEM;",
          "1285:  }",
          "1286:  for (i = 0; i < fulllen; i++) {",
          "1287:   if (dup[i] == '/')",
          "1288:    dup[i] = '\\0';",
          "1289:  }",
          "1291:  dirfd = open(prefix_skip, O_RDONLY);",
          "1292:  if (dirfd < 0)",
          "1293:   goto out;",
          "1294:  while (1) {",
          "1295:   int newfd, saved_errno;",
          "1296:   char *nextpath;",
          "1298:   if ((nextpath = get_nextpath(dup, &curlen, fulllen)) == NULL)",
          "1299:    goto out;",
          "1300:   newfd = open_if_safe(dirfd, nextpath);",
          "1301:   saved_errno = errno;",
          "1302:   close(dirfd);",
          "1303:   dirfd = newfd;",
          "1304:   if (newfd < 0) {",
          "1305:    errno = saved_errno;",
          "1306:    if (errno == ELOOP)",
          "1307:     SYSERROR(\"%s in %s was a symbolic link!\", nextpath, target);",
          "1308:    else",
          "1309:     SYSERROR(\"Error examining %s in %s\", nextpath, target);",
          "1310:    goto out;",
          "1311:   }",
          "1312:  }",
          "1314: out:",
          "1315:  free(dup);",
          "1316:  return dirfd;",
          "1317: }",
          "1327: int safe_mount(const char *src, const char *dest, const char *fstype,",
          "1328:   unsigned long flags, const void *data, const char *rootfs)",
          "1329: {",
          "1330:  int srcfd = -1, destfd, ret, saved_errno;",
          "1331:  char srcbuf[50], destbuf[50]; // only needs enough for /proc/self/fd/<fd>",
          "1332:  const char *mntsrc = src;",
          "1334:  if (!rootfs)",
          "1335:   rootfs = \"\";",
          "1338:  if (flags & MS_BIND && src && src[0] != '/') {",
          "1339:   INFO(\"this is a relative bind mount\");",
          "1340:   srcfd = open_without_symlink(src, NULL);",
          "1341:   if (srcfd < 0)",
          "1342:    return srcfd;",
          "1343:   ret = snprintf(srcbuf, 50, \"/proc/self/fd/%d\", srcfd);",
          "1344:   if (ret < 0 || ret > 50) {",
          "1345:    close(srcfd);",
          "1346:    ERROR(\"Out of memory\");",
          "1347:    return -EINVAL;",
          "1348:   }",
          "1349:   mntsrc = srcbuf;",
          "1350:  }",
          "1352:  destfd = open_without_symlink(dest, rootfs);",
          "1353:  if (destfd < 0) {",
          "1354:   if (srcfd != -1)",
          "1355:    close(srcfd);",
          "1356:   return destfd;",
          "1357:  }",
          "1359:  ret = snprintf(destbuf, 50, \"/proc/self/fd/%d\", destfd);",
          "1360:  if (ret < 0 || ret > 50) {",
          "1361:   if (srcfd != -1)",
          "1362:    close(srcfd);",
          "1363:   close(destfd);",
          "1364:   ERROR(\"Out of memory\");",
          "1365:   return -EINVAL;",
          "1366:  }",
          "1368:  ret = mount(mntsrc, destbuf, fstype, flags, data);",
          "1369:  saved_errno = errno;",
          "1370:  if (srcfd != -1)",
          "1371:   close(srcfd);",
          "1372:  close(destfd);",
          "1373:  if (ret < 0) {",
          "1374:   errno = saved_errno;",
          "1375:   SYSERROR(\"Failed to mount %s onto %s\", src, dest);",
          "1376:   return ret;",
          "1377:  }",
          "1379:  return 0;",
          "1380: }",
          "",
          "---------------"
        ],
        "src/lxc/utils.h||src/lxc/utils.h": [
          "File: src/lxc/utils.h -> src/lxc/utils.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "274: char *on_path(char *cmd);",
          "275: char *get_template_path(const char *t);",
          "276: int null_stdfds(void);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "278: int safe_mount(const char *src, const char *dest, const char *fstype,",
          "279:   unsigned long flags, const void *data, const char *rootfs);",
          "",
          "---------------"
        ],
        "src/tests/Makefile.am||src/tests/Makefile.am": [
          "File: src/tests/Makefile.am -> src/tests/Makefile.am",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:  lxc-test-reboot lxc-test-list lxc-test-attach lxc-test-device-add-remove \\",
          "49:  lxc-test-apparmor",
          "53: if DISTRO_UBUNTU",
          "54: bin_SCRIPTS += lxc-test-usernic lxc-test-ubuntu lxc-test-unpriv",
          "",
          "[Removed Lines]",
          "51: bin_SCRIPTS = lxc-test-autostart",
          "",
          "[Added Lines]",
          "51: bin_SCRIPTS = lxc-test-autostart lxc-test-symlink",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "71:  locktests.c \\",
          "72:  lxcpath.c \\",
          "73:  lxc-test-autostart \\",
          "74:  lxc-test-ubuntu \\",
          "75:  lxc-test-unpriv \\",
          "76:  may_control.c \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:  lxc-test-symlink \\",
          "",
          "---------------"
        ]
      }
    }
  ]
}