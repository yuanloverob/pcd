{
  "cve_id": "CVE-2016-9777",
  "cve_desc": "KVM in the Linux kernel before 4.8.12, when I/O APIC is enabled, does not properly restrict the VCPU index, which allows guest OS users to gain host OS privileges or cause a denial of service (out-of-bounds array access and host OS crash) via a crafted interrupt request, related to arch/x86/kvm/ioapic.c and arch/x86/kvm/ioapic.h.",
  "repo": "torvalds/linux",
  "patch_hash": "81cdb259fb6d8c1c4ecfeea389ff5a73c07f5755",
  "patch_info": {
    "commit_hash": "81cdb259fb6d8c1c4ecfeea389ff5a73c07f5755",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/81cdb259fb6d8c1c4ecfeea389ff5a73c07f5755",
    "files": [
      "arch/x86/kvm/ioapic.c",
      "arch/x86/kvm/ioapic.h"
    ],
    "message": "KVM: x86: fix out-of-bounds accesses of rtc_eoi map\n\nKVM was using arrays of size KVM_MAX_VCPUS with vcpu_id, but ID can be\nbigger that the maximal number of VCPUs, resulting in out-of-bounds\naccess.\n\nFound by syzkaller:\n\n  BUG: KASAN: slab-out-of-bounds in __apic_accept_irq+0xb33/0xb50 at addr [...]\n  Write of size 1 by task a.out/27101\n  CPU: 1 PID: 27101 Comm: a.out Not tainted 4.9.0-rc5+ #49\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011\n   [...]\n  Call Trace:\n   [...] __apic_accept_irq+0xb33/0xb50 arch/x86/kvm/lapic.c:905\n   [...] kvm_apic_set_irq+0x10e/0x180 arch/x86/kvm/lapic.c:495\n   [...] kvm_irq_delivery_to_apic+0x732/0xc10 arch/x86/kvm/irq_comm.c:86\n   [...] ioapic_service+0x41d/0x760 arch/x86/kvm/ioapic.c:360\n   [...] ioapic_set_irq+0x275/0x6c0 arch/x86/kvm/ioapic.c:222\n   [...] kvm_ioapic_inject_all arch/x86/kvm/ioapic.c:235\n   [...] kvm_set_ioapic+0x223/0x310 arch/x86/kvm/ioapic.c:670\n   [...] kvm_vm_ioctl_set_irqchip arch/x86/kvm/x86.c:3668\n   [...] kvm_arch_vm_ioctl+0x1a08/0x23c0 arch/x86/kvm/x86.c:3999\n   [...] kvm_vm_ioctl+0x1fa/0x1a70 arch/x86/kvm/../../../virt/kvm/kvm_main.c:3099\n\nReported-by: Dmitry Vyukov <dvyukov@google.com>\nCc: stable@vger.kernel.org\nFixes: af1bae5497b9 (\"KVM: x86: bump KVM_MAX_VCPU_ID to 1023\")\nReviewed-by: Paolo Bonzini <pbonzini@redhat.com>\nReviewed-by: David Hildenbrand <david@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
    "before_after_code_files": [
      "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c",
      "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h"
    ]
  },
  "patch_diff": {
    "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c": [
      "File: arch/x86/kvm/ioapic.c -> arch/x86/kvm/ioapic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "94: static void rtc_irq_eoi_tracking_reset(struct kvm_ioapic *ioapic)",
      "95: {",
      "96:  ioapic->rtc_status.pending_eoi = 0;",
      "98: }",
      "100: static void kvm_rtc_eoi_tracking_restore_all(struct kvm_ioapic *ioapic);",
      "",
      "[Removed Lines]",
      "97:  bitmap_zero(ioapic->rtc_status.dest_map.map, KVM_MAX_VCPUS);",
      "",
      "[Added Lines]",
      "97:  bitmap_zero(ioapic->rtc_status.dest_map.map, KVM_MAX_VCPU_ID);",
      "",
      "---------------"
    ],
    "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h": [
      "File: arch/x86/kvm/ioapic.h -> arch/x86/kvm/ioapic.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "43: struct dest_map {",
      "52: };",
      "",
      "[Removed Lines]",
      "45:  DECLARE_BITMAP(map, KVM_MAX_VCPUS);",
      "51:  u8 vectors[KVM_MAX_VCPUS];",
      "",
      "[Added Lines]",
      "45:  DECLARE_BITMAP(map, KVM_MAX_VCPU_ID);",
      "51:  u8 vectors[KVM_MAX_VCPU_ID];",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2117d5398c81554fbf803f5fd1dc55eb78216c0c",
      "candidate_info": {
        "commit_hash": "2117d5398c81554fbf803f5fd1dc55eb78216c0c",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/2117d5398c81554fbf803f5fd1dc55eb78216c0c",
        "files": [
          "arch/x86/kvm/emulate.c"
        ],
        "message": "KVM: x86: drop error recovery in em_jmp_far and em_ret_far\n\nem_jmp_far and em_ret_far assumed that setting IP can only fail in 64\nbit mode, but syzkaller proved otherwise (and SDM agrees).\nCode segment was restored upon failure, but it was left uninitialized\noutside of long mode, which could lead to a leak of host kernel stack.\nWe could have fixed that by always saving and restoring the CS, but we\ntake a simpler approach and just break any guest that manages to fail\nas the error recovery is error-prone and modern CPUs don't need emulator\nfor this.\n\nFound by syzkaller:\n\n  WARNING: CPU: 2 PID: 3668 at arch/x86/kvm/emulate.c:2217 em_ret_far+0x428/0x480\n  Kernel panic - not syncing: panic_on_warn set ...\n\n  CPU: 2 PID: 3668 Comm: syz-executor Not tainted 4.9.0-rc4+ #49\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011\n   [...]\n  Call Trace:\n   [...] __dump_stack lib/dump_stack.c:15\n   [...] dump_stack+0xb3/0x118 lib/dump_stack.c:51\n   [...] panic+0x1b7/0x3a3 kernel/panic.c:179\n   [...] __warn+0x1c4/0x1e0 kernel/panic.c:542\n   [...] warn_slowpath_null+0x2c/0x40 kernel/panic.c:585\n   [...] em_ret_far+0x428/0x480 arch/x86/kvm/emulate.c:2217\n   [...] em_ret_far_imm+0x17/0x70 arch/x86/kvm/emulate.c:2227\n   [...] x86_emulate_insn+0x87a/0x3730 arch/x86/kvm/emulate.c:5294\n   [...] x86_emulate_instruction+0x520/0x1ba0 arch/x86/kvm/x86.c:5545\n   [...] emulate_instruction arch/x86/include/asm/kvm_host.h:1116\n   [...] complete_emulated_io arch/x86/kvm/x86.c:6870\n   [...] complete_emulated_mmio+0x4e9/0x710 arch/x86/kvm/x86.c:6934\n   [...] kvm_arch_vcpu_ioctl_run+0x3b7a/0x5a90 arch/x86/kvm/x86.c:6978\n   [...] kvm_vcpu_ioctl+0x61e/0xdd0 arch/x86/kvm/../../../virt/kvm/kvm_main.c:2557\n   [...] vfs_ioctl fs/ioctl.c:43\n   [...] do_vfs_ioctl+0x18c/0x1040 fs/ioctl.c:679\n   [...] SYSC_ioctl fs/ioctl.c:694\n   [...] SyS_ioctl+0x8f/0xc0 fs/ioctl.c:685\n   [...] entry_SYSCALL_64_fastpath+0x1f/0xc2\n\nReported-by: Dmitry Vyukov <dvyukov@google.com>\nCc: stable@vger.kernel.org\nFixes: d1442d85cc30 (\"KVM: x86: Handle errors when RIP is set during far jumps\")\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
        "before_after_code_files": [
          "arch/x86/kvm/emulate.c||arch/x86/kvm/emulate.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/x86/kvm/emulate.c||arch/x86/kvm/emulate.c": [
          "File: arch/x86/kvm/emulate.c -> arch/x86/kvm/emulate.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2105: static int em_jmp_far(struct x86_emulate_ctxt *ctxt)",
          "2106: {",
          "2107:  int rc;",
          "2111:  u8 cpl = ctxt->ops->cpl(ctxt);",
          "2118:  memcpy(&sel, ctxt->src.valptr + ctxt->op_bytes, 2);",
          "2120:  rc = __load_segment_descriptor(ctxt, sel, VCPU_SREG_CS, cpl,",
          "",
          "[Removed Lines]",
          "2108:  unsigned short sel, old_sel;",
          "2109:  struct desc_struct old_desc, new_desc;",
          "2110:  const struct x86_emulate_ops *ops = ctxt->ops;",
          "2114:  if (ctxt->mode == X86EMUL_MODE_PROT64)",
          "2115:   ops->get_segment(ctxt, &old_sel, &old_desc, NULL,",
          "2116:      VCPU_SREG_CS);",
          "",
          "[Added Lines]",
          "2108:  unsigned short sel;",
          "2109:  struct desc_struct new_desc;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2124:   return rc;",
          "2126:  rc = assign_eip_far(ctxt, ctxt->src.val, &new_desc);",
          "2133:  return rc;",
          "2134: }",
          "",
          "[Removed Lines]",
          "2127:  if (rc != X86EMUL_CONTINUE) {",
          "2128:   WARN_ON(ctxt->mode != X86EMUL_MODE_PROT64);",
          "2130:   ops->set_segment(ctxt, old_sel, &old_desc, 0, VCPU_SREG_CS);",
          "2131:   return rc;",
          "2132:  }",
          "",
          "[Added Lines]",
          "2122:  if (rc != X86EMUL_CONTINUE)",
          "2123:   return X86EMUL_UNHANDLEABLE;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2189: {",
          "2190:  int rc;",
          "2191:  unsigned long eip, cs;",
          "2193:  int cpl = ctxt->ops->cpl(ctxt);",
          "2201:  rc = emulate_pop(ctxt, &eip, ctxt->op_bytes);",
          "2202:  if (rc != X86EMUL_CONTINUE)",
          "",
          "[Removed Lines]",
          "2192:  u16 old_cs;",
          "2194:  struct desc_struct old_desc, new_desc;",
          "2195:  const struct x86_emulate_ops *ops = ctxt->ops;",
          "2197:  if (ctxt->mode == X86EMUL_MODE_PROT64)",
          "2198:   ops->get_segment(ctxt, &old_cs, &old_desc, NULL,",
          "2199:      VCPU_SREG_CS);",
          "",
          "[Added Lines]",
          "2185:  struct desc_struct new_desc;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2213:  if (rc != X86EMUL_CONTINUE)",
          "2214:   return rc;",
          "2215:  rc = assign_eip_far(ctxt, eip, &new_desc);",
          "2220:  return rc;",
          "2221: }",
          "",
          "[Removed Lines]",
          "2216:  if (rc != X86EMUL_CONTINUE) {",
          "2217:   WARN_ON(ctxt->mode != X86EMUL_MODE_PROT64);",
          "2218:   ops->set_segment(ctxt, old_cs, &old_desc, 0, VCPU_SREG_CS);",
          "2219:  }",
          "",
          "[Added Lines]",
          "2203:  if (rc != X86EMUL_CONTINUE)",
          "2204:   return X86EMUL_UNHANDLEABLE;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "444fdad88f35de9fd1c130b2c4e4550671758fd2",
      "candidate_info": {
        "commit_hash": "444fdad88f35de9fd1c130b2c4e4550671758fd2",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/444fdad88f35de9fd1c130b2c4e4550671758fd2",
        "files": [
          "arch/x86/kvm/lapic.c"
        ],
        "message": "KVM: x86: fix out-of-bounds access in lapic\n\nCluster xAPIC delivery incorrectly assumed that dest_id <= 0xff.\nWith enabled KVM_X2APIC_API_USE_32BIT_IDS in KVM_CAP_X2APIC_API, a\nuserspace can send an interrupt with dest_id that results in\nout-of-bounds access.\n\nFound by syzkaller:\n\n  BUG: KASAN: slab-out-of-bounds in kvm_irq_delivery_to_apic_fast+0x11fa/0x1210 at addr ffff88003d9ca750\n  Read of size 8 by task syz-executor/22923\n  CPU: 0 PID: 22923 Comm: syz-executor Not tainted 4.9.0-rc4+ #49\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01/01/2011\n   [...]\n  Call Trace:\n   [...] __dump_stack lib/dump_stack.c:15\n   [...] dump_stack+0xb3/0x118 lib/dump_stack.c:51\n   [...] kasan_object_err+0x1c/0x70 mm/kasan/report.c:156\n   [...] print_address_description mm/kasan/report.c:194\n   [...] kasan_report_error mm/kasan/report.c:283\n   [...] kasan_report+0x231/0x500 mm/kasan/report.c:303\n   [...] __asan_report_load8_noabort+0x14/0x20 mm/kasan/report.c:329\n   [...] kvm_irq_delivery_to_apic_fast+0x11fa/0x1210 arch/x86/kvm/lapic.c:824\n   [...] kvm_irq_delivery_to_apic+0x132/0x9a0 arch/x86/kvm/irq_comm.c:72\n   [...] kvm_set_msi+0x111/0x160 arch/x86/kvm/irq_comm.c:157\n   [...] kvm_send_userspace_msi+0x201/0x280 arch/x86/kvm/../../../virt/kvm/irqchip.c:74\n   [...] kvm_vm_ioctl+0xba5/0x1670 arch/x86/kvm/../../../virt/kvm/kvm_main.c:3015\n   [...] vfs_ioctl fs/ioctl.c:43\n   [...] do_vfs_ioctl+0x18c/0x1040 fs/ioctl.c:679\n   [...] SYSC_ioctl fs/ioctl.c:694\n   [...] SyS_ioctl+0x8f/0xc0 fs/ioctl.c:685\n   [...] entry_SYSCALL_64_fastpath+0x1f/0xc2\n\nReported-by: Dmitry Vyukov <dvyukov@google.com>\nCc: stable@vger.kernel.org\nFixes: e45115b62f9a (\"KVM: x86: use physical LAPIC array for logical x2APIC\")\nReviewed-by: Paolo Bonzini <pbonzini@redhat.com>\nSigned-off-by: Radim Kr\u010dm\u00e1\u0159 <rkrcmar@redhat.com>",
        "before_after_code_files": [
          "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c": [
          "File: arch/x86/kvm/lapic.c -> arch/x86/kvm/lapic.c"
        ]
      }
    },
    {
      "candidate_hash": "9e4aabe2bb3454c83dac8139cf9974503ee044db",
      "candidate_info": {
        "commit_hash": "9e4aabe2bb3454c83dac8139cf9974503ee044db",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/9e4aabe2bb3454c83dac8139cf9974503ee044db",
        "files": [
          "arch/x86/kvm/ioapic.c",
          "arch/x86/kvm/ioapic.h",
          "arch/x86/kvm/irq_comm.c",
          "arch/x86/kvm/lapic.c",
          "arch/x86/kvm/lapic.h"
        ],
        "message": "kvm: x86: Convert ioapic->rtc_status.dest_map to a struct\n\nCurrently this is a bitmap which tracks which CPUs we expect\nan EOI from. Move this bitmap to a struct so that we can\ntrack additional information there.\n\nSigned-off-by: Joerg Roedel <jroedel@suse.de>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
        "before_after_code_files": [
          "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c",
          "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h",
          "arch/x86/kvm/irq_comm.c||arch/x86/kvm/irq_comm.c",
          "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c",
          "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c",
            "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h"
          ],
          "candidate": [
            "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c",
            "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kvm/ioapic.c||arch/x86/kvm/ioapic.c": [
          "File: arch/x86/kvm/ioapic.c -> arch/x86/kvm/ioapic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "94: static void rtc_irq_eoi_tracking_reset(struct kvm_ioapic *ioapic)",
          "95: {",
          "96:  ioapic->rtc_status.pending_eoi = 0;",
          "98: }",
          "100: static void kvm_rtc_eoi_tracking_restore_all(struct kvm_ioapic *ioapic);",
          "",
          "[Removed Lines]",
          "97:  bitmap_zero(ioapic->rtc_status.dest_map, KVM_MAX_VCPUS);",
          "",
          "[Added Lines]",
          "97:  bitmap_zero(ioapic->rtc_status.dest_map.map, KVM_MAX_VCPUS);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "117:   return;",
          "119:  new_val = kvm_apic_pending_eoi(vcpu, e->fields.vector);",
          "122:  if (new_val == old_val)",
          "123:   return;",
          "125:  if (new_val) {",
          "127:   ioapic->rtc_status.pending_eoi++;",
          "128:  } else {",
          "130:   ioapic->rtc_status.pending_eoi--;",
          "131:   rtc_status_pending_eoi_check_valid(ioapic);",
          "132:  }",
          "",
          "[Removed Lines]",
          "120:  old_val = test_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map);",
          "126:   __set_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map);",
          "129:   __clear_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map);",
          "",
          "[Added Lines]",
          "120:  old_val = test_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map.map);",
          "126:   __set_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map.map);",
          "129:   __clear_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map.map);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "157: static void rtc_irq_eoi(struct kvm_ioapic *ioapic, struct kvm_vcpu *vcpu)",
          "158: {",
          "160:   --ioapic->rtc_status.pending_eoi;",
          "161:   rtc_status_pending_eoi_check_valid(ioapic);",
          "162:  }",
          "",
          "[Removed Lines]",
          "159:  if (test_and_clear_bit(vcpu->vcpu_id, ioapic->rtc_status.dest_map)) {",
          "",
          "[Added Lines]",
          "159:  if (test_and_clear_bit(vcpu->vcpu_id,",
          "160:           ioapic->rtc_status.dest_map.map)) {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "347:   BUG_ON(ioapic->rtc_status.pending_eoi != 0);",
          "348:   ret = kvm_irq_delivery_to_apic(ioapic->kvm, NULL, &irqe,",
          "350:   ioapic->rtc_status.pending_eoi = (ret < 0 ? 0 : ret);",
          "351:  } else",
          "352:   ret = kvm_irq_delivery_to_apic(ioapic->kvm, NULL, &irqe, NULL);",
          "",
          "[Removed Lines]",
          "349:     ioapic->rtc_status.dest_map);",
          "",
          "[Added Lines]",
          "350:             &ioapic->rtc_status.dest_map);",
          "",
          "---------------"
        ],
        "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h": [
          "File: arch/x86/kvm/ioapic.h -> arch/x86/kvm/ioapic.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "40: #define RTC_GSI -1U",
          "41: #endif",
          "43: struct rtc_status {",
          "44:  int pending_eoi;",
          "46: };",
          "48: union kvm_ioapic_redirect_entry {",
          "",
          "[Removed Lines]",
          "45:  DECLARE_BITMAP(dest_map, KVM_MAX_VCPUS);",
          "",
          "[Added Lines]",
          "43: struct dest_map {",
          "44:  DECLARE_BITMAP(map, KVM_MAX_VCPUS);",
          "45: };",
          "50:  struct dest_map dest_map;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "118:          int level, bool line_status);",
          "119: void kvm_ioapic_clear_all(struct kvm_ioapic *ioapic, int irq_source_id);",
          "120: int kvm_irq_delivery_to_apic(struct kvm *kvm, struct kvm_lapic *src,",
          "122: int kvm_get_ioapic(struct kvm *kvm, struct kvm_ioapic_state *state);",
          "123: int kvm_set_ioapic(struct kvm *kvm, struct kvm_ioapic_state *state);",
          "124: void kvm_ioapic_scan_entry(struct kvm_vcpu *vcpu,",
          "",
          "[Removed Lines]",
          "121:   struct kvm_lapic_irq *irq, unsigned long *dest_map);",
          "",
          "[Added Lines]",
          "126:         struct kvm_lapic_irq *irq,",
          "127:         struct dest_map *dest_map);",
          "",
          "---------------"
        ],
        "arch/x86/kvm/irq_comm.c||arch/x86/kvm/irq_comm.c": [
          "File: arch/x86/kvm/irq_comm.c -> arch/x86/kvm/irq_comm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "54: }",
          "56: int kvm_irq_delivery_to_apic(struct kvm *kvm, struct kvm_lapic *src,",
          "58: {",
          "59:  int i, r = -1;",
          "60:  struct kvm_vcpu *vcpu, *lowest = NULL;",
          "",
          "[Removed Lines]",
          "57:   struct kvm_lapic_irq *irq, unsigned long *dest_map)",
          "",
          "[Added Lines]",
          "57:   struct kvm_lapic_irq *irq, struct dest_map *dest_map)",
          "",
          "---------------"
        ],
        "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c": [
          "File: arch/x86/kvm/lapic.c -> arch/x86/kvm/lapic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "486: static int __apic_accept_irq(struct kvm_lapic *apic, int delivery_mode,",
          "487:         int vector, int level, int trig_mode,",
          "490: int kvm_apic_set_irq(struct kvm_vcpu *vcpu, struct kvm_lapic_irq *irq,",
          "492: {",
          "493:  struct kvm_lapic *apic = vcpu->arch.apic;",
          "",
          "[Removed Lines]",
          "488:         unsigned long *dest_map);",
          "491:   unsigned long *dest_map)",
          "",
          "[Added Lines]",
          "488:         struct dest_map *dest_map);",
          "491:        struct dest_map *dest_map)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "695: }",
          "697: bool kvm_irq_delivery_to_apic_fast(struct kvm *kvm, struct kvm_lapic *src,",
          "699: {",
          "700:  struct kvm_apic_map *map;",
          "701:  unsigned long bitmap = 1;",
          "",
          "[Removed Lines]",
          "698:   struct kvm_lapic_irq *irq, int *r, unsigned long *dest_map)",
          "",
          "[Added Lines]",
          "698:   struct kvm_lapic_irq *irq, int *r, struct dest_map *dest_map)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "895: static int __apic_accept_irq(struct kvm_lapic *apic, int delivery_mode,",
          "896:         int vector, int level, int trig_mode,",
          "898: {",
          "899:  int result = 0;",
          "900:  struct kvm_vcpu *vcpu = apic->vcpu;",
          "",
          "[Removed Lines]",
          "897:         unsigned long *dest_map)",
          "",
          "[Added Lines]",
          "897:         struct dest_map *dest_map)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "915:   result = 1;",
          "917:   if (dest_map)",
          "920:   if (apic_test_vector(vector, apic->regs + APIC_TMR) != !!trig_mode) {",
          "921:    if (trig_mode)",
          "",
          "[Removed Lines]",
          "918:    __set_bit(vcpu->vcpu_id, dest_map);",
          "",
          "[Added Lines]",
          "918:    __set_bit(vcpu->vcpu_id, dest_map->map);",
          "",
          "---------------"
        ],
        "arch/x86/kvm/lapic.h||arch/x86/kvm/lapic.h": [
          "File: arch/x86/kvm/lapic.h -> arch/x86/kvm/lapic.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:  unsigned long pending_events;",
          "43:  unsigned int sipi_vector;",
          "44: };",
          "45: int kvm_create_lapic(struct kvm_vcpu *vcpu);",
          "46: void kvm_free_lapic(struct kvm_vcpu *vcpu);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46: struct dest_map;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "60: void __kvm_apic_update_irr(u32 *pir, void *regs);",
          "61: void kvm_apic_update_irr(struct kvm_vcpu *vcpu, u32 *pir);",
          "62: int kvm_apic_set_irq(struct kvm_vcpu *vcpu, struct kvm_lapic_irq *irq,",
          "64: int kvm_apic_local_deliver(struct kvm_lapic *apic, int lvt_type);",
          "66: bool kvm_irq_delivery_to_apic_fast(struct kvm *kvm, struct kvm_lapic *src,",
          "69: u64 kvm_get_apic_base(struct kvm_vcpu *vcpu);",
          "70: int kvm_set_apic_base(struct kvm_vcpu *vcpu, struct msr_data *msr_info);",
          "",
          "[Removed Lines]",
          "63:   unsigned long *dest_map);",
          "67:   struct kvm_lapic_irq *irq, int *r, unsigned long *dest_map);",
          "",
          "[Added Lines]",
          "66:        struct dest_map *dest_map);",
          "70:   struct kvm_lapic_irq *irq, int *r, struct dest_map *dest_map);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9daa50076f585854f0040aa8403eac020d6f5d64",
      "candidate_info": {
        "commit_hash": "9daa50076f585854f0040aa8403eac020d6f5d64",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/9daa50076f585854f0040aa8403eac020d6f5d64",
        "files": [
          "arch/x86/kvm/ioapic.h",
          "arch/x86/kvm/lapic.c"
        ],
        "message": "kvm: x86: Track irq vectors in ioapic->rtc_status.dest_map\n\nThis allows backtracking later in case the rtc irq has been\nmoved to another vcpu/vector.\n\nSigned-off-by: Joerg Roedel <jroedel@suse.de>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>",
        "before_after_code_files": [
          "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h",
          "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h"
          ],
          "candidate": [
            "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kvm/ioapic.h||arch/x86/kvm/ioapic.h": [
          "File: arch/x86/kvm/ioapic.h -> arch/x86/kvm/ioapic.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: #endif",
          "43: struct dest_map {",
          "44:  DECLARE_BITMAP(map, KVM_MAX_VCPUS);",
          "45: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51:  u8 vectors[KVM_MAX_VCPUS];",
          "",
          "---------------"
        ],
        "arch/x86/kvm/lapic.c||arch/x86/kvm/lapic.c": [
          "File: arch/x86/kvm/lapic.c -> arch/x86/kvm/lapic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "915:   result = 1;",
          "918:    __set_bit(vcpu->vcpu_id, dest_map->map);",
          "920:   if (apic_test_vector(vector, apic->regs + APIC_TMR) != !!trig_mode) {",
          "921:    if (trig_mode)",
          "",
          "[Removed Lines]",
          "917:   if (dest_map)",
          "",
          "[Added Lines]",
          "917:   if (dest_map) {",
          "919:    dest_map->vectors[vcpu->vcpu_id] = vector;",
          "920:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}