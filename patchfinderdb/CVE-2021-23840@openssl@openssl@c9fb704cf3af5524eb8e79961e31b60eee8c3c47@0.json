{
  "cve_id": "CVE-2021-23840",
  "cve_desc": "Calls to EVP_CipherUpdate, EVP_EncryptUpdate and EVP_DecryptUpdate may overflow the output length argument in some cases where the input length is close to the maximum permissable length for an integer on the platform. In such cases the return value from the function call will be 1 (indicating success), but the output length value will be negative. This could cause applications to behave incorrectly or crash. OpenSSL versions 1.1.1i and below are affected by this issue. Users of these versions should upgrade to OpenSSL 1.1.1j. OpenSSL versions 1.0.2x and below are affected by this issue. However OpenSSL 1.0.2 is out of support and no longer receiving public updates. Premium support customers of OpenSSL 1.0.2 should upgrade to 1.0.2y. Other users should upgrade to 1.1.1j. Fixed in OpenSSL 1.1.1j (Affected 1.1.1-1.1.1i). Fixed in OpenSSL 1.0.2y (Affected 1.0.2-1.0.2x).",
  "repo": "openssl/openssl",
  "patch_hash": "c9fb704cf3af5524eb8e79961e31b60eee8c3c47",
  "patch_info": {
    "commit_hash": "c9fb704cf3af5524eb8e79961e31b60eee8c3c47",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/c9fb704cf3af5524eb8e79961e31b60eee8c3c47",
    "files": [
      "crypto/err/openssl.txt",
      "crypto/evp/evp_enc.c",
      "crypto/evp/evp_err.c",
      "include/crypto/evperr.h",
      "include/openssl/evperr.h"
    ],
    "message": "Don't overflow the output length in EVP_CipherUpdate calls\n\nCVE-2021-23840\n\nReviewed-by: Paul Dale <pauli@openssl.org>",
    "before_after_code_files": [
      "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c",
      "crypto/evp/evp_err.c||crypto/evp/evp_err.c",
      "include/crypto/evperr.h||include/crypto/evperr.h",
      "include/openssl/evperr.h||include/openssl/evperr.h"
    ]
  },
  "patch_diff": {
    "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c": [
      "File: crypto/evp/evp_enc.c -> crypto/evp/evp_enc.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "11: #define OPENSSL_SUPPRESS_DEPRECATED",
      "13: #include <stdio.h>",
      "14: #include <assert.h>",
      "15: #include \"internal/cryptlib.h\"",
      "16: #include <openssl/evp.h>",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "14: #include <limits.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "511:             return 1;",
      "512:         } else {",
      "513:             j = bl - i;",
      "514:             memcpy(&(ctx->buf[i]), in, j);",
      "515:             inl -= j;",
      "516:             in += j;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "523:             if (((inl - j) & ~(bl - 1)) > INT_MAX - bl) {",
      "524:                 ERR_raise(ERR_LIB_EVP, EVP_R_OUTPUT_WOULD_OVERFLOW);",
      "525:                 return 0;",
      "526:             }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "771:             ERR_raise(ERR_LIB_EVP, EVP_R_PARTIALLY_OVERLAPPING);",
      "772:             return 0;",
      "773:         }",
      "774:         memcpy(out, ctx->final, b);",
      "775:         out += b;",
      "776:         fix_len = 1;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "796:         if ((inl & ~(b - 1)) > INT_MAX - b) {",
      "797:             ERR_raise(ERR_LIB_EVP, EVP_R_OUTPUT_WOULD_OVERFLOW);",
      "798:             return 0;",
      "799:         }",
      "",
      "---------------"
    ],
    "crypto/evp/evp_err.c||crypto/evp/evp_err.c": [
      "File: crypto/evp/evp_err.c -> crypto/evp/evp_err.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "137:     \"operation not supported for this keytype\"},",
      "138:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_OPERATON_NOT_INITIALIZED),",
      "139:     \"operation not initialized\"},",
      "140:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_PARAMETER_TOO_LARGE),",
      "141:     \"parameter too large\"},",
      "142:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_PARTIALLY_OVERLAPPING),",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "140:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_OUTPUT_WOULD_OVERFLOW),",
      "141:     \"output would overflow\"},",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "153:     \"set default property failure\"},",
      "154:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_TOO_MANY_RECORDS), \"too many records\"},",
      "155:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_UNABLE_TO_ENABLE_LOCKING),",
      "157:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_UNABLE_TO_GET_MAXIMUM_REQUEST_SIZE),",
      "158:     \"unable to get maximum request size\"},",
      "159:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_UNABLE_TO_GET_RANDOM_STRENGTH),",
      "",
      "[Removed Lines]",
      "156:     \"unable to enable parent locking\"},",
      "",
      "[Added Lines]",
      "158:     \"unable to enable locking\"},",
      "",
      "---------------"
    ],
    "include/crypto/evperr.h||include/crypto/evperr.h": [
      "File: include/crypto/evperr.h -> include/crypto/evperr.h"
    ],
    "include/openssl/evperr.h||include/openssl/evperr.h": [
      "File: include/openssl/evperr.h -> include/openssl/evperr.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "97: # define EVP_R_ONLY_ONESHOT_SUPPORTED                     177",
      "98: # define EVP_R_OPERATION_NOT_SUPPORTED_FOR_THIS_KEYTYPE   150",
      "99: # define EVP_R_OPERATON_NOT_INITIALIZED                   151",
      "100: # define EVP_R_PARAMETER_TOO_LARGE                        187",
      "101: # define EVP_R_PARTIALLY_OVERLAPPING                      162",
      "102: # define EVP_R_PBKDF2_ERROR                               181",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "100: # define EVP_R_OUTPUT_WOULD_OVERFLOW                      202",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6a51b9e1d0cf0bf8515f7201b68fb0a3482b3dc1",
      "candidate_info": {
        "commit_hash": "6a51b9e1d0cf0bf8515f7201b68fb0a3482b3dc1",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/6a51b9e1d0cf0bf8515f7201b68fb0a3482b3dc1",
        "files": [
          "crypto/err/openssl.txt",
          "crypto/evp/evp_enc.c",
          "crypto/evp/evp_err.c",
          "include/openssl/evperr.h"
        ],
        "message": "Don't overflow the output length in EVP_CipherUpdate calls\n\nCVE-2021-23840\n\nReviewed-by: Paul Dale <pauli@openssl.org>",
        "before_after_code_files": [
          "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c",
          "crypto/evp/evp_err.c||crypto/evp/evp_err.c",
          "include/openssl/evperr.h||include/openssl/evperr.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c",
            "crypto/evp/evp_err.c||crypto/evp/evp_err.c",
            "include/openssl/evperr.h||include/openssl/evperr.h"
          ],
          "candidate": [
            "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c",
            "crypto/evp/evp_err.c||crypto/evp/evp_err.c",
            "include/openssl/evperr.h||include/openssl/evperr.h"
          ]
        }
      },
      "candidate_diff": {
        "crypto/evp/evp_enc.c||crypto/evp/evp_enc.c": [
          "File: crypto/evp/evp_enc.c -> crypto/evp/evp_enc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10: #include <stdio.h>",
          "11: #include <assert.h>",
          "12: #include \"internal/cryptlib.h\"",
          "13: #include <openssl/evp.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11: #include <limits.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "355:             return 1;",
          "356:         } else {",
          "357:             j = bl - i;",
          "358:             memcpy(&(ctx->buf[i]), in, j);",
          "359:             inl -= j;",
          "360:             in += j;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "367:             if (((inl - j) & ~(bl - 1)) > INT_MAX - bl) {",
          "368:                 EVPerr(EVP_F_EVP_ENCRYPTDECRYPTUPDATE,",
          "369:                        EVP_R_OUTPUT_WOULD_OVERFLOW);",
          "370:                 return 0;",
          "371:             }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "502:             EVPerr(EVP_F_EVP_DECRYPTUPDATE, EVP_R_PARTIALLY_OVERLAPPING);",
          "503:             return 0;",
          "504:         }",
          "505:         memcpy(out, ctx->final, b);",
          "506:         out += b;",
          "507:         fix_len = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "528:         if ((inl & ~(b - 1)) > INT_MAX - b) {",
          "529:             EVPerr(EVP_F_EVP_DECRYPTUPDATE, EVP_R_OUTPUT_WOULD_OVERFLOW);",
          "530:             return 0;",
          "531:         }",
          "",
          "---------------"
        ],
        "crypto/evp/evp_err.c||crypto/evp/evp_err.c": [
          "File: crypto/evp/evp_err.c -> crypto/evp/evp_err.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "239:     \"operation not supported for this keytype\"},",
          "240:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_OPERATON_NOT_INITIALIZED),",
          "241:     \"operaton not initialized\"},",
          "242:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_PARTIALLY_OVERLAPPING),",
          "243:     \"partially overlapping buffers\"},",
          "244:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_PBKDF2_ERROR), \"pbkdf2 error\"},",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "242:     {ERR_PACK(ERR_LIB_EVP, 0, EVP_R_OUTPUT_WOULD_OVERFLOW),",
          "243:     \"output would overflow\"},",
          "",
          "---------------"
        ],
        "include/openssl/evperr.h||include/openssl/evperr.h": [
          "File: include/openssl/evperr.h -> include/openssl/evperr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: #ifndef HEADER_EVPERR_H",
          "12: # define HEADER_EVPERR_H",
          "18: # ifdef  __cplusplus",
          "19: extern \"C\"",
          "",
          "[Removed Lines]",
          "14: # ifndef HEADER_SYMHACKS_H",
          "15: #  include <openssl/symhacks.h>",
          "16: # endif",
          "",
          "[Added Lines]",
          "14: # include <openssl/symhacks.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "179: # define EVP_R_ONLY_ONESHOT_SUPPORTED                     177",
          "180: # define EVP_R_OPERATION_NOT_SUPPORTED_FOR_THIS_KEYTYPE   150",
          "181: # define EVP_R_OPERATON_NOT_INITIALIZED                   151",
          "182: # define EVP_R_PARTIALLY_OVERLAPPING                      162",
          "183: # define EVP_R_PBKDF2_ERROR                               181",
          "184: # define EVP_R_PKEY_APPLICATION_ASN1_METHOD_ALREADY_REGISTERED 179",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "180: # define EVP_R_OUTPUT_WOULD_OVERFLOW                      184",
          "",
          "---------------"
        ]
      }
    }
  ]
}