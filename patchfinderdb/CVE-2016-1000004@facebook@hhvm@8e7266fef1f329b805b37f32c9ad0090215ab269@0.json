{
  "cve_id": "CVE-2016-1000004",
  "cve_desc": "Insufficient type checks were employed prior to casting input data in SimpleXMLElement_exportNode and simplexml_import_dom. This issue affects HHVM versions prior to 3.9.5, all versions between 3.10.0 and 3.12.3 (inclusive), and all versions between 3.13.0 and 3.14.1 (inclusive).",
  "repo": "facebook/hhvm",
  "patch_hash": "8e7266fef1f329b805b37f32c9ad0090215ab269",
  "patch_info": {
    "commit_hash": "8e7266fef1f329b805b37f32c9ad0090215ab269",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/8e7266fef1f329b805b37f32c9ad0090215ab269",
    "files": [
      "hphp/runtime/ext/simplexml/ext_simplexml.cpp",
      "hphp/test/slow/ext_domdocument/simplexml_null.php",
      "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
    ],
    "message": "Type safety in simplexml import routines\n\nReviewed By: Orvid\n\nDifferential Revision: D3447275\n\nfbshipit-source-id: d859c97f9d85c520b0e371cef6dcb19bb2ef7dbf",
    "before_after_code_files": [
      "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
      "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
      "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
    ]
  },
  "patch_diff": {
    "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp": [
      "File: hphp/runtime/ext/simplexml/ext_simplexml.cpp -> hphp/runtime/ext/simplexml/ext_simplexml.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "374: }",
      "376: xmlNodePtr SimpleXMLElement_exportNode(const Object& sxe) {",
      "378:   auto data = Native::data<SimpleXMLElement>(sxe.get());",
      "379:   return php_sxe_get_first_node(data, data->nodep());",
      "380: }",
      "",
      "[Removed Lines]",
      "377:   assert(sxe->instanceof(SimpleXMLElement_classof()));",
      "",
      "[Added Lines]",
      "377:   if (!sxe->instanceof(SimpleXMLElement_classof())) return nullptr;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1166:   return cls;",
      "1167: }",
      "1169: static Variant HHVM_FUNCTION(simplexml_import_dom,",
      "1172:   auto domnode = Native::data<DOMNode>(node);",
      "1173:   xmlNodePtr nodep = domnode->nodep();",
      "",
      "[Removed Lines]",
      "1170:   const Object& node,",
      "1171:   const String& class_name /* = \"SimpleXMLElement\" */) {",
      "",
      "[Added Lines]",
      "1169: const StaticString s_DOMNode(\"DOMNode\");",
      "1172:                              const Object& node,",
      "1173:                              const String& class_name) {",
      "1174:   if (!node->instanceof(s_DOMNode)) {",
      "1175:     raise_warning(\"Invalid Nodetype to import\");",
      "1176:     return init_null();",
      "1177:   }",
      "",
      "---------------"
    ],
    "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php": [
      "File: hphp/test/slow/ext_domdocument/simplexml_null.php -> hphp/test/slow/ext_domdocument/simplexml_null.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?php",
      "3: $date = date_create_immutable();",
      "4: var_dump(dom_import_simplexml($date));",
      "5: var_dump(simplexml_import_dom($date));",
      "",
      "---------------"
    ],
    "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf": [
      "File: hphp/test/slow/ext_domdocument/simplexml_null.php.expectf -> hphp/test/slow/ext_domdocument/simplexml_null.php.expectf",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 4",
      "2: NULL",
      "4: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 5",
      "5: NULL",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e3c182b26f1e6f31fc352df4b95b264aaf8168dc",
      "candidate_info": {
        "commit_hash": "e3c182b26f1e6f31fc352df4b95b264aaf8168dc",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/e3c182b26f1e6f31fc352df4b95b264aaf8168dc",
        "files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ],
        "message": "Type safety in simplexml import routines\n\nReviewed By: Orvid\n\nDifferential Revision: D3447275\n\nfbshipit-source-id: d859c97f9d85c520b0e371cef6dcb19bb2ef7dbf",
        "before_after_code_files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp": [
          "File: hphp/runtime/ext/simplexml/ext_simplexml.cpp -> hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "374: }",
          "376: xmlNodePtr SimpleXMLElement_exportNode(const Object& sxe) {",
          "378:   auto data = Native::data<SimpleXMLElement>(sxe.get());",
          "379:   return php_sxe_get_first_node(data, data->nodep());",
          "380: }",
          "",
          "[Removed Lines]",
          "377:   assert(sxe->instanceof(SimpleXMLElement_classof()));",
          "",
          "[Added Lines]",
          "377:   if (!sxe->instanceof(SimpleXMLElement_classof())) return nullptr;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1166:   return cls;",
          "1167: }",
          "1169: static Variant HHVM_FUNCTION(simplexml_import_dom,",
          "1172:   auto domnode = Native::data<DOMNode>(node);",
          "1173:   xmlNodePtr nodep = domnode->nodep();",
          "",
          "[Removed Lines]",
          "1170:   const Object& node,",
          "1171:   const String& class_name /* = \"SimpleXMLElement\" */) {",
          "",
          "[Added Lines]",
          "1169: const StaticString s_DOMNode(\"DOMNode\");",
          "1172:                              const Object& node,",
          "1173:                              const String& class_name) {",
          "1174:   if (!node->instanceof(s_DOMNode)) {",
          "1175:     raise_warning(\"Invalid Nodetype to import\");",
          "1176:     return init_null();",
          "1177:   }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php -> hphp/test/slow/ext_domdocument/simplexml_null.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: $date = date_create_immutable();",
          "4: var_dump(dom_import_simplexml($date));",
          "5: var_dump(simplexml_import_dom($date));",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php.expectf -> hphp/test/slow/ext_domdocument/simplexml_null.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 4",
          "2: NULL",
          "4: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 5",
          "5: NULL",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "30d5e912ceb30ea07a841008b532ddbce04b3801",
      "candidate_info": {
        "commit_hash": "30d5e912ceb30ea07a841008b532ddbce04b3801",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/30d5e912ceb30ea07a841008b532ddbce04b3801",
        "files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ],
        "message": "Type safety in simplexml import routines\n\nReviewed By: Orvid\n\nDifferential Revision: D3447275\n\nfbshipit-source-id: d859c97f9d85c520b0e371cef6dcb19bb2ef7dbf",
        "before_after_code_files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp": [
          "File: hphp/runtime/ext/simplexml/ext_simplexml.cpp -> hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "375: }",
          "377: xmlNodePtr SimpleXMLElement_exportNode(const Object& sxe) {",
          "379:   auto data = Native::data<SimpleXMLElement>(sxe.get());",
          "380:   return php_sxe_get_first_node(data, data->nodep());",
          "381: }",
          "",
          "[Removed Lines]",
          "378:   assert(sxe->instanceof(SimpleXMLElement_classof()));",
          "",
          "[Added Lines]",
          "378:   if (!sxe->instanceof(SimpleXMLElement_classof())) return nullptr;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1167:   return cls;",
          "1168: }",
          "1170: static Variant HHVM_FUNCTION(simplexml_import_dom,",
          "1173:   auto domnode = Native::data<DOMNode>(node);",
          "1174:   xmlNodePtr nodep = domnode->nodep();",
          "",
          "[Removed Lines]",
          "1171:   const Object& node,",
          "1172:   const String& class_name /* = \"SimpleXMLElement\" */) {",
          "",
          "[Added Lines]",
          "1170: const StaticString s_DOMNode(\"DOMNode\");",
          "1173:                              const Object& node,",
          "1174:                              const String& class_name) {",
          "1175:   if (!node->instanceof(s_DOMNode)) {",
          "1176:     raise_warning(\"Invalid Nodetype to import\");",
          "1177:     return init_null();",
          "1178:   }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php -> hphp/test/slow/ext_domdocument/simplexml_null.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: $date = date_create_immutable();",
          "4: var_dump(dom_import_simplexml($date));",
          "5: var_dump(simplexml_import_dom($date));",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php.expectf -> hphp/test/slow/ext_domdocument/simplexml_null.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 4",
          "2: NULL",
          "4: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 5",
          "5: NULL",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e479b05591f17b9dfed2ccfd4055accb768bc1e5",
      "candidate_info": {
        "commit_hash": "e479b05591f17b9dfed2ccfd4055accb768bc1e5",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/e479b05591f17b9dfed2ccfd4055accb768bc1e5",
        "files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ],
        "message": "Type safety in simplexml import routines\n\nReviewed By: Orvid\n\nDifferential Revision: D3447275\n\nfbshipit-source-id: d859c97f9d85c520b0e371cef6dcb19bb2ef7dbf",
        "before_after_code_files": [
          "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
          "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ],
          "candidate": [
            "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp",
            "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php",
            "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/simplexml/ext_simplexml.cpp||hphp/runtime/ext/simplexml/ext_simplexml.cpp": [
          "File: hphp/runtime/ext/simplexml/ext_simplexml.cpp -> hphp/runtime/ext/simplexml/ext_simplexml.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "1054:   return cls;",
          "1055: }",
          "1057: Variant f_simplexml_import_dom(",
          "1058:   const Object& node,",
          "1059:   const String& class_name /* = \"SimpleXMLElement\" */) {",
          "1060:   auto domnode = Native::data<DOMNode>(node);",
          "1061:   xmlNodePtr nodep = domnode->nodep();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1057: const StaticString s_DOMNode(\"DOMNode\");",
          "1061:   if (!node->instanceof(s_DOMNode)) {",
          "1062:     raise_warning(\"Invalid Nodetype to import\");",
          "1063:     return init_null();",
          "1064:   }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php||hphp/test/slow/ext_domdocument/simplexml_null.php": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php -> hphp/test/slow/ext_domdocument/simplexml_null.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?php",
          "3: $date = date_create_immutable();",
          "4: var_dump(dom_import_simplexml($date));",
          "5: var_dump(simplexml_import_dom($date));",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_domdocument/simplexml_null.php.expectf||hphp/test/slow/ext_domdocument/simplexml_null.php.expectf": [
          "File: hphp/test/slow/ext_domdocument/simplexml_null.php.expectf -> hphp/test/slow/ext_domdocument/simplexml_null.php.expectf",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 4",
          "2: NULL",
          "4: Warning: Invalid Nodetype to import in %s/test/slow/ext_domdocument/simplexml_null.php on line 5",
          "5: NULL",
          "",
          "---------------"
        ]
      }
    }
  ]
}