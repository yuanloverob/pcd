{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c62fe10d7bc0022a91a328d0c43268a23c9cfc62",
      "candidate_info": {
        "commit_hash": "c62fe10d7bc0022a91a328d0c43268a23c9cfc62",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c62fe10d7bc0022a91a328d0c43268a23c9cfc62",
        "files": [
          "nmake-x86.bat"
        ],
        "message": "add nmake-x86.bat",
        "before_after_code_files": [
          "nmake-x86.bat||nmake-x86.bat"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "nmake-x86.bat||nmake-x86.bat": [
          "File: nmake-x86.bat -> nmake-x86.bat",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: :: Capstone disassembler engine (www.capstone-engine.org)",
          "2: :: Build Capstone libs (capstone.dll & capstone.lib) on Windows with CMake & Nmake",
          "3: :: By Nguyen Anh Quynh, 2017",
          "5: cmake -DCMAKE_BUILD_TYPE=Release SUPPORTED_ARCHITECTURES=X86 -G \"NMake Makefiles\" ..",
          "6: nmake",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f715a40fdb234726bdbf7b3d23ac462ae353ceec",
      "candidate_info": {
        "commit_hash": "f715a40fdb234726bdbf7b3d23ac462ae353ceec",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f715a40fdb234726bdbf7b3d23ac462ae353ceec",
        "files": [
          "windows/winkernel_mm.c"
        ],
        "message": "fix #748",
        "before_after_code_files": [
          "windows/winkernel_mm.c||windows/winkernel_mm.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "windows/winkernel_mm.c||windows/winkernel_mm.c": [
          "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "31:  NT_ASSERT(size);",
          "33:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
          "35:  if (!block) {",
          "36:   return NULL;",
          "37:  }",
          "",
          "[Removed Lines]",
          "34:    NonPagedPoolNx, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
          "",
          "[Added Lines]",
          "34:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "86e9dd494c904bd85c46909e0044ad75397d637d",
      "candidate_info": {
        "commit_hash": "86e9dd494c904bd85c46909e0044ad75397d637d",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/86e9dd494c904bd85c46909e0044ad75397d637d",
        "files": [
          "bindings/java/capstone/M68k_const.java",
          "bindings/ocaml/m68k_const.ml"
        ],
        "message": "bindings: update Java & Ocaml after recent change on M68k interface",
        "before_after_code_files": [
          "bindings/javcapstone/M68k_const.java||bindings/java/capstone/M68k_const.java",
          "bindings/ocaml/m68k_const.ml||bindings/ocaml/m68k_const.ml"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javcapstone/M68k_const.java||bindings/java/capstone/M68k_const.java": [
          "File: bindings/javcapstone/M68k_const.java -> bindings/java/capstone/M68k_const.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86:  public static final int M68K_OP_FP_SINGLE = 4;",
          "87:  public static final int M68K_OP_FP_DOUBLE = 5;",
          "88:  public static final int M68K_OP_REG_BITS = 6;",
          "89:  public static final int M68K_OP_REG_PAIR = 7;",
          "",
          "---------------"
        ],
        "bindings/ocaml/m68k_const.ml||bindings/ocaml/m68k_const.ml": [
          "File: bindings/ocaml/m68k_const.ml -> bindings/ocaml/m68k_const.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "80: let _M68K_OP_REG = 1;;",
          "81: let _M68K_OP_IMM = 2;;",
          "82: let _M68K_OP_MEM = 3;;",
          "87: let _M68K_CPU_SIZE_NONE = 0;;",
          "88: let _M68K_CPU_SIZE_BYTE = 1;;",
          "",
          "[Removed Lines]",
          "83: let _M68K_OP_FP = 4;;",
          "84: let _M68K_OP_REG_BITS = 5;;",
          "85: let _M68K_OP_REG_PAIR = 6;;",
          "",
          "[Added Lines]",
          "83: let _M68K_OP_FP_SINGLE = 4;;",
          "84: let _M68K_OP_FP_DOUBLE = 5;;",
          "85: let _M68K_OP_REG_BITS = 6;;",
          "86: let _M68K_OP_REG_PAIR = 7;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1504f913f17be8868a04bb308bccb04e5dbc5a24",
      "candidate_info": {
        "commit_hash": "1504f913f17be8868a04bb308bccb04e5dbc5a24",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/1504f913f17be8868a04bb308bccb04e5dbc5a24",
        "files": [
          "arch/X86/X86Mapping.c"
        ],
        "message": "x86: consistent register names ST0-ST7 with the asm output",
        "before_after_code_files": [
          "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ],
          "candidate": [
            "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
          "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "183:  { X86_REG_R13, \"r13\" },",
          "184:  { X86_REG_R14, \"r14\" },",
          "185:  { X86_REG_R15, \"r15\" },",
          "194:  { X86_REG_XMM0, \"xmm0\" },",
          "195:  { X86_REG_XMM1, \"xmm1\" },",
          "196:  { X86_REG_XMM2, \"xmm2\" },",
          "",
          "[Removed Lines]",
          "186:  { X86_REG_ST0, \"st0\" },",
          "187:  { X86_REG_ST1, \"st1\" },",
          "188:  { X86_REG_ST2, \"st2\" },",
          "189:  { X86_REG_ST3, \"st3\" },",
          "190:  { X86_REG_ST4, \"st4\" },",
          "191:  { X86_REG_ST5, \"st5\" },",
          "192:  { X86_REG_ST6, \"st6\" },",
          "193:  { X86_REG_ST7, \"st7\" },",
          "",
          "[Added Lines]",
          "186:  { X86_REG_ST0, \"st(0\" },",
          "187:  { X86_REG_ST1, \"st(1)\" },",
          "188:  { X86_REG_ST2, \"st(2)\" },",
          "189:  { X86_REG_ST3, \"st(3)\" },",
          "190:  { X86_REG_ST4, \"st(4)\" },",
          "191:  { X86_REG_ST5, \"st(5)\" },",
          "192:  { X86_REG_ST6, \"st(6)\" },",
          "193:  { X86_REG_ST7, \"st(7)\" },",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "81f2bcf31c869867f092c42c14bc30f61280ea33",
      "candidate_info": {
        "commit_hash": "81f2bcf31c869867f092c42c14bc30f61280ea33",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/81f2bcf31c869867f092c42c14bc30f61280ea33",
        "files": [
          "arch/X86/X86DisassemblerDecoder.c"
        ],
        "message": "x86: initialize eaDisplacement in 16-bit mode.  Fixes #656",
        "before_after_code_files": [
          "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c": [
          "File: arch/X86/X86DisassemblerDecoder.c -> arch/X86/X86DisassemblerDecoder.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1646:      break;",
          "1647:     case 0x3:",
          "1648:      insn->eaBase = (EABase)(insn->eaRegBase + rm);",
          "1649:      if (readDisplacement(insn))",
          "1650:       return -1;",
          "1651:      break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1649:      insn->eaDisplacement = EA_DISP_NONE;",
          "",
          "---------------"
        ]
      }
    }
  ]
}