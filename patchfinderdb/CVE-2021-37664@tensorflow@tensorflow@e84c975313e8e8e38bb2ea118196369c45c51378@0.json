{
  "cve_id": "CVE-2021-37664",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions an attacker can read from outside of bounds of heap allocated data by sending specially crafted illegal arguments to `BoostedTreesSparseCalculateBestFeatureSplit`. The [implementation](https://github.com/tensorflow/tensorflow/blob/84d053187cb80d975ef2b9684d4b61981bca0c41/tensorflow/core/kernels/boosted_trees/stats_ops.cc) needs to validate that each value in `stats_summary_indices` is in range. We have patched the issue in GitHub commit e84c975313e8e8e38bb2ea118196369c45c51378. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "e84c975313e8e8e38bb2ea118196369c45c51378",
  "patch_info": {
    "commit_hash": "e84c975313e8e8e38bb2ea118196369c45c51378",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/e84c975313e8e8e38bb2ea118196369c45c51378",
    "files": [
      "tensorflow/core/kernels/boosted_trees/stats_ops.cc"
    ],
    "message": "In tf.raw_ops.BoostedTreesSparseCalculateBestFeatureSplit, limit stat_dim in stats_summary_indices to under stats_dims in stats_summary_shape\n\nPiperOrigin-RevId: 387171191\nChange-Id: I83ca8a75b22aa78c037e8b98779da6cced16bfaa",
    "before_after_code_files": [
      "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc": [
      "File: tensorflow/core/kernels/boosted_trees/stats_ops.cc -> tensorflow/core/kernels/boosted_trees/stats_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "1050:       const int32_t feature_dim = stats_summary_indices(idx, 1);",
      "1051:       const int32_t bucket_id = stats_summary_indices(idx, 2);",
      "1052:       const int32_t stat_dim = stats_summary_indices(idx, 3);",
      "1053:       std::pair<FeatureMapIterator, bool> const& f_insert_result = f_map.insert(",
      "1054:           FeatureMapIterator::value_type(feature_dim, BucketMap()));",
      "1055:       auto& b_map = f_insert_result.first->second;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1053:       OP_REQUIRES(context, stat_dim < stats_dims,",
      "1054:                   errors::InvalidArgument(",
      "1055:                       \"Stat dim, the sum of logits dim and hessian dim in \"",
      "1056:                       \"stats_summary_indices, cannot be greater than stats \"",
      "1057:                       \"dims, the last value in stats_summary_shape, which was \",",
      "1058:                       stats_dims, \". At index (\", idx,",
      "1059:                       \", 4), stats_summary_indices contains value \", stat_dim));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3366e13671d43a248d9bdbea151407587f1b3f05",
      "candidate_info": {
        "commit_hash": "3366e13671d43a248d9bdbea151407587f1b3f05",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3366e13671d43a248d9bdbea151407587f1b3f05",
        "files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ],
        "message": "[Cherrypick2.3] In tf.raw_ops.BoostedTreesSparseCalculateBestFeatureSplit, limit stat_dim in stats_summary_indices to under stats_dims in stats_summary_shape",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/stats_ops.cc -> tensorflow/core/kernels/boosted_trees/stats_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1025:       const int32 feature_dim = stats_summary_indices(idx, 1);",
          "1026:       const int32 bucket_id = stats_summary_indices(idx, 2);",
          "1027:       const int32 stat_dim = stats_summary_indices(idx, 3);",
          "1028:       std::pair<FeatureMapIterator, bool> const& f_insert_result = f_map.insert(",
          "1029:           FeatureMapIterator::value_type(feature_dim, BucketMap()));",
          "1030:       auto& b_map = f_insert_result.first->second;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1028:       OP_REQUIRES(context, stat_dim < stats_dims,",
          "1029:                   errors::InvalidArgument(",
          "1030:                       \"Stat dim, the sum of logits dim and hessian dim in \"",
          "1031:                       \"stats_summary_indices, cannot be greater than stats \"",
          "1032:                       \"dims, the last value in stats_summary_shape, which was \",",
          "1033:                       stats_dims, \". At index (\", idx,",
          "1034:                       \", 4), stats_summary_indices contains value \", stat_dim));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fc4fd4e628f8b8b7a39b28d62338ff246d9bb71c",
      "candidate_info": {
        "commit_hash": "fc4fd4e628f8b8b7a39b28d62338ff246d9bb71c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/fc4fd4e628f8b8b7a39b28d62338ff246d9bb71c",
        "files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ],
        "message": "[Cherrypick2.4] In tf.raw_ops.BoostedTreesSparseCalculateBestFeatureSplit, limit stat_dim in stats_summary_indices to under stats_dims in stats_summary_shape",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/stats_ops.cc -> tensorflow/core/kernels/boosted_trees/stats_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1025:       const int32 feature_dim = stats_summary_indices(idx, 1);",
          "1026:       const int32 bucket_id = stats_summary_indices(idx, 2);",
          "1027:       const int32 stat_dim = stats_summary_indices(idx, 3);",
          "1028:       std::pair<FeatureMapIterator, bool> const& f_insert_result = f_map.insert(",
          "1029:           FeatureMapIterator::value_type(feature_dim, BucketMap()));",
          "1030:       auto& b_map = f_insert_result.first->second;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1028:       OP_REQUIRES(context, stat_dim < stats_dims,",
          "1029:                   errors::InvalidArgument(",
          "1030:                       \"Stat dim, the sum of logits dim and hessian dim in \"",
          "1031:                       \"stats_summary_indices, cannot be greater than stats \"",
          "1032:                       \"dims, the last value in stats_summary_shape, which was \",",
          "1033:                       stats_dims, \". At index (\", idx,",
          "1034:                       \", 4), stats_summary_indices contains value \", stat_dim));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7867d402c40d4c9d813ed3a5f5148f9cae1ee381",
      "candidate_info": {
        "commit_hash": "7867d402c40d4c9d813ed3a5f5148f9cae1ee381",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/7867d402c40d4c9d813ed3a5f5148f9cae1ee381",
        "files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ],
        "message": "[Cherrypick2.5] In tf.raw_ops.BoostedTreesSparseCalculateBestFeatureSplit, limit stat_dim in stats_summary_indices to under stats_dims in stats_summary_shape",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/stats_ops.cc -> tensorflow/core/kernels/boosted_trees/stats_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1025:       const int32 feature_dim = stats_summary_indices(idx, 1);",
          "1026:       const int32 bucket_id = stats_summary_indices(idx, 2);",
          "1027:       const int32 stat_dim = stats_summary_indices(idx, 3);",
          "1028:       std::pair<FeatureMapIterator, bool> const& f_insert_result = f_map.insert(",
          "1029:           FeatureMapIterator::value_type(feature_dim, BucketMap()));",
          "1030:       auto& b_map = f_insert_result.first->second;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1028:       OP_REQUIRES(context, stat_dim < stats_dims,",
          "1029:                   errors::InvalidArgument(",
          "1030:                       \"Stat dim, the sum of logits dim and hessian dim in \"",
          "1031:                       \"stats_summary_indices, cannot be greater than stats \"",
          "1032:                       \"dims, the last value in stats_summary_shape, which was \",",
          "1033:                       stats_dims, \". At index (\", idx,",
          "1034:                       \", 4), stats_summary_indices contains value \", stat_dim));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fbfafe40cbc00a66f5baac245d680ef1158e1658",
      "candidate_info": {
        "commit_hash": "fbfafe40cbc00a66f5baac245d680ef1158e1658",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/fbfafe40cbc00a66f5baac245d680ef1158e1658",
        "files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ],
        "message": "[Cherrypick2.6] In tf.raw_ops.BoostedTreesSparseCalculateBestFeatureSplit, limit stat_dim in stats_summary_indices to under stats_dims in stats_summary_shape",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/stats_ops.cc||tensorflow/core/kernels/boosted_trees/stats_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/stats_ops.cc -> tensorflow/core/kernels/boosted_trees/stats_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1025:       const int32 feature_dim = stats_summary_indices(idx, 1);",
          "1026:       const int32 bucket_id = stats_summary_indices(idx, 2);",
          "1027:       const int32 stat_dim = stats_summary_indices(idx, 3);",
          "1028:       std::pair<FeatureMapIterator, bool> const& f_insert_result = f_map.insert(",
          "1029:           FeatureMapIterator::value_type(feature_dim, BucketMap()));",
          "1030:       auto& b_map = f_insert_result.first->second;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1028:       OP_REQUIRES(context, stat_dim < stats_dims,",
          "1029:                   errors::InvalidArgument(",
          "1030:                       \"Stat dim, the sum of logits dim and hessian dim in \"",
          "1031:                       \"stats_summary_indices, cannot be greater than stats \"",
          "1032:                       \"dims, the last value in stats_summary_shape, which was \",",
          "1033:                       stats_dims, \". At index (\", idx,",
          "1034:                       \", 4), stats_summary_indices contains value \", stat_dim));",
          "",
          "---------------"
        ]
      }
    }
  ]
}