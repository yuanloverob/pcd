{
  "cve_id": "CVE-2015-7551",
  "cve_desc": "The Fiddle::Handle implementation in ext/fiddle/handle.c in Ruby before 2.0.0-p648, 2.1 before 2.1.8, and 2.2 before 2.2.4, as distributed in Apple OS X before 10.11.4 and other products, mishandles tainting, which allows context-dependent attackers to execute arbitrary code or cause a denial of service (application crash) via a crafted string, related to the DL module and the libffi library.  NOTE: this vulnerability exists because of a CVE-2009-5147 regression.",
  "repo": "ruby/ruby",
  "patch_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
  "patch_info": {
    "commit_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
    "repo": "ruby/ruby",
    "commit_url": "https://github.com/ruby/ruby/commit/339e11a7f178312d937b7c95dd3115ce7236597a",
    "files": [
      "ChangeLog",
      "ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb",
      "version.h"
    ],
    "message": "merge revision(s): 53153 and 23405@ruby_1_9_1\n\n\t* ext/fiddle/handle.c: check tainted string arguments.\n\t  Patch provided by tenderlove and nobu.\n\n\t* test/fiddle/test_handle.rb (class TestHandle): add test for above.\n\n\t* ext/dl/handle.c (rb_dlhandle_initialize): prohibits DL::dlopen\n\t  with a tainted name of library.\n\t  Patch by sheepman <sheepman AT sheepman.sakura.ne.jp>.\n\n\t* ext/dl/handle.c (rb_dlhandle_sym): ditto\n\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53156 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
    "before_after_code_files": [
      "ext/fiddle/handle.c||ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb",
      "version.h||version.h"
    ]
  },
  "patch_diff": {
    "ext/fiddle/handle.c||ext/fiddle/handle.c": [
      "File: ext/fiddle/handle.c -> ext/fiddle/handle.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #include <ruby.h>",
      "2: #include <fiddle.h>",
      "4: VALUE rb_cHandle;",
      "6: struct dl_handle {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: #define SafeStringValueCStr(v) (rb_check_safe_obj(rb_string_value(&v)), StringValueCStr(v))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "144:  break;",
      "145:       case 1:",
      "147:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "148:  break;",
      "149:       case 2:",
      "151:  cflag = NUM2INT(flag);",
      "152:  break;",
      "153:       default:",
      "",
      "[Removed Lines]",
      "146:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "150:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "",
      "[Added Lines]",
      "148:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "152:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "263:     return PTR2NUM(fiddle_handle);",
      "264: }",
      "",
      "[Removed Lines]",
      "266: static VALUE fiddle_handle_sym(void *handle, const char *symbol);",
      "",
      "[Added Lines]",
      "268: static VALUE fiddle_handle_sym(void *handle, VALUE symbol);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "282:  rb_raise(rb_eFiddleError, \"closed handle\");",
      "283:     }",
      "286: }",
      "288: #ifndef RTLD_NEXT",
      "",
      "[Removed Lines]",
      "285:     return fiddle_handle_sym(fiddle_handle->ptr, StringValueCStr(sym));",
      "",
      "[Added Lines]",
      "287:     return fiddle_handle_sym(fiddle_handle->ptr, sym);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "305: static VALUE",
      "306: rb_fiddle_handle_s_sym(VALUE self, VALUE sym)",
      "307: {",
      "309: }",
      "311: static VALUE",
      "313: {",
      "314: #if defined(HAVE_DLERROR)",
      "315:     const char *err;",
      "",
      "[Removed Lines]",
      "308:     return fiddle_handle_sym(RTLD_NEXT, StringValueCStr(sym));",
      "312: fiddle_handle_sym(void *handle, const char *name)",
      "",
      "[Added Lines]",
      "310:     return fiddle_handle_sym(RTLD_NEXT, sym);",
      "314: fiddle_handle_sym(void *handle, VALUE symbol)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "318: # define CHECK_DLERROR",
      "319: #endif",
      "320:     void (*func)();",
      "322:     rb_secure(2);",
      "323: #ifdef HAVE_DLERROR",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "323:     const char *name = SafeStringValueCStr(symbol);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "367:     }",
      "368: #endif",
      "369:     if( !func ){",
      "371:     }",
      "373:     return PTR2NUM(func);",
      "",
      "[Removed Lines]",
      "370:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%s\\\"\", name);",
      "",
      "[Added Lines]",
      "373:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%\"PRIsVALUE\"\\\"\", symbol);",
      "",
      "---------------"
    ],
    "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb": [
      "File: test/fiddle/test_handle.rb -> test/fiddle/test_handle.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:     include Test::Unit::Assertions",
      "13:     def test_to_i",
      "14:       handle = Fiddle::Handle.new(LIBC_SO)",
      "15:       assert_kind_of Integer, handle.to_i",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     def test_safe_handle_open",
      "14:       t = Thread.new do",
      "15:         $SAFE = 1",
      "16:         Fiddle::Handle.new(LIBC_SO.taint)",
      "17:       end",
      "18:       assert_raise(SecurityError) { t.value }",
      "19:     end",
      "21:     def test_safe_function_lookup",
      "22:       t = Thread.new do",
      "23:         h = Fiddle::Handle.new(LIBC_SO)",
      "24:         $SAFE = 1",
      "25:         h[\"qsort\".taint]",
      "26:       end",
      "27:       assert_raise(SecurityError) { t.value }",
      "28:     end",
      "",
      "---------------"
    ],
    "version.h||version.h": [
      "File: version.h -> version.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #define RUBY_VERSION \"2.1.8\"",
      "2: #define RUBY_RELEASE_DATE \"2015-12-16\"",
      "5: #define RUBY_RELEASE_YEAR 2015",
      "6: #define RUBY_RELEASE_MONTH 12",
      "",
      "[Removed Lines]",
      "3: #define RUBY_PATCHLEVEL 438",
      "",
      "[Added Lines]",
      "3: #define RUBY_PATCHLEVEL 439",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9580200f7da99a5d1e2c3b35354b4972d1be9ea5",
      "candidate_info": {
        "commit_hash": "9580200f7da99a5d1e2c3b35354b4972d1be9ea5",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/9580200f7da99a5d1e2c3b35354b4972d1be9ea5",
        "files": [
          "ChangeLog",
          "lib/net/http/response.rb",
          "test/net/http/test_httpresponse.rb",
          "version.h"
        ],
        "message": "merge revision(s) 51061,51063,51091: [Backport #11285]\n\n\t* lib/net/http/response.rb (inflater): CONTENT_ENCODING can be upper\n\t  case. [ruby-core:69670] [Bug #11285] patched by Andy Chu\n\n\t* test/net/http/test_httpresponse.rb\n\t(HTTPResponseTest#test_read_body_content_encoding_deflate_uppercase):\n\tfix a failure without zlib.\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51602 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "lib/net/http/response.rb||lib/net/http/response.rb",
          "test/net/http/test_httpresponse.rb||test/net/http/test_httpresponse.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "lib/net/http/response.rb||lib/net/http/response.rb": [
          "File: lib/net/http/response.rb -> lib/net/http/response.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:     return yield @socket unless @decode_content",
          "251:     return yield @socket if self['content-range']",
          "254:     when 'deflate', 'gzip', 'x-gzip' then",
          "255:       self.delete 'content-encoding'",
          "",
          "[Removed Lines]",
          "253:     case self['content-encoding']",
          "",
          "[Added Lines]",
          "253:     v = self['content-encoding']",
          "254:     case v && v.downcase",
          "",
          "---------------"
        ],
        "test/net/http/test_httpresponse.rb||test/net/http/test_httpresponse.rb": [
          "File: test/net/http/test_httpresponse.rb -> test/net/http/test_httpresponse.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "103:     end",
          "104:   end",
          "106:   def test_read_body_content_encoding_deflate_chunked",
          "107:     io = dummy_io(<<EOS)",
          "108: HTTP/1.1 200 OK",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:     end",
          "104:   end",
          "106:   def test_read_body_content_encoding_deflate_uppercase",
          "107:     io = dummy_io(<<EOS)",
          "108: HTTP/1.1 200 OK",
          "109: Connection: close",
          "110: Content-Encoding: DEFLATE",
          "111: Content-Length: 13",
          "113: x\\x9C\\xCBH\\xCD\\xC9\\xC9\\a\\x00\\x06,\\x02\\x15",
          "114: EOS",
          "116:     res = Net::HTTPResponse.read_new(io)",
          "117:     res.decode_content = true",
          "119:     body = nil",
          "121:     res.reading_body io, true do",
          "122:       body = res.read_body",
          "123:     end",
          "125:     if Net::HTTP::HAVE_ZLIB",
          "126:       assert_equal nil, res['content-encoding']",
          "127:       assert_equal 'hello', body",
          "128:     else",
          "129:       assert_equal 'DEFLATE', res['content-encoding']",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-08-17\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 8",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 385",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 386",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4f0e238f2854a9f3e5a1f3cbb0c8d32e66dc15d8",
      "candidate_info": {
        "commit_hash": "4f0e238f2854a9f3e5a1f3cbb0c8d32e66dc15d8",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/4f0e238f2854a9f3e5a1f3cbb0c8d32e66dc15d8",
        "files": [
          "ChangeLog",
          "class.c",
          "version.h"
        ],
        "message": "merge revision(s) 49875: [Backport #10946]\n\n\t* class.c (rb_prepend_module): need a WB for klass -> origin.\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@50285 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "class.c||class.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "class.c||class.c": [
          "File: class.c -> class.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "937:  RCLASS_SET_SUPER(origin, RCLASS_SUPER(klass));",
          "938:  RCLASS_SET_SUPER(klass, origin);",
          "940:  RCLASS_M_TBL_WRAPPER(origin) = RCLASS_M_TBL_WRAPPER(klass);",
          "941:  RCLASS_M_TBL_INIT(klass);",
          "942:  st_foreach(RCLASS_M_TBL(origin), move_refined_method,",
          "",
          "[Removed Lines]",
          "939:  RCLASS_ORIGIN(klass) = origin;",
          "",
          "[Added Lines]",
          "939:  RB_OBJ_WRITE(klass, &RCLASS_ORIGIN(klass), origin);",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "2: #define RUBY_RELEASE_DATE \"2015-04-13\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 4",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 331",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 332",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1bd36e36e09f5bccb5110d197e8494d0d7e19000",
      "candidate_info": {
        "commit_hash": "1bd36e36e09f5bccb5110d197e8494d0d7e19000",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/1bd36e36e09f5bccb5110d197e8494d0d7e19000",
        "files": [
          "ChangeLog",
          "test/ruby/test_refinement.rb",
          "version.h",
          "vm_eval.c"
        ],
        "message": "merge revision(s) 50430,50440: [Backport #11117]\n\n\t* vm_eval.c (rb_method_call_status): undefined refined method is\n\t  not callable unless using.  [ruby-core:69064] [Bug #11117]\n\n\t* vm_eval.c (rb_method_call_status): resolve refined method entry\n\t  to check if undefined.  [ruby-core:69064] [Bug #11117]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51119 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "test/ruby/test_refinement.rb||test/ruby/test_refinement.rb",
          "version.h||version.h",
          "vm_eval.c||vm_eval.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "test/ruby/test_refinement.rb||test/ruby/test_refinement.rb": [
          "File: test/ruby/test_refinement.rb -> test/ruby/test_refinement.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1399:     INPUT",
          "1400:   end",
          "1402:   private",
          "1404:   def eval_using(mod, s)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1402:   def test_check_funcall_undefined",
          "1403:     bug11117 = '[ruby-core:69064] [Bug #11117]'",
          "1405:     x = Class.new",
          "1406:     Module.new do",
          "1407:       refine x do",
          "1408:         def to_regexp",
          "1410:         end",
          "1411:       end",
          "1412:     end",
          "1414:     assert_nothing_raised(NoMethodError, bug11117) {",
          "1415:       assert_nil(Regexp.try_convert(x.new))",
          "1416:     }",
          "1417:   end",
          "1419:   def test_funcall_inherited",
          "1420:     bug11117 = '[ruby-core:69064] [Bug #11117]'",
          "1422:     Module.new {refine(Dir) {def to_s; end}}",
          "1423:     x = Class.new(Dir).allocate",
          "1424:     assert_nothing_raised(NoMethodError, bug11117) {",
          "1425:       x.inspect",
          "1426:     }",
          "1427:   end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-07-03\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 7",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 370",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 371",
          "",
          "---------------"
        ],
        "vm_eval.c||vm_eval.c": [
          "File: vm_eval.c -> vm_eval.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "533:     int noex;",
          "535:     if (UNDEFINED_METHOD_ENTRY_P(me)) {",
          "536:  return scope == CALL_VCALL ? NOEX_VCALL : 0;",
          "537:     }",
          "538:     klass = me->klass;",
          "539:     oid = me->def->original_id;",
          "540:     noex = me->flag;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "536:       undefined:",
          "539:     if (me->def->type == VM_METHOD_TYPE_REFINED) {",
          "540:  me = rb_resolve_refined_method(Qnil, me, NULL);",
          "541:  if (UNDEFINED_METHOD_ENTRY_P(me)) goto undefined;",
          "542:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "137514a3992eba2be425d6f5df48d259428acb20",
      "candidate_info": {
        "commit_hash": "137514a3992eba2be425d6f5df48d259428acb20",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/137514a3992eba2be425d6f5df48d259428acb20",
        "files": [
          "ChangeLog",
          "rational.c",
          "version.h"
        ],
        "message": "merge revision(s) 50406,50407: [Backport #11075]\n\n\t* rational.c: Added documentation for rational literal.\n\t  [Bug #11075][fix GH-885][ci skip] Patch by @shishir127\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@50579 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "rational.c||rational.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "rational.c||rational.c": [
          "File: rational.c -> rational.c"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-05-21\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 5",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 352",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 353",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4e125b59e1d6cf0c8b06a9fb36f1c437c42378ad",
      "candidate_info": {
        "commit_hash": "4e125b59e1d6cf0c8b06a9fb36f1c437c42378ad",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/4e125b59e1d6cf0c8b06a9fb36f1c437c42378ad",
        "files": [
          "ChangeLog",
          "parse.y",
          "version.h"
        ],
        "message": "merge revision(s) 54172: [Backport #12192]\n\n\t* parse.y (parse_numvar): NTH_REF must be less than a half of\n\t  INT_MAX, as it is left-shifted to be ORed with back-ref flag.\n\t  [ruby-core:74444] [Bug#12192] [Fix GH-1296]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@54275 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "parse.y||parse.y",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "parse.y||parse.y": [
          "File: parse.y -> parse.y",
          "--- Hunk 1 ---",
          "[Context before]",
          "6965:     int overflow;",
          "6966:     unsigned long n = ruby_scan_digits(tok()+1, toklen()-1, 10, &len, &overflow);",
          "6967:     const unsigned long nth_ref_max =",
          "",
          "[Removed Lines]",
          "6968:  (FIXNUM_MAX / 2 < INT_MAX) ? FIXNUM_MAX / 2 : INT_MAX;",
          "",
          "[Added Lines]",
          "6968:  ((FIXNUM_MAX < INT_MAX) ? FIXNUM_MAX : INT_MAX) >> 1;",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.9\"",
          "2: #define RUBY_RELEASE_DATE \"2016-03-25\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 3",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 472",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 473",
          "",
          "---------------"
        ]
      }
    }
  ]
}