{
  "cve_id": "CVE-2021-40516",
  "cve_desc": "WeeChat before 3.2.1 allows remote attackers to cause a denial of service (crash) via a crafted WebSocket frame that trigger an out-of-bounds read in plugins/relay/relay-websocket.c in the Relay plugin.",
  "repo": "weechat/weechat",
  "patch_hash": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
  "patch_info": {
    "commit_hash": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
    "repo": "weechat/weechat",
    "commit_url": "https://github.com/weechat/weechat/commit/8b1331f98de1714bae15a9ca2e2b393ba49d735b",
    "files": [
      "ChangeLog.adoc",
      "src/plugins/relay/relay-websocket.c",
      "version.sh"
    ],
    "message": "relay: fix crash when decoding a malformed websocket frame",
    "before_after_code_files": [
      "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c",
      "version.sh||version.sh"
    ]
  },
  "patch_diff": {
    "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c": [
      "File: src/plugins/relay/relay-websocket.c -> src/plugins/relay/relay-websocket.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "278:     index_buffer = 0;",
      "282:     {",
      "283:         opcode = buffer[index_buffer] & 15;",
      "",
      "[Removed Lines]",
      "281:     while (index_buffer + 2 <= buffer_length)",
      "",
      "[Added Lines]",
      "281:     while (index_buffer + 1 < buffer_length)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "293:         length_frame_size = 1;",
      "294:         length_frame = buffer[index_buffer + 1] & 127;",
      "295:         index_buffer += 2;",
      "296:         if ((length_frame == 126) || (length_frame == 127))",
      "297:         {",
      "298:             length_frame_size = (length_frame == 126) ? 2 : 8;",
      "300:                 return 0;",
      "301:             length_frame = 0;",
      "302:             for (i = 0; i < length_frame_size; i++)",
      "",
      "[Removed Lines]",
      "299:             if (buffer_length < 1 + length_frame_size)",
      "",
      "[Added Lines]",
      "296:         if (index_buffer >= buffer_length)",
      "297:             return 0;",
      "301:             if (index_buffer + length_frame_size > buffer_length)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "306:             index_buffer += length_frame_size;",
      "307:         }",
      "313:         int masks[4];",
      "314:         for (i = 0; i < 4; i++)",
      "315:         {",
      "",
      "[Removed Lines]",
      "309:         if (buffer_length < 1 + length_frame_size + 4 + length_frame)",
      "310:             return 0;",
      "",
      "[Added Lines]",
      "312:         if (index_buffer + 4 > buffer_length)",
      "313:             return 0;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "336:         for (i = 0; i < length_frame; i++)",
      "337:         {",
      "338:             decoded[*decoded_length + i] = (int)((unsigned char)buffer[index_buffer + i]) ^ masks[i % 4];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "337:         if ((length_frame > buffer_length)",
      "338:             || (index_buffer + length_frame > buffer_length))",
      "339:         {",
      "340:             return 0;",
      "341:         }",
      "",
      "---------------"
    ],
    "version.sh||version.sh": [
      "File: version.sh -> version.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "33: #",
      "35: WEECHAT_STABLE=3.2",
      "39: if [ $# -lt 1 ]; then",
      "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
      "",
      "[Removed Lines]",
      "36: WEECHAT_DEVEL=3.2",
      "37: WEECHAT_DEVEL_FULL=3.2",
      "",
      "[Added Lines]",
      "36: WEECHAT_DEVEL=3.2.1",
      "37: WEECHAT_DEVEL_FULL=3.2.1-dev",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3e180a3c9082cf214efa72935184861b8f8a8540",
      "candidate_info": {
        "commit_hash": "3e180a3c9082cf214efa72935184861b8f8a8540",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/3e180a3c9082cf214efa72935184861b8f8a8540",
        "files": [
          "ChangeLog.adoc",
          "ReleaseNotes.adoc",
          "version.sh",
          "weechat.spec"
        ],
        "message": "Version 3.2.1",
        "before_after_code_files": [
          "version.sh||version.sh",
          "weechat.spec||weechat.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #     devel-patch  the patch version of devel (e.g. 2 for version 1.4.2)",
          "33: #",
          "36: WEECHAT_DEVEL=3.2.1",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "35: WEECHAT_STABLE=3.2",
          "37: WEECHAT_DEVEL_FULL=3.2.1-dev",
          "",
          "[Added Lines]",
          "35: WEECHAT_STABLE=3.2.1",
          "37: WEECHAT_DEVEL_FULL=3.2.1",
          "",
          "---------------"
        ],
        "weechat.spec||weechat.spec": [
          "File: weechat.spec -> weechat.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #",
          "25: %define name weechat",
          "27: %define release 1",
          "29: Name:      %{name}",
          "",
          "[Removed Lines]",
          "26: %define version 3.2",
          "",
          "[Added Lines]",
          "26: %define version 3.2.1",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: %{_prefix}/share/icons/hicolor/512x512/apps/weechat.png",
          "84: %changelog",
          "86: - Released version 3.2",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86: - Released version 3.2.1",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "70c09f1f5a4b317037330699d5cedfe96a54e05c",
      "candidate_info": {
        "commit_hash": "70c09f1f5a4b317037330699d5cedfe96a54e05c",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/70c09f1f5a4b317037330699d5cedfe96a54e05c",
        "files": [
          "ChangeLog.adoc",
          "ReleaseNotes.adoc",
          "version.sh",
          "weechat.spec"
        ],
        "message": "Version 3.2",
        "before_after_code_files": [
          "version.sh||version.sh",
          "weechat.spec||weechat.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #     devel-patch  the patch version of devel (e.g. 2 for version 1.4.2)",
          "33: #",
          "36: WEECHAT_DEVEL=3.2",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "35: WEECHAT_STABLE=3.1",
          "37: WEECHAT_DEVEL_FULL=3.2-rc1",
          "",
          "[Added Lines]",
          "35: WEECHAT_STABLE=3.2",
          "37: WEECHAT_DEVEL_FULL=3.2",
          "",
          "---------------"
        ],
        "weechat.spec||weechat.spec": [
          "File: weechat.spec -> weechat.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #",
          "25: %define name weechat",
          "27: %define release 1",
          "29: Name:      %{name}",
          "",
          "[Removed Lines]",
          "26: %define version 3.1",
          "",
          "[Added Lines]",
          "26: %define version 3.2",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: %{_prefix}/share/icons/hicolor/512x512/apps/weechat.png",
          "84: %changelog",
          "86: - Released version 3.1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86: - Released version 3.2",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "72936fd3be66a9e975143ba760bbb3bfc4d1a9a8",
      "candidate_info": {
        "commit_hash": "72936fd3be66a9e975143ba760bbb3bfc4d1a9a8",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/72936fd3be66a9e975143ba760bbb3bfc4d1a9a8",
        "files": [
          "ChangeLog.adoc",
          "ReleaseNotes.adoc",
          "version.sh",
          "weechat.spec"
        ],
        "message": "Version 3.0",
        "before_after_code_files": [
          "version.sh||version.sh",
          "weechat.spec||weechat.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #     devel-patch  the patch version of devel (e.g. 2 for version 1.4.2)",
          "33: #",
          "36: WEECHAT_DEVEL=3.0",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "35: WEECHAT_STABLE=2.9",
          "37: WEECHAT_DEVEL_FULL=3.0-rc1",
          "",
          "[Added Lines]",
          "35: WEECHAT_STABLE=3.0",
          "37: WEECHAT_DEVEL_FULL=3.0",
          "",
          "---------------"
        ],
        "weechat.spec||weechat.spec": [
          "File: weechat.spec -> weechat.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #",
          "25: %define name weechat",
          "27: %define release 1",
          "29: Name:      %{name}",
          "",
          "[Removed Lines]",
          "26: %define version 2.9",
          "",
          "[Added Lines]",
          "26: %define version 3.0",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: %{_prefix}/share/icons/hicolor/512x512/apps/weechat.png",
          "84: %changelog",
          "86: - Released version 2.9",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86: - Released version 3.0",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ae2f25109c48e78d696f061b517b68ec18e87deb",
      "candidate_info": {
        "commit_hash": "ae2f25109c48e78d696f061b517b68ec18e87deb",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/ae2f25109c48e78d696f061b517b68ec18e87deb",
        "files": [
          "ChangeLog.adoc",
          "ReleaseNotes.adoc",
          "version.sh",
          "weechat.spec"
        ],
        "message": "Version 3.1",
        "before_after_code_files": [
          "version.sh||version.sh",
          "weechat.spec||weechat.spec"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #     devel-patch  the patch version of devel (e.g. 2 for version 1.4.2)",
          "33: #",
          "36: WEECHAT_DEVEL=3.1",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "35: WEECHAT_STABLE=3.0",
          "37: WEECHAT_DEVEL_FULL=3.1-rc1",
          "",
          "[Added Lines]",
          "35: WEECHAT_STABLE=3.1",
          "37: WEECHAT_DEVEL_FULL=3.1",
          "",
          "---------------"
        ],
        "weechat.spec||weechat.spec": [
          "File: weechat.spec -> weechat.spec",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #",
          "25: %define name weechat",
          "27: %define release 1",
          "29: Name:      %{name}",
          "",
          "[Removed Lines]",
          "26: %define version 3.0.1",
          "",
          "[Added Lines]",
          "26: %define version 3.1",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "82: %{_prefix}/share/icons/hicolor/512x512/apps/weechat.png",
          "84: %changelog",
          "86: - Released version 3.0.1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "86: - Released version 3.1",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7dd3b0016cf9f40bfccd1c6c80d6d00f8c381b26",
      "candidate_info": {
        "commit_hash": "7dd3b0016cf9f40bfccd1c6c80d6d00f8c381b26",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/7dd3b0016cf9f40bfccd1c6c80d6d00f8c381b26",
        "files": [
          "version.sh"
        ],
        "message": "Version 3.2-rc1",
        "before_after_code_files": [
          "version.sh||version.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: WEECHAT_STABLE=3.1",
          "36: WEECHAT_DEVEL=3.2",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "37: WEECHAT_DEVEL_FULL=3.2-dev",
          "",
          "[Added Lines]",
          "37: WEECHAT_DEVEL_FULL=3.2-rc1",
          "",
          "---------------"
        ]
      }
    }
  ]
}