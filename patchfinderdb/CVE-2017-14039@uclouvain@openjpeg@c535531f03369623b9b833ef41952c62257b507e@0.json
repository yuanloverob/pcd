{
  "cve_id": "CVE-2017-14039",
  "cve_desc": "A heap-based buffer overflow was discovered in the opj_t2_encode_packet function in lib/openjp2/t2.c in OpenJPEG 2.2.0. The vulnerability causes an out-of-bounds write, which may lead to remote denial of service or possibly unspecified other impact.",
  "repo": "uclouvain/openjpeg",
  "patch_hash": "c535531f03369623b9b833ef41952c62257b507e",
  "patch_info": {
    "commit_hash": "c535531f03369623b9b833ef41952c62257b507e",
    "repo": "uclouvain/openjpeg",
    "commit_url": "https://github.com/uclouvain/openjpeg/commit/c535531f03369623b9b833ef41952c62257b507e",
    "files": [
      "src/lib/openjp2/j2k.c",
      "src/lib/openjp2/t2.c"
    ],
    "message": "opj_t2_encode_packet(): fix potential write heap buffer overflow (#992)",
    "before_after_code_files": [
      "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c",
      "src/lib/openjp2/t2.c||src/lib/openjp2/t2.c"
    ]
  },
  "patch_diff": {
    "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c": [
      "File: src/lib/openjp2/j2k.c -> src/lib/openjp2/j2k.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4215:     assert(p_stream != 00);",
      "4217:     OPJ_UNUSED(p_stream);",
      "4220:     if (p_total_data_size < 12) {",
      "4221:         opj_event_msg(p_manager, EVT_ERROR,",
      "",
      "[Removed Lines]",
      "4218:     OPJ_UNUSED(p_manager);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "4618:     OPJ_UNUSED(p_stream);",
      "4620:     opj_write_bytes(p_data, J2K_MS_SOD,",
      "4622:     p_data += 2;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4619:     if (p_total_data_size < 4) {",
      "4620:         opj_event_msg(p_manager, EVT_ERROR,",
      "4621:                       \"Not enough bytes in output buffer to write SOD marker\\n\");",
      "4622:         return OPJ_FALSE;",
      "4623:     }",
      "",
      "---------------"
    ],
    "src/lib/openjp2/t2.c||src/lib/openjp2/t2.c": [
      "File: src/lib/openjp2/t2.c -> src/lib/openjp2/t2.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "631:     if (tcp->csty & J2K_CP_CSTY_SOP) {",
      "632:         c[0] = 255;",
      "633:         c[1] = 145;",
      "634:         c[2] = 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "632:         if (length < 6) {",
      "633:             if (p_t2_mode == FINAL_PASS) {",
      "634:                 opj_event_msg(p_manager, EVT_ERROR,",
      "635:                               \"opj_t2_encode_packet(): only %u bytes remaining in \"",
      "636:                               \"output buffer. %u needed.\\n\",",
      "637:                               length, 6);",
      "638:             }",
      "639:             return OPJ_FALSE;",
      "640:         }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "819:     if (tcp->csty & J2K_CP_CSTY_EPH) {",
      "820:         c[0] = 255;",
      "821:         c[1] = 146;",
      "822:         c += 2;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "829:         if (length < 2) {",
      "830:             if (p_t2_mode == FINAL_PASS) {",
      "831:                 opj_event_msg(p_manager, EVT_ERROR,",
      "832:                               \"opj_t2_encode_packet(): only %u bytes remaining in \"",
      "833:                               \"output buffer. %u needed.\\n\",",
      "834:                               length, 2);",
      "835:             }",
      "836:             return OPJ_FALSE;",
      "837:         }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a8ca7c51f38a4cbdcb4a541137478df03e5eb76d",
      "candidate_info": {
        "commit_hash": "a8ca7c51f38a4cbdcb4a541137478df03e5eb76d",
        "repo": "uclouvain/openjpeg",
        "commit_url": "https://github.com/uclouvain/openjpeg/commit/a8ca7c51f38a4cbdcb4a541137478df03e5eb76d",
        "files": [
          "CMakeLists.txt",
          "src/bin/jp2/CMakeLists.txt",
          "src/lib/openjp2/CMakeLists.txt",
          "src/lib/openjp2/j2k.c",
          "src/lib/openjp2/jp2.c",
          "tools/ctest_scripts/travis-ci.cmake"
        ],
        "message": "CMake: add stronger warnings for openjp2 lib/bin by default, and error out on declaration-after-statement\n\nAnd remove occurences of unused arguments in src/lib/openjp2",
        "before_after_code_files": [
          "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c",
          "src/lib/openjp2/jp2.c||src/lib/openjp2/jp2.c",
          "tools/ctest_scripts/travis-ci.cmake||tools/ctest_scripts/travis-ci.cmake"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c"
          ],
          "candidate": [
            "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/openjp2/j2k.c||src/lib/openjp2/j2k.c": [
          "File: src/lib/openjp2/j2k.c -> src/lib/openjp2/j2k.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51: #define OPJ_UNUSED(x) (void)x",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1791:     assert(p_j2k != 00);",
          "1792:     assert(p_manager != 00);",
          "1794:     l_nb_tiles = cp->tw * cp->th;",
          "1796:     tcp = cp->tcps;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1796:     OPJ_UNUSED(p_j2k);",
          "1797:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2505:     assert(p_j2k != 00);",
          "2506:     assert(p_manager != 00);",
          "2507:     assert(p_header_data != 00);",
          "2510:     return OPJ_TRUE;",
          "2511: }",
          "",
          "[Removed Lines]",
          "2508:     (void)p_header_size;",
          "",
          "[Added Lines]",
          "2514:     OPJ_UNUSED(p_j2k);",
          "2515:     OPJ_UNUSED(p_header_data);",
          "2516:     OPJ_UNUSED(p_header_size);",
          "2517:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3284:     assert(p_j2k != 00);",
          "3285:     assert(p_manager != 00);",
          "3287:     l_tcp = &p_j2k->m_cp.tcps[p_j2k->m_current_tile_number];",
          "3288:     l_tccp = &l_tcp->tccps[0];",
          "3289:     l_image = p_j2k->m_private_image;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3296:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "3523:     assert(p_j2k != 00);",
          "3524:     assert(p_manager != 00);",
          "3526:     l_nb_comp = p_j2k->m_private_image->numcomps;",
          "3528:     if (p_header_size != l_nb_comp * 4) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3537:     OPJ_UNUSED(p_header_data);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "3564:     assert(p_j2k != 00);",
          "3565:     assert(p_manager != 00);",
          "3567:     if (p_header_size < 2) {",
          "3568:         opj_event_msg(p_manager, EVT_ERROR, \"Error reading TLM marker\\n\");",
          "3569:         return OPJ_FALSE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3580:     OPJ_UNUSED(p_j2k);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "3621:     assert(p_j2k != 00);",
          "3622:     assert(p_manager != 00);",
          "3624:     if (p_header_size < 1) {",
          "3625:         opj_event_msg(p_manager, EVT_ERROR, \"Error reading PLM marker\\n\");",
          "3626:         return OPJ_FALSE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3639:     OPJ_UNUSED(p_j2k);",
          "3640:     OPJ_UNUSED(p_header_data);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "3693:     assert(p_j2k != 00);",
          "3694:     assert(p_manager != 00);",
          "3696:     if (p_header_size < 1) {",
          "3697:         opj_event_msg(p_manager, EVT_ERROR, \"Error reading PLT marker\\n\");",
          "3698:         return OPJ_FALSE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3714:     OPJ_UNUSED(p_j2k);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "4156:     assert(p_manager != 00);",
          "4157:     assert(p_stream != 00);",
          "4159:     opj_write_bytes(p_data, J2K_MS_SOT,",
          "4161:     p_data += 2;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4179:     OPJ_UNUSED(p_stream);",
          "4180:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "4520:     assert(p_manager != 00);",
          "4521:     assert(p_stream != 00);",
          "4523:     opj_write_bytes(p_data, J2K_MS_SOD,",
          "4525:     p_data += 2;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4546:     OPJ_UNUSED(p_stream);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "4916:     assert(p_manager != 00);",
          "4917:     assert(p_stream != 00);",
          "4919:     l_cp = &(p_j2k->m_cp);",
          "4920:     l_image = p_j2k->m_private_image;",
          "4921:     l_tcp = l_cp->tcps;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4944:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "5124:     assert(p_manager != 00);",
          "5125:     assert(p_stream != 00);",
          "5127:     p_j2k->cstr_index->main_head_end = opj_stream_tell(p_stream);",
          "5129:     return OPJ_TRUE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5154:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "5264:     assert(p_manager != 00);",
          "5265:     assert(p_stream != 00);",
          "5267:     l_cstr_index = p_j2k->cstr_index;",
          "5268:     if (l_cstr_index) {",
          "5269:         l_cstr_index->codestream_size = (OPJ_UINT64)opj_stream_tell(p_stream);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "5296:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "7291:     assert(p_stream != 00);",
          "7292:     assert(p_manager != 00);",
          "7294:     if ((p_j2k->m_cp.rsiz & 0x8200) == 0x8200) {",
          "7295:         OPJ_UINT32 l_nb_tiles = p_j2k->m_cp.th * p_j2k->m_cp.tw;",
          "7296:         opj_tcp_t * l_tcp = p_j2k->m_cp.tcps;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7325:     OPJ_UNUSED(p_stream);",
          "7326:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 15 ---",
          "[Context before]",
          "7510:     assert(p_stream != 00);",
          "7511:     assert(p_manager != 00);",
          "7515:     l_is_valid &= (p_j2k->m_specific_param.m_decoder.m_state == J2K_STATE_NONE);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7547:     OPJ_UNUSED(p_stream);",
          "",
          "---------------",
          "--- Hunk 16 ---",
          "[Context before]",
          "7560:     assert(p_stream != 00);",
          "7561:     assert(p_manager != 00);",
          "7565: #ifdef TODO_MSD",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7599:     OPJ_UNUSED(p_stream);",
          "7600:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 17 ---",
          "[Context before]",
          "7813:     assert(p_stream != 00);",
          "7814:     assert(p_manager != 00);",
          "7816:     l_image = p_j2k->m_private_image;",
          "7817:     l_nb_tiles = p_j2k->m_cp.th * p_j2k->m_cp.tw;",
          "7818:     l_tcp = p_j2k->m_cp.tcps;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7855:     OPJ_UNUSED(p_stream);",
          "",
          "---------------",
          "--- Hunk 18 ---",
          "[Context before]",
          "11442:     assert(p_manager != 00);",
          "11443:     assert(p_stream != 00);",
          "11445:     opj_tcd_destroy(p_j2k->m_tcd);",
          "11446:     p_j2k->m_tcd = 00;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11486:     OPJ_UNUSED(p_stream);",
          "11487:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 19 ---",
          "[Context before]",
          "11474:     assert(p_stream != 00);",
          "11475:     assert(p_manager != 00);",
          "11477:     if (p_j2k->m_specific_param.m_encoder.m_header_tile_data) {",
          "11478:         opj_free(p_j2k->m_specific_param.m_encoder.m_header_tile_data);",
          "11479:         p_j2k->m_specific_param.m_encoder.m_header_tile_data = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11521:     OPJ_UNUSED(p_stream);",
          "11522:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 20 ---",
          "[Context before]",
          "11496:     assert(p_stream != 00);",
          "11497:     (void)l_cstr_info;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11546:     OPJ_UNUSED(p_stream);",
          "",
          "---------------",
          "--- Hunk 21 ---",
          "[Context before]",
          "11557:     assert(p_manager != 00);",
          "11558:     assert(p_stream != 00);",
          "11560:     p_j2k->m_tcd = opj_tcd_create(OPJ_FALSE);",
          "11562:     if (! p_j2k->m_tcd) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11609:     OPJ_UNUSED(p_stream);",
          "",
          "---------------"
        ],
        "src/lib/openjp2/jp2.c||src/lib/openjp2/jp2.c": [
          "File: src/lib/openjp2/jp2.c -> src/lib/openjp2/jp2.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "45: #define OPJ_BOX_SIZE    1024",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47: #define OPJ_UNUSED(x) (void)x",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1818:     assert(jp2 != 00);",
          "1819:     assert(p_manager != 00);",
          "1822:     opj_write_bytes(l_signature_data, 12, 4);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1823:     OPJ_UNUSED(jp2);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2160:     assert(cio != 00);",
          "2161:     assert(p_manager != 00);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2167:     OPJ_UNUSED(p_manager);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2826:     assert(jp2 != 00);",
          "2827:     assert(p_manager != 00);",
          "2831:     return OPJ_TRUE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2835:     OPJ_UNUSED(jp2);",
          "2836:     OPJ_UNUSED(p_manager);",
          "",
          "---------------"
        ],
        "tools/ctest_scripts/travis-ci.cmake||tools/ctest_scripts/travis-ci.cmake": [
          "File: tools/ctest_scripts/travis-ci.cmake -> tools/ctest_scripts/travis-ci.cmake",
          "--- Hunk 1 ---",
          "[Context before]",
          "19:  set( JPYLYZER_EXT          \"exe\"  )",
          "20: else()",
          "21:  set( CTEST_CMAKE_GENERATOR \"Unix Makefiles\")   # Always makefile in travis-ci environment",
          "23:  set( JPYLYZER_EXT          \"py\"  )",
          "24: endif()",
          "",
          "[Removed Lines]",
          "22:  set( CCFLAGS_WARNING \"-Wall -Wextra -Wconversion -Wno-unused-parameter -Wdeclaration-after-statement\")",
          "",
          "[Added Lines]",
          "22:  set( CCFLAGS_WARNING \"-Wall -Wextra -Wconversion -Wno-unused-parameter -Wdeclaration-after-statement -Werror=declaration-after-statement\")",
          "",
          "---------------"
        ]
      }
    }
  ]
}