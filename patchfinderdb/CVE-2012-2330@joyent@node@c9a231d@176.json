{
  "cve_id": "CVE-2012-2330",
  "cve_desc": "The Update method in src/node_http_parser.cc in Node.js before 0.6.17 and 0.7 before 0.7.8 does not properly check the length of a string, which allows remote attackers to obtain sensitive information (request header contents) and possibly spoof HTTP headers via a zero length string.",
  "repo": "joyent/node",
  "patch_hash": "c9a231db0e59658be419d926b1dfa17b939ba158",
  "patch_info": {
    "commit_hash": "c9a231db0e59658be419d926b1dfa17b939ba158",
    "repo": "joyent/node",
    "commit_url": "https://github.com/joyent/node/commit/c9a231d",
    "files": [
      "src/node_http_parser.cc"
    ],
    "message": "typo in node_http_parser",
    "before_after_code_files": [
      "src/node_http_parser.cc||src/node_http_parser.cc"
    ]
  },
  "patch_diff": {
    "src/node_http_parser.cc||src/node_http_parser.cc": [
      "File: src/node_http_parser.cc -> src/node_http_parser.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "191:   void Update(const char* str, size_t size) {",
      "192:     if (str_ == NULL)",
      "193:       str_ = str;",
      "197:       char* s = new char[size_ + size];",
      "",
      "[Removed Lines]",
      "194:     else if (on_heap_ || str_ + size != str) {",
      "",
      "[Added Lines]",
      "194:     else if (on_heap_ || str_ + size_ != str) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f116e17a2300545451e3e7b60bd4e20fc4489d20",
      "candidate_info": {
        "commit_hash": "f116e17a2300545451e3e7b60bd4e20fc4489d20",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/f116e17a2300545451e3e7b60bd4e20fc4489d20",
        "files": [
          "test/simple/test-http-url.parse-auth.js"
        ],
        "message": "test: update HTTP basic auth test\n\nVerify that URL-encoded entities are properly encoded into the Authorization\nheader.",
        "before_after_code_files": [
          "test/simple/test-http-url.parse-auth.js||test/simple/test-http-url.parse-auth.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/simple/test-http-url.parse-auth.js||test/simple/test-http-url.parse-auth.js": [
          "File: test/simple/test-http-url.parse-auth.js -> test/simple/test-http-url.parse-auth.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: var http = require('http');",
          "25: var url = require('url');",
          "29: function check(request) {",
          "32: }",
          "34: var server = http.createServer(function(request, response) {",
          "",
          "[Removed Lines]",
          "27: var testURL = url.parse('http://asdf:qwer@localhost:' + common.PORT);",
          "31:   assert.strictEqual(request.headers.authorization, 'Basic YXNkZjpxd2Vy');",
          "",
          "[Added Lines]",
          "28: var testURL = url.parse('http://user:pass%3A@localhost:' + common.PORT);",
          "32:   assert.strictEqual(request.headers.authorization, 'Basic dXNlcjpwYXNzOg==');",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "943448772e988eba86173e9d53746137070420f4",
      "candidate_info": {
        "commit_hash": "943448772e988eba86173e9d53746137070420f4",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/943448772e988eba86173e9d53746137070420f4",
        "files": [
          "tools/msvs/msi/nodemsi.wixproj",
          "tools/msvs/msi/product.wxs"
        ],
        "message": "windows/msi: add start menu links when installing",
        "before_after_code_files": [
          "tools/msvs/msi/nodemsi.wixproj||tools/msvs/msi/nodemsi.wixproj",
          "tools/msvs/msi/product.wxs||tools/msvs/msi/product.wxs"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tools/msvs/msi/nodemsi.wixproj||tools/msvs/msi/nodemsi.wixproj": [
          "File: tools/msvs/msi/nodemsi.wixproj -> tools/msvs/msi/nodemsi.wixproj",
          "--- Hunk 1 ---",
          "[Context before]",
          "42:       <HintPath>$(WixExtDir)\\WixUIExtension.dll</HintPath>",
          "43:       <Name>WixUIExtension</Name>",
          "44:     </WixExtension>",
          "45:   </ItemGroup>",
          "46:   <Import Project=\"$(WixTargetsPath)\" />",
          "47:     <Target Name=\"BeforeBuild\">",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "45:     <WixExtension Include=\"WiXUtilExtension\">",
          "46:       <HintPath>$(WixExtDir)\\WiXUtilExtension.dll</HintPath>",
          "47:       <Name>WiXUtilExtension</Name>",
          "48:     </WixExtension>",
          "",
          "---------------"
        ],
        "tools/msvs/msi/product.wxs||tools/msvs/msi/product.wxs": [
          "File: tools/msvs/msi/product.wxs -> tools/msvs/msi/product.wxs",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: <?xml version=\"1.0\" encoding=\"UTF-8\"?>",
          "4:   <?define repoDir=\"$(var.ProjectDir)..\\..\\..\\\" ?>",
          "5:   <?define sourcedir=\"$(var.repoDir)\\$(var.Configuration)\\\" ?>",
          "7:   <Product Id=\"*\"",
          "9:            Language=\"1033\"",
          "10:            Version=\"$(var.ProductVersion)\"",
          "12:            UpgradeCode=\"1d60944c-b9ce-4a71-a7c0-0384eb884baa\">",
          "14:     <Package InstallerVersion=\"200\" Compressed=\"yes\" />",
          "",
          "[Removed Lines]",
          "2: <Wix xmlns=\"http://schemas.microsoft.com/wix/2006/wi\">",
          "8:            Name=\"node.js\"",
          "11:            Manufacturer=\"Joyent, Inc\"",
          "",
          "[Added Lines]",
          "2: <Wix xmlns=\"http://schemas.microsoft.com/wix/2006/wi\"",
          "3:      xmlns:util=\"http://schemas.microsoft.com/wix/UtilExtension\">",
          "5:   <?define ProductName = \"node.js\" ?>",
          "6:   <?define ProductDescription = \"Evented I/O for V8 javascript\" ?>",
          "7:   <?define ProductAuthor = \"Joyent, Inc. and other Node contributors\" ?>",
          "13:            Name=\"$(var.ProductName)\"",
          "16:            Manufacturer=\"$(var.ProductAuthor)\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19:                   DowngradeErrorMessage=\"A later version of node.js is already installed. Setup will now exit.\" />",
          "21:     <Directory Id=\"TARGETDIR\" Name=\"SourceDir\">",
          "22:       <Directory Id=\"$(var.ProgramFilesFolderId)\">",
          "24:           <Directory Id=\"NodeModulesFolder\" Name=\"node_modules\">",
          "25:             <Directory Id=\"NPMFolder\" Name=\"npm\">",
          "26:               <Component Id=\"npmrc\" Guid=\"55B2B03F-8F32-4D62-A54A-FA428615591D\">",
          "",
          "[Removed Lines]",
          "23:         <Directory Id=\"NodeRoot\" Name=\"nodejs\">",
          "",
          "[Added Lines]",
          "28:       <Directory Id=\"ProgramMenuFolder\">",
          "29:           <Directory Id=\"ApplicationProgramsFolder\" Name=\"Node.js\"/>",
          "30:       </Directory>",
          "33:         <Directory Id=\"APPLICATIONROOTDIRECTORY\" Name=\"nodejs\">",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "69:       </Directory>",
          "70:     </Directory>",
          "72:     <ComponentGroup Id=\"allfiles\">",
          "73:       <ComponentRef Id=\"nodeexe\"/>",
          "74:       <ComponentRef Id=\"npmcmd\"/>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "83:     <DirectoryRef Id=\"ApplicationProgramsFolder\">",
          "84:       <Component Id=\"ApplicationShortcut\" Guid=\"9b1ab94a-8f54-4f19-a5c4-b890de474162\">",
          "85:         <Shortcut Id=\"ApplicationStartMenuShortcut\" Name=\"Node.js\"",
          "86:                   Description=\"$(var.ProductDescription)\" Target=\"[APPLICATIONROOTDIRECTORY]node.exe\"",
          "87:                   WorkingDirectory=\"APPLICATIONROOTDIRECTORY\"/>",
          "88:         <util:InternetShortcut Id=\"OnlineWebsiteShortcut\"",
          "89:                   Name=\"Node.js website\"",
          "90:                   Target=\"http://nodejs.org\"/>",
          "91:         <util:InternetShortcut Id=\"OnlineDocumentationShortcut\"",
          "92:                   Name=\"Node.js documentation\"",
          "93:                   Target=\"http://nodejs.org/dist/v$(var.ProductVersion)/docs/api/\"/>",
          "94:         <Shortcut Id=\"UninstallProduct\"",
          "95:                   Name=\"Uninstall Node.js\"",
          "96:                   Target=\"[SystemFolder]msiexec.exe\"",
          "97:                   Arguments=\"/x [ProductCode]\"",
          "98:                   Description=\"Uninstalls $(var.ProductName)\" />",
          "99:         <RemoveFolder Id=\"ApplicationProgramsFolder\" On=\"uninstall\"/>",
          "100:         <RegistryValue Root=\"HKCU\" Key=\"Software\\$(var.ProductAuthor)\\$(var.ProductName)\" Name=\"installed\" Type=\"integer\" Value=\"1\" KeyPath=\"yes\"/>",
          "101:       </Component>",
          "102:     </DirectoryRef>",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "79:       <?if $(var.Configuration) = Debug ?>",
          "80:       <ComponentRef Id=\"nodepdb\"/>",
          "81:       <?endif?>",
          "82:     </ComponentGroup>",
          "85:       <ComponentGroupRef Id=\"allfiles\" />",
          "86:       <ComponentGroupRef Id=\"Product.Generated\" />",
          "87:     </Feature>",
          "",
          "[Removed Lines]",
          "84:     <Feature Id=\"nodejs\" Title=\"node.js engine\" Level=\"1\" Description=\"evented I/O for V8 javascript\">",
          "",
          "[Added Lines]",
          "115:       <ComponentRef Id=\"ApplicationShortcut\" />",
          "118:     <Feature Id=\"nodejs\" Title=\"node.js engine\" Level=\"1\" Description=\"$(var.ProductDescription)\">",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e1b829d2a502b5181d7a9d13e79d839ba0601421",
      "candidate_info": {
        "commit_hash": "e1b829d2a502b5181d7a9d13e79d839ba0601421",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/e1b829d2a502b5181d7a9d13e79d839ba0601421",
        "files": [
          "test/simple/test-child-process-fork3.js",
          "test/simple/test-isolates3.js"
        ],
        "message": "Add broken test-isolates3.js",
        "before_after_code_files": [
          "test/simple/test-child-process-fork3.js||test/simple/test-child-process-fork3.js",
          "test/simple/test-isolates3.js||test/simple/test-isolates3.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/simple/test-child-process-fork3.js||test/simple/test-child-process-fork3.js": [
          "File: test/simple/test-child-process-fork3.js -> test/simple/test-child-process-fork3.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: var filename = common.fixturesDir + '/destroy-stdin.js';",
          "31: process.stdin.destroy();",
          "",
          "[Removed Lines]",
          "32: fork(filename).stdin.on('end', process.exit);",
          "",
          "[Added Lines]",
          "28: var options = {",
          "29:   thread: process.TEST_ISOLATE ? true : false",
          "30: };",
          "36: fork(filename, [], options).stdin.on('end', process.exit);",
          "",
          "---------------"
        ],
        "test/simple/test-isolates3.js||test/simple/test-isolates3.js": [
          "File: test/simple/test-isolates3.js -> test/simple/test-isolates3.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2: if (!process.features.isolates) return;",
          "4: var assert = require('assert');",
          "9: process.TEST_ISOLATE = true;",
          "10: require('./test-child-process-fork3');",
          "12: var numThreads = process.binding('isolates').count();",
          "13: assert.ok(numThreads > 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4c9c9f412ca64435fbe93a2700d569b84ba7b36",
      "candidate_info": {
        "commit_hash": "e4c9c9f412ca64435fbe93a2700d569b84ba7b36",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/e4c9c9f412ca64435fbe93a2700d569b84ba7b36",
        "files": [
          "lib/readline.js",
          "test/simple/test-readline-interface.js",
          "test/simple/test-readline-set-raw-mode.js"
        ],
        "message": "readline: Remove event listeners on close\n\nFix #3756",
        "before_after_code_files": [
          "lib/readline.js||lireadline.js",
          "test/simple/test-readline-interface.js||test/simple/test-readline-interface.js",
          "test/simple/test-readline-set-raw-mode.js||test/simple/test-readline-set-raw-mode.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/readline.js||lireadline.js": [
          "File: lib/readline.js -> lireadline.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:   this.terminal = !!terminal;",
          "89:   if (!this.terminal) {",
          "95:     });",
          "96:     var StringDecoder = require('string_decoder').StringDecoder; // lazy load",
          "97:     this._decoder = new StringDecoder('utf8');",
          "",
          "[Removed Lines]",
          "90:     input.on('data', function(data) {",
          "91:       self._normalWrite(data);",
          "92:     });",
          "93:     input.on('end', function() {",
          "94:       self.close();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "101:     exports.emitKeypressEvents(input);",
          "109:     this.line = '';",
          "",
          "[Removed Lines]",
          "104:     input.on('keypress', function(s, key) {",
          "105:       self._ttyWrite(s, key);",
          "106:     });",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "117:     this.history = [];",
          "118:     this.historyIndex = -1;",
          "122:     });",
          "123:   }",
          "124: }",
          "",
          "[Removed Lines]",
          "120:     output.on('resize', function() {",
          "121:       self._refreshLine();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/simple/test-readline-interface.js||test/simple/test-readline-interface.js": [
          "File: test/simple/test-readline-interface.js -> test/simple/test-readline-interface.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: }",
          "32: inherits(FakeInput, EventEmitter);",
          "33: FakeInput.prototype.resume = function() {};",
          "35: var fi;",
          "36: var rli;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: FakeInput.prototype.pause = function() {};",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "67: });",
          "68: fi.emit('data', 'a');",
          "69: assert.ok(!called);",
          "72: fi = new FakeInput();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "71: rli.close();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "80: assert.ok(!called);",
          "81: fi.emit('data', '\\n');",
          "82: assert.ok(called);",
          "85: fi = new FakeInput();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85: rli.close();",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "92: });",
          "93: fi.emit('data', expectedLines.join(''));",
          "94: assert.equal(callCount, expectedLines.length);",
          "97: fi = new FakeInput();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "98: rli.close();",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "104: });",
          "105: fi.emit('data', expectedLines.join(''));",
          "106: assert.equal(callCount, expectedLines.length - 1);",
          "109: var buf = Buffer('\u262e', 'utf8');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "111: rli.close();",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "120: assert.equal(callCount, 0);",
          "121: fi.emit('data', '\\n');",
          "122: assert.equal(callCount, 1);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128: rli.close();",
          "130: assert.deepEqual(fi.listeners('end'), []);",
          "131: assert.deepEqual(fi.listeners('data'), []);",
          "",
          "---------------"
        ],
        "test/simple/test-readline-set-raw-mode.js||test/simple/test-readline-set-raw-mode.js": [
          "File: test/simple/test-readline-set-raw-mode.js -> test/simple/test-readline-set-raw-mode.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "85: assert(!resumeCalled);",
          "86: assert(pauseCalled);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "88: assert.deepEqual(stream.listeners('end'), []);",
          "89: assert.deepEqual(stream.listeners('keypress'), []);",
          "91: assert.equal(stream.listeners('data').length, 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9a3521cb25e5f0035cf38ed7b16729c8d0dc3c65",
      "candidate_info": {
        "commit_hash": "9a3521cb25e5f0035cf38ed7b16729c8d0dc3c65",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/9a3521cb25e5f0035cf38ed7b16729c8d0dc3c65",
        "files": [
          "lib/http.js",
          "test/simple/test-http-1.0-keep-alive.js"
        ],
        "message": "http: respect HTTP/1.0 TE header\n\nA HTTP/1.0 client does not support 'Transfer-Encoding: chunked' unless it\nexplicitly requests it by sending a 'TE: chunked' header.\n\nBefore this commit, node.js always disabled chunked encoding for HTTP/1.0\nclients. Now it will scan for the TE header and turn on chunked encoding if\nrequested and applicable.\n\nFixes #940.",
        "before_after_code_files": [
          "lib/http.js||lihttp.js",
          "test/simple/test-http-1.0-keep-alive.js||test/simple/test-http-1.0-keep-alive.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/http.js||lihttp.js": [
          "File: lib/http.js -> lihttp.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "891:   this.sendDate = true;",
          "893:   if (req.httpVersionMajor < 1 || req.httpVersionMinor < 1) {",
          "895:     this.shouldKeepAlive = false;",
          "896:   }",
          "897: }",
          "",
          "[Removed Lines]",
          "894:     this.useChunkedEncodingByDefault = false;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/simple/test-http-1.0-keep-alive.js||test/simple/test-http-1.0-keep-alive.js": [
          "File: test/simple/test-http-1.0-keep-alive.js -> test/simple/test-http-1.0-keep-alive.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: var common = require('../common');",
          "23: var assert = require('assert');",
          "24: var http = require('http');",
          "25: var net = require('net');",
          "28: check([{",
          "29:   name: 'keep-alive, no TE header',",
          "30:   requests: [{",
          "31:     expectClose: true,",
          "32:     data: 'POST / HTTP/1.0\\r\\n' +",
          "33:           'Connection: keep-alive\\r\\n' +",
          "34:           '\\r\\n'",
          "35:   }, {",
          "36:     expectClose: true,",
          "37:     data: 'POST / HTTP/1.0\\r\\n' +",
          "38:           'Connection: keep-alive\\r\\n' +",
          "39:           '\\r\\n'",
          "40:   }],",
          "41:   responses: [{",
          "42:     headers: {'Connection': 'keep-alive'},",
          "43:     chunks: ['OK']",
          "44:   }, {",
          "45:     chunks: []",
          "46:   }]",
          "47: }, {",
          "48:   name: 'keep-alive, with TE: chunked',",
          "49:   requests: [{",
          "50:     expectClose: false,",
          "51:     data: 'POST / HTTP/1.0\\r\\n' +",
          "52:           'Connection: keep-alive\\r\\n' +",
          "53:           'TE: chunked\\r\\n' +",
          "54:           '\\r\\n'",
          "55:   }, {",
          "56:     expectClose: true,",
          "57:     data: 'POST / HTTP/1.0\\r\\n' +",
          "58:           '\\r\\n'",
          "59:   }],",
          "60:   responses: [{",
          "61:     headers: {'Connection': 'keep-alive'},",
          "62:     chunks: ['OK']",
          "63:   }, {",
          "64:     chunks: []",
          "65:   }]",
          "66: }, {",
          "67:   name: 'keep-alive, with Transfer-Encoding: chunked',",
          "68:   requests: [{",
          "69:     expectClose: false,",
          "70:     data: 'POST / HTTP/1.0\\r\\n' +",
          "71:           'Connection: keep-alive\\r\\n' +",
          "72:           '\\r\\n'",
          "73:   }, {",
          "74:     expectClose: true,",
          "75:     data: 'POST / HTTP/1.0\\r\\n' +",
          "76:           '\\r\\n'",
          "77:   }],",
          "78:   responses: [{",
          "79:     headers: {'Connection': 'keep-alive',",
          "80:               'Transfer-Encoding': 'chunked'},",
          "81:     chunks: ['OK']",
          "82:   }, {",
          "83:     chunks: []",
          "84:   }]",
          "85: }, {",
          "86:   name: 'keep-alive, with Content-Length',",
          "87:   requests: [{",
          "88:     expectClose: false,",
          "89:     data: 'POST / HTTP/1.0\\r\\n' +",
          "90:           'Connection: keep-alive\\r\\n' +",
          "91:           '\\r\\n'",
          "92:   }, {",
          "93:     expectClose: true,",
          "94:     data: 'POST / HTTP/1.0\\r\\n' +",
          "95:           '\\r\\n'",
          "96:   }],",
          "97:   responses: [{",
          "98:     headers: {'Connection': 'keep-alive',",
          "99:               'Content-Length': '2'},",
          "100:     chunks: ['OK']",
          "101:   }, {",
          "102:     chunks: []",
          "103:   }]",
          "104: }]);",
          "106: function check(tests) {",
          "107:   var test = tests[0];",
          "108:   if (test) http.createServer(server).listen(common.PORT, '127.0.0.1', client);",
          "109:   var current = 0;",
          "111:   function next() {",
          "112:     check(tests.slice(1));",
          "113:   }",
          "115:   function server(req, res) {",
          "116:     if (current + 1 === test.responses.length) this.close();",
          "117:     var ctx = test.responses[current];",
          "118:     res.writeHead(200, ctx.headers);",
          "119:     ctx.chunks.slice(0, -1).forEach(function(chunk) { res.write(chunk) });",
          "120:     res.end(ctx.chunks[ctx.chunks.length - 1]);",
          "121:   }",
          "123:   function client() {",
          "124:     if (current === test.requests.length) return next();",
          "125:     var conn = net.createConnection(common.PORT, '127.0.0.1', connected);",
          "127:     function connected() {",
          "128:       var ctx = test.requests[current];",
          "129:       conn.setEncoding('utf8');",
          "130:       conn.write(ctx.data);",
          "132:       function onclose() {",
          "133:         if (!ctx.expectClose) throw new Error('unexpected close');",
          "134:         client();",
          "135:       }",
          "136:       conn.on('close', onclose);",
          "138:       function ondata(s) {",
          "139:         current++;",
          "140:         if (ctx.expectClose) return;",
          "141:         conn.removeListener('close', onclose);",
          "142:         conn.removeListener('data', ondata);;",
          "143:         connected();",
          "144:       }",
          "145:       conn.on('data', ondata);",
          "146:     }",
          "147:   }",
          "148: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}