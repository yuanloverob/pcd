{
  "cve_id": "CVE-2015-7804",
  "cve_desc": "Off-by-one error in the phar_parse_zipfile function in ext/phar/zip.c in PHP before 5.5.30 and 5.6.x before 5.6.14 allows remote attackers to cause a denial of service (uninitialized pointer dereference and application crash) by including the / filename in a .zip PHAR archive.",
  "repo": "php/php-src",
  "patch_hash": "1ddf72180a52d247db88ea42a3e35f824a8fbda1",
  "patch_info": {
    "commit_hash": "1ddf72180a52d247db88ea42a3e35f824a8fbda1",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/1ddf72180a52d247db88ea42a3e35f824a8fbda1",
    "files": [
      "ext/phar/dirstream.c",
      "ext/phar/util.c",
      "ext/phar/zip.c"
    ],
    "message": "Better fix for bug #70433",
    "before_after_code_files": [
      "ext/phar/dirstream.c||ext/phar/dirstream.c",
      "ext/phar/util.c||ext/phar/util.c",
      "ext/phar/zip.c||ext/phar/zip.c"
    ]
  },
  "patch_diff": {
    "ext/phar/dirstream.c||ext/phar/dirstream.c": [
      "File: ext/phar/dirstream.c -> ext/phar/dirstream.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "207:  zend_hash_internal_pointer_reset(manifest);",
      "209:  while (FAILURE != zend_hash_has_more_elements(manifest)) {",
      "211:    break;",
      "212:   }",
      "",
      "[Removed Lines]",
      "210:   if (HASH_KEY_IS_STRING != zend_hash_get_current_key_ex(manifest, &key, &keylen, &unused, 0, NULL)) {",
      "",
      "[Added Lines]",
      "210:   if (HASH_KEY_NON_EXISTENT == zend_hash_get_current_key_ex(manifest, &key, &keylen, &unused, 0, NULL)) {",
      "",
      "---------------"
    ],
    "ext/phar/util.c||ext/phar/util.c": [
      "File: ext/phar/util.c -> ext/phar/util.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1978:  while ((s = zend_memrchr(filename, '/', filename_len))) {",
      "1979:   filename_len = s - filename;",
      "1981:    break;",
      "1982:   }",
      "1983:  }",
      "",
      "[Removed Lines]",
      "1980:   if (FAILURE == zend_hash_add_empty_element(&phar->virtual_dirs, filename, filename_len)) {",
      "",
      "[Added Lines]",
      "1980:   if (!filename_len || FAILURE == zend_hash_add_empty_element(&phar->virtual_dirs, filename, filename_len)) {",
      "",
      "---------------"
    ],
    "ext/phar/zip.c||ext/phar/zip.c": [
      "File: ext/phar/zip.c -> ext/phar/zip.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "397:   if (entry.filename[entry.filename_len - 1] == '/') {",
      "398:    entry.is_dir = 1;",
      "400:    entry.flags |= PHAR_ENT_PERM_DEF_DIR;",
      "401:   } else {",
      "402:    entry.is_dir = 0;",
      "",
      "[Removed Lines]",
      "399:    entry.filename_len--;",
      "",
      "[Added Lines]",
      "399:    if(entry.filename_len > 1) {",
      "400:     entry.filename_len--;",
      "401:    }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e78ac461dbefb7c4a3e9fde78d50fbc56b7b0183",
      "candidate_info": {
        "commit_hash": "e78ac461dbefb7c4a3e9fde78d50fbc56b7b0183",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/e78ac461dbefb7c4a3e9fde78d50fbc56b7b0183",
        "files": [
          "ext/phar/dirstream.c",
          "ext/phar/tests/bug70433.phpt",
          "ext/phar/tests/bug70433.zip"
        ],
        "message": "FIx bug #70433 - Uninitialized pointer in phar_make_dirstream when zip entry filename is \"/\"",
        "before_after_code_files": [
          "ext/phar/dirstream.c||ext/phar/dirstream.c",
          "ext/phar/tests/bug70433.phpt||ext/phar/tests/bug70433.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/dirstream.c||ext/phar/dirstream.c"
          ],
          "candidate": [
            "ext/phar/dirstream.c||ext/phar/dirstream.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/dirstream.c||ext/phar/dirstream.c": [
          "File: ext/phar/dirstream.c -> ext/phar/dirstream.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "207:  zend_hash_internal_pointer_reset(manifest);",
          "209:  while (FAILURE != zend_hash_has_more_elements(manifest)) {",
          "211:    break;",
          "212:   }",
          "",
          "[Removed Lines]",
          "210:   if (HASH_KEY_NON_EXISTENT == zend_hash_get_current_key_ex(manifest, &key, &keylen, &unused, 0, NULL)) {",
          "",
          "[Added Lines]",
          "210:   if (HASH_KEY_IS_STRING != zend_hash_get_current_key_ex(manifest, &key, &keylen, &unused, 0, NULL)) {",
          "",
          "---------------"
        ],
        "ext/phar/tests/bug70433.phpt||ext/phar/tests/bug70433.phpt": [
          "File: ext/phar/tests/bug70433.phpt -> ext/phar/tests/bug70433.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Phar - bug #70433 - Uninitialized pointer in phar_make_dirstream when zip entry filename is \"/\"",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
          "5: --FILE--",
          "6: <?php",
          "7: $phar = new PharData(__DIR__.\"/bug70433.zip\");",
          "8: var_dump($phar);",
          "9: $meta = $phar->getMetadata();",
          "10: var_dump($meta);",
          "11: ?>",
          "12: DONE",
          "13: --EXPECTF--",
          "14: object(PharData)#1 (3) {",
          "15:   [\"pathName\":\"SplFileInfo\":private]=>",
          "16:   string(0) \"\"",
          "17:   [\"glob\":\"DirectoryIterator\":private]=>",
          "18:   bool(false)",
          "19:   [\"subPathName\":\"RecursiveDirectoryIterator\":private]=>",
          "20:   string(0) \"\"",
          "21: }",
          "22: NULL",
          "23: DONE",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a8dfa57571afbe815f213f1fe74ee1f8704e408a",
      "candidate_info": {
        "commit_hash": "a8dfa57571afbe815f213f1fe74ee1f8704e408a",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/a8dfa57571afbe815f213f1fe74ee1f8704e408a",
        "files": [
          "ext/phar/dirstream.c",
          "ext/phar/util.c",
          "ext/phar/zip.c"
        ],
        "message": "Merge branch 'PHP-5.5' into PHP-5.6\n\n* PHP-5.5:\n  Better fix for bug #70433\n\nConflicts:\n\text/phar/dirstream.c",
        "before_after_code_files": [
          "ext/phar/dirstream.c||ext/phar/dirstream.c",
          "ext/phar/util.c||ext/phar/util.c",
          "ext/phar/zip.c||ext/phar/zip.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/dirstream.c||ext/phar/dirstream.c",
            "ext/phar/util.c||ext/phar/util.c",
            "ext/phar/zip.c||ext/phar/zip.c"
          ],
          "candidate": [
            "ext/phar/dirstream.c||ext/phar/dirstream.c",
            "ext/phar/util.c||ext/phar/util.c",
            "ext/phar/zip.c||ext/phar/zip.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/dirstream.c||ext/phar/dirstream.c": [
          "File: ext/phar/dirstream.c -> ext/phar/dirstream.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "198:  zend_hash_internal_pointer_reset(manifest);",
          "200:  while (FAILURE != zend_hash_has_more_elements(manifest)) {",
          "202:    break;",
          "203:   }",
          "",
          "[Removed Lines]",
          "201:   if (HASH_KEY_IS_STRING != zend_hash_get_current_key_ex(manifest, &str_key, &keylen, &unused, 0, NULL)) {",
          "",
          "[Added Lines]",
          "201:   if (HASH_KEY_NON_EXISTENT == zend_hash_get_current_key_ex(manifest, &str_key, &keylen, &unused, 0, NULL)) {",
          "",
          "---------------"
        ],
        "ext/phar/util.c||ext/phar/util.c": [
          "File: ext/phar/util.c -> ext/phar/util.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1971:  while ((s = zend_memrchr(filename, '/', filename_len))) {",
          "1972:   filename_len = s - filename;",
          "1974:    break;",
          "1975:   }",
          "1976:  }",
          "",
          "[Removed Lines]",
          "1973:   if (FAILURE == zend_hash_add_empty_element(&phar->virtual_dirs, filename, filename_len)) {",
          "",
          "[Added Lines]",
          "1973:   if (!filename_len || FAILURE == zend_hash_add_empty_element(&phar->virtual_dirs, filename, filename_len)) {",
          "",
          "---------------"
        ],
        "ext/phar/zip.c||ext/phar/zip.c": [
          "File: ext/phar/zip.c -> ext/phar/zip.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "397:   if (entry.filename[entry.filename_len - 1] == '/') {",
          "398:    entry.is_dir = 1;",
          "400:    entry.flags |= PHAR_ENT_PERM_DEF_DIR;",
          "401:   } else {",
          "402:    entry.is_dir = 0;",
          "",
          "[Removed Lines]",
          "399:    entry.filename_len--;",
          "",
          "[Added Lines]",
          "399:    if(entry.filename_len > 1) {",
          "400:     entry.filename_len--;",
          "401:    }",
          "",
          "---------------"
        ]
      }
    }
  ]
}