{
  "cve_id": "CVE-2019-19880",
  "cve_desc": "exprListAppendList in window.c in SQLite 3.30.1 allows attackers to trigger an invalid pointer dereference because constant integer values in ORDER BY clauses of window definitions are mishandled.",
  "repo": "sqlite/sqlite",
  "patch_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
  "patch_info": {
    "commit_hash": "75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/75e95e1fcd52d3ec8282edb75ac8cd0814095d54",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/window.c"
    ],
    "message": "When processing constant integer values in ORDER BY clauses of window definitions (see check-in [7e4809eadfe99ebf]) be sure to fully disable the constant value to avoid an invalid pointer dereference if the expression is ever duplicated. This fixes a crash report from Yongheng and Rui.\n\nFossilOrigin-Name: 1ca0bd982ab1183bbafce0d260e4dceda5eb766ed2e7793374a88d1ae0bdd2ca",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/window.c||src/window.c"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8223e79f987feda5c8e51ec52cec6798cca16d070b10558939e2888ca1a25b8e",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/window.c||src/window.c": [
      "File: src/window.c -> src/window.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "895:     int nInit = pList ? pList->nExpr : 0;",
      "896:     for(i=0; i<pAppend->nExpr; i++){",
      "897:       Expr *pDup = sqlite3ExprDup(pParse->db, pAppend->a[i].pExpr, 0);",
      "898:       if( bIntToNull && pDup && pDup->op==TK_INTEGER ){",
      "899:         pDup->op = TK_NULL;",
      "900:         pDup->flags &= ~(EP_IntValue|EP_IsTrue|EP_IsFalse);",
      "901:       }",
      "902:       pList = sqlite3ExprListAppend(pParse, pList, pDup);",
      "903:       if( pList ) pList->a[nInit+i].sortFlags = pAppend->a[i].sortFlags;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "898:       assert( pDup==0 || !ExprHasProperty(pDup, EP_MemToken) );",
      "902:         pDup->u.zToken = 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "427db2d2452d52075feb28f4ae33e65978dc0dc4",
      "candidate_info": {
        "commit_hash": "427db2d2452d52075feb28f4ae33e65978dc0dc4",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/427db2d2452d52075feb28f4ae33e65978dc0dc4",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbemem.c"
        ],
        "message": "Make the testcase() macro added in the previous check-in reachable for testing.\n\nFossilOrigin-Name: 80704a16f6dbbeacc65fa36a3623df10292a28aeacf9e2c1d2891258479e3b89",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbemem.c||src/vdbemem.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: df58774e994bd306b1a2e1f259e7e4408f01c5b1dc104673698168bbf8a63ce5",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbemem.c||src/vdbemem.c": [
          "File: src/vdbemem.c -> src/vdbemem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "302:   int nByte;",
          "303:   assert( pMem->flags & MEM_Zero );",
          "304:   assert( (pMem->flags&MEM_Blob)!=0 || MemNullNochng(pMem) );",
          "306:   assert( !sqlite3VdbeMemIsRowSet(pMem) );",
          "307:   assert( pMem->db==0 || sqlite3_mutex_held(pMem->db->mutex) );",
          "",
          "[Removed Lines]",
          "305:   testcase( MemNullNochng(pMem) )",
          "",
          "[Added Lines]",
          "305:   testcase( sqlite3_value_nochange(pMem) );",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6e0a75a2b8867e0597377d6a11b064b5d27b3a88",
      "candidate_info": {
        "commit_hash": "6e0a75a2b8867e0597377d6a11b064b5d27b3a88",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/6e0a75a2b8867e0597377d6a11b064b5d27b3a88",
        "files": [
          "ext/fts5/fts5_vocab.c",
          "ext/fts5/test/fts5vocab.test",
          "manifest",
          "manifest.uuid"
        ],
        "message": "Fix a crash in the fts5vocab module caused by including a \"term < NULL\" term in a WHERE clause.\n\nFossilOrigin-Name: 9e717c4377c0116a5d36815fbc30f8b8803f14770d30be361feb27cc5b5b537b",
        "before_after_code_files": [
          "ext/fts5/fts5_vocab.c||ext/fts5/fts5_vocab.c",
          "ext/fts5/test/fts5vocab.test||ext/fts5/test/fts5vocab.test",
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts5/fts5_vocab.c||ext/fts5/fts5_vocab.c": [
          "File: ext/fts5/fts5_vocab.c -> ext/fts5/fts5_vocab.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "561:         if( rc==SQLITE_OK ){",
          "562:           zTerm = sqlite3Fts5IterTerm(pCsr->pIter, &nTerm);",
          "564:           if( nTerm!=pCsr->term.n",
          "565:           || (nTerm>0 && memcmp(zTerm, pCsr->term.p, nTerm))",
          "566:           ){",
          "",
          "[Removed Lines]",
          "563:           assert_nc( nTerm>0 );",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "621:     }",
          "622:     if( pLe ){",
          "623:       const char *zCopy = (const char *)sqlite3_value_text(pLe);",
          "624:       pCsr->nLeTerm = sqlite3_value_bytes(pLe);",
          "625:       pCsr->zLeTerm = sqlite3_malloc(pCsr->nLeTerm+1);",
          "626:       if( pCsr->zLeTerm==0 ){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "623:       if( zCopy==0 ) zCopy = \"\";",
          "",
          "---------------"
        ],
        "ext/fts5/test/fts5vocab.test||ext/fts5/test/fts5vocab.test": [
          "File: ext/fts5/test/fts5vocab.test -> ext/fts5/test/fts5vocab.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "523:   set res",
          "524: } {3 5 7}",
          "526: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "526: do_execsql_test 10.6.1 {",
          "527:   SELECT * FROM t2 WHERE term<NULL;",
          "528: }",
          "529: do_execsql_test 10.6.2 {",
          "530:   SELECT * FROM t2 WHERE term>NULL;",
          "531: }",
          "532: do_execsql_test 10.6.3 {",
          "533:   SELECT * FROM t2 WHERE term=NULL;",
          "534: }",
          "535: do_execsql_test 10.7.1 {",
          "536:   SELECT * FROM t2 WHERE term<?;",
          "537: }",
          "538: do_execsql_test 10.7.2 {",
          "539:   SELECT * FROM t2 WHERE term>?;",
          "540: }",
          "541: do_execsql_test 10.7.3 {",
          "542:   SELECT * FROM t2 WHERE term=?;",
          "543: }",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 55c5d72af9510e2f27c33544d804a58d4282b0efb384ead38484129ce91b574f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bedf84c17bb5b5a811cd395892c1f89f5f458b70",
      "candidate_info": {
        "commit_hash": "bedf84c17bb5b5a811cd395892c1f89f5f458b70",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/bedf84c17bb5b5a811cd395892c1f89f5f458b70",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c"
        ],
        "message": "Fix an assert() that [28196d89] caused to fail.\n\nFossilOrigin-Name: 8fb0c6d5a38e77aa4c5f394fb8af1b0c7c6a4790e932aabc213a3078ee9acaf6",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 28196d894ac9fad9d8f877c7bf17ec9d299d12acdcc942f9ea0783777b14fdc5",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "619: #ifdef SQLITE_DEBUG",
          "623:   int nLookaside = 0;",
          "625:     nLookaside = sqlite3LookasideUsed(db, 0);",
          "626:   }",
          "627: #endif",
          "",
          "[Removed Lines]",
          "624:   if( db && (pTable->tabFlags & TF_Ephemeral)==0 ){",
          "",
          "[Added Lines]",
          "628:   if( db && !db->mallocFailed && (pTable->tabFlags & TF_Ephemeral)==0 ){",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "16d7e87caa1e02fabf6c226f1c0cf89c820c6a73",
      "candidate_info": {
        "commit_hash": "16d7e87caa1e02fabf6c226f1c0cf89c820c6a73",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/16d7e87caa1e02fabf6c226f1c0cf89c820c6a73",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbemem.c"
        ],
        "message": "Further simplifications to sqlite3VdbeMemSetStr().\n\nFossilOrigin-Name: 1d212957079a2caa30f3c9d80f43464781bc9634c2b5181a5814efbddae31711",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbemem.c||src/vdbemem.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 5c499da8a4d0babc56883aa362ae124772fd9214a51169a88a5dee523d051658",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbemem.c||src/vdbemem.c": [
          "File: src/vdbemem.c -> src/vdbemem.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1045:     assert( enc!=0 );",
          "1046:     if( enc==SQLITE_UTF8 ){",
          "1047:       nByte = 0x7fffffff & (int)strlen(z);",
          "1049:     }else{",
          "1050:       for(nByte=0; nByte<=iLimit && (z[nByte] | z[nByte+1]); nByte+=2){}",
          "1051:     }",
          "",
          "[Removed Lines]",
          "1048:       if( nByte>iLimit ) nByte = iLimit+1;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1059:   if( xDel==SQLITE_TRANSIENT ){",
          "1061:     if( flags&MEM_Term ){",
          "1062:       nAlloc += (enc==SQLITE_UTF8?1:2);",
          "1063:     }",
          "",
          "[Removed Lines]",
          "1060:     int nAlloc = nByte;",
          "",
          "[Added Lines]",
          "1059:     u32 nAlloc = nByte;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1067:     testcase( nAlloc==0 );",
          "1068:     testcase( nAlloc==31 );",
          "1069:     testcase( nAlloc==32 );",
          "1071:       return SQLITE_NOMEM_BKPT;",
          "1072:     }",
          "1073:     memcpy(pMem->z, z, nAlloc);",
          "1078:   }else{",
          "1079:     sqlite3VdbeMemRelease(pMem);",
          "1080:     pMem->z = (char *)z;",
          "1083:   }",
          "1085:   pMem->n = nByte;",
          "",
          "[Removed Lines]",
          "1070:     if( sqlite3VdbeMemClearAndResize(pMem, MAX(nAlloc,32)) ){",
          "1074:   }else if( xDel==SQLITE_DYNAMIC ){",
          "1075:     sqlite3VdbeMemRelease(pMem);",
          "1076:     pMem->zMalloc = pMem->z = (char *)z;",
          "1077:     pMem->szMalloc = sqlite3DbMallocSize(pMem->db, pMem->zMalloc);",
          "1081:     pMem->xDel = xDel;",
          "1082:     flags |= ((xDel==SQLITE_STATIC)?MEM_Static:MEM_Dyn);",
          "",
          "[Added Lines]",
          "1069:     if( sqlite3VdbeMemClearAndResize(pMem, (int)MAX(nAlloc,32)) ){",
          "1076:     if( xDel==SQLITE_DYNAMIC ){",
          "1077:       pMem->zMalloc = pMem->z;",
          "1078:       pMem->szMalloc = sqlite3DbMallocSize(pMem->db, pMem->zMalloc);",
          "1079:     }else{",
          "1080:       pMem->xDel = xDel;",
          "1081:       flags |= ((xDel==SQLITE_STATIC)?MEM_Static:MEM_Dyn);",
          "1082:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "397a78d4a1864111f488a51d296810e7ef037893",
      "candidate_info": {
        "commit_hash": "397a78d4a1864111f488a51d296810e7ef037893",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/397a78d4a1864111f488a51d296810e7ef037893",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/alter.c",
          "test/altertab.test"
        ],
        "message": "In defensive mode, do not allow shadow tables to be renamed using ALTER TABLE.\n\nFossilOrigin-Name: 23e200da5cfbde0798e67cd9e016e4a1cd73b67981e1af841493fcd123d8f547",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/alter.c||src/alter.c",
          "test/altertab.test||test/altertab.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: d64f248da3ce7762fe2c17fbc83f7bea9ffca73723bb3ad0982a85320839da90",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/alter.c||src/alter.c": [
          "File: src/alter.c -> src/alter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34:     return 1;",
          "35:   }",
          "36:   return 0;",
          "",
          "[Removed Lines]",
          "31: static int isSystemTable(Parse *pParse, const char *zName){",
          "32:   if( 0==sqlite3StrNICmp(zName, \"sqlite_\", 7) ){",
          "33:     sqlite3ErrorMsg(pParse, \"table %s may not be altered\", zName);",
          "",
          "[Added Lines]",
          "31: static int isAlterableTable(Parse *pParse, Table *pTab){",
          "32:   if( 0==sqlite3StrNICmp(pTab->zName, \"sqlite_\", 7)",
          "33: #ifndef SQLITE_OMIT_VIRTUALTABLE",
          "34:    || ( (pTab->tabFlags & TF_Shadow)",
          "35:      && (pParse->db->flags & SQLITE_Defensive)",
          "36:      && pParse->db->nVdbeExec==0",
          "37:    )",
          "38: #endif",
          "39:   ){",
          "40:     sqlite3ErrorMsg(pParse, \"table %s may not be altered\", pTab->zName);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "130:     goto exit_rename_table;",
          "131:   }",
          "132:   if( SQLITE_OK!=sqlite3CheckObjectName(pParse, zName) ){ goto",
          "",
          "[Removed Lines]",
          "129:   if( SQLITE_OK!=isSystemTable(pParse, pTab->zName) ){",
          "",
          "[Added Lines]",
          "136:   if( SQLITE_OK!=isAlterableTable(pParse, pTab) ){",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "424:     sqlite3ErrorMsg(pParse, \"Cannot add a column to a view\");",
          "425:     goto exit_begin_add_column;",
          "426:   }",
          "428:     goto exit_begin_add_column;",
          "429:   }",
          "",
          "[Removed Lines]",
          "427:   if( SQLITE_OK!=isSystemTable(pParse, pTab->zName) ){",
          "",
          "[Added Lines]",
          "434:   if( SQLITE_OK!=isAlterableTable(pParse, pTab) ){",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "526:   if( !pTab ) goto exit_rename_column;",
          "530:   if( SQLITE_OK!=isRealTable(pParse, pTab) ) goto exit_rename_column;",
          "",
          "[Removed Lines]",
          "529:   if( SQLITE_OK!=isSystemTable(pParse, pTab->zName) ) goto exit_rename_column;",
          "",
          "[Added Lines]",
          "536:   if( SQLITE_OK!=isAlterableTable(pParse, pTab) ) goto exit_rename_column;",
          "",
          "---------------"
        ],
        "test/altertab.test||test/altertab.test": [
          "File: test/altertab.test -> test/altertab.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "505:   SELECT sql FROM sqlite_master WHERE name = 'y';",
          "506: } {{CREATE VIEW y AS SELECT f2 AS f1 FROM x}}",
          "509: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "508: #-------------------------------------------------------------------------",
          "509: # Test that it is not possible to rename a shadow table in DEFENSIVE mode.",
          "510: #",
          "511: ifcapable fts3 {",
          "512:   proc vtab_command {method args} {",
          "513:     switch -- $method {",
          "514:       xConnect {",
          "515:         if {[info exists ::vtab_connect_sql]} {",
          "516:           execsql $::vtab_connect_sql",
          "517:         }",
          "518:         return \"CREATE TABLE t1(a, b, c)\"",
          "519:       }",
          "521:       xBestIndex {",
          "522:         set clist [lindex $args 0]",
          "523:         if {[llength $clist]!=1} { error \"unexpected constraint list\" }",
          "524:         catch { array unset C }",
          "525:         array set C [lindex $clist 0]",
          "526:         if {$C(usable)} {",
          "527:           return \"omit 0 cost 0 rows 1 idxnum 555 idxstr eq!\"",
          "528:         } else {",
          "529:           return \"cost 1000000 rows 0 idxnum 0 idxstr scan...\"",
          "530:         }",
          "531:       }",
          "532:     }",
          "534:     return {}",
          "535:   }",
          "537:   register_tcl_module db",
          "539:   sqlite3_db_config db DEFENSIVE 1",
          "541:   do_execsql_test 16.0 {",
          "542:     CREATE VIRTUAL TABLE y1 USING fts3;",
          "543:   }",
          "545:   do_catchsql_test 16.1 {",
          "546:     INSERT INTO y1_segments VALUES(1, X'1234567890');",
          "547:   } {1 {table y1_segments may not be modified}}",
          "549:   do_catchsql_test 16.2 {",
          "550:     ALTER TABLE y1_segments RENAME TO abc;",
          "551:   } {1 {table y1_segments may not be altered}}",
          "553:   do_execsql_test 16.3 {",
          "554:     ALTER TABLE y1 RENAME TO z1;",
          "555:   }",
          "557:   do_execsql_test 16.4 {",
          "558:     SELECT * FROM z1_segments;",
          "559:   }",
          "560: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}