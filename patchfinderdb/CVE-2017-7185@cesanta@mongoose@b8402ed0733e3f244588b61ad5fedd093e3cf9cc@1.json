{
  "cve_id": "CVE-2017-7185",
  "cve_desc": "Use-after-free vulnerability in the mg_http_multipart_wait_for_boundary function in mongoose.c in Cesanta Mongoose Embedded Web Server Library 6.7 and earlier and Mongoose OS 1.2 and earlier allows remote attackers to cause a denial of service (crash) via a multipart/form-data POST request without a MIME boundary string.",
  "repo": "cesanta/mongoose",
  "patch_hash": "b8402ed0733e3f244588b61ad5fedd093e3cf9cc",
  "patch_info": {
    "commit_hash": "b8402ed0733e3f244588b61ad5fedd093e3cf9cc",
    "repo": "cesanta/mongoose",
    "commit_url": "https://github.com/cesanta/mongoose/commit/b8402ed0733e3f244588b61ad5fedd093e3cf9cc",
    "files": [
      "mongoose.c"
    ],
    "message": "Fix crash in multipart handling\n\nClose cesanta/dev#6974\n\nPUBLISHED_FROM=4d4e4a46eceba10aec8dacb7f8f58bd078c92307",
    "before_after_code_files": [
      "mongoose.c||mongoose.c"
    ]
  },
  "patch_diff": {
    "mongoose.c||mongoose.c": [
      "File: mongoose.c -> mongoose.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "5961:   struct mbuf *io = &c->recv_mbuf;",
      "5962:   struct mg_http_proto_data *pd = mg_http_get_proto_data(c);",
      "5964:   if ((int) io->len < pd->mp_stream.boundary_len + 2) {",
      "5965:     return 0;",
      "5966:   }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "5964:   if (pd->mp_stream.boundary == NULL) {",
      "5965:     pd->mp_stream.state = MPS_FINALIZE;",
      "5966:     DBG((\"Invalid request: boundary not initilaized\"));",
      "5967:     return 0;",
      "5968:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "49ca223e9cb7c724decf1e8e1bf41dd725684c0b",
      "candidate_info": {
        "commit_hash": "49ca223e9cb7c724decf1e8e1bf41dd725684c0b",
        "repo": "cesanta/mongoose",
        "commit_url": "https://github.com/cesanta/mongoose/commit/49ca223e9cb7c724decf1e8e1bf41dd725684c0b",
        "files": [
          "mongoose.c"
        ],
        "message": "Minor memory optimization\n\nRelease pbuf sooner: after copying data from, before invoking user code\n\nPUBLISHED_FROM=b877c96ef602bbca26762b18b9dde17eb880d1f9",
        "before_after_code_files": [
          "mongoose.c||mongoose.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/cesanta/mongoose/pull/855"
        ],
        "olp_code_files": {
          "patch": [
            "mongoose.c||mongoose.c"
          ],
          "candidate": [
            "mongoose.c||mongoose.c"
          ]
        }
      },
      "candidate_diff": {
        "mongoose.c||mongoose.c": [
          "File: mongoose.c -> mongoose.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "13928:       return;",
          "13929:     }",
          "13930:     pbuf_copy_partial(seg, data, len, cs->rx_offset);",
          "13934:     cs->rx_offset += len;",
          "13935:     if (cs->rx_offset == cs->rx_chain->len) {",
          "13936:       cs->rx_chain = pbuf_dechain(cs->rx_chain);",
          "13937:       pbuf_free(seg);",
          "13938:       cs->rx_offset = 0;",
          "13939:     }",
          "13940:   }",
          "13941:   mgos_unlock();",
          "",
          "[Removed Lines]",
          "13931:     mgos_unlock();",
          "13932:     mg_if_recv_tcp_cb(nc, data, len, 1 /* own */);",
          "13933:     mgos_lock();",
          "",
          "[Added Lines]",
          "13937:     mgos_unlock();",
          "13938:     mg_if_recv_tcp_cb(nc, data, len, 1 /* own */);",
          "13939:     mgos_lock();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f374ac5f9a1eb814e1bc2413aeda66be2162f363",
      "candidate_info": {
        "commit_hash": "f374ac5f9a1eb814e1bc2413aeda66be2162f363",
        "repo": "cesanta/mongoose",
        "commit_url": "https://github.com/cesanta/mongoose/commit/f374ac5f9a1eb814e1bc2413aeda66be2162f363",
        "files": [
          "mongoose.c"
        ],
        "message": "Do not close already closed connection\n\nPUBLISHED_FROM=9e345f2319141f20b89e28a2d29adba21ea213e1",
        "before_after_code_files": [
          "mongoose.c||mongoose.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/cesanta/mongoose/pull/855"
        ],
        "olp_code_files": {
          "patch": [
            "mongoose.c||mongoose.c"
          ],
          "candidate": [
            "mongoose.c||mongoose.c"
          ]
        }
      },
      "candidate_diff": {
        "mongoose.c||mongoose.c": [
          "File: mongoose.c -> mongoose.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "14230:   struct mg_connection *nc = (struct mg_connection *) arg;",
          "14231:   DBG((\"%p %p %u %d\", nc, tpcb, (p != NULL ? p->tot_len : 0), err));",
          "14232:   if (p == NULL) {",
          "14234:       mg_lwip_post_signal(MG_SIG_CLOSE_CONN, nc);",
          "14235:     } else {",
          "",
          "[Removed Lines]",
          "14233:     if (nc != NULL) {",
          "",
          "[Added Lines]",
          "14233:     if (nc != NULL && !(nc->flags & MG_F_CLOSE_IMMEDIATELY)) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f62018451f7868544aee63ff67599ef92a0e8dda",
      "candidate_info": {
        "commit_hash": "f62018451f7868544aee63ff67599ef92a0e8dda",
        "repo": "cesanta/mongoose",
        "commit_url": "https://github.com/cesanta/mongoose/commit/f62018451f7868544aee63ff67599ef92a0e8dda",
        "files": [
          "mongoose.c"
        ],
        "message": "Fix subscription parsing in MQTT broker\n\nAlso, do not accept PUBLISH and SUBSCRIBE before a sucessful CONNECT.\n\nPUBLISHED_FROM=b5096cdc2ec5da1358244c428efbbb2e20be1a05",
        "before_after_code_files": [
          "mongoose.c||mongoose.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/cesanta/mongoose/pull/855"
        ],
        "olp_code_files": {
          "patch": [
            "mongoose.c||mongoose.c"
          ],
          "candidate": [
            "mongoose.c||mongoose.c"
          ]
        }
      },
      "candidate_diff": {
        "mongoose.c||mongoose.c": [
          "File: mongoose.c -> mongoose.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "10234: int mg_mqtt_next_subscribe_topic(struct mg_mqtt_message *msg,",
          "10235:                                  struct mg_str *topic, uint8_t *qos, int pos) {",
          "10236:   unsigned char *buf = (unsigned char *) msg->payload.p + pos;",
          "10242:   topic->len = buf[0] << 8 | buf[1];",
          "10243:   topic->p = (char *) buf + 2;",
          "10246: }",
          "10248: void mg_mqtt_unsubscribe(struct mg_connection *nc, char **topics,",
          "",
          "[Removed Lines]",
          "10238:   if ((size_t) pos >= msg->payload.len) {",
          "10239:     return -1;",
          "10240:   }",
          "10245:   return pos + 2 + topic->len + 1;",
          "",
          "[Added Lines]",
          "10237:   int new_pos;",
          "10239:   if ((size_t) pos >= msg->payload.len) return -1;",
          "10244:   new_pos = pos + 2 + topic->len + 1;",
          "10245:   if ((size_t) new_pos > msg->payload.len) return -1;",
          "10246:   return new_pos;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "10468:       break;",
          "10469:     case MG_EV_MQTT_CONNECT:",
          "10471:       break;",
          "10472:     case MG_EV_MQTT_SUBSCRIBE:",
          "10474:       break;",
          "10475:     case MG_EV_MQTT_PUBLISH:",
          "10477:       break;",
          "10478:     case MG_EV_CLOSE:",
          "10479:       if (nc->listener && nc->user_data != NULL) {",
          "",
          "[Removed Lines]",
          "10470:       mg_mqtt_broker_handle_connect(brk, nc);",
          "10473:       mg_mqtt_broker_handle_subscribe(nc, msg);",
          "10476:       mg_mqtt_broker_handle_publish(brk, msg);",
          "",
          "[Added Lines]",
          "10471:       if (nc->user_data == NULL) {",
          "10472:         mg_mqtt_broker_handle_connect(brk, nc);",
          "10473:       } else {",
          "10475:         nc->flags |= MG_F_CLOSE_IMMEDIATELY;",
          "10476:       }",
          "10479:       if (nc->user_data != NULL) {",
          "10480:         mg_mqtt_broker_handle_subscribe(nc, msg);",
          "10481:       } else {",
          "10483:         nc->flags |= MG_F_CLOSE_IMMEDIATELY;",
          "10484:       }",
          "10487:       if (nc->user_data != NULL) {",
          "10488:         mg_mqtt_broker_handle_publish(brk, msg);",
          "10489:       } else {",
          "10491:         nc->flags |= MG_F_CLOSE_IMMEDIATELY;",
          "10492:       }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "448b44094a04264162197086e765defee8afae1e",
      "candidate_info": {
        "commit_hash": "448b44094a04264162197086e765defee8afae1e",
        "repo": "cesanta/mongoose",
        "commit_url": "https://github.com/cesanta/mongoose/commit/448b44094a04264162197086e765defee8afae1e",
        "files": [
          "mongoose.c",
          "mongoose.h"
        ],
        "message": "Add automated check for extern \"C\"\n\nFix headers that didn't have it\n\nPUBLISHED_FROM=ce8140783d4b661f16278a4a5adc957b21965473",
        "before_after_code_files": [
          "mongoose.c||mongoose.c",
          "mongoose.h||mongoose.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/cesanta/mongoose/pull/855"
        ],
        "olp_code_files": {
          "patch": [
            "mongoose.c||mongoose.c"
          ],
          "candidate": [
            "mongoose.c||mongoose.c"
          ]
        }
      },
      "candidate_diff": {
        "mongoose.c||mongoose.c": [
          "File: mongoose.c -> mongoose.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "165: #ifndef CS_COMMON_MG_MEM_H_",
          "166: #define CS_COMMON_MG_MEM_H_",
          "168: #ifndef MG_MALLOC",
          "169: #define MG_MALLOC malloc",
          "170: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "168: #ifdef __cplusplus",
          "169: extern \"C\" {",
          "170: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "181: #define MG_FREE free",
          "182: #endif",
          "185: #ifdef MG_MODULE_LINES",
          "186: #line 1 \"common/cs_dbg.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "188: #ifdef __cplusplus",
          "189: }",
          "190: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "782: #ifndef CS_COMMON_CS_ENDIAN_H_",
          "783: #define CS_COMMON_CS_ENDIAN_H_",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "793: #ifdef __cplusplus",
          "794: extern \"C\" {",
          "795: #endif",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "801: #ifdef MG_MODULE_LINES",
          "802: #line 1 \"common/cs_md5.c\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "812: #ifdef __cplusplus",
          "813: }",
          "814: #endif",
          "",
          "---------------"
        ],
        "mongoose.h||mongoose.h": [
          "File: mongoose.h -> mongoose.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "560: #ifndef MG_NET_IF",
          "561: #include <lwip/opt.h>",
          "564: #else",
          "566: #endif",
          "567: #endif",
          "",
          "[Removed Lines]",
          "563: #  define MG_NET_IF MG_NET_IF_SOCKET",
          "565: #  define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "",
          "[Added Lines]",
          "563: #define MG_NET_IF MG_NET_IF_SOCKET",
          "565: #define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "604: #include <simplelink.h>",
          "605: #include <netapp.h>",
          "608: typedef int sock_t;",
          "609: #define INVALID_SOCKET (-1)",
          "",
          "[Removed Lines]",
          "606: #undef timeval",
          "",
          "[Added Lines]",
          "606: #undef timeval",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "840: #define CS_ENABLE_STDIO 1",
          "841: #endif",
          "844: #define MG_ENABLE_FILESYSTEM 1",
          "845: #endif",
          "",
          "[Removed Lines]",
          "843: #if (defined(CC3200_FS_SPIFFS) || defined(CC3200_FS_SLFS)) && !defined(MG_ENABLE_FILESYSTEM)",
          "",
          "[Added Lines]",
          "843: #if (defined(CC3200_FS_SPIFFS) || defined(CC3200_FS_SLFS)) && \\",
          "844:     !defined(MG_ENABLE_FILESYSTEM)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "884: #define __cdecl",
          "886: #ifndef MG_NET_IF",
          "894: #elif MG_NET_IF == MG_NET_IF_SIMPLELINK",
          "896: #endif",
          "898: #ifndef CS_ENABLE_STDIO",
          "",
          "[Removed Lines]",
          "887: #  include <lwip/opt.h>",
          "888: #  if LWIP_SOCKET",
          "889: #    define MG_NET_IF MG_NET_IF_SOCKET",
          "890: #  else",
          "891: #    define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "892: #  endif",
          "893: #  define MG_LWIP 1",
          "895: #  include \"common/platforms/simplelink/cs_simplelink.h\"",
          "",
          "[Added Lines]",
          "888: #include <lwip/opt.h>",
          "889: #if LWIP_SOCKET",
          "890: #define MG_NET_IF MG_NET_IF_SOCKET",
          "891: #else",
          "892: #define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "893: #endif",
          "894: #define MG_LWIP 1",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1015: #define to64(x) strtoll(x, NULL, 10)",
          "1025: #if !defined(__ARMCC_VERSION)",
          "1027: #else",
          "1028: struct timeval;",
          "1029: int gettimeofday(struct timeval *tp, void *tzp);",
          "",
          "[Removed Lines]",
          "1017: #define MG_NET_IF             MG_NET_IF_LWIP_LOW_LEVEL",
          "1018: #define MG_LWIP               1",
          "1019: #define MG_ENABLE_IPV6        1",
          "1026: # define LWIP_TIMEVAL_PRIVATE  0",
          "",
          "[Added Lines]",
          "1018: #define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "1019: #define MG_LWIP 1",
          "1020: #define MG_ENABLE_IPV6 1",
          "1027: #define LWIP_TIMEVAL_PRIVATE 0",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1061: #define to64(x) strtoll(x, NULL, 10)",
          "1067: #if !defined(ENOSPC)",
          "1069: #endif",
          "",
          "[Removed Lines]",
          "1063: #define MG_NET_IF             MG_NET_IF_LWIP_LOW_LEVEL",
          "1064: #define MG_LWIP               1",
          "1065: #define MG_ENABLE_IPV6        1",
          "",
          "[Added Lines]",
          "1064: #define MG_NET_IF MG_NET_IF_LWIP_LOW_LEVEL",
          "1065: #define MG_LWIP 1",
          "1066: #define MG_ENABLE_IPV6 1",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1075: #if !defined(__ARMCC_VERSION)",
          "1077: #endif",
          "1079: #define INT64_FMT PRId64",
          "",
          "[Removed Lines]",
          "1076: # define LWIP_TIMEVAL_PRIVATE  0",
          "",
          "[Added Lines]",
          "1077: #define LWIP_TIMEVAL_PRIVATE 0",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1377: #endif",
          "1379: #ifndef _UINTPTR_T_DEFINED",
          "1381: #endif",
          "1383: #define _S_IFREG 2",
          "1384: #define _S_IFDIR 4",
          "1386: #ifndef S_ISDIR",
          "1388: #endif",
          "1390: #ifndef S_ISREG",
          "1392: #endif",
          "1394: int open(const char *filename, int oflag, int pmode);",
          "",
          "[Removed Lines]",
          "1380: typedef unsigned int* uintptr_t;",
          "1387: #define S_ISDIR(x) (((x) & _S_IFDIR) != 0)",
          "1391: #define S_ISREG(x) (((x) & _S_IFREG) != 0)",
          "",
          "[Added Lines]",
          "1381: typedef unsigned int *uintptr_t;",
          "1388: #define S_ISDIR(x) (((x) &_S_IFDIR) != 0)",
          "1392: #define S_ISREG(x) (((x) &_S_IFREG) != 0)",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1521: #define CS_ENABLE_STDIO 1",
          "1522: #endif",
          "",
          "[Removed Lines]",
          "1524: char* inet_ntoa(struct in_addr in);",
          "",
          "[Added Lines]",
          "1526: char *inet_ntoa(struct in_addr in);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1760: #ifdef __cplusplus",
          "1761: extern \"C\" {",
          "1765: struct mg_str {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1764: #endif",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "1814: #ifdef __cplusplus",
          "1815: }",
          "1819: #ifdef MG_MODULE_LINES",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1818: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5baeba53d7e5f83c4a690565bc9c02e6fafb491d",
      "candidate_info": {
        "commit_hash": "5baeba53d7e5f83c4a690565bc9c02e6fafb491d",
        "repo": "cesanta/mongoose",
        "commit_url": "https://github.com/cesanta/mongoose/commit/5baeba53d7e5f83c4a690565bc9c02e6fafb491d",
        "files": [
          "mongoose.c"
        ],
        "message": "Reorg docs\n\nPUBLISHED_FROM=657a53762ada0ab3fe715a15939eb510a637e37f",
        "before_after_code_files": [
          "mongoose.c||mongoose.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/cesanta/mongoose/pull/855"
        ],
        "olp_code_files": {
          "patch": [
            "mongoose.c||mongoose.c"
          ],
          "candidate": [
            "mongoose.c||mongoose.c"
          ]
        }
      },
      "candidate_diff": {
        "mongoose.c||mongoose.c": [
          "File: mongoose.c -> mongoose.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2783:   struct mg_add_sock_opts add_sock_opts;",
          "2784:   char host[MG_MAX_HOST_LEN];",
          "2790:   MG_COPY_COMMON_CONNECTION_OPTIONS(&add_sock_opts, &opts);",
          "2792: #if MG_ENABLE_TUN",
          "",
          "[Removed Lines]",
          "2786: #if MG_ENABLE_CALLBACK_USERDATA",
          "2787:   opts.user_data = user_data;",
          "2788: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2850:   }",
          "2851:   mg_add_conn(nc->mgr, nc);",
          "2853:   return nc;",
          "2854: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2849: #if MG_ENABLE_CALLBACK_USERDATA",
          "2850:   (void) user_data;",
          "2851: #endif",
          "",
          "---------------"
        ]
      }
    }
  ]
}