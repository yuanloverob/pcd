{
  "cve_id": "CVE-2014-2270",
  "cve_desc": "softmagic.c in file before 5.17 and libmagic allows context-dependent attackers to cause a denial of service (out-of-bounds memory access and crash) via crafted offsets in the softmagic of a PE executable.",
  "repo": "file/file",
  "patch_hash": "447558595a3650db2886cd2f416ad0beba965801",
  "patch_info": {
    "commit_hash": "447558595a3650db2886cd2f416ad0beba965801",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/447558595a3650db2886cd2f416ad0beba965801",
    "files": [
      "src/softmagic.c"
    ],
    "message": "PR/313: Aaron Reffett: Check properly for exceeding the offset.",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.170 2014/01/06 02:25:32 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.171 2014/01/08 22:02:06 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71: private void cvt_32(union VALUETYPE *, const struct magic *);",
      "72: private void cvt_64(union VALUETYPE *, const struct magic *);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "74: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) >= ((n) - (o)))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1223:   }",
      "1224:   switch (in_type = cvt_flip(m->in_type, flip)) {",
      "1225:   case FILE_BYTE:",
      "1227:     return 0;",
      "1228:    if (off) {",
      "1229:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1226:    if (nbytes < offset || nbytes < (offset + 1))",
      "",
      "[Added Lines]",
      "1227:    if (OFFSET_OOB(nbytes, offset, 1))",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1258:     offset = ~offset;",
      "1259:    break;",
      "1260:   case FILE_BESHORT:",
      "1262:     return 0;",
      "1263:    if (off) {",
      "1264:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1261:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1262:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1310:     offset = ~offset;",
      "1311:    break;",
      "1312:   case FILE_LESHORT:",
      "1314:     return 0;",
      "1315:    if (off) {",
      "1316:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1313:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1314:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1362:     offset = ~offset;",
      "1363:    break;",
      "1364:   case FILE_SHORT:",
      "1366:     return 0;",
      "1367:    if (off) {",
      "1368:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1365:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1366:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1399:    break;",
      "1400:   case FILE_BELONG:",
      "1401:   case FILE_BEID3:",
      "1403:     return 0;",
      "1404:    if (off) {",
      "1405:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1402:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1403:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1470:    break;",
      "1471:   case FILE_LELONG:",
      "1472:   case FILE_LEID3:",
      "1474:     return 0;",
      "1475:    if (off) {",
      "1476:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1473:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1474:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1540:     offset = ~offset;",
      "1541:    break;",
      "1542:   case FILE_MELONG:",
      "1544:     return 0;",
      "1545:    if (off) {",
      "1546:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1543:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1544:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1610:     offset = ~offset;",
      "1611:    break;",
      "1612:   case FILE_LONG:",
      "1614:     return 0;",
      "1615:    if (off) {",
      "1616:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1613:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1614:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1688:  switch (m->type) {",
      "1689:  case FILE_BYTE:",
      "1691:    return 0;",
      "1692:   break;",
      "1694:  case FILE_SHORT:",
      "1695:  case FILE_BESHORT:",
      "1696:  case FILE_LESHORT:",
      "1698:    return 0;",
      "1699:   break;",
      "",
      "[Removed Lines]",
      "1697:   if (nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1691:   if (OFFSET_OOB(nbytes, offset, 1))",
      "1698:   if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1713:  case FILE_FLOAT:",
      "1714:  case FILE_BEFLOAT:",
      "1715:  case FILE_LEFLOAT:",
      "1717:    return 0;",
      "1718:   break;",
      "1720:  case FILE_DOUBLE:",
      "1721:  case FILE_BEDOUBLE:",
      "1722:  case FILE_LEDOUBLE:",
      "1724:    return 0;",
      "1725:   break;",
      "1727:  case FILE_STRING:",
      "1728:  case FILE_PSTRING:",
      "1729:  case FILE_SEARCH:",
      "1731:    return 0;",
      "1732:   break;",
      "1734:  case FILE_REGEX:",
      "1736:    return 0;",
      "1737:   break;",
      "1739:  case FILE_INDIRECT:",
      "1741:    return 0;",
      "1742:   sbuf = ms->o.buf;",
      "1743:   soffset = ms->offset;",
      "",
      "[Removed Lines]",
      "1716:   if (nbytes < (offset + 4))",
      "1723:   if (nbytes < (offset + 8))",
      "1730:   if (nbytes < (offset + m->vallen))",
      "1735:   if (nbytes < offset)",
      "1740:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1717:   if (OFFSET_OOB(nbytes, offset, 4))",
      "1724:   if (OFFSET_OOB(nbytes, offset, 8))",
      "1731:   if (OFFSET_OOB(nbytes, offset, m->vallen))",
      "1736:   if (OFFSET_OOB(nbytes, offset, 0))",
      "1741:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1761:   return rv;",
      "1763:  case FILE_USE:",
      "1765:    return 0;",
      "1766:   sbuf = m->value.s;",
      "1767:   if (*sbuf == '^') {",
      "",
      "[Removed Lines]",
      "1764:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1765:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "74cafd7de9ec99a14f4480927580e501c8f852c3",
      "candidate_info": {
        "commit_hash": "74cafd7de9ec99a14f4480927580e501c8f852c3",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/74cafd7de9ec99a14f4480927580e501c8f852c3",
        "files": [
          "src/softmagic.c"
        ],
        "message": "If requested, limit search length.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.187 2014/05/13 16:42:17 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.188 2014/05/14 23:15:42 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1929:    file_regerror(&rx, rc, ms);",
          "1930:    v = (uint64_t)-1;",
          "1931:   } else {",
          "1932:    regmatch_t pmatch[1];",
          "1933: #ifndef REG_STARTEND",
          "1934: #define REG_STARTEND 0",
          "1938: #else",
          "1939:    pmatch[0].rm_so = 0;",
          "1941: #endif",
          "1942:    rc = file_regexec(&rx, (const char *)ms->search.s,",
          "1943:        1, pmatch, REG_STARTEND);",
          "",
          "[Removed Lines]",
          "1935:    size_t l = ms->search.s_len - 1;",
          "1936:    char c = ms->search.s[l];",
          "1937:    ((char *)(intptr_t)ms->search.s)[l] = '\\0';",
          "1940:    pmatch[0].rm_eo = ms->search.s_len;",
          "",
          "[Added Lines]",
          "1932: #ifndef REG_STARTEND",
          "1933:    char c;",
          "1934: #endif",
          "1936:    size_t slen = ms->search.s_len;",
          "1938:    if (m->str_range > 0)",
          "1939:     slen = MIN(slen, m->str_range);",
          "1942:    if (slen != 0)",
          "1943:     slen--;",
          "1944:    c = ms->search.s[slen];",
          "1945:    ((char *)(intptr_t)ms->search.s)[slen] = '\\0';",
          "1948:    pmatch[0].rm_eo = slen;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "59e63838913eee47f5c120a6c53d4565af638158",
      "candidate_info": {
        "commit_hash": "59e63838913eee47f5c120a6c53d4565af638158",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/59e63838913eee47f5c120a6c53d4565af638158",
        "files": [
          "src/softmagic.c"
        ],
        "message": "PR/398: Correctly truncate pascal strings (fixes out of bounds read of 1, 2, or 4 bytes).",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.195 2014/09/24 19:49:07 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "964:   size_t sz = file_pstring_length_size(m);",
          "965:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
          "966:   size_t len = file_pstring_get_length(m, ptr1);",
          "975:   }",
          "976:   while (len--)",
          "",
          "[Removed Lines]",
          "967:   if (len >= sizeof(p->s)) {",
          "974:    len = sizeof(p->s) - sz;",
          "",
          "[Added Lines]",
          "968:   if (len >= sz) {",
          "977:    len = sz;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "da78707a80a6da27324a9b534059c31d9897b329",
      "candidate_info": {
        "commit_hash": "da78707a80a6da27324a9b534059c31d9897b329",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/da78707a80a6da27324a9b534059c31d9897b329",
        "files": [
          "src/softmagic.c"
        ],
        "message": "fix compilation without fmt debug.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.180 2014/03/15 21:47:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.181 2014/03/27 18:12:12 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "90: #define FILE_FMTDEBUG",
          "91: #ifdef FILE_FMTDEBUG",
          "92: #define F(a, b, c) file_fmtcheck((a), (b), (c), __FILE__, __LINE__)",
          "97: private const char * __attribute__((__format_arg__(3)))",
          "98: file_fmtcheck(struct magic_set *ms, const struct magic *m, const char *def,",
          "",
          "[Removed Lines]",
          "93: #else",
          "94: #define F(a, b) fmtcheck((b)->desc, (c))",
          "95: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "105:       file, line, m->desc, def);",
          "106:  return ptr;",
          "107: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "105: #else",
          "106: #define F(a, b, c) fmtcheck((b)->desc, (c))",
          "107: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "eb38a6f82924cb5ad5ed3b611fa2364dcc4ba5eb",
      "candidate_info": {
        "commit_hash": "eb38a6f82924cb5ad5ed3b611fa2364dcc4ba5eb",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/eb38a6f82924cb5ad5ed3b611fa2364dcc4ba5eb",
        "files": [
          "ChangeLog",
          "configure.ac",
          "src/file.h",
          "src/funcs.c",
          "src/readcdf.c",
          "src/softmagic.c",
          "src/strcasestr.c"
        ],
        "message": "locale and strcasestr changes",
        "before_after_code_files": [
          "configure.ac||configure.ac",
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/readcdf.c||src/readcdf.c",
          "src/softmagic.c||src/softmagic.c",
          "src/strcasestr.c||src/strcasestr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "configure.ac||configure.ac": [
          "File: configure.ac -> configure.ac",
          "--- Hunk 1 ---",
          "[Context before]",
          "139: AC_CHECK_FUNCS(strerror strndup strtoul mkstemp mkostemp utimes utime wcwidth strtof)",
          "141: dnl Provide implementation of some required functions if necessary",
          "144: dnl Checks for libraries",
          "145: AC_CHECK_LIB(z,gzopen)",
          "",
          "[Removed Lines]",
          "142: AC_REPLACE_FUNCS(getopt_long asprintf vasprintf strlcpy strlcat getline ctime_r asctime_r pread)",
          "",
          "[Added Lines]",
          "142: AC_REPLACE_FUNCS(getopt_long asprintf vasprintf strlcpy strlcat getline ctime_r asctime_r pread strcasestr)",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "491: int vasprintf(char **, const char *, va_list);",
          "492: #endif",
          "493: #ifndef HAVE_ASPRINTF",
          "495: #endif",
          "497: #ifndef HAVE_STRLCPY",
          "499: #endif",
          "500: #ifndef HAVE_STRLCAT",
          "502: #endif",
          "503: #ifndef HAVE_GETLINE",
          "506: #endif",
          "507: #ifndef HAVE_CTIME_R",
          "508: char   *ctime_r(const time_t *, char *);",
          "",
          "[Removed Lines]",
          "494: int asprintf(char **ptr, const char *format_string, ...);",
          "498: size_t strlcpy(char *dst, const char *src, size_t siz);",
          "501: size_t strlcat(char *dst, const char *src, size_t siz);",
          "504: ssize_t getline(char **dst, size_t *len, FILE *fp);",
          "505: ssize_t getdelim(char **dst, size_t *len, int delimiter, FILE *fp);",
          "",
          "[Added Lines]",
          "494: int asprintf(char **, const char *, ...);",
          "498: size_t strlcpy(char *, const char *, size_t);",
          "501: size_t strlcat(char *, const char *, size_t);",
          "502: #endif",
          "503: #ifndef HAVE_STRCASESTR",
          "504: char *strcasestr(const char *, const char *);",
          "507: ssize_t getline(char **, size_t *, FILE *);",
          "508: ssize_t getdelim(char **, size_t *, int, FILE *);",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.63 2013/09/03 08:31:48 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.64 2013/11/19 23:49:44 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44: #if defined(HAVE_LIMITS_H)",
          "45: #include <limits.h>",
          "46: #endif",
          "48: #ifndef SIZE_MAX",
          "49: #define SIZE_MAX ((size_t)~0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "47: #if defined(HAVE_LOCALE_H)",
          "48: #include <locale.h>",
          "49: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "437: file_replace(struct magic_set *ms, const char *pat, const char *rep)",
          "438: {",
          "439:  regex_t rx;",
          "442:  rc = regcomp(&rx, pat, REG_EXTENDED);",
          "443:  if (rc) {",
          "444:   char errmsg[512];",
          "445:   (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "446:   file_magerror(ms, \"regex error %d, (%s)\", rc, errmsg);",
          "448:  } else {",
          "449:   regmatch_t rm;",
          "450:   int nm = 0;",
          "",
          "[Removed Lines]",
          "440:  int rc;",
          "447:   return -1;",
          "",
          "[Added Lines]",
          "443:  int rc, rv = -1;",
          "445:  (void)setlocale(LC_CTYPE, \"C\");",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "452:    ms->o.buf[rm.rm_so] = '\\0';",
          "453:    if (file_printf(ms, \"%s%s\", rep,",
          "454:        rm.rm_eo != 0 ? ms->o.buf + rm.rm_eo : \"\") == -1)",
          "456:    nm++;",
          "457:   }",
          "458:   regfree(&rx);",
          "460:  }",
          "461: }",
          "",
          "[Removed Lines]",
          "455:     return -1;",
          "459:   return nm;",
          "",
          "[Added Lines]",
          "458:     goto out;",
          "462:   rv = nm;",
          "464: out:",
          "465:  (void)setlocale(LC_CTYPE, \"\");",
          "466:  return rv;",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <stdlib.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.34 2013/10/29 18:22:45 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.35 2013/10/29 18:30:45 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "34: #include <string.h>",
          "35: #include <time.h>",
          "36: #include <ctype.h>",
          "38: #include \"cdf.h\"",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "37: #if defined(HAVE_LOCALE_H)",
          "38: #include <locale.h>",
          "39: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "70: cdf_app_to_mime(const char *vbuf, const struct nv *nv)",
          "71: {",
          "72:  size_t i;",
          "74:  for (i = 0; nv[i].pattern != NULL; i++)",
          "77:  return NULL;",
          "78: }",
          "",
          "[Removed Lines]",
          "75:   if (strstr(vbuf, nv[i].pattern) != NULL)",
          "76:    return nv[i].mime;",
          "",
          "[Added Lines]",
          "76:  const char *rv = NULL;",
          "78:  (void)setlocale(LC_CTYPE, \"C\");",
          "80:   if (strcasestr(vbuf, nv[i].pattern) != NULL) {",
          "81:    rv = nv[i].mime;",
          "82:    break;",
          "83:   }",
          "84:  (void)setlocale(LC_CTYPE, \"\");",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.167 2013/04/22 15:30:11 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.168 2013/05/30 15:53:33 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "40: #include <ctype.h>",
          "41: #include <stdlib.h>",
          "42: #include <time.h>",
          "45: private int match(struct magic_set *, struct magic *, uint32_t,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "43: #if defined(HAVE_LOCALE_H)",
          "44: #include <locale.h>",
          "45: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "337: check_fmt(struct magic_set *ms, struct magic *m)",
          "338: {",
          "339:  regex_t rx;",
          "342:  if (strchr(m->desc, '%') == NULL)",
          "343:   return 0;",
          "345:  rc = regcomp(&rx, \"%[-0-9\\\\.]*s\", REG_EXTENDED|REG_NOSUB);",
          "346:  if (rc) {",
          "347:   char errmsg[512];",
          "348:   (void)regerror(rc, &rx, errmsg, sizeof(errmsg));",
          "349:   file_magerror(ms, \"regex error %d, (%s)\", rc, errmsg);",
          "351:  } else {",
          "352:   rc = regexec(&rx, m->desc, 0, 0, 0);",
          "353:   regfree(&rx);",
          "355:  }",
          "356: }",
          "358: #ifndef HAVE_STRNDUP",
          "",
          "[Removed Lines]",
          "340:  int rc;",
          "350:   return -1;",
          "354:   return !rc;",
          "",
          "[Added Lines]",
          "343:  int rc, rv = -1;",
          "348:  (void)setlocale(LC_CTYPE, \"C\");",
          "357:   rv = !rc;",
          "359:  (void)setlocale(LC_CTYPE, \"\");",
          "360:  return rv;",
          "",
          "---------------"
        ],
        "src/strcasestr.c||src/strcasestr.c": [
          "File: src/strcasestr.c -> src/strcasestr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "35: #if defined(LIBC_SCCS) && !defined(lint)",
          "36: __RCSID(\"$NetBSD: strcasestr.c,v 1.3 2005/11/29 03:12:00 christos Exp $\");",
          "37: __RCSID(\"$NetBSD: strncasecmp.c,v 1.2 2007/06/04 18:19:27 christos Exp $\");",
          "40: #include <assert.h>",
          "41: #include <ctype.h>",
          "42: #include <string.h>",
          "44: static int",
          "45: _strncasecmp(const char *s1, const char *s2, size_t n)",
          "46: {",
          "47:  if (n != 0) {",
          "48:   const unsigned char *us1 = (const unsigned char *)s1,",
          "51:   do {",
          "52:    if (tolower(*us1) != tolower(*us2++))",
          "53:     return tolower(*us1) - tolower(*--us2);",
          "54:    if (*us1++ == '\\0')",
          "55:     break;",
          "56:   } while (--n != 0);",
          "57:  }",
          "58:  return 0;",
          "59: }",
          "64: char *",
          "65: strcasestr(const char *s, const char *find)",
          "66: {",
          "67:  char c, sc;",
          "68:  size_t len;",
          "70:  if ((c = *find++) != 0) {",
          "71:   c = tolower((unsigned char)c);",
          "72:   len = strlen(find);",
          "73:   do {",
          "74:    do {",
          "75:     if ((sc = *s++) == 0)",
          "76:      return (NULL);",
          "77:    } while ((char)tolower((unsigned char)sc) != c);",
          "78:   } while (_strncasecmp(s, find, len) != 0);",
          "79:   s--;",
          "80:  }",
          "81:  return (char *)(intptr_t)(s);",
          "82: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "70c65d2e1841491f59168db1f905e8b14083fb1c",
      "candidate_info": {
        "commit_hash": "70c65d2e1841491f59168db1f905e8b14083fb1c",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/70c65d2e1841491f59168db1f905e8b14083fb1c",
        "files": [
          "src/softmagic.c"
        ],
        "message": "off by one in out of bounds calculations (Jan Kaluza)",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.176 2014/02/18 17:59:21 kim Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.177 2014/02/21 14:32:48 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "72: private void cvt_32(union VALUETYPE *, const struct magic *);",
          "73: private void cvt_64(union VALUETYPE *, const struct magic *);",
          "",
          "[Removed Lines]",
          "75: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) >= ((n) - (o)))",
          "",
          "[Added Lines]",
          "75: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) > ((n) - (o)))",
          "",
          "---------------"
        ]
      }
    }
  ]
}