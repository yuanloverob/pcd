{
  "cve_id": "CVE-2010-2060",
  "cve_desc": "The put command functionality in beanstalkd 1.4.5 and earlier allows remote attackers to execute arbitrary Beanstalk commands via the body in a job that is too big, which is not properly handled by the dispatch_cmd function in prot.c.",
  "repo": "kr/beanstalkd",
  "patch_hash": "2e8e8c6387ecdf5923dfc4d7718d18eba1b0873d",
  "patch_info": {
    "commit_hash": "2e8e8c6387ecdf5923dfc4d7718d18eba1b0873d",
    "repo": "kr/beanstalkd",
    "commit_url": "https://github.com/kr/beanstalkd/commit/2e8e8c6387ecdf5923dfc4d7718d18eba1b0873d",
    "files": [
      "check-one.sh",
      "prot.c",
      "sh-tests/too-big.commands",
      "sh-tests/too-big.expected"
    ],
    "message": "Discard job body bytes if the job is too big.\n\nPreviously, a malicious user could craft a job payload and inject\nbeanstalk commands without the client application knowing. (An\nextra-careful client library could check the size of the job body before\nsending the put command, but most libraries do not do this, nor should\nthey have to.)\n\nReported by Graham Barr.",
    "before_after_code_files": [
      "check-one.sh||check-one.sh",
      "prot.c||prot.c",
      "sh-tests/too-big.commands||sh-tests/too-big.commands",
      "sh-tests/too-big.expected||sh-tests/too-big.expected"
    ]
  },
  "patch_diff": {
    "check-one.sh||check-one.sh": [
      "File: check-one.sh -> check-one.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "34:   exit 2",
      "35: fi",
      "39: # Run the test",
      "40: fgrep -v \"#\" $commands | $nc $server $port > \"$tmpf\"",
      "",
      "[Removed Lines]",
      "37: start_beanstalkd",
      "",
      "[Added Lines]",
      "37: start_beanstalkd '' '-z 10'",
      "",
      "---------------"
    ],
    "prot.c||prot.c": [
      "File: prot.c -> prot.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1196:         if (errno) return reply_msg(c, MSG_BAD_FORMAT);",
      "1198:         if (body_size > job_data_size_limit) {",
      "1200:         }",
      "",
      "[Removed Lines]",
      "1199:             return reply_msg(c, MSG_JOB_TOO_BIG);",
      "",
      "[Added Lines]",
      "1200:             return skip(c, body_size + 2, MSG_JOB_TOO_BIG);",
      "",
      "---------------"
    ],
    "sh-tests/too-big.commands||sh-tests/too-big.commands": [
      "File: sh-tests/too-big.commands -> sh-tests/too-big.commands",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: put 0 0 0 11",
      "2: delete 9999",
      "3: quit",
      "",
      "---------------"
    ],
    "sh-tests/too-big.expected||sh-tests/too-big.expected": [
      "File: sh-tests/too-big.expected -> sh-tests/too-big.expected",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: JOB_TOO_BIG",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "437b75887d804f865a8d86824d0029068615a15a",
      "candidate_info": {
        "commit_hash": "437b75887d804f865a8d86824d0029068615a15a",
        "repo": "kr/beanstalkd",
        "commit_url": "https://github.com/kr/beanstalkd/commit/437b75887d804f865a8d86824d0029068615a15a",
        "files": [
          "check-one.sh",
          "sh-tests/binlog-basic.sh",
          "sh-tests/binlog-bury.sh",
          "sh-tests/binlog-diskfull-delete.sh",
          "sh-tests/binlog-diskfull.sh",
          "sh-tests/binlog-read.sh",
          "sh-tests/binlog-sizelimit.sh",
          "sh-tests/common.functions"
        ],
        "message": "refactor and make more robust and verbose",
        "before_after_code_files": [
          "check-one.sh||check-one.sh",
          "sh-tests/binlog-basic.sh||sh-tests/binlog-basic.sh",
          "sh-tests/binlog-bury.sh||sh-tests/binlog-bury.sh",
          "sh-tests/binlog-diskfull-delete.sh||sh-tests/binlog-diskfull-delete.sh",
          "sh-tests/binlog-diskfull.sh||sh-tests/binlog-diskfull.sh",
          "sh-tests/binlog-read.sh||sh-tests/binlog-read.sh",
          "sh-tests/binlog-sizelimit.sh||sh-tests/binlog-sizelimit.sh",
          "sh-tests/common.functions||sh-tests/common.functions"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "check-one.sh||check-one.sh"
          ],
          "candidate": [
            "check-one.sh||check-one.sh"
          ]
        }
      },
      "candidate_diff": {
        "check-one.sh||check-one.sh": [
          "File: check-one.sh -> check-one.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: server=localhost",
          "5: tmpdir=\"$TMPDIR\"",
          "6: test -z \"$tmpdir\" && tmpdir=/tmp",
          "7: tmpf=\"${tmpdir}/bnch$$\"",
          "",
          "[Removed Lines]",
          "1: #!/bin/sh",
          "4: port=11400",
          "",
          "[Added Lines]",
          "1: #!/bin/bash",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "33:   exit 2",
          "34: fi",
          "45: # Run the test",
          "46: fgrep -v \"#\" $commands | $nc $server $port > \"$tmpf\"",
          "",
          "[Removed Lines]",
          "36: ./beanstalkd -p $port >/dev/null 2>/dev/null &",
          "37: bpid=$!",
          "39: sleep .1",
          "40: if ! ps -p $bpid >/dev/null; then",
          "41:   echo \"Could not start beanstalkd for testing, port $port is taken\"",
          "42:   exit 2",
          "43: fi",
          "",
          "[Added Lines]",
          "37: start_beanstalkd",
          "",
          "---------------"
        ],
        "sh-tests/binlog-basic.sh||sh-tests/binlog-basic.sh": [
          "File: sh-tests/binlog-basic.sh -> sh-tests/binlog-basic.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: server=localhost",
          "5: tmpdir=\"$TMPDIR\"",
          "6: test -z \"$tmpdir\" && tmpdir=/tmp",
          "7: out1=\"${tmpdir}/bnch$$.1\"",
          "",
          "[Removed Lines]",
          "4: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "9: logdir=\"${tmpdir}/bnch$$.d\"",
          "10: nc='./sh-tests/netcat.py'",
          "20: cleanup() {",
          "21:     killbeanstalkd",
          "22:     rm -rf \"$logdir\" \"$out1\" \"$out2\"",
          "",
          "[Removed Lines]",
          "12: killbeanstalkd() {",
          "13:     {",
          "14:         test -z \"$bpid\" || kill -9 $bpid",
          "15:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "16:     } >/dev/null 2>&1",
          "17:     bpid=",
          "18: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "35:   exit 2",
          "36: fi",
          "49: $nc $server $port <<EOF > \"$out1\"",
          "50: put 0 0 100 0",
          "",
          "[Removed Lines]",
          "38: mkdir -p $logdir",
          "40: ./beanstalkd -p $port -b \"$logdir\" >/dev/null 2>/dev/null &",
          "41: bpid=$!",
          "43: sleep .1",
          "44: if ! ps -p $bpid >/dev/null; then",
          "45:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "46:   exit 2",
          "47: fi",
          "",
          "[Added Lines]",
          "31: start_beanstalkd $logdir",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "61: killbeanstalkd",
          "63: sleep .1",
          "73: $nc $server $port <<EOF > \"$out2\"",
          "74: delete 1",
          "",
          "[Removed Lines]",
          "64: ./beanstalkd -p $port -b \"$logdir\" >/dev/null 2>/dev/null &",
          "65: bpid=$!",
          "67: sleep .1",
          "68: if ! ps -p $bpid >/dev/null; then",
          "69:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "70:   exit 2",
          "71: fi",
          "",
          "[Added Lines]",
          "48: start_beanstalkd $logdir",
          "",
          "---------------"
        ],
        "sh-tests/binlog-bury.sh||sh-tests/binlog-bury.sh": [
          "File: sh-tests/binlog-bury.sh -> sh-tests/binlog-bury.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: server=localhost",
          "5: tmpdir=\"$TMPDIR\"",
          "6: test -z \"$tmpdir\" && tmpdir=/tmp",
          "7: out1=\"${tmpdir}/bnch$$.1\"",
          "",
          "[Removed Lines]",
          "4: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "9: logdir=\"${tmpdir}/bnch$$.d\"",
          "10: nc='./sh-tests/netcat.py'",
          "20: cleanup() {",
          "21:     killbeanstalkd",
          "22:     rm -rf \"$logdir\" \"$out1\" \"$out2\"",
          "",
          "[Removed Lines]",
          "12: killbeanstalkd() {",
          "13:     {",
          "14:         test -z \"$bpid\" || kill -9 $bpid",
          "15:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "16:     } >/dev/null 2>&1",
          "17:     bpid=",
          "18: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "35:   exit 2",
          "36: fi",
          "49: $nc $server $port <<EOF > \"$out1\"",
          "50: put 0 0 100 0",
          "",
          "[Removed Lines]",
          "38: mkdir -p $logdir",
          "40: ./beanstalkd -p $port -b \"$logdir\" >/dev/null 2>/dev/null &",
          "41: bpid=$!",
          "43: sleep .1",
          "44: if ! ps -p $bpid >/dev/null; then",
          "45:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "46:   exit 2",
          "47: fi",
          "",
          "[Added Lines]",
          "31: start_beanstalkd $logdir",
          "",
          "---------------"
        ],
        "sh-tests/binlog-diskfull-delete.sh||sh-tests/binlog-diskfull-delete.sh": [
          "File: sh-tests/binlog-diskfull-delete.sh -> sh-tests/binlog-diskfull-delete.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: ENOSPC=28",
          "4: server=localhost",
          "6: tmpdir=\"$TMPDIR\"",
          "7: size=1000",
          "8: test -z \"$tmpdir\" && tmpdir=/tmp",
          "",
          "[Removed Lines]",
          "5: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "24:     exit 1",
          "25: }",
          "35: cleanup() {",
          "36:     killbeanstalkd",
          "37:     rm -rf \"$logdir\" \"$out1\" \"$out2\" ${tmpdir}/fiu-ctrl-[0-9]*.{in,out}",
          "",
          "[Removed Lines]",
          "27: killbeanstalkd() {",
          "28:     {",
          "29:         test -z \"$bpid\" || kill -9 $bpid",
          "30:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "31:     } >/dev/null 2>&1",
          "32:     bpid=",
          "33: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "55:   exit 2",
          "56: fi",
          "69: # Insert enough jobs to create another binlog file",
          "70: $nc $server $port <<EOF > \"$out1\"",
          "",
          "[Removed Lines]",
          "58: mkdir -p $logdir",
          "60: fiu-run -x ./beanstalkd -p $port -b \"$logdir\" -s $size >/dev/null 2>/dev/null &",
          "61: bpid=$!",
          "63: sleep .1",
          "64: if ! ps -p $bpid >/dev/null; then",
          "65:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "66:   exit 2",
          "67: fi",
          "",
          "[Added Lines]",
          "51: start_beanstalkd $logdir \"-s $size\" \"fiu-run -x\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "181: killbeanstalkd",
          "193: $nc $server $port <<EOF > \"$out2\"",
          "194: delete 8",
          "",
          "[Removed Lines]",
          "183: sleep .1",
          "184: ./beanstalkd -p $port -b \"$logdir\" -s $size >/dev/null 2>/dev/null &",
          "185: bpid=$!",
          "187: sleep .1",
          "188: if ! ps -p $bpid >/dev/null; then",
          "189:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "190:   exit 2",
          "191: fi",
          "",
          "[Added Lines]",
          "167: start_beanstalkd $logdir \"-s $size\"",
          "",
          "---------------"
        ],
        "sh-tests/binlog-diskfull.sh||sh-tests/binlog-diskfull.sh": [
          "File: sh-tests/binlog-diskfull.sh -> sh-tests/binlog-diskfull.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: ENOSPC=28",
          "4: server=localhost",
          "6: tmpdir=\"$TMPDIR\"",
          "7: size=1000",
          "8: test -z \"$tmpdir\" && tmpdir=/tmp",
          "",
          "[Removed Lines]",
          "5: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "17:   exit 0",
          "18: fi",
          "28: cleanup() {",
          "29:     killbeanstalkd",
          "30:     rm -rf \"$logdir\" \"$out1\" \"$out2\" ${tmpdir}/fiu-ctrl-[0-9]*.{in,out}",
          "",
          "[Removed Lines]",
          "20: killbeanstalkd() {",
          "21:     {",
          "22:         test -z \"$bpid\" || kill -9 $bpid",
          "23:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "24:     } >/dev/null 2>&1",
          "25:     bpid=",
          "26: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "43:   exit 2",
          "44: fi",
          "57: # Make beanstalkd think the disk is full now.",
          "58: fiu-ctrl -e posix/io/oc/open -i $ENOSPC $bpid",
          "",
          "[Removed Lines]",
          "46: mkdir -p $logdir",
          "48: fiu-run -x ./beanstalkd -p $port -b \"$logdir\" -s $size >/dev/null 2>/dev/null &",
          "49: bpid=$!",
          "51: sleep .1",
          "52: if ! ps -p $bpid >/dev/null; then",
          "53:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "54:   exit 2",
          "55: fi",
          "",
          "[Added Lines]",
          "39: start_beanstalkd $logdir \"-s $size\" \"fiu-run -x\"",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "113: killbeanstalkd",
          "115: sleep .1",
          "125: $nc $server $port <<EOF > \"$out2\"",
          "126: delete 1",
          "",
          "[Removed Lines]",
          "116: ./beanstalkd -p $port -b \"$logdir\" -s $size >/dev/null 2>/dev/null &",
          "117: bpid=$!",
          "119: sleep .1",
          "120: if ! ps -p $bpid >/dev/null; then",
          "121:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "122:   exit 2",
          "123: fi",
          "",
          "[Added Lines]",
          "100: start_beanstalkd $logdir \"-s $size\"",
          "",
          "---------------"
        ],
        "sh-tests/binlog-read.sh||sh-tests/binlog-read.sh": [
          "File: sh-tests/binlog-read.sh -> sh-tests/binlog-read.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: server=localhost",
          "5: tmpdir=\"$TMPDIR\"",
          "6: test -z \"$tmpdir\" && tmpdir=/tmp",
          "7: out1=\"${tmpdir}/bnch$$.1\"",
          "",
          "[Removed Lines]",
          "4: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "9: logdir=\"${tmpdir}/bnch$$.d\"",
          "10: nc='./sh-tests/netcat.py'",
          "20: cleanup() {",
          "21:     killbeanstalkd",
          "22:     rm -rf \"$logdir\" \"$out1\" \"$out2\"",
          "",
          "[Removed Lines]",
          "12: killbeanstalkd() {",
          "13:     {",
          "14:         test -z \"$bpid\" || kill -9 $bpid",
          "15:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "16:     } >/dev/null 2>&1",
          "17:     bpid=",
          "18: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "35:   exit 2",
          "36: fi",
          "49: $nc $server $port <<EOF > \"$out1\"",
          "50: use test",
          "",
          "[Removed Lines]",
          "38: mkdir -p $logdir",
          "40: ./beanstalkd -p $port -b \"$logdir\" >/dev/null 2>/dev/null &",
          "41: bpid=$!",
          "43: sleep .1",
          "44: if ! ps -p $bpid >/dev/null; then",
          "45:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "46:   exit 2",
          "47: fi",
          "",
          "[Added Lines]",
          "31: start_beanstalkd $logdir",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "78: killbeanstalkd",
          "80: sleep 1",
          "90: $nc $server $port <<EOF > \"$out2\"",
          "91: watch test",
          "",
          "[Removed Lines]",
          "81: ./beanstalkd -p $port -b \"$logdir\" >/dev/null 2>/dev/null &",
          "82: bpid=$!",
          "84: sleep .1",
          "85: if ! ps -p $bpid >/dev/null; then",
          "86:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "87:   exit 2",
          "88: fi",
          "",
          "[Added Lines]",
          "65: start_beanstalkd $logdir",
          "",
          "---------------"
        ],
        "sh-tests/binlog-sizelimit.sh||sh-tests/binlog-sizelimit.sh": [
          "File: sh-tests/binlog-sizelimit.sh -> sh-tests/binlog-sizelimit.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #!/usr/bin/env bash",
          "3: server=localhost",
          "5: tmpdir=\"$TMPDIR\"",
          "6: size=1024",
          "7: truncated_size_1=796",
          "",
          "[Removed Lines]",
          "4: port=11400",
          "",
          "[Added Lines]",
          "3: . sh-tests/common.functions",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "19:     exit 1",
          "20: }",
          "30: cleanup() {",
          "31:     killbeanstalkd",
          "32:     rm -rf \"$logdir\" \"$out1\" \"$out2\"",
          "",
          "[Removed Lines]",
          "22: killbeanstalkd() {",
          "23:     {",
          "24:         test -z \"$bpid\" || kill -9 $bpid",
          "25:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "26:     } >/dev/null 2>&1",
          "27:     bpid=",
          "28: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "50:   exit 2",
          "51: fi",
          "64: # Check that the first binlog file is the proper size.",
          "65: test \"$(fsize \"$logdir\"/binlog.1)\" -eq $size || fail first binlog wrong size",
          "",
          "[Removed Lines]",
          "53: mkdir -p $logdir",
          "55: ./beanstalkd -p $port -b \"$logdir\" -s $size >/dev/null 2>/dev/null &",
          "56: bpid=$!",
          "58: sleep .1",
          "59: if ! ps -p $bpid >/dev/null; then",
          "60:   echo \"Could not start beanstalkd for testing (possibly port $port is taken)\"",
          "61:   exit 2",
          "62: fi",
          "",
          "[Added Lines]",
          "46: start_beanstalkd $logdir \"-s $size\"",
          "",
          "---------------"
        ],
        "sh-tests/common.functions||sh-tests/common.functions": [
          "File: sh-tests/common.functions -> sh-tests/common.functions",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: #!/usr/bin/env bash",
          "3: start_port=11400",
          "4: max_port_retries=20",
          "6: function killbeanstalkd() {",
          "7:     {",
          "8:         test -z \"$bpid\" || kill -9 $bpid",
          "9:         /bin/true # Somehow this gets rid of an unnessary shell message.",
          "10:     } >/dev/null 2>&1",
          "11: }",
          "13: function start_beanstalkd {",
          "14:     port=$start_port",
          "15:     logdir=\"$1\"",
          "16:     other_args=\"$2\" # other_args and fiu are optional",
          "17:     fiu=\"$3\"",
          "19:     if [ \"x$logdir\" != \"x\" ]; then",
          "20:         mkdir -p $logdir",
          "21:         other_args=\"-b $logdir $other_args\"",
          "22:     fi",
          "24:     max_port=$(($port + $max_port_retries))",
          "25:     while [ $port -lt $max_port ]; do",
          "26:         echo \"$fiu ./beanstalkd -l 127.0.0.1 -p $port $other_args &\"",
          "27:         $fiu ./beanstalkd -l 127.0.0.1 -p $port $other_args &",
          "28:         bpid=$!",
          "30:         sleep .1",
          "31:         if ! ps -p $bpid >/dev/null; then",
          "32:           echo \"Could not start beanstalkd for testing (possibly port $port is taken)\" >&2",
          "33:           port=$(($port + 1))",
          "34:         else",
          "35:           echo \"Started beanstalkd (pid: $bpid), listening on port $port\"",
          "36:           export port bpid",
          "37:           return",
          "38:         fi",
          "39:     done",
          "40:   echo \"Giving up after having tried $max_port_retries different ports\" >&2",
          "41:   exit 2",
          "42: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}