{
  "cve_id": "CVE-2013-0868",
  "cve_desc": "libavcodec/huffyuvdec.c in FFmpeg before 1.1.2 allows remote attackers to have an unspecified impact via crafted Huffyuv data, related to an out-of-bounds write and (1) unchecked return codes from the init_vlc function and (2) \"len==0 cases.\"",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "f67a0d115254461649470452058fa3c28c0df294",
  "patch_info": {
    "commit_hash": "f67a0d115254461649470452058fa3c28c0df294",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/f67a0d115254461649470452058fa3c28c0df294",
    "files": [
      "libavcodec/huffyuvdec.c"
    ],
    "message": "huffyuvdec: Check init_vlc() return codes.\n\nPrevents out of array writes\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/huffyuvdec.c||libavcodec/huffyuvdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/huffyuvdec.c||libavcodec/huffyuvdec.c": [
      "File: libavcodec/huffyuvdec.c -> libavcodec/huffyuvdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "124:                     int len1 = s->len[p][u];",
      "125:                     if (len1 > limit)",
      "126:                         continue;",
      "127:                     len[i] = len0 + len1;",
      "128:                     bits[i] = (s->bits[0][y] << len1) + s->bits[p][u];",
      "129:                     symbols[i] = (y << 8) + u;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "127:                     av_assert0(i < (1 << VLC_BITS));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "158:                     int len2 = s->len[2][r & 255];",
      "159:                     if (len2 > limit1)",
      "160:                         continue;",
      "161:                     len[i] = len0 + len1 + len2;",
      "162:                     bits[i] = (code << len2) + s->bits[2][r & 255];",
      "163:                     if (s->decorrelate) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "162:                     av_assert0(i < (1 << VLC_BITS));",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "182: {",
      "183:     GetBitContext gb;",
      "184:     int i;",
      "186:     init_get_bits(&gb, src, length * 8);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "187:     int ret;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "192:             return -1;",
      "193:         }",
      "194:         ff_free_vlc(&s->vlc[i]);",
      "197:     }",
      "199:     generate_joint_tables(s);",
      "",
      "[Removed Lines]",
      "195:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
      "196:                  s->bits[i], 4, 4, 0);",
      "",
      "[Added Lines]",
      "198:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
      "199:                            s->bits[i], 4, 4, 0)) < 0)",
      "200:             return ret;",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "205: {",
      "206:     GetBitContext gb;",
      "207:     int i;",
      "209:     init_get_bits(&gb, classic_shift_luma,",
      "210:                   classic_shift_luma_table_size * 8);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "212:     int ret;",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "229:     for (i = 0; i < 3; i++) {",
      "230:         ff_free_vlc(&s->vlc[i]);",
      "233:     }",
      "235:     generate_joint_tables(s);",
      "",
      "[Removed Lines]",
      "231:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
      "232:                  s->bits[i], 4, 4, 0);",
      "",
      "[Added Lines]",
      "236:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
      "237:                             s->bits[i], 4, 4, 0)) < 0)",
      "238:             return ret;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e4831bb9a678dea50b535638aa81eaf4aea0184c",
      "candidate_info": {
        "commit_hash": "e4831bb9a678dea50b535638aa81eaf4aea0184c",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e4831bb9a678dea50b535638aa81eaf4aea0184c",
        "files": [
          "libavcodec/huffyuv.c"
        ],
        "message": "huffyuvdec: Check init_vlc() return codes.\n\nPrevents out of array writes\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit f67a0d115254461649470452058fa3c28c0df294)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 95ab8d33e1a680f30a5a9605175112008ab81afc)\n\nConflicts:\n\n\tlibavcodec/huffyuv.c\n(cherry picked from commit 277def59fce10d91e3113e5c0f63e22bc4abfa88)\n\nConflicts:\n\n\tlibavcodec/huffyuv.c\n(cherry picked from commit adf022f458d75e2c8041262e1906a249366ad518)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/huffyuv.c||libavcodec/huffyuv.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/huffyuv.c||libavcodec/huffyuv.c": [
          "File: libavcodec/huffyuv.c -> libavcodec/huffyuv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: #include \"avcodec.h\"",
          "32: #include \"get_bits.h\"",
          "33: #include \"put_bits.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "289:                     int len1 = s->len[p][u];",
          "290:                     if(len1 > limit)",
          "291:                         continue;",
          "292:                     len[i] = len0 + len1;",
          "293:                     bits[i] = (s->bits[0][y] << len1) + s->bits[p][u];",
          "294:                     symbols[i] = (y<<8) + u;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "293:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "322:                     int len2 = s->len[2][r&255];",
          "323:                     if(len2 > limit1)",
          "324:                         continue;",
          "325:                     len[i] = len0 + len1 + len2;",
          "326:                     bits[i] = (code << len2) + s->bits[2][r&255];",
          "327:                     if(s->decorrelate){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "327:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "345: static int read_huffman_tables(HYuvContext *s, const uint8_t *src, int length){",
          "346:     GetBitContext gb;",
          "347:     int i;",
          "349:     init_get_bits(&gb, src, length*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "351:     int ret;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "355:             return -1;",
          "356:         }",
          "357:         free_vlc(&s->vlc[i]);",
          "359:     }",
          "361:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "358:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "362:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0)) < 0)",
          "363:             return ret;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "367: #if 1",
          "368:     GetBitContext gb;",
          "369:     int i;",
          "371:     init_get_bits(&gb, classic_shift_luma, classic_shift_luma_table_size*8);",
          "372:     if(read_len_table(s->len[0], &gb)<0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "375:     int ret;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "388:     for(i=0; i<3; i++){",
          "389:         free_vlc(&s->vlc[i]);",
          "391:     }",
          "393:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "390:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "396:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0)) < 0)",
          "397:             return ret;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b666debffec1fcbb19ef377635a53b9a58bca8a4",
      "candidate_info": {
        "commit_hash": "b666debffec1fcbb19ef377635a53b9a58bca8a4",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b666debffec1fcbb19ef377635a53b9a58bca8a4",
        "files": [
          "libavcodec/huffyuv.c"
        ],
        "message": "huffyuvdec: Check init_vlc() return codes.\n\nPrevents out of array writes\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit f67a0d115254461649470452058fa3c28c0df294)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/huffyuv.c||libavcodec/huffyuv.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/huffyuv.c||libavcodec/huffyuv.c": [
          "File: libavcodec/huffyuv.c -> libavcodec/huffyuv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "273:                     int len1 = s->len[p][u];",
          "274:                     if (len1 > limit)",
          "275:                         continue;",
          "276:                     len[i] = len0 + len1;",
          "277:                     bits[i] = (s->bits[0][y] << len1) + s->bits[p][u];",
          "278:                     symbols[i] = (y << 8) + u;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "276:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "307:                     int len2 = s->len[2][r & 255];",
          "308:                     if (len2 > limit1)",
          "309:                         continue;",
          "310:                     len[i] = len0 + len1 + len2;",
          "311:                     bits[i] = (code << len2) + s->bits[2][r & 255];",
          "312:                     if (s->decorrelate) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "311:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "331: {",
          "332:     GetBitContext gb;",
          "333:     int i;",
          "335:     init_get_bits(&gb, src, length * 8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "336:     int ret;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "341:             return -1;",
          "342:         }",
          "343:         ff_free_vlc(&s->vlc[i]);",
          "346:     }",
          "348:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "344:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
          "345:                  s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "347:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
          "348:                            s->bits[i], 4, 4, 0)) < 0)",
          "349:             return ret;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "354: {",
          "355:     GetBitContext gb;",
          "356:     int i;",
          "358:     init_get_bits(&gb, classic_shift_luma,",
          "359:                   classic_shift_luma_table_size * 8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361:     int ret;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "378:     for (i = 0; i < 3; i++) {",
          "379:         ff_free_vlc(&s->vlc[i]);",
          "382:     }",
          "384:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "380:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
          "381:                  s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "385:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1,",
          "386:                             s->bits[i], 4, 4, 0)) < 0)",
          "387:             return ret;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "562aa82d2a22cba39caede1d7b1243fdb6311ce5",
      "candidate_info": {
        "commit_hash": "562aa82d2a22cba39caede1d7b1243fdb6311ce5",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/562aa82d2a22cba39caede1d7b1243fdb6311ce5",
        "files": [
          "libavcodec/huffyuv.c"
        ],
        "message": "huffyuvdec: Check init_vlc() return codes.\n\nPrevents out of array writes\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit f67a0d115254461649470452058fa3c28c0df294)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 95ab8d33e1a680f30a5a9605175112008ab81afc)\n\nConflicts:\n\n\tlibavcodec/huffyuv.c",
        "before_after_code_files": [
          "libavcodec/huffyuv.c||libavcodec/huffyuv.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/huffyuv.c||libavcodec/huffyuv.c": [
          "File: libavcodec/huffyuv.c -> libavcodec/huffyuv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "320:                     int len1 = s->len[p][u];",
          "321:                     if(len1 > limit)",
          "322:                         continue;",
          "323:                     len[i] = len0 + len1;",
          "324:                     bits[i] = (s->bits[0][y] << len1) + s->bits[p][u];",
          "325:                     symbols[i] = (y<<8) + u;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "323:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "353:                     int len2 = s->len[2][r&255];",
          "354:                     if(len2 > limit1)",
          "355:                         continue;",
          "356:                     len[i] = len0 + len1 + len2;",
          "357:                     bits[i] = (code << len2) + s->bits[2][r&255];",
          "358:                     if(s->decorrelate){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "357:                     av_assert0(i < (1 << VLC_BITS));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "376: static int read_huffman_tables(HYuvContext *s, const uint8_t *src, int length){",
          "377:     GetBitContext gb;",
          "378:     int i;",
          "380:     init_get_bits(&gb, src, length*8);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "381:     int ret;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "386:             return -1;",
          "387:         }",
          "388:         ff_free_vlc(&s->vlc[i]);",
          "390:     }",
          "392:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "389:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "392:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0)) < 0)",
          "393:             return ret;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "397: static int read_old_huffman_tables(HYuvContext *s){",
          "398:     GetBitContext gb;",
          "399:     int i;",
          "401:     init_get_bits(&gb, classic_shift_luma, classic_shift_luma_table_size*8);",
          "402:     if(read_len_table(s->len[0], &gb)<0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "404:     int ret;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "418:     for(i=0; i<3; i++){",
          "419:         ff_free_vlc(&s->vlc[i]);",
          "421:     }",
          "423:     generate_joint_tables(s);",
          "",
          "[Removed Lines]",
          "420:         init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0);",
          "",
          "[Added Lines]",
          "425:         if ((ret = init_vlc(&s->vlc[i], VLC_BITS, 256, s->len[i], 1, 1, s->bits[i], 4, 4, 0)) < 0)",
          "426:             return ret;",
          "",
          "---------------"
        ]
      }
    }
  ]
}