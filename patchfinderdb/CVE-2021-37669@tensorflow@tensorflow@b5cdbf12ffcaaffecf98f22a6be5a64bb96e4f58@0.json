{
  "cve_id": "CVE-2021-37669",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions an attacker can cause denial of service in applications serving models using `tf.raw_ops.NonMaxSuppressionV5` by triggering a division by 0. The [implementation](https://github.com/tensorflow/tensorflow/blob/460e000de3a83278fb00b61a16d161b1964f15f4/tensorflow/core/kernels/image/non_max_suppression_op.cc#L170-L271) uses a user controlled argument to resize a `std::vector`. However, as `std::vector::resize` takes the size argument as a `size_t` and `output_size` is an `int`, there is an implicit conversion to unsigned. If the attacker supplies a negative value, this conversion results in a crash. A similar issue occurs in `CombinedNonMaxSuppression`. We have patched the issue in GitHub commit 3a7362750d5c372420aa8f0caf7bf5b5c3d0f52d and commit [b5cdbf12ffcaaffecf98f22a6be5a64bb96e4f58. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "b5cdbf12ffcaaffecf98f22a6be5a64bb96e4f58",
  "patch_info": {
    "commit_hash": "b5cdbf12ffcaaffecf98f22a6be5a64bb96e4f58",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/b5cdbf12ffcaaffecf98f22a6be5a64bb96e4f58",
    "files": [
      "tensorflow/core/kernels/image/non_max_suppression_op.cc"
    ],
    "message": "Prevent overflow due to integer conversion to unsigned.\n\nPiperOrigin-RevId: 387738045\nChange-Id: Id7e95bc07e02df1c66b72bd09f389608c87bdebe",
    "before_after_code_files": [
      "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc": [
      "File: tensorflow/core/kernels/image/non_max_suppression_op.cc -> tensorflow/core/kernels/image/non_max_suppression_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "930:         errors::InvalidArgument(\"max_size_per_class must be 0-D, got shape \",",
      "931:                                 max_output_size.shape().DebugString()));",
      "932:     const int max_size_per_class = max_output_size.scalar<int>()();",
      "934:     const Tensor& max_total_size = context->input(3);",
      "935:     OP_REQUIRES(",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "933:     OP_REQUIRES(context, max_size_per_class > 0,",
      "934:                 errors::InvalidArgument(\"max_size_per_class must be positive\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "303859d07f548f1b8edebc1608ccf8cbc6539f10",
      "candidate_info": {
        "commit_hash": "303859d07f548f1b8edebc1608ccf8cbc6539f10",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/303859d07f548f1b8edebc1608ccf8cbc6539f10",
        "files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ],
        "message": "Prevent overflow due to integer conversion to unsigned.\n\nPiperOrigin-RevId: 387738045\nChange-Id: Id7e95bc07e02df1c66b72bd09f389608c87bdebe",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc": [
          "File: tensorflow/core/kernels/image/non_max_suppression_op.cc -> tensorflow/core/kernels/image/non_max_suppression_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "921:         errors::InvalidArgument(\"max_size_per_class must be 0-D, got shape \",",
          "922:                                 max_output_size.shape().DebugString()));",
          "923:     const int max_size_per_class = max_output_size.scalar<int>()();",
          "925:     const Tensor& max_total_size = context->input(3);",
          "926:     OP_REQUIRES(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "924:     OP_REQUIRES(context, max_size_per_class > 0,",
          "925:                 errors::InvalidArgument(\"max_size_per_class must be positive\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "99ff982089529cfbd3f8cc7b92491ce39ff94583",
      "candidate_info": {
        "commit_hash": "99ff982089529cfbd3f8cc7b92491ce39ff94583",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/99ff982089529cfbd3f8cc7b92491ce39ff94583",
        "files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ],
        "message": "Prevent overflow due to integer conversion to unsigned.\n\nPiperOrigin-RevId: 387738045\nChange-Id: Id7e95bc07e02df1c66b72bd09f389608c87bdebe",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc": [
          "File: tensorflow/core/kernels/image/non_max_suppression_op.cc -> tensorflow/core/kernels/image/non_max_suppression_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "930:         errors::InvalidArgument(\"max_size_per_class must be 0-D, got shape \",",
          "931:                                 max_output_size.shape().DebugString()));",
          "932:     const int max_size_per_class = max_output_size.scalar<int>()();",
          "934:     const Tensor& max_total_size = context->input(3);",
          "935:     OP_REQUIRES(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "933:     OP_REQUIRES(context, max_size_per_class > 0,",
          "934:                 errors::InvalidArgument(\"max_size_per_class must be positive\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8bac83f84bcb6413d84c5e40757dbf6375ab4a97",
      "candidate_info": {
        "commit_hash": "8bac83f84bcb6413d84c5e40757dbf6375ab4a97",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8bac83f84bcb6413d84c5e40757dbf6375ab4a97",
        "files": [
          "tensorflow/core/kernels/non_max_suppression_op.cc"
        ],
        "message": "Prevent overflow due to integer conversion to unsigned.\n\nPiperOrigin-RevId: 387738045\nChange-Id: Id7e95bc07e02df1c66b72bd09f389608c87bdebe",
        "before_after_code_files": [
          "tensorflow/core/kernels/non_max_suppression_op.cc||tensorflow/core/kernels/non_max_suppression_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/non_max_suppression_op.cc||tensorflow/core/kernels/non_max_suppression_op.cc": [
          "File: tensorflow/core/kernels/non_max_suppression_op.cc -> tensorflow/core/kernels/non_max_suppression_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "921:         errors::InvalidArgument(\"max_size_per_class must be 0-D, got shape \",",
          "922:                                 max_output_size.shape().DebugString()));",
          "923:     const int max_size_per_class = max_output_size.scalar<int>()();",
          "925:     const Tensor& max_total_size = context->input(3);",
          "926:     OP_REQUIRES(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "924:     OP_REQUIRES(context, max_size_per_class > 0,",
          "925:                 errors::InvalidArgument(\"max_size_per_class must be positive\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "70311a706ca4a1e00cfae9cfb9d3a667af783eba",
      "candidate_info": {
        "commit_hash": "70311a706ca4a1e00cfae9cfb9d3a667af783eba",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/70311a706ca4a1e00cfae9cfb9d3a667af783eba",
        "files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ],
        "message": "Prevent overflow due to integer conversion to unsigned.\n\nPiperOrigin-RevId: 387738045\nChange-Id: Id7e95bc07e02df1c66b72bd09f389608c87bdebe",
        "before_after_code_files": [
          "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/image/non_max_suppression_op.cc||tensorflow/core/kernels/image/non_max_suppression_op.cc": [
          "File: tensorflow/core/kernels/image/non_max_suppression_op.cc -> tensorflow/core/kernels/image/non_max_suppression_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "930:         errors::InvalidArgument(\"max_size_per_class must be 0-D, got shape \",",
          "931:                                 max_output_size.shape().DebugString()));",
          "932:     const int max_size_per_class = max_output_size.scalar<int>()();",
          "934:     const Tensor& max_total_size = context->input(3);",
          "935:     OP_REQUIRES(",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "933:     OP_REQUIRES(context, max_size_per_class > 0,",
          "934:                 errors::InvalidArgument(\"max_size_per_class must be positive\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}