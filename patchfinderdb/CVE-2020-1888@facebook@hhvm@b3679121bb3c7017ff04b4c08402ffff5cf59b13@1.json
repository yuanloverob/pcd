{
  "cve_id": "CVE-2020-1888",
  "cve_desc": "Insufficient boundary checks when decoding JSON in handleBackslash reads out of bounds memory, potentially leading to DOS. This issue affects HHVM 4.45.0, 4.44.0, 4.43.0, 4.42.0, 4.41.0, 4.40.0, 4.39.0, versions between 4.33.0 and 4.38.0 (inclusive), versions between 4.9.0 and 4.32.0 (inclusive), and versions prior to 4.8.7.",
  "repo": "facebook/hhvm",
  "patch_hash": "b3679121bb3c7017ff04b4c08402ffff5cf59b13",
  "patch_info": {
    "commit_hash": "b3679121bb3c7017ff04b4c08402ffff5cf59b13",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/b3679121bb3c7017ff04b4c08402ffff5cf59b13",
    "files": [
      "hphp/runtime/ext/json/JSON_parser.cpp",
      "hphp/test/slow/ext_json/decode_crash.php",
      "hphp/test/slow/ext_json/decode_crash.php.expect"
    ],
    "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163\n\nfbshipit-source-id: 3da0a39555cb85a93f4fd98048368f17cf37e2e4",
    "before_after_code_files": [
      "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
    ]
  },
  "patch_diff": {
    "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
      "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "453:       case 'u': {",
      "454:         if (UNLIKELY(is_tsimplejson)) {",
      "455:           auto const ch1 = *p++;",
      "456:           auto const ch2 = *p++;",
      "457:           auto const dch3 = dehexchar(*p++);",
      "458:           auto const dch4 = dehexchar(*p++);",
      "462:           out = (dch3 << 4) | dch4;",
      "463:           return true;",
      "464:         } else {",
      "",
      "[Removed Lines]",
      "459:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
      "460:             return false;",
      "461:           }",
      "",
      "[Added Lines]",
      "456:           if (UNLIKELY(ch1 != '0')) return false;",
      "458:           if (UNLIKELY(ch2 != '0')) return false;",
      "460:           if (UNLIKELY(dch3 < 0)) return false;",
      "462:           if (UNLIKELY(dch4 < 0)) return false;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3fb3affe795e832b626dac70b009654d3ffb2687",
      "candidate_info": {
        "commit_hash": "3fb3affe795e832b626dac70b009654d3ffb2687",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/3fb3affe795e832b626dac70b009654d3ffb2687",
        "files": [
          "hphp/runtime/ext/json/JSON_parser.cpp",
          "hphp/test/slow/ext_json/decode_crash.php",
          "hphp/test/slow/ext_json/decode_crash.php.expect"
        ],
        "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163",
        "before_after_code_files": [
          "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ],
          "candidate": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
          "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "454:       case 'u': {",
          "455:         if (UNLIKELY(is_tsimplejson)) {",
          "456:           auto const ch1 = *p++;",
          "457:           auto const ch2 = *p++;",
          "458:           auto const dch3 = dehexchar(*p++);",
          "459:           auto const dch4 = dehexchar(*p++);",
          "463:           out = (dch3 << 4) | dch4;",
          "464:           return true;",
          "465:         } else {",
          "",
          "[Removed Lines]",
          "460:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
          "461:             return false;",
          "462:           }",
          "",
          "[Added Lines]",
          "457:           if (UNLIKELY(ch1 != '0')) return false;",
          "459:           if (UNLIKELY(ch2 != '0')) return false;",
          "461:           if (UNLIKELY(dch3 < 0)) return false;",
          "463:           if (UNLIKELY(dch4 < 0)) return false;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "52d384b9e4ac89128a23d95cfd27ee083b5ab4f9",
      "candidate_info": {
        "commit_hash": "52d384b9e4ac89128a23d95cfd27ee083b5ab4f9",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/52d384b9e4ac89128a23d95cfd27ee083b5ab4f9",
        "files": [
          "hphp/runtime/ext/json/JSON_parser.cpp",
          "hphp/test/slow/ext_json/decode_crash.php",
          "hphp/test/slow/ext_json/decode_crash.php.expect"
        ],
        "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163",
        "before_after_code_files": [
          "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ],
          "candidate": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
          "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "454:       case 'u': {",
          "455:         if (UNLIKELY(is_tsimplejson)) {",
          "456:           auto const ch1 = *p++;",
          "457:           auto const ch2 = *p++;",
          "458:           auto const dch3 = dehexchar(*p++);",
          "459:           auto const dch4 = dehexchar(*p++);",
          "463:           out = (dch3 << 4) | dch4;",
          "464:           return true;",
          "465:         } else {",
          "",
          "[Removed Lines]",
          "460:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
          "461:             return false;",
          "462:           }",
          "",
          "[Added Lines]",
          "457:           if (UNLIKELY(ch1 != '0')) return false;",
          "459:           if (UNLIKELY(ch2 != '0')) return false;",
          "461:           if (UNLIKELY(dch3 < 0)) return false;",
          "463:           if (UNLIKELY(dch4 < 0)) return false;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9bf0dacd54010f180dc99913b9540e8befccde54",
      "candidate_info": {
        "commit_hash": "9bf0dacd54010f180dc99913b9540e8befccde54",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/9bf0dacd54010f180dc99913b9540e8befccde54",
        "files": [
          "hphp/runtime/ext/json/JSON_parser.cpp",
          "hphp/test/slow/ext_json/decode_crash.php",
          "hphp/test/slow/ext_json/decode_crash.php.expect"
        ],
        "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163",
        "before_after_code_files": [
          "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ],
          "candidate": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
          "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "454:       case 'u': {",
          "455:         if (UNLIKELY(is_tsimplejson)) {",
          "456:           auto const ch1 = *p++;",
          "457:           auto const ch2 = *p++;",
          "458:           auto const dch3 = dehexchar(*p++);",
          "459:           auto const dch4 = dehexchar(*p++);",
          "463:           out = (dch3 << 4) | dch4;",
          "464:           return true;",
          "465:         } else {",
          "",
          "[Removed Lines]",
          "460:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
          "461:             return false;",
          "462:           }",
          "",
          "[Added Lines]",
          "457:           if (UNLIKELY(ch1 != '0')) return false;",
          "459:           if (UNLIKELY(ch2 != '0')) return false;",
          "461:           if (UNLIKELY(dch3 < 0)) return false;",
          "463:           if (UNLIKELY(dch4 < 0)) return false;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f319ba1d96b17ab325ecb82295e2614839359efb",
      "candidate_info": {
        "commit_hash": "f319ba1d96b17ab325ecb82295e2614839359efb",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/f319ba1d96b17ab325ecb82295e2614839359efb",
        "files": [
          "hphp/runtime/ext/json/JSON_parser.cpp",
          "hphp/test/slow/ext_json/decode_crash.php",
          "hphp/test/slow/ext_json/decode_crash.php.expect"
        ],
        "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163",
        "before_after_code_files": [
          "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ],
          "candidate": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
          "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "453:       case 'u': {",
          "454:         if (UNLIKELY(is_tsimplejson)) {",
          "455:           auto const ch1 = *p++;",
          "456:           auto const ch2 = *p++;",
          "457:           auto const dch3 = dehexchar(*p++);",
          "458:           auto const dch4 = dehexchar(*p++);",
          "462:           out = (dch3 << 4) | dch4;",
          "463:           return true;",
          "464:         } else {",
          "",
          "[Removed Lines]",
          "459:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
          "460:             return false;",
          "461:           }",
          "",
          "[Added Lines]",
          "456:           if (UNLIKELY(ch1 != '0')) return false;",
          "458:           if (UNLIKELY(ch2 != '0')) return false;",
          "460:           if (UNLIKELY(dch3 < 0)) return false;",
          "462:           if (UNLIKELY(dch4 < 0)) return false;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2fdb47b8dbc28cbd33528aa5dc460d50b3dc8704",
      "candidate_info": {
        "commit_hash": "2fdb47b8dbc28cbd33528aa5dc460d50b3dc8704",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/2fdb47b8dbc28cbd33528aa5dc460d50b3dc8704",
        "files": [
          "hphp/runtime/ext/json/JSON_parser.cpp",
          "hphp/test/slow/ext_json/decode_crash.php",
          "hphp/test/slow/ext_json/decode_crash.php.expect"
        ],
        "message": "Fix buffer overrun in SimpleParser::handleBackslash\n\nSummary:\nIt read 4 chars, then checked for validity, but any of them could have\nbeen the end of the string, so check after each one instead.\n\nReviewed By: oulgen\n\nDifferential Revision: D19611163",
        "before_after_code_files": [
          "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ],
          "candidate": [
            "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/json/JSON_parser.cpp||hphp/runtime/ext/json/JSON_parser.cpp": [
          "File: hphp/runtime/ext/json/JSON_parser.cpp -> hphp/runtime/ext/json/JSON_parser.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "454:       case 'u': {",
          "455:         if (UNLIKELY(is_tsimplejson)) {",
          "456:           auto const ch1 = *p++;",
          "457:           auto const ch2 = *p++;",
          "458:           auto const dch3 = dehexchar(*p++);",
          "459:           auto const dch4 = dehexchar(*p++);",
          "463:           out = (dch3 << 4) | dch4;",
          "464:           return true;",
          "465:         } else {",
          "",
          "[Removed Lines]",
          "460:           if (UNLIKELY(ch1 != '0' || ch2 != '0' || dch3 < 0 || dch4 < 0)) {",
          "461:             return false;",
          "462:           }",
          "",
          "[Added Lines]",
          "457:           if (UNLIKELY(ch1 != '0')) return false;",
          "459:           if (UNLIKELY(ch2 != '0')) return false;",
          "461:           if (UNLIKELY(dch3 < 0)) return false;",
          "463:           if (UNLIKELY(dch4 < 0)) return false;",
          "",
          "---------------"
        ]
      }
    }
  ]
}