{
  "cve_id": "CVE-2022-29780",
  "cve_desc": "Nginx NJS v0.7.2 was discovered to contain a segmentation violation in the function njs_array_prototype_sort at src/njs_array.c.",
  "repo": "nginx/njs",
  "patch_hash": "8b39afdad9a0761e0a5d4af1a762bd9a6daef572",
  "patch_info": {
    "commit_hash": "8b39afdad9a0761e0a5d4af1a762bd9a6daef572",
    "repo": "nginx/njs",
    "commit_url": "https://github.com/nginx/njs/commit/8b39afdad9a0761e0a5d4af1a762bd9a6daef572",
    "files": [
      "src/njs_array.c",
      "src/test/njs_unit_test.c"
    ],
    "message": "Fixed Array.prototype.sort() when arr size is changed in a comparator.\n\nThis fixed #468 issue on Github.",
    "before_after_code_files": [
      "src/njs_array.c||src/njs_array.c",
      "src/test/njs_unit_test.c||src/test/njs_unit_test.c"
    ]
  },
  "patch_diff": {
    "src/njs_array.c||src/njs_array.c": [
      "File: src/njs_array.c -> src/njs_array.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2696:         goto exception;",
      "2697:     }",
      "2700:         array = njs_array(this);",
      "2701:         start = array->start;",
      "",
      "[Removed Lines]",
      "2699:     if (njs_fast_path(fast_path)) {",
      "",
      "[Added Lines]",
      "2699:     if (njs_fast_path(fast_path && njs_is_fast_array(this))) {",
      "",
      "---------------"
    ],
    "src/test/njs_unit_test.c||src/test/njs_unit_test.c": [
      "File: src/test/njs_unit_test.c -> src/test/njs_unit_test.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "6989:     { njs_str(\"[1,2].sort(1)\"),",
      "6990:       njs_str(\"TypeError: comparefn must be callable or undefined\") },",
      "6993:       Array.prototype.keys()",
      "6994:       Array.prototype.values()",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6992:     { njs_str(\"var a = [1,2]; a.sort(() => {a.length = 65535}); a.length\"),",
      "6993:       njs_str(\"65535\") },",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5f4b5f2713b19ebf4524191309eb81eeb28205e3",
      "candidate_info": {
        "commit_hash": "5f4b5f2713b19ebf4524191309eb81eeb28205e3",
        "repo": "nginx/njs",
        "commit_url": "https://github.com/nginx/njs/commit/5f4b5f2713b19ebf4524191309eb81eeb28205e3",
        "files": [
          "src/njs_array.c",
          "src/test/njs_unit_test.c"
        ],
        "message": "Fixed Array.prototype.sort() when array is changed while sorting.\n\nPreviously, the fast-path check did not take into account the fact that\nthe flat array may be resized as a side effect of the array's values\nevaluation.\n\nIn addition, the slow_path fix ensures that \"this\" array is repopulated\nagain even if the array was resized.\n\nThis fixes #594 issue on Github.",
        "before_after_code_files": [
          "src/njs_array.c||src/njs_array.c",
          "src/test/njs_unit_test.c||src/test/njs_unit_test.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/njs_array.c||src/njs_array.c",
            "src/test/njs_unit_test.c||src/test/njs_unit_test.c"
          ],
          "candidate": [
            "src/njs_array.c||src/njs_array.c",
            "src/test/njs_unit_test.c||src/test/njs_unit_test.c"
          ]
        }
      },
      "candidate_diff": {
        "src/njs_array.c||src/njs_array.c": [
          "File: src/njs_array.c -> src/njs_array.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2663:         goto exception;",
          "2664:     }",
          "2667:         array = njs_array(this);",
          "2668:         start = array->start;",
          "",
          "[Removed Lines]",
          "2666:     if (njs_fast_path(fast_path && njs_is_fast_array(this))) {",
          "",
          "[Added Lines]",
          "2666:     if (njs_fast_path(fast_path",
          "2667:                       && njs_is_fast_array(this)",
          "2668:                       && (njs_array(this)->length == length)))",
          "2669:     {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2678:     } else {",
          "2679:         for (i = 0; i < len; i++) {",
          "2685:             }",
          "2686:         }",
          "",
          "[Removed Lines]",
          "2680:             if (slots[i].pos != i) {",
          "2681:                 ret = njs_value_property_i64_set(vm, this, i, &slots[i].value);",
          "2682:                 if (njs_slow_path(ret == NJS_ERROR)) {",
          "2683:                     goto exception;",
          "2684:                 }",
          "",
          "[Added Lines]",
          "2683:             ret = njs_value_property_i64_set(vm, this, i, &slots[i].value);",
          "2684:             if (njs_slow_path(ret == NJS_ERROR)) {",
          "2685:                 goto exception;",
          "",
          "---------------"
        ],
        "src/test/njs_unit_test.c||src/test/njs_unit_test.c": [
          "File: src/test/njs_unit_test.c -> src/test/njs_unit_test.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "7276:     { njs_str(\"var a = [1,2]; a.sort(() => {a.length = 65535}); a.length\"),",
          "7277:       njs_str(\"65535\") },",
          "7280:       Array.prototype.keys()",
          "7281:       Array.prototype.values()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7279:     { njs_str(\"var a = [];\"",
          "7280:               \"var shift = true;\"",
          "7281:               \"for (let i = 0; i < 64; i++) {\"",
          "7282:               \"    a[i] = { toString() {\"",
          "7283:               \"                 if (shift) { a.shift() };\"",
          "7284:               \"                 return (63 - i).toString().padStart(2, '0');\"",
          "7285:               \"             }\"",
          "7286:               \"           };\"",
          "7287:               \"}\"",
          "7288:               \"a.sort();\"",
          "7289:               \"shift = false;\"",
          "7290:               \"[a.length, a[0].toString(), a[63].toString()]\"),",
          "7291:       njs_str(\"64,00,63\") },",
          "7293:     { njs_str(\"var a = [];\"",
          "7294:               \"var shift = true;\"",
          "7295:               \"for (let i = 0; i < 64; i++) {\"",
          "7296:               \"    a[i] = { toString() {\"",
          "7297:               \"                 if (shift) { a.shift() };\"",
          "7298:               \"                 return (i).toString().padStart(2, '0');\"",
          "7299:               \"             }\"",
          "7300:               \"           };\"",
          "7301:               \"}\"",
          "7302:               \"a.sort();\"",
          "7303:               \"shift = false;\"",
          "7304:               \"[a.length, a[0].toString(), a[63].toString()]\"),",
          "7305:       njs_str(\"64,00,63\") },",
          "",
          "---------------"
        ]
      }
    }
  ]
}