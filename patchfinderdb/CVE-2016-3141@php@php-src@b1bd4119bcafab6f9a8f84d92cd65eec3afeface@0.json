{
  "cve_id": "CVE-2016-3141",
  "cve_desc": "Use-after-free vulnerability in wddx.c in the WDDX extension in PHP before 5.5.33 and 5.6.x before 5.6.19 allows remote attackers to cause a denial of service (memory corruption and application crash) or possibly have unspecified other impact by triggering a wddx_deserialize call on XML data containing a crafted var element.",
  "repo": "php/php-src",
  "patch_hash": "b1bd4119bcafab6f9a8f84d92cd65eec3afeface",
  "patch_info": {
    "commit_hash": "b1bd4119bcafab6f9a8f84d92cd65eec3afeface",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/b1bd4119bcafab6f9a8f84d92cd65eec3afeface",
    "files": [
      "ext/wddx/tests/bug71587.phpt",
      "ext/wddx/wddx.c"
    ],
    "message": "Fixed bug #71587 - Use-After-Free / Double-Free in WDDX Deserialize",
    "before_after_code_files": [
      "ext/wddx/tests/bug71587.phpt||ext/wddx/tests/bug71587.phpt",
      "ext/wddx/wddx.c||ext/wddx/wddx.c"
    ]
  },
  "patch_diff": {
    "ext/wddx/tests/bug71587.phpt||ext/wddx/tests/bug71587.phpt": [
      "File: ext/wddx/tests/bug71587.phpt -> ext/wddx/tests/bug71587.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #71587 (Use-After-Free / Double-Free in WDDX Deserialize)",
      "3: --SKIPIF--",
      "4: <?php",
      "5: if (!extension_loaded(\"wddx\")) print \"skip\";",
      "6: ?>",
      "7: --FILE--",
      "8: <?php",
      "10: $xml = <<<EOF",
      "11: <?xml version='1.0' ?>",
      "12: <!DOCTYPE wddxPacket SYSTEM 'wddx_0100.dtd'>",
      "13: <wddxPacket version='1.0'>",
      "14:     <array>",
      "15:          <var name='ML'></var>",
      "16:             <string>manhluat</string>",
      "17:          <var name='ML2'></var>",
      "18:           <boolean value='a'/>",
      "19:          <boolean value='true'/>",
      "20:     </array>",
      "21: </wddxPacket>",
      "22: EOF;",
      "24: $wddx = wddx_deserialize($xml);",
      "25: var_dump($wddx);",
      "27: foreach($wddx as $k=>$v)",
      "28:  printf(\"Key: %s\\nValue: %s\\n\",bin2hex($k),bin2hex($v));",
      "30: ?>",
      "31: DONE",
      "32: --EXPECTF--",
      "33: array(2) {",
      "34:   [0]=>",
      "35:   string(8) \"manhluat\"",
      "36:   [1]=>",
      "37:   bool(true)",
      "38: }",
      "39: Key: 30",
      "40: Value: 6d616e686c756174",
      "41: Key: 31",
      "42: Value: 31",
      "43: DONE",
      "",
      "---------------"
    ],
    "ext/wddx/wddx.c||ext/wddx/wddx.c": [
      "File: ext/wddx/wddx.c -> ext/wddx/wddx.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "936:   !strcmp(name, EL_DATETIME)) {",
      "937:   wddx_stack_top(stack, (void**)&ent1);",
      "939:   if (!strcmp(name, EL_BINARY)) {",
      "940:    int new_len=0;",
      "941:    unsigned char *new_str;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "939:   if (!ent1->data) {",
      "940:    if (stack->top > 1) {",
      "941:     stack->top--;",
      "942:    } else {",
      "943:     stack->done = 1;",
      "944:    }",
      "945:    efree(ent1);",
      "946:    return;",
      "947:   }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1032:   }",
      "1033:  } else if (!strcmp(name, EL_VAR) && stack->varname) {",
      "1034:   efree(stack->varname);",
      "1035:  } else if (!strcmp(name, EL_FIELD)) {",
      "1036:   st_entry *ent;",
      "1037:   wddx_stack_top(stack, (void **)&ent);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1045:   stack->varname = NULL;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1052:  if (!wddx_stack_is_empty(stack) && !stack->done) {",
      "1053:   wddx_stack_top(stack, (void**)&ent);",
      "1055:    case ST_STRING:",
      "1056:     if (Z_STRLEN_P(ent->data) == 0) {",
      "1057:      STR_FREE(Z_STRVAL_P(ent->data));",
      "",
      "[Removed Lines]",
      "1054:   switch (Z_TYPE_P(ent)) {",
      "",
      "[Added Lines]",
      "1065:   switch (ent->type) {",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1090:     } else if (!strcmp(s, \"false\")) {",
      "1091:      Z_LVAL_P(ent->data) = 0;",
      "1092:     } else {",
      "1094:      zval_ptr_dtor(&ent->data);",
      "1096:       efree(ent->varname);",
      "1098:     }",
      "1099:     break;",
      "",
      "[Removed Lines]",
      "1093:      stack->top--;",
      "1095:      if (ent->varname)",
      "1097:      efree(ent);",
      "",
      "[Added Lines]",
      "1105:      if (ent->varname) {",
      "1107:      }",
      "1108:      ent->data = NULL;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e09845d32614a19188632f410316478fbb440ebd",
      "candidate_info": {
        "commit_hash": "e09845d32614a19188632f410316478fbb440ebd",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/e09845d32614a19188632f410316478fbb440ebd",
        "files": [
          "ext/wddx/wddx.c"
        ],
        "message": "fix wddx merge",
        "before_after_code_files": [
          "ext/wddx/wddx.c||ext/wddx/wddx.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/wddx/wddx.c||ext/wddx/wddx.c"
          ],
          "candidate": [
            "ext/wddx/wddx.c||ext/wddx/wddx.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/wddx/wddx.c||ext/wddx/wddx.c": [
          "File: ext/wddx/wddx.c -> ext/wddx/wddx.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "877:   !strcmp((char *)name, EL_DATETIME)) {",
          "878:   wddx_stack_top(stack, (void**)&ent1);",
          "881:    if (stack->top > 1) {",
          "882:     stack->top--;",
          "883:    } else {",
          "",
          "[Removed Lines]",
          "880:   if (!ent1->data) {",
          "",
          "[Added Lines]",
          "880:   if (Z_TYPE(ent1->data) == IS_UNDEF) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1020:      if (ent->varname) {",
          "1021:       efree(ent->varname);",
          "1022:      }",
          "1024:     }",
          "1025:     break;",
          "",
          "[Removed Lines]",
          "1023:      ent->data = NULL;",
          "",
          "[Added Lines]",
          "1023:      ZVAL_UNDEF(&ent->data);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1ce0ea7396a917f3e68037df3647c4118f3a9fec",
      "candidate_info": {
        "commit_hash": "1ce0ea7396a917f3e68037df3647c4118f3a9fec",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/1ce0ea7396a917f3e68037df3647c4118f3a9fec",
        "files": [
          "ext/wddx/wddx.c"
        ],
        "message": "fix wddx merge",
        "before_after_code_files": [
          "ext/wddx/wddx.c||ext/wddx/wddx.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/wddx/wddx.c||ext/wddx/wddx.c"
          ],
          "candidate": [
            "ext/wddx/wddx.c||ext/wddx/wddx.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/wddx/wddx.c||ext/wddx/wddx.c": [
          "File: ext/wddx/wddx.c -> ext/wddx/wddx.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "877:   !strcmp((char *)name, EL_DATETIME)) {",
          "878:   wddx_stack_top(stack, (void**)&ent1);",
          "881:    if (stack->top > 1) {",
          "882:     stack->top--;",
          "883:    } else {",
          "",
          "[Removed Lines]",
          "880:   if (!ent1->data) {",
          "",
          "[Added Lines]",
          "880:   if (Z_TYPE(ent1->data) == IS_UNDEF) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1020:      if (ent->varname) {",
          "1021:       efree(ent->varname);",
          "1022:      }",
          "1024:     }",
          "1025:     break;",
          "",
          "[Removed Lines]",
          "1023:      ent->data = NULL;",
          "",
          "[Added Lines]",
          "1023:      ZVAL_UNDEF(&ent->data);",
          "",
          "---------------"
        ]
      }
    }
  ]
}