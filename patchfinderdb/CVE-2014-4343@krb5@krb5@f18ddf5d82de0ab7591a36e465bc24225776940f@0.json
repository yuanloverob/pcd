{
  "cve_id": "CVE-2014-4343",
  "cve_desc": "Double free vulnerability in the init_ctx_reselect function in the SPNEGO initiator in lib/gssapi/spnego/spnego_mech.c in MIT Kerberos 5 (aka krb5) 1.10.x through 1.12.x before 1.12.2 allows remote attackers to cause a denial of service (memory corruption) or possibly execute arbitrary code via network traffic that appears to come from an intended acceptor, but specifies a security mechanism different from the one proposed by the initiator.",
  "repo": "krb5/krb5",
  "patch_hash": "f18ddf5d82de0ab7591a36e465bc24225776940f",
  "patch_info": {
    "commit_hash": "f18ddf5d82de0ab7591a36e465bc24225776940f",
    "repo": "krb5/krb5",
    "commit_url": "https://github.com/krb5/krb5/commit/f18ddf5d82de0ab7591a36e465bc24225776940f",
    "files": [
      "src/lib/gssapi/spnego/spnego_mech.c"
    ],
    "message": "Fix double-free in SPNEGO [CVE-2014-4343]\n\nIn commit cd7d6b08 (\"Verify acceptor's mech in SPNEGO initiator\") the\npointer sc->internal_mech became an alias into sc->mech_set->elements,\nwhich should be considered constant for the duration of the SPNEGO\ncontext.  So don't free it.\n\nCVE-2014-4343:\n\nIn MIT krb5 releases 1.10 and newer, an unauthenticated remote\nattacker with the ability to spoof packets appearing to be from a\nGSSAPI acceptor can cause a double-free condition in GSSAPI initiators\n(clients) which are using the SPNEGO mechanism, by returning a\ndifferent underlying mechanism than was proposed by the initiator.  At\nthis stage of the negotiation, the acceptor is unauthenticated, and\nthe acceptor's response could be spoofed by an attacker with the\nability to inject traffic to the initiator.\n\nHistorically, some double-free vulnerabilities can be translated into\nremote code execution, though the necessary exploits must be tailored\nto the individual application and are usually quite\ncomplicated. Double-frees can also be exploited to cause an\napplication crash, for a denial of service.  However, most GSSAPI\nclient applications are not vulnerable, as the SPNEGO mechanism is not\nused by default (when GSS_C_NO_OID is passed as the mech_type argument\nto gss_init_sec_context()).  The most common use of SPNEGO is for\nHTTP-Negotiate, used in web browsers and other web clients.  Most such\nclients are believed to not offer HTTP-Negotiate by default, instead\nrequiring a whitelist of sites for which it may be used to be\nconfigured.  If the whitelist is configured to only allow\nHTTP-Negotiate over TLS connections (\"https://\"), a successful\nattacker must also spoof the web server's SSL certificate, due to the\nway the WWW-Authenticate header is sent in a 401 (Unauthorized)\nresponse message.  Unfortunately, many instructions for enabling\nHTTP-Negotiate in common web browsers do not include a TLS\nrequirement.\n\n    CVSSv2 Vector: AV:N/AC:H/Au:N/C:C/I:C/A:C/E:POC/RL:OF/RC:C\n\n[kaduk@mit.edu: CVE summary and CVSSv2 vector]\n\nticket: 7969 (new)\ntarget_version: 1.12.2\ntags: pullup",
    "before_after_code_files": [
      "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
    ]
  },
  "patch_diff": {
    "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c": [
      "File: src/lib/gssapi/spnego/spnego_mech.c -> src/lib/gssapi/spnego/spnego_mech.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "818:  OM_uint32 tmpmin;",
      "819:  size_t i;",
      "822:  gss_delete_sec_context(&tmpmin, &sc->ctx_handle,",
      "823:           GSS_C_NO_BUFFER);",
      "",
      "[Removed Lines]",
      "821:  generic_gss_release_oid(&tmpmin, &sc->internal_mech);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3a3749e219534415d4c9e449d0d08b047325ae89",
      "candidate_info": {
        "commit_hash": "3a3749e219534415d4c9e449d0d08b047325ae89",
        "repo": "krb5/krb5",
        "commit_url": "https://github.com/krb5/krb5/commit/3a3749e219534415d4c9e449d0d08b047325ae89",
        "files": [
          "src/lib/gssapi/spnego/spnego_mech.c"
        ],
        "message": "Fix double-free in SPNEGO [CVE-2014-4343]\n\nIn commit cd7d6b08 (\"Verify acceptor's mech in SPNEGO initiator\") the\npointer sc->internal_mech became an alias into sc->mech_set->elements,\nwhich should be considered constant for the duration of the SPNEGO\ncontext.  So don't free it.\n\nCVE-2014-4343:\n\nIn MIT krb5 releases 1.10 and newer, an unauthenticated remote\nattacker with the ability to spoof packets appearing to be from a\nGSSAPI acceptor can cause a double-free condition in GSSAPI initiators\n(clients) which are using the SPNEGO mechanism, by returning a\ndifferent underlying mechanism than was proposed by the initiator.  At\nthis stage of the negotiation, the acceptor is unauthenticated, and\nthe acceptor's response could be spoofed by an attacker with the\nability to inject traffic to the initiator.\n\nHistorically, some double-free vulnerabilities can be translated into\nremote code execution, though the necessary exploits must be tailored\nto the individual application and are usually quite\ncomplicated. Double-frees can also be exploited to cause an\napplication crash, for a denial of service.  However, most GSSAPI\nclient applications are not vulnerable, as the SPNEGO mechanism is not\nused by default (when GSS_C_NO_OID is passed as the mech_type argument\nto gss_init_sec_context()).  The most common use of SPNEGO is for\nHTTP-Negotiate, used in web browsers and other web clients.  Most such\nclients are believed to not offer HTTP-Negotiate by default, instead\nrequiring a whitelist of sites for which it may be used to be\nconfigured.  If the whitelist is configured to only allow\nHTTP-Negotiate over TLS connections (\"https://\"), a successful\nattacker must also spoof the web server's SSL certificate, due to the\nway the WWW-Authenticate header is sent in a 401 (Unauthorized)\nresponse message.  Unfortunately, many instructions for enabling\nHTTP-Negotiate in common web browsers do not include a TLS\nrequirement.\n\n    CVSSv2 Vector: AV:N/AC:H/Au:N/C:C/I:C/A:C/E:POC/RL:OF/RC:C\n\n[kaduk@mit.edu: CVE summary and CVSSv2 vector]\n\n(cherry picked from commit f18ddf5d82de0ab7591a36e465bc24225776940f)\n\nticket: 7969\nversion_fixed: 1.12.2\nstatus: resolved",
        "before_after_code_files": [
          "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
          ],
          "candidate": [
            "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c": [
          "File: src/lib/gssapi/spnego/spnego_mech.c -> src/lib/gssapi/spnego/spnego_mech.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "796:  OM_uint32 tmpmin;",
          "797:  size_t i;",
          "800:  gss_delete_sec_context(&tmpmin, &sc->ctx_handle,",
          "801:           GSS_C_NO_BUFFER);",
          "",
          "[Removed Lines]",
          "799:  generic_gss_release_oid(&tmpmin, &sc->internal_mech);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "32f6c3feba6c70f45ce2d29257bfe8c2dc2a0804",
      "candidate_info": {
        "commit_hash": "32f6c3feba6c70f45ce2d29257bfe8c2dc2a0804",
        "repo": "krb5/krb5",
        "commit_url": "https://github.com/krb5/krb5/commit/32f6c3feba6c70f45ce2d29257bfe8c2dc2a0804",
        "files": [
          "src/lib/gssapi/spnego/spnego_mech.c"
        ],
        "message": "Fix double-free in SPNEGO [CVE-2014-4343]\n\nIn commit cd7d6b08 (\"Verify acceptor's mech in SPNEGO initiator\") the\npointer sc->internal_mech became an alias into sc->mech_set->elements,\nwhich should be considered constant for the duration of the SPNEGO\ncontext.  So don't free it.\n\nCVE-2014-4343:\n\nIn MIT krb5 releases 1.10 and newer, an unauthenticated remote\nattacker with the ability to spoof packets appearing to be from a\nGSSAPI acceptor can cause a double-free condition in GSSAPI initiators\n(clients) which are using the SPNEGO mechanism, by returning a\ndifferent underlying mechanism than was proposed by the initiator.  At\nthis stage of the negotiation, the acceptor is unauthenticated, and\nthe acceptor's response could be spoofed by an attacker with the\nability to inject traffic to the initiator.\n\nHistorically, some double-free vulnerabilities can be translated into\nremote code execution, though the necessary exploits must be tailored\nto the individual application and are usually quite\ncomplicated. Double-frees can also be exploited to cause an\napplication crash, for a denial of service.  However, most GSSAPI\nclient applications are not vulnerable, as the SPNEGO mechanism is not\nused by default (when GSS_C_NO_OID is passed as the mech_type argument\nto gss_init_sec_context()).  The most common use of SPNEGO is for\nHTTP-Negotiate, used in web browsers and other web clients.  Most such\nclients are believed to not offer HTTP-Negotiate by default, instead\nrequiring a whitelist of sites for which it may be used to be\nconfigured.  If the whitelist is configured to only allow\nHTTP-Negotiate over TLS connections (\"https://\"), a successful\nattacker must also spoof the web server's SSL certificate, due to the\nway the WWW-Authenticate header is sent in a 401 (Unauthorized)\nresponse message.  Unfortunately, many instructions for enabling\nHTTP-Negotiate in common web browsers do not include a TLS\nrequirement.\n\n    CVSSv2 Vector: AV:N/AC:H/Au:N/C:C/I:C/A:C/E:POC/RL:OF/RC:C\n\n[kaduk@mit.edu: CVE summary and CVSSv2 vector]\n\n(cherry picked from commit f18ddf5d82de0ab7591a36e465bc24225776940f)\n\nticket: 8113 (new)\nversion_fixed: 1.11.6\nstatus: resolved",
        "before_after_code_files": [
          "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
          ],
          "candidate": [
            "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c"
          ]
        }
      },
      "candidate_diff": {
        "src/lib/gssapi/spnego/spnego_mech.c||src/lib/gssapi/spnego/spnego_mech.c": [
          "File: src/lib/gssapi/spnego/spnego_mech.c -> src/lib/gssapi/spnego/spnego_mech.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "789:  OM_uint32 tmpmin;",
          "790:  size_t i;",
          "793:  gss_delete_sec_context(&tmpmin, &sc->ctx_handle,",
          "794:           GSS_C_NO_BUFFER);",
          "",
          "[Removed Lines]",
          "792:  generic_gss_release_oid(&tmpmin, &sc->internal_mech);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}