{
  "cve_id": "CVE-2017-7866",
  "cve_desc": "FFmpeg before 2017-01-23 has an out-of-bounds write caused by a stack-based buffer overflow related to the decode_zbuf function in libavcodec/pngdec.c.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "e371f031b942d73e02c090170975561fabd5c264",
  "patch_info": {
    "commit_hash": "e371f031b942d73e02c090170975561fabd5c264",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e371f031b942d73e02c090170975561fabd5c264",
    "files": [
      "libavcodec/pngdec.c"
    ],
    "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavcodec/pngdec.c||libavcodec/pngdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/pngdec.c||libavcodec/pngdec.c": [
      "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "437:     av_bprint_init(bp, 0, -1);",
      "439:     while (zstream.avail_in > 0) {",
      "442:             ret = AVERROR(ENOMEM);",
      "443:             goto fail;",
      "444:         }",
      "445:         zstream.next_out  = buf;",
      "447:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
      "448:         if (ret != Z_OK && ret != Z_STREAM_END) {",
      "449:             ret = AVERROR_EXTERNAL;",
      "",
      "[Removed Lines]",
      "440:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
      "441:         if (!buf_size) {",
      "446:         zstream.avail_out = buf_size;",
      "",
      "[Added Lines]",
      "440:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
      "441:         if (buf_size < 2) {",
      "446:         zstream.avail_out = buf_size - 1;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "bd6c1d5149fbc4f2a0200ad99e7f56f4fb7d518a",
      "candidate_info": {
        "commit_hash": "bd6c1d5149fbc4f2a0200ad99e7f56f4fb7d518a",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/bd6c1d5149fbc4f2a0200ad99e7f56f4fb7d518a",
        "files": [
          "libavcodec/pngdec.c"
        ],
        "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit e371f031b942d73e02c090170975561fabd5c264)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/pngdec.c||libavcodec/pngdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ],
          "candidate": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/pngdec.c||libavcodec/pngdec.c": [
          "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "437:     av_bprint_init(bp, 0, -1);",
          "439:     while (zstream.avail_in > 0) {",
          "442:             ret = AVERROR(ENOMEM);",
          "443:             goto fail;",
          "444:         }",
          "445:         zstream.next_out  = buf;",
          "447:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
          "448:         if (ret != Z_OK && ret != Z_STREAM_END) {",
          "449:             ret = AVERROR_EXTERNAL;",
          "",
          "[Removed Lines]",
          "440:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
          "441:         if (!buf_size) {",
          "446:         zstream.avail_out = buf_size;",
          "",
          "[Added Lines]",
          "440:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
          "441:         if (buf_size < 2) {",
          "446:         zstream.avail_out = buf_size - 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "00bbf3063c9ef8033c23612dc25a9928beb3aa3d",
      "candidate_info": {
        "commit_hash": "00bbf3063c9ef8033c23612dc25a9928beb3aa3d",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/00bbf3063c9ef8033c23612dc25a9928beb3aa3d",
        "files": [
          "libavcodec/pngdec.c"
        ],
        "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit e371f031b942d73e02c090170975561fabd5c264)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/pngdec.c||libavcodec/pngdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ],
          "candidate": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/pngdec.c||libavcodec/pngdec.c": [
          "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "437:     av_bprint_init(bp, 0, -1);",
          "439:     while (zstream.avail_in > 0) {",
          "442:             ret = AVERROR(ENOMEM);",
          "443:             goto fail;",
          "444:         }",
          "445:         zstream.next_out  = buf;",
          "447:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
          "448:         if (ret != Z_OK && ret != Z_STREAM_END) {",
          "449:             ret = AVERROR_EXTERNAL;",
          "",
          "[Removed Lines]",
          "440:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
          "441:         if (!buf_size) {",
          "446:         zstream.avail_out = buf_size;",
          "",
          "[Added Lines]",
          "440:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
          "441:         if (buf_size < 2) {",
          "446:         zstream.avail_out = buf_size - 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1febd817b1d84a520dd2bc96ceacdfe7fb8a0dd2",
      "candidate_info": {
        "commit_hash": "1febd817b1d84a520dd2bc96ceacdfe7fb8a0dd2",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/1febd817b1d84a520dd2bc96ceacdfe7fb8a0dd2",
        "files": [
          "libavcodec/pngdec.c"
        ],
        "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit e371f031b942d73e02c090170975561fabd5c264)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/pngdec.c||libavcodec/pngdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ],
          "candidate": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/pngdec.c||libavcodec/pngdec.c": [
          "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "435:     av_bprint_init(bp, 0, -1);",
          "437:     while (zstream.avail_in > 0) {",
          "440:             ret = AVERROR(ENOMEM);",
          "441:             goto fail;",
          "442:         }",
          "443:         zstream.next_out  = buf;",
          "445:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
          "446:         if (ret != Z_OK && ret != Z_STREAM_END) {",
          "447:             ret = AVERROR_EXTERNAL;",
          "",
          "[Removed Lines]",
          "438:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
          "439:         if (!buf_size) {",
          "444:         zstream.avail_out = buf_size;",
          "",
          "[Added Lines]",
          "438:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
          "439:         if (buf_size < 2) {",
          "444:         zstream.avail_out = buf_size - 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "62244f37d116af28949787d160f80f5210083e55",
      "candidate_info": {
        "commit_hash": "62244f37d116af28949787d160f80f5210083e55",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/62244f37d116af28949787d160f80f5210083e55",
        "files": [
          "libavcodec/pngdec.c"
        ],
        "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit e371f031b942d73e02c090170975561fabd5c264)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/pngdec.c||libavcodec/pngdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ],
          "candidate": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/pngdec.c||libavcodec/pngdec.c": [
          "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "421:     av_bprint_init(bp, 0, -1);",
          "423:     while (zstream.avail_in > 0) {",
          "426:             ret = AVERROR(ENOMEM);",
          "427:             goto fail;",
          "428:         }",
          "429:         zstream.next_out  = buf;",
          "431:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
          "432:         if (ret != Z_OK && ret != Z_STREAM_END) {",
          "433:             ret = AVERROR_EXTERNAL;",
          "",
          "[Removed Lines]",
          "424:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
          "425:         if (!buf_size) {",
          "430:         zstream.avail_out = buf_size;",
          "",
          "[Added Lines]",
          "424:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
          "425:         if (buf_size < 2) {",
          "430:         zstream.avail_out = buf_size - 1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "99c78466ff27311b2a06d874cb7bbd8b1cefc597",
      "candidate_info": {
        "commit_hash": "99c78466ff27311b2a06d874cb7bbd8b1cefc597",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/99c78466ff27311b2a06d874cb7bbd8b1cefc597",
        "files": [
          "libavcodec/pngdec.c"
        ],
        "message": "avcodec/pngdec: Fix off by 1 size in decode_zbuf()\n\nFixes out of array access\nFixes: 444/fuzz-2-ffmpeg_VIDEO_AV_CODEC_ID_PNG_fuzzer\n\nFound-by: continuous fuzzing process https://github.com/google/oss-fuzz/tree/master/targets/ffmpeg\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit e371f031b942d73e02c090170975561fabd5c264)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/pngdec.c||libavcodec/pngdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ],
          "candidate": [
            "libavcodec/pngdec.c||libavcodec/pngdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/pngdec.c||libavcodec/pngdec.c": [
          "File: libavcodec/pngdec.c -> libavcodec/pngdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "437:     av_bprint_init(bp, 0, -1);",
          "439:     while (zstream.avail_in > 0) {",
          "442:             ret = AVERROR(ENOMEM);",
          "443:             goto fail;",
          "444:         }",
          "445:         zstream.next_out  = buf;",
          "447:         ret = inflate(&zstream, Z_PARTIAL_FLUSH);",
          "448:         if (ret != Z_OK && ret != Z_STREAM_END) {",
          "449:             ret = AVERROR_EXTERNAL;",
          "",
          "[Removed Lines]",
          "440:         av_bprint_get_buffer(bp, 1, &buf, &buf_size);",
          "441:         if (!buf_size) {",
          "446:         zstream.avail_out = buf_size;",
          "",
          "[Added Lines]",
          "440:         av_bprint_get_buffer(bp, 2, &buf, &buf_size);",
          "441:         if (buf_size < 2) {",
          "446:         zstream.avail_out = buf_size - 1;",
          "",
          "---------------"
        ]
      }
    }
  ]
}