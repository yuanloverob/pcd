{
  "cve_id": "CVE-2020-15852",
  "cve_desc": "An issue was discovered in the Linux kernel 5.5 through 5.7.9, as used in Xen through 4.13.x for x86 PV guests. An attacker may be granted the I/O port permissions of an unrelated task. This occurs because tss_invalidate_io_bitmap mishandling causes a loss of synchronization between the I/O bitmaps of TSS and Xen, aka CID-cadfad870154.",
  "repo": "torvalds/linux",
  "patch_hash": "cadfad870154e14f745ec845708bc17d166065f2",
  "patch_info": {
    "commit_hash": "cadfad870154e14f745ec845708bc17d166065f2",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/cadfad870154e14f745ec845708bc17d166065f2",
    "files": [
      "arch/x86/include/asm/io_bitmap.h",
      "arch/x86/include/asm/paravirt.h",
      "arch/x86/include/asm/paravirt_types.h",
      "arch/x86/kernel/paravirt.c",
      "arch/x86/kernel/process.c",
      "arch/x86/xen/enlighten_pv.c"
    ],
    "message": "x86/ioperm: Fix io bitmap invalidation on Xen PV\n\ntss_invalidate_io_bitmap() wasn't wired up properly through the pvop\nmachinery, so the TSS and Xen's io bitmap would get out of sync\nwhenever disabling a valid io bitmap.\n\nAdd a new pvop for tss_invalidate_io_bitmap() to fix it.\n\nThis is XSA-329.\n\nFixes: 22fe5b0439dd (\"x86/ioperm: Move TSS bitmap update to exit to user work\")\nSigned-off-by: Andy Lutomirski <luto@kernel.org>\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\nReviewed-by: Juergen Gross <jgross@suse.com>\nReviewed-by: Thomas Gleixner <tglx@linutronix.de>\nCc: stable@vger.kernel.org\nLink: https://lkml.kernel.org/r/d53075590e1f91c19f8af705059d3ff99424c020.1595030016.git.luto@kernel.org",
    "before_after_code_files": [
      "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
      "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h",
      "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h",
      "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c",
      "arch/x86/kernel/process.c||arch/x86/kernel/process.c",
      "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
    ]
  },
  "patch_diff": {
    "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h": [
      "File: arch/x86/include/asm/io_bitmap.h -> arch/x86/include/asm/io_bitmap.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "19: void io_bitmap_share(struct task_struct *tsk);",
      "20: void io_bitmap_exit(struct task_struct *tsk);",
      "22: void native_tss_update_io_bitmap(void);",
      "24: #ifdef CONFIG_PARAVIRT_XXL",
      "25: #include <asm/paravirt.h>",
      "26: #else",
      "27: #define tss_update_io_bitmap native_tss_update_io_bitmap",
      "28: #endif",
      "30: #else",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "22: static inline void native_tss_invalidate_io_bitmap(void)",
      "23: {",
      "33:  this_cpu_write(cpu_tss_rw.x86_tss.io_bitmap_base,",
      "34:          IO_BITMAP_OFFSET_INVALID);",
      "35: }",
      "43: #define tss_invalidate_io_bitmap native_tss_invalidate_io_bitmap",
      "",
      "---------------"
    ],
    "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h": [
      "File: arch/x86/include/asm/paravirt.h -> arch/x86/include/asm/paravirt.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "302: }",
      "304: #ifdef CONFIG_X86_IOPL_IOPERM",
      "305: static inline void tss_update_io_bitmap(void)",
      "306: {",
      "307:  PVOP_VCALL0(cpu.update_io_bitmap);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "305: static inline void tss_invalidate_io_bitmap(void)",
      "306: {",
      "307:  PVOP_VCALL0(cpu.invalidate_io_bitmap);",
      "308: }",
      "",
      "---------------"
    ],
    "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h": [
      "File: arch/x86/include/asm/paravirt_types.h -> arch/x86/include/asm/paravirt_types.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "141:  void (*load_sp0)(unsigned long sp0);",
      "143: #ifdef CONFIG_X86_IOPL_IOPERM",
      "144:  void (*update_io_bitmap)(void);",
      "145: #endif",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "144:  void (*invalidate_io_bitmap)(void);",
      "",
      "---------------"
    ],
    "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c": [
      "File: arch/x86/kernel/paravirt.c -> arch/x86/kernel/paravirt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "324:  .cpu.swapgs  = native_swapgs,",
      "326: #ifdef CONFIG_X86_IOPL_IOPERM",
      "328: #endif",
      "330:  .cpu.start_context_switch = paravirt_nop,",
      "",
      "[Removed Lines]",
      "327:  .cpu.update_io_bitmap = native_tss_update_io_bitmap,",
      "",
      "[Added Lines]",
      "327:  .cpu.invalidate_io_bitmap = native_tss_invalidate_io_bitmap,",
      "328:  .cpu.update_io_bitmap  = native_tss_update_io_bitmap,",
      "",
      "---------------"
    ],
    "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
      "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "322: }",
      "324: #ifdef CONFIG_X86_IOPL_IOPERM",
      "339: static inline void switch_to_bitmap(unsigned long tifp)",
      "340: {",
      "",
      "[Removed Lines]",
      "325: static inline void tss_invalidate_io_bitmap(struct tss_struct *tss)",
      "326: {",
      "336:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
      "337: }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "348:  if (tifp & _TIF_IO_BITMAP)",
      "350: }",
      "352: static void tss_copy_io_bitmap(struct tss_struct *tss, struct io_bitmap *iobm)",
      "",
      "[Removed Lines]",
      "349:   tss_invalidate_io_bitmap(this_cpu_ptr(&cpu_tss_rw));",
      "",
      "[Added Lines]",
      "335:   tss_invalidate_io_bitmap();",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "380:  u16 *base = &tss->x86_tss.io_bitmap_base;",
      "382:  if (!test_thread_flag(TIF_IO_BITMAP)) {",
      "384:   return;",
      "385:  }",
      "",
      "[Removed Lines]",
      "383:   tss_invalidate_io_bitmap(tss);",
      "",
      "[Added Lines]",
      "369:   native_tss_invalidate_io_bitmap();",
      "",
      "---------------"
    ],
    "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c": [
      "File: arch/x86/xen/enlighten_pv.c -> arch/x86/xen/enlighten_pv.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "870: }",
      "872: #ifdef CONFIG_X86_IOPL_IOPERM",
      "873: static void xen_update_io_bitmap(void)",
      "874: {",
      "875:  struct physdev_set_iobitmap iobitmap;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "873: static void xen_invalidate_io_bitmap(void)",
      "874: {",
      "875:  struct physdev_set_iobitmap iobitmap = {",
      "876:   .bitmap = 0,",
      "877:   .nr_ports = 0,",
      "878:  };",
      "880:  native_tss_invalidate_io_bitmap();",
      "881:  HYPERVISOR_physdev_op(PHYSDEVOP_set_iobitmap, &iobitmap);",
      "882: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1099:  .load_sp0 = xen_load_sp0,",
      "1101: #ifdef CONFIG_X86_IOPL_IOPERM",
      "1102:  .update_io_bitmap = xen_update_io_bitmap,",
      "1103: #endif",
      "1104:  .io_delay = xen_io_delay,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1113:  .invalidate_io_bitmap = xen_invalidate_io_bitmap,",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "90fc73928fec2f62bbee1476781754c7392a7b61",
      "candidate_info": {
        "commit_hash": "90fc73928fec2f62bbee1476781754c7392a7b61",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/90fc73928fec2f62bbee1476781754c7392a7b61",
        "files": [
          "arch/x86/xen/enlighten_pv.c"
        ],
        "message": "x86/ioperm: Initialize pointer bitmap with NULL rather than 0\n\nThe pointer bitmap is being initialized with a plain integer 0,\nfix this by initializing it with a NULL instead.\n\nCleans up sparse warning:\narch/x86/xen/enlighten_pv.c:876:27: warning: Using plain integer\nas NULL pointer\n\nSigned-off-by: Colin Ian King <colin.king@canonical.com>\nSigned-off-by: Ingo Molnar <mingo@kernel.org>\nReviewed-by: Juergen Gross <jgross@suse.com>\nLink: https://lore.kernel.org/r/20200721100217.407975-1-colin.king@canonical.com",
        "before_after_code_files": [
          "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
          ],
          "candidate": [
            "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c": [
          "File: arch/x86/xen/enlighten_pv.c -> arch/x86/xen/enlighten_pv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "873: static void xen_invalidate_io_bitmap(void)",
          "874: {",
          "875:  struct physdev_set_iobitmap iobitmap = {",
          "877:   .nr_ports = 0,",
          "878:  };",
          "",
          "[Removed Lines]",
          "876:   .bitmap = 0,",
          "",
          "[Added Lines]",
          "876:   .bitmap = NULL,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "99bcd4a6e5b8ba201fdd252f1054689884899fee",
      "candidate_info": {
        "commit_hash": "99bcd4a6e5b8ba201fdd252f1054689884899fee",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/99bcd4a6e5b8ba201fdd252f1054689884899fee",
        "files": [
          "arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/paravirt.h",
          "arch/x86/include/asm/paravirt_types.h",
          "arch/x86/kernel/paravirt.c",
          "arch/x86/kernel/process.c",
          "arch/x86/xen/enlighten_pv.c"
        ],
        "message": "x86/ioperm: Add new paravirt function update_io_bitmap()\n\nCommit 111e7b15cf10f6 (\"x86/ioperm: Extend IOPL config to control ioperm()\nas well\") reworked the iopl syscall to use I/O bitmaps.\n\nUnfortunately this broke Xen PV domains using that syscall as there is\ncurrently no I/O bitmap support in PV domains.\n\nAdd I/O bitmap support via a new paravirt function update_io_bitmap which\nXen PV domains can use to update their I/O bitmaps via a hypercall.\n\nFixes: 111e7b15cf10f6 (\"x86/ioperm: Extend IOPL config to control ioperm() as well\")\nReported-by: Jan Beulich <jbeulich@suse.com>\nSigned-off-by: Juergen Gross <jgross@suse.com>\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\nTested-by: Jan Beulich <jbeulich@suse.com>\nReviewed-by: Jan Beulich <jbeulich@suse.com>\nCc: <stable@vger.kernel.org> # 5.5\nLink: https://lkml.kernel.org/r/20200218154712.25490-1-jgross@suse.com",
        "before_after_code_files": [
          "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h",
          "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h",
          "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c",
          "arch/x86/kernel/process.c||arch/x86/kernel/process.c",
          "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h",
            "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h",
            "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c",
            "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
          ],
          "candidate": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h",
            "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h",
            "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c",
            "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h": [
          "File: arch/x86/include/asm/io_bitmap.h -> arch/x86/include/asm/io_bitmap.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "19: void io_bitmap_share(struct task_struct *tsk);",
          "20: void io_bitmap_exit(void);",
          "23: #else",
          "24: static inline void io_bitmap_share(struct task_struct *tsk) { }",
          "25: static inline void io_bitmap_exit(void) { }",
          "",
          "[Removed Lines]",
          "22: void tss_update_io_bitmap(void);",
          "",
          "[Added Lines]",
          "22: void native_tss_update_io_bitmap(void);",
          "24: #ifdef CONFIG_PARAVIRT_XXL",
          "25: #include <asm/paravirt.h>",
          "26: #else",
          "27: #define tss_update_io_bitmap native_tss_update_io_bitmap",
          "28: #endif",
          "",
          "---------------"
        ],
        "arch/x86/include/asm/paravirt.h||arch/x86/include/asm/paravirt.h": [
          "File: arch/x86/include/asm/paravirt.h -> arch/x86/include/asm/paravirt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "295:  PVOP_VCALL3(cpu.write_idt_entry, dt, entry, g);",
          "296: }",
          "298: static inline void paravirt_activate_mm(struct mm_struct *prev,",
          "299:      struct mm_struct *next)",
          "300: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "298: #ifdef CONFIG_X86_IOPL_IOPERM",
          "299: static inline void tss_update_io_bitmap(void)",
          "300: {",
          "301:  PVOP_VCALL0(cpu.update_io_bitmap);",
          "302: }",
          "303: #endif",
          "",
          "---------------"
        ],
        "arch/x86/include/asm/paravirt_types.h||arch/x86/include/asm/paravirt_types.h": [
          "File: arch/x86/include/asm/paravirt_types.h -> arch/x86/include/asm/paravirt_types.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "141:  void (*load_sp0)(unsigned long sp0);",
          "143:  void (*wbinvd)(void);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "143: #ifdef CONFIG_X86_IOPL_IOPERM",
          "144:  void (*update_io_bitmap)(void);",
          "145: #endif",
          "",
          "---------------"
        ],
        "arch/x86/kernel/paravirt.c||arch/x86/kernel/paravirt.c": [
          "File: arch/x86/kernel/paravirt.c -> arch/x86/kernel/paravirt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: #include <asm/timer.h>",
          "31: #include <asm/special_insns.h>",
          "32: #include <asm/tlb.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: #include <asm/io_bitmap.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "341:  .cpu.iret  = native_iret,",
          "342:  .cpu.swapgs  = native_swapgs,",
          "344:  .cpu.start_context_switch = paravirt_nop,",
          "345:  .cpu.end_context_switch  = paravirt_nop,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345: #ifdef CONFIG_X86_IOPL_IOPERM",
          "346:  .cpu.update_io_bitmap = native_tss_update_io_bitmap,",
          "347: #endif",
          "",
          "---------------"
        ],
        "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
          "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "378: {",
          "379:  struct tss_struct *tss = this_cpu_ptr(&cpu_tss_rw);",
          "380:  struct thread_struct *t = &current->thread;",
          "",
          "[Removed Lines]",
          "377: void tss_update_io_bitmap(void)",
          "",
          "[Added Lines]",
          "377: void native_tss_update_io_bitmap(void)",
          "",
          "---------------"
        ],
        "arch/x86/xen/enlighten_pv.c||arch/x86/xen/enlighten_pv.c": [
          "File: arch/x86/xen/enlighten_pv.c -> arch/x86/xen/enlighten_pv.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "72: #include <asm/mwait.h>",
          "73: #include <asm/pci_x86.h>",
          "74: #include <asm/cpu.h>",
          "76: #ifdef CONFIG_ACPI",
          "77: #include <linux/acpi.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75: #ifdef CONFIG_X86_IOPL_IOPERM",
          "76: #include <asm/io_bitmap.h>",
          "77: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "837:  this_cpu_write(cpu_tss_rw.x86_tss.sp0, sp0);",
          "838: }",
          "840: static void xen_io_delay(void)",
          "841: {",
          "842: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "843: #ifdef CONFIG_X86_IOPL_IOPERM",
          "844: static void xen_update_io_bitmap(void)",
          "845: {",
          "846:  struct physdev_set_iobitmap iobitmap;",
          "847:  struct tss_struct *tss = this_cpu_ptr(&cpu_tss_rw);",
          "849:  native_tss_update_io_bitmap();",
          "851:  iobitmap.bitmap = (uint8_t *)(&tss->x86_tss) +",
          "852:      tss->x86_tss.io_bitmap_base;",
          "853:  if (tss->x86_tss.io_bitmap_base == IO_BITMAP_OFFSET_INVALID)",
          "854:   iobitmap.nr_ports = 0;",
          "855:  else",
          "856:   iobitmap.nr_ports = IO_BITMAP_BITS;",
          "858:  HYPERVISOR_physdev_op(PHYSDEVOP_set_iobitmap, &iobitmap);",
          "859: }",
          "860: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1047:  .write_idt_entry = xen_write_idt_entry,",
          "1048:  .load_sp0 = xen_load_sp0,",
          "1050:  .io_delay = xen_io_delay,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1072: #ifdef CONFIG_X86_IOPL_IOPERM",
          "1073:  .update_io_bitmap = xen_update_io_bitmap,",
          "1074: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "22fe5b0439dd53643fd6f4c582c46c6dba0fde53",
      "candidate_info": {
        "commit_hash": "22fe5b0439dd53643fd6f4c582c46c6dba0fde53",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/22fe5b0439dd53643fd6f4c582c46c6dba0fde53",
        "files": [
          "arch/x86/entry/common.c",
          "arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/thread_info.h",
          "arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c"
        ],
        "message": "x86/ioperm: Move TSS bitmap update to exit to user work\n\nThere is no point to update the TSS bitmap for tasks which use I/O bitmaps\non every context switch. It's enough to update it right before exiting to\nuser space.\n\nThat reduces the context switch bitmap handling to invalidating the io\nbitmap base offset in the TSS when the outgoing task has TIF_IO_BITMAP\nset. The invaldiation is done on purpose when a task with an IO bitmap\nswitches out to prevent any possible leakage of an activated IO bitmap.\n\nIt also removes the requirement to update the tasks bitmap atomically in\nioperm().\n\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>",
        "before_after_code_files": [
          "arch/x86/entry/common.c||arch/x86/entry/common.c",
          "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/thread_info.h||arch/x86/include/asm/thread_info.h",
          "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ],
          "candidate": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/entry/common.c||arch/x86/entry/common.c": [
          "File: arch/x86/entry/common.c -> arch/x86/entry/common.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include <asm/cpufeature.h>",
          "34: #include <asm/fpu/api.h>",
          "35: #include <asm/nospec-branch.h>",
          "37: #define CREATE_TRACE_POINTS",
          "38: #include <trace/events/syscalls.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36: #include <asm/io_bitmap.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "197:  cached_flags = READ_ONCE(ti->flags);",
          "199:  fpregs_assert_state_consistent();",
          "200:  if (unlikely(cached_flags & _TIF_NEED_FPU_LOAD))",
          "201:   switch_fpu_return();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "200:  if (unlikely(cached_flags & _TIF_IO_BITMAP))",
          "201:   tss_update_io_bitmap();",
          "",
          "---------------"
        ],
        "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h": [
          "File: arch/x86/include/asm/io_bitmap.h -> arch/x86/include/asm/io_bitmap.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "11:  unsigned long bitmap[IO_BITMAP_LONGS];",
          "12: };",
          "14: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "14: void tss_update_io_bitmap(void);",
          "",
          "---------------"
        ],
        "arch/x86/include/asm/thread_info.h||arch/x86/include/asm/thread_info.h": [
          "File: arch/x86/include/asm/thread_info.h -> arch/x86/include/asm/thread_info.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "143:   _TIF_NOHZ)",
          "148:   _TIF_SSBD | _TIF_SPEC_FORCE_UPDATE)",
          "",
          "[Removed Lines]",
          "146: #define _TIF_WORK_CTXSW_BASE      \\",
          "147:  (_TIF_IO_BITMAP|_TIF_NOCPUID|_TIF_NOTSC|_TIF_BLOCKSTEP|  \\",
          "",
          "[Added Lines]",
          "146: #define _TIF_WORK_CTXSW_BASE     \\",
          "147:  (_TIF_NOCPUID | _TIF_NOTSC | _TIF_BLOCKSTEP |  \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "156: # define _TIF_WORK_CTXSW (_TIF_WORK_CTXSW_BASE)",
          "157: #endif",
          "162: #define STACK_WARN  (THREAD_SIZE/8)",
          "",
          "[Removed Lines]",
          "159: #define _TIF_WORK_CTXSW_PREV (_TIF_WORK_CTXSW|_TIF_USER_RETURN_NOTIFY)",
          "160: #define _TIF_WORK_CTXSW_NEXT (_TIF_WORK_CTXSW)",
          "",
          "[Added Lines]",
          "159: #define _TIF_WORK_CTXSW_PREV (_TIF_WORK_CTXSW| _TIF_USER_RETURN_NOTIFY | \\",
          "160:      _TIF_IO_BITMAP)",
          "161: #define _TIF_WORK_CTXSW_NEXT (_TIF_WORK_CTXSW)",
          "",
          "---------------"
        ],
        "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c": [
          "File: arch/x86/kernel/ioport.c -> arch/x86/kernel/ioport.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: long ksys_ioperm(unsigned long from, unsigned long num, int turn_on)",
          "23: {",
          "25:  struct thread_struct *t = &current->thread;",
          "27:  struct io_bitmap *iobm;",
          "29:  if ((from + num <= from) || (from + num > IO_BITMAP_BITS))",
          "",
          "[Removed Lines]",
          "24:  unsigned int i, max_long, bytes, bytes_updated;",
          "26:  struct tss_struct *tss;",
          "",
          "[Added Lines]",
          "25:  unsigned int i, max_long;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "50:  }",
          "57:  if (turn_on)",
          "58:   bitmap_clear(iobm->bitmap, from, num);",
          "59:  else",
          "",
          "[Removed Lines]",
          "56:  preempt_disable();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "69:    max_long = i;",
          "70:  }",
          "78:  iobm->sequence = atomic64_add_return(1, &io_bitmap_sequence);",
          "",
          "[Removed Lines]",
          "72:  bytes = (max_long + 1) * sizeof(unsigned long);",
          "73:  bytes_updated = max(bytes, t->io_bitmap->max);",
          "76:  iobm->max = bytes;",
          "",
          "[Added Lines]",
          "70:  iobm->max = (max_long + 1) * sizeof(unsigned long);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "85:  t->io_bitmap = iobm;",
          "86:  set_thread_flag(TIF_IO_BITMAP);",
          "100:  return 0;",
          "101: }",
          "",
          "[Removed Lines]",
          "89:  tss = this_cpu_ptr(&cpu_tss_rw);",
          "90:  memcpy(tss->io_bitmap.bitmap, iobm->bitmap, bytes_updated);",
          "92:  tss->io_bitmap.prev_max = bytes;",
          "94:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_VALID;",
          "96:  refresh_tss_limit();",
          "98:  preempt_enable();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
          "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "360:  }",
          "361: }",
          "365: {",
          "",
          "[Removed Lines]",
          "363: static void switch_to_update_io_bitmap(struct tss_struct *tss,",
          "364:            struct io_bitmap *iobm)",
          "",
          "[Added Lines]",
          "363: static inline void tss_invalidate_io_bitmap(struct tss_struct *tss)",
          "364: {",
          "374:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "375: }",
          "377: static inline void switch_to_bitmap(unsigned long tifp)",
          "378: {",
          "386:  if (tifp & _TIF_IO_BITMAP)",
          "387:   tss_invalidate_io_bitmap(this_cpu_ptr(&cpu_tss_rw));",
          "388: }",
          "390: static void tss_copy_io_bitmap(struct tss_struct *tss, struct io_bitmap *iobm)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "382:  tss->io_bitmap.prev_sequence = iobm->sequence;",
          "383: }",
          "387: {",
          "388:  struct tss_struct *tss = this_cpu_ptr(&cpu_tss_rw);",
          "",
          "[Removed Lines]",
          "385: static inline void switch_to_bitmap(struct thread_struct *next,",
          "386:         unsigned long tifp, unsigned long tifn)",
          "390:  if (tifn & _TIF_IO_BITMAP) {",
          "391:   struct io_bitmap *iobm = next->io_bitmap;",
          "",
          "[Added Lines]",
          "414: void tss_update_io_bitmap(void)",
          "418:  if (test_thread_flag(TIF_IO_BITMAP)) {",
          "419:   struct io_bitmap *iobm = current->thread.io_bitmap;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "398:   if (tss->io_bitmap.prev_sequence != iobm->sequence)",
          "402:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_VALID;",
          "",
          "[Removed Lines]",
          "399:    switch_to_update_io_bitmap(tss, iobm);",
          "",
          "[Added Lines]",
          "427:    tss_copy_io_bitmap(tss, iobm);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "411:   refresh_tss_limit();",
          "424:  }",
          "425: }",
          "",
          "[Removed Lines]",
          "412:  } else if (tifp & _TIF_IO_BITMAP) {",
          "423:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "",
          "[Added Lines]",
          "440:  } else {",
          "441:   tss_invalidate_io_bitmap(tss);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "635:  tifn = READ_ONCE(task_thread_info(next_p)->flags);",
          "636:  tifp = READ_ONCE(task_thread_info(prev_p)->flags);",
          "639:  propagate_user_return_notify(prev_p, next_p);",
          "",
          "[Removed Lines]",
          "637:  switch_to_bitmap(next, tifp, tifn);",
          "",
          "[Added Lines]",
          "656:  switch_to_bitmap(tifp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "060aa16fdb7c5078a4159a76e5dc87d6a493af9b",
      "candidate_info": {
        "commit_hash": "060aa16fdb7c5078a4159a76e5dc87d6a493af9b",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/060aa16fdb7c5078a4159a76e5dc87d6a493af9b",
        "files": [
          "arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/processor.h",
          "arch/x86/kernel/cpu/common.c",
          "arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c"
        ],
        "message": "x86/ioperm: Add bitmap sequence number\n\nAdd a globally unique sequence number which is incremented when ioperm() is\nchanging the I/O bitmap of a task. Store the new sequence number in the\nio_bitmap structure and compare it with the sequence number of the I/O\nbitmap which was last loaded on a CPU. Only update the bitmap if the\nsequence is different.\n\nThat should further reduce the overhead of I/O bitmap scheduling when there\nare only a few I/O bitmap users on the system.\n\nThe 64bit sequence counter is sufficient. A wraparound of the sequence\ncounter assuming an ioperm() call every nanosecond would require about 584\nyears of uptime.\n\nSuggested-by: Linus Torvalds <torvalds@linux-foundation.org>\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>",
        "before_after_code_files": [
          "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
          "arch/x86/include/asm/processor.h||arch/x86/include/asm/processor.h",
          "arch/x86/kernel/cpu/common.c||arch/x86/kernel/cpu/common.c",
          "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c",
          "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ],
          "candidate": [
            "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h",
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/include/asm/io_bitmap.h||arch/x86/include/asm/io_bitmap.h": [
          "File: arch/x86/include/asm/io_bitmap.h -> arch/x86/include/asm/io_bitmap.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: #include <asm/processor.h>",
          "7: struct io_bitmap {",
          "9:  unsigned int max;",
          "10:  unsigned long bitmap[IO_BITMAP_LONGS];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8:  u64  sequence;",
          "",
          "---------------"
        ],
        "arch/x86/include/asm/processor.h||arch/x86/include/asm/processor.h": [
          "File: arch/x86/include/asm/processor.h -> arch/x86/include/asm/processor.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "363: struct x86_io_bitmap {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "365:  u64   prev_sequence;",
          "",
          "---------------"
        ],
        "arch/x86/kernel/cpu/common.c||arch/x86/kernel/cpu/common.c": [
          "File: arch/x86/kernel/cpu/common.c -> arch/x86/kernel/cpu/common.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1862:  tss_setup_ist(tss);",
          "1863:  tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_INVALID;",
          "1864:  tss->io_bitmap.prev_max = 0;",
          "1865:  memset(tss->io_bitmap.bitmap, 0xff, sizeof(tss->io_bitmap.bitmap));",
          "1866:  set_tss_desc(cpu, &get_cpu_entry_area(cpu)->tss.x86_tss);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1865:  tss->io_bitmap.prev_sequence = 0;",
          "",
          "---------------"
        ],
        "arch/x86/kernel/ioport.c||arch/x86/kernel/ioport.c": [
          "File: arch/x86/kernel/ioport.c -> arch/x86/kernel/ioport.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: #include <asm/io_bitmap.h>",
          "15: #include <asm/desc.h>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "17: static atomic64_t io_bitmap_sequence;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "74:  iobm->max = bytes;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "78:  iobm->sequence = atomic64_add_return(1, &io_bitmap_sequence);",
          "",
          "---------------"
        ],
        "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
          "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "360:  }",
          "361: }",
          "363: static inline void switch_to_bitmap(struct thread_struct *next,",
          "364:         unsigned long tifp, unsigned long tifn)",
          "365: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "363: static void switch_to_update_io_bitmap(struct tss_struct *tss,",
          "364:            struct io_bitmap *iobm)",
          "365: {",
          "374:  memcpy(tss->io_bitmap.bitmap, iobm->bitmap,",
          "375:         max(tss->io_bitmap.prev_max, iobm->max));",
          "381:  tss->io_bitmap.prev_max = iobm->max;",
          "382:  tss->io_bitmap.prev_sequence = iobm->sequence;",
          "383: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "369:   struct io_bitmap *iobm = next->io_bitmap;",
          "384:   tss->x86_tss.io_bitmap_base = IO_BITMAP_OFFSET_VALID;",
          "",
          "[Removed Lines]",
          "379:   memcpy(tss->io_bitmap.bitmap, next->io_bitmap->bitmap,",
          "380:          max(tss->io_bitmap.prev_max, next->io_bitmap->max));",
          "383:   tss->io_bitmap.prev_max = next->io_bitmap->max;",
          "",
          "[Added Lines]",
          "398:   if (tss->io_bitmap.prev_sequence != iobm->sequence)",
          "399:    switch_to_update_io_bitmap(tss, iobm);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7b0b8cfd261c569177d64d6e9b1800fbe412fd65",
      "candidate_info": {
        "commit_hash": "7b0b8cfd261c569177d64d6e9b1800fbe412fd65",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/7b0b8cfd261c569177d64d6e9b1800fbe412fd65",
        "files": [
          "arch/x86/kernel/process.c"
        ],
        "message": "x86/ioperm: Save an indentation level in tss_update_io_bitmap()\n\n... for better readability.\n\nNo functional changes.\n\n[ Minor edit. ]\n\nSigned-off-by: Borislav Petkov <bp@suse.de>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Thomas Gleixner <tglx@linutronix.de>\nSigned-off-by: Ingo Molnar <mingo@kernel.org>",
        "before_after_code_files": [
          "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ],
          "candidate": [
            "arch/x86/kernel/process.c||arch/x86/kernel/process.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/x86/kernel/process.c||arch/x86/kernel/process.c": [
          "File: arch/x86/kernel/process.c -> arch/x86/kernel/process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "377: void tss_update_io_bitmap(void)",
          "378: {",
          "379:  struct tss_struct *tss = this_cpu_ptr(&cpu_tss_rw);",
          "380:  u16 *base = &tss->x86_tss.io_bitmap_base;",
          "410:  }",
          "411: }",
          "413: static inline void switch_to_bitmap(unsigned long tifp) { }",
          "",
          "[Removed Lines]",
          "382:  if (test_thread_flag(TIF_IO_BITMAP)) {",
          "383:   struct thread_struct *t = &current->thread;",
          "385:   if (IS_ENABLED(CONFIG_X86_IOPL_IOPERM) && t->iopl_emul == 3) {",
          "387:   } else {",
          "388:    struct io_bitmap *iobm = t->io_bitmap;",
          "394:    if (tss->io_bitmap.prev_sequence != iobm->sequence)",
          "395:     tss_copy_io_bitmap(tss, iobm);",
          "399:   }",
          "407:   refresh_tss_limit();",
          "408:  } else {",
          "409:   tss_invalidate_io_bitmap(tss);",
          "",
          "[Added Lines]",
          "380:  struct thread_struct *t = &current->thread;",
          "383:  if (!test_thread_flag(TIF_IO_BITMAP)) {",
          "384:   tss_invalidate_io_bitmap(tss);",
          "385:   return;",
          "386:  }",
          "388:  if (IS_ENABLED(CONFIG_X86_IOPL_IOPERM) && t->iopl_emul == 3) {",
          "390:  } else {",
          "391:   struct io_bitmap *iobm = t->io_bitmap;",
          "397:   if (tss->io_bitmap.prev_sequence != iobm->sequence)",
          "398:    tss_copy_io_bitmap(tss, iobm);",
          "410:  refresh_tss_limit();",
          "",
          "---------------"
        ]
      }
    }
  ]
}