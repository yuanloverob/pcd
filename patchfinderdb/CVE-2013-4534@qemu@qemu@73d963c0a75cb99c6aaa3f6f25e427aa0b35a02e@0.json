{
  "cve_id": "CVE-2013-4534",
  "cve_desc": "Buffer overflow in hw/intc/openpic.c in QEMU before 1.7.2 allows remote attackers to cause a denial of service or possibly execute arbitrary code via vectors related to IRQDest elements.",
  "repo": "qemu/qemu",
  "patch_hash": "73d963c0a75cb99c6aaa3f6f25e427aa0b35a02e",
  "patch_info": {
    "commit_hash": "73d963c0a75cb99c6aaa3f6f25e427aa0b35a02e",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/73d963c0a75cb99c6aaa3f6f25e427aa0b35a02e",
    "files": [
      "hw/intc/openpic.c"
    ],
    "message": "openpic: avoid buffer overrun on incoming migration\n\nCVE-2013-4534\n\nopp->nb_cpus is read from the wire and used to determine how many\nIRQDest elements to read into opp->dst[]. If the value exceeds the\nlength of opp->dst[], MAX_CPU, opp->dst[] can be overrun with arbitrary\ndata from the wire.\n\nFix this by failing migration if the value read from the wire exceeds\nMAX_CPU.\n\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>\nReviewed-by: Alexander Graf <agraf@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>",
    "before_after_code_files": [
      "hw/intc/openpic.c||hw/intc/openpic.c"
    ]
  },
  "patch_diff": {
    "hw/intc/openpic.c||hw/intc/openpic.c": [
      "File: hw/intc/openpic.c -> hw/intc/openpic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "41: #include \"hw/sysbus.h\"",
      "42: #include \"hw/pci/msi.h\"",
      "43: #include \"qemu/bitops.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "44: #include \"qapi/qmp/qerror.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1416: static int openpic_load(QEMUFile* f, void *opaque, int version_id)",
      "1417: {",
      "1418:     OpenPICState *opp = (OpenPICState *)opaque;",
      "1421:     if (version_id != 1) {",
      "1422:         return -EINVAL;",
      "",
      "[Removed Lines]",
      "1419:     unsigned int i;",
      "",
      "[Added Lines]",
      "1420:     unsigned int i, nb_cpus;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1428:     qemu_get_be32s(f, &opp->spve);",
      "1429:     qemu_get_be32s(f, &opp->tfrr);",
      "1433:     for (i = 0; i < opp->nb_cpus; i++) {",
      "1434:         qemu_get_sbe32s(f, &opp->dst[i].ctpr);",
      "",
      "[Removed Lines]",
      "1431:     qemu_get_be32s(f, &opp->nb_cpus);",
      "",
      "[Added Lines]",
      "1432:     qemu_get_be32s(f, &nb_cpus);",
      "1433:     if (opp->nb_cpus != nb_cpus) {",
      "1434:         return -EINVAL;",
      "1435:     }",
      "1436:     assert(nb_cpus > 0 && nb_cpus <= MAX_CPU);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1567:         {NULL}",
      "1568:     };",
      "1570:     switch (opp->model) {",
      "1571:     case OPENPIC_MODEL_FSL_MPIC_20:",
      "1572:     default:",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1575:     if (opp->nb_cpus > MAX_CPU) {",
      "1576:         error_set(errp, QERR_PROPERTY_VALUE_OUT_OF_RANGE,",
      "1577:                   TYPE_OPENPIC, \"nb_cpus\", (uint64_t)opp->nb_cpus,",
      "1578:                   (uint64_t)0, (uint64_t)MAX_CPU);",
      "1579:         return;",
      "1580:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1124696193a6247f24a69cc2547d7ad80098833c",
      "candidate_info": {
        "commit_hash": "1124696193a6247f24a69cc2547d7ad80098833c",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/1124696193a6247f24a69cc2547d7ad80098833c",
        "files": [
          "hw/intc/openpic.c"
        ],
        "message": "openpic: avoid buffer overrun on incoming migration\n\nCVE-2013-4534\n\nopp->nb_cpus is read from the wire and used to determine how many\nIRQDest elements to read into opp->dst[]. If the value exceeds the\nlength of opp->dst[], MAX_CPU, opp->dst[] can be overrun with arbitrary\ndata from the wire.\n\nFix this by failing migration if the value read from the wire exceeds\nMAX_CPU.\n\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>\nReviewed-by: Alexander Graf <agraf@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 73d963c0a75cb99c6aaa3f6f25e427aa0b35a02e)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/intc/openpic.c||hw/intc/openpic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/intc/openpic.c||hw/intc/openpic.c"
          ],
          "candidate": [
            "hw/intc/openpic.c||hw/intc/openpic.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/intc/openpic.c||hw/intc/openpic.c": [
          "File: hw/intc/openpic.c -> hw/intc/openpic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: #include \"hw/sysbus.h\"",
          "42: #include \"hw/pci/msi.h\"",
          "43: #include \"qemu/bitops.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: #include \"qapi/qmp/qerror.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1416: static int openpic_load(QEMUFile* f, void *opaque, int version_id)",
          "1417: {",
          "1418:     OpenPICState *opp = (OpenPICState *)opaque;",
          "1421:     if (version_id != 1) {",
          "1422:         return -EINVAL;",
          "",
          "[Removed Lines]",
          "1419:     unsigned int i;",
          "",
          "[Added Lines]",
          "1420:     unsigned int i, nb_cpus;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1428:     qemu_get_be32s(f, &opp->spve);",
          "1429:     qemu_get_be32s(f, &opp->tfrr);",
          "1433:     for (i = 0; i < opp->nb_cpus; i++) {",
          "1434:         qemu_get_sbe32s(f, &opp->dst[i].ctpr);",
          "",
          "[Removed Lines]",
          "1431:     qemu_get_be32s(f, &opp->nb_cpus);",
          "",
          "[Added Lines]",
          "1432:     qemu_get_be32s(f, &nb_cpus);",
          "1433:     if (opp->nb_cpus != nb_cpus) {",
          "1434:         return -EINVAL;",
          "1435:     }",
          "1436:     assert(nb_cpus > 0 && nb_cpus <= MAX_CPU);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1567:         {NULL}",
          "1568:     };",
          "1570:     switch (opp->model) {",
          "1571:     case OPENPIC_MODEL_FSL_MPIC_20:",
          "1572:     default:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1575:     if (opp->nb_cpus > MAX_CPU) {",
          "1576:         error_set(errp, QERR_PROPERTY_VALUE_OUT_OF_RANGE,",
          "1577:                   TYPE_OPENPIC, \"nb_cpus\", (uint64_t)opp->nb_cpus,",
          "1578:                   (uint64_t)0, (uint64_t)MAX_CPU);",
          "1579:         return;",
          "1580:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "609f5bf6fecb78ada914b88598ae8ba43e304e36",
      "candidate_info": {
        "commit_hash": "609f5bf6fecb78ada914b88598ae8ba43e304e36",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/609f5bf6fecb78ada914b88598ae8ba43e304e36",
        "files": [
          "hw/intc/openpic.c"
        ],
        "message": "openpic: avoid buffer overrun on incoming migration\n\nCVE-2013-4534\n\nopp->nb_cpus is read from the wire and used to determine how many\nIRQDest elements to read into opp->dst[]. If the value exceeds the\nlength of opp->dst[], MAX_CPU, opp->dst[] can be overrun with arbitrary\ndata from the wire.\n\nFix this by failing migration if the value read from the wire exceeds\nMAX_CPU.\n\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>\nReviewed-by: Alexander Graf <agraf@suse.de>\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nSigned-off-by: Juan Quintela <quintela@redhat.com>\n(cherry picked from commit 73d963c0a75cb99c6aaa3f6f25e427aa0b35a02e)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/intc/openpic.c||hw/intc/openpic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/intc/openpic.c||hw/intc/openpic.c"
          ],
          "candidate": [
            "hw/intc/openpic.c||hw/intc/openpic.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/intc/openpic.c||hw/intc/openpic.c": [
          "File: hw/intc/openpic.c -> hw/intc/openpic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "41: #include \"hw/sysbus.h\"",
          "42: #include \"hw/pci/msi.h\"",
          "43: #include \"qemu/bitops.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "44: #include \"qapi/qmp/qerror.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1416: static int openpic_load(QEMUFile* f, void *opaque, int version_id)",
          "1417: {",
          "1418:     OpenPICState *opp = (OpenPICState *)opaque;",
          "1421:     if (version_id != 1) {",
          "1422:         return -EINVAL;",
          "",
          "[Removed Lines]",
          "1419:     unsigned int i;",
          "",
          "[Added Lines]",
          "1420:     unsigned int i, nb_cpus;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1428:     qemu_get_be32s(f, &opp->spve);",
          "1429:     qemu_get_be32s(f, &opp->tfrr);",
          "1433:     for (i = 0; i < opp->nb_cpus; i++) {",
          "1434:         qemu_get_sbe32s(f, &opp->dst[i].ctpr);",
          "",
          "[Removed Lines]",
          "1431:     qemu_get_be32s(f, &opp->nb_cpus);",
          "",
          "[Added Lines]",
          "1432:     qemu_get_be32s(f, &nb_cpus);",
          "1433:     if (opp->nb_cpus != nb_cpus) {",
          "1434:         return -EINVAL;",
          "1435:     }",
          "1436:     assert(nb_cpus > 0 && nb_cpus <= MAX_CPU);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1567:         {NULL}",
          "1568:     };",
          "1570:     switch (opp->model) {",
          "1571:     case OPENPIC_MODEL_FSL_MPIC_20:",
          "1572:     default:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1575:     if (opp->nb_cpus > MAX_CPU) {",
          "1576:         error_set(errp, QERR_PROPERTY_VALUE_OUT_OF_RANGE,",
          "1577:                   TYPE_OPENPIC, \"nb_cpus\", (uint64_t)opp->nb_cpus,",
          "1578:                   (uint64_t)0, (uint64_t)MAX_CPU);",
          "1579:         return;",
          "1580:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}