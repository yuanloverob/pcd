{
  "cve_id": "CVE-2016-2330",
  "cve_desc": "libavcodec/gif.c in FFmpeg before 2.8.6 does not properly calculate a buffer size, which allows remote attackers to cause a denial of service (out-of-bounds array access) or possibly have unspecified other impact via a crafted .tga file, related to the gif_image_write_image, gif_encode_init, and gif_encode_close functions.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "03d83ba34b2070878909eae18dfac0f519503777",
  "patch_info": {
    "commit_hash": "03d83ba34b2070878909eae18dfac0f519503777",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/03d83ba34b2070878909eae18dfac0f519503777",
    "files": [
      "libavcodec/gif.c"
    ],
    "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavcodec/gif.c||libavcodec/gif.c"
    ]
  },
  "patch_diff": {
    "libavcodec/gif.c||libavcodec/gif.c": [
      "File: libavcodec/gif.c -> libavcodec/gif.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "43:     const AVClass *class;",
      "44:     LZWState *lzw;",
      "45:     uint8_t *buf;",
      "46:     AVFrame *last_frame;",
      "47:     int flags;",
      "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "46:     int buf_size;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "175:     bytestream_put_byte(bytestream, 0x08);",
      "178:                        12, FF_LZW_GIF, put_bits);",
      "180:     ptr = buf + y_start*linesize + x_start;",
      "",
      "[Removed Lines]",
      "177:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
      "",
      "[Added Lines]",
      "178:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "231:     s->transparent_index = -1;",
      "233:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
      "235:     s->tmpl = av_malloc(avctx->width);",
      "236:     if (!s->tmpl || !s->buf || !s->lzw)",
      "237:         return AVERROR(ENOMEM);",
      "",
      "[Removed Lines]",
      "234:     s->buf = av_malloc(avctx->width*avctx->height*2);",
      "",
      "[Added Lines]",
      "235:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
      "236:     s->buf = av_malloc(s->buf_size);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "322:     av_freep(&s->lzw);",
      "323:     av_freep(&s->buf);",
      "324:     av_frame_free(&s->last_frame);",
      "325:     av_freep(&s->tmpl);",
      "326:     return 0;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "326:     s->buf_size = 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9f30eafd0f31c2b5c4f7c86fecabbdde1282e079",
      "candidate_info": {
        "commit_hash": "9f30eafd0f31c2b5c4f7c86fecabbdde1282e079",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/9f30eafd0f31c2b5c4f7c86fecabbdde1282e079",
        "files": [
          "libavcodec/gif.c"
        ],
        "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 03d83ba34b2070878909eae18dfac0f519503777)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/gif.c||libavcodec/gif.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ],
          "candidate": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/gif.c||libavcodec/gif.c": [
          "File: libavcodec/gif.c -> libavcodec/gif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     const AVClass *class;",
          "44:     LZWState *lzw;",
          "45:     uint8_t *buf;",
          "46:     AVFrame *last_frame;",
          "47:     int flags;",
          "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     int buf_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "169:     bytestream_put_byte(bytestream, 0x08);",
          "172:                        12, FF_LZW_GIF, put_bits);",
          "174:     ptr = buf + y_start*linesize + x_start;",
          "",
          "[Removed Lines]",
          "171:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
          "",
          "[Added Lines]",
          "172:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "224:     avctx->coded_frame->key_frame = 1;",
          "226:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
          "228:     s->tmpl = av_malloc(avctx->width);",
          "229:     if (!s->tmpl || !s->buf || !s->lzw)",
          "230:         return AVERROR(ENOMEM);",
          "",
          "[Removed Lines]",
          "227:     s->buf = av_malloc(avctx->width*avctx->height*2);",
          "",
          "[Added Lines]",
          "228:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
          "229:     s->buf = av_malloc(s->buf_size);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "284:     av_freep(&s->lzw);",
          "285:     av_freep(&s->buf);",
          "286:     av_frame_free(&s->last_frame);",
          "287:     av_freep(&s->tmpl);",
          "288:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "288:     s->buf_size = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "828d85bf8693b1fb6797c53eb888278d59d99fa4",
      "candidate_info": {
        "commit_hash": "828d85bf8693b1fb6797c53eb888278d59d99fa4",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/828d85bf8693b1fb6797c53eb888278d59d99fa4",
        "files": [
          "libavcodec/gif.c"
        ],
        "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 03d83ba34b2070878909eae18dfac0f519503777)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/gif.c||libavcodec/gif.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ],
          "candidate": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/gif.c||libavcodec/gif.c": [
          "File: libavcodec/gif.c -> libavcodec/gif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     const AVClass *class;",
          "44:     LZWState *lzw;",
          "45:     uint8_t *buf;",
          "46:     AVFrame *last_frame;",
          "47:     int flags;",
          "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     int buf_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "175:     bytestream_put_byte(bytestream, 0x08);",
          "178:                        12, FF_LZW_GIF, put_bits);",
          "180:     ptr = buf + y_start*linesize + x_start;",
          "",
          "[Removed Lines]",
          "177:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
          "",
          "[Added Lines]",
          "178:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "231:     s->transparent_index = -1;",
          "233:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
          "235:     s->tmpl = av_malloc(avctx->width);",
          "236:     if (!s->tmpl || !s->buf || !s->lzw)",
          "237:         return AVERROR(ENOMEM);",
          "",
          "[Removed Lines]",
          "234:     s->buf = av_malloc(avctx->width*avctx->height*2);",
          "",
          "[Added Lines]",
          "235:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
          "236:     s->buf = av_malloc(s->buf_size);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "322:     av_freep(&s->lzw);",
          "323:     av_freep(&s->buf);",
          "324:     av_frame_free(&s->last_frame);",
          "325:     av_freep(&s->tmpl);",
          "326:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "326:     s->buf_size = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "40e846bb3f8e6fcc0133f1da24ef30de0a6c5f16",
      "candidate_info": {
        "commit_hash": "40e846bb3f8e6fcc0133f1da24ef30de0a6c5f16",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/40e846bb3f8e6fcc0133f1da24ef30de0a6c5f16",
        "files": [
          "libavcodec/gif.c"
        ],
        "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 03d83ba34b2070878909eae18dfac0f519503777)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/gif.c||libavcodec/gif.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ],
          "candidate": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/gif.c||libavcodec/gif.c": [
          "File: libavcodec/gif.c -> libavcodec/gif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     const AVClass *class;",
          "44:     LZWState *lzw;",
          "45:     uint8_t *buf;",
          "46:     AVFrame *last_frame;",
          "47:     int flags;",
          "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     int buf_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "175:     bytestream_put_byte(bytestream, 0x08);",
          "178:                        12, FF_LZW_GIF, put_bits);",
          "180:     ptr = buf + y_start*linesize + x_start;",
          "",
          "[Removed Lines]",
          "177:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
          "",
          "[Added Lines]",
          "178:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "232:     s->transparent_index = -1;",
          "234:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
          "236:     s->tmpl = av_malloc(avctx->width);",
          "237:     if (!s->tmpl || !s->buf || !s->lzw)",
          "238:         return AVERROR(ENOMEM);",
          "",
          "[Removed Lines]",
          "235:     s->buf = av_malloc(avctx->width*avctx->height*2);",
          "",
          "[Added Lines]",
          "236:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
          "237:     s->buf = av_malloc(s->buf_size);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "325:     av_freep(&s->lzw);",
          "326:     av_freep(&s->buf);",
          "327:     av_frame_free(&s->last_frame);",
          "328:     av_freep(&s->tmpl);",
          "329:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "329:     s->buf_size = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "49ae02d36f25963e8ef9ea1fba82a7e1c9914563",
      "candidate_info": {
        "commit_hash": "49ae02d36f25963e8ef9ea1fba82a7e1c9914563",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/49ae02d36f25963e8ef9ea1fba82a7e1c9914563",
        "files": [
          "libavcodec/gif.c"
        ],
        "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 03d83ba34b2070878909eae18dfac0f519503777)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/gif.c||libavcodec/gif.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ],
          "candidate": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/gif.c||libavcodec/gif.c": [
          "File: libavcodec/gif.c -> libavcodec/gif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     const AVClass *class;",
          "44:     LZWState *lzw;",
          "45:     uint8_t *buf;",
          "46:     AVFrame *last_frame;",
          "47:     int flags;",
          "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     int buf_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "169:     bytestream_put_byte(bytestream, 0x08);",
          "172:                        12, FF_LZW_GIF, put_bits);",
          "174:     ptr = buf + y_start*linesize + x_start;",
          "",
          "[Removed Lines]",
          "171:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
          "",
          "[Added Lines]",
          "172:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "224:     avctx->coded_frame->key_frame = 1;",
          "226:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
          "228:     s->tmpl = av_malloc(avctx->width);",
          "229:     if (!s->tmpl || !s->buf || !s->lzw)",
          "230:         return AVERROR(ENOMEM);",
          "",
          "[Removed Lines]",
          "227:     s->buf = av_malloc(avctx->width*avctx->height*2);",
          "",
          "[Added Lines]",
          "228:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
          "229:     s->buf = av_malloc(s->buf_size);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "284:     av_freep(&s->lzw);",
          "285:     av_freep(&s->buf);",
          "286:     av_frame_free(&s->last_frame);",
          "287:     av_freep(&s->tmpl);",
          "288:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "288:     s->buf_size = 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2b7f125af78b421155640b2276d40f79b9344705",
      "candidate_info": {
        "commit_hash": "2b7f125af78b421155640b2276d40f79b9344705",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/2b7f125af78b421155640b2276d40f79b9344705",
        "files": [
          "libavcodec/gif.c"
        ],
        "message": "avcodec/gif: Fix lzw buffer size\n\nFixes out of array access\nFixes: aaa479088e6fb40b04837b3119f47b04/asan_heap-oob_e38c68_8576_9d653078b2470700e2834636f12ff557.tga\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 03d83ba34b2070878909eae18dfac0f519503777)\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/gif.c||libavcodec/gif.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ],
          "candidate": [
            "libavcodec/gif.c||libavcodec/gif.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/gif.c||libavcodec/gif.c": [
          "File: libavcodec/gif.c -> libavcodec/gif.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     const AVClass *class;",
          "44:     LZWState *lzw;",
          "45:     uint8_t *buf;",
          "46:     AVFrame *last_frame;",
          "47:     int flags;",
          "48:     uint32_t palette[AVPALETTE_COUNT];  ///< local reference palette for !pal8",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46:     int buf_size;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "175:     bytestream_put_byte(bytestream, 0x08);",
          "178:                        12, FF_LZW_GIF, put_bits);",
          "180:     ptr = buf + y_start*linesize + x_start;",
          "",
          "[Removed Lines]",
          "177:     ff_lzw_encode_init(s->lzw, s->buf, 2 * width * height,",
          "",
          "[Added Lines]",
          "178:     ff_lzw_encode_init(s->lzw, s->buf, s->buf_size,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "232:     s->transparent_index = -1;",
          "234:     s->lzw = av_mallocz(ff_lzw_encode_state_size);",
          "236:     s->tmpl = av_malloc(avctx->width);",
          "237:     if (!s->tmpl || !s->buf || !s->lzw)",
          "238:         return AVERROR(ENOMEM);",
          "",
          "[Removed Lines]",
          "235:     s->buf = av_malloc(avctx->width*avctx->height*2);",
          "",
          "[Added Lines]",
          "236:     s->buf_size = avctx->width*avctx->height*2 + 1000;",
          "237:     s->buf = av_malloc(s->buf_size);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "325:     av_freep(&s->lzw);",
          "326:     av_freep(&s->buf);",
          "327:     av_frame_free(&s->last_frame);",
          "328:     av_freep(&s->tmpl);",
          "329:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "329:     s->buf_size = 0;",
          "",
          "---------------"
        ]
      }
    }
  ]
}