{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c745e64573d21b4b23eeea69cee06d3f8249e1bf",
      "candidate_info": {
        "commit_hash": "c745e64573d21b4b23eeea69cee06d3f8249e1bf",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/c745e64573d21b4b23eeea69cee06d3f8249e1bf",
        "files": [
          "capstone.pc.in"
        ],
        "message": "fixed hardcoded paths with variables. (#1018)\n\n* fixed hardcoded paths with variables.\n\ncmake pkg-config file fixed hardcoded paths with variables. CMakeLists.txt line 394 needs to be modified\n> configure_file(\"capstone.pc.in\" \"capstone.pc\" @ONLY)\n\n* forgot to add 64bit support variable.",
        "before_after_code_files": [
          "capstone.pc.in||capstone.pc.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "capstone.pc.in||capstone.pc.in": [
          "File: capstone.pc.in -> capstone.pc.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: Name: capstone",
          "2: Description: Capstone disassembly engine",
          "3: Version: @VERSION_MAJOR@.@VERSION_MINOR@.@VERSION_PATCH@",
          "4: URL: http://www.capstone-engine.org",
          "",
          "[Removed Lines]",
          "5: archive=@CMAKE_INSTALL_PREFIX@/lib/libcapstone.a",
          "6: Libs: -L@CMAKE_INSTALL_PREFIX@/lib -lcapstone",
          "7: Cflags: -I@CMAKE_INSTALL_PREFIX@/include/capstone",
          "",
          "[Added Lines]",
          "1: prefix=@CMAKE_INSTALL_PREFIX@",
          "2: exec_prefix=${prefix}",
          "3: libdir=${prefix}/lib@LIBSUFFIX@",
          "4: includedir=${prefix}/include",
          "10: archive=${libdir}/libcapstone.a",
          "11: Libs: -L${libdir} -lcapstone",
          "12: Cflags: -I${includedir}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "665d404b0df6491b29ed095dd8cf5f2e07665ac8",
      "candidate_info": {
        "commit_hash": "665d404b0df6491b29ed095dd8cf5f2e07665ac8",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/665d404b0df6491b29ed095dd8cf5f2e07665ac8",
        "files": [
          "bindings/python/setup.py",
          "bindings/python/setup_cython.py"
        ],
        "message": "python: bump version to 3.0.5",
        "before_after_code_files": [
          "bindings/python/setup.py||bindings/python/setup.py",
          "bindings/python/setup_cython.py||bindings/python/setup_cython.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: from setuptools.command.bdist_egg import bdist_egg",
          "16: SYSTEM = sys.platform",
          "19: # adapted from commit e504b81 of Nguyen Tan Cong",
          "20: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "",
          "[Removed Lines]",
          "17: VERSION = '3.0.4'",
          "",
          "[Added Lines]",
          "17: VERSION = '3.0.5'",
          "",
          "---------------"
        ],
        "bindings/python/setup_cython.py||bindings/python/setup_cython.py": [
          "File: bindings/python/setup_cython.py -> bindings/python/setup_cython.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: SYSTEM = sys.platform",
          "14: # adapted from commit e504b81 of Nguyen Tan Cong",
          "15: # Reference: https://docs.python.org/2/library/platform.html#cross-platform",
          "",
          "[Removed Lines]",
          "12: VERSION = '3.0.4'",
          "",
          "[Added Lines]",
          "12: VERSION = '3.0.5'",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e29ddbdbb332b3b08740eadee4424a3fc612311b",
      "candidate_info": {
        "commit_hash": "e29ddbdbb332b3b08740eadee4424a3fc612311b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/e29ddbdbb332b3b08740eadee4424a3fc612311b",
        "files": [
          "bindings/python/capstone/__init__.py"
        ],
        "message": "Python: Actually attempt to load .so.3 extension on linux",
        "before_after_code_files": [
          "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/capstone/__init__.py||bindings/python/capstone/__init__.py": [
          "File: bindings/python/capstone/__init__.py -> bindings/python/capstone/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "211: else:",
          "212:     _lib = \"libcapstone.so\"",
          "215: _found = False",
          "217: def _load_lib(path):",
          "",
          "[Removed Lines]",
          "214: _all_libs = ['capstone.dll', 'libcapstone.so.3', 'libcapstone.so', 'libcapstone.dylib']",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "222:         # if we're on linux, try again with .so.3 extension",
          "223:         if lib_file.endswith('.so'):",
          "224:             try:",
          "226:             except OSError:",
          "227:                 return None",
          "228:         return None",
          "",
          "[Removed Lines]",
          "225:                 return ctypes.cdll.LoadLibrary(lib_file)",
          "",
          "[Added Lines]",
          "224:                 return ctypes.cdll.LoadLibrary(lib_file + '.3')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f98fde5fa9197b757e3dd3920b6c6363f52386ca",
      "candidate_info": {
        "commit_hash": "f98fde5fa9197b757e3dd3920b6c6363f52386ca",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f98fde5fa9197b757e3dd3920b6c6363f52386ca",
        "files": [
          "include/capstone/arm64.h"
        ],
        "message": "Fix wrong register aliases on arm64 (#1064)",
        "before_after_code_files": [
          "include/capstone/arm64.h||include/capstone/arm64.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/capstone/arm64.h||include/capstone/arm64.h": [
          "File: include/capstone/arm64.h -> include/capstone/arm64.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "617:  ARM64_REG_FP = ARM64_REG_X29,",
          "618:  ARM64_REG_LR = ARM64_REG_X30,",
          "619: } arm64_reg;",
          "",
          "[Removed Lines]",
          "615:  ARM64_REG_IP1 = ARM64_REG_X16,",
          "616:  ARM64_REG_IP0 = ARM64_REG_X17,",
          "",
          "[Added Lines]",
          "615:  ARM64_REG_IP0 = ARM64_REG_X16,",
          "616:  ARM64_REG_IP1 = ARM64_REG_X17,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5664998f4ca2831e14bed47c7bffb46113cfadda",
      "candidate_info": {
        "commit_hash": "5664998f4ca2831e14bed47c7bffb46113cfadda",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/5664998f4ca2831e14bed47c7bffb46113cfadda",
        "files": [
          "cstool/cstool.c"
        ],
        "message": "cstool: compile for next branch",
        "before_after_code_files": [
          "cstool/cstool.c||cstool/cstool.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "cstool/cstool.c||cstool/cstool.c": [
          "File: cstool/cstool.c -> cstool/cstool.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: #include <ctype.h>",
          "6: #include <errno.h>",
          "10: #define VERSION \"1.0\"",
          "",
          "[Removed Lines]",
          "8: #include <capstone.h>",
          "",
          "[Added Lines]",
          "8: #include <capstone/capstone.h>",
          "",
          "---------------"
        ]
      }
    }
  ]
}