{
  "cve_id": "CVE-2019-11930",
  "cve_desc": "An invalid free in mb_detect_order can cause the application to crash or potentially result in remote code execution. This issue affects HHVM versions prior to 3.30.12, all versions between 4.0.0 and 4.8.5, all versions between 4.9.0 and 4.23.1, as well as 4.24.0, 4.25.0, 4.26.0, 4.27.0, 4.28.0, and 4.28.1.",
  "repo": "facebook/hhvm",
  "patch_hash": "524d2e60cfe910406ec6109e4286d7edd545ab36",
  "patch_info": {
    "commit_hash": "524d2e60cfe910406ec6109e4286d7edd545ab36",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/524d2e60cfe910406ec6109e4286d7edd545ab36",
    "files": [
      "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
      "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
    ],
    "message": "ext_mbstring: Fix invalid free() in php_mb_parse_encoding\n\nSummary:\nA chunk of memory allocated by 'req::calloc_noptrs' was being freed by 'free'. The former internally calls 'calloc' and returns a pointer at an index sizeof(MallocNode) inside the allocated buffer. This led to freeing invalid memory.\n\nCVE-2019-11930\n\nReviewed By: jjergus\n\nDifferential Revision: D18179908\n\nfbshipit-source-id: 0e3fe77628e0b9dee8361e712b8abac59ae5ed22",
    "before_after_code_files": [
      "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
      "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
    ]
  },
  "patch_diff": {
    "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
      "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "908:   }",
      "909:   if (!ret) {",
      "910:     if (return_list && *return_list) {",
      "913:     }",
      "914:     return_size = 0;",
      "",
      "[Removed Lines]",
      "911:       free(*return_list);",
      "",
      "[Added Lines]",
      "911:       req::free(*return_list);",
      "",
      "---------------"
    ],
    "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php": [
      "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: <?hh",
      "4: <<__EntryPoint>>",
      "5: function main() {",
      "6:   var_dump(mb_detect_order(\"UTF-8,\\x2c\"));",
      "7: }",
      "",
      "---------------"
    ],
    "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect": [
      "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: bool(false)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f97d395de6dfbf70b96fc008fefdad02af3bf815",
      "candidate_info": {
        "commit_hash": "f97d395de6dfbf70b96fc008fefdad02af3bf815",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/f97d395de6dfbf70b96fc008fefdad02af3bf815",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ],
        "message": "ext_mbstring: Fix invalid free() in php_mb_parse_encoding\n\nSummary:\nA chunk of memory allocated by 'req::calloc_noptrs' was being freed by 'free'. The former internally calls 'calloc' and returns a pointer at an index sizeof(MallocNode) inside the allocated buffer. This led to freeing invalid memory.\n\nCVE-2019-11930\n\nReviewed By: binliu19\n\nDifferential Revision: D17605318",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "908:   }",
          "909:   if (!ret) {",
          "910:     if (return_list && *return_list) {",
          "913:     }",
          "914:     return_size = 0;",
          "",
          "[Removed Lines]",
          "911:       free(*return_list);",
          "",
          "[Added Lines]",
          "911:       req::free(*return_list);",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "4: <<__EntryPoint>>",
          "5: function main() {",
          "6:   var_dump(mb_detect_order(\"UTF-8,\\x2c\"));",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: bool(false)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a876b08aefb941e0e5fcf4cc3147278871b385e6",
      "candidate_info": {
        "commit_hash": "a876b08aefb941e0e5fcf4cc3147278871b385e6",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/a876b08aefb941e0e5fcf4cc3147278871b385e6",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ],
        "message": "ext_mbstring: Fix invalid free() in php_mb_parse_encoding\n\nSummary:\nA chunk of memory allocated by 'req::calloc_noptrs' was being freed by 'free'. The former internally calls 'calloc' and returns a pointer at an index sizeof(MallocNode) inside the allocated buffer. This led to freeing invalid memory.\n\nCVE-2019-11930\n\nReviewed By: binliu19\n\nDifferential Revision: D17605318",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "908:   }",
          "909:   if (!ret) {",
          "910:     if (return_list && *return_list) {",
          "913:     }",
          "914:     return_size = 0;",
          "",
          "[Removed Lines]",
          "911:       free(*return_list);",
          "",
          "[Added Lines]",
          "911:       req::free(*return_list);",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "4: <<__EntryPoint>>",
          "5: function main() {",
          "6:   var_dump(mb_detect_order(\"UTF-8,\\x2c\"));",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: bool(false)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2b6cfce06a8271776a563c4eb6ab86c281e3645c",
      "candidate_info": {
        "commit_hash": "2b6cfce06a8271776a563c4eb6ab86c281e3645c",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/2b6cfce06a8271776a563c4eb6ab86c281e3645c",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ],
        "message": "ext_mbstring: Fix invalid free() in php_mb_parse_encoding\n\nSummary:\nA chunk of memory allocated by 'req::calloc_noptrs' was being freed by 'free'. The former internally calls 'calloc' and returns a pointer at an index sizeof(MallocNode) inside the allocated buffer. This led to freeing invalid memory.\n\nCVE-2019-11930\n\nReviewed By: binliu19\n\nDifferential Revision: D17605318",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "907:   }",
          "908:   if (!ret) {",
          "909:     if (return_list && *return_list) {",
          "912:     }",
          "913:     return_size = 0;",
          "",
          "[Removed Lines]",
          "910:       free(*return_list);",
          "",
          "[Added Lines]",
          "910:       req::free(*return_list);",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "4: <<__EntryPoint>>",
          "5: function main() {",
          "6:   var_dump(mb_detect_order(\"UTF-8,\\x2c\"));",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: bool(false)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1b77aaf5f9fd61caf63898392cf175eca7b16af1",
      "candidate_info": {
        "commit_hash": "1b77aaf5f9fd61caf63898392cf175eca7b16af1",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/1b77aaf5f9fd61caf63898392cf175eca7b16af1",
        "files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ],
        "message": "ext_mbstring: Fix invalid free() in php_mb_parse_encoding\n\nSummary:\nA chunk of memory allocated by 'req::calloc_noptrs' was being freed by 'free'. The former internally calls 'calloc' and returns a pointer at an index sizeof(MallocNode) inside the allocated buffer. This led to freeing invalid memory.\n\nCVE-2019-11930\n\nReviewed By: binliu19\n\nDifferential Revision: D17605318",
        "before_after_code_files": [
          "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ],
          "candidate": [
            "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
            "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/ext/mbstring/ext_mbstring.cpp||hphp/runtime/ext/mbstring/ext_mbstring.cpp": [
          "File: hphp/runtime/ext/mbstring/ext_mbstring.cpp -> hphp/runtime/ext/mbstring/ext_mbstring.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "908:   }",
          "909:   if (!ret) {",
          "910:     if (return_list && *return_list) {",
          "913:     }",
          "914:     return_size = 0;",
          "",
          "[Removed Lines]",
          "911:       free(*return_list);",
          "",
          "[Added Lines]",
          "911:       req::free(*return_list);",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: <?hh",
          "4: <<__EntryPoint>>",
          "5: function main() {",
          "6:   var_dump(mb_detect_order(\"UTF-8,\\x2c\"));",
          "7: }",
          "",
          "---------------"
        ],
        "hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect||hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect": [
          "File: hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect -> hphp/test/slow/ext_mb/mb_detect_order_t54638796.php.expect",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: bool(false)",
          "",
          "---------------"
        ]
      }
    }
  ]
}