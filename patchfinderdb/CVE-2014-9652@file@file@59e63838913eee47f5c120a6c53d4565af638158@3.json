{
  "cve_id": "CVE-2014-9652",
  "cve_desc": "The mconvert function in softmagic.c in file before 5.21, as used in the Fileinfo component in PHP before 5.4.37, 5.5.x before 5.5.21, and 5.6.x before 5.6.5, does not properly handle a certain string-length field during a copy of a truncated version of a Pascal string, which might allow remote attackers to cause a denial of service (out-of-bounds memory access and application crash) via a crafted file.",
  "repo": "file/file",
  "patch_hash": "59e63838913eee47f5c120a6c53d4565af638158",
  "patch_info": {
    "commit_hash": "59e63838913eee47f5c120a6c53d4565af638158",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/59e63838913eee47f5c120a6c53d4565af638158",
    "files": [
      "src/softmagic.c"
    ],
    "message": "PR/398: Correctly truncate pascal strings (fixes out of bounds read of 1, 2, or 4 bytes).",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.195 2014/09/24 19:49:07 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.196 2014/11/07 15:24:14 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "964:   size_t sz = file_pstring_length_size(m);",
      "965:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
      "966:   size_t len = file_pstring_get_length(m, ptr1);",
      "975:   }",
      "976:   while (len--)",
      "",
      "[Removed Lines]",
      "967:   if (len >= sizeof(p->s)) {",
      "974:    len = sizeof(p->s) - sz;",
      "",
      "[Added Lines]",
      "968:   if (len >= sz) {",
      "977:    len = sz;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
      "candidate_info": {
        "commit_hash": "9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/9190a18d09f25fb0ca6abe1fcbdba780f5077e45",
        "files": [
          "ChangeLog",
          "TODO",
          "doc/file.man",
          "doc/libmagic.man",
          "magic/Magdir/jpeg",
          "magic/Magdir/mathematica",
          "src/apprentice.c",
          "src/ascmagic.c",
          "src/file.c",
          "src/file.h",
          "src/file_opts.h",
          "src/fsmagic.c",
          "src/is_tar.c",
          "src/readcdf.c",
          "src/readelf.c",
          "src/softmagic.c"
        ],
        "message": "Add --extension",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/ascmagic.c||src/ascmagic.c",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/file_opts.h||src/file_opts.h",
          "src/fsmagic.c||src/fsmagic.c",
          "src/is_tar.c||src/is_tar.c",
          "src/readcdf.c||src/readcdf.c",
          "src/readelf.c||src/readelf.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.230 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.231 2015/02/06 17:08:58 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "149: private int parse_mime(struct magic_set *, struct magic_entry *, const char *);",
          "150: private int parse_strength(struct magic_set *, struct magic_entry *, const char *);",
          "151: private int parse_apple(struct magic_set *, struct magic_entry *, const char *);",
          "154: private size_t magicsize = sizeof(struct magic);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152: private int parse_ext(struct magic_set *, struct magic_entry *, const char *);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "163: #define DECLARE_FIELD(name) { # name, sizeof(# name) - 1, parse_ ## name }",
          "164:  DECLARE_FIELD(mime),",
          "165:  DECLARE_FIELD(apple),",
          "166:  DECLARE_FIELD(strength),",
          "167: #undef DECLARE_FIELD",
          "168:  { NULL, 0, NULL }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:  DECLARE_FIELD(ext),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2254:      sizeof(m->apple), \"APPLE\", \"!+-./\", 0);",
          "2255: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2262: private int",
          "2263: parse_ext(struct magic_set *ms, struct magic_entry *me, const char *line)",
          "2264: {",
          "2265:  struct magic *m = &me->mp[0];",
          "2267:  return parse_extra(ms, me, line,",
          "2268:      CAST(off_t, offsetof(struct magic, ext)),",
          "2269:      sizeof(m->ext), \"EXTENSION\", \",!+-/\", 0);",
          "2270: }",
          "",
          "---------------"
        ],
        "src/ascmagic.c||src/ascmagic.c": [
          "File: src/ascmagic.c -> src/ascmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.90 2014/11/28 02:35:05 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: ascmagic.c,v 1.91 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "79:  const char *code_mime = NULL;",
          "80:  const char *type = NULL;",
          "83:   return 0;",
          "85:  nbytes = trim_nuls(buf, nbytes);",
          "",
          "[Removed Lines]",
          "82:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "82:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123:  size_t last_line_end = (size_t)-1;",
          "124:  int has_long_lines = 0;",
          "127:   return 0;",
          "129:  nbytes = trim_nuls(buf, nbytes);",
          "",
          "[Removed Lines]",
          "126:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "126:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.161 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.162 2015/02/09 20:15:50 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "76: # define USAGE  \\",
          "77:     \"Usage: %s [\" FILE_FLAGS \\",
          "79:     \"            [-e testname] [-F separator] [-f namefile] [-m magicfiles] \" \\",
          "80:     \"file ...\\n\" \\",
          "81:     \"       %s -C [-m magicfiles]\\n\" \\",
          "",
          "[Removed Lines]",
          "78:  \"] [--apple] [--mime-encoding] [--mime-type]\\n\" \\",
          "",
          "[Added Lines]",
          "78:  \"] [--apple] [--extension] [--mime-encoding] [--mime-type]\\n\" \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "191:     flags |= MAGIC_APPLE;",
          "192:     break;",
          "193:    case 11:",
          "195:     break;",
          "196:    case 12:",
          "197:     flags |= MAGIC_MIME_ENCODING;",
          "198:     break;",
          "199:    }",
          "",
          "[Removed Lines]",
          "194:     flags |= MAGIC_MIME_TYPE;",
          "",
          "[Added Lines]",
          "194:     flags |= MAGIC_EXTENSION;",
          "197:     flags |= MAGIC_MIME_TYPE;",
          "198:     break;",
          "199:    case 13:",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: #define MAGICNO  0xF11E041C",
          "141: #define FILE_LOAD 0",
          "142: #define FILE_CHECK 1",
          "",
          "[Removed Lines]",
          "138: #define VERSIONNO 12",
          "139: #define FILE_MAGICSIZE 248",
          "",
          "[Added Lines]",
          "138: #define VERSIONNO 13",
          "139: #define FILE_MAGICSIZE 312",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "311: };",
          "313: #define BIT(A)   (1 << (A))",
          "",
          "[Removed Lines]",
          "310:  char apple[8];",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/file_opts.h||src/file_opts.h": [
          "File: src/file_opts.h -> src/file_opts.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "29: OPT('i', \"mime\", 0, \"                 output MIME type strings (--mime-type and\\n\"",
          "30:     \"                               --mime-encoding)\\n\")",
          "31: OPT_LONGONLY(\"apple\", 0, \"                output the Apple CREATOR/TYPE\\n\")",
          "32: OPT_LONGONLY(\"mime-type\", 0, \"            output the MIME type\\n\")",
          "33: OPT_LONGONLY(\"mime-encoding\", 0, \"        output the MIME encoding\\n\")",
          "34: OPT('k', \"keep-going\", 0, \"           don't stop at the first match\\n\")",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "32: OPT_LONGONLY(\"extension\", 0, \"            output a comma-separated list of extnsions\\n\")",
          "",
          "---------------"
        ],
        "src/fsmagic.c||src/fsmagic.c": [
          "File: src/fsmagic.c -> src/fsmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.74 2014/10/13 20:21:49 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.75 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "110:  struct stat tstatbuf;",
          "111: #endif",
          "114:   return 0;",
          "115:  if (fn == NULL)",
          "116:   return 0;",
          "",
          "[Removed Lines]",
          "113:  if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "113:  if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/is_tar.c||src/is_tar.c": [
          "File: src/is_tar.c -> src/is_tar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "40: #include \"file.h\"",
          "42: #ifndef lint",
          "44: #endif",
          "46: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "43: FILE_RCSID(\"@(#)$File: is_tar.c,v 1.36 2009/02/03 20:27:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "43: FILE_RCSID(\"@(#)$File: is_tar.c,v 1.37 2010/11/30 14:58:53 rrt Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "69:  int tar;",
          "70:  int mime = ms->flags & MAGIC_MIME;",
          "73:   return 0;",
          "75:  tar = is_tar(buf, nbytes);",
          "",
          "[Removed Lines]",
          "72:  if ((ms->flags & MAGIC_APPLE) != 0)",
          "",
          "[Added Lines]",
          "72:  if ((ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION)) != 0)",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.51 2015/01/11 16:58:25 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.52 2015/02/27 21:16:38 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "454:         info.i_fd = fd;",
          "455:         info.i_buf = buf;",
          "456:         info.i_len = nbytes;",
          "458:                 return 0;",
          "459:         if (cdf_read_header(&info, &h) == -1)",
          "460:                 return 0;",
          "",
          "[Removed Lines]",
          "457:         if (ms->flags & MAGIC_APPLE)",
          "",
          "[Added Lines]",
          "457:         if (ms->flags & (MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.117 2014/12/16 23:29:42 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.118 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1353:  Elf64_Ehdr elf64hdr;",
          "1354:  uint16_t type, phnum, shnum, notecount;",
          "1357:   return 0;",
          "",
          "[Removed Lines]",
          "1356:  if (ms->flags & (MAGIC_MIME|MAGIC_APPLE))",
          "",
          "[Added Lines]",
          "1356:  if (ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION))",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.212 2015/01/24 22:11:25 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.213 2015/02/14 18:43:12 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:  unsigned int cont_level = 0;",
          "152:  if (returnval == NULL)",
          "153:   returnval = &returnvalv;",
          "",
          "[Removed Lines]",
          "150:  int print = (ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0;",
          "",
          "[Added Lines]",
          "150:  int print = (ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION)) == 0;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1674:    return -1;",
          "1676:   if (rv == 1) {",
          "1678:        file_printf(ms, F(ms, m, \"%u\"), offset) == -1) {",
          "1679:     free(rbuf);",
          "1680:     return -1;",
          "",
          "[Removed Lines]",
          "1677:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
          "",
          "[Added Lines]",
          "1677:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE|MAGIC_EXTENSION)) == 0 &&",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2136:    return -1;",
          "2137:   return 1;",
          "2138:  }",
          "2139:  if ((ms->flags & MAGIC_MIME_TYPE) && m->mimetype[0]) {",
          "2140:   if (file_printf(ms, \"%s\", m->mimetype) == -1)",
          "2141:    return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2139:  if (ms->flags & MAGIC_EXTENSION) {",
          "2140:   if (file_printf(ms, \"%s\", m->ext) == -1)",
          "2141:    return -1;",
          "2142:   return 1;",
          "2143:  }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1878ee9dfefa4adddd15822ade56228b4469228f",
      "candidate_info": {
        "commit_hash": "1878ee9dfefa4adddd15822ade56228b4469228f",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/1878ee9dfefa4adddd15822ade56228b4469228f",
        "files": [
          "src/softmagic.c"
        ],
        "message": "PR/337: Fix incorrect handling of offsets (wrong sign) Test: $ perl -e 'print \"ABC\", \"\\xff\\xff\", \"\\x00\"x70000, \"DEF\"' > abc.data $ cat abc.magic 0\tstring\t\tABC\tABC test file format >(3.s)\tsearch/0x3000\tDEF\t\\b, DEF sub type $ file -m abc.magic abc.data abc.data: ABC test file format, DEF sub type",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.182 2014/03/28 19:07:08 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.183 2014/04/01 15:44:26 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1179: {",
          "1180:  uint32_t soffset, offset = ms->offset;",
          "1181:  uint32_t count = m->str_range;",
          "1182:  int rv, oneed_separator, in_type;",
          "1183:  char *sbuf, *rbuf;",
          "1184:  union VALUETYPE *p = &ms->ms_value;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1182:  uint32_t lhs;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1281:   case FILE_BESHORT:",
          "1282:    if (OFFSET_OOB(nbytes, offset, 2))",
          "1283:     return 0;",
          "1284:    if (off) {",
          "1285:     switch (m->in_op & FILE_OPS_MASK) {",
          "1286:     case FILE_OPAND:",
          "1290:      break;",
          "1291:     case FILE_OPOR:",
          "1295:      break;",
          "1296:     case FILE_OPXOR:",
          "1300:      break;",
          "1301:     case FILE_OPADD:",
          "1305:      break;",
          "1306:     case FILE_OPMINUS:",
          "1310:      break;",
          "1311:     case FILE_OPMULTIPLY:",
          "1315:      break;",
          "1316:     case FILE_OPDIVIDE:",
          "1320:      break;",
          "1321:     case FILE_OPMODULO:",
          "1325:      break;",
          "1326:     }",
          "1327:    } else",
          "1330:    if (m->in_op & FILE_OPINVERSE)",
          "1331:     offset = ~offset;",
          "1332:    break;",
          "1333:   case FILE_LESHORT:",
          "1334:    if (OFFSET_OOB(nbytes, offset, 2))",
          "1335:     return 0;",
          "1336:    if (off) {",
          "1337:     switch (m->in_op & FILE_OPS_MASK) {",
          "1338:     case FILE_OPAND:",
          "1342:      break;",
          "1343:     case FILE_OPOR:",
          "1347:      break;",
          "1348:     case FILE_OPXOR:",
          "1352:      break;",
          "1353:     case FILE_OPADD:",
          "1357:      break;",
          "1358:     case FILE_OPMINUS:",
          "1362:      break;",
          "1363:     case FILE_OPMULTIPLY:",
          "1367:      break;",
          "1368:     case FILE_OPDIVIDE:",
          "1372:      break;",
          "1373:     case FILE_OPMODULO:",
          "1377:      break;",
          "1378:     }",
          "1379:    } else",
          "1382:    if (m->in_op & FILE_OPINVERSE)",
          "1383:     offset = ~offset;",
          "1384:    break;",
          "",
          "[Removed Lines]",
          "1287:      offset = (short)((p->hs[0]<<8)|",
          "1288:         (p->hs[1])) &",
          "1289:        off;",
          "1292:      offset = (short)((p->hs[0]<<8)|",
          "1293:         (p->hs[1])) |",
          "1294:        off;",
          "1297:      offset = (short)((p->hs[0]<<8)|",
          "1298:         (p->hs[1])) ^",
          "1299:        off;",
          "1302:      offset = (short)((p->hs[0]<<8)|",
          "1303:         (p->hs[1])) +",
          "1304:        off;",
          "1307:      offset = (short)((p->hs[0]<<8)|",
          "1308:         (p->hs[1])) -",
          "1309:        off;",
          "1312:      offset = (short)((p->hs[0]<<8)|",
          "1313:         (p->hs[1])) *",
          "1314:        off;",
          "1317:      offset = (short)((p->hs[0]<<8)|",
          "1318:         (p->hs[1])) /",
          "1319:        off;",
          "1322:      offset = (short)((p->hs[0]<<8)|",
          "1323:         (p->hs[1])) %",
          "1324:        off;",
          "1328:     offset = (short)((p->hs[0]<<8)|",
          "1329:        (p->hs[1]));",
          "1339:      offset = (short)((p->hs[1]<<8)|",
          "1340:         (p->hs[0])) &",
          "1341:        off;",
          "1344:      offset = (short)((p->hs[1]<<8)|",
          "1345:         (p->hs[0])) |",
          "1346:        off;",
          "1349:      offset = (short)((p->hs[1]<<8)|",
          "1350:         (p->hs[0])) ^",
          "1351:        off;",
          "1354:      offset = (short)((p->hs[1]<<8)|",
          "1355:         (p->hs[0])) +",
          "1356:        off;",
          "1359:      offset = (short)((p->hs[1]<<8)|",
          "1360:         (p->hs[0])) -",
          "1361:        off;",
          "1364:      offset = (short)((p->hs[1]<<8)|",
          "1365:         (p->hs[0])) *",
          "1366:        off;",
          "1369:      offset = (short)((p->hs[1]<<8)|",
          "1370:         (p->hs[0])) /",
          "1371:        off;",
          "1374:      offset = (short)((p->hs[1]<<8)|",
          "1375:         (p->hs[0])) %",
          "1376:        off;",
          "1380:     offset = (short)((p->hs[1]<<8)|",
          "1381:        (p->hs[0]));",
          "",
          "[Added Lines]",
          "1285:    lhs = (p->hs[0] << 8) | p->hs[1];",
          "1289:      offset = lhs & off;",
          "1292:      offset = lhs | off;",
          "1295:      offset = lhs ^ off;",
          "1298:      offset = lhs + off;",
          "1301:      offset = lhs - off;",
          "1304:      offset = lhs * off;",
          "1307:      offset = lhs / off;",
          "1310:      offset = lhs % off;",
          "1314:     offset = lhs;",
          "1321:    lhs = (p->hs[1] << 8) | p->hs[0];",
          "1325:      offset = lhs & off;",
          "1328:      offset = lhs | off;",
          "1331:      offset = lhs ^ off;",
          "1334:      offset = lhs + off;",
          "1337:      offset = lhs - off;",
          "1340:      offset = lhs * off;",
          "1343:      offset = lhs / off;",
          "1346:      offset = lhs % off;",
          "1350:     offset = lhs;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1422:   case FILE_BEID3:",
          "1423:    if (OFFSET_OOB(nbytes, offset, 4))",
          "1424:     return 0;",
          "1425:    if (off) {",
          "1426:     switch (m->in_op & FILE_OPS_MASK) {",
          "1427:     case FILE_OPAND:",
          "1433:      break;",
          "1434:     case FILE_OPOR:",
          "1440:      break;",
          "1441:     case FILE_OPXOR:",
          "1447:      break;",
          "1448:     case FILE_OPADD:",
          "1454:      break;",
          "1455:     case FILE_OPMINUS:",
          "1461:      break;",
          "1462:     case FILE_OPMULTIPLY:",
          "1468:      break;",
          "1469:     case FILE_OPDIVIDE:",
          "1475:      break;",
          "1476:     case FILE_OPMODULO:",
          "1482:      break;",
          "1483:     }",
          "1484:    } else",
          "1489:    if (m->in_op & FILE_OPINVERSE)",
          "1490:     offset = ~offset;",
          "1491:    break;",
          "",
          "[Removed Lines]",
          "1428:      offset = (int32_t)((p->hl[0]<<24)|",
          "1429:         (p->hl[1]<<16)|",
          "1430:         (p->hl[2]<<8)|",
          "1431:         (p->hl[3])) &",
          "1432:        off;",
          "1435:      offset = (int32_t)((p->hl[0]<<24)|",
          "1436:         (p->hl[1]<<16)|",
          "1437:         (p->hl[2]<<8)|",
          "1438:         (p->hl[3])) |",
          "1439:        off;",
          "1442:      offset = (int32_t)((p->hl[0]<<24)|",
          "1443:         (p->hl[1]<<16)|",
          "1444:         (p->hl[2]<<8)|",
          "1445:         (p->hl[3])) ^",
          "1446:        off;",
          "1449:      offset = (int32_t)((p->hl[0]<<24)|",
          "1450:         (p->hl[1]<<16)|",
          "1451:         (p->hl[2]<<8)|",
          "1452:         (p->hl[3])) +",
          "1453:        off;",
          "1456:      offset = (int32_t)((p->hl[0]<<24)|",
          "1457:         (p->hl[1]<<16)|",
          "1458:         (p->hl[2]<<8)|",
          "1459:         (p->hl[3])) -",
          "1460:        off;",
          "1463:      offset = (int32_t)((p->hl[0]<<24)|",
          "1464:         (p->hl[1]<<16)|",
          "1465:         (p->hl[2]<<8)|",
          "1466:         (p->hl[3])) *",
          "1467:        off;",
          "1470:      offset = (int32_t)((p->hl[0]<<24)|",
          "1471:         (p->hl[1]<<16)|",
          "1472:         (p->hl[2]<<8)|",
          "1473:         (p->hl[3])) /",
          "1474:        off;",
          "1477:      offset = (int32_t)((p->hl[0]<<24)|",
          "1478:         (p->hl[1]<<16)|",
          "1479:         (p->hl[2]<<8)|",
          "1480:         (p->hl[3])) %",
          "1481:        off;",
          "1485:     offset = (int32_t)((p->hl[0]<<24)|",
          "1486:        (p->hl[1]<<16)|",
          "1487:        (p->hl[2]<<8)|",
          "1488:        (p->hl[3]));",
          "",
          "[Added Lines]",
          "1394:    lhs = (p->hl[0] << 24) | (p->hl[1] << 16) |",
          "1395:        (p->hl[2] << 8) | p->hl[3];",
          "1399:      offset = lhs & off;",
          "1402:      offset = lhs | off;",
          "1405:      offset = lhs ^ off;",
          "1408:      offset = lhs + off;",
          "1411:      offset = lhs - off;",
          "1414:      offset = lhs * off;",
          "1417:      offset = lhs / off;",
          "1420:      offset = lhs % off;",
          "1424:     offset = lhs;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1493:   case FILE_LEID3:",
          "1494:    if (OFFSET_OOB(nbytes, offset, 4))",
          "1495:     return 0;",
          "1496:    if (off) {",
          "1497:     switch (m->in_op & FILE_OPS_MASK) {",
          "1498:     case FILE_OPAND:",
          "1504:      break;",
          "1505:     case FILE_OPOR:",
          "1511:      break;",
          "1512:     case FILE_OPXOR:",
          "1518:      break;",
          "1519:     case FILE_OPADD:",
          "1525:      break;",
          "1526:     case FILE_OPMINUS:",
          "1532:      break;",
          "1533:     case FILE_OPMULTIPLY:",
          "1539:      break;",
          "1540:     case FILE_OPDIVIDE:",
          "1546:      break;",
          "1547:     case FILE_OPMODULO:",
          "1553:      break;",
          "1554:     }",
          "1555:    } else",
          "1560:    if (m->in_op & FILE_OPINVERSE)",
          "1561:     offset = ~offset;",
          "1562:    break;",
          "1563:   case FILE_MELONG:",
          "1564:    if (OFFSET_OOB(nbytes, offset, 4))",
          "1565:     return 0;",
          "1566:    if (off) {",
          "1567:     switch (m->in_op & FILE_OPS_MASK) {",
          "1568:     case FILE_OPAND:",
          "1574:      break;",
          "1575:     case FILE_OPOR:",
          "1581:      break;",
          "1582:     case FILE_OPXOR:",
          "1588:      break;",
          "1589:     case FILE_OPADD:",
          "1595:      break;",
          "1596:     case FILE_OPMINUS:",
          "1602:      break;",
          "1603:     case FILE_OPMULTIPLY:",
          "1609:      break;",
          "1610:     case FILE_OPDIVIDE:",
          "1616:      break;",
          "1617:     case FILE_OPMODULO:",
          "1623:      break;",
          "1624:     }",
          "1625:    } else",
          "1630:    if (m->in_op & FILE_OPINVERSE)",
          "1631:     offset = ~offset;",
          "1632:    break;",
          "",
          "[Removed Lines]",
          "1499:      offset = (int32_t)((p->hl[3]<<24)|",
          "1500:         (p->hl[2]<<16)|",
          "1501:         (p->hl[1]<<8)|",
          "1502:         (p->hl[0])) &",
          "1503:        off;",
          "1506:      offset = (int32_t)((p->hl[3]<<24)|",
          "1507:         (p->hl[2]<<16)|",
          "1508:         (p->hl[1]<<8)|",
          "1509:         (p->hl[0])) |",
          "1510:        off;",
          "1513:      offset = (int32_t)((p->hl[3]<<24)|",
          "1514:         (p->hl[2]<<16)|",
          "1515:         (p->hl[1]<<8)|",
          "1516:         (p->hl[0])) ^",
          "1517:        off;",
          "1520:      offset = (int32_t)((p->hl[3]<<24)|",
          "1521:         (p->hl[2]<<16)|",
          "1522:         (p->hl[1]<<8)|",
          "1523:         (p->hl[0])) +",
          "1524:        off;",
          "1527:      offset = (int32_t)((p->hl[3]<<24)|",
          "1528:         (p->hl[2]<<16)|",
          "1529:         (p->hl[1]<<8)|",
          "1530:         (p->hl[0])) -",
          "1531:        off;",
          "1534:      offset = (int32_t)((p->hl[3]<<24)|",
          "1535:         (p->hl[2]<<16)|",
          "1536:         (p->hl[1]<<8)|",
          "1537:         (p->hl[0])) *",
          "1538:        off;",
          "1541:      offset = (int32_t)((p->hl[3]<<24)|",
          "1542:         (p->hl[2]<<16)|",
          "1543:         (p->hl[1]<<8)|",
          "1544:         (p->hl[0])) /",
          "1545:        off;",
          "1548:      offset = (int32_t)((p->hl[3]<<24)|",
          "1549:         (p->hl[2]<<16)|",
          "1550:         (p->hl[1]<<8)|",
          "1551:         (p->hl[0])) %",
          "1552:        off;",
          "1556:     offset = (int32_t)((p->hl[3]<<24)|",
          "1557:        (p->hl[2]<<16)|",
          "1558:        (p->hl[1]<<8)|",
          "1559:        (p->hl[0]));",
          "1569:      offset = (int32_t)((p->hl[1]<<24)|",
          "1570:         (p->hl[0]<<16)|",
          "1571:         (p->hl[3]<<8)|",
          "1572:         (p->hl[2])) &",
          "1573:        off;",
          "1576:      offset = (int32_t)((p->hl[1]<<24)|",
          "1577:         (p->hl[0]<<16)|",
          "1578:         (p->hl[3]<<8)|",
          "1579:         (p->hl[2])) |",
          "1580:        off;",
          "1583:      offset = (int32_t)((p->hl[1]<<24)|",
          "1584:         (p->hl[0]<<16)|",
          "1585:         (p->hl[3]<<8)|",
          "1586:         (p->hl[2])) ^",
          "1587:        off;",
          "1590:      offset = (int32_t)((p->hl[1]<<24)|",
          "1591:         (p->hl[0]<<16)|",
          "1592:         (p->hl[3]<<8)|",
          "1593:         (p->hl[2])) +",
          "1594:        off;",
          "1597:      offset = (int32_t)((p->hl[1]<<24)|",
          "1598:         (p->hl[0]<<16)|",
          "1599:         (p->hl[3]<<8)|",
          "1600:         (p->hl[2])) -",
          "1601:        off;",
          "1604:      offset = (int32_t)((p->hl[1]<<24)|",
          "1605:         (p->hl[0]<<16)|",
          "1606:         (p->hl[3]<<8)|",
          "1607:         (p->hl[2])) *",
          "1608:        off;",
          "1611:      offset = (int32_t)((p->hl[1]<<24)|",
          "1612:         (p->hl[0]<<16)|",
          "1613:         (p->hl[3]<<8)|",
          "1614:         (p->hl[2])) /",
          "1615:        off;",
          "1618:      offset = (int32_t)((p->hl[1]<<24)|",
          "1619:         (p->hl[0]<<16)|",
          "1620:         (p->hl[3]<<8)|",
          "1621:         (p->hl[2])) %",
          "1622:        off;",
          "1626:     offset = (int32_t)((p->hl[1]<<24)|",
          "1627:        (p->hl[0]<<16)|",
          "1628:        (p->hl[3]<<8)|",
          "1629:        (p->hl[2]));",
          "",
          "[Added Lines]",
          "1432:    lhs = (p->hl[3] << 24) | (p->hl[2] << 16) |",
          "1433:        (p->hl[1] << 8) | p->hl[0];",
          "1437:      offset = lhs & off;",
          "1440:      offset = lhs | off;",
          "1443:      offset = lhs ^ off;",
          "1446:      offset = lhs + off;",
          "1449:      offset = lhs - off;",
          "1452:      offset = lhs * off;",
          "1455:      offset = lhs / off;",
          "1458:      offset = lhs % off;",
          "1462:     offset = lhs;",
          "1469:    lhs = (p->hl[1] << 24) | (p->hl[0] << 16) |",
          "1470:        (p->hl[3] << 8) | p->hl[2];",
          "1474:      offset = lhs & off;",
          "1477:      offset = lhs | off;",
          "1480:      offset = lhs ^ off;",
          "1483:      offset = lhs + off;",
          "1486:      offset = lhs - off;",
          "1489:      offset = lhs * off;",
          "1492:      offset = lhs / off;",
          "1495:      offset = lhs % off;",
          "1499:     offset = lhs;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c0c0032b9e9eb57b91fefef905a3b018bab492d9",
      "candidate_info": {
        "commit_hash": "c0c0032b9e9eb57b91fefef905a3b018bab492d9",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/c0c0032b9e9eb57b91fefef905a3b018bab492d9",
        "files": [
          "src/softmagic.c"
        ],
        "message": "Fix memory leak (Anatol Belski)",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.175 2014/02/18 11:09:31 kim Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.176 2014/02/18 17:59:21 kim Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1762:   ms->offset = soffset;",
          "1763:   if (rv == 1) {",
          "1764:    if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&",
          "1766:     return -1;",
          "1768:     return -1;",
          "1770:   }",
          "1771:   return rv;",
          "1773:  case FILE_USE:",
          "",
          "[Removed Lines]",
          "1765:        file_printf(ms, F(m->desc, \"%u\"), offset) == -1)",
          "1767:    if (file_printf(ms, \"%s\", rbuf) == -1)",
          "1769:    free(rbuf);",
          "",
          "[Added Lines]",
          "1765:        file_printf(ms, F(m->desc, \"%u\"), offset) == -1) {",
          "1766:     free(rbuf);",
          "1768:    }",
          "1769:    if (file_printf(ms, \"%s\", rbuf) == -1) {",
          "1770:     free(rbuf);",
          "1772:    }",
          "1774:   free(rbuf);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "defbf8856b8f519f5979f65623ec18266741de50",
      "candidate_info": {
        "commit_hash": "defbf8856b8f519f5979f65623ec18266741de50",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/defbf8856b8f519f5979f65623ec18266741de50",
        "files": [
          "src/softmagic.c"
        ],
        "message": "search and regex don't copy stuff to value.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.206 2015/01/01 17:07:34 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.207 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "589:   t = ms->offset + sizeof(uint64_t);",
          "590:   break;",
          "595:   vf = p->f;",
          "596:   switch (check_fmt(ms, m)) {",
          "597:   case -1:",
          "",
          "[Removed Lines]",
          "592:    case FILE_FLOAT:",
          "593:    case FILE_BEFLOAT:",
          "594:    case FILE_LEFLOAT:",
          "",
          "[Added Lines]",
          "592:  case FILE_FLOAT:",
          "593:  case FILE_BEFLOAT:",
          "594:  case FILE_LEFLOAT:",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "609:   t = ms->offset + sizeof(float);",
          "610:     break;",
          "615:   vd = p->d;",
          "616:   switch (check_fmt(ms, m)) {",
          "617:   case -1:",
          "",
          "[Removed Lines]",
          "612:    case FILE_DOUBLE:",
          "613:    case FILE_BEDOUBLE:",
          "614:    case FILE_LEDOUBLE:",
          "",
          "[Added Lines]",
          "612:  case FILE_DOUBLE:",
          "613:  case FILE_BEDOUBLE:",
          "614:  case FILE_LEDOUBLE:",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "629:   t = ms->offset + sizeof(double);",
          "630:     break;",
          "632:  case FILE_REGEX: {",
          "633:   char *cp;",
          "634:   int rval;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "632:  case FILE_SEARCH:",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "652:   break;",
          "653:  }",
          "665:  case FILE_DEFAULT:",
          "666:  case FILE_CLEAR:",
          "667:     if (file_printf(ms, \"%s\", m->desc) == -1)",
          "",
          "[Removed Lines]",
          "655:  case FILE_SEARCH:",
          "656:     if (file_printf(ms, F(ms, m, \"%s\"),",
          "657:       file_printable(sbuf, sizeof(sbuf), m->value.s)) == -1)",
          "658:    return -1;",
          "659:   if ((m->str_flags & REGEX_OFFSET_START))",
          "660:    t = ms->search.offset;",
          "661:   else",
          "662:    t = ms->search.offset + m->vallen;",
          "663:   break;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1965:        m->str_flags);",
          "1967:     ms->search.offset += idx;",
          "1968:     break;",
          "1969:    }",
          "1970:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1959:     ms->search.rm_len = m->str_range - idx;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
      "candidate_info": {
        "commit_hash": "c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/c12b1c8d6af72a0e2fb0a43928c03b7a0e2f2d3d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "annotations are attached to the first description entry, print them then.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.218 2015/09/11 17:24:09 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.219 2015/09/16 18:25:23 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "228:    continue;",
          "229:   }",
          "241:   if (*m->desc) {",
          "244:    if (print_sep(ms, firstline) == -1)",
          "",
          "[Removed Lines]",
          "231:   if ((e = handle_annotation(ms, m)) != 0) {",
          "235:    return e;",
          "236:   }",
          "",
          "[Added Lines]",
          "236:    if ((e = handle_annotation(ms, m)) != 0) {",
          "240:     return e;",
          "241:    }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "318:       break;",
          "319:     } else",
          "320:      ms->c.li[cont_level].got_match = 1;",
          "331:     if (*m->desc) {",
          "332:      if (!*printed_something) {",
          "334:       if (print_sep(ms, firstline)",
          "",
          "[Removed Lines]",
          "321:     if ((e = handle_annotation(ms, m)) != 0) {",
          "325:      return e;",
          "326:     }",
          "",
          "[Added Lines]",
          "326:      if ((e = handle_annotation(ms, m)) != 0) {",
          "330:       return e;",
          "331:      }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2166: private int",
          "2167: handle_annotation(struct magic_set *ms, struct magic *m)",
          "2168: {",
          "2169:  if (ms->flags & MAGIC_APPLE) {",
          "2170:   if (file_printf(ms, \"%.8s\", m->apple) == -1)",
          "2171:    return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2169: printf(\"desc = %s, ext = %s mime = %s\\n\", m->desc, m->ext, m->mimetype);",
          "",
          "---------------"
        ]
      }
    }
  ]
}