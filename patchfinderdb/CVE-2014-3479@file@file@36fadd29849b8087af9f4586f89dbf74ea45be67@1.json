{
  "cve_id": "CVE-2014-3479",
  "cve_desc": "The cdf_check_stream_offset function in cdf.c in file before 5.19, as used in the Fileinfo component in PHP before 5.4.30 and 5.5.x before 5.5.14, relies on incorrect sector-size data, which allows remote attackers to cause a denial of service (application crash) via a crafted stream offset in a CDF file.",
  "repo": "file/file",
  "patch_hash": "36fadd29849b8087af9f4586f89dbf74ea45be67",
  "patch_info": {
    "commit_hash": "36fadd29849b8087af9f4586f89dbf74ea45be67",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/36fadd29849b8087af9f4586f89dbf74ea45be67",
    "files": [
      "src/cdf.c"
    ],
    "message": "Use the proper sector size when checking stream offsets (Francisco Alonso and Jan Kaluza at RedHat)",
    "before_after_code_files": [
      "src/cdf.c||src/cdf.c"
    ]
  },
  "patch_diff": {
    "src/cdf.c||src/cdf.c": [
      "File: src/cdf.c -> src/cdf.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "35: #include \"file.h\"",
      "37: #ifndef lint",
      "39: #endif",
      "41: #include <assert.h>",
      "",
      "[Removed Lines]",
      "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.60 2014/05/21 13:04:38 christos Exp $\")",
      "",
      "[Added Lines]",
      "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.61 2014/06/04 17:23:19 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "267: {",
      "268:  const char *b = (const char *)sst->sst_tab;",
      "269:  const char *e = ((const char *)p) + tail;",
      "270:  (void)&line;",
      "272:   return 0;",
      "273:  DPRINTF((\"%d: offset begin %p < end %p || %\" SIZE_T_FORMAT \"u\"",
      "274:      \" > %\" SIZE_T_FORMAT \"u [%\" SIZE_T_FORMAT \"u %\"",
      "275:      SIZE_T_FORMAT \"u]\\n\", line, b, e, (size_t)(e - b),",
      "277:  errno = EFTYPE;",
      "278:  return -1;",
      "279: }",
      "",
      "[Removed Lines]",
      "271:  if (e >= b && (size_t)(e - b) <= CDF_SEC_SIZE(h) * sst->sst_len)",
      "276:      CDF_SEC_SIZE(h) * sst->sst_len, CDF_SEC_SIZE(h), sst->sst_len));",
      "",
      "[Added Lines]",
      "270:  size_t ss = sst->sst_dirlen < h->h_min_size_standard_stream ?",
      "271:      CDF_SHORT_SEC_SIZE(h) : CDF_SEC_SIZE(h);",
      "273:  if (e >= b && (size_t)(e - b) <= ss * sst->sst_len)",
      "278:      ss * sst->sst_len, ss, sst->sst_len));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4c195c2c22236b8cd169b80ef1809ab753d36b25",
      "candidate_info": {
        "commit_hash": "4c195c2c22236b8cd169b80ef1809ab753d36b25",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/4c195c2c22236b8cd169b80ef1809ab753d36b25",
        "files": [
          "src/cdf.c",
          "src/cdf.h",
          "src/readcdf.c"
        ],
        "message": "Factor out finding CDF files by directory names. Add quickbooks",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c",
          "src/cdf.h||src/cdf.h",
          "src/readcdf.c||src/readcdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.71 2015/01/05 18:00:36 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.72 2015/01/05 18:09:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "747:     const cdf_sat_t *sat, const cdf_sat_t *ssat, const cdf_stream_t *sst,",
          "748:     const cdf_dir_t *dir, const char *name, cdf_stream_t *scn)",
          "749: {",
          "751:  const cdf_directory_t *d;",
          "754:  for (i = dir->dir_len; i > 0; i--)",
          "756:       cdf_namecmp(name, dir->dir_tab[i - 1].d_name, name_len)",
          "757:       == 0)",
          "758:    break;",
          "768: }",
          "770: int",
          "",
          "[Removed Lines]",
          "750:  size_t i;",
          "752:  size_t name_len = strlen(name) + 1;",
          "755:   if (dir->dir_tab[i - 1].d_type == CDF_DIR_TYPE_USER_STREAM &&",
          "760:  if (i == 0) {",
          "761:   DPRINTF((\"Cannot find user stream `%s'\\n\", name));",
          "762:   errno = ESRCH;",
          "763:   return -1;",
          "764:  }",
          "765:  d = &dir->dir_tab[i - 1];",
          "766:  return cdf_read_sector_chain(info, h, sat, ssat, sst,",
          "767:      d->d_stream_first_sector, d->d_size, scn);",
          "",
          "[Added Lines]",
          "751:  int i = cdf_find_stream(dir, name, CDF_DIR_TYPE_USER_STREAM);",
          "753:  if (i <= 0)",
          "754:   return i;",
          "756:  d = &dir->dir_tab[i - 1];",
          "757:  return cdf_read_sector_chain(info, h, sat, ssat, sst,",
          "758:      d->d_stream_first_sector, d->d_size, scn);",
          "759: }",
          "761: int",
          "762: cdf_find_stream(const cdf_dir_t *dir, const char *name, int type)",
          "763: {",
          "764:  size_t i, name_len = strlen(name) + 1;",
          "767:   if (dir->dir_tab[i - 1].d_type == type &&",
          "771:  if (i > 0)",
          "772:   return i;",
          "774:  DPRINTF((\"Cannot find type %d `%s'\\n\", type, name));",
          "775:  errno = ESRCH;",
          "776:  return 0;",
          "",
          "---------------"
        ],
        "src/cdf.h||src/cdf.h": [
          "File: src/cdf.h -> src/cdf.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "314: int cdf_read_user_stream(const cdf_info_t *, const cdf_header_t *,",
          "315:     const cdf_sat_t *, const cdf_sat_t *, const cdf_stream_t *,",
          "316:     const cdf_dir_t *, const char *, cdf_stream_t *);",
          "323: int cdf_read_summary_info(const cdf_info_t *, const cdf_header_t *,",
          "324:     const cdf_sat_t *, const cdf_sat_t *, const cdf_stream_t *,",
          "325:     const cdf_dir_t *, cdf_stream_t *);",
          "",
          "[Removed Lines]",
          "317: #define cdf_read_catalog(info, header, sat, ssat, stream, dir, scn) \\",
          "318:     cdf_read_user_stream(info, header, sat, ssat, stream, dir, \"Catalog\", \\",
          "319:     scn)",
          "320: #define cdf_read_encrypted_package(info, header, sat, ssat, stream, dir, scn) \\",
          "321:     cdf_read_user_stream(info, header, sat, ssat, stream, dir, \\",
          "322:     \"EncryptedPackage\", scn)",
          "",
          "[Added Lines]",
          "317: int cdf_find_stream(const cdf_dir_t *, const char *, int);",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.49 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.50 2015/01/02 21:29:39 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "100:   if (clsid[0] == cv[i].clsid[0] && clsid[1] == cv[i].clsid[1])",
          "101:    return cv[i].mime;",
          "102:  }",
          "103:  return NULL;",
          "104: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103: #ifdef CDF_DEBUG",
          "104:  fprintf(stderr, \"unknown mime %\" PRIx64 \", %\" PRIx64 \"\\n\", clsid[0],",
          "105:      clsid[1]);",
          "106: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "121:    rv = nv[i].mime;",
          "122:    break;",
          "123:   }",
          "124: #ifdef USE_C_LOCALE",
          "125:  (void)uselocale(old_lc_ctype);",
          "126:  freelocale(c_lc_ctype);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "128: #ifdef CDF_DEBUG",
          "129:  fprintf(stderr, \"unknown app %s\\n\", vbuf);",
          "130: #endif",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "347: }",
          "348: #endif",
          "350: protected int",
          "351: file_trycdf(struct magic_set *ms, int fd, const unsigned char *buf,",
          "352:     size_t nbytes)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "357: private int",
          "358: cdf_file_catalog_info(struct magic_set *ms, const cdf_info_t *info,",
          "359:     const cdf_header_t *h, const cdf_sat_t *sat, const cdf_sat_t *ssat,",
          "360:     const cdf_stream_t *sst, const cdf_dir_t *dir, cdf_stream_t *scn)",
          "361: {",
          "362:  int i;",
          "364:  if ((i = cdf_read_user_stream(info, h, sat, ssat, sst,",
          "365:      dir, \"Catalog\", scn)) <= 0)",
          "366:   return i;",
          "367: #ifdef CDF_DEBUG",
          "368:  cdf_dump_catalog(&h, &scn);",
          "369: #endif",
          "370:  if ((i = cdf_file_catalog(ms, h, scn)) == -1)",
          "371:   return -1;",
          "372:  return i;",
          "373: }",
          "375: private struct sinfo {",
          "376:  const char *name;",
          "377:  const char *mime;",
          "378:  const char *sections[5];",
          "379:  const int  types[5];",
          "380: } sectioninfo[] = {",
          "381:  { \"Encrypted\", \"encrypted\",",
          "382:   {",
          "383:    \"EncryptedPackage\", NULL, NULL, NULL, NULL,",
          "384:   },",
          "385:   {",
          "386:    CDF_DIR_TYPE_USER_STREAM, 0, 0, 0, 0,",
          "388:   },",
          "389:  },",
          "390:  { \"QuickBooks\", \"quickbooks\",",
          "391:   {",
          "392: #if 0",
          "393:    \"TaxForms\", \"PDFTaxForms\", \"modulesInBackup\",",
          "394: #endif",
          "395:    \"mfbu_header\", NULL, NULL, NULL, NULL,",
          "396:   },",
          "397:   {",
          "398: #if 0",
          "399:    CDF_DIR_TYPE_USER_STORAGE,",
          "400:    CDF_DIR_TYPE_USER_STORAGE,",
          "401:    CDF_DIR_TYPE_USER_STREAM,",
          "402: #endif",
          "403:    CDF_DIR_TYPE_USER_STREAM,",
          "404:    0, 0, 0, 0",
          "405:   },",
          "406:  },",
          "407: };",
          "409: private int",
          "410: cdf_file_dir_info(struct magic_set *ms, const cdf_dir_t *dir)",
          "411: {",
          "412:  size_t sd, j;",
          "414:  for (sd = 0; sd < __arraycount(sectioninfo); sd++) {",
          "415:   const struct sinfo *si = &sectioninfo[sd];",
          "416:   for (j = 0; si->sections[j]; j++) {",
          "417:    if (cdf_find_stream(dir, si->sections[j], si->types[j])",
          "418:        <= 0) {",
          "419: #ifdef CDF_DEBUG",
          "420:     fprintf(stderr, \"Can't read %s\\n\",",
          "421:         si->sections[j]);",
          "422: #endif",
          "423:     break;",
          "424:    }",
          "425:   }",
          "426:   if (si->sections[j] != NULL)",
          "427:    continue;",
          "428:   if (NOTMIME(ms)) {",
          "429:    if (file_printf(ms, \"CDFV2 %s\", si->name) == -1)",
          "430:     return -1;",
          "431:   } else {",
          "432:    if (file_printf(ms, \"application/CDFV2-%s\",",
          "433:        si->mime) == -1)",
          "434:     return -1;",
          "435:   }",
          "436:   return 1;",
          "437:  }",
          "438:  return -1;",
          "439: }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "358:         cdf_dir_t dir;",
          "359:         int i;",
          "360:         const char *expn = \"\";",
          "362:         const cdf_directory_t *root_storage;",
          "364:         info.i_fd = fd;",
          "",
          "[Removed Lines]",
          "361:         const char *corrupt = \"corrupt: \";",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "440:         if ((i = cdf_read_summary_info(&info, &h, &sat, &ssat, &sst, &dir,",
          "441:             &scn)) == -1) {",
          "462:                         expn = \"Cannot read summary info\";",
          "466: #ifdef CDF_DEBUG",
          "467:         cdf_dump_summary_info(&h, &scn);",
          "468: #endif",
          "",
          "[Removed Lines]",
          "442:                 if (errno == ESRCH) {",
          "443:    if ((i = cdf_read_catalog(&info, &h, &sat, &ssat, &sst,",
          "444:        &dir, &scn)) == -1) {",
          "445:     corrupt = expn;",
          "446:     if ((i = cdf_read_encrypted_package(&info, &h,",
          "447:         &sat, &ssat, &sst, &dir, &scn)) == -1)",
          "448:      expn = \"No summary info\";",
          "449:     else {",
          "450:      expn = \"Encrypted\";",
          "451:      i = -1;",
          "452:     }",
          "453:     goto out4;",
          "454:    }",
          "455: #ifdef CDF_DEBUG",
          "456:    cdf_dump_catalog(&h, &scn);",
          "457: #endif",
          "458:    if ((i = cdf_file_catalog(ms, &h, &scn))",
          "459:        < 0)",
          "460:     expn = \"Can't expand catalog\";",
          "461:                 } else {",
          "463:                 }",
          "464:                 goto out4;",
          "465:         }",
          "",
          "[Added Lines]",
          "532:                 if (errno != ESRCH) {",
          "534:    goto out4;",
          "535:   }",
          "536:   i = cdf_file_catalog_info(ms, &info, &h, &sat, &ssat, &sst,",
          "537:       &dir, &scn);",
          "538:   if (i > 0)",
          "539:    goto out4;",
          "540:   i = cdf_file_dir_info(ms, &dir);",
          "541:   if (i < 0)",
          "542:                         expn = \"Cannot read section info\";",
          "543:   goto out4;",
          "544:  }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "513:       \"Composite Document File V2 Document\") == -1)",
          "514:       return -1;",
          "515:   if (*expn)",
          "517:    return -1;",
          "518:      } else {",
          "521:       return -1;",
          "522:      }",
          "523:      i = 1;",
          "",
          "[Removed Lines]",
          "516:       if (file_printf(ms, \", %s%s\", corrupt, expn) == -1)",
          "519:   if (file_printf(ms, \"application/CDFV2-%s\",",
          "",
          "[Added Lines]",
          "597:       if (file_printf(ms, \", %s\", expn) == -1)",
          "600:   if (file_printf(ms, \"application/CDFV2-unknown\") == -1)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "78c2b81ccb511a740049ffe8ca5410433aae7d4e",
      "candidate_info": {
        "commit_hash": "78c2b81ccb511a740049ffe8ca5410433aae7d4e",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/78c2b81ccb511a740049ffe8ca5410433aae7d4e",
        "files": [
          "src/apprentice.c",
          "src/cdf.c",
          "src/compress.c",
          "src/file.c",
          "src/file.h",
          "src/funcs.c",
          "src/magic.c",
          "src/print.c",
          "src/readcdf.c",
          "src/readelf.c",
          "src/softmagic.c"
        ],
        "message": "Bug + portability fixes from the NetBSD build.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/cdf.c||src/cdf.c",
          "src/compress.c||src/compress.c",
          "src/file.c||src/file.c",
          "src/file.h||src/file.h",
          "src/funcs.c||src/funcs.c",
          "src/magic.c||src/magic.c",
          "src/print.c||src/print.c",
          "src/readcdf.c||src/readcdf.c",
          "src/readelf.c||src/readelf.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.228 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.229 2015/01/01 17:07:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2199:  size_t i;",
          "2200:  const char *l = line;",
          "2201:  struct magic *m = &me->mp[me->cont_count == 0 ? 0 : me->cont_count - 1];",
          "2204:  if (buf[0] != '\\0') {",
          "2205:   len = nt ? strlen(buf) : len;",
          "",
          "[Removed Lines]",
          "2202:  char *buf = (char *)m + off;",
          "",
          "[Added Lines]",
          "2202:  char *buf = CAST(char *, CAST(void *, m)) + off;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2248: {",
          "2249:  struct magic *m = &me->mp[0];",
          "2252:      sizeof(m->apple), \"APPLE\", \"!+-./\", 0);",
          "2253: }",
          "",
          "[Removed Lines]",
          "2251:  return parse_extra(ms, me, line, offsetof(struct magic, apple),",
          "",
          "[Added Lines]",
          "2251:  return parse_extra(ms, me, line,",
          "2252:      CAST(off_t, offsetof(struct magic, apple)),",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2261: {",
          "2262:  struct magic *m = &me->mp[0];",
          "2265:      sizeof(m->mimetype), \"MIME\", \"+-/.\", 1);",
          "2266: }",
          "",
          "[Removed Lines]",
          "2264:  return parse_extra(ms, me, line, offsetof(struct magic, mimetype),",
          "",
          "[Added Lines]",
          "2265:  return parse_extra(ms, me, line,",
          "2266:      CAST(off_t, offsetof(struct magic, mimetype)),",
          "",
          "---------------"
        ],
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.68 2014/10/22 19:27:36 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.69 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "73: #define CDF_TOLE8(x) ((uint64_t)(NEED_SWAP ? _cdf_tole8(x) : (uint64_t)(x)))",
          "74: #define CDF_TOLE4(x) ((uint32_t)(NEED_SWAP ? _cdf_tole4(x) : (uint32_t)(x)))",
          "75: #define CDF_TOLE2(x) ((uint16_t)(NEED_SWAP ? _cdf_tole2(x) : (uint16_t)(x)))",
          "78: #define CDF_GETUINT32(x, y) cdf_getuint32(x, y)",
          "",
          "[Removed Lines]",
          "76: #define CDF_TOLE(x) (sizeof(x) == 2 ? CDF_TOLE2(x) : (sizeof(x) == 4 ? \\",
          "77:     CDF_TOLE4(x) : CDF_TOLE8(x)))",
          "",
          "[Added Lines]",
          "76: #define CDF_TOLE(x) (/*CONSTCOND*/sizeof(x) == 2 ? \\",
          "77:        CDF_TOLE2(CAST(uint16_t, x)) : \\",
          "78:    (/*CONSTCOND*/sizeof(x) == 4 ? \\",
          "79:        CDF_TOLE4(CAST(uint32_t, x)) : \\",
          "80:        CDF_TOLE8(CAST(uint64_t, x))))",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "271:  const char *e = ((const char *)p) + tail;",
          "272:  size_t ss = sst->sst_dirlen < h->h_min_size_standard_stream ?",
          "273:      CDF_SHORT_SEC_SIZE(h) : CDF_SEC_SIZE(h);",
          "275:  if (e >= b && (size_t)(e - b) <= ss * sst->sst_len)",
          "276:   return 0;",
          "277:  DPRINTF((\"%d: offset begin %p < end %p || %\" SIZE_T_FORMAT \"u\"",
          "",
          "[Removed Lines]",
          "274:  (void)&line;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "998: }",
          "1002:     memcpy(&ce[i].f, b + (l), sizeof(ce[i].f)); \\",
          "1005: int",
          "1006: cdf_unpack_catalog(const cdf_header_t *h, const cdf_stream_t *sst,",
          "",
          "[Removed Lines]",
          "1001: #define extract_catalog_field(f, l) \\",
          "1003:     ce[i].f = CDF_TOLE(ce[i].f)",
          "",
          "[Added Lines]",
          "1004: #define extract_catalog_field(t, f, l) \\",
          "1006:     ce[i].f = CAST(t, CDF_TOLE(ce[i].f))",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1028:  ce = (*cat)->cat_e;",
          "1029:  b = CAST(const char *, sst->sst_tab);",
          "1030:  for (i = 0; i < nr; i++) {",
          "1034:   reclen = ce[i].ce_namlen;",
          "1035:   ce[i].ce_namlen =",
          "1036:       sizeof(ce[i].ce_name) / sizeof(ce[i].ce_name[0]) - 1;",
          "1037:   if (ce[i].ce_namlen > reclen - 14)",
          "1038:    ce[i].ce_namlen = reclen - 14;",
          "1040:   for (k = 0; k < ce[i].ce_namlen; k++) {",
          "1043:   }",
          "1044:   ce[i].ce_name[ce[i].ce_namlen] = 0;",
          "1045:   b += reclen;",
          "",
          "[Removed Lines]",
          "1031:   extract_catalog_field(ce_namlen, 0);",
          "1032:   extract_catalog_field(ce_num, 2);",
          "1033:   extract_catalog_field(ce_timestamp, 6);",
          "1039:   np = CAST(const uint16_t *, (b + 16));",
          "1041:    ce[i].ce_name[k] = np[k];",
          "1042:    CDF_TOLE2(ce[i].ce_name[k]);",
          "",
          "[Added Lines]",
          "1034:   extract_catalog_field(uint16_t, ce_namlen, 0);",
          "1035:   extract_catalog_field(uint16_t, ce_num, 2);",
          "1036:   extract_catalog_field(uint64_t, ce_timestamp, 6);",
          "1042:   np = CAST(const uint16_t *, CAST(const void *, (b + 16)));",
          "",
          "---------------"
        ],
        "src/compress.c||src/compress.c": [
          "File: src/compress.c -> src/compress.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: compress.c,v 1.76 2014/12/11 11:47:08 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: compress.c,v 1.77 2014/12/12 16:33:01 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "383:  int fdin[2], fdout[2];",
          "384:  int status;",
          "385:  ssize_t r;",
          "388: #ifdef BUILTIN_DECOMPRESS",
          "",
          "[Removed Lines]",
          "386:  pid_t pid;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "397:   file_error(ms, errno, \"cannot create pipe\");",
          "398:   return NODATA;",
          "399:  }",
          "402:   (void) close(0);",
          "403:   if (fd != -1) {",
          "",
          "[Removed Lines]",
          "400:  switch (pid = fork()) {",
          "",
          "[Added Lines]",
          "399:  switch (fork()) {",
          "",
          "---------------"
        ],
        "src/file.c||src/file.c": [
          "File: src/file.c -> src/file.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.159 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: file.c,v 1.160 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "133: private void usage(void);",
          "134: private void docprint(const char *);",
          "135: private void help(void);",
          "137: private int unwrap(struct magic_set *, const char *);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "133: #ifdef __dead",
          "134: __dead",
          "135: #endif",
          "138: #ifdef __dead",
          "139: __dead",
          "140: #endif",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "590: #else",
          "591: #define FILE_RCSID(id)",
          "592: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "593: #ifndef __RCSID",
          "594: #define __RCSID(a)",
          "595: #endif",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.78 2014/12/11 12:34:24 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.79 2014/12/16 20:52:49 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "159: }",
          "161: #ifndef COMPILE_ONLY",
          "162: protected int",
          "164:     const void *buf, size_t nb)",
          "165: {",
          "166:  int m = 0, rv = 0, looks_text = 0;",
          "",
          "[Removed Lines]",
          "163: file_buffer(struct magic_set *ms, int fd, const char *inname __attribute__ ((unused)),",
          "",
          "[Added Lines]",
          "164: file_buffer(struct magic_set *ms, int fd, const char *inname __attribute__ ((__unused__)),",
          "",
          "---------------"
        ],
        "src/magic.c||src/magic.c": [
          "File: src/magic.c -> src/magic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include \"file.h\"",
          "35: #ifndef lint",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.90 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "[Added Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.91 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "543: {",
          "544:  switch (param) {",
          "545:  case MAGIC_PARAM_INDIR_MAX:",
          "547:   return 0;",
          "548:  case MAGIC_PARAM_NAME_MAX:",
          "550:   return 0;",
          "551:  case MAGIC_PARAM_ELF_PHNUM_MAX:",
          "553:   return 0;",
          "554:  case MAGIC_PARAM_ELF_SHNUM_MAX:",
          "556:   return 0;",
          "557:  case MAGIC_PARAM_ELF_NOTES_MAX:",
          "559:   return 0;",
          "560:  default:",
          "561:   errno = EINVAL;",
          "",
          "[Removed Lines]",
          "546:   ms->indir_max = *(const size_t *)val;",
          "549:   ms->name_max = *(const size_t *)val;",
          "552:   ms->elf_phnum_max = *(const size_t *)val;",
          "555:   ms->elf_shnum_max = *(const size_t *)val;",
          "558:   ms->elf_notes_max = *(const size_t *)val;",
          "",
          "[Added Lines]",
          "546:   ms->indir_max = (uint16_t)*(const size_t *)val;",
          "549:   ms->name_max = (uint16_t)*(const size_t *)val;",
          "552:   ms->elf_phnum_max = (uint16_t)*(const size_t *)val;",
          "555:   ms->elf_shnum_max = (uint16_t)*(const size_t *)val;",
          "558:   ms->elf_notes_max = (uint16_t)*(const size_t *)val;",
          "",
          "---------------"
        ],
        "src/print.c||src/print.c": [
          "File: src/print.c -> src/print.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include <string.h>",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: print.c,v 1.75 2012/10/30 23:11:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: print.c,v 1.76 2013/02/26 18:25:00 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "164:   case FILE_MELDATE:",
          "165:    (void)fprintf(stderr, \"%s,\",",
          "166:        file_fmttime(m->value.l, 0, tbuf));",
          "167:   case FILE_QDATE:",
          "168:   case FILE_LEQDATE:",
          "169:   case FILE_BEQDATE:",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "167:    break;",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.48 2014/09/10 18:41:51 christos Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.49 2014/12/04 15:56:46 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39: #include \"cdf.h\"",
          "40: #include \"magic.h\"",
          "42: #define NOTMIME(ms) (((ms)->flags & MAGIC_MIME) == 0)",
          "44: static const struct nv {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: #ifndef __arraycount",
          "43: #define __arraycount(a) (sizeof(a) / sizeof(a[0]))",
          "44: #endif",
          "",
          "---------------"
        ],
        "src/readelf.c||src/readelf.c": [
          "File: src/readelf.c -> src/readelf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #ifdef BUILTIN_ELF",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.116 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: readelf.c,v 1.117 2014/12/16 23:29:42 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "622:    return 1;",
          "624:   for (i = 0; i < __arraycount(pax); i++) {",
          "626:     continue;",
          "627:    if (file_printf(ms, \"%s%s\", did++ ? \",\" : \"\",",
          "628:        pax[i]) == -1)",
          "",
          "[Removed Lines]",
          "625:    if (((1 << i) & desc) == 0)",
          "",
          "[Added Lines]",
          "626:    if (((1 << (int)i) & desc) == 0)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1008:  }",
          "1012:   file_badread(ms);",
          "1013:   return -1;",
          "1014:  }",
          "",
          "[Removed Lines]",
          "1011:  if (pread(fd, xsh_addr, xsh_sizeof, off + size * strtab) < (ssize_t)xsh_sizeof) {",
          "",
          "[Added Lines]",
          "1012:  if (pread(fd, xsh_addr, xsh_sizeof, CAST(off_t, (off + size * strtab)))",
          "1013:      < (ssize_t)xsh_sizeof) {",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.205 2015/01/01 04:12:23 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.206 2015/01/01 17:07:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1667:  case FILE_INDIRECT:",
          "1668:   if (m->str_flags & INDIRECT_RELATIVE)",
          "1670:   if (offset == 0)",
          "1671:    return 0;",
          "",
          "[Removed Lines]",
          "1669:    offset += o;",
          "",
          "[Added Lines]",
          "1669:    offset += CAST(uint32_t, o);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "34a2a20178e86bad906200ac68089897930277ea",
      "candidate_info": {
        "commit_hash": "34a2a20178e86bad906200ac68089897930277ea",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/34a2a20178e86bad906200ac68089897930277ea",
        "files": [
          "src/cdf.c"
        ],
        "message": "return error on not finding stream.",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.72 2015/01/05 18:09:40 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.73 2015/01/11 16:58:25 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "751:  int i = cdf_find_stream(dir, name, CDF_DIR_TYPE_USER_STREAM);",
          "753:  if (i <= 0)",
          "756:  d = &dir->dir_tab[i - 1];",
          "757:  return cdf_read_sector_chain(info, h, sat, ssat, sst,",
          "",
          "[Removed Lines]",
          "754:   return i;",
          "",
          "[Added Lines]",
          "754:   return -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b8acc83781d5a24cc5101e525d15efe0482c280d",
      "candidate_info": {
        "commit_hash": "b8acc83781d5a24cc5101e525d15efe0482c280d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/b8acc83781d5a24cc5101e525d15efe0482c280d",
        "files": [
          "src/cdf.c"
        ],
        "message": "Remove loop that kept reading the same offset (Jan Kaluza)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.55 2014/02/27 23:26:17 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.56 2014/05/05 16:11:21 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "932: cdf_unpack_summary_info(const cdf_stream_t *sst, const cdf_header_t *h,",
          "933:     cdf_summary_info_header_t *ssi, cdf_property_info_t **info, size_t *count)",
          "934: {",
          "936:  const cdf_summary_info_header_t *si =",
          "937:      CAST(const cdf_summary_info_header_t *, sst->sst_tab);",
          "938:  const cdf_section_declaration_t *sd =",
          "",
          "[Removed Lines]",
          "935:  size_t i, maxcount;",
          "",
          "[Added Lines]",
          "935:  size_t maxcount;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "947:  ssi->si_os = CDF_TOLE2(si->si_os);",
          "948:  ssi->si_class = si->si_class;",
          "949:  cdf_swap_class(&ssi->si_class);",
          "952:  maxcount = 0;",
          "965:  return 0;",
          "966: }",
          "",
          "[Removed Lines]",
          "950:  ssi->si_count = CDF_TOLE2(si->si_count);",
          "954:  for (i = 0; i < CDF_TOLE4(si->si_count); i++) {",
          "955:   if (i >= CDF_LOOP_LIMIT) {",
          "956:    DPRINTF((\"Unpack summary info loop limit\"));",
          "957:    errno = EFTYPE;",
          "958:    return -1;",
          "959:   }",
          "960:   if (cdf_read_property_info(sst, h, CDF_TOLE4(sd->sd_offset),",
          "961:       info, count, &maxcount) == -1) {",
          "962:    return -1;",
          "963:   }",
          "964:  }",
          "",
          "[Added Lines]",
          "950:  ssi->si_count = CDF_TOLE4(si->si_count);",
          "954:  if (cdf_read_property_info(sst, h, CDF_TOLE4(sd->sd_offset), info,",
          "955:      count, &maxcount) == -1)",
          "956:   return -1;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "209113ac443c82cc7573bb228b68ce1dd9d50f90",
      "candidate_info": {
        "commit_hash": "209113ac443c82cc7573bb228b68ce1dd9d50f90",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/209113ac443c82cc7573bb228b68ce1dd9d50f90",
        "files": [
          "src/cdf.c",
          "src/cdf.h",
          "src/readcdf.c"
        ],
        "message": "add some class id matching (from Christoph Biedl)",
        "before_after_code_files": [
          "src/cdf.c||src/cdf.c",
          "src/cdf.h||src/cdf.h",
          "src/readcdf.c||src/readcdf.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/cdf.c||src/cdf.c"
          ],
          "candidate": [
            "src/cdf.c||src/cdf.c"
          ]
        }
      },
      "candidate_diff": {
        "src/cdf.c||src/cdf.c": [
          "File: src/cdf.c -> src/cdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: #include \"file.h\"",
          "37: #ifndef lint",
          "39: #endif",
          "41: #include <assert.h>",
          "",
          "[Removed Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.53 2013/02/26 16:20:42 christos Exp $\")",
          "",
          "[Added Lines]",
          "38: FILE_RCSID(\"@(#)$File: cdf.c,v 1.54 2014/02/25 20:52:02 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "676: int",
          "677: cdf_read_short_stream(const cdf_info_t *info, const cdf_header_t *h,",
          "679: {",
          "680:  size_t i;",
          "681:  const cdf_directory_t *d;",
          "683:  for (i = 0; i < dir->dir_len; i++)",
          "684:   if (dir->dir_tab[i].d_type == CDF_DIR_TYPE_ROOT_STORAGE)",
          "685:    break;",
          "",
          "[Removed Lines]",
          "678:     const cdf_sat_t *sat, const cdf_dir_t *dir, cdf_stream_t *scn)",
          "",
          "[Added Lines]",
          "678:     const cdf_sat_t *sat, const cdf_dir_t *dir, cdf_stream_t *scn,",
          "679:     const cdf_directory_t **root)",
          "",
          "---------------"
        ],
        "src/cdf.h||src/cdf.h": [
          "File: src/cdf.h -> src/cdf.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "294: int cdf_read_ssat(const cdf_info_t *, const cdf_header_t *, const cdf_sat_t *,",
          "295:     cdf_sat_t *);",
          "296: int cdf_read_short_stream(const cdf_info_t *, const cdf_header_t *,",
          "298: int cdf_read_property_info(const cdf_stream_t *, const cdf_header_t *, uint32_t,",
          "299:     cdf_property_info_t **, size_t *, size_t *);",
          "300: int cdf_read_summary_info(const cdf_info_t *, const cdf_header_t *,",
          "",
          "[Removed Lines]",
          "297:     const cdf_sat_t *, const cdf_dir_t *, cdf_stream_t *);",
          "",
          "[Added Lines]",
          "297:     const cdf_sat_t *, const cdf_dir_t *, cdf_stream_t *,",
          "298:     const cdf_directory_t **);",
          "",
          "---------------"
        ],
        "src/readcdf.c||src/readcdf.c": [
          "File: src/readcdf.c -> src/readcdf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "26: #include \"file.h\"",
          "28: #ifndef lint",
          "30: #endif",
          "32: #include <assert.h>",
          "",
          "[Removed Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.37 2014/01/06 13:41:18 rrt Exp $\")",
          "",
          "[Added Lines]",
          "29: FILE_RCSID(\"@(#)$File: readcdf.c,v 1.38 2014/02/18 11:09:31 kim Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "70:  { NULL,    NULL,   },",
          "71: };",
          "73: private const char *",
          "74: cdf_app_to_mime(const char *vbuf, const struct nv *nv)",
          "75: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73: static const struct cv {",
          "74:  uint64_t clsid[2];",
          "75:  const char *mime;",
          "76: } clsid2mime[] = {",
          "77:  {",
          "78:   { 0x00000000000c1084LLU, 0x46000000000000c0LLU },",
          "79:   \"x-msi\",",
          "80:  }",
          "81: }, clsid2desc[] = {",
          "82:  {",
          "83:   { 0x00000000000c1084LLU, 0x46000000000000c0LLU },",
          "84:   \"MSI Installer\",",
          "85:  },",
          "86: };",
          "88: private const char *",
          "89: cdf_clsid_to_mime(const uint64_t clsid[2], const struct cv *cv)",
          "90: {",
          "91:  size_t i;",
          "92:  for (i = 0; cv[i].mime != NULL; i++) {",
          "93:  printf(\"%llx %llx %llx %llx\\n\",",
          "94:   clsid[0], cv[i].clsid[0], clsid[1], cv[i].clsid[1]);",
          "95:   if (clsid[0] == cv[i].clsid[0] && clsid[1] == cv[i].clsid[1])",
          "96:    return cv[i].mime;",
          "97:  }",
          "98:  return NULL;",
          "99: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "95: private int",
          "96: cdf_file_property_info(struct magic_set *ms, const cdf_property_info_t *info,",
          "98: {",
          "99:         size_t i;",
          "100:         cdf_timestamp_t tp;",
          "",
          "[Removed Lines]",
          "97:     size_t count)",
          "",
          "[Added Lines]",
          "125:     size_t count, const uint64_t clsid[2])",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "104:         const char *s;",
          "105:         int len;",
          "107:         for (i = 0; i < count; i++) {",
          "108:                 cdf_print_property_name(buf, sizeof(buf), info[i].pi_id);",
          "109:                 switch (info[i].pi_type) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "135:         if (!NOTMIME(ms))",
          "136:   str = cdf_clsid_to_mime(clsid, clsid2mime);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "160:                                                     buf, vbuf) == -1)",
          "161:                                                         return -1;",
          "162:                                         }",
          "164:         CDF_PROPERTY_NAME_OF_APPLICATION) {",
          "165:      str = cdf_app_to_mime(vbuf, app2mime);",
          "166:     }",
          "",
          "[Removed Lines]",
          "163:                                 } else if (info[i].pi_id ==",
          "",
          "[Added Lines]",
          "194:                                 } else if (str == NULL && info[i].pi_id ==",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "208: private int",
          "209: cdf_file_summary_info(struct magic_set *ms, const cdf_header_t *h,",
          "211: {",
          "212:         cdf_summary_info_header_t si;",
          "213:         cdf_property_info_t *info;",
          "",
          "[Removed Lines]",
          "210:     const cdf_stream_t *sst)",
          "",
          "[Added Lines]",
          "241:     const cdf_stream_t *sst, const uint64_t clsid[2])",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "218:                 return -1;",
          "220:         if (NOTMIME(ms)) {",
          "221:                 if (file_printf(ms, \"Composite Document File V2 Document\")",
          "222:       == -1)",
          "223:                         return -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "252:   const char *str;",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "245:                                 return -2;",
          "246:                         break;",
          "247:                 }",
          "248:         }",
          "251:         free(info);",
          "253:         return m == -1 ? -2 : m;",
          "254: }",
          "256: protected int",
          "257: file_trycdf(struct magic_set *ms, int fd, const unsigned char *buf,",
          "258:     size_t nbytes)",
          "",
          "[Removed Lines]",
          "250:         m = cdf_file_property_info(ms, info, count);",
          "",
          "[Added Lines]",
          "281:   str = cdf_clsid_to_mime(clsid, clsid2desc);",
          "282:   if (str)",
          "283:                         if (file_printf(ms, \", %s\", str) == -1)",
          "284:     return -2;",
          "287:         m = cdf_file_property_info(ms, info, count, clsid);",
          "293: #ifdef notdef",
          "294: private char *",
          "295: format_clsid(char *buf, size_t len, const uint64_t uuid[2]) {",
          "296:  snprintf(buf, len, \"%.8\" PRIx64 \"-%.4\" PRIx64 \"-%.4\" PRIx64 \"-%.4\"",
          "297:      PRIx64 \"-%.12\" PRIx64,",
          "298:      (uuid[0] >> 32) & (uint64_t)0x000000000ffffffffLLU,",
          "299:      (uuid[0] >> 16) & (uint64_t)0x0000000000000ffffLLU,",
          "300:      (uuid[0] >>  0) & (uint64_t)0x0000000000000ffffLLU,",
          "301:      (uuid[1] >> 48) & (uint64_t)0x0000000000000ffffLLU,",
          "302:      (uuid[1] >>  0) & (uint64_t)0x0000fffffffffffffLLU);",
          "303:  return buf;",
          "304: }",
          "305: #endif",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "298:                 goto out2;",
          "299:         }",
          "302:                 expn = \"Cannot read short stream\";",
          "303:                 goto out3;",
          "304:         }",
          "305: #ifdef CDF_DEBUG",
          "306:         cdf_dump_dir(&info, &h, &sat, &ssat, &sst, &dir);",
          "307: #endif",
          "309:         if ((i = cdf_read_summary_info(&info, &h, &sat, &ssat, &sst, &dir,",
          "310:             &scn)) == -1) {",
          "",
          "[Removed Lines]",
          "301:         if ((i = cdf_read_short_stream(&info, &h, &sat, &dir, &sst)) == -1) {",
          "",
          "[Added Lines]",
          "352:         const cdf_directory_t *root_storage;",
          "353:         if ((i = cdf_read_short_stream(&info, &h, &sat, &dir, &sst,",
          "354:      &root_storage)) == -1) {",
          "361: #ifdef notdef",
          "362:  if (root_storage) {",
          "363:   if (NOTMIME(ms)) {",
          "364:    char clsbuf[128];",
          "365:    if (file_printf(ms, \"CLSID %s, \",",
          "366:        format_clsid(clsbuf, sizeof(clsbuf),",
          "367:        root_storage->d_storage_uuid)) == -1)",
          "368:     return -1;",
          "369:   }",
          "370:  }",
          "371: #endif",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "319: #ifdef CDF_DEBUG",
          "320:         cdf_dump_summary_info(&h, &scn);",
          "321: #endif",
          "323:                 expn = \"Can't expand summary_info\";",
          "324:  if (i == 0) {",
          "325:   const char *str = NULL;",
          "326:   cdf_directory_t *d;",
          "327:   char name[__arraycount(d->d_name)];",
          "328:   size_t j, k;",
          "330:    d = &dir.dir_tab[j];",
          "331:    for (k = 0; k < sizeof(name); k++)",
          "332:     name[k] = (char)cdf_tole2(d->d_name[k]);",
          "339:   }",
          "340:   if (NOTMIME(ms)) {",
          "341:    if (str != NULL) {",
          "",
          "[Removed Lines]",
          "322:         if ((i = cdf_file_summary_info(ms, &h, &scn)) < 0)",
          "329:   for (j = 0; j < dir.dir_len; j++) {",
          "333:    if (NOTMIME(ms))",
          "334:     str = cdf_app_to_mime(name, name2desc);",
          "335:    else",
          "336:     str = cdf_app_to_mime(name, name2mime);",
          "337:    if (str != NULL)",
          "338:     break;",
          "",
          "[Added Lines]",
          "386:         if ((i = cdf_file_summary_info(ms, &h, &scn,",
          "387:      root_storage->d_storage_uuid)) < 0)",
          "396:   for (j = 0; str == NULL && j < dir.dir_len; j++) {",
          "400:    str = cdf_app_to_mime(name,",
          "401:        NOTMIME(ms) ? name2desc : name2mime);",
          "",
          "---------------"
        ]
      }
    }
  ]
}