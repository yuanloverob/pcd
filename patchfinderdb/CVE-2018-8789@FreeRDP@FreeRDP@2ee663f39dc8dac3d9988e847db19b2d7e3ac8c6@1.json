{
  "cve_id": "CVE-2018-8789",
  "cve_desc": "FreeRDP prior to version 2.0.0-rc4 contains several Out-Of-Bounds Reads in the NTLM Authentication module that results in a Denial of Service (segfault).",
  "repo": "FreeRDP/FreeRDP",
  "patch_hash": "2ee663f39dc8dac3d9988e847db19b2d7e3ac8c6",
  "patch_info": {
    "commit_hash": "2ee663f39dc8dac3d9988e847db19b2d7e3ac8c6",
    "repo": "FreeRDP/FreeRDP",
    "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/2ee663f39dc8dac3d9988e847db19b2d7e3ac8c6",
    "files": [
      "winpr/libwinpr/sspi/NTLM/ntlm_message.c"
    ],
    "message": "Fixed CVE-2018-8789\n\nThanks to Eyal Itkin from Check Point Software Technologies.",
    "before_after_code_files": [
      "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c"
    ]
  },
  "patch_diff": {
    "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c": [
      "File: winpr/libwinpr/sspi/NTLM/ntlm_message.c -> winpr/libwinpr/sspi/NTLM/ntlm_message.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "74:  \"NTLMSSP_NEGOTIATE_UNICODE\"",
      "75: };",
      "78: {",
      "79:  int i;",
      "80:  const char* str;",
      "",
      "[Removed Lines]",
      "77: void ntlm_print_negotiate_flags(UINT32 flags)",
      "",
      "[Added Lines]",
      "77: static void ntlm_print_negotiate_flags(UINT32 flags)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "90:  }",
      "91: }",
      "94: {",
      "95:  if (Stream_GetRemainingLength(s) < 12)",
      "96:   return -1;",
      "",
      "[Removed Lines]",
      "93: int ntlm_read_message_header(wStream* s, NTLM_MESSAGE_HEADER* header)",
      "",
      "[Added Lines]",
      "93: static int ntlm_read_message_header(wStream* s, NTLM_MESSAGE_HEADER* header)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "104:  return 1;",
      "105: }",
      "108: {",
      "109:  Stream_Write(s, header->Signature, sizeof(NTLM_SIGNATURE));",
      "110:  Stream_Write_UINT32(s, header->MessageType);",
      "111: }",
      "114: {",
      "115:  CopyMemory(header->Signature, NTLM_SIGNATURE, sizeof(NTLM_SIGNATURE));",
      "116:  header->MessageType = MessageType;",
      "117: }",
      "120: {",
      "121:  if (Stream_GetRemainingLength(s) < 8)",
      "122:   return -1;",
      "",
      "[Removed Lines]",
      "107: void ntlm_write_message_header(wStream* s, NTLM_MESSAGE_HEADER* header)",
      "113: void ntlm_populate_message_header(NTLM_MESSAGE_HEADER* header, UINT32 MessageType)",
      "119: int ntlm_read_message_fields(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "[Added Lines]",
      "107: static void ntlm_write_message_header(wStream* s, NTLM_MESSAGE_HEADER* header)",
      "113: static void ntlm_populate_message_header(NTLM_MESSAGE_HEADER* header, UINT32 MessageType)",
      "119: static int ntlm_read_message_fields(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "127:  return 1;",
      "128: }",
      "131: {",
      "132:  if (fields->MaxLen < 1)",
      "133:   fields->MaxLen = fields->Len;",
      "",
      "[Removed Lines]",
      "130: void ntlm_write_message_fields(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "[Added Lines]",
      "130: static void ntlm_write_message_fields(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "138: }",
      "141: {",
      "142:  if (fields->Len > 0)",
      "143:  {",
      "145:    return -1;",
      "147:   fields->Buffer = (PBYTE) malloc(fields->Len);",
      "",
      "[Removed Lines]",
      "140: int ntlm_read_message_fields_buffer(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "144:   if ((fields->BufferOffset + fields->Len) > Stream_Length(s))",
      "",
      "[Added Lines]",
      "140: static int ntlm_read_message_fields_buffer(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "144:   const UINT64 offset = (UINT64)fields->BufferOffset + (UINT64)fields->Len;",
      "146:   if (offset > Stream_Length(s))",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "156:  return 1;",
      "157: }",
      "160: {",
      "161:  if (fields->Len > 0)",
      "162:  {",
      "",
      "[Removed Lines]",
      "159: void ntlm_write_message_fields_buffer(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "[Added Lines]",
      "161: static void ntlm_write_message_fields_buffer(wStream* s, NTLM_MESSAGE_FIELDS* fields)",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "165:  }",
      "166: }",
      "169: {",
      "170:  if (fields)",
      "171:  {",
      "",
      "[Removed Lines]",
      "168: void ntlm_free_message_fields_buffer(NTLM_MESSAGE_FIELDS* fields)",
      "",
      "[Added Lines]",
      "170: static void ntlm_free_message_fields_buffer(NTLM_MESSAGE_FIELDS* fields)",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "180:  }",
      "181: }",
      "184: {",
      "185:  WLog_DBG(TAG, \"%s (Len: %\"PRIu16\" MaxLen: %\"PRIu16\" BufferOffset: %\"PRIu32\")\",",
      "186:           name, fields->Len, fields->MaxLen, fields->BufferOffset);",
      "",
      "[Removed Lines]",
      "183: void ntlm_print_message_fields(NTLM_MESSAGE_FIELDS* fields, const char* name)",
      "",
      "[Added Lines]",
      "185: static void ntlm_print_message_fields(NTLM_MESSAGE_FIELDS* fields, const char* name)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "eb57ed3a3059cea8576eaa91ccd6b3a3fd959f41",
      "candidate_info": {
        "commit_hash": "eb57ed3a3059cea8576eaa91ccd6b3a3fd959f41",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/eb57ed3a3059cea8576eaa91ccd6b3a3fd959f41",
        "files": [
          "winpr/libwinpr/sspi/NTLM/ntlm.h",
          "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c",
          "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h",
          "winpr/libwinpr/sspi/NTLM/ntlm_compute.c",
          "winpr/libwinpr/sspi/NTLM/ntlm_message.c"
        ],
        "message": "Refactored ntlm_av_pairs API\n\nTightened checks, cleaned up code and improved redability.",
        "before_after_code_files": [
          "winpr/libwinpr/sspi/NTLM/ntlm.h||winpr/libwinpr/sspi/NTLM/ntlm.h",
          "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c||winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c",
          "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h||winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h",
          "winpr/libwinpr/sspi/NTLM/ntlm_compute.c||winpr/libwinpr/sspi/NTLM/ntlm_compute.c",
          "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c"
          ],
          "candidate": [
            "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c"
          ]
        }
      },
      "candidate_diff": {
        "winpr/libwinpr/sspi/NTLM/ntlm.h||winpr/libwinpr/sspi/NTLM/ntlm.h": [
          "File: winpr/libwinpr/sspi/NTLM/ntlm.h -> winpr/libwinpr/sspi/NTLM/ntlm.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "147:  BYTE ClientChallenge[8];",
          "148:  UINT32 Reserved3;",
          "149:  NTLM_AV_PAIR* AvPairs;",
          "150: };",
          "151: typedef struct _NTLMv2_CLIENT_CHALLENGE NTLMv2_CLIENT_CHALLENGE;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "150:  UINT32 cbAvPairs;",
          "",
          "---------------"
        ],
        "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c||winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c": [
          "File: winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c -> winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: #include \"../../log.h\"",
          "40: #define TAG WINPR_TAG(\"sspi.NTLM\")",
          "43: {",
          "44:  \"MsvAvEOL\",",
          "45:  \"MsvAvNbComputerName\",",
          "",
          "[Removed Lines]",
          "42: const char* const AV_PAIR_STRINGS[] =",
          "",
          "[Added Lines]",
          "42: static const char* const AV_PAIR_STRINGS[] =",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "54:  \"MsvChannelBindings\"",
          "55: };",
          "58: {",
          "59:  NTLM_AV_PAIR* pAvPair = pAvPairList;",
          "60:  ntlm_av_pair_set_id(pAvPair, MsvAvEOL);",
          "61:  ntlm_av_pair_set_len(pAvPair, 0);",
          "62: }",
          "65: {",
          "66:  ULONG length;",
          "67:  NTLM_AV_PAIR* pAvPair = pAvPairList;",
          "",
          "[Removed Lines]",
          "57: void ntlm_av_pair_list_init(NTLM_AV_PAIR* pAvPairList)",
          "64: ULONG ntlm_av_pair_list_length(NTLM_AV_PAIR* pAvPairList)",
          "",
          "[Added Lines]",
          "57: static NTLM_AV_PAIR* ntlm_av_pair_get_next_pointer(NTLM_AV_PAIR* pAvPair, size_t* pcbAvPair);",
          "59: static void ntlm_av_pair_set_id(NTLM_AV_PAIR* pAvPair, UINT16 id)",
          "60: {",
          "61:  Data_Write_UINT16(&pAvPair->AvId, id);",
          "62: }",
          "64: static void ntlm_av_pair_set_len(NTLM_AV_PAIR* pAvPair, UINT16 len)",
          "65: {",
          "66:  Data_Write_UINT16(&pAvPair->AvLen, len);",
          "67: }",
          "69: static BOOL ntlm_av_pair_list_init(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairList)",
          "73:  if (!pAvPair || (cbAvPairList < sizeof(NTLM_AV_PAIR)))",
          "74:   return FALSE;",
          "78:  return TRUE;",
          "81: static INLINE UINT16 ntlm_av_pair_get_id(const NTLM_AV_PAIR* pAvPair)",
          "82: {",
          "83:  UINT16 AvId;",
          "85:  if (!pAvPair)",
          "86:   return MsvAvEOL;",
          "88:  Data_Read_UINT16(&pAvPair->AvId, AvId);",
          "89:  return AvId;",
          "90: }",
          "92: ULONG ntlm_av_pair_list_length(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairListMaxLength)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "72:  while (ntlm_av_pair_get_id(pAvPair) != MsvAvEOL)",
          "73:  {",
          "75:  }",
          "77:  length = (pAvPair - pAvPairList) + sizeof(NTLM_AV_PAIR);",
          "78:  return length;",
          "79: }",
          "82: {",
          "83:  NTLM_AV_PAIR* pAvPair = pAvPairList;",
          "",
          "[Removed Lines]",
          "74:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair);",
          "81: void ntlm_print_av_pair_list(NTLM_AV_PAIR* pAvPairList)",
          "",
          "[Added Lines]",
          "102:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair, &cbAvPairListMaxLength);",
          "109: static INLINE SSIZE_T ntlm_av_pair_get_len(const NTLM_AV_PAIR* pAvPair, size_t cbAvPair)",
          "110: {",
          "111:  UINT16 AvLen;",
          "113:  if (!pAvPair || (cbAvPair < sizeof(NTLM_AV_PAIR)))",
          "114:   return -1;",
          "116:  Data_Read_UINT16(&pAvPair->AvLen, AvLen);",
          "118:  if (cbAvPair < sizeof(NTLM_AV_PAIR) + pAvPair->AvLen)",
          "119:   return -1;",
          "121:  return AvLen;",
          "122: }",
          "124: void ntlm_print_av_pair_list(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairList)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "92:   WLog_INFO(TAG, \"\\t%s AvId: %\"PRIu16\" AvLen: %\"PRIu16\"\",",
          "93:             AV_PAIR_STRINGS[ntlm_av_pair_get_id(pAvPair)],",
          "94:             ntlm_av_pair_get_id(pAvPair),",
          "99:  }",
          "100: }",
          "103: {",
          "105:  return ((AvPairsCount + 1) * 4) + AvPairsValueLength;",
          "106: }",
          "109: {",
          "110:  return &((PBYTE) pAvPair)[sizeof(NTLM_AV_PAIR)];",
          "111: }",
          "114: {",
          "116: }",
          "119: {",
          "121: }",
          "124: {",
          "125:  NTLM_AV_PAIR* pAvPair = pAvPairList;",
          "131:  {",
          "132:   if (ntlm_av_pair_get_id(pAvPair) == AvId)",
          "133:    return pAvPair;",
          "135:   if (ntlm_av_pair_get_id(pAvPair) == MsvAvEOL)",
          "136:    return NULL;",
          "139:  }",
          "141:  return NULL;",
          "142: }",
          "146: {",
          "147:  NTLM_AV_PAIR* pAvPair;",
          "150:  if (!pAvPair)",
          "151:   return NULL;",
          "",
          "[Removed Lines]",
          "95:             ntlm_av_pair_get_len(pAvPair));",
          "96:   winpr_HexDump(TAG, WLOG_INFO, ntlm_av_pair_get_value_pointer(pAvPair),",
          "97:                 ntlm_av_pair_get_len(pAvPair));",
          "98:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair);",
          "102: ULONG ntlm_av_pair_list_size(ULONG AvPairsCount, ULONG AvPairsValueLength)",
          "108: PBYTE ntlm_av_pair_get_value_pointer(NTLM_AV_PAIR* pAvPair)",
          "113: int ntlm_av_pair_get_next_offset(NTLM_AV_PAIR* pAvPair)",
          "115:  return ntlm_av_pair_get_len(pAvPair) + sizeof(NTLM_AV_PAIR);",
          "118: NTLM_AV_PAIR* ntlm_av_pair_get_next_pointer(NTLM_AV_PAIR* pAvPair)",
          "120:  return (NTLM_AV_PAIR*)((PBYTE) pAvPair + ntlm_av_pair_get_next_offset(pAvPair));",
          "123: NTLM_AV_PAIR* ntlm_av_pair_get(NTLM_AV_PAIR* pAvPairList, NTLM_AV_ID AvId)",
          "127:  if (!pAvPair)",
          "128:   return NULL;",
          "130:  while (1)",
          "138:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair);",
          "144: NTLM_AV_PAIR* ntlm_av_pair_add(NTLM_AV_PAIR* pAvPairList, NTLM_AV_ID AvId, PBYTE Value,",
          "145:                                UINT16 AvLen)",
          "148:  pAvPair = ntlm_av_pair_get(pAvPairList, MsvAvEOL);",
          "",
          "[Added Lines]",
          "138:             ntlm_av_pair_get_len(pAvPair, cbAvPairList));",
          "139:   winpr_HexDump(TAG, WLOG_INFO, ntlm_av_pair_get_value_pointer(pAvPair, cbAvPairList),",
          "140:                 ntlm_av_pair_get_len(pAvPair, cbAvPairList));",
          "141:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair, &cbAvPairList);",
          "145: static ULONG ntlm_av_pair_list_size(ULONG AvPairsCount, ULONG AvPairsValueLength)",
          "151: PBYTE ntlm_av_pair_get_value_pointer(NTLM_AV_PAIR* pAvPair, size_t cbAvPairListMaxLength)",
          "153:  if (cbAvPairListMaxLength < 2 * sizeof(NTLM_AV_PAIR))",
          "154:   return NULL;",
          "159: static SSIZE_T ntlm_av_pair_get_next_offset(NTLM_AV_PAIR* pAvPair, size_t cbAvPairListMaxLength)",
          "161:  return ntlm_av_pair_get_len(pAvPair, cbAvPairListMaxLength) + sizeof(NTLM_AV_PAIR);",
          "164: NTLM_AV_PAIR* ntlm_av_pair_get_next_pointer(NTLM_AV_PAIR* pAvPair, size_t* pcbAvPair)",
          "166:  SSIZE_T offset;",
          "168:  if (!pAvPair || !pcbAvPair)",
          "169:   return NULL;",
          "171:  offset = ntlm_av_pair_get_next_offset(pAvPair, *pcbAvPair);",
          "173:  if ((offset <= 0) || (offset > *pcbAvPair))",
          "174:   return NULL;",
          "177:  return (NTLM_AV_PAIR*)((PBYTE) pAvPair + offset);",
          "180: NTLM_AV_PAIR* ntlm_av_pair_get(void* pAvPairList,",
          "181:                                size_t avPairListLength,",
          "182:                                NTLM_AV_ID AvId,",
          "183:                                size_t* pcbAvPairListRemainingLength)",
          "187:  if (pcbAvPairListRemainingLength)",
          "190:  while (pAvPair)",
          "193:   {",
          "194:    if (pcbAvPairListRemainingLength)",
          "198:   }",
          "203:   pAvPair = ntlm_av_pair_get_next_pointer(pAvPair, &avPairListLength);",
          "209: static NTLM_AV_PAIR* ntlm_av_pair_add(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairListLength,",
          "210:                                       NTLM_AV_ID AvId, PBYTE Value,",
          "211:                                       UINT16 AvLen)",
          "213:  size_t cbAvPair;",
          "215:  pAvPair = ntlm_av_pair_get(pAvPairList, cbAvPairListLength, MsvAvEOL, &cbAvPair);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "153:  assert(Value != NULL);",
          "154:  ntlm_av_pair_set_id(pAvPair, AvId);",
          "155:  ntlm_av_pair_set_len(pAvPair, AvLen);",
          "157:  return pAvPair;",
          "158: }",
          "161: {",
          "162:  NTLM_AV_PAIR* pAvPairCopy;",
          "165:  if (!pAvPairCopy)",
          "166:   return NULL;",
          "168:  CopyMemory(&pAvPairCopy->AvId, &pAvPair->AvId, 2);",
          "169:  CopyMemory(&pAvPairCopy->AvLen, &pAvPair->AvLen, 2);",
          "173:  return pAvPairCopy;",
          "174: }",
          "177: {",
          "178:  char* name;",
          "179:  int status;",
          "",
          "[Removed Lines]",
          "156:  CopyMemory(ntlm_av_pair_get_value_pointer(pAvPair), Value, AvLen);",
          "160: NTLM_AV_PAIR* ntlm_av_pair_add_copy(NTLM_AV_PAIR* pAvPairList, NTLM_AV_PAIR* pAvPair)",
          "163:  pAvPairCopy = ntlm_av_pair_get(pAvPairList, MsvAvEOL);",
          "170:  CopyMemory(ntlm_av_pair_get_value_pointer(pAvPairCopy),",
          "171:             ntlm_av_pair_get_value_pointer(pAvPair),",
          "172:             ntlm_av_pair_get_len(pAvPair));",
          "176: int ntlm_get_target_computer_name(PUNICODE_STRING pName, COMPUTER_NAME_FORMAT type)",
          "",
          "[Added Lines]",
          "223:  CopyMemory(ntlm_av_pair_get_value_pointer(pAvPair, cbAvPair), Value, AvLen);",
          "227: static NTLM_AV_PAIR* ntlm_av_pair_add_copy(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairListLength,",
          "228:         NTLM_AV_PAIR* pAvPair, size_t cbAvPair)",
          "231:  size_t cbAvPairCopy;",
          "232:  pAvPairCopy = ntlm_av_pair_get(pAvPairList, cbAvPairListLength, MsvAvEOL, &cbAvPairCopy);",
          "239:  CopyMemory(ntlm_av_pair_get_value_pointer(pAvPairCopy, cbAvPairCopy),",
          "240:             ntlm_av_pair_get_value_pointer(pAvPair, cbAvPair),",
          "241:             ntlm_av_pair_get_len(pAvPair, cbAvPair));",
          "245: static int ntlm_get_target_computer_name(PUNICODE_STRING pName, COMPUTER_NAME_FORMAT type)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "219:  return 1;",
          "220: }",
          "223: {",
          "224:  if (string)",
          "225:  {",
          "",
          "[Removed Lines]",
          "222: void ntlm_free_unicode_string(PUNICODE_STRING string)",
          "",
          "[Added Lines]",
          "291: static void ntlm_free_unicode_string(PUNICODE_STRING string)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "271:  return winpr_Digest_Update(md5, be32, 4);",
          "272: }",
          "275: {",
          "276:  WINPR_DIGEST_CTX* md5;",
          "277:  BYTE* ChannelBindingToken;",
          "",
          "[Removed Lines]",
          "274: void ntlm_compute_channel_bindings(NTLM_CONTEXT* context)",
          "",
          "[Added Lines]",
          "343: static void ntlm_compute_channel_bindings(NTLM_CONTEXT* context)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "317:  winpr_Digest_Free(md5);",
          "318: }",
          "321: {",
          "",
          "[Removed Lines]",
          "320: void ntlm_compute_single_host_data(NTLM_CONTEXT* context)",
          "",
          "[Added Lines]",
          "389: static void ntlm_compute_single_host_data(NTLM_CONTEXT* context)",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "337: int ntlm_construct_challenge_target_info(NTLM_CONTEXT* context)",
          "338: {",
          "339:  int length;",
          "340:  ULONG AvPairsCount;",
          "341:  ULONG AvPairsLength;",
          "342:  NTLM_AV_PAIR* pAvPairList;",
          "349:  if (ntlm_get_target_computer_name(&NbDomainName, ComputerNameNetBIOS) < 0)",
          "352:  NbComputerName.Buffer = NULL;",
          "354:  if (ntlm_get_target_computer_name(&NbComputerName, ComputerNameNetBIOS) < 0)",
          "357:  DnsDomainName.Buffer = NULL;",
          "359:  if (ntlm_get_target_computer_name(&DnsDomainName, ComputerNameDnsDomain) < 0)",
          "362:  DnsComputerName.Buffer = NULL;",
          "364:  if (ntlm_get_target_computer_name(&DnsComputerName, ComputerNameDnsHostname) < 0)",
          "367:  AvPairsCount = 5;",
          "368:  AvPairsLength = NbDomainName.Length + NbComputerName.Length +",
          "",
          "[Removed Lines]",
          "343:  UNICODE_STRING NbDomainName;",
          "344:  UNICODE_STRING NbComputerName;",
          "345:  UNICODE_STRING DnsDomainName;",
          "346:  UNICODE_STRING DnsComputerName;",
          "347:  NbDomainName.Buffer = NULL;",
          "350:   return -1;",
          "355:   return -1;",
          "360:   return -1;",
          "365:   return -1;",
          "",
          "[Added Lines]",
          "408:  int rc = -1;",
          "413:  size_t cbAvPairList;",
          "414:  UNICODE_STRING NbDomainName = { 0 };",
          "415:  UNICODE_STRING NbComputerName = { 0 };",
          "416:  UNICODE_STRING DnsDomainName = { 0 };",
          "417:  UNICODE_STRING DnsComputerName = { 0 };",
          "420:   goto fail;",
          "425:   goto fail;",
          "430:   goto fail;",
          "435:   goto fail;",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "370:  length = ntlm_av_pair_list_size(AvPairsCount, AvPairsLength);",
          "372:  if (!sspi_SecBufferAlloc(&context->ChallengeTargetInfo, length))",
          "375:  pAvPairList = (NTLM_AV_PAIR*) context->ChallengeTargetInfo.pvBuffer;",
          "385:  ntlm_free_unicode_string(&NbDomainName);",
          "386:  ntlm_free_unicode_string(&NbComputerName);",
          "387:  ntlm_free_unicode_string(&DnsDomainName);",
          "388:  ntlm_free_unicode_string(&DnsComputerName);",
          "390: }",
          "392: int ntlm_construct_authenticate_target_info(NTLM_CONTEXT* context)",
          "",
          "[Removed Lines]",
          "373:   return -1;",
          "376:  ntlm_av_pair_list_init(pAvPairList);",
          "377:  ntlm_av_pair_add(pAvPairList, MsvAvNbDomainName, (PBYTE) NbDomainName.Buffer, NbDomainName.Length);",
          "378:  ntlm_av_pair_add(pAvPairList, MsvAvNbComputerName, (PBYTE) NbComputerName.Buffer,",
          "379:                   NbComputerName.Length);",
          "380:  ntlm_av_pair_add(pAvPairList, MsvAvDnsDomainName, (PBYTE) DnsDomainName.Buffer,",
          "381:                   DnsDomainName.Length);",
          "382:  ntlm_av_pair_add(pAvPairList, MsvAvDnsComputerName, (PBYTE) DnsComputerName.Buffer,",
          "383:                   DnsComputerName.Length);",
          "384:  ntlm_av_pair_add(pAvPairList, MsvAvTimestamp, context->Timestamp, sizeof(context->Timestamp));",
          "389:  return 1;",
          "",
          "[Added Lines]",
          "443:   goto fail;",
          "446:  cbAvPairList = context->ChallengeTargetInfo.cbBuffer;",
          "448:  if (!ntlm_av_pair_list_init(pAvPairList, cbAvPairList))",
          "449:   goto fail;",
          "451:  if (ntlm_av_pair_add(pAvPairList, cbAvPairList, MsvAvNbDomainName, (PBYTE) NbDomainName.Buffer,",
          "452:                       NbDomainName.Length) == NULL)",
          "453:   goto fail;",
          "455:  if (ntlm_av_pair_add(pAvPairList, cbAvPairList, MsvAvNbComputerName, (PBYTE) NbComputerName.Buffer,",
          "456:                       NbComputerName.Length) == NULL)",
          "457:   goto fail;",
          "459:  if (ntlm_av_pair_add(pAvPairList, cbAvPairList, MsvAvDnsDomainName, (PBYTE) DnsDomainName.Buffer,",
          "460:                       DnsDomainName.Length) == NULL)",
          "461:   goto fail;",
          "463:  if (ntlm_av_pair_add(pAvPairList, cbAvPairList, MsvAvDnsComputerName,",
          "464:                       (PBYTE) DnsComputerName.Buffer,",
          "465:                       DnsComputerName.Length) == NULL)",
          "466:   goto fail;",
          "468:  if (ntlm_av_pair_add(pAvPairList, cbAvPairList, MsvAvTimestamp, context->Timestamp,",
          "469:                       sizeof(context->Timestamp)) == NULL)",
          "470:   goto fail;",
          "472:  rc = 1;",
          "473: fail:",
          "478:  return rc;",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "402:  NTLM_AV_PAIR* AvDnsTreeName;",
          "403:  NTLM_AV_PAIR* ChallengeTargetInfo;",
          "404:  NTLM_AV_PAIR* AuthenticateTargetInfo;",
          "405:  AvPairsCount = 1;",
          "406:  AvPairsValueLength = 0;",
          "407:  ChallengeTargetInfo = (NTLM_AV_PAIR*) context->ChallengeTargetInfo.pvBuffer;",
          "415:  if (AvNbDomainName)",
          "416:  {",
          "419:  }",
          "421:  if (AvNbComputerName)",
          "422:  {",
          "425:  }",
          "427:  if (AvDnsDomainName)",
          "428:  {",
          "431:  }",
          "433:  if (AvDnsComputerName)",
          "434:  {",
          "437:  }",
          "439:  if (AvDnsTreeName)",
          "440:  {",
          "443:  }",
          "",
          "[Removed Lines]",
          "408:  AvNbDomainName = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvNbDomainName);",
          "409:  AvNbComputerName = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvNbComputerName);",
          "410:  AvDnsDomainName = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvDnsDomainName);",
          "411:  AvDnsComputerName = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvDnsComputerName);",
          "412:  AvDnsTreeName = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvDnsTreeName);",
          "413:  AvTimestamp = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvTimestamp);",
          "418:   AvPairsValueLength += ntlm_av_pair_get_len(AvNbDomainName);",
          "424:   AvPairsValueLength += ntlm_av_pair_get_len(AvNbComputerName);",
          "430:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsDomainName);",
          "436:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsComputerName);",
          "442:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsTreeName);",
          "",
          "[Added Lines]",
          "494:  size_t cbAvTimestamp;",
          "495:  size_t cbAvNbDomainName;",
          "496:  size_t cbAvNbComputerName;",
          "497:  size_t cbAvDnsDomainName;",
          "498:  size_t cbAvDnsComputerName;",
          "499:  size_t cbAvDnsTreeName;",
          "500:  size_t cbChallengeTargetInfo;",
          "501:  size_t cbAuthenticateTargetInfo;",
          "505:  cbChallengeTargetInfo = context->ChallengeTargetInfo.cbBuffer;",
          "506:  AvNbDomainName = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvNbDomainName,",
          "507:                                    &cbAvNbDomainName);",
          "508:  AvNbComputerName = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvNbComputerName,",
          "509:                                      &cbAvNbComputerName);",
          "510:  AvDnsDomainName = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvDnsDomainName,",
          "511:                                     &cbAvDnsDomainName);",
          "512:  AvDnsComputerName = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo,",
          "513:                                       MsvAvDnsComputerName,",
          "514:                                       &cbAvDnsComputerName);",
          "515:  AvDnsTreeName = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvDnsTreeName,",
          "516:                                   &cbAvDnsTreeName);",
          "517:  AvTimestamp = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvTimestamp,",
          "518:                                 &cbAvTimestamp);",
          "523:   AvPairsValueLength += ntlm_av_pair_get_len(AvNbDomainName, cbAvNbDomainName);",
          "529:   AvPairsValueLength += ntlm_av_pair_get_len(AvNbComputerName, cbAvNbComputerName);",
          "535:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsDomainName, cbAvDnsDomainName);",
          "541:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsComputerName, cbAvDnsComputerName);",
          "547:   AvPairsValueLength += ntlm_av_pair_get_len(AvDnsTreeName, cbAvDnsTreeName);",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "489:   return -1;",
          "491:  AuthenticateTargetInfo = (NTLM_AV_PAIR*) context->AuthenticateTargetInfo.pvBuffer;",
          "494:  if (AvNbDomainName)",
          "497:  if (AvNbComputerName)",
          "500:  if (AvDnsDomainName)",
          "503:  if (AvDnsComputerName)",
          "506:  if (AvDnsTreeName)",
          "509:  if (AvTimestamp)",
          "512:  if (context->UseMIC)",
          "513:  {",
          "514:   UINT32 flags;",
          "515:   Data_Write_UINT32(&flags, MSV_AV_FLAGS_MESSAGE_INTEGRITY_CHECK);",
          "517:  }",
          "519:  if (context->SendSingleHostData)",
          "520:  {",
          "523:  }",
          "525:  if (!context->SuppressExtendedProtection)",
          "526:  {",
          "529:   if (context->ServicePrincipalName.Length > 0)",
          "530:   {",
          "534:   }",
          "535:  }",
          "537:  if (context->NTLMv2)",
          "538:  {",
          "539:   NTLM_AV_PAIR* AvEOL;",
          "542:  }",
          "544:  return 1;",
          "",
          "[Removed Lines]",
          "492:  ntlm_av_pair_list_init(AuthenticateTargetInfo);",
          "495:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvNbDomainName);",
          "498:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvNbComputerName);",
          "501:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvDnsDomainName);",
          "504:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvDnsComputerName);",
          "507:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvDnsTreeName);",
          "510:   ntlm_av_pair_add_copy(AuthenticateTargetInfo, AvTimestamp);",
          "516:   ntlm_av_pair_add(AuthenticateTargetInfo, MsvAvFlags, (PBYTE) &flags, 4);",
          "521:   ntlm_av_pair_add(AuthenticateTargetInfo, MsvAvSingleHost,",
          "522:                    (PBYTE) &context->SingleHostData, context->SingleHostData.Size);",
          "527:   ntlm_av_pair_add(AuthenticateTargetInfo, MsvChannelBindings, context->ChannelBindingsHash, 16);",
          "531:    ntlm_av_pair_add(AuthenticateTargetInfo, MsvAvTargetName,",
          "532:                     (PBYTE) context->ServicePrincipalName.Buffer,",
          "533:                     context->ServicePrincipalName.Length);",
          "540:   AvEOL = ntlm_av_pair_get(ChallengeTargetInfo, MsvAvEOL);",
          "541:   ZeroMemory((void*) AvEOL, 4);",
          "",
          "[Added Lines]",
          "597:  cbAuthenticateTargetInfo = context->AuthenticateTargetInfo.cbBuffer;",
          "599:  if (!ntlm_av_pair_list_init(AuthenticateTargetInfo, cbAuthenticateTargetInfo))",
          "600:   return -1;",
          "603:  {",
          "604:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo, AvNbDomainName,",
          "605:                             cbAvNbDomainName) == NULL)",
          "606:    return -1;",
          "607:  }",
          "610:  {",
          "611:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo,",
          "612:                             AvNbComputerName, cbAvNbComputerName) == NULL)",
          "613:    return -1;",
          "614:  }",
          "617:  {",
          "618:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo,",
          "619:                             AvDnsDomainName, cbAvDnsDomainName) == NULL)",
          "620:    return -1;",
          "621:  }",
          "624:  {",
          "625:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo,",
          "626:                             AvDnsComputerName, cbAvDnsComputerName) == NULL)",
          "627:    return -1;",
          "628:  }",
          "631:  {",
          "632:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo, AvDnsTreeName,",
          "633:                             cbAvDnsTreeName) == NULL)",
          "634:    return -1;",
          "635:  }",
          "638:  {",
          "639:   if (ntlm_av_pair_add_copy(AuthenticateTargetInfo, cbAuthenticateTargetInfo, AvTimestamp,",
          "640:                             cbAvTimestamp) == NULL)",
          "641:    return -1;",
          "642:  }",
          "649:   if (ntlm_av_pair_add(AuthenticateTargetInfo, cbAuthenticateTargetInfo, MsvAvFlags, (PBYTE) &flags,",
          "650:                        4) == NULL)",
          "651:    return -1;",
          "656:   if (ntlm_av_pair_add(AuthenticateTargetInfo, cbAuthenticateTargetInfo, MsvAvSingleHost,",
          "657:                        (PBYTE) &context->SingleHostData, context->SingleHostData.Size) == NULL)",
          "658:    return -1;",
          "663:   if (ntlm_av_pair_add(AuthenticateTargetInfo, cbAuthenticateTargetInfo, MsvChannelBindings,",
          "664:                        context->ChannelBindingsHash, 16) == NULL)",
          "665:    return -1;",
          "669:    if (ntlm_av_pair_add(AuthenticateTargetInfo,",
          "670:                         cbAuthenticateTargetInfo,",
          "671:                         MsvAvTargetName,",
          "672:                         (PBYTE) context->ServicePrincipalName.Buffer,",
          "673:                         context->ServicePrincipalName.Length) == NULL)",
          "674:     return -1;",
          "681:   AvEOL = ntlm_av_pair_get(ChallengeTargetInfo, cbChallengeTargetInfo, MsvAvEOL, NULL);",
          "683:   if (!AvEOL)",
          "684:    return -1;",
          "686:   ZeroMemory(AvEOL, sizeof(NTLM_AV_PAIR));",
          "",
          "---------------"
        ],
        "winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h||winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h": [
          "File: winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h -> winpr/libwinpr/sspi/NTLM/ntlm_av_pairs.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "25: #include <winpr/stream.h>",
          "55: int ntlm_construct_challenge_target_info(NTLM_CONTEXT* context);",
          "56: int ntlm_construct_authenticate_target_info(NTLM_CONTEXT* context);",
          "",
          "[Removed Lines]",
          "27: void ntlm_av_pair_list_init(NTLM_AV_PAIR* pAvPairList);",
          "28: ULONG ntlm_av_pair_list_length(NTLM_AV_PAIR* pAvPairList);",
          "29: void ntlm_print_av_pair_list(NTLM_AV_PAIR* pAvPairList);",
          "30: ULONG ntlm_av_pair_list_size(ULONG AvPairsCount, ULONG AvPairsValueLength);",
          "31: PBYTE ntlm_av_pair_get_value_pointer(NTLM_AV_PAIR* pAvPair);",
          "32: int ntlm_av_pair_get_next_offset(NTLM_AV_PAIR* pAvPair);",
          "33: NTLM_AV_PAIR* ntlm_av_pair_get_next_pointer(NTLM_AV_PAIR* pAvPair);",
          "34: NTLM_AV_PAIR* ntlm_av_pair_get(NTLM_AV_PAIR* pAvPairList, NTLM_AV_ID AvId);",
          "35: NTLM_AV_PAIR* ntlm_av_pair_add(NTLM_AV_PAIR* pAvPairList, NTLM_AV_ID AvId, PBYTE Value, UINT16 AvLen);",
          "36: NTLM_AV_PAIR* ntlm_av_pair_add_copy(NTLM_AV_PAIR* pAvPairList, NTLM_AV_PAIR* pAvPair);",
          "38: static INLINE UINT16 ntlm_av_pair_get_id(NTLM_AV_PAIR* pAvPair)",
          "39: {",
          "40:  UINT16 AvId;",
          "41:  Data_Read_UINT16(&pAvPair->AvId, AvId);",
          "42:  return AvId;",
          "43: }",
          "45: static INLINE UINT16 ntlm_av_pair_get_len(NTLM_AV_PAIR* pAvPair)",
          "46: {",
          "47:  UINT16 AvLen;",
          "48:  Data_Read_UINT16(&pAvPair->AvLen, AvLen);",
          "49:  return AvLen;",
          "50: }",
          "52: #define ntlm_av_pair_set_id(pAvPair, id) Data_Write_UINT16(&pAvPair->AvId, id)",
          "53: #define ntlm_av_pair_set_len(pAvPair, len) Data_Write_UINT16(&pAvPair->AvLen, len)",
          "",
          "[Added Lines]",
          "27: ULONG ntlm_av_pair_list_length(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairListMaxLength);",
          "28: void ntlm_print_av_pair_list(NTLM_AV_PAIR* pAvPairList, size_t cbAvPairList);",
          "29: PBYTE ntlm_av_pair_get_value_pointer(NTLM_AV_PAIR* pAvPair, size_t cbAvPairListMaxLength);",
          "30: NTLM_AV_PAIR* ntlm_av_pair_get(void* pAvPairList, size_t avPairListLength, NTLM_AV_ID AvId,",
          "31:                                size_t* pcbAvPairListRemainingLength);",
          "",
          "---------------"
        ],
        "winpr/libwinpr/sspi/NTLM/ntlm_compute.c||winpr/libwinpr/sspi/NTLM/ntlm_compute.c": [
          "File: winpr/libwinpr/sspi/NTLM/ntlm_compute.c -> winpr/libwinpr/sspi/NTLM/ntlm_compute.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "132:  Stream_Read(s, challenge->ClientChallenge, 8);",
          "133:  Stream_Read_UINT32(s, challenge->Reserved3);",
          "134:  size = Stream_Length(s) - Stream_GetPosition(s);",
          "137:  if (!challenge->AvPairs)",
          "138:   return -1;",
          "",
          "[Removed Lines]",
          "135:  challenge->AvPairs = (NTLM_AV_PAIR*) malloc(size);",
          "",
          "[Added Lines]",
          "136:  if (size > UINT32_MAX)",
          "137:   return -1;",
          "139:  challenge->cbAvPairs = size;",
          "140:  challenge->AvPairs = (NTLM_AV_PAIR*) malloc(challenge->cbAvPairs);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "151:  Stream_Write(s, challenge->Timestamp, 8);",
          "152:  Stream_Write(s, challenge->ClientChallenge, 8);",
          "153:  Stream_Write_UINT32(s, challenge->Reserved3);",
          "155:  Stream_Write(s, challenge->AvPairs, length);",
          "156:  return 1;",
          "157: }",
          "",
          "[Removed Lines]",
          "154:  length = ntlm_av_pair_list_length(challenge->AvPairs);",
          "",
          "[Added Lines]",
          "159:  length = ntlm_av_pair_list_length(challenge->AvPairs, challenge->cbAvPairs);",
          "",
          "---------------"
        ],
        "winpr/libwinpr/sspi/NTLM/ntlm_message.c||winpr/libwinpr/sspi/NTLM/ntlm_message.c": [
          "File: winpr/libwinpr/sspi/NTLM/ntlm_message.c -> winpr/libwinpr/sspi/NTLM/ntlm_message.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "141: {",
          "142:  if (fields->Len > 0)",
          "143:  {",
          "146:   if (offset > Stream_Length(s))",
          "147:    return -1;",
          "",
          "[Removed Lines]",
          "144:   const UINT64 offset = (UINT64)fields->BufferOffset + (UINT64)fields->Len;",
          "",
          "[Added Lines]",
          "144:   const UINT32 offset = fields->BufferOffset + fields->Len;",
          "146:   if (fields->BufferOffset > UINT32_MAX - fields->Len)",
          "147:    return -1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "448:  if (message->TargetInfo.Len > 0)",
          "449:  {",
          "450:   if (ntlm_read_message_fields_buffer(s, &(message->TargetInfo)) < 0)",
          "451:   {",
          "452:    Stream_Free(s, FALSE);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "453:   size_t cbAvTimestamp;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "456:   context->ChallengeTargetInfo.pvBuffer = message->TargetInfo.Buffer;",
          "457:   context->ChallengeTargetInfo.cbBuffer = message->TargetInfo.Len;",
          "460:   if (AvTimestamp)",
          "461:   {",
          "462:    if (context->NTLMv2)",
          "463:     context->UseMIC = TRUE;",
          "466:   }",
          "467:  }",
          "",
          "[Removed Lines]",
          "458:   AvTimestamp = ntlm_av_pair_get((NTLM_AV_PAIR*) message->TargetInfo.Buffer, MsvAvTimestamp);",
          "465:    CopyMemory(context->ChallengeTimestamp, ntlm_av_pair_get_value_pointer(AvTimestamp), 8);",
          "",
          "[Added Lines]",
          "463:   AvTimestamp = ntlm_av_pair_get(message->TargetInfo.Buffer,",
          "464:                                  message->TargetInfo.Len,",
          "465:                                  MsvAvTimestamp, &cbAvTimestamp);",
          "469:    PBYTE ptr = ntlm_av_pair_get_value_pointer(AvTimestamp, cbAvTimestamp);",
          "471:    if (!ptr)",
          "472:     return SEC_E_INTERNAL_ERROR;",
          "477:    CopyMemory(context->ChallengeTimestamp, ptr, 8);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "787:  if (message->NtChallengeResponse.Len > 0)",
          "788:  {",
          "789:   wStream* snt = Stream_New(message->NtChallengeResponse.Buffer, message->NtChallengeResponse.Len);",
          "791:   if (!snt)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "801:   size_t cbAvFlags;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "808:   context->ChallengeTargetInfo.pvBuffer = (void*) context->NTLMv2Response.Challenge.AvPairs;",
          "809:   context->ChallengeTargetInfo.cbBuffer = message->NtChallengeResponse.Len - (28 + 16);",
          "810:   CopyMemory(context->ClientChallenge, context->NTLMv2Response.Challenge.ClientChallenge, 8);",
          "813:   if (AvFlags)",
          "815:  }",
          "817:  if (ntlm_read_message_fields_buffer(s,",
          "",
          "[Removed Lines]",
          "811:   AvFlags = ntlm_av_pair_get(context->NTLMv2Response.Challenge.AvPairs, MsvAvFlags);",
          "814:    Data_Read_UINT32(ntlm_av_pair_get_value_pointer(AvFlags), flags);",
          "",
          "[Added Lines]",
          "824:   AvFlags = ntlm_av_pair_get(context->NTLMv2Response.Challenge.AvPairs,",
          "825:                              context->NTLMv2Response.Challenge.cbAvPairs,",
          "826:                              MsvAvFlags, &cbAvFlags);",
          "829:    Data_Read_UINT32(ntlm_av_pair_get_value_pointer(AvFlags, cbAvFlags), flags);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1103: SECURITY_STATUS ntlm_server_AuthenticateComplete(NTLM_CONTEXT* context)",
          "1104: {",
          "1105:  UINT32 flags = 0;",
          "1106:  NTLM_AV_PAIR* AvFlags = NULL;",
          "1107:  NTLM_AUTHENTICATE_MESSAGE* message;",
          "1108:  BYTE messageIntegrityCheck[16];",
          "1110:  if (context->state != NTLM_STATE_COMPLETION)",
          "1111:   return SEC_E_OUT_OF_SEQUENCE;",
          "1113:  message = &context->AUTHENTICATE_MESSAGE;",
          "1116:  if (AvFlags)",
          "1120:   return SEC_E_INTERNAL_ERROR;",
          "",
          "[Removed Lines]",
          "1114:  AvFlags = ntlm_av_pair_get(context->NTLMv2Response.Challenge.AvPairs, MsvAvFlags);",
          "1117:   Data_Read_UINT32(ntlm_av_pair_get_value_pointer(AvFlags), flags);",
          "",
          "[Added Lines]",
          "1121:  size_t cbAvFlags;",
          "1126:  if (!context)",
          "1127:   return SEC_E_INVALID_PARAMETER;",
          "1133:  AvFlags = ntlm_av_pair_get(context->NTLMv2Response.Challenge.AvPairs,",
          "1134:                             context->NTLMv2Response.Challenge.cbAvPairs,",
          "1135:                             MsvAvFlags, &cbAvFlags);",
          "1138:   Data_Read_UINT32(ntlm_av_pair_get_value_pointer(AvFlags, cbAvFlags), flags);",
          "",
          "---------------"
        ]
      }
    }
  ]
}