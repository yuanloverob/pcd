{
  "cve_id": "CVE-2021-41204",
  "cve_desc": "TensorFlow is an open source platform for machine learning. In affected versions during TensorFlow's Grappler optimizer phase, constant folding might attempt to deep copy a resource tensor. This results in a segfault, as these tensors are supposed to not change. The fix will be included in TensorFlow 2.7.0. We will also cherrypick this commit on TensorFlow 2.6.1, TensorFlow 2.5.2, and TensorFlow 2.4.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "7731e8dfbe4a56773be5dc94d631611211156659",
  "patch_info": {
    "commit_hash": "7731e8dfbe4a56773be5dc94d631611211156659",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/7731e8dfbe4a56773be5dc94d631611211156659",
    "files": [
      "tensorflow/core/common_runtime/constant_folding.cc"
    ],
    "message": "Don't constant-fold DT_RESOURCE constants.\n\nPiperOrigin-RevId: 391803952\nChange-Id: I0ea3ec31d3e7dfda0f03b4027a237f08d00a3091",
    "before_after_code_files": [
      "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc": [
      "File: tensorflow/core/common_runtime/constant_folding.cc -> tensorflow/core/common_runtime/constant_folding.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "30: #include \"tensorflow/core/framework/log_memory.h\"",
      "31: #include \"tensorflow/core/framework/op_kernel.h\"",
      "32: #include \"tensorflow/core/framework/types.h\"",
      "33: #include \"tensorflow/core/graph/algorithm.h\"",
      "34: #include \"tensorflow/core/graph/node_builder.h\"",
      "35: #include \"tensorflow/core/graph/subgraph.h\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "33: #include \"tensorflow/core/framework/types.pb.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "223:     std::unordered_map<const Node*, std::vector<Tensor>>*",
      "224:         shape_replacement_map) {",
      "225:   if (n->IsConstant()) {",
      "227:   }",
      "228:   if (MaybeReplaceShapeOp(n, shape_map, shape_replacement_map)) {",
      "229:     return true;",
      "",
      "[Removed Lines]",
      "226:     return true;",
      "",
      "[Added Lines]",
      "228:     return n->output_type(0) != DT_RESOURCE;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4102505d421ebcc8e6b730fa2ff5f43afe86ace6",
      "candidate_info": {
        "commit_hash": "4102505d421ebcc8e6b730fa2ff5f43afe86ace6",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/4102505d421ebcc8e6b730fa2ff5f43afe86ace6",
        "files": [
          "tensorflow/core/common_runtime/constant_folding.cc"
        ],
        "message": "Don't constant-fold DT_RESOURCE constants.\n\nPiperOrigin-RevId: 391803952\nChange-Id: I0ea3ec31d3e7dfda0f03b4027a237f08d00a3091",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc": [
          "File: tensorflow/core/common_runtime/constant_folding.cc -> tensorflow/core/common_runtime/constant_folding.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: #include \"tensorflow/core/framework/log_memory.h\"",
          "31: #include \"tensorflow/core/framework/op_kernel.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/graph/algorithm.h\"",
          "34: #include \"tensorflow/core/graph/node_builder.h\"",
          "35: #include \"tensorflow/core/graph/subgraph.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "223:     std::unordered_map<const Node*, std::vector<Tensor>>*",
          "224:         shape_replacement_map) {",
          "225:   if (n->IsConstant()) {",
          "227:   }",
          "228:   if (MaybeReplaceShapeOp(n, shape_map, shape_replacement_map)) {",
          "229:     return true;",
          "",
          "[Removed Lines]",
          "226:     return true;",
          "",
          "[Added Lines]",
          "228:     return n->output_type(0) != DT_RESOURCE;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "be72049d526fa18c139031d4e64b6fc7f45e2dee",
      "candidate_info": {
        "commit_hash": "be72049d526fa18c139031d4e64b6fc7f45e2dee",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/be72049d526fa18c139031d4e64b6fc7f45e2dee",
        "files": [
          "tensorflow/core/common_runtime/constant_folding.cc"
        ],
        "message": "Don't constant-fold DT_RESOURCE constants.\n\nPiperOrigin-RevId: 391803952\nChange-Id: I0ea3ec31d3e7dfda0f03b4027a237f08d00a3091",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc": [
          "File: tensorflow/core/common_runtime/constant_folding.cc -> tensorflow/core/common_runtime/constant_folding.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: #include \"tensorflow/core/framework/log_memory.h\"",
          "31: #include \"tensorflow/core/framework/op_kernel.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/graph/algorithm.h\"",
          "34: #include \"tensorflow/core/graph/node_builder.h\"",
          "35: #include \"tensorflow/core/graph/subgraph.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "223:     std::unordered_map<const Node*, std::vector<Tensor>>*",
          "224:         shape_replacement_map) {",
          "225:   if (n->IsConstant()) {",
          "227:   }",
          "228:   if (MaybeReplaceShapeOp(n, shape_map, shape_replacement_map)) {",
          "229:     return true;",
          "",
          "[Removed Lines]",
          "226:     return true;",
          "",
          "[Added Lines]",
          "228:     return n->output_type(0) != DT_RESOURCE;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e270462c7c6ef29076c32ea3f44b14d10ecad4a1",
      "candidate_info": {
        "commit_hash": "e270462c7c6ef29076c32ea3f44b14d10ecad4a1",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/e270462c7c6ef29076c32ea3f44b14d10ecad4a1",
        "files": [
          "tensorflow/core/common_runtime/constant_folding.cc"
        ],
        "message": "Don't constant-fold DT_RESOURCE constants.\n\nPiperOrigin-RevId: 391803952\nChange-Id: I0ea3ec31d3e7dfda0f03b4027a237f08d00a3091",
        "before_after_code_files": [
          "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ],
          "candidate": [
            "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/common_runtime/constant_folding.cc||tensorflow/core/common_runtime/constant_folding.cc": [
          "File: tensorflow/core/common_runtime/constant_folding.cc -> tensorflow/core/common_runtime/constant_folding.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "30: #include \"tensorflow/core/framework/log_memory.h\"",
          "31: #include \"tensorflow/core/framework/op_kernel.h\"",
          "32: #include \"tensorflow/core/framework/types.h\"",
          "33: #include \"tensorflow/core/graph/algorithm.h\"",
          "34: #include \"tensorflow/core/graph/node_builder.h\"",
          "35: #include \"tensorflow/core/graph/subgraph.h\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "33: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "223:     std::unordered_map<const Node*, std::vector<Tensor>>*",
          "224:         shape_replacement_map) {",
          "225:   if (n->IsConstant()) {",
          "227:   }",
          "228:   if (MaybeReplaceShapeOp(n, shape_map, shape_replacement_map)) {",
          "229:     return true;",
          "",
          "[Removed Lines]",
          "226:     return true;",
          "",
          "[Added Lines]",
          "228:     return n->output_type(0) != DT_RESOURCE;",
          "",
          "---------------"
        ]
      }
    }
  ]
}