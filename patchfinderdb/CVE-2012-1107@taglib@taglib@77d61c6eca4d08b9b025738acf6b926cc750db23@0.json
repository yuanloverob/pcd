{
  "cve_id": "CVE-2012-1107",
  "cve_desc": "The analyzeCurrent function in ape/apeproperties.cpp in TagLib 1.7 and earlier allows context-dependent attackers to cause a denial of service (application crash) via a crafted sampleRate in an ape file, which triggers a divide-by-zero error.",
  "repo": "taglib/taglib",
  "patch_hash": "77d61c6eca4d08b9b025738acf6b926cc750db23",
  "patch_info": {
    "commit_hash": "77d61c6eca4d08b9b025738acf6b926cc750db23",
    "repo": "taglib/taglib",
    "commit_url": "https://github.com/taglib/taglib/commit/77d61c6eca4d08b9b025738acf6b926cc750db23",
    "files": [
      "taglib/ape/apeproperties.cpp"
    ],
    "message": "Make sure to not try dividing by zero",
    "before_after_code_files": [
      "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
    ]
  },
  "patch_diff": {
    "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp": [
      "File: taglib/ape/apeproperties.cpp -> taglib/ape/apeproperties.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "193:   uint blocksPerFrame = header.mid(4, 4).toUInt(false);",
      "194:   uint finalFrameBlocks = header.mid(8, 4).toUInt(false);",
      "195:   uint totalBlocks = totalFrames > 0 ? (totalFrames -  1) * blocksPerFrame + finalFrameBlocks : 0;",
      "197:   d->bitrate = d->length > 0 ? ((d->streamLength * 8L) / d->length) / 1000 : 0;",
      "198: }",
      "",
      "[Removed Lines]",
      "196:   d->length = totalBlocks / d->sampleRate;",
      "",
      "[Added Lines]",
      "196:   d->length = d->sampleRate > 0 ? totalBlocks / d->sampleRate : 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "df1d3e028e467014991cc154caa1f7a313bce969",
      "candidate_info": {
        "commit_hash": "df1d3e028e467014991cc154caa1f7a313bce969",
        "repo": "taglib/taglib",
        "commit_url": "https://github.com/taglib/taglib/commit/df1d3e028e467014991cc154caa1f7a313bce969",
        "files": [
          "taglib/ape/apeproperties.cpp"
        ],
        "message": "Make sure to not try dividing by zero",
        "before_after_code_files": [
          "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
          ],
          "candidate": [
            "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
          ]
        }
      },
      "candidate_diff": {
        "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp": [
          "File: taglib/ape/apeproperties.cpp -> taglib/ape/apeproperties.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "193:   uint blocksPerFrame = header.mid(4, 4).toUInt(false);",
          "194:   uint finalFrameBlocks = header.mid(8, 4).toUInt(false);",
          "195:   uint totalBlocks = totalFrames > 0 ? (totalFrames -  1) * blocksPerFrame + finalFrameBlocks : 0;",
          "197:   d->bitrate = d->length > 0 ? ((d->streamLength * 8L) / d->length) / 1000 : 0;",
          "198: }",
          "",
          "[Removed Lines]",
          "196:   d->length = totalBlocks / d->sampleRate;",
          "",
          "[Added Lines]",
          "196:   d->length = d->sampleRate > 0 ? totalBlocks / d->sampleRate : 0;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "69ac59f5f0b5a9cd546b1aea7b162df8289eb12f",
      "candidate_info": {
        "commit_hash": "69ac59f5f0b5a9cd546b1aea7b162df8289eb12f",
        "repo": "taglib/taglib",
        "commit_url": "https://github.com/taglib/taglib/commit/69ac59f5f0b5a9cd546b1aea7b162df8289eb12f",
        "files": [
          "taglib/ape/apeproperties.cpp",
          "taglib/ape/apeproperties.h",
          "taglib/mpc/mpcproperties.cpp",
          "taglib/mpc/mpcproperties.h",
          "taglib/wavpack/wavpackproperties.cpp",
          "taglib/wavpack/wavpackproperties.h"
        ],
        "message": "Added sampleFrames() to audio properties",
        "before_after_code_files": [
          "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp",
          "taglib/ape/apeproperties.h||taglib/ape/apeproperties.h",
          "taglib/mpc/mpcproperties.cpp||taglib/mpc/mpcproperties.cpp",
          "taglib/mpc/mpcproperties.h||taglib/mpc/mpcproperties.h",
          "taglib/wavpack/wavpackproperties.cpp||taglib/wavpack/wavpackproperties.cpp",
          "taglib/wavpack/wavpackproperties.h||taglib/wavpack/wavpackproperties.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
          ],
          "candidate": [
            "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp"
          ]
        }
      },
      "candidate_diff": {
        "taglib/ape/apeproperties.cpp||taglib/ape/apeproperties.cpp": [
          "File: taglib/ape/apeproperties.cpp -> taglib/ape/apeproperties.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "46:     channels(0),",
          "47:     version(0),",
          "48:     bitsPerSample(0),",
          "49:     file(file),",
          "50:     streamLength(streamLength) {}",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "49:     sampleFrames(0),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "55:   int channels;",
          "56:   int version;",
          "57:   int bitsPerSample;",
          "58:   File *file;",
          "59:   long streamLength;",
          "60: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "59:   uint sampleFrames;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "104:   return d->bitsPerSample;",
          "105: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "109: uint APE::Properties::sampleFrames() const",
          "110: {",
          "111:   return d->sampleFrames;",
          "112: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "192:   uint totalFrames = header.mid(12, 4).toUInt(false);",
          "193:   uint blocksPerFrame = header.mid(4, 4).toUInt(false);",
          "194:   uint finalFrameBlocks = header.mid(8, 4).toUInt(false);",
          "197:   d->bitrate = d->length > 0 ? ((d->streamLength * 8L) / d->length) / 1000 : 0;",
          "198: }",
          "",
          "[Removed Lines]",
          "195:   uint totalBlocks = totalFrames > 0 ? (totalFrames -  1) * blocksPerFrame + finalFrameBlocks : 0;",
          "196:   d->length = d->sampleRate > 0 ? totalBlocks / d->sampleRate : 0;",
          "",
          "[Added Lines]",
          "202:   d->sampleFrames = totalFrames > 0 ? (totalFrames -  1) * blocksPerFrame + finalFrameBlocks : 0;",
          "203:   d->length = d->sampleRate > 0 ? d->sampleFrames / d->sampleRate : 0;",
          "",
          "---------------"
        ],
        "taglib/ape/apeproperties.h||taglib/ape/apeproperties.h": [
          "File: taglib/ape/apeproperties.h -> taglib/ape/apeproperties.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "73:       int bitsPerSample() const;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "74:       uint sampleFrames() const;",
          "",
          "---------------"
        ],
        "taglib/mpc/mpcproperties.cpp||taglib/mpc/mpcproperties.cpp": [
          "File: taglib/mpc/mpcproperties.cpp -> taglib/mpc/mpcproperties.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "43:     length(0),",
          "44:     bitrate(0),",
          "45:     sampleRate(0),",
          "48:   ByteVector data;",
          "49:   long streamLength;",
          "",
          "[Removed Lines]",
          "46:     channels(0) {}",
          "",
          "[Added Lines]",
          "46:     channels(0),",
          "47:     totalFrames(0),",
          "48:     sampleFrames(0) {}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "53:   int bitrate;",
          "54:   int sampleRate;",
          "55:   int channels;",
          "56: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "58:   uint totalFrames;",
          "59:   uint sampleFrames;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "95:   return d->version;",
          "96: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102: uint MPC::Properties::totalFrames() const",
          "103: {",
          "104:   return d->totalFrames;",
          "105: }",
          "107: uint MPC::Properties::sampleFrames() const",
          "108: {",
          "109:   return d->sampleFrames;",
          "110: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "109:   d->version = d->data[3] & 15;",
          "113:   if(d->version >= 7) {",
          "116:     std::bitset<32> flags(TAGLIB_CONSTRUCT_BITSET(d->data.mid(8, 4).toUInt(false)));",
          "117:     d->sampleRate = sftable[flags[17] * 2 + flags[16]];",
          "118:     d->channels = 2;",
          "119:   }",
          "120:   else {",
          "121:     uint headerData = d->data.mid(0, 4).toUInt(false);",
          "",
          "[Removed Lines]",
          "111:   unsigned int frames;",
          "114:     frames = d->data.mid(4, 4).toUInt(false);",
          "",
          "[Added Lines]",
          "126:     d->totalFrames = d->data.mid(4, 4).toUInt(false);",
          "132:     uint gapless = d->data.mid(5, 4).toUInt(false);",
          "133:     bool trueGapless = (gapless >> 31) & 0x0001;",
          "134:     if(trueGapless) {",
          "135:       uint lastFrameSamples = (gapless >> 20) & 0x07FF;",
          "136:       d->sampleFrames = d->totalFrames * 1152 - lastFrameSamples;",
          "137:     }",
          "138:     else",
          "139:       d->sampleFrames = d->totalFrames * 1152 - 576;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "126:     d->channels = 2;",
          "128:     if(d->version >= 5)",
          "130:     else",
          "138:   if(!d->bitrate)",
          "139:     d->bitrate = d->length > 0 ? ((d->streamLength * 8L) / d->length) / 1000 : 0;",
          "",
          "[Removed Lines]",
          "129:       frames = d->data.mid(4, 4).toUInt(false);",
          "131:       frames = d->data.mid(6, 2).toUInt(false);",
          "132:   }",
          "134:   uint samples = frames * 1152 - 576;",
          "136:   d->length = d->sampleRate > 0 ? (samples + (d->sampleRate / 2)) / d->sampleRate : 0;",
          "",
          "[Added Lines]",
          "150:       d->totalFrames = d->data.mid(4, 4).toUInt(false);",
          "152:       d->totalFrames = d->data.mid(6, 2).toUInt(false);",
          "154:     d->sampleFrames = d->totalFrames * 1152 - 576;",
          "155:   }",
          "157:   d->length = d->sampleRate > 0 ? (d->sampleFrames + (d->sampleRate / 2)) / d->sampleRate : 0;",
          "",
          "---------------"
        ],
        "taglib/mpc/mpcproperties.h||taglib/mpc/mpcproperties.h": [
          "File: taglib/mpc/mpcproperties.h -> taglib/mpc/mpcproperties.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:       int mpcVersion() const;",
          "73:     private:",
          "74:       Properties(const Properties &);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "72:       uint totalFrames() const;",
          "73:       uint sampleFrames() const;",
          "",
          "---------------"
        ],
        "taglib/wavpack/wavpackproperties.cpp||taglib/wavpack/wavpackproperties.cpp": [
          "File: taglib/wavpack/wavpackproperties.cpp -> taglib/wavpack/wavpackproperties.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:     channels(0),",
          "49:     version(0),",
          "50:     bitsPerSample(0),",
          "51:     file(0) {}",
          "53:   ByteVector data;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "51:     sampleFrames(0),",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "59:   int channels;",
          "60:   int version;",
          "61:   int bitsPerSample;",
          "62:   File *file;",
          "63: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "63:   uint sampleFrames;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "115:   return d->bitsPerSample;",
          "116: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "120: uint WavPack::Properties::sampleFrames() const",
          "121: {",
          "122:   return d->sampleFrames;",
          "123: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "161:     }",
          "162:   }",
          "163:   d->length = d->sampleRate > 0 ? (samples + (d->sampleRate / 2)) / d->sampleRate : 0;",
          "165:   d->bitrate = d->length > 0 ? ((d->streamLength * 8L) / d->length) / 1000 : 0;",
          "166: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "171:   d->sampleFrames = samples;",
          "",
          "---------------"
        ],
        "taglib/wavpack/wavpackproperties.h||taglib/wavpack/wavpackproperties.h": [
          "File: taglib/wavpack/wavpackproperties.h -> taglib/wavpack/wavpackproperties.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:       int bitsPerSample() const;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "85:       uint sampleFrames() const;",
          "",
          "---------------"
        ]
      }
    }
  ]
}