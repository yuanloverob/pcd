{
  "cve_id": "CVE-2021-37648",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions the code for `tf.raw_ops.SaveV2` does not properly validate the inputs and an attacker can trigger a null pointer dereference. The [implementation](https://github.com/tensorflow/tensorflow/blob/8d72537c6abf5a44103b57b9c2e22c14f5f49698/tensorflow/core/kernels/save_restore_v2_ops.cc) uses `ValidateInputs` to check that the input arguments are valid. This validation would have caught the illegal state represented by the reproducer above. However, the validation uses `OP_REQUIRES` which translates to setting the `Status` object of the current `OpKernelContext` to an error status, followed by an empty `return` statement which just terminates the execution of the function it is present in. However, this does not mean that the kernel execution is finalized: instead, execution continues from the next line in `Compute` that follows the call to `ValidateInputs`. This is equivalent to lacking the validation. We have patched the issue in GitHub commit 9728c60e136912a12d99ca56e106b7cce7af5986. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "9728c60e136912a12d99ca56e106b7cce7af5986",
  "patch_info": {
    "commit_hash": "9728c60e136912a12d99ca56e106b7cce7af5986",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/9728c60e136912a12d99ca56e106b7cce7af5986",
    "files": [
      "tensorflow/core/kernels/save_restore_v2_ops.cc"
    ],
    "message": "Ensure validation sticks in `save_restore_v2_ops.cc`\n\nPiperOrigin-RevId: 387924206\nChange-Id: I6156842eb3230076b5812c0815f3e66bd5241454",
    "before_after_code_files": [
      "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc": [
      "File: tensorflow/core/kernels/save_restore_v2_ops.cc -> tensorflow/core/kernels/save_restore_v2_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "98:     const Tensor& shape_and_slices = context->input(2);",
      "99:     ValidateInputs(true /* is save op */, context, prefix, tensor_names,",
      "100:                    shape_and_slices);",
      "102:     const int kFixedInputs = 3;  // Prefix, tensor names, shape_and_slices.",
      "103:     const int num_tensors = static_cast<int>(tensor_names.NumElements());",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "101:     if (!context->status().ok()) return;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "177:                                         \" expected dtypes.\"));",
      "178:     ValidateInputs(false /* not save op */, context, prefix, tensor_names,",
      "179:                    shape_and_slices);",
      "181:     const string& prefix_string = prefix.scalar<tstring>()();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "181:     if (!context->status().ok()) return;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "190548f9c08530e493933d217b071e5b3d909ea2",
      "candidate_info": {
        "commit_hash": "190548f9c08530e493933d217b071e5b3d909ea2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/190548f9c08530e493933d217b071e5b3d909ea2",
        "files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc"
        ],
        "message": "Ensure validation sticks in `save_restore_v2_ops.cc`\n\nPiperOrigin-RevId: 387924206\nChange-Id: I6156842eb3230076b5812c0815f3e66bd5241454",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc": [
          "File: tensorflow/core/kernels/save_restore_v2_ops.cc -> tensorflow/core/kernels/save_restore_v2_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     const Tensor& shape_and_slices = context->input(2);",
          "99:     ValidateInputs(true /* is save op */, context, prefix, tensor_names,",
          "100:                    shape_and_slices);",
          "102:     const int kFixedInputs = 3;  // Prefix, tensor names, shape_and_slices.",
          "103:     const int num_tensors = static_cast<int>(tensor_names.NumElements());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "101:     if (!context->status().ok()) return;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "156:                                         \" expected dtypes.\"));",
          "157:     ValidateInputs(false /* not save op */, context, prefix, tensor_names,",
          "158:                    shape_and_slices);",
          "160:     const string& prefix_string = prefix.scalar<tstring>()();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "160:     if (!context->status().ok()) return;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b8c55432c71c7a539e41b2a01b7c76427319f7e0",
      "candidate_info": {
        "commit_hash": "b8c55432c71c7a539e41b2a01b7c76427319f7e0",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b8c55432c71c7a539e41b2a01b7c76427319f7e0",
        "files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc"
        ],
        "message": "Ensure validation sticks in `save_restore_v2_ops.cc`\n\nPiperOrigin-RevId: 387924206\nChange-Id: I6156842eb3230076b5812c0815f3e66bd5241454",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc": [
          "File: tensorflow/core/kernels/save_restore_v2_ops.cc -> tensorflow/core/kernels/save_restore_v2_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     const Tensor& shape_and_slices = context->input(2);",
          "99:     ValidateInputs(true /* is save op */, context, prefix, tensor_names,",
          "100:                    shape_and_slices);",
          "102:     const int kFixedInputs = 3;  // Prefix, tensor names, shape_and_slices.",
          "103:     const int num_tensors = static_cast<int>(tensor_names.NumElements());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "101:     if (!context->status().ok()) return;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "177:                                         \" expected dtypes.\"));",
          "178:     ValidateInputs(false /* not save op */, context, prefix, tensor_names,",
          "179:                    shape_and_slices);",
          "181:     const string& prefix_string = prefix.scalar<tstring>()();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "181:     if (!context->status().ok()) return;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3b13a5d1fd3984a999f297ac5377315591c7e675",
      "candidate_info": {
        "commit_hash": "3b13a5d1fd3984a999f297ac5377315591c7e675",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3b13a5d1fd3984a999f297ac5377315591c7e675",
        "files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc"
        ],
        "message": "Ensure validation sticks in `save_restore_v2_ops.cc`\n\nPiperOrigin-RevId: 387924206\nChange-Id: I6156842eb3230076b5812c0815f3e66bd5241454",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc": [
          "File: tensorflow/core/kernels/save_restore_v2_ops.cc -> tensorflow/core/kernels/save_restore_v2_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     const Tensor& shape_and_slices = context->input(2);",
          "99:     ValidateInputs(true /* is save op */, context, prefix, tensor_names,",
          "100:                    shape_and_slices);",
          "102:     const int kFixedInputs = 3;  // Prefix, tensor names, shape_and_slices.",
          "103:     const int num_tensors = static_cast<int>(tensor_names.NumElements());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "101:     if (!context->status().ok()) return;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "177:                                         \" expected dtypes.\"));",
          "178:     ValidateInputs(false /* not save op */, context, prefix, tensor_names,",
          "179:                    shape_and_slices);",
          "181:     const string& prefix_string = prefix.scalar<tstring>()();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "181:     if (!context->status().ok()) return;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "bcec190a882eb0b6b2906958afeb4e9f5de66847",
      "candidate_info": {
        "commit_hash": "bcec190a882eb0b6b2906958afeb4e9f5de66847",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/bcec190a882eb0b6b2906958afeb4e9f5de66847",
        "files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc"
        ],
        "message": "Ensure validation sticks in `save_restore_v2_ops.cc`\n\nPiperOrigin-RevId: 387924206\nChange-Id: I6156842eb3230076b5812c0815f3e66bd5241454",
        "before_after_code_files": [
          "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/save_restore_v2_ops.cc||tensorflow/core/kernels/save_restore_v2_ops.cc": [
          "File: tensorflow/core/kernels/save_restore_v2_ops.cc -> tensorflow/core/kernels/save_restore_v2_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     const Tensor& shape_and_slices = context->input(2);",
          "99:     ValidateInputs(true /* is save op */, context, prefix, tensor_names,",
          "100:                    shape_and_slices);",
          "102:     const int kFixedInputs = 3;  // Prefix, tensor names, shape_and_slices.",
          "103:     const int num_tensors = static_cast<int>(tensor_names.NumElements());",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "101:     if (!context->status().ok()) return;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "177:                                         \" expected dtypes.\"));",
          "178:     ValidateInputs(false /* not save op */, context, prefix, tensor_names,",
          "179:                    shape_and_slices);",
          "181:     const string& prefix_string = prefix.scalar<tstring>()();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "181:     if (!context->status().ok()) return;",
          "",
          "---------------"
        ]
      }
    }
  ]
}