{
  "cve_id": "CVE-2014-5263",
  "cve_desc": "vmstate_xhci_event in hw/usb/hcd-xhci.c in QEMU 1.6.0 does not terminate the list with the VMSTATE_END_OF_LIST macro, which allows attackers to cause a denial of service (out-of-bounds access, infinite loop, and memory corruption) and possibly gain privileges via unspecified vectors.",
  "repo": "qemu/qemu",
  "patch_hash": "3afca1d6d413592c2b78cf28f52fa24a586d8f56",
  "patch_info": {
    "commit_hash": "3afca1d6d413592c2b78cf28f52fa24a586d8f56",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/3afca1d6d413592c2b78cf28f52fa24a586d8f56",
    "files": [
      "hw/usb/hcd-xhci.c"
    ],
    "message": "vmstate_xhci_event: fix unterminated field list\n\n\"vmstate_xhci_event\" was introduced in commit 37352df3 (\"xhci: add live\nmigration support\"), and first released in v1.6.0. The field list in this\nVMSD is not terminated with the VMSTATE_END_OF_LIST() macro.\n\nDuring normal use (ie. migration), the issue is practically invisible,\nbecause the \"vmstate_xhci_event\" object (with the unterminated field list)\nis only ever referenced -- via \"vmstate_xhci_intr\" -- if xhci_er_full()\nreturns true, for the \"ev_buffer\" test. Since that field_exists() check\n(apparently) almost always returns false, we almost never traverse\n\"vmstate_xhci_event\" during migration, which hides the bug.\n\nHowever, Amit's vmstate checker forces recursion into this VMSD as well,\nand the lack of VMSTATE_END_OF_LIST() breaks the field list terminator\ncheck (field->name != NULL) in dump_vmstate_vmsd(). The result is\nundefined behavior, which in my case translates to infinite recursion\n(because the loop happens to overflow into \"vmstate_xhci_intr\", which then\nlinks back to \"vmstate_xhci_event\").\n\nAdd the missing terminator.\n\nSigned-off-by: Laszlo Ersek <lersek@redhat.com>\nReviewed-by: Amit Shah <amit.shah@redhat.com>\nReviewed-by: Paolo Bonzini <pbonzini@redhat.com>\nCc: qemu-stable@nongnu.org\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>",
    "before_after_code_files": [
      "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
    ]
  },
  "patch_diff": {
    "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c": [
      "File: hw/usb/hcd-xhci.c -> hw/usb/hcd-xhci.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3737:         VMSTATE_UINT32(flags,  XHCIEvent),",
      "3738:         VMSTATE_UINT8(slotid,  XHCIEvent),",
      "3739:         VMSTATE_UINT8(epid,    XHCIEvent),",
      "3740:     }",
      "3741: };",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "3740:         VMSTATE_END_OF_LIST()",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "750f169519ded18e497c1ac11c2db7e0cbc8c316",
      "candidate_info": {
        "commit_hash": "750f169519ded18e497c1ac11c2db7e0cbc8c316",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/750f169519ded18e497c1ac11c2db7e0cbc8c316",
        "files": [
          "hw/usb/hcd-xhci.c"
        ],
        "message": "vmstate_xhci_event: fix unterminated field list\n\n\"vmstate_xhci_event\" was introduced in commit 37352df3 (\"xhci: add live\nmigration support\"), and first released in v1.6.0. The field list in this\nVMSD is not terminated with the VMSTATE_END_OF_LIST() macro.\n\nDuring normal use (ie. migration), the issue is practically invisible,\nbecause the \"vmstate_xhci_event\" object (with the unterminated field list)\nis only ever referenced -- via \"vmstate_xhci_intr\" -- if xhci_er_full()\nreturns true, for the \"ev_buffer\" test. Since that field_exists() check\n(apparently) almost always returns false, we almost never traverse\n\"vmstate_xhci_event\" during migration, which hides the bug.\n\nHowever, Amit's vmstate checker forces recursion into this VMSD as well,\nand the lack of VMSTATE_END_OF_LIST() breaks the field list terminator\ncheck (field->name != NULL) in dump_vmstate_vmsd(). The result is\nundefined behavior, which in my case translates to infinite recursion\n(because the loop happens to overflow into \"vmstate_xhci_intr\", which then\nlinks back to \"vmstate_xhci_event\").\n\nAdd the missing terminator.\n\nSigned-off-by: Laszlo Ersek <lersek@redhat.com>\nReviewed-by: Amit Shah <amit.shah@redhat.com>\nReviewed-by: Paolo Bonzini <pbonzini@redhat.com>\nCc: qemu-stable@nongnu.org\nSigned-off-by: Peter Maydell <peter.maydell@linaro.org>\n(cherry picked from commit 3afca1d6d413592c2b78cf28f52fa24a586d8f56)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
          ],
          "candidate": [
            "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c"
          ]
        }
      },
      "candidate_diff": {
        "hw/usb/hcd-xhci.c||hw/usb/hcd-xhci.c": [
          "File: hw/usb/hcd-xhci.c -> hw/usb/hcd-xhci.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3703:         VMSTATE_UINT32(flags,  XHCIEvent),",
          "3704:         VMSTATE_UINT8(slotid,  XHCIEvent),",
          "3705:         VMSTATE_UINT8(epid,    XHCIEvent),",
          "3706:     }",
          "3707: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3706:         VMSTATE_END_OF_LIST()",
          "",
          "---------------"
        ]
      }
    }
  ]
}