{
  "cve_id": "CVE-2020-13397",
  "cve_desc": "An issue was discovered in FreeRDP before 2.1.1. An out-of-bounds (OOB) read vulnerability has been detected in security_fips_decrypt in libfreerdp/core/security.c due to an uninitialized value.",
  "repo": "FreeRDP/FreeRDP",
  "patch_hash": "d6cd14059b257318f176c0ba3ee0a348826a9ef8",
  "patch_info": {
    "commit_hash": "d6cd14059b257318f176c0ba3ee0a348826a9ef8",
    "repo": "FreeRDP/FreeRDP",
    "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/d6cd14059b257318f176c0ba3ee0a348826a9ef8",
    "files": [
      "libfreerdp/core/security.c"
    ],
    "message": "Fixed GHSL-2020-101 missing NULL check\n\n(cherry picked from commit b207dbba35c505bbc3ad5aadc10b34980c6b7e8e)",
    "before_after_code_files": [
      "libfreerdp/core/security.c||libfreerdp/core/security.c"
    ]
  },
  "patch_diff": {
    "libfreerdp/core/security.c||libfreerdp/core/security.c": [
      "File: libfreerdp/core/security.c -> libfreerdp/core/security.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "816: {",
      "817:  size_t olen;",
      "819:  if (!winpr_Cipher_Update(rdp->fips_decrypt, data, length, data, &olen))",
      "820:   return FALSE;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "819:  if (!rdp || !rdp->fips_decrypt)",
      "820:   return FALSE;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "449b45e84055938bdcd7e31ae0c2d42aa576be12",
      "candidate_info": {
        "commit_hash": "449b45e84055938bdcd7e31ae0c2d42aa576be12",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/449b45e84055938bdcd7e31ae0c2d42aa576be12",
        "files": [
          "winpr/include/winpr/bitstream.h"
        ],
        "message": "Fixed BehaviorSantizer warnings.\n\n(cherry picked from commit 7a509fe27749e006a9a58854c4abb4522fc58c81)",
        "before_after_code_files": [
          "winpr/include/winpr/bitstream.h||winpr/include/winpr/bitstream.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "winpr/include/winpr/bitstream.h||winpr/include/winpr/bitstream.h": [
          "File: winpr/include/winpr/bitstream.h -> winpr/include/winpr/bitstream.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:  {",
          "53:   (_bs->prefetch) = 0;",
          "54:   if (((UINT32)(_bs->pointer - _bs->buffer) + 4) < (_bs->capacity))",
          "56:   if (((UINT32)(_bs->pointer - _bs->buffer) + 5) < (_bs->capacity))",
          "58:   if (((UINT32)(_bs->pointer - _bs->buffer) + 6) < (_bs->capacity))",
          "60:   if (((UINT32)(_bs->pointer - _bs->buffer) + 7) < (_bs->capacity))",
          "62:  }",
          "64:  static INLINE void BitStream_Fetch(wBitStream* _bs)",
          "65:  {",
          "66:   (_bs->accumulator) = 0;",
          "67:   if (((UINT32)(_bs->pointer - _bs->buffer) + 0) < (_bs->capacity))",
          "69:   if (((UINT32)(_bs->pointer - _bs->buffer) + 1) < (_bs->capacity))",
          "71:   if (((UINT32)(_bs->pointer - _bs->buffer) + 2) < (_bs->capacity))",
          "73:   if (((UINT32)(_bs->pointer - _bs->buffer) + 3) < (_bs->capacity))",
          "75:   BitStream_Prefetch(_bs);",
          "76:  }",
          "78:  static INLINE void BitStream_Flush(wBitStream* _bs)",
          "79:  {",
          "80:   if (((UINT32)(_bs->pointer - _bs->buffer) + 0) < (_bs->capacity))",
          "82:   if (((UINT32)(_bs->pointer - _bs->buffer) + 1) < (_bs->capacity))",
          "84:   if (((UINT32)(_bs->pointer - _bs->buffer) + 2) < (_bs->capacity))",
          "86:   if (((UINT32)(_bs->pointer - _bs->buffer) + 3) < (_bs->capacity))",
          "88:  }",
          "90:  static INLINE void BitStream_Shift(wBitStream* _bs, UINT32 _nbits)",
          "",
          "[Removed Lines]",
          "55:    (_bs->prefetch) |= (*(_bs->pointer + 4) << 24);",
          "57:    (_bs->prefetch) |= (*(_bs->pointer + 5) << 16);",
          "59:    (_bs->prefetch) |= (*(_bs->pointer + 6) << 8);",
          "61:    (_bs->prefetch) |= (*(_bs->pointer + 7) << 0);",
          "68:    (_bs->accumulator) |= (*(_bs->pointer + 0) << 24);",
          "70:    (_bs->accumulator) |= (*(_bs->pointer + 1) << 16);",
          "72:    (_bs->accumulator) |= (*(_bs->pointer + 2) << 8);",
          "74:    (_bs->accumulator) |= (*(_bs->pointer + 3) << 0);",
          "",
          "[Added Lines]",
          "55:    (_bs->prefetch) |= ((UINT32) * (_bs->pointer + 4) << 24);",
          "57:    (_bs->prefetch) |= ((UINT32) * (_bs->pointer + 5) << 16);",
          "59:    (_bs->prefetch) |= ((UINT32) * (_bs->pointer + 6) << 8);",
          "61:    (_bs->prefetch) |= ((UINT32) * (_bs->pointer + 7) << 0);",
          "68:    (_bs->accumulator) |= ((UINT32) * (_bs->pointer + 0) << 24);",
          "70:    (_bs->accumulator) |= ((UINT32) * (_bs->pointer + 1) << 16);",
          "72:    (_bs->accumulator) |= ((UINT32) * (_bs->pointer + 2) << 8);",
          "74:    (_bs->accumulator) |= ((UINT32) * (_bs->pointer + 3) << 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "99:    _bs->offset += _nbits;",
          "100:    if (_bs->offset < 32)",
          "101:    {",
          "103:     _bs->accumulator |= ((_bs->prefetch >> (32 - _nbits)) & _bs->mask);",
          "104:     _bs->prefetch <<= _nbits;",
          "105:    }",
          "106:    else",
          "107:    {",
          "109:     _bs->accumulator |= ((_bs->prefetch >> (32 - _nbits)) & _bs->mask);",
          "110:     _bs->prefetch <<= _nbits;",
          "111:     _bs->offset -= 32;",
          "",
          "[Removed Lines]",
          "102:     _bs->mask = ((1 << _nbits) - 1);",
          "108:     _bs->mask = ((1 << _nbits) - 1);",
          "",
          "[Added Lines]",
          "102:     _bs->mask = ((1UL << _nbits) - 1);",
          "108:     _bs->mask = ((1UL << _nbits) - 1);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "113:     BitStream_Prefetch(_bs);",
          "114:     if (_bs->offset)",
          "115:     {",
          "117:      _bs->accumulator |= ((_bs->prefetch >> (32 - _bs->offset)) & _bs->mask);",
          "118:      _bs->prefetch <<= _bs->offset;",
          "119:     }",
          "",
          "[Removed Lines]",
          "116:      _bs->mask = ((1 << _bs->offset) - 1);",
          "",
          "[Added Lines]",
          "116:      _bs->mask = ((1UL << _bs->offset) - 1);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "149:    _bs->pointer += 4;",
          "150:    if (_bs->offset)",
          "151:    {",
          "153:     _bs->accumulator |= ((_bits & _bs->mask) << (32 - _bs->offset));",
          "154:    }",
          "155:   }",
          "",
          "[Removed Lines]",
          "152:     _bs->mask = ((1 << _bs->offset) - 1);",
          "",
          "[Added Lines]",
          "152:     _bs->mask = ((1UL << _bs->offset) - 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "228d16a8689e9e8c9ca0aacaa3d4acf607200c04",
      "candidate_info": {
        "commit_hash": "228d16a8689e9e8c9ca0aacaa3d4acf607200c04",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/228d16a8689e9e8c9ca0aacaa3d4acf607200c04",
        "files": [
          "server/proxy/freerdp_proxy.c"
        ],
        "message": "server: proxy: Register signal handler after modules finished loading.\n\nThis prevents a race where the signal handler free's structs that\nmodules use while initializing.\n\n(cherry picked from commit 42d99f4c6070a984afc43ec7e85650dc4e624af8)",
        "before_after_code_files": [
          "server/proxy/freerdp_proxy.c||server/proxy/freerdp_proxy.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "server/proxy/freerdp_proxy.c||server/proxy/freerdp_proxy.c": [
          "File: server/proxy/freerdp_proxy.c -> server/proxy/freerdp_proxy.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "94:  if (argc >= 2)",
          "95:   config_path = argv[1];",
          "99:  config = pf_server_config_load(config_path);",
          "100:  if (!config)",
          "101:   goto fail;",
          "",
          "[Removed Lines]",
          "97:  pf_server_register_signal_handlers();",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "113:  if (!is_all_required_modules_loaded(config))",
          "114:   goto fail;",
          "116:  server = pf_server_new(config);",
          "117:  if (!server)",
          "118:   goto fail;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "114:  pf_server_register_signal_handlers();",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f2d836cd94c79f14542ef8e7dec7aa969fbead08",
      "candidate_info": {
        "commit_hash": "f2d836cd94c79f14542ef8e7dec7aa969fbead08",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/f2d836cd94c79f14542ef8e7dec7aa969fbead08",
        "files": [
          "libfreerdp/core/test/TestConnect.c"
        ],
        "message": "Fixed memory leak in test\n\n(cherry picked from commit 2d630cccf7b1e566f99b74a224805fc25f85d6c1)",
        "before_after_code_files": [
          "libfreerdp/core/test/TestConnect.c||libfreerdp/core/test/TestConnect.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/core/test/TestConnect.c||libfreerdp/core/test/TestConnect.c": [
          "File: libfreerdp/core/test/TestConnect.c -> libfreerdp/core/test/TestConnect.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "181:  path = GetCombinedPath(exe, \"Sample\");",
          "182:  wpath = GetCombinedPath(wexe, \"Sample\");",
          "184:  if (!path || !wpath)",
          "185:   goto fail;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:  free(exe);",
          "184:  exe = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "227: fail:",
          "228:  free(exe);",
          "229:  free(path);",
          "230:  free(wpath);",
          "231:  free(commandLine);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "231:  free(wexe);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "efecbf41a921e11f409789e2892e29e30bb225d2",
      "candidate_info": {
        "commit_hash": "efecbf41a921e11f409789e2892e29e30bb225d2",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/efecbf41a921e11f409789e2892e29e30bb225d2",
        "files": [
          "libfreerdp/core/gateway/http.c",
          "libfreerdp/core/proxy.c",
          "winpr/libwinpr/timezone/timezone.c"
        ],
        "message": "change use of strtok to strtok_s\n\n(cherry picked from commit 6013a96bff20affbb4c0a1780d35a751eafa4903)",
        "before_after_code_files": [
          "libfreerdp/core/gateway/http.c||libfreerdp/core/gateway/http.c",
          "libfreerdp/core/proxy.c||libfreerdp/core/proxy.c",
          "winpr/libwinpr/timezone/timezone.c||winpr/libwinpr/timezone/timezone.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/core/gateway/http.c||libfreerdp/core/gateway/http.c": [
          "File: libfreerdp/core/gateway/http.c -> libfreerdp/core/gateway/http.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "814:   size_t count = 0;",
          "815:   char* buffer = (char*)Stream_Buffer(response->data);",
          "816:   char* line = (char*)Stream_Buffer(response->data);",
          "818:   while ((line = string_strnstr(line, \"\\r\\n\", payloadOffset - (line - buffer) - 2UL)))",
          "819:   {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "817:   char* context = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "834:   buffer[payloadOffset - 1] = '\\0';",
          "835:   buffer[payloadOffset - 2] = '\\0';",
          "836:   count = 0;",
          "839:   while (line && (response->count > count))",
          "840:   {",
          "841:    response->lines[count] = line;",
          "843:    count++;",
          "844:   }",
          "",
          "[Removed Lines]",
          "837:   line = strtok(buffer, \"\\r\\n\");",
          "842:    line = strtok(NULL, \"\\r\\n\");",
          "",
          "[Added Lines]",
          "838:   line = strtok_s(buffer, \"\\r\\n\", &context);",
          "843:    line = strtok_s(NULL, \"\\r\\n\", &context);",
          "",
          "---------------"
        ],
        "libfreerdp/core/proxy.c||libfreerdp/core/proxy.c": [
          "File: libfreerdp/core/proxy.c -> libfreerdp/core/proxy.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "144:  BOOL result = FALSE;",
          "145:  char* current;",
          "146:  char* copy;",
          "147:  size_t host_len;",
          "148:  struct sockaddr_in sa4;",
          "149:  struct sockaddr_in6 sa6;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "147:  char* context = NULL;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "164:  if (!copy)",
          "165:   return FALSE;",
          "169:  while (current && !result)",
          "170:  {",
          "",
          "[Removed Lines]",
          "167:  current = strtok(copy, delimiter);",
          "",
          "[Added Lines]",
          "168:  current = strtok_s(copy, delimiter, &context);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "243:    }",
          "244:   }",
          "247:  }",
          "249:  free(copy);",
          "",
          "[Removed Lines]",
          "246:   current = strtok(NULL, delimiter);",
          "",
          "[Added Lines]",
          "247:   current = strtok_s(NULL, delimiter, &context);",
          "",
          "---------------"
        ],
        "winpr/libwinpr/timezone/timezone.c||winpr/libwinpr/timezone/timezone.c": [
          "File: winpr/libwinpr/timezone/timezone.c -> winpr/libwinpr/timezone/timezone.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "248: {",
          "249:  char* p;",
          "250:  char* list_copy;",
          "251:  list_copy = _strdup(list);",
          "253:  if (!list_copy)",
          "254:   return FALSE;",
          "258:  while (p != NULL)",
          "259:  {",
          "",
          "[Removed Lines]",
          "256:  p = strtok(list_copy, \" \");",
          "",
          "[Added Lines]",
          "251:  char* context = NULL;",
          "258:  p = strtok_s(list_copy, \" \", &context);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "263:    return TRUE;",
          "264:   }",
          "267:  }",
          "269:  free(list_copy);",
          "",
          "[Removed Lines]",
          "266:   p = strtok(NULL, \" \");",
          "",
          "[Added Lines]",
          "268:   p = strtok_s(NULL, \" \", &context);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
      "candidate_info": {
        "commit_hash": "ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
        "files": [
          "libfreerdp/core/nla.c"
        ],
        "message": "Fixed some more resource cleanup leaks in nla\n\n(cherry picked from commit 354bb7d6ae98df282775d154b609a39c1068a09b)",
        "before_after_code_files": [
          "libfreerdp/core/nla.c||libfreerdp/core/nla.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/core/nla.c||libfreerdp/core/nla.c": [
          "File: libfreerdp/core/nla.c -> libfreerdp/core/nla.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1144:  const BOOL ntlm = (_tcsncmp(nla->packageName, NTLM_SSP_NAME, ARRAYSIZE(NTLM_SSP_NAME)) == 0);",
          "1145:  public_key_length = nla->PublicKey.cbBuffer;",
          "1147:  if (!sspi_SecBufferAlloc(&nla->pubKeyAuth,",
          "1148:                           public_key_length + nla->ContextSizes.cbSecurityTrailer))",
          "1149:   return SEC_E_INSUFFICIENT_MEMORY;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1147:  sspi_SecBufferFree(&nla->pubKeyAuth);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2465:  sspi_SecBufferFree(&nla->tsCredentials);",
          "2466:  free(nla->ServicePrincipalName);",
          "2467:  nla_identity_free(nla->identity);",
          "2468:  free(nla);",
          "2469: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2469:  nla_buffer_free(nla);",
          "",
          "---------------"
        ]
      }
    }
  ]
}