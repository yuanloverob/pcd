{
  "cve_id": "CVE-2022-29197",
  "cve_desc": "TensorFlow is an open source platform for machine learning. Prior to versions 2.9.0, 2.8.1, 2.7.2, and 2.6.4, the implementation of `tf.raw_ops.UnsortedSegmentJoin` does not fully validate the input arguments. This results in a `CHECK`-failure which can be used to trigger a denial of service attack. The code assumes `num_segments` is a scalar but there is no validation for this before accessing its value. Versions 2.9.0, 2.8.1, 2.7.2, and 2.6.4 contain a patch for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "13d38a07ce9143e044aa737cfd7bb759d0e9b400",
  "patch_info": {
    "commit_hash": "13d38a07ce9143e044aa737cfd7bb759d0e9b400",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/13d38a07ce9143e044aa737cfd7bb759d0e9b400",
    "files": [
      "tensorflow/core/kernels/unsorted_segment_join_op.cc"
    ],
    "message": "Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.\n\nCheck that input is actually a scalar before treating it as such.\n\nPiperOrigin-RevId: 445206880",
    "before_after_code_files": [
      "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc": [
      "File: tensorflow/core/kernels/unsorted_segment_join_op.cc -> tensorflow/core/kernels/unsorted_segment_join_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "92:     const Tensor& num_segments_tensor = context->input(2);",
      "93:     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,",
      "94:                 errors::InvalidArgument(\"Number of segments cannot be empty.\"));",
      "95:     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();",
      "97:     OP_REQUIRES(",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "95:     OP_REQUIRES(context,",
      "96:                 TensorShapeUtils::IsScalar(num_segments_tensor.shape()),",
      "97:                 errors::InvalidArgument(\"Number of segments must be a scalar\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7241eccf00d4fea84f54f94c5f30ad13c38c0265",
      "candidate_info": {
        "commit_hash": "7241eccf00d4fea84f54f94c5f30ad13c38c0265",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/7241eccf00d4fea84f54f94c5f30ad13c38c0265",
        "files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ],
        "message": "Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.\n\nCheck that input is actually a scalar before treating it as such.\n\nPiperOrigin-RevId: 445206880",
        "before_after_code_files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc": [
          "File: tensorflow/core/kernels/unsorted_segment_join_op.cc -> tensorflow/core/kernels/unsorted_segment_join_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:     const Tensor& num_segments_tensor = context->input(2);",
          "93:     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,",
          "94:                 errors::InvalidArgument(\"Number of segments cannot be empty.\"));",
          "95:     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();",
          "97:     OP_REQUIRES(context, segment_dims != 0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     OP_REQUIRES(context,",
          "96:                 TensorShapeUtils::IsScalar(num_segments_tensor.shape()),",
          "97:                 errors::InvalidArgument(\"Number of segments must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0a7bd116bf29dccde91d0dea6d209fe6d592bd32",
      "candidate_info": {
        "commit_hash": "0a7bd116bf29dccde91d0dea6d209fe6d592bd32",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0a7bd116bf29dccde91d0dea6d209fe6d592bd32",
        "files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ],
        "message": "Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.\n\nCheck that input is actually a scalar before treating it as such.\n\nPiperOrigin-RevId: 445206880",
        "before_after_code_files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc": [
          "File: tensorflow/core/kernels/unsorted_segment_join_op.cc -> tensorflow/core/kernels/unsorted_segment_join_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:     const Tensor& num_segments_tensor = context->input(2);",
          "93:     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,",
          "94:                 errors::InvalidArgument(\"Number of segments cannot be empty.\"));",
          "95:     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();",
          "97:     OP_REQUIRES(context, segment_dims != 0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     OP_REQUIRES(context,",
          "96:                 TensorShapeUtils::IsScalar(num_segments_tensor.shape()),",
          "97:                 errors::InvalidArgument(\"Number of segments must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2e17289aeb245914710d7be2a4019b68a1569d1d",
      "candidate_info": {
        "commit_hash": "2e17289aeb245914710d7be2a4019b68a1569d1d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/2e17289aeb245914710d7be2a4019b68a1569d1d",
        "files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ],
        "message": "Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.\n\nCheck that input is actually a scalar before treating it as such.\n\nPiperOrigin-RevId: 445206880",
        "before_after_code_files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc": [
          "File: tensorflow/core/kernels/unsorted_segment_join_op.cc -> tensorflow/core/kernels/unsorted_segment_join_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:     const Tensor& num_segments_tensor = context->input(2);",
          "93:     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,",
          "94:                 errors::InvalidArgument(\"Number of segments cannot be empty.\"));",
          "95:     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();",
          "97:     OP_REQUIRES(context, segment_dims != 0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     OP_REQUIRES(context,",
          "96:                 TensorShapeUtils::IsScalar(num_segments_tensor.shape()),",
          "97:                 errors::InvalidArgument(\"Number of segments must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "db6b81e110fb192e93c7c4ef1bdeda9545de1049",
      "candidate_info": {
        "commit_hash": "db6b81e110fb192e93c7c4ef1bdeda9545de1049",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/db6b81e110fb192e93c7c4ef1bdeda9545de1049",
        "files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ],
        "message": "Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.\n\nCheck that input is actually a scalar before treating it as such.\n\nPiperOrigin-RevId: 445206880",
        "before_after_code_files": [
          "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/unsorted_segment_join_op.cc||tensorflow/core/kernels/unsorted_segment_join_op.cc": [
          "File: tensorflow/core/kernels/unsorted_segment_join_op.cc -> tensorflow/core/kernels/unsorted_segment_join_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:     const Tensor& num_segments_tensor = context->input(2);",
          "93:     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,",
          "94:                 errors::InvalidArgument(\"Number of segments cannot be empty.\"));",
          "95:     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();",
          "97:     OP_REQUIRES(context, segment_dims != 0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95:     OP_REQUIRES(context,",
          "96:                 TensorShapeUtils::IsScalar(num_segments_tensor.shape()),",
          "97:                 errors::InvalidArgument(\"Number of segments must be a scalar\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}