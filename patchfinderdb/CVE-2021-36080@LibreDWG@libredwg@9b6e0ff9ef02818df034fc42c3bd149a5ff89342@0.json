{
  "cve_id": "CVE-2021-36080",
  "cve_desc": "GNU LibreDWG 0.12.3.4163 through 0.12.3.4191 has a double-free in bit_chain_free (called from dwg_encode_MTEXT and dwg_encode_add_object).",
  "repo": "LibreDWG/libredwg",
  "patch_hash": "9b6e0ff9ef02818df034fc42c3bd149a5ff89342",
  "patch_info": {
    "commit_hash": "9b6e0ff9ef02818df034fc42c3bd149a5ff89342",
    "repo": "LibreDWG/libredwg",
    "commit_url": "https://github.com/LibreDWG/libredwg/commit/9b6e0ff9ef02818df034fc42c3bd149a5ff89342",
    "files": [
      "src/encode.c"
    ],
    "message": "encode: avoid hdl_dat double-free\n\nIn case of an handle overflow, such as num_reactors.\nFixes oss-fuzz issue 31724.",
    "before_after_code_files": [
      "src/encode.c||src/encode.c"
    ]
  },
  "patch_diff": {
    "src/encode.c||src/encode.c": [
      "File: src/encode.c -> src/encode.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "830:     int error;                                                                \\",
      "831:     Bit_Chain _hdl_dat = { 0 };                                               \\",
      "832:     Bit_Chain *hdl_dat = &_hdl_dat; /* a new copy */                          \\",
      "834:     LOG_INFO (\"Encode entity \" #token \"\\n\");                                  \\",
      "835:     bit_chain_init_dat (hdl_dat, 128, dat);                                   \\",
      "836:     error = dwg_encode_entity (obj, dat, hdl_dat, str_dat);                   \\",
      "837:     if (error)                                                                \\",
      "838:       {                                                                       \\",
      "840:           bit_chain_free (hdl_dat);                                           \\",
      "841:         return error;                                                         \\",
      "842:       }                                                                       \\",
      "843:     error = dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);        \\",
      "846:     return error;                                                             \\",
      "847:   }                                                                           \\",
      "848:   static int dwg_encode_##token##_private (                                   \\",
      "851:   {                                                                           \\",
      "852:     int error = 0;                                                            \\",
      "853:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
      "854:     Dwg_Data *dwg = obj->parent;                                              \\",
      "855:     Dwg_Object_Entity *_ent = obj->tio.entity;                                \\",
      "858: #define DWG_ENTITY_END                                                        \\",
      "859:     if (hdl_dat->byte > dat->byte)                                            \\",
      "",
      "[Removed Lines]",
      "833:     Bit_Chain *str_dat = dat; /* a ref */                                     \\",
      "839:         if (hdl_dat != dat)                                                   \\",
      "844:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat)                   \\",
      "845:       bit_chain_free (hdl_dat);                                               \\",
      "849:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
      "850:         Dwg_Object *restrict obj)                                             \\",
      "856:     Dwg_Entity_##token *_obj = _ent->tio.token;                               \\",
      "",
      "[Added Lines]",
      "834:     Bit_Chain *str_dat = dat;       /* a ref */                               \\",
      "840:         LOG_HANDLE (\"Early DWG_ENTITY exit\\n\");                               \\",
      "841:         if (hdl_dat != dat && hdl_dat->chain != dat->chain)                   \\",
      "846:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat                    \\",
      "847:         && hdl_dat->chain != dat->chain)                                      \\",
      "848:       {                                                                       \\",
      "849:         LOG_HANDLE (\"VALUEOUTOFBOUNDS bypassed DWG_ENTITY_END\\n\");            \\",
      "851:       }                                                                       \\",
      "855:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
      "856:       Dwg_Object *restrict obj)                                               \\",
      "862:     Dwg_Entity_##token *_obj = _ent->tio.token;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "861:         dat->byte = hdl_dat->byte;                                            \\",
      "862:         dat->bit = hdl_dat->bit;                                              \\",
      "863:       }                                                                       \\",
      "865:       bit_chain_free (hdl_dat);                                               \\",
      "866:     return error;                                                             \\",
      "867:   }",
      "",
      "[Removed Lines]",
      "864:     if (hdl_dat != dat)                                                       \\",
      "",
      "[Added Lines]",
      "870:     if (hdl_dat != dat && hdl_dat->chain != dat->chain)                       \\",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "891:         return error;                                                         \\",
      "892:       }                                                                       \\",
      "893:     error = dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);        \\",
      "895:       bit_chain_free (hdl_dat);                                               \\",
      "896:     return error;                                                             \\",
      "897:   }                                                                           \\",
      "",
      "[Removed Lines]",
      "894:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat)                   \\",
      "",
      "[Added Lines]",
      "900:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat                    \\",
      "901:         && hdl_dat->chain != dat->chain)                                      \\",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "915:         dat->byte = hdl_dat->byte;                                            \\",
      "916:         dat->bit = hdl_dat->bit;                                              \\",
      "917:       }                                                                       \\",
      "919:       bit_chain_free (hdl_dat);                                               \\",
      "920:     return error;                                                             \\",
      "921:   }",
      "",
      "[Removed Lines]",
      "918:     if (hdl_dat != dat)                                                       \\",
      "",
      "[Added Lines]",
      "925:     if (hdl_dat != dat && hdl_dat->chain != dat->chain)                       \\",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7c7a67cd897a3a05aa568f8b680d60f720ea4d26",
      "candidate_info": {
        "commit_hash": "7c7a67cd897a3a05aa568f8b680d60f720ea4d26",
        "repo": "LibreDWG/libredwg",
        "commit_url": "https://github.com/LibreDWG/libredwg/commit/7c7a67cd897a3a05aa568f8b680d60f720ea4d26",
        "files": [
          "src/bits.c",
          "src/bits.h",
          "src/decode.c",
          "src/encode.c",
          "src/spec.h"
        ],
        "message": "encode: seperate hdl_dat stream earlier\n\nas in decode, almost:\nwrite the common handles later on START_OBJECT_HANDLE_STREAM\nor when that is missing at DWG_OBJECT_END.\nno special cases for CONTROL objs needed here",
        "before_after_code_files": [
          "src/bits.c||src/bits.c",
          "src/bits.h||src/bits.h",
          "src/decode.c||src/decode.c",
          "src/encode.c||src/encode.c",
          "src/spec.h||src/spec.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/encode.c||src/encode.c"
          ],
          "candidate": [
            "src/encode.c||src/encode.c"
          ]
        }
      },
      "candidate_diff": {
        "src/bits.c||src/bits.c": [
          "File: src/bits.c -> src/bits.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2300:     }",
          "2301: }",
          "2303: void",
          "2304: bit_print (Bit_Chain *dat, long unsigned int size)",
          "2305: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2303: void",
          "2304: bit_chain_free (Bit_Chain *dat)",
          "2305: {",
          "2306:   if (dat->chain)",
          "2307:     {",
          "2308:       free (dat->chain);",
          "2309:       dat->chain = NULL;",
          "2310:     }",
          "2311:   dat->size = 0;",
          "2312: }",
          "",
          "---------------"
        ],
        "src/bits.h||src/bits.h": [
          "File: src/bits.h -> src/bits.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "275: void bit_chain_init (Bit_Chain *dat, const int size);",
          "276: void bit_chain_alloc (Bit_Chain *dat);",
          "278: void bit_print (Bit_Chain *dat, long unsigned int size);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "277: void bit_chain_free (Bit_Chain *dat);",
          "",
          "---------------"
        ],
        "src/decode.c||src/decode.c": [
          "File: src/decode.c -> src/decode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "861:   int error = 0;",
          "862:   const char *section_names[]",
          "863:       = { \"AcDb:Header\", \"AcDb:Classes\", \"AcDb:Handles\",",
          "866:   {",
          "867:     int i;",
          "",
          "[Removed Lines]",
          "864:           \"2NDHEADER\",   \"MEASUREMENT\",  \"AcDb:AuxHeader\" };",
          "",
          "[Added Lines]",
          "864:           \"2NDHEADER\",   \"AcDb:Template\",  \"AcDb:AuxHeader\" };",
          "",
          "---------------"
        ],
        "src/encode.c||src/encode.c": [
          "File: src/encode.c -> src/encode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "364: #define REACTORS(code)                                                        \\",
          "365:   if (obj->tio.object->reactors)                                              \\",
          "366:     {                                                                         \\",
          "368:       SINCE (R_13)                                                            \\",
          "369:       {                                                                       \\",
          "370:         for (vcount = 0; vcount < (BITCODE_BL)obj->tio.object->num_reactors;  \\",
          "",
          "[Removed Lines]",
          "367:       OVERFLOW_CHECK_LV (nam, obj->tio.object->num_reactors)                  \\",
          "",
          "[Added Lines]",
          "367:       OVERFLOW_CHECK_LV (num_reactors, obj->tio.object->num_reactors)         \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "561:   }                                                                           \\",
          "562:   RESET_VER",
          "564: #define SECTION_STRING_STREAM                                                 \\",
          "565:   {                                                                           \\",
          "566:     Bit_Chain sav_dat = *dat;                                                 \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "564: #define START_OBJECT_HANDLE_STREAM  START_HANDLE_STREAM",
          "565: #define CONTROL_HANDLE_STREAM       START_HANDLE_STREAM",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "588:       obj->bitsize = bit_position (dat) - (obj->address * 8);                 \\",
          "589:       obj->was_bitsize_set = 1;                                               \\",
          "590:     }                                                                         \\",
          "595:   RESET_VER",
          "597: static void",
          "",
          "[Removed Lines]",
          "591:   if (!obj->hdlpos) obj->hdlpos = bit_position (dat);                         \\",
          "592:   if (dat->version >= R_2007 && bit_position (hdl_dat) > 0)                   \\",
          "593:     obj_flush_hdlstream (obj, dat, hdl_dat);                                  \\",
          "",
          "[Added Lines]",
          "594:   if (!obj->hdlpos)                                                           \\",
          "595:     obj->hdlpos = bit_position (dat);                                         \\",
          "596:   {                                                                           \\",
          "597:     unsigned long _hpos = bit_position (hdl_dat);                             \\",
          "598:     if (obj->supertype == DWG_SUPERTYPE_OBJECT && dat->version >= R_13)       \\",
          "599:       {                                                                       \\",
          "600:         VALUE_HANDLE (obj->tio.object->ownerhandle, ownerhandle, 4, 0);       \\",
          "601:         REACTORS (4)                                                          \\",
          "602:         XDICOBJHANDLE (3)                                                     \\",
          "603:       }                                                                       \\",
          "604:     if (_hpos > 0)                                                            \\",
          "605:       obj_flush_hdlstream (obj, dat, hdl_dat);                                \\",
          "606:   }                                                                           \\",
          "607:   hdl_dat->byte = dat->byte;                                                  \\",
          "608:   hdl_dat->bit = dat->bit;                                                    \\",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "608:       bit_write_B (dat, bit_read_B (hdl_dat));",
          "609:     }",
          "612: }",
          "614: #if 0",
          "",
          "[Removed Lines]",
          "610:   free (hdl_dat->chain);",
          "611:   hdl_dat->size = 0;",
          "",
          "[Added Lines]",
          "624:   bit_chain_free (hdl_dat);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "683:     Dwg_Object_Entity *_ent = obj->tio.entity;                                \\",
          "684:     Dwg_Entity_##token *_obj = _ent->tio.token;                               \\",
          "685:     int error;                                                                \\",
          "687:     Bit_Chain *str_dat = dat; /* a ref */                                     \\",
          "688:     Dwg_Data *dwg = obj->parent;                                              \\",
          "695:     error = dwg_encode_entity (obj, dat, hdl_dat, str_dat);                   \\",
          "696:     if (error)                                                                \\",
          "699: #define DWG_ENTITY_END                                                        \\",
          "700:   return error;                                                               \\",
          "701:   }",
          "",
          "[Removed Lines]",
          "686:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "689:     LOG_INFO (\"Encode entity \" #token \"\\n\")                                   \\",
          "690:     SINCE (R_2007) {                                                          \\",
          "691:       Bit_Chain _hdl_dat;                                                     \\",
          "692:       hdl_dat = &_hdl_dat; /* a new copy */                                   \\",
          "693:       bit_chain_init (hdl_dat, 128);                                          \\",
          "694:     }                                                                         \\",
          "697:       return error;",
          "",
          "[Added Lines]",
          "699:     Bit_Chain _hdl_dat = { 0 };                                               \\",
          "700:     Bit_Chain *hdl_dat = &_hdl_dat; /* a new copy */                          \\",
          "703:     LOG_INFO (\"Encode entity \" #token \"\\n\");                                  \\",
          "704:     bit_chain_init (hdl_dat, 128);                                            \\",
          "707:       {                                                                       \\",
          "708:         bit_chain_free (hdl_dat);                                             \\",
          "709:         return error;                                                         \\",
          "710:       }",
          "713:   if (hdl_dat->byte > dat->byte)                                              \\",
          "714:     {                                                                         \\",
          "715:       dat->byte = hdl_dat->byte;                                              \\",
          "716:       dat->bit = hdl_dat->bit;                                                \\",
          "717:     }                                                                         \\",
          "718:   bit_chain_free (hdl_dat);                                                   \\",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "710:   {                                                                           \\",
          "711:     BITCODE_BL vcount, rcount1, rcount2, rcount3, rcount4;                    \\",
          "712:     int error;                                                                \\",
          "715:     Dwg_Data *dwg = obj->parent;                                              \\",
          "722:     error = dwg_encode_object (obj, dat, hdl_dat, str_dat);                   \\",
          "723:     if (error)                                                                \\",
          "727: #define DWG_OBJECT_END                                                        \\",
          "729:   }",
          "731: #define ENT_REACTORS(code)                                                    \\",
          "733:     {                                                                         \\",
          "734:       LOG_ERROR (\"Invalid num_reactors: %ld\\n\", (long)_obj->num_reactors);    \\",
          "735:       return DWG_ERR_VALUEOUTOFBOUNDS;                                        \\",
          "",
          "[Removed Lines]",
          "713:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "714:     Bit_Chain *str_dat = dat; /* a ref */                                     \\",
          "716:     Dwg_Object_##token *_obj = obj->tio.object ? obj->tio.object->tio.token : NULL; \\",
          "717:     SINCE (R_2007) {                                                          \\",
          "718:       Bit_Chain _hdl_dat;                                                     \\",
          "719:       hdl_dat = &_hdl_dat; /* a new copy */                                   \\",
          "720:       bit_chain_init (hdl_dat, 128);                                          \\",
          "721:     }                                                                         \\",
          "724:       return error;                                                           \\",
          "725:     LOG_INFO (\"Encode object \" #token \"\\n\")",
          "728:   return error;                                                               \\",
          "732:   if (dat->version >= R_2000 && _obj->num_reactors > 0x1000)                  \\",
          "",
          "[Added Lines]",
          "732:     Bit_Chain _hdl_dat = { 0 };                                               \\",
          "733:     Bit_Chain *hdl_dat = &_hdl_dat; /* a new copy */                          \\",
          "734:     Bit_Chain *str_dat = dat;       /* a ref */                               \\",
          "736:     Dwg_Object_##token *_obj                                                  \\",
          "737:         = obj->tio.object ? obj->tio.object->tio.token : NULL;                \\",
          "738:     LOG_INFO (\"Encode object \" #token \"\\n\");                                  \\",
          "739:     bit_chain_init (hdl_dat, 128);                                            \\",
          "742:       {                                                                       \\",
          "743:         bit_chain_free (hdl_dat);                                             \\",
          "744:         return error;                                                         \\",
          "745:       }",
          "749:     if (!obj->hdlpos)                                                         \\",
          "750:       {                                                                       \\",
          "751:         START_OBJECT_HANDLE_STREAM                                            \\",
          "752:       }                                                                       \\",
          "753:     if (hdl_dat->byte > dat->byte)                                            \\",
          "754:       {                                                                       \\",
          "755:         dat->byte = hdl_dat->byte;                                            \\",
          "756:         dat->bit = hdl_dat->bit;                                              \\",
          "757:       }                                                                       \\",
          "758:     bit_chain_free (hdl_dat);                                                 \\",
          "759:     return error;                                                             \\",
          "763:   if (dat->version >= R_13 && _obj->num_reactors > 0x1000)                    \\",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "769: static int encode_preR13 (Dwg_Data *restrict dwg, Bit_Chain *restrict dat);",
          "771: static int dwg_encode_entity (Dwg_Object *restrict obj, Bit_Chain *dat,",
          "775: static int dwg_encode_common_entity_handle_data (Bit_Chain *dat,",
          "776:                                                  Bit_Chain *hdl_dat,",
          "777:                                                  Dwg_Object *restrict obj);",
          "",
          "[Removed Lines]",
          "772:                               Bit_Chain *hdl_dat, Bit_Chain *str_dat);",
          "773: static int dwg_encode_object (Dwg_Object *restrict obj, Bit_Chain *str_dat,",
          "774:                               Bit_Chain *hdl_dat, Bit_Chain *dat);",
          "",
          "[Added Lines]",
          "803:                               Bit_Chain *restrict hdl_dat, Bit_Chain *str_dat);",
          "804: static int dwg_encode_object (Dwg_Object *restrict obj, Bit_Chain *dat,",
          "805:                               Bit_Chain *restrict hdl_dat, Bit_Chain *str_dat);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "861:   Bit_Chain *hdl_dat;",
          "862:   const char *section_names[]",
          "863:       = { \"AcDb:Header\", \"AcDb:Classes\", \"AcDb:Handles\",",
          "865:   Dwg_Version_Type orig_from_version = dat->from_version;",
          "867:   if (dwg->opts)",
          "",
          "[Removed Lines]",
          "864:           \"2NDHEADER\",   \"MEASUREMENT\",  \"AcDb:AuxHeader\" };",
          "",
          "[Added Lines]",
          "895:           \"2NDHEADER\",   \"AcDb:Template\",  \"AcDb:AuxHeader\" };",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "880:   bit_chain_alloc (dat);",
          "",
          "[Removed Lines]",
          "881:   hdl_dat = dat;",
          "",
          "[Added Lines]",
          "912:   hdl_dat = dat; // splitted later in objects/entities",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2226:       BITCODE_BL pos = bit_position (dat);",
          "2227:       BITCODE_RL old_size = obj->size;",
          "2228:       assert (address);",
          "2233:       if (!obj->bitsize ||",
          "2234:           (dwg->opts & DWG_OPTS_INJSON",
          "",
          "[Removed Lines]",
          "2229:       obj->size = dat->byte - address - 2; // excludes the CRC",
          "2230:       if (dat->bit)",
          "2231:         obj->size++;",
          "",
          "[Added Lines]",
          "2260:       if (dat->byte > address)",
          "2261:         {",
          "2262:           obj->size = dat->byte - address - 2; // excludes the CRC",
          "2263:           if (dat->bit)",
          "2264:             obj->size++;",
          "2265:         }",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2532:    See DWG_SUPERTYPE_ENTITY in dwg_encode().",
          "2534: static int",
          "2537: {",
          "2538:   int error = 0;",
          "2539:   Dwg_Object_Entity *ent = obj->tio.entity;",
          "",
          "[Removed Lines]",
          "2535: dwg_encode_entity (Dwg_Object *restrict obj, Bit_Chain *hdl_dat,",
          "2536:                    Bit_Chain *str_dat, Bit_Chain *dat)",
          "",
          "[Added Lines]",
          "2569: dwg_encode_entity (Dwg_Object *restrict obj, Bit_Chain *dat,",
          "2570:                    Bit_Chain *restrict hdl_dat, Bit_Chain *str_dat)",
          "",
          "---------------",
          "--- Hunk 12 ---",
          "[Context before]",
          "2543:   if (!obj || !dat)",
          "2544:     return DWG_ERR_INVALIDDWG;",
          "2545:   PRE (R_13)",
          "2546:   {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2580:   hdl_dat->from_version = dat->from_version;",
          "2581:   hdl_dat->version = dat->version;",
          "2582:   hdl_dat->opts = dat->opts;",
          "",
          "---------------",
          "--- Hunk 13 ---",
          "[Context before]",
          "2572:   obj->was_bitsize_set = 0;",
          "2573:   if (obj->bitsize)",
          "2574:     {",
          "2576:     }",
          "2577:   SINCE (R_2007)",
          "2578:   {",
          "",
          "[Removed Lines]",
          "2575:       obj->hdlpos = obj->address * 8 + obj->bitsize;",
          "",
          "[Added Lines]",
          "2614:       obj->hdlpos = (obj->address * 8) + obj->bitsize;",
          "",
          "---------------",
          "--- Hunk 14 ---",
          "[Context before]",
          "2702:    See DWG_SUPERTYPE_OBJECT in dwg_encode().",
          "2704: static int",
          "2707: {",
          "2708:   int error = 0;",
          "2731:   {",
          "2736:   }",
          "2751:   }",
          "2752:   return error;",
          "2753: }",
          "",
          "[Removed Lines]",
          "2701:    There is no COMMON_ENTITY_HANDLE_DATA for objects.",
          "2705: dwg_encode_object (Dwg_Object *restrict obj, Bit_Chain *hdl_dat,",
          "2706:                    Bit_Chain *str_dat, Bit_Chain *dat)",
          "2709:   Dwg_Object_Object *ord = obj->tio.object;",
          "2711:   VERSIONS (R_2000, R_2007)",
          "2712:   {",
          "2713:     obj->bitsize_pos = bit_position (dat);",
          "2714:     bit_write_RL (dat, obj->bitsize);",
          "2715:     LOG_INFO (\"bitsize: \" FORMAT_RL \" [RL] (@%lu.%u)\\n\", obj->bitsize,",
          "2716:               dat->byte - 4, dat->bit);",
          "2717:   }",
          "2718:   obj->was_bitsize_set = 0;",
          "2719:   if (obj->bitsize)",
          "2721:     obj->hdlpos = bit_position (dat) + obj->bitsize;",
          "2722:   SINCE (R_2007) { obj_string_stream (dat, obj, str_dat); }",
          "2723:   if (!ord)",
          "2724:     return DWG_ERR_INVALIDTYPE;",
          "2726:   bit_write_H (dat, &obj->handle);",
          "2727:   LOG_TRACE (\"handle: \" FORMAT_H \" [H 5]\\n\", ARGS_H (obj->handle));",
          "2728:   error |= dwg_encode_eed (dat, obj);",
          "2730:   VERSIONS (R_13, R_14)",
          "2732:     obj->bitsize_pos = bit_position (dat);",
          "2733:     bit_write_RL (dat, obj->bitsize);",
          "2734:     LOG_INFO (\"bitsize: \" FORMAT_RL \" [RL] (@%lu.%u)\\n\", obj->bitsize,",
          "2735:               dat->byte - 4, dat->bit);",
          "2738:   bit_write_BL (dat, ord->num_reactors);",
          "2739:   LOG_TRACE (\"num_reactors: \" FORMAT_BL \" [BL]\\n\", ord->num_reactors);",
          "2740:   SINCE (R_2004)",
          "2741:   {",
          "2742:     bit_write_B (dat, ord->xdic_missing_flag);",
          "2743:     LOG_TRACE (\"xdic_missing_flag: \" FORMAT_B \" [B]\\n\",",
          "2744:                ord->xdic_missing_flag);",
          "2745:   }",
          "2746:   SINCE (R_2013)",
          "2747:   {",
          "2748:     bit_write_B (dat, ord->has_ds_binary_data);",
          "2749:     LOG_TRACE (\"has_ds_binary_data: \" FORMAT_B \" [B]\\n\",",
          "2750:                ord->has_ds_binary_data);",
          "",
          "[Added Lines]",
          "2741:    There is no COMMON_ENTITY_DATA for objects, handles are deferred and flushed later.",
          "2745: dwg_encode_object (Dwg_Object *restrict obj, Bit_Chain *dat,",
          "2746:                    Bit_Chain *restrict hdl_dat, Bit_Chain *str_dat)",
          "2749:   BITCODE_BL vcount;",
          "2751:   hdl_dat->from_version = dat->from_version;",
          "2752:   hdl_dat->version = dat->version;",
          "2753:   hdl_dat->opts = dat->opts;",
          "2755:     Dwg_Object *_obj = obj;",
          "2756:     VERSIONS (R_2000, R_2007)",
          "2757:     {",
          "2758:       obj->bitsize_pos = bit_position (dat);",
          "2759:       FIELD_RL (bitsize, 0);",
          "2760:     }",
          "2761:     obj->was_bitsize_set = 0;",
          "2762:     if (obj->bitsize)",
          "2764:       obj->hdlpos = bit_position (dat) + obj->bitsize;",
          "2765:     SINCE (R_2007) { obj_string_stream (dat, obj, str_dat); }",
          "2766:     if (!_obj)",
          "2767:       return DWG_ERR_INVALIDTYPE;",
          "2769:     bit_write_H (dat, &obj->handle);",
          "2770:     LOG_TRACE (\"handle: \" FORMAT_H \" [H 5]\\n\", ARGS_H (obj->handle));",
          "2771:     error |= dwg_encode_eed (dat, obj);",
          "2773:     VERSIONS (R_13, R_14)",
          "2774:     {",
          "2775:       obj->bitsize_pos = bit_position (dat);",
          "2776:       FIELD_RL (bitsize, 0);",
          "2777:     }",
          "2780:   SINCE (R_13) {",
          "2781:     Dwg_Object_Object *_obj = obj->tio.object;",
          "2782:     FIELD_BL (num_reactors, 0);",
          "2783:     SINCE (R_2004) { FIELD_B (xdic_missing_flag, 0); }",
          "2784:     SINCE (R_2013) { FIELD_B (has_ds_binary_data, 0); }",
          "",
          "---------------"
        ],
        "src/spec.h||src/spec.h": [
          "File: src/spec.h -> src/spec.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "348: #ifndef CONTROL_HANDLE_STREAM",
          "349: #  define CONTROL_HANDLE_STREAM                                               \\",
          "350:     assert (obj->supertype == DWG_SUPERTYPE_OBJECT);                          \\",
          "352:     SINCE (R_13) {                                                            \\",
          "353:       VALUE_HANDLE (obj->tio.object->ownerhandle, ownerhandle, 4, 0);         \\",
          "354:       REACTORS (4)                                                            \\",
          "",
          "[Removed Lines]",
          "351:     PRE (R_2007) *hdl_dat = *dat;                                             \\",
          "",
          "[Added Lines]",
          "351:     PRE (R_2007) {                                                            \\",
          "352:       hdl_dat->byte = dat->byte;                                              \\",
          "353:       hdl_dat->bit = dat->bit;                                                \\",
          "354:     }                                                                         \\",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "749923e4dfaf9b32e13282325decd78595a60c95",
      "candidate_info": {
        "commit_hash": "749923e4dfaf9b32e13282325decd78595a60c95",
        "repo": "LibreDWG/libredwg",
        "commit_url": "https://github.com/LibreDWG/libredwg/commit/749923e4dfaf9b32e13282325decd78595a60c95",
        "files": [
          "src/encode.c"
        ],
        "message": "encode: fix hdl_dat leak on errors\n\nwhen we have to return early within dwg.spec, such as HATCH errors\nand don't cleanup with DWG_OBJECT_END.\n\nFixes oss-fuzz issue 31456",
        "before_after_code_files": [
          "src/encode.c||src/encode.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/encode.c||src/encode.c"
          ],
          "candidate": [
            "src/encode.c||src/encode.c"
          ]
        }
      },
      "candidate_diff": {
        "src/encode.c||src/encode.c": [
          "File: src/encode.c -> src/encode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "837:           bit_chain_free (hdl_dat);                                           \\",
          "838:         return error;                                                         \\",
          "839:       }                                                                       \\",
          "841:   }                                                                           \\",
          "842:   static int dwg_encode_##token##_private (                                   \\",
          "843:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "",
          "[Removed Lines]",
          "840:     return dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "",
          "[Added Lines]",
          "840:     error = dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);        \\",
          "841:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat)                   \\",
          "842:       bit_chain_free (hdl_dat);                                               \\",
          "843:     return error;                                                             \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "884:           bit_chain_free (hdl_dat);                                           \\",
          "885:         return error;                                                         \\",
          "886:       }                                                                       \\",
          "888:   }                                                                           \\",
          "889:   static int dwg_encode_##token##_private (                                   \\",
          "890:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "",
          "[Removed Lines]",
          "887:     return dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "",
          "[Added Lines]",
          "890:     error = dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);        \\",
          "891:     if (error & DWG_ERR_VALUEOUTOFBOUNDS && hdl_dat != dat)                   \\",
          "892:       bit_chain_free (hdl_dat);                                               \\",
          "893:     return error;                                                             \\",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5c7ea30abf417ce93fa0ce231dafa04b8066811b",
      "candidate_info": {
        "commit_hash": "5c7ea30abf417ce93fa0ce231dafa04b8066811b",
        "repo": "LibreDWG/libredwg",
        "commit_url": "https://github.com/LibreDWG/libredwg/commit/5c7ea30abf417ce93fa0ce231dafa04b8066811b",
        "files": [
          "src/encode.c",
          "src/free.c",
          "src/out_dxf.c",
          "src/out_dxfb.c",
          "src/out_json.c",
          "src/print.c",
          "test/unit-testing/geopositionmarker.c"
        ],
        "message": "actions: add more _private functions\n\nwith the end goal to also call free on them",
        "before_after_code_files": [
          "src/encode.c||src/encode.c",
          "src/free.c||src/free.c",
          "src/out_dxf.c||src/out_dxf.c",
          "src/out_dxfb.c||src/out_dxfb.c",
          "src/out_json.c||src/out_json.c",
          "src/print.c||src/print.c",
          "test/unit-testing/geopositionmarker.c||test/unit-testing/geopositionmarker.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/encode.c||src/encode.c"
          ],
          "candidate": [
            "src/encode.c||src/encode.c"
          ]
        }
      },
      "candidate_diff": {
        "src/encode.c||src/encode.c": [
          "File: src/encode.c -> src/encode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "760: EXPORT long dwg_add_##token (Dwg_Data * dwg)     \\",
          "761: {                                                \\",
          "762:   Bit_Chain dat = { 0 };                         \\",
          "764:   BITCODE_BL num_objs  = dwg->num_objects;       \\",
          "765:   dat.size = sizeof(Dwg_Object_##token) + 40;    \\",
          "766:   LOG_INFO (\"Add object \" #token \" \")            \\",
          "",
          "[Removed Lines]",
          "763:   int error = 0; \\",
          "",
          "[Added Lines]",
          "763:   int error = 0;                                 \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "788: #endif",
          "790: #define DWG_ENTITY(token)                                                     \\",
          "792:   {                                                                           \\",
          "796:     int error;                                                                \\",
          "797:     Bit_Chain _hdl_dat = { 0 };                                               \\",
          "798:     Bit_Chain *hdl_dat = &_hdl_dat; /* a new copy */                          \\",
          "799:     Bit_Chain *str_dat = dat; /* a ref */                                     \\",
          "801:     LOG_INFO (\"Encode entity \" #token \"\\n\");                                  \\",
          "802:     bit_chain_init (hdl_dat, 128);                                            \\",
          "803:     error = dwg_encode_entity (obj, dat, hdl_dat, str_dat);                   \\",
          "",
          "[Removed Lines]",
          "791:   static int dwg_encode_##token (Bit_Chain *restrict dat, Dwg_Object *restrict obj)  \\",
          "793:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "794:     Dwg_Object_Entity *_ent = obj->tio.entity;                                \\",
          "795:     Dwg_Entity_##token *_obj = _ent->tio.token;                               \\",
          "800:     Dwg_Data *dwg = obj->parent;                                              \\",
          "",
          "[Added Lines]",
          "791:   static int dwg_encode_##token##_private (                                   \\",
          "792:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "793:       Dwg_Object *restrict obj);                                              \\",
          "794:   static int dwg_encode_##token (Bit_Chain *restrict dat,                     \\",
          "795:                                  Dwg_Object *restrict obj)                    \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "806:         if (hdl_dat != dat)                                                   \\",
          "807:           bit_chain_free (hdl_dat);                                           \\",
          "808:         return error;                                                         \\",
          "811: #define DWG_ENTITY_END                                                        \\",
          "820:   }",
          "",
          "[Removed Lines]",
          "809:       }",
          "812:   if (hdl_dat->byte > dat->byte)                                              \\",
          "813:     {                                                                         \\",
          "814:       dat->byte = hdl_dat->byte;                                              \\",
          "815:       dat->bit = hdl_dat->bit;                                                \\",
          "816:     }                                                                         \\",
          "817:   if (hdl_dat != dat)                                                         \\",
          "818:     bit_chain_free (hdl_dat);                                                 \\",
          "819:   return error;                                                               \\",
          "",
          "[Added Lines]",
          "809:       }                                                                       \\",
          "810:     return dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "811:   }                                                                           \\",
          "812:   static int dwg_encode_##token##_private (                                   \\",
          "813:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "814:         Dwg_Object *restrict obj)                                             \\",
          "815:   {                                                                           \\",
          "816:     int error = 0;                                                            \\",
          "817:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "818:     Dwg_Data *dwg = obj->parent;                                              \\",
          "819:     Dwg_Object_Entity *_ent = obj->tio.entity;                                \\",
          "820:     Dwg_Entity_##token *_obj = _ent->tio.token;                               \\",
          "823:     if (hdl_dat->byte > dat->byte)                                            \\",
          "824:       {                                                                       \\",
          "825:         dat->byte = hdl_dat->byte;                                            \\",
          "826:         dat->bit = hdl_dat->bit;                                              \\",
          "827:       }                                                                       \\",
          "828:     if (hdl_dat != dat)                                                       \\",
          "829:       bit_chain_free (hdl_dat);                                               \\",
          "830:     return error;                                                             \\",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "824:    all internal obj pointers after a object[] realloc.",
          "826: #define DWG_OBJECT(token)                                                     \\",
          "828:   {                                                                           \\",
          "830:     int error;                                                                \\",
          "831:     Bit_Chain _hdl_dat = { 0 };                                               \\",
          "832:     Bit_Chain *hdl_dat = &_hdl_dat; /* a new copy */                          \\",
          "833:     Bit_Chain *str_dat = dat;       /* a ref */                               \\",
          "837:     LOG_INFO (\"Encode object \" #token \"\\n\");                                  \\",
          "838:     bit_chain_init (hdl_dat, 128);                                            \\",
          "839:     error = dwg_encode_object (obj, dat, hdl_dat, str_dat);                   \\",
          "",
          "[Removed Lines]",
          "827:   static int dwg_encode_##token (Bit_Chain *restrict dat, Dwg_Object *restrict obj)  \\",
          "829:     BITCODE_BL vcount, rcount3, rcount4;                    \\",
          "834:     Dwg_Data *dwg = obj->parent;                                              \\",
          "835:     Dwg_Object_##token *_obj                                                  \\",
          "836:         = obj->tio.object ? obj->tio.object->tio.token : NULL;                \\",
          "",
          "[Added Lines]",
          "838:   static int dwg_encode_##token##_private (                                   \\",
          "839:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "840:       Dwg_Object *restrict obj);                                              \\",
          "841:   static int dwg_encode_##token (Bit_Chain *restrict dat,                     \\",
          "842:                                  Dwg_Object *restrict obj)                    \\",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "842:         if (hdl_dat != dat)                                                   \\",
          "843:           bit_chain_free (hdl_dat);                                           \\",
          "844:         return error;                                                         \\",
          "848: #define DWG_OBJECT_END                                                        \\",
          "",
          "[Removed Lines]",
          "845:       }",
          "",
          "[Added Lines]",
          "856:       }                                                                       \\",
          "857:     return dwg_encode_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "858:   }                                                                           \\",
          "859:   static int dwg_encode_##token##_private (                                   \\",
          "860:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "861:         Dwg_Object *restrict obj)                                             \\",
          "862:   {                                                                           \\",
          "863:     int error = 0;                                                            \\",
          "864:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "865:     Dwg_Data *dwg = obj->parent;                                              \\",
          "866:     Dwg_Object_##token *_obj = obj->tio.object->tio.token;",
          "",
          "---------------"
        ],
        "src/free.c||src/free.c": [
          "File: src/free.c -> src/free.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "318:     Dwg_Data *dwg = obj->parent;                                              \\",
          "319:     int error = 0;                                                            \\",
          "320:     _ent = obj->tio.entity;                                                   \\",
          "321:     _obj = ent = _ent->tio.token;",
          "323: #define DWG_ENTITY_END                                                        \\",
          "325:   }",
          "327: #define DWG_OBJECT(token)                                                     \\",
          "",
          "[Removed Lines]",
          "324:   return error;                                                               \\",
          "",
          "[Added Lines]",
          "321:     if (!_ent)                                                                \\",
          "322:       return 0;                                                               \\",
          "326:     return error;                                                             \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "365: #define DWG_OBJECT_END                                                        \\",
          "367:   }",
          "369: static void",
          "",
          "[Removed Lines]",
          "366:   return error;                                                               \\",
          "",
          "[Added Lines]",
          "368:     return error;                                                             \\",
          "",
          "---------------"
        ],
        "src/out_dxf.c||src/out_dxf.c": [
          "File: src/out_dxf.c -> src/out_dxf.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "697: #define DWG_ENTITY(token)                                                     \\",
          "698:   static int dwg_dxf_##token (Bit_Chain *restrict dat,                        \\",
          "699:                               const Dwg_Object *restrict obj)                 \\",
          "700:   {                                                                           \\",
          "702:     int error = 0;                                                            \\",
          "704:     Bit_Chain *str_dat = dat;                                                 \\",
          "707:     if (obj->fixedtype != DWG_TYPE_##token)                                   \\",
          "708:       {                                                                       \\",
          "709:         LOG_ERROR (\"Invalid type 0x%x, expected 0x%x %s\", obj->fixedtype,     \\",
          "",
          "[Removed Lines]",
          "701:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "703:     Dwg_Data *dwg = obj->parent;                                              \\",
          "705:     Dwg_Entity_##token *ent, *_obj;                                           \\",
          "706:     Dwg_Object_Entity *_ent;                                                  \\",
          "",
          "[Added Lines]",
          "698:   static int dwg_dxf_##token##_private (                                      \\",
          "699:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "700:       const Dwg_Object *restrict obj);                                        \\",
          "705:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "732:       record (obj->dxfname);                                                  \\",
          "733:     else                                                                      \\",
          "734:       RECORD (token);                                                         \\",
          "737:     LOG_INFO (\"Entity \" #token \":\\n\")                                         \\",
          "738:     SINCE (R_11)                                                              \\",
          "739:     {                                                                         \\",
          "740:       LOG_TRACE (\"Entity handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle));      \\",
          "741:       fprintf (dat->fh, \"%3i\\r\\n%lX\\r\\n\", 5, obj->handle.value);              \\",
          "742:     }                                                                         \\",
          "745: #define DWG_ENTITY_END                                                        \\",
          "748:   }",
          "750: #define DWG_OBJECT(token)                                                     \\",
          "751:   static int dwg_dxf_##token (Bit_Chain *restrict dat,                        \\",
          "752:                               const Dwg_Object *restrict obj)                 \\",
          "753:   {                                                                           \\",
          "755:     int error = 0;                                                            \\",
          "756:     Bit_Chain *hdl_dat = dat, *str_dat = dat;                                 \\",
          "759:     LOG_INFO (\"Object \" #token \":\\n\")                                         \\",
          "760:     if (obj->fixedtype != DWG_TYPE_##token)                                   \\",
          "761:       {                                                                       \\",
          "",
          "[Removed Lines]",
          "735:     _ent = obj->tio.entity;                                                   \\",
          "736:     _obj = ent = _ent->tio.token;                                             \\",
          "743:     SINCE (R_13) { error |= dxf_common_entity_handle_data (dat, obj); }",
          "746:   error |= dxf_write_eed (dat, (Dwg_Object_Object*)obj->tio.entity);          \\",
          "747:   return error;                                                               \\",
          "754:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "757:     Dwg_Data *dwg = obj->parent;                                              \\",
          "758:     Dwg_Object_##token *_obj;                                                 \\",
          "",
          "[Added Lines]",
          "741:     SINCE (R_13) { error |= dxf_common_entity_handle_data (dat, obj); }       \\",
          "742:     error |= dwg_dxf_##token##_private (dat, hdl_dat, str_dat, obj);          \\",
          "743:     error |= dxf_write_eed (dat, obj->tio.object);                            \\",
          "744:     return error;                                                             \\",
          "745:   }                                                                           \\",
          "746:   static int dwg_dxf_##token##_private (                                      \\",
          "747:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "748:       const Dwg_Object *restrict obj) {                                       \\",
          "749:     int error = 0;                                                            \\",
          "750:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "751:     Dwg_Data *dwg = obj->parent;                                              \\",
          "752:     Dwg_Entity_##token *_obj = obj->tio.entity->tio.token;                    \\",
          "753:     Dwg_Object_Entity *_ent = obj->tio.entity;",
          "756:     return error;                                                             \\",
          "760:   static int dwg_dxf_##token##_private (                                      \\",
          "761:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "762:       const Dwg_Object *restrict obj);                                        \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "763:                    DWG_TYPE_##token, #token);                                 \\",
          "764:         return DWG_ERR_INVALIDTYPE;                                           \\",
          "765:       }                                                                       \\",
          "767:     if (!dwg_obj_is_control (obj))                                            \\",
          "768:       {                                                                       \\",
          "769:         if (obj->fixedtype == DWG_TYPE_TABLE)                                 \\",
          "",
          "[Removed Lines]",
          "766:     _obj = obj->tio.object->tio.token;                                        \\",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "777:                                                                               \\",
          "778:         SINCE (R_13)                                                          \\",
          "779:         {                                                                     \\",
          "780:           const int dxf = obj->type == DWG_TYPE_DIMSTYLE ? 105 : 5;           \\",
          "781:           fprintf (dat->fh, \"%3i\\r\\n%lX\\r\\n\", dxf, obj->handle.value);        \\",
          "782:           _XDICOBJHANDLE (3);                                                 \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "788:           BITCODE_BL vcount;                                                  \\",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "799:           }                                                                   \\",
          "800:         else                                                                  \\",
          "801:           LOG_TRACE (\"Object handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle))   \\",
          "806: #define DWG_OBJECT_END                                                        \\",
          "808:     return error;                                                             \\",
          "811: #undef DXF_3DSOLID",
          "812: #define DXF_3DSOLID dxf_3dsolid (dat, obj, (Dwg_Entity_3DSOLID *)_obj);",
          "",
          "[Removed Lines]",
          "802:       }",
          "807:     error |= dxf_write_eed (dat, obj->tio.object);                            \\",
          "809: }",
          "",
          "[Added Lines]",
          "811:       }                                                                       \\",
          "812:     error |= dwg_dxf_##token##_private (dat, hdl_dat, str_dat, obj);          \\",
          "813:     error |= dxf_write_eed (dat, obj->tio.object);                            \\",
          "814:     return error;                                                             \\",
          "815:   }                                                                           \\",
          "816:   static int dwg_dxf_##token##_private (                                      \\",
          "817:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "818:       const Dwg_Object *restrict obj) {                                       \\",
          "819:     int error = 0;                                                            \\",
          "820:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "821:     Dwg_Data *dwg = obj->parent;                                              \\",
          "822:     Dwg_Object_##token *_obj = obj->tio.object->tio.token;",
          "828:   }",
          "",
          "---------------"
        ],
        "src/out_dxfb.c||src/out_dxfb.c": [
          "File: src/out_dxfb.c -> src/out_dxfb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "600: #endif",
          "602: #define DWG_ENTITY(token)                                                     \\",
          "603:   static int dwg_dxfb_##token (Bit_Chain *restrict dat,                       \\",
          "604:                                const Dwg_Object *restrict obj)                \\",
          "605:   {                                                                           \\",
          "607:     int error = 0;                                                            \\",
          "608:     Dwg_Data *dwg = obj->parent;                                              \\",
          "609:     Bit_Chain *str_dat = dat;                                                 \\",
          "612:     if (obj->fixedtype != DWG_TYPE_##token)                                   \\",
          "613:       {                                                                       \\",
          "614:         LOG_ERROR (\"Invalid type 0x%x, expected 0x%x %s\", obj->fixedtype,     \\",
          "",
          "[Removed Lines]",
          "606:     BITCODE_BL vcount, rcount3, rcount4;                    \\",
          "610:     Dwg_Entity_##token *ent, *_obj;                                           \\",
          "611:     Dwg_Object_Entity *_ent;                                                  \\",
          "",
          "[Added Lines]",
          "603:   static int dwg_dxfb_##token##_private (                                     \\",
          "604:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "605:       const Dwg_Object *restrict obj);                                        \\",
          "609:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "612:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "638:     else                                                                      \\",
          "639:       RECORD (token)                                                          \\",
          "640:     LOG_INFO (\"Entity \" #token \":\\n\")                                         \\",
          "643:     SINCE (R_11)                                                              \\",
          "644:     {                                                                         \\",
          "645:       uint32_t i = (uint32_t)obj->handle.value;                               \\",
          "",
          "[Removed Lines]",
          "641:     _ent = obj->tio.entity;                                                   \\",
          "642:     _obj = ent = _ent->tio.token;                                             \\",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "652:       VALUE_HANDLE_NAME (obj->parent->header_vars.BLOCK_RECORD_MSPACE, 330,   \\",
          "653:                          BLOCK_HEADER);                                       \\",
          "654:       error |= dxfb_common_entity_handle_data (dat, obj);                     \\",
          "657: #define DWG_ENTITY_END                                                        \\",
          "659:     return error;                                                             \\",
          "660:   }",
          "662: #define DWG_OBJECT(token)                                                     \\",
          "663:   static int dwg_dxfb_##token (Bit_Chain *restrict dat,                       \\",
          "664:                                const Dwg_Object *restrict obj)                \\",
          "665:   {                                                                           \\",
          "",
          "[Removed Lines]",
          "655:     }",
          "658:     error |= dxfb_write_eed (dat, (Dwg_Object_Object*)obj->tio.entity);       \\",
          "",
          "[Added Lines]",
          "655:     }                                                                         \\",
          "656:     error |= dwg_dxfb_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "657:     error |= dxfb_write_eed (dat, obj->tio.object);                           \\",
          "658:     return error;                                                             \\",
          "659:   }                                                                           \\",
          "660:   static int dwg_dxfb_##token##_private (                                     \\",
          "661:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "662:       const Dwg_Object *restrict obj) {                                       \\",
          "663:     int error = 0;                                                            \\",
          "664:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "665:     Dwg_Data *dwg = obj->parent;                                              \\",
          "666:     Dwg_Entity_##token *_obj = obj->tio.entity->tio.token;                    \\",
          "667:     Dwg_Object_Entity *_ent = obj->tio.entity;",
          "674:   static int dwg_dxfb_##token##_private (                                     \\",
          "675:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "676:       const Dwg_Object *restrict obj);                                        \\",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "667:     int error = 0;                                                            \\",
          "668:     Bit_Chain *str_dat = dat;                                                 \\",
          "669:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "672:     LOG_INFO (\"Object \" #token \":\\n\")                                         \\",
          "673:     if (obj->fixedtype != DWG_TYPE_##token)                                   \\",
          "674:       {                                                                       \\",
          "",
          "[Removed Lines]",
          "670:     Dwg_Data *dwg = obj->parent;                                              \\",
          "671:     Dwg_Object_##token *_obj;                                                 \\",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "676:                    DWG_TYPE_##token, #token);                                 \\",
          "677:         return DWG_ERR_INVALIDTYPE;                                           \\",
          "678:       }                                                                       \\",
          "680:     if (!dwg_obj_is_control (obj))                                            \\",
          "681:       {                                                                       \\",
          "682:         if (obj->fixedtype == DWG_TYPE_TABLE)                                 \\",
          "",
          "[Removed Lines]",
          "679:     _obj = obj->tio.object->tio.token;                                        \\",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "701:           VALUE_HANDLE (obj->tio.object->ownerhandle, ownerhandle, 3, 330);   \\",
          "702:         }                                                                     \\",
          "703:       }                                                                       \\",
          "706: #define DWG_OBJECT_END                                                        \\",
          "708:     return error;                                                             \\",
          "709:   }",
          "",
          "[Removed Lines]",
          "704:     LOG_TRACE (\"Object handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle))",
          "707:     error |= dxfb_write_eed (dat, obj->tio.object);                           \\",
          "",
          "[Added Lines]",
          "715:     LOG_TRACE (\"Object handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle))         \\",
          "716:     error |= dwg_dxfb_##token##_private (dat, hdl_dat, str_dat, obj);         \\",
          "717:     error |= dxfb_write_eed (dat, obj->tio.object);                           \\",
          "718:     return error;                                                             \\",
          "719:   }                                                                           \\",
          "720:   static int dwg_dxfb_##token##_private (                                     \\",
          "721:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "722:       const Dwg_Object *restrict obj) {                                       \\",
          "723:     int error = 0;                                                            \\",
          "724:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "725:     Dwg_Data *dwg = obj->parent;                                              \\",
          "726:     Dwg_Object_##token *_obj = obj->tio.object->tio.token;",
          "",
          "---------------"
        ],
        "src/out_json.c||src/out_json.c": [
          "File: src/out_json.c -> src/out_json.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "842: }",
          "844: #define DWG_ENTITY(token)                                                     \\",
          "845:   GCC30_DIAG_IGNORE (-Wshadow)                                                \\",
          "846:   static int dwg_json_##token (Bit_Chain *restrict dat,                       \\",
          "847:                                Dwg_Object *restrict obj)                      \\",
          "848:   {                                                                           \\",
          "850:     int error = 0;                                                            \\",
          "851:     Bit_Chain *str_dat = dat;                                                 \\",
          "852:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "",
          "[Removed Lines]",
          "849:     BITCODE_BL vcount, rcount3, rcount4;                    \\",
          "",
          "[Added Lines]",
          "845:   static int dwg_json_##token##_private (                                     \\",
          "846:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "847:       Dwg_Object *restrict obj);                                              \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "871:     _FIELD (bitsize, BL, 0);                                                  \\",
          "872:     if (_ent->preview_exists)                                                 \\",
          "873:       ENT_FIELD (preview_exists, B, 0);                                       \\",
          "876: #define DWG_ENTITY_END                                                        \\",
          "878:   }",
          "880: #define DWG_OBJECT(token)                                                     \\",
          "881:   GCC30_DIAG_IGNORE (-Wshadow)                                                \\",
          "882:   static int dwg_json_##token (Bit_Chain *restrict dat,                       \\",
          "883:                                Dwg_Object *restrict obj)                      \\",
          "884:   {                                                                           \\",
          "886:     int error = 0;                                                            \\",
          "887:     Bit_Chain *str_dat = dat;                                                 \\",
          "888:     Bit_Chain *hdl_dat = dat;                                                 \\",
          "890:     const char *name = #token;                                                \\",
          "891:     Dwg_Object_##token *_obj;                                                 \\",
          "892:     LOG_INFO (\"Object \"#token \":\\n\")                                          \\",
          "",
          "[Removed Lines]",
          "874:     error |= json_common_entity_data (dat, obj);",
          "877:   return 0;                                                                   \\",
          "885:     BITCODE_BL vcount, rcount3, rcount4;                    \\",
          "889:     Dwg_Data *dwg = obj->parent;                                              \\",
          "",
          "[Added Lines]",
          "876:     error |= json_common_entity_data (dat, obj);                              \\",
          "877:     return error | dwg_json_##token##_private (dat, hdl_dat, str_dat, obj);   \\",
          "878:   }                                                                           \\",
          "879:   static int dwg_json_##token##_private (                                     \\",
          "880:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "881:         Dwg_Object *restrict obj)                                             \\",
          "882:   {                                                                           \\",
          "883:     int error = 0;                                                            \\",
          "884:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "885:     Dwg_Data *dwg = obj->parent;                                              \\",
          "886:     Dwg_Object_Entity *_ent = obj->tio.entity;                                \\",
          "887:     Dwg_Entity_##token *_obj = _ent->tio.token;",
          "890:     return error;                                                             \\",
          "894:   static int dwg_json_##token##_private (                                     \\",
          "895:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "896:       Dwg_Object *restrict obj);                                              \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "904:     _FIELD (size, RL, 0);                                                     \\",
          "905:     _FIELD (bitsize, BL, 0);                                                  \\",
          "906:     error |= json_eed (dat, obj->tio.object);                                 \\",
          "909: #define DWG_OBJECT_END                                                        \\",
          "911:   }",
          "913: #undef JSON_3DSOLID",
          "",
          "[Removed Lines]",
          "907:     error |= json_common_object_handle_data (dat, obj);",
          "910:   return 0;                                                                   \\",
          "",
          "[Added Lines]",
          "921:     error |= json_common_object_handle_data (dat, obj);                       \\",
          "922:     return error | dwg_json_##token##_private (dat, hdl_dat, str_dat, obj);   \\",
          "923:   }                                                                           \\",
          "924:   static int dwg_json_##token##_private (                                     \\",
          "925:         Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,               \\",
          "926:         Dwg_Object *restrict obj)                                             \\",
          "927:   {                                                                           \\",
          "928:     int error = 0;                                                            \\",
          "929:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "930:     Dwg_Data *dwg = obj->parent;                                              \\",
          "931:     Dwg_Object_##token *_obj = obj->tio.object->tio.token;",
          "934:     return 0;                                                                 \\",
          "",
          "---------------"
        ],
        "src/print.c||src/print.c": [
          "File: src/print.c -> src/print.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "333:   bit_set_position (hdl_dat, obj->hdlpos)",
          "335: #define DWG_ENTITY(token)                                                     \\",
          "336:   static int dwg_print_##token (Bit_Chain *restrict dat,                      \\",
          "338:   {                                                                           \\",
          "339:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "340:     Dwg_Entity_##token *ent, *_obj;                                           \\",
          "",
          "[Removed Lines]",
          "337:                                 Dwg_Object *restrict obj)                     \\",
          "",
          "[Added Lines]",
          "336:   static int dwg_print_##token##_private (                                    \\",
          "337:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "338:       const Dwg_Object *restrict obj) {                                       \\",
          "339:     return 0;                                                                 \\",
          "340:   }                                                                           \\",
          "342:                                 const Dwg_Object *restrict obj)               \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "346:     LOG_INFO (\"Entity \" #token \":\\n\")                                         \\",
          "347:     _ent = obj->tio.entity;                                                   \\",
          "348:     _obj = ent = _ent->tio.token;                                             \\",
          "349:     LOG_TRACE (\"Entity handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle))",
          "351: #define DWG_ENTITY_END                                                        \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "354:     dwg_print_##token##_private (dat, hdl_dat, str_dat, obj);                 \\",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "353:   }",
          "355: #define DWG_OBJECT(token)                                                     \\",
          "356:   static int dwg_print_##token (Bit_Chain *restrict dat,                      \\",
          "358:   {                                                                           \\",
          "359:     BITCODE_BL vcount, rcount3, rcount4;                                      \\",
          "360:     Dwg_Object_##token *_obj;                                                 \\",
          "",
          "[Removed Lines]",
          "357:                                 Dwg_Object *restrict obj)                     \\",
          "",
          "[Added Lines]",
          "362:   static int dwg_print_##token##_private (                                    \\",
          "363:       Bit_Chain *dat, Bit_Chain *hdl_dat, Bit_Chain *str_dat,                 \\",
          "364:       const Dwg_Object *restrict obj) {                                       \\",
          "365:     return 0;                                                                 \\",
          "366:   }                                                                           \\",
          "368:                                 const Dwg_Object *restrict obj)               \\",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "363:     Dwg_Data *dwg = obj->parent;                                              \\",
          "364:     int error = 0;                                                            \\",
          "365:     LOG_INFO (\"Object \" #token \":\\n\")                                         \\",
          "366:     _obj = obj->tio.object->tio.token;                                        \\",
          "367:     LOG_TRACE (\"Object handle: \" FORMAT_H \"\\n\", ARGS_H (obj->handle))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "377:     dwg_print_##token##_private (dat, hdl_dat, str_dat, obj);                 \\",
          "",
          "---------------"
        ],
        "test/unit-testing/geopositionmarker.c||test/unit-testing/geopositionmarker.c": [
          "File: test/unit-testing/geopositionmarker.c -> test/unit-testing/geopositionmarker.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "38:     {",
          "39:       Dwg_Entity_MTEXT *_obj = mtext->tio.entity->tio.MTEXT;",
          "40:       if (mtext->fixedtype != DWG_TYPE_MTEXT)",
          "42:     }",
          "",
          "[Removed Lines]",
          "41:         fail (\"MTEXT.mtext.fixedtype %d\", mtext->fixedtype);",
          "",
          "[Added Lines]",
          "41:         fail (\"Wrong MTEXT.mtext.fixedtype %d\", mtext->fixedtype);",
          "",
          "---------------"
        ]
      }
    }
  ]
}