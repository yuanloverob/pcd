{
  "cve_id": "CVE-2019-1010283",
  "cve_desc": "Univention Corporate Server univention-directory-notifier 12.0.1-3 and earlier is affected by: CWE-213: Intentional Information Exposure. The impact is: Loss of Confidentiality. The component is: function data_on_connection() in src/callback.c. The attack vector is: network connectivity. The fixed version is: 12.0.1-4 and later.",
  "repo": "univention/univention-corporate-server",
  "patch_hash": "a28053045bd2e778c50ed1acaf4e52e1e34f6e34",
  "patch_info": {
    "commit_hash": "a28053045bd2e778c50ed1acaf4e52e1e34f6e34",
    "repo": "univention/univention-corporate-server",
    "commit_url": "https://github.com/univention/univention-corporate-server/commit/a28053045bd2e778c50ed1acaf4e52e1e34f6e34",
    "files": [
      "management/univention-directory-notifier/debian/changelog",
      "management/univention-directory-notifier/src/callback.c"
    ],
    "message": "Bug #48427 UDN: Forbid vulnerable GET_DN for VERSION >= 3\n\nUDL using PROTOCOL_3 must no longer use GET_DN but WAIT_DN - if it is\nstill used this is a protocol violation. UDL simply will not get an\nanswer.\n\nWhen UCRV 'notifier/protocol/version is set to 3, any old client still\nusing PROTOCOL_2 will get rejected while negotiating the protocol\nversion, so it is asserted that \"version >= network_procotol_version\".",
    "before_after_code_files": [
      "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
    ]
  },
  "patch_diff": {
    "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c": [
      "File: management/univention-directory-notifier/src/callback.c -> management/univention-directory-notifier/src/callback.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "199:    p+=strlen(network_line);",
      "204:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"RECV: GET_DN\");",
      "",
      "[Removed Lines]",
      "202:   } else if ( !strncmp(network_line, \"GET_DN \", strlen(\"GET_DN \")) && msg_id != UINT32_MAX && network_client_get_version(fd) > 0) {",
      "",
      "[Added Lines]",
      "202:   } else if ( !strncmp(network_line, \"GET_DN \", strlen(\"GET_DN \")) && msg_id != UINT32_MAX && version > PROTOCOL_UNKNOWN && version < PROTOCOL_3) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a09179aa260f16f8d9b0032d7c9901439129f9ba",
      "candidate_info": {
        "commit_hash": "a09179aa260f16f8d9b0032d7c9901439129f9ba",
        "repo": "univention/univention-corporate-server",
        "commit_url": "https://github.com/univention/univention-corporate-server/commit/a09179aa260f16f8d9b0032d7c9901439129f9ba",
        "files": [
          "management/univention-directory-notifier/02univention-directory-notifier.inst",
          "management/univention-directory-notifier/15univention-directory-notifier-post.inst",
          "management/univention-directory-notifier/conffiles/etc/runit/univention-directory-notifier/run",
          "management/univention-directory-notifier/debian/copyright",
          "management/univention-directory-notifier/debian/rules",
          "management/univention-directory-notifier/debian/univention-directory-notifier.init",
          "management/univention-directory-notifier/debian/univention-directory-notifier.postinst",
          "management/univention-directory-notifier/etc/network/if-post-down.d/univention-directory-notifier",
          "management/univention-directory-notifier/src/Makefile",
          "management/univention-directory-notifier/src/cache.c",
          "management/univention-directory-notifier/src/cache.h",
          "management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/callback.h",
          "management/univention-directory-notifier/src/index-dump.c",
          "management/univention-directory-notifier/src/index.c",
          "management/univention-directory-notifier/src/index.h",
          "management/univention-directory-notifier/src/network.c",
          "management/univention-directory-notifier/src/network.h",
          "management/univention-directory-notifier/src/notify.c",
          "management/univention-directory-notifier/src/notify.h",
          "management/univention-directory-notifier/src/sem.c",
          "management/univention-directory-notifier/src/sem.h",
          "management/univention-directory-notifier/src/univention-directory-notifier.c",
          "management/univention-directory-notifier/univention-replicate-one"
        ],
        "message": "Bug #48427 udn: Copyright 2019",
        "before_after_code_files": [
          "management/univention-directory-notifier/02univention-directory-notifier.inst||management/univention-directory-notifier/02univention-directory-notifier.inst",
          "management/univention-directory-notifier/15univention-directory-notifier-post.inst||management/univention-directory-notifier/15univention-directory-notifier-post.inst",
          "management/univention-directory-notifier/debian/univention-directory-notifier.init||management/univention-directory-notifier/debian/univention-directory-notifier.init",
          "management/univention-directory-notifier/debian/univention-directory-notifier.postinst||management/univention-directory-notifier/debian/univention-directory-notifier.postinst",
          "management/univention-directory-notifier/src/cache.c||management/univention-directory-notifier/src/cache.c",
          "management/univention-directory-notifier/src/cache.h||management/univention-directory-notifier/src/cache.h",
          "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/callback.h||management/univention-directory-notifier/src/callback.h",
          "management/univention-directory-notifier/src/index-dump.c||management/univention-directory-notifier/src/index-dump.c",
          "management/univention-directory-notifier/src/index.c||management/univention-directory-notifier/src/index.c",
          "management/univention-directory-notifier/src/index.h||management/univention-directory-notifier/src/index.h",
          "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c",
          "management/univention-directory-notifier/src/network.h||management/univention-directory-notifier/src/network.h",
          "management/univention-directory-notifier/src/notify.c||management/univention-directory-notifier/src/notify.c",
          "management/univention-directory-notifier/src/notify.h||management/univention-directory-notifier/src/notify.h",
          "management/univention-directory-notifier/src/sem.c||management/univention-directory-notifier/src/sem.c",
          "management/univention-directory-notifier/src/sem.h||management/univention-directory-notifier/src/sem.h",
          "management/univention-directory-notifier/src/univention-directory-notifier.c||management/univention-directory-notifier/src/univention-directory-notifier.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ],
          "candidate": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ]
        }
      },
      "candidate_diff": {
        "management/univention-directory-notifier/02univention-directory-notifier.inst||management/univention-directory-notifier/02univention-directory-notifier.inst": [
          "File: management/univention-directory-notifier/02univention-directory-notifier.inst -> management/univention-directory-notifier/02univention-directory-notifier.inst",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Directory Notifier",
          "4: #  join script",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2007-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2007-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/15univention-directory-notifier-post.inst||management/univention-directory-notifier/15univention-directory-notifier-post.inst": [
          "File: management/univention-directory-notifier/15univention-directory-notifier-post.inst -> management/univention-directory-notifier/15univention-directory-notifier-post.inst",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Directory Notifier",
          "4: #  join script",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2007-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2007-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/debian/univention-directory-notifier.init||management/univention-directory-notifier/debian/univention-directory-notifier.init": [
          "File: management/univention-directory-notifier/debian/univention-directory-notifier.init -> management/univention-directory-notifier/debian/univention-directory-notifier.init",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: # Short-Description: Univention Directory Notifier Daemon",
          "9: ### END INIT INFO",
          "10: #",
          "12: #",
          "13: # http://www.univention.de/",
          "14: #",
          "",
          "[Removed Lines]",
          "11: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "11: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/debian/univention-directory-notifier.postinst||management/univention-directory-notifier/debian/univention-directory-notifier.postinst": [
          "File: management/univention-directory-notifier/debian/univention-directory-notifier.postinst -> management/univention-directory-notifier/debian/univention-directory-notifier.postinst",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Directory Notifier",
          "4: #  postinst",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/src/cache.c||management/univention-directory-notifier/src/cache.c": [
          "File: management/univention-directory-notifier/src/cache.c -> management/univention-directory-notifier/src/cache.c"
        ],
        "management/univention-directory-notifier/src/cache.h||management/univention-directory-notifier/src/cache.h": [
          "File: management/univention-directory-notifier/src/cache.h -> management/univention-directory-notifier/src/cache.h"
        ],
        "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c": [
          "File: management/univention-directory-notifier/src/callback.c -> management/univention-directory-notifier/src/callback.c"
        ],
        "management/univention-directory-notifier/src/callback.h||management/univention-directory-notifier/src/callback.h": [
          "File: management/univention-directory-notifier/src/callback.h -> management/univention-directory-notifier/src/callback.h"
        ],
        "management/univention-directory-notifier/src/index-dump.c||management/univention-directory-notifier/src/index-dump.c": [
          "File: management/univention-directory-notifier/src/index-dump.c -> management/univention-directory-notifier/src/index-dump.c"
        ],
        "management/univention-directory-notifier/src/index.c||management/univention-directory-notifier/src/index.c": [
          "File: management/univention-directory-notifier/src/index.c -> management/univention-directory-notifier/src/index.c"
        ],
        "management/univention-directory-notifier/src/index.h||management/univention-directory-notifier/src/index.h": [
          "File: management/univention-directory-notifier/src/index.h -> management/univention-directory-notifier/src/index.h"
        ],
        "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c": [
          "File: management/univention-directory-notifier/src/network.c -> management/univention-directory-notifier/src/network.c"
        ],
        "management/univention-directory-notifier/src/network.h||management/univention-directory-notifier/src/network.h": [
          "File: management/univention-directory-notifier/src/network.h -> management/univention-directory-notifier/src/network.h"
        ],
        "management/univention-directory-notifier/src/notify.c||management/univention-directory-notifier/src/notify.c": [
          "File: management/univention-directory-notifier/src/notify.c -> management/univention-directory-notifier/src/notify.c"
        ],
        "management/univention-directory-notifier/src/notify.h||management/univention-directory-notifier/src/notify.h": [
          "File: management/univention-directory-notifier/src/notify.h -> management/univention-directory-notifier/src/notify.h"
        ],
        "management/univention-directory-notifier/src/sem.c||management/univention-directory-notifier/src/sem.c": [
          "File: management/univention-directory-notifier/src/sem.c -> management/univention-directory-notifier/src/sem.c"
        ],
        "management/univention-directory-notifier/src/sem.h||management/univention-directory-notifier/src/sem.h": [
          "File: management/univention-directory-notifier/src/sem.h -> management/univention-directory-notifier/src/sem.h"
        ],
        "management/univention-directory-notifier/src/univention-directory-notifier.c||management/univention-directory-notifier/src/univention-directory-notifier.c": [
          "File: management/univention-directory-notifier/src/univention-directory-notifier.c -> management/univention-directory-notifier/src/univention-directory-notifier.c"
        ]
      }
    },
    {
      "candidate_hash": "5b69a4ba48b674e1a3e91f2ba2e0502281037e8d",
      "candidate_info": {
        "commit_hash": "5b69a4ba48b674e1a3e91f2ba2e0502281037e8d",
        "repo": "univention/univention-corporate-server",
        "commit_url": "https://github.com/univention/univention-corporate-server/commit/5b69a4ba48b674e1a3e91f2ba2e0502281037e8d",
        "files": [
          "management/univention-join/20univention-join.inst",
          "management/univention-join/35univention-management-console-module-join.inst",
          "management/univention-join/check_join_status.sh",
          "management/univention-join/debian/copyright",
          "management/univention-join/debian/rules",
          "management/univention-join/debian/univention-join.postinst",
          "management/univention-join/joinscripthelper.lib",
          "management/univention-join/umc/js/join.js",
          "management/univention-join/umc/js/join/Form.js",
          "management/univention-join/umc/js/join/Grid.js",
          "management/univention-join/umc/python/join/__init__.py",
          "management/univention-join/univention-install-joinscript",
          "management/univention-join/univention-join",
          "management/univention-join/univention-run-join-scripts",
          "management/univention-join/univention-server-join"
        ],
        "message": "Bug #48427 join: Copyright 2019",
        "before_after_code_files": [
          "management/univention-join/20univention-join.inst||management/univention-join/20univention-join.inst",
          "management/univention-join/35univention-management-console-module-join.inst||management/univention-join/35univention-management-console-module-join.inst",
          "management/univention-join/check_join_status.sh||management/univention-join/check_join_status.sh",
          "management/univention-join/debian/univention-join.postinst||management/univention-join/debian/univention-join.postinst",
          "management/univention-join/joinscripthelper.lib||management/univention-join/joinscripthelper.lib",
          "management/univention-join/umc/js/join.js||management/univention-join/umc/js/join.js",
          "management/univention-join/umc/js/join/Form.js||management/univention-join/umc/js/join/Form.js",
          "management/univention-join/umc/js/join/Grid.js||management/univention-join/umc/js/join/Grid.js",
          "management/univention-join/umc/python/join/__init__.py||management/univention-join/umc/python/join/__init__.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "management/univention-join/20univention-join.inst||management/univention-join/20univention-join.inst": [
          "File: management/univention-join/20univention-join.inst -> management/univention-join/20univention-join.inst",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Join",
          "4: #  join script",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-join/35univention-management-console-module-join.inst||management/univention-join/35univention-management-console-module-join.inst": [
          "File: management/univention-join/35univention-management-console-module-join.inst -> management/univention-join/35univention-management-console-module-join.inst",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: # Univention Management Console Module join",
          "5: #  join script",
          "6: #",
          "8: #",
          "9: # http://www.univention.de/",
          "10: #",
          "",
          "[Removed Lines]",
          "7: # Copyright 2011-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "7: # Copyright 2011-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-join/check_join_status.sh||management/univention-join/check_join_status.sh": [
          "File: management/univention-join/check_join_status.sh -> management/univention-join/check_join_status.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Join",
          "4: #  helper script: checks the join status of the local system",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-join/debian/univention-join.postinst||management/univention-join/debian/univention-join.postinst": [
          "File: management/univention-join/debian/univention-join.postinst -> management/univention-join/debian/univention-join.postinst",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: # Univention Join",
          "4: #  postinst script for the debian package",
          "5: #",
          "7: #",
          "8: # http://www.univention.de/",
          "9: #",
          "",
          "[Removed Lines]",
          "6: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "6: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-join/joinscripthelper.lib||management/univention-join/joinscripthelper.lib": [
          "File: management/univention-join/joinscripthelper.lib -> management/univention-join/joinscripthelper.lib",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: # Helper lib for writing join-scripts.",
          "2: #",
          "4: #",
          "5: # http://www.univention.de/",
          "6: #",
          "",
          "[Removed Lines]",
          "3: # Copyright 2004-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "3: # Copyright 2004-2019 Univention GmbH",
          "",
          "---------------"
        ],
        "management/univention-join/umc/js/join.js||management/univention-join/umc/js/join.js": [
          "File: management/univention-join/umc/js/join.js -> management/univention-join/umc/js/join.js"
        ],
        "management/univention-join/umc/js/join/Form.js||management/univention-join/umc/js/join/Form.js": [
          "File: management/univention-join/umc/js/join/Form.js -> management/univention-join/umc/js/join/Form.js"
        ],
        "management/univention-join/umc/js/join/Grid.js||management/univention-join/umc/js/join/Grid.js": [
          "File: management/univention-join/umc/js/join/Grid.js -> management/univention-join/umc/js/join/Grid.js"
        ],
        "management/univention-join/umc/python/join/__init__.py||management/univention-join/umc/python/join/__init__.py": [
          "File: management/univention-join/umc/python/join/__init__.py -> management/univention-join/umc/python/join/__init__.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: # Univention Management Console",
          "5: #  module: system usage statistics",
          "6: #",
          "8: #",
          "9: # http://www.univention.de/",
          "10: #",
          "",
          "[Removed Lines]",
          "7: # Copyright 2011-2018 Univention GmbH",
          "",
          "[Added Lines]",
          "7: # Copyright 2011-2019 Univention GmbH",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ac0c422bb806f2860343804aa240bbe011e57956",
      "candidate_info": {
        "commit_hash": "ac0c422bb806f2860343804aa240bbe011e57956",
        "repo": "univention/univention-corporate-server",
        "commit_url": "https://github.com/univention/univention-corporate-server/commit/ac0c422bb806f2860343804aa240bbe011e57956",
        "files": [
          "test/ucs-test/debian/changelog",
          "test/ucs-test/tests/10_ldap/52listener-filter",
          "test/utils/get_notifier_id.py"
        ],
        "message": "Bug #48427 test: Use UDN protocol version 3",
        "before_after_code_files": [
          "test/utils/get_notifier_id.py||test/utils/get_notifier_id.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "test/utils/get_notifier_id.py||test/utils/get_notifier_id.py": [
          "File: test/utils/get_notifier_id.py -> test/utils/get_notifier_id.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:         sys.exit(1)",
          "49:     try:",
          "53:         sock.recv(100)",
          "55:         sock.send('MSGID: 1\\nGET_ID\\n\\n')",
          "",
          "[Removed Lines]",
          "50:         sock = socket.create_connection((master, 6669))",
          "52:         sock.send('Version: 2\\nCapabilities: \\n\\n')",
          "",
          "[Added Lines]",
          "50:         sock = socket.create_connection((master, 6669), 60.0)",
          "52:         sock.send('Version: 3\\nCapabilities: \\n\\n')",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f7a42a6f09c7584dc31acbcd01954522993645d",
      "candidate_info": {
        "commit_hash": "3f7a42a6f09c7584dc31acbcd01954522993645d",
        "repo": "univention/univention-corporate-server",
        "commit_url": "https://github.com/univention/univention-corporate-server/commit/3f7a42a6f09c7584dc31acbcd01954522993645d",
        "files": [
          "management/univention-directory-notifier/doc/protokoll3.txt",
          "management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/network.c"
        ],
        "message": "Bug #48427 udn: Implement new WAIT_ID command\n\nto wait until transaction ID is known. This works like the old GET_ID\nand GET_DN combined. The later is insecure and will be deprecated.\nIt does not return the DN itself, but the last transaction ID like\n\"GET_I\".  The client must then query\nldap:///cn=translog?univentionTranslogDn,univentionTranslogCommand?one?(univentionTranslogIndex=%d)\n\nThe command will return immediately if the transaction already has\nhappened, otherwise it will block and return later.",
        "before_after_code_files": [
          "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ],
          "candidate": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ]
        }
      },
      "candidate_diff": {
        "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c": [
          "File: management/univention-directory-notifier/src/callback.c -> management/univention-directory-notifier/src/callback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "259:    p+=strlen(network_line)+1;",
          "260:    msg_id = UINT32_MAX;",
          "263:   } else if ( !strncmp(network_line, \"GET_ID\", strlen(\"GET_ID\")) && msg_id != UINT32_MAX  && network_client_get_version(fd) > 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "262:   } else if (!strncmp(p, \"WAIT_ID \", 8) && msg_id != UINT32_MAX && version >= PROTOCOL_3) {",
          "263:    char *head = network_line, *end;",
          "264:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"RECV: WAIT_ID\");",
          "265:    id = strtoul(head + 8, &end, 10);",
          "266:    if (!head[8] || *end)",
          "267:     goto failed;",
          "268:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"id: %ld\", id);",
          "270:    if (id <= notify_last_id.id) {",
          "271:     snprintf(string, sizeof(string), \"MSGID: %ld\\n%ld\\n\\n\", msg_id, notify_last_id.id);",
          "272:     write(fd, string, strlen(string));",
          "273:    } else {",
          "275:     network_client_set_next_id(fd, id);",
          "276:     network_client_set_msg_id(fd, msg_id);",
          "277:    }",
          "279:    p += strlen(network_line) + 1;",
          "280:    msg_id = UINT32_MAX;",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c": [
          "File: management/univention-directory-notifier/src/network.c -> management/univention-directory-notifier/src/network.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: extern void unset_schema_callback ();",
          "68: extern void unset_listener_callback ();",
          "70: enum network_protocol network_procotol_version = PROTOCOL_2;",
          "72: int network_create_socket( int port )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: extern NotifyId_t notify_last_id;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "477:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"Wrote to Listener fd = %d\\n\",tmp->fd);",
          "478:    if ( tmp->next_id == id ) {",
          "479:     memset(string, 0, 8192 );",
          "480:     sprintf(string,\"MSGID: %ld\\n\",tmp->msg_id);",
          "481:     strncat(string,buf, l_buf);",
          "482:     strcat(string,\"\\n\");",
          "483:     univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"Wrote to Listener fd = %d[%s]\\n\",tmp->fd, string);",
          "484:     rc = write(tmp->fd, string, strlen(string) );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "482:     switch (tmp->version) {",
          "483:      case PROTOCOL_2:",
          "487:       break;",
          "488:      case PROTOCOL_3:",
          "489:       snprintf(string, sizeof(string), \"MSGID: %ld\\n%ld\\n\\n\", tmp->msg_id, notify_last_id.id);",
          "490:       break;",
          "491:      default:",
          "492:       univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_WARN, \"v%d not implemented fd=%d\", tmp->version, tmp->fd);",
          "493:       continue;",
          "494:     }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a9e7b1d883986014381c80a7152b7b79cd60f8e2",
      "candidate_info": {
        "commit_hash": "a9e7b1d883986014381c80a7152b7b79cd60f8e2",
        "repo": "univention/univention-corporate-server",
        "commit_url": "https://github.com/univention/univention-corporate-server/commit/a9e7b1d883986014381c80a7152b7b79cd60f8e2",
        "files": [
          "management/univention-directory-notifier/doc/protokoll3.txt",
          "management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/network.c"
        ],
        "message": "Bug #48427 udn: Implement new WAIT_ID command\n\nto wait until transaction ID is known. This works like the old GET_ID\nand GET_DN combined. The later is insecure and will be deprecated.\nIt does not return the DN itself, but the last transaction ID like\n\"GET_I\".  The client must then query\nldap:///cn=translog?univentionTranslogDn,univentionTranslogCommand?one?(univentionTranslogIndex=%d)\n\nThe command will return immediately if the transaction already has\nhappened, otherwise it will block and return later.\n\nForbid vulnerable GET_DN for VERSION >= 3\n\nUDL using PROTOCOL_3 must no longer use GET_DN but WAIT_DN - if it is\nstill used this is a protocol violation. UDL simply will not get an\nanswer.\n\nWhen UCRV 'notifier/protocol/version is set to 3, any old client still\nusing PROTOCOL_2 will get rejected while negotiating the protocol\nversion, so it is asserted that \"version >= network_procotol_version\".",
        "before_after_code_files": [
          "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c",
          "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ],
          "candidate": [
            "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c"
          ]
        }
      },
      "candidate_diff": {
        "management/univention-directory-notifier/src/callback.c||management/univention-directory-notifier/src/callback.c": [
          "File: management/univention-directory-notifier/src/callback.c -> management/univention-directory-notifier/src/callback.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "199:    p+=strlen(network_line);",
          "204:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"RECV: GET_DN\");",
          "",
          "[Removed Lines]",
          "202:   } else if ( !strncmp(network_line, \"GET_DN \", strlen(\"GET_DN \")) && msg_id != UINT32_MAX && network_client_get_version(fd) > 0) {",
          "",
          "[Added Lines]",
          "202:   } else if ( !strncmp(network_line, \"GET_DN \", strlen(\"GET_DN \")) && msg_id != UINT32_MAX && version > PROTOCOL_UNKNOWN && version < PROTOCOL_3) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "259:    p+=strlen(network_line)+1;",
          "260:    msg_id = UINT32_MAX;",
          "263:   } else if ( !strncmp(network_line, \"GET_ID\", strlen(\"GET_ID\")) && msg_id != UINT32_MAX  && network_client_get_version(fd) > 0) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "262:   } else if (!strncmp(p, \"WAIT_ID \", 8) && msg_id != UINT32_MAX && version >= PROTOCOL_3) {",
          "263:    char *head = network_line, *end;",
          "264:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"RECV: WAIT_ID\");",
          "265:    id = strtoul(head + 8, &end, 10);",
          "266:    if (!head[8] || *end)",
          "267:     goto failed;",
          "268:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"id: %ld\", id);",
          "270:    if (id <= notify_last_id.id) {",
          "271:     snprintf(string, sizeof(string), \"MSGID: %ld\\n%ld\\n\\n\", msg_id, notify_last_id.id);",
          "272:     write(fd, string, strlen(string));",
          "273:    } else {",
          "275:     network_client_set_next_id(fd, id);",
          "276:     network_client_set_msg_id(fd, msg_id);",
          "277:    }",
          "279:    p += strlen(network_line) + 1;",
          "280:    msg_id = UINT32_MAX;",
          "",
          "---------------"
        ],
        "management/univention-directory-notifier/src/network.c||management/univention-directory-notifier/src/network.c": [
          "File: management/univention-directory-notifier/src/network.c -> management/univention-directory-notifier/src/network.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "67: extern void unset_schema_callback ();",
          "68: extern void unset_listener_callback ();",
          "70: enum network_protocol network_procotol_version = PROTOCOL_2;",
          "72: int network_create_socket( int port )",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "70: extern NotifyId_t notify_last_id;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "477:    univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"Wrote to Listener fd = %d\\n\",tmp->fd);",
          "478:    if ( tmp->next_id == id ) {",
          "479:     memset(string, 0, 8192 );",
          "480:     sprintf(string,\"MSGID: %ld\\n\",tmp->msg_id);",
          "481:     strncat(string,buf, l_buf);",
          "482:     strcat(string,\"\\n\");",
          "483:     univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_ALL, \"Wrote to Listener fd = %d[%s]\\n\",tmp->fd, string);",
          "484:     rc = write(tmp->fd, string, strlen(string) );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "482:     switch (tmp->version) {",
          "483:      case PROTOCOL_2:",
          "487:       break;",
          "488:      case PROTOCOL_3:",
          "489:       snprintf(string, sizeof(string), \"MSGID: %ld\\n%ld\\n\\n\", tmp->msg_id, notify_last_id.id);",
          "490:       break;",
          "491:      default:",
          "492:       univention_debug(UV_DEBUG_TRANSFILE, UV_DEBUG_WARN, \"v%d not implemented fd=%d\", tmp->version, tmp->fd);",
          "493:       continue;",
          "494:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}