{
  "cve_id": "CVE-2017-3731",
  "cve_desc": "If an SSL/TLS server or client is running on a 32-bit host, and a specific cipher is being used, then a truncated packet can cause that server or client to perform an out-of-bounds read, usually resulting in a crash. For OpenSSL 1.1.0, the crash can be triggered when using CHACHA20/POLY1305; users should upgrade to 1.1.0d. For Openssl 1.0.2, the crash can be triggered when using RC4-MD5; users who have not disabled that algorithm should update to 1.0.2k.",
  "repo": "openssl/openssl",
  "patch_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
  "patch_info": {
    "commit_hash": "00d965474b22b54e4275232bc71ee0c699c5cd21",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/00d965474b22b54e4275232bc71ee0c699c5cd21",
    "files": [
      "crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c"
    ],
    "message": "crypto/evp: harden AEAD ciphers.\n\nOriginally a crash in 32-bit build was reported CHACHA20-POLY1305\ncipher. The crash is triggered by truncated packet and is result\nof excessive hashing to the edge of accessible memory. Since hash\noperation is read-only it is not considered to be exploitable\nbeyond a DoS condition. Other ciphers were hardened.\n\nThanks to Robert \u015awi\u0119cki for report.\n\nCVE-2017-3731\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "crypto/evp/e_aes.c||crypto/evp/e_aes.c",
      "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c"
    ]
  },
  "patch_diff": {
    "crypto/evp/e_aes.c||crypto/evp/e_aes.c": [
      "File: crypto/evp/e_aes.c -> crypto/evp/e_aes.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1388:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1389:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1391:             len -= EVP_GCM_TLS_EXPLICIT_IV_LEN;",
      "1394:                 len -= EVP_GCM_TLS_TAG_LEN;",
      "1395:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1396:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1397:         }",
      "",
      "[Removed Lines]",
      "1393:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1391:             if (len < EVP_GCM_TLS_EXPLICIT_IV_LEN)",
      "1392:                 return 0;",
      "1395:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1396:                 if (len < EVP_GCM_TLS_TAG_LEN)",
      "1397:                     return 0;",
      "1399:             }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1946:                 EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] << 8",
      "1947:                 | EVP_CIPHER_CTX_buf_noconst(c)[arg - 1];",
      "1949:             len -= EVP_CCM_TLS_EXPLICIT_IV_LEN;",
      "1952:                 len -= cctx->M;",
      "1953:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 2] = len >> 8;",
      "1954:             EVP_CIPHER_CTX_buf_noconst(c)[arg - 1] = len & 0xff;",
      "1955:         }",
      "",
      "[Removed Lines]",
      "1951:             if (!EVP_CIPHER_CTX_encrypting(c))",
      "",
      "[Added Lines]",
      "1954:             if (len < EVP_CCM_TLS_EXPLICIT_IV_LEN)",
      "1955:                 return 0;",
      "1958:             if (!EVP_CIPHER_CTX_encrypting(c)) {",
      "1959:                 if (len < cctx->M)",
      "1960:                     return 0;",
      "1962:             }",
      "",
      "---------------"
    ],
    "crypto/evp/e_chacha20_poly1305.c||crypto/evp/e_chacha20_poly1305.c": [
      "File: crypto/evp/e_chacha20_poly1305.c -> crypto/evp/e_chacha20_poly1305.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "398:             len = aad[EVP_AEAD_TLS1_AAD_LEN - 2] << 8 |",
      "399:                   aad[EVP_AEAD_TLS1_AAD_LEN - 1];",
      "400:             if (!ctx->encrypt) {",
      "402:                 memcpy(temp, aad, EVP_AEAD_TLS1_AAD_LEN - 2);",
      "403:                 aad = temp;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "401:                 if (len < POLY1305_BLOCK_SIZE)",
      "402:                     return 0;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "39ff4d7adde80b87c994649559921b9189b9612f",
      "candidate_info": {
        "commit_hash": "39ff4d7adde80b87c994649559921b9189b9612f",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/39ff4d7adde80b87c994649559921b9189b9612f",
        "files": [
          "crypto/asn1/a_int.c",
          "crypto/asn1/x_long.c",
          "crypto/bio/b_print.c"
        ],
        "message": "Fix VC warnings about unary minus to an unsigned type.\n\nReviewed-by: Andy Polyakov <appro@openssl.org>\nGH: #2230\n(cherry picked from commit 68d4bcfd0651c7ea5d37ca52abc0d2e6e6b3bd20)",
        "before_after_code_files": [
          "crypto/asn1/a_int.c||crypto/asn1/a_int.c",
          "crypto/asn1/x_long.c||crypto/asn1/x_long.c",
          "crypto/bio/b_print.c||crypto/bio/b_print.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/asn1/a_int.c||crypto/asn1/a_int.c": [
          "File: crypto/asn1/a_int.c -> crypto/asn1/a_int.c"
        ],
        "crypto/asn1/x_long.c||crypto/asn1/x_long.c": [
          "File: crypto/asn1/x_long.c -> crypto/asn1/x_long.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     if (ltmp < 0)",
          "80:     else",
          "81:         utmp = ltmp;",
          "82:     clen = BN_num_bits_word(utmp);",
          "",
          "[Removed Lines]",
          "79:         utmp = -(unsigned long)ltmp - 1;",
          "",
          "[Added Lines]",
          "79:         utmp = 0 - (unsigned long)ltmp - 1;",
          "",
          "---------------"
        ],
        "crypto/bio/b_print.c||crypto/bio/b_print.c": [
          "File: crypto/bio/b_print.c -> crypto/bio/b_print.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "451:     if (!(flags & DP_F_UNSIGNED)) {",
          "452:         if (value < 0) {",
          "453:             signvalue = '-';",
          "455:         } else if (flags & DP_F_PLUS)",
          "456:             signvalue = '+';",
          "457:         else if (flags & DP_F_SPACE)",
          "",
          "[Removed Lines]",
          "454:             uvalue = -(unsigned LLONG)value;",
          "",
          "[Added Lines]",
          "454:             uvalue = 0 - (unsigned LLONG)value;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "aa25177560344e78d55aaaf20927b5cf42a294b7",
      "candidate_info": {
        "commit_hash": "aa25177560344e78d55aaaf20927b5cf42a294b7",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/aa25177560344e78d55aaaf20927b5cf42a294b7",
        "files": [
          "util/build.info",
          "util/local_shlib.com.in",
          "util/shareable_image_wrap.c.in",
          "util/unlocal_shlib.com.in"
        ],
        "message": "VMS: throw away [.util]shareable_image_wrap.c.in and add replacement scripts\n\n[.util]shareable_image_wrap.c.in was never useful because lib$spawn()\ninsisted on combining stdout and stderr into one.\n\nInstead, we introduce two scripts that create and destroy a temporary\nenvironment where the local shareable images become available,\n[.util]local_shlib.com and [.util]unlocal_shlib.com.\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2948)",
        "before_after_code_files": [
          "util/build.info||util/build.info",
          "util/local_shlib.com.in||util/local_shlib.com.in",
          "util/shareable_image_wrap.c.in||util/shareable_image_wrap.c.in",
          "util/unlocal_shlib.com.in||util/unlocal_shlib.com.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "util/build.info||util/build.info": [
          "File: util/build.info -> util/build.info",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: IF[{- $target{build_scheme}->[1] eq \"VMS\" -}]",
          "5: ELSIF[{- $target{build_scheme}->[1] eq \"unix\" -}]",
          "6:  SCRIPTS_NO_INST=shlib_wrap.sh",
          "7:  SOURCE[shlib_wrap.sh]=shlib_wrap.sh.in",
          "",
          "[Removed Lines]",
          "2:  PROGRAMS_NO_INST=shlib_wrap",
          "3:  SOURCE[shlib_wrap]=shareable_image_wrap.c",
          "4:  GENERATE[shareable_image_wrap.c]=shareable_image_wrap.c.in",
          "",
          "[Added Lines]",
          "2:  SCRIPTS_NO_INST=local_shlib.com unlocal_shlib.com",
          "3:  SOURCE[local_shlib.com]=local_shlib.com.in",
          "4:  SOURCE[unlocal_shlib.com]=unlocal_shlib.com.in",
          "",
          "---------------"
        ],
        "util/local_shlib.com.in||util/local_shlib.com.in": [
          "File: util/local_shlib.com.in -> util/local_shlib.com.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: ${-",
          "2:   use File::Spec::Functions qw(rel2abs);",
          "4:   my $bldtop = rel2abs($config{builddir});",
          "5:   our %names = ( map { $_ => $bldtop.$_.\".EXE\" }",
          "6:                  map { $unified_info{sharednames}->{$_} || () }",
          "7:                  @{$unified_info{libraries}} );",
          "8:   \"\" -}",
          "9: $       ! Create a local environment with the shared library logical names",
          "10: $       ! properly set.  Undo this with unlocal_shlib.com",
          "11: $",
          "12: $       OPENSSL_NAMES := OPENSSL_NAMES_'F$GETJPI(\"\",\"PID\")'",
          "13: $       CREATE/NAME_TABLE/PARENT_TABLE=LNM$PROCESS_DIRECTORY 'OPENSSL_NAMES'",
          "14: $       DEFINE/TABLE='OPENSSL_NAMES' OSSL_FLAG YES",
          "15: $",
          "16: $       NAMES := {- join(\",\", keys %names); -}",
          "17: {-",
          "18:   join(\"\\n\", map { \"\\$       __$_ = \\\"\".$names{$_}.\"\\\"\" } keys %names);",
          "19: -}",
          "20: $       I = 0",
          "21: $       LOOP:",
          "22: $           E = F$ELEMENT(I,\",\",NAMES)",
          "23: $           I = I + 1",
          "24: $           IF E .EQS. \",\" THEN GOTO ENDLOOP",
          "25: $           EV = __'E'",
          "26: $           OLDV = F$TRNLNM(E,\"LNM$PROCESS\")",
          "27: $           IF OLDV .NES. \"\" THEN DEFINE/TABLE='OPENSSL_NAMES' 'E' 'OLDV'",
          "28: $           DEFINE 'E' 'EV'",
          "29: $           GOTO LOOP",
          "30: $       ENDLOOP:",
          "",
          "---------------"
        ],
        "util/shareable_image_wrap.c.in||util/shareable_image_wrap.c.in": [
          "File: util/shareable_image_wrap.c.in -> util/shareable_image_wrap.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "util/unlocal_shlib.com.in||util/unlocal_shlib.com.in": [
          "File: util/unlocal_shlib.com.in -> util/unlocal_shlib.com.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: ${-",
          "2:   use File::Spec::Functions qw(rel2abs);",
          "4:   my $bldtop = rel2abs($config{builddir});",
          "5:   our %names = ( map { $_ => $bldtop.$_.\".EXE\" }",
          "6:                  map { $unified_info{sharednames}->{$_} || () }",
          "7:                  @{$unified_info{libraries}} );",
          "8:   \"\" -}",
          "9: $       ! Remove the local environment created by local_shlib.com",
          "10: $",
          "11: $       OPENSSL_NAMES := OPENSSL_NAMES_'F$GETJPI(\"\",\"PID\")'",
          "12: $       IF F$TRNLNM(\"OSSL_FLAG\",OPENSSL_NAMES) .EQS. \"\" THEN EXIT 0",
          "13: $",
          "14: $       NAMES := {- join(\",\", keys %names); -}",
          "15: $       I = 0",
          "16: $       LOOP:",
          "17: $           E = F$ELEMENT(I,\",\",NAMES)",
          "18: $           I = I + 1",
          "19: $           IF E .EQS. \",\" THEN GOTO ENDLOOP",
          "20: $           OLDV = F$TRNLNM(E,OPENSSL_NAMES)",
          "21: $           DEASSIGN 'E'",
          "22: $           IF OLDV .NES. \"\" THEN DEFINE 'E' 'OLDV'",
          "23: $           GOTO LOOP",
          "24: $       ENDLOOP:",
          "25: $",
          "26: $       DEASSIGN 'OPENSSL_NAMES' /TABLE=LNM$PROCESS_DIRECTORY",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "51d8e5ea866a7d606e4f2aa5e45c2f7df2270ace",
      "candidate_info": {
        "commit_hash": "51d8e5ea866a7d606e4f2aa5e45c2f7df2270ace",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/51d8e5ea866a7d606e4f2aa5e45c2f7df2270ace",
        "files": [
          "Configurations/00-base-templates.conf"
        ],
        "message": "Windows: use default ZLIB1 unless --with-zlib-lib is set\n\nReviewed-by: Andy Polyakov <appro@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1772)\n(cherry picked from commit 475592e2419c5cb3098dfea4c9229d0c09ea7010)",
        "before_after_code_files": [
          "Configurations/00-base-templates.conf||Configurations/00-base-templates.conf"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "Configurations/00-base-templates.conf||Configurations/00-base-templates.conf": [
          "File: Configurations/00-base-templates.conf -> Configurations/00-base-templates.conf",
          "--- Hunk 1 ---",
          "[Context before]",
          "80:             sub {",
          "81:                 unless ($disabled{zlib}) {",
          "82:                     if (defined($disabled{\"zlib-dynamic\"})) {",
          "84:                     }",
          "85:                 }",
          "88:         ld              => \"link\",",
          "89:         lflags          => \"/nologo\",",
          "",
          "[Removed Lines]",
          "83:                         return $withargs{zlib_lib};",
          "86:                 return (); },",
          "",
          "[Added Lines]",
          "83:                         return $withargs{zlib_lib} // \"ZLIB1\";",
          "86:                 return ();",
          "87:             },",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "955286c9f38c11b8be719d632fa9267eb13467f8",
      "candidate_info": {
        "commit_hash": "955286c9f38c11b8be719d632fa9267eb13467f8",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/955286c9f38c11b8be719d632fa9267eb13467f8",
        "files": [
          "crypto/async/async_wait.c"
        ],
        "message": "Further improvements to ASYNC_WAIT_CTX_clear_fd\n\nRemove call to cleanup function\nUse only one loop to find previous element\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\nReviewed-by: Matt Caswell <matt@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/2581)\n(cherry picked from commit 219aa86cb04e1bfc9c156fab18da2f767502afb2)",
        "before_after_code_files": [
          "crypto/async/async_wait.c||crypto/async/async_wait.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/async/async_wait.c||crypto/async/async_wait.c": [
          "File: crypto/async/async_wait.c -> crypto/async/async_wait.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "139: int ASYNC_WAIT_CTX_clear_fd(ASYNC_WAIT_CTX *ctx, const void *key)",
          "140: {",
          "143:     curr = ctx->fds;",
          "144:     while (curr != NULL) {",
          "147:             curr = curr->next;",
          "148:             continue;",
          "",
          "[Removed Lines]",
          "141:     struct fd_lookup_st *curr;",
          "145:         if (curr->del) {",
          "",
          "[Added Lines]",
          "141:     struct fd_lookup_st *curr, *prev;",
          "144:     prev = NULL;",
          "146:         if (curr->del == 1) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "152:             if (curr->add == 1) {",
          "153:                 if (ctx->fds == curr) {",
          "154:                     ctx->fds = curr->next;",
          "164:                     prev->next = curr->next;",
          "165:                 }",
          "173:                 OPENSSL_free(curr);",
          "174:                 ctx->numadd--;",
          "175:                 return 1;",
          "",
          "[Removed Lines]",
          "155:                 }",
          "156:                 else {",
          "157:                     struct fd_lookup_st *prev = ctx->fds;",
          "158:                     while (prev->next != curr && prev->next != NULL) {",
          "159:                         prev = prev->next;",
          "160:                     }",
          "161:                     if (prev->next == NULL) {",
          "162:                         return 1;",
          "163:                     }",
          "171:                 if (curr->cleanup != NULL)",
          "172:                     curr->cleanup(ctx, curr->key, curr->fd, curr->custom_data);",
          "",
          "[Added Lines]",
          "156:                 } else {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "184:             ctx->numdel++;",
          "185:             return 1;",
          "186:         }",
          "187:         curr = curr->next;",
          "188:     }",
          "189:     return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "177:         prev = curr;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "98bdd4363bd657304d88fb4b64a684e26c66b774",
      "candidate_info": {
        "commit_hash": "98bdd4363bd657304d88fb4b64a684e26c66b774",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/98bdd4363bd657304d88fb4b64a684e26c66b774",
        "files": [
          "crypto/x509/t_x509.c"
        ],
        "message": "Add missing braces.\n\nReviewed-by: Richard Levitte <levitte@openssl.org>\nGH: #2234\n(cherry picked from commit c4a60150914fc260c3fc2854e13372c870bdde76)",
        "before_after_code_files": [
          "crypto/x509/t_x509.c||crypto/x509/t_x509.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/x509/t_x509.c||crypto/x509/t_x509.c": [
          "File: crypto/x509/t_x509.c -> crypto/x509/t_x509.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "97:             if (bs->type == V_ASN1_NEG_INTEGER) {",
          "98:                 ul = 0 - (unsigned long)l;",
          "99:                 neg = \"-\";",
          "101:                 ul = l;",
          "102:                 neg = \"\";",
          "103:             if (BIO_printf(bp, \" %s%lu (%s0x%lx)\\n\", neg, ul, neg, ul) <= 0)",
          "104:                 goto err;",
          "105:         } else {",
          "",
          "[Removed Lines]",
          "100:             } else",
          "",
          "[Added Lines]",
          "100:             } else {",
          "103:             }",
          "",
          "---------------"
        ]
      }
    }
  ]
}