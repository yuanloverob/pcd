{
  "cve_id": "CVE-2016-6663",
  "cve_desc": "Race condition in Oracle MySQL before 5.5.52, 5.6.x before 5.6.33, 5.7.x before 5.7.15, and 8.x before 8.0.1; MariaDB before 5.5.52, 10.0.x before 10.0.28, and 10.1.x before 10.1.18; Percona Server before 5.5.51-38.2, 5.6.x before 5.6.32-78-1, and 5.7.x before 5.7.14-8; and Percona XtraDB Cluster before 5.5.41-37.0, 5.6.x before 5.6.32-25.17, and 5.7.x before 5.7.14-26.17 allows local users with certain permissions to gain privileges by leveraging use of my_copystat by REPAIR TABLE to repair a MyISAM table.",
  "repo": "mysql/mysql-server",
  "patch_hash": "4e5473862e6852b0f3802b0cd0c6fa10b5253291",
  "patch_info": {
    "commit_hash": "4e5473862e6852b0f3802b0cd0c6fa10b5253291",
    "repo": "mysql/mysql-server",
    "commit_url": "https://github.com/mysql/mysql-server/commit/4e5473862e6852b0f3802b0cd0c6fa10b5253291",
    "files": [
      "include/my_sys.h",
      "include/myisam.h",
      "mysys/my_redel.c",
      "storage/myisam/ha_myisam.cc",
      "storage/myisam/mi_check.c",
      "storage/myisam/myisamchk.c"
    ],
    "message": "Bug#24388746: PRIVILEGE ESCALATION AND RACE CONDITION USING CREATE TABLE\n\nDuring REPAIR TABLE of a MyISAM table, a temporary data file (.TMD)\nis created. When repair finishes, this file is renamed to the original\n.MYD file. The problem was that during this rename, we copied the\nstats from the old file to the new file with chmod/chown. If a user\nmanaged to replace the temporary file before chmod/chown was executed,\nit was possible to get an arbitrary file with the privileges of the\nmysql user.\n\nThis patch fixes the problem by not copying stats from the old\nfile to the new file. This is not needed as the new file was\ncreated with the correct stats. This fix only changes server\nbehavior - external utilities such as myisamchk still does\nchmod/chown.\n\nNo test case provided since the problem involves synchronization\nwith file system operations.",
    "before_after_code_files": [
      "include/my_sys.h||include/my_sys.h",
      "include/myisam.h||include/myisam.h",
      "mysys/my_redel.c||mysys/my_redel.c",
      "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc",
      "storage/myisam/mi_check.c||storage/myisam/mi_check.c",
      "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c"
    ]
  },
  "patch_diff": {
    "include/my_sys.h||include/my_sys.h": [
      "File: include/my_sys.h -> include/my_sys.h"
    ],
    "include/myisam.h||include/myisam.h": [
      "File: include/myisam.h -> include/myisam.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "4:    This program is free software; you can redistribute it and/or modify",
      "5:    it under the terms of the GNU General Public License as published by",
      "",
      "[Removed Lines]",
      "2:    Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.",
      "",
      "[Added Lines]",
      "2:    Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "426: int chk_key(MI_CHECK *param, MI_INFO *info);",
      "427: int chk_data_link(MI_CHECK *param, MI_INFO *info,int extend);",
      "428: int mi_repair(MI_CHECK *param, register MI_INFO *info,",
      "431: int mi_repair_by_sort(MI_CHECK *param, register MI_INFO *info,",
      "433: int mi_repair_parallel(MI_CHECK *param, register MI_INFO *info,",
      "435: int change_to_newfile(const char * filename, const char * old_ext,",
      "436:         const char * new_ext, myf myflags);",
      "437: int lock_file(MI_CHECK *param, File file, my_off_t start, int lock_type,",
      "",
      "[Removed Lines]",
      "429:        char * name, int rep_quick);",
      "430: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name);",
      "432:         const char * name, int rep_quick);",
      "434:         const char * name, int rep_quick);",
      "",
      "[Added Lines]",
      "429:        char * name, int rep_quick, my_bool no_copy_stat);",
      "430: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name,",
      "431:                   my_bool no_copy_stat);",
      "433:         const char * name, int rep_quick, my_bool no_copy_stat);",
      "435:                        const char * name, int rep_quick, my_bool no_copy_stat);",
      "",
      "---------------"
    ],
    "mysys/my_redel.c||mysys/my_redel.c": [
      "File: mysys/my_redel.c -> mysys/my_redel.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "36:    if MY_REDEL_MAKE_COPY is given, then the orginal file",
      "37:    is renamed to org_name-'current_time'.BAK",
      "40: #define REDEL_EXT \".BAK\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "39:           if MY_REDEL_NO_COPY_STAT is given, stats are not copied",
      "40:           from org_name to tmp_name.",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "46:   DBUG_PRINT(\"my\",(\"org_name: '%s' tmp_name: '%s'  MyFlags: %d\",",
      "47:      org_name,tmp_name,MyFlags));",
      "51:   if (MyFlags & MY_REDEL_MAKE_BACKUP)",
      "52:   {",
      "53:     char name_buff[FN_REFLEN+20];",
      "",
      "[Removed Lines]",
      "49:   if (my_copystat(org_name,tmp_name,MyFlags) < 0)",
      "50:     goto end;",
      "",
      "[Added Lines]",
      "52:   if (!(MyFlags & MY_REDEL_NO_COPY_STAT))",
      "53:   {",
      "54:     if (my_copystat(org_name,tmp_name,MyFlags) < 0)",
      "55:       goto end;",
      "56:   }",
      "",
      "---------------"
    ],
    "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc": [
      "File: storage/myisam/ha_myisam.cc -> storage/myisam/ha_myisam.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "4:    This program is free software; you can redistribute it and/or modify",
      "5:    it under the terms of the GNU General Public License as published by",
      "",
      "[Removed Lines]",
      "2:    Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.",
      "",
      "[Added Lines]",
      "2:    Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1092:         my_snprintf(buf, 40, \"Repair with %d threads\", my_count_bits(key_map));",
      "1093:         thd_proc_info(thd, buf);",
      "1094:         error = mi_repair_parallel(&param, file, fixed_name,",
      "1096:         thd_proc_info(thd, \"Repair done\"); // to reset proc_info, as",
      "1098:       }",
      "1099:       else",
      "1100:       {",
      "1101:         thd_proc_info(thd, \"Repair by sorting\");",
      "1102:         error = mi_repair_by_sort(&param, file, fixed_name,",
      "1104:       }",
      "1105:     }",
      "1106:     else",
      "1107:     {",
      "1108:       thd_proc_info(thd, \"Repair with keycache\");",
      "1109:       param.testflag &= ~T_REP_BY_SORT;",
      "1110:       error=  mi_repair(&param, file, fixed_name,",
      "1112:     }",
      "1113: #ifdef HAVE_MMAP",
      "1114:     if (remap)",
      "",
      "[Removed Lines]",
      "1095:             param.testflag & T_QUICK);",
      "1103:             param.testflag & T_QUICK);",
      "1111:    param.testflag & T_QUICK);",
      "",
      "[Added Lines]",
      "1095:           The new file is created with the right stats, so we can skip",
      "1096:           copying file stats from old to new.",
      "1099:                                    param.testflag & T_QUICK, TRUE);",
      "1107:           The new file is created with the right stats, so we can skip",
      "1108:           copying file stats from old to new.",
      "1111:                                   param.testflag & T_QUICK, TRUE);",
      "1119:         The new file is created with the right stats, so we can skip",
      "1120:         copying file stats from old to new.",
      "1123:    param.testflag & T_QUICK, TRUE);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1124:     {",
      "1125:       optimize_done=1;",
      "1126:       thd_proc_info(thd, \"Sorting index\");",
      "1128:     }",
      "1129:     if (!statistics_done && (local_testflag & T_STATISTICS))",
      "1130:     {",
      "",
      "[Removed Lines]",
      "1127:       error=mi_sort_index(&param,file,fixed_name);",
      "",
      "[Added Lines]",
      "1140:         The new file is created with the right stats, so we can skip",
      "1141:         copying file stats from old to new.",
      "1143:       error=mi_sort_index(&param,file,fixed_name, TRUE);",
      "",
      "---------------"
    ],
    "storage/myisam/mi_check.c||storage/myisam/mi_check.c": [
      "File: storage/myisam/mi_check.c -> storage/myisam/mi_check.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4:    This program is free software; you can redistribute it and/or modify",
      "5:    it under the terms of the GNU General Public License as published by",
      "",
      "[Removed Lines]",
      "2:    Copyright (c) 2000, 2015, Oracle and/or its affiliates. All rights reserved.",
      "",
      "[Added Lines]",
      "2:    Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1514: int mi_repair(MI_CHECK *param, register MI_INFO *info,",
      "1516: {",
      "1517:   int error,got_error;",
      "1518:   ha_rows start_records,new_header_length;",
      "",
      "[Removed Lines]",
      "1515:        char * name, int rep_quick)",
      "",
      "[Added Lines]",
      "1515:        char * name, int rep_quick, my_bool no_copy_stat)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1727:     if (new_file >= 0)",
      "1728:     {",
      "1729:       mysql_file_close(new_file, MYF(0));",
      "1730:       info->dfile=new_file= -1;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1729:       myf flags= 0;",
      "1730:       if (param->testflag & T_BACKUP_DATA)",
      "1731:         flags |= MY_REDEL_MAKE_BACKUP;",
      "1732:       if (no_copy_stat)",
      "1733:         flags |= MY_REDEL_NO_COPY_STAT;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1744:         info->s->file_map= NULL;",
      "1745:       }",
      "1746:       if (change_to_newfile(share->data_file_name, MI_NAME_DEXT, DATA_TMP_EXT,",
      "1749:    mi_open_datafile(info,share,name,-1))",
      "1750:  got_error=1;",
      "",
      "[Removed Lines]",
      "1747:        (param->testflag & T_BACKUP_DATA ?",
      "1748:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
      "",
      "[Added Lines]",
      "1752:                             flags) ||",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1937: {",
      "1938:   reg2 uint key;",
      "1939:   reg1 MI_KEYDEF *keyinfo;",
      "",
      "[Removed Lines]",
      "1936: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name)",
      "",
      "[Added Lines]",
      "1940: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name,",
      "1941:                   my_bool no_copy_stat)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "2004:   share->kfile = -1;",
      "2005:   (void) mysql_file_close(new_file, MYF(MY_WME));",
      "2006:   if (change_to_newfile(share->index_file_name, MI_NAME_IEXT, INDEX_TMP_EXT,",
      "2008:       mi_open_keyfile(share))",
      "2009:     goto err2;",
      "",
      "[Removed Lines]",
      "2007:    MYF(0)) ||",
      "",
      "[Added Lines]",
      "2012:    no_copy_stat ? MYF(MY_REDEL_NO_COPY_STAT) : MYF(0)) ||",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "2209:     info  MyISAM handler to repair",
      "2210:     name  Name of table (for warnings)",
      "2211:     rep_quick  set to <> 0 if we should not change data file",
      "2213:   RESULT",
      "2214:     0 ok",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2217:     no_copy_stat        Don't copy file stats from old to new file,",
      "2218:                         assume that new file was created with correct stats",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "2218: int mi_repair_by_sort(MI_CHECK *param, register MI_INFO *info,",
      "2220: {",
      "2221:   int got_error;",
      "2222:   uint i;",
      "",
      "[Removed Lines]",
      "2219:         const char * name, int rep_quick)",
      "",
      "[Added Lines]",
      "2226:         const char * name, int rep_quick, my_bool no_copy_stat)",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "2544:     if (new_file >= 0)",
      "2545:     {",
      "2546:       mysql_file_close(new_file, MYF(0));",
      "2547:       info->dfile=new_file= -1;",
      "2548:       if (change_to_newfile(share->data_file_name,MI_NAME_DEXT, DATA_TMP_EXT,",
      "2551:    mi_open_datafile(info,share,name,-1))",
      "2552:  got_error=1;",
      "2553:     }",
      "",
      "[Removed Lines]",
      "2549:        (param->testflag & T_BACKUP_DATA ?",
      "2550:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
      "",
      "[Added Lines]",
      "2553:       myf flags= 0;",
      "2554:       if (param->testflag & T_BACKUP_DATA)",
      "2555:         flags |= MY_REDEL_MAKE_BACKUP;",
      "2556:       if (no_copy_stat)",
      "2557:         flags |= MY_REDEL_NO_COPY_STAT;",
      "2561:                             flags) ||",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "2595:     info  MyISAM handler to repair",
      "2596:     name  Name of table (for warnings)",
      "2597:     rep_quick  set to <> 0 if we should not change data file",
      "2599:   DESCRIPTION",
      "2600:     Same as mi_repair_by_sort but do it multithreaded",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2609:     no_copy_stat        Don't copy file stats from old to new file,",
      "2610:                         assume that new file was created with correct stats",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "2631: int mi_repair_parallel(MI_CHECK *param, register MI_INFO *info,",
      "2633: {",
      "2634:   int got_error;",
      "2635:   uint i,key, total_key_length, istep;",
      "",
      "[Removed Lines]",
      "2632:    const char * name, int rep_quick)",
      "",
      "[Added Lines]",
      "2645:                        const char * name, int rep_quick, my_bool no_copy_stat)",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "3077:     if (new_file >= 0)",
      "3078:     {",
      "3079:       mysql_file_close(new_file, MYF(0));",
      "3080:       info->dfile=new_file= -1;",
      "3081:       if (change_to_newfile(share->data_file_name, MI_NAME_DEXT, DATA_TMP_EXT,",
      "3084:    mi_open_datafile(info,share,name,-1))",
      "3085:  got_error=1;",
      "3086:     }",
      "",
      "[Removed Lines]",
      "3082:        (param->testflag & T_BACKUP_DATA ?",
      "3083:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
      "",
      "[Added Lines]",
      "3092:       myf flags= 0;",
      "3093:       if (param->testflag & T_BACKUP_DATA)",
      "3094:         flags |= MY_REDEL_MAKE_BACKUP;",
      "3095:       if (no_copy_stat)",
      "3096:         flags |= MY_REDEL_NO_COPY_STAT;",
      "3100:        flags) ||",
      "",
      "---------------"
    ],
    "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c": [
      "File: storage/myisam/myisamchk.c -> storage/myisam/myisamchk.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "993:     info->s->state.key_map,",
      "994:     param->force_sort))",
      "995:  {",
      "996:           if (param->testflag & T_REP_BY_SORT)",
      "998:           else",
      "1000:    state_updated=1;",
      "1001:  }",
      "1002:  else if (param->testflag & T_REP_ANY)",
      "1004:       }",
      "1005:       if (!error && param->testflag & T_SORT_RECORDS)",
      "1006:       {",
      "",
      "[Removed Lines]",
      "997:             error=mi_repair_by_sort(param,info,filename,rep_quick);",
      "999:             error=mi_repair_parallel(param,info,filename,rep_quick);",
      "1003:    error=mi_repair(param, info,filename,rep_quick);",
      "",
      "[Added Lines]",
      "997:             The new file might not be created with the right stats depending",
      "998:             on how myisamchk is run, so we must copy file stats from old to new.",
      "1001:             error= mi_repair_by_sort(param, info, filename, rep_quick, FALSE);",
      "1003:             error= mi_repair_parallel(param, info, filename, rep_quick, FALSE);",
      "1007:    error= mi_repair(param, info, filename, rep_quick, FALSE);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1040:    {",
      "1041:      if (param->verbose)",
      "1042:        puts(\"Table had a compressed index;  We must now recreate the index\");",
      "1044:    }",
      "1045:  }",
      "1046:       }",
      "1047:       if (!error && param->testflag & T_SORT_INDEX)",
      "1049:       if (!error)",
      "1050:  share->state.changed&= ~(STATE_CHANGED | STATE_CRASHED |",
      "1051:      STATE_CRASHED_ON_REPAIR);",
      "",
      "[Removed Lines]",
      "1043:      error=mi_repair_by_sort(param,info,filename,1);",
      "1048:  error=mi_sort_index(param,info,filename);",
      "",
      "[Added Lines]",
      "1047:      error= mi_repair_by_sort(param, info, filename, 1, FALSE);",
      "1052:  error= mi_sort_index(param, info, filename, FALSE);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "75b59544fa76a6b16b1370292c9526565d4d587e",
      "candidate_info": {
        "commit_hash": "75b59544fa76a6b16b1370292c9526565d4d587e",
        "repo": "mysql/mysql-server",
        "commit_url": "https://github.com/mysql/mysql-server/commit/75b59544fa76a6b16b1370292c9526565d4d587e",
        "files": [
          "include/my_sys.h",
          "include/myisam.h",
          "mysys/my_redel.c",
          "storage/myisam/ha_myisam.cc",
          "storage/myisam/mi_check.c",
          "storage/myisam/myisamchk.c"
        ],
        "message": "Merge branch 'mysql-5.5' into mysql-5.6\n\n(cherry picked from commit 3682c8928e0b538739ca3d7c93b74e3bd2f9a001)",
        "before_after_code_files": [
          "include/my_sys.h||include/my_sys.h",
          "include/myisam.h||include/myisam.h",
          "mysys/my_redel.c||mysys/my_redel.c",
          "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc",
          "storage/myisam/mi_check.c||storage/myisam/mi_check.c",
          "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "include/my_sys.h||include/my_sys.h",
            "include/myisam.h||include/myisam.h",
            "mysys/my_redel.c||mysys/my_redel.c",
            "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc",
            "storage/myisam/mi_check.c||storage/myisam/mi_check.c",
            "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c"
          ],
          "candidate": [
            "include/my_sys.h||include/my_sys.h",
            "include/myisam.h||include/myisam.h",
            "mysys/my_redel.c||mysys/my_redel.c",
            "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc",
            "storage/myisam/mi_check.c||storage/myisam/mi_check.c",
            "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c"
          ]
        }
      },
      "candidate_diff": {
        "include/my_sys.h||include/my_sys.h": [
          "File: include/my_sys.h -> include/my_sys.h"
        ],
        "include/myisam.h||include/myisam.h": [
          "File: include/myisam.h -> include/myisam.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "4:    This program is free software; you can redistribute it and/or modify",
          "5:    it under the terms of the GNU General Public License as published by",
          "",
          "[Removed Lines]",
          "2:    Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.",
          "",
          "[Added Lines]",
          "2:    Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "426: int chk_key(MI_CHECK *param, MI_INFO *info);",
          "427: int chk_data_link(MI_CHECK *param, MI_INFO *info,int extend);",
          "428: int mi_repair(MI_CHECK *param, register MI_INFO *info,",
          "431: int mi_repair_by_sort(MI_CHECK *param, register MI_INFO *info,",
          "433: int mi_repair_parallel(MI_CHECK *param, register MI_INFO *info,",
          "435: int change_to_newfile(const char * filename, const char * old_ext,",
          "436:         const char * new_ext, myf myflags);",
          "437: int lock_file(MI_CHECK *param, File file, my_off_t start, int lock_type,",
          "",
          "[Removed Lines]",
          "429:        char * name, int rep_quick);",
          "430: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name);",
          "432:         const char * name, int rep_quick);",
          "434:         const char * name, int rep_quick);",
          "",
          "[Added Lines]",
          "429:        char * name, int rep_quick, my_bool no_copy_stat);",
          "430: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name,",
          "431:                   my_bool no_copy_stat);",
          "433:         const char * name, int rep_quick, my_bool no_copy_stat);",
          "435:                        const char * name, int rep_quick, my_bool no_copy_stat);",
          "",
          "---------------"
        ],
        "mysys/my_redel.c||mysys/my_redel.c": [
          "File: mysys/my_redel.c -> mysys/my_redel.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "36:    if MY_REDEL_MAKE_COPY is given, then the orginal file",
          "37:    is renamed to org_name-'current_time'.BAK",
          "40: #define REDEL_EXT \".BAK\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "39:           if MY_REDEL_NO_COPY_STAT is given, stats are not copied",
          "40:           from org_name to tmp_name.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "46:   DBUG_PRINT(\"my\",(\"org_name: '%s' tmp_name: '%s'  MyFlags: %d\",",
          "47:      org_name,tmp_name,MyFlags));",
          "51:   if (MyFlags & MY_REDEL_MAKE_BACKUP)",
          "52:   {",
          "53:     char name_buff[FN_REFLEN+20];",
          "",
          "[Removed Lines]",
          "49:   if (my_copystat(org_name,tmp_name,MyFlags) < 0)",
          "50:     goto end;",
          "",
          "[Added Lines]",
          "52:   if (!(MyFlags & MY_REDEL_NO_COPY_STAT))",
          "53:   {",
          "54:     if (my_copystat(org_name,tmp_name,MyFlags) < 0)",
          "55:       goto end;",
          "56:   }",
          "",
          "---------------"
        ],
        "storage/myisam/ha_myisam.cc||storage/myisam/ha_myisam.cc": [
          "File: storage/myisam/ha_myisam.cc -> storage/myisam/ha_myisam.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1090:         my_snprintf(buf, 40, \"Repair with %d threads\", my_count_bits(key_map));",
          "1091:         thd_proc_info(thd, buf);",
          "1092:         error = mi_repair_parallel(&param, file, fixed_name,",
          "1094:         thd_proc_info(thd, \"Repair done\"); // to reset proc_info, as",
          "1096:       }",
          "1097:       else",
          "1098:       {",
          "1099:         thd_proc_info(thd, \"Repair by sorting\");",
          "1100:         error = mi_repair_by_sort(&param, file, fixed_name,",
          "1102:       }",
          "1103:     }",
          "1104:     else",
          "1105:     {",
          "1106:       thd_proc_info(thd, \"Repair with keycache\");",
          "1107:       param.testflag &= ~T_REP_BY_SORT;",
          "1108:       error=  mi_repair(&param, file, fixed_name,",
          "1110:     }",
          "1111: #ifdef HAVE_MMAP",
          "1112:     if (remap)",
          "",
          "[Removed Lines]",
          "1093:             param.testflag & T_QUICK);",
          "1101:             param.testflag & T_QUICK);",
          "1109:    param.testflag & T_QUICK);",
          "",
          "[Added Lines]",
          "1093:           The new file is created with the right stats, so we can skip",
          "1094:           copying file stats from old to new.",
          "1097:                                    param.testflag & T_QUICK, TRUE);",
          "1105:           The new file is created with the right stats, so we can skip",
          "1106:           copying file stats from old to new.",
          "1109:                                   param.testflag & T_QUICK, TRUE);",
          "1117:         The new file is created with the right stats, so we can skip",
          "1118:         copying file stats from old to new.",
          "1121:    param.testflag & T_QUICK, TRUE);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1122:     {",
          "1123:       optimize_done=1;",
          "1124:       thd_proc_info(thd, \"Sorting index\");",
          "1126:     }",
          "1127:     if (!statistics_done && (local_testflag & T_STATISTICS))",
          "1128:     {",
          "",
          "[Removed Lines]",
          "1125:       error=mi_sort_index(&param,file,fixed_name);",
          "",
          "[Added Lines]",
          "1138:         The new file is created with the right stats, so we can skip",
          "1139:         copying file stats from old to new.",
          "1141:       error=mi_sort_index(&param,file,fixed_name, TRUE);",
          "",
          "---------------"
        ],
        "storage/myisam/mi_check.c||storage/myisam/mi_check.c": [
          "File: storage/myisam/mi_check.c -> storage/myisam/mi_check.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1514: int mi_repair(MI_CHECK *param, register MI_INFO *info,",
          "1516: {",
          "1517:   int error,got_error;",
          "1518:   ha_rows start_records,new_header_length;",
          "",
          "[Removed Lines]",
          "1515:        char * name, int rep_quick)",
          "",
          "[Added Lines]",
          "1515:        char * name, int rep_quick, my_bool no_copy_stat)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1727:     if (new_file >= 0)",
          "1728:     {",
          "1729:       mysql_file_close(new_file, MYF(0));",
          "1730:       info->dfile=new_file= -1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1729:       myf flags= 0;",
          "1730:       if (param->testflag & T_BACKUP_DATA)",
          "1731:         flags |= MY_REDEL_MAKE_BACKUP;",
          "1732:       if (no_copy_stat)",
          "1733:         flags |= MY_REDEL_NO_COPY_STAT;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1744:         info->s->file_map= NULL;",
          "1745:       }",
          "1746:       if (change_to_newfile(share->data_file_name, MI_NAME_DEXT, DATA_TMP_EXT,",
          "1749:    mi_open_datafile(info,share,name,-1))",
          "1750:  got_error=1;",
          "",
          "[Removed Lines]",
          "1747:        (param->testflag & T_BACKUP_DATA ?",
          "1748:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
          "",
          "[Added Lines]",
          "1752:                             flags) ||",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1937: {",
          "1938:   reg2 uint key;",
          "1939:   reg1 MI_KEYDEF *keyinfo;",
          "",
          "[Removed Lines]",
          "1936: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name)",
          "",
          "[Added Lines]",
          "1940: int mi_sort_index(MI_CHECK *param, register MI_INFO *info, char * name,",
          "1941:                   my_bool no_copy_stat)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2010:   share->kfile = -1;",
          "2011:   (void) mysql_file_close(new_file, MYF(MY_WME));",
          "2012:   if (change_to_newfile(share->index_file_name, MI_NAME_IEXT, INDEX_TMP_EXT,",
          "2014:       mi_open_keyfile(share))",
          "2015:     goto err2;",
          "",
          "[Removed Lines]",
          "2013:    MYF(0)) ||",
          "",
          "[Added Lines]",
          "2018:    no_copy_stat ? MYF(MY_REDEL_NO_COPY_STAT) : MYF(0)) ||",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2215:     info  MyISAM handler to repair",
          "2216:     name  Name of table (for warnings)",
          "2217:     rep_quick  set to <> 0 if we should not change data file",
          "2219:   RESULT",
          "2220:     0 ok",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2223:     no_copy_stat        Don't copy file stats from old to new file,",
          "2224:                         assume that new file was created with correct stats",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2224: int mi_repair_by_sort(MI_CHECK *param, register MI_INFO *info,",
          "2226: {",
          "2227:   int got_error;",
          "2228:   uint i;",
          "",
          "[Removed Lines]",
          "2225:         const char * name, int rep_quick)",
          "",
          "[Added Lines]",
          "2232:         const char * name, int rep_quick, my_bool no_copy_stat)",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2550:     if (new_file >= 0)",
          "2551:     {",
          "2552:       mysql_file_close(new_file, MYF(0));",
          "2553:       info->dfile=new_file= -1;",
          "2554:       if (change_to_newfile(share->data_file_name,MI_NAME_DEXT, DATA_TMP_EXT,",
          "2557:    mi_open_datafile(info,share,name,-1))",
          "2558:  got_error=1;",
          "2559:     }",
          "",
          "[Removed Lines]",
          "2555:        (param->testflag & T_BACKUP_DATA ?",
          "2556:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
          "",
          "[Added Lines]",
          "2559:       myf flags= 0;",
          "2560:       if (param->testflag & T_BACKUP_DATA)",
          "2561:         flags |= MY_REDEL_MAKE_BACKUP;",
          "2562:       if (no_copy_stat)",
          "2563:         flags |= MY_REDEL_NO_COPY_STAT;",
          "2567:                             flags) ||",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2601:     info  MyISAM handler to repair",
          "2602:     name  Name of table (for warnings)",
          "2603:     rep_quick  set to <> 0 if we should not change data file",
          "2605:   DESCRIPTION",
          "2606:     Same as mi_repair_by_sort but do it multithreaded",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2615:     no_copy_stat        Don't copy file stats from old to new file,",
          "2616:                         assume that new file was created with correct stats",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2637: int mi_repair_parallel(MI_CHECK *param, register MI_INFO *info,",
          "2639: {",
          "2640:   int got_error;",
          "2641:   uint i,key, total_key_length, istep;",
          "",
          "[Removed Lines]",
          "2638:    const char * name, int rep_quick)",
          "",
          "[Added Lines]",
          "2651:                        const char * name, int rep_quick, my_bool no_copy_stat)",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "3083:     if (new_file >= 0)",
          "3084:     {",
          "3085:       mysql_file_close(new_file, MYF(0));",
          "3086:       info->dfile=new_file= -1;",
          "3087:       if (change_to_newfile(share->data_file_name, MI_NAME_DEXT, DATA_TMP_EXT,",
          "3090:    mi_open_datafile(info,share,name,-1))",
          "3091:  got_error=1;",
          "3092:     }",
          "",
          "[Removed Lines]",
          "3088:        (param->testflag & T_BACKUP_DATA ?",
          "3089:         MYF(MY_REDEL_MAKE_BACKUP): MYF(0))) ||",
          "",
          "[Added Lines]",
          "3098:       myf flags= 0;",
          "3099:       if (param->testflag & T_BACKUP_DATA)",
          "3100:         flags |= MY_REDEL_MAKE_BACKUP;",
          "3101:       if (no_copy_stat)",
          "3102:         flags |= MY_REDEL_NO_COPY_STAT;",
          "3106:        flags) ||",
          "",
          "---------------"
        ],
        "storage/myisam/myisamchk.c||storage/myisam/myisamchk.c": [
          "File: storage/myisam/myisamchk.c -> storage/myisam/myisamchk.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "994:     info->s->state.key_map,",
          "995:     param->force_sort))",
          "996:  {",
          "997:           if (param->testflag & T_REP_BY_SORT)",
          "999:           else",
          "1001:    state_updated=1;",
          "1002:  }",
          "1003:  else if (param->testflag & T_REP_ANY)",
          "1005:       }",
          "1006:       if (!error && param->testflag & T_SORT_RECORDS)",
          "1007:       {",
          "",
          "[Removed Lines]",
          "998:             error=mi_repair_by_sort(param,info,filename,rep_quick);",
          "1000:             error=mi_repair_parallel(param,info,filename,rep_quick);",
          "1004:    error=mi_repair(param, info,filename,rep_quick);",
          "",
          "[Added Lines]",
          "998:             The new file might not be created with the right stats depending",
          "999:             on how myisamchk is run, so we must copy file stats from old to new.",
          "1002:             error= mi_repair_by_sort(param, info, filename, rep_quick, FALSE);",
          "1004:             error= mi_repair_parallel(param, info, filename, rep_quick, FALSE);",
          "1008:    error= mi_repair(param, info, filename, rep_quick, FALSE);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1041:    {",
          "1042:      if (param->verbose)",
          "1043:        puts(\"Table had a compressed index;  We must now recreate the index\");",
          "1045:    }",
          "1046:  }",
          "1047:       }",
          "1048:       if (!error && param->testflag & T_SORT_INDEX)",
          "1050:       if (!error)",
          "1051:  share->state.changed&= ~(STATE_CHANGED | STATE_CRASHED |",
          "1052:      STATE_CRASHED_ON_REPAIR);",
          "",
          "[Removed Lines]",
          "1044:      error=mi_repair_by_sort(param,info,filename,1);",
          "1049:  error=mi_sort_index(param,info,filename);",
          "",
          "[Added Lines]",
          "1048:      error= mi_repair_by_sort(param, info, filename, 1, FALSE);",
          "1053:  error= mi_sort_index(param, info, filename, FALSE);",
          "",
          "---------------"
        ]
      }
    }
  ]
}