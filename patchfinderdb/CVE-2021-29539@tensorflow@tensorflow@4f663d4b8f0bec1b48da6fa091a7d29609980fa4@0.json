{
  "cve_id": "CVE-2021-29539",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Calling `tf.raw_ops.ImmutableConst`(https://www.tensorflow.org/api_docs/python/tf/raw_ops/ImmutableConst) with a `dtype` of `tf.resource` or `tf.variant` results in a segfault in the implementation as code assumes that the tensor contents are pure scalars. We have patched the issue in 4f663d4b8f0bec1b48da6fa091a7d29609980fa4 and will release TensorFlow 2.5.0 containing the patch. TensorFlow nightly packages after this commit will also have the issue resolved. If using `tf.raw_ops.ImmutableConst` in code, you can prevent the segfault by inserting a filter for the `dtype` argument.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "4f663d4b8f0bec1b48da6fa091a7d29609980fa4",
  "patch_info": {
    "commit_hash": "4f663d4b8f0bec1b48da6fa091a7d29609980fa4",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/4f663d4b8f0bec1b48da6fa091a7d29609980fa4",
    "files": [
      "tensorflow/core/kernels/immutable_constant_op.cc"
    ],
    "message": "Allowlist certain data types to avoid a seg fault.\n\nPiperOrigin-RevId: 356326671\nChange-Id: I23b65b52e93798cb5a6744632d31b0f88c6b6b31",
    "before_after_code_files": [
      "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc": [
      "File: tensorflow/core/kernels/immutable_constant_op.cc -> tensorflow/core/kernels/immutable_constant_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "18: #include <unordered_set>",
      "20: namespace tensorflow {",
      "22: namespace {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "20: #include \"tensorflow/core/framework/types.pb.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "86:   OP_REQUIRES_OK(context,",
      "87:                  context->GetAttr(kMemoryRegionNameAttr, &region_name_));",
      "88:   OP_REQUIRES_OK(context, context->GetAttr(kDTypeAttr, &dtype_));",
      "89:   OP_REQUIRES_OK(context, context->GetAttr(kShapeAttr, &shape_));",
      "90: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "91:   OP_REQUIRES(context, dtype_ != DT_RESOURCE && dtype_ != DT_VARIANT,",
      "92:               errors::InvalidArgument(",
      "93:                   \"Resource and variant dtypes are invalid for this op.\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f999f298463957e9a3de6e1571ddda8bb8e462cc",
      "candidate_info": {
        "commit_hash": "f999f298463957e9a3de6e1571ddda8bb8e462cc",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f999f298463957e9a3de6e1571ddda8bb8e462cc",
        "files": [
          "tensorflow/core/kernels/immutable_constant_op.cc"
        ],
        "message": "Allowlist certain data types to avoid a seg fault.\n\nPiperOrigin-RevId: 356326671\nChange-Id: I23b65b52e93798cb5a6744632d31b0f88c6b6b31",
        "before_after_code_files": [
          "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc": [
          "File: tensorflow/core/kernels/immutable_constant_op.cc -> tensorflow/core/kernels/immutable_constant_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <unordered_set>",
          "20: namespace tensorflow {",
          "22: namespace {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "86:   OP_REQUIRES_OK(context,",
          "87:                  context->GetAttr(kMemoryRegionNameAttr, &region_name_));",
          "88:   OP_REQUIRES_OK(context, context->GetAttr(kDTypeAttr, &dtype_));",
          "89:   OP_REQUIRES_OK(context, context->GetAttr(kShapeAttr, &shape_));",
          "90: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   OP_REQUIRES(context, dtype_ != DT_RESOURCE && dtype_ != DT_VARIANT,",
          "92:               errors::InvalidArgument(",
          "93:                   \"Resource and variant dtypes are invalid for this op.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "616a3c1ba0a80ba17f6ce832b3125720b35281b9",
      "candidate_info": {
        "commit_hash": "616a3c1ba0a80ba17f6ce832b3125720b35281b9",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/616a3c1ba0a80ba17f6ce832b3125720b35281b9",
        "files": [
          "tensorflow/core/kernels/immutable_constant_op.cc"
        ],
        "message": "Allowlist certain data types to avoid a seg fault.\n\nPiperOrigin-RevId: 356326671\nChange-Id: I23b65b52e93798cb5a6744632d31b0f88c6b6b31",
        "before_after_code_files": [
          "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc": [
          "File: tensorflow/core/kernels/immutable_constant_op.cc -> tensorflow/core/kernels/immutable_constant_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <unordered_set>",
          "20: namespace tensorflow {",
          "22: namespace {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "86:   OP_REQUIRES_OK(context,",
          "87:                  context->GetAttr(kMemoryRegionNameAttr, &region_name_));",
          "88:   OP_REQUIRES_OK(context, context->GetAttr(kDTypeAttr, &dtype_));",
          "89:   OP_REQUIRES_OK(context, context->GetAttr(kShapeAttr, &shape_));",
          "90: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   OP_REQUIRES(context, dtype_ != DT_RESOURCE && dtype_ != DT_VARIANT,",
          "92:               errors::InvalidArgument(",
          "93:                   \"Resource and variant dtypes are invalid for this op.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "13a869c280ba8de6bf75428e850ab9c63fc8d8d8",
      "candidate_info": {
        "commit_hash": "13a869c280ba8de6bf75428e850ab9c63fc8d8d8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/13a869c280ba8de6bf75428e850ab9c63fc8d8d8",
        "files": [
          "tensorflow/core/kernels/immutable_constant_op.cc"
        ],
        "message": "Allowlist certain data types to avoid a seg fault.\n\nPiperOrigin-RevId: 356326671\nChange-Id: I23b65b52e93798cb5a6744632d31b0f88c6b6b31",
        "before_after_code_files": [
          "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc": [
          "File: tensorflow/core/kernels/immutable_constant_op.cc -> tensorflow/core/kernels/immutable_constant_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <unordered_set>",
          "20: namespace tensorflow {",
          "22: namespace {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "86:   OP_REQUIRES_OK(context,",
          "87:                  context->GetAttr(kMemoryRegionNameAttr, &region_name_));",
          "88:   OP_REQUIRES_OK(context, context->GetAttr(kDTypeAttr, &dtype_));",
          "89:   OP_REQUIRES_OK(context, context->GetAttr(kShapeAttr, &shape_));",
          "90: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   OP_REQUIRES(context, dtype_ != DT_RESOURCE && dtype_ != DT_VARIANT,",
          "92:               errors::InvalidArgument(",
          "93:                   \"Resource and variant dtypes are invalid for this op.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a1f159dbb6f8c1623919b6d113bc4368aa1a5386",
      "candidate_info": {
        "commit_hash": "a1f159dbb6f8c1623919b6d113bc4368aa1a5386",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a1f159dbb6f8c1623919b6d113bc4368aa1a5386",
        "files": [
          "tensorflow/core/kernels/immutable_constant_op.cc"
        ],
        "message": "Allowlist certain data types to avoid a seg fault.\n\nPiperOrigin-RevId: 356326671\nChange-Id: I23b65b52e93798cb5a6744632d31b0f88c6b6b31",
        "before_after_code_files": [
          "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/immutable_constant_op.cc||tensorflow/core/kernels/immutable_constant_op.cc": [
          "File: tensorflow/core/kernels/immutable_constant_op.cc -> tensorflow/core/kernels/immutable_constant_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: #include <unordered_set>",
          "20: namespace tensorflow {",
          "22: namespace {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: #include \"tensorflow/core/framework/types.pb.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "86:   OP_REQUIRES_OK(context,",
          "87:                  context->GetAttr(kMemoryRegionNameAttr, &region_name_));",
          "88:   OP_REQUIRES_OK(context, context->GetAttr(kDTypeAttr, &dtype_));",
          "89:   OP_REQUIRES_OK(context, context->GetAttr(kShapeAttr, &shape_));",
          "90: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   OP_REQUIRES(context, dtype_ != DT_RESOURCE && dtype_ != DT_VARIANT,",
          "92:               errors::InvalidArgument(",
          "93:                   \"Resource and variant dtypes are invalid for this op.\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}