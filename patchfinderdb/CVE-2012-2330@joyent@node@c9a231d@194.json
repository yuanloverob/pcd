{
  "cve_id": "CVE-2012-2330",
  "cve_desc": "The Update method in src/node_http_parser.cc in Node.js before 0.6.17 and 0.7 before 0.7.8 does not properly check the length of a string, which allows remote attackers to obtain sensitive information (request header contents) and possibly spoof HTTP headers via a zero length string.",
  "repo": "joyent/node",
  "patch_hash": "c9a231db0e59658be419d926b1dfa17b939ba158",
  "patch_info": {
    "commit_hash": "c9a231db0e59658be419d926b1dfa17b939ba158",
    "repo": "joyent/node",
    "commit_url": "https://github.com/joyent/node/commit/c9a231d",
    "files": [
      "src/node_http_parser.cc"
    ],
    "message": "typo in node_http_parser",
    "before_after_code_files": [
      "src/node_http_parser.cc||src/node_http_parser.cc"
    ]
  },
  "patch_diff": {
    "src/node_http_parser.cc||src/node_http_parser.cc": [
      "File: src/node_http_parser.cc -> src/node_http_parser.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "191:   void Update(const char* str, size_t size) {",
      "192:     if (str_ == NULL)",
      "193:       str_ = str;",
      "197:       char* s = new char[size_ + size];",
      "",
      "[Removed Lines]",
      "194:     else if (on_heap_ || str_ + size != str) {",
      "",
      "[Added Lines]",
      "194:     else if (on_heap_ || str_ + size_ != str) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "248f552ab4567943e6254cead09ded6c4fd91f05",
      "candidate_info": {
        "commit_hash": "248f552ab4567943e6254cead09ded6c4fd91f05",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/248f552ab4567943e6254cead09ded6c4fd91f05",
        "files": [
          "src/node.cc",
          "test/simple/test-process-exit-recursive.js",
          "test/simple/test-process-exit.js"
        ],
        "message": "process: ensure that the \"exit\" event always has \"code\" given\n\nUpon \"normal\" exiting of Node (i.e. the event loop completes naturally),\nthe \"code\" parameter was not being passed to the \"exit\" event listeners.\n\nBe consistent. Tests included.",
        "before_after_code_files": [
          "src/node.cc||src/node.cc",
          "test/simple/test-process-exit-recursive.js||test/simple/test-process-exit-recursive.js",
          "test/simple/test-process-exit.js||test/simple/test-process-exit.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/node.cc||src/node.cc": [
          "File: src/node.cc -> src/node.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "2775:   Local<Value> emit_v = process_l->Get(String::New(\"emit\"));",
          "2776:   assert(emit_v->IsFunction());",
          "2777:   Local<Function> emit = Local<Function>::Cast(emit_v);",
          "2779:   TryCatch try_catch;",
          "2781:   if (try_catch.HasCaught()) {",
          "2782:     FatalException(try_catch);",
          "2783:   }",
          "",
          "[Removed Lines]",
          "2778:   Local<Value> args[] = { String::New(\"exit\") };",
          "2780:   emit->Call(process_l, 1, args);",
          "",
          "[Added Lines]",
          "2778:   Local<Value> args[] = { String::New(\"exit\"), Integer::New(0) };",
          "2780:   emit->Call(process_l, 2, args);",
          "",
          "---------------"
        ],
        "test/simple/test-process-exit-recursive.js||test/simple/test-process-exit-recursive.js": [
          "File: test/simple/test-process-exit-recursive.js -> test/simple/test-process-exit-recursive.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: var assert = require('assert');",
          "25: var nexits = 0;",
          "27: process.on('exit', function(code) {",
          "28:   assert.equal(nexits++, 0);",
          "29:   assert.equal(code, 1);",
          "32:   process.exit();",
          "33: });",
          "35: process.exit(1);",
          "",
          "---------------"
        ],
        "test/simple/test-process-exit.js||test/simple/test-process-exit.js": [
          "File: test/simple/test-process-exit.js -> test/simple/test-process-exit.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: var common = require('../common');",
          "23: var assert = require('assert');",
          "26: var nexits = 0;",
          "29:   assert.equal(nexits++, 0);",
          "30:   process.exit();",
          "31: });",
          "",
          "[Removed Lines]",
          "28: process.on('exit', function() {",
          "33: process.exit();",
          "",
          "[Added Lines]",
          "28: process.on('exit', function(code) {",
          "30:   assert.equal(code, 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "63431796f4cdeb726cf8a4fe91806702cf09619c",
      "candidate_info": {
        "commit_hash": "63431796f4cdeb726cf8a4fe91806702cf09619c",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/63431796f4cdeb726cf8a4fe91806702cf09619c",
        "files": [
          "lib/net.js",
          "test/simple/test-net-write-connect-write.js"
        ],
        "message": "net: fix race write() before and after connect()\n\nFixes #2827.",
        "before_after_code_files": [
          "lib/net.js||linet.js",
          "test/simple/test-net-write-connect-write.js||test/simple/test-net-write-connect-write.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/net.js||linet.js": [
          "File: lib/net.js -> linet.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "617:       handle.readStart();",
          "618:     }",
          "622:     if (self._connectQueue) {",
          "623:       debug('Drain the connect queue');",
          "624:       for (var i = 0; i < self._connectQueue.length; i++) {",
          "",
          "[Removed Lines]",
          "620:     self.emit('connect');",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "627:       self._connectQueueCleanUp();",
          "628:     }",
          "630:     if (self._flags & FLAG_SHUTDOWNQUED) {",
          "632:       self._flags &= ~FLAG_SHUTDOWNQUED;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/simple/test-net-write-connect-write.js||test/simple/test-net-write-connect-write.js": [
          "File: test/simple/test-net-write-connect-write.js -> test/simple/test-net-write-connect-write.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "22: var common = require('../common');",
          "23: var assert = require('assert');",
          "24: var net = require('net');",
          "26: var received = '';",
          "28: var server = net.createServer(function(socket) {",
          "29:   socket.pipe(socket);",
          "30: }).listen(common.PORT, function() {",
          "31:   var conn = net.connect(common.PORT);",
          "32:   conn.setEncoding('utf8');",
          "33:   conn.write('before');",
          "34:   conn.on('connect', function() {",
          "35:     conn.write('after');",
          "36:   });",
          "37:   conn.on('data', function(buf) {",
          "38:     received += buf;",
          "39:     conn.end();",
          "40:   });",
          "41:   conn.on('end', function() {",
          "42:     server.close();",
          "43:   });",
          "44: });",
          "46: process.on('exit', function() {",
          "47:   assert.equal(received, 'before' + 'after');",
          "48: });",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "26f754d9ddcdab02cbed4eab6c3f7a36907e8a13",
      "candidate_info": {
        "commit_hash": "26f754d9ddcdab02cbed4eab6c3f7a36907e8a13",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/26f754d9ddcdab02cbed4eab6c3f7a36907e8a13",
        "files": [
          "deps/v8/src/debug-agent.cc"
        ],
        "message": "v8: debug: fix error handling in SendConnectMessage()\n\nThe old error handling code checked if the return value of Socket::Send() != 0,\nwhich is wrong because Socket::Send() can write less bytes than requested or\nreturn -1 on error.",
        "before_after_code_files": [
          "deps/v8/src/debug-agent.cc||deps/v8/src/debug-agent.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "deps/v8/src/debug-agent.cc||deps/v8/src/debug-agent.cc": [
          "File: deps/v8/src/debug-agent.cc -> deps/v8/src/debug-agent.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "323:                                            const char* embedding_host) {",
          "324:   static const int kBufferSize = 80;",
          "325:   char buffer[kBufferSize];  // Sending buffer.",
          "327:   int len;",
          "330:   len = OS::SNPrintF(Vector<char>(buffer, kBufferSize),",
          "331:                      \"Type: connect\\r\\n\");",
          "335:   len = OS::SNPrintF(Vector<char>(buffer, kBufferSize),",
          "336:                      \"V8-Version: %s\\r\\n\", v8::V8::GetVersion());",
          "340:   len = OS::SNPrintF(Vector<char>(buffer, kBufferSize),",
          "341:                      \"Protocol-Version: 1\\r\\n\");",
          "345:   if (embedding_host != NULL) {",
          "346:     len = OS::SNPrintF(Vector<char>(buffer, kBufferSize),",
          "347:                        \"Embedding-Host: %s\\r\\n\", embedding_host);",
          "350:   }",
          "352:   len = OS::SNPrintF(Vector<char>(buffer, kBufferSize),",
          "353:                      \"%s: 0\\r\\n\", kContentLength);",
          "358:   len = OS::SNPrintF(Vector<char>(buffer, kBufferSize), \"\\r\\n\");",
          "",
          "[Removed Lines]",
          "326:   bool ok;",
          "332:   ok = conn->Send(buffer, len);",
          "333:   if (!ok) return false;",
          "337:   ok = conn->Send(buffer, len);",
          "338:   if (!ok) return false;",
          "342:   ok = conn->Send(buffer, len);",
          "343:   if (!ok) return false;",
          "348:     ok = conn->Send(buffer, len);",
          "349:     if (!ok) return false;",
          "354:   ok = conn->Send(buffer, len);",
          "355:   if (!ok) return false;",
          "359:   ok = conn->Send(buffer, len);",
          "360:   if (!ok) return false;",
          "",
          "[Added Lines]",
          "327:   int r;",
          "332:   r = conn->Send(buffer, len);",
          "333:   if (r != len) return false;",
          "337:   r = conn->Send(buffer, len);",
          "338:   if (r != len) return false;",
          "342:   r = conn->Send(buffer, len);",
          "343:   if (r != len) return false;",
          "348:     r = conn->Send(buffer, len);",
          "349:     if (r != len) return false;",
          "354:   r = conn->Send(buffer, len);",
          "355:   if (r != len) return false;",
          "359:   r = conn->Send(buffer, len);",
          "360:   if (r != len) return false;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4aa09d1e0e29139484e3f2c72294fd8315c9ca33",
      "candidate_info": {
        "commit_hash": "4aa09d1e0e29139484e3f2c72294fd8315c9ca33",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/4aa09d1e0e29139484e3f2c72294fd8315c9ca33",
        "files": [
          "lib/tls.js",
          "test/simple/test-tls-check-server-identity.js"
        ],
        "message": "tls: localhost is valid against identity-check",
        "before_after_code_files": [
          "lib/tls.js||litls.js",
          "test/simple/test-tls-check-server-identity.js||test/simple/test-tls-check-server-identity.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "lib/tls.js||litls.js": [
          "File: lib/tls.js -> litls.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "86:     if (!/\\.$/.test(host)) host += '.';",
          "",
          "[Removed Lines]",
          "90:     if (!/^.+\\..+$/.test(host)) return /$./;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/simple/test-tls-check-server-identity.js||test/simple/test-tls-check-server-identity.js": [
          "File: test/simple/test-tls-check-server-identity.js -> test/simple/test-tls-check-server-identity.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "180:     },",
          "181:     result: false",
          "182:   },",
          "183: ];",
          "185: tests.forEach(function(test, i) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "183:   {",
          "184:     host: 'localhost', cert: {",
          "185:       subjectaltname: 'DNS:a.com',",
          "186:       subject: { CN: 'localhost' }",
          "187:     },",
          "188:     result: true",
          "189:   },",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e2126e05e7a5a4a7f2cb97173ad3b8b4c11807d5",
      "candidate_info": {
        "commit_hash": "e2126e05e7a5a4a7f2cb97173ad3b8b4c11807d5",
        "repo": "joyent/node",
        "commit_url": "https://github.com/joyent/node/commit/e2126e05e7a5a4a7f2cb97173ad3b8b4c11807d5",
        "files": [
          "tools/msvs/msi/nodemsi.wixproj",
          "tools/msvs/msi/product.wxs",
          "vcbuild.bat"
        ],
        "message": "windows/msi: cleanup WiX project files\n\nThe current WiX project files do some manual processing and generation\nwhich WiX supports doing out of the box. This patch will use the\nHeatDirectory task to generate the npm.wxs file and use the auto GUID\ngeneration. I also changed the msi filename generation to include the\nversion number to match the currently used name for released msi files.\n\nCloses #3360",
        "before_after_code_files": [
          "tools/msvs/msi/nodemsi.wixproj||tools/msvs/msi/nodemsi.wixproj",
          "tools/msvs/msi/product.wxs||tools/msvs/msi/product.wxs",
          "vcbuild.bat||vcbuild.bat"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/roamm/node/pull/1",
          "https://github.com/kingzone/node/pull/1",
          "https://github.com/OpenFPGAduino/node/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tools/msvs/msi/nodemsi.wixproj||tools/msvs/msi/nodemsi.wixproj": [
          "File: tools/msvs/msi/nodemsi.wixproj -> tools/msvs/msi/nodemsi.wixproj",
          "--- Hunk 1 ---",
          "[Context before]",
          "3: <Project ToolsVersion=\"4.0\" DefaultTargets=\"Build\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\">",
          "4:   <PropertyGroup>",
          "",
          "[Removed Lines]",
          "1: \ufeff<?xml version=\"1.0\" encoding=\"utf-8\"?>",
          "",
          "[Added Lines]",
          "1: <?xml version=\"1.0\" encoding=\"utf-8\"?>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "7:     <ProductVersion>3.5</ProductVersion>",
          "8:     <ProjectGuid>{1d808ff0-b5a9-4be9-859d-b334b6f48be2}</ProjectGuid>",
          "9:     <SchemaVersion>2.0</SchemaVersion>",
          "11:     <OutputType>Package</OutputType>",
          "12:     <WixTargetsPath Condition=\" '$(WixTargetsPath)' == '' AND '$(MSBuildExtensionsPath32)' != '' \">$(MSBuildExtensionsPath32)\\Microsoft\\WiX\\v3.x\\Wix.targets</WixTargetsPath>",
          "13:     <WixTargetsPath Condition=\" '$(WixTargetsPath)' == '' \">$(MSBuildExtensionsPath)\\Microsoft\\WiX\\v3.x\\Wix.targets</WixTargetsPath>",
          "",
          "[Removed Lines]",
          "10:     <OutputName>node</OutputName>",
          "",
          "[Added Lines]",
          "10:     <OutputName>node-v$(NodeVersion)-$(Platform)</OutputName>",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "43:       <Name>WixUIExtension</Name>",
          "44:     </WixExtension>",
          "45:   </ItemGroup>",
          "58:   <Import Project=\"$(WixTargetsPath)\" />",
          "59:     <Target Name=\"BeforeBuild\">",
          "66:     </Target>",
          "67: </Project>",
          "",
          "[Removed Lines]",
          "46:   <UsingTask TaskName=\"GenerateProductId\" TaskFactory=\"CodeTaskFactory\" AssemblyFile=\"$(MSBuildToolsPath)\\Microsoft.Build.Tasks.v4.0.dll\">",
          "47:     <ParameterGroup>",
          "48:       <ProductId ParameterType=\"System.String\" Output=\"true\" />",
          "49:     </ParameterGroup>",
          "50:     <Task>",
          "51:       <Code Type=\"Fragment\" Language=\"cs\">",
          "52:         <![CDATA[",
          "53:           this.ProductId = System.Guid.NewGuid().ToString().ToUpper();",
          "54:         ]]>",
          "55:       </Code>",
          "56:     </Task>",
          "57:   </UsingTask>",
          "60:       <GenerateProductId>",
          "61:         <Output PropertyName=\"NodeProductId\" TaskParameter=\"ProductId\"/>",
          "62:       </GenerateProductId>",
          "63:       <CreateProperty Value=\"$(DefineConstants);ProductId=$(NodeProductId)\">",
          "64:         <Output TaskParameter=\"Value\" PropertyName=\"DefineConstants\" />",
          "65:       </CreateProperty>",
          "",
          "[Added Lines]",
          "48:       <HeatDirectory ToolPath=\"$(WixToolPath)\" Directory=\"..\\..\\..\\deps\\npm\" PreprocessorVariable=\"var.NPMSourceDir\" DirectoryRefId=\"NodeModulesFolder\" ComponentGroupName=\"NPMFiles\" GenerateGuidsNow=\"true\" SuppressFragments=\"false\" OutputFile=\"..\\..\\..\\npm.wxs\">",
          "49:       </HeatDirectory>",
          "",
          "---------------"
        ],
        "tools/msvs/msi/product.wxs||tools/msvs/msi/product.wxs": [
          "File: tools/msvs/msi/product.wxs -> tools/msvs/msi/product.wxs",
          "--- Hunk 1 ---",
          "[Context before]",
          "4:   <?define repoDir=\"$(var.ProjectDir)..\\..\\..\\\" ?>",
          "5:   <?define sourcedir=\"$(var.repoDir)\\$(var.Configuration)\\\" ?>",
          "8:            Name=\"node.js\"",
          "9:            Language=\"1033\"",
          "10:            Version=\"$(var.ProductVersion)\"",
          "",
          "[Removed Lines]",
          "7:   <Product Id=\"$(var.ProductId)\"",
          "",
          "[Added Lines]",
          "7:   <Product Id=\"*\"",
          "",
          "---------------"
        ],
        "vcbuild.bat||vcbuild.bat": [
          "File: vcbuild.bat -> vcbuild.bat",
          "--- Hunk 1 ---",
          "[Context before]",
          "116: python \"%~dp0tools\\getnodeversion.py\" > \"%temp%\\node_version.txt\"",
          "117: if not errorlevel 0 echo Cannot determine current version of node.js & goto exit",
          "118: for /F \"tokens=*\" %%i in (%temp%\\node_version.txt) do set NODE_VERSION=%%i",
          "120: msbuild \"%~dp0tools\\msvs\\msi\\nodemsi.sln\" /m /t:Clean,Build /p:Configuration=%config% /p:Platform=%msiplatform% /p:NodeVersion=%NODE_VERSION% /clp:NoSummary;NoItemAndPropertyList;Verbosity=minimal /nologo",
          "121: if errorlevel 1 goto exit",
          "123: if defined nosign goto run",
          "126: :run",
          "127: @rem Run tests if requested.",
          "",
          "[Removed Lines]",
          "119: heat dir deps\\npm -var var.NPMSourceDir -dr NodeModulesFolder -cg NPMFiles -gg -template fragment -nologo -out npm.wxs",
          "124: signtool sign /a Release\\node.msi",
          "",
          "[Added Lines]",
          "123: signtool sign /a Release\\node-v%NODE_VERSION%-%msiplatform%.msi",
          "",
          "---------------"
        ]
      }
    }
  ]
}