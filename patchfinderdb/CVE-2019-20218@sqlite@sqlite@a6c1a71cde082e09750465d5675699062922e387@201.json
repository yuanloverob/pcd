{
  "cve_id": "CVE-2019-20218",
  "cve_desc": "selectExpander in select.c in SQLite 3.30.1 proceeds with WITH stack unwinding even after a parsing error.",
  "repo": "sqlite/sqlite",
  "patch_hash": "a6c1a71cde082e09750465d5675699062922e387",
  "patch_info": {
    "commit_hash": "a6c1a71cde082e09750465d5675699062922e387",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/a6c1a71cde082e09750465d5675699062922e387",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/altertab3.test"
    ],
    "message": "Do not attempt to unwind the WITH stack in the Parse object following an error. This fixes a separate case to [de6e6d68].\n\nFossilOrigin-Name: d29edef93451cc67a5d69c1cce1b1832d9ca8fff1f600afdd51338b74d077b92",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/altertab3.test||test/altertab3.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 597896ed0ae9e2960a8f39576bd7f77a11dccc1da84b6a44ebb5c38d90ebc330",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4982:     return WRC_Abort;",
      "4983:   }",
      "",
      "[Removed Lines]",
      "4981:   if( db->mallocFailed || sqliteProcessJoin(pParse, p) ){",
      "",
      "[Added Lines]",
      "4981:   if( pParse->nErr || db->mallocFailed || sqliteProcessJoin(pParse, p) ){",
      "",
      "---------------"
    ],
    "test/altertab3.test||test/altertab3.test": [
      "File: test/altertab3.test -> test/altertab3.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "531:   ALTER TABLE t1 RENAME TO t1x;",
      "532: } {1 {error in trigger r1: no such table: main.t2}}",
      "534: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "534: #------------------------------------------------------------------------",
      "535: #",
      "536: reset_db",
      "537: do_execsql_test 23.1 {",
      "538:   CREATE TABLE v0 (a);",
      "539:   CREATE VIEW v2 (v3) AS",
      "540:     WITH x1 AS (SELECT * FROM v2)",
      "541:     SELECT v3 AS x, v3 AS y FROM v2;",
      "542: }",
      "544: do_catchsql_test 23.2 {",
      "545:   SELECT * FROM v2",
      "546: } {1 {view v2 is circularly defined}}",
      "548: db close",
      "549: sqlite3 db test.db",
      "551: do_catchsql_test 23.3 {",
      "552:   ALTER TABLE v0 RENAME TO t3 ;",
      "553: } {1 {error in view v2: view v2 is circularly defined}}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2d82269ca8ccc13328af42cd9dad7edd565f9456",
      "candidate_info": {
        "commit_hash": "2d82269ca8ccc13328af42cd9dad7edd565f9456",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/2d82269ca8ccc13328af42cd9dad7edd565f9456",
        "files": [
          "ext/fts5/test/fts5misc.test",
          "manifest",
          "manifest.uuid",
          "src/wherecode.c",
          "test/rowvaluevtab.test"
        ],
        "message": "Fix a problem with row-value IN(...) operators and virtual tables.\n\nFossilOrigin-Name: aa57d7abac0bb92d4d5fd4e093a11cf8efc04e4eed748b2a400d01f137250649",
        "before_after_code_files": [
          "ext/fts5/test/fts5misc.test||ext/fts5/test/fts5misc.test",
          "manifest.uuid||manifest.uuid",
          "src/wherecode.c||src/wherecode.c",
          "test/rowvaluevtab.test||test/rowvaluevtab.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts5/test/fts5misc.test||ext/fts5/test/fts5misc.test": [
          "File: ext/fts5/test/fts5misc.test -> ext/fts5/test/fts5misc.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "193:   INSERT INTO vt0(vt0) VALUES('rebuild');",
          "194: }",
          "196: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "196: #-------------------------------------------------------------------------",
          "197: #",
          "198: reset_db",
          "199: do_execsql_test 7.0 {",
          "200:   CREATE VIRTUAL TABLE t1 USING fts5(x);",
          "201:   INSERT INTO t1(rowid, x) VALUES(1, 'hello world');",
          "202:   INSERT INTO t1(rowid, x) VALUES(2, 'well said');",
          "203:   INSERT INTO t1(rowid, x) VALUES(3, 'hello said');",
          "204:   INSERT INTO t1(rowid, x) VALUES(4, 'well world');",
          "206:   CREATE TABLE t2 (a, b);",
          "207:   INSERT INTO t2 VALUES(1, 'hello');",
          "208:   INSERT INTO t2 VALUES(2, 'world');",
          "209:   INSERT INTO t2 VALUES(3, 'said');",
          "210:   INSERT INTO t2 VALUES(4, 'hello');",
          "211: }",
          "213: do_execsql_test 7.1 {",
          "214:   SELECT rowid FROM t1 WHERE (rowid, x) IN (SELECT a, b FROM t2);",
          "215: }",
          "217: do_execsql_test 7.2 {",
          "218:   SELECT rowid FROM t1 WHERE rowid=2 AND t1 = 'hello';",
          "219: }",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: d1acf72ae1ea7484bb9c3a8630094f1a3a9597578c7b9d6e02fc0a4e3f59c57d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/wherecode.c||src/wherecode.c": [
          "File: src/wherecode.c -> src/wherecode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1307:       pTerm = pLoop->aLTerm[j];",
          "1308:       if( j<16 && (pLoop->u.vtab.omitMask>>j)&1 ){",
          "1309:         disableTerm(pLevel, pTerm);",
          "",
          "[Removed Lines]",
          "1310:       }else if( (pTerm->eOperator & WO_IN)!=0 ){",
          "",
          "[Added Lines]",
          "1310:       }else if( (pTerm->eOperator & WO_IN)!=0 &&",
          "1311:           sqlite3ExprVectorSize(pTerm->pExpr->pLeft)==1",
          "1312:       ){",
          "",
          "---------------"
        ],
        "test/rowvaluevtab.test||test/rowvaluevtab.test": [
          "File: test/rowvaluevtab.test -> test/rowvaluevtab.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: # 2018 October 14",
          "2: #",
          "3: # The author disclaims copyright to this source code.  In place of",
          "4: # a legal notice, here is a blessing:",
          "5: #",
          "6: #    May you do good and not evil.",
          "7: #    May you find forgiveness for yourself and forgive others.",
          "8: #    May you share freely, never taking more than you give.",
          "9: #",
          "10: #***********************************************************************",
          "11: #",
          "14: set testdir [file dirname $argv0]",
          "15: source $testdir/tester.tcl",
          "16: set ::testprefix rowvaluevtab",
          "18: register_echo_module db",
          "20: do_execsql_test 1.0 {",
          "21:   CREATE TABLE t1(a, b, c);",
          "22:   CREATE INDEX t1b ON t1(b);",
          "23:   INSERT INTO t1 VALUES('one', 1, 1);",
          "24:   INSERT INTO t1 VALUES('two', 1, 2);",
          "25:   INSERT INTO t1 VALUES('three', 1, 3);",
          "26:   INSERT INTO t1 VALUES('four', 2, 1);",
          "27:   INSERT INTO t1 VALUES('five', 2, 2);",
          "28:   INSERT INTO t1 VALUES('six', 2, 3);",
          "29:   INSERT INTO t1 VALUES('seven', 3, 1);",
          "30:   INSERT INTO t1 VALUES('eight', 3, 2);",
          "31:   INSERT INTO t1 VALUES('nine', 3, 3);",
          "33:   WITH s(i) AS (",
          "34:     SELECT 1 UNION ALL SELECT i+1 FROM s WHERE i<10000",
          "35:   ) INSERT INTO t1 SELECT NULL, NULL, NULL FROM s;",
          "36:   CREATE VIRTUAL TABLE e1 USING echo(t1);",
          "37: }",
          "39: proc do_vfilter4_test {tn sql expected} {",
          "40:   set res [list]",
          "41:   db eval \"explain $sql\" {",
          "42:     if {$opcode==\"VFilter\"} {",
          "43:       lappend res $p4",
          "44:     }",
          "45:   }",
          "46:   uplevel [list do_test $tn [list set {} $res] [list {*}$expected]]",
          "47: }",
          "49: do_execsql_test 1.1 {",
          "50:   SELECT a FROM e1 WHERE (b, c) = (2, 2)",
          "51: } {five}",
          "52: do_vfilter4_test 1.1f {",
          "53:   SELECT a FROM e1 WHERE (b, c) = (?, ?)",
          "54: } {{SELECT rowid, a, b, c FROM 't1' WHERE b = ?}}",
          "56: do_execsql_test 1.2 {",
          "57:   SELECT a FROM e1 WHERE (b, c) > (2, 2)",
          "58: } {six seven eight nine}",
          "59: do_vfilter4_test 1.2f {",
          "60:   SELECT a FROM e1 WHERE (b, c) > (2, 2)",
          "61: } {",
          "62:   {SELECT rowid, a, b, c FROM 't1' WHERE b >= ?}",
          "63: }",
          "65: do_execsql_test 1.3 {",
          "66:   SELECT a FROM e1 WHERE (b, c) >= (2, 2)",
          "67: } {five six seven eight nine}",
          "68: do_vfilter4_test 1.3f {",
          "69:   SELECT a FROM e1 WHERE (b, c) >= (2, 2)",
          "70: } {",
          "71:   {SELECT rowid, a, b, c FROM 't1' WHERE b >= ?}",
          "72: }",
          "74: do_execsql_test 1.3 {",
          "75:   SELECT a FROM e1 WHERE (b, c) BETWEEN (1, 2) AND (2, 3)",
          "76: } {two three four five six}",
          "77: do_vfilter4_test 1.3f {",
          "78:   SELECT a FROM e1 WHERE (b, c) BETWEEN (1, 2) AND (2, 3)",
          "79: } {",
          "80:   {SELECT rowid, a, b, c FROM 't1' WHERE b >= ? AND b <= ?}",
          "81: }",
          "83: do_execsql_test 1.4 {",
          "84:   SELECT a FROM e1 WHERE (b, c) IN ( VALUES(2, 2) )",
          "85: } {five}",
          "86: do_vfilter4_test 1.4f {",
          "87:   SELECT a FROM e1 WHERE (b, c) IN ( VALUES(2, 2) )",
          "88: } {{SELECT rowid, a, b, c FROM 't1' WHERE b = ?}}",
          "90: finish_test",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9d70284022fbc4d7fecb4c4b60f98589e6897a9f",
      "candidate_info": {
        "commit_hash": "9d70284022fbc4d7fecb4c4b60f98589e6897a9f",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/9d70284022fbc4d7fecb4c4b60f98589e6897a9f",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/func.c"
        ],
        "message": "Fix an OOB read in the INSTR() function introduced yesterday by check-in [3fb40f518086c1e8] and detected by OSSFuzz.  The test case is in TH3.\n\nFossilOrigin-Name: d49047c1b59bbfd05204af9973cdb0fab51b4d2661b550aec10d917fff94dc9b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/func.c||src/func.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 8efd62594eae725decb719aa7777c020f982b7cdc2c92bab3b91bf349a5bc298",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/func.c||src/func.c": [
          "File: src/func.c -> src/func.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "224:     }else{",
          "225:       pC1 = sqlite3_value_dup(argv[0]);",
          "226:       zHaystack = sqlite3_value_text(pC1);",
          "227:       pC2 = sqlite3_value_dup(argv[1]);",
          "228:       zNeedle = sqlite3_value_text(pC2);",
          "229:       isText = 1;",
          "230:     }",
          "235:     firstChar = zNeedle[0];",
          "236:     while( nNeedle<=nHaystack",
          "237:        && (zHaystack[0]!=firstChar || memcmp(zHaystack, zNeedle, nNeedle)!=0)",
          "",
          "[Removed Lines]",
          "231:     if( zNeedle==0 || (nHaystack && zHaystack==0) ){",
          "232:       sqlite3_result_error_nomem(context);",
          "233:       goto endInstr;",
          "234:     }",
          "",
          "[Added Lines]",
          "227:       if( zHaystack==0 ) goto endInstrOOM;",
          "228:       nHaystack = sqlite3_value_bytes(pC1);",
          "231:       if( zNeedle==0 ) goto endInstrOOM;",
          "232:       nNeedle = sqlite3_value_bytes(pC2);",
          "235:     if( zNeedle==0 || (nHaystack && zHaystack==0) ) goto endInstrOOM;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "248: endInstr:",
          "249:   sqlite3_value_free(pC1);",
          "250:   sqlite3_value_free(pC2);",
          "251: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "252:   return;",
          "253: endInstrOOM:",
          "254:   sqlite3_result_error_nomem(context);",
          "255:   goto endInstr;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8f4076223d248f0cbe6bfc5769f7574f1b0033e5",
      "candidate_info": {
        "commit_hash": "8f4076223d248f0cbe6bfc5769f7574f1b0033e5",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/8f4076223d248f0cbe6bfc5769f7574f1b0033e5",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/alter.c",
          "test/altertab3.test"
        ],
        "message": "Fix an assert() failure that could occur in ALTER TABLE code when the schema contains a view that uses a CTE.\n\nFossilOrigin-Name: 75b04a4b0d2e65bfcd02cf4e0b6d8f1954957c590814a9b8f9a9ee2adc2ec022",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/alter.c||src/alter.c",
          "test/altertab3.test||test/altertab3.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "test/altertab3.test||test/altertab3.test"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "test/altertab3.test||test/altertab3.test"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: e01fdbf9f700e1bd9dd5283c65547d10d26ce4f4506d3cfef9e1087aecdc2305",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/alter.c||src/alter.c": [
          "File: src/alter.c -> src/alter.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "733:   return WRC_Continue;",
          "734: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "740: static void renameWalkWith(Walker *pWalker, Select *pSelect){",
          "741:   if( pSelect->pWith ){",
          "742:     int i;",
          "743:     for(i=0; i<pSelect->pWith->nCte; i++){",
          "744:       Select *p = pSelect->pWith->a[i].pSelect;",
          "745:       NameContext sNC;",
          "746:       memset(&sNC, 0, sizeof(sNC));",
          "747:       sNC.pParse = pWalker->pParse;",
          "748:       sqlite3SelectPrep(sNC.pParse, p, &sNC);",
          "749:       sqlite3WalkSelect(pWalker, p);",
          "750:     }",
          "751:   }",
          "752: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "753:       sqlite3RenameTokenRemap(pParse, 0, (void*)pSrc->a[i].zName);",
          "754:     }",
          "755:   }",
          "756:   return WRC_Continue;",
          "757: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "775:   renameWalkWith(pWalker, p);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "819:   }",
          "820: }",
          "",
          "[Removed Lines]",
          "826: static void renameWalkWith(Walker *pWalker, Select *pSelect){",
          "827:   if( pSelect->pWith ){",
          "828:     int i;",
          "829:     for(i=0; i<pSelect->pWith->nCte; i++){",
          "830:       Select *p = pSelect->pWith->a[i].pSelect;",
          "831:       NameContext sNC;",
          "832:       memset(&sNC, 0, sizeof(sNC));",
          "833:       sNC.pParse = pWalker->pParse;",
          "834:       sqlite3SelectPrep(sNC.pParse, p, &sNC);",
          "835:       sqlite3WalkSelect(pWalker, p);",
          "836:     }",
          "837:   }",
          "838: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/altertab3.test||test/altertab3.test": [
          "File: test/altertab3.test -> test/altertab3.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "411:   ALTER TABLE t1 RENAME TO t1x;",
          "412: } {1 {error in trigger r1: 1st ORDER BY term does not match any column in the result set}}",
          "415: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "414: #-------------------------------------------------------------------------",
          "415: reset_db",
          "416: do_execsql_test 19.0 {",
          "417:   CREATE TABLE a(a,h CONSTRAINT a UNIQUE ON CONFLICT FAIL,CONSTRAINT a);",
          "418: }",
          "420: foreach {tn v res} {",
          "421:   1 {",
          "422:     CREATE VIEW q AS SELECT 123",
          "424:       WINDOW x AS (",
          "425:         RANGE BETWEEN UNBOUNDED PRECEDING AND INDEXED() OVER(",
          "426:           PARTITION BY ( WITH x AS(VALUES(col1)) VALUES(453) )",
          "427:         )",
          "428:       FOLLOWING",
          "429:     )",
          "430:   } {1 {error in view q: no such column: col1}}",
          "432:   2 {",
          "433:     CREATE VIEW q AS SELECT",
          "434:     CAST(CAST(CAST(CAST(CAST(CAST(CAST(CAST(CAST(CAST(CAST(RIGHT",
          "435:     AS)AS)AS)AS)AS)AS)AS)AS)AS)AS)AS)WINDOW x AS(RANGE BETWEEN UNBOUNDED",
          "436:     PRECEDING AND INDEXED(*)OVER(PARTITION BY",
          "437:     CROSS,CROSS,NATURAL,sqlite_master(*)OVER a,(WITH a AS(VALUES(LEFT)UNION",
          "438:     VALUES(LEFT)UNION VALUES(LEFT)UNION VALUES(LEFT)UNION VALUES(LEFT)UNION",
          "439:     VALUES(LEFT)UNION VALUES(LEFT))VALUES(LEFT))IN",
          "440:     STORED,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT)*LEFT FOLLOWING)ORDER BY",
          "441:     LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT LIMIT",
          "442:     LEFT,INDEXED(*)OVER(PARTITION BY",
          "443:     CROSS,CROSS,CROSS,LEFT,INDEXED(*)OVER(PARTITION BY",
          "444:     CROSS,CROSS,CROSS),INDEXED(*)OVER(PARTITION BY",
          "445:     LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT,LEFT),",
          "446:     LEFT,LEFT,INNER,CROSS,CROSS,CROSS,INNER,NATURAL ORDER BY",
          "447:     OUTER,NATURAL,NATURAL,NATURAL,NATURAL,NATURAL,NATURAL,NATURAL,INNER,",
          "448:     INNER,INNER NULLS LAST GROUPS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED",
          "449:     FOLLOWING);",
          "450:   } {1 {error in view q: no such column: LEFT}}",
          "452:   3 {",
          "453:     CREATE VIEW q AS SELECT 99 WINDOW x AS (RANGE BETWEEN UNBOUNDED PRECEDING",
          "454:     AND count(*)OVER(PARTITION BY (WITH a AS(VALUES(2),(x3))VALUES(0)))",
          "455:     FOLLOWING)ORDER BY x2,sum(1)OVER(PARTITION BY avg(5)OVER(PARTITION BY x1));",
          "456:   } {1 {error in view q: no such column: x3}}",
          "457: } {",
          "458:   do_execsql_test 19.$tn.1 \"",
          "459:     DROP VIEW IF EXISTS q;",
          "460:     $v",
          "461:   \" {}",
          "463:   do_catchsql_test 19.$tn.2 {",
          "464:     ALTER TABLE a RENAME TO g;",
          "465:   } $res",
          "466: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1a9082f6d773fad00926f64650601104827bd319",
      "candidate_info": {
        "commit_hash": "1a9082f6d773fad00926f64650601104827bd319",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/1a9082f6d773fad00926f64650601104827bd319",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/where.c",
          "test/gencol1.test"
        ],
        "message": "Omit the optimization that reduces the column-count on rowid-table cursors when the table has generated columns, because we do not know what columns the generator expressions might try to access.\n\nFossilOrigin-Name: e6c96ed91e7a96d2bd30ea9df132644ac02d5a321a62f81f8f3984a8e49ed94b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c",
          "test/gencol1.test||test/gencol1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 7c52f5478f9ecf5c078208759143ae9de43c1bf191dfcd74acb8bd169d4dc883",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5014:       assert( pTabItem->iCursor==pLevel->iTabCur );",
          "5015:       testcase( pWInfo->eOnePass==ONEPASS_OFF && pTab->nCol==BMS-1 );",
          "5016:       testcase( pWInfo->eOnePass==ONEPASS_OFF && pTab->nCol==BMS );",
          "5018:         Bitmask b = pTabItem->colUsed;",
          "5019:         int n = 0;",
          "5020:         for(; b; b=b>>1, n++){}",
          "",
          "[Removed Lines]",
          "5017:       if( pWInfo->eOnePass==ONEPASS_OFF && pTab->nCol<BMS && HasRowid(pTab) ){",
          "",
          "[Added Lines]",
          "5017:       if( pWInfo->eOnePass==ONEPASS_OFF",
          "5018:        && pTab->nCol<BMS",
          "5019:        && (pTab->tabFlags & (TF_HasGenerated|TF_WithoutRowid))==0",
          "5020:       ){",
          "",
          "---------------"
        ],
        "test/gencol1.test||test/gencol1.test": [
          "File: test/gencol1.test -> test/gencol1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "176:   REPLACE INTO t0(c0,c2,c3) VALUES(0,0,0),(0,0,0);",
          "177: } {1 {FOREIGN KEY constraint failed}}",
          "179: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "179: # 2019-11-01 Problem found while adding new foreign key test cases in TH3.",
          "180: db close",
          "181: sqlite3 db :memory:",
          "182: do_execsql_test gencol1-5.100 {",
          "183:   PRAGMA foreign_keys=ON;",
          "184:   CREATE TABLE t1(",
          "185:     gcb AS (b*1),",
          "186:     a INTEGER PRIMARY KEY,",
          "187:     gcc AS (c+0),",
          "188:     b UNIQUE,",
          "189:     gca AS (1*a+0),",
          "190:     c UNIQUE",
          "191:   ) WITHOUT ROWID;",
          "192:   INSERT INTO t1 VALUES(1,2,3);",
          "193:   INSERT INTO t1 VALUES(4,5,6);",
          "194:   INSERT INTO t1 VALUES(7,8,9);",
          "195:   CREATE TABLE t1a(",
          "196:     gcx AS (x+0) REFERENCES t1(a) ON DELETE CASCADE,",
          "197:     id,",
          "198:     x,",
          "199:     gcid AS (1*id)",
          "200:   );",
          "201:   INSERT INTO t1a VALUES(1, 1);",
          "202:   INSERT INTO t1a VALUES(2, 4);",
          "203:   INSERT INTO t1a VALUES(3, 7);",
          "204:   DELETE FROM t1 WHERE b=5;",
          "205:   SELECT id,x,'|' FROM t1a ORDER BY id;",
          "206: } {1 1 | 3 7 |}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c398c65bee850b6b8f24a44852872a27f114535d",
      "candidate_info": {
        "commit_hash": "c398c65bee850b6b8f24a44852872a27f114535d",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c398c65bee850b6b8f24a44852872a27f114535d",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/btree.c",
          "src/os.c",
          "src/os_unix.c",
          "src/os_win.c",
          "src/pager.c",
          "src/sqlite.h.in",
          "src/test_demovfs.c",
          "src/test_vfs.c"
        ],
        "message": "Revise the SQLITE_OPEN_NOFOLLOW so that it actually uses O_NOFOLLOW in the open() system call.  This backs out the SQLITE_ACCESS_SYMLINK value but adds the new SQLITE_OK_SYMLINK return code from the xFullPathname method of sqlite3_vfs when that routine resolves symbolic links. O_NOFOLLOW is always included in open() system calls for journal files.\n\nFossilOrigin-Name: 6a64fb6a2da6c98f1e87b55ad5689967e1db4eae2e08345471d95e28cd567e0f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/btree.c||src/btree.c",
          "src/os.c||src/os.c",
          "src/os_unix.c||src/os_unix.c",
          "src/os_win.c||src/os_win.c",
          "src/pager.c||src/pager.c",
          "src/sqlite.h.in||src/sqlite.h.in",
          "src/test_demovfs.c||src/test_demovfs.c",
          "src/test_vfs.c||src/test_vfs.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: ac080432b480062507452d3cdbe6c0f759e6f95b65d9862e0462017405ab2b8e",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/btree.c||src/btree.c": [
          "File: src/btree.c -> src/btree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2403:         rc = sqlite3OsFullPathname(pVfs, zFilename,",
          "2404:                                    nFullPathname, zFullPathname);",
          "2405:         if( rc ){",
          "2409:         }",
          "2410:       }",
          "2411: #if SQLITE_THREADSAFE",
          "",
          "[Removed Lines]",
          "2406:           sqlite3_free(zFullPathname);",
          "2407:           sqlite3_free(p);",
          "2408:           return rc;",
          "",
          "[Added Lines]",
          "2406:           if( rc==SQLITE_OK_SYMLINK ){",
          "2407:             rc = SQLITE_OK;",
          "2408:           }else{",
          "2409:             sqlite3_free(zFullPathname);",
          "2410:             sqlite3_free(p);",
          "2411:             return rc;",
          "2412:           }",
          "",
          "---------------"
        ],
        "src/os.c||src/os.c": [
          "File: src/os.c -> src/os.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "219:   assert( rc==SQLITE_OK || pFile->pMethods==0 );",
          "220:   return rc;",
          "221: }",
          "",
          "[Removed Lines]",
          "218:   rc = pVfs->xOpen(pVfs, zPath, pFile, flags & 0x87f7f, pFlagsOut);",
          "",
          "[Added Lines]",
          "218:   rc = pVfs->xOpen(pVfs, zPath, pFile, flags & 0x1087f7f, pFlagsOut);",
          "",
          "---------------"
        ],
        "src/os_unix.c||src/os_unix.c": [
          "File: src/os_unix.c -> src/os_unix.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3685:     if( zDirname[0]!='/' ) zDirname[0] = '.';",
          "3686:     zDirname[1] = 0;",
          "3687:   }",
          "3689:   if( fd>=0 ){",
          "3690:     OSTRACE((\"OPENDIR %-3d %s\\n\", fd, zDirname));",
          "3691:   }",
          "",
          "[Removed Lines]",
          "3688:   fd = robust_open(zDirname, O_RDONLY|O_BINARY, 0);",
          "",
          "[Added Lines]",
          "3688:   fd = robust_open(zDirname, O_RDONLY|O_BINARY|O_NOFOLLOW, 0);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4577:     if( pInode->bProcessLock==0 ){",
          "4578:       if( 0==sqlite3_uri_boolean(pDbFd->zPath, \"readonly_shm\", 0) ){",
          "4580:       }",
          "4581:       if( pShmNode->hShm<0 ){",
          "4583:         if( pShmNode->hShm<0 ){",
          "4584:           rc = unixLogError(SQLITE_CANTOPEN_BKPT, \"open\", zShm);",
          "4585:           goto shm_open_err;",
          "",
          "[Removed Lines]",
          "4579:         pShmNode->hShm = robust_open(zShm, O_RDWR|O_CREAT,(sStat.st_mode&0777));",
          "4582:         pShmNode->hShm = robust_open(zShm, O_RDONLY, (sStat.st_mode&0777));",
          "",
          "[Added Lines]",
          "4579:         pShmNode->hShm = robust_open(zShm, O_RDWR|O_CREAT|O_NOFOLLOW,",
          "4580:                                      (sStat.st_mode&0777));",
          "4583:         pShmNode->hShm = robust_open(zShm, O_RDONLY|O_NOFOLLOW,",
          "4584:                                      (sStat.st_mode&0777));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "6039:   if( isReadWrite ) openFlags |= O_RDWR;",
          "6040:   if( isCreate )    openFlags |= O_CREAT;",
          "6041:   if( isExclusive ) openFlags |= (O_EXCL|O_NOFOLLOW);",
          "6044:   if( fd<0 ){",
          "",
          "[Removed Lines]",
          "6042:   openFlags |= (O_LARGEFILE|O_BINARY);",
          "",
          "[Added Lines]",
          "6044:   openFlags |= (O_LARGEFILE|O_BINARY|O_NOFOLLOW);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "6251:   SimulateIOError( return SQLITE_IOERR_ACCESS; );",
          "6252:   assert( pResOut!=0 );",
          "6260:   if( flags==SQLITE_ACCESS_EXISTS ){",
          "6261:     struct stat buf;",
          "6265:   }else{",
          "6273:   }",
          "6274:   return SQLITE_OK;",
          "6275: }",
          "",
          "[Removed Lines]",
          "6256:   assert( flags==SQLITE_ACCESS_EXISTS",
          "6257:        || flags==SQLITE_ACCESS_READWRITE",
          "6258:        || flags==SQLITE_ACCESS_SYMLINK );",
          "6263:   }else if( flags==SQLITE_ACCESS_READWRITE ){",
          "6266: #if !defined(HAVE_LSTAT)",
          "6268: #else",
          "6269:     struct stat buf;",
          "6271: #endif",
          "6272:     assert( flags==SQLITE_ACCESS_SYMLINK );",
          "",
          "[Added Lines]",
          "6258:   assert( flags==SQLITE_ACCESS_EXISTS || flags==SQLITE_ACCESS_READWRITE );",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "6350:     }",
          "6352:     if( bLink ){",
          "6353:       if( zDel==0 ){",
          "6354:         zDel = sqlite3_malloc(nOut);",
          "6355:         if( zDel==0 ) rc = SQLITE_NOMEM_BKPT;",
          "6357:         rc = SQLITE_CANTOPEN_BKPT;",
          "6358:       }",
          "",
          "[Removed Lines]",
          "6356:       }else if( ++nLink>SQLITE_MAX_SYMLINKS ){",
          "",
          "[Added Lines]",
          "6345:       nLink++;",
          "6349:       }else if( nLink>=SQLITE_MAX_SYMLINKS ){",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "6389:   }while( rc==SQLITE_OK );",
          "6391:   sqlite3_free(zDel);",
          "6392:   return rc;",
          "6394: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6385:   if( rc==SQLITE_OK && nLink ) rc = SQLITE_OK_SYMLINK;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "6874:   int fd = -1;",
          "6875:   unixFile *pNew;",
          "6876:   int rc = SQLITE_OK;",
          "6878:   sqlite3_vfs dummyVfs;",
          "6879:   int terrno = 0;",
          "6880:   UnixUnusedFd *pUnused = NULL;",
          "",
          "[Removed Lines]",
          "6877:   int openFlags = O_RDWR | O_CREAT;",
          "",
          "[Added Lines]",
          "6871:   int openFlags = O_RDWR | O_CREAT | O_NOFOLLOW;",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "6904:     }",
          "6905:   }",
          "6906:   if( fd<0 ){",
          "6908:     fd = robust_open(path, openFlags, 0);",
          "6909:     terrno = errno;",
          "6910:   }",
          "",
          "[Removed Lines]",
          "6907:     openFlags = O_RDONLY;",
          "",
          "[Added Lines]",
          "6901:     openFlags = O_RDONLY | O_NOFOLLOW;",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "7030:     goto end_breaklock;",
          "7031:   }",
          "7034:   if( fd<0 ){",
          "7035:     sqlite3_snprintf(sizeof(errmsg), errmsg, \"create failed (%d)\", errno);",
          "7036:     goto end_breaklock;",
          "",
          "[Removed Lines]",
          "7033:   fd = robust_open(tPath, (O_RDWR|O_CREAT|O_EXCL), 0);",
          "",
          "[Added Lines]",
          "7027:   fd = robust_open(tPath, (O_RDWR|O_CREAT|O_EXCL|O_NOFOLLOW), 0);",
          "",
          "---------------"
        ],
        "src/os_win.c||src/os_win.c": [
          "File: src/os_win.c -> src/os_win.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "80: #  define NTDDI_WINTHRESHOLD                0x06040000",
          "81: #endif",
          "",
          "[Removed Lines]",
          "87: #ifndef FILE_ATTRIBUTE_REPARSE_POINT",
          "88: #  define FILE_ATTRIBUTE_REPARSE_POINT      0x00000400",
          "89: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "5480:       rc = attr!=INVALID_FILE_ATTRIBUTES &&",
          "5481:              (attr & FILE_ATTRIBUTE_READONLY)==0;",
          "5482:       break;",
          "5487:     default:",
          "5488:       assert(!\"Invalid flags argument\");",
          "5489:   }",
          "",
          "[Removed Lines]",
          "5483:     case SQLITE_ACCESS_SYMLINK:",
          "5484:       rc = attr!=INVALID_FILE_ATTRIBUTES &&",
          "5485:              (attr & FILE_ATTRIBUTE_REPARSE_POINT)!=0;",
          "5486:       break;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/pager.c||src/pager.c": [
          "File: src/pager.c -> src/pager.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4791:   if( zFilename && zFilename[0] ){",
          "4792:     const char *z;",
          "4799:     nPathname = pVfs->mxPathname+1;",
          "4800:     zPathname = sqlite3DbMallocRaw(0, nPathname*2);",
          "4801:     if( zPathname==0 ){",
          "",
          "[Removed Lines]",
          "4793:     if( (vfsFlags & SQLITE_OPEN_NOFOLLOW)!=0 ){",
          "4794:       int isLink = 0;",
          "4795:       int rc = sqlite3OsAccess(pVfs, zFilename, SQLITE_ACCESS_SYMLINK, &isLink);",
          "4796:       if( rc==SQLITE_OK && isLink ) rc = SQLITE_CANTOPEN_SYMLINK;",
          "4797:       if( rc ) return rc;",
          "4798:     }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4803:     }",
          "4805:     rc = sqlite3OsFullPathname(pVfs, zFilename, nPathname, zPathname);",
          "4806:     nPathname = sqlite3Strlen30(zPathname);",
          "4807:     z = zUri = &zFilename[sqlite3Strlen30(zFilename)+1];",
          "4808:     while( *z ){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4800:     if( rc!=SQLITE_OK ){",
          "4801:       if( rc==SQLITE_OK_SYMLINK ){",
          "4802:         if( vfsFlags & SQLITE_OPEN_NOFOLLOW ){",
          "4803:           rc = SQLITE_CANTOPEN_SYMLINK;",
          "4804:         }else{",
          "4805:           rc = SQLITE_OK;",
          "4806:         }",
          "4807:       }",
          "4808:     }",
          "",
          "---------------"
        ],
        "src/sqlite.h.in||src/sqlite.h.in": [
          "File: src/sqlite.h.in -> src/sqlite.h.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "541: #define SQLITE_WARNING_AUTOINDEX       (SQLITE_WARNING | (1<<8))",
          "542: #define SQLITE_AUTH_USER               (SQLITE_AUTH | (1<<8))",
          "543: #define SQLITE_OK_LOAD_PERMANENTLY     (SQLITE_OK | (1<<8))",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "544: #define SQLITE_OK_SYMLINK              (SQLITE_OK | (2<<8))",
          "",
          "---------------"
        ],
        "src/test_demovfs.c||src/test_demovfs.c": [
          "File: src/test_demovfs.c -> src/test_demovfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "512:   );",
          "519:   if( flags==SQLITE_ACCESS_READWRITE ) eAccess = R_OK|W_OK;",
          "520:   if( flags==SQLITE_ACCESS_READ )      eAccess = R_OK;",
          "",
          "[Removed Lines]",
          "514:   if( flags==SQLITE_ACCESS_SYMLINK ){",
          "517:     return SQLITE_OK;",
          "518:   }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/test_vfs.c||src/test_vfs.c": [
          "File: src/test_vfs.c -> src/test_vfs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "732:     if( flags==SQLITE_ACCESS_EXISTS ) zArg = \"SQLITE_ACCESS_EXISTS\";",
          "733:     if( flags==SQLITE_ACCESS_READWRITE ) zArg = \"SQLITE_ACCESS_READWRITE\";",
          "734:     if( flags==SQLITE_ACCESS_READ ) zArg = \"SQLITE_ACCESS_READ\";",
          "736:     tvfsExecTcl(p, \"xAccess\",",
          "737:         Tcl_NewStringObj(zPath, -1), Tcl_NewStringObj(zArg, -1), 0, 0",
          "738:     );",
          "",
          "[Removed Lines]",
          "735:     if( flags==SQLITE_ACCESS_SYMLINK ) zArg = \"SQLITE_ACCESS_SYMLINK\";",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}