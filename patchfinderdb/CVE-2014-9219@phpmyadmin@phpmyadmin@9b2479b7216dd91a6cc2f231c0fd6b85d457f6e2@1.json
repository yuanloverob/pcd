{
  "cve_id": "CVE-2014-9219",
  "cve_desc": "Cross-site scripting (XSS) vulnerability in the redirection feature in url.php in phpMyAdmin 4.2.x before 4.2.13.1 allows remote attackers to inject arbitrary web script or HTML via the url parameter.",
  "repo": "phpmyadmin/phpmyadmin",
  "patch_hash": "9b2479b7216dd91a6cc2f231c0fd6b85d457f6e2",
  "patch_info": {
    "commit_hash": "9b2479b7216dd91a6cc2f231c0fd6b85d457f6e2",
    "repo": "phpmyadmin/phpmyadmin",
    "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/9b2479b7216dd91a6cc2f231c0fd6b85d457f6e2",
    "files": [
      "ChangeLog",
      "url.php"
    ],
    "message": "bug #4612 [security] XSS vulnerability in redirection mechanism\n\nSigned-off-by: Madhura Jayaratne <madhura.cj@gmail.com>",
    "before_after_code_files": [
      "url.php||url.php"
    ]
  },
  "patch_diff": {
    "url.php||url.php": [
      "File: url.php -> url.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "12: define('PMA_MINIMUM_COMMON', true);",
      "13: require_once './libraries/common.inc.php';",
      "15: if (! PMA_isValid($_GET['url'])",
      "16:     || ! preg_match('/^https?:\\/\\/[^\\n\\r]*$/', $_GET['url'])",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "17: require_once './libraries/js_escape.lib.php';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "25:     echo \"<script type='text/javascript'>",
      "26:             window.onload=function(){",
      "28:             }",
      "29:         </script>\";",
      "",
      "[Removed Lines]",
      "27:                 window.location='\" . htmlspecialchars($_GET['url']) . \"';",
      "",
      "[Added Lines]",
      "31:                 window.location='\" . PMA_escapeJsString($_GET['url']) . \"';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "0a18d86059d2dac273df05ef6abc609db51b2919",
      "candidate_info": {
        "commit_hash": "0a18d86059d2dac273df05ef6abc609db51b2919",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/0a18d86059d2dac273df05ef6abc609db51b2919",
        "files": [
          "libraries/common.inc.php",
          "libraries/core.lib.php",
          "test/classes/PMA_Advisor_test.php",
          "test/classes/PMA_DbSearch_test.php",
          "test/classes/PMA_Message_test.php",
          "test/classes/config/PMA_FormDisplay_test.php",
          "test/classes/plugin/auth/PMA_AuthenticationConfig_test.php",
          "test/libraries/PMA_sanitize_test.php",
          "test/libraries/common/PMA_showDocu_test.php",
          "test/libraries/common/PMA_showPHPDocu_test.php",
          "test/libraries/core/PMA_getLinks_test.php",
          "url.php"
        ],
        "message": "Fix for bug#4237.\n\nSigned-off-by: Dhananjay <dhananjaynakrani@gmail.com>",
        "before_after_code_files": [
          "libraries/common.inc.php||libraries/common.inc.php",
          "libraries/core.lib.php||libraries/core.lib.php",
          "test/classes/PMA_Advisor_test.php||test/classes/PMA_Advisor_test.php",
          "test/classes/PMA_DbSearch_test.php||test/classes/PMA_DbSearch_test.php",
          "test/classes/PMA_Message_test.php||test/classes/PMA_Message_test.php",
          "test/classes/config/PMA_FormDisplay_test.php||test/classes/config/PMA_FormDisplay_test.php",
          "test/classes/plugin/auth/PMA_AuthenticationConfig_test.php||test/classes/plugin/auth/PMA_AuthenticationConfig_test.php",
          "test/libraries/PMA_sanitize_test.php||test/libraries/PMA_sanitize_test.php",
          "test/libraries/common/PMA_showDocu_test.php||test/libraries/common/PMA_showDocu_test.php",
          "test/libraries/common/PMA_showPHPDocu_test.php||test/libraries/common/PMA_showPHPDocu_test.php",
          "test/libraries/core/PMA_getLinks_test.php||test/libraries/core/PMA_getLinks_test.php",
          "url.php||url.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "url.php||url.php"
          ],
          "candidate": [
            "url.php||url.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/common.inc.php||libraries/common.inc.php": [
          "File: libraries/common.inc.php -> libraries/common.inc.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "486:         'ajax_request',",
          "489:     );",
          "",
          "[Removed Lines]",
          "488:         'old_usr'",
          "",
          "[Added Lines]",
          "488:         'old_usr',",
          "490:         'url'",
          "",
          "---------------"
        ],
        "libraries/core.lib.php||libraries/core.lib.php": [
          "File: libraries/core.lib.php -> libraries/core.lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "802:     }",
          "803:     $params = array();",
          "804:     $params['url'] = $url;",
          "806: }",
          "",
          "[Removed Lines]",
          "805:     return './url.php' . PMA_URL_getCommon($params);",
          "",
          "[Added Lines]",
          "806:     $url=PMA_URL_getCommon($params);",
          "808:     $arr=parse_url($url);",
          "809:     parse_str($arr[\"query\"],$vars);",
          "810:     $query = http_build_query(array(\"url\"=>$vars[\"url\"]));",
          "811:     $url='./url.php?' . $query;",
          "813:     return $url;",
          "814: }",
          "823: function PMA_isAllowedDomain($url)",
          "824: {",
          "825:     $arr=parse_url($url);",
          "826:     $domain=$arr[\"host\"];",
          "827:     $domainWhiteList=array(",
          "829:                     $_SERVER['SERVER_NAME'],",
          "831:                     'wiki.phpmyadmin.net', 'www.phpMyAdmin.net','phpmyadmin.net', 'docs.phpmyadmin.net',",
          "833:                     'dev.mysql.com','bugs.mysql.com',",
          "835:                     'php.net',",
          "837:                     'github.com','www.github.com',",
          "839:                     'www.primebase.com','pbxt.blogspot.com'",
          "840:                     );",
          "841:     if(in_array($domain,$domainWhiteList)){",
          "842:         return true;",
          "843:     }",
          "845:     return false;",
          "",
          "---------------"
        ],
        "test/classes/PMA_Advisor_test.php||test/classes/PMA_Advisor_test.php": [
          "File: test/classes/PMA_Advisor_test.php -> test/classes/PMA_Advisor_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:                     'name' => 'Distribution',",
          "251:                     'issue' => 'official MySQL binaries.',",
          "252:                     'recommendation' => 'See <a href=\"./url.php?url=http%3A%2F%2F' .",
          "254:                     'id' => 'Distribution'",
          "255:                 ),",
          "256:                 null,",
          "",
          "[Removed Lines]",
          "253:                         'phpma.org%2F&amp;lang=en&amp;token=token\">web</a>',",
          "",
          "[Added Lines]",
          "253:                         'phpma.org%2F\">web</a>',",
          "",
          "---------------"
        ],
        "test/classes/PMA_DbSearch_test.php||test/classes/PMA_DbSearch_test.php": [
          "File: test/classes/PMA_DbSearch_test.php -> test/classes/PMA_DbSearch_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "210:             . 'SearchType_4\" value=\"4\" />' . \"\\n\"",
          "211:             . '<label for=\"criteriaSearchType_4\">as regular expression <a href='",
          "212:             . '\"./url.php?url=http%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen'",
          "214:             . '\"mysql_doc\"><img src=\"themes/dot.gifb_help.png\" title=\"Documentation\"'",
          "215:             . ' alt=\"Documentation\" /></a></label><br />' . \"\\n\"",
          "216:             . '</td></tr><tr><td class=\"right vtop\">Inside tables:</td>'",
          "",
          "[Removed Lines]",
          "213:             . '%2Fregexp.html&amp;server=0&amp;lang=en&amp;token=token\" target='",
          "",
          "[Added Lines]",
          "213:             . '%2Fregexp.html\" target='",
          "",
          "---------------"
        ],
        "test/classes/PMA_Message_test.php||test/classes/PMA_Message_test.php": [
          "File: test/classes/PMA_Message_test.php -> test/classes/PMA_Message_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "354:             ),",
          "355:             array(",
          "356:                 '[a@http://foo.bar/@Documentation]link[/a]',",
          "359:             ),",
          "360:             array(",
          "361:                 '[a@./non-existing@Documentation]link[/a]',",
          "",
          "[Removed Lines]",
          "357:                 '<a href=\"./url.php?url=http%3A%2F%2Ffoo.bar%2F&amp;lang=en&amp;'",
          "358:                 . 'token=token\" target=\"Documentation\">link</a>'",
          "",
          "[Added Lines]",
          "357:                 '<a href=\"./url.php?url=http%3A%2F%2Ffoo.bar%2F\"'",
          "358:                 . ' target=\"Documentation\">link</a>'",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "364:             array(",
          "365:                 '[doc@foo]link[/doc]',",
          "366:                 '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2F'",
          "368:                 . 'target=\"documentation\">link</a>'",
          "369:             ),",
          "370:         );",
          "",
          "[Removed Lines]",
          "367:                 . 'latest%2Fsetup.html%23foo&amp;lang=en&amp;token=token\" '",
          "",
          "[Added Lines]",
          "367:                 . 'latest%2Fsetup.html%23foo\" '",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "490:         $this->object->setMessage('[kbd]test[/kbd] [doc@cfg_Example]test[/doc]');",
          "491:         $this->assertEquals(",
          "492:             '<kbd>test</kbd> <a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.'",
          "495:             $this->object->getMessage()",
          "496:         );",
          "497:     }",
          "",
          "[Removed Lines]",
          "493:             . 'net%2Fen%2Flatest%2Fcfg.html%23cfg_Example&amp;lang=en&amp;token='",
          "494:             . 'token\" target=\"documentation\">test</a>',",
          "",
          "[Added Lines]",
          "493:             . 'net%2Fen%2Flatest%2Fcfg.html%23cfg_Example\"'",
          "494:             . ' target=\"documentation\">test</a>',",
          "",
          "---------------"
        ],
        "test/classes/config/PMA_FormDisplay_test.php||test/classes/config/PMA_FormDisplay_test.php": [
          "File: test/classes/config/PMA_FormDisplay_test.php -> test/classes/config/PMA_FormDisplay_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "334:     {",
          "335:         $this->assertEquals(",
          "336:             \"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2Flatest%2F\" .",
          "339:             $this->object->getDocLink(\"Servers/3/test/2/\")",
          "340:         );",
          "",
          "[Removed Lines]",
          "337:             \"config.html%23cfg_Servers_3_test_2_&amp;server=0&amp;lang=en&amp\" .",
          "338:             \";token=token\",",
          "",
          "[Added Lines]",
          "337:             \"config.html%23cfg_Servers_3_test_2_\",",
          "",
          "---------------"
        ],
        "test/classes/plugin/auth/PMA_AuthenticationConfig_test.php||test/classes/plugin/auth/PMA_AuthenticationConfig_test.php": [
          "File: test/classes/plugin/auth/PMA_AuthenticationConfig_test.php -> test/classes/plugin/auth/PMA_AuthenticationConfig_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "119:         $this->assertContains(",
          "120:             '<strong>MySQL said: </strong><a href=\"./url.php?url=http%3A%2F%2F' .",
          "123:             '<img src=\"themes/dot.gif\" title=\"Documentation\" alt=\"Documentation\" ' .",
          "124:             'class=\"icon ic_b_help\" /></a>',",
          "125:             $html",
          "",
          "[Removed Lines]",
          "121:             'dev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Ferror-messages-server.html' .",
          "122:             '&amp;server=0&amp;lang=en&amp;token=token\" target=\"mysql_doc\">' .",
          "",
          "[Added Lines]",
          "121:             'dev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Ferror-messages-server.html\"' .",
          "122:             ' target=\"mysql_doc\">' .",
          "",
          "---------------"
        ],
        "test/libraries/PMA_sanitize_test.php||test/libraries/PMA_sanitize_test.php": [
          "File: test/libraries/PMA_sanitize_test.php -> test/libraries/PMA_sanitize_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:         unset($GLOBALS['lang']);",
          "50:         unset($GLOBALS['collation_connection']);",
          "51:         $this->assertEquals(",
          "53:             PMA_sanitize('[a@http://www.phpmyadmin.net/@target]link[/a]')",
          "54:         );",
          "55:     }",
          "",
          "[Removed Lines]",
          "52:             '<a href=\"./url.php?url=http%3A%2F%2Fwww.phpmyadmin.net%2F&amp;token=token\" target=\"target\">link</a>',",
          "",
          "[Added Lines]",
          "52:             '<a href=\"./url.php?url=http%3A%2F%2Fwww.phpmyadmin.net%2F\" target=\"target\">link</a>',",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "62:     public function testDoc()",
          "63:     {",
          "64:         $this->assertEquals(",
          "66:             PMA_sanitize('[doc@foo]doclink[/doc]')",
          "67:         );",
          "68:     }",
          "",
          "[Removed Lines]",
          "65:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2Flatest%2Fsetup.html%23foo&amp;token=token\" target=\"documentation\">doclink</a>',",
          "",
          "[Added Lines]",
          "65:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2Flatest%2Fsetup.html%23foo\" target=\"documentation\">doclink</a>',",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "101:     public function testLinkAndXssInHref()",
          "102:     {",
          "103:         $this->assertEquals(",
          "105:             PMA_sanitize('[a@http://docs.phpmyadmin.net/]doc[/a][a@javascript:alert(\\'XSS\\');@target]link[/a]')",
          "106:         );",
          "107:     }",
          "",
          "[Removed Lines]",
          "104:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2F&amp;token=token\">doc</a>[a@javascript:alert(\\'XSS\\');@target]link</a>',",
          "",
          "[Added Lines]",
          "104:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2F\">doc</a>[a@javascript:alert(\\'XSS\\');@target]link</a>',",
          "",
          "---------------"
        ],
        "test/libraries/common/PMA_showDocu_test.php||test/libraries/common/PMA_showDocu_test.php": [
          "File: test/libraries/common/PMA_showDocu_test.php -> test/libraries/common/PMA_showDocu_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "26:     function testShowDocu()",
          "27:     {",
          "28:         $this->assertEquals(",
          "30:             PMA_Util::showDocu('page', 'anchor')",
          "31:         );",
          "",
          "[Removed Lines]",
          "29:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2Flatest%2Fpage.html%23anchor&amp;server=99&amp;lang=en&amp;token=token\" target=\"documentation\"><img src=\"themes/dot.gif\" title=\"Documentation\" alt=\"Documentation\" class=\"icon ic_b_help\" /></a>',",
          "",
          "[Added Lines]",
          "29:             '<a href=\"./url.php?url=http%3A%2F%2Fdocs.phpmyadmin.net%2Fen%2Flatest%2Fpage.html%23anchor\" target=\"documentation\"><img src=\"themes/dot.gif\" title=\"Documentation\" alt=\"Documentation\" class=\"icon ic_b_help\" /></a>',",
          "",
          "---------------"
        ],
        "test/libraries/common/PMA_showPHPDocu_test.php||test/libraries/common/PMA_showPHPDocu_test.php": [
          "File: test/libraries/common/PMA_showPHPDocu_test.php -> test/libraries/common/PMA_showPHPDocu_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "29:         $target = \"docu\";",
          "30:         $lang = _pgettext('PHP documentation language', 'en');",
          "31:         $expected = '<a href=\"./url.php?url=http%3A%2F%2Fphp.net%2Fmanual%2F' . $lang",
          "34:             . __('Documentation') . '\" alt=\"' . __('Documentation') . '\" class=\"icon ic_b_help\" /></a>';",
          "36:         $this->assertEquals(",
          "",
          "[Removed Lines]",
          "32:             . '%2F' . $target . '&amp;server=99&amp;lang=en&amp;token=token'",
          "33:             . '\" target=\"documentation\"><img src=\"themes/dot.gif\" title=\"'",
          "",
          "[Added Lines]",
          "32:             . '%2F' . $target . '\" target=\"documentation\"><img src=\"themes/dot.gif\" title=\"'",
          "",
          "---------------"
        ],
        "test/libraries/core/PMA_getLinks_test.php||test/libraries/core/PMA_getLinks_test.php": [
          "File: test/libraries/core/PMA_getLinks_test.php -> test/libraries/core/PMA_getLinks_test.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27:         $this->assertEquals(",
          "28:             PMA_getPHPDocLink('function'),",
          "29:             './url.php?url=http%3A%2F%2Fphp.net%2Fmanual%2F'",
          "31:         );",
          "32:     }",
          "",
          "[Removed Lines]",
          "30:             . $lang . '%2Ffunction&amp;server=99&amp;lang=en&amp;token=token'",
          "",
          "[Added Lines]",
          "30:             . $lang . '%2Ffunction'",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "35:     {",
          "36:         return array(",
          "37:             array('http://wiki.phpmyadmin.net',",
          "40:             array('https://wiki.phpmyadmin.net',",
          "43:             array('wiki.phpmyadmin.net', 'wiki.phpmyadmin.net'),",
          "44:             array('index.php?db=phpmyadmin', 'index.php?db=phpmyadmin')",
          "45:         );",
          "",
          "[Removed Lines]",
          "38:              './url.php?url=http%3A%2F%2Fwiki.phpmyadmin.net&amp;server=99'",
          "39:             . '&amp;lang=en&amp;token=token'),",
          "41:              './url.php?url=https%3A%2F%2Fwiki.phpmyadmin.net&amp;server=99'",
          "42:             . '&amp;lang=en&amp;token=token'),",
          "",
          "[Added Lines]",
          "38:              './url.php?url=http%3A%2F%2Fwiki.phpmyadmin.net'),",
          "40:              './url.php?url=https%3A%2F%2Fwiki.phpmyadmin.net'),",
          "",
          "---------------"
        ],
        "url.php||url.php": [
          "File: url.php -> url.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "17: ) {",
          "18:     header('Location: ' . $cfg['PmaAbsoluteUri']);",
          "19: } else {",
          "21: }",
          "22: die();",
          "23: ?>",
          "",
          "[Removed Lines]",
          "20:     header('Location: ' . $_GET['url']);",
          "",
          "[Added Lines]",
          "23:     if (PMA_isAllowedDomain($_GET['url'])) {",
          "25:      echo \"<script type='text/javascript'>",
          "26:        window.onload=function(){",
          "27:         window.location='\".$_GET['url'].\"';",
          "28:       }",
          "29:       </script>\";",
          "30:         echo 'Taking you to '.($_GET['url']); // Display redirecting msg on screen.",
          "31:     }",
          "32:     else",
          "33:     {",
          "34:      header('Location: ' . $cfg['PmaAbsoluteUri']);",
          "35:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}