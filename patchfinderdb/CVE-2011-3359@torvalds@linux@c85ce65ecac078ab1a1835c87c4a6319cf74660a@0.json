{
  "cve_id": "CVE-2011-3359",
  "cve_desc": "The dma_rx function in drivers/net/wireless/b43/dma.c in the Linux kernel before 2.6.39 does not properly allocate receive buffers, which allows remote attackers to cause a denial of service (system crash) via a crafted frame.",
  "repo": "torvalds/linux",
  "patch_hash": "c85ce65ecac078ab1a1835c87c4a6319cf74660a",
  "patch_info": {
    "commit_hash": "c85ce65ecac078ab1a1835c87c4a6319cf74660a",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/c85ce65ecac078ab1a1835c87c4a6319cf74660a",
    "files": [
      "drivers/net/wireless/b43/dma.c",
      "drivers/net/wireless/b43/dma.h"
    ],
    "message": "b43: allocate receive buffers big enough for max frame len + offset\n\nOtherwise, skb_put inside of dma_rx can fail...\n\n\thttps://bugzilla.kernel.org/show_bug.cgi?id=32042\n\nSigned-off-by: John W. Linville <linville@tuxdriver.com>\nAcked-by: Larry Finger <Larry.Finger@lwfinger.net>\nCc: stable@kernel.org",
    "before_after_code_files": [
      "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c",
      "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h"
    ]
  },
  "patch_diff": {
    "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c": [
      "File: drivers/net/wireless/b43/dma.c -> drivers/net/wireless/b43/dma.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1536:   dmaaddr = meta->dmaaddr;",
      "1537:   goto drop_recycle_buffer;",
      "1538:  }",
      "",
      "[Removed Lines]",
      "1539:  if (unlikely(len > ring->rx_buffersize)) {",
      "",
      "[Added Lines]",
      "1539:  if (unlikely(len + ring->frameoffset > ring->rx_buffersize)) {",
      "",
      "---------------"
    ],
    "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h": [
      "File: drivers/net/wireless/b43/dma.h -> drivers/net/wireless/b43/dma.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "164: #define B43_TXRING_SLOTS  256",
      "165: #define B43_RXRING_SLOTS  64",
      "169: #define B43_DMA_PTR_POISON  ((void *)ERR_PTR(-ENOMEM))",
      "",
      "[Removed Lines]",
      "166: #define B43_DMA0_RX_BUFFERSIZE  IEEE80211_MAX_FRAME_LEN",
      "",
      "[Added Lines]",
      "166: #define B43_DMA0_RX_BUFFERSIZE  (B43_DMA0_RX_FRAMEOFFSET + IEEE80211_MAX_FRAME_LEN)",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "17030f48e31adde5b043741c91ba143f5f7db0fd",
      "candidate_info": {
        "commit_hash": "17030f48e31adde5b043741c91ba143f5f7db0fd",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/17030f48e31adde5b043741c91ba143f5f7db0fd",
        "files": [
          "drivers/net/wireless/b43/dma.c",
          "drivers/net/wireless/b43/dma.h",
          "drivers/net/wireless/b43/pio.c",
          "drivers/net/wireless/b43/xmit.c",
          "drivers/net/wireless/b43/xmit.h"
        ],
        "message": "b43: support new RX header, noticed to be used in 598.314+ fw\n\nSigned-off-by: Rafa\u0142 Mi\u0142ecki <zajec5@gmail.com>\nSigned-off-by: John W. Linville <linville@tuxdriver.com>",
        "before_after_code_files": [
          "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c",
          "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h",
          "drivers/net/wireless/b43/pio.c||drivers/net/wireless/b43/pio.c",
          "drivers/net/wireless/b43/xmit.c||drivers/net/wireless/b43/xmit.c",
          "drivers/net/wireless/b43/xmit.h||drivers/net/wireless/b43/xmit.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c",
            "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h"
          ],
          "candidate": [
            "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c",
            "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h"
          ]
        }
      },
      "candidate_diff": {
        "drivers/net/wireless/b43/dma.c||drivers/net/wireless/b43/dma.c": [
          "File: drivers/net/wireless/b43/dma.c -> drivers/net/wireless/b43/dma.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "858:   ring->current_slot = -1;",
          "859:  } else {",
          "860:   if (ring->index == 0) {",
          "863:   } else",
          "864:    B43_WARN_ON(1);",
          "865:  }",
          "",
          "[Removed Lines]",
          "861:    ring->rx_buffersize = B43_DMA0_RX_BUFFERSIZE;",
          "862:    ring->frameoffset = B43_DMA0_RX_FRAMEOFFSET;",
          "",
          "[Added Lines]",
          "861:    switch (dev->fw.hdr_format) {",
          "862:    case B43_FW_HDR_598:",
          "863:     ring->rx_buffersize = B43_DMA0_RX_FW598_BUFSIZE;",
          "864:     ring->frameoffset = B43_DMA0_RX_FW598_FO;",
          "865:     break;",
          "866:    case B43_FW_HDR_410:",
          "867:    case B43_FW_HDR_351:",
          "868:     ring->rx_buffersize = B43_DMA0_RX_FW351_BUFSIZE;",
          "869:     ring->frameoffset = B43_DMA0_RX_FW351_FO;",
          "870:     break;",
          "871:    }",
          "",
          "---------------"
        ],
        "drivers/net/wireless/b43/dma.h||drivers/net/wireless/b43/dma.h": [
          "File: drivers/net/wireless/b43/dma.h -> drivers/net/wireless/b43/dma.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "164: #define B43_DMA_RINGMEMSIZE  PAGE_SIZE",
          "168: #define B43_TXRING_SLOTS  256",
          "169: #define B43_RXRING_SLOTS  64",
          "173: #define B43_DMA_PTR_POISON  ((void *)ERR_PTR(-ENOMEM))",
          "",
          "[Removed Lines]",
          "165: #define B43_DMA0_RX_FRAMEOFFSET  30",
          "170: #define B43_DMA0_RX_BUFFERSIZE  (B43_DMA0_RX_FRAMEOFFSET + IEEE80211_MAX_FRAME_LEN)",
          "",
          "[Added Lines]",
          "166: #define B43_DMA0_RX_FW598_FO  38",
          "167: #define B43_DMA0_RX_FW351_FO  30",
          "172: #define B43_DMA0_RX_FW598_BUFSIZE (B43_DMA0_RX_FW598_FO + IEEE80211_MAX_FRAME_LEN)",
          "173: #define B43_DMA0_RX_FW351_BUFSIZE (B43_DMA0_RX_FW351_FO + IEEE80211_MAX_FRAME_LEN)",
          "",
          "---------------"
        ],
        "drivers/net/wireless/b43/pio.c||drivers/net/wireless/b43/pio.c": [
          "File: drivers/net/wireless/b43/pio.c -> drivers/net/wireless/b43/pio.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "676:   goto rx_error;",
          "677:  }",
          "680:  if (macstat & B43_RX_MAC_FCSERR) {",
          "681:   if (!(q->dev->wl->filter_flags & FIF_FCSFAIL)) {",
          "",
          "[Removed Lines]",
          "679:  macstat = le32_to_cpu(rxhdr->mac_status);",
          "",
          "[Added Lines]",
          "679:  switch (dev->fw.hdr_format) {",
          "680:  case B43_FW_HDR_598:",
          "681:   macstat = le32_to_cpu(rxhdr->format_598.mac_status);",
          "682:   break;",
          "683:  case B43_FW_HDR_410:",
          "684:  case B43_FW_HDR_351:",
          "685:   macstat = le32_to_cpu(rxhdr->format_351.mac_status);",
          "686:   break;",
          "687:  }",
          "",
          "---------------"
        ],
        "drivers/net/wireless/b43/xmit.c||drivers/net/wireless/b43/xmit.c": [
          "File: drivers/net/wireless/b43/xmit.c -> drivers/net/wireless/b43/xmit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "653:  struct ieee80211_hdr *wlhdr;",
          "654:  const struct b43_rxhdr_fw4 *rxhdr = _rxhdr;",
          "655:  __le16 fctl;",
          "658:  u16 chanid;",
          "659:  u16 phytype;",
          "660:  int padding;",
          "",
          "[Removed Lines]",
          "656:  u16 phystat0, phystat3, chanstat, mactime;",
          "657:  u32 macstat;",
          "",
          "[Added Lines]",
          "656:  u16 phystat0, phystat3;",
          "657:  u16 uninitialized_var(chanstat), uninitialized_var(mactime);",
          "658:  u32 uninitialized_var(macstat);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "665:  phystat0 = le16_to_cpu(rxhdr->phy_status0);",
          "666:  phystat3 = le16_to_cpu(rxhdr->phy_status3);",
          "670:  phytype = chanstat & B43_RX_CHAN_PHYTYPE;",
          "672:  if (unlikely(macstat & B43_RX_MAC_FCSERR)) {",
          "",
          "[Removed Lines]",
          "667:  macstat = le32_to_cpu(rxhdr->mac_status);",
          "668:  mactime = le16_to_cpu(rxhdr->mac_time);",
          "669:  chanstat = le16_to_cpu(rxhdr->channel);",
          "",
          "[Added Lines]",
          "668:  switch (dev->fw.hdr_format) {",
          "669:  case B43_FW_HDR_598:",
          "670:   macstat = le32_to_cpu(rxhdr->format_598.mac_status);",
          "671:   mactime = le16_to_cpu(rxhdr->format_598.mac_time);",
          "672:   chanstat = le16_to_cpu(rxhdr->format_598.channel);",
          "673:   break;",
          "674:  case B43_FW_HDR_410:",
          "675:  case B43_FW_HDR_351:",
          "676:   macstat = le32_to_cpu(rxhdr->format_351.mac_status);",
          "677:   mactime = le16_to_cpu(rxhdr->format_351.mac_time);",
          "678:   chanstat = le16_to_cpu(rxhdr->format_351.channel);",
          "679:   break;",
          "680:  }",
          "",
          "---------------"
        ],
        "drivers/net/wireless/b43/xmit.h||drivers/net/wireless/b43/xmit.h": [
          "File: drivers/net/wireless/b43/xmit.h -> drivers/net/wireless/b43/xmit.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "250:  } __packed;",
          "256: } __packed;",
          "",
          "[Removed Lines]",
          "254:  __le16 mac_time;",
          "255:  __le16 channel;",
          "",
          "[Added Lines]",
          "253:  union {",
          "255:   struct {",
          "259:    __le16 mac_time;",
          "260:    __le16 channel;",
          "261:   } format_598 __packed;",
          "264:   struct {",
          "266:    __le16 mac_time;",
          "267:    __le16 channel;",
          "268:   } format_351 __packed;",
          "269:  } __packed;",
          "",
          "---------------"
        ]
      }
    }
  ]
}