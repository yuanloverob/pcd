{
  "cve_id": "CVE-2020-9760",
  "cve_desc": "An issue was discovered in WeeChat before 2.7.1 (0.3.4 to 2.7 are affected). When a new IRC message 005 is received with longer nick prefixes, a buffer overflow and possibly a crash can happen when a new mode is set for a nick.",
  "repo": "weechat/weechat",
  "patch_hash": "40ccacb4330a64802b1f1e28ed9a6b6d3ca9197f",
  "patch_info": {
    "commit_hash": "40ccacb4330a64802b1f1e28ed9a6b6d3ca9197f",
    "repo": "weechat/weechat",
    "commit_url": "https://github.com/weechat/weechat/commit/40ccacb4330a64802b1f1e28ed9a6b6d3ca9197f",
    "files": [
      "ChangeLog.adoc",
      "src/plugins/irc/irc-nick.c",
      "src/plugins/irc/irc-nick.h",
      "src/plugins/irc/irc-server.c"
    ],
    "message": "irc: fix crash when a new message 005 is received with longer nick prefixes\n\nThanks to Stuart Nevans Locke for reporting the issue.",
    "before_after_code_files": [
      "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c",
      "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h",
      "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
    ]
  },
  "patch_diff": {
    "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c": [
      "File: src/plugins/irc/irc-nick.c -> src/plugins/irc/irc-nick.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "643:     }",
      "644: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "651: void",
      "652: irc_nick_realloc_prefixes (struct t_irc_server *server,",
      "653:                            int old_length, int new_length)",
      "654: {",
      "655:     struct t_irc_channel *ptr_channel;",
      "656:     struct t_irc_nick *ptr_nick;",
      "657:     char *new_prefixes;",
      "659:     for (ptr_channel = server->channels; ptr_channel;",
      "660:          ptr_channel = ptr_channel->next_channel)",
      "661:     {",
      "662:         for (ptr_nick = ptr_channel->nicks; ptr_nick;",
      "663:              ptr_nick = ptr_nick->next_nick)",
      "664:         {",
      "665:             if (ptr_nick->prefixes)",
      "666:             {",
      "667:                 new_prefixes = realloc (ptr_nick->prefixes, new_length + 1);",
      "668:                 if (new_prefixes)",
      "669:                 {",
      "670:                     ptr_nick->prefixes = new_prefixes;",
      "671:                     if (new_length > old_length)",
      "672:                     {",
      "673:                         memset (ptr_nick->prefixes + old_length,",
      "674:                                 ' ',",
      "675:                                 new_length - old_length);",
      "676:                     }",
      "677:                     ptr_nick->prefixes[new_length] = '\\0';",
      "678:                 }",
      "679:             }",
      "680:             else",
      "681:             {",
      "682:                 ptr_nick->prefixes = malloc (new_length + 1);",
      "683:                 if (ptr_nick->prefixes)",
      "684:                 {",
      "685:                     memset (ptr_nick->prefixes, ' ', new_length);",
      "686:                     ptr_nick->prefixes[new_length] = '\\0';",
      "687:                 }",
      "688:             }",
      "689:         }",
      "690:     }",
      "691: }",
      "",
      "---------------"
    ],
    "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h": [
      "File: src/plugins/irc/irc-nick.h -> src/plugins/irc/irc-nick.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "74: extern void irc_nick_set_mode (struct t_irc_server *server,",
      "75:                                struct t_irc_channel *channel,",
      "76:                                struct t_irc_nick *nick, int set, char mode);",
      "77: extern void irc_nick_free (struct t_irc_server *server,",
      "78:                            struct t_irc_channel *channel,",
      "79:                            struct t_irc_nick *nick);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "77: extern void irc_nick_realloc_prefixes (struct t_irc_server *server,",
      "78:                                        int old_length, int new_length);",
      "",
      "---------------"
    ],
    "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c": [
      "File: src/plugins/irc/irc-server.c -> src/plugins/irc/irc-server.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "988:                                    const char *prefix)",
      "989: {",
      "990:     char *pos;",
      "993:     if (!server || !prefix)",
      "994:         return;",
      "997:     if (server->prefix_modes)",
      "998:     {",
      "",
      "[Removed Lines]",
      "991:     int i, length_modes, length_chars;",
      "",
      "[Added Lines]",
      "991:     int i, old_length_chars, length_modes, length_chars;",
      "996:     old_length_chars = (server->prefix_chars) ?",
      "997:         strlen (server->prefix_chars) : 0;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1032:             }",
      "1033:         }",
      "1034:     }",
      "1035: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1039:     length_chars = (server->prefix_chars) ? strlen (server->prefix_chars) : 0;",
      "1040:     if (server->prefix_chars && (length_chars != old_length_chars))",
      "1041:         irc_nick_realloc_prefixes (server, old_length_chars, length_chars);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "230f64858487e41baa2b92a9d68a0ec732a58bd9",
      "candidate_info": {
        "commit_hash": "230f64858487e41baa2b92a9d68a0ec732a58bd9",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/230f64858487e41baa2b92a9d68a0ec732a58bd9",
        "files": [
          "src/plugins/irc/irc-server.c"
        ],
        "message": "irc: use irc_server_prefix_chars_default if server->prefix_chars is NULL",
        "before_after_code_files": [
          "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
          ],
          "candidate": [
            "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
          ]
        }
      },
      "candidate_diff": {
        "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c": [
          "File: src/plugins/irc/irc-server.c -> src/plugins/irc/irc-server.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "994:         return;",
          "996:     old_length_chars = (server->prefix_chars) ?",
          "1000:     if (server->prefix_modes)",
          "",
          "[Removed Lines]",
          "997:         strlen (server->prefix_chars) : 0;",
          "",
          "[Added Lines]",
          "997:         strlen (server->prefix_chars) :",
          "998:         strlen (irc_server_prefix_chars_default);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1036:         }",
          "1037:     }",
          "1041:         irc_nick_realloc_prefixes (server, old_length_chars, length_chars);",
          "1042: }",
          "",
          "[Removed Lines]",
          "1039:     length_chars = (server->prefix_chars) ? strlen (server->prefix_chars) : 0;",
          "1040:     if (server->prefix_chars && (length_chars != old_length_chars))",
          "",
          "[Added Lines]",
          "1040:     length_chars = (server->prefix_chars) ?",
          "1041:         strlen (server->prefix_chars) :",
          "1042:         strlen (irc_server_prefix_chars_default);",
          "1044:     if (length_chars != old_length_chars)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "694b5c9f874d7337cd2e03761e0de435275dd64d",
      "candidate_info": {
        "commit_hash": "694b5c9f874d7337cd2e03761e0de435275dd64d",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/694b5c9f874d7337cd2e03761e0de435275dd64d",
        "files": [
          "ChangeLog.adoc",
          "src/plugins/irc/irc-nick.c",
          "src/plugins/irc/irc-nick.h",
          "src/plugins/irc/irc-server.c"
        ],
        "message": "irc: fix crash when a new message 005 is received with longer nick prefixes\n\nThanks to Stuart Nevans Locke for reporting the issue.",
        "before_after_code_files": [
          "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c",
          "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h",
          "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c",
            "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h",
            "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
          ],
          "candidate": [
            "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c",
            "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h",
            "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c"
          ]
        }
      },
      "candidate_diff": {
        "src/plugins/irc/irc-nick.c||src/plugins/irc/irc-nick.c": [
          "File: src/plugins/irc/irc-nick.c -> src/plugins/irc/irc-nick.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "643:     }",
          "644: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "651: void",
          "652: irc_nick_realloc_prefixes (struct t_irc_server *server,",
          "653:                            int old_length, int new_length)",
          "654: {",
          "655:     struct t_irc_channel *ptr_channel;",
          "656:     struct t_irc_nick *ptr_nick;",
          "657:     char *new_prefixes;",
          "659:     for (ptr_channel = server->channels; ptr_channel;",
          "660:          ptr_channel = ptr_channel->next_channel)",
          "661:     {",
          "662:         for (ptr_nick = ptr_channel->nicks; ptr_nick;",
          "663:              ptr_nick = ptr_nick->next_nick)",
          "664:         {",
          "665:             if (ptr_nick->prefixes)",
          "666:             {",
          "667:                 new_prefixes = realloc (ptr_nick->prefixes, new_length + 1);",
          "668:                 if (new_prefixes)",
          "669:                 {",
          "670:                     ptr_nick->prefixes = new_prefixes;",
          "671:                     if (new_length > old_length)",
          "672:                     {",
          "673:                         memset (ptr_nick->prefixes + old_length,",
          "674:                                 ' ',",
          "675:                                 new_length - old_length);",
          "676:                     }",
          "677:                     ptr_nick->prefixes[new_length] = '\\0';",
          "678:                 }",
          "679:             }",
          "680:             else",
          "681:             {",
          "682:                 ptr_nick->prefixes = malloc (new_length + 1);",
          "683:                 if (ptr_nick->prefixes)",
          "684:                 {",
          "685:                     memset (ptr_nick->prefixes, ' ', new_length);",
          "686:                     ptr_nick->prefixes[new_length] = '\\0';",
          "687:                 }",
          "688:             }",
          "689:         }",
          "690:     }",
          "691: }",
          "",
          "---------------"
        ],
        "src/plugins/irc/irc-nick.h||src/plugins/irc/irc-nick.h": [
          "File: src/plugins/irc/irc-nick.h -> src/plugins/irc/irc-nick.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "74: extern void irc_nick_set_mode (struct t_irc_server *server,",
          "75:                                struct t_irc_channel *channel,",
          "76:                                struct t_irc_nick *nick, int set, char mode);",
          "77: extern void irc_nick_free (struct t_irc_server *server,",
          "78:                            struct t_irc_channel *channel,",
          "79:                            struct t_irc_nick *nick);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "77: extern void irc_nick_realloc_prefixes (struct t_irc_server *server,",
          "78:                                        int old_length, int new_length);",
          "",
          "---------------"
        ],
        "src/plugins/irc/irc-server.c||src/plugins/irc/irc-server.c": [
          "File: src/plugins/irc/irc-server.c -> src/plugins/irc/irc-server.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "988:                                    const char *prefix)",
          "989: {",
          "990:     char *pos;",
          "993:     if (!server || !prefix)",
          "994:         return;",
          "997:     if (server->prefix_modes)",
          "998:     {",
          "",
          "[Removed Lines]",
          "991:     int i, length_modes, length_chars;",
          "",
          "[Added Lines]",
          "991:     int i, old_length_chars, length_modes, length_chars;",
          "996:     old_length_chars = (server->prefix_chars) ?",
          "997:         strlen (server->prefix_chars) :",
          "998:         strlen (irc_server_prefix_chars_default);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1032:             }",
          "1033:         }",
          "1034:     }",
          "1035: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1040:     length_chars = (server->prefix_chars) ?",
          "1041:         strlen (server->prefix_chars) :",
          "1042:         strlen (irc_server_prefix_chars_default);",
          "1044:     if (length_chars != old_length_chars)",
          "1045:         irc_nick_realloc_prefixes (server, old_length_chars, length_chars);",
          "",
          "---------------"
        ]
      }
    }
  ]
}