{
  "cve_id": "CVE-2021-21323",
  "cve_desc": "Brave is an open source web browser with a focus on privacy and security. In Brave versions 1.17.73-1.20.103, the CNAME adblocking feature added in Brave 1.17.73 accidentally initiated DNS requests that bypassed the Brave Tor proxy. Users with adblocking enabled would leak DNS requests from Tor windows to their DNS provider. (DNS requests that were not initiated by CNAME adblocking would go through Tor as expected.) This is fixed in Brave version 1.20.108",
  "repo": "brave/brave-core",
  "patch_hash": "12fe321eaad8acc1cbd1d70b4128f687777bcf15",
  "patch_info": {
    "commit_hash": "12fe321eaad8acc1cbd1d70b4128f687777bcf15",
    "repo": "brave/brave-core",
    "commit_url": "https://github.com/brave/brave-core/commit/12fe321eaad8acc1cbd1d70b4128f687777bcf15",
    "files": [
      "browser/net/BUILD.gn",
      "browser/net/brave_ad_block_tp_network_delegate_helper.cc",
      "android/brave_java_resources.gni",
      "android/brave_java_sources.gni",
      "android/java/org/chromium/chrome/browser/BraveRewardsBalance.java",
      "android/java/org/chromium/chrome/browser/BraveRewardsHelper.java",
      "android/java/org/chromium/chrome/browser/BraveRewardsPanelPopup.java",
      "android/java/org/chromium/chrome/browser/DeprecateBAPModalDialogFragment.java",
      "android/java/org/chromium/chrome/browser/app/BraveActivity.java",
      "android/java/org/chromium/chrome/browser/shields/ShieldsTooltipEnum.java",
      "android/java/org/chromium/chrome/browser/toolbar/top/BraveToolbarLayout.java",
      "android/java/res/drawable/ic_warning_triangle.xml",
      "android/java/res/drawable/ic_warning_triangle_2.xml",
      "android/java/res/drawable/rewards_modal_background.xml",
      "android/java/res/drawable/rewards_tooltip_background.xml",
      "android/java/res/layout/brave_shields_tooltip_layout.xml",
      "android/java/res/layout/fragment_deprecate_bap_modal_dialog.xml",
      "android/java/res/values/brave_colors.xml",
      "browser/farbling/brave_offscreencanvas_farbling_browsertest.cc",
      "browser/ui/android/strings/android_brave_strings.grd",
      "chromium_src/third_party/blink/renderer/core/execution_context/execution_context.cc",
      "components/content_settings/renderer/brave_content_settings_agent_impl_browsertest.cc",
      "components/cosmetic_filters/renderer/cosmetic_filters_js_handler.cc",
      "components/cosmetic_filters/renderer/cosmetic_filters_js_handler.h",
      "ui/webui/resources/br_elements/br_toolbar/br_toolbar.html"
    ],
    "message": "Merge pull request #7769 from brave/tor-dns-leak\n\nFix Tor dns leak",
    "before_after_code_files": [
      "browser/net/BUILD.gn||browser/net/BUILD.gn",
      "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc"
    ]
  },
  "patch_diff": {
    "browser/net/BUILD.gn||browser/net/BUILD.gn": [
      "File: browser/net/BUILD.gn -> browser/net/BUILD.gn",
      "--- Hunk 1 ---",
      "[Context before]",
      "54:     \"//brave/components/brave_webtorrent/browser/buildflags\",",
      "55:     \"//brave/components/ipfs/buildflags\",",
      "56:     \"//brave/extensions:common\",",
      "57:     \"//components/prefs\",",
      "58:     \"//components/user_prefs\",",
      "59:     \"//content/public/browser\",",
      "60:     \"//content/public/common\",",
      "62:     \"//extensions/common:common_constants\",",
      "63:     \"//mojo/public/cpp/bindings\",",
      "64:     \"//mojo/public/cpp/system\",",
      "",
      "[Removed Lines]",
      "61:     \"//components/content_settings/core/browser\",",
      "",
      "[Added Lines]",
      "57:     \"//components/content_settings/core/browser\",",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "88:       \"brave_referrals_network_delegate_helper.h\",",
      "89:     ]",
      "94:   }",
      "96:   if (enable_brave_webtorrent) {",
      "",
      "[Removed Lines]",
      "91:     deps += [",
      "92:       \"//brave/components/brave_referrals/browser\",",
      "93:     ]",
      "",
      "[Added Lines]",
      "91:     deps += [ \"//brave/components/brave_referrals/browser\" ]",
      "",
      "---------------"
    ],
    "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc": [
      "File: browser/net/brave_ad_block_tp_network_delegate_helper.cc -> browser/net/brave_ad_block_tp_network_delegate_helper.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "65:   std::string source_host = ctx->initiator_url.host();",
      "67:   g_brave_browser_process->ad_block_service()->ShouldStartRequest(",
      "71:   if (did_match_important) {",
      "72:     ctx->blocked_by = kAdBlocked;",
      "73:     return;",
      "74:   }",
      "78:     GURL::Replacements replacements = GURL::Replacements();",
      "79:     replacements.SetHost(",
      "80:         canonical_name->c_str(),",
      "",
      "[Removed Lines]",
      "68:         ctx->request_url, ctx->resource_type, source_host,",
      "69:         &did_match_rule, &did_match_exception, &did_match_important,",
      "70:         &ctx->mock_data_url);",
      "76:   if (canonical_name.has_value() && ctx->request_url.host() != *canonical_name",
      "77:       && *canonical_name != \"\") {",
      "",
      "[Added Lines]",
      "68:       ctx->request_url, ctx->resource_type, source_host, &did_match_rule,",
      "69:       &did_match_exception, &did_match_important, &ctx->mock_data_url);",
      "75:   if (canonical_name.has_value() &&",
      "76:       ctx->request_url.host() != *canonical_name && *canonical_name != \"\") {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "82:     const GURL canonical_url = ctx->request_url.ReplaceComponents(replacements);",
      "84:     g_brave_browser_process->ad_block_service()->ShouldStartRequest(",
      "88:   }",
      "90:   if (did_match_important || (did_match_rule && !did_match_exception)) {",
      "",
      "[Removed Lines]",
      "85:         ctx->request_url, ctx->resource_type, source_host,",
      "86:         &did_match_rule, &did_match_exception, &did_match_important,",
      "87:         &ctx->mock_data_url);",
      "",
      "[Added Lines]",
      "84:         ctx->request_url, ctx->resource_type, source_host, &did_match_rule,",
      "85:         &did_match_exception, &did_match_important, &ctx->mock_data_url);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "206:   scoped_refptr<base::SequencedTaskRunner> task_runner =",
      "207:       g_brave_browser_process->ad_block_service()->GetTaskRunner();",
      "210: }",
      "212: int OnBeforeURLRequest_AdBlockTPPreWork(const ResponseCallback& next_callback,",
      "",
      "[Removed Lines]",
      "209:   new AdblockCnameResolveHostClient(std::move(next_callback), task_runner, ctx);",
      "",
      "[Added Lines]",
      "207:   DCHECK(ctx->browser_context);",
      "210:   if (ctx->browser_context->IsTor()) {",
      "211:     ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,",
      "212:                                    base::nullopt);",
      "213:   } else {",
      "214:     new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,",
      "215:                                       ctx);",
      "216:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "da2fa9ec0317b770141736f766d0d3c33602c8bf",
      "candidate_info": {
        "commit_hash": "da2fa9ec0317b770141736f766d0d3c33602c8bf",
        "repo": "brave/brave-core",
        "commit_url": "https://github.com/brave/brave-core/commit/da2fa9ec0317b770141736f766d0d3c33602c8bf",
        "files": [
          "browser/net/BUILD.gn",
          "browser/net/brave_ad_block_tp_network_delegate_helper.cc"
        ],
        "message": "Merge pull request #7909 from brave/pr7769_tor-dns-leak_1.21.x\n\nFix Tor dns leak (uplift to 1.21.x)",
        "before_after_code_files": [
          "browser/net/BUILD.gn||browser/net/BUILD.gn",
          "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "browser/net/BUILD.gn||browser/net/BUILD.gn",
            "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc"
          ],
          "candidate": [
            "browser/net/BUILD.gn||browser/net/BUILD.gn",
            "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc"
          ]
        }
      },
      "candidate_diff": {
        "browser/net/BUILD.gn||browser/net/BUILD.gn": [
          "File: browser/net/BUILD.gn -> browser/net/BUILD.gn",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:     \"//brave/components/brave_webtorrent/browser/buildflags\",",
          "55:     \"//brave/components/ipfs/buildflags\",",
          "56:     \"//brave/extensions:common\",",
          "57:     \"//components/prefs\",",
          "58:     \"//components/user_prefs\",",
          "59:     \"//content/public/browser\",",
          "60:     \"//content/public/common\",",
          "62:     \"//extensions/common:common_constants\",",
          "63:     \"//mojo/public/cpp/bindings\",",
          "64:     \"//mojo/public/cpp/system\",",
          "",
          "[Removed Lines]",
          "61:     \"//components/content_settings/core/browser\",",
          "",
          "[Added Lines]",
          "57:     \"//components/content_settings/core/browser\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "88:       \"brave_referrals_network_delegate_helper.h\",",
          "89:     ]",
          "94:   }",
          "96:   if (enable_brave_webtorrent) {",
          "",
          "[Removed Lines]",
          "91:     deps += [",
          "92:       \"//brave/components/brave_referrals/browser\",",
          "93:     ]",
          "",
          "[Added Lines]",
          "91:     deps += [ \"//brave/components/brave_referrals/browser\" ]",
          "",
          "---------------"
        ],
        "browser/net/brave_ad_block_tp_network_delegate_helper.cc||browser/net/brave_ad_block_tp_network_delegate_helper.cc": [
          "File: browser/net/brave_ad_block_tp_network_delegate_helper.cc -> browser/net/brave_ad_block_tp_network_delegate_helper.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "196:   scoped_refptr<base::SequencedTaskRunner> task_runner =",
          "197:       g_brave_browser_process->ad_block_service()->GetTaskRunner();",
          "200: }",
          "202: int OnBeforeURLRequest_AdBlockTPPreWork(const ResponseCallback& next_callback,",
          "",
          "[Removed Lines]",
          "199:   new AdblockCnameResolveHostClient(std::move(next_callback), task_runner, ctx);",
          "",
          "[Added Lines]",
          "199:   DCHECK(ctx->browser_context);",
          "202:   if (ctx->browser_context->IsTor()) {",
          "203:     ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,",
          "204:                                    base::nullopt);",
          "205:   } else {",
          "206:     new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,",
          "207:                                       ctx);",
          "208:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}