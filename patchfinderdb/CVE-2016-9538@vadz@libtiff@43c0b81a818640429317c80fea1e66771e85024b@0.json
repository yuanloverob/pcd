{
  "cve_id": "CVE-2016-9538",
  "cve_desc": "tools/tiffcrop.c in libtiff 4.0.6 reads an undefined buffer in readContigStripsIntoBuffer() because of a uint16 integer overflow. Reported as MSVR 35100.",
  "repo": "vadz/libtiff",
  "patch_hash": "43c0b81a818640429317c80fea1e66771e85024b",
  "patch_info": {
    "commit_hash": "43c0b81a818640429317c80fea1e66771e85024b",
    "repo": "vadz/libtiff",
    "commit_url": "https://github.com/vadz/libtiff/commit/43c0b81a818640429317c80fea1e66771e85024b",
    "files": [
      "ChangeLog",
      "tools/tiffcp.c",
      "tools/tiffcrop.c"
    ],
    "message": "* tools/tiffcp.c: fix read of undefined variable in case of missing required tags. Found on test case of MSVR 35100. * tools/tiffcrop.c: fix read of undefined buffer in readContigStripsIntoBuffer() due to uint16 overflow. Probably not a security issue but I can be wrong. Reported as MSVR 35100 by Axel Souchet from the MSRC Vulnerabilities & Mitigations team.",
    "before_after_code_files": [
      "tools/tiffcp.c||tools/tiffcp.c",
      "tools/tiffcrop.c||tools/tiffcrop.c"
    ]
  },
  "patch_diff": {
    "tools/tiffcp.c||tools/tiffcp.c": [
      "File: tools/tiffcp.c -> tools/tiffcp.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "592: static int",
      "593: tiffcp(TIFF* in, TIFF* out)",
      "594: {",
      "597:  copyFunc cf;",
      "598:  uint32 width, length;",
      "599:  struct cpTag* p;",
      "",
      "[Removed Lines]",
      "595:  uint16 bitspersample, samplesperpixel;",
      "596:  uint16 input_compression, input_photometric;",
      "",
      "[Added Lines]",
      "595:  uint16 bitspersample, samplesperpixel = 1;",
      "596:  uint16 input_compression, input_photometric = PHOTOMETRIC_MINISBLACK;",
      "",
      "---------------"
    ],
    "tools/tiffcrop.c||tools/tiffcrop.c": [
      "File: tools/tiffcrop.c -> tools/tiffcrop.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3628: {",
      "3629:         uint8* bufp = buf;",
      "3630:         int32  bytes_read = 0;",
      "3632:         uint32 stripsize = TIFFStripSize(in);",
      "3633:         uint32 rows = 0;",
      "3634:         uint32 rps = TIFFGetFieldDefaulted(in, TIFFTAG_ROWSPERSTRIP, &rps);",
      "",
      "[Removed Lines]",
      "3631:         uint16 strip, nstrips   = TIFFNumberOfStrips(in);",
      "",
      "[Added Lines]",
      "3631:         uint32 strip, nstrips   = TIFFNumberOfStrips(in);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "4711:                                          uint32 width, uint16 spp,",
      "4712:                                          struct dump_opts *dump)",
      "4713:   {",
      "4715:   int32  bytes_read = 0;",
      "4717:   uint32 src_rowsize, dst_rowsize, rows_processed, rps;",
      "4718:   uint32 rows_this_strip = 0;",
      "4719:   tsample_t s;",
      "",
      "[Removed Lines]",
      "4714:   int i, j, bytes_per_sample, bytes_per_pixel, shift_width, result = 1;",
      "4716:   uint16 bps, nstrips, planar, strips_per_sample;",
      "",
      "[Added Lines]",
      "4714:   int i, bytes_per_sample, bytes_per_pixel, shift_width, result = 1;",
      "4715:   uint32 j;",
      "4717:   uint16 bps, planar;",
      "4718:   uint32 nstrips;",
      "4719:   uint32 strips_per_sample;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5c080298d59efa53264d7248bbe3a04660db6ef7",
      "candidate_info": {
        "commit_hash": "5c080298d59efa53264d7248bbe3a04660db6ef7",
        "repo": "vadz/libtiff",
        "commit_url": "https://github.com/vadz/libtiff/commit/5c080298d59efa53264d7248bbe3a04660db6ef7",
        "files": [
          "ChangeLog",
          "tools/tiffcp.c"
        ],
        "message": "* tools/tiffcp.c: error out cleanly in cpContig2SeparateByRow and cpSeparate2ContigByRow if BitsPerSample != 8 to avoid heap based overflow. Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2656 and http://bugzilla.maptools.org/show_bug.cgi?id=2657",
        "before_after_code_files": [
          "tools/tiffcp.c||tools/tiffcp.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/tiffcp.c||tools/tiffcp.c"
          ],
          "candidate": [
            "tools/tiffcp.c||tools/tiffcp.c"
          ]
        }
      },
      "candidate_diff": {
        "tools/tiffcp.c||tools/tiffcp.c": [
          "File: tools/tiffcp.c -> tools/tiffcp.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "591: static int",
          "592: tiffcp(TIFF* in, TIFF* out)",
          "593: {",
          "595:  uint16 input_compression, input_photometric = PHOTOMETRIC_MINISBLACK;",
          "596:  copyFunc cf;",
          "597:  uint32 width, length;",
          "",
          "[Removed Lines]",
          "594:  uint16 bitspersample, samplesperpixel = 1;",
          "",
          "[Added Lines]",
          "594:  uint16 bitspersample = 1, samplesperpixel = 1;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1067:  register uint32 n;",
          "1068:  uint32 row;",
          "1069:  tsample_t s;",
          "1071:  inbuf = _TIFFmalloc(scanlinesizein);",
          "1072:  outbuf = _TIFFmalloc(scanlinesizeout);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1070:         uint16 bps = 0;",
          "1072:         (void) TIFFGetField(in, TIFFTAG_BITSPERSAMPLE, &bps);",
          "1073:         if( bps != 8 )",
          "1074:         {",
          "1075:             TIFFError(TIFFFileName(in),",
          "1076:                       \"Error, can only handle BitsPerSample=8 in %s\",",
          "1077:                       \"cpContig2SeparateByRow\");",
          "1078:             return 0;",
          "1079:         }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1120:  register uint32 n;",
          "1121:  uint32 row;",
          "1122:  tsample_t s;",
          "1124:  inbuf = _TIFFmalloc(scanlinesizein);",
          "1125:  outbuf = _TIFFmalloc(scanlinesizeout);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1133:         uint16 bps = 0;",
          "1135:         (void) TIFFGetField(in, TIFFTAG_BITSPERSAMPLE, &bps);",
          "1136:         if( bps != 8 )",
          "1137:         {",
          "1138:             TIFFError(TIFFFileName(in),",
          "1139:                       \"Error, can only handle BitsPerSample=8 in %s\",",
          "1140:                       \"cpSeparate2ContigByRow\");",
          "1141:             return 0;",
          "1142:         }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1784:  uint32 w, l, tw, tl;",
          "1785:  int bychunk;",
          "1788:  if (shortv != config && bitspersample != 8 && samplesperpixel > 1) {",
          "1789:   fprintf(stderr,",
          "1790:       \"%s: Cannot handle different planar configuration w/ bits/sample != 8\\n\",",
          "",
          "[Removed Lines]",
          "1787:  (void) TIFFGetField(in, TIFFTAG_PLANARCONFIG, &shortv);",
          "",
          "[Added Lines]",
          "1807:  (void) TIFFGetFieldDefaulted(in, TIFFTAG_PLANARCONFIG, &shortv);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d3c5426395dc53e3345712ac7246c29db9fed8fa",
      "candidate_info": {
        "commit_hash": "d3c5426395dc53e3345712ac7246c29db9fed8fa",
        "repo": "vadz/libtiff",
        "commit_url": "https://github.com/vadz/libtiff/commit/d3c5426395dc53e3345712ac7246c29db9fed8fa",
        "files": [
          "ChangeLog",
          "tools/tiffcrop.c"
        ],
        "message": "* tools/tiffcrop.c: fix integer division by zero when BitsPerSample is missing. Reported by Agostina Sarubo. Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2619",
        "before_after_code_files": [
          "tools/tiffcrop.c||tools/tiffcrop.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/tiffcrop.c||tools/tiffcrop.c"
          ],
          "candidate": [
            "tools/tiffcrop.c||tools/tiffcrop.c"
          ]
        }
      },
      "candidate_diff": {
        "tools/tiffcrop.c||tools/tiffcrop.c": [
          "File: tools/tiffcrop.c -> tools/tiffcrop.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1164:   tdata_t  obuf;",
          "1166:   (void) TIFFGetFieldDefaulted(out, TIFFTAG_ROWSPERSTRIP, &rowsperstrip);",
          "1168:   bytes_per_sample = (bps + 7) / 8;",
          "1169:   if( width == 0 ||",
          "1170:       (uint32)bps * (uint32)spp > TIFF_UINT32_MAX / width ||",
          "",
          "[Removed Lines]",
          "1167:   (void) TIFFGetField(out, TIFFTAG_BITSPERSAMPLE, &bps);",
          "",
          "[Added Lines]",
          "1167:   (void) TIFFGetFieldDefaulted(out, TIFFTAG_BITSPERSAMPLE, &bps);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4760:   int i, bytes_per_sample, bytes_per_pixel, shift_width, result = 1;",
          "4761:   uint32 j;",
          "4762:   int32  bytes_read = 0;",
          "4764:   uint32 nstrips;",
          "4765:   uint32 strips_per_sample;",
          "4766:   uint32 src_rowsize, dst_rowsize, rows_processed, rps;",
          "",
          "[Removed Lines]",
          "4763:   uint16 bps, planar;",
          "",
          "[Added Lines]",
          "4763:   uint16 bps = 0, planar;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "4780:     }",
          "4782:   memset (srcbuffs, '\\0', sizeof(srcbuffs));",
          "4784:   TIFFGetFieldDefaulted(in, TIFFTAG_PLANARCONFIG, &planar);",
          "4785:   TIFFGetFieldDefaulted(in, TIFFTAG_ROWSPERSTRIP, &rps);",
          "4786:   if (rps > length)",
          "",
          "[Removed Lines]",
          "4783:   TIFFGetField(in, TIFFTAG_BITSPERSAMPLE, &bps);",
          "",
          "[Added Lines]",
          "4783:   TIFFGetFieldDefaulted(in, TIFFTAG_BITSPERSAMPLE, &bps);",
          "",
          "---------------"
        ]
      }
    }
  ]
}