{
  "cve_id": "CVE-2022-31622",
  "cve_desc": "MariaDB Server before 10.7 is vulnerable to Denial of Service. In extra/mariabackup/ds_compress.cc, when an error occurs (pthread_create returns a nonzero value) while executing the method create_worker_threads, the held lock is not released correctly, which allows local users to trigger a denial of service due to the deadlock. Note: The vendor argues this is just an improper locking bug and not a vulnerability with adverse effects.",
  "repo": "MariaDB/server",
  "patch_hash": "e1eb39a446c30b8459c39fd7f2ee1c55a36e97d2",
  "patch_info": {
    "commit_hash": "e1eb39a446c30b8459c39fd7f2ee1c55a36e97d2",
    "repo": "MariaDB/server",
    "commit_url": "https://github.com/MariaDB/server/commit/e1eb39a446c30b8459c39fd7f2ee1c55a36e97d2",
    "files": [
      "extra/mariabackup/ds_compress.cc"
    ],
    "message": "MDEV-26561 Fix a bug due to unreleased lock\n\nFix a bug of unreleased lock ctrl_mutex in the method create_worker_threads",
    "before_after_code_files": [
      "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc"
    ]
  },
  "patch_diff": {
    "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc": [
      "File: extra/mariabackup/ds_compress.cc -> extra/mariabackup/ds_compress.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "369:        thd)) {",
      "370:    msg(\"compress: pthread_create() failed: \"",
      "371:        \"errno = %d\", errno);",
      "372:    goto err;",
      "373:   }",
      "374:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "372:    pthread_mutex_unlock(&thd->ctrl_mutex);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7c30bc38a588b22b01f11130cfe99e7f36accf94",
      "candidate_info": {
        "commit_hash": "7c30bc38a588b22b01f11130cfe99e7f36accf94",
        "repo": "MariaDB/server",
        "commit_url": "https://github.com/MariaDB/server/commit/7c30bc38a588b22b01f11130cfe99e7f36accf94",
        "files": [
          "extra/mariabackup/ds_compress.cc"
        ],
        "message": "MDEV-26561 mariabackup release locks\n\nThe previous threads locked need to be released too.\n\nThis occurs if the initialization of any of the non-first\nmutex/conditition variables errors occurs.",
        "before_after_code_files": [
          "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/MariaDB/server/pull/1938"
        ],
        "olp_code_files": {
          "patch": [
            "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc"
          ],
          "candidate": [
            "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc"
          ]
        }
      },
      "candidate_diff": {
        "extra/mariabackup/ds_compress.cc||extra/mariabackup/ds_compress.cc": [
          "File: extra/mariabackup/ds_compress.cc -> extra/mariabackup/ds_compress.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "386:  return threads;",
          "388: err:",
          "389:  my_free(threads);",
          "390:  return NULL;",
          "391: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "389:  while (i > 0) {",
          "390:   comp_thread_ctxt_t *thd;",
          "391:   i--;",
          "392:   thd = threads + i;",
          "393:   pthread_mutex_unlock(&thd->ctrl_mutex);",
          "394:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}