{
  "cve_id": "CVE-2014-2270",
  "cve_desc": "softmagic.c in file before 5.17 and libmagic allows context-dependent attackers to cause a denial of service (out-of-bounds memory access and crash) via crafted offsets in the softmagic of a PE executable.",
  "repo": "file/file",
  "patch_hash": "447558595a3650db2886cd2f416ad0beba965801",
  "patch_info": {
    "commit_hash": "447558595a3650db2886cd2f416ad0beba965801",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/447558595a3650db2886cd2f416ad0beba965801",
    "files": [
      "src/softmagic.c"
    ],
    "message": "PR/313: Aaron Reffett: Check properly for exceeding the offset.",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.170 2014/01/06 02:25:32 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.171 2014/01/08 22:02:06 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "71: private void cvt_32(union VALUETYPE *, const struct magic *);",
      "72: private void cvt_64(union VALUETYPE *, const struct magic *);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "74: #define OFFSET_OOB(n, o, i) ((n) < (o) || (i) >= ((n) - (o)))",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1223:   }",
      "1224:   switch (in_type = cvt_flip(m->in_type, flip)) {",
      "1225:   case FILE_BYTE:",
      "1227:     return 0;",
      "1228:    if (off) {",
      "1229:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1226:    if (nbytes < offset || nbytes < (offset + 1))",
      "",
      "[Added Lines]",
      "1227:    if (OFFSET_OOB(nbytes, offset, 1))",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1258:     offset = ~offset;",
      "1259:    break;",
      "1260:   case FILE_BESHORT:",
      "1262:     return 0;",
      "1263:    if (off) {",
      "1264:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1261:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1262:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "1310:     offset = ~offset;",
      "1311:    break;",
      "1312:   case FILE_LESHORT:",
      "1314:     return 0;",
      "1315:    if (off) {",
      "1316:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1313:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1314:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "1362:     offset = ~offset;",
      "1363:    break;",
      "1364:   case FILE_SHORT:",
      "1366:     return 0;",
      "1367:    if (off) {",
      "1368:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1365:    if (nbytes < offset || nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1366:    if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "1399:    break;",
      "1400:   case FILE_BELONG:",
      "1401:   case FILE_BEID3:",
      "1403:     return 0;",
      "1404:    if (off) {",
      "1405:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1402:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1403:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 8 ---",
      "[Context before]",
      "1470:    break;",
      "1471:   case FILE_LELONG:",
      "1472:   case FILE_LEID3:",
      "1474:     return 0;",
      "1475:    if (off) {",
      "1476:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1473:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1474:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 9 ---",
      "[Context before]",
      "1540:     offset = ~offset;",
      "1541:    break;",
      "1542:   case FILE_MELONG:",
      "1544:     return 0;",
      "1545:    if (off) {",
      "1546:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1543:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1544:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 10 ---",
      "[Context before]",
      "1610:     offset = ~offset;",
      "1611:    break;",
      "1612:   case FILE_LONG:",
      "1614:     return 0;",
      "1615:    if (off) {",
      "1616:     switch (m->in_op & FILE_OPS_MASK) {",
      "",
      "[Removed Lines]",
      "1613:    if (nbytes < offset || nbytes < (offset + 4))",
      "",
      "[Added Lines]",
      "1614:    if (OFFSET_OOB(nbytes, offset, 4))",
      "",
      "---------------",
      "--- Hunk 11 ---",
      "[Context before]",
      "1688:  switch (m->type) {",
      "1689:  case FILE_BYTE:",
      "1691:    return 0;",
      "1692:   break;",
      "1694:  case FILE_SHORT:",
      "1695:  case FILE_BESHORT:",
      "1696:  case FILE_LESHORT:",
      "1698:    return 0;",
      "1699:   break;",
      "",
      "[Removed Lines]",
      "1697:   if (nbytes < (offset + 2))",
      "",
      "[Added Lines]",
      "1691:   if (OFFSET_OOB(nbytes, offset, 1))",
      "1698:   if (OFFSET_OOB(nbytes, offset, 2))",
      "",
      "---------------",
      "--- Hunk 12 ---",
      "[Context before]",
      "1713:  case FILE_FLOAT:",
      "1714:  case FILE_BEFLOAT:",
      "1715:  case FILE_LEFLOAT:",
      "1717:    return 0;",
      "1718:   break;",
      "1720:  case FILE_DOUBLE:",
      "1721:  case FILE_BEDOUBLE:",
      "1722:  case FILE_LEDOUBLE:",
      "1724:    return 0;",
      "1725:   break;",
      "1727:  case FILE_STRING:",
      "1728:  case FILE_PSTRING:",
      "1729:  case FILE_SEARCH:",
      "1731:    return 0;",
      "1732:   break;",
      "1734:  case FILE_REGEX:",
      "1736:    return 0;",
      "1737:   break;",
      "1739:  case FILE_INDIRECT:",
      "1741:    return 0;",
      "1742:   sbuf = ms->o.buf;",
      "1743:   soffset = ms->offset;",
      "",
      "[Removed Lines]",
      "1716:   if (nbytes < (offset + 4))",
      "1723:   if (nbytes < (offset + 8))",
      "1730:   if (nbytes < (offset + m->vallen))",
      "1735:   if (nbytes < offset)",
      "1740:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1717:   if (OFFSET_OOB(nbytes, offset, 4))",
      "1724:   if (OFFSET_OOB(nbytes, offset, 8))",
      "1731:   if (OFFSET_OOB(nbytes, offset, m->vallen))",
      "1736:   if (OFFSET_OOB(nbytes, offset, 0))",
      "1741:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------",
      "--- Hunk 13 ---",
      "[Context before]",
      "1761:   return rv;",
      "1763:  case FILE_USE:",
      "1765:    return 0;",
      "1766:   sbuf = m->value.s;",
      "1767:   if (*sbuf == '^') {",
      "",
      "[Removed Lines]",
      "1764:   if (nbytes < offset)",
      "",
      "[Added Lines]",
      "1765:   if (OFFSET_OOB(nbytes, offset, 0))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4075d47c8debe0b2d413c1cf0f01b8f48813756c",
      "candidate_info": {
        "commit_hash": "4075d47c8debe0b2d413c1cf0f01b8f48813756c",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/4075d47c8debe0b2d413c1cf0f01b8f48813756c",
        "files": [
          "src/softmagic.c"
        ],
        "message": "indirect offsets should be relative to the beginning of the current magic.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.203 2014/12/04 15:22:05 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.204 2014/12/11 12:34:24 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1665:   break;",
          "1667:  case FILE_INDIRECT:",
          "1668:   if (offset == 0)",
          "1669:    return 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1668:   offset += o;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9b6ada8a20d69bec0ced9ef5f5ff5004c4a142db",
      "candidate_info": {
        "commit_hash": "9b6ada8a20d69bec0ced9ef5f5ff5004c4a142db",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/9b6ada8a20d69bec0ced9ef5f5ff5004c4a142db",
        "files": [
          "src/softmagic.c"
        ],
        "message": "maintain the current flip value on recursive calls unless you encounter another ^. From Toby Peterson",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.162 2013/02/27 00:27:15 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.163 2013/02/27 16:58:32 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1735:   sbuf = m->value.s;",
          "1736:   if (*sbuf == '^') {",
          "1737:    sbuf++;",
          "1741:   if (file_magicfind(ms, sbuf, &ml) == -1) {",
          "1742:    file_error(ms, 0, \"cannot find entry `%s'\", sbuf);",
          "1743:    return -1;",
          "",
          "[Removed Lines]",
          "1738:    flip = 1;",
          "1739:   } else",
          "1740:    flip = 0;",
          "",
          "[Added Lines]",
          "1738:    flip = !flip;",
          "1739:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "43137d87ebe726757ff4b91cd8aae9b8e355fc5a",
      "candidate_info": {
        "commit_hash": "43137d87ebe726757ff4b91cd8aae9b8e355fc5a",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/43137d87ebe726757ff4b91cd8aae9b8e355fc5a",
        "files": [
          "ChangeLog",
          "src/softmagic.c"
        ],
        "message": "Make strings from files always printable.",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.194 2014/09/22 18:26:19 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.195 2014/09/24 19:49:07 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "397: }",
          "400: private int32_t",
          "401: mprint(struct magic_set *ms, struct magic *m)",
          "402: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "400: static char *",
          "401: printable(char *buf, size_t bufsiz, const char *str)",
          "402: {",
          "403:  char *ptr, *eptr;",
          "404:  const unsigned char *s = (const unsigned char *)str;",
          "406:  for (ptr = buf, eptr = ptr + bufsiz - 1; ptr < eptr && *s; s++) {",
          "407:   if (isprint(*s)) {",
          "409:    continue;",
          "410:   }",
          "411:   if (ptr >= eptr + 4)",
          "412:    break;",
          "417:  }",
          "419:  return buf;",
          "420: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "503:    t = ms->offset + m->vallen;",
          "504:   }",
          "505:   else {",
          "506:    char *str = p->s;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "528:    char sbuf[512];",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "525:    }",
          "528:     return -1;",
          "530:    if (m->type == FILE_PSTRING)",
          "",
          "[Removed Lines]",
          "527:    if (file_printf(ms, F(ms, m, \"%s\"), str) == -1)",
          "",
          "[Added Lines]",
          "550:    if (file_printf(ms, F(ms, m, \"%s\"),",
          "551:        printable(sbuf, sizeof(sbuf), str)) == -1)",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "809020889c857afb776a67cc73b1c4fa217adc0b",
      "candidate_info": {
        "commit_hash": "809020889c857afb776a67cc73b1c4fa217adc0b",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/809020889c857afb776a67cc73b1c4fa217adc0b",
        "files": [
          "src/apprentice.c",
          "src/cdf_time.c",
          "src/file.h",
          "src/fsmagic.c",
          "src/funcs.c",
          "src/magic.c",
          "src/softmagic.c"
        ],
        "message": "PR/347: Windows patches.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/cdf_time.c||src/cdf_time.c",
          "src/file.h||src/file.h",
          "src/fsmagic.c||src/fsmagic.c",
          "src/funcs.c||src/funcs.c",
          "src/magic.c||src/magic.c",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.208 2014/05/06 16:07:23 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.209 2014/05/13 16:42:17 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2767:  }",
          "2768:  entries = (uint32_t)(st.st_size / sizeof(struct magic));",
          "2769:  if ((off_t)(entries * sizeof(struct magic)) != st.st_size) {",
          "2771:       dbname, (unsigned long long)st.st_size,",
          "2772:       sizeof(struct magic));",
          "2773:   goto error;",
          "",
          "[Removed Lines]",
          "2770:   file_error(ms, 0, \"Size of `%s' %llu is not a multiple of %zu\",",
          "",
          "[Added Lines]",
          "2770:   file_error(ms, 0, \"Size of `%s' %\" INT64_T_FORMAT \"u is not \"",
          "2771:       \"a multiple of %\" SIZE_T_FORMAT \"u\",",
          "",
          "---------------"
        ],
        "src/cdf_time.c||src/cdf_time.c": [
          "File: src/cdf_time.c -> src/cdf_time.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "31: #endif",
          "33: #include <time.h>",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: cdf_time.c,v 1.13 2014/02/25 20:52:02 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: cdf_time.c,v 1.14 2014/04/17 12:44:01 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "171:  char *ptr = ctime_r(sec, buf);",
          "172:  if (ptr != NULL)",
          "173:   return buf;",
          "175:  return buf;",
          "176: }",
          "",
          "[Removed Lines]",
          "174:  (void)snprintf(buf, 26, \"*Bad* 0x%16.16llx\\n\", (long long)*sec);",
          "",
          "[Added Lines]",
          "174:  (void)snprintf(buf, 26, \"*Bad* 0x%16.16\" INT64_T_FORMAT \"x\\n\",",
          "175:      (long long)*sec);",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "84: #define private static",
          "87: #define public  __attribute__ ((__visibility__(\"default\")))",
          "88: #ifndef protected",
          "89: #define protected __attribute__ ((__visibility__(\"hidden\")))",
          "",
          "[Removed Lines]",
          "86: #if HAVE_VISIBILITY",
          "",
          "[Added Lines]",
          "86: #if HAVE_VISIBILITY && !defined(WIN32)",
          "",
          "---------------"
        ],
        "src/fsmagic.c||src/fsmagic.c": [
          "File: src/fsmagic.c -> src/fsmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.71 2013/12/01 18:01:07 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: fsmagic.c,v 1.72 2014/04/17 12:47:11 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "54: # define HAVE_MAJOR",
          "55: #endif",
          "57: #ifndef HAVE_MAJOR",
          "58: # define major(dev)  (((dev) >> 8) & 0xff)",
          "59: # define minor(dev)  ((dev) & 0xff)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56: #ifdef WIN32",
          "57: # define WIN32_LEAN_AND_MEAN",
          "58: # include <windows.h>",
          "59: #endif",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123: #endif",
          "126:  if (ret) {",
          "127:   if (ms->flags & MAGIC_ERROR) {",
          "128:    file_error(ms, errno, \"cannot stat `%s'\", fn);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "130: #ifdef WIN32",
          "131:  {",
          "132:   HANDLE hFile = CreateFile(fn, 0, FILE_SHARE_DELETE |",
          "133:       FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0,",
          "134:       NULL);",
          "135:   if (hFile != INVALID_HANDLE_VALUE) {",
          "140:    if (ret) {",
          "141:     sb->st_mode = S_IFBLK;",
          "142:     ret = 0;",
          "143:    }",
          "144:    switch (GetFileType(hFile)) {",
          "145:    case FILE_TYPE_CHAR:",
          "146:     sb->st_mode |= S_IFCHR;",
          "147:     sb->st_mode &= ~S_IFREG;",
          "148:     break;",
          "149:    case FILE_TYPE_PIPE:",
          "150:     sb->st_mode |= S_IFIFO;",
          "151:     sb->st_mode &= ~S_IFREG;",
          "152:     break;",
          "153:    }",
          "154:    CloseHandle(hFile);",
          "155:   }",
          "156:  }",
          "157: #endif",
          "",
          "---------------"
        ],
        "src/funcs.c||src/funcs.c": [
          "File: src/funcs.c -> src/funcs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "27: #include \"file.h\"",
          "29: #ifndef lint",
          "33: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.70 2014/03/14 19:02:37 christos Exp $\")",
          "",
          "[Added Lines]",
          "30: FILE_RCSID(\"@(#)$File: funcs.c,v 1.71 2014/05/05 20:53:10 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "280:   if (file_printf(ms, \"%s\", code_mime) == -1)",
          "281:    rv = -1;",
          "282:  }",
          "283:  done_encoding:",
          "284:  free(u8buf);",
          "285:  if (rv)",
          "286:   return rv;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "283: #if HAVE_FORK",
          "285: #endif",
          "",
          "---------------"
        ],
        "src/magic.c||src/magic.c": [
          "File: src/magic.c -> src/magic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #include \"file.h\"",
          "35: #ifndef lint",
          "39: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.82 2014/05/13 16:38:23 christos Exp $\")",
          "",
          "[Added Lines]",
          "36: FILE_RCSID(\"@(#)$File: magic.c,v 1.83 2014/05/13 16:44:24 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "126:  free(hmagicpath);",
          "127:  return MAGIC;",
          "128: #else",
          "130:  char *tmppath = NULL;",
          "132: #define APPENDPATH() \\",
          "133:  do { \\",
          "",
          "[Removed Lines]",
          "129:  char *hmagicp = hmagicpath;",
          "",
          "[Added Lines]",
          "129:  char *hmagicp;",
          "131:  hmagicpath = NULL;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "368:   goto done;",
          "369:  }",
          "371:  if (inname == NULL) {",
          "372:   if (fstat(fd, &sb) == 0 && S_ISFIFO(sb.st_mode))",
          "373:    ispipe = 1;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "372: #ifdef WIN32",
          "374:  if (fd == STDIN_FILENO)",
          "375:   _setmode(STDIN_FILENO, O_BINARY);",
          "376: #endif",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "387:   errno = 0;",
          "388:   if ((fd = open(inname, flags)) < 0) {",
          "389:    if (okstat &&",
          "390:        unreadable_info(ms, sb.st_mode, inname) == -1)",
          "391:     goto done;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "396: #ifdef WIN32",
          "403:    if (!okstat && errno == EACCES) {",
          "404:     sb.st_mode = S_IFBLK;",
          "405:     okstat = 1;",
          "406:    }",
          "407: #endif",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "421:   }",
          "423:  } else {",
          "426:    goto done;",
          "427:   }",
          "428:  }",
          "",
          "[Removed Lines]",
          "424:   if ((nbytes = read(fd, (char *)buf, HOWMANY)) == -1) {",
          "425:    file_error(ms, errno, \"cannot read `%s'\", inname);",
          "",
          "[Added Lines]",
          "444:   size_t howmany =",
          "445: #if defined(WIN32) && HOWMANY > 8 * 1024",
          "446:     _isatty(fd) ? 8 * 1024 :",
          "447: #endif",
          "448:     HOWMANY;",
          "449:   if ((nbytes = read(fd, (char *)buf, howmany)) == -1) {",
          "450:    if (inname == NULL && fd != STDIN_FILENO)",
          "451:     file_error(ms, errno, \"cannot read fd %d\", fd);",
          "452:    else",
          "453:     file_error(ms, errno, \"cannot read `%s'\",",
          "454:         inname == NULL ? \"/dev/stdin\" : inname);",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.186 2014/05/05 20:53:10 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.187 2014/05/13 16:42:17 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "482:   case -1:",
          "483:    return -1;",
          "484:   case 1:",
          "486:        (unsigned long long)v);",
          "487:    if (file_printf(ms, F(ms, m, \"%s\"), buf) == -1)",
          "488:     return -1;",
          "489:    break;",
          "490:   default:",
          "492:        (unsigned long long) v) == -1)",
          "493:     return -1;",
          "494:    break;",
          "",
          "[Removed Lines]",
          "485:    (void)snprintf(buf, sizeof(buf), \"%llu\",",
          "491:    if (file_printf(ms, F(ms, m, \"%llu\"),",
          "",
          "[Added Lines]",
          "485:    (void)snprintf(buf, sizeof(buf), \"%\" INT64_T_FORMAT \"u\",",
          "491:    if (file_printf(ms, F(ms, m, \"%\" INT64_T_FORMAT \"u\"),",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "24afd020b48d38d90350579b707773bf9d08c6ba",
      "candidate_info": {
        "commit_hash": "24afd020b48d38d90350579b707773bf9d08c6ba",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/24afd020b48d38d90350579b707773bf9d08c6ba",
        "files": [
          "ChangeLog",
          "doc/magic.man",
          "magic/Magdir/jpeg",
          "src/apprentice.c",
          "src/file.h",
          "src/softmagic.c"
        ],
        "message": "Add indirect relative offsets; make Exif use them. All other indirect magic is absolute by default.",
        "before_after_code_files": [
          "src/apprentice.c||src/apprentice.c",
          "src/file.h||src/file.h",
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/apprentice.c||src/apprentice.c": [
          "File: src/apprentice.c -> src/apprentice.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.227 2014/11/28 02:46:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: apprentice.c,v 1.228 2014/12/16 23:18:40 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1605: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1608: private int",
          "1609: parse_indirect_modifier(struct magic_set *ms, struct magic *m, const char **lp)",
          "1610: {",
          "1611:  const char *l = *lp;",
          "1613:  while (!isspace((unsigned char)*++l))",
          "1614:   switch (*l) {",
          "1615:   case CHAR_INDIRECT_RELATIVE:",
          "1616:    m->str_flags |= INDIRECT_RELATIVE;",
          "1617:    break;",
          "1618:   default:",
          "1619:    if (ms->flags & MAGIC_CHECK)",
          "1620:     file_magwarn(ms, \"indirect modifier `%c' \"",
          "1621:      \"invalid\", *l);",
          "1623:    return -1;",
          "1624:   }",
          "1626:  return 0;",
          "1627: }",
          "1629: private void",
          "1630: parse_op_modifier(struct magic_set *ms, struct magic *m, const char **lp,",
          "1631:     int op)",
          "1632: {",
          "1633:  const char *l = *lp;",
          "1634:  char *t;",
          "1635:  uint64_t val;",
          "1637:  ++l;",
          "1638:  m->mask_op |= op;",
          "1639:  val = (uint64_t)strtoull(l, &t, 0);",
          "1640:  l = t;",
          "1641:  m->num_mask = file_signextend(ms, m, val);",
          "1642:  eatsize(&l);",
          "1644: }",
          "1646: private int",
          "1647: parse_string_modifier(struct magic_set *ms, struct magic *m, const char **lp)",
          "1648: {",
          "1649:  const char *l = *lp;",
          "1650:  char *t;",
          "1651:  int have_range = 0;",
          "1653:  while (!isspace((unsigned char)*++l)) {",
          "1654:   switch (*l) {",
          "1655:   case '0':  case '1':  case '2':",
          "1656:   case '3':  case '4':  case '5':",
          "1657:   case '6':  case '7':  case '8':",
          "1658:   case '9':",
          "1659:    if (have_range && (ms->flags & MAGIC_CHECK))",
          "1660:     file_magwarn(ms, \"multiple ranges\");",
          "1661:    have_range = 1;",
          "1662:    m->str_range = CAST(uint32_t, strtoul(l, &t, 0));",
          "1663:    if (m->str_range == 0)",
          "1664:     file_magwarn(ms, \"zero range\");",
          "1665:    l = t - 1;",
          "1666:    break;",
          "1667:   case CHAR_COMPACT_WHITESPACE:",
          "1668:    m->str_flags |= STRING_COMPACT_WHITESPACE;",
          "1669:    break;",
          "1670:   case CHAR_COMPACT_OPTIONAL_WHITESPACE:",
          "1671:    m->str_flags |= STRING_COMPACT_OPTIONAL_WHITESPACE;",
          "1672:    break;",
          "1673:   case CHAR_IGNORE_LOWERCASE:",
          "1674:    m->str_flags |= STRING_IGNORE_LOWERCASE;",
          "1675:    break;",
          "1676:   case CHAR_IGNORE_UPPERCASE:",
          "1677:    m->str_flags |= STRING_IGNORE_UPPERCASE;",
          "1678:    break;",
          "1679:   case CHAR_REGEX_OFFSET_START:",
          "1680:    m->str_flags |= REGEX_OFFSET_START;",
          "1681:    break;",
          "1682:   case CHAR_BINTEST:",
          "1683:    m->str_flags |= STRING_BINTEST;",
          "1684:    break;",
          "1685:   case CHAR_TEXTTEST:",
          "1686:    m->str_flags |= STRING_TEXTTEST;",
          "1687:    break;",
          "1688:   case CHAR_TRIM:",
          "1689:    m->str_flags |= STRING_TRIM;",
          "1690:    break;",
          "1691:   case CHAR_PSTRING_1_LE:",
          "1692: #define SET_LENGTH(a) m->str_flags = (m->str_flags & ~PSTRING_LEN) | (a)",
          "1693:    if (m->type != FILE_PSTRING)",
          "1694:     goto bad;",
          "1695:    SET_LENGTH(PSTRING_1_LE);",
          "1696:    break;",
          "1697:   case CHAR_PSTRING_2_BE:",
          "1698:    if (m->type != FILE_PSTRING)",
          "1699:     goto bad;",
          "1700:    SET_LENGTH(PSTRING_2_BE);",
          "1701:    break;",
          "1702:   case CHAR_PSTRING_2_LE:",
          "1703:    if (m->type != FILE_PSTRING)",
          "1704:     goto bad;",
          "1705:    SET_LENGTH(PSTRING_2_LE);",
          "1706:    break;",
          "1707:   case CHAR_PSTRING_4_BE:",
          "1708:    if (m->type != FILE_PSTRING)",
          "1709:     goto bad;",
          "1710:    SET_LENGTH(PSTRING_4_BE);",
          "1711:    break;",
          "1712:   case CHAR_PSTRING_4_LE:",
          "1713:    switch (m->type) {",
          "1714:    case FILE_PSTRING:",
          "1715:    case FILE_REGEX:",
          "1716:     break;",
          "1717:    default:",
          "1718:     goto bad;",
          "1719:    }",
          "1720:    SET_LENGTH(PSTRING_4_LE);",
          "1721:    break;",
          "1722:   case CHAR_PSTRING_LENGTH_INCLUDES_ITSELF:",
          "1723:    if (m->type != FILE_PSTRING)",
          "1724:     goto bad;",
          "1725:    m->str_flags |= PSTRING_LENGTH_INCLUDES_ITSELF;",
          "1726:    break;",
          "1727:   default:",
          "1728:   bad:",
          "1729:    if (ms->flags & MAGIC_CHECK)",
          "1730:     file_magwarn(ms, \"string modifier `%c' \"",
          "1731:      \"invalid\", *l);",
          "1732:    goto out;",
          "1733:   }",
          "1735:   if (l[1] == '/' && !isspace((unsigned char)l[2]))",
          "1736:    l++;",
          "1737:  }",
          "1738:  if (string_modifier_check(ms, m) == -1)",
          "1739:   goto out;",
          "1741:  return 0;",
          "1742: out:",
          "1744:  return -1;",
          "1745: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1874:  m->str_range = 0;",
          "1875:  m->str_flags = m->type == FILE_PSTRING ? PSTRING_1_LE : 0;",
          "1876:  if ((op = get_op(*l)) != -1) {",
          "1979:    }",
          "1981:     return -1;",
          "1988:  }",
          "",
          "[Removed Lines]",
          "1877:   if (!IS_STRING(m->type)) {",
          "1878:    uint64_t val;",
          "1879:    ++l;",
          "1880:    m->mask_op |= op;",
          "1881:    val = (uint64_t)strtoull(l, &t, 0);",
          "1882:    l = t;",
          "1883:    m->num_mask = file_signextend(ms, m, val);",
          "1884:    eatsize(&l);",
          "1885:   }",
          "1886:   else if (op == FILE_OPDIVIDE) {",
          "1887:    int have_range = 0;",
          "1888:    while (!isspace((unsigned char)*++l)) {",
          "1889:     switch (*l) {",
          "1890:     case '0':  case '1':  case '2':",
          "1891:     case '3':  case '4':  case '5':",
          "1892:     case '6':  case '7':  case '8':",
          "1893:     case '9':",
          "1894:      if (have_range &&",
          "1895:          (ms->flags & MAGIC_CHECK))",
          "1896:       file_magwarn(ms,",
          "1897:           \"multiple ranges\");",
          "1898:      have_range = 1;",
          "1899:      m->str_range = CAST(uint32_t,",
          "1900:          strtoul(l, &t, 0));",
          "1901:      if (m->str_range == 0)",
          "1902:       file_magwarn(ms,",
          "1903:           \"zero range\");",
          "1904:      l = t - 1;",
          "1905:      break;",
          "1906:     case CHAR_COMPACT_WHITESPACE:",
          "1907:      m->str_flags |=",
          "1908:          STRING_COMPACT_WHITESPACE;",
          "1909:      break;",
          "1910:     case CHAR_COMPACT_OPTIONAL_WHITESPACE:",
          "1911:      m->str_flags |=",
          "1912:          STRING_COMPACT_OPTIONAL_WHITESPACE;",
          "1913:      break;",
          "1914:     case CHAR_IGNORE_LOWERCASE:",
          "1915:      m->str_flags |= STRING_IGNORE_LOWERCASE;",
          "1916:      break;",
          "1917:     case CHAR_IGNORE_UPPERCASE:",
          "1918:      m->str_flags |= STRING_IGNORE_UPPERCASE;",
          "1919:      break;",
          "1920:     case CHAR_REGEX_OFFSET_START:",
          "1921:      m->str_flags |= REGEX_OFFSET_START;",
          "1922:      break;",
          "1923:     case CHAR_BINTEST:",
          "1924:      m->str_flags |= STRING_BINTEST;",
          "1925:      break;",
          "1926:     case CHAR_TEXTTEST:",
          "1927:      m->str_flags |= STRING_TEXTTEST;",
          "1928:      break;",
          "1929:     case CHAR_TRIM:",
          "1930:      m->str_flags |= STRING_TRIM;",
          "1931:      break;",
          "1932:     case CHAR_PSTRING_1_LE:",
          "1933:      if (m->type != FILE_PSTRING)",
          "1934:       goto bad;",
          "1935:      m->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_1_LE;",
          "1936:      break;",
          "1937:     case CHAR_PSTRING_2_BE:",
          "1938:      if (m->type != FILE_PSTRING)",
          "1939:       goto bad;",
          "1940:      m->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_2_BE;",
          "1941:      break;",
          "1942:     case CHAR_PSTRING_2_LE:",
          "1943:      if (m->type != FILE_PSTRING)",
          "1944:       goto bad;",
          "1945:      m->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_2_LE;",
          "1946:      break;",
          "1947:     case CHAR_PSTRING_4_BE:",
          "1948:      if (m->type != FILE_PSTRING)",
          "1949:       goto bad;",
          "1950:      m->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_4_BE;",
          "1951:      break;",
          "1952:     case CHAR_PSTRING_4_LE:",
          "1953:      switch (m->type) {",
          "1954:      case FILE_PSTRING:",
          "1955:      case FILE_REGEX:",
          "1956:       break;",
          "1957:      default:",
          "1958:       goto bad;",
          "1959:      }",
          "1960:      m->str_flags = (m->str_flags & ~PSTRING_LEN) | PSTRING_4_LE;",
          "1961:      break;",
          "1962:     case CHAR_PSTRING_LENGTH_INCLUDES_ITSELF:",
          "1963:      if (m->type != FILE_PSTRING)",
          "1964:       goto bad;",
          "1965:      m->str_flags |= PSTRING_LENGTH_INCLUDES_ITSELF;",
          "1966:      break;",
          "1967:     default:",
          "1968:     bad:",
          "1969:      if (ms->flags & MAGIC_CHECK)",
          "1970:       file_magwarn(ms,",
          "1971:           \"string extension `%c' \"",
          "1972:           \"invalid\", *l);",
          "1973:      return -1;",
          "1974:     }",
          "1976:     if (l[1] == '/' &&",
          "1977:         !isspace((unsigned char)l[2]))",
          "1978:      l++;",
          "1980:    if (string_modifier_check(ms, m) == -1)",
          "1982:   }",
          "1983:   else {",
          "1984:    if (ms->flags & MAGIC_CHECK)",
          "1985:     file_magwarn(ms, \"invalid string op: %c\", *t);",
          "1986:    return -1;",
          "1987:   }",
          "",
          "[Added Lines]",
          "2016:   if (IS_STRING(m->type)) {",
          "2017:    int r;",
          "2019:    if (op != FILE_OPDIVIDE) {",
          "2020:     if (ms->flags & MAGIC_CHECK)",
          "2021:      file_magwarn(ms,",
          "2022:          \"invalid string/indirect op: \"",
          "2023:          \"`%c'\", *t);",
          "2024:     return -1;",
          "2027:    if (m->type == FILE_INDIRECT)",
          "2028:     r = parse_indirect_modifier(ms, m, &l);",
          "2029:    else",
          "2030:     r = parse_string_modifier(ms, m, &l);",
          "2031:    if (r == -1)",
          "2033:   } else",
          "2034:    parse_op_modifier(ms, m, &l, op);",
          "",
          "---------------"
        ],
        "src/file.h||src/file.h": [
          "File: src/file.h -> src/file.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:   (t) == FILE_LESTRING16 || \\",
          "235:   (t) == FILE_REGEX || \\",
          "236:   (t) == FILE_SEARCH || \\",
          "237:   (t) == FILE_NAME || \\",
          "238:   (t) == FILE_USE)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "237:   (t) == FILE_INDIRECT || \\",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "346: #define STRING_IGNORE_CASE  (STRING_IGNORE_LOWERCASE|STRING_IGNORE_UPPERCASE)",
          "347: #define STRING_DEFAULT_RANGE  100",
          "351: struct mlist {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "350: #define INDIRECT_RELATIVE   BIT(0)",
          "351: #define CHAR_INDIRECT_RELATIVE   'r'",
          "",
          "---------------"
        ],
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.204 2014/12/11 12:34:24 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.205 2015/01/01 04:12:23 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1665:   break;",
          "1667:  case FILE_INDIRECT:",
          "1669:   if (offset == 0)",
          "1670:    return 0;",
          "",
          "[Removed Lines]",
          "1668:   offset += o;",
          "",
          "[Added Lines]",
          "1668:   if (m->str_flags & INDIRECT_RELATIVE)",
          "1669:    offset += o;",
          "",
          "---------------"
        ]
      }
    }
  ]
}