{
  "cve_id": "CVE-2021-29607",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Incomplete validation in `SparseAdd` results in allowing attackers to exploit undefined behavior (dereferencing null pointers) as well as write outside of bounds of heap allocated data. The implementation(https://github.com/tensorflow/tensorflow/blob/656e7673b14acd7835dc778867f84916c6d1cac2/tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc) has a large set of validation for the two sparse tensor inputs (6 tensors in total), but does not validate that the tensors are not empty or that the second dimension of `*_indices` matches the size of corresponding `*_shape`. This allows attackers to send tensor triples that represent invalid sparse tensors to abuse code assumptions that are not protected by validation. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "f6fde895ef9c77d848061c0517f19d0ec2682f3a",
  "patch_info": {
    "commit_hash": "f6fde895ef9c77d848061c0517f19d0ec2682f3a",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/f6fde895ef9c77d848061c0517f19d0ec2682f3a",
    "files": [
      "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
    ],
    "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
      "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "166:                     \"Input shapes should be a vector but received shapes \",",
      "167:                     a_shape_t->shape().DebugString(), \" and \",",
      "168:                     b_shape_t->shape().DebugString()));",
      "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
      "170:                 errors::InvalidArgument(",
      "171:                     \"Operands do not have the same ranks; got shapes: \",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "170:     const int num_dims = a_indices_t->dim_size(1);",
      "171:     OP_REQUIRES(",
      "172:         ctx, a_shape_t->NumElements() == num_dims,",
      "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
      "174:                                 \"a_shape must match, got \",",
      "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
      "176:     OP_REQUIRES(ctx, num_dims > 0,",
      "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "180:                                           \" for dimension \", i));",
      "181:     }",
      "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
      "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
      "191:     std::vector<T> a_augmented_values, b_augmented_values;",
      "",
      "[Removed Lines]",
      "183:     OP_REQUIRES(",
      "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
      "185:         errors::InvalidArgument(",
      "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
      "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
      "188:     const int num_dims = a_indices_t->dim_size(1);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6b2bf99cd9336026689579b683a709c5efcb4ae9",
      "candidate_info": {
        "commit_hash": "6b2bf99cd9336026689579b683a709c5efcb4ae9",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6b2bf99cd9336026689579b683a709c5efcb4ae9",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:                     \"Input shapes should be a vector but received shapes \",",
          "167:                     a_shape_t->shape().DebugString(), \" and \",",
          "168:                     b_shape_t->shape().DebugString()));",
          "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
          "170:                 errors::InvalidArgument(",
          "171:                     \"Operands do not have the same ranks; got shapes: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "170:     const int num_dims = a_indices_t->dim_size(1);",
          "171:     OP_REQUIRES(",
          "172:         ctx, a_shape_t->NumElements() == num_dims,",
          "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
          "174:                                 \"a_shape must match, got \",",
          "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
          "176:     OP_REQUIRES(ctx, num_dims > 0,",
          "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "191:     std::vector<T> a_augmented_values, b_augmented_values;",
          "",
          "[Removed Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "188:     const int num_dims = a_indices_t->dim_size(1);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0f1b2415056851f7782a13d7c140cf44f58a4fe8",
      "candidate_info": {
        "commit_hash": "0f1b2415056851f7782a13d7c140cf44f58a4fe8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0f1b2415056851f7782a13d7c140cf44f58a4fe8",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:                     \"Input shapes should be a vector but received shapes \",",
          "167:                     a_shape_t->shape().DebugString(), \" and \",",
          "168:                     b_shape_t->shape().DebugString()));",
          "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
          "170:                 errors::InvalidArgument(",
          "171:                     \"Operands do not have the same ranks; got shapes: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "170:     const int num_dims = a_indices_t->dim_size(1);",
          "171:     OP_REQUIRES(",
          "172:         ctx, a_shape_t->NumElements() == num_dims,",
          "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
          "174:                                 \"a_shape must match, got \",",
          "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
          "176:     OP_REQUIRES(ctx, num_dims > 0,",
          "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "191:     std::vector<T> a_augmented_values, b_augmented_values;",
          "",
          "[Removed Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "188:     const int num_dims = a_indices_t->dim_size(1);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "91eb42dc6dcd04c806a680c1db754e6a54048c2e",
      "candidate_info": {
        "commit_hash": "91eb42dc6dcd04c806a680c1db754e6a54048c2e",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/91eb42dc6dcd04c806a680c1db754e6a54048c2e",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:                     \"Input shapes should be a vector but received shapes \",",
          "167:                     a_shape_t->shape().DebugString(), \" and \",",
          "168:                     b_shape_t->shape().DebugString()));",
          "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
          "170:                 errors::InvalidArgument(",
          "171:                     \"Operands do not have the same ranks; got shapes: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "170:     const int num_dims = a_indices_t->dim_size(1);",
          "171:     OP_REQUIRES(",
          "172:         ctx, a_shape_t->NumElements() == num_dims,",
          "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
          "174:                                 \"a_shape must match, got \",",
          "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
          "176:     OP_REQUIRES(ctx, num_dims > 0,",
          "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "191:     std::vector<T> a_augmented_values, b_augmented_values;",
          "",
          "[Removed Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "188:     const int num_dims = a_indices_t->dim_size(1);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a1ab0abc98ab16978d9ccb1e1d144a1d7bcfd196",
      "candidate_info": {
        "commit_hash": "a1ab0abc98ab16978d9ccb1e1d144a1d7bcfd196",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a1ab0abc98ab16978d9ccb1e1d144a1d7bcfd196",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:                     \"Input shapes should be a vector but received shapes \",",
          "167:                     a_shape_t->shape().DebugString(), \" and \",",
          "168:                     b_shape_t->shape().DebugString()));",
          "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
          "170:                 errors::InvalidArgument(",
          "171:                     \"Operands do not have the same ranks; got shapes: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "170:     const int num_dims = a_indices_t->dim_size(1);",
          "171:     OP_REQUIRES(",
          "172:         ctx, a_shape_t->NumElements() == num_dims,",
          "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
          "174:                                 \"a_shape must match, got \",",
          "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
          "176:     OP_REQUIRES(ctx, num_dims > 0,",
          "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "191:     std::vector<T> a_augmented_values, b_augmented_values;",
          "",
          "[Removed Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "188:     const int num_dims = a_indices_t->dim_size(1);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0edd559a021aec0c037b508f904489cf731c7700",
      "candidate_info": {
        "commit_hash": "0edd559a021aec0c037b508f904489cf731c7700",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/0edd559a021aec0c037b508f904489cf731c7700",
        "files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ],
        "message": "Validate that a and b are proper sparse tensors\n\nPiperOrigin-RevId: 373274848\nChange-Id: I3a665ac3a29dee9fb69bdf408a939330cb93ea75",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc||tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc -> tensorflow/core/kernels/sparse_sparse_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "166:                     \"Input shapes should be a vector but received shapes \",",
          "167:                     a_shape_t->shape().DebugString(), \" and \",",
          "168:                     b_shape_t->shape().DebugString()));",
          "169:     OP_REQUIRES(ctx, a_shape_t->IsSameSize(*b_shape_t),",
          "170:                 errors::InvalidArgument(",
          "171:                     \"Operands do not have the same ranks; got shapes: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "170:     const int num_dims = a_indices_t->dim_size(1);",
          "171:     OP_REQUIRES(",
          "172:         ctx, a_shape_t->NumElements() == num_dims,",
          "173:         errors::InvalidArgument(\"Second dimension of a_indices and length of \"",
          "174:                                 \"a_shape must match, got \",",
          "175:                                 num_dims, \" and \", a_shape_t->NumElements()));",
          "176:     OP_REQUIRES(ctx, num_dims > 0,",
          "177:                 errors::InvalidArgument(\"Tensors must not be empty\"));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "180:                                           \" for dimension \", i));",
          "181:     }",
          "189:     const auto a_indices_mat = a_indices_t->matrix<int64>();",
          "190:     const auto b_indices_mat = b_indices_t->matrix<int64>();",
          "191:     std::vector<T> a_augmented_values, b_augmented_values;",
          "",
          "[Removed Lines]",
          "183:     OP_REQUIRES(",
          "184:         ctx, a_indices_t->dim_size(1) == b_indices_t->dim_size(1),",
          "185:         errors::InvalidArgument(",
          "186:             \"Indices' dimensions do not match: got \", a_indices_t->dim_size(1),",
          "187:             \" and \", b_indices_t->dim_size(1), \" for the second dimension.\"));",
          "188:     const int num_dims = a_indices_t->dim_size(1);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}