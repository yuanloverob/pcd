{
  "cve_id": "CVE-2022-29224",
  "cve_desc": "Envoy is a cloud-native high-performance proxy. Versions of envoy prior to 1.22.1 are subject to a segmentation fault in the GrpcHealthCheckerImpl. Envoy can perform various types of upstream health checking. One of them uses gRPC. Envoy also has a feature which can \u201chold\u201d (prevent removal) upstream hosts obtained via service discovery until configured active health checking fails. If an attacker controls an upstream host and also controls service discovery of that host (via DNS, the EDS API, etc.), an attacker can crash Envoy by forcing removal of the host from service discovery, and then failing the gRPC health check request. This will crash Envoy via a null pointer dereference. Users are advised to upgrade to resolve this vulnerability. Users unable to upgrade may disable gRPC health checking and/or replace it with a different health checking type as a mitigation.",
  "repo": "envoyproxy/envoy",
  "patch_hash": "9b1c3962172a972bc0359398af6daa3790bb59db",
  "patch_info": {
    "commit_hash": "9b1c3962172a972bc0359398af6daa3790bb59db",
    "repo": "envoyproxy/envoy",
    "commit_url": "https://github.com/envoyproxy/envoy/commit/9b1c3962172a972bc0359398af6daa3790bb59db",
    "files": [
      "source/common/upstream/health_checker_impl.cc",
      "test/common/upstream/health_checker_impl_test.cc"
    ],
    "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>\nSigned-off-by: Pradeep Rao <pcrao@google.com>",
    "before_after_code_files": [
      "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
      "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
    ]
  },
  "patch_diff": {
    "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
      "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "816:   if (request_encoder_) {",
      "817:     handleFailure(envoy::data::core::v3::NETWORK);",
      "820:   }",
      "822: }",
      "824: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
      "",
      "[Removed Lines]",
      "818:     expect_reset_ = true;",
      "819:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
      "821:   client_->close();",
      "",
      "[Added Lines]",
      "820:     if (request_encoder_ != nullptr) {",
      "821:       expect_reset_ = true;",
      "822:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
      "823:     }",
      "824:   }",
      "826:   if (client_ != nullptr) {",
      "827:     client_->close();",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "852:   if (end_stream) {",
      "853:     resetState();",
      "854:   } else {",
      "858:   }",
      "861:     client_->close();",
      "862:   }",
      "863: }",
      "",
      "[Removed Lines]",
      "856:     expect_reset_ = true;",
      "857:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
      "860:   if (!parent_.reuse_connection_ || goaway) {",
      "",
      "[Added Lines]",
      "864:     if (request_encoder_ != nullptr) {",
      "866:       expect_reset_ = true;",
      "867:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
      "868:     }",
      "872:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
      "",
      "---------------"
    ],
    "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
      "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "4737:   expectHostHealthy(true);",
      "4738: }",
      "4741: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
      "4742:   setupHC();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4742: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
      "4743:   setupHC();",
      "4744:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
      "4745:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
      "4747:   expectSessionCreate();",
      "4748:   expectHealthcheckStart(0);",
      "4749:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
      "4750:   health_checker_->start();",
      "4752:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
      "4753:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
      "4754:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
      "4755:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
      "4756:       }));",
      "4757:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
      "4758:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
      "4759:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
      "4760: }",
      "4763: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
      "4764:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
      "4765:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
      "4766:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
      "4768:   expectSessionCreate();",
      "4769:   expectHealthcheckStart(0);",
      "4770:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
      "4771:   health_checker_->start();",
      "4773:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
      "4774:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
      "4775:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
      "4776:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
      "4777:       }));",
      "4778:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
      "4779:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
      "4780: }",
      "4783: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
      "4784:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
      "4785:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
      "4786:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
      "4788:   expectSessionCreate();",
      "4789:   expectHealthcheckStart(0);",
      "4790:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
      "4791:   health_checker_->start();",
      "4793:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
      "4794:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
      "4795:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
      "4796:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
      "4797:       }));",
      "4798:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
      "4799:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
      "4800:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
      "4801:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
      "4802: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8cca7c54eba813ba6dfe8ee7a2b1db9e6222775a",
      "candidate_info": {
        "commit_hash": "8cca7c54eba813ba6dfe8ee7a2b1db9e6222775a",
        "repo": "envoyproxy/envoy",
        "commit_url": "https://github.com/envoyproxy/envoy/commit/8cca7c54eba813ba6dfe8ee7a2b1db9e6222775a",
        "files": [
          "source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc"
        ],
        "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>\nSigned-off-by: Pradeep Rao <pcrao@google.com>\n\nSigned-off-by: Ryan Northey <ryan@synca.io>",
        "before_after_code_files": [
          "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ],
          "candidate": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
          "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "816:   if (request_encoder_) {",
          "817:     handleFailure(envoy::data::core::v3::NETWORK);",
          "820:   }",
          "822: }",
          "824: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
          "",
          "[Removed Lines]",
          "818:     expect_reset_ = true;",
          "819:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "821:   client_->close();",
          "",
          "[Added Lines]",
          "820:     if (request_encoder_ != nullptr) {",
          "821:       expect_reset_ = true;",
          "822:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "823:     }",
          "824:   }",
          "826:   if (client_ != nullptr) {",
          "827:     client_->close();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "852:   if (end_stream) {",
          "853:     resetState();",
          "854:   } else {",
          "858:   }",
          "861:     client_->close();",
          "862:   }",
          "863: }",
          "",
          "[Removed Lines]",
          "856:     expect_reset_ = true;",
          "857:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "860:   if (!parent_.reuse_connection_ || goaway) {",
          "",
          "[Added Lines]",
          "864:     if (request_encoder_ != nullptr) {",
          "866:       expect_reset_ = true;",
          "867:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "868:     }",
          "872:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
          "",
          "---------------"
        ],
        "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
          "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "4737:   expectHostHealthy(true);",
          "4738: }",
          "4741: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
          "4742:   setupHC();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4742: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
          "4743:   setupHC();",
          "4744:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4745:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4747:   expectSessionCreate();",
          "4748:   expectHealthcheckStart(0);",
          "4749:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4750:   health_checker_->start();",
          "4752:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4753:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4754:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4755:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4756:       }));",
          "4757:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4758:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
          "4759:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
          "4760: }",
          "4763: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
          "4764:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4765:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4766:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4768:   expectSessionCreate();",
          "4769:   expectHealthcheckStart(0);",
          "4770:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4771:   health_checker_->start();",
          "4773:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4774:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4775:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4776:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4777:       }));",
          "4778:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4779:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
          "4780: }",
          "4783: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
          "4784:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4785:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4786:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4788:   expectSessionCreate();",
          "4789:   expectHealthcheckStart(0);",
          "4790:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4791:   health_checker_->start();",
          "4793:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4794:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4795:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4796:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4797:       }));",
          "4798:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4799:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
          "4800:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
          "4801:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
          "4802: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9b1c3962172a972bc0359398af6daa3790bb59db",
      "candidate_info": {
        "commit_hash": "9b1c3962172a972bc0359398af6daa3790bb59db",
        "repo": "envoyproxy/envoy",
        "commit_url": "https://github.com/envoyproxy/envoy/commit/9b1c3962172a972bc0359398af6daa3790bb59db",
        "files": [
          "source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc"
        ],
        "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>\nSigned-off-by: Pradeep Rao <pcrao@google.com>",
        "before_after_code_files": [
          "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ],
          "candidate": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
          "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "816:   if (request_encoder_) {",
          "817:     handleFailure(envoy::data::core::v3::NETWORK);",
          "820:   }",
          "822: }",
          "824: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
          "",
          "[Removed Lines]",
          "818:     expect_reset_ = true;",
          "819:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "821:   client_->close();",
          "",
          "[Added Lines]",
          "820:     if (request_encoder_ != nullptr) {",
          "821:       expect_reset_ = true;",
          "822:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "823:     }",
          "824:   }",
          "826:   if (client_ != nullptr) {",
          "827:     client_->close();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "852:   if (end_stream) {",
          "853:     resetState();",
          "854:   } else {",
          "858:   }",
          "861:     client_->close();",
          "862:   }",
          "863: }",
          "",
          "[Removed Lines]",
          "856:     expect_reset_ = true;",
          "857:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "860:   if (!parent_.reuse_connection_ || goaway) {",
          "",
          "[Added Lines]",
          "864:     if (request_encoder_ != nullptr) {",
          "866:       expect_reset_ = true;",
          "867:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "868:     }",
          "872:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
          "",
          "---------------"
        ],
        "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
          "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "4737:   expectHostHealthy(true);",
          "4738: }",
          "4741: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
          "4742:   setupHC();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4742: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
          "4743:   setupHC();",
          "4744:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4745:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4747:   expectSessionCreate();",
          "4748:   expectHealthcheckStart(0);",
          "4749:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4750:   health_checker_->start();",
          "4752:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4753:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4754:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4755:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4756:       }));",
          "4757:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4758:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
          "4759:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
          "4760: }",
          "4763: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
          "4764:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4765:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4766:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4768:   expectSessionCreate();",
          "4769:   expectHealthcheckStart(0);",
          "4770:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4771:   health_checker_->start();",
          "4773:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4774:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4775:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4776:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4777:       }));",
          "4778:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4779:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
          "4780: }",
          "4783: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
          "4784:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4785:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4786:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4788:   expectSessionCreate();",
          "4789:   expectHealthcheckStart(0);",
          "4790:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4791:   health_checker_->start();",
          "4793:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4794:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4795:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4796:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4797:       }));",
          "4798:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4799:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
          "4800:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
          "4801:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
          "4802: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "11114916a4f0bd7aba21bbeff45b415b65bccb13",
      "candidate_info": {
        "commit_hash": "11114916a4f0bd7aba21bbeff45b415b65bccb13",
        "repo": "envoyproxy/envoy",
        "commit_url": "https://github.com/envoyproxy/envoy/commit/11114916a4f0bd7aba21bbeff45b415b65bccb13",
        "files": [
          "source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc"
        ],
        "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>",
        "before_after_code_files": [
          "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ],
          "candidate": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
          "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "816:   if (request_encoder_) {",
          "817:     handleFailure(envoy::data::core::v3::NETWORK);",
          "820:   }",
          "822: }",
          "824: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
          "",
          "[Removed Lines]",
          "818:     expect_reset_ = true;",
          "819:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "821:   client_->close();",
          "",
          "[Added Lines]",
          "820:     if (request_encoder_ != nullptr) {",
          "821:       expect_reset_ = true;",
          "822:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "823:     }",
          "824:   }",
          "826:   if (client_ != nullptr) {",
          "827:     client_->close();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "852:   if (end_stream) {",
          "853:     resetState();",
          "854:   } else {",
          "858:   }",
          "861:     client_->close();",
          "862:   }",
          "863: }",
          "",
          "[Removed Lines]",
          "856:     expect_reset_ = true;",
          "857:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "860:   if (!parent_.reuse_connection_ || goaway) {",
          "",
          "[Added Lines]",
          "864:     if (request_encoder_ != nullptr) {",
          "866:       expect_reset_ = true;",
          "867:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "868:     }",
          "872:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
          "",
          "---------------"
        ],
        "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
          "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "4737:   expectHostHealthy(true);",
          "4738: }",
          "4741: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
          "4742:   setupHC();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4742: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
          "4743:   setupHC();",
          "4744:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4745:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4747:   expectSessionCreate();",
          "4748:   expectHealthcheckStart(0);",
          "4749:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4750:   health_checker_->start();",
          "4752:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4753:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4754:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4755:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4756:       }));",
          "4757:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4758:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
          "4759:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
          "4760: }",
          "4763: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
          "4764:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4765:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4766:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4768:   expectSessionCreate();",
          "4769:   expectHealthcheckStart(0);",
          "4770:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4771:   health_checker_->start();",
          "4773:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4774:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4775:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4776:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4777:       }));",
          "4778:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4779:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
          "4780: }",
          "4783: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
          "4784:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4785:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4786:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4788:   expectSessionCreate();",
          "4789:   expectHealthcheckStart(0);",
          "4790:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4791:   health_checker_->start();",
          "4793:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4794:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4795:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4796:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4797:       }));",
          "4798:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4799:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
          "4800:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
          "4801:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
          "4802: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "74a5d24bf88f557a9415a20c3430fbc8b1f6bfbc",
      "candidate_info": {
        "commit_hash": "74a5d24bf88f557a9415a20c3430fbc8b1f6bfbc",
        "repo": "envoyproxy/envoy",
        "commit_url": "https://github.com/envoyproxy/envoy/commit/74a5d24bf88f557a9415a20c3430fbc8b1f6bfbc",
        "files": [
          "source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc"
        ],
        "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>\nSigned-off-by: Pradeep Rao <pcrao@google.com>\n\nSigned-off-by: Ryan Northey <ryan@synca.io>",
        "before_after_code_files": [
          "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ],
          "candidate": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
          "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "814:   if (request_encoder_) {",
          "815:     handleFailure(envoy::data::core::v3::NETWORK);",
          "818:   }",
          "820: }",
          "822: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
          "",
          "[Removed Lines]",
          "816:     expect_reset_ = true;",
          "817:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "819:   client_->close();",
          "",
          "[Added Lines]",
          "818:     if (request_encoder_ != nullptr) {",
          "819:       expect_reset_ = true;",
          "820:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "821:     }",
          "822:   }",
          "824:   if (client_ != nullptr) {",
          "825:     client_->close();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "850:   if (end_stream) {",
          "851:     resetState();",
          "852:   } else {",
          "856:   }",
          "859:     client_->close();",
          "860:   }",
          "861: }",
          "",
          "[Removed Lines]",
          "854:     expect_reset_ = true;",
          "855:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "858:   if (!parent_.reuse_connection_ || goaway) {",
          "",
          "[Added Lines]",
          "862:     if (request_encoder_ != nullptr) {",
          "864:       expect_reset_ = true;",
          "865:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "866:     }",
          "870:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
          "",
          "---------------"
        ],
        "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
          "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "4674:   expectHostHealthy(true);",
          "4675: }",
          "4678: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
          "4679:   setupHC();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4679: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
          "4680:   setupHC();",
          "4681:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4682:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4684:   expectSessionCreate();",
          "4685:   expectHealthcheckStart(0);",
          "4686:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4687:   health_checker_->start();",
          "4689:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4690:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4691:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4692:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4693:       }));",
          "4694:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4695:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
          "4696:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
          "4697: }",
          "4700: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
          "4701:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4702:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4703:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4705:   expectSessionCreate();",
          "4706:   expectHealthcheckStart(0);",
          "4707:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4708:   health_checker_->start();",
          "4710:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4711:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4712:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4713:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4714:       }));",
          "4715:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4716:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
          "4717: }",
          "4720: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
          "4721:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4722:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4723:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4725:   expectSessionCreate();",
          "4726:   expectHealthcheckStart(0);",
          "4727:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4728:   health_checker_->start();",
          "4730:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4731:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4732:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4733:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4734:       }));",
          "4735:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4736:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
          "4737:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
          "4738:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
          "4739: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "081608334fc9d67554e3c458c83ae87c8928af37",
      "candidate_info": {
        "commit_hash": "081608334fc9d67554e3c458c83ae87c8928af37",
        "repo": "envoyproxy/envoy",
        "commit_url": "https://github.com/envoyproxy/envoy/commit/081608334fc9d67554e3c458c83ae87c8928af37",
        "files": [
          "source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc"
        ],
        "message": "healthcheck: fix grpc inline removal crashes (#749)\n\nSigned-off-by: Matt Klein <mklein@lyft.com>\nSigned-off-by: Pradeep Rao <pcrao@google.com>",
        "before_after_code_files": [
          "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
          "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ],
          "candidate": [
            "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc",
            "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "source/common/upstream/health_checker_impl.cc||source/common/upstream/health_checker_impl.cc": [
          "File: source/common/upstream/health_checker_impl.cc -> source/common/upstream/health_checker_impl.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "814:   if (request_encoder_) {",
          "815:     handleFailure(envoy::data::core::v3::NETWORK);",
          "818:   }",
          "820: }",
          "822: bool GrpcHealthCheckerImpl::GrpcActiveHealthCheckSession::isHealthCheckSucceeded(",
          "",
          "[Removed Lines]",
          "816:     expect_reset_ = true;",
          "817:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "819:   client_->close();",
          "",
          "[Added Lines]",
          "818:     if (request_encoder_ != nullptr) {",
          "819:       expect_reset_ = true;",
          "820:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "821:     }",
          "822:   }",
          "824:   if (client_ != nullptr) {",
          "825:     client_->close();",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "850:   if (end_stream) {",
          "851:     resetState();",
          "852:   } else {",
          "856:   }",
          "859:     client_->close();",
          "860:   }",
          "861: }",
          "",
          "[Removed Lines]",
          "854:     expect_reset_ = true;",
          "855:     request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "858:   if (!parent_.reuse_connection_ || goaway) {",
          "",
          "[Added Lines]",
          "862:     if (request_encoder_ != nullptr) {",
          "864:       expect_reset_ = true;",
          "865:       request_encoder_->getStream().resetStream(Http::StreamResetReason::LocalReset);",
          "866:     }",
          "870:   if (client_ != nullptr && (!parent_.reuse_connection_ || goaway)) {",
          "",
          "---------------"
        ],
        "test/common/upstream/health_checker_impl_test.cc||test/common/upstream/health_checker_impl_test.cc": [
          "File: test/common/upstream/health_checker_impl_test.cc -> test/common/upstream/health_checker_impl_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "4674:   expectHostHealthy(true);",
          "4675: }",
          "4678: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFail) {",
          "4679:   setupHC();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4679: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaRpcRemoveHostInCallback) {",
          "4680:   setupHC();",
          "4681:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4682:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4684:   expectSessionCreate();",
          "4685:   expectHealthcheckStart(0);",
          "4686:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4687:   health_checker_->start();",
          "4689:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4690:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4691:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4692:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4693:       }));",
          "4694:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4695:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::NoError);",
          "4696:   respondServiceStatus(0, grpc::health::v1::HealthCheckResponse::NOT_SERVING);",
          "4697: }",
          "4700: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaGoawayRemoveHostInCallback) {",
          "4701:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4702:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4703:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4705:   expectSessionCreate();",
          "4706:   expectHealthcheckStart(0);",
          "4707:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4708:   health_checker_->start();",
          "4710:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4711:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4712:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4713:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4714:       }));",
          "4715:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4716:   test_sessions_[0]->codec_client_->raiseGoAway(Http::GoAwayErrorCode::Other);",
          "4717: }",
          "4720: TEST_F(GrpcHealthCheckerImplTest, GrpcHealthFailViaBadResponseRemoveHostInCallback) {",
          "4721:   setupHCWithUnhealthyThreshold(/*threshold=*/1);",
          "4722:   cluster_->prioritySet().getMockHostSet(0)->hosts_ = {",
          "4723:       makeTestHost(cluster_->info_, \"tcp://127.0.0.1:80\", simTime())};",
          "4725:   expectSessionCreate();",
          "4726:   expectHealthcheckStart(0);",
          "4727:   EXPECT_CALL(event_logger_, logUnhealthy(_, _, _, true));",
          "4728:   health_checker_->start();",
          "4730:   EXPECT_CALL(*this, onHostStatus(_, HealthTransition::Changed))",
          "4731:       .WillOnce(Invoke([&](HostSharedPtr host, HealthTransition) {",
          "4732:         cluster_->prioritySet().getMockHostSet(0)->hosts_ = {};",
          "4733:         cluster_->prioritySet().runUpdateCallbacks(0, {}, {host});",
          "4734:       }));",
          "4735:   EXPECT_CALL(event_logger_, logEjectUnhealthy(_, _, _));",
          "4736:   std::unique_ptr<Http::TestResponseHeaderMapImpl> response_headers(",
          "4737:       new Http::TestResponseHeaderMapImpl{{\":status\", \"500\"}});",
          "4738:   test_sessions_[0]->stream_response_callbacks_->decodeHeaders(std::move(response_headers), false);",
          "4739: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}