{
  "cve_id": "CVE-2019-17541",
  "cve_desc": "ImageMagick before 7.0.8-55 has a use-after-free in DestroyStringInfo in MagickCore/string.c because the error manager is mishandled in coders/jpeg.c.",
  "repo": "ImageMagick/ImageMagick",
  "patch_hash": "39f226a9c137f547e12afde972eeba7551124493",
  "patch_info": {
    "commit_hash": "39f226a9c137f547e12afde972eeba7551124493",
    "repo": "ImageMagick/ImageMagick",
    "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/39f226a9c137f547e12afde972eeba7551124493",
    "files": [
      "ChangeLog",
      "coders/jpeg.c"
    ],
    "message": "https://github.com/ImageMagick/ImageMagick/issues/1641",
    "before_after_code_files": [
      "coders/jpeg.c||coders/jpeg.c"
    ]
  },
  "patch_diff": {
    "coders/jpeg.c||coders/jpeg.c": [
      "File: coders/jpeg.c -> coders/jpeg.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "564:   {",
      "565:     int",
      "566:       c;",
      "568:     c=GetCharacter(jpeg_info);",
      "569:     if (c == EOF)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "572:   }",
      "573:   if (i != (ssize_t) length)",
      "574:     {",
      "576:       (void) ThrowMagickException(exception,GetMagickModule(),",
      "577:         CorruptImageError,\"InsufficientImageDataInFile\",\"`%s'\",",
      "578:         image->filename);",
      "",
      "[Removed Lines]",
      "575:       profile=DestroyStringInfo(profile);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "698:   error_manager->profile=NULL;",
      "699:   if (i != (ssize_t) length)",
      "700:     {",
      "701:       profile=DestroyStringInfo(profile);",
      "702:       (void) ThrowMagickException(exception,GetMagickModule(),",
      "703:         CorruptImageError,\"InsufficientImageDataInFile\",\"`%s'\",",
      "704:         image->filename);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "702:       (void) ThrowMagickException(exception,GetMagickModule(),",
      "703:         CorruptImageError,\"InsufficientImageDataInFile\",\"`%s'\",",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "912eb73afb7aef98723e1ee0ace0c9f78898878c",
      "candidate_info": {
        "commit_hash": "912eb73afb7aef98723e1ee0ace0c9f78898878c",
        "repo": "ImageMagick/ImageMagick",
        "commit_url": "https://github.com/ImageMagick/ImageMagick/commit/912eb73afb7aef98723e1ee0ace0c9f78898878c",
        "files": [
          "coders/jpeg.c"
        ],
        "message": "Added missing EOF checks.",
        "before_after_code_files": [
          "coders/jpeg.c||coders/jpeg.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "coders/jpeg.c||coders/jpeg.c"
          ],
          "candidate": [
            "coders/jpeg.c||coders/jpeg.c"
          ]
        }
      },
      "candidate_diff": {
        "coders/jpeg.c||coders/jpeg.c": [
          "File: coders/jpeg.c -> coders/jpeg.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "277:     }",
          "278:   source->manager.next_input_byte=source->buffer;",
          "279:   source->start_of_blob=FALSE;",
          "281: }",
          "283: static int GetCharacter(j_decompress_ptr jpeg_info)",
          "",
          "[Removed Lines]",
          "280:   return(TRUE);",
          "",
          "[Added Lines]",
          "280:   return(TRUE);",
          "281: }",
          "283: static int GetCharacter(j_decompress_ptr jpeg_info)",
          "284: {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "455:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "456:         ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",image->filename);",
          "457:       return(FALSE);",
          "460:     Read comment.",
          "",
          "[Removed Lines]",
          "458:     }",
          "",
          "[Added Lines]",
          "462:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "467:       c;",
          "469:     c=GetCharacter(jpeg_info);",
          "470:     if (c == EOF)",
          "471:       break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "474:     if (c == EOF)",
          "475:       break;",
          "477:   }",
          "479:   error_manager->profile=NULL;",
          "480:   if (i != (ssize_t) length)",
          "481:     {",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "543:   profile=BlobToStringInfo((const void *) NULL,length);",
          "544:   if (profile == (StringInfo *) NULL)",
          "545:     {",
          "547:         ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",image->filename);",
          "548:       return(FALSE);",
          "549:     }",
          "",
          "[Removed Lines]",
          "546:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "[Added Lines]",
          "558:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "553:   {",
          "554:     int",
          "555:       c;",
          "557:     c=GetCharacter(jpeg_info);",
          "558:     if (c == EOF)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "569:     c=GetCharacter(jpeg_info);",
          "570:     if (c == EOF)",
          "571:       break;",
          "573:   }",
          "574:   if (i != (ssize_t) length)",
          "575:     {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "660:   profile=BlobToStringInfo((const void *) NULL,length);",
          "661:   if (profile == (StringInfo *) NULL)",
          "662:     {",
          "664:         ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",image->filename);",
          "665:       return(FALSE);",
          "666:     }",
          "",
          "[Removed Lines]",
          "663:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "[Added Lines]",
          "683:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "671:     int",
          "672:       c;",
          "674:     c=GetCharacter(jpeg_info);",
          "675:     if (c == EOF)",
          "676:       break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "694:     c=GetCharacter(jpeg_info);",
          "695:     if (c == EOF)",
          "696:       break;",
          "698:   }",
          "699:   error_manager->profile=NULL;",
          "700:   if (i != (ssize_t) length)",
          "701:     {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "752:   profile=BlobToStringInfo((const void *) NULL,length);",
          "753:   if (profile == (StringInfo *) NULL)",
          "754:     {",
          "756:         ResourceLimitError,\"MemoryAllocationFailed\",\"`%s'\",image->filename);",
          "757:       return(FALSE);",
          "758:     }",
          "",
          "[Removed Lines]",
          "755:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "[Added Lines]",
          "783:       (void) ThrowMagickException(exception,GetMagickModule(),",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "763:     int",
          "764:       c;",
          "766:     c=GetCharacter(jpeg_info);",
          "767:     if (c == EOF)",
          "768:       break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "794:     c=GetCharacter(jpeg_info);",
          "795:     if (c == EOF)",
          "796:       break;",
          "798:   }",
          "799:   error_manager->profile=NULL;",
          "800:   if (i != (ssize_t) length)",
          "801:     {",
          "",
          "---------------"
        ]
      }
    }
  ]
}