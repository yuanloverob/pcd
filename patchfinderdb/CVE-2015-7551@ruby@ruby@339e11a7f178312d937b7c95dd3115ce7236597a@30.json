{
  "cve_id": "CVE-2015-7551",
  "cve_desc": "The Fiddle::Handle implementation in ext/fiddle/handle.c in Ruby before 2.0.0-p648, 2.1 before 2.1.8, and 2.2 before 2.2.4, as distributed in Apple OS X before 10.11.4 and other products, mishandles tainting, which allows context-dependent attackers to execute arbitrary code or cause a denial of service (application crash) via a crafted string, related to the DL module and the libffi library.  NOTE: this vulnerability exists because of a CVE-2009-5147 regression.",
  "repo": "ruby/ruby",
  "patch_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
  "patch_info": {
    "commit_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
    "repo": "ruby/ruby",
    "commit_url": "https://github.com/ruby/ruby/commit/339e11a7f178312d937b7c95dd3115ce7236597a",
    "files": [
      "ChangeLog",
      "ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb",
      "version.h"
    ],
    "message": "merge revision(s): 53153 and 23405@ruby_1_9_1\n\n\t* ext/fiddle/handle.c: check tainted string arguments.\n\t  Patch provided by tenderlove and nobu.\n\n\t* test/fiddle/test_handle.rb (class TestHandle): add test for above.\n\n\t* ext/dl/handle.c (rb_dlhandle_initialize): prohibits DL::dlopen\n\t  with a tainted name of library.\n\t  Patch by sheepman <sheepman AT sheepman.sakura.ne.jp>.\n\n\t* ext/dl/handle.c (rb_dlhandle_sym): ditto\n\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53156 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
    "before_after_code_files": [
      "ext/fiddle/handle.c||ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb",
      "version.h||version.h"
    ]
  },
  "patch_diff": {
    "ext/fiddle/handle.c||ext/fiddle/handle.c": [
      "File: ext/fiddle/handle.c -> ext/fiddle/handle.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #include <ruby.h>",
      "2: #include <fiddle.h>",
      "4: VALUE rb_cHandle;",
      "6: struct dl_handle {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: #define SafeStringValueCStr(v) (rb_check_safe_obj(rb_string_value(&v)), StringValueCStr(v))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "144:  break;",
      "145:       case 1:",
      "147:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "148:  break;",
      "149:       case 2:",
      "151:  cflag = NUM2INT(flag);",
      "152:  break;",
      "153:       default:",
      "",
      "[Removed Lines]",
      "146:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "150:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "",
      "[Added Lines]",
      "148:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "152:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "263:     return PTR2NUM(fiddle_handle);",
      "264: }",
      "",
      "[Removed Lines]",
      "266: static VALUE fiddle_handle_sym(void *handle, const char *symbol);",
      "",
      "[Added Lines]",
      "268: static VALUE fiddle_handle_sym(void *handle, VALUE symbol);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "282:  rb_raise(rb_eFiddleError, \"closed handle\");",
      "283:     }",
      "286: }",
      "288: #ifndef RTLD_NEXT",
      "",
      "[Removed Lines]",
      "285:     return fiddle_handle_sym(fiddle_handle->ptr, StringValueCStr(sym));",
      "",
      "[Added Lines]",
      "287:     return fiddle_handle_sym(fiddle_handle->ptr, sym);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "305: static VALUE",
      "306: rb_fiddle_handle_s_sym(VALUE self, VALUE sym)",
      "307: {",
      "309: }",
      "311: static VALUE",
      "313: {",
      "314: #if defined(HAVE_DLERROR)",
      "315:     const char *err;",
      "",
      "[Removed Lines]",
      "308:     return fiddle_handle_sym(RTLD_NEXT, StringValueCStr(sym));",
      "312: fiddle_handle_sym(void *handle, const char *name)",
      "",
      "[Added Lines]",
      "310:     return fiddle_handle_sym(RTLD_NEXT, sym);",
      "314: fiddle_handle_sym(void *handle, VALUE symbol)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "318: # define CHECK_DLERROR",
      "319: #endif",
      "320:     void (*func)();",
      "322:     rb_secure(2);",
      "323: #ifdef HAVE_DLERROR",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "323:     const char *name = SafeStringValueCStr(symbol);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "367:     }",
      "368: #endif",
      "369:     if( !func ){",
      "371:     }",
      "373:     return PTR2NUM(func);",
      "",
      "[Removed Lines]",
      "370:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%s\\\"\", name);",
      "",
      "[Added Lines]",
      "373:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%\"PRIsVALUE\"\\\"\", symbol);",
      "",
      "---------------"
    ],
    "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb": [
      "File: test/fiddle/test_handle.rb -> test/fiddle/test_handle.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:     include Test::Unit::Assertions",
      "13:     def test_to_i",
      "14:       handle = Fiddle::Handle.new(LIBC_SO)",
      "15:       assert_kind_of Integer, handle.to_i",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     def test_safe_handle_open",
      "14:       t = Thread.new do",
      "15:         $SAFE = 1",
      "16:         Fiddle::Handle.new(LIBC_SO.taint)",
      "17:       end",
      "18:       assert_raise(SecurityError) { t.value }",
      "19:     end",
      "21:     def test_safe_function_lookup",
      "22:       t = Thread.new do",
      "23:         h = Fiddle::Handle.new(LIBC_SO)",
      "24:         $SAFE = 1",
      "25:         h[\"qsort\".taint]",
      "26:       end",
      "27:       assert_raise(SecurityError) { t.value }",
      "28:     end",
      "",
      "---------------"
    ],
    "version.h||version.h": [
      "File: version.h -> version.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #define RUBY_VERSION \"2.1.8\"",
      "2: #define RUBY_RELEASE_DATE \"2015-12-16\"",
      "5: #define RUBY_RELEASE_YEAR 2015",
      "6: #define RUBY_RELEASE_MONTH 12",
      "",
      "[Removed Lines]",
      "3: #define RUBY_PATCHLEVEL 438",
      "",
      "[Added Lines]",
      "3: #define RUBY_PATCHLEVEL 439",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4bf78945ffe3fe696605a82ffcdcd69a4250667e",
      "candidate_info": {
        "commit_hash": "4bf78945ffe3fe696605a82ffcdcd69a4250667e",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/4bf78945ffe3fe696605a82ffcdcd69a4250667e",
        "files": [
          "ChangeLog",
          "test/ruby/test_transcode.rb",
          "transcode.c",
          "version.h"
        ],
        "message": "merge revision(s) 51116: [Backport #11324]\n\n\t* transcode.c (rb_econv_set_replacement): target encoding name can\n\t  be empty now.  [ruby-core:69841] [Bug #11324]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51614 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "test/ruby/test_transcode.rb||test/ruby/test_transcode.rb",
          "transcode.c||transcode.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "test/ruby/test_transcode.rb||test/ruby/test_transcode.rb": [
          "File: test/ruby/test_transcode.rb -> test/ruby/test_transcode.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "2109:       assert_equal([expected]*num, result, bug11277)",
          "2110:     end;",
          "2111:   end",
          "2112: end",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2113:   def test_universal_newline",
          "2114:     bug11324 = '[ruby-core:69841] [Bug #11324]'",
          "2115:     usascii = Encoding::US_ASCII",
          "2116:     s = \"A\\nB\\r\\nC\".force_encoding(usascii)",
          "2117:     assert_equal(\"A\\nB\\nC\", s.encode(usascii, universal_newline: true), bug11324)",
          "2118:     assert_equal(\"A\\nB\\nC\", s.encode(usascii, universal_newline: true, undef: :replace), bug11324)",
          "2119:     assert_equal(\"A\\nB\\nC\", s.encode(usascii, universal_newline: true, undef: :replace, replace: ''), bug11324)",
          "2120:   end",
          "",
          "---------------"
        ],
        "transcode.c||transcode.c": [
          "File: transcode.c -> transcode.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2202:     encname2 = rb_econv_encoding_to_insert_output(ec);",
          "2205:         str2 = xmalloc(len);",
          "2207:         len2 = len;",
          "",
          "[Removed Lines]",
          "2204:     if (encoding_equal(encname, encname2)) {",
          "",
          "[Added Lines]",
          "2204:     if (!*encname2 || encoding_equal(encname, encname2)) {",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-08-17\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 8",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 396",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 397",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b366c72ae1523f7dc25766d6191f77cb96a0f844",
      "candidate_info": {
        "commit_hash": "b366c72ae1523f7dc25766d6191f77cb96a0f844",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/b366c72ae1523f7dc25766d6191f77cb96a0f844",
        "files": [
          "ChangeLog",
          "ext/etc/etc.c",
          "test/etc/test_etc.rb",
          "version.h",
          "win32/win32.c"
        ],
        "message": "merge revision(s) r48360,r48364: [Backport #10493]\n\n\t* ext/etc/etc.c (etc_getlogin): set login name encoding properly.\n\t  [ruby-core:66163] [Bug #10493]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49473 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/etc/etc.c||ext/etc/etc.c",
          "test/etc/test_etc.rb||test/etc/test_etc.rb",
          "version.h||version.h",
          "win32/win32.c||win32/win32.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/etc/etc.c||ext/etc/etc.c": [
          "File: ext/etc/etc.c -> ext/etc/etc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "67:     login = getenv(\"USER\");",
          "68: #endif",
          "72:     return Qnil;",
          "73: }",
          "",
          "[Removed Lines]",
          "70:     if (login)",
          "71:  return rb_tainted_str_new2(login);",
          "",
          "[Added Lines]",
          "70:     if (login) {",
          "71: #ifdef _WIN32",
          "72:  rb_encoding *extenc = rb_utf8_encoding();",
          "73: #else",
          "74:  rb_encoding *extenc = rb_locale_encoding();",
          "75: #endif",
          "76:  return rb_external_str_new_with_enc(login, strlen(login), extenc);",
          "77:     }",
          "",
          "---------------"
        ],
        "test/etc/test_etc.rb||test/etc/test_etc.rb": [
          "File: test/etc/test_etc.rb -> test/etc/test_etc.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: class TestEtc < Test::Unit::TestCase",
          "5:   def test_getlogin",
          "6:     s = Etc.getlogin",
          "8:   end",
          "10:   def test_passwd",
          "",
          "[Removed Lines]",
          "7:     assert(s.is_a?(String) || s == nil, \"getlogin must return a String or nil\")",
          "",
          "[Added Lines]",
          "7:     return if s == nil",
          "8:     assert(s.is_a?(String), \"getlogin must return a String or nil\")",
          "9:     assert_predicate(s, :valid_encoding?, \"login name should be a valid string\")",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "2: #define RUBY_RELEASE_DATE \"2015-02-02\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 2",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 289",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 290",
          "",
          "---------------"
        ],
        "win32/win32.c||win32/win32.c": [
          "File: win32/win32.c -> win32/win32.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "543:  if (!GetEnvironmentVariableW(L\"USERNAME\", env, numberof(env)) &&",
          "544:      !GetUserNameW(env, (len = numberof(env), &len))) {",
          "545:      NTLoginName = \"<Unknown>\";",
          "547:  }",
          "549:     }",
          "552:     if (!GetEnvironmentVariableW(TMPDIR, env, numberof(env)) &&",
          "553:  !GetEnvironmentVariableW(L\"TMP\", env, numberof(env)) &&",
          "",
          "[Removed Lines]",
          "546:      return;",
          "548:  set_env_val(L\"USER\");",
          "550:     NTLoginName = strdup(rb_w32_getenv(\"USER\"));",
          "",
          "[Added Lines]",
          "547:  else {",
          "548:      set_env_val(L\"USER\");",
          "549:      NTLoginName = rb_w32_wstr_to_mbstr(CP_UTF8, env, -1, NULL);",
          "550:  }",
          "551:     }",
          "552:     else {",
          "553:  NTLoginName = rb_w32_wstr_to_mbstr(CP_UTF8, env, -1, NULL);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b19d2e9af9c9429f3a84f613432777a6723dd4b7",
      "candidate_info": {
        "commit_hash": "b19d2e9af9c9429f3a84f613432777a6723dd4b7",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/b19d2e9af9c9429f3a84f613432777a6723dd4b7",
        "files": [
          "ChangeLog",
          "version.h"
        ],
        "message": "* version.h (RUBY_VERSION): bump RUBY_VERSION to 2.1.8.\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51974 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-08-18\"",
          "3: #define RUBY_PATCHLEVEL 400",
          "6: #define RUBY_RELEASE_MONTH 8",
          "7: #define RUBY_RELEASE_DAY 18",
          "",
          "[Added Lines]",
          "1: #define RUBY_VERSION \"2.1.8\"",
          "2: #define RUBY_RELEASE_DATE \"2015-09-29\"",
          "3: #define RUBY_PATCHLEVEL 401",
          "6: #define RUBY_RELEASE_MONTH 9",
          "7: #define RUBY_RELEASE_DAY 29",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0d1f4fb57deeeb88f55751bf71ad7c2e90ac47b1",
      "candidate_info": {
        "commit_hash": "0d1f4fb57deeeb88f55751bf71ad7c2e90ac47b1",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/0d1f4fb57deeeb88f55751bf71ad7c2e90ac47b1",
        "files": [
          "ChangeLog",
          "ext/bigdecimal/bigdecimal.c",
          "version.h"
        ],
        "message": "merge revision(s) 49491: [Backport #10823]\n\n\t* ext/bigdecimal/bigdecimal.c (VpSetPTR): fix a typo, 'expoennt'\n\t  to 'exponent'.  [ruby-core:67980] [Bug #10823] [Fix GH-825]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@50670 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/bigdecimal/bigdecimal.c||ext/bigdecimal/bigdecimal.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/bigdecimal/bigdecimal.c||ext/bigdecimal/bigdecimal.c": [
          "File: ext/bigdecimal/bigdecimal.c -> ext/bigdecimal/bigdecimal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4387:     size_t const round_limit = (VpGetPrecLimit() + BASE_FIG - 1) / BASE_FIG;",
          "4391:     c->frac[0] = 0;",
          "",
          "[Removed Lines]",
          "4389:     assert(a->exponent >= b->expoennt);",
          "",
          "[Added Lines]",
          "4389:     assert(a->exponent >= b->exponent);",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-05-29\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 5",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 361",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 362",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f3ac23e422c1cd68b9be355b82c495047786c268",
      "candidate_info": {
        "commit_hash": "f3ac23e422c1cd68b9be355b82c495047786c268",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/f3ac23e422c1cd68b9be355b82c495047786c268",
        "files": [
          "ChangeLog",
          "complex.c",
          "object.c",
          "rational.c",
          "version.h"
        ],
        "message": "merge revision(s) r45375,r48260,r48320,r48746: [Backport #10526]\n\n\t* complax.c: [DOC] Document number conversion of `nil` by @skade [fix GH-570] [ci skip]\n\n\t* object.c, rational.c: ditto.\n\t* object.c: fix document of Kernel.Stirng by @suzukaze\n\t  [fix GH-743][ci skip]\n\n\t* object.c (Module#const_defined?): [DOC] Revise the documentation.\n\t  Patch by Xavier Noria.\n\t  [Fixes GH-754] https://github.com/ruby/ruby/pull/754\n\n\t* object.c: [DOC] Revise documentation by Marcus Stollsteimer at\n\t  [ruby-core:66368].  [Bug #10526]\n\t  * #inspect: be more specific about generated string, remove\n\t    obsolete example.\n\t  * #nil?: use code examples instead of different call-seq's.\n\t  * #tap: clarify what is yielded.\n\t  * Integer(): be more specific about to_int and to_i, remove\n\t    reference to Ruby 1.8.\n\t  * Array(): fix error.\n\t  * Class: fix variable name style and indentation in example.\n\t  * improve consistency, fix typos and formatting.\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49367 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "complex.c||complex.c",
          "object.c||object.c",
          "rational.c||rational.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "complex.c||complex.c": [
          "File: complex.c -> complex.c"
        ],
        "object.c||object.c": [
          "File: object.c -> object.c"
        ],
        "rational.c||rational.c": [
          "File: rational.c -> rational.c"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "2: #define RUBY_RELEASE_DATE \"2015-01-22\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 1",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 280",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 281",
          "",
          "---------------"
        ]
      }
    }
  ]
}