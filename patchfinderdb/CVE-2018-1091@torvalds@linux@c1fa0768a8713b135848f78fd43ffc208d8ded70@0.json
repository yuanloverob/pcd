{
  "cve_id": "CVE-2018-1091",
  "cve_desc": "In the flush_tmregs_to_thread function in arch/powerpc/kernel/ptrace.c in the Linux kernel before 4.13.5, a guest kernel crash can be triggered from unprivileged userspace during a core dump on a POWER host due to a missing processor feature check and an erroneous use of transactional memory (TM) instructions in the core dump path, leading to a denial of service.",
  "repo": "torvalds/linux",
  "patch_hash": "c1fa0768a8713b135848f78fd43ffc208d8ded70",
  "patch_info": {
    "commit_hash": "c1fa0768a8713b135848f78fd43ffc208d8ded70",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/c1fa0768a8713b135848f78fd43ffc208d8ded70",
    "files": [
      "arch/powerpc/kernel/ptrace.c"
    ],
    "message": "powerpc/tm: Flush TM only if CPU has TM feature\n\nCommit cd63f3c (\"powerpc/tm: Fix saving of TM SPRs in core dump\")\nadded code to access TM SPRs in flush_tmregs_to_thread(). However\nflush_tmregs_to_thread() does not check if TM feature is available on\nCPU before trying to access TM SPRs in order to copy live state to\nthread structures. flush_tmregs_to_thread() is indeed guarded by\nCONFIG_PPC_TRANSACTIONAL_MEM but it might be the case that kernel\nwas compiled with CONFIG_PPC_TRANSACTIONAL_MEM enabled and ran on\na CPU without TM feature available, thus rendering the execution\nof TM instructions that are treated by the CPU as illegal instructions.\n\nThe fix is just to add proper checking in flush_tmregs_to_thread()\nif CPU has the TM feature before accessing any TM-specific resource,\nreturning immediately if TM is no available on the CPU. Adding\nthat checking in flush_tmregs_to_thread() instead of in places\nwhere it is called, like in vsr_get() and vsr_set(), is better because\navoids the same problem cropping up elsewhere.\n\nCc: stable@vger.kernel.org # v4.13+\nFixes: cd63f3c (\"powerpc/tm: Fix saving of TM SPRs in core dump\")\nSigned-off-by: Gustavo Romero <gromero@linux.vnet.ibm.com>\nReviewed-by: Cyril Bur <cyrilbur@gmail.com>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>",
    "before_after_code_files": [
      "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c"
    ]
  },
  "patch_diff": {
    "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c": [
      "File: arch/powerpc/kernel/ptrace.c -> arch/powerpc/kernel/ptrace.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "135:   return;",
      "137:  if (MSR_TM_SUSPENDED(mfmsr())) {",
      "",
      "[Removed Lines]",
      "134:  if (tsk != current)",
      "",
      "[Added Lines]",
      "134:  if ((!cpu_has_feature(CPU_FTR_TM)) || (tsk != current))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "cd63f3cf1d59b7ad8419eba1cac8f9126e79cc43",
      "candidate_info": {
        "commit_hash": "cd63f3cf1d59b7ad8419eba1cac8f9126e79cc43",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/cd63f3cf1d59b7ad8419eba1cac8f9126e79cc43",
        "files": [
          "arch/powerpc/kernel/ptrace.c"
        ],
        "message": "powerpc/tm: Fix saving of TM SPRs in core dump\n\nCurrently flush_tmregs_to_thread() does not save the TM SPRs (TFHAR,\nTFIAR, TEXASR) to the thread struct, unless the process is currently\ninside a suspended transaction.\n\nIf the process is core dumping, and the TM SPRs have changed since the\nlast time the process was context switched, then we will save stale\nvalues of the TM SPRs to the core dump.\n\nFix it by saving the live register state to the thread struct in that\ncase.\n\nFixes: 08e1c01d6aed (\"powerpc/ptrace: Enable support for TM SPR state\")\nCc: stable@vger.kernel.org # v4.8+\nSigned-off-by: Gustavo Romero <gromero@linux.vnet.ibm.com>\nReviewed-by: Cyril Bur <cyrilbur@gmail.com>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>",
        "before_after_code_files": [
          "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c"
          ],
          "candidate": [
            "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c"
          ]
        }
      },
      "candidate_diff": {
        "arch/powerpc/kernel/ptrace.c||arch/powerpc/kernel/ptrace.c": [
          "File: arch/powerpc/kernel/ptrace.c -> arch/powerpc/kernel/ptrace.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "136: }",
          "137: #else",
          "138: static inline void flush_tmregs_to_thread(struct task_struct *tsk) { }",
          "",
          "[Removed Lines]",
          "133:  if (tsk == current && MSR_TM_SUSPENDED(mfmsr()))",
          "134:   tm_reclaim_current(TM_CAUSE_SIGNAL);",
          "",
          "[Added Lines]",
          "134:  if (tsk != current)",
          "135:   return;",
          "137:  if (MSR_TM_SUSPENDED(mfmsr())) {",
          "138:   tm_reclaim_current(TM_CAUSE_SIGNAL);",
          "139:  } else {",
          "140:   tm_enable();",
          "141:   tm_save_sprs(&(tsk->thread));",
          "142:  }",
          "",
          "---------------"
        ]
      }
    }
  ]
}