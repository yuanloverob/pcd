{
  "cve_id": "CVE-2016-2041",
  "cve_desc": "libraries/common.inc.php in phpMyAdmin 4.0.x before 4.0.10.13, 4.4.x before 4.4.15.3, and 4.5.x before 4.5.4 does not use a constant-time algorithm for comparing CSRF tokens, which makes it easier for remote attackers to bypass intended access restrictions by measuring time differences.",
  "repo": "phpmyadmin/phpmyadmin",
  "patch_hash": "ec0e88e37ef30a66eada1c072953f4ec385a3e49",
  "patch_info": {
    "commit_hash": "ec0e88e37ef30a66eada1c072953f4ec385a3e49",
    "repo": "phpmyadmin/phpmyadmin",
    "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/ec0e88e37ef30a66eada1c072953f4ec385a3e49",
    "files": [
      "libraries/common.inc.php",
      "libraries/core.lib.php"
    ],
    "message": "Use hash_equals for comparing token\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
    "before_after_code_files": [
      "libraries/common.inc.php||libraries/common.inc.php",
      "libraries/core.lib.php||libraries/core.lib.php"
    ]
  },
  "patch_diff": {
    "libraries/common.inc.php||libraries/common.inc.php": [
      "File: libraries/common.inc.php -> libraries/common.inc.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "474: $token_provided = false;",
      "475: if (PMA_isValid($_REQUEST['token'])) {",
      "476:     $token_provided = true;",
      "478: }",
      "480: if ($token_mismatch) {",
      "",
      "[Removed Lines]",
      "477:     $token_mismatch = ($_SESSION[' PMA_token '] != $_REQUEST['token']);",
      "",
      "[Added Lines]",
      "477:     $token_mismatch = ! hash_equals($_SESSION[' PMA_token '], $_REQUEST['token']);",
      "",
      "---------------"
    ],
    "libraries/core.lib.php||libraries/core.lib.php": [
      "File: libraries/core.lib.php -> libraries/core.lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "998:         $GLOBALS['url_params'][$param] = $GLOBALS[$param];",
      "999:     }",
      "1000: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1003: if(! function_exists('hash_equals')) {",
      "1004:     function hash_equals($a, $b) {",
      "1005:         $ret = strlen($a) ^ strlen($b);",
      "1006:         $ret |= array_sum(unpack(\"C*\", $a ^ $b));",
      "1007:         return ! $ret;",
      "1008:     }",
      "1009: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3303b3d6c304d71da4a7d242307bf449aaa955c5",
      "candidate_info": {
        "commit_hash": "3303b3d6c304d71da4a7d242307bf449aaa955c5",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/3303b3d6c304d71da4a7d242307bf449aaa955c5",
        "files": [
          "libraries/common.inc.php",
          "libraries/core.lib.php"
        ],
        "message": "Use hash_equals for comparing token\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
        "before_after_code_files": [
          "libraries/common.inc.php||libraries/common.inc.php",
          "libraries/core.lib.php||libraries/core.lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libraries/common.inc.php||libraries/common.inc.php",
            "libraries/core.lib.php||libraries/core.lib.php"
          ],
          "candidate": [
            "libraries/common.inc.php||libraries/common.inc.php",
            "libraries/core.lib.php||libraries/core.lib.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/common.inc.php||libraries/common.inc.php": [
          "File: libraries/common.inc.php -> libraries/common.inc.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "469: $token_provided = false;",
          "470: if (PMA_isValid($_REQUEST['token'])) {",
          "471:     $token_provided = true;",
          "473: }",
          "475: if ($token_mismatch) {",
          "",
          "[Removed Lines]",
          "472:     $token_mismatch = ($_SESSION[' PMA_token '] != $_REQUEST['token']);",
          "",
          "[Added Lines]",
          "472:     $token_mismatch = ! hash_equals($_SESSION[' PMA_token '], $_REQUEST['token']);",
          "",
          "---------------"
        ],
        "libraries/core.lib.php||libraries/core.lib.php": [
          "File: libraries/core.lib.php -> libraries/core.lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1012:         $GLOBALS['url_params'][$param] = $GLOBALS[$param];",
          "1013:     }",
          "1014: }",
          "1015: ?>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1017: if(! function_exists('hash_equals')) {",
          "1018:     function hash_equals($a, $b) {",
          "1019:         $ret = strlen($a) ^ strlen($b);",
          "1020:         $ret |= array_sum(unpack(\"C*\", $a ^ $b));",
          "1021:         return ! $ret;",
          "1022:     }",
          "1023: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fe62b69a5b032de8e1d9d0a04456c1cecf46428c",
      "candidate_info": {
        "commit_hash": "fe62b69a5b032de8e1d9d0a04456c1cecf46428c",
        "repo": "phpmyadmin/phpmyadmin",
        "commit_url": "https://github.com/phpmyadmin/phpmyadmin/commit/fe62b69a5b032de8e1d9d0a04456c1cecf46428c",
        "files": [
          "libraries/common.inc.php",
          "libraries/core.lib.php"
        ],
        "message": "Use hash_equals for comparing token\n\nSigned-off-by: Michal \u010ciha\u0159 <michal@cihar.com>",
        "before_after_code_files": [
          "libraries/common.inc.php||libraries/common.inc.php",
          "libraries/core.lib.php||libraries/core.lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libraries/common.inc.php||libraries/common.inc.php",
            "libraries/core.lib.php||libraries/core.lib.php"
          ],
          "candidate": [
            "libraries/common.inc.php||libraries/common.inc.php",
            "libraries/core.lib.php||libraries/core.lib.php"
          ]
        }
      },
      "candidate_diff": {
        "libraries/common.inc.php||libraries/common.inc.php": [
          "File: libraries/common.inc.php -> libraries/common.inc.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "483: $token_mismatch = true;",
          "484: if (PMA_isValid($_REQUEST['token'])) {",
          "486: }",
          "488: if ($token_mismatch) {",
          "",
          "[Removed Lines]",
          "485:     $token_mismatch = ($_SESSION[' PMA_token '] != $_REQUEST['token']);",
          "",
          "[Added Lines]",
          "485:     $token_mismatch = ! hash_equals($_SESSION[' PMA_token '], $_REQUEST['token']);",
          "",
          "---------------"
        ],
        "libraries/core.lib.php||libraries/core.lib.php": [
          "File: libraries/core.lib.php -> libraries/core.lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "305:         PMA_fatalError($message);",
          "306:     } else {",
          "307:         $GLOBALS['error_handler']->addError(",
          "309:             E_USER_WARNING,",
          "310:             '',",
          "311:             '',",
          "",
          "[Removed Lines]",
          "308:             $message,",
          "",
          "[Added Lines]",
          "308:             $message,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "799:     PMA_addJSCode(PMA_getJsValue($key, $value, $escape));",
          "800: }",
          "802: ?>",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "803: if(! function_exists('hash_equals')) {",
          "804:     function hash_equals($a, $b) {",
          "805:         $ret = strlen($a) ^ strlen($b);",
          "806:         $ret |= array_sum(unpack(\"C*\", $a ^ $b));",
          "807:         return ! $ret;",
          "808:     }",
          "809: }",
          "",
          "---------------"
        ]
      }
    }
  ]
}