{
  "cve_id": "CVE-2021-29567",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Due to lack of validation in `tf.raw_ops.SparseDenseCwiseMul`, an attacker can trigger denial of service via `CHECK`-fails or accesses to outside the bounds of heap allocated data. Since the implementation(https://github.com/tensorflow/tensorflow/blob/38178a2f7a681a7835bb0912702a134bfe3b4d84/tensorflow/core/kernels/sparse_dense_binary_op_shared.cc#L68-L80) only validates the rank of the input arguments but no constraints between dimensions(https://www.tensorflow.org/api_docs/python/tf/raw_ops/SparseDenseCwiseMul), an attacker can abuse them to trigger internal `CHECK` assertions (and cause program termination, denial of service) or to write to memory outside of bounds of heap allocated tensor buffers. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "7ae2af34087fb4b5c8915279efd03da3b81028bc",
  "patch_info": {
    "commit_hash": "7ae2af34087fb4b5c8915279efd03da3b81028bc",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/7ae2af34087fb4b5c8915279efd03da3b81028bc",
    "files": [
      "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
    ],
    "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseDenseCwiseMul`.\n\nPiperOrigin-RevId: 372054410\nChange-Id: Ifcce0491e2e3816838c87e73be30a1e61b65174d",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
      "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "78:                     \"but received shapes: \",",
      "79:                     values_t->shape().DebugString(), \" and \",",
      "80:                     shape_t->shape().DebugString()));",
      "82:     const auto indices_mat = indices_t->matrix<int64>();",
      "83:     const auto shape_vec = shape_t->vec<int64>();",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "81:     OP_REQUIRES(",
      "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
      "83:         errors::InvalidArgument(",
      "84:             \"The first dimension of values and indices should match. (\",",
      "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6a71fd1c0222e4789c978c8583bf2b8252b26478",
      "candidate_info": {
        "commit_hash": "6a71fd1c0222e4789c978c8583bf2b8252b26478",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6a71fd1c0222e4789c978c8583bf2b8252b26478",
        "files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ],
        "message": "Add missing validation to sparse dense cwise ops.\n\nPiperOrigin-RevId: 415543133\nChange-Id: I5baf3284e919338afb96178c468ad3d3cb0d956c",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                     \"but received shapes: \",",
          "79:                     values_t->shape().DebugString(), \" and \",",
          "80:                     shape_t->shape().DebugString()));",
          "81:     OP_REQUIRES(",
          "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
          "83:         errors::InvalidArgument(",
          "84:             \"The first dimension of values and indices should match. (\",",
          "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
          "87:     const auto indices_mat = indices_t->matrix<int64>();",
          "88:     const auto shape_vec = shape_t->vec<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     OP_REQUIRES(",
          "82:         ctx, TensorShapeUtils::IsVector(shape_t->shape()),",
          "83:         errors::InvalidArgument(\"Input sp_shape must be a vector. Got: \",",
          "84:                                 shape_t->shape().DebugString()));",
          "90:     OP_REQUIRES(",
          "91:         ctx, shape_t->shape().dim_size(0) == indices_t->shape().dim_size(1),",
          "92:         errors::InvalidArgument(",
          "93:             \"Number of dimensions must match second dimension of indices. \",",
          "94:             \"Got \", shape_t->shape().dim_size(0),",
          "95:             \" dimensions, indices shape: \", indices_t->shape().DebugString()));",
          "96:     OP_REQUIRES(ctx, shape_t->NumElements() > 0,",
          "97:                 errors::InvalidArgument(",
          "98:                     \"The shape argument requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1bb5127afa846aa5d67313ff4bbfaa360f25d148",
      "candidate_info": {
        "commit_hash": "1bb5127afa846aa5d67313ff4bbfaa360f25d148",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/1bb5127afa846aa5d67313ff4bbfaa360f25d148",
        "files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ],
        "message": "Add missing validation to sparse dense cwise ops.\n\nPiperOrigin-RevId: 415543133\nChange-Id: I5baf3284e919338afb96178c468ad3d3cb0d956c",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                     \"but received shapes: \",",
          "79:                     values_t->shape().DebugString(), \" and \",",
          "80:                     shape_t->shape().DebugString()));",
          "81:     OP_REQUIRES(",
          "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
          "83:         errors::InvalidArgument(",
          "84:             \"The first dimension of values and indices should match. (\",",
          "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
          "87:     const auto indices_mat = indices_t->matrix<int64_t>();",
          "88:     const auto shape_vec = shape_t->vec<int64_t>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     OP_REQUIRES(",
          "82:         ctx, TensorShapeUtils::IsVector(shape_t->shape()),",
          "83:         errors::InvalidArgument(\"Input sp_shape must be a vector. Got: \",",
          "84:                                 shape_t->shape().DebugString()));",
          "90:     OP_REQUIRES(",
          "91:         ctx, shape_t->shape().dim_size(0) == indices_t->shape().dim_size(1),",
          "92:         errors::InvalidArgument(",
          "93:             \"Number of dimensions must match second dimension of indices. \",",
          "94:             \"Got \", shape_t->shape().dim_size(0),",
          "95:             \" dimensions, indices shape: \", indices_t->shape().DebugString()));",
          "96:     OP_REQUIRES(ctx, shape_t->NumElements() > 0,",
          "97:                 errors::InvalidArgument(",
          "98:                     \"The shape argument requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1b54cadd19391b60b6fcccd8d076426f7221d5e8",
      "candidate_info": {
        "commit_hash": "1b54cadd19391b60b6fcccd8d076426f7221d5e8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/1b54cadd19391b60b6fcccd8d076426f7221d5e8",
        "files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ],
        "message": "Add missing validation to sparse dense cwise ops.\n\nPiperOrigin-RevId: 415543133\nChange-Id: I5baf3284e919338afb96178c468ad3d3cb0d956c",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                     \"but received shapes: \",",
          "79:                     values_t->shape().DebugString(), \" and \",",
          "80:                     shape_t->shape().DebugString()));",
          "81:     OP_REQUIRES(",
          "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
          "83:         errors::InvalidArgument(",
          "84:             \"The first dimension of values and indices should match. (\",",
          "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
          "87:     const auto indices_mat = indices_t->matrix<int64_t>();",
          "88:     const auto shape_vec = shape_t->vec<int64_t>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     OP_REQUIRES(",
          "82:         ctx, TensorShapeUtils::IsVector(shape_t->shape()),",
          "83:         errors::InvalidArgument(\"Input sp_shape must be a vector. Got: \",",
          "84:                                 shape_t->shape().DebugString()));",
          "90:     OP_REQUIRES(",
          "91:         ctx, shape_t->shape().dim_size(0) == indices_t->shape().dim_size(1),",
          "92:         errors::InvalidArgument(",
          "93:             \"Number of dimensions must match second dimension of indices. \",",
          "94:             \"Got \", shape_t->shape().dim_size(0),",
          "95:             \" dimensions, indices shape: \", indices_t->shape().DebugString()));",
          "96:     OP_REQUIRES(ctx, shape_t->NumElements() > 0,",
          "97:                 errors::InvalidArgument(",
          "98:                     \"The shape argument requires at least one element.\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "116e0ee715c78510c4fbd1c26ad7d89aaadfd564",
      "candidate_info": {
        "commit_hash": "116e0ee715c78510c4fbd1c26ad7d89aaadfd564",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/116e0ee715c78510c4fbd1c26ad7d89aaadfd564",
        "files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseDenseCwiseMul`.\n\nPiperOrigin-RevId: 372054410\nChange-Id: Ifcce0491e2e3816838c87e73be30a1e61b65174d",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                     \"but received shapes: \",",
          "79:                     values_t->shape().DebugString(), \" and \",",
          "80:                     shape_t->shape().DebugString()));",
          "82:     const auto indices_mat = indices_t->matrix<int64>();",
          "83:     const auto shape_vec = shape_t->vec<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     OP_REQUIRES(",
          "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
          "83:         errors::InvalidArgument(",
          "84:             \"The first dimension of values and indices should match. (\",",
          "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6675965ab64ae542a59db7f8735ca0e7ba056e17",
      "candidate_info": {
        "commit_hash": "6675965ab64ae542a59db7f8735ca0e7ba056e17",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/6675965ab64ae542a59db7f8735ca0e7ba056e17",
        "files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ],
        "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseDenseCwiseMul`.\n\nPiperOrigin-RevId: 372054410\nChange-Id: Ifcce0491e2e3816838c87e73be30a1e61b65174d",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_dense_binary_op_shared.cc||tensorflow/core/kernels/sparse_dense_binary_op_shared.cc": [
          "File: tensorflow/core/kernels/sparse_dense_binary_op_shared.cc -> tensorflow/core/kernels/sparse_dense_binary_op_shared.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:                     \"but received shapes: \",",
          "79:                     values_t->shape().DebugString(), \" and \",",
          "80:                     shape_t->shape().DebugString()));",
          "82:     const auto indices_mat = indices_t->matrix<int64>();",
          "83:     const auto shape_vec = shape_t->vec<int64>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "81:     OP_REQUIRES(",
          "82:         ctx, values_t->dim_size(0) == indices_t->dim_size(0),",
          "83:         errors::InvalidArgument(",
          "84:             \"The first dimension of values and indices should match. (\",",
          "85:             values_t->dim_size(0), \" vs. \", indices_t->dim_size(0), \")\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}