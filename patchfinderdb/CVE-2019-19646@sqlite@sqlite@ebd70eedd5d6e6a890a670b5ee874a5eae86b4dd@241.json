{
  "cve_id": "CVE-2019-19646",
  "cve_desc": "pragma.c in SQLite through 3.30.1 mishandles NOT NULL in an integrity_check PRAGMA command in certain cases of generated columns.",
  "repo": "sqlite/sqlite",
  "patch_hash": "ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
  "patch_info": {
    "commit_hash": "ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/ebd70eedd5d6e6a890a670b5ee874a5eae86b4dd",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/pragma.c",
      "test/gencol1.test"
    ],
    "message": "Fix the NOT NULL verification logic in PRAGMA integrity_check so that it works for generated columns whose value is the result of a comparison operator. Ticket [bd8c280671ba44a7]\n\nFossilOrigin-Name: f3b39c71b88cb6721f443de56cdce4c08252453a5e340b00a2bd88dc10c42400",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/pragma.c||src/pragma.c",
      "test/gencol1.test||test/gencol1.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: e3398c5ffb060b2b26334b8598e2c63953741e2d6f5124dbd6bdfc8e94742539",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/pragma.c||src/pragma.c": [
      "File: src/pragma.c -> src/pragma.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1596:           if( j==pTab->iPKey ) continue;",
      "1597:           if( pTab->aCol[j].notNull==0 ) continue;",
      "1598:           sqlite3ExprCodeGetColumnOfTable(v, pTab, iDataCur, j, 3);",
      "1600:           jmp2 = sqlite3VdbeAddOp1(v, OP_NotNull, 3); VdbeCoverage(v);",
      "1601:           zErr = sqlite3MPrintf(db, \"NULL value in %s.%s\", pTab->zName,",
      "1602:                               pTab->aCol[j].zName);",
      "",
      "[Removed Lines]",
      "1599:           sqlite3VdbeChangeP5(v, OPFLAG_TYPEOFARG);",
      "",
      "[Added Lines]",
      "1599:           if( sqlite3VdbeGetOp(v,-1)->opcode==OP_Column ){",
      "1600:             sqlite3VdbeChangeP5(v, OPFLAG_TYPEOFARG);",
      "1601:           }",
      "",
      "---------------"
    ],
    "test/gencol1.test||test/gencol1.test": [
      "File: test/gencol1.test -> test/gencol1.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "328:   INSERT OR REPLACE INTO t0(c0, c1) VALUES (2, 1), (1, 0)",
      "329: } {1 {FOREIGN KEY constraint failed}}",
      "331: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "331: # 2019-12-09 ticket bd8c280671ba44a7",
      "332: # With generated columns, the sqlite3ExprGetColumnOfTable() routine might",
      "333: # generate a code sequence that does not end with OP_Column.  So check to",
      "334: # make sure that the last instruction generated is an OP_column prior to",
      "335: # applying the OPFLAG_TYPEOFARG optimization to NOT NULL checks in the",
      "336: # PRAGMA integrity_check code.",
      "337: #",
      "338: sqlite3 db :memory:",
      "339: do_execsql_test gencol1-12.10 {",
      "340:   CREATE TABLE t0 (c0, c1 NOT NULL AS (c0==0));",
      "341:   INSERT INTO t0(c0) VALUES (0);",
      "342:   PRAGMA integrity_check;",
      "343: } {ok}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "32d0f64e8dc1ce478a48e6ebcc400e71a3deb8aa",
      "candidate_info": {
        "commit_hash": "32d0f64e8dc1ce478a48e6ebcc400e71a3deb8aa",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/32d0f64e8dc1ce478a48e6ebcc400e71a3deb8aa",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/whereexpr.c",
          "test/like.test"
        ],
        "message": "Do not attempt the LIKE optimization on a column with numeric affinity if the rhs of the operator begins with whitespace. Fix for ticket [fd76310a5e].\n\nFossilOrigin-Name: 94b58ab059cba9771e75f16d1460f313104a8fb879f9f8805725d362aa58cbcd",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/whereexpr.c||src/whereexpr.c",
          "test/like.test||test/like.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b141bae3f6d16c0ebb59dac9b02086a4370839e71ade34004f647b09b1083d1d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/whereexpr.c||src/whereexpr.c": [
          "File: src/whereexpr.c -> src/whereexpr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "279:         if( sqlite3Isdigit(zNew[0])",
          "280:          || zNew[0]=='-'",
          "281:          || zNew[0]=='+'",
          "282:          || zNew[iTo-1]=='0'-1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "280:          || sqlite3Isspace(zNew[0])",
          "",
          "---------------"
        ],
        "test/like.test||test/like.test": [
          "File: test/like.test -> test/like.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "18: set testdir [file dirname $argv0]",
          "19: source $testdir/tester.tcl",
          "21: # Create some sample data to work with.",
          "22: #",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "20: set testprefix like",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1095: } {/SEARCH/}",
          "1096: }",
          "1098: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1099: #-------------------------------------------------------------------------",
          "1100: # Tests for ticket [b1d8c79314].",
          "1101: #",
          "1102: reset_db",
          "1103: do_execsql_test 16.0 {",
          "1104:   CREATE TABLE t1(a INTEGER COLLATE NOCASE);",
          "1105:   CREATE INDEX i1 ON t1(a);",
          "1106:   INSERT INTO t1 VALUES(' 1x');",
          "1107:   INSERT INTO t1 VALUES(' 1-');",
          "1108: }",
          "1109: do_execsql_test 16.1 {",
          "1110:   SELECT * FROM t1 WHERE a LIKE ' 1%';",
          "1111: } {{ 1x} { 1-}}",
          "1112: do_execsql_test 16.2 {",
          "1113:   SELECT * FROM t1 WHERE a LIKE ' 1-';",
          "1114: } {{ 1-}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b4e5039316e0c8fee98913d6f3433074d28a4b6b",
      "candidate_info": {
        "commit_hash": "b4e5039316e0c8fee98913d6f3433074d28a4b6b",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/b4e5039316e0c8fee98913d6f3433074d28a4b6b",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "Add the \".eqp trace\" command to the CLI when using SQLITE_DEBUG, as a convenient shorthand for \"PRAGMA vdbe_debug=ON\" but with automatic indentation feature for program listings provided by the CLI.\n\nFossilOrigin-Name: 626502faa17b5b7a0fa36cabfd12e463eb09aec048d01c587a18d3977cf04662",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 13f6942eb0da2d92a0830f18640ce64208bd0cd6ff6d0c97e4a4c57ac3d65ba6",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "3401:   \"     --newlines             Allow unescaped newline characters in output\",",
          "3402:   \"   TABLE is LIKE pattern for the tables to dump\",",
          "3403:   \".echo on|off             Turn command echo on or off\",",
          "3405:   \".excel                   Display the output of next command in a spreadsheet\",",
          "3406:   \".exit ?CODE?             Exit this program with return-code CODE\",",
          "3407:   \".expert                  EXPERIMENTAL. Suggest indexes for specified queries\",",
          "",
          "[Removed Lines]",
          "3404:   \".eqp on|off|full         Enable or disable automatic EXPLAIN QUERY PLAN\",",
          "",
          "[Added Lines]",
          "3405:   \".eqp on|off|full|...     Enable or disable automatic EXPLAIN QUERY PLAN\",",
          "3406:   \"   Other Modes:\",",
          "3407: #ifdef SQLITE_DEBUG",
          "3408:   \"      test                  Show raw EXPLAIN QUERY PLAN output\",",
          "3409:   \"      trace                 Like \\\"full\\\" but also enable \\\"PRAGMA vdbe_trace\\\"\",",
          "3410: #endif",
          "3411:   \"      trigger               Like \\\"full\\\" but also show trigger bytecode\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6264:   if( c=='e' && strncmp(azArg[0], \"eqp\", n)==0 ){",
          "6265:     if( nArg==2 ){",
          "6266:       p->autoEQPtest = 0;",
          "6267:       if( strcmp(azArg[1],\"full\")==0 ){",
          "6268:         p->autoEQP = AUTOEQP_full;",
          "6269:       }else if( strcmp(azArg[1],\"trigger\")==0 ){",
          "6270:         p->autoEQP = AUTOEQP_trigger;",
          "6271:       }else if( strcmp(azArg[1],\"test\")==0 ){",
          "6272:         p->autoEQP = AUTOEQP_on;",
          "6273:         p->autoEQPtest = 1;",
          "6274:       }else{",
          "6275:         p->autoEQP = (u8)booleanValue(azArg[1]);",
          "6276:       }",
          "6277:     }else{",
          "6279:       rc = 1;",
          "6280:     }",
          "6281:   }else",
          "",
          "[Removed Lines]",
          "6278:       raw_printf(stderr, \"Usage: .eqp off|on|trigger|full\\n\");",
          "",
          "[Added Lines]",
          "6274:       if( p->autoEQPtrace ){",
          "6275:         if( p->db ) sqlite3_exec(p->db, \"PRAGMA vdbe_trace=OFF;\", 0, 0, 0);",
          "6276:         p->autoEQPtrace = 0;",
          "6277:       }",
          "6282: #ifdef SQLITE_DEBUG",
          "6286:       }else if( strcmp(azArg[1],\"trace\")==0 ){",
          "6287:         p->autoEQP = AUTOEQP_full;",
          "6288:         p->autoEQPtrace = 1;",
          "6289:         open_db(p, 0);",
          "6290:         (void)sqlite3_table_column_metadata(p->db, \"x\",\"x\",0,0,0,0,0,0);",
          "6291:         sqlite3_exec(p->db, \"PRAGMA vdbe_trace=ON;\", 0, 0, 0);",
          "6292: #endif",
          "6297:       raw_printf(stderr, \"Usage: .eqp off|on|trace|trigger|full\\n\");",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2a58dbde30bf17497aaf77711496bf01cf72b90e",
      "candidate_info": {
        "commit_hash": "2a58dbde30bf17497aaf77711496bf01cf72b90e",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/2a58dbde30bf17497aaf77711496bf01cf72b90e",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbeaux.c",
          "test/fuzzdata7.db"
        ],
        "message": "Improved detection of cell corruption in sqlite3VdbeRecordCompareWithSkip().\n\nFossilOrigin-Name: fa47f4c6589c431cf678560ac33dea6b695052012bea2096b2c92869ed51c688",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbeaux.c||src/vdbeaux.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: aaa3a19f8cf5ba7003634e4610abc7832354af91d7c7f65469218678f66bcd46",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbeaux.c||src/vdbeaux.c": [
          "File: src/vdbeaux.c -> src/vdbeaux.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4251:   }else{",
          "4252:     idx1 = getVarint32(aKey1, szHdr1);",
          "4253:     d1 = szHdr1;",
          "4258:     i = 0;",
          "4259:   }",
          "4262:   assert( pPKey2->pKeyInfo->nAllField>=pPKey2->nField",
          "",
          "[Removed Lines]",
          "4254:     if( d1>(unsigned)nKey1 ){",
          "4255:       pPKey2->errCode = (u8)SQLITE_CORRUPT_BKPT;",
          "4257:     }",
          "",
          "[Added Lines]",
          "4256:   if( d1>(unsigned)nKey1 ){",
          "4257:     pPKey2->errCode = (u8)SQLITE_CORRUPT_BKPT;",
          "4259:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "705e73344ed81ea306ea6df8b94fc6b623319def",
      "candidate_info": {
        "commit_hash": "705e73344ed81ea306ea6df8b94fc6b623319def",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/705e73344ed81ea306ea6df8b94fc6b623319def",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/prepare.c"
        ],
        "message": "Omit the check for conflicting shared-cache locks in sqlite3Prepare() if the database connection uses no shared cache.  We might be able to go back and remove this code completely, due to the newer Schema.iGeneration logic, but that will take more analysis.  This check-in gives the speed benefit but not the reduction in code size.\n\nFossilOrigin-Name: 0b73a09270dfafb27f8d1762b547ef8178c9da66f45e7153ff0b76272dfa92f5",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/prepare.c||src/prepare.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fc8d45086dc2bcb9bce756088e99e63cbeedf9129139fb0e6a48b43c4f502180",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/prepare.c||src/prepare.c": [
          "File: src/prepare.c -> src/prepare.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "614:       }",
          "615:     }",
          "616:   }",
          "",
          "[Removed Lines]",
          "604:   for(i=0; i<db->nDb; i++) {",
          "605:     Btree *pBt = db->aDb[i].pBt;",
          "606:     if( pBt ){",
          "607:       assert( sqlite3BtreeHoldsMutex(pBt) );",
          "608:       rc = sqlite3BtreeSchemaLocked(pBt);",
          "609:       if( rc ){",
          "610:         const char *zDb = db->aDb[i].zDbSName;",
          "611:         sqlite3ErrorWithMsg(db, rc, \"database schema is locked: %s\", zDb);",
          "612:         testcase( db->flags & SQLITE_ReadUncommit );",
          "613:         goto end_prepare;",
          "",
          "[Added Lines]",
          "604:   if( !db->noSharedCache ){",
          "605:     for(i=0; i<db->nDb; i++) {",
          "606:       Btree *pBt = db->aDb[i].pBt;",
          "607:       if( pBt ){",
          "608:         assert( sqlite3BtreeHoldsMutex(pBt) );",
          "609:         rc = sqlite3BtreeSchemaLocked(pBt);",
          "610:         if( rc ){",
          "611:           const char *zDb = db->aDb[i].zDbSName;",
          "612:           sqlite3ErrorWithMsg(db, rc, \"database schema is locked: %s\", zDb);",
          "613:           testcase( db->flags & SQLITE_ReadUncommit );",
          "614:           goto end_prepare;",
          "615:         }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "244edd01d32b4081086982d5f3c5a93b7a2b6f18",
      "candidate_info": {
        "commit_hash": "244edd01d32b4081086982d5f3c5a93b7a2b6f18",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/244edd01d32b4081086982d5f3c5a93b7a2b6f18",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/fkey8.test"
        ],
        "message": "Add test cases for the fix on this branch.\n\nFossilOrigin-Name: 2e31abe0ae5937a8ce10179e0ae045ee4c5ed8b7e2622ab41243226c6d3f5425",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/fkey8.test||test/fkey8.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 3f1c8051648a341db4dffad66d3b1f9980d8a2b314cb0ce879cb2a10d1779b84",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/fkey8.test||test/fkey8.test": [
          "File: test/fkey8.test -> test/fkey8.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "197:   INSERT OR REPLACE INTO t1 VALUES(20000, 20000);",
          "198: }",
          "200: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "200: #-------------------------------------------------------------------------",
          "201: reset_db",
          "202: do_execsql_test 5.0 {",
          "203:   PRAGMA foreign_keys = true;",
          "204:   CREATE TABLE parent(",
          "205:     p TEXT PRIMARY KEY",
          "206:   );",
          "207:   CREATE TABLE child(",
          "208:     c INTEGER UNIQUE,",
          "209:     FOREIGN KEY(c) REFERENCES parent(p) DEFERRABLE INITIALLY DEFERRED",
          "210:   );",
          "211:   BEGIN;",
          "212:     INSERT INTO child VALUES(123);",
          "213:     INSERT INTO parent VALUES('123');",
          "214:   COMMIT;",
          "215: }",
          "216: do_execsql_test 5.1 {",
          "217:   PRAGMA integrity_check;",
          "218: } {ok}",
          "220: do_execsql_test 5.2 {",
          "221:   INSERT INTO parent VALUES(1200);",
          "222:   BEGIN;",
          "223:     INSERT INTO child VALUES(456);",
          "224:     UPDATE parent SET p = '456' WHERE p=1200;",
          "225:   COMMIT;",
          "226: }",
          "227: do_execsql_test 5.3 {",
          "228:   PRAGMA integrity_check;",
          "229: } {ok}",
          "",
          "---------------"
        ]
      }
    }
  ]
}