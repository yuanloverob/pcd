{
  "cve_id": "CVE-2019-10133",
  "cve_desc": "A flaw was found in Moodle before 3.7, 3.6.4, 3.5.6, 3.4.9 and 3.1.18. The form to upload cohorts contained a redirect field, which was not restricted to internal URLs.",
  "repo": "moodle/moodle",
  "patch_hash": "c509d108216524887c7ca08b1c451054d669ea75",
  "patch_info": {
    "commit_hash": "c509d108216524887c7ca08b1c451054d669ea75",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/c509d108216524887c7ca08b1c451054d669ea75",
    "files": [
      "cohort/upload.php",
      "cohort/upload_form.php"
    ],
    "message": "MDL-64708 cohort: Return url is not used anywhere in core.",
    "before_after_code_files": [
      "cohort/upload.php||cohort/upload.php",
      "cohort/upload_form.php||cohort/upload_form.php"
    ]
  },
  "patch_diff": {
    "cohort/upload.php||cohort/upload.php": [
      "File: cohort/upload.php -> cohort/upload.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "28: require_once($CFG->libdir . '/csvlib.class.php');",
      "30: $contextid = optional_param('contextid', 0, PARAM_INT);",
      "33: require_login();",
      "",
      "[Removed Lines]",
      "31: $returnurl = optional_param('returnurl', '', PARAM_URL);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "56:     navigation_node::override_active_url(new moodle_url('/cohort/index.php', array()));",
      "57: }",
      "67: if ($uploadform->is_cancelled()) {",
      "68:     redirect($returnurl);",
      "",
      "[Removed Lines]",
      "59: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id, 'returnurl' => $returnurl));",
      "61: if ($returnurl) {",
      "62:     $returnurl = new moodle_url($returnurl);",
      "63: } else {",
      "64:     $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
      "65: }",
      "",
      "[Added Lines]",
      "58: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id));",
      "60: $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
      "",
      "---------------"
    ],
    "cohort/upload_form.php||cohort/upload_form.php": [
      "File: cohort/upload_form.php -> cohort/upload_form.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "48:         $mform = $this->_form;",
      "49:         $data  = (object)$this->_customdata;",
      "54:         $mform->addElement('header', 'cohortfileuploadform', get_string('uploadafile'));",
      "56:         $filepickeroptions = array();",
      "",
      "[Removed Lines]",
      "51:         $mform->addElement('hidden', 'returnurl');",
      "52:         $mform->setType('returnurl', PARAM_URL);",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a6258d0934f707b1d033f50fb41ffbcf45bb2102",
      "candidate_info": {
        "commit_hash": "a6258d0934f707b1d033f50fb41ffbcf45bb2102",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a6258d0934f707b1d033f50fb41ffbcf45bb2102",
        "files": [
          "cohort/upload.php",
          "cohort/upload_form.php"
        ],
        "message": "MDL-64708 cohort: Return url is not used anywhere in core.",
        "before_after_code_files": [
          "cohort/upload.php||cohort/upload.php",
          "cohort/upload_form.php||cohort/upload_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ],
          "candidate": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ]
        }
      },
      "candidate_diff": {
        "cohort/upload.php||cohort/upload.php": [
          "File: cohort/upload.php -> cohort/upload.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: require_once($CFG->libdir . '/csvlib.class.php');",
          "30: $contextid = optional_param('contextid', 0, PARAM_INT);",
          "33: require_login();",
          "",
          "[Removed Lines]",
          "31: $returnurl = optional_param('returnurl', '', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "56:     navigation_node::override_active_url(new moodle_url('/cohort/index.php', array()));",
          "57: }",
          "67: if ($uploadform->is_cancelled()) {",
          "68:     redirect($returnurl);",
          "",
          "[Removed Lines]",
          "59: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id, 'returnurl' => $returnurl));",
          "61: if ($returnurl) {",
          "62:     $returnurl = new moodle_url($returnurl);",
          "63: } else {",
          "64:     $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "65: }",
          "",
          "[Added Lines]",
          "58: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id));",
          "60: $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "",
          "---------------"
        ],
        "cohort/upload_form.php||cohort/upload_form.php": [
          "File: cohort/upload_form.php -> cohort/upload_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:         $mform = $this->_form;",
          "49:         $data  = (object)$this->_customdata;",
          "54:         $mform->addElement('header', 'cohortfileuploadform', get_string('uploadafile'));",
          "56:         $filepickeroptions = array();",
          "",
          "[Removed Lines]",
          "51:         $mform->addElement('hidden', 'returnurl');",
          "52:         $mform->setType('returnurl', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5a89ac9640b3a695720845b6ddeff65e69a289fc",
      "candidate_info": {
        "commit_hash": "5a89ac9640b3a695720845b6ddeff65e69a289fc",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/5a89ac9640b3a695720845b6ddeff65e69a289fc",
        "files": [
          "cohort/upload.php",
          "cohort/upload_form.php"
        ],
        "message": "MDL-64708 cohort: Return url is not used anywhere in core.",
        "before_after_code_files": [
          "cohort/upload.php||cohort/upload.php",
          "cohort/upload_form.php||cohort/upload_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ],
          "candidate": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ]
        }
      },
      "candidate_diff": {
        "cohort/upload.php||cohort/upload.php": [
          "File: cohort/upload.php -> cohort/upload.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: require_once($CFG->libdir . '/csvlib.class.php');",
          "30: $contextid = optional_param('contextid', 0, PARAM_INT);",
          "33: require_login();",
          "",
          "[Removed Lines]",
          "31: $returnurl = optional_param('returnurl', '', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "56:     navigation_node::override_active_url(new moodle_url('/cohort/index.php', array()));",
          "57: }",
          "67: if ($uploadform->is_cancelled()) {",
          "68:     redirect($returnurl);",
          "",
          "[Removed Lines]",
          "59: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id, 'returnurl' => $returnurl));",
          "61: if ($returnurl) {",
          "62:     $returnurl = new moodle_url($returnurl);",
          "63: } else {",
          "64:     $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "65: }",
          "",
          "[Added Lines]",
          "58: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id));",
          "60: $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "",
          "---------------"
        ],
        "cohort/upload_form.php||cohort/upload_form.php": [
          "File: cohort/upload_form.php -> cohort/upload_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:         $mform = $this->_form;",
          "49:         $data  = (object)$this->_customdata;",
          "54:         $mform->addElement('header', 'cohortfileuploadform', get_string('uploadafile'));",
          "56:         $filepickeroptions = array();",
          "",
          "[Removed Lines]",
          "51:         $mform->addElement('hidden', 'returnurl');",
          "52:         $mform->setType('returnurl', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cd6fb4322b6b1914c05f05033a71ed060f875fd4",
      "candidate_info": {
        "commit_hash": "cd6fb4322b6b1914c05f05033a71ed060f875fd4",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/cd6fb4322b6b1914c05f05033a71ed060f875fd4",
        "files": [
          "cohort/upload.php",
          "cohort/upload_form.php"
        ],
        "message": "MDL-64708 cohort: Return url is not used anywhere in core.",
        "before_after_code_files": [
          "cohort/upload.php||cohort/upload.php",
          "cohort/upload_form.php||cohort/upload_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ],
          "candidate": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ]
        }
      },
      "candidate_diff": {
        "cohort/upload.php||cohort/upload.php": [
          "File: cohort/upload.php -> cohort/upload.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: require_once($CFG->libdir . '/csvlib.class.php');",
          "30: $contextid = optional_param('contextid', 0, PARAM_INT);",
          "33: require_login();",
          "",
          "[Removed Lines]",
          "31: $returnurl = optional_param('returnurl', '', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "56:     navigation_node::override_active_url(new moodle_url('/cohort/index.php', array()));",
          "57: }",
          "67: if ($uploadform->is_cancelled()) {",
          "68:     redirect($returnurl);",
          "",
          "[Removed Lines]",
          "59: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id, 'returnurl' => $returnurl));",
          "61: if ($returnurl) {",
          "62:     $returnurl = new moodle_url($returnurl);",
          "63: } else {",
          "64:     $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "65: }",
          "",
          "[Added Lines]",
          "58: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id));",
          "60: $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "",
          "---------------"
        ],
        "cohort/upload_form.php||cohort/upload_form.php": [
          "File: cohort/upload_form.php -> cohort/upload_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:         $mform = $this->_form;",
          "49:         $data  = (object)$this->_customdata;",
          "54:         $mform->addElement('header', 'cohortfileuploadform', get_string('uploadafile'));",
          "56:         $filepickeroptions = array();",
          "",
          "[Removed Lines]",
          "51:         $mform->addElement('hidden', 'returnurl');",
          "52:         $mform->setType('returnurl', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d5067bffd230d733ad24f6aeaa56aaa17eca5bfb",
      "candidate_info": {
        "commit_hash": "d5067bffd230d733ad24f6aeaa56aaa17eca5bfb",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/d5067bffd230d733ad24f6aeaa56aaa17eca5bfb",
        "files": [
          "cohort/upload.php",
          "cohort/upload_form.php"
        ],
        "message": "MDL-64708 cohort: Return url is not used anywhere in core.",
        "before_after_code_files": [
          "cohort/upload.php||cohort/upload.php",
          "cohort/upload_form.php||cohort/upload_form.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ],
          "candidate": [
            "cohort/upload.php||cohort/upload.php",
            "cohort/upload_form.php||cohort/upload_form.php"
          ]
        }
      },
      "candidate_diff": {
        "cohort/upload.php||cohort/upload.php": [
          "File: cohort/upload.php -> cohort/upload.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: require_once($CFG->libdir . '/csvlib.class.php');",
          "30: $contextid = optional_param('contextid', 0, PARAM_INT);",
          "33: require_login();",
          "",
          "[Removed Lines]",
          "31: $returnurl = optional_param('returnurl', '', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "56:     navigation_node::override_active_url(new moodle_url('/cohort/index.php', array()));",
          "57: }",
          "67: if ($uploadform->is_cancelled()) {",
          "68:     redirect($returnurl);",
          "",
          "[Removed Lines]",
          "59: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id, 'returnurl' => $returnurl));",
          "61: if ($returnurl) {",
          "62:     $returnurl = new moodle_url($returnurl);",
          "63: } else {",
          "64:     $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "65: }",
          "",
          "[Added Lines]",
          "58: $uploadform = new cohort_upload_form(null, array('contextid' => $context->id));",
          "60: $returnurl = new moodle_url('/cohort/index.php', array('contextid' => $context->id));",
          "",
          "---------------"
        ],
        "cohort/upload_form.php||cohort/upload_form.php": [
          "File: cohort/upload_form.php -> cohort/upload_form.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "48:         $mform = $this->_form;",
          "49:         $data  = (object)$this->_customdata;",
          "54:         $mform->addElement('header', 'cohortfileuploadform', get_string('uploadafile'));",
          "56:         $filepickeroptions = array();",
          "",
          "[Removed Lines]",
          "51:         $mform->addElement('hidden', 'returnurl');",
          "52:         $mform->setType('returnurl', PARAM_URL);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}