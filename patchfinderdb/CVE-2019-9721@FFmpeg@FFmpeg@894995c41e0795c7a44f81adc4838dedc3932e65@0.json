{
  "cve_id": "CVE-2019-9721",
  "cve_desc": "A denial of service in the subtitle decoder in FFmpeg 3.2 and 4.1 allows attackers to hog the CPU via a crafted video file in Matroska format, because handle_open_brace in libavcodec/htmlsubtitles.c has a complex format argument to sscanf.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "894995c41e0795c7a44f81adc4838dedc3932e65",
  "patch_info": {
    "commit_hash": "894995c41e0795c7a44f81adc4838dedc3932e65",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/894995c41e0795c7a44f81adc4838dedc3932e65",
    "files": [
      "libavcodec/htmlsubtitles.c"
    ],
    "message": "avcodec/htmlsubtitles: Fixes denial of service due to use of sscanf in inner loop for handling braces\n\nFixes: [Semmle Security Reports #19439]\nFixes: dos_sscanf2.mkv\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
    "before_after_code_files": [
      "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
    ]
  },
  "patch_diff": {
    "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
      "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: #include \"libavutil/common.h\"",
      "25: #include \"libavutil/parseutils.h\"",
      "26: #include \"htmlsubtitles.h\"",
      "28: static int html_color_parse(void *log_ctx, const char *str)",
      "29: {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27: #include <ctype.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "44:             buf->str[--buf->len] = 0;",
      "45: }",
      "49: static void handle_open_brace(AVBPrint *dst, const char **inp, int *an, int *closing_brace_missing)",
      "50: {",
      "52:     const char *in = *inp;",
      "56:     if (!*closing_brace_missing) {",
      "57:         if (   (*an != 1 && in[1] == '\\\\')",
      "",
      "[Removed Lines]",
      "51:     int len = 0;",
      "",
      "[Added Lines]",
      "54: static int scanbraces(const char* in) {",
      "55:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
      "56:         return 0;",
      "57:     }",
      "58:     if (!isdigit(in[4])) {",
      "59:         return 0;",
      "60:     }",
      "61:     if (in[5] != '}') {",
      "62:         return 0;",
      "63:     }",
      "64:     return 1;",
      "65: }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f7f3937494f6734d27fc3d0081c9c7a9a19614a8",
      "candidate_info": {
        "commit_hash": "f7f3937494f6734d27fc3d0081c9c7a9a19614a8",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/f7f3937494f6734d27fc3d0081c9c7a9a19614a8",
        "files": [
          "libavcodec/htmlsubtitles.c"
        ],
        "message": "avcodec/htmlsubtitles: Fixes denial of service due to use of sscanf in inner loop for handling braces\n\nFixes: [Semmle Security Reports #19439]\nFixes: dos_sscanf2.mkv\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 894995c41e0795c7a44f81adc4838dedc3932e65)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ],
          "candidate": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
          "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"libavutil/common.h\"",
          "25: #include \"libavutil/parseutils.h\"",
          "26: #include \"htmlsubtitles.h\"",
          "28: static int html_color_parse(void *log_ctx, const char *str)",
          "29: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include <ctype.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44:             buf->str[--buf->len] = 0;",
          "45: }",
          "49: static void handle_open_brace(AVBPrint *dst, const char **inp, int *an, int *closing_brace_missing)",
          "50: {",
          "52:     const char *in = *inp;",
          "56:     if (!*closing_brace_missing) {",
          "57:         if (   (*an != 1 && in[1] == '\\\\')",
          "",
          "[Removed Lines]",
          "51:     int len = 0;",
          "",
          "[Added Lines]",
          "54: static int scanbraces(const char* in) {",
          "55:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
          "56:         return 0;",
          "57:     }",
          "58:     if (!isdigit(in[4])) {",
          "59:         return 0;",
          "60:     }",
          "61:     if (in[5] != '}') {",
          "62:         return 0;",
          "63:     }",
          "64:     return 1;",
          "65: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e2ae3419ff47b66a2a9a93c0cdf81155c70f2b3c",
      "candidate_info": {
        "commit_hash": "e2ae3419ff47b66a2a9a93c0cdf81155c70f2b3c",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e2ae3419ff47b66a2a9a93c0cdf81155c70f2b3c",
        "files": [
          "libavcodec/htmlsubtitles.c"
        ],
        "message": "avcodec/htmlsubtitles: Fixes denial of service due to use of sscanf in inner loop for handling braces\n\nFixes: [Semmle Security Reports #19439]\nFixes: dos_sscanf2.mkv\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 894995c41e0795c7a44f81adc4838dedc3932e65)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ],
          "candidate": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
          "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"libavutil/common.h\"",
          "25: #include \"libavutil/parseutils.h\"",
          "26: #include \"htmlsubtitles.h\"",
          "28: static int html_color_parse(void *log_ctx, const char *str)",
          "29: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include <ctype.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44:             buf->str[--buf->len] = 0;",
          "45: }",
          "49: static void handle_open_brace(AVBPrint *dst, const char **inp, int *an, int *closing_brace_missing)",
          "50: {",
          "52:     const char *in = *inp;",
          "56:     if (!*closing_brace_missing) {",
          "57:         if (   (*an != 1 && in[1] == '\\\\')",
          "",
          "[Removed Lines]",
          "51:     int len = 0;",
          "",
          "[Added Lines]",
          "54: static int scanbraces(const char* in) {",
          "55:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
          "56:         return 0;",
          "57:     }",
          "58:     if (!isdigit(in[4])) {",
          "59:         return 0;",
          "60:     }",
          "61:     if (in[5] != '}') {",
          "62:         return 0;",
          "63:     }",
          "64:     return 1;",
          "65: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "273f2755ce8635d42da3cde0eeba15b2e7842774",
      "candidate_info": {
        "commit_hash": "273f2755ce8635d42da3cde0eeba15b2e7842774",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/273f2755ce8635d42da3cde0eeba15b2e7842774",
        "files": [
          "libavcodec/htmlsubtitles.c"
        ],
        "message": "avcodec/htmlsubtitles: Fixes denial of service due to use of sscanf in inner loop for handling braces\n\nFixes: [Semmle Security Reports #19439]\nFixes: dos_sscanf2.mkv\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 894995c41e0795c7a44f81adc4838dedc3932e65)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ],
          "candidate": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
          "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: #include \"libavutil/common.h\"",
          "23: #include \"libavutil/parseutils.h\"",
          "24: #include \"htmlsubtitles.h\"",
          "26: static int html_color_parse(void *log_ctx, const char *str)",
          "27: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25: #include <ctype.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "51:             buf->str[--buf->len] = 0;",
          "52: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "61: static int scanbraces(const char* in) {",
          "62:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
          "63:         return 0;",
          "64:     }",
          "65:     if (!isdigit(in[4])) {",
          "66:         return 0;",
          "67:     }",
          "68:     if (in[5] != '}') {",
          "69:         return 0;",
          "70:     }",
          "71:     return 1;",
          "72: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "110:             break;",
          "111:         case '{':    /* skip all {\\xxx} substrings except for {\\an%d}",
          "116:             if (!closing_brace_missing) {",
          "117:                 if (   (an != 1 && in[1] == '\\\\')",
          "118:                     || (in[1] && strchr(\"CcFfoPSsYy\", in[1]) && in[2] == ':')) {",
          "",
          "[Removed Lines]",
          "113:             len = 0;",
          "114:             an += sscanf(in, \"{\\\\an%*1u}%n\", &len) >= 0 && len > 0;",
          "",
          "[Added Lines]",
          "133:             an += scanbraces(in);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7dc5c930354c4339ce36a6cc4f2113c9cfd294f5",
      "candidate_info": {
        "commit_hash": "7dc5c930354c4339ce36a6cc4f2113c9cfd294f5",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/7dc5c930354c4339ce36a6cc4f2113c9cfd294f5",
        "files": [
          "libavcodec/htmlsubtitles.c"
        ],
        "message": "avcodec/htmlsubtitles: Fixes denial of service due to use of sscanf in inner loop for handling braces\n\nFixes: [Semmle Security Reports #19439]\nFixes: dos_sscanf2.mkv\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n(cherry picked from commit 894995c41e0795c7a44f81adc4838dedc3932e65)\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ],
          "candidate": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
          "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include \"libavutil/common.h\"",
          "25: #include \"libavutil/parseutils.h\"",
          "26: #include \"htmlsubtitles.h\"",
          "28: static int html_color_parse(void *log_ctx, const char *str)",
          "29: {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include <ctype.h>",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "44:             buf->str[--buf->len] = 0;",
          "45: }",
          "49: static void handle_open_brace(AVBPrint *dst, const char **inp, int *an, int *closing_brace_missing)",
          "50: {",
          "52:     const char *in = *inp;",
          "56:     if (!*closing_brace_missing) {",
          "57:         if (   (*an != 1 && in[1] == '\\\\')",
          "",
          "[Removed Lines]",
          "51:     int len = 0;",
          "",
          "[Added Lines]",
          "54: static int scanbraces(const char* in) {",
          "55:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
          "56:         return 0;",
          "57:     }",
          "58:     if (!isdigit(in[4])) {",
          "59:         return 0;",
          "60:     }",
          "61:     if (in[5] != '}') {",
          "62:         return 0;",
          "63:     }",
          "64:     return 1;",
          "65: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b94cf549e2d9e456d77f8539baca0fffa805ba69",
      "candidate_info": {
        "commit_hash": "b94cf549e2d9e456d77f8539baca0fffa805ba69",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b94cf549e2d9e456d77f8539baca0fffa805ba69",
        "files": [
          "libavcodec/htmlsubtitles.c"
        ],
        "message": "avcodec/htmlsubtitles: Avoid locale dependant isdigit()\n\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>",
        "before_after_code_files": [
          "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ],
          "candidate": [
            "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/htmlsubtitles.c||libavcodec/htmlsubtitles.c": [
          "File: libavcodec/htmlsubtitles.c -> libavcodec/htmlsubtitles.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "55:     if (strncmp(in, \"{\\\\an\", 4) != 0) {",
          "56:         return 0;",
          "57:     }",
          "59:         return 0;",
          "60:     }",
          "61:     if (in[5] != '}') {",
          "",
          "[Removed Lines]",
          "58:     if (!isdigit(in[4])) {",
          "",
          "[Added Lines]",
          "58:     if (!av_isdigit(in[4])) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}