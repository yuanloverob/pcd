{
  "cve_id": "CVE-2014-9316",
  "cve_desc": "The mjpeg_decode_app function in libavcodec/mjpegdec.c in FFMpeg before 2.1.6, 2.2.x through 2.3.x, and 2.4.x before 2.4.4 allows remote attackers to cause a denial of service (out-of-bounds heap access) and possibly have other unspecified impact via vectors related to LJIF tags in an MJPEG file.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "0eecf40935b22644e6cd74c586057237ecfd6844",
  "patch_info": {
    "commit_hash": "0eecf40935b22644e6cd74c586057237ecfd6844",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/0eecf40935b22644e6cd74c586057237ecfd6844",
    "files": [
      "libavcodec/mjpegdec.c"
    ],
    "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
      "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1620:     }",
      "1622:     if (id == AV_RB32(\"LJIF\")) {",
      "1623:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
      "1624:             av_log(s->avctx, AV_LOG_INFO,",
      "1625:                    \"Pegasus lossless jpeg header found\\n\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1623:         int rgb = s->rgb;",
      "1624:         int pegasus_rct = s->pegasus_rct;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1630:         switch (i=get_bits(&s->gb, 8)) {",
      "1631:         case 1:",
      "1634:             break;",
      "1635:         case 2:",
      "1638:             break;",
      "1639:         default:",
      "1640:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
      "1641:         }",
      "1642:         len -= 9;",
      "1643:         goto out;",
      "1644:     }",
      "1645:     if (id == AV_RL32(\"colr\") && len > 0) {",
      "",
      "[Removed Lines]",
      "1632:             s->rgb         = 1;",
      "1633:             s->pegasus_rct = 0;",
      "1636:             s->rgb         = 1;",
      "1637:             s->pegasus_rct = 1;",
      "",
      "[Added Lines]",
      "1634:             rgb         = 1;",
      "1635:             pegasus_rct = 0;",
      "1638:             rgb         = 1;",
      "1639:             pegasus_rct = 1;",
      "1646:         if (s->got_picture)",
      "1647:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
      "1648:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
      "1649:                 goto out;",
      "1650:             }",
      "1652:         s->rgb = rgb;",
      "1653:         s->pegasus_rct = pegasus_rct;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5d6f8bab02ba6d8434188172b31a4e1ac0a00756",
      "candidate_info": {
        "commit_hash": "5d6f8bab02ba6d8434188172b31a4e1ac0a00756",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/5d6f8bab02ba6d8434188172b31a4e1ac0a00756",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1553:     }",
          "1555:     if (id == AV_RB32(\"LJIF\")) {",
          "1556:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1557:             av_log(s->avctx, AV_LOG_INFO,",
          "1558:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1556:         int rgb = s->rgb;",
          "1557:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1563:         switch (i=get_bits(&s->gb, 8)) {",
          "1564:         case 1:",
          "1567:             break;",
          "1568:         case 2:",
          "1571:             break;",
          "1572:         default:",
          "1573:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
          "1574:         }",
          "1575:         len -= 9;",
          "1576:         goto out;",
          "1577:     }",
          "1578:     if (id == AV_RL32(\"colr\") && len > 0) {",
          "",
          "[Removed Lines]",
          "1565:             s->rgb         = 1;",
          "1566:             s->pegasus_rct = 0;",
          "1569:             s->rgb         = 1;",
          "1570:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1567:             rgb         = 1;",
          "1568:             pegasus_rct = 0;",
          "1571:             rgb         = 1;",
          "1572:             pegasus_rct = 1;",
          "1579:         if (s->got_picture)",
          "1580:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1581:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1582:                 goto out;",
          "1583:             }",
          "1585:         s->rgb = rgb;",
          "1586:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "aebfcf7d6258760af42e84ab146f592fbfb6395c",
      "candidate_info": {
        "commit_hash": "aebfcf7d6258760af42e84ab146f592fbfb6395c",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/aebfcf7d6258760af42e84ab146f592fbfb6395c",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nConflicts:\n\n\tlibavcodec/mjpegdec.c\n(cherry picked from commit 32d3acac727f3f4a6489ca129a5ea4ccdfcb34a5)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1376:     }",
          "1378:     if (id == AV_RL32(\"LJIF\")) {",
          "1379:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1380:             av_log(s->avctx, AV_LOG_INFO,",
          "1381:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1379:         int rgb = s->rgb;",
          "1380:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1386:         switch (get_bits(&s->gb, 8)) {",
          "1387:         case 1:",
          "1390:             break;",
          "1391:         case 2:",
          "1394:             break;",
          "1395:         default:",
          "1396:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "1397:         }",
          "1398:         len -= 9;",
          "1399:         goto out;",
          "1400:     }",
          "",
          "[Removed Lines]",
          "1388:             s->rgb         = 1;",
          "1389:             s->pegasus_rct = 0;",
          "1392:             s->rgb         = 1;",
          "1393:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1390:             rgb         = 1;",
          "1391:             pegasus_rct = 0;",
          "1394:             rgb         = 1;",
          "1395:             pegasus_rct = 1;",
          "1402:         if (s->got_picture)",
          "1403:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1404:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1405:                 goto out;",
          "1406:             }",
          "1408:         s->rgb = rgb;",
          "1409:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b4ce4f94e781af9d41e557aca3f393bfb93a79cc",
      "candidate_info": {
        "commit_hash": "b4ce4f94e781af9d41e557aca3f393bfb93a79cc",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/b4ce4f94e781af9d41e557aca3f393bfb93a79cc",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1528:     }",
          "1530:     if (id == AV_RB32(\"LJIF\")) {",
          "1531:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1532:             av_log(s->avctx, AV_LOG_INFO,",
          "1533:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1531:         int rgb = s->rgb;",
          "1532:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1538:         switch (i=get_bits(&s->gb, 8)) {",
          "1539:         case 1:",
          "1542:             break;",
          "1543:         case 2:",
          "1546:             break;",
          "1547:         default:",
          "1548:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
          "1549:         }",
          "1550:         len -= 9;",
          "1551:         goto out;",
          "1552:     }",
          "1553:     if (id == AV_RL32(\"colr\") && len > 0) {",
          "",
          "[Removed Lines]",
          "1540:             s->rgb         = 1;",
          "1541:             s->pegasus_rct = 0;",
          "1544:             s->rgb         = 1;",
          "1545:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1542:             rgb         = 1;",
          "1543:             pegasus_rct = 0;",
          "1546:             rgb         = 1;",
          "1547:             pegasus_rct = 1;",
          "1554:         if (s->got_picture)",
          "1555:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1556:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1557:                 goto out;",
          "1558:             }",
          "1560:         s->rgb = rgb;",
          "1561:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6c28673cb3648d49117c6bfa4ed89ead157b1c22",
      "candidate_info": {
        "commit_hash": "6c28673cb3648d49117c6bfa4ed89ead157b1c22",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/6c28673cb3648d49117c6bfa4ed89ead157b1c22",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1437:     }",
          "1439:     if (id == AV_RB32(\"LJIF\")) {",
          "1440:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1441:             av_log(s->avctx, AV_LOG_INFO,",
          "1442:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1440:         int rgb = s->rgb;",
          "1441:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1447:         switch (get_bits(&s->gb, 8)) {",
          "1448:         case 1:",
          "1451:             break;",
          "1452:         case 2:",
          "1455:             break;",
          "1456:         default:",
          "1457:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "1458:         }",
          "1459:         len -= 9;",
          "1460:         goto out;",
          "1461:     }",
          "",
          "[Removed Lines]",
          "1449:             s->rgb         = 1;",
          "1450:             s->pegasus_rct = 0;",
          "1453:             s->rgb         = 1;",
          "1454:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1451:             rgb         = 1;",
          "1452:             pegasus_rct = 0;",
          "1455:             rgb         = 1;",
          "1456:             pegasus_rct = 1;",
          "1463:         if (s->got_picture)",
          "1464:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1465:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1466:                 goto out;",
          "1467:             }",
          "1469:         s->rgb = rgb;",
          "1470:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cb026ac30364db99faa39041f38b4671928c6cfe",
      "candidate_info": {
        "commit_hash": "cb026ac30364db99faa39041f38b4671928c6cfe",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/cb026ac30364db99faa39041f38b4671928c6cfe",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: make \"unknown colorspace\" error more informative\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1477:         case 1:",
          "1478:             s->rgb         = 1;",
          "1479:             s->pegasus_rct = 0;",
          "",
          "[Removed Lines]",
          "1476:         switch (get_bits(&s->gb, 8)) {",
          "",
          "[Added Lines]",
          "1476:         switch (i=get_bits(&s->gb, 8)) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1483:             s->pegasus_rct = 1;",
          "1484:             break;",
          "1485:         default:",
          "1487:         }",
          "1488:         len -= 9;",
          "1489:         goto out;",
          "",
          "[Removed Lines]",
          "1486:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "",
          "[Added Lines]",
          "1486:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
          "",
          "---------------"
        ]
      }
    }
  ]
}