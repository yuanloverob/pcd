{
  "cve_id": "CVE-2015-0215",
  "cve_desc": "calendar/externallib.php in Moodle through 2.5.9, 2.6.x before 2.6.7, 2.7.x before 2.7.4, and 2.8.x before 2.8.2 allows remote authenticated users to obtain sensitive calendar-event information via a web-services request.",
  "repo": "moodle/moodle",
  "patch_hash": "76aea854f6877cc5accb288bc6ac60bc55d30788",
  "patch_info": {
    "commit_hash": "76aea854f6877cc5accb288bc6ac60bc55d30788",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/76aea854f6877cc5accb288bc6ac60bc55d30788",
    "files": [
      "calendar/externallib.php"
    ],
    "message": "MDL-48017 core_calendar: add context validation to get_calendar_events",
    "before_after_code_files": [
      "calendar/externallib.php||calendar/externallib.php"
    ]
  },
  "patch_diff": {
    "calendar/externallib.php||calendar/externallib.php": [
      "File: calendar/externallib.php -> calendar/externallib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "175:         if (!$hassystemcap) {",
      "178:             foreach ($params['events']['courseids'] as $id) {",
      "180:                     $funcparam['courses'][] = $id;",
      "183:                 }",
      "184:             }",
      "185:         } else {",
      "",
      "[Removed Lines]",
      "176:             $courses = enrol_get_my_courses();",
      "177:             $courses = array_keys($courses);",
      "179:                 if (in_array($id, $courses)) {",
      "181:                 } else {",
      "182:                     $warnings[] = array('item' => $id, 'warningcode' => 'nopermissions', 'message' => 'you do not have permissions to access this course');",
      "",
      "[Added Lines]",
      "177:                try {",
      "178:                     $context = context_course::instance($id);",
      "179:                     self::validate_context($context);",
      "181:                 } catch (Exception $e) {",
      "182:                     $warnings[] = array(",
      "183:                         'item' => 'course',",
      "184:                         'itemid' => $id,",
      "185:                         'warningcode' => 'nopermissions',",
      "186:                         'message' => 'No access rights in course context '.$e->getMessage().$e->getTraceAsString()",
      "187:                     );",
      "188:                     continue;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "88929ca82476f85fd73fd3f0e6e4b0a86b3b46c6",
      "candidate_info": {
        "commit_hash": "88929ca82476f85fd73fd3f0e6e4b0a86b3b46c6",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/88929ca82476f85fd73fd3f0e6e4b0a86b3b46c6",
        "files": [
          "calendar/externallib.php"
        ],
        "message": "MDL-48017 core_calendar: add context validation to get_calendar_events",
        "before_after_code_files": [
          "calendar/externallib.php||calendar/externallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "calendar/externallib.php||calendar/externallib.php"
          ],
          "candidate": [
            "calendar/externallib.php||calendar/externallib.php"
          ]
        }
      },
      "candidate_diff": {
        "calendar/externallib.php||calendar/externallib.php": [
          "File: calendar/externallib.php -> calendar/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "175:         if (!$hassystemcap) {",
          "178:             foreach ($params['events']['courseids'] as $id) {",
          "180:                     $funcparam['courses'][] = $id;",
          "183:                 }",
          "184:             }",
          "185:         } else {",
          "",
          "[Removed Lines]",
          "176:             $courses = enrol_get_my_courses();",
          "177:             $courses = array_keys($courses);",
          "179:                 if (in_array($id, $courses)) {",
          "181:                 } else {",
          "182:                     $warnings[] = array('item' => $id, 'warningcode' => 'nopermissions', 'message' => 'you do not have permissions to access this course');",
          "",
          "[Added Lines]",
          "177:                try {",
          "178:                     $context = context_course::instance($id);",
          "179:                     self::validate_context($context);",
          "181:                 } catch (Exception $e) {",
          "182:                     $warnings[] = array(",
          "183:                         'item' => 'course',",
          "184:                         'itemid' => $id,",
          "185:                         'warningcode' => 'nopermissions',",
          "186:                         'message' => 'No access rights in course context '.$e->getMessage().$e->getTraceAsString()",
          "187:                     );",
          "188:                     continue;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ae4a17183a8db0089f28797c7f2e8daf64689750",
      "candidate_info": {
        "commit_hash": "ae4a17183a8db0089f28797c7f2e8daf64689750",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/ae4a17183a8db0089f28797c7f2e8daf64689750",
        "files": [
          "calendar/externallib.php"
        ],
        "message": "MDL-48017 core_calendar: add context validation to get_calendar_events",
        "before_after_code_files": [
          "calendar/externallib.php||calendar/externallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "calendar/externallib.php||calendar/externallib.php"
          ],
          "candidate": [
            "calendar/externallib.php||calendar/externallib.php"
          ]
        }
      },
      "candidate_diff": {
        "calendar/externallib.php||calendar/externallib.php": [
          "File: calendar/externallib.php -> calendar/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "175:         if (!$hassystemcap) {",
          "178:             foreach ($params['events']['courseids'] as $id) {",
          "180:                     $funcparam['courses'][] = $id;",
          "183:                 }",
          "184:             }",
          "185:         } else {",
          "",
          "[Removed Lines]",
          "176:             $courses = enrol_get_my_courses();",
          "177:             $courses = array_keys($courses);",
          "179:                 if (in_array($id, $courses)) {",
          "181:                 } else {",
          "182:                     $warnings[] = array('item' => $id, 'warningcode' => 'nopermissions', 'message' => 'you do not have permissions to access this course');",
          "",
          "[Added Lines]",
          "177:                try {",
          "178:                     $context = context_course::instance($id);",
          "179:                     self::validate_context($context);",
          "181:                 } catch (Exception $e) {",
          "182:                     $warnings[] = array(",
          "183:                         'item' => 'course',",
          "184:                         'itemid' => $id,",
          "185:                         'warningcode' => 'nopermissions',",
          "186:                         'message' => 'No access rights in course context '.$e->getMessage().$e->getTraceAsString()",
          "187:                     );",
          "188:                     continue;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cdb4e29e579c98e60a05d370b8c2aa0588bc312d",
      "candidate_info": {
        "commit_hash": "cdb4e29e579c98e60a05d370b8c2aa0588bc312d",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/cdb4e29e579c98e60a05d370b8c2aa0588bc312d",
        "files": [
          "calendar/externallib.php"
        ],
        "message": "MDL-48017 core_calendar: add context validation to get_calendar_events",
        "before_after_code_files": [
          "calendar/externallib.php||calendar/externallib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "calendar/externallib.php||calendar/externallib.php"
          ],
          "candidate": [
            "calendar/externallib.php||calendar/externallib.php"
          ]
        }
      },
      "candidate_diff": {
        "calendar/externallib.php||calendar/externallib.php": [
          "File: calendar/externallib.php -> calendar/externallib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "175:         if (!$hassystemcap) {",
          "178:             foreach ($params['events']['courseids'] as $id) {",
          "180:                     $funcparam['courses'][] = $id;",
          "183:                 }",
          "184:             }",
          "185:         } else {",
          "",
          "[Removed Lines]",
          "176:             $courses = enrol_get_my_courses();",
          "177:             $courses = array_keys($courses);",
          "179:                 if (in_array($id, $courses)) {",
          "181:                 } else {",
          "182:                     $warnings[] = array('item' => $id, 'warningcode' => 'nopermissions', 'message' => 'you do not have permissions to access this course');",
          "",
          "[Added Lines]",
          "177:                try {",
          "178:                     $context = context_course::instance($id);",
          "179:                     self::validate_context($context);",
          "181:                 } catch (Exception $e) {",
          "182:                     $warnings[] = array(",
          "183:                         'item' => 'course',",
          "184:                         'itemid' => $id,",
          "185:                         'warningcode' => 'nopermissions',",
          "186:                         'message' => 'No access rights in course context '.$e->getMessage().$e->getTraceAsString()",
          "187:                     );",
          "188:                     continue;",
          "",
          "---------------"
        ]
      }
    }
  ]
}