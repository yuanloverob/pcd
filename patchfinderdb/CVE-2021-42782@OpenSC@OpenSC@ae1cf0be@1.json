{
  "cve_id": "CVE-2021-42782",
  "cve_desc": "Stack buffer overflow issues were found in Opensc before version 0.22.0 in various places that could potentially crash programs using the library.",
  "repo": "OpenSC/OpenSC",
  "patch_hash": "ae1cf0be90396fb6c0be95829bf0d3eecbd2fd1c",
  "patch_info": {
    "commit_hash": "ae1cf0be90396fb6c0be95829bf0d3eecbd2fd1c",
    "repo": "OpenSC/OpenSC",
    "commit_url": "https://github.com/OpenSC/OpenSC/commit/ae1cf0be90396fb6c0be95829bf0d3eecbd2fd1c",
    "files": [
      "src/libopensc/card-iasecc.c"
    ],
    "message": "iasecc: Prevent stack buffer overflow when empty ACL is returned\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=30800",
    "before_after_code_files": [
      "src/libopensc/card-iasecc.c||src/libopensc/card-iasecc.c"
    ]
  },
  "patch_diff": {
    "src/libopensc/card-iasecc.c||src/libopensc/card-iasecc.c": [
      "File: src/libopensc/card-iasecc.c -> src/libopensc/card-iasecc.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1171:  else",
      "1172:   acls = sc_asn1_find_tag(ctx, buf, buflen, IASECC_DOCP_TAG_ACLS_CONTACT, &taglen);",
      "1175:   sc_log(ctx,",
      "1176:          \"ACLs not found in data(%\"SC_FORMAT_LEN_SIZE_T\"u) %s\",",
      "1177:          buflen, sc_dump_hex(buf, buflen));",
      "",
      "[Removed Lines]",
      "1174:  if (!acls)   {",
      "",
      "[Added Lines]",
      "1174:  if (!acls || taglen < 7)   {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9c91a4327e6db579f7f964f147fd6e94a0e1b85e",
      "candidate_info": {
        "commit_hash": "9c91a4327e6db579f7f964f147fd6e94a0e1b85e",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/9c91a4327e6db579f7f964f147fd6e94a0e1b85e",
        "files": [
          "src/libopensc/pkcs15-oberthur.c"
        ],
        "message": "oberthur: Free another read data on failure paths",
        "before_after_code_files": [
          "src/libopensc/pkcs15-oberthur.c||src/libopensc/pkcs15-oberthur.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2219"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/libopensc/pkcs15-oberthur.c||src/libopensc/pkcs15-oberthur.c": [
          "File: src/libopensc/pkcs15-oberthur.c -> src/libopensc/pkcs15-oberthur.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "876:  rv = sc_oberthur_read_file(p15card, ch_tmp, &info_blob, &info_len, 1);",
          "877:  LOG_TEST_RET(ctx, rv, \"Failed to add data: read oberthur file error\");",
          "880:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add certificate: no 'tag'\");",
          "881:  flags = *(info_blob + 0) * 0x100 + *(info_blob + 1);",
          "882:  offs = 2;",
          "886:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: no 'label'\");",
          "887:  label = info_blob + offs + 2;",
          "888:  label_len = *(info_blob + offs + 1) + *(info_blob + offs) * 0x100;",
          "889:  if (label_len > sizeof(dobj.label) - 1)",
          "",
          "[Removed Lines]",
          "879:  if (info_len < 2)",
          "885:  if (offs > info_len)",
          "",
          "[Added Lines]",
          "879:  if (info_len < 2) {",
          "880:   free(info_blob);",
          "882:  }",
          "887:  if (offs > info_len) {",
          "888:   free(info_blob);",
          "890:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "891:  offs += 2 + *(info_blob + offs + 1);",
          "895:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: no 'application'\");",
          "896:  app = info_blob + offs + 2;",
          "897:  app_len = *(info_blob + offs + 1) + *(info_blob + offs) * 0x100;",
          "898:  if (app_len > sizeof(dinfo.app_label) - 1)",
          "",
          "[Removed Lines]",
          "894:  if (offs > info_len)",
          "",
          "[Added Lines]",
          "898:  if (offs > info_len) {",
          "899:   free(info_blob);",
          "901:  }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "900:  offs += 2 + app_len;",
          "904:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: no 'OID'\");",
          "905:  oid_len = *(info_blob + offs + 1) + *(info_blob + offs) * 0x100;",
          "906:  if (oid_len)   {",
          "907:   oid = info_blob + offs + 2;",
          "909:    LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: invalid 'OID' format\");",
          "910:   oid += 2;",
          "911:   oid_len -= 2;",
          "912:  }",
          "",
          "[Removed Lines]",
          "903:  if (offs > info_len)",
          "908:   if (*oid != 0x06 || (*(oid + 1) != oid_len - 2))",
          "",
          "[Added Lines]",
          "909:  if (offs > info_len) {",
          "910:   free(info_blob);",
          "912:  }",
          "916:   if (*oid != 0x06 || (*(oid + 1) != oid_len - 2)) {",
          "917:    free(info_blob);",
          "919:   }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "934:  rv = sc_pkcs15emu_add_data_object(p15card, &dobj, &dinfo);",
          "936:  LOG_FUNC_RETURN(p15card->card->ctx, rv);",
          "937: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "946:  free(info_blob);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1dbe4b5a5b45b044bb9787bcfe4d093b10b455c1",
      "candidate_info": {
        "commit_hash": "1dbe4b5a5b45b044bb9787bcfe4d093b10b455c1",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/1dbe4b5a5b45b044bb9787bcfe4d093b10b455c1",
        "files": [
          "src/pkcs15init/pkcs15-isoApplet.c"
        ],
        "message": "isoApplet: Prevent reading uninitialized values\n\nCID 365823\n\nThanks coverity",
        "before_after_code_files": [
          "src/pkcs15init/pkcs15-isoApplet.c||src/pkcs15init/pkcs15-isoApplet.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2219"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/pkcs15init/pkcs15-isoApplet.c||src/pkcs15init/pkcs15-isoApplet.c": [
          "File: src/pkcs15init/pkcs15-isoApplet.c -> src/pkcs15init/pkcs15-isoApplet.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "359:  LOG_FUNC_CALLED(card->ctx);",
          "362:  keybits = key_info->modulus_length;",
          "363:  if (keybits != 2048)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "361:  memset(&args, 0, sizeof(args));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "374:  args.algorithm_ref = SC_ISOAPPLET_ALG_REF_RSA_GEN_2048;",
          "375:  args.priv_key_ref = key_info->key_reference;",
          "",
          "[Removed Lines]",
          "373:  memset(&args, 0, sizeof(args));",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "46cfe89b3c3cf325bcbd4f6a9ef001d5a647144b",
      "candidate_info": {
        "commit_hash": "46cfe89b3c3cf325bcbd4f6a9ef001d5a647144b",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/46cfe89b3c3cf325bcbd4f6a9ef001d5a647144b",
        "files": [
          "src/pkcs15init/pkcs15-iasecc.c"
        ],
        "message": "pkcs15-iasecc: Avoid memory leak\n\nThanks coverity\n\nCID 365818",
        "before_after_code_files": [
          "src/pkcs15init/pkcs15-iasecc.c||src/pkcs15init/pkcs15-iasecc.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2219"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/pkcs15init/pkcs15-iasecc.c||src/pkcs15init/pkcs15-iasecc.c": [
          "File: src/pkcs15init/pkcs15-iasecc.c -> src/pkcs15init/pkcs15-iasecc.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1485:  rv = sc_pkcs15_read_data_object(p15card, (struct sc_pkcs15_data_info *)data_obj->data, &dod);",
          "1486:  LOG_TEST_RET(ctx, rv, \"Cannot read from 'CSP/'Default Key Container'\");",
          "1489:   LOG_FUNC_RETURN(ctx, SC_SUCCESS);",
          "1491:  rv = sc_pkcs15_get_objects(p15card, SC_PKCS15_TYPE_PRKEY, key_objs, 32);",
          "1492:  LOG_TEST_RET(ctx, rv, \"Get private key PKCS#15 objects error\");",
          "",
          "[Removed Lines]",
          "1488:  if (guid_len != dod->data_len || memcmp(guid, dod->data, guid_len))",
          "",
          "[Added Lines]",
          "1488:  if (guid_len != dod->data_len || memcmp(guid, dod->data, guid_len)) {",
          "1489:   sc_pkcs15_free_data_object(dod);",
          "1491:  }",
          "1492:  sc_pkcs15_free_data_object(dod);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "17d8980cde7be597afc366b7e311d0d7cadcb1f4",
      "candidate_info": {
        "commit_hash": "17d8980cde7be597afc366b7e311d0d7cadcb1f4",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/17d8980cde7be597afc366b7e311d0d7cadcb1f4",
        "files": [
          "src/libopensc/pkcs15-oberthur.c"
        ],
        "message": "oberthur: Avoid two buffer overflows\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=30112",
        "before_after_code_files": [
          "src/libopensc/pkcs15-oberthur.c||src/libopensc/pkcs15-oberthur.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2219"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/libopensc/pkcs15-oberthur.c||src/libopensc/pkcs15-oberthur.c": [
          "File: src/libopensc/pkcs15-oberthur.c -> src/libopensc/pkcs15-oberthur.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "884:  offs = 2;",
          "888:   free(info_blob);",
          "889:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: no 'label'\");",
          "890:  }",
          "891:  label = info_blob + offs + 2;",
          "892:  label_len = *(info_blob + offs + 1) + *(info_blob + offs) * 0x100;",
          "893:  if (label_len > sizeof(dobj.label) - 1)",
          "894:   label_len = sizeof(dobj.label) - 1;",
          "895:  offs += 2 + *(info_blob + offs + 1);",
          "",
          "[Removed Lines]",
          "887:  if (offs > info_len) {",
          "",
          "[Added Lines]",
          "887:  if (offs + 2 > info_len) {",
          "893:  if (offs + 2 + label_len > info_len) {",
          "894:   free(info_blob);",
          "895:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Invalid length of 'label' received\");",
          "896:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "906:  offs += 2 + app_len;",
          "910:   free(info_blob);",
          "911:   LOG_TEST_RET(ctx, SC_ERROR_UNKNOWN_DATA_RECEIVED, \"Failed to add data: no 'OID'\");",
          "912:  }",
          "",
          "[Removed Lines]",
          "909:  if (offs > info_len) {",
          "",
          "[Added Lines]",
          "913:  if (offs + 1 > info_len) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7ba89daae6b5ad8a78c4bf7e10796953a9017313",
      "candidate_info": {
        "commit_hash": "7ba89daae6b5ad8a78c4bf7e10796953a9017313",
        "repo": "OpenSC/OpenSC",
        "commit_url": "https://github.com/OpenSC/OpenSC/commit/7ba89daae6b5ad8a78c4bf7e10796953a9017313",
        "files": [
          "src/libopensc/apdu.c"
        ],
        "message": "apdu: Do not insert delay while fuzzing\n\nThis was timeout after 60 seconds. After skipping this call, we\nget down to 1 s for the same input\n\nThanks oss-fuzz\n\nhttps://bugs.chromium.org/p/oss-fuzz/issues/detail?id=27423",
        "before_after_code_files": [
          "src/libopensc/apdu.c||src/libopensc/apdu.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/OpenSC/OpenSC/pull/2219"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "src/libopensc/apdu.c||src/libopensc/apdu.c": [
          "File: src/libopensc/apdu.c -> src/libopensc/apdu.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "402:  apdu->resplen = olen;",
          "403:  apdu->le      = nlen;",
          "407:  if (card->type == SC_CARD_TYPE_BELPIC_EID)",
          "408:   msleep(40);",
          "411:  rv = sc_single_transmit(card, apdu);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "404: #ifndef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION",
          "410: #endif",
          "",
          "---------------"
        ]
      }
    }
  ]
}