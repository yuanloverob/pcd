{
  "cve_id": "CVE-2019-20218",
  "cve_desc": "selectExpander in select.c in SQLite 3.30.1 proceeds with WITH stack unwinding even after a parsing error.",
  "repo": "sqlite/sqlite",
  "patch_hash": "a6c1a71cde082e09750465d5675699062922e387",
  "patch_info": {
    "commit_hash": "a6c1a71cde082e09750465d5675699062922e387",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/a6c1a71cde082e09750465d5675699062922e387",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/altertab3.test"
    ],
    "message": "Do not attempt to unwind the WITH stack in the Parse object following an error. This fixes a separate case to [de6e6d68].\n\nFossilOrigin-Name: d29edef93451cc67a5d69c1cce1b1832d9ca8fff1f600afdd51338b74d077b92",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/altertab3.test||test/altertab3.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 597896ed0ae9e2960a8f39576bd7f77a11dccc1da84b6a44ebb5c38d90ebc330",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4982:     return WRC_Abort;",
      "4983:   }",
      "",
      "[Removed Lines]",
      "4981:   if( db->mallocFailed || sqliteProcessJoin(pParse, p) ){",
      "",
      "[Added Lines]",
      "4981:   if( pParse->nErr || db->mallocFailed || sqliteProcessJoin(pParse, p) ){",
      "",
      "---------------"
    ],
    "test/altertab3.test||test/altertab3.test": [
      "File: test/altertab3.test -> test/altertab3.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "531:   ALTER TABLE t1 RENAME TO t1x;",
      "532: } {1 {error in trigger r1: no such table: main.t2}}",
      "534: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "534: #------------------------------------------------------------------------",
      "535: #",
      "536: reset_db",
      "537: do_execsql_test 23.1 {",
      "538:   CREATE TABLE v0 (a);",
      "539:   CREATE VIEW v2 (v3) AS",
      "540:     WITH x1 AS (SELECT * FROM v2)",
      "541:     SELECT v3 AS x, v3 AS y FROM v2;",
      "542: }",
      "544: do_catchsql_test 23.2 {",
      "545:   SELECT * FROM v2",
      "546: } {1 {view v2 is circularly defined}}",
      "548: db close",
      "549: sqlite3 db test.db",
      "551: do_catchsql_test 23.3 {",
      "552:   ALTER TABLE v0 RENAME TO t3 ;",
      "553: } {1 {error in view v2: view v2 is circularly defined}}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "05fbfd827c9fb79412fc8179ef460032c33b6dfc",
      "candidate_info": {
        "commit_hash": "05fbfd827c9fb79412fc8179ef460032c33b6dfc",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/05fbfd827c9fb79412fc8179ef460032c33b6dfc",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/where.c"
        ],
        "message": "Additional debugging information printed with the \".wheretrace 0x100\" option. No changes to normally delivered code.\n\nFossilOrigin-Name: fc72ec52c92ca6a953e765b48e21d52021fdb23a2cd84f737da4e43c642f6a5d",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 7ae8c0d52f6aa7f27537216f85456ef49dade040366cfb250c789206ecd4dc5a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1816:   }else{",
          "1817:     char *z;",
          "1818:     if( p->u.vtab.idxStr ){",
          "1820:                 p->u.vtab.idxNum, p->u.vtab.idxStr, p->u.vtab.omitMask);",
          "1821:     }else{",
          "1822:       z = sqlite3_mprintf(\"(%d,%x)\", p->u.vtab.idxNum, p->u.vtab.omitMask);",
          "",
          "[Removed Lines]",
          "1819:       z = sqlite3_mprintf(\"(%d,\\\"%s\\\",%x)\",",
          "",
          "[Added Lines]",
          "1819:       z = sqlite3_mprintf(\"(%d,\\\"%s\\\",%#x)\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4810:     }",
          "4811:   }",
          "4813:     sqlite3WhereClausePrint(sWLB.pWC);",
          "4814:   }",
          "4815: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4813:     sqlite3DebugPrintf(\"---- WHERE clause at start of analysis:\\n\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "4948:       nTabList--;",
          "4949:     }",
          "4950:   }",
          "4951:   WHERETRACE(0xffff,(\"*** Optimizer Finished ***\\n\"));",
          "4952:   pWInfo->pParse->nQueryLoop += pWInfo->nRowOut;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4952: #if defined(WHERETRACE_ENABLED)",
          "4954:     sqlite3DebugPrintf(\"---- WHERE clause at end of analysis:\\n\");",
          "4955:     sqlite3WhereClausePrint(sWLB.pWC);",
          "4956:   }",
          "4958: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c1da4397d6920ebdefbf4eeaf35c780f5478c6fb",
      "candidate_info": {
        "commit_hash": "c1da4397d6920ebdefbf4eeaf35c780f5478c6fb",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c1da4397d6920ebdefbf4eeaf35c780f5478c6fb",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c",
          "src/vdbeInt.h",
          "src/vdbeaux.c"
        ],
        "message": "Move the sqlite3VdbeSerialType() routine in-line in the OP_MakeRecord opcode. Optimizing compilers were doing this already.  By doing it manually, we can omit some redundant tests and make the whole thing run a million cycles faster and use about 80 bytes less code space.\n\nFossilOrigin-Name: d837ab0da52632699abc09320980606aef020df5020c253f99c97e24bf3c6d00",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c",
          "src/vdbeInt.h||src/vdbeInt.h",
          "src/vdbeaux.c||src/vdbeaux.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fc82b73eaac8b36950e527f12c4b5dc1e147e6f4ad2217ae43ad82882a88bfa6",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2932:   pRec = pLast;",
          "2933:   do{",
          "2934:     assert( memIsValid(pRec) );",
          "",
          "[Removed Lines]",
          "2935:     serial_type = sqlite3VdbeSerialType(pRec, file_format, &len);",
          "2936:     if( pRec->flags & MEM_Zero ){",
          "2937:       if( serial_type==0 ){",
          "",
          "[Added Lines]",
          "2935:     if( pRec->flags & MEM_Null ){",
          "2936:       if( pRec->flags & MEM_Zero ){",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2944:         assert( pOp->p5==OPFLAG_NOCHNG_MAGIC || CORRUPT_DB );",
          "2948:       }else{",
          "2951:       }",
          "2952:     }",
          "2958:     if( pRec==pData0 ) break;",
          "2959:     pRec--;",
          "2960:   }while(1);",
          "",
          "[Removed Lines]",
          "2945:         serial_type = 10;",
          "2946:       }else if( nData ){",
          "2947:         if( sqlite3VdbeMemExpandBlob(pRec) ) goto no_mem;",
          "2949:         nZero += pRec->u.nZero;",
          "2950:         len -= pRec->u.nZero;",
          "2953:     nData += len;",
          "2954:     testcase( serial_type==127 );",
          "2955:     testcase( serial_type==128 );",
          "2956:     nHdr += serial_type<=127 ? 1 : sqlite3VarintLen(serial_type);",
          "2957:     pRec->uTemp = serial_type;",
          "",
          "[Added Lines]",
          "2944:         pRec->uTemp = 10;",
          "2948:       nHdr++;",
          "2949:     }else if( pRec->flags & (MEM_Int|MEM_IntReal) ){",
          "2951:       i64 i = pRec->u.i;",
          "2952:       u64 u;",
          "2953:       testcase( pRec->flags & MEM_Int );",
          "2954:       testcase( pRec->flags & MEM_IntReal );",
          "2955:       if( i<0 ){",
          "2956:         u = ~i;",
          "2957:       }else{",
          "2958:         u = i;",
          "2959:       }",
          "2960:       nHdr++;",
          "2961:       if( u<=127 ){",
          "2962:         if( (i&1)==i && file_format>=4 ){",
          "2963:           pRec->uTemp = 8+(u32)u;",
          "2964:         }else{",
          "2965:           nData++;",
          "2966:           pRec->uTemp = 1;",
          "2967:         }",
          "2968:       }else if( u<=32767 ){",
          "2969:         nData += 2;",
          "2970:         pRec->uTemp = 2;",
          "2971:       }else if( u<=8388607 ){",
          "2972:         nData += 3;",
          "2973:         pRec->uTemp = 3;",
          "2974:       }else if( u<=2147483647 ){",
          "2975:         nData += 4;",
          "2976:         pRec->uTemp = 4;",
          "2977:       }else if( u<=140737488355327LL ){",
          "2978:         nData += 6;",
          "2979:         pRec->uTemp = 5;",
          "2980:       }else{",
          "2981:         nData += 8;",
          "2982:         if( pRec->flags & MEM_IntReal ){",
          "2986:           pRec->u.r = (double)pRec->u.i;",
          "2987:           pRec->flags &= ~MEM_IntReal;",
          "2988:           pRec->flags |= MEM_Real;",
          "2989:           pRec->uTemp = 7;",
          "2990:         }else{",
          "2991:           pRec->uTemp = 6;",
          "2992:         }",
          "2993:       }",
          "2994:     }else if( pRec->flags & MEM_Real ){",
          "2995:       nHdr++;",
          "2996:       nData += 8;",
          "2997:       pRec->uTemp = 7;",
          "2998:     }else{",
          "2999:       assert( db->mallocFailed || pRec->flags&(MEM_Str|MEM_Blob) );",
          "3000:       assert( pRec->n>=0 );",
          "3001:       len = (u32)pRec->n;",
          "3002:       serial_type = (len*2) + 12 + ((pRec->flags & MEM_Str)!=0);",
          "3003:       if( pRec->flags & MEM_Zero ){",
          "3004:         serial_type += pRec->u.nZero*2;",
          "3005:         if( nData ){",
          "3006:           if( sqlite3VdbeMemExpandBlob(pRec) ) goto no_mem;",
          "3007:           len += pRec->u.nZero;",
          "3008:         }else{",
          "3009:           nZero += pRec->u.nZero;",
          "3010:         }",
          "3011:       }",
          "3012:       nData += len;",
          "3013:       nHdr += sqlite3VarintLen(serial_type);",
          "3014:       pRec->uTemp = serial_type;",
          "",
          "---------------"
        ],
        "src/vdbeInt.h||src/vdbeInt.h": [
          "File: src/vdbeInt.h -> src/vdbeInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "486: int sqlite3VdbeCursorRestore(VdbeCursor*);",
          "487: u32 sqlite3VdbeSerialTypeLen(u32);",
          "488: u8 sqlite3VdbeOneByteSerialTypeLen(u8);",
          "489: u32 sqlite3VdbeSerialType(Mem*, int, u32*);",
          "490: u32 sqlite3VdbeSerialPut(unsigned char*, Mem*, u32);",
          "491: u32 sqlite3VdbeSerialGet(const unsigned char*, u32, Mem*);",
          "492: void sqlite3VdbeDeleteAuxData(sqlite3*, AuxData**, int, int);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "489: #ifdef SQLITE_ENABLE_STAT3_OR_STAT4",
          "491: #endif",
          "",
          "---------------"
        ],
        "src/vdbeaux.c||src/vdbeaux.c": [
          "File: src/vdbeaux.c -> src/vdbeaux.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3438: u32 sqlite3VdbeSerialType(Mem *pMem, int file_format, u32 *pLen){",
          "3439:   int flags = pMem->flags;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3433: #ifdef SQLITE_ENABLE_STAT3_OR_STAT4",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2bd207ff6d3a1c83f133293a96ea691a0adb318c",
      "candidate_info": {
        "commit_hash": "2bd207ff6d3a1c83f133293a96ea691a0adb318c",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/2bd207ff6d3a1c83f133293a96ea691a0adb318c",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "Omit errors about missing SAVEPOINTs when aborting the .archive command in the CLI.\n\nFossilOrigin-Name: 2a47387ba6aa3c294607b7641aa1c4cf70a7b27a861e1098c2f79a38e5b7036a",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: fa47f4c6589c431cf678560ac33dea6b695052012bea2096b2c92869ed51c688",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "5749:   }",
          "5750: end_ar_transaction:",
          "5751:   if( rc!=SQLITE_OK ){",
          "5753:   }else{",
          "5754:     rc = arExecSql(pAr, \"RELEASE ar;\");",
          "5755:     if( pAr->bZip && pAr->zFile ){",
          "",
          "[Removed Lines]",
          "5752:     arExecSql(pAr, \"ROLLBACK TO ar; RELEASE ar;\");",
          "",
          "[Added Lines]",
          "5752:     sqlite3_exec(pAr->db, \"ROLLBACK TO ar; RELEASE ar;\", 0, 0, 0);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b6991796b4b6f1a9c591349dd6d6ac4438f1db79",
      "candidate_info": {
        "commit_hash": "b6991796b4b6f1a9c591349dd6d6ac4438f1db79",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/b6991796b4b6f1a9c591349dd6d6ac4438f1db79",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/sqliteInt.h",
          "src/vdbeInt.h",
          "src/vdbeaux.c"
        ],
        "message": "Move the nOpAlloc field from Parse into Vdbe to avoid an extra pointer deference on the fast path in sqlite3VdbeAddOp3().\n\nFossilOrigin-Name: 8f10efc29dea7b816b1ba401726c268950d6671d890f686911269082a241d8d9",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/sqliteInt.h||src/sqliteInt.h",
          "src/vdbeInt.h||src/vdbeInt.h",
          "src/vdbeaux.c||src/vdbeaux.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: c4d44542d259bbec11aea60ae94fcb4acd53e97e125723cae078cf0f8873f8ef",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h"
        ],
        "src/vdbeInt.h||src/vdbeInt.h": [
          "File: src/vdbeInt.h -> src/vdbeInt.h"
        ],
        "src/vdbeaux.c||src/vdbeaux.c": [
          "File: src/vdbeaux.c -> src/vdbeaux.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "36:   pParse->pVdbe = p;",
          "37:   assert( pParse->aLabel==0 );",
          "38:   assert( pParse->nLabel==0 );",
          "40:   assert( pParse->szOpAlloc==0 );",
          "41:   sqlite3VdbeAddOp2(p, OP_Init, 0, 1);",
          "42:   return p;",
          "",
          "[Removed Lines]",
          "39:   assert( pParse->nOpAlloc==0 );",
          "",
          "[Added Lines]",
          "39:   assert( p->nOpAlloc==0 );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "157: #ifdef SQLITE_TEST_REALLOC_STRESS",
          "159: #else",
          "161:   UNUSED_PARAMETER(nOp);",
          "162: #endif",
          "",
          "[Removed Lines]",
          "158:   int nNew = (p->nOpAlloc>=512 ? p->nOpAlloc*2 : p->nOpAlloc+nOp);",
          "160:   int nNew = (p->nOpAlloc ? p->nOpAlloc*2 : (int)(1024/sizeof(Op)));",
          "",
          "[Added Lines]",
          "158:   int nNew = (v->nOpAlloc>=512 ? v->nOpAlloc*2 : v->nOpAlloc+nOp);",
          "160:   int nNew = (v->nOpAlloc ? v->nOpAlloc*2 : (int)(1024/sizeof(Op)));",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "168:   }",
          "170:   assert( nOp<=(1024/sizeof(Op)) );",
          "172:   pNew = sqlite3DbRealloc(p->db, v->aOp, nNew*sizeof(Op));",
          "173:   if( pNew ){",
          "174:     p->szOpAlloc = sqlite3DbMallocSize(p->db, pNew);",
          "176:     v->aOp = pNew;",
          "177:   }",
          "178:   return (pNew ? SQLITE_OK : SQLITE_NOMEM_BKPT);",
          "",
          "[Removed Lines]",
          "171:   assert( nNew>=(p->nOpAlloc+nOp) );",
          "175:     p->nOpAlloc = p->szOpAlloc/sizeof(Op);",
          "",
          "[Added Lines]",
          "171:   assert( nNew>=(v->nOpAlloc+nOp) );",
          "175:     v->nOpAlloc = p->szOpAlloc/sizeof(Op);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "208: static SQLITE_NOINLINE int growOp3(Vdbe *p, int op, int p1, int p2, int p3){",
          "210:   if( growOpArray(p, 1) ) return 1;",
          "212:   return sqlite3VdbeAddOp3(p, op, p1, p2, p3);",
          "213: }",
          "214: int sqlite3VdbeAddOp3(Vdbe *p, int op, int p1, int p2, int p3){",
          "",
          "[Removed Lines]",
          "209:   assert( p->pParse->nOpAlloc<=p->nOp );",
          "211:   assert( p->pParse->nOpAlloc>p->nOp );",
          "",
          "[Added Lines]",
          "209:   assert( p->nOpAlloc<=p->nOp );",
          "211:   assert( p->nOpAlloc>p->nOp );",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "218:   i = p->nOp;",
          "219:   assert( p->magic==VDBE_MAGIC_INIT );",
          "220:   assert( op>=0 && op<0xff );",
          "222:     return growOp3(p, op, p1, p2, p3);",
          "223:   }",
          "224:   p->nOp++;",
          "",
          "[Removed Lines]",
          "221:   if( p->pParse->nOpAlloc<=i ){",
          "",
          "[Added Lines]",
          "221:   if( p->nOpAlloc<=i ){",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "794: #if defined(SQLITE_DEBUG) && !defined(SQLITE_TEST_REALLOC_STRESS)",
          "795: void sqlite3VdbeVerifyNoMallocRequired(Vdbe *p, int N){",
          "797: }",
          "798: #endif",
          "",
          "[Removed Lines]",
          "796:   assert( p->nOp + N <= p->pParse->nOpAlloc );",
          "",
          "[Added Lines]",
          "796:   assert( p->nOp + N <= p->nOpAlloc );",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "865:   VdbeOp *pOut, *pFirst;",
          "866:   assert( nOp>0 );",
          "867:   assert( p->magic==VDBE_MAGIC_INIT );",
          "869:     return 0;",
          "870:   }",
          "871:   pFirst = pOut = &p->aOp[p->nOp];",
          "",
          "[Removed Lines]",
          "868:   if( p->nOp + nOp > p->pParse->nOpAlloc && growOpArray(p, nOp) ){",
          "",
          "[Added Lines]",
          "868:   if( p->nOp + nOp > p->nOpAlloc && growOpArray(p, nOp) ){",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d35bdd6c090ddc4d85213dc0bf8cb432966eb38a",
      "candidate_info": {
        "commit_hash": "d35bdd6c090ddc4d85213dc0bf8cb432966eb38a",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/d35bdd6c090ddc4d85213dc0bf8cb432966eb38a",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/build.c",
          "src/insert.c",
          "test/conflict.test"
        ],
        "message": "Ensure that all ON CONFLICT REPLACE indexes are sorted to the end of the list of indexes for a table, even for weird cases where the same UNIQUE constraint occurs twice with the ON CONFLICT REPLACE clause only on the second one.  This avoids an out-of-order contraint processing problem that can arise due to the optimization of check-in [469a62ca33081854].\n\nFossilOrigin-Name: 1e3918ca2f2c1cfcfa44249b1d7b847d52cbb8d302a8d4a335c090cfdf22d7a1",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/build.c||src/build.c",
          "src/insert.c||src/insert.c",
          "test/conflict.test||test/conflict.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 672e749aef7351de3c69b365c1f80c756fda4e261b5d2ac1faa01d3a7d5a4c49",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/build.c||src/build.c": [
          "File: src/build.c -> src/build.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3921:       sqlite3VdbeJumpHere(v, pIndex->tnum);",
          "3922:     }",
          "3923:   }",
          "3931:   if( db->init.busy || pTblName==0 ){",
          "3944:     pIndex = 0;",
          "3945:   }",
          "3946:   else if( IN_RENAME_OBJECT ){",
          "",
          "[Removed Lines]",
          "3932:     if( onError!=OE_Replace || pTab->pIndex==0",
          "3933:          || pTab->pIndex->onError==OE_Replace){",
          "3934:       pIndex->pNext = pTab->pIndex;",
          "3935:       pTab->pIndex = pIndex;",
          "3936:     }else{",
          "3937:       Index *pOther = pTab->pIndex;",
          "3938:       while( pOther->pNext && pOther->pNext->onError!=OE_Replace ){",
          "3939:         pOther = pOther->pNext;",
          "3940:       }",
          "3941:       pIndex->pNext = pOther->pNext;",
          "3942:       pOther->pNext = pIndex;",
          "3943:     }",
          "",
          "[Added Lines]",
          "3925:     pIndex->pNext = pTab->pIndex;",
          "3926:     pTab->pIndex = pIndex;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3953: exit_create_index:",
          "3954:   if( pIndex ) sqlite3FreeIndex(db, pIndex);",
          "3955:   sqlite3ExprDelete(db, pPIWhere);",
          "3956:   sqlite3ExprListDelete(db, pList);",
          "3957:   sqlite3SrcListDelete(db, pTblName);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3939:     Index **ppFrom = &pTab->pIndex;",
          "3940:     Index *pThis;",
          "3941:     for(ppFrom=&pTab->pIndex; (pThis = *ppFrom)!=0; ppFrom=&pThis->pNext){",
          "3942:       Index *pNext;",
          "3943:       if( pThis->onError!=OE_Replace ) continue;",
          "3944:       while( (pNext = pThis->pNext)!=0 && pNext->onError!=OE_Replace ){",
          "3946:         pThis->pNext = pNext->pNext;",
          "3947:         pNext->pNext = pThis;",
          "3948:         ppFrom = &pNext->pNext;",
          "3949:       }",
          "3950:       break;",
          "3951:     }",
          "3952:   }",
          "",
          "---------------"
        ],
        "src/insert.c||src/insert.c": [
          "File: src/insert.c -> src/insert.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2250:   assert( v!=0 );",
          "2252:   for(i=0, pIdx=pTab->pIndex; pIdx; pIdx=pIdx->pNext, i++){",
          "2253:     if( aRegIdx[i]==0 ) continue;",
          "2254:     if( pIdx->pPartIdxWhere ){",
          "2255:       sqlite3VdbeAddOp2(v, OP_IsNull, aRegIdx[i], sqlite3VdbeCurrentAddr(v)+2);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2254:     assert( pIdx->onError!=OE_Replace",
          "2255:          || pIdx->pNext==0",
          "2256:          || pIdx->pNext->onError==OE_Replace );",
          "",
          "---------------"
        ],
        "test/conflict.test||test/conflict.test": [
          "File: test/conflict.test -> test/conflict.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "834:   REPLACE INTO t1 DEFAULT VALUES;",
          "835: } {1 {NOT NULL constraint failed: t1.x}}",
          "838: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "837: # 2019-12-15 gramfuzz1 find",
          "838: # Three UNIQUE constraints, where the third would is a duplicate except",
          "839: # that it adds ON CONFLICT REPLACE.  Verify that the indexes end up",
          "840: # sorted in the correct order (REPLACE last) so that constraint processing",
          "841: # works correctly.",
          "842: #",
          "843: reset_db",
          "844: do_execsql_test conflict-15.10 {",
          "845:   CREATE TABLE t1(",
          "846:     x PRIMARY KEY,",
          "847:     UNIQUE(x,x),",
          "848:     UNIQUE(x,x) ON CONFLICT REPLACE",
          "849:   );",
          "850:   INSERT INTO t1(x) VALUES(1);",
          "851:   SELECT * FROM t1;",
          "852: } {1}",
          "853: do_catchsql_test conflict-15.20 {",
          "854:   INSERT INTO t1(x) VALUES(1);",
          "855: } {1 {UNIQUE constraint failed: t1.x}}",
          "856: do_execsql_test conflict-15.30 {",
          "857:   SELECT * FROM t1;",
          "858: } {1}",
          "",
          "---------------"
        ]
      }
    }
  ]
}