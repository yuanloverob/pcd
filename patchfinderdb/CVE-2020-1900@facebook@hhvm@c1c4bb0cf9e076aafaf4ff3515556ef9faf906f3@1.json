{
  "cve_id": "CVE-2020-1900",
  "cve_desc": "When unserializing an object with dynamic properties HHVM needs to pre-reserve the full size of the dynamic property array before inserting anything into it. Otherwise the array might resize, invalidating previously stored references. This pre-reservation was not occurring in HHVM prior to v4.32.3, between versions 4.33.0 and 4.56.0, 4.57.0, 4.58.0, 4.58.1, 4.59.0, 4.60.0, 4.61.0, 4.62.0.",
  "repo": "facebook/hhvm",
  "patch_hash": "c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
  "patch_info": {
    "commit_hash": "c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
    "repo": "facebook/hhvm",
    "commit_url": "https://github.com/facebook/hhvm/commit/c1c4bb0cf9e076aafaf4ff3515556ef9faf906f3",
    "files": [
      "hphp/runtime/base/object-data.cpp",
      "hphp/runtime/base/variable-unserializer.cpp"
    ],
    "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
    "before_after_code_files": [
      "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
      "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
    ]
  },
  "patch_diff": {
    "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
      "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "342:     return dynPropArray();",
      "343:   }",
      "345:   return setDynPropArray(",
      "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
      "347:   );",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
      "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
      "347:     check_non_safepoint_surprise();",
      "348:   }",
      "",
      "---------------"
    ],
    "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
      "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
      "--- Hunk 1 ---",
      "[Context before]",
      "555:     t = obj->makeDynProp(realKey.get());",
      "556:   } else {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "555:     obj->reserveDynProps(nProp);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2083090d1a5c367d9d56c556409f8c96acca7d03",
      "candidate_info": {
        "commit_hash": "2083090d1a5c367d9d56c556409f8c96acca7d03",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/2083090d1a5c367d9d56c556409f8c96acca7d03",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "322:     return dynPropArray();",
          "323:   }",
          "325:   return setDynPropArray(",
          "326:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "327:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "325:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "326:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "327:     check_non_safepoint_surprise();",
          "328:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "497544961784c0cce69a8712eb815c62d88c1bde",
      "candidate_info": {
        "commit_hash": "497544961784c0cce69a8712eb815c62d88c1bde",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/497544961784c0cce69a8712eb815c62d88c1bde",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "414:     return dynPropArray();",
          "415:   }",
          "417:   return setDynPropArray(",
          "418:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "419:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "417:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "418:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "419:     check_non_safepoint_surprise();",
          "420:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "580:     SuppressHACFalseyPromoteNotices shacn;",
          "581:     t = obj->makeDynProp(realKey.get());",
          "582:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "581:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9cbe2e86c729609fd3ef070c297ca91506c4a85d",
      "candidate_info": {
        "commit_hash": "9cbe2e86c729609fd3ef070c297ca91506c4a85d",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/9cbe2e86c729609fd3ef070c297ca91506c4a85d",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "327:     return dynPropArray();",
          "328:   }",
          "330:   return setDynPropArray(",
          "331:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "332:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "330:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "331:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "332:     check_non_safepoint_surprise();",
          "333:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "583:     t = obj->makeDynProp(realKey.get());",
          "584:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "583:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e4ad1cb5de9acd656deca6fcf91aa86d4b5ee64f",
      "candidate_info": {
        "commit_hash": "e4ad1cb5de9acd656deca6fcf91aa86d4b5ee64f",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/e4ad1cb5de9acd656deca6fcf91aa86d4b5ee64f",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:     return dynPropArray();",
          "343:   }",
          "345:   return setDynPropArray(",
          "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "347:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "347:     check_non_safepoint_surprise();",
          "348:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "555:     t = obj->makeDynProp(realKey.get());",
          "556:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "555:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4c0b428099c13ff2c57c5d9190d0c2370a36fb03",
      "candidate_info": {
        "commit_hash": "4c0b428099c13ff2c57c5d9190d0c2370a36fb03",
        "repo": "facebook/hhvm",
        "commit_url": "https://github.com/facebook/hhvm/commit/4c0b428099c13ff2c57c5d9190d0c2370a36fb03",
        "files": [
          "hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp"
        ],
        "message": "CVE-2020-1900\n\nPre-reserve object dynamic properties when unserializing",
        "before_after_code_files": [
          "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
          "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ],
          "candidate": [
            "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp",
            "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp"
          ]
        }
      },
      "candidate_diff": {
        "hphp/runtime/base/object-data.cpp||hphp/runtime/base/object-data.cpp": [
          "File: hphp/runtime/base/object-data.cpp -> hphp/runtime/base/object-data.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:     return dynPropArray();",
          "343:   }",
          "345:   return setDynPropArray(",
          "346:       Array::attach(MixedArray::MakeReserveMixed(numDynamic))",
          "347:   );",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "345:   auto const allocsz = MixedArray::computeAllocBytesFromMaxElms(numDynamic);",
          "346:   if (UNLIKELY(allocsz > kMaxSmallSize && tl_heap->preAllocOOM(allocsz))) {",
          "347:     check_non_safepoint_surprise();",
          "348:   }",
          "",
          "---------------"
        ],
        "hphp/runtime/base/variable-unserializer.cpp||hphp/runtime/base/variable-unserializer.cpp": [
          "File: hphp/runtime/base/variable-unserializer.cpp -> hphp/runtime/base/variable-unserializer.cpp",
          "--- Hunk 1 ---",
          "[Context before]",
          "541:     t = obj->makeDynProp(realKey.get());",
          "542:   } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "541:     obj->reserveDynProps(nProp);",
          "",
          "---------------"
        ]
      }
    }
  ]
}