{
  "cve_id": "CVE-2016-3726",
  "cve_desc": "Multiple open redirect vulnerabilities in Jenkins before 2.3 and LTS before 1.651.2 allow remote attackers to redirect users to arbitrary web sites and conduct phishing attacks via unspecified vectors related to \"scheme-relative\" URLs.",
  "repo": "jenkinsci/jenkins",
  "patch_hash": "2ed0c046dfbb2003a17df27c53777e72c6eaff25",
  "patch_info": {
    "commit_hash": "2ed0c046dfbb2003a17df27c53777e72c6eaff25",
    "repo": "jenkinsci/jenkins",
    "commit_url": "https://github.com/jenkinsci/jenkins/commit/2ed0c046dfbb2003a17df27c53777e72c6eaff25",
    "files": [
      "core/src/main/java/hudson/Util.java",
      "core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
      "core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
      "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java"
    ],
    "message": "[FIX SECURITY-276] Don't allow open redirect using scheme-rel. URL",
    "before_after_code_files": [
      "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java",
      "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
      "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
      "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java"
    ]
  },
  "patch_diff": {
    "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java": [
      "File: core/src/main/java/hudson/Util.java -> core/src/main/java/hudson/Util.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "77: import javax.annotation.Nonnull;",
      "78: import javax.annotation.Nullable;",
      "79: import org.apache.commons.codec.digest.DigestUtils;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "80: import org.kohsuke.accmod.Restricted;",
      "81: import org.kohsuke.accmod.restrictions.NoExternalUse;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1458:     public static boolean isAbsoluteUri(@Nonnull String uri) {",
      "1459:         int idx = uri.indexOf(':');",
      "1460:         if (idx<0)  return false;   // no ':'. can't be absolute",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1462:     @Deprecated",
      "1463:     @RestrictedSince(\"1.651.2 / 2.TODO\")",
      "1464:     @Restricted(NoExternalUse.class)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1463:         return idx<_indexOf(uri, '#') && idx<_indexOf(uri,'?') && idx<_indexOf(uri,'/');",
      "1464:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1476:     public static boolean isAbsoluteOrSchemeRelativeUri(@Nonnull String uri) {",
      "1477:         return isAbsoluteUri(uri) || uri.startsWith(\"//\");",
      "1478:     }",
      "",
      "---------------"
    ],
    "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java": [
      "File: core/src/main/java/hudson/model/DirectoryBrowserSupport.java -> core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "158:         String pattern = req.getParameter(\"pattern\");",
      "159:         if(pattern==null)",
      "160:             pattern = req.getParameter(\"path\"); // compatibility with Hudson<1.129",
      "162:             rsp.sendRedirect2(pattern);",
      "163:             return;",
      "164:         }",
      "",
      "[Removed Lines]",
      "161:         if(pattern!=null && !Util.isAbsoluteUri(pattern)) {// avoid open redirect",
      "",
      "[Added Lines]",
      "161:         if(pattern!=null && !Util.isAbsoluteOrSchemeRelativeUri(pattern)) {// avoid open redirect",
      "",
      "---------------"
    ],
    "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java": [
      "File: core/src/main/java/hudson/model/ParametersDefinitionProperty.java -> core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "158:                 getJob(), delay.getTime(), new ParametersAction(values), new CauseAction(new Cause.UserIdCause()));",
      "159:         if (item!=null) {",
      "160:             String url = formData.optString(\"redirectTo\");",
      "162:                 url = req.getContextPath()+'/'+item.getUrl();",
      "163:             rsp.sendRedirect(formData.optInt(\"statusCode\",SC_CREATED), url);",
      "164:         } else",
      "",
      "[Removed Lines]",
      "161:             if (url==null || Util.isAbsoluteUri(url))   // avoid open redirect",
      "",
      "[Added Lines]",
      "161:             if (url==null || Util.isAbsoluteOrSchemeRelativeUri(url))   // avoid open redirect",
      "",
      "---------------"
    ],
    "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java": [
      "File: core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java -> core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java",
      "--- Hunk 1 ---",
      "[Context before]",
      "53:         if (targetUrl == null)",
      "54:             return getDefaultTargetUrl();",
      "57:             return \".\"; // avoid open redirect",
      "",
      "[Removed Lines]",
      "56:         if (Util.isAbsoluteUri(targetUrl))",
      "",
      "[Added Lines]",
      "56:         if (Util.isAbsoluteOrSchemeRelativeUri(targetUrl))",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "e6efae7d0d742f068498366424b0059e9ed42e4c",
      "candidate_info": {
        "commit_hash": "e6efae7d0d742f068498366424b0059e9ed42e4c",
        "repo": "jenkinsci/jenkins",
        "commit_url": "https://github.com/jenkinsci/jenkins/commit/e6efae7d0d742f068498366424b0059e9ed42e4c",
        "files": [
          "core/src/main/java/hudson/Util.java",
          "core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
          "core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
          "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java",
          "core/src/test/java/hudson/UtilTest.java"
        ],
        "message": "[SECURITY-276] Better method name, add tests",
        "before_after_code_files": [
          "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java",
          "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
          "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
          "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java",
          "core/src/test/java/hudson/UtilTest.java||core/src/test/java/hudson/UtilTest.java"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java",
            "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
            "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
            "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java"
          ],
          "candidate": [
            "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java",
            "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
            "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
            "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java"
          ]
        }
      },
      "candidate_diff": {
        "core/src/main/java/hudson/Util.java||core/src/main/java/hudson/Util.java": [
          "File: core/src/main/java/hudson/Util.java -> core/src/main/java/hudson/Util.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "1471:     }",
          "1478:     }",
          "",
          "[Removed Lines]",
          "1476:     public static boolean isAbsoluteOrSchemeRelativeUri(@Nonnull String uri) {",
          "1477:         return isAbsoluteUri(uri) || uri.startsWith(\"//\");",
          "",
          "[Added Lines]",
          "1476:     public static boolean isSafeToRedirectTo(@Nonnull String uri) {",
          "1477:         return !isAbsoluteUri(uri) && !uri.startsWith(\"//\");",
          "",
          "---------------"
        ],
        "core/src/main/java/hudson/model/DirectoryBrowserSupport.java||core/src/main/java/hudson/model/DirectoryBrowserSupport.java": [
          "File: core/src/main/java/hudson/model/DirectoryBrowserSupport.java -> core/src/main/java/hudson/model/DirectoryBrowserSupport.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "158:         String pattern = req.getParameter(\"pattern\");",
          "159:         if(pattern==null)",
          "160:             pattern = req.getParameter(\"path\"); // compatibility with Hudson<1.129",
          "162:             rsp.sendRedirect2(pattern);",
          "163:             return;",
          "164:         }",
          "",
          "[Removed Lines]",
          "161:         if(pattern!=null && !Util.isAbsoluteOrSchemeRelativeUri(pattern)) {// avoid open redirect",
          "",
          "[Added Lines]",
          "161:         if(pattern!=null && Util.isSafeToRedirectTo(pattern)) {// avoid open redirect",
          "",
          "---------------"
        ],
        "core/src/main/java/hudson/model/ParametersDefinitionProperty.java||core/src/main/java/hudson/model/ParametersDefinitionProperty.java": [
          "File: core/src/main/java/hudson/model/ParametersDefinitionProperty.java -> core/src/main/java/hudson/model/ParametersDefinitionProperty.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "158:                 getJob(), delay.getTime(), new ParametersAction(values), new CauseAction(new Cause.UserIdCause()));",
          "159:         if (item!=null) {",
          "160:             String url = formData.optString(\"redirectTo\");",
          "162:                 url = req.getContextPath()+'/'+item.getUrl();",
          "163:             rsp.sendRedirect(formData.optInt(\"statusCode\",SC_CREATED), url);",
          "164:         } else",
          "",
          "[Removed Lines]",
          "161:             if (url==null || Util.isAbsoluteOrSchemeRelativeUri(url))   // avoid open redirect",
          "",
          "[Added Lines]",
          "161:             if (url==null || !Util.isSafeToRedirectTo(url))   // avoid open redirect",
          "",
          "---------------"
        ],
        "core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java||core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java": [
          "File: core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java -> core/src/main/java/hudson/security/AuthenticationProcessingFilter2.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:         if (targetUrl == null)",
          "54:             return getDefaultTargetUrl();",
          "57:             return \".\"; // avoid open redirect",
          "",
          "[Removed Lines]",
          "56:         if (Util.isAbsoluteOrSchemeRelativeUri(targetUrl))",
          "",
          "[Added Lines]",
          "56:         if (!Util.isSafeToRedirectTo(targetUrl))",
          "",
          "---------------"
        ],
        "core/src/test/java/hudson/UtilTest.java||core/src/test/java/hudson/UtilTest.java": [
          "File: core/src/test/java/hudson/UtilTest.java -> core/src/test/java/hudson/UtilTest.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "344:         assertFalse(Util.isAbsoluteUri(\"foo/bar\"));",
          "345:     }",
          "347:     @Test",
          "348:     public void loadProperties() throws IOException {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "347:     @Test",
          "348:     @Issue(\"SECURITY-276\")",
          "349:     public void testIsSafeToRedirectTo() {",
          "350:         assertFalse(Util.isSafeToRedirectTo(\"http://foobar/\"));",
          "351:         assertFalse(Util.isSafeToRedirectTo(\"mailto:kk@kohsuke.org\"));",
          "352:         assertFalse(Util.isSafeToRedirectTo(\"d123://test/\"));",
          "353:         assertFalse(Util.isSafeToRedirectTo(\"//google.com\"));",
          "355:         assertTrue(Util.isSafeToRedirectTo(\"foo/bar/abc:def\"));",
          "356:         assertTrue(Util.isSafeToRedirectTo(\"foo?abc:def\"));",
          "357:         assertTrue(Util.isSafeToRedirectTo(\"foo#abc:def\"));",
          "358:         assertTrue(Util.isSafeToRedirectTo(\"foo/bar\"));",
          "359:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}