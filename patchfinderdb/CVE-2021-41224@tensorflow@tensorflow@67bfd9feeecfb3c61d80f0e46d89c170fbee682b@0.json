{
  "cve_id": "CVE-2021-41224",
  "cve_desc": "TensorFlow is an open source platform for machine learning. In affected versions the implementation of `SparseFillEmptyRows` can be made to trigger a heap OOB access. This occurs whenever the size of `indices` does not match the size of `values`. The fix will be included in TensorFlow 2.7.0. We will also cherrypick this commit on TensorFlow 2.6.1, TensorFlow 2.5.2, and TensorFlow 2.4.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "67bfd9feeecfb3c61d80f0e46d89c170fbee682b",
  "patch_info": {
    "commit_hash": "67bfd9feeecfb3c61d80f0e46d89c170fbee682b",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/67bfd9feeecfb3c61d80f0e46d89c170fbee682b",
    "files": [
      "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
    ],
    "message": "Make SparseFillEmptyRows validate that the length of `values` must be equal to the number of index tuples.\n\nPiperOrigin-RevId: 399969549\nChange-Id: I3c2f2ca1c1d2cc88bb5951c6958b38c16e9436c8",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
      "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "24: #include <vector>",
      "26: #include \"tensorflow/core/framework/op_kernel.h\"",
      "27: #include \"tensorflow/core/framework/register_types.h\"",
      "28: #include \"tensorflow/core/framework/tensor.h\"",
      "29: #include \"tensorflow/core/framework/tensor_util.h\"",
      "30: #include \"tensorflow/core/framework/types.h\"",
      "31: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
      "32: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
      "34: namespace tensorflow {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "27: #include \"tensorflow/core/framework/op_requires.h\"",
      "33: #include \"tensorflow/core/platform/errors.h\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "222:                     errors::InvalidArgument(\"values must be a vector, saw: \",",
      "223:                                             values_t.shape().DebugString()),",
      "224:                     done);",
      "225:   OP_REQUIRES_ASYNC(",
      "226:       context, TensorShapeUtils::IsScalar(default_value_t.shape()),",
      "227:       errors::InvalidArgument(\"default_value must be a scalar, saw: \",",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "227:   OP_REQUIRES_ASYNC(",
      "228:       context, indices_t.dim_size(0) == values_t.dim_size(0),",
      "229:       errors::InvalidArgument(\"The length of `values` (\", values_t.dim_size(0),",
      "230:                               \") must match the first dimension of `indices` (\",",
      "231:                               indices_t.dim_size(0), \").\"),",
      "232:       done);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3d59a664553508f8a5a4648dc3f711ecacd61f25",
      "candidate_info": {
        "commit_hash": "3d59a664553508f8a5a4648dc3f711ecacd61f25",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3d59a664553508f8a5a4648dc3f711ecacd61f25",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "Make SparseFillEmptyRows validate that the length of `values` must be equal to the number of index tuples.\n\nPiperOrigin-RevId: 399969549\nChange-Id: I3c2f2ca1c1d2cc88bb5951c6958b38c16e9436c8",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "22: #include <vector>",
          "24: #include \"tensorflow/core/framework/op_kernel.h\"",
          "25: #include \"tensorflow/core/framework/register_types.h\"",
          "26: #include \"tensorflow/core/framework/tensor.h\"",
          "27: #include \"tensorflow/core/framework/tensor_util.h\"",
          "28: #include \"tensorflow/core/framework/types.h\"",
          "29: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "30: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "32: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25: #include \"tensorflow/core/framework/op_requires.h\"",
          "31: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "64:     OP_REQUIRES(context, TensorShapeUtils::IsVector(values_t.shape()),",
          "65:                 errors::InvalidArgument(\"values must be a vector, saw: \",",
          "66:                                         values_t.shape().DebugString()));",
          "67:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(default_value_t.shape()),",
          "68:                 errors::InvalidArgument(\"default_value must be a scalar, saw: \",",
          "69:                                         default_value_t.shape().DebugString()));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "69:     OP_REQUIRES(context, indices_t.dim_size(0) == values_t.dim_size(0),",
          "70:                 errors::InvalidArgument(\"The length of `values` (\", values_t.dim_size(0),",
          "71:                                         \") must match the first dimension of `indices` (\",",
          "72:                                         indices_t.dim_size(0), \").\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "34e0845f65deaeb68d932c7a4eee54419484dcb8",
      "candidate_info": {
        "commit_hash": "34e0845f65deaeb68d932c7a4eee54419484dcb8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/34e0845f65deaeb68d932c7a4eee54419484dcb8",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "Make SparseFillEmptyRows validate that the length of `values` must be equal to the number of index tuples.\n\nPiperOrigin-RevId: 399969549\nChange-Id: I3c2f2ca1c1d2cc88bb5951c6958b38c16e9436c8",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include <vector>",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/register_types.h\"",
          "28: #include \"tensorflow/core/framework/tensor.h\"",
          "29: #include \"tensorflow/core/framework/tensor_util.h\"",
          "30: #include \"tensorflow/core/framework/types.h\"",
          "31: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "32: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "34: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "33: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "222:                     errors::InvalidArgument(\"values must be a vector, saw: \",",
          "223:                                             values_t.shape().DebugString()),",
          "224:                     done);",
          "225:   OP_REQUIRES_ASYNC(",
          "226:       context, TensorShapeUtils::IsScalar(default_value_t.shape()),",
          "227:       errors::InvalidArgument(\"default_value must be a scalar, saw: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "227:   OP_REQUIRES_ASYNC(",
          "228:       context, indices_t.dim_size(0) == values_t.dim_size(0),",
          "229:       errors::InvalidArgument(\"The length of `values` (\", values_t.dim_size(0),",
          "230:                               \") must match the first dimension of `indices` (\",",
          "231:                               indices_t.dim_size(0), \").\"),",
          "232:       done);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "22c0d28377dbccabdc853d88defda3106624c00f",
      "candidate_info": {
        "commit_hash": "22c0d28377dbccabdc853d88defda3106624c00f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/22c0d28377dbccabdc853d88defda3106624c00f",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "Make SparseFillEmptyRows validate that the length of `values` must be equal to the number of index tuples.\n\nPiperOrigin-RevId: 399969549\nChange-Id: I3c2f2ca1c1d2cc88bb5951c6958b38c16e9436c8",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include <vector>",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/register_types.h\"",
          "28: #include \"tensorflow/core/framework/tensor.h\"",
          "29: #include \"tensorflow/core/framework/tensor_util.h\"",
          "30: #include \"tensorflow/core/framework/types.h\"",
          "31: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "32: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "34: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "33: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "222:                     errors::InvalidArgument(\"values must be a vector, saw: \",",
          "223:                                             values_t.shape().DebugString()),",
          "224:                     done);",
          "225:   OP_REQUIRES_ASYNC(",
          "226:       context, TensorShapeUtils::IsScalar(default_value_t.shape()),",
          "227:       errors::InvalidArgument(\"default_value must be a scalar, saw: \",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "227:   OP_REQUIRES_ASYNC(",
          "228:       context, indices_t.dim_size(0) == values_t.dim_size(0),",
          "229:       errors::InvalidArgument(\"The length of `values` (\", values_t.dim_size(0),",
          "230:                               \") must match the first dimension of `indices` (\",",
          "231:                               indices_t.dim_size(0), \").\"),",
          "232:       done);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a89c13363896a85a51df86391463026ca9fe8028",
      "candidate_info": {
        "commit_hash": "a89c13363896a85a51df86391463026ca9fe8028",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a89c13363896a85a51df86391463026ca9fe8028",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "Make SparseFillEmptyRows validate that the length of `values` must be equal to the number of index tuples.\n\nPiperOrigin-RevId: 399969549\nChange-Id: I3c2f2ca1c1d2cc88bb5951c6958b38c16e9436c8",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "24: #include <vector>",
          "26: #include \"tensorflow/core/framework/op_kernel.h\"",
          "27: #include \"tensorflow/core/framework/register_types.h\"",
          "28: #include \"tensorflow/core/framework/tensor.h\"",
          "29: #include \"tensorflow/core/framework/tensor_util.h\"",
          "30: #include \"tensorflow/core/framework/types.h\"",
          "31: #include \"tensorflow/core/lib/gtl/inlined_vector.h\"",
          "32: #include \"tensorflow/core/util/sparse/sparse_tensor.h\"",
          "34: namespace tensorflow {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "27: #include \"tensorflow/core/framework/op_requires.h\"",
          "33: #include \"tensorflow/core/platform/errors.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "211:     OP_REQUIRES(context, TensorShapeUtils::IsVector(values_t.shape()),",
          "212:                 errors::InvalidArgument(\"values must be a vector, saw: \",",
          "213:                                         values_t.shape().DebugString()));",
          "214:     OP_REQUIRES(context, TensorShapeUtils::IsScalar(default_value_t.shape()),",
          "215:                 errors::InvalidArgument(\"default_value must be a scalar, saw: \",",
          "216:                                         default_value_t.shape().DebugString()));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "216:     OP_REQUIRES(context, indices_t.dim_size(0) == values_t.dim_size(0),",
          "217:                 errors::InvalidArgument(\"The length of `values` (\", values_t.dim_size(0),",
          "218:                                         \") must match the first dimension of `indices` (\",",
          "219:                                         indices_t.dim_size(0), \").\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}