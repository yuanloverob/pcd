{
  "cve_id": "CVE-2020-15202",
  "cve_desc": "In Tensorflow before versions 1.15.4, 2.0.3, 2.1.2, 2.2.1 and 2.3.1, the `Shard` API in TensorFlow expects the last argument to be a function taking two `int64` (i.e., `long long`) arguments. However, there are several places in TensorFlow where a lambda taking `int` or `int32` arguments is being used. In these cases, if the amount of work to be parallelized is large enough, integer truncation occurs. Depending on how the two arguments of the lambda are used, this can result in segfaults, read/write outside of heap allocated arrays, stack overflows, or data corruption. The issue is patched in commits 27b417360cbd671ef55915e4bb6bb06af8b8a832 and ca8c013b5e97b1373b3bb1c97ea655e69f31a575, and is released in TensorFlow versions 1.15.4, 2.0.3, 2.1.2, 2.2.1, or 2.3.1.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "ca8c013b5e97b1373b3bb1c97ea655e69f31a575",
  "patch_info": {
    "commit_hash": "ca8c013b5e97b1373b3bb1c97ea655e69f31a575",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/ca8c013b5e97b1373b3bb1c97ea655e69f31a575",
    "files": [
      "tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
      "tensorflow/core/kernels/image/crop_and_resize_op.cc",
      "tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc",
      "tensorflow/core/kernels/nth_element_op.cc",
      "tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
      "tensorflow/core/kernels/random_binomial_op.cc",
      "tensorflow/core/kernels/random_poisson_op.cc",
      "tensorflow/core/kernels/stateless_random_ops.cc",
      "tensorflow/core/kernels/topk_op.cc"
    ],
    "message": "Prevent integer truncation from 64 to 32 bits.\n\nThe `tensorflow::Shard` functions last argument must be a 2 argument function where both arguments are `int64` (`long long`, 64 bits). However, there are usages where code passes in a function where arguments are `int` or `int32` (32 bits). In these cases, it is possible that the integer truncation would later cause a segfault or other unexpected behavior.\n\nPiperOrigin-RevId: 332560414\nChange-Id: Ief649406babc8d4f60b3e7a9d573cbcc5ce5b767",
    "before_after_code_files": [
      "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
      "tensorflow/core/kernels/image/crop_and_resize_op.cc||tensorflow/core/kernels/image/crop_and_resize_op.cc",
      "tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc||tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc",
      "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
      "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
      "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
      "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
      "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
      "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc": [
      "File: tensorflow/core/kernels/boosted_trees/prediction_ops.cc -> tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "121:       auto do_work = [&resource, &bucketized_features, &cached_tree_ids,",
      "122:                       &cached_node_ids, &output_partial_logits,",
      "123:                       &output_node_ids, latest_tree,",
      "125:         for (int32 i = start; i < end; ++i) {",
      "126:           int32 tree_id = cached_tree_ids(i);",
      "127:           int32 node_id = cached_node_ids(i);",
      "",
      "[Removed Lines]",
      "124:                       this](int32 start, int32 end) {",
      "",
      "[Added Lines]",
      "124:                       this](int64 start, int64 end) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "238:     const int32 last_tree = resource->num_trees() - 1;",
      "239:     auto do_work = [&resource, &bucketized_features, &output_logits, last_tree,",
      "241:       for (int32 i = start; i < end; ++i) {",
      "242:         std::vector<float> tree_logits(logits_dimension_, 0.0);",
      "243:         int32 tree_id = 0;",
      "",
      "[Removed Lines]",
      "240:                     this](int32 start, int32 end) {",
      "",
      "[Added Lines]",
      "240:                     this](int64 start, int64 end) {",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "342:     auto do_work = [&resource, &bucketized_features, &output_debug_info,",
      "344:       for (int32 i = start; i < end; ++i) {",
      "346:         boosted_trees::DebugOutput example_debug_info;",
      "",
      "[Removed Lines]",
      "343:                     last_tree](int32 start, int32 end) {",
      "",
      "[Added Lines]",
      "343:                     last_tree](int64 start, int64 end) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/image/crop_and_resize_op.cc||tensorflow/core/kernels/image/crop_and_resize_op.cc": [
      "File: tensorflow/core/kernels/image/crop_and_resize_op.cc -> tensorflow/core/kernels/image/crop_and_resize_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "223:     const int depth = crops.dimension(3);",
      "227:       for (int b = start_box; b < limit_box; ++b) {",
      "228:         const float y1 = boxes(b, 0);",
      "229:         const float x1 = boxes(b, 1);",
      "",
      "[Removed Lines]",
      "226:     auto CropAndResizePerBox = [&](int start_box, int limit_box) {",
      "",
      "[Added Lines]",
      "226:     auto CropAndResizePerBox = [&](int64 start_box, int64 limit_box) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "450:     grads_image.setZero();",
      "453:       for (int b = start_box; b < limit_box; ++b) {",
      "454:         const float y1 = boxes(b, 0);",
      "455:         const float x1 = boxes(b, 1);",
      "",
      "[Removed Lines]",
      "452:     auto CropAndResizeBackImgPerBox = [&](int start_box, int limit_box) {",
      "",
      "[Added Lines]",
      "452:     auto CropAndResizeBackImgPerBox = [&](int64 start_box, int64 limit_box) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc||tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc": [
      "File: tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc -> tensorflow/core/kernels/linalg/banded_triangular_solve_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "194:     Shard(worker_threads.num_threads, worker_threads.workers, batch_size,",
      "195:           cost_per_unit,",
      "197:             SequentialBandedTriangularSolveKernel<Scalar>::Run(",
      "198:                 in_x, in_y, lower, adjoint, bcast, out, start, limit);",
      "199:           });",
      "",
      "[Removed Lines]",
      "196:           [&in_x, &in_y, adjoint, lower, &bcast, out](int start, int limit) {",
      "",
      "[Added Lines]",
      "196:           [&in_x, &in_y, adjoint, lower, &bcast, out](int64 start,",
      "197:                                                       int64 limit) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc": [
      "File: tensorflow/core/kernels/nth_element_op.cc -> tensorflow/core/kernels/nth_element_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "95:     const int last_dim = input_tensor.dim_size(input_tensor.dims() - 1);",
      "100:       std::vector<T> buf(last_dim);",
      "",
      "[Removed Lines]",
      "98:     auto SubNthElement = [&, input, output, last_dim, n](int start, int limit) {",
      "",
      "[Added Lines]",
      "98:     auto SubNthElement = [&, input, output, last_dim, n](int64 start,",
      "99:                                                          int64 limit) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
      "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "71:     auto do_work = [samples_per_batch, num_elements, &ctx, &means, &stddevs,",
      "72:                     &minvals, &maxvals, &gen, &output,",
      "",
      "[Removed Lines]",
      "73:                     kStdDevsInsideBoundsToUseRandnSampler](int start_batch,",
      "74:                                                            int limit_batch) {",
      "",
      "[Added Lines]",
      "73:                     kStdDevsInsideBoundsToUseRandnSampler](int64 start_batch,",
      "74:                                                            int64 limit_batch) {",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "334:     auto do_work = [num_batches, samples_per_batch, &ctx, &bcast, &means,",
      "335:                     &stddevs, &minvals, &maxvals, &gen, &output,",
      "",
      "[Removed Lines]",
      "336:                     kStdDevsInsideBoundsToUseRandnSampler](int start_output,",
      "337:                                                            int limit_output) {",
      "",
      "[Added Lines]",
      "336:                     kStdDevsInsideBoundsToUseRandnSampler](int64 start_output,",
      "337:                                                            int64 limit_output) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc": [
      "File: tensorflow/core/kernels/random_binomial_op.cc -> tensorflow/core/kernels/random_binomial_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "186:     auto DoWork = [num_batches, samples_per_batch, &bcast, &counts, &probs,",
      "190:       Eigen::array<T, 4> z;",
      "",
      "[Removed Lines]",
      "187:                    &gen, &output](int start_output, int limit_output) {",
      "",
      "[Added Lines]",
      "187:                    &gen, &output](int64 start_output, int64 limit_output) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc": [
      "File: tensorflow/core/kernels/random_poisson_op.cc -> tensorflow/core/kernels/random_poisson_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "97:     typedef random::UniformDistribution<random::PhiloxRandom, CT> Uniform;",
      "99:     auto DoWork = [num_samples, num_rate, &rng, samples_flat, rate_flat](",
      "",
      "[Removed Lines]",
      "100:                       int start_output, int limit_output) {",
      "",
      "[Added Lines]",
      "100:                       int64 start_output, int64 limit_output) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc": [
      "File: tensorflow/core/kernels/stateless_random_ops.cc -> tensorflow/core/kernels/stateless_random_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "254:     auto DoWork = [samples_per_alpha, num_alphas, &random, samples_flat,",
      "",
      "[Removed Lines]",
      "255:                    alpha_flat](int start_output, int limit_output) {",
      "",
      "[Added Lines]",
      "255:                    alpha_flat](int64 start_output, int64 limit_output) {",
      "",
      "---------------"
    ],
    "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc": [
      "File: tensorflow/core/kernels/topk_op.cc -> tensorflow/core/kernels/topk_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "136:       return Status::OK();",
      "137:     }",
      "140:       for (int32 b = start_batch; b < limit_batch; ++b) {",
      "141:         const T* input_data = &input(b, 0);",
      "142:         const auto stable_comp = [input_data](const int32 a, const int32 b) {",
      "",
      "[Removed Lines]",
      "139:     auto SortIndices = [&](int start_batch, int limit_batch) {",
      "",
      "[Added Lines]",
      "139:     auto SortIndices = [&](int64 start_batch, int64 limit_batch) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "42783a6d9e83fb3aae8e1885ae01ca68332856b5",
      "candidate_info": {
        "commit_hash": "42783a6d9e83fb3aae8e1885ae01ca68332856b5",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/42783a6d9e83fb3aae8e1885ae01ca68332856b5",
        "files": [
          "tensorflow/core/kernels/banded_triangular_solve_op.cc",
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/crop_and_resize_op.cc",
          "tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/stateless_random_ops.cc",
          "tensorflow/core/kernels/topk_op.cc"
        ],
        "message": "Prevent integer truncation from 64 to 32 bits.\n\nThe `tensorflow::Shard` functions last argument must be a 2 argument function where both arguments are `int64` (`long long`, 64 bits). However, there are usages where code passes in a function where arguments are `int` or `int32` (32 bits). In these cases, it is possible that the integer truncation would later cause a segfault or other unexpected behavior.\n\nPiperOrigin-RevId: 332560414\nChange-Id: Ief649406babc8d4f60b3e7a9d573cbcc5ce5b767",
        "before_after_code_files": [
          "tensorflow/core/kernels/banded_triangular_solve_op.cc||tensorflow/core/kernels/banded_triangular_solve_op.cc",
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/crop_and_resize_op.cc||tensorflow/core/kernels/crop_and_resize_op.cc",
          "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
          "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/banded_triangular_solve_op.cc||tensorflow/core/kernels/banded_triangular_solve_op.cc": [
          "File: tensorflow/core/kernels/banded_triangular_solve_op.cc -> tensorflow/core/kernels/banded_triangular_solve_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "194:     Shard(worker_threads.num_threads, worker_threads.workers, batch_size,",
          "195:           cost_per_unit,",
          "197:             SequentialBandedTriangularSolveKernel<Scalar>::Run(",
          "198:                 in_x, in_y, lower, adjoint, bcast, out, start, limit);",
          "199:           });",
          "",
          "[Removed Lines]",
          "196:           [&in_x, &in_y, adjoint, lower, &bcast, out](int start, int limit) {",
          "",
          "[Added Lines]",
          "196:           [&in_x, &in_y, adjoint, lower, &bcast, out](int64 start,",
          "197:                                                       int64 limit) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/prediction_ops.cc -> tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "121:       auto do_work = [&resource, &bucketized_features, &cached_tree_ids,",
          "122:                       &cached_node_ids, &output_partial_logits,",
          "123:                       &output_node_ids, latest_tree,",
          "125:         for (int32 i = start; i < end; ++i) {",
          "126:           int32 tree_id = cached_tree_ids(i);",
          "127:           int32 node_id = cached_node_ids(i);",
          "",
          "[Removed Lines]",
          "124:                       this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "124:                       this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "238:     const int32 last_tree = resource->num_trees() - 1;",
          "239:     auto do_work = [&resource, &bucketized_features, &output_logits, last_tree,",
          "241:       for (int32 i = start; i < end; ++i) {",
          "242:         std::vector<float> tree_logits(logits_dimension_, 0.0);",
          "243:         int32 tree_id = 0;",
          "",
          "[Removed Lines]",
          "240:                     this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "240:                     this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "342:     auto do_work = [&resource, &bucketized_features, &output_debug_info,",
          "344:       for (int32 i = start; i < end; ++i) {",
          "346:         boosted_trees::DebugOutput example_debug_info;",
          "",
          "[Removed Lines]",
          "343:                     last_tree](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "343:                     last_tree](int64 start, int64 end) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/crop_and_resize_op.cc||tensorflow/core/kernels/crop_and_resize_op.cc": [
          "File: tensorflow/core/kernels/crop_and_resize_op.cc -> tensorflow/core/kernels/crop_and_resize_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "223:     const int depth = crops.dimension(3);",
          "227:       for (int b = start_box; b < limit_box; ++b) {",
          "228:         const float y1 = boxes(b, 0);",
          "229:         const float x1 = boxes(b, 1);",
          "",
          "[Removed Lines]",
          "226:     auto CropAndResizePerBox = [&](int start_box, int limit_box) {",
          "",
          "[Added Lines]",
          "226:     auto CropAndResizePerBox = [&](int64 start_box, int64 limit_box) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "450:     grads_image.setZero();",
          "453:       for (int b = start_box; b < limit_box; ++b) {",
          "454:         const float y1 = boxes(b, 0);",
          "455:         const float x1 = boxes(b, 1);",
          "",
          "[Removed Lines]",
          "452:     auto CropAndResizeBackImgPerBox = [&](int start_box, int limit_box) {",
          "",
          "[Added Lines]",
          "452:     auto CropAndResizeBackImgPerBox = [&](int64 start_box, int64 limit_box) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc": [
          "File: tensorflow/core/kernels/nth_element_op.cc -> tensorflow/core/kernels/nth_element_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     const int last_dim = input_tensor.dim_size(input_tensor.dims() - 1);",
          "100:       std::vector<T> buf(last_dim);",
          "",
          "[Removed Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int start, int limit) {",
          "",
          "[Added Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int64 start,",
          "99:                                                          int64 limit) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:     auto do_work = [samples_per_batch, num_elements, &ctx, &means, &stddevs,",
          "72:                     &minvals, &maxvals, &gen, &output,",
          "",
          "[Removed Lines]",
          "73:                     kStdDevsInsideBoundsToUseRandnSampler](int start_batch,",
          "74:                                                            int limit_batch) {",
          "",
          "[Added Lines]",
          "73:                     kStdDevsInsideBoundsToUseRandnSampler](int64 start_batch,",
          "74:                                                            int64 limit_batch) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "334:     auto do_work = [num_batches, samples_per_batch, &ctx, &bcast, &means,",
          "335:                     &stddevs, &minvals, &maxvals, &gen, &output,",
          "",
          "[Removed Lines]",
          "336:                     kStdDevsInsideBoundsToUseRandnSampler](int start_output,",
          "337:                                                            int limit_output) {",
          "",
          "[Added Lines]",
          "336:                     kStdDevsInsideBoundsToUseRandnSampler](int64 start_output,",
          "337:                                                            int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc": [
          "File: tensorflow/core/kernels/random_binomial_op.cc -> tensorflow/core/kernels/random_binomial_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "184:     auto DoWork = [num_batches, samples_per_batch, &bcast, &counts, &probs,",
          "188:       Eigen::array<T, 4> z;",
          "",
          "[Removed Lines]",
          "185:                    &gen, &output](int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "185:                    &gen, &output](int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc": [
          "File: tensorflow/core/kernels/random_poisson_op.cc -> tensorflow/core/kernels/random_poisson_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "97:     typedef random::UniformDistribution<random::PhiloxRandom, CT> Uniform;",
          "99:     auto DoWork = [num_samples, num_rate, &rng, samples_flat, rate_flat](",
          "",
          "[Removed Lines]",
          "100:                       int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "100:                       int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc": [
          "File: tensorflow/core/kernels/stateless_random_ops.cc -> tensorflow/core/kernels/stateless_random_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "254:     auto DoWork = [samples_per_alpha, num_alphas, &random, samples_flat,",
          "",
          "[Removed Lines]",
          "255:                    alpha_flat](int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "255:                    alpha_flat](int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc": [
          "File: tensorflow/core/kernels/topk_op.cc -> tensorflow/core/kernels/topk_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "136:       return Status::OK();",
          "137:     }",
          "140:       for (int32 b = start_batch; b < limit_batch; ++b) {",
          "141:         const T* input_data = &input(b, 0);",
          "142:         const auto stable_comp = [input_data](const int32 a, const int32 b) {",
          "",
          "[Removed Lines]",
          "139:     auto SortIndices = [&](int start_batch, int limit_batch) {",
          "",
          "[Added Lines]",
          "139:     auto SortIndices = [&](int64 start_batch, int64 limit_batch) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "446b0ead53890e5fcb70c00ed35dbdd5cc42fc6d",
      "candidate_info": {
        "commit_hash": "446b0ead53890e5fcb70c00ed35dbdd5cc42fc6d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/446b0ead53890e5fcb70c00ed35dbdd5cc42fc6d",
        "files": [
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/topk_op.cc"
        ],
        "message": "Prevent integer truncation from 64 to 32 bits.\n\nThe `tensorflow::Shard` functions last argument must be a 2 argument function where both arguments are `int64` (`long long`, 64 bits). However, there are usages where code passes in a function where arguments are `int` or `int32` (32 bits). In these cases, it is possible that the integer truncation would later cause a segfault or other unexpected behavior.\n\nPiperOrigin-RevId: 332560414\nChange-Id: Ief649406babc8d4f60b3e7a9d573cbcc5ce5b767",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/prediction_ops.cc -> tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "109:       auto do_work = [&resource, &batch_bucketized_features, &cached_tree_ids,",
          "110:                       &cached_node_ids, &output_partial_logits,",
          "111:                       &output_node_ids, latest_tree,",
          "113:         for (int32 i = start; i < end; ++i) {",
          "114:           int32 tree_id = cached_tree_ids(i);",
          "115:           int32 node_id = cached_node_ids(i);",
          "",
          "[Removed Lines]",
          "112:                       this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "112:                       this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "228:     const int32 last_tree = resource->num_trees() - 1;",
          "229:     auto do_work = [&resource, &batch_bucketized_features, &output_logits,",
          "231:       for (int32 i = start; i < end; ++i) {",
          "232:         std::vector<float> tree_logits(logits_dimension_, 0.0);",
          "233:         int32 tree_id = 0;",
          "",
          "[Removed Lines]",
          "230:                     last_tree, this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "230:                     last_tree, this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "334:     auto do_work = [&resource, &batch_bucketized_features, &output_debug_info,",
          "336:       for (int32 i = start; i < end; ++i) {",
          "338:         boosted_trees::DebugOutput example_debug_info;",
          "",
          "[Removed Lines]",
          "335:                     last_tree](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "335:                     last_tree](int64 start, int64 end) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc": [
          "File: tensorflow/core/kernels/nth_element_op.cc -> tensorflow/core/kernels/nth_element_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     const int last_dim = input_tensor.dim_size(input_tensor.dims() - 1);",
          "100:       std::vector<T> buf(last_dim);",
          "",
          "[Removed Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int start, int limit) {",
          "",
          "[Added Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int64 start,",
          "99:                                                          int64 limit) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "70:     auto DoWork = [samples_per_batch, num_elements, &ctx, &means, &stddevs,",
          "71:                    &minvals, &maxvals, &gen, &output,",
          "",
          "[Removed Lines]",
          "72:                    kStdDevsInsideBoundsToUseRandnSampler](int start_batch,",
          "73:                                                           int limit_batch) {",
          "",
          "[Added Lines]",
          "72:                    kStdDevsInsideBoundsToUseRandnSampler](int64 start_batch,",
          "73:                                                           int64 limit_batch) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc": [
          "File: tensorflow/core/kernels/random_binomial_op.cc -> tensorflow/core/kernels/random_binomial_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "176:     auto worker_threads = *(ctx->device()->tensorflow_cpu_worker_threads());",
          "178:     auto DoWork = [samples_per_batch, num_elements, &counts, &probs, &gen,",
          "",
          "[Removed Lines]",
          "179:                    &output](int start_batch, int limit_batch) {",
          "",
          "[Added Lines]",
          "179:                    &output](int64 start_batch, int64 limit_batch) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc": [
          "File: tensorflow/core/kernels/random_poisson_op.cc -> tensorflow/core/kernels/random_poisson_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "103:     typedef random::UniformDistribution<random::PhiloxRandom, CT> Uniform;",
          "105:     auto DoWork = [num_samples, num_rate, &rng, samples_flat, rate_flat](",
          "",
          "[Removed Lines]",
          "106:                       int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "106:                       int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc": [
          "File: tensorflow/core/kernels/topk_op.cc -> tensorflow/core/kernels/topk_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "136:       return Status::OK();",
          "137:     }",
          "140:       for (int32 b = start_batch; b < limit_batch; ++b) {",
          "141:         const T* input_data = &input(b, 0);",
          "142:         const auto stable_comp = [input_data](const int32 a, const int32 b) {",
          "",
          "[Removed Lines]",
          "139:     auto SortIndices = [&](int start_batch, int limit_batch) {",
          "",
          "[Added Lines]",
          "139:     auto SortIndices = [&](int64 start_batch, int64 limit_batch) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ccb3e4cc2631198d10e488dc5a283e6209a2f0c7",
      "candidate_info": {
        "commit_hash": "ccb3e4cc2631198d10e488dc5a283e6209a2f0c7",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ccb3e4cc2631198d10e488dc5a283e6209a2f0c7",
        "files": [
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/stateless_random_ops.cc",
          "tensorflow/core/kernels/topk_op.cc"
        ],
        "message": "Prevent integer truncation from 64 to 32 bits.\n\nThe `tensorflow::Shard` functions last argument must be a 2 argument function where both arguments are `int64` (`long long`, 64 bits). However, there are usages where code passes in a function where arguments are `int` or `int32` (32 bits). In these cases, it is possible that the integer truncation would later cause a segfault or other unexpected behavior.\n\nPiperOrigin-RevId: 332560414\nChange-Id: Ief649406babc8d4f60b3e7a9d573cbcc5ce5b767",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
          "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
          "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
          "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
          "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
            "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc",
            "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
            "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc",
            "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc",
            "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc",
            "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/prediction_ops.cc||tensorflow/core/kernels/boosted_trees/prediction_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/prediction_ops.cc -> tensorflow/core/kernels/boosted_trees/prediction_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "121:       auto do_work = [&resource, &bucketized_features, &cached_tree_ids,",
          "122:                       &cached_node_ids, &output_partial_logits,",
          "123:                       &output_node_ids, latest_tree,",
          "125:         for (int32 i = start; i < end; ++i) {",
          "126:           int32 tree_id = cached_tree_ids(i);",
          "127:           int32 node_id = cached_node_ids(i);",
          "",
          "[Removed Lines]",
          "124:                       this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "124:                       this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "238:     const int32 last_tree = resource->num_trees() - 1;",
          "239:     auto do_work = [&resource, &bucketized_features, &output_logits, last_tree,",
          "241:       for (int32 i = start; i < end; ++i) {",
          "242:         std::vector<float> tree_logits(logits_dimension_, 0.0);",
          "243:         int32 tree_id = 0;",
          "",
          "[Removed Lines]",
          "240:                     this](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "240:                     this](int64 start, int64 end) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "342:     auto do_work = [&resource, &bucketized_features, &output_debug_info,",
          "344:       for (int32 i = start; i < end; ++i) {",
          "346:         boosted_trees::DebugOutput example_debug_info;",
          "",
          "[Removed Lines]",
          "343:                     last_tree](int32 start, int32 end) {",
          "",
          "[Added Lines]",
          "343:                     last_tree](int64 start, int64 end) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/nth_element_op.cc||tensorflow/core/kernels/nth_element_op.cc": [
          "File: tensorflow/core/kernels/nth_element_op.cc -> tensorflow/core/kernels/nth_element_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "95:     const int last_dim = input_tensor.dim_size(input_tensor.dims() - 1);",
          "100:       std::vector<T> buf(last_dim);",
          "",
          "[Removed Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int start, int limit) {",
          "",
          "[Added Lines]",
          "98:     auto SubNthElement = [&, input, output, last_dim, n](int64 start,",
          "99:                                                          int64 limit) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/parameterized_truncated_normal_op.cc||tensorflow/core/kernels/parameterized_truncated_normal_op.cc": [
          "File: tensorflow/core/kernels/parameterized_truncated_normal_op.cc -> tensorflow/core/kernels/parameterized_truncated_normal_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "70:     auto DoWork = [samples_per_batch, num_elements, &ctx, &means, &stddevs,",
          "71:                    &minvals, &maxvals, &gen, &output,",
          "",
          "[Removed Lines]",
          "72:                    kStdDevsInsideBoundsToUseRandnSampler](int start_batch,",
          "73:                                                           int limit_batch) {",
          "",
          "[Added Lines]",
          "72:                    kStdDevsInsideBoundsToUseRandnSampler](int64 start_batch,",
          "73:                                                           int64 limit_batch) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_binomial_op.cc||tensorflow/core/kernels/random_binomial_op.cc": [
          "File: tensorflow/core/kernels/random_binomial_op.cc -> tensorflow/core/kernels/random_binomial_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "184:     auto DoWork = [num_batches, samples_per_batch, &bcast, &counts, &probs,",
          "188:       Eigen::array<T, 4> z;",
          "",
          "[Removed Lines]",
          "185:                    &gen, &output](int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "185:                    &gen, &output](int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/random_poisson_op.cc||tensorflow/core/kernels/random_poisson_op.cc": [
          "File: tensorflow/core/kernels/random_poisson_op.cc -> tensorflow/core/kernels/random_poisson_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "97:     typedef random::UniformDistribution<random::PhiloxRandom, CT> Uniform;",
          "99:     auto DoWork = [num_samples, num_rate, &rng, samples_flat, rate_flat](",
          "",
          "[Removed Lines]",
          "100:                       int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "100:                       int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/stateless_random_ops.cc||tensorflow/core/kernels/stateless_random_ops.cc": [
          "File: tensorflow/core/kernels/stateless_random_ops.cc -> tensorflow/core/kernels/stateless_random_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "254:     auto DoWork = [samples_per_alpha, num_alphas, &random, samples_flat,",
          "",
          "[Removed Lines]",
          "255:                    alpha_flat](int start_output, int limit_output) {",
          "",
          "[Added Lines]",
          "255:                    alpha_flat](int64 start_output, int64 limit_output) {",
          "",
          "---------------"
        ],
        "tensorflow/core/kernels/topk_op.cc||tensorflow/core/kernels/topk_op.cc": [
          "File: tensorflow/core/kernels/topk_op.cc -> tensorflow/core/kernels/topk_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "136:       return Status::OK();",
          "137:     }",
          "140:       for (int32 b = start_batch; b < limit_batch; ++b) {",
          "141:         const T* input_data = &input(b, 0);",
          "142:         const auto stable_comp = [input_data](const int32 a, const int32 b) {",
          "",
          "[Removed Lines]",
          "139:     auto SortIndices = [&](int start_batch, int limit_batch) {",
          "",
          "[Added Lines]",
          "139:     auto SortIndices = [&](int64 start_batch, int64 limit_batch) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}