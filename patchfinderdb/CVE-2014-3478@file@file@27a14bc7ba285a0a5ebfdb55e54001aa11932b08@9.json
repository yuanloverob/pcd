{
  "cve_id": "CVE-2014-3478",
  "cve_desc": "Buffer overflow in the mconvert function in softmagic.c in file before 5.19, as used in the Fileinfo component in PHP before 5.4.30 and 5.5.x before 5.5.14, allows remote attackers to cause a denial of service (application crash) via a crafted Pascal string in a FILE_PSTRING conversion.",
  "repo": "file/file",
  "patch_hash": "27a14bc7ba285a0a5ebfdb55e54001aa11932b08",
  "patch_info": {
    "commit_hash": "27a14bc7ba285a0a5ebfdb55e54001aa11932b08",
    "repo": "file/file",
    "commit_url": "https://github.com/file/file/commit/27a14bc7ba285a0a5ebfdb55e54001aa11932b08",
    "files": [
      "src/softmagic.c"
    ],
    "message": "Correctly compute the truncated pascal string size (Francisco Alonso and Jan Kaluza at RedHat)",
    "before_after_code_files": [
      "src/softmagic.c||src/softmagic.c"
    ]
  },
  "patch_diff": {
    "src/softmagic.c||src/softmagic.c": [
      "File: src/softmagic.c -> src/softmagic.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "32: #include \"file.h\"",
      "34: #ifndef lint",
      "38: #include \"magic.h\"",
      "",
      "[Removed Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.189 2014/05/30 16:47:44 christos Exp $\")",
      "",
      "[Added Lines]",
      "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.190 2014/06/03 19:01:34 christos Exp $\")",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "940:   return 1;",
      "941:  }",
      "942:  case FILE_PSTRING: {",
      "944:   size_t len = file_pstring_get_length(m, ptr1);",
      "947:   while (len--)",
      "",
      "[Removed Lines]",
      "943:   char *ptr1 = p->s, *ptr2 = ptr1 + file_pstring_length_size(m);",
      "945:   if (len >= sizeof(p->s))",
      "946:    len = sizeof(p->s) - 1;",
      "",
      "[Added Lines]",
      "943:   size_t sz = file_pstring_length_size(m);",
      "944:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
      "946:   if (len >= sizeof(p->s)) {",
      "953:    len = sizeof(p->s) - sz;",
      "954:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2091732d23c52d7e58c073cae832b2039486e04d",
      "candidate_info": {
        "commit_hash": "2091732d23c52d7e58c073cae832b2039486e04d",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/2091732d23c52d7e58c073cae832b2039486e04d",
        "files": [
          "src/softmagic.c"
        ],
        "message": "- always do arithmetic on dates - fix T_LOCAL reversed logic",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.209 2015/01/05 20:05:39 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.210 2015/01/05 20:21:30 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "548:  case FILE_LEDATE:",
          "549:  case FILE_MEDATE:",
          "550:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "552:    return -1;",
          "553:   t = ms->offset + sizeof(uint32_t);",
          "554:   break;",
          "",
          "[Removed Lines]",
          "551:       file_fmttime(p->l + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "551:       file_fmttime(p->l, 0, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "558:  case FILE_LELDATE:",
          "559:  case FILE_MELDATE:",
          "560:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "562:    return -1;",
          "563:   t = ms->offset + sizeof(uint32_t);",
          "564:   break;",
          "",
          "[Removed Lines]",
          "561:       file_fmttime(p->l + m->num_mask, 0, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "561:       file_fmttime(p->l, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "567:  case FILE_BEQDATE:",
          "568:  case FILE_LEQDATE:",
          "569:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "571:    return -1;",
          "572:   t = ms->offset + sizeof(uint64_t);",
          "573:   break;",
          "",
          "[Removed Lines]",
          "570:       file_fmttime(p->q + m->num_mask, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "570:       file_fmttime(p->q, 0, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "576:  case FILE_BEQLDATE:",
          "577:  case FILE_LEQLDATE:",
          "578:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "580:    return -1;",
          "581:   t = ms->offset + sizeof(uint64_t);",
          "582:   break;",
          "",
          "[Removed Lines]",
          "579:       file_fmttime(p->q + m->num_mask, 0, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "579:       file_fmttime(p->q, FILE_T_LOCAL, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "585:  case FILE_BEQWDATE:",
          "586:  case FILE_LEQWDATE:",
          "587:   if (file_printf(ms, F(ms, m, \"%s\"),",
          "589:    return -1;",
          "590:   t = ms->offset + sizeof(uint64_t);",
          "591:   break;",
          "",
          "[Removed Lines]",
          "588:       file_fmttime(p->q + m->num_mask, FILE_T_WINDOWS, tbuf)) == -1)",
          "",
          "[Added Lines]",
          "588:       file_fmttime(p->q, FILE_T_WINDOWS, tbuf)) == -1)",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "970:  case FILE_BELDATE:",
          "971:   p->l = (int32_t)",
          "972:       ((p->hl[0]<<24)|(p->hl[1]<<16)|(p->hl[2]<<8)|(p->hl[3]));",
          "975:   return 1;",
          "976:  case FILE_BEQUAD:",
          "977:  case FILE_BEQDATE:",
          "",
          "[Removed Lines]",
          "973:   if (type == FILE_BELONG)",
          "974:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "973:   cvt_32(p, m);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "982:        ((uint64_t)p->hq[2]<<40)|((uint64_t)p->hq[3]<<32)|",
          "983:        ((uint64_t)p->hq[4]<<24)|((uint64_t)p->hq[5]<<16)|",
          "984:        ((uint64_t)p->hq[6]<<8)|((uint64_t)p->hq[7]));",
          "987:   return 1;",
          "988:  case FILE_LESHORT:",
          "989:   p->h = (short)((p->hs[1]<<8)|(p->hs[0]));",
          "",
          "[Removed Lines]",
          "985:   if (type == FILE_BEQUAD)",
          "986:    cvt_64(p, m);",
          "",
          "[Added Lines]",
          "984:   cvt_64(p, m);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "994:  case FILE_LELDATE:",
          "995:   p->l = (int32_t)",
          "996:       ((p->hl[3]<<24)|(p->hl[2]<<16)|(p->hl[1]<<8)|(p->hl[0]));",
          "999:   return 1;",
          "1000:  case FILE_LEQUAD:",
          "1001:  case FILE_LEQDATE:",
          "",
          "[Removed Lines]",
          "997:   if (type == FILE_LELONG)",
          "998:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "995:   cvt_32(p, m);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1006:        ((uint64_t)p->hq[5]<<40)|((uint64_t)p->hq[4]<<32)|",
          "1007:        ((uint64_t)p->hq[3]<<24)|((uint64_t)p->hq[2]<<16)|",
          "1008:        ((uint64_t)p->hq[1]<<8)|((uint64_t)p->hq[0]));",
          "1011:   return 1;",
          "1012:  case FILE_MELONG:",
          "1013:  case FILE_MEDATE:",
          "1014:  case FILE_MELDATE:",
          "1015:   p->l = (int32_t)",
          "1016:       ((p->hl[1]<<24)|(p->hl[0]<<16)|(p->hl[3]<<8)|(p->hl[2]));",
          "1019:   return 1;",
          "1020:  case FILE_FLOAT:",
          "1021:   cvt_float(p, m);",
          "",
          "[Removed Lines]",
          "1009:   if (type == FILE_LEQUAD)",
          "1010:    cvt_64(p, m);",
          "1017:   if (type == FILE_MELONG)",
          "1018:    cvt_32(p, m);",
          "",
          "[Added Lines]",
          "1006:   cvt_64(p, m);",
          "1013:   cvt_32(p, m);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b59b1691ede36b7adf25eeaf8fcf85bc2ae67a48",
      "candidate_info": {
        "commit_hash": "b59b1691ede36b7adf25eeaf8fcf85bc2ae67a48",
        "repo": "file/file",
        "commit_url": "https://github.com/file/file/commit/b59b1691ede36b7adf25eeaf8fcf85bc2ae67a48",
        "files": [
          "src/softmagic.c"
        ],
        "message": "Correctly compute the truncated pascal string size (Francisco Alonso and Jan Kaluza at RedHat)",
        "before_after_code_files": [
          "src/softmagic.c||src/softmagic.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "src/softmagic.c||src/softmagic.c"
          ],
          "candidate": [
            "src/softmagic.c||src/softmagic.c"
          ]
        }
      },
      "candidate_diff": {
        "src/softmagic.c||src/softmagic.c": [
          "File: src/softmagic.c -> src/softmagic.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "32: #include \"file.h\"",
          "34: #ifndef lint",
          "38: #include \"magic.h\"",
          "",
          "[Removed Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.190 2014/06/03 19:01:34 christos Exp $\")",
          "",
          "[Added Lines]",
          "35: FILE_RCSID(\"@(#)$File: softmagic.c,v 1.191 2014/06/04 17:36:34 christos Exp $\")",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "940:   return 1;",
          "941:  }",
          "942:  case FILE_PSTRING: {",
          "944:   size_t len = file_pstring_get_length(m, ptr1);",
          "947:   while (len--)",
          "",
          "[Removed Lines]",
          "943:   char *ptr1 = p->s, *ptr2 = ptr1 + file_pstring_length_size(m);",
          "945:   if (len >= sizeof(p->s))",
          "946:    len = sizeof(p->s) - 1;",
          "",
          "[Added Lines]",
          "943:   size_t sz = file_pstring_length_size(m);",
          "944:   char *ptr1 = p->s, *ptr2 = ptr1 + sz;",
          "946:   if (len >= sizeof(p->s)) {",
          "953:    len = sizeof(p->s) - sz;",
          "954:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}