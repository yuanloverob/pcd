{
  "cve_id": "CVE-2021-37651",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions the implementation for `tf.raw_ops.FractionalAvgPoolGrad` can be tricked into accessing data outside of bounds of heap allocated buffers. The [implementation](https://github.com/tensorflow/tensorflow/blob/f24faa153ad31a4b51578f8181d3aaab77a1ddeb/tensorflow/core/kernels/fractional_avg_pool_op.cc#L205) does not validate that the input tensor is non-empty. Thus, code constructs an empty `EigenDoubleMatrixMap` and then accesses this buffer with indices that are outside of the empty area. We have patched the issue in GitHub commit 0f931751fb20f565c4e94aa6df58d54a003cdb30. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "0f931751fb20f565c4e94aa6df58d54a003cdb30",
  "patch_info": {
    "commit_hash": "0f931751fb20f565c4e94aa6df58d54a003cdb30",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/0f931751fb20f565c4e94aa6df58d54a003cdb30",
    "files": [
      "tensorflow/core/kernels/fractional_avg_pool_op.cc"
    ],
    "message": "Validate dimensions of input tensor in `FractionalAvgPoolGrad`\n\nPiperOrigin-RevId: 388286227\nChange-Id: Ieb7566155e92acc8993a2212c76deacadc0edc8a",
    "before_after_code_files": [
      "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
      "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "271:     const int64_t in_rows = orig_input_tensor_shape_flat(1);",
      "272:     const int64_t in_cols = orig_input_tensor_shape_flat(2);",
      "273:     const int64_t in_depth = orig_input_tensor_shape_flat(3);",
      "275:     constexpr int tensor_in_and_out_dims = 4;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "274:     OP_REQUIRES(",
      "275:         context, in_batch != 0,",
      "276:         errors::InvalidArgument(\"Batch dimension of input must not be 0\"));",
      "277:     OP_REQUIRES(",
      "278:         context, in_rows != 0,",
      "279:         errors::InvalidArgument(\"Rows dimension of input must not be 0\"));",
      "280:     OP_REQUIRES(",
      "281:         context, in_cols != 0,",
      "282:         errors::InvalidArgument(\"Columns dimension of input must not be 0\"));",
      "283:     OP_REQUIRES(",
      "284:         context, in_depth != 0,",
      "285:         errors::InvalidArgument(\"Depth dimension of input must not be 0\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8d84da87382aea3f0be163360510554117e68998",
      "candidate_info": {
        "commit_hash": "8d84da87382aea3f0be163360510554117e68998",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/8d84da87382aea3f0be163360510554117e68998",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate dimensions of input tensor in `FractionalAvgPoolGrad`\n\nPiperOrigin-RevId: 388286227\nChange-Id: Ieb7566155e92acc8993a2212c76deacadc0edc8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "271:     const int64 in_rows = orig_input_tensor_shape_flat(1);",
          "272:     const int64 in_cols = orig_input_tensor_shape_flat(2);",
          "273:     const int64 in_depth = orig_input_tensor_shape_flat(3);",
          "275:     constexpr int tensor_in_and_out_dims = 4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "274:     OP_REQUIRES(",
          "275:         context, in_batch != 0,",
          "276:         errors::InvalidArgument(\"Batch dimension of input must not be 0\"));",
          "277:     OP_REQUIRES(",
          "278:         context, in_rows != 0,",
          "279:         errors::InvalidArgument(\"Rows dimension of input must not be 0\"));",
          "280:     OP_REQUIRES(",
          "281:         context, in_cols != 0,",
          "282:         errors::InvalidArgument(\"Columns dimension of input must not be 0\"));",
          "283:     OP_REQUIRES(",
          "284:         context, in_depth != 0,",
          "285:         errors::InvalidArgument(\"Depth dimension of input must not be 0\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "280653e243a5ade5d3f1207a8269dd739efa3bd8",
      "candidate_info": {
        "commit_hash": "280653e243a5ade5d3f1207a8269dd739efa3bd8",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/280653e243a5ade5d3f1207a8269dd739efa3bd8",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate dimensions of input tensor in `FractionalAvgPoolGrad`\n\nPiperOrigin-RevId: 388286227\nChange-Id: Ieb7566155e92acc8993a2212c76deacadc0edc8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "271:     const int64 in_rows = orig_input_tensor_shape_flat(1);",
          "272:     const int64 in_cols = orig_input_tensor_shape_flat(2);",
          "273:     const int64 in_depth = orig_input_tensor_shape_flat(3);",
          "275:     constexpr int tensor_in_and_out_dims = 4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "274:     OP_REQUIRES(",
          "275:         context, in_batch != 0,",
          "276:         errors::InvalidArgument(\"Batch dimension of input must not be 0\"));",
          "277:     OP_REQUIRES(",
          "278:         context, in_rows != 0,",
          "279:         errors::InvalidArgument(\"Rows dimension of input must not be 0\"));",
          "280:     OP_REQUIRES(",
          "281:         context, in_cols != 0,",
          "282:         errors::InvalidArgument(\"Columns dimension of input must not be 0\"));",
          "283:     OP_REQUIRES(",
          "284:         context, in_depth != 0,",
          "285:         errors::InvalidArgument(\"Depth dimension of input must not be 0\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f655cb73298d48d3df24d47f14cc41cf9c090601",
      "candidate_info": {
        "commit_hash": "f655cb73298d48d3df24d47f14cc41cf9c090601",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f655cb73298d48d3df24d47f14cc41cf9c090601",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate dimensions of input tensor in `FractionalAvgPoolGrad`\n\nPiperOrigin-RevId: 388286227\nChange-Id: Ieb7566155e92acc8993a2212c76deacadc0edc8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "271:     const int64 in_rows = orig_input_tensor_shape_flat(1);",
          "272:     const int64 in_cols = orig_input_tensor_shape_flat(2);",
          "273:     const int64 in_depth = orig_input_tensor_shape_flat(3);",
          "275:     constexpr int tensor_in_and_out_dims = 4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "274:     OP_REQUIRES(",
          "275:         context, in_batch != 0,",
          "276:         errors::InvalidArgument(\"Batch dimension of input must not be 0\"));",
          "277:     OP_REQUIRES(",
          "278:         context, in_rows != 0,",
          "279:         errors::InvalidArgument(\"Rows dimension of input must not be 0\"));",
          "280:     OP_REQUIRES(",
          "281:         context, in_cols != 0,",
          "282:         errors::InvalidArgument(\"Columns dimension of input must not be 0\"));",
          "283:     OP_REQUIRES(",
          "284:         context, in_depth != 0,",
          "285:         errors::InvalidArgument(\"Depth dimension of input must not be 0\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c91ba1ce78af68d1918cb1709b973d2ebcff1b50",
      "candidate_info": {
        "commit_hash": "c91ba1ce78af68d1918cb1709b973d2ebcff1b50",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/c91ba1ce78af68d1918cb1709b973d2ebcff1b50",
        "files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ],
        "message": "Validate dimensions of input tensor in `FractionalAvgPoolGrad`\n\nPiperOrigin-RevId: 388286227\nChange-Id: Ieb7566155e92acc8993a2212c76deacadc0edc8a",
        "before_after_code_files": [
          "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/fractional_avg_pool_op.cc||tensorflow/core/kernels/fractional_avg_pool_op.cc": [
          "File: tensorflow/core/kernels/fractional_avg_pool_op.cc -> tensorflow/core/kernels/fractional_avg_pool_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "271:     const int64 in_rows = orig_input_tensor_shape_flat(1);",
          "272:     const int64 in_cols = orig_input_tensor_shape_flat(2);",
          "273:     const int64 in_depth = orig_input_tensor_shape_flat(3);",
          "275:     constexpr int tensor_in_and_out_dims = 4;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "274:     OP_REQUIRES(",
          "275:         context, in_batch != 0,",
          "276:         errors::InvalidArgument(\"Batch dimension of input must not be 0\"));",
          "277:     OP_REQUIRES(",
          "278:         context, in_rows != 0,",
          "279:         errors::InvalidArgument(\"Rows dimension of input must not be 0\"));",
          "280:     OP_REQUIRES(",
          "281:         context, in_cols != 0,",
          "282:         errors::InvalidArgument(\"Columns dimension of input must not be 0\"));",
          "283:     OP_REQUIRES(",
          "284:         context, in_depth != 0,",
          "285:         errors::InvalidArgument(\"Depth dimension of input must not be 0\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}