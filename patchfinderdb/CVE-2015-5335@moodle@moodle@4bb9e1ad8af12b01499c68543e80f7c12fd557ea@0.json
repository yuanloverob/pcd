{
  "cve_id": "CVE-2015-5335",
  "cve_desc": "Cross-site request forgery (CSRF) vulnerability in admin/registration/register.php in Moodle through 2.6.11, 2.7.x before 2.7.11, 2.8.x before 2.8.9, and 2.9.x before 2.9.3 allows remote attackers to hijack the authentication of administrators for requests that send statistics to an arbitrary hub URL.",
  "repo": "moodle/moodle",
  "patch_hash": "4bb9e1ad8af12b01499c68543e80f7c12fd557ea",
  "patch_info": {
    "commit_hash": "4bb9e1ad8af12b01499c68543e80f7c12fd557ea",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/4bb9e1ad8af12b01499c68543e80f7c12fd557ea",
    "files": [
      "admin/registration/register.php",
      "admin/settings/top.php"
    ],
    "message": "MDL-51091 core_registration: session key check in registration.",
    "before_after_code_files": [
      "admin/registration/register.php||admin/registration/register.php",
      "admin/settings/top.php||admin/settings/top.php"
    ]
  },
  "patch_diff": {
    "admin/registration/register.php||admin/registration/register.php": [
      "File: admin/registration/register.php -> admin/registration/register.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39: require_once($CFG->dirroot . '/webservice/lib.php');",
      "40: require_once($CFG->dirroot . '/' . $CFG->admin . '/registration/lib.php');",
      "42: $huburl = required_param('huburl', PARAM_URL);",
      "43: $huburl = rtrim($huburl, \"/\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "42: require_sesskey();",
      "",
      "---------------"
    ],
    "admin/settings/top.php||admin/settings/top.php": [
      "File: admin/settings/top.php -> admin/settings/top.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "11: $ADMIN->add('root', new admin_externalpage('adminnotifications', new lang_string('notifications'), \"$CFG->wwwroot/$CFG->admin/index.php\"));",
      "13: $ADMIN->add('root', new admin_externalpage('registrationmoodleorg', new lang_string('registration', 'admin'),",
      "15: $ADMIN->add('root', new admin_externalpage('registrationhub', new lang_string('registerwith', 'hub'),",
      "16:         \"$CFG->wwwroot/$CFG->admin/registration/register.php\", 'moodle/site:config', true));",
      "17: $ADMIN->add('root', new admin_externalpage('registrationhubs', new lang_string('hubs', 'admin'),",
      "",
      "[Removed Lines]",
      "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org\"));",
      "",
      "[Added Lines]",
      "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org&sesskey=\" . sesskey()));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7bf5c6a542efa113dbb241a113cb6079f0572443",
      "candidate_info": {
        "commit_hash": "7bf5c6a542efa113dbb241a113cb6079f0572443",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/7bf5c6a542efa113dbb241a113cb6079f0572443",
        "files": [
          "admin/registration/register.php",
          "admin/settings/top.php"
        ],
        "message": "MDL-51091 core_registration: session key check in registration.",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php",
          "admin/settings/top.php||admin/settings/top.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: require_once($CFG->dirroot . '/webservice/lib.php');",
          "40: require_once($CFG->dirroot . '/' . $CFG->admin . '/registration/lib.php');",
          "42: $huburl = required_param('huburl', PARAM_URL);",
          "43: $huburl = rtrim($huburl, \"/\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: require_sesskey();",
          "",
          "---------------"
        ],
        "admin/settings/top.php||admin/settings/top.php": [
          "File: admin/settings/top.php -> admin/settings/top.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: $ADMIN->add('root', new admin_externalpage('adminnotifications', new lang_string('notifications'), \"$CFG->wwwroot/$CFG->admin/index.php\"));",
          "13: $ADMIN->add('root', new admin_externalpage('registrationmoodleorg', new lang_string('registration', 'admin'),",
          "15: $ADMIN->add('root', new admin_externalpage('registrationhub', new lang_string('registerwith', 'hub'),",
          "16:         \"$CFG->wwwroot/$CFG->admin/registration/register.php\", 'moodle/site:config', true));",
          "17: $ADMIN->add('root', new admin_externalpage('registrationhubs', new lang_string('hubs', 'admin'),",
          "",
          "[Removed Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org\"));",
          "",
          "[Added Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org&sesskey=\" . sesskey()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "77e072ebec68ba685551b886b71054d1feae6c94",
      "candidate_info": {
        "commit_hash": "77e072ebec68ba685551b886b71054d1feae6c94",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/77e072ebec68ba685551b886b71054d1feae6c94",
        "files": [
          "admin/registration/register.php",
          "admin/settings/top.php"
        ],
        "message": "MDL-51091 core_registration: session key check in registration.",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php",
          "admin/settings/top.php||admin/settings/top.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: require_once($CFG->dirroot . '/webservice/lib.php');",
          "40: require_once($CFG->dirroot . '/' . $CFG->admin . '/registration/lib.php');",
          "42: $huburl = required_param('huburl', PARAM_URL);",
          "43: $huburl = rtrim($huburl, \"/\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: require_sesskey();",
          "",
          "---------------"
        ],
        "admin/settings/top.php||admin/settings/top.php": [
          "File: admin/settings/top.php -> admin/settings/top.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: $ADMIN->add('root', new admin_externalpage('adminnotifications', new lang_string('notifications'), \"$CFG->wwwroot/$CFG->admin/index.php\"));",
          "13: $ADMIN->add('root', new admin_externalpage('registrationmoodleorg', new lang_string('registration', 'admin'),",
          "15: $ADMIN->add('root', new admin_externalpage('registrationhub', new lang_string('registerwith', 'hub'),",
          "16:         \"$CFG->wwwroot/$CFG->admin/registration/register.php\", 'moodle/site:config', true));",
          "17: $ADMIN->add('root', new admin_externalpage('registrationhubs', new lang_string('hubs', 'admin'),",
          "",
          "[Removed Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org\"));",
          "",
          "[Added Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org&sesskey=\" . sesskey()));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a1168a7427f8fa1926a771fe8e6d10aeb6689686",
      "candidate_info": {
        "commit_hash": "a1168a7427f8fa1926a771fe8e6d10aeb6689686",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/a1168a7427f8fa1926a771fe8e6d10aeb6689686",
        "files": [
          "admin/registration/register.php",
          "admin/settings/top.php"
        ],
        "message": "MDL-51091 core_registration: session key check in registration.",
        "before_after_code_files": [
          "admin/registration/register.php||admin/registration/register.php",
          "admin/settings/top.php||admin/settings/top.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ],
          "candidate": [
            "admin/registration/register.php||admin/registration/register.php",
            "admin/settings/top.php||admin/settings/top.php"
          ]
        }
      },
      "candidate_diff": {
        "admin/registration/register.php||admin/registration/register.php": [
          "File: admin/registration/register.php -> admin/registration/register.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "39: require_once($CFG->dirroot . '/webservice/lib.php');",
          "40: require_once($CFG->dirroot . '/' . $CFG->admin . '/registration/lib.php');",
          "42: $huburl = required_param('huburl', PARAM_URL);",
          "43: $huburl = rtrim($huburl, \"/\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "42: require_sesskey();",
          "",
          "---------------"
        ],
        "admin/settings/top.php||admin/settings/top.php": [
          "File: admin/settings/top.php -> admin/settings/top.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "11: $ADMIN->add('root', new admin_externalpage('adminnotifications', new lang_string('notifications'), \"$CFG->wwwroot/$CFG->admin/index.php\"));",
          "13: $ADMIN->add('root', new admin_externalpage('registrationmoodleorg', new lang_string('registration', 'admin'),",
          "15: $ADMIN->add('root', new admin_externalpage('registrationhub', new lang_string('registerwith', 'hub'),",
          "16:         \"$CFG->wwwroot/$CFG->admin/registration/register.php\", 'moodle/site:config', true));",
          "17: $ADMIN->add('root', new admin_externalpage('registrationhubs', new lang_string('hubs', 'admin'),",
          "",
          "[Removed Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org\"));",
          "",
          "[Added Lines]",
          "14:         \"$CFG->wwwroot/$CFG->admin/registration/register.php?huburl=\" . HUB_MOODLEORGHUBURL . \"&hubname=Moodle.org&sesskey=\" . sesskey()));",
          "",
          "---------------"
        ]
      }
    }
  ]
}