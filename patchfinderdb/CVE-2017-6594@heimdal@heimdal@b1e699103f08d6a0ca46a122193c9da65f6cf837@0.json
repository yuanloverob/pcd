{
  "cve_id": "CVE-2017-6594",
  "cve_desc": "The transit path validation code in Heimdal before 7.3 might allow attackers to bypass the capath policy protection mechanism by leveraging failure to add the previous hop realm to the transit path of issued tickets.",
  "repo": "heimdal/heimdal",
  "patch_hash": "b1e699103f08d6a0ca46a122193c9da65f6cf837",
  "patch_info": {
    "commit_hash": "b1e699103f08d6a0ca46a122193c9da65f6cf837",
    "repo": "heimdal/heimdal",
    "commit_url": "https://github.com/heimdal/heimdal/commit/b1e699103f08d6a0ca46a122193c9da65f6cf837",
    "files": [
      "NEWS",
      "kdc/krb5tgs.c",
      "tests/kdc/check-kdc.in",
      "tests/kdc/krb5.conf.in"
    ],
    "message": "Fix transit path validation CVE-2017-6594\n\nCommit f469fc6 (2010-10-02) inadvertently caused the previous hop realm\nto not be added to the transit path of issued tickets.  This may, in\nsome cases, enable bypass of capath policy in Heimdal versions 1.5\nthrough 7.2.\n\nNote, this may break sites that rely on the bug.  With the bug some\nincomplete [capaths] worked, that should not have.  These may now break\nauthentication in some cross-realm configurations.",
    "before_after_code_files": [
      "kdc/krb5tgs.c||kdc/krb5tgs.c",
      "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in",
      "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in"
    ]
  },
  "patch_diff": {
    "kdc/krb5tgs.c||kdc/krb5tgs.c": [
      "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "737:         const char *server_name,",
      "738:         hdb_entry_ex *client,",
      "739:         krb5_principal client_principal,",
      "740:         hdb_entry_ex *krbtgt,",
      "741:         krb5_enctype krbtgt_etype,",
      "742:         krb5_principals spp,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "744:                const char *tgt_realm,",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "798:      &tgt->transited, &et,",
      "799:      krb5_principal_get_realm(context, client_principal),",
      "800:      krb5_principal_get_realm(context, server->entry.principal),",
      "802:     if(ret)",
      "803:  goto out;",
      "",
      "[Removed Lines]",
      "801:      krb5_principal_get_realm(context, krbtgt->entry.principal));",
      "",
      "[Added Lines]",
      "806:      tgt_realm);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1519:     krb5_keyblock sessionkey;",
      "1520:     krb5_kvno kvno;",
      "1521:     krb5_data rspac;",
      "1523:         krb5_principal_get_comp_string(context, krbtgt->entry.principal, 1);",
      "1524:     char **capath = NULL;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1528:         krb5_principal_get_realm(context, krbtgt->entry.principal);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2324:     spn,",
      "2325:     client,",
      "2326:     cp,",
      "2327:     krbtgt_out,",
      "2328:     tkey_sign->key.keytype,",
      "2329:     spp,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2334:                          tgt_realm,",
      "",
      "---------------"
    ],
    "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in": [
      "File: tests/kdc/check-kdc.in -> tests/kdc/check-kdc.in",
      "--- Hunk 1 ---",
      "[Context before]",
      "53: R5=SOME-REALM5.FR",
      "54: R6=SOME-REALM6.US",
      "55: R7=SOME-REALM7.UK",
      "57: H1=H1.$R",
      "58: H2=H2.$R",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "56: R8=SOME-REALM8.UK",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "148:     --realm-max-renewable-life=1month \\",
      "149:     ${R7} || exit 1",
      "151: ${kadmin} \\",
      "152:     init \\",
      "153:     --realm-max-ticket-life=1day \\",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "152: ${kadmin} \\",
      "153:     init \\",
      "154:     --realm-max-ticket-life=1day \\",
      "155:     --realm-max-renewable-life=1month \\",
      "156:     ${R8} || exit 1",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "191: ${kadmin5} add -p foo --use-defaults foo@${R5} || exit 1",
      "192: ${kadmin} add -p foo --use-defaults foo@${R6} || exit 1",
      "193: ${kadmin} add -p foo --use-defaults foo@${R7} || exit 1",
      "194: ${kadmin} add -p foo --use-defaults foo@${H1} || exit 1",
      "195: ${kadmin} add -p foo --use-defaults foo/host.${h1}@${H1} || exit 1",
      "196: ${kadmin} add -p foo --use-defaults foo@${H2} || exit 1",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "201: ${kadmin} add -p foo --use-defaults foo@${R8} || exit 1",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "249: ${kadmin} add -p cross1 --use-defaults krbtgt/${R7}@${R6} || exit 1",
      "250: ${kadmin} add -p cross2 --use-defaults krbtgt/${R6}@${R7} || exit 1",
      "252: ${kadmin} add -p cross1 --use-defaults krbtgt/${H1}@${R} || exit 1",
      "253: ${kadmin} add -p cross2 --use-defaults krbtgt/${R}@${H1} || exit 1",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "260: ${kadmin} add -p cross1 --use-defaults krbtgt/${R8}@${R6} || exit 1",
      "261: ${kadmin} add -p cross2 --use-defaults krbtgt/${R6}@${R8} || exit 1",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "284: ${kadmin5} check ${R5} || exit 1",
      "285: ${kadmin} check ${R6} || exit 1",
      "286: ${kadmin} check ${R7} || exit 1",
      "287: ${kadmin} check ${H1} || exit 1",
      "288: ${kadmin} check ${H2} || exit 1",
      "289: ${kadmin} check ${H3} || exit 1",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "298: ${kadmin} check ${R8} || exit 1",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "388: ${kgetcred} foo@${R6} || { ec=1 ; eval \"${testfailed}\"; }",
      "389: echo \"Getting x-realm tickets with capaths for $R -> $R7\"",
      "390: ${kgetcred} foo@${R7} || { ec=1 ; eval \"${testfailed}\"; }",
      "391: ${kdestroy}",
      "393: echo \"Testing capaths logic (reverse order)\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "403: echo \"Should not get x-realm tickets with capaths for $R -> $R8\"",
      "404: ${kgetcred} foo@${R8} && { ec=1 ; eval \"${testfailed}\"; }",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "419: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $H1\"",
      "420: ${kgetcred} --hostbased --canonicalize foo host.${h1} || { ec=1 ; eval \"${testfailed}\"; }",
      "421: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $R\"",
      "422: ${kgetcred} --hostbased --canonicalize foo host.${r} || { ec=1 ; eval \"${testfailed}\"; }",
      "423: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $H2\"",
      "424: ${kgetcred} --hostbased --canonicalize foo host.${h2} || { ec=1 ; eval \"${testfailed}\"; }",
      "425: ${kdestroy}",
      "427: echo \"Testing multi-hop [capaths] referral logic\"",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "435: fgrep \"cross-realm ${H3} -> ${H1} via [${H2}, ${R}]\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
      "438: fgrep \"cross-realm ${H3} -> ${R} via [${H2}]\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
      "441: fgrep \"cross-realm ${H3} -> ${H2}\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
      "",
      "---------------"
    ],
    "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in": [
      "File: tests/kdc/krb5.conf.in -> tests/kdc/krb5.conf.in",
      "--- Hunk 1 ---",
      "[Context before]",
      "40:  SOME-REALM7.UK = {",
      "41:   kdc = localhost:@port@",
      "42:  }",
      "43:  TEST-HTTP.H5L.SE = {",
      "44:   kdc = http/localhost:@port@",
      "45:  }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "43:  SOME-REALM8.UK = {",
      "44:   kdc = localhost:@port@",
      "45:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "147:   SOME-REALM6.US = SOME-REALM5.FR",
      "148:   SOME-REALM7.UK = SOME-REALM6.US",
      "149:   SOME-REALM7.UK = SOME-REALM5.FR",
      "150:  }",
      "151:         H4.H2.TEST.H5L.SE = {",
      "152:                 H1.TEST.H5L.SE = H3.H2.TEST.H5L.SE",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "153:   SOME-REALM8.UK = SOME-REALM6.US",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d7bf245e793a9f9ec565e07dae9372597c0ece69",
      "candidate_info": {
        "commit_hash": "d7bf245e793a9f9ec565e07dae9372597c0ece69",
        "repo": "heimdal/heimdal",
        "commit_url": "https://github.com/heimdal/heimdal/commit/d7bf245e793a9f9ec565e07dae9372597c0ece69",
        "files": [
          "NEWS",
          "kdc/krb5tgs.c",
          "tests/kdc/check-kdc.in",
          "tests/kdc/krb5.conf.in"
        ],
        "message": "Fix transit path validation CVE-2017-6594\n\nCommit f469fc6 (2010-10-02) inadvertently caused the previous hop realm\nto not be added to the transit path of issued tickets.  This may, in\nsome cases, enable bypass of capath policy in Heimdal versions 1.5\nthrough 7.2.\n\nNote, this may break sites that rely on the bug.  With the bug some\nincomplete [capaths] worked, that should not have.  These may now break\nauthentication in some cross-realm configurations.",
        "before_after_code_files": [
          "kdc/krb5tgs.c||kdc/krb5tgs.c",
          "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in",
          "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c",
            "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in",
            "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in"
          ],
          "candidate": [
            "kdc/krb5tgs.c||kdc/krb5tgs.c",
            "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in",
            "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in"
          ]
        }
      },
      "candidate_diff": {
        "kdc/krb5tgs.c||kdc/krb5tgs.c": [
          "File: kdc/krb5tgs.c -> kdc/krb5tgs.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "737:         const char *server_name,",
          "738:         hdb_entry_ex *client,",
          "739:         krb5_principal client_principal,",
          "740:         hdb_entry_ex *krbtgt,",
          "741:         krb5_enctype krbtgt_etype,",
          "742:         krb5_principals spp,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "744:                const char *tgt_realm,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "798:      &tgt->transited, &et,",
          "799:      krb5_principal_get_realm(context, client_principal),",
          "800:      krb5_principal_get_realm(context, server->entry.principal),",
          "802:     if(ret)",
          "803:  goto out;",
          "",
          "[Removed Lines]",
          "801:      krb5_principal_get_realm(context, krbtgt->entry.principal));",
          "",
          "[Added Lines]",
          "806:      tgt_realm);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1519:     krb5_keyblock sessionkey;",
          "1520:     krb5_kvno kvno;",
          "1521:     krb5_data rspac;",
          "1523:         krb5_principal_get_comp_string(context, krbtgt->entry.principal, 1);",
          "1524:     char **capath = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1528:         krb5_principal_get_realm(context, krbtgt->entry.principal);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2324:     spn,",
          "2325:     client,",
          "2326:     cp,",
          "2327:     krbtgt_out,",
          "2328:     tkey_sign->key.keytype,",
          "2329:     spp,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2334:                          tgt_realm,",
          "",
          "---------------"
        ],
        "tests/kdc/check-kdc.in||tests/kdc/check-kdc.in": [
          "File: tests/kdc/check-kdc.in -> tests/kdc/check-kdc.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "53: R5=SOME-REALM5.FR",
          "54: R6=SOME-REALM6.US",
          "55: R7=SOME-REALM7.UK",
          "57: H1=H1.$R",
          "58: H2=H2.$R",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "56: R8=SOME-REALM8.UK",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "148:     --realm-max-renewable-life=1month \\",
          "149:     ${R7} || exit 1",
          "151: ${kadmin} \\",
          "152:     init \\",
          "153:     --realm-max-ticket-life=1day \\",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "152: ${kadmin} \\",
          "153:     init \\",
          "154:     --realm-max-ticket-life=1day \\",
          "155:     --realm-max-renewable-life=1month \\",
          "156:     ${R8} || exit 1",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "191: ${kadmin5} add -p foo --use-defaults foo@${R5} || exit 1",
          "192: ${kadmin} add -p foo --use-defaults foo@${R6} || exit 1",
          "193: ${kadmin} add -p foo --use-defaults foo@${R7} || exit 1",
          "194: ${kadmin} add -p foo --use-defaults foo@${H1} || exit 1",
          "195: ${kadmin} add -p foo --use-defaults foo/host.${h1}@${H1} || exit 1",
          "196: ${kadmin} add -p foo --use-defaults foo@${H2} || exit 1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "201: ${kadmin} add -p foo --use-defaults foo@${R8} || exit 1",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "249: ${kadmin} add -p cross1 --use-defaults krbtgt/${R7}@${R6} || exit 1",
          "250: ${kadmin} add -p cross2 --use-defaults krbtgt/${R6}@${R7} || exit 1",
          "252: ${kadmin} add -p cross1 --use-defaults krbtgt/${H1}@${R} || exit 1",
          "253: ${kadmin} add -p cross2 --use-defaults krbtgt/${R}@${H1} || exit 1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "260: ${kadmin} add -p cross1 --use-defaults krbtgt/${R8}@${R6} || exit 1",
          "261: ${kadmin} add -p cross2 --use-defaults krbtgt/${R6}@${R8} || exit 1",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "284: ${kadmin5} check ${R5} || exit 1",
          "285: ${kadmin} check ${R6} || exit 1",
          "286: ${kadmin} check ${R7} || exit 1",
          "287: ${kadmin} check ${H1} || exit 1",
          "288: ${kadmin} check ${H2} || exit 1",
          "289: ${kadmin} check ${H3} || exit 1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "298: ${kadmin} check ${R8} || exit 1",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "388: ${kgetcred} foo@${R6} || { ec=1 ; eval \"${testfailed}\"; }",
          "389: echo \"Getting x-realm tickets with capaths for $R -> $R7\"",
          "390: ${kgetcred} foo@${R7} || { ec=1 ; eval \"${testfailed}\"; }",
          "391: ${kdestroy}",
          "393: echo \"Testing capaths logic (reverse order)\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "403: echo \"Should not get x-realm tickets with capaths for $R -> $R8\"",
          "404: ${kgetcred} foo@${R8} && { ec=1 ; eval \"${testfailed}\"; }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "419: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $H1\"",
          "420: ${kgetcred} --hostbased --canonicalize foo host.${h1} || { ec=1 ; eval \"${testfailed}\"; }",
          "421: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $R\"",
          "422: ${kgetcred} --hostbased --canonicalize foo host.${r} || { ec=1 ; eval \"${testfailed}\"; }",
          "423: echo \"Getting x-realm tickets with hierarchical referrals for $H3 -> $H2\"",
          "424: ${kgetcred} --hostbased --canonicalize foo host.${h2} || { ec=1 ; eval \"${testfailed}\"; }",
          "425: ${kdestroy}",
          "427: echo \"Testing multi-hop [capaths] referral logic\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "435: fgrep \"cross-realm ${H3} -> ${H1} via [${H2}, ${R}]\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
          "438: fgrep \"cross-realm ${H3} -> ${R} via [${H2}]\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
          "441: fgrep \"cross-realm ${H3} -> ${H2}\" messages.log > /dev/null || { ec=1 ; eval \"${testfailed}\"; }",
          "",
          "---------------"
        ],
        "tests/kdc/krb5.conf.in||tests/kdc/krb5.conf.in": [
          "File: tests/kdc/krb5.conf.in -> tests/kdc/krb5.conf.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "40:  SOME-REALM7.UK = {",
          "41:   kdc = localhost:@port@",
          "42:  }",
          "43:  TEST-HTTP.H5L.SE = {",
          "44:   kdc = http/localhost:@port@",
          "45:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "43:  SOME-REALM8.UK = {",
          "44:   kdc = localhost:@port@",
          "45:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "147:   SOME-REALM6.US = SOME-REALM5.FR",
          "148:   SOME-REALM7.UK = SOME-REALM6.US",
          "149:   SOME-REALM7.UK = SOME-REALM5.FR",
          "150:  }",
          "151:         H4.H2.TEST.H5L.SE = {",
          "152:                 H1.TEST.H5L.SE = H3.H2.TEST.H5L.SE",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "153:   SOME-REALM8.UK = SOME-REALM6.US",
          "",
          "---------------"
        ]
      }
    }
  ]
}