{
  "cve_id": "CVE-2021-37661",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. In affected versions an attacker can cause a denial of service in `boosted_trees_create_quantile_stream_resource` by using negative arguments. The [implementation](https://github.com/tensorflow/tensorflow/blob/84d053187cb80d975ef2b9684d4b61981bca0c41/tensorflow/core/kernels/boosted_trees/quantile_ops.cc#L96) does not validate that `num_streams` only contains non-negative numbers. In turn, [this results in using this value to allocate memory](https://github.com/tensorflow/tensorflow/blob/84d053187cb80d975ef2b9684d4b61981bca0c41/tensorflow/core/kernels/boosted_trees/quantiles/quantile_stream_resource.h#L31-L40). However, `reserve` receives an unsigned integer so there is an implicit conversion from a negative value to a large positive unsigned. This results in a crash from the standard library. We have patched the issue in GitHub commit 8a84f7a2b5a2b27ecf88d25bad9ac777cd2f7992. The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "8a84f7a2b5a2b27ecf88d25bad9ac777cd2f7992",
  "patch_info": {
    "commit_hash": "8a84f7a2b5a2b27ecf88d25bad9ac777cd2f7992",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/8a84f7a2b5a2b27ecf88d25bad9ac777cd2f7992",
    "files": [
      "tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
    ],
    "message": "Ensure num_streams >= 0 in tf.raw_ops.BoostedTreesCreateQuantileStreamResource\n\nPiperOrigin-RevId: 387452765\nChange-Id: I9990c760e177fabca6a3b9b4612ceeaeeba51495",
    "before_after_code_files": [
      "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc": [
      "File: tensorflow/core/kernels/boosted_trees/quantile_ops.cc -> tensorflow/core/kernels/boosted_trees/quantile_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "116:     const Tensor* num_streams_t;",
      "117:     OP_REQUIRES_OK(context, context->input(kNumStreamsName, &num_streams_t));",
      "118:     int64_t num_streams = num_streams_t->scalar<int64>()();",
      "120:     auto result =",
      "121:         new QuantileStreamResource(epsilon, max_elements_, num_streams);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "119:     OP_REQUIRES(context, num_streams >= 0,",
      "120:                 errors::InvalidArgument(",
      "121:                     \"Num_streams input cannot be a negative integer\"));",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "b65eb1055d2ed056e730711146d3cb3a9c90c9d7",
      "candidate_info": {
        "commit_hash": "b65eb1055d2ed056e730711146d3cb3a9c90c9d7",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/b65eb1055d2ed056e730711146d3cb3a9c90c9d7",
        "files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ],
        "message": "Ensure num_streams >= 0 in tf.raw_ops.BoostedTreesCreateQuantileStreamResource\n\nPiperOrigin-RevId: 387452765\nChange-Id: I9990c760e177fabca6a3b9b4612ceeaeeba51495",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/quantile_ops.cc -> tensorflow/core/kernels/boosted_trees/quantile_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:     const Tensor* num_streams_t;",
          "117:     OP_REQUIRES_OK(context, context->input(kNumStreamsName, &num_streams_t));",
          "118:     int64 num_streams = num_streams_t->scalar<int64>()();",
          "120:     auto result =",
          "121:         new QuantileStreamResource(epsilon, max_elements_, num_streams);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119:     OP_REQUIRES(context, num_streams >= 0,",
          "120:                 errors::InvalidArgument(",
          "121:                     \"Num_streams input cannot be a negative integer\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d2e8d735db87425df1336653617da2be552e3d2f",
      "candidate_info": {
        "commit_hash": "d2e8d735db87425df1336653617da2be552e3d2f",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d2e8d735db87425df1336653617da2be552e3d2f",
        "files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ],
        "message": "Ensure num_streams >= 0 in tf.raw_ops.BoostedTreesCreateQuantileStreamResource\n\nPiperOrigin-RevId: 387452765\nChange-Id: I9990c760e177fabca6a3b9b4612ceeaeeba51495",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/quantile_ops.cc -> tensorflow/core/kernels/boosted_trees/quantile_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:     const Tensor* num_streams_t;",
          "117:     OP_REQUIRES_OK(context, context->input(kNumStreamsName, &num_streams_t));",
          "118:     int64 num_streams = num_streams_t->scalar<int64>()();",
          "120:     auto result =",
          "121:         new QuantileStreamResource(epsilon, max_elements_, num_streams);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119:     OP_REQUIRES(context, num_streams >= 0,",
          "120:                 errors::InvalidArgument(",
          "121:                     \"Num_streams input cannot be a negative integer\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "12c91ab1d14927a4d925e790b42ae33ab6c19e07",
      "candidate_info": {
        "commit_hash": "12c91ab1d14927a4d925e790b42ae33ab6c19e07",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/12c91ab1d14927a4d925e790b42ae33ab6c19e07",
        "files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ],
        "message": "[cheerypick2.6]Ensure num_streams >= 0 in tf.raw_ops.BoostedTreesCreateQuantileStreamResource",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/quantile_ops.cc -> tensorflow/core/kernels/boosted_trees/quantile_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:     const Tensor* num_streams_t;",
          "117:     OP_REQUIRES_OK(context, context->input(kNumStreamsName, &num_streams_t));",
          "118:     int64 num_streams = num_streams_t->scalar<int64>()();",
          "120:     auto result =",
          "121:         new QuantileStreamResource(epsilon, max_elements_, num_streams);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119:     OP_REQUIRES(context, num_streams >= 0,",
          "120:                 errors::InvalidArgument(",
          "121:                     \"Num_streams input cannot be a negative integer\"));",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cb696e91b518f8269a0e6f54c1539c20118661ed",
      "candidate_info": {
        "commit_hash": "cb696e91b518f8269a0e6f54c1539c20118661ed",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/cb696e91b518f8269a0e6f54c1539c20118661ed",
        "files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ],
        "message": "Ensure num_streams >= 0 in tf.raw_ops.BoostedTreesCreateQuantileStreamResource\n\nPiperOrigin-RevId: 387452765\nChange-Id: I9990c760e177fabca6a3b9b4612ceeaeeba51495",
        "before_after_code_files": [
          "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/boosted_trees/quantile_ops.cc||tensorflow/core/kernels/boosted_trees/quantile_ops.cc": [
          "File: tensorflow/core/kernels/boosted_trees/quantile_ops.cc -> tensorflow/core/kernels/boosted_trees/quantile_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "116:     const Tensor* num_streams_t;",
          "117:     OP_REQUIRES_OK(context, context->input(kNumStreamsName, &num_streams_t));",
          "118:     int64 num_streams = num_streams_t->scalar<int64>()();",
          "120:     auto result =",
          "121:         new QuantileStreamResource(epsilon, max_elements_, num_streams);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "119:     OP_REQUIRES(context, num_streams >= 0,",
          "120:                 errors::InvalidArgument(",
          "121:                     \"Num_streams input cannot be a negative integer\"));",
          "",
          "---------------"
        ]
      }
    }
  ]
}