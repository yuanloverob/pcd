{
  "cve_id": "CVE-2014-0146",
  "cve_desc": "The qcow2_open function in the (block/qcow2.c) in QEMU before 1.7.2 and 2.x before 2.0.0 allows local users to cause a denial of service (NULL pointer dereference) via a crafted image which causes an error, related to the initialization of the snapshot_offset and nb_snapshots fields.",
  "repo": "qemu/qemu",
  "patch_hash": "11b128f4062dd7f89b14abc8877ff20d41b28be9",
  "patch_info": {
    "commit_hash": "11b128f4062dd7f89b14abc8877ff20d41b28be9",
    "repo": "qemu/qemu",
    "commit_url": "https://github.com/qemu/qemu/commit/11b128f4062dd7f89b14abc8877ff20d41b28be9",
    "files": [
      "block/qcow2.c",
      "tests/qemu-iotests/080",
      "tests/qemu-iotests/080.out"
    ],
    "message": "qcow2: Fix NULL dereference in qcow2_open() error path (CVE-2014-0146)\n\nThe qcow2 code assumes that s->snapshots is non-NULL if s->nb_snapshots\n!= 0. By having the initialisation of both fields separated in\nqcow2_open(), any error occuring in between would cause the error path\nto dereference NULL in qcow2_free_snapshots() if the image had any\nsnapshots.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
    "before_after_code_files": [
      "block/qcow2.c||block/qcow2.c"
    ]
  },
  "patch_diff": {
    "block/qcow2.c||block/qcow2.c": [
      "File: block/qcow2.c -> block/qcow2.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "637:         goto fail;",
      "638:     }",
      "644:     if (header.l1_size > 0x2000000) {",
      "",
      "[Removed Lines]",
      "640:     s->snapshots_offset = header.snapshots_offset;",
      "641:     s->nb_snapshots = header.nb_snapshots;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "734:         bs->backing_file[len] = '\\0';",
      "735:     }",
      "737:     ret = qcow2_read_snapshots(bs);",
      "738:     if (ret < 0) {",
      "739:         error_setg_errno(errp, -ret, \"Could not read snapshots\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "735:     s->snapshots_offset = header.snapshots_offset;",
      "736:     s->nb_snapshots = header.nb_snapshots;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c2c52728f5719a4534f52fd2f0c6f3d04e230bdf",
      "candidate_info": {
        "commit_hash": "c2c52728f5719a4534f52fd2f0c6f3d04e230bdf",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/c2c52728f5719a4534f52fd2f0c6f3d04e230bdf",
        "files": [
          "block/qcow2.c",
          "tests/qemu-iotests/080",
          "tests/qemu-iotests/080.out"
        ],
        "message": "qcow2: Fix NULL dereference in qcow2_open() error path (CVE-2014-0146)\n\nThe qcow2 code assumes that s->snapshots is non-NULL if s->nb_snapshots\n!= 0. By having the initialisation of both fields separated in\nqcow2_open(), any error occuring in between would cause the error path\nto dereference NULL in qcow2_free_snapshots() if the image had any\nsnapshots.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>\n(cherry picked from commit 11b128f4062dd7f89b14abc8877ff20d41b28be9)\nSigned-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>",
        "before_after_code_files": [
          "block/qcow2.c||block/qcow2.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "block/qcow2.c||block/qcow2.c"
          ],
          "candidate": [
            "block/qcow2.c||block/qcow2.c"
          ]
        }
      },
      "candidate_diff": {
        "block/qcow2.c||block/qcow2.c": [
          "File: block/qcow2.c -> block/qcow2.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "639:         goto fail;",
          "640:     }",
          "646:     if (header.l1_size > 0x2000000) {",
          "",
          "[Removed Lines]",
          "642:     s->snapshots_offset = header.snapshots_offset;",
          "643:     s->nb_snapshots = header.nb_snapshots;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "736:         bs->backing_file[len] = '\\0';",
          "737:     }",
          "739:     ret = qcow2_read_snapshots(bs);",
          "740:     if (ret < 0) {",
          "741:         error_setg_errno(errp, -ret, \"Could not read snapshots\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "737:     s->snapshots_offset = header.snapshots_offset;",
          "738:     s->nb_snapshots = header.nb_snapshots;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2d51c32c4b511db8bb9e58208f1e2c25e4c06c85",
      "candidate_info": {
        "commit_hash": "2d51c32c4b511db8bb9e58208f1e2c25e4c06c85",
        "repo": "qemu/qemu",
        "commit_url": "https://github.com/qemu/qemu/commit/2d51c32c4b511db8bb9e58208f1e2c25e4c06c85",
        "files": [
          "block/qcow2.c",
          "tests/qemu-iotests/080",
          "tests/qemu-iotests/080.out"
        ],
        "message": "qcow2: Validate active L1 table offset and size (CVE-2014-0144)\n\nThis avoids an unbounded allocation.\n\nSigned-off-by: Kevin Wolf <kwolf@redhat.com>\nReviewed-by: Max Reitz <mreitz@redhat.com>\nSigned-off-by: Stefan Hajnoczi <stefanha@redhat.com>",
        "before_after_code_files": [
          "block/qcow2.c||block/qcow2.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "block/qcow2.c||block/qcow2.c"
          ],
          "candidate": [
            "block/qcow2.c||block/qcow2.c"
          ]
        }
      },
      "candidate_diff": {
        "block/qcow2.c||block/qcow2.c": [
          "File: block/qcow2.c -> block/qcow2.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "642:     s->nb_snapshots = header.nb_snapshots;",
          "645:     s->l1_size = header.l1_size;",
          "647:     l1_vm_state_index = size_to_l1(s, header.size);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "645:     if (header.l1_size > 0x2000000) {",
          "648:         error_setg(errp, \"Active L1 table too large\");",
          "649:         ret = -EFBIG;",
          "650:         goto fail;",
          "651:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "659:         ret = -EINVAL;",
          "660:         goto fail;",
          "661:     }",
          "662:     s->l1_table_offset = header.l1_table_offset;",
          "663:     if (s->l1_size > 0) {",
          "664:         s->l1_table = g_malloc0(",
          "665:             align_offset(s->l1_size * sizeof(uint64_t), 512));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "670:     ret = validate_table_offset(bs, header.l1_table_offset,",
          "671:                                 header.l1_size, sizeof(uint64_t));",
          "672:     if (ret < 0) {",
          "673:         error_setg(errp, \"Invalid L1 table offset\");",
          "674:         goto fail;",
          "675:     }",
          "",
          "---------------"
        ]
      }
    }
  ]
}