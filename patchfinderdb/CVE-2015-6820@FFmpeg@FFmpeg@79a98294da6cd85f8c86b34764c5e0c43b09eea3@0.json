{
  "cve_id": "CVE-2015-6820",
  "cve_desc": "The ff_sbr_apply function in libavcodec/aacsbr.c in FFmpeg before 2.7.2 does not check for a matching AAC frame syntax element before proceeding with Spectral Band Replication calculations, which allows remote attackers to cause a denial of service (out-of-bounds array access) or possibly have unspecified other impact via crafted AAC data.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "79a98294da6cd85f8c86b34764c5e0c43b09eea3",
  "patch_info": {
    "commit_hash": "79a98294da6cd85f8c86b34764c5e0c43b09eea3",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/79a98294da6cd85f8c86b34764c5e0c43b09eea3",
    "files": [
      "libavcodec/aacsbr.c",
      "libavcodec/sbr.h"
    ],
    "message": "avcodec/aacsbr: check that the element type matches before applying SBR\n\nFixes out of array access\nFixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
      "libavcodec/sbr.h||libavcodec/sbr.h"
    ]
  },
  "patch_diff": {
    "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
      "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1019: {",
      "1020:     unsigned int cnt = get_bits_count(gb);",
      "1022:     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {",
      "1023:         if (read_sbr_single_channel_element(ac, sbr, gb)) {",
      "1024:             sbr_turnoff(sbr);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1022:     sbr->id_aac = id_aac;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1695:     int nch = (id_aac == TYPE_CPE) ? 2 : 1;",
      "1696:     int err;",
      "1698:     if (!sbr->kx_and_m_pushed) {",
      "1699:         sbr->kx[0] = sbr->kx[1];",
      "1700:         sbr->m[0] = sbr->m[1];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1700:     if (id_aac != sbr->id_aac) {",
      "1701:         av_log(ac->avctx, AV_LOG_ERROR,",
      "1702:             \"element type mismatch %d != %d\\n\", id_aac, sbr->id_aac);",
      "1703:         sbr_turnoff(sbr);",
      "1704:     }",
      "",
      "---------------"
    ],
    "libavcodec/sbr.h||libavcodec/sbr.h": [
      "File: libavcodec/sbr.h -> libavcodec/sbr.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "137: struct SpectralBandReplication {",
      "138:     int                sample_rate;",
      "139:     int                start;",
      "140:     int                reset;",
      "141:     SpectrumParameters spectrum_params;",
      "142:     int                bs_amp_res_header;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "140:     int                id_aac;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "1674c5beafc4004587a0c7d84e7c94d665cd71e0",
      "candidate_info": {
        "commit_hash": "1674c5beafc4004587a0c7d84e7c94d665cd71e0",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/1674c5beafc4004587a0c7d84e7c94d665cd71e0",
        "files": [
          "libavcodec/aacsbr.c",
          "libavcodec/sbr.h"
        ],
        "message": "avcodec/aacsbr: check that the element type matches before applying SBR\n\nFixes out of array access\nFixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 79a98294da6cd85f8c86b34764c5e0c43b09eea3)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
          "libavcodec/sbr.h||libavcodec/sbr.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ],
          "candidate": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
          "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018: {",
          "1019:     unsigned int cnt = get_bits_count(gb);",
          "1021:     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {",
          "1022:         if (read_sbr_single_channel_element(ac, sbr, gb)) {",
          "1023:             sbr_turnoff(sbr);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1021:     sbr->id_aac = id_aac;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1694:     int nch = (id_aac == TYPE_CPE) ? 2 : 1;",
          "1695:     int err;",
          "1697:     if (!sbr->kx_and_m_pushed) {",
          "1698:         sbr->kx[0] = sbr->kx[1];",
          "1699:         sbr->m[0] = sbr->m[1];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1699:     if (id_aac != sbr->id_aac) {",
          "1700:         av_log(ac->avctx, AV_LOG_ERROR,",
          "1701:             \"element type mismatch %d != %d\\n\", id_aac, sbr->id_aac);",
          "1702:         sbr_turnoff(sbr);",
          "1703:     }",
          "",
          "---------------"
        ],
        "libavcodec/sbr.h||libavcodec/sbr.h": [
          "File: libavcodec/sbr.h -> libavcodec/sbr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: struct SpectralBandReplication {",
          "138:     int                sample_rate;",
          "139:     int                start;",
          "140:     int                reset;",
          "141:     SpectrumParameters spectrum_params;",
          "142:     int                bs_amp_res_header;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "140:     int                id_aac;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e740506d31e793801c520e4a6283438d88279e75",
      "candidate_info": {
        "commit_hash": "e740506d31e793801c520e4a6283438d88279e75",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/e740506d31e793801c520e4a6283438d88279e75",
        "files": [
          "libavcodec/aacsbr.c",
          "libavcodec/sbr.h"
        ],
        "message": "avcodec/aacsbr: check that the element type matches before applying SBR\n\nFixes out of array access\nFixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 79a98294da6cd85f8c86b34764c5e0c43b09eea3)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
          "libavcodec/sbr.h||libavcodec/sbr.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ],
          "candidate": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
          "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1019: {",
          "1020:     unsigned int cnt = get_bits_count(gb);",
          "1022:     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {",
          "1023:         if (read_sbr_single_channel_element(ac, sbr, gb)) {",
          "1024:             sbr_turnoff(sbr);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1022:     sbr->id_aac = id_aac;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1695:     int nch = (id_aac == TYPE_CPE) ? 2 : 1;",
          "1696:     int err;",
          "1698:     if (!sbr->kx_and_m_pushed) {",
          "1699:         sbr->kx[0] = sbr->kx[1];",
          "1700:         sbr->m[0] = sbr->m[1];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1700:     if (id_aac != sbr->id_aac) {",
          "1701:         av_log(ac->avctx, AV_LOG_ERROR,",
          "1702:             \"element type mismatch %d != %d\\n\", id_aac, sbr->id_aac);",
          "1703:         sbr_turnoff(sbr);",
          "1704:     }",
          "",
          "---------------"
        ],
        "libavcodec/sbr.h||libavcodec/sbr.h": [
          "File: libavcodec/sbr.h -> libavcodec/sbr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: struct SpectralBandReplication {",
          "138:     int                sample_rate;",
          "139:     int                start;",
          "140:     int                reset;",
          "141:     SpectrumParameters spectrum_params;",
          "142:     int                bs_amp_res_header;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "140:     int                id_aac;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1b15487e903b107559524bbf1f3663e04cc12cb5",
      "candidate_info": {
        "commit_hash": "1b15487e903b107559524bbf1f3663e04cc12cb5",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/1b15487e903b107559524bbf1f3663e04cc12cb5",
        "files": [
          "libavcodec/aacsbr.c",
          "libavcodec/sbr.h"
        ],
        "message": "avcodec/aacsbr: check that the element type matches before applying SBR\n\nFixes out of array access\nFixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 79a98294da6cd85f8c86b34764c5e0c43b09eea3)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
          "libavcodec/sbr.h||libavcodec/sbr.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ],
          "candidate": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
          "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018: {",
          "1019:     unsigned int cnt = get_bits_count(gb);",
          "1021:     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {",
          "1022:         if (read_sbr_single_channel_element(ac, sbr, gb)) {",
          "1023:             sbr_turnoff(sbr);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1021:     sbr->id_aac = id_aac;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1694:     int nch = (id_aac == TYPE_CPE) ? 2 : 1;",
          "1695:     int err;",
          "1697:     if (!sbr->kx_and_m_pushed) {",
          "1698:         sbr->kx[0] = sbr->kx[1];",
          "1699:         sbr->m[0] = sbr->m[1];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1699:     if (id_aac != sbr->id_aac) {",
          "1700:         av_log(ac->avctx, AV_LOG_ERROR,",
          "1701:             \"element type mismatch %d != %d\\n\", id_aac, sbr->id_aac);",
          "1702:         sbr_turnoff(sbr);",
          "1703:     }",
          "",
          "---------------"
        ],
        "libavcodec/sbr.h||libavcodec/sbr.h": [
          "File: libavcodec/sbr.h -> libavcodec/sbr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: struct SpectralBandReplication {",
          "138:     int                sample_rate;",
          "139:     int                start;",
          "140:     int                reset;",
          "141:     SpectrumParameters spectrum_params;",
          "142:     int                bs_amp_res_header;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "140:     int                id_aac;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "514d0e29c8cd27fbc55ae1feb0f246c623608558",
      "candidate_info": {
        "commit_hash": "514d0e29c8cd27fbc55ae1feb0f246c623608558",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/514d0e29c8cd27fbc55ae1feb0f246c623608558",
        "files": [
          "libavcodec/aacsbr.c",
          "libavcodec/sbr.h"
        ],
        "message": "avcodec/aacsbr: check that the element type matches before applying SBR\n\nFixes out of array access\nFixes: signal_sigsegv_3670fc0_2818_cov_2307326154_moon.mux\n\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 79a98294da6cd85f8c86b34764c5e0c43b09eea3)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
          "libavcodec/sbr.h||libavcodec/sbr.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ],
          "candidate": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c",
            "libavcodec/sbr.h||libavcodec/sbr.h"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
          "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1018: {",
          "1019:     unsigned int cnt = get_bits_count(gb);",
          "1021:     if (id_aac == TYPE_SCE || id_aac == TYPE_CCE) {",
          "1022:         if (read_sbr_single_channel_element(ac, sbr, gb)) {",
          "1023:             sbr_turnoff(sbr);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1021:     sbr->id_aac = id_aac;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1688:     int nch = (id_aac == TYPE_CPE) ? 2 : 1;",
          "1689:     int err;",
          "1691:     if (!sbr->kx_and_m_pushed) {",
          "1692:         sbr->kx[0] = sbr->kx[1];",
          "1693:         sbr->m[0] = sbr->m[1];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1693:     if (id_aac != sbr->id_aac) {",
          "1694:         av_log(ac->avctx, AV_LOG_ERROR,",
          "1695:             \"element type mismatch %d != %d\\n\", id_aac, sbr->id_aac);",
          "1696:         sbr_turnoff(sbr);",
          "1697:     }",
          "",
          "---------------"
        ],
        "libavcodec/sbr.h||libavcodec/sbr.h": [
          "File: libavcodec/sbr.h -> libavcodec/sbr.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "137: struct SpectralBandReplication {",
          "138:     int                sample_rate;",
          "139:     int                start;",
          "140:     int                reset;",
          "141:     SpectrumParameters spectrum_params;",
          "142:     int                bs_amp_res_header;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "140:     int                id_aac;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2e13a45b1a9a69456631e582bbb06954d169eb55",
      "candidate_info": {
        "commit_hash": "2e13a45b1a9a69456631e582bbb06954d169eb55",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/2e13a45b1a9a69456631e582bbb06954d169eb55",
        "files": [
          "libavcodec/aacsbr.c"
        ],
        "message": "avcodec/aacsbr: Assert that bs_num_env is positive\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/aacsbr.c||libavcodec/aacsbr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c"
          ],
          "candidate": [
            "libavcodec/aacsbr.c||libavcodec/aacsbr.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/aacsbr.c||libavcodec/aacsbr.c": [
          "File: libavcodec/aacsbr.c -> libavcodec/aacsbr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1726:             sbr->c.sbr_hf_inverse_filter(&sbr->dsp, sbr->alpha0, sbr->alpha1,",
          "1727:                                          (const float (*)[40][2]) sbr->X_low, sbr->k[0]);",
          "1728:             sbr_chirp(sbr, &sbr->data[ch]);",
          "1729:             sbr_hf_gen(ac, sbr, sbr->X_high,",
          "1730:                        (const float (*)[40][2]) sbr->X_low,",
          "1731:                        (const float (*)[2]) sbr->alpha0,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1729:             av_assert0(sbr->data[ch].bs_num_env > 0);",
          "",
          "---------------"
        ]
      }
    }
  ]
}