{
  "cve_id": "CVE-2021-29565",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. An attacker can trigger a null pointer dereference in the implementation of `tf.raw_ops.SparseFillEmptyRows`. This is because of missing validation(https://github.com/tensorflow/tensorflow/blob/fdc82089d206e281c628a93771336bf87863d5e8/tensorflow/core/kernels/sparse_fill_empty_rows_op.cc#L230-L231) that was covered under a `TODO`. If the `dense_shape` tensor is empty, then `dense_shape_t.vec<>()` would cause a null pointer dereference in the implementation of the op. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "faa76f39014ed3b5e2c158593b1335522e573c7f",
  "patch_info": {
    "commit_hash": "faa76f39014ed3b5e2c158593b1335522e573c7f",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/faa76f39014ed3b5e2c158593b1335522e573c7f",
    "files": [
      "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
    ],
    "message": "Fix heap-buffer-overflow issue with `tf.raw_ops.SparseFillEmptyRows`.\n\nPiperOrigin-RevId: 372009178\nChange-Id: Ia1a9e9691ecaa072f32fb39a0887b2aabd399210",
    "before_after_code_files": [
      "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
      "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "228:                               default_value_t.shape().DebugString()),",
      "229:       done);",
      "233:   using FunctorType = functor::SparseFillEmptyRows<Device, T, Tindex>;",
      "234:   OP_REQUIRES_OK_ASYNC(context,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "232:   OP_REQUIRES_ASYNC(context, dense_shape_t.NumElements() != 0,",
      "233:                     errors::InvalidArgument(\"Dense shape cannot be empty.\"),",
      "234:                     done);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "84f5c517d437c085020c6e21b86fd4cfea998eb2",
      "candidate_info": {
        "commit_hash": "84f5c517d437c085020c6e21b86fd4cfea998eb2",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/84f5c517d437c085020c6e21b86fd4cfea998eb2",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "CherryPick2.1: Fix heap-buffer-overflow issue with tf.raw_ops.SparseFillEmptyRows",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:                                 default_value_t->shape().DebugString()));",
          "70:     const T& default_value = default_value_t->scalar<T>()();",
          "71:     const auto indices = indices_t->matrix<int64>();",
          "72:     const auto values = values_t->vec<T>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "69:     OP_REQUIRES(context, dense_shape_t.NumElements() != 0,",
          "70:                 errors::InvalidArgument(\"Dense shape cannot be empty.\"),",
          "71:                 done);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a7d8f6a5d2e760c489e121b19dc5bd9c2c1e4c2a",
      "candidate_info": {
        "commit_hash": "a7d8f6a5d2e760c489e121b19dc5bd9c2c1e4c2a",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/a7d8f6a5d2e760c489e121b19dc5bd9c2c1e4c2a",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "CherryPick2.2:Fix heap-buffer-overflow issue with tf.raw_ops.SparseFillEmptyRows.",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "69:                                         default_value_t.shape().DebugString()));",
          "73:     const T& default_value = default_value_t.scalar<T>()();",
          "74:     const auto indices = indices_t.matrix<int64>();",
          "75:     const auto values = values_t.vec<T>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73:     OP_REQUIRES(context, dense_shape_t.NumElements() != 0,",
          "74:                 errors::InvalidArgument(\"Dense shape cannot be empty.\"),",
          "75:                 done);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "76fd666a911b2d283174487a7c587c6c00bd5e36",
      "candidate_info": {
        "commit_hash": "76fd666a911b2d283174487a7c587c6c00bd5e36",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/76fd666a911b2d283174487a7c587c6c00bd5e36",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "CherryPick2.4:Fix heap-buffer-overflow issue with tf.raw_ops.SparseFillEmptyRows.",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "69:                                         default_value_t.shape().DebugString()));",
          "73:     const T& default_value = default_value_t.scalar<T>()();",
          "74:     const auto indices = indices_t.matrix<int64>();",
          "75:     const auto values = values_t.vec<T>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73:     OP_REQUIRES(context, dense_shape_t.NumElements() != 0,",
          "74:                 errors::InvalidArgument(\"Dense shape cannot be empty.\"),",
          "75:                 done);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3f158d721a47d6ba03713afe6650c9acc5f9fc26",
      "candidate_info": {
        "commit_hash": "3f158d721a47d6ba03713afe6650c9acc5f9fc26",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/3f158d721a47d6ba03713afe6650c9acc5f9fc26",
        "files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ],
        "message": "CherryPick2.3:Fix heap-buffer-overflow issue with tf.raw_ops.SparseFillEmptyRows.",
        "before_after_code_files": [
          "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ],
          "candidate": [
            "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sparse_fill_empty_rows_op.cc||tensorflow/core/kernels/sparse_fill_empty_rows_op.cc": [
          "File: tensorflow/core/kernels/sparse_fill_empty_rows_op.cc -> tensorflow/core/kernels/sparse_fill_empty_rows_op.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "69:                                         default_value_t.shape().DebugString()));",
          "73:     const T& default_value = default_value_t.scalar<T>()();",
          "74:     const auto indices = indices_t.matrix<int64>();",
          "75:     const auto values = values_t.vec<T>();",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "73:     OP_REQUIRES(context, dense_shape_t.NumElements() != 0,",
          "74:                 errors::InvalidArgument(\"Dense shape cannot be empty.\"),",
          "75:                  done);",
          "",
          "---------------"
        ]
      }
    }
  ]
}