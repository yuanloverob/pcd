{
  "cve_id": "CVE-2014-9316",
  "cve_desc": "The mjpeg_decode_app function in libavcodec/mjpegdec.c in FFMpeg before 2.1.6, 2.2.x through 2.3.x, and 2.4.x before 2.4.4 allows remote attackers to cause a denial of service (out-of-bounds heap access) and possibly have other unspecified impact via vectors related to LJIF tags in an MJPEG file.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "0eecf40935b22644e6cd74c586057237ecfd6844",
  "patch_info": {
    "commit_hash": "0eecf40935b22644e6cd74c586057237ecfd6844",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/0eecf40935b22644e6cd74c586057237ecfd6844",
    "files": [
      "libavcodec/mjpegdec.c"
    ],
    "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
      "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1620:     }",
      "1622:     if (id == AV_RB32(\"LJIF\")) {",
      "1623:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
      "1624:             av_log(s->avctx, AV_LOG_INFO,",
      "1625:                    \"Pegasus lossless jpeg header found\\n\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1623:         int rgb = s->rgb;",
      "1624:         int pegasus_rct = s->pegasus_rct;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1630:         switch (i=get_bits(&s->gb, 8)) {",
      "1631:         case 1:",
      "1634:             break;",
      "1635:         case 2:",
      "1638:             break;",
      "1639:         default:",
      "1640:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
      "1641:         }",
      "1642:         len -= 9;",
      "1643:         goto out;",
      "1644:     }",
      "1645:     if (id == AV_RL32(\"colr\") && len > 0) {",
      "",
      "[Removed Lines]",
      "1632:             s->rgb         = 1;",
      "1633:             s->pegasus_rct = 0;",
      "1636:             s->rgb         = 1;",
      "1637:             s->pegasus_rct = 1;",
      "",
      "[Added Lines]",
      "1634:             rgb         = 1;",
      "1635:             pegasus_rct = 0;",
      "1638:             rgb         = 1;",
      "1639:             pegasus_rct = 1;",
      "1646:         if (s->got_picture)",
      "1647:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
      "1648:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
      "1649:                 goto out;",
      "1650:             }",
      "1652:         s->rgb = rgb;",
      "1653:         s->pegasus_rct = pegasus_rct;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "6c63eb59099e7096aaaaaad3c15a1dab62afc87b",
      "candidate_info": {
        "commit_hash": "6c63eb59099e7096aaaaaad3c15a1dab62afc87b",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/6c63eb59099e7096aaaaaad3c15a1dab62afc87b",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1595:     }",
          "1597:     if (id == AV_RB32(\"LJIF\")) {",
          "1598:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1599:             av_log(s->avctx, AV_LOG_INFO,",
          "1600:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1598:         int rgb = s->rgb;",
          "1599:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1605:         switch (i=get_bits(&s->gb, 8)) {",
          "1606:         case 1:",
          "1609:             break;",
          "1610:         case 2:",
          "1613:             break;",
          "1614:         default:",
          "1615:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
          "1616:         }",
          "1617:         len -= 9;",
          "1618:         goto out;",
          "1619:     }",
          "1620:     if (id == AV_RL32(\"colr\") && len > 0) {",
          "",
          "[Removed Lines]",
          "1607:             s->rgb         = 1;",
          "1608:             s->pegasus_rct = 0;",
          "1611:             s->rgb         = 1;",
          "1612:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1609:             rgb         = 1;",
          "1610:             pegasus_rct = 0;",
          "1613:             rgb         = 1;",
          "1614:             pegasus_rct = 1;",
          "1621:         if (s->got_picture)",
          "1622:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1623:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1624:                 goto out;",
          "1625:             }",
          "1627:         s->rgb = rgb;",
          "1628:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "07b98ea3963f1bf4a94b6adce540af90e767d881",
      "candidate_info": {
        "commit_hash": "07b98ea3963f1bf4a94b6adce540af90e767d881",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/07b98ea3963f1bf4a94b6adce540af90e767d881",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nConflicts:\n\n\tlibavcodec/mjpegdec.c",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1436:     }",
          "1438:     if (id == AV_RL32(\"LJIF\")) {",
          "1439:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1440:             av_log(s->avctx, AV_LOG_INFO,",
          "1441:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1439:         int rgb = s->rgb;",
          "1440:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1446:         switch (get_bits(&s->gb, 8)) {",
          "1447:         case 1:",
          "1450:             break;",
          "1451:         case 2:",
          "1454:             break;",
          "1455:         default:",
          "1456:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "1457:         }",
          "1458:         len -= 9;",
          "1459:         goto out;",
          "1460:     }",
          "",
          "[Removed Lines]",
          "1448:             s->rgb         = 1;",
          "1449:             s->pegasus_rct = 0;",
          "1452:             s->rgb         = 1;",
          "1453:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1450:             rgb         = 1;",
          "1451:             pegasus_rct = 0;",
          "1454:             rgb         = 1;",
          "1455:             pegasus_rct = 1;",
          "1462:         if (s->got_picture)",
          "1463:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1464:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1465:                 goto out;",
          "1466:             }",
          "1468:         s->rgb = rgb;",
          "1469:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "30e8a375901f8802853fd6d478b77a127d208bd6",
      "candidate_info": {
        "commit_hash": "30e8a375901f8802853fd6d478b77a127d208bd6",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/30e8a375901f8802853fd6d478b77a127d208bd6",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nConflicts:\n\n\tlibavcodec/mjpegdec.c\n(cherry picked from commit 32d3acac727f3f4a6489ca129a5ea4ccdfcb34a5)\n\nConflicts:\n\n\tlibavcodec/mjpegdec.c\n(cherry picked from commit 8d8ac60d70aee50d44a3e1d7de276598de041640)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1177:     }",
          "1179:     if (id == AV_RL32(\"LJIF\")){",
          "1180:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1181:             av_log(s->avctx, AV_LOG_INFO, \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1180:         int rgb = s->rgb;",
          "1181:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1186:         switch( get_bits(&s->gb, 8)){",
          "1187:         case 1:",
          "1190:             break;",
          "1191:         case 2:",
          "1194:             break;",
          "1195:         default:",
          "1196:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "1197:         }",
          "1198:         len -= 9;",
          "1199:         goto out;",
          "1200:     }",
          "",
          "[Removed Lines]",
          "1188:             s->rgb= 1;",
          "1189:             s->pegasus_rct=0;",
          "1192:             s->rgb= 1;",
          "1193:             s->pegasus_rct=1;",
          "",
          "[Added Lines]",
          "1190:             rgb         = 1;",
          "1191:             pegasus_rct = 0;",
          "1194:             rgb         = 1;",
          "1195:             pegasus_rct = 1;",
          "1202:         if (s->got_picture)",
          "1203:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1204:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1205:                 goto out;",
          "1206:             }",
          "1208:         s->rgb = rgb;",
          "1209:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1e18ed781f8befcb72f94a1bd4d5392c2e7e6267",
      "candidate_info": {
        "commit_hash": "1e18ed781f8befcb72f94a1bd4d5392c2e7e6267",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/1e18ed781f8befcb72f94a1bd4d5392c2e7e6267",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1448:     }",
          "1450:     if (id == AV_RB32(\"LJIF\")) {",
          "1451:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1452:             av_log(s->avctx, AV_LOG_INFO,",
          "1453:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1451:         int rgb = s->rgb;",
          "1452:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1458:         switch (get_bits(&s->gb, 8)) {",
          "1459:         case 1:",
          "1462:             break;",
          "1463:         case 2:",
          "1466:             break;",
          "1467:         default:",
          "1468:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace\\n\");",
          "1469:         }",
          "1470:         len -= 9;",
          "1471:         goto out;",
          "1472:     }",
          "",
          "[Removed Lines]",
          "1460:             s->rgb         = 1;",
          "1461:             s->pegasus_rct = 0;",
          "1464:             s->rgb         = 1;",
          "1465:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1462:             rgb         = 1;",
          "1463:             pegasus_rct = 0;",
          "1466:             rgb         = 1;",
          "1467:             pegasus_rct = 1;",
          "1474:         if (s->got_picture)",
          "1475:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1476:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1477:                 goto out;",
          "1478:             }",
          "1480:         s->rgb = rgb;",
          "1481:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8524009161b0430ba961a4e6fcd8125a695edd7c",
      "candidate_info": {
        "commit_hash": "8524009161b0430ba961a4e6fcd8125a695edd7c",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/8524009161b0430ba961a4e6fcd8125a695edd7c",
        "files": [
          "libavcodec/mjpegdec.c"
        ],
        "message": "avcodec/mjpegdec: Fix context fields becoming inconsistent\n\nFixes out of array access\nFixes: asan_heap-oob_1ca4f85_2760_cov_144449187_miss_congeniality_pegasus_ljpg.avi\nFound-by: Mateusz \"j00ru\" Jurczyk and Gynvael Coldwind\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 0eecf40935b22644e6cd74c586057237ecfd6844)\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ],
          "candidate": [
            "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c"
          ]
        }
      },
      "candidate_diff": {
        "libavcodec/mjpegdec.c||libavcodec/mjpegdec.c": [
          "File: libavcodec/mjpegdec.c -> libavcodec/mjpegdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1596:     }",
          "1598:     if (id == AV_RB32(\"LJIF\")) {",
          "1599:         if (s->avctx->debug & FF_DEBUG_PICT_INFO)",
          "1600:             av_log(s->avctx, AV_LOG_INFO,",
          "1601:                    \"Pegasus lossless jpeg header found\\n\");",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1599:         int rgb = s->rgb;",
          "1600:         int pegasus_rct = s->pegasus_rct;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1606:         switch (i=get_bits(&s->gb, 8)) {",
          "1607:         case 1:",
          "1610:             break;",
          "1611:         case 2:",
          "1614:             break;",
          "1615:         default:",
          "1616:             av_log(s->avctx, AV_LOG_ERROR, \"unknown colorspace %d\\n\", i);",
          "1617:         }",
          "1618:         len -= 9;",
          "1619:         goto out;",
          "1620:     }",
          "1621:     if (id == AV_RL32(\"colr\") && len > 0) {",
          "",
          "[Removed Lines]",
          "1608:             s->rgb         = 1;",
          "1609:             s->pegasus_rct = 0;",
          "1612:             s->rgb         = 1;",
          "1613:             s->pegasus_rct = 1;",
          "",
          "[Added Lines]",
          "1610:             rgb         = 1;",
          "1611:             pegasus_rct = 0;",
          "1614:             rgb         = 1;",
          "1615:             pegasus_rct = 1;",
          "1622:         if (s->got_picture)",
          "1623:             if (rgb != s->rgb || pegasus_rct != s->pegasus_rct) {",
          "1624:                 av_log(s->avctx, AV_LOG_WARNING, \"Mismatching LJIF tag\\n\");",
          "1625:                 goto out;",
          "1626:             }",
          "1628:         s->rgb = rgb;",
          "1629:         s->pegasus_rct = pegasus_rct;",
          "",
          "---------------"
        ]
      }
    }
  ]
}