{
  "cve_id": "CVE-2019-19923",
  "cve_desc": "flattenSubquery in select.c in SQLite 3.30.1 mishandles certain uses of SELECT DISTINCT involving a LEFT JOIN in which the right-hand side is a view. This can cause a NULL pointer dereference (or incorrect results).",
  "repo": "sqlite/sqlite",
  "patch_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
  "patch_info": {
    "commit_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/join.test"
    ],
    "message": "Continue to back away from the LEFT JOIN optimization of check-in [41c27bc0ff1d3135] by disallowing query flattening if the outer query is DISTINCT.  Without this fix, if an index scan is run on the table within the view on the right-hand side of the LEFT JOIN, stale result registers might be accessed yielding incorrect results, and/or an OP_IfNullRow opcode might be invoked on the un-opened table, resulting in a NULL-pointer dereference.  This problem was found by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: 862974312edf00e9d1068115d1a39b7235b7db68b6d86b81d38a12f025a4748e",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/join.test||test/join.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 289158aa24b066c453d2bce4bc2dead1c56fb0b23c3f7c4810b34b13627cef34",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3797:   if( (pSubitem->fg.jointype & JT_OUTER)!=0 ){",
      "3798:     isLeftJoin = 1;",
      "3801:       return 0;",
      "3802:     }",
      "3803:   }",
      "",
      "[Removed Lines]",
      "3799:     if( pSubSrc->nSrc>1 || isAgg || IsVirtual(pSubSrc->a[0].pTab) ){",
      "",
      "[Added Lines]",
      "3804:     ){",
      "",
      "---------------"
    ],
    "test/join.test||test/join.test": [
      "File: test/join.test -> test/join.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
      "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
      "978: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "978: # 2019-12-18 problem with a LEFT JOIN where the RHS is a view.",
      "979: # Detected by Yongheng and Rui.",
      "980: # Follows from the optimization attempt of check-in 41c27bc0ff1d3135",
      "981: # on 2017-04-18",
      "982: #",
      "983: reset_db",
      "984: do_execsql_test join-22.10 {",
      "985:   CREATE TABLE t0(a, b);",
      "986:   CREATE INDEX t0a ON t0(a);",
      "987:   INSERT INTO t0 VALUES(10,10),(10,11),(10,12);",
      "988:   SELECT DISTINCT c FROM t0 LEFT JOIN (SELECT a+1 AS c FROM t0) ORDER BY c ;",
      "989: } {11}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "f09a14fbc34a130a9508707e435e24318ae07364",
      "candidate_info": {
        "commit_hash": "f09a14fbc34a130a9508707e435e24318ae07364",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/f09a14fbc34a130a9508707e435e24318ae07364",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/delete.c",
          "src/fkey.c",
          "test/gencol1.test"
        ],
        "message": "Add missing column translations to foreign key logic. Ticket [c28a01da72f8957c]\n\nFossilOrigin-Name: bc6a43e7ee6353b9ef3dea4309c77e170a1c798eefcfaa7636bf5a93e51c47ee",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/delete.c||src/delete.c",
          "src/fkey.c||src/fkey.c",
          "test/gencol1.test||test/gencol1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: cc6a40818387f78f89499f09e3f1c4655c7396af1cba2596c7fb2f23f3e9755f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/delete.c||src/delete.c": [
          "File: src/delete.c -> src/delete.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "737:       testcase( mask!=0xffffffff && iCol==31 );",
          "738:       testcase( mask!=0xffffffff && iCol==32 );",
          "739:       if( mask==0xffffffff || (iCol<=31 && (mask & MASKBIT32(iCol))!=0) ){",
          "741:       }",
          "742:     }",
          "",
          "[Removed Lines]",
          "740:         sqlite3ExprCodeGetColumnOfTable(v, pTab, iDataCur, iCol, iOld+iCol+1);",
          "",
          "[Added Lines]",
          "740:         int kk = sqlite3TableColumnToStorage(pTab, iCol);",
          "741:         sqlite3ExprCodeGetColumnOfTable(v, pTab, iDataCur, iCol, iOld+kk+1);",
          "",
          "---------------"
        ],
        "src/fkey.c||src/fkey.c": [
          "File: src/fkey.c -> src/fkey.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "483:   if( pExpr ){",
          "484:     if( iCol>=0 && iCol!=pTab->iPKey ){",
          "485:       pCol = &pTab->aCol[iCol];",
          "487:       pExpr->affExpr = pCol->affinity;",
          "488:       zColl = pCol->zColl;",
          "489:       if( zColl==0 ) zColl = db->pDfltColl->zName;",
          "",
          "[Removed Lines]",
          "486:       pExpr->iTable = regBase + iCol + 1;",
          "",
          "[Added Lines]",
          "486:       pExpr->iTable = regBase + sqlite3TableColumnToStorage(pTab,iCol) + 1;",
          "",
          "---------------"
        ],
        "test/gencol1.test||test/gencol1.test": [
          "File: test/gencol1.test -> test/gencol1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "159:   UPDATE t0 SET c1 = c0, c3 = c0+1;",
          "160: } {1 {FOREIGN KEY constraint failed}}",
          "162: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "162: # 2019-11-01 ticket c28a01da72f8957c",
          "163: db close",
          "164: sqlite3 db :memory:",
          "165: do_execsql_test gencol1-4.100 {",
          "166:   CREATE TABLE t0 (",
          "167:     c0,",
          "168:     c1 a UNIQUE AS (1),",
          "169:     c2,",
          "170:     c3 REFERENCES t0(c1)",
          "171:   );",
          "172:   PRAGMA foreign_keys = true;",
          "173:   INSERT INTO t0(c0,c2,c3) VALUES(0,0,1);",
          "174: } {}",
          "175: do_catchsql_test gencol1-4.110 {",
          "176:   REPLACE INTO t0(c0,c2,c3) VALUES(0,0,0),(0,0,0);",
          "177: } {1 {FOREIGN KEY constraint failed}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "9252df49692952ff4f83a73286dcc380e53a15e2",
      "candidate_info": {
        "commit_hash": "9252df49692952ff4f83a73286dcc380e53a15e2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/9252df49692952ff4f83a73286dcc380e53a15e2",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/fuzzdata8.db"
        ],
        "message": "New test cases in test/fuzzdata8.db.\n\nFossilOrigin-Name: 6e92d71c24c6039e7116f02fc5f39b2b87efcd3674ea828077c03d760bf49c45",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f237f60e4fa9171dfe9a77c8637595c2701e971034d41bd6018944e8b2b27a6f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f135cb7d7f123a42940ddbb4dadc91e86f84cb35",
      "candidate_info": {
        "commit_hash": "f135cb7d7f123a42940ddbb4dadc91e86f84cb35",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/f135cb7d7f123a42940ddbb4dadc91e86f84cb35",
        "files": [
          "manifest",
          "manifest.uuid",
          "tool/lemon.c"
        ],
        "message": "Fix an error message in the Lemon parser generator.\n\nFossilOrigin-Name: b6d7d42b7426622a26b67809cd1f21285fea120aa1897377b9946840463b41f1",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "tool/lemon.c||tool/lemon.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f97626f921dafe596b615a168ef31987f4a1c0b52956443e1a5c1148b49cab74",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "tool/lemon.c||tool/lemon.c": [
          "File: tool/lemon.c -> tool/lemon.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3848:           ErrorMsg(lemp->filename,rp->ruleline,",
          "3849:             \"%s(%s) has the same label as the LHS but is not the left-most \"",
          "3850:             \"symbol on the RHS.\",",
          "3852:           lemp->errorcnt++;",
          "3853:         }",
          "3854:         for(j=0; j<i; j++){",
          "",
          "[Removed Lines]",
          "3851:             rp->rhs[i]->name, rp->rhsalias);",
          "",
          "[Added Lines]",
          "3851:             rp->rhs[i]->name, rp->rhsalias[i]);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "68c1f9ce9a33d745205d21261cb44124dde057bc",
      "candidate_info": {
        "commit_hash": "68c1f9ce9a33d745205d21261cb44124dde057bc",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/68c1f9ce9a33d745205d21261cb44124dde057bc",
        "files": [
          "ext/fts3/fts3_expr.c",
          "manifest",
          "manifest.uuid",
          "test/fts3expr5.test"
        ],
        "message": "Have fts3 ignore empty sets of parenthesis if built with SQLITE_ENABLE_FTS3_PARENTHESIS.\n\nFossilOrigin-Name: c93c6b45a317c40eb5c0abb6620d21f5821a601632c791e11e5ce62e039eccda",
        "before_after_code_files": [
          "ext/fts3/fts3_expr.c||ext/fts3/fts3_expr.c",
          "manifest.uuid||manifest.uuid",
          "test/fts3expr5.test||test/fts3expr5.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "ext/fts3/fts3_expr.c||ext/fts3/fts3_expr.c": [
          "File: ext/fts3/fts3_expr.c -> ext/fts3/fts3_expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "497:       int nConsumed = 0;",
          "498:       pParse->nNest++;",
          "499:       rc = fts3ExprParse(pParse, zInput+1, nInput-1, ppExpr, &nConsumed);",
          "502:       return rc;",
          "503:     }else if( *zInput==')' ){",
          "",
          "[Removed Lines]",
          "500:       if( rc==SQLITE_OK && !*ppExpr ){ rc = SQLITE_DONE; }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: cb50509020d952fa9efed8df7fa08b07b71ae9bdbdefea216b6e660863291039",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/fts3expr5.test||test/fts3expr5.test": [
          "File: test/fts3expr5.test -> test/fts3expr5.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "22:   return",
          "23: }",
          "25: #-------------------------------------------------------------------------",
          "26: # Various forms of empty phrase expressions.",
          "27: #",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "25: proc test_fts3expr {expr} {",
          "26:   db one {SELECT fts3_exprtest('simple', $expr, 'a', 'b', 'c')}",
          "27: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "45:   SELECT rowid FROM t0 WHERE x MATCH '\"\"\"\"';",
          "46: } {}",
          "48: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52: #-------------------------------------------------------------------------",
          "53: # Various forms of empty phrase expressions.",
          "54: #",
          "55: set sqlite_fts3_enable_parentheses 1",
          "56: do_test 2.0 {",
          "57:   test_fts3expr {(a:123)(b:234)()(c:456)}",
          "58: } {AND {AND {PHRASE 0 0 123} {PHRASE 1 0 234}} {PHRASE 2 0 456}}",
          "59: do_test 2.1 {",
          "60:   test_fts3expr {(a:123)(b:234)(c:456)}",
          "61: } {AND {AND {PHRASE 0 0 123} {PHRASE 1 0 234}} {PHRASE 2 0 456}}",
          "62: do_test 2.2 {",
          "63:   list [catch { test_fts3expr {\"123\" AND ( )} } msg] $msg",
          "64: } {1 {Error parsing expression}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "39593e4f0932dd09dca6820888fc725d12262272",
      "candidate_info": {
        "commit_hash": "39593e4f0932dd09dca6820888fc725d12262272",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/39593e4f0932dd09dca6820888fc725d12262272",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/where.c"
        ],
        "message": "The check-in [b7810062ec2489e1] was not quite right in that it allowed an oversized shift operation (which is UB in C) on some obscure inputs.  OSSFuzz found the problem for us overnight.\n\nFossilOrigin-Name: 62f2235adf796c72882b26313489cf49804ec3ec4972e0eee5034176cbb07f84",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 32772dfd50b602c049d8c30bc28cde60a18b7495a997d728081f689ff417c956",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3203:       if( iTerm>mxTerm ) mxTerm = iTerm;",
          "3204:       testcase( iTerm==15 );",
          "3205:       testcase( iTerm==16 );",
          "3208:           testcase( i!=iTerm );",
          "3209:           pNew->u.vtab.omitMask |= 1<<iTerm;",
          "3210:         }else{",
          "",
          "[Removed Lines]",
          "3206:       if( iTerm<16 && pUsage[i].omit ){",
          "3207:         if( ((1<<i)&mNoOmit)==0 ){",
          "",
          "[Added Lines]",
          "3206:       if( pUsage[i].omit ){",
          "3207:         if( i<16 && ((1<<i)&mNoOmit)==0 ){",
          "",
          "---------------"
        ]
      }
    }
  ]
}