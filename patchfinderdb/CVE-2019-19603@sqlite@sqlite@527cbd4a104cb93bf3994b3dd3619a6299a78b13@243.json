{
  "cve_id": "CVE-2019-19603",
  "cve_desc": "SQLite 3.30.1 mishandles certain SELECT statements with a nonexistent VIEW, leading to an application crash.",
  "repo": "sqlite/sqlite",
  "patch_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
  "patch_info": {
    "commit_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/build.c",
      "src/sqliteInt.h",
      "test/altertab.test"
    ],
    "message": "Do not allow CREATE TABLE or CREATE VIEW of an object with a name that looks like a shadow table name.\n\nFossilOrigin-Name: 6aef58b629d89955f85f65191ba2be67b2adfac4f0327fe9a7141cb2705dbc00",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/build.c||src/build.c",
      "src/sqliteInt.h||src/sqliteInt.h",
      "test/altertab.test||test/altertab.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8ad34d36a141fa8f5d9bd784dfeb892c983897a6dc6b867607cc668508acf944",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/build.c||src/build.c": [
      "File: src/build.c -> src/build.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "856:       }",
      "857:     }",
      "858:   }else{",
      "861:     ){",
      "862:       sqlite3ErrorMsg(pParse, \"object name reserved for internal use: %s\",",
      "863:                       zName);",
      "864:       return SQLITE_ERROR;",
      "865:     }",
      "866:   }",
      "867:   return SQLITE_OK;",
      "868: }",
      "",
      "[Removed Lines]",
      "859:     if( pParse->nested==0",
      "860:      && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7)",
      "",
      "[Added Lines]",
      "859:     if( (pParse->nested==0 && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7))",
      "860:      || (sqlite3ReadOnlyShadowTables(db) && sqlite3ShadowTableName(db, zName))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "2132: static int isShadowTableName(sqlite3 *db, char *zName){",
      "",
      "[Added Lines]",
      "2133: int sqlite3ShadowTableName(sqlite3 *db, const char *zName){",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2147:   if( pMod->pModule->xShadowName==0 ) return 0;",
      "2148:   return pMod->pModule->xShadowName(zTail+1);",
      "2149: }",
      "",
      "[Removed Lines]",
      "2150: #else",
      "2151: # define isShadowTableName(x,y) 0",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2190:   p = pParse->pNewTable;",
      "2191:   if( p==0 ) return;",
      "2194:     p->tabFlags |= TF_Shadow;",
      "2195:   }",
      "",
      "[Removed Lines]",
      "2193:   if( pSelect==0 && isShadowTableName(db, p->zName) ){",
      "",
      "[Added Lines]",
      "2192:   if( pSelect==0 && sqlite3ShadowTableName(db, p->zName) ){",
      "",
      "---------------"
    ],
    "src/sqliteInt.h||src/sqliteInt.h": [
      "File: src/sqliteInt.h -> src/sqliteInt.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "4548: #  define sqlite3VtabInSync(db) ((db)->nVTrans>0 && (db)->aVTrans==0)",
      "4549: #endif",
      "4550: int sqlite3ReadOnlyShadowTables(sqlite3 *db);",
      "4551: int sqlite3VtabEponymousTableInit(Parse*,Module*);",
      "4552: void sqlite3VtabEponymousTableClear(sqlite3*,Module*);",
      "4553: void sqlite3VtabMakeWritable(Parse*,Table*);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4551: #ifndef SQLITE_OMIT_VIRTUALTABLE",
      "4552:   int sqlite3ShadowTableName(sqlite3 *db, const char *zName);",
      "4553: #else",
      "4554: # define sqlite3ShadowTableName(A,B) 0",
      "4555: #endif",
      "",
      "---------------"
    ],
    "test/altertab.test||test/altertab.test": [
      "File: test/altertab.test -> test/altertab.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "547:   } {1 {table y1_segments may not be modified}}",
      "549:   do_catchsql_test 16.20 {",
      "554:     DROP TABLE y1_segments;",
      "555:   } {1 {table y1_segments may not be dropped}}",
      "557:   do_execsql_test 16.30 {",
      "558:     ALTER TABLE y1 RENAME TO z1;",
      "559:   }",
      "",
      "[Removed Lines]",
      "550:     ALTER TABLE y1_segments RENAME TO abc;",
      "551:   } {1 {table y1_segments may not be altered}}",
      "553:   do_catchsql_test 16.21 {",
      "",
      "[Added Lines]",
      "553:   do_catchsql_test 16.20 {",
      "554:     ALTER TABLE y1_segments RENAME TO abc;",
      "555:   } {1 {table y1_segments may not be altered}}",
      "556:   sqlite3_db_config db DEFENSIVE 0",
      "557:   do_catchsql_test 16.22 {",
      "558:     ALTER TABLE y1_segments RENAME TO abc;",
      "559:   } {0 {}}",
      "560:   sqlite3_db_config db DEFENSIVE 1",
      "561:   do_catchsql_test 16.23 {",
      "562:     CREATE TABLE y1_segments AS SELECT * FROM abc;",
      "563:   } {1 {object name reserved for internal use: y1_segments}}",
      "564:   do_catchsql_test 16.24 {",
      "565:     CREATE VIEW y1_segments AS SELECT * FROM abc;",
      "566:   } {1 {object name reserved for internal use: y1_segments}}",
      "567:   sqlite3_db_config db DEFENSIVE 0",
      "568:   do_catchsql_test 16.25 {",
      "569:     ALTER TABLE abc RENAME TO y1_segments;",
      "570:   } {0 {}}",
      "571:   sqlite3_db_config db DEFENSIVE 1",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "4245e0456d8387d867a73ab3d986aabcf3725ff2",
      "candidate_info": {
        "commit_hash": "4245e0456d8387d867a73ab3d986aabcf3725ff2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/4245e0456d8387d867a73ab3d986aabcf3725ff2",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in",
          "test/altertab3.test"
        ],
        "message": "Fix a minor error in a test script, and harmless compiler warnings in the CLI code.\n\nFossilOrigin-Name: eaa34626e497d3af132dd8f13eddbbda89365d369ed43212a5f788175b3d6198",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in",
          "test/altertab3.test||test/altertab3.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: ebb81dad1f43dac4636cd44d4055d1d4b198c675f73e23c5a2d8d992ae27fe1f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "6562:     char *z = azArg[i];",
          "6563:     int n;",
          "6564:     if( z[0]=='-' && z[1]=='-' ) z++;",
          "6566:     if( n<=17 && memcmp(\"-freelist-corrupt\", z, n)==0 ){",
          "6567:       bFreelist = 0;",
          "6568:     }else",
          "",
          "[Removed Lines]",
          "6565:     n = strlen(z);",
          "",
          "[Added Lines]",
          "6565:     n = strlen30(z);",
          "",
          "---------------"
        ],
        "test/altertab3.test||test/altertab3.test": [
          "File: test/altertab3.test -> test/altertab3.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "204:   db2 eval { INSERT INTO t2 VALUES (1), (2), (3) }",
          "205:   db close",
          "206: } {}",
          "208: #-------------------------------------------------------------------------",
          "209: reset_db",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "207: db2 close",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "83c5bb997a496d00f50b63a9af8feccb33a2b138",
      "candidate_info": {
        "commit_hash": "83c5bb997a496d00f50b63a9af8feccb33a2b138",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/83c5bb997a496d00f50b63a9af8feccb33a2b138",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/window.c"
        ],
        "message": "Mark rowid-comparison opcodes as never-null for VDBE coverage tracking purposes.\n\nFossilOrigin-Name: a69bb4f257500e40ef4056d5628ef25266def5bcef07eebdb471a79fffe80237",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/window.c||src/window.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f56d305a7bad6608d51d8c8cef417ddb66cff50f0a75d28554ea669e47f3d90d",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1578:   if( pMWin->eExclude==TK_CURRENT ){",
          "1579:     sqlite3VdbeAddOp3(v, OP_Eq, regCRowid, lblNext, regRowid);",
          "1581:   }else if( pMWin->eExclude!=TK_NO ){",
          "1582:     int addr;",
          "1583:     int addrEq = 0;",
          "",
          "[Removed Lines]",
          "1580:     VdbeCoverage(v);",
          "",
          "[Added Lines]",
          "1580:     VdbeCoverageNeverNull(v);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1588:     }",
          "1589:     if( pMWin->eExclude==TK_TIES ){",
          "1590:       addrEq = sqlite3VdbeAddOp3(v, OP_Eq, regCRowid, 0, regRowid);",
          "1592:     }",
          "1593:     if( pKeyInfo ){",
          "1594:       windowReadPeerValues(p, csr, regPeer);",
          "",
          "[Removed Lines]",
          "1591:       VdbeCoverage(v);",
          "",
          "[Added Lines]",
          "1591:       VdbeCoverageNeverNull(v);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2526:   sqlite3VdbeAddOp2(v, OP_NewRowid, csrWrite, regRowid);",
          "2527:   sqlite3VdbeAddOp3(v, OP_Insert, csrWrite, regRecord, regRowid);",
          "2528:   addrNe = sqlite3VdbeAddOp3(v, OP_Ne, pMWin->regOne, 0, regRowid);",
          "2532:   s.regArg = windowInitAccum(pParse, pMWin);",
          "",
          "[Removed Lines]",
          "2529:   VdbeCoverage(v);",
          "",
          "[Added Lines]",
          "2529:   VdbeCoverageNeverNull(v);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "8cf92890f28ace3c510c448b5be6de2ca96016c2",
      "candidate_info": {
        "commit_hash": "8cf92890f28ace3c510c448b5be6de2ca96016c2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/8cf92890f28ace3c510c448b5be6de2ca96016c2",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbeapi.c"
        ],
        "message": "Avoid the use of function pointers in columnName(), as function pointers appear to be a source of consternation to LLVM.\n\nFossilOrigin-Name: c48f6f39c5f89a338fed7153553a27a5d882d4d8db8221e911b96e0dd57c53d9",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbeapi.c||src/vdbeapi.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 0c5db18d79366d9c23925ce3ed835500311f32a10aa7dbfdd09148b1e8a2507b",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbeapi.c||src/vdbeapi.c": [
          "File: src/vdbeapi.c -> src/vdbeapi.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1122: static const void *columnName(",
          "1127: ){",
          "1128:   const void *ret;",
          "1129:   Vdbe *p;",
          "",
          "[Removed Lines]",
          "1123:   sqlite3_stmt *pStmt,",
          "1124:   int N,",
          "1125:   const void *(*xFunc)(Mem*),",
          "1126:   int useType",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1144:     N += useType*n;",
          "1145:     sqlite3_mutex_enter(db->mutex);",
          "1146:     assert( db->mallocFailed==0 );",
          "1151:     if( db->mallocFailed ){",
          "",
          "[Removed Lines]",
          "1147:     ret = xFunc(&p->aColName[N]);",
          "",
          "[Added Lines]",
          "1147:     if( useUtf16 ){",
          "1148:       ret = sqlite3_value_text16((sqlite3_value*)&p->aColName[N]);",
          "1149:     }else{",
          "1150:       ret = sqlite3_value_text((sqlite3_value*)&p->aColName[N]);",
          "1151:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1164: const char *sqlite3_column_name(sqlite3_stmt *pStmt, int N){",
          "1167: }",
          "1168: #ifndef SQLITE_OMIT_UTF16",
          "1169: const void *sqlite3_column_name16(sqlite3_stmt *pStmt, int N){",
          "1172: }",
          "1173: #endif",
          "",
          "[Removed Lines]",
          "1165:   return columnName(",
          "1166:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text, COLNAME_NAME);",
          "1170:   return columnName(",
          "1171:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text16, COLNAME_NAME);",
          "",
          "[Added Lines]",
          "1169:   return columnName(pStmt, N, 0, COLNAME_NAME);",
          "1173:   return columnName(pStmt, N, 1, COLNAME_NAME);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1189: const char *sqlite3_column_decltype(sqlite3_stmt *pStmt, int N){",
          "1192: }",
          "1193: #ifndef SQLITE_OMIT_UTF16",
          "1194: const void *sqlite3_column_decltype16(sqlite3_stmt *pStmt, int N){",
          "1197: }",
          "",
          "[Removed Lines]",
          "1190:   return columnName(",
          "1191:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text, COLNAME_DECLTYPE);",
          "1195:   return columnName(",
          "1196:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text16, COLNAME_DECLTYPE);",
          "",
          "[Added Lines]",
          "1192:   return columnName(pStmt, N, 0, COLNAME_DECLTYPE);",
          "1196:   return columnName(pStmt, N, 1, COLNAME_DECLTYPE);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1207: const char *sqlite3_column_database_name(sqlite3_stmt *pStmt, int N){",
          "1210: }",
          "1211: #ifndef SQLITE_OMIT_UTF16",
          "1212: const void *sqlite3_column_database_name16(sqlite3_stmt *pStmt, int N){",
          "1215: }",
          "",
          "[Removed Lines]",
          "1208:   return columnName(",
          "1209:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text, COLNAME_DATABASE);",
          "1213:   return columnName(",
          "1214:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text16, COLNAME_DATABASE);",
          "",
          "[Added Lines]",
          "1208:   return columnName(pStmt, N, 0, COLNAME_DATABASE);",
          "1212:   return columnName(pStmt, N, 1, COLNAME_DATABASE);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1223: const char *sqlite3_column_table_name(sqlite3_stmt *pStmt, int N){",
          "1226: }",
          "1227: #ifndef SQLITE_OMIT_UTF16",
          "1228: const void *sqlite3_column_table_name16(sqlite3_stmt *pStmt, int N){",
          "1231: }",
          "",
          "[Removed Lines]",
          "1224:   return columnName(",
          "1225:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text, COLNAME_TABLE);",
          "1229:   return columnName(",
          "1230:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text16, COLNAME_TABLE);",
          "",
          "[Added Lines]",
          "1222:   return columnName(pStmt, N, 0, COLNAME_TABLE);",
          "1226:   return columnName(pStmt, N, 1, COLNAME_TABLE);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1239: const char *sqlite3_column_origin_name(sqlite3_stmt *pStmt, int N){",
          "1242: }",
          "1243: #ifndef SQLITE_OMIT_UTF16",
          "1244: const void *sqlite3_column_origin_name16(sqlite3_stmt *pStmt, int N){",
          "1247: }",
          "",
          "[Removed Lines]",
          "1240:   return columnName(",
          "1241:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text, COLNAME_COLUMN);",
          "1245:   return columnName(",
          "1246:       pStmt, N, (const void*(*)(Mem*))sqlite3_value_text16, COLNAME_COLUMN);",
          "",
          "[Added Lines]",
          "1236:   return columnName(pStmt, N, 0, COLNAME_COLUMN);",
          "1240:   return columnName(pStmt, N, 1, COLNAME_COLUMN);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e7e48dc629f2703f1130ee792705374f8b72622c",
      "candidate_info": {
        "commit_hash": "e7e48dc629f2703f1130ee792705374f8b72622c",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/e7e48dc629f2703f1130ee792705374f8b72622c",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/releasetest_data.tcl"
        ],
        "message": "Add \"set TMP=%CD%\" to the start of each msvc script output by releasetest_data.tcl. Otherwise, since binaries compiled with SQLITE_TEST all choose the same sequence of pseudo-random numbers, collisions between temp file names cause errors when running multiple tests in parallel.\n\nFossilOrigin-Name: f5d0436d8dc650cadb61a5fe76fd1a0d68dabba54ff0c2a8c138f9dfbdab1c3f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/releasetest_data.tcl||test/releasetest_data.tcl"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 8158d2aca68c5a253054376fdf1b8eaab2db874f4b93524742be7340e9c50dd5",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/releasetest_data.tcl||test/releasetest_data.tcl": [
          "File: test/releasetest_data.tcl -> test/releasetest_data.tcl",
          "--- Hunk 1 ---",
          "[Context before]",
          "546:     set makecmd    \"nmake /f %SRCDIR%\\\\Makefile.msc TOP=%SRCDIR% $target \"",
          "547:     append makecmd \"\\\"CFLAGS=$cflags\\\" \\\"OPTS=$opts\\\" $makeOpts\"",
          "549:     puts $makecmd",
          "550:   }",
          "551: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "549:     puts \"set TMP=%CD%\"",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6ca644818b163eaebae657f816f907335ed0b068",
      "candidate_info": {
        "commit_hash": "6ca644818b163eaebae657f816f907335ed0b068",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/6ca644818b163eaebae657f816f907335ed0b068",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/memdb.c",
          "src/shell.c.in",
          "src/sqlite.h.in",
          "src/tclsqlite.c",
          "test/memdb1.test"
        ],
        "message": "Enhancements to deserialize: (1) Add the SQLITE_FCNTL_SIZE_LIMIT file control to set a maximum size for an in-memory database, defaulting to SQLITE_MEMDB_DEFAULT_MAXSIZE or 1GiB.  (2) Honor the SQLITE_DESERIALIZE_READONLY flag. (3) Enhance the TCL interface to support -maxsize N and -readonly BOOLEAN. (4) Add the --maxsize option to the \".open\" command and on the command-line for the CLI.\n\nFossilOrigin-Name: 30f08d58882819a69e353bcc1b6b349664bbfbe00aa1c115ba44a9fd899fcc5b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/memdb.c||src/memdb.c",
          "src/shell.c.in||src/shell.c.in",
          "src/sqlite.h.in||src/sqlite.h.in",
          "src/tclsqlite.c||src/tclsqlite.c",
          "test/memdb1.test||test/memdb1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: e148cdad35520e6684cfeba23b003f60b55f83a6bf621aff16be8aa5612cdcee",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/memdb.c||src/memdb.c": [
          "File: src/memdb.c -> src/memdb.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "34: struct MemFile {",
          "42: };",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46: #ifndef SQLITE_MEMDB_DEFAULT_MAXSIZE",
          "47: # define SQLITE_MEMDB_DEFAULT_MAXSIZE 1073741824",
          "48: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "160:   if( (p->mFlags & SQLITE_DESERIALIZE_RESIZEABLE)==0 || p->nMmap>0 ){",
          "161:     return SQLITE_FULL;",
          "162:   }",
          "163:   pNew = sqlite3_realloc64(p->aData, newSz);",
          "164:   if( pNew==0 ) return SQLITE_NOMEM;",
          "165:   p->aData = pNew;",
          "167:   return SQLITE_OK;",
          "168: }",
          "",
          "[Removed Lines]",
          "166:   p->szMax = newSz;",
          "",
          "[Added Lines]",
          "169:   if( newSz>p->szMax ){",
          "170:     return SQLITE_FULL;",
          "171:   }",
          "172:   newSz *= 2;",
          "173:   if( newSz>p->szMax ) newSz = p->szMax;",
          "177:   p->szAlloc = newSz;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "177:   sqlite_int64 iOfst",
          "178: ){",
          "179:   MemFile *p = (MemFile *)pFile;",
          "180:   if( iOfst+iAmt>p->sz ){",
          "181:     int rc;",
          "184:     ){",
          "185:       return rc;",
          "186:     }",
          "",
          "[Removed Lines]",
          "182:     if( iOfst+iAmt>p->szMax",
          "183:      && (rc = memdbEnlarge(p, (iOfst+iAmt)*2))!=SQLITE_OK",
          "",
          "[Added Lines]",
          "191:   if( p->mFlags & SQLITE_DESERIALIZE_READONLY ) return SQLITE_READONLY;",
          "194:     if( iOfst+iAmt>p->szAlloc",
          "195:      && (rc = memdbEnlarge(p, iOfst+iAmt))!=SQLITE_OK",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "251:     rc = SQLITE_OK;",
          "252:   }",
          "253:   return rc;",
          "254: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "265:   if( op==SQLITE_FCNTL_SIZE_LIMIT ){",
          "266:     sqlite3_int64 iLimit = *(sqlite3_int64*)pArg;",
          "267:     if( iLimit<p->sz ){",
          "268:       if( iLimit<0 ){",
          "269:         iLimit = p->szMax;",
          "270:       }else{",
          "271:         iLimit = p->sz;",
          "272:       }",
          "273:     }",
          "274:     p->szMax = iLimit;",
          "276:     rc = SQLITE_OK;",
          "277:   }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "313:   p->base.pMethods = &memdb_io_methods;",
          "314:   return SQLITE_OK;",
          "315: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "339:   p->szMax = SQLITE_MEMDB_DEFAULT_MAXSIZE;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "560:   }else{",
          "561:     p->aData = pData;",
          "562:     p->sz = szDb;",
          "563:     p->szMax = szBuf;",
          "564:     p->mFlags = mFlags;",
          "565:     rc = SQLITE_OK;",
          "566:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "589:     p->szAlloc = szBuf;",
          "591:     if( p->szMax<SQLITE_MEMDB_DEFAULT_MAXSIZE ){",
          "592:       p->szMax = SQLITE_MEMDB_DEFAULT_MAXSIZE;",
          "593:     }",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "3449: #ifdef SQLITE_ENABLE_DESERIALIZE",
          "3450:   \"        --deserialize   Load into memory useing sqlite3_deserialize()\",",
          "3451:   \"        --hexdb         Load the output of \\\"dbtotxt\\\" as an in-memory database\",",
          "3452: #endif",
          "3453:   \"        --new           Initialize FILE to an empty database\",",
          "3454:   \"        --readonly      Open FILE readonly\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3453:   \"        --maxsize N     Maximum size for --hexdb or --deserialized database\",",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3927:       if( rc ){",
          "3928:         utf8_printf(stderr, \"Error: sqlite3_deserialize() returns %d\\n\", rc);",
          "3929:       }",
          "3930:     }",
          "3931: #endif",
          "3932:   }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3932:       if( p->szMax>0 ){",
          "3933:         sqlite3_file_control(p->db, \"main\", SQLITE_FCNTL_SIZE_LIMIT, &p->szMax);",
          "3934:       }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "6841:     sqlite3_free(p->zFreeOnClose);",
          "6842:     p->zFreeOnClose = 0;",
          "6843:     p->openMode = SHELL_OPEN_UNSPEC;",
          "6845:     for(iName=1; iName<nArg && azArg[iName][0]=='-'; iName++){",
          "6846:       const char *z = azArg[iName];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6849:     p->szMax = 0;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "6859:         p->openMode = SHELL_OPEN_DESERIALIZE;",
          "6860:       }else if( optionMatch(z, \"hexdb\") ){",
          "6861:         p->openMode = SHELL_OPEN_HEXDB;",
          "6863:       }else if( z[0]=='-' ){",
          "6864:         utf8_printf(stderr, \"unknown option: %s\\n\", z);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6868:       }else if( optionMatch(z, \"maxsize\") && iName+1<nArg ){",
          "6869:         p->szMax = integerValue(azArg[++iName]);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "8549:   \"   -column              set output mode to 'column'\\n\"",
          "8550:   \"   -cmd COMMAND         run \\\"COMMAND\\\" before reading stdin\\n\"",
          "8551:   \"   -csv                 set output mode to 'csv'\\n\"",
          "8552:   \"   -echo                print commands before execution\\n\"",
          "8553:   \"   -init FILENAME       read/process named file\\n\"",
          "8554:   \"   -[no]header          turn headers on or off\\n\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8560: #if defined(SQLITE_ENABLE_DESERIALIZE)",
          "8561:   \"   -deserialize         open the database using sqlite3_deserialize()\\n\"",
          "8562: #endif",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "8561:   \"   -line                set output mode to 'line'\\n\"",
          "8562:   \"   -list                set output mode to 'list'\\n\"",
          "8563:   \"   -lookaside SIZE N    use N entries of SZ bytes for lookaside memory\\n\"",
          "8564:   \"   -mmap N              default mmap size set to N\\n\"",
          "8565: #ifdef SQLITE_ENABLE_MULTIPLEX",
          "8566:   \"   -multiplex           enable the multiplexor VFS\\n\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8575: #if defined(SQLITE_ENABLE_DESERIALIZE)",
          "8576:   \"   -maxsize N           maximum size for a --deserialize database\\n\"",
          "8577: #endif",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "8871: #ifdef SQLITE_ENABLE_DESERIALIZE",
          "8872:     }else if( strcmp(z,\"-deserialize\")==0 ){",
          "8873:       data.openMode = SHELL_OPEN_DESERIALIZE;",
          "8874: #endif",
          "8875:     }else if( strcmp(z,\"-readonly\")==0 ){",
          "8876:       data.openMode = SHELL_OPEN_READONLY;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8888:     }else if( strcmp(z,\"-maxsize\")==0 && i+1<argc ){",
          "8889:       data.szMax = integerValue(argv[++i]);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "8972: #ifdef SQLITE_ENABLE_DESERIALIZE",
          "8973:     }else if( strcmp(z,\"-deserialize\")==0 ){",
          "8974:       data.openMode = SHELL_OPEN_DESERIALIZE;",
          "8975: #endif",
          "8976:     }else if( strcmp(z,\"-readonly\")==0 ){",
          "8977:       data.openMode = SHELL_OPEN_READONLY;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8991:     }else if( strcmp(z,\"-maxsize\")==0 && i+1<argc ){",
          "8992:       data.szMax = integerValue(argv[++i]);",
          "",
          "---------------"
        ],
        "src/sqlite.h.in||src/sqlite.h.in": [
          "File: src/sqlite.h.in -> src/sqlite.h.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1131: #define SQLITE_FCNTL_ROLLBACK_ATOMIC_WRITE  33",
          "1132: #define SQLITE_FCNTL_LOCK_TIMEOUT           34",
          "1133: #define SQLITE_FCNTL_DATA_VERSION           35",
          "1136: #define SQLITE_GET_LOCKPROXYFILE      SQLITE_FCNTL_GET_LOCKPROXYFILE",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1143: #define SQLITE_FCNTL_SIZE_LIMIT             36",
          "",
          "---------------"
        ],
        "src/tclsqlite.c||src/tclsqlite.c": [
          "File: src/tclsqlite.c -> src/tclsqlite.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2428:                      (char*)0);",
          "2429:     rc = TCL_ERROR;",
          "2430: #else",
          "2433:     unsigned char *pBA;",
          "2434:     unsigned char *pData;",
          "2435:     int len, xrc;",
          "2444:       Tcl_WrongNumArgs(interp, 2, objv, \"?DATABASE? VALUE\");",
          "2445:       rc = TCL_ERROR;",
          "2446:       break;",
          "2447:     }",
          "2448:     pBA = Tcl_GetByteArrayFromObj(pValue, &len);",
          "2449:     pData = sqlite3_malloc64( len );",
          "2450:     if( pData==0 && len>0 ){",
          "2451:       Tcl_AppendResult(interp, \"out of memory\", (char*)0);",
          "2452:       rc = TCL_ERROR;",
          "2453:     }else{",
          "2454:       if( len>0 ) memcpy(pData, pBA, len);",
          "2458:       if( xrc ){",
          "2459:         Tcl_AppendResult(interp, \"unable to set MEMDB content\", (char*)0);",
          "2460:         rc = TCL_ERROR;",
          "2461:       }",
          "2462:     }",
          "2463: #endif",
          "2464:     break;",
          "2465:   }",
          "",
          "[Removed Lines]",
          "2431:     const char *zSchema;",
          "2432:     Tcl_Obj *pValue;",
          "2437:     if( objc==3 ){",
          "2438:       zSchema = 0;",
          "2439:       pValue = objv[2];",
          "2440:     }else if( objc==4 ){",
          "2441:       zSchema = Tcl_GetString(objv[2]);",
          "2442:       pValue = objv[3];",
          "2443:     }else{",
          "2455:       xrc = sqlite3_deserialize(pDb->db, zSchema, pData, len, len,",
          "2456:                 SQLITE_DESERIALIZE_FREEONCLOSE |",
          "2457:                 SQLITE_DESERIALIZE_RESIZEABLE);",
          "",
          "[Added Lines]",
          "2431:     const char *zSchema = 0;",
          "2432:     Tcl_Obj *pValue = 0;",
          "2436:     sqlite3_int64 mxSize = 0;",
          "2437:     int i;",
          "2438:     int isReadonly = 0;",
          "2441:     if( objc<3 ){",
          "2446:     for(i=2; i<objc-1; i++){",
          "2447:       const char *z = Tcl_GetString(objv[i]);",
          "2448:       if( strcmp(z,\"-maxsize\")==0 && i<objc-2 ){",
          "2449:         rc = Tcl_GetWideIntFromObj(interp, objv[++i], &mxSize);",
          "2450:         if( rc ) goto deserialize_error;",
          "2451:         continue;",
          "2452:       }",
          "2453:       if( strcmp(z,\"-readonly\")==0 && i<objc-2 ){",
          "2454:         rc = Tcl_GetBooleanFromObj(interp, objv[++i], &isReadonly);",
          "2455:         if( rc ) goto deserialize_error;",
          "2456:         continue;",
          "2457:       }",
          "2458:       if( zSchema==0 && i==objc-2 && z[0]!='-' ){",
          "2459:         zSchema = z;",
          "2460:         continue;",
          "2461:       }",
          "2462:       Tcl_AppendResult(interp, \"unknown option: \", z, (char*)0);",
          "2463:       rc = TCL_ERROR;",
          "2464:       goto deserialize_error;",
          "2465:     }",
          "2466:     pValue = objv[objc-1];",
          "2473:       int flags;",
          "2475:       if( isReadonly ){",
          "2476:         flags = SQLITE_DESERIALIZE_FREEONCLOSE | SQLITE_DESERIALIZE_READONLY;",
          "2477:       }else{",
          "2478:         flags = SQLITE_DESERIALIZE_FREEONCLOSE | SQLITE_DESERIALIZE_RESIZEABLE;",
          "2479:       }",
          "2480:       xrc = sqlite3_deserialize(pDb->db, zSchema, pData, len, len, flags);",
          "2485:       if( mxSize>0 ){",
          "2486:         sqlite3_file_control(pDb->db, zSchema,SQLITE_FCNTL_SIZE_LIMIT,&mxSize);",
          "2487:       }",
          "2489: deserialize_error:",
          "",
          "---------------"
        ],
        "test/memdb1.test||test/memdb1.test": [
          "File: test/memdb1.test -> test/memdb1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:   PRAGMA page_count;",
          "73: } {2}",
          "75: # Build a largish on-disk database and serialize it.  Verify that the",
          "76: # serialization works.",
          "77: #",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "75: do_test 150 {",
          "76:   catch {db deserialize -unknown 1 $db1} msg",
          "77:   set msg",
          "78: } {unknown option: -unknown}",
          "79: do_test 151 {",
          "80:   db deserialize -readonly 1 $db1",
          "81:   db eval {SELECT * FROM t1}",
          "82: } {1 2}",
          "83: do_test 152 {",
          "84:   catchsql {INSERT INTO t1 VALUES(3,4);}",
          "85: } {1 {attempt to write a readonly database}}",
          "87: breakpoint",
          "88: do_test 160 {",
          "89:   db deserialize -maxsize 32768 $db1",
          "90:   db eval {SELECT * FROM t1}",
          "91: } {1 2}",
          "92: do_test 161 {",
          "93:   db eval {INSERT INTO t1 VALUES(3,4); SELECT * FROM t1}",
          "94: } {1 2 3 4}",
          "95: do_test 162 {",
          "96:   catchsql {INSERT INTO t1 VALUES(5,randomblob(100000))}",
          "97: } {1 {database or disk is full}}",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "154: do_test 610 {",
          "155:   set rc [catch {db deserialize a b c} msg]",
          "156:   lappend rc $msg",
          "158: do_test 620 {",
          "159:   set rc [catch {db serialize a b} msg]",
          "160:   lappend rc $msg",
          "",
          "[Removed Lines]",
          "157: } {1 {wrong # args: should be \"db deserialize ?DATABASE? VALUE\"}}",
          "",
          "[Added Lines]",
          "182: } {1 {unknown option: a}}",
          "",
          "---------------"
        ]
      }
    }
  ]
}