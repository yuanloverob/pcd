{
  "cve_id": "CVE-2021-41211",
  "cve_desc": "TensorFlow is an open source platform for machine learning. In affected versions the shape inference code for `QuantizeV2` can trigger a read outside of bounds of heap allocated array. This occurs whenever `axis` is a negative value less than `-1`. In this case, we are accessing data before the start of a heap buffer. The code allows `axis` to be an optional argument (`s` would contain an `error::NOT_FOUND` error code). Otherwise, it assumes that `axis` is a valid index into the dimensions of the `input` tensor. If `axis` is less than `-1` then this results in a heap OOB read. The fix will be included in TensorFlow 2.7.0. We will also cherrypick this commit on TensorFlow 2.6.1, as this version is the only one that is also affected.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "a0d64445116c43cf46a5666bd4eee28e7a82f244",
  "patch_info": {
    "commit_hash": "a0d64445116c43cf46a5666bd4eee28e7a82f244",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/a0d64445116c43cf46a5666bd4eee28e7a82f244",
    "files": [
      "tensorflow/core/framework/common_shape_fns.cc"
    ],
    "message": "Prevent OOB access in QuantizeV2 shape inference\n\nPiperOrigin-RevId: 400309614\nChange-Id: I31412c71b05b4f21b677f7fa715a61499cbee39d",
    "before_after_code_files": [
      "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc": [
      "File: tensorflow/core/framework/common_shape_fns.cc -> tensorflow/core/framework/common_shape_fns.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "2559:   if (!s.ok() && s.code() != error::NOT_FOUND) {",
      "2560:     return s;",
      "2561:   }",
      "2562:   const int minmax_rank = (axis == -1) ? 0 : 1;",
      "2563:   TF_RETURN_IF_ERROR(shape_inference::UnchangedShape(c));",
      "2564:   ShapeHandle minmax;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2562:   if (axis < -1) {",
      "2563:     return errors::InvalidArgument(\"axis should be at least -1, got \", axis);",
      "2564:   }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ff0fdf765f4b8641cd5f08a860e23d725a81d05c",
      "candidate_info": {
        "commit_hash": "ff0fdf765f4b8641cd5f08a860e23d725a81d05c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/ff0fdf765f4b8641cd5f08a860e23d725a81d05c",
        "files": [
          "tensorflow/core/framework/common_shape_fns.cc"
        ],
        "message": "Prevent OOB access in QuantizeV2 shape inference\n\nPiperOrigin-RevId: 400309614\nChange-Id: I31412c71b05b4f21b677f7fa715a61499cbee39d",
        "before_after_code_files": [
          "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
          ],
          "candidate": [
            "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc": [
          "File: tensorflow/core/framework/common_shape_fns.cc -> tensorflow/core/framework/common_shape_fns.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "2559:   if (!s.ok() && s.code() != error::NOT_FOUND) {",
          "2560:     return s;",
          "2561:   }",
          "2562:   const int minmax_rank = (axis == -1) ? 0 : 1;",
          "2563:   TF_RETURN_IF_ERROR(shape_inference::UnchangedShape(c));",
          "2564:   ShapeHandle minmax;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2562:   if (axis < -1) {",
          "2563:     return errors::InvalidArgument(\"axis should be at least -1, got \", axis);",
          "2564:   }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "276a88daa218c93345c070b31c9c480c968bac16",
      "candidate_info": {
        "commit_hash": "276a88daa218c93345c070b31c9c480c968bac16",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/276a88daa218c93345c070b31c9c480c968bac16",
        "files": [
          "tensorflow/core/framework/common_shape_fns.cc"
        ],
        "message": "Prevent OOB access in QuantizeV2 shape inference\n\nPiperOrigin-RevId: 400309614\nChange-Id: I31412c71b05b4f21b677f7fa715a61499cbee39d",
        "before_after_code_files": [
          "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
          ],
          "candidate": [
            "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/framework/common_shape_fns.cc||tensorflow/core/framework/common_shape_fns.cc": [
          "File: tensorflow/core/framework/common_shape_fns.cc -> tensorflow/core/framework/common_shape_fns.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "2521:   if (!s.ok() && s.code() != error::NOT_FOUND) {",
          "2522:     return s;",
          "2523:   }",
          "2524:   const int minmax_rank = (axis == -1) ? 0 : 1;",
          "2525:   TF_RETURN_IF_ERROR(shape_inference::UnchangedShape(c));",
          "2526:   ShapeHandle minmax;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2524:   if (axis < -1) {",
          "2525:     return errors::InvalidArgument(\"axis should be at least -1, got \", axis);",
          "2526:   }",
          "",
          "---------------"
        ]
      }
    }
  ]
}