{
  "cve_id": "CVE-2013-7018",
  "cve_desc": "libavcodec/jpeg2000dec.c in FFmpeg before 2.1 does not ensure the use of valid code-block dimension values, which allows remote attackers to cause a denial of service (out-of-bounds array access) or possibly have unspecified other impact via crafted JPEG2000 data.",
  "repo": "FFmpeg/FFmpeg",
  "patch_hash": "9a271a9368eaabf99e6c2046103acb33957e63b7",
  "patch_info": {
    "commit_hash": "9a271a9368eaabf99e6c2046103acb33957e63b7",
    "repo": "FFmpeg/FFmpeg",
    "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/9a271a9368eaabf99e6c2046103acb33957e63b7",
    "files": [
      "libavcodec/jpeg2000dec.c"
    ],
    "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
    "before_after_code_files": [
      "libavcodec/jpeg2000dec.c||libavcodec/jpeg2000dec.c"
    ]
  },
  "patch_diff": {
    "libavcodec/jpeg2000dec.c||libavcodec/jpeg2000dec.c": [
      "File: libavcodec/jpeg2000dec.c -> libavcodec/jpeg2000dec.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "384:         return AVERROR_INVALIDDATA;",
      "385:     }",
      "387:     c->cblk_style = bytestream2_get_byteu(&s->g);",
      "388:     if (c->cblk_style != 0) { // cblk style",
      "389:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "387:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
      "388:         avpriv_request_sample(s->avctx, \"cblk size > 64\");",
      "389:         return AVERROR_PATCHWELCOME;",
      "390:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1025:     int bpass_csty_symbol           = codsty->cblk_style & JPEG2000_CBLK_BYPASS;",
      "1026:     int vert_causal_ctx_csty_symbol = codsty->cblk_style & JPEG2000_CBLK_VSC;",
      "1028:     for (y = 0; y < height; y++)",
      "1029:         memset(t1->data[y], 0, width * sizeof(**t1->data));",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1033:     av_assert0(width  <= JPEG2000_MAX_CBLKW);",
      "1034:     av_assert0(height <= JPEG2000_MAX_CBLKH);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "359bfa4c272adf9c3b1c59d123fadb57a9e2f8cb",
      "candidate_info": {
        "commit_hash": "359bfa4c272adf9c3b1c59d123fadb57a9e2f8cb",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/359bfa4c272adf9c3b1c59d123fadb57a9e2f8cb",
        "files": [
          "libavcodec/j2kdec.c"
        ],
        "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9a271a9368eaabf99e6c2046103acb33957e63b7)\n\nConflicts:\n\n\tlibavcodec/jpeg2000dec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/j2kdec.c||libavcodec/j2kdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/j2kdec.c||libavcodec/j2kdec.c": [
          "File: libavcodec/j2kdec.c -> libavcodec/j2kdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: #include \"bytestream.h\"",
          "32: #include \"internal.h\"",
          "33: #include \"j2k.h\"",
          "34: #include \"libavutil/common.h\"",
          "36: #define JP2_SIG_TYPE    0x6A502020",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "302:      c->log2_cblk_width = bytestream2_get_byteu(&s->g) + 2; // cblk width",
          "303:     c->log2_cblk_height = bytestream2_get_byteu(&s->g) + 2; // cblk height",
          "305:     c->cblk_style = bytestream2_get_byteu(&s->g);",
          "306:     if (c->cblk_style != 0){ // cblk style",
          "307:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "306:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
          "307:         return AVERROR_PATCHWELCOME;",
          "308:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "719:     int bpass_csty_symbol = J2K_CBLK_BYPASS & codsty->cblk_style;",
          "720:     int vert_causal_ctx_csty_symbol = J2K_CBLK_VSC & codsty->cblk_style;",
          "722:     for (y = 0; y < height+2; y++)",
          "723:         memset(t1->flags[y], 0, (width+2)*sizeof(int));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "727:     av_assert0(width  <= J2K_MAX_CBLKW);",
          "728:     av_assert0(height <= J2K_MAX_CBLKH);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "38ca79b04d9a16790be7941950152b514a237759",
      "candidate_info": {
        "commit_hash": "38ca79b04d9a16790be7941950152b514a237759",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/38ca79b04d9a16790be7941950152b514a237759",
        "files": [
          "libavcodec/j2kdec.c"
        ],
        "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9a271a9368eaabf99e6c2046103acb33957e63b7)\n\nConflicts:\n\n\tlibavcodec/jpeg2000dec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n\nConflicts:\n\n\tlibavcodec/j2kdec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/j2kdec.c||libavcodec/j2kdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/j2kdec.c||libavcodec/j2kdec.c": [
          "File: libavcodec/j2kdec.c -> libavcodec/j2kdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: #include \"avcodec.h\"",
          "29: #include \"bytestream.h\"",
          "30: #include \"j2k.h\"",
          "31: #include \"libavutil/common.h\"",
          "33: #define JP2_SIG_TYPE    0x6A502020",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "283:      c->log2_cblk_width = bytestream_get_byte(&s->buf) + 2; // cblk width",
          "284:     c->log2_cblk_height = bytestream_get_byte(&s->buf) + 2; // cblk height",
          "286:     c->cblk_style = bytestream_get_byte(&s->buf);",
          "287:     if (c->cblk_style != 0){ // cblk style",
          "288:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "287:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
          "288:         return AVERROR_PATCHWELCOME;",
          "289:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "699:     int bpass_csty_symbol = J2K_CBLK_BYPASS & codsty->cblk_style;",
          "700:     int vert_causal_ctx_csty_symbol = J2K_CBLK_VSC & codsty->cblk_style;",
          "702:     for (y = 0; y < height+2; y++)",
          "703:         memset(t1->flags[y], 0, (width+2)*sizeof(int));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "707:     av_assert0(width  <= J2K_MAX_CBLKW);",
          "708:     av_assert0(height <= J2K_MAX_CBLKH);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1a311ad99a57ec3cd4f821f8a4c22973e2b4d740",
      "candidate_info": {
        "commit_hash": "1a311ad99a57ec3cd4f821f8a4c22973e2b4d740",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/1a311ad99a57ec3cd4f821f8a4c22973e2b4d740",
        "files": [
          "libavcodec/j2kdec.c"
        ],
        "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9a271a9368eaabf99e6c2046103acb33957e63b7)\n\nConflicts:\n\n\tlibavcodec/jpeg2000dec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n\nConflicts:\n\n\tlibavcodec/j2kdec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/j2kdec.c||libavcodec/j2kdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/j2kdec.c||libavcodec/j2kdec.c": [
          "File: libavcodec/j2kdec.c -> libavcodec/j2kdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: #include \"avcodec.h\"",
          "29: #include \"bytestream.h\"",
          "30: #include \"j2k.h\"",
          "31: #include \"libavutil/common.h\"",
          "33: #define JP2_SIG_TYPE    0x6A502020",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "289:      c->log2_cblk_width = bytestream_get_byte(&s->buf) + 2; // cblk width",
          "290:     c->log2_cblk_height = bytestream_get_byte(&s->buf) + 2; // cblk height",
          "292:     c->cblk_style = bytestream_get_byte(&s->buf);",
          "293:     if (c->cblk_style != 0){ // cblk style",
          "294:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "293:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
          "294:         return AVERROR_PATCHWELCOME;",
          "295:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "705:     int bpass_csty_symbol = J2K_CBLK_BYPASS & codsty->cblk_style;",
          "706:     int vert_causal_ctx_csty_symbol = J2K_CBLK_VSC & codsty->cblk_style;",
          "708:     for (y = 0; y < height+2; y++)",
          "709:         memset(t1->flags[y], 0, (width+2)*sizeof(int));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "713:     av_assert0(width  <= J2K_MAX_CBLKW);",
          "714:     av_assert0(height <= J2K_MAX_CBLKH);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a4b4be7493bdfd6d50ef6038adcc45e5b07878f1",
      "candidate_info": {
        "commit_hash": "a4b4be7493bdfd6d50ef6038adcc45e5b07878f1",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/a4b4be7493bdfd6d50ef6038adcc45e5b07878f1",
        "files": [
          "libavcodec/j2kdec.c"
        ],
        "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9a271a9368eaabf99e6c2046103acb33957e63b7)\n\nConflicts:\n\n\tlibavcodec/jpeg2000dec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n\nConflicts:\n\n\tlibavcodec/j2kdec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/j2kdec.c||libavcodec/j2kdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/j2kdec.c||libavcodec/j2kdec.c": [
          "File: libavcodec/j2kdec.c -> libavcodec/j2kdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: #include \"avcodec.h\"",
          "29: #include \"bytestream.h\"",
          "30: #include \"j2k.h\"",
          "31: #include \"libavutil/common.h\"",
          "33: #define JP2_SIG_TYPE    0x6A502020",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "31: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "289:      c->log2_cblk_width = bytestream_get_byte(&s->buf) + 2; // cblk width",
          "290:     c->log2_cblk_height = bytestream_get_byte(&s->buf) + 2; // cblk height",
          "292:     c->cblk_style = bytestream_get_byte(&s->buf);",
          "293:     if (c->cblk_style != 0){ // cblk style",
          "294:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "293:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
          "294:         return AVERROR_PATCHWELCOME;",
          "295:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "705:     int bpass_csty_symbol = J2K_CBLK_BYPASS & codsty->cblk_style;",
          "706:     int vert_causal_ctx_csty_symbol = J2K_CBLK_VSC & codsty->cblk_style;",
          "708:     for (y = 0; y < height+2; y++)",
          "709:         memset(t1->flags[y], 0, (width+2)*sizeof(int));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "713:     av_assert0(width  <= J2K_MAX_CBLKW);",
          "714:     av_assert0(height <= J2K_MAX_CBLKH);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "848e5cfc0f7ef0eae410562c3d7f7744a83aae9b",
      "candidate_info": {
        "commit_hash": "848e5cfc0f7ef0eae410562c3d7f7744a83aae9b",
        "repo": "FFmpeg/FFmpeg",
        "commit_url": "https://github.com/FFmpeg/FFmpeg/commit/848e5cfc0f7ef0eae410562c3d7f7744a83aae9b",
        "files": [
          "libavcodec/j2kdec.c"
        ],
        "message": "jpeg2000: check log2_cblk dimensions\n\nFixes out of array access\nFixes Ticket2895\n\nFound-by: Piotr Bandurski <ami_stuff@o2.pl>\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>\n(cherry picked from commit 9a271a9368eaabf99e6c2046103acb33957e63b7)\n\nConflicts:\n\n\tlibavcodec/jpeg2000dec.c\n\nSigned-off-by: Michael Niedermayer <michaelni@gmx.at>",
        "before_after_code_files": [
          "libavcodec/j2kdec.c||libavcodec/j2kdec.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libavcodec/j2kdec.c||libavcodec/j2kdec.c": [
          "File: libavcodec/j2kdec.c -> libavcodec/j2kdec.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "31: #include \"bytestream.h\"",
          "32: #include \"internal.h\"",
          "33: #include \"j2k.h\"",
          "34: #include \"libavutil/common.h\"",
          "36: #define JP2_SIG_TYPE    0x6A502020",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "34: #include \"libavutil/avassert.h\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "302:      c->log2_cblk_width = bytestream2_get_byteu(&s->g) + 2; // cblk width",
          "303:     c->log2_cblk_height = bytestream2_get_byteu(&s->g) + 2; // cblk height",
          "305:     c->cblk_style = bytestream2_get_byteu(&s->g);",
          "306:     if (c->cblk_style != 0){ // cblk style",
          "307:         av_log(s->avctx, AV_LOG_WARNING, \"extra cblk styles %X\\n\", c->cblk_style);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "306:     if (c->log2_cblk_width > 6 || c->log2_cblk_height > 6) {",
          "307:         return AVERROR_PATCHWELCOME;",
          "308:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "719:     int bpass_csty_symbol = J2K_CBLK_BYPASS & codsty->cblk_style;",
          "720:     int vert_causal_ctx_csty_symbol = J2K_CBLK_VSC & codsty->cblk_style;",
          "722:     for (y = 0; y < height+2; y++)",
          "723:         memset(t1->flags[y], 0, (width+2)*sizeof(int));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "727:     av_assert0(width  <= J2K_MAX_CBLKW);",
          "728:     av_assert0(height <= J2K_MAX_CBLKH);",
          "",
          "---------------"
        ]
      }
    }
  ]
}