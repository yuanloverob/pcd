{
  "cve_id": "CVE-2015-7551",
  "cve_desc": "The Fiddle::Handle implementation in ext/fiddle/handle.c in Ruby before 2.0.0-p648, 2.1 before 2.1.8, and 2.2 before 2.2.4, as distributed in Apple OS X before 10.11.4 and other products, mishandles tainting, which allows context-dependent attackers to execute arbitrary code or cause a denial of service (application crash) via a crafted string, related to the DL module and the libffi library.  NOTE: this vulnerability exists because of a CVE-2009-5147 regression.",
  "repo": "ruby/ruby",
  "patch_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
  "patch_info": {
    "commit_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
    "repo": "ruby/ruby",
    "commit_url": "https://github.com/ruby/ruby/commit/339e11a7f178312d937b7c95dd3115ce7236597a",
    "files": [
      "ChangeLog",
      "ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb",
      "version.h"
    ],
    "message": "merge revision(s): 53153 and 23405@ruby_1_9_1\n\n\t* ext/fiddle/handle.c: check tainted string arguments.\n\t  Patch provided by tenderlove and nobu.\n\n\t* test/fiddle/test_handle.rb (class TestHandle): add test for above.\n\n\t* ext/dl/handle.c (rb_dlhandle_initialize): prohibits DL::dlopen\n\t  with a tainted name of library.\n\t  Patch by sheepman <sheepman AT sheepman.sakura.ne.jp>.\n\n\t* ext/dl/handle.c (rb_dlhandle_sym): ditto\n\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53156 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
    "before_after_code_files": [
      "ext/fiddle/handle.c||ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb",
      "version.h||version.h"
    ]
  },
  "patch_diff": {
    "ext/fiddle/handle.c||ext/fiddle/handle.c": [
      "File: ext/fiddle/handle.c -> ext/fiddle/handle.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #include <ruby.h>",
      "2: #include <fiddle.h>",
      "4: VALUE rb_cHandle;",
      "6: struct dl_handle {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: #define SafeStringValueCStr(v) (rb_check_safe_obj(rb_string_value(&v)), StringValueCStr(v))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "144:  break;",
      "145:       case 1:",
      "147:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "148:  break;",
      "149:       case 2:",
      "151:  cflag = NUM2INT(flag);",
      "152:  break;",
      "153:       default:",
      "",
      "[Removed Lines]",
      "146:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "150:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "",
      "[Added Lines]",
      "148:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "152:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "263:     return PTR2NUM(fiddle_handle);",
      "264: }",
      "",
      "[Removed Lines]",
      "266: static VALUE fiddle_handle_sym(void *handle, const char *symbol);",
      "",
      "[Added Lines]",
      "268: static VALUE fiddle_handle_sym(void *handle, VALUE symbol);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "282:  rb_raise(rb_eFiddleError, \"closed handle\");",
      "283:     }",
      "286: }",
      "288: #ifndef RTLD_NEXT",
      "",
      "[Removed Lines]",
      "285:     return fiddle_handle_sym(fiddle_handle->ptr, StringValueCStr(sym));",
      "",
      "[Added Lines]",
      "287:     return fiddle_handle_sym(fiddle_handle->ptr, sym);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "305: static VALUE",
      "306: rb_fiddle_handle_s_sym(VALUE self, VALUE sym)",
      "307: {",
      "309: }",
      "311: static VALUE",
      "313: {",
      "314: #if defined(HAVE_DLERROR)",
      "315:     const char *err;",
      "",
      "[Removed Lines]",
      "308:     return fiddle_handle_sym(RTLD_NEXT, StringValueCStr(sym));",
      "312: fiddle_handle_sym(void *handle, const char *name)",
      "",
      "[Added Lines]",
      "310:     return fiddle_handle_sym(RTLD_NEXT, sym);",
      "314: fiddle_handle_sym(void *handle, VALUE symbol)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "318: # define CHECK_DLERROR",
      "319: #endif",
      "320:     void (*func)();",
      "322:     rb_secure(2);",
      "323: #ifdef HAVE_DLERROR",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "323:     const char *name = SafeStringValueCStr(symbol);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "367:     }",
      "368: #endif",
      "369:     if( !func ){",
      "371:     }",
      "373:     return PTR2NUM(func);",
      "",
      "[Removed Lines]",
      "370:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%s\\\"\", name);",
      "",
      "[Added Lines]",
      "373:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%\"PRIsVALUE\"\\\"\", symbol);",
      "",
      "---------------"
    ],
    "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb": [
      "File: test/fiddle/test_handle.rb -> test/fiddle/test_handle.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:     include Test::Unit::Assertions",
      "13:     def test_to_i",
      "14:       handle = Fiddle::Handle.new(LIBC_SO)",
      "15:       assert_kind_of Integer, handle.to_i",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     def test_safe_handle_open",
      "14:       t = Thread.new do",
      "15:         $SAFE = 1",
      "16:         Fiddle::Handle.new(LIBC_SO.taint)",
      "17:       end",
      "18:       assert_raise(SecurityError) { t.value }",
      "19:     end",
      "21:     def test_safe_function_lookup",
      "22:       t = Thread.new do",
      "23:         h = Fiddle::Handle.new(LIBC_SO)",
      "24:         $SAFE = 1",
      "25:         h[\"qsort\".taint]",
      "26:       end",
      "27:       assert_raise(SecurityError) { t.value }",
      "28:     end",
      "",
      "---------------"
    ],
    "version.h||version.h": [
      "File: version.h -> version.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #define RUBY_VERSION \"2.1.8\"",
      "2: #define RUBY_RELEASE_DATE \"2015-12-16\"",
      "5: #define RUBY_RELEASE_YEAR 2015",
      "6: #define RUBY_RELEASE_MONTH 12",
      "",
      "[Removed Lines]",
      "3: #define RUBY_PATCHLEVEL 438",
      "",
      "[Added Lines]",
      "3: #define RUBY_PATCHLEVEL 439",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9008fda66f28a28074088fb711488ae06ab72eba",
      "candidate_info": {
        "commit_hash": "9008fda66f28a28074088fb711488ae06ab72eba",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/9008fda66f28a28074088fb711488ae06ab72eba",
        "files": [
          "ChangeLog",
          "ext/openssl/ossl_ssl.c",
          "version.h"
        ],
        "message": "merge revision(s) 52227,52228: [Backport #11369]\n\n\t* ext/openssl/ossl_ssl.c (ssl_npn_select_cb): explicitly raise error\n\t  in ext/openssl instead of OpenSSL itself because LibreSSL\n\t  silently truncate the selected protocol name by casting the length\n\t  from int to unsigned char. [Bug #11369]\n\t  Patch by Jeremy Evans <merch-redmine@jeremyevans.net>\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@52356 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/openssl/ossl_ssl.c||ext/openssl/ossl_ssl.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/openssl/ossl_ssl.c||ext/openssl/ossl_ssl.c": [
          "File: ext/openssl/ossl_ssl.c -> ext/openssl/ossl_ssl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "606: }",
          "608: static int",
          "610: {",
          "621:  rb_ary_push(protocols, protocol);",
          "623:     }",
          "625:     selected = rb_funcall(cb, rb_intern(\"call\"), 1, protocols);",
          "626:     StringValue(selected);",
          "630:     return SSL_TLSEXT_ERR_OK;",
          "631: }",
          "632: #endif",
          "",
          "[Removed Lines]",
          "609: ssl_npn_select_cb(SSL *s, unsigned char **out, unsigned char *outlen, const unsigned char *in, unsigned int inlen, void *arg)",
          "611:     int i = 0;",
          "612:     VALUE sslctx_obj, cb, protocols, selected;",
          "614:     sslctx_obj = (VALUE) arg;",
          "615:     cb = rb_iv_get(sslctx_obj, \"@npn_select_cb\");",
          "616:     protocols = rb_ary_new();",
          "619:     while (in[i]) {",
          "620:  VALUE protocol = rb_str_new((const char *) &in[i + 1], in[i]);",
          "622:  i += in[i] + 1;",
          "",
          "[Added Lines]",
          "609: ssl_npn_select_cb_common(VALUE cb, const unsigned char **out, unsigned char *outlen, const unsigned char *in, unsigned int inlen)",
          "611:     VALUE selected;",
          "612:     long len;",
          "613:     unsigned char l;",
          "614:     VALUE protocols = rb_ary_new();",
          "617:     while (l = *in++) {",
          "618:  VALUE protocol;",
          "619:  if (l > inlen) {",
          "620:      ossl_raise(eSSLError, \"Invalid protocol name list\");",
          "621:  }",
          "622:  protocol = rb_str_new((const char *)in, l);",
          "624:  in += l;",
          "625:  inlen -= l;",
          "630:     len = RSTRING_LEN(selected);",
          "631:     if (len < 1 || len >= 256) {",
          "632:  ossl_raise(eSSLError, \"Selected protocol name must have length 1..255\");",
          "633:     }",
          "640: static int",
          "641: ssl_npn_select_cb(SSL *s, unsigned char **out, unsigned char *outlen, const unsigned char *in, unsigned int inlen, void *arg)",
          "642: {",
          "643:     VALUE sslctx_obj, cb;",
          "645:     sslctx_obj = (VALUE) arg;",
          "646:     cb = rb_iv_get(sslctx_obj, \"@npn_select_cb\");",
          "648:     return ssl_npn_select_cb_common(cb, (const unsigned char **)out, outlen, in, inlen);",
          "649: }",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.8\"",
          "2: #define RUBY_RELEASE_DATE \"2015-10-29\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 10",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 407",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 408",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4a4a83c981b1f51f625073fbd63f8dc8a9f53044",
      "candidate_info": {
        "commit_hash": "4a4a83c981b1f51f625073fbd63f8dc8a9f53044",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/4a4a83c981b1f51f625073fbd63f8dc8a9f53044",
        "files": [
          "ChangeLog",
          "lib/rss/rss.rb",
          "test/rss/test_to_s.rb",
          "version.h"
        ],
        "message": "merge revision(s) 51766,51767: [Backport #11509]\n\n\t* lib/rss/rss.rb (Time#w3cdtf): fix zero-trimmed width of fraction\n\t  digits.  [ruby-core:70667] [Bug #11509]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51977 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "lib/rss/rss.rb||lib/rss/rss.rb",
          "test/rss/test_to_s.rb||test/rss/test_to_s.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "lib/rss/rss.rb||lib/rss/rss.rb": [
          "File: lib/rss/rss.rb -> lib/rss/rss.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "53:       if usec.zero?",
          "54:         fraction_digits = 0",
          "55:       else",
          "57:       end",
          "58:       xmlschema(fraction_digits)",
          "59:     end",
          "",
          "[Removed Lines]",
          "56:         fraction_digits = Math.log10(usec.to_s.sub(/0*$/, '').to_i).floor + 1",
          "",
          "[Added Lines]",
          "56:         fraction_digits = strftime('%6N').index(/0*\\z/)",
          "",
          "---------------"
        ],
        "test/rss/test_to_s.rb||test/rss/test_to_s.rb": [
          "File: test/rss/test_to_s.rb -> test/rss/test_to_s.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "102:       assert_textinput20(@textinput_info, rss.textinput)",
          "103:     end",
          "105:     private",
          "106:     def setup_xml_declaration_info",
          "107:       @version = \"1.0\"",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "105:     def test_time_w3cdtf",
          "106:       assert_equal(\"2015-09-05T01:25:48.0001Z\",",
          "107:                    Time.utc(2015, 9, 5, 1, 25, 48, 100).w3cdtf,",
          "108:                    '[ruby-core:70667] [Bug #11509]')",
          "109:     end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.8\"",
          "2: #define RUBY_RELEASE_DATE \"2015-09-29\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 9",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 403",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 404",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "dd4cf6bbeb4ae5dd03d9b6cb3c2a4e73e2ab8b34",
      "candidate_info": {
        "commit_hash": "dd4cf6bbeb4ae5dd03d9b6cb3c2a4e73e2ab8b34",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/dd4cf6bbeb4ae5dd03d9b6cb3c2a4e73e2ab8b34",
        "files": [
          "ChangeLog",
          "ext/tk/extconf.rb",
          "ext/tk/lib/tk.rb",
          "ext/tk/tcltklib.c",
          "version.h"
        ],
        "message": "* ext/tk/extconf.rb: support Tcl/Tk8.6.\n\n* ext/tk/tcltklib.c, ext/tk/lib/tk.rb: get rid of SEGV with Tcl/Tk8.6.\n  [Backport #10401]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@50474 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/tk/extconf.rb||ext/tk/extconf.rb",
          "ext/tk/lib/tk.rb||ext/tk/lib/tk.rb",
          "ext/tk/tcltklib.c||ext/tk/tcltklib.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/tk/extconf.rb||ext/tk/extconf.rb": [
          "File: ext/tk/extconf.rb -> ext/tk/extconf.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "9:   # %w[8.9 8.8 8.7 8.6 8.5 8.4 8.3 8.2 8.1 8.0 7.6 4.2]",
          "10:   # %w[8.7 8.6 8.5 8.4 8.3 8.2 8.1 8.0]",
          "11:   # %w[8.7 8.6 8.5 8.4 8.0] # to shorten search steps",
          "14: TkLib_Config['unsupported_versions'] =",
          "17: TkLib_Config['major_nums'] = '87'",
          "",
          "[Removed Lines]",
          "12:   %w[8.5 8.4] # At present, Tcl/Tk8.6 is not supported.",
          "15:   %w[8.8 8.7 8.6] # At present, Tcl/Tk8.6 is not supported.",
          "",
          "[Added Lines]",
          "12:   %w[8.6 8.5 8.4]",
          "15:   %w[8.8 8.7]",
          "",
          "---------------"
        ],
        "ext/tk/lib/tk.rb||ext/tk/lib/tk.rb": [
          "File: ext/tk/lib/tk.rb -> ext/tk/lib/tk.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1309:           end",
          "1311:           unless interp.deleted?",
          "1314:           end",
          "1316:         ensure",
          "",
          "[Removed Lines]",
          "1312:             #Thread.current[:status].value = TclTkLib.mainloop(false)",
          "1313:             Thread.current[:status].value = interp.mainloop(false)",
          "",
          "[Added Lines]",
          "1312:             begin",
          "1313:               #Thread.current[:status].value = TclTkLib.mainloop(false)",
          "1314:               Thread.current[:status].value = interp.mainloop(false)",
          "1315:             rescue Exception=>e",
          "1316:               puts \"ignore exception on interp: #{e.inspect}\\n\" if $DEBUG",
          "1317:             end",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1569:   EOL",
          "1570: =end",
          "1574:   EventFlag = TclTkLib::EventFlag",
          "",
          "[Removed Lines]",
          "1572:   at_exit{ INTERP.remove_tk_procs(TclTkLib::FINALIZE_PROC_NAME) }",
          "",
          "[Added Lines]",
          "1576:   if !WITH_RUBY_VM || RUN_EVENTLOOP_ON_MAIN_THREAD ### check Ruby 1.9 !!!!!!!",
          "1577:     at_exit{ INTERP.remove_tk_procs(TclTkLib::FINALIZE_PROC_NAME) }",
          "1578:   else",
          "1579:     at_exit{",
          "1580:       Tk.root.destroy",
          "1581:       INTERP.remove_tk_procs(TclTkLib::FINALIZE_PROC_NAME)",
          "1582:       INTERP_THREAD.kill.join",
          "1583:     }",
          "1584:   end",
          "",
          "---------------"
        ],
        "ext/tk/tcltklib.c||ext/tk/tcltklib.c": [
          "File: ext/tk/tcltklib.c -> ext/tk/tcltklib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6012:     Tcl_CmdInfo info;",
          "6013:     int ret;",
          "6015:     if (!Tcl_GetCommandInfo(interp, \"__orig_namespace_command__\", &(info))) {",
          "6016:         Tcl_ResetResult(interp);",
          "6017:         Tcl_AppendResult(interp,",
          "6018:                          \"invalid command name \\\"namespace\\\"\", (char*)NULL);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6015:     DUMP1(\"call ip_rbNamespaceObjCmd\");",
          "6016:     DUMP2(\"objc = %d\", objc);",
          "6017:     DUMP2(\"objv[0] = '%s'\", Tcl_GetString(objv[0]));",
          "6018:     DUMP2(\"objv[1] = '%s'\", Tcl_GetString(objv[1]));",
          "6020:         DUMP1(\"fail to get __orig_namespace_command__\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "6020:     }",
          "6022:     rbtk_eventloop_depth++;",
          "6025:     if (info.isNativeObjectProc) {",
          "6026:         ret = (*(info.objProc))(info.objClientData, interp, objc, objv);",
          "6027:     } else {",
          "6029:         int i;",
          "6030:         char **argv;",
          "6033:         argv = RbTk_ALLOC_N(char *, (objc + 1));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6028:     DUMP2(\"namespace wrapper enter depth == %d\", rbtk_eventloop_depth);",
          "6031: #if TCL_MAJOR_VERSION == 8 && TCL_MINOR_VERSION < 6",
          "6032:         DUMP1(\"call a native-object-proc\");",
          "6034: #else",
          "6036:         int i;",
          "6037:         Tcl_Obj **cp_objv;",
          "6038:         char org_ns_cmd_name[] = \"__orig_namespace_command__\";",
          "6040:         DUMP1(\"call a native-object-proc for tcl8.6 or later\");",
          "6041:         cp_objv = RbTk_ALLOC_N(Tcl_Obj *, (objc + 1));",
          "6043:         cp_objv[0] = Tcl_NewStringObj(org_ns_cmd_name, strlen(org_ns_cmd_name));",
          "6044:         for(i = 1; i < objc; i++) {",
          "6045:             cp_objv[i] = objv[i];",
          "6046:         }",
          "6047:         cp_objv[objc] = (Tcl_Obj *)NULL;",
          "6050:         ret = Tcl_EvalObjv(interp, objc, cp_objv, 0);",
          "6052:         ckfree((char*)cp_objv);",
          "6053: #endif",
          "6059:         DUMP1(\"call with the string-interface\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "6056: #endif",
          "6057:     }",
          "6060:     rbtk_eventloop_depth--;",
          "6062:     return ret;",
          "6063: }",
          "6064: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6087:     DUMP2(\"namespace wrapper exit depth == %d\", rbtk_eventloop_depth);",
          "6090:     DUMP1(\"end of ip_rbNamespaceObjCmd\");",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "6068:     Tcl_Interp *interp;",
          "6069: {",
          "6070: #if TCL_MAJOR_VERSION >= 8",
          "6071:     Tcl_CmdInfo orig_info;",
          "6073:     if (!Tcl_GetCommandInfo(interp, \"namespace\", &(orig_info))) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6101: #if TCL_MAJOR_VERSION == 8 && TCL_MINOR_VERSION < 6",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "6084:                           orig_info.deleteProc);",
          "6085:     }",
          "6087:     Tcl_CreateObjCommand(interp, \"namespace\", ip_rbNamespaceObjCmd,",
          "6088:                          (ClientData) 0, (Tcl_CmdDeleteProc *)NULL);",
          "6089: #endif",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6119:     Tcl_GlobalEval(interp, \"rename namespace __orig_namespace_command__\");",
          "6121: #endif",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "8448: #endif",
          "8449: {",
          "8450:     struct invoke_info *inf = (struct invoke_info *)arg;",
          "8451:     int i, len;",
          "8453:     int argc = inf->objc;",
          "8454:     char **argv = (char **)NULL;",
          "8455: #endif",
          "8459:     if (!inf->cmdinfo.isNativeObjectProc) {",
          "8462:         argv = RbTk_ALLOC_N(char *, (argc+1));",
          "",
          "[Removed Lines]",
          "8452: #if TCL_MAJOR_VERSION >= 8",
          "8458: #if TCL_MAJOR_VERSION >= 8",
          "",
          "[Added Lines]",
          "8488: #if TCL_MAJOR_VERSION >= 8 && TCL_MINOR_VERSION < 6",
          "8494:     DUMP1(\"call invoke_tcl_proc\");",
          "8496: #if TCL_MAJOR_VERSION > 8 || (TCL_MAJOR_VERSION == 8 && TCL_MINOR_VERSION >= 6)",
          "8499:     inf->ptr->return_value = Tcl_EvalObjv(inf->ptr->ip, inf->objc, inf->objv, TCL_EVAL_DIRECT);",
          "8505: #if TCL_MAJOR_VERSION == 8",
          "8508:         DUMP1(\"called proc is not a native-obj-proc\");",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "8470:     }",
          "8471: #endif",
          "8473:     Tcl_ResetResult(inf->ptr->ip);",
          "8477:     if (inf->cmdinfo.isNativeObjectProc) {",
          "8478:         inf->ptr->return_value",
          "8479:             = (*(inf->cmdinfo.objProc))(inf->cmdinfo.objClientData,",
          "8480:                                         inf->ptr->ip, inf->objc, inf->objv);",
          "",
          "[Removed Lines]",
          "8476: #if TCL_MAJOR_VERSION >= 8",
          "",
          "[Added Lines]",
          "8522:     DUMP1(\"reset result of tcl-interp\");",
          "8526: #if TCL_MAJOR_VERSION == 8",
          "8529:         DUMP1(\"call tcl_proc as a native-obj-proc\");",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "8482:     else",
          "8483: #endif",
          "8484:     {",
          "8486:         inf->ptr->return_value",
          "8487:             = (*(inf->cmdinfo.proc))(inf->cmdinfo.clientData, inf->ptr->ip,",
          "8488:                                      argc, (CONST84 char **)argv);",
          "",
          "[Removed Lines]",
          "8485: #if TCL_MAJOR_VERSION >= 8",
          "",
          "[Added Lines]",
          "8537: #if TCL_MAJOR_VERSION == 8",
          "8539:         DUMP1(\"call tcl_proc as not a native-obj-proc\");",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "8505: #endif",
          "8506:     }",
          "8508:     return Qnil;",
          "8509: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8564:     DUMP1(\"end of invoke_tcl_proc\");",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "8644: #endif",
          "8647:     rb_protect(invoke_tcl_proc, (VALUE)&inf, &status);",
          "8648:     switch(status) {",
          "8649:     case TAG_RAISE:",
          "8650:         if (NIL_P(rb_errinfo())) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8704:     DUMP1(\"invoke tcl-proc\");",
          "8706:     DUMP2(\"status of tcl-proc, %d\", status);",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 5",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-05-11\"",
          "3: #define RUBY_PATCHLEVEL 342",
          "7: #define RUBY_RELEASE_DAY 11",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-05-12\"",
          "3: #define RUBY_PATCHLEVEL 343",
          "7: #define RUBY_RELEASE_DAY 12",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e358e2f89964ed1950d64d040218cd80add26b72",
      "candidate_info": {
        "commit_hash": "e358e2f89964ed1950d64d040218cd80add26b72",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/e358e2f89964ed1950d64d040218cd80add26b72",
        "files": [
          "ChangeLog",
          "ext/socket/raddrinfo.c",
          "test/socket/test_addrinfo.rb",
          "version.h"
        ],
        "message": "merge revision(s) 50187,50202: [Backport #11051]\n\n\t* ext/socket/raddrinfo.c (addrinfo_mload): fix memory leak of\n\t  addrinfo.  [ruby-dev:48923] [Bug #11051]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@50575 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/socket/raddrinfo.c||ext/socket/raddrinfo.c",
          "test/socket/test_addrinfo.rb||test/socket/test_addrinfo.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/socket/raddrinfo.c||ext/socket/raddrinfo.c": [
          "File: ext/socket/raddrinfo.c -> ext/socket/raddrinfo.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1645:         len = res->ai->ai_addrlen;",
          "1646:         memcpy(&ss, res->ai->ai_addr, res->ai->ai_addrlen);",
          "1647:         break;",
          "1648:       }",
          "1649:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1647:         rb_freeaddrinfo(res);",
          "",
          "---------------"
        ],
        "test/socket/test_addrinfo.rb||test/socket/test_addrinfo.rb": [
          "File: test/socket/test_addrinfo.rb -> test/socket/test_addrinfo.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "4: end",
          "6: require \"test/unit\"",
          "8: class TestSocketAddrinfo < Test::Unit::TestCase",
          "9:   HAS_UNIXSOCKET = defined?(UNIXSocket) && /cygwin/ !~ RUBY_PLATFORM",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "7: require_relative \"../ruby/envutil\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "468:     assert_equal(ai1.canonname, ai2.canonname)",
          "469:   end",
          "471:   if Socket.const_defined?(\"AF_INET6\") && Socket::AF_INET6.is_a?(Integer)",
          "473:     def test_addrinfo_new_inet6",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "472:   def test_marshal_memory_leak",
          "473:     bug11051 = '[ruby-dev:48923] [Bug #11051]'",
          "474:     assert_no_memory_leak(%w[-rsocket], <<-PREP, <<-CODE, bug11051, rss: true)",
          "475:     d = Marshal.dump(Addrinfo.tcp(\"127.0.0.1\", 80))",
          "476:     1000.times {Marshal.load(d)}",
          "477:     PREP",
          "478:     GC.start",
          "479:     20_000.times {Marshal.load(d)}",
          "480:     CODE",
          "481:   end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "2: #define RUBY_RELEASE_DATE \"2015-05-21\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 5",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 348",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 349",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "61f3baeef9003de4651419fa27ee97c18c8ce170",
      "candidate_info": {
        "commit_hash": "61f3baeef9003de4651419fa27ee97c18c8ce170",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/61f3baeef9003de4651419fa27ee97c18c8ce170",
        "files": [
          "ChangeLog",
          "ext/objspace/objspace_dump.c",
          "test/objspace/test_objspace.rb",
          "version.h"
        ],
        "message": "merge revision(s) 50982,50983: [Backport #11291]\n\n\t* ext/objspace/objspace_dump.c(dump_object): Return empty JSON object when\n\t  passed object is a special const, instead of SEGV.\n\t  Based patch by Kohei Suzuki (eagletmt). [ruby-core:69692] [Bug #11291]\n\n\t* test/objspace/test_objspace.rb(test_dump_special_consts): Test for above fix.\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@51059 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/objspace/objspace_dump.c||ext/objspace/objspace_dump.c",
          "test/objspace/test_objspace.rb||test/objspace/test_objspace.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/objspace/objspace_dump.c||ext/objspace/objspace_dump.c": [
          "File: ext/objspace/objspace_dump.c -> ext/objspace/objspace_dump.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "152:     ID flags[RB_OBJ_GC_FLAGS_MAX];",
          "153:     size_t n, i;",
          "155:     dc->cur_obj = obj;",
          "156:     dc->cur_obj_references = 0;",
          "157:     dc->cur_obj_klass = BUILTIN_TYPE(obj) == T_NODE ? 0 : RBASIC_CLASS(obj);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "155:     if (SPECIAL_CONST_P(obj)) {",
          "156:  dump_append(dc, \"{}\");",
          "157:  return;",
          "158:     }",
          "",
          "---------------"
        ],
        "test/objspace/test_objspace.rb||test/objspace/test_objspace.rb": [
          "File: test/objspace/test_objspace.rb -> test/objspace/test_objspace.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "234:     assert_match /\"method\":\"#{loc.base_label}\"/, info",
          "235:   end",
          "237:   def test_dump_all",
          "238:     entry = /\"bytesize\":11, \"value\":\"TEST STRING\", \"encoding\":\"UTF-8\", \"file\":\"-\", \"line\":4, \"method\":\"dump_my_heap_please\", \"generation\":/",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "237:   def test_dump_special_consts",
          "238:     # [ruby-core:69692] [Bug #11291]",
          "239:     assert_equal('{}', ObjectSpace.dump(nil))",
          "240:     assert_equal('{}', ObjectSpace.dump(true))",
          "241:     assert_equal('{}', ObjectSpace.dump(false))",
          "242:     assert_equal('{}', ObjectSpace.dump(0))",
          "243:     assert_equal('{}', ObjectSpace.dump(:foo))",
          "244:   end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.7\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 6",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-06-17\"",
          "3: #define RUBY_PATCHLEVEL 367",
          "7: #define RUBY_RELEASE_DAY 17",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-06-29\"",
          "3: #define RUBY_PATCHLEVEL 368",
          "7: #define RUBY_RELEASE_DAY 29",
          "",
          "---------------"
        ]
      }
    }
  ]
}