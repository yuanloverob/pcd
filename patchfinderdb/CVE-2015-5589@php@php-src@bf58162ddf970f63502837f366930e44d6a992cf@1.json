{
  "cve_id": "CVE-2015-5589",
  "cve_desc": "The phar_convert_to_other function in ext/phar/phar_object.c in PHP before 5.4.43, 5.5.x before 5.5.27, and 5.6.x before 5.6.11 does not validate a file pointer before a close operation, which allows remote attackers to cause a denial of service (segmentation fault) or possibly have unspecified other impact via a crafted TAR archive that is mishandled in a Phar::convertToData call.",
  "repo": "php/php-src",
  "patch_hash": "bf58162ddf970f63502837f366930e44d6a992cf",
  "patch_info": {
    "commit_hash": "bf58162ddf970f63502837f366930e44d6a992cf",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/bf58162ddf970f63502837f366930e44d6a992cf",
    "files": [
      "ext/phar/phar_object.c",
      "ext/phar/tests/bug69958.phpt",
      "ext/phar/tests/bug69958.tar"
    ],
    "message": "Fix bug #69958 - Segfault in Phar::convertToData on invalid file",
    "before_after_code_files": [
      "ext/phar/phar_object.c||ext/phar/phar_object.c",
      "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
    ]
  },
  "patch_diff": {
    "ext/phar/phar_object.c||ext/phar/phar_object.c": [
      "File: ext/phar/phar_object.c -> ext/phar/phar_object.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1269:  INIT_PZVAL(&arg2);",
      "1270:  ZVAL_LONG(&arg2, flags);",
      "1273:   &spl_ce_RecursiveDirectoryIterator->constructor, \"__construct\", NULL, &arg1, &arg2);",
      "1275:  if (!phar_data->is_persistent) {",
      "",
      "[Removed Lines]",
      "1272:  zend_call_method_with_2_params(&zobj, Z_OBJCE_P(zobj),",
      "",
      "[Added Lines]",
      "1272:  zend_call_method_with_2_params(&zobj, Z_OBJCE_P(zobj),",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1845:  ZVAL_LONG(&arg2, SPL_FILE_DIR_SKIPDOTS|SPL_FILE_DIR_UNIXPATHS);",
      "1846: #endif",
      "1849:    &spl_ce_RecursiveDirectoryIterator->constructor, \"__construct\", NULL, &arg, &arg2);",
      "1851:  if (EG(exception)) {",
      "",
      "[Removed Lines]",
      "1848:  zend_call_method_with_2_params(&iter, spl_ce_RecursiveDirectoryIterator,",
      "",
      "[Added Lines]",
      "1848:  zend_call_method_with_2_params(&iter, spl_ce_RecursiveDirectoryIterator,",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1862:   RETURN_FALSE;",
      "1863:  }",
      "1866:    &spl_ce_RecursiveIteratorIterator->constructor, \"__construct\", NULL, iter);",
      "1868:  if (EG(exception)) {",
      "",
      "[Removed Lines]",
      "1865:  zend_call_method_with_1_params(&iteriter, spl_ce_RecursiveIteratorIterator,",
      "",
      "[Added Lines]",
      "1865:  zend_call_method_with_1_params(&iteriter, spl_ce_RecursiveIteratorIterator,",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "1887:   INIT_PZVAL(&arg2);",
      "1888:   ZVAL_STRINGL(&arg2, regex, regex_len, 0);",
      "1891:    &spl_ce_RegexIterator->constructor, \"__construct\", NULL, iteriter, &arg2);",
      "1892:  }",
      "",
      "[Removed Lines]",
      "1890:   zend_call_method_with_2_params(&regexiter, spl_ce_RegexIterator,",
      "",
      "[Added Lines]",
      "1890:   zend_call_method_with_2_params(&regexiter, spl_ce_RegexIterator,",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2419:   zend_hash_destroy(&(phar->manifest));",
      "2420:   zend_hash_destroy(&(phar->mounted_dirs));",
      "2421:   zend_hash_destroy(&(phar->virtual_dirs));",
      "2423:   efree(phar->fname);",
      "2424:   efree(phar);",
      "2425:   return NULL;",
      "",
      "[Removed Lines]",
      "2422:   php_stream_close(phar->fp);",
      "",
      "[Added Lines]",
      "2422:   if (phar->fp) {",
      "2423:    php_stream_close(phar->fp);",
      "2424:   }",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "4544:  INIT_PZVAL(&arg1);",
      "4545:  ZVAL_STRINGL(&arg1, fname, fname_len, 0);",
      "4548:   &spl_ce_SplFileInfo->constructor, \"__construct\", NULL, &arg1);",
      "4549: }",
      "",
      "[Removed Lines]",
      "4547:  zend_call_method_with_1_params(&zobj, Z_OBJCE_P(zobj),",
      "",
      "[Added Lines]",
      "4549:  zend_call_method_with_1_params(&zobj, Z_OBJCE_P(zobj),",
      "",
      "---------------"
    ],
    "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt": [
      "File: ext/phar/tests/bug69958.phpt -> ext/phar/tests/bug69958.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Phar: bug #69958: Segfault in Phar::convertToData on invalid file",
      "3: --SKIPIF--",
      "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
      "5: --FILE--",
      "6: <?php",
      "7: $tarphar = new PharData(__DIR__.'/bug69958.tar');",
      "8: $phar = $tarphar->convertToData(Phar::TAR);",
      "9: --EXPECTF--",
      "10: Fatal error: Uncaught exception 'BadMethodCallException' with message 'phar \"%s/bug69958.tar\" exists and must be unlinked prior to conversion' in %s/bug69958.php:%d",
      "11: Stack trace:",
      "12: #0 %s/bug69958.php(%d): PharData->convertToData(%d)",
      "13: #1 {main}",
      "14:   thrown in %s/bug69958.php on line %d",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "eda31f57fbda9e18080b368921d190d836abe3d6",
      "candidate_info": {
        "commit_hash": "eda31f57fbda9e18080b368921d190d836abe3d6",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/eda31f57fbda9e18080b368921d190d836abe3d6",
        "files": [
          "ext/phar/phar_object.c",
          "ext/phar/tests/bug69958.phpt"
        ],
        "message": "Better fix for bug #69958",
        "before_after_code_files": [
          "ext/phar/phar_object.c||ext/phar/phar_object.c",
          "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/phar_object.c||ext/phar/phar_object.c",
            "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
          ],
          "candidate": [
            "ext/phar/phar_object.c||ext/phar/phar_object.c",
            "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/phar_object.c||ext/phar/phar_object.c": [
          "File: ext/phar/phar_object.c -> ext/phar/phar_object.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2089: }",
          "2093: {",
          "2094:  const char *oldname = NULL;",
          "2095:  char *oldpath = NULL;",
          "2096:  char *basename = NULL, *basepath = NULL;",
          "2097:  char *newname = NULL, *newpath = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2095:  phar_archive_data *phar = *sphar;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2413:   phar_add_virtual_dirs(phar, newentry.filename, newentry.filename_len TSRMLS_CC);",
          "2414:  }",
          "2417:   return ret;",
          "2418:  } else {",
          "2424:   }",
          "2427:   return NULL;",
          "2428:  }",
          "2429: }",
          "",
          "[Removed Lines]",
          "2416:  if ((ret = phar_rename_archive(phar, ext, 0 TSRMLS_CC))) {",
          "2419:   zend_hash_destroy(&(phar->manifest));",
          "2420:   zend_hash_destroy(&(phar->mounted_dirs));",
          "2421:   zend_hash_destroy(&(phar->virtual_dirs));",
          "2422:   if (phar->fp) {",
          "2423:    php_stream_close(phar->fp);",
          "2425:   efree(phar->fname);",
          "2426:   efree(phar);",
          "",
          "[Added Lines]",
          "2418:  if ((ret = phar_rename_archive(&phar, ext, 0 TSRMLS_CC))) {",
          "2421:   if(phar != NULL) {",
          "2422:    zend_hash_destroy(&(phar->manifest));",
          "2423:    zend_hash_destroy(&(phar->mounted_dirs));",
          "2424:    zend_hash_destroy(&(phar->virtual_dirs));",
          "2425:    if (phar->fp) {",
          "2426:     php_stream_close(phar->fp);",
          "2427:    }",
          "2428:    efree(phar->fname);",
          "2429:    efree(phar);",
          "",
          "---------------"
        ],
        "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt": [
          "File: ext/phar/tests/bug69958.phpt -> ext/phar/tests/bug69958.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "2: Phar: bug #69958: Segfault in Phar::convertToData on invalid file",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
          "5: --FILE--",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: --XFAIL--",
          "4: Still has memory leaks, see https://bugs.php.net/bug.php?id=70005",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "885edfef0a0eb1016a906d197399f92375a795e4",
      "candidate_info": {
        "commit_hash": "885edfef0a0eb1016a906d197399f92375a795e4",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/885edfef0a0eb1016a906d197399f92375a795e4",
        "files": [
          "ext/phar/phar_object.c",
          "ext/phar/tests/bug69958.phpt"
        ],
        "message": "Better fix for bug #69958",
        "before_after_code_files": [
          "ext/phar/phar_object.c||ext/phar/phar_object.c",
          "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/phar/phar_object.c||ext/phar/phar_object.c",
            "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
          ],
          "candidate": [
            "ext/phar/phar_object.c||ext/phar/phar_object.c",
            "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/phar/phar_object.c||ext/phar/phar_object.c": [
          "File: ext/phar/phar_object.c -> ext/phar/phar_object.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2089: }",
          "2093: {",
          "2094:  const char *oldname = NULL;",
          "2095:  char *oldpath = NULL;",
          "2096:  char *basename = NULL, *basepath = NULL;",
          "2097:  char *newname = NULL, *newpath = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2095:  phar_archive_data *phar = *sphar;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2413:   phar_add_virtual_dirs(phar, newentry.filename, newentry.filename_len TSRMLS_CC);",
          "2414:  }",
          "2417:   return ret;",
          "2418:  } else {",
          "2424:   }",
          "2427:   return NULL;",
          "2428:  }",
          "2429: }",
          "",
          "[Removed Lines]",
          "2416:  if ((ret = phar_rename_archive(phar, ext, 0 TSRMLS_CC))) {",
          "2419:   zend_hash_destroy(&(phar->manifest));",
          "2420:   zend_hash_destroy(&(phar->mounted_dirs));",
          "2421:   zend_hash_destroy(&(phar->virtual_dirs));",
          "2422:   if (phar->fp) {",
          "2423:    php_stream_close(phar->fp);",
          "2425:   efree(phar->fname);",
          "2426:   efree(phar);",
          "",
          "[Added Lines]",
          "2418:  if ((ret = phar_rename_archive(&phar, ext, 0 TSRMLS_CC))) {",
          "2421:   if(phar != NULL) {",
          "2422:    zend_hash_destroy(&(phar->manifest));",
          "2423:    zend_hash_destroy(&(phar->mounted_dirs));",
          "2424:    zend_hash_destroy(&(phar->virtual_dirs));",
          "2425:    if (phar->fp) {",
          "2426:     php_stream_close(phar->fp);",
          "2427:    }",
          "2428:    efree(phar->fname);",
          "2429:    efree(phar);",
          "",
          "---------------"
        ],
        "ext/phar/tests/bug69958.phpt||ext/phar/tests/bug69958.phpt": [
          "File: ext/phar/tests/bug69958.phpt -> ext/phar/tests/bug69958.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: --TEST--",
          "2: Phar: bug #69958: Segfault in Phar::convertToData on invalid file",
          "3: --SKIPIF--",
          "4: <?php if (!extension_loaded(\"phar\")) die(\"skip\"); ?>",
          "5: --FILE--",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: --XFAIL--",
          "4: Still has memory leaks, see https://bugs.php.net/bug.php?id=70005",
          "",
          "---------------"
        ]
      }
    }
  ]
}