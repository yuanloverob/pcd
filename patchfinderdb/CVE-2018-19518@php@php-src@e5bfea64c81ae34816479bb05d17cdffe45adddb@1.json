{
  "cve_id": "CVE-2018-19518",
  "cve_desc": "University of Washington IMAP Toolkit 2007f on UNIX, as used in imap_open() in PHP and other products, launches an rsh command (by means of the imap_rimap function in c-client/imap4r1.c and the tcp_aopen function in osdep/unix/tcp_unix.c) without preventing argument injection, which might allow remote attackers to execute arbitrary OS commands if the IMAP server name is untrusted input (e.g., entered by a user of a web application) and if rsh has been replaced by a program with different argument semantics. For example, if rsh is a link to ssh (as seen on Debian and Ubuntu systems), then the attack can use an IMAP server name containing a \"-oProxyCommand\" argument.",
  "repo": "php/php-src",
  "patch_hash": "e5bfea64c81ae34816479bb05d17cdffe45adddb",
  "patch_info": {
    "commit_hash": "e5bfea64c81ae34816479bb05d17cdffe45adddb",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/e5bfea64c81ae34816479bb05d17cdffe45adddb",
    "files": [
      "NEWS",
      "UPGRADING",
      "ext/imap/php_imap.c",
      "ext/imap/php_imap.h",
      "ext/imap/tests/bug77153.phpt"
    ],
    "message": "Disable rsh/ssh functionality in imap by default (bug #77153)",
    "before_after_code_files": [
      "ext/imap/php_imap.c||ext/imap/php_imap.c",
      "ext/imap/php_imap.h||ext/imap/php_imap.h",
      "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
    ]
  },
  "patch_diff": {
    "ext/imap/php_imap.c||ext/imap/php_imap.c": [
      "File: ext/imap/php_imap.c -> ext/imap/php_imap.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "562: };",
      "567: zend_module_entry imap_module_entry = {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "568: PHP_INI_BEGIN()",
      "569: STD_PHP_INI_BOOLEAN(\"imap.enable_insecure_rsh\", \"0\", PHP_INI_SYSTEM, OnUpdateBool, enable_rsh, zend_imap_globals, imap_globals)",
      "570: PHP_INI_END()",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "835: {",
      "836:  unsigned long sa_all = SA_MESSAGES | SA_RECENT | SA_UNSEEN | SA_UIDNEXT | SA_UIDVALIDITY;",
      "838: #ifndef PHP_WIN32",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "847:  REGISTER_INI_ENTRIES();",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1052:  GC_TEXTS               texts",
      "1055:  le_imap = zend_register_list_destructors_ex(mail_close_it, NULL, \"imap\", module_number);",
      "1056:  return SUCCESS;",
      "1057: }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1066:  if (!IMAPG(enable_rsh)) {",
      "1068:   mail_parameters (NIL, SET_RSHTIMEOUT, 0);",
      "1069:   mail_parameters (NIL, SET_SSHTIMEOUT, 0);",
      "1070:  }",
      "",
      "---------------"
    ],
    "ext/imap/php_imap.h||ext/imap/php_imap.h": [
      "File: ext/imap/php_imap.h -> ext/imap/php_imap.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "214: #endif",
      "216:  php_stream *gets_stream;",
      "217: ZEND_END_MODULE_GLOBALS(imap)",
      "219: #ifdef ZTS",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "217:  zend_bool enable_rsh;",
      "",
      "---------------"
    ],
    "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt": [
      "File: ext/imap/tests/bug77153.phpt -> ext/imap/tests/bug77153.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #77153 (imap_open allows to run arbitrary shell commands via mailbox parameter)",
      "3: --SKIPIF--",
      "4: <?php",
      "5:         if (!extension_loaded(\"imap\")) {",
      "6:                 die(\"skip imap extension not available\");",
      "7:         }",
      "8: ?>",
      "9: --FILE--",
      "10: <?php",
      "11: $payload = \"echo 'BUG'> \" . __DIR__ . '/__bug';",
      "12: $payloadb64 = base64_encode($payload);",
      "13: $server = \"x -oProxyCommand=echo\\t$payloadb64|base64\\t-d|sh}\";",
      "14: @imap_open('{'.$server.':143/imap}INBOX', '', '');",
      "16: imap_errors();",
      "17: var_dump(file_exists(__DIR__ . '/__bug'));",
      "18: ?>",
      "19: --EXPECT--",
      "20: bool(false)",
      "21: --CLEAN--",
      "22: <?php",
      "23: if(file_exists(__DIR__ . '/__bug')) unlink(__DIR__ . '/__bug');",
      "24: ?>",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "752f0e6e2bdd8d1aa474818065040e44ee0cddf9",
      "candidate_info": {
        "commit_hash": "752f0e6e2bdd8d1aa474818065040e44ee0cddf9",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/752f0e6e2bdd8d1aa474818065040e44ee0cddf9",
        "files": [
          "NEWS",
          "UPGRADING",
          "ext/imap/php_imap.c",
          "ext/imap/php_imap.h",
          "ext/imap/tests/bug77153.phpt"
        ],
        "message": "Disable rsh/ssh functionality in imap by default (bug #77153)",
        "before_after_code_files": [
          "ext/imap/php_imap.c||ext/imap/php_imap.c",
          "ext/imap/php_imap.h||ext/imap/php_imap.h",
          "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/imap/php_imap.c||ext/imap/php_imap.c",
            "ext/imap/php_imap.h||ext/imap/php_imap.h",
            "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
          ],
          "candidate": [
            "ext/imap/php_imap.c||ext/imap/php_imap.c",
            "ext/imap/php_imap.h||ext/imap/php_imap.h",
            "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/imap/php_imap.c||ext/imap/php_imap.c": [
          "File: ext/imap/php_imap.c -> ext/imap/php_imap.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "562: };",
          "567: zend_module_entry imap_module_entry = {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "568: PHP_INI_BEGIN()",
          "569: STD_PHP_INI_BOOLEAN(\"imap.enable_insecure_rsh\", \"0\", PHP_INI_SYSTEM, OnUpdateBool, enable_rsh, zend_imap_globals, imap_globals)",
          "570: PHP_INI_END()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "832: {",
          "833:  unsigned long sa_all = SA_MESSAGES | SA_RECENT | SA_UNSEEN | SA_UIDNEXT | SA_UIDVALIDITY;",
          "835: #ifndef PHP_WIN32",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "844:  REGISTER_INI_ENTRIES();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1049:  GC_TEXTS               texts",
          "1052:  le_imap = zend_register_list_destructors_ex(mail_close_it, NULL, \"imap\", module_number);",
          "1053:  return SUCCESS;",
          "1054: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1063:  if (!IMAPG(enable_rsh)) {",
          "1065:   mail_parameters (NIL, SET_RSHTIMEOUT, 0);",
          "1066:   mail_parameters (NIL, SET_SSHTIMEOUT, 0);",
          "1067:  }",
          "",
          "---------------"
        ],
        "ext/imap/php_imap.h||ext/imap/php_imap.h": [
          "File: ext/imap/php_imap.h -> ext/imap/php_imap.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "231: #endif",
          "233:  php_stream *gets_stream;",
          "234: ZEND_END_MODULE_GLOBALS(imap)",
          "236: #ifdef ZTS",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "234:  zend_bool enable_rsh;",
          "",
          "---------------"
        ],
        "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt": [
          "File: ext/imap/tests/bug77153.phpt -> ext/imap/tests/bug77153.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #77153 (imap_open allows to run arbitrary shell commands via mailbox parameter)",
          "3: --SKIPIF--",
          "4: <?php",
          "5:         if (!extension_loaded(\"imap\")) {",
          "6:                 die(\"skip imap extension not available\");",
          "7:         }",
          "8: ?>",
          "9: --FILE--",
          "10: <?php",
          "11: $payload = \"echo 'BUG'> \" . __DIR__ . '/__bug';",
          "12: $payloadb64 = base64_encode($payload);",
          "13: $server = \"x -oProxyCommand=echo\\t$payloadb64|base64\\t-d|sh}\";",
          "14: @imap_open('{'.$server.':143/imap}INBOX', '', '');",
          "16: imap_errors();",
          "17: var_dump(file_exists(__DIR__ . '/__bug'));",
          "18: ?>",
          "19: --EXPECT--",
          "20: bool(false)",
          "21: --CLEAN--",
          "22: <?php",
          "23: if(file_exists(__DIR__ . '/__bug')) unlink(__DIR__ . '/__bug');",
          "24: ?>",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3a144d3f7f6bad308e2bf112ebf16829eb298f20",
      "candidate_info": {
        "commit_hash": "3a144d3f7f6bad308e2bf112ebf16829eb298f20",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/3a144d3f7f6bad308e2bf112ebf16829eb298f20",
        "files": [
          "ext/imap/php_imap.c",
          "ext/imap/php_imap.h",
          "ext/imap/tests/bug77153.phpt"
        ],
        "message": "Disable rsh/ssh functionality in imap by default (bug #77153)\n\n(cherry picked from commit 05782f01f5d179187798551e901d06d2c621bdae)\n(cherry picked from commit 3f165e8ca3dd8914e50dfebdd48a75a4027f0058)",
        "before_after_code_files": [
          "ext/imap/php_imap.c||ext/imap/php_imap.c",
          "ext/imap/php_imap.h||ext/imap/php_imap.h",
          "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "ext/imap/php_imap.c||ext/imap/php_imap.c",
            "ext/imap/php_imap.h||ext/imap/php_imap.h",
            "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
          ],
          "candidate": [
            "ext/imap/php_imap.c||ext/imap/php_imap.c",
            "ext/imap/php_imap.h||ext/imap/php_imap.h",
            "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/imap/php_imap.c||ext/imap/php_imap.c": [
          "File: ext/imap/php_imap.c -> ext/imap/php_imap.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "561: };",
          "566: zend_module_entry imap_module_entry = {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "567: PHP_INI_BEGIN()",
          "568: STD_PHP_INI_BOOLEAN(\"imap.enable_insecure_rsh\", \"0\", PHP_INI_SYSTEM, OnUpdateBool, enable_rsh, zend_imap_globals, imap_globals)",
          "569: PHP_INI_END()",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "831: {",
          "832:  unsigned long sa_all = SA_MESSAGES | SA_RECENT | SA_UNSEEN | SA_UIDNEXT | SA_UIDVALIDITY;",
          "834: #ifndef PHP_WIN32",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "843:  REGISTER_INI_ENTRIES();",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1048:  GC_TEXTS               texts",
          "1051:  le_imap = zend_register_list_destructors_ex(mail_close_it, NULL, \"imap\", module_number);",
          "1052:  return SUCCESS;",
          "1053: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1062:  if (!IMAPG(enable_rsh)) {",
          "1064:   mail_parameters (NIL, SET_RSHTIMEOUT, 0);",
          "1065:   mail_parameters (NIL, SET_SSHTIMEOUT, 0);",
          "1066:  }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1135:  php_info_print_table_row(2, \"Kerberos Support\", \"enabled\");",
          "1136: #endif",
          "1137:  php_info_print_table_end();",
          "1138: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1156:  DISPLAY_INI_ENTRIES();",
          "",
          "---------------"
        ],
        "ext/imap/php_imap.h||ext/imap/php_imap.h": [
          "File: ext/imap/php_imap.h -> ext/imap/php_imap.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "229: #endif",
          "231:  php_stream *gets_stream;",
          "232: ZEND_END_MODULE_GLOBALS(imap)",
          "234: #ifdef ZTS",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "232:  zend_bool enable_rsh;",
          "",
          "---------------"
        ],
        "ext/imap/tests/bug77153.phpt||ext/imap/tests/bug77153.phpt": [
          "File: ext/imap/tests/bug77153.phpt -> ext/imap/tests/bug77153.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #77153 (imap_open allows to run arbitrary shell commands via mailbox parameter)",
          "3: --SKIPIF--",
          "4: <?php",
          "5:         if (!extension_loaded(\"imap\")) {",
          "6:                 die(\"skip imap extension not available\");",
          "7:         }",
          "8: ?>",
          "9: --FILE--",
          "10: <?php",
          "11: $payload = \"echo 'BUG'> \" . __DIR__ . '/__bug';",
          "12: $payloadb64 = base64_encode($payload);",
          "13: $server = \"x -oProxyCommand=echo\\t$payloadb64|base64\\t-d|sh}\";",
          "14: @imap_open('{'.$server.':143/imap}INBOX', '', '');",
          "16: imap_errors();",
          "17: var_dump(file_exists(__DIR__ . '/__bug'));",
          "18: ?>",
          "19: --EXPECT--",
          "20: bool(false)",
          "21: --CLEAN--",
          "22: <?php",
          "23: if(file_exists(__DIR__ . '/__bug')) unlink(__DIR__ . '/__bug');",
          "24: ?>",
          "",
          "---------------"
        ]
      }
    }
  ]
}