{
  "cve_id": "CVE-2016-2153",
  "cve_desc": "Cross-site scripting (XSS) vulnerability in the advanced-search feature in mod_data in Moodle through 2.6.11, 2.7.x before 2.7.13, 2.8.x before 2.8.11, 2.9.x before 2.9.5, and 3.0.x before 3.0.3 allows remote attackers to inject arbitrary web script or HTML via a crafted field in a URL, as demonstrated by a search form field.",
  "repo": "moodle/moodle",
  "patch_hash": "a5fae3b0d21cc85a7ea2d2c2af8c7fc9acf2fd92",
  "patch_info": {
    "commit_hash": "a5fae3b0d21cc85a7ea2d2c2af8c7fc9acf2fd92",
    "repo": "moodle/moodle",
    "commit_url": "https://github.com/moodle/moodle/commit/a5fae3b0d21cc85a7ea2d2c2af8c7fc9acf2fd92",
    "files": [
      "mod/data/field/file/field.class.php",
      "mod/data/field/number/field.class.php",
      "mod/data/field/picture/field.class.php",
      "mod/data/field/text/field.class.php",
      "mod/data/field/textarea/field.class.php",
      "mod/data/field/url/field.class.php",
      "mod/data/lib.php"
    ],
    "message": "MDL-52727 mod_data: Improve output of the form fields values\n\nThis issue mostly affects the search form fields. Submitted values for\nthese fields are typically obtained via optional_param() with\nPARAM_NOTAGS specified as the parameter type - see parse_search_field()\nmethods. Such values themselves are not safe enough to be printed back\ndirectly into the HTML as they might contain malicious code.\n\nWhile working on the patch, some other places with weak protection were\ndetected and fixed.\n\nIn case of the itemid parameters, explicit clean_param() is added to\nmake sure we cast the value as an integer. That should make the s()\nunnecessary but it was added anyway as an extra protection (just in case\nthe code flow changes or the parts of the code are re-used elsewhere).",
    "before_after_code_files": [
      "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
      "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
      "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
      "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
      "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
      "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
      "mod/data/lib.php||mod/data/lib.php"
    ]
  },
  "patch_diff": {
    "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php": [
      "File: mod/data/field/file/field.class.php -> mod/data/field/file/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "39:         if ($formdata) {",
      "40:             $fieldname = 'field_' . $this->field->id . '_file';",
      "42:         } else if ($recordid) {",
      "43:             if ($content = $DB->get_record('data_content', array('fieldid'=>$this->field->id, 'recordid'=>$recordid))) {",
      "",
      "[Removed Lines]",
      "41:             $itemid = $formdata->$fieldname;",
      "",
      "[Added Lines]",
      "41:             $itemid = clean_param($formdata->$fieldname, PARAM_INT);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "79:         }",
      "84:         $options = new stdClass();",
      "85:         $options->maxbytes = $this->field->param3;",
      "",
      "[Removed Lines]",
      "82:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
      "",
      "[Added Lines]",
      "82:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "105:     function display_search_field($value = '') {",
      "106:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
      "108:     }",
      "110:     function generate_sql($tablealias, $value) {",
      "",
      "[Removed Lines]",
      "107:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "107:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php": [
      "File: mod/data/field/number/field.class.php -> mod/data/field/number/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "72:     function display_search_field($value = '') {",
      "73:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
      "75:     }",
      "77:     function parse_search_field() {",
      "",
      "[Removed Lines]",
      "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php": [
      "File: mod/data/field/picture/field.class.php -> mod/data/field/picture/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "40:         if ($formdata) {",
      "41:             $fieldname = 'field_' . $this->field->id . '_file';",
      "43:             $fieldname = 'field_' . $this->field->id . '_alttext';",
      "44:             if (isset($formdata->$fieldname)) {",
      "45:                 $alttext = $formdata->$fieldname;",
      "",
      "[Removed Lines]",
      "42:             $itemid = $formdata->$fieldname;",
      "",
      "[Added Lines]",
      "42:             $itemid = clean_param($formdata->$fieldname, PARAM_INT);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "109:         $str .= $output->render($fm);",
      "111:         $str .= '<div class=\"mdl-left\">';",
      "113:         $str .= '<label for=\"field_'.$this->field->id.'_alttext\">'.get_string('alttext','data') .'</label>&nbsp;<input type=\"text\" name=\"field_'",
      "114:                 .$this->field->id.'_alttext\" id=\"field_'.$this->field->id.'_alttext\" value=\"'.s($alttext).'\" />';",
      "115:         $str .= '</div>';",
      "",
      "[Removed Lines]",
      "112:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
      "",
      "[Added Lines]",
      "112:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "141:     function display_search_field($value = '') {",
      "142:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
      "144:     }",
      "146:     function parse_search_field() {",
      "",
      "[Removed Lines]",
      "143:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "143:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php": [
      "File: mod/data/field/text/field.class.php -> mod/data/field/text/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "27:     var $type = 'text';",
      "29:     function display_search_field($value = '') {",
      "31:     }",
      "33:     function parse_search_field() {",
      "",
      "[Removed Lines]",
      "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php": [
      "File: mod/data/field/textarea/field.class.php -> mod/data/field/textarea/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "79:             }",
      "80:             $fieldname = 'field_' . $this->field->id . '_itemid';",
      "81:             if (isset($formdata->$fieldname)) {",
      "83:             } else {",
      "84:                 $draftitemid = file_get_unused_draft_itemid();",
      "85:             }",
      "",
      "[Removed Lines]",
      "82:                 $draftitemid = $formdata->$fieldname;",
      "",
      "[Added Lines]",
      "82:                 $draftitemid = clean_param($formdata->$fieldname, PARAM_INT);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "146:         }",
      "147:         $editor->set_text($text);",
      "148:         $editor->use_editor($field, $options, $fpoptions);",
      "150:         $str .= '<div class=\"mod-data-input\">';",
      "151:         $str .= '<div><textarea id=\"'.$field.'\" name=\"'.$field.'\" rows=\"'.$this->field->param3.'\" cols=\"'.$this->field->param2.'\" spellcheck=\"true\">'.s($text).'</textarea></div>';",
      "152:         $str .= '<div><label class=\"accesshide\" for=\"' . $field . '_content1\">' . get_string('format') . '</label>';",
      "",
      "[Removed Lines]",
      "149:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.$draftitemid.'\" />';",
      "",
      "[Added Lines]",
      "149:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.s($draftitemid).'\" />';",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "167:     function display_search_field($value = '') {",
      "168:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
      "170:     }",
      "172:     function parse_search_field() {",
      "",
      "[Removed Lines]",
      "169:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "169:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php": [
      "File: mod/data/field/url/field.class.php -> mod/data/field/url/field.class.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "81:             }",
      "82:             $str .= '</td><td>';",
      "83:             $str .= $label;",
      "85:             $str .= '<button id=\"filepicker-button-'.$options->client_id.'\" style=\"display:none\">'.$straddlink.'</button></td></tr>';",
      "86:             $str .= '<tr><td align=\"right\"><span class=\"mod-data-input\">'.get_string('text', 'data').':</span></td><td>';",
      "87:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_1\" id=\"field_'.$this->field->id.'_1\" value=\"'.s($text).'\"';",
      "",
      "[Removed Lines]",
      "84:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.$url.'\" size=\"60\" />';",
      "",
      "[Added Lines]",
      "84:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.s($url).'\" size=\"60\" />';",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "109:     function display_search_field($value = '') {",
      "110:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
      "112:     }",
      "114:     function parse_search_field() {",
      "",
      "[Removed Lines]",
      "111:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
      "",
      "[Added Lines]",
      "111:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
      "",
      "---------------"
    ],
    "mod/data/lib.php||mod/data/lib.php": [
      "File: mod/data/lib.php -> mod/data/lib.php",
      "--- Hunk 1 ---",
      "[Context before]",
      "1736:     $fn = !empty($search_array[DATA_FIRSTNAME]->data) ? $search_array[DATA_FIRSTNAME]->data : '';",
      "1737:     $ln = !empty($search_array[DATA_LASTNAME]->data) ? $search_array[DATA_LASTNAME]->data : '';",
      "1738:     $patterns[]    = '/##firstname##/';",
      "1740:     $patterns[]    = '/##lastname##/';",
      "1744:     $newtext = preg_replace($patterns, $replacement, $data->asearchtemplate);",
      "",
      "[Removed Lines]",
      "1739:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.$fn.'\" />';",
      "1741:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.$ln.'\" />';",
      "",
      "[Added Lines]",
      "1739:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.s($fn).'\" />';",
      "1741:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.s($ln).'\" />';",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "8f95eac1634b4d84053cef52a03065e620d6adf2",
      "candidate_info": {
        "commit_hash": "8f95eac1634b4d84053cef52a03065e620d6adf2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/8f95eac1634b4d84053cef52a03065e620d6adf2",
        "files": [
          "mod/data/field/file/field.class.php",
          "mod/data/field/number/field.class.php",
          "mod/data/field/picture/field.class.php",
          "mod/data/field/text/field.class.php",
          "mod/data/field/textarea/field.class.php",
          "mod/data/field/url/field.class.php",
          "mod/data/lib.php"
        ],
        "message": "MDL-52727 mod_data: Improve output of the form fields values\n\nThis issue mostly affects the search form fields. Submitted values for\nthese fields are typically obtained via optional_param() with\nPARAM_NOTAGS specified as the parameter type - see parse_search_field()\nmethods. Such values themselves are not safe enough to be printed back\ndirectly into the HTML as they might contain malicious code.\n\nWhile working on the patch, some other places with weak protection were\ndetected and fixed.\n\nIn case of the itemid parameters, the s() seems to be unnecessary but it\nwas added anyway as an extra protection (just in case the code flow\nchanges or the parts of the code are re-used elsewhere).",
        "before_after_code_files": [
          "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
          "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
          "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
          "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
          "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
          "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
          "mod/data/lib.php||mod/data/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
            "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
            "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
            "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
            "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
            "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
            "mod/data/lib.php||mod/data/lib.php"
          ],
          "candidate": [
            "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
            "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
            "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
            "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
            "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
            "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
            "mod/data/lib.php||mod/data/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php": [
          "File: mod/data/field/file/field.class.php -> mod/data/field/file/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         $html .= '<fieldset><legend><span class=\"accesshide\">'.$this->field->name.'</span></legend>';",
          "73:         $options = new stdClass();",
          "74:         $options->maxbytes = $this->field->param3;",
          "",
          "[Removed Lines]",
          "71:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
          "",
          "[Added Lines]",
          "71:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "93:     function display_search_field($value = '') {",
          "94:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
          "96:     }",
          "98:     function generate_sql($tablealias, $value) {",
          "",
          "[Removed Lines]",
          "95:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "95:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php": [
          "File: mod/data/field/number/field.class.php -> mod/data/field/number/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:     function display_search_field($value = '') {",
          "73:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "75:     }",
          "77:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php": [
          "File: mod/data/field/picture/field.class.php -> mod/data/field/picture/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "93:         $str .= $output->render($fm);",
          "95:         $str .= '<div class=\"mdl-left\">';",
          "97:         $str .= '<label for=\"field_'.$this->field->id.'_alttext\">'.get_string('alttext','data') .'</label>&nbsp;<input type=\"text\" name=\"field_'",
          "98:                 .$this->field->id.'_alttext\" id=\"field_'.$this->field->id.'_alttext\" value=\"'.s($alttext).'\" />';",
          "99:         $str .= '</div>';",
          "",
          "[Removed Lines]",
          "96:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
          "",
          "[Added Lines]",
          "96:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:     function display_search_field($value = '') {",
          "125:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "127:     }",
          "129:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "126:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "126:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php": [
          "File: mod/data/field/text/field.class.php -> mod/data/field/text/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27:     var $type = 'text';",
          "29:     function display_search_field($value = '') {",
          "31:     }",
          "33:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php": [
          "File: mod/data/field/textarea/field.class.php -> mod/data/field/textarea/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "121:         }",
          "122:         $editor->set_text($text);",
          "123:         $editor->use_editor($field, $options, $fpoptions);",
          "125:         $str .= '<div><textarea id=\"'.$field.'\" name=\"'.$field.'\" rows=\"'.$this->field->param3.'\" cols=\"'.$this->field->param2.'\" spellcheck=\"true\">'.s($text).'</textarea></div>';",
          "126:         $str .= '<div><label class=\"accesshide\" for=\"' . $field . '_content1\">' . get_string('format') . '</label>';",
          "127:         $str .= '<select id=\"' . $field . '_content1\" name=\"'.$field.'_content1\">';",
          "",
          "[Removed Lines]",
          "124:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.$draftitemid.'\" />';",
          "",
          "[Added Lines]",
          "124:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.s($draftitemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "140:     function display_search_field($value = '') {",
          "141:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
          "143:     }",
          "145:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "142:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "142:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php": [
          "File: mod/data/field/url/field.class.php -> mod/data/field/url/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:             $str .= '<table><tr><td align=\"right\">';",
          "55:             $str .= get_string('url','data').':</td><td>';",
          "56:             $str .= '<label class=\"accesshide\" for=\"' . $fieldid . '\">'. $this->field->name .'</label>';",
          "58:             $str .= '<button id=\"filepicker-button-'.$options->client_id.'\" style=\"display:none\">'.$straddlink.'</button></td></tr>';",
          "59:             $str .= '<tr><td align=\"right\">'.get_string('text','data').':</td><td><input type=\"text\" name=\"field_'.$this->field->id.'_1\" id=\"field_'.$this->field->id.'_1\" value=\"'.s($text).'\" size=\"60\" /></td></tr>';",
          "60:             $str .= '</table>';",
          "",
          "[Removed Lines]",
          "57:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.$url.'\" size=\"60\" />';",
          "",
          "[Added Lines]",
          "57:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.s($url).'\" size=\"60\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     function display_search_field($value = '') {",
          "81:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "83:     }",
          "85:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "82:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "82:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/lib.php||mod/data/lib.php": [
          "File: mod/data/lib.php -> mod/data/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1715:     $fn = !empty($search_array[DATA_FIRSTNAME]->data) ? $search_array[DATA_FIRSTNAME]->data : '';",
          "1716:     $ln = !empty($search_array[DATA_LASTNAME]->data) ? $search_array[DATA_LASTNAME]->data : '';",
          "1717:     $patterns[]    = '/##firstname##/';",
          "1719:     $patterns[]    = '/##lastname##/';",
          "1723:     $newtext = preg_replace($patterns, $replacement, $data->asearchtemplate);",
          "",
          "[Removed Lines]",
          "1718:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.$fn.'\" />';",
          "1720:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.$ln.'\" />';",
          "",
          "[Added Lines]",
          "1718:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.s($fn).'\" />';",
          "1720:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.s($ln).'\" />';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "87e60e529939c60ef5b07d70c37426d359b2e8a2",
      "candidate_info": {
        "commit_hash": "87e60e529939c60ef5b07d70c37426d359b2e8a2",
        "repo": "moodle/moodle",
        "commit_url": "https://github.com/moodle/moodle/commit/87e60e529939c60ef5b07d70c37426d359b2e8a2",
        "files": [
          "mod/data/field/file/field.class.php",
          "mod/data/field/number/field.class.php",
          "mod/data/field/picture/field.class.php",
          "mod/data/field/text/field.class.php",
          "mod/data/field/textarea/field.class.php",
          "mod/data/field/url/field.class.php",
          "mod/data/lib.php"
        ],
        "message": "MDL-52727 mod_data: Improve output of the form fields values\n\nThis issue mostly affects the search form fields. Submitted values for\nthese fields are typically obtained via optional_param() with\nPARAM_NOTAGS specified as the parameter type - see parse_search_field()\nmethods. Such values themselves are not safe enough to be printed back\ndirectly into the HTML as they might contain malicious code.\n\nWhile working on the patch, some other places with weak protection were\ndetected and fixed.\n\nIn case of the itemid parameters, the s() seems to be unnecessary but it\nwas added anyway as an extra protection (just in case the code flow\nchanges or the parts of the code are re-used elsewhere).",
        "before_after_code_files": [
          "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
          "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
          "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
          "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
          "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
          "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
          "mod/data/lib.php||mod/data/lib.php"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_olp_changes": 1,
        "olp_code_files": {
          "patch": [
            "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
            "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
            "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
            "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
            "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
            "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
            "mod/data/lib.php||mod/data/lib.php"
          ],
          "candidate": [
            "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php",
            "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php",
            "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php",
            "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php",
            "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php",
            "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php",
            "mod/data/lib.php||mod/data/lib.php"
          ]
        }
      },
      "candidate_diff": {
        "mod/data/field/file/field.class.php||mod/data/field/file/field.class.php": [
          "File: mod/data/field/file/field.class.php -> mod/data/field/file/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "68:         $html .= '<fieldset><legend><span class=\"accesshide\">'.$this->field->name.'</span></legend>';",
          "73:         $options = new stdClass();",
          "74:         $options->maxbytes = $this->field->param3;",
          "",
          "[Removed Lines]",
          "71:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
          "",
          "[Added Lines]",
          "71:         $html .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "93:     function display_search_field($value = '') {",
          "94:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
          "96:     }",
          "98:     function generate_sql($tablealias, $value) {",
          "",
          "[Removed Lines]",
          "95:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "95:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/number/field.class.php||mod/data/field/number/field.class.php": [
          "File: mod/data/field/number/field.class.php -> mod/data/field/number/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:     function display_search_field($value = '') {",
          "73:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "75:     }",
          "77:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "74:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/picture/field.class.php||mod/data/field/picture/field.class.php": [
          "File: mod/data/field/picture/field.class.php -> mod/data/field/picture/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "93:         $str .= $output->render($fm);",
          "95:         $str .= '<div class=\"mdl-left\">';",
          "97:         $str .= '<label for=\"field_'.$this->field->id.'_alttext\">'.get_string('alttext','data') .'</label>&nbsp;<input type=\"text\" name=\"field_'",
          "98:                 .$this->field->id.'_alttext\" id=\"field_'.$this->field->id.'_alttext\" value=\"'.s($alttext).'\" />';",
          "99:         $str .= '</div>';",
          "",
          "[Removed Lines]",
          "96:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.$itemid.'\" />';",
          "",
          "[Added Lines]",
          "96:         $str .= '<input type=\"hidden\" name=\"field_'.$this->field->id.'_file\" value=\"'.s($itemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "124:     function display_search_field($value = '') {",
          "125:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "127:     }",
          "129:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "126:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "126:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/text/field.class.php||mod/data/field/text/field.class.php": [
          "File: mod/data/field/text/field.class.php -> mod/data/field/text/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "27:     var $type = 'text';",
          "29:     function display_search_field($value = '') {",
          "31:     }",
          "33:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "30:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">'. $this->field->name.'</label>' . '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/textarea/field.class.php||mod/data/field/textarea/field.class.php": [
          "File: mod/data/field/textarea/field.class.php -> mod/data/field/textarea/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "120:             $formats[$fid] = $strformats[$fid];",
          "121:         }",
          "122:         $editor->use_editor($field, $options, $fpoptions);",
          "124:         $str .= '<div><textarea id=\"'.$field.'\" name=\"'.$field.'\" rows=\"'.$this->field->param3.'\" cols=\"'.$this->field->param2.'\" spellcheck=\"true\">'.s($text).'</textarea></div>';",
          "125:         $str .= '<div><label class=\"accesshide\" for=\"' . $field . '_content1\">' . get_string('format') . '</label>';",
          "126:         $str .= '<select id=\"' . $field . '_content1\" name=\"'.$field.'_content1\">';",
          "",
          "[Removed Lines]",
          "123:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.$draftitemid.'\" />';",
          "",
          "[Added Lines]",
          "123:         $str .= '<input type=\"hidden\" name=\"'.$field.'_itemid\" value=\"'.s($draftitemid).'\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "139:     function display_search_field($value = '') {",
          "140:         return '<label class=\"accesshide\" for=\"f_' . $this->field->id . '\">' . $this->field->name . '</label>' .",
          "142:     }",
          "144:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "141:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "141:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/field/url/field.class.php||mod/data/field/url/field.class.php": [
          "File: mod/data/field/url/field.class.php -> mod/data/field/url/field.class.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "54:             $str .= '<table><tr><td align=\"right\">';",
          "55:             $str .= get_string('url','data').':</td><td>';",
          "56:             $str .= '<label class=\"accesshide\" for=\"' . $fieldid . '\">'. $this->field->name .'</label>';",
          "58:             $str .= '<button id=\"filepicker-button-'.$options->client_id.'\" style=\"display:none\">'.$straddlink.'</button></td></tr>';",
          "59:             $str .= '<tr><td align=\"right\">'.get_string('text','data').':</td><td><input type=\"text\" name=\"field_'.$this->field->id.'_1\" id=\"field_'.$this->field->id.'_1\" value=\"'.s($text).'\" size=\"60\" /></td></tr>';",
          "60:             $str .= '</table>';",
          "",
          "[Removed Lines]",
          "57:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.$url.'\" size=\"60\" />';",
          "",
          "[Added Lines]",
          "57:             $str .= '<input type=\"text\" name=\"field_'.$this->field->id.'_0\" id=\"'.$fieldid.'\" value=\"'.s($url).'\" size=\"60\" />';",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:     function display_search_field($value = '') {",
          "81:         return '<label class=\"accesshide\" for=\"f_'.$this->field->id.'\">' . get_string('fieldname', 'data') . '</label>' .",
          "83:     }",
          "85:     function parse_search_field() {",
          "",
          "[Removed Lines]",
          "82:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.$value.'\" />';",
          "",
          "[Added Lines]",
          "82:                '<input type=\"text\" size=\"16\" id=\"f_'.$this->field->id.'\" name=\"f_'.$this->field->id.'\" value=\"'.s($value).'\" />';",
          "",
          "---------------"
        ],
        "mod/data/lib.php||mod/data/lib.php": [
          "File: mod/data/lib.php -> mod/data/lib.php",
          "--- Hunk 1 ---",
          "[Context before]",
          "1741:     $fn = !empty($search_array[DATA_FIRSTNAME]->data) ? $search_array[DATA_FIRSTNAME]->data : '';",
          "1742:     $ln = !empty($search_array[DATA_LASTNAME]->data) ? $search_array[DATA_LASTNAME]->data : '';",
          "1743:     $patterns[]    = '/##firstname##/';",
          "1745:     $patterns[]    = '/##lastname##/';",
          "1749:     $newtext = preg_replace($patterns, $replacement, $data->asearchtemplate);",
          "",
          "[Removed Lines]",
          "1744:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.$fn.'\" />';",
          "1746:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.$ln.'\" />';",
          "",
          "[Added Lines]",
          "1744:     $replacement[] = '<label class=\"accesshide\" for=\"u_fn\">'.get_string('authorfirstname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_fn\" name=\"u_fn\" value=\"'.s($fn).'\" />';",
          "1746:     $replacement[] = '<label class=\"accesshide\" for=\"u_ln\">'.get_string('authorlastname', 'data').'</label><input type=\"text\" size=\"16\" id=\"u_ln\" name=\"u_ln\" value=\"'.s($ln).'\" />';",
          "",
          "---------------"
        ]
      }
    }
  ]
}