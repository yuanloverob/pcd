{
  "cve_id": "CVE-2021-29586",
  "cve_desc": "TensorFlow is an end-to-end open source platform for machine learning. Optimized pooling implementations in TFLite fail to check that the stride arguments are not 0 before calling `ComputePaddingHeightWidth`(https://github.com/tensorflow/tensorflow/blob/3f24ccd932546416ec906a02ddd183b48a1d2c83/tensorflow/lite/kernels/pooling.cc#L90). Since users can craft special models which will have `params->stride_{height,width}` be zero, this will result in a division by zero. The fix will be included in TensorFlow 2.5.0. We will also cherrypick this commit on TensorFlow 2.4.2, TensorFlow 2.3.3, TensorFlow 2.2.3 and TensorFlow 2.1.4, as these are also affected and still in supported range.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "5f7975d09eac0f10ed8a17dbb6f5964977725adc",
  "patch_info": {
    "commit_hash": "5f7975d09eac0f10ed8a17dbb6f5964977725adc",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/5f7975d09eac0f10ed8a17dbb6f5964977725adc",
    "files": [
      "tensorflow/lite/kernels/pooling.cc",
      "tensorflow/lite/kernels/pooling_test.cc"
    ],
    "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
    "before_after_code_files": [
      "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
      "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
      "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "87:   auto padding = params->padding;",
      "88:   int out_width, out_height;",
      "90:   data->padding = ComputePaddingHeightWidth(",
      "91:       params->stride_height, params->stride_width, 1, 1, height, width,",
      "92:       params->filter_height, params->filter_width, padding, &out_height,",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "91:   TF_LITE_ENSURE(context, params->stride_height > 0);",
      "92:   TF_LITE_ENSURE(context, params->stride_width > 0);",
      "",
      "---------------"
    ],
    "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
      "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "1151:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
      "1152: }",
      "1154: }  // namespace",
      "1155: }  // namespace tflite",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1154: #ifdef GTEST_HAS_DEATH_TEST",
      "1155: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
      "1156:   EXPECT_DEATH(",
      "1157:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
      "1163:       \"Cannot allocate tensors\");",
      "1164: }",
      "1165: #endif",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "9f51169f3ba9e1c7dd4af9ce2ffef1aed5323f08",
      "candidate_info": {
        "commit_hash": "9f51169f3ba9e1c7dd4af9ce2ffef1aed5323f08",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/9f51169f3ba9e1c7dd4af9ce2ffef1aed5323f08",
        "files": [
          "tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc"
        ],
        "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
        "before_after_code_files": [
          "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
          "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "84:   auto padding = params->padding;",
          "85:   int out_width, out_height;",
          "87:   data->padding = ComputePaddingHeightWidth(",
          "88:       params->stride_height, params->stride_width, 1, 1, height, width,",
          "89:       params->filter_height, params->filter_width, padding, &out_height,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "88:   TF_LITE_ENSURE(context, params->stride_height > 0);",
          "89:   TF_LITE_ENSURE(context, params->stride_width > 0);",
          "",
          "---------------"
        ],
        "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
          "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1083:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
          "1084: }",
          "1086: }  // namespace",
          "1087: }  // namespace tflite",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1086: #ifdef GTEST_HAS_DEATH_TEST",
          "1087: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
          "1088:   EXPECT_DEATH(",
          "1089:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
          "1095:       \"Cannot allocate tensors\");",
          "1096: }",
          "1097: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2a2c7d5a12edd1304ff6b3652362b0cc74dd6a95",
      "candidate_info": {
        "commit_hash": "2a2c7d5a12edd1304ff6b3652362b0cc74dd6a95",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/2a2c7d5a12edd1304ff6b3652362b0cc74dd6a95",
        "files": [
          "tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc"
        ],
        "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
        "before_after_code_files": [
          "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
          "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:   auto padding = params->padding;",
          "88:   int out_width, out_height;",
          "90:   data->padding = ComputePaddingHeightWidth(",
          "91:       params->stride_height, params->stride_width, 1, 1, height, width,",
          "92:       params->filter_height, params->filter_width, padding, &out_height,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   TF_LITE_ENSURE(context, params->stride_height > 0);",
          "92:   TF_LITE_ENSURE(context, params->stride_width > 0);",
          "",
          "---------------"
        ],
        "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
          "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1151:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
          "1152: }",
          "1154: }  // namespace",
          "1155: }  // namespace tflite",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1154: #ifdef GTEST_HAS_DEATH_TEST",
          "1155: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
          "1156:   EXPECT_DEATH(",
          "1157:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
          "1163:       \"Cannot allocate tensors\");",
          "1164: }",
          "1165: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5500bcc40f6d267eca67ea1c8099eca3bf458c2c",
      "candidate_info": {
        "commit_hash": "5500bcc40f6d267eca67ea1c8099eca3bf458c2c",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/5500bcc40f6d267eca67ea1c8099eca3bf458c2c",
        "files": [
          "tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc"
        ],
        "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
        "before_after_code_files": [
          "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
          "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:   auto padding = params->padding;",
          "84:   int out_width, out_height;",
          "86:   data->padding = ComputePaddingHeightWidth(",
          "87:       params->stride_height, params->stride_width, 1, 1, height, width,",
          "88:       params->filter_height, params->filter_width, padding, &out_height,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "87:   TF_LITE_ENSURE(context, params->stride_height > 0);",
          "88:   TF_LITE_ENSURE(context, params->stride_width > 0);",
          "",
          "---------------"
        ],
        "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
          "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1083:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
          "1084: }",
          "1086: }  // namespace",
          "1087: }  // namespace tflite",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1086: #ifdef GTEST_HAS_DEATH_TEST",
          "1087: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
          "1088:   EXPECT_DEATH(",
          "1089:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
          "1095:       \"Cannot allocate tensors\");",
          "1096: }",
          "1097: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d55533a1f99995377832a3d131756a8d66f2c55d",
      "candidate_info": {
        "commit_hash": "d55533a1f99995377832a3d131756a8d66f2c55d",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d55533a1f99995377832a3d131756a8d66f2c55d",
        "files": [
          "tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc"
        ],
        "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
        "before_after_code_files": [
          "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
          "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "87:   auto padding = params->padding;",
          "88:   int out_width, out_height;",
          "90:   data->padding = ComputePaddingHeightWidth(",
          "91:       params->stride_height, params->stride_width, 1, 1, height, width,",
          "92:       params->filter_height, params->filter_width, padding, &out_height,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "91:   TF_LITE_ENSURE(context, params->stride_height > 0);",
          "92:   TF_LITE_ENSURE(context, params->stride_width > 0);",
          "",
          "---------------"
        ],
        "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
          "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1151:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
          "1152: }",
          "1154: }  // namespace",
          "1155: }  // namespace tflite",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1154: #ifdef GTEST_HAS_DEATH_TEST",
          "1155: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
          "1156:   EXPECT_DEATH(",
          "1157:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
          "1163:       \"Cannot allocate tensors\");",
          "1164: }",
          "1165: #endif",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "55e88231144464012b66fd0435e5a1c83a1aca70",
      "candidate_info": {
        "commit_hash": "55e88231144464012b66fd0435e5a1c83a1aca70",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/55e88231144464012b66fd0435e5a1c83a1aca70",
        "files": [
          "tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc"
        ],
        "message": "Prevent another div by 0 in optimized pooling implementations TFLite\n\nPiperOrigin-RevId: 370800091\nChange-Id: I2119352f57fb5ca4f2051e0e2d749403304a979b",
        "before_after_code_files": [
          "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
          "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ],
          "candidate": [
            "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc",
            "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/lite/kernels/pooling.cc||tensorflow/lite/kernels/pooling.cc": [
          "File: tensorflow/lite/kernels/pooling.cc -> tensorflow/lite/kernels/pooling.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "85:   auto padding = params->padding;",
          "86:   int out_width, out_height;",
          "88:   data->padding = ComputePaddingHeightWidth(",
          "89:       params->stride_height, params->stride_width, 1, 1, height, width,",
          "90:       params->filter_height, params->filter_width, padding, &out_height,",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "89:   TF_LITE_ENSURE(context, params->stride_height > 0);",
          "90:   TF_LITE_ENSURE(context, params->stride_width > 0);",
          "",
          "---------------"
        ],
        "tensorflow/lite/kernels/pooling_test.cc||tensorflow/lite/kernels/pooling_test.cc": [
          "File: tensorflow/lite/kernels/pooling_test.cc -> tensorflow/lite/kernels/pooling_test.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1151:   EXPECT_THAT(m.GetOutput(), ElementsAreArray({3.5, 6.0, 6.5}));",
          "1152: }",
          "1154: }  // namespace",
          "1155: }  // namespace tflite",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1154: #ifdef GTEST_HAS_DEATH_TEST",
          "1155: TEST(FloatPoolingOpTest, MaxPoolWithZeroStride) {",
          "1156:   EXPECT_DEATH(",
          "1157:       FloatPoolingOpModel m(BuiltinOperator_MAX_POOL_2D,",
          "1163:       \"Cannot allocate tensors\");",
          "1164: }",
          "1165: #endif",
          "",
          "---------------"
        ]
      }
    }
  ]
}