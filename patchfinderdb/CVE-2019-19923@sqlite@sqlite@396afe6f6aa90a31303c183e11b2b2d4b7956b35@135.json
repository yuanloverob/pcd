{
  "cve_id": "CVE-2019-19923",
  "cve_desc": "flattenSubquery in select.c in SQLite 3.30.1 mishandles certain uses of SELECT DISTINCT involving a LEFT JOIN in which the right-hand side is a view. This can cause a NULL pointer dereference (or incorrect results).",
  "repo": "sqlite/sqlite",
  "patch_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
  "patch_info": {
    "commit_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/join.test"
    ],
    "message": "Continue to back away from the LEFT JOIN optimization of check-in [41c27bc0ff1d3135] by disallowing query flattening if the outer query is DISTINCT.  Without this fix, if an index scan is run on the table within the view on the right-hand side of the LEFT JOIN, stale result registers might be accessed yielding incorrect results, and/or an OP_IfNullRow opcode might be invoked on the un-opened table, resulting in a NULL-pointer dereference.  This problem was found by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: 862974312edf00e9d1068115d1a39b7235b7db68b6d86b81d38a12f025a4748e",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/join.test||test/join.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 289158aa24b066c453d2bce4bc2dead1c56fb0b23c3f7c4810b34b13627cef34",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3797:   if( (pSubitem->fg.jointype & JT_OUTER)!=0 ){",
      "3798:     isLeftJoin = 1;",
      "3801:       return 0;",
      "3802:     }",
      "3803:   }",
      "",
      "[Removed Lines]",
      "3799:     if( pSubSrc->nSrc>1 || isAgg || IsVirtual(pSubSrc->a[0].pTab) ){",
      "",
      "[Added Lines]",
      "3804:     ){",
      "",
      "---------------"
    ],
    "test/join.test||test/join.test": [
      "File: test/join.test -> test/join.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
      "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
      "978: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "978: # 2019-12-18 problem with a LEFT JOIN where the RHS is a view.",
      "979: # Detected by Yongheng and Rui.",
      "980: # Follows from the optimization attempt of check-in 41c27bc0ff1d3135",
      "981: # on 2017-04-18",
      "982: #",
      "983: reset_db",
      "984: do_execsql_test join-22.10 {",
      "985:   CREATE TABLE t0(a, b);",
      "986:   CREATE INDEX t0a ON t0(a);",
      "987:   INSERT INTO t0 VALUES(10,10),(10,11),(10,12);",
      "988:   SELECT DISTINCT c FROM t0 LEFT JOIN (SELECT a+1 AS c FROM t0) ORDER BY c ;",
      "989: } {11}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "99670abb82c4c67d528a554ef994a0d4e47b7199",
      "candidate_info": {
        "commit_hash": "99670abb82c4c67d528a554ef994a0d4e47b7199",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/99670abb82c4c67d528a554ef994a0d4e47b7199",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "test/gencol1.test"
        ],
        "message": "Do not set OP_Column flags on the instructions generated by sqlite3ExprCodeGetColumn() if the opcode generated is not really an OP_Column, which might happen if the column is virtual. Fix for ticket [b439bfcfb7deedc6]\n\nFossilOrigin-Name: 2401e04730a156aa48787b91af4e516406cb7635145e430be62fd16481816237",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "test/gencol1.test||test/gencol1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f8e876c82a246ceed32b166f64e05dfe5ce4ab4c6820be60404109b43d36bb80",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "3487:   assert( pParse->pVdbe!=0 );",
          "3488:   sqlite3ExprCodeGetColumnOfTable(pParse->pVdbe, pTab, iTable, iColumn, iReg);",
          "3489:   if( p5 ){",
          "3491:   }",
          "3492:   return iReg;",
          "3493: }",
          "",
          "[Removed Lines]",
          "3490:     sqlite3VdbeChangeP5(pParse->pVdbe, p5);",
          "",
          "[Added Lines]",
          "3490:     VdbeOp *pOp = sqlite3VdbeGetOp(pParse->pVdbe,-1);",
          "3491:     if( pOp->opcode==OP_Column ) pOp->p5 = p5;",
          "",
          "---------------"
        ],
        "test/gencol1.test||test/gencol1.test": [
          "File: test/gencol1.test -> test/gencol1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "342:   PRAGMA integrity_check;",
          "343: } {ok}",
          "346: # Ensure that the SrcList_item.colUsed field is set correctly when a",
          "347: # generated column appears in the USING clause of a join.",
          "348: #",
          "",
          "[Removed Lines]",
          "345: # 2019-12-09 but report from Yongheng Chen",
          "",
          "[Added Lines]",
          "345: # 2019-12-09 bug report from Yongheng Chen",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "369:   SELECT 456 FROM t1 JOIN t1 USING (x,x);",
          "370: } {456}",
          "373: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "372: # 2019-12-14 ticket b439bfcfb7deedc6",
          "373: #",
          "374: sqlite3 db :memory:",
          "375: do_execsql_test gencol1-14.10 {",
          "376:   CREATE TABLE t0(c0 AS(1 >= 1), c1 UNIQUE AS(TYPEOF(c0)), c2);",
          "377:   INSERT INTO t0 VALUES(0);",
          "378:   REINDEX;",
          "379:   SELECT * FROM t0;",
          "380: } {1 integer 0}",
          "381: do_catchsql_test gencol1-14.10 {",
          "382:   INSERT INTO t0 VALUES(2);",
          "383: } {1 {UNIQUE constraint failed: t0.c1}}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "108e6b2c875cd723626a5960cce4d492d6c59813",
      "candidate_info": {
        "commit_hash": "108e6b2c875cd723626a5960cce4d492d6c59813",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/108e6b2c875cd723626a5960cce4d492d6c59813",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbe.c",
          "src/window.c",
          "test/permutations.test",
          "test/window4.test",
          "test/windowfault.test"
        ],
        "message": "Always evaluate window functions using the alternative path usually only used by EXCLUDE frames if the SQLITE_QueryFlattener test flag is set.\n\nFossilOrigin-Name: 2879a691aca9304aea5acb46bab8e82bb2e08eb54201f3679d60bfc0e8383845",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbe.c||src/vdbe.c",
          "src/window.c||src/window.c",
          "test/permutations.test||test/permutations.test",
          "test/window4.test||test/window4.test",
          "test/windowfault.test||test/windowfault.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 723c84be3ec5ae941b7abd2442cdb76ca3bd76a5ce2d830b0e648c6e1424885a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbe.c||src/vdbe.c": [
          "File: src/vdbe.c -> src/vdbe.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "6540:   assert( (pMem->flags & ~(MEM_Null|MEM_Agg))==0 );",
          "6541: #ifndef SQLITE_OMIT_WINDOWFUNC",
          "6542:   if( pOp->p3 ){",
          "6543:     rc = sqlite3VdbeMemAggValue(pMem, &aMem[pOp->p3], pOp->p4.pFunc);",
          "6544:     pMem = &aMem[pOp->p3];",
          "6545:   }else",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "6543:     memAboutToChange(p, &aMem[pOp->p3]);",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "215:   struct NthValueCtx *p;",
          "216:   p = (struct NthValueCtx*)sqlite3_aggregate_context(pCtx, sizeof(*p));",
          "217:   if( p ){",
          "219:     p->nStep++;",
          "220:     if( iVal==p->nStep ){",
          "221:       p->pValue = sqlite3_value_dup(apArg[0]);",
          "222:     }",
          "223:   }",
          "224:   UNUSED_PARAMETER(nArg);",
          "225:   UNUSED_PARAMETER(apArg);",
          "226: }",
          "227: static void nth_valueValueFunc(sqlite3_context *pCtx){",
          "228:   struct NthValueCtx *p;",
          "",
          "[Removed Lines]",
          "218:     i64 iVal = sqlite3_value_int64(apArg[1]);",
          "",
          "[Added Lines]",
          "218:     i64 iVal;",
          "219:     switch( sqlite3_value_numeric_type(apArg[1]) ){",
          "220:       case SQLITE_INTEGER:",
          "221:         iVal = sqlite3_value_int64(apArg[1]);",
          "222:         break;",
          "223:       case SQLITE_FLOAT: {",
          "224:         double fVal = sqlite3_value_double(apArg[1]);",
          "225:         if( ((i64)fVal)!=fVal ) goto error_out;",
          "226:         iVal = (i64)fVal;",
          "227:         break;",
          "228:       }",
          "229:       default:",
          "230:         goto error_out;",
          "231:     }",
          "232:     if( iVal<=0 ) goto error_out;",
          "237:       if( !p->pValue ){",
          "238:         sqlite3_result_error_nomem(pCtx);",
          "239:       }",
          "244:   return;",
          "246:  error_out:",
          "247:   sqlite3_result_error(",
          "248:       pCtx, \"second argument to nth_value must be a positive integer\", -1",
          "249:   );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "251:   p = (struct NthValueCtx*)sqlite3_aggregate_context(pCtx, sizeof(*p));",
          "252:   if( p && p->pValue==0 ){",
          "253:     p->pValue = sqlite3_value_dup(apArg[0]);",
          "254:   }",
          "255:   UNUSED_PARAMETER(nArg);",
          "256:   UNUSED_PARAMETER(apArg);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "278:     if( !p->pValue ){",
          "279:       sqlite3_result_error_nomem(pCtx);",
          "280:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1072:   pWin->eType = eType;",
          "1073:   pWin->eStart = eStart;",
          "1074:   pWin->eEnd = eEnd;",
          "1075:   pWin->eExclude = eExclude;",
          "1076:   pWin->bImplicitFrame = bImplicitFrame;",
          "1077:   pWin->pEnd = sqlite3WindowOffsetExpr(pParse, pEnd);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1102:   if( eExclude==0 && OptimizationDisabled(pParse->db, SQLITE_QueryFlattener) ){",
          "1103:     eExclude = TK_NO;",
          "1104:   }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1536:   addrNext = sqlite3VdbeCurrentAddr(v);",
          "1537:   sqlite3VdbeAddOp2(v, OP_Rowid, csr, regRowid);",
          "1538:   sqlite3VdbeAddOp3(v, OP_Gt, pMWin->regEndRowid, lblBrk, regRowid);",
          "1539:   if( pMWin->eExclude==TK_CURRENT ){",
          "1540:     sqlite3VdbeAddOp3(v, OP_Eq, regCRowid, lblNext, regRowid);",
          "1541:   }else if( pMWin->eExclude!=TK_NO ){",
          "1542:     int addr;",
          "1545:     if( pMWin->eExclude==TK_TIES ){",
          "1546:       addrEq = sqlite3VdbeAddOp3(v, OP_Eq, regCRowid, lblNext, regRowid);",
          "1547:     }",
          "",
          "[Removed Lines]",
          "1543:     int addrEq = 0;;",
          "1544:     KeyInfo *pKeyInfo = sqlite3KeyInfoFromExprList(pParse, pMWin->pOrderBy,0,0);",
          "",
          "[Added Lines]",
          "1574:     int addrEq = 0;",
          "1575:     KeyInfo *pKeyInfo;",
          "1577:     pKeyInfo = sqlite3KeyInfoFromExprList(pParse, pMWin->pOrderBy, 0, 0);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1668:     FuncDef *pFunc = pWin->pFunc;",
          "1669:     sqlite3VdbeAddOp2(v, OP_Null, 0, pWin->regAccum);",
          "1670:     nArg = MAX(nArg, windowArgCount(pWin));",
          "1672:       if( pFunc->zName==nth_valueName || pFunc->zName==first_valueName ){",
          "1673:         sqlite3VdbeAddOp2(v, OP_Integer, 0, pWin->regApp);",
          "1674:         sqlite3VdbeAddOp2(v, OP_Integer, 0, pWin->regApp+1);",
          "",
          "[Removed Lines]",
          "1671:     if( pWin->eExclude==0 ){",
          "",
          "[Added Lines]",
          "1704:     if( pMWin->regStartRowid==0 ){",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1764:   int reg2 = sqlite3GetTempReg(pParse);",
          "1765:   int arith = OP_Add;",
          "1766:   int addrGe;",
          "1769:   int regString = ++pParse->nMem;",
          "",
          "[Removed Lines]",
          "1767:   int addrNotNull;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2337:   assert( pMWin->eEnd==TK_FOLLOWING || pMWin->eEnd==TK_CURRENT",
          "2338:        || pMWin->eEnd==TK_UNBOUNDED || pMWin->eEnd==TK_PRECEDING",
          "2339:   );",
          "2341:   lblWhereEnd = sqlite3VdbeMakeLabel(pParse);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2372:   assert( pMWin->eExclude==0 || pMWin->eExclude==TK_CURRENT",
          "2373:        || pMWin->eExclude==TK_GROUP || pMWin->eExclude==TK_TIES",
          "2374:        || pMWin->eExclude==TK_NO",
          "2375:   );",
          "",
          "---------------"
        ],
        "test/permutations.test||test/permutations.test": [
          "File: test/permutations.test -> test/permutations.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1032: test_suite \"no_optimization\" -description {",
          "1033:   Run test scripts with optimizations disabled using the",
          "1034:   sqlite3_test_control(SQLITE_TESTCTRL_OPTIMIZATIONS) interface.",
          "1042:   optimization_control $::dbhandle all 0",
          "1043: }",
          "",
          "[Removed Lines]",
          "1035: } -files {",
          "1036:   where.test where2.test where3.test where4.test where5.test",
          "1037:   where6.test where7.test where8.test where9.test",
          "1038:   whereA.test whereB.test wherelimit.test",
          "1039:   select1.test select2.test select3.test select4.test select5.test",
          "1040:   select7.test select8.test selectA.test selectC.test",
          "1041: } -dbconfig {",
          "",
          "[Added Lines]",
          "1035: } -files [",
          "1036:   test_set \\",
          "1037:     [glob -nocomplain $::testdir/window*.test]                       \\",
          "1038:     where.test where2.test where3.test where4.test where5.test       \\",
          "1039:     where6.test where7.test where8.test where9.test                  \\",
          "1040:     whereA.test whereB.test wherelimit.test                          \\",
          "1041:     select1.test select2.test select3.test select4.test select5.test \\",
          "1042:     select7.test select8.test selectA.test selectC.test",
          "1043: ] -dbconfig {",
          "",
          "---------------"
        ],
        "test/window4.test||test/window4.test": [
          "File: test/window4.test -> test/window4.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "150:   SELECT group_concat(b, '.') OVER (",
          "151:     ORDER BY a ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING",
          "152:   ) FROM t4",
          "155: do_execsql_test 3.0 {",
          "156:   DROP TABLE IF EXISTS t5;",
          "",
          "[Removed Lines]",
          "153: } {A.B.C.D.E.F.G.H.I.J   B.C.D.E.F.G.H.I.J   C.D.E.F.G.H.I.J   D.E.F.G.H.I.J   E.F.G.H.I.J   F.G.H.I.J   G.H.I.J   H.I.J   I.J   J}",
          "",
          "[Added Lines]",
          "153: } {A.B.C.D.E.F.G.H.I.J   B.C.D.E.F.G.H.I.J   C.D.E.F.G.H.I.J   D.E.F.G.H.I.J",
          "154:   E.F.G.H.I.J   F.G.H.I.J   G.H.I.J   H.I.J   I.J   J}",
          "",
          "---------------"
        ],
        "test/windowfault.test||test/windowfault.test": [
          "File: test/windowfault.test -> test/windowfault.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "28: }",
          "29: faultsim_save_and_close",
          "32:   faultsim_restore_and_reopen",
          "33: } -body {",
          "34:   execsql {",
          "",
          "[Removed Lines]",
          "31: do_faultsim_test 1 -start 1 -faults oom-* -prep {",
          "",
          "[Added Lines]",
          "31: do_faultsim_test 1 -start 1 -faults oom-t* -prep {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e88c0cde6caa0136fb9b6b3b2ea3330faf8547d1",
      "candidate_info": {
        "commit_hash": "e88c0cde6caa0136fb9b6b3b2ea3330faf8547d1",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/e88c0cde6caa0136fb9b6b3b2ea3330faf8547d1",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/test_devsym.c",
          "test/permutations.test"
        ],
        "message": "As it requires wal mode support, do not run test file chunksize.test as part of the \"journaltest\" permutation.\n\nFossilOrigin-Name: acd2df36c2876ff3cc477889fc99f493cdf53a656bdb84bde6121676c9eeed1f",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/test_devsym.c||src/test_devsym.c",
          "test/permutations.test||test/permutations.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 971b4422ae7a8eed67f5db62c0e1cc061faac9404ff5f7051d7e07decf2207a4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/test_devsym.c||src/test_devsym.c": [
          "File: src/test_devsym.c -> src/test_devsym.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "506: void devsym_unregister(){",
          "507:   sqlite3_vfs_unregister(&devsym_vfs);",
          "508:   g.pVfs = 0;",
          "509:   g.iDeviceChar = 0;",
          "510:   g.iSectorSize = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "508:   sqlite3_vfs_unregister(&writecrash_vfs);",
          "",
          "---------------"
        ],
        "test/permutations.test||test/permutations.test": [
          "File: test/permutations.test -> test/permutations.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "966:   async4.test bigfile.test backcompat.test e_wal* fstat.test mmap2.test",
          "967:   pager1.test syscall.test tkt3457.test *malloc* mmap* multiplex* nolock*",
          "968:   pager2.test *fault* rowal* snapshot* superlock* symlink.test",
          "970: }]",
          "972: if {[info commands register_demovfs] != \"\"} {",
          "",
          "[Removed Lines]",
          "969:   delete_db.test shmlock.test",
          "",
          "[Added Lines]",
          "969:   delete_db.test shmlock.test chunksize.test",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "e464802d49013ea759c30be7106976cbc2cde1e5",
      "candidate_info": {
        "commit_hash": "e464802d49013ea759c30be7106976cbc2cde1e5",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/e464802d49013ea759c30be7106976cbc2cde1e5",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/vdbeblob.c",
          "test/close.test"
        ],
        "message": "Fix a problem that could cause a crash if a blob handle were closed after the associated database handle was closed using sqlite3_close_v2().\n\nFossilOrigin-Name: 52f463d29407fad691c42b13462880e7605603c9be9f480d18e953a0ef78149a",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/vdbeblob.c||src/vdbeblob.c",
          "test/close.test||test/close.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 0fff105a3e501fd91877d67761459eb0323e6cf79916242027cce0d05697f554",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/vdbeblob.c||src/vdbeblob.c": [
          "File: src/vdbeblob.c -> src/vdbeblob.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "355:   sqlite3 *db;",
          "357:   if( p ){",
          "358:     db = p->db;",
          "359:     sqlite3_mutex_enter(db->mutex);",
          "361:     sqlite3DbFree(db, p);",
          "362:     sqlite3_mutex_leave(db->mutex);",
          "363:   }else{",
          "364:     rc = SQLITE_OK;",
          "365:   }",
          "",
          "[Removed Lines]",
          "360:     rc = sqlite3_finalize(p->pStmt);",
          "",
          "[Added Lines]",
          "358:     sqlite3_stmt *pStmt = p->pStmt;",
          "363:     rc = sqlite3_finalize(pStmt);",
          "",
          "---------------"
        ],
        "test/close.test||test/close.test": [
          "File: test/close.test -> test/close.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "79:   sqlite3_finalize $STMT",
          "80: } {SQLITE_OK}",
          "82: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "82: do_test 1.5 {",
          "83:   set DB [sqlite3_open test.db]",
          "84:   sqlite3_blob_open $DB main t1 x 2 0 BLOB",
          "85:   sqlite3_close_v2 $DB",
          "86:   sqlite3_blob_close $BLOB",
          "87: } {}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "60379d424341391776e3270f989f0a489db0539c",
      "candidate_info": {
        "commit_hash": "60379d424341391776e3270f989f0a489db0539c",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/60379d424341391776e3270f989f0a489db0539c",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/shell.c.in"
        ],
        "message": "Fix the CLI so that the \".open --hexdb\" command works even if it is contained in a subscript that is read using \".read\".\n\nFossilOrigin-Name: 67a87399b8ad8f1ce3052ee3159906f5c6df3d7b5691b3acac856bd2f1c82088",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/shell.c.in||src/shell.c.in"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: e3bf1d3ea5f748c5142c2403813fdace5aedc1fc68f0dcd5eae40a2fe763fedb",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "3595: }",
          "",
          "[Removed Lines]",
          "3598: static int process_input(ShellState *p, FILE *in);",
          "",
          "[Added Lines]",
          "3599: static int process_input(ShellState *p);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "3749:       return 0;",
          "3750:     }",
          "3751:   }else{",
          "3753:   }",
          "3755:   if( fgets(zLine, sizeof(zLine), in)==0 ) goto readHexDb_error;",
          "",
          "[Removed Lines]",
          "3752:     in = stdin;",
          "",
          "[Added Lines]",
          "3753:     in = p->in;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "3789:     }",
          "3790:   }",
          "3793:   return a;",
          "3795: readHexDb_error:",
          "3796:   if( in!=stdin ){",
          "3797:     fclose(in);",
          "3798:   }else{",
          "3800:       if(strncmp(zLine, \"| end \", 6)==0 ) break;",
          "3801:     }",
          "3802:   }",
          "",
          "[Removed Lines]",
          "3792:   if( in!=stdin ) fclose(in);",
          "3799:     while( fgets(zLine, sizeof(zLine), in)!=0 ){",
          "",
          "[Added Lines]",
          "3793:   if( in!=p->in ) fclose(in);",
          "3800:     while( fgets(zLine, sizeof(zLine), p->in)!=0 ){",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "6970:   }else",
          "6972:   if( c=='r' && n>=3 && strncmp(azArg[0], \"read\", n)==0 ){",
          "6974:     if( nArg!=2 ){",
          "6975:       raw_printf(stderr, \"Usage: .read FILE\\n\");",
          "6976:       rc = 1;",
          "6977:       goto meta_command_exit;",
          "6978:     }",
          "6981:       utf8_printf(stderr,\"Error: cannot open \\\"%s\\\"\\n\", azArg[1]);",
          "6982:       rc = 1;",
          "6983:     }else{",
          "6986:     }",
          "6987:   }else",
          "6989:   if( c=='r' && n>=3 && strncmp(azArg[0], \"restore\", n)==0 ){",
          "",
          "[Removed Lines]",
          "6973:     FILE *alt;",
          "6979:     alt = fopen(azArg[1], \"rb\");",
          "6980:     if( alt==0 ){",
          "6984:       rc = process_input(p, alt);",
          "6985:       fclose(alt);",
          "",
          "[Added Lines]",
          "6974:     FILE *inSaved = p->in;",
          "6980:     p->in = fopen(azArg[1], \"rb\");",
          "6981:     if( p->in==0 ){",
          "6985:       rc = process_input(p);",
          "6986:       fclose(p->in);",
          "6988:     p->in = inSaved;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "8327: static int process_input(ShellState *p, FILE *in){",
          "",
          "[Added Lines]",
          "8329: static int process_input(ShellState *p){",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "8340:     fflush(p->out);",
          "8342:     if( zLine==0 ){",
          "8345:       break;",
          "8346:     }",
          "8347:     if( seenInterrupt ){",
          "8349:       seenInterrupt = 0;",
          "8350:     }",
          "8351:     lineno++;",
          "",
          "[Removed Lines]",
          "8339:   while( errCnt==0 || !bail_on_error || (in==0 && stdin_is_interactive) ){",
          "8341:     zLine = one_input_line(in, zLine, nSql>0);",
          "8344:       if( in==0 && stdin_is_interactive ) printf(\"\\n\");",
          "8348:       if( in!=0 ) break;",
          "",
          "[Added Lines]",
          "8341:   while( errCnt==0 || !bail_on_error || (p->in==0 && stdin_is_interactive) ){",
          "8343:     zLine = one_input_line(p->in, zLine, nSql>0);",
          "8346:       if( p->in==0 && stdin_is_interactive ) printf(\"\\n\");",
          "8350:       if( p->in!=0 ) break;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "8389:     }",
          "8390:     if( nSql && line_contains_semicolon(&zSql[nSqlPrior], nSql-nSqlPrior)",
          "8391:                 && sqlite3_complete(zSql) ){",
          "8393:       nSql = 0;",
          "8394:       if( p->outCount ){",
          "8395:         output_reset(p);",
          "",
          "[Removed Lines]",
          "8392:       errCnt += runOneSqlLine(p, zSql, in, startline);",
          "",
          "[Added Lines]",
          "8394:       errCnt += runOneSqlLine(p, zSql, p->in, startline);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "8403:     }",
          "8404:   }",
          "8405:   if( nSql && !_all_whitespace(zSql) ){",
          "8407:   }",
          "8408:   free(zSql);",
          "8409:   free(zLine);",
          "",
          "[Removed Lines]",
          "8406:     errCnt += runOneSqlLine(p, zSql, in, startline);",
          "",
          "[Added Lines]",
          "8408:     errCnt += runOneSqlLine(p, zSql, p->in, startline);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "8492:   char *home_dir = NULL;",
          "8493:   const char *sqliterc = sqliterc_override;",
          "8494:   char *zBuf = 0;",
          "8497:   if (sqliterc == NULL) {",
          "8498:     home_dir = find_home_dir(0);",
          "",
          "[Removed Lines]",
          "8495:   FILE *in = NULL;",
          "",
          "[Added Lines]",
          "8497:   FILE *inSaved = p->in;",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "8504:     zBuf = sqlite3_mprintf(\"%s/.sqliterc\",home_dir);",
          "8505:     sqliterc = zBuf;",
          "8506:   }",
          "8509:     if( stdin_is_interactive ){",
          "8510:       utf8_printf(stderr,\"-- Loading resources from %s\\n\",sqliterc);",
          "8511:     }",
          "8514:   }",
          "8515:   sqlite3_free(zBuf);",
          "8516: }",
          "",
          "[Removed Lines]",
          "8507:   in = fopen(sqliterc,\"rb\");",
          "8508:   if( in ){",
          "8512:     process_input(p,in);",
          "8513:     fclose(in);",
          "",
          "[Added Lines]",
          "8509:   p->in = fopen(sqliterc,\"rb\");",
          "8510:   if( p->in ){",
          "8514:     process_input(p);",
          "8515:     fclose(p->in);",
          "8517:   p->in = inSaved;",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "9123: #elif HAVE_LINENOISE",
          "9124:       linenoiseSetCompletionCallback(linenoise_completion);",
          "9125: #endif",
          "9127:       if( zHistory ){",
          "9128:         shell_stifle_history(2000);",
          "9129:         shell_write_history(zHistory);",
          "9130:         free(zHistory);",
          "9131:       }",
          "9132:     }else{",
          "9134:     }",
          "9135:   }",
          "9136:   set_table_name(&data, 0);",
          "",
          "[Removed Lines]",
          "9126:       rc = process_input(&data, 0);",
          "9133:       rc = process_input(&data, stdin);",
          "",
          "[Added Lines]",
          "9129:       data.in = 0;",
          "9130:       rc = process_input(&data);",
          "9137:       data.in = stdin;",
          "9138:       rc = process_input(&data);",
          "",
          "---------------"
        ]
      }
    }
  ]
}