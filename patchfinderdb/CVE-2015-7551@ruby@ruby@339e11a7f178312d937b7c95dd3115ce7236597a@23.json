{
  "cve_id": "CVE-2015-7551",
  "cve_desc": "The Fiddle::Handle implementation in ext/fiddle/handle.c in Ruby before 2.0.0-p648, 2.1 before 2.1.8, and 2.2 before 2.2.4, as distributed in Apple OS X before 10.11.4 and other products, mishandles tainting, which allows context-dependent attackers to execute arbitrary code or cause a denial of service (application crash) via a crafted string, related to the DL module and the libffi library.  NOTE: this vulnerability exists because of a CVE-2009-5147 regression.",
  "repo": "ruby/ruby",
  "patch_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
  "patch_info": {
    "commit_hash": "339e11a7f178312d937b7c95dd3115ce7236597a",
    "repo": "ruby/ruby",
    "commit_url": "https://github.com/ruby/ruby/commit/339e11a7f178312d937b7c95dd3115ce7236597a",
    "files": [
      "ChangeLog",
      "ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb",
      "version.h"
    ],
    "message": "merge revision(s): 53153 and 23405@ruby_1_9_1\n\n\t* ext/fiddle/handle.c: check tainted string arguments.\n\t  Patch provided by tenderlove and nobu.\n\n\t* test/fiddle/test_handle.rb (class TestHandle): add test for above.\n\n\t* ext/dl/handle.c (rb_dlhandle_initialize): prohibits DL::dlopen\n\t  with a tainted name of library.\n\t  Patch by sheepman <sheepman AT sheepman.sakura.ne.jp>.\n\n\t* ext/dl/handle.c (rb_dlhandle_sym): ditto\n\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53156 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
    "before_after_code_files": [
      "ext/fiddle/handle.c||ext/fiddle/handle.c",
      "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb",
      "version.h||version.h"
    ]
  },
  "patch_diff": {
    "ext/fiddle/handle.c||ext/fiddle/handle.c": [
      "File: ext/fiddle/handle.c -> ext/fiddle/handle.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #include <ruby.h>",
      "2: #include <fiddle.h>",
      "4: VALUE rb_cHandle;",
      "6: struct dl_handle {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4: #define SafeStringValueCStr(v) (rb_check_safe_obj(rb_string_value(&v)), StringValueCStr(v))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "143:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "144:  break;",
      "145:       case 1:",
      "147:  cflag = RTLD_LAZY | RTLD_GLOBAL;",
      "148:  break;",
      "149:       case 2:",
      "151:  cflag = NUM2INT(flag);",
      "152:  break;",
      "153:       default:",
      "",
      "[Removed Lines]",
      "146:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "150:  clib = NIL_P(lib) ? NULL : StringValuePtr(lib);",
      "",
      "[Added Lines]",
      "148:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "152:  clib = NIL_P(lib) ? NULL : SafeStringValueCStr(lib);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "263:     return PTR2NUM(fiddle_handle);",
      "264: }",
      "",
      "[Removed Lines]",
      "266: static VALUE fiddle_handle_sym(void *handle, const char *symbol);",
      "",
      "[Added Lines]",
      "268: static VALUE fiddle_handle_sym(void *handle, VALUE symbol);",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "282:  rb_raise(rb_eFiddleError, \"closed handle\");",
      "283:     }",
      "286: }",
      "288: #ifndef RTLD_NEXT",
      "",
      "[Removed Lines]",
      "285:     return fiddle_handle_sym(fiddle_handle->ptr, StringValueCStr(sym));",
      "",
      "[Added Lines]",
      "287:     return fiddle_handle_sym(fiddle_handle->ptr, sym);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "305: static VALUE",
      "306: rb_fiddle_handle_s_sym(VALUE self, VALUE sym)",
      "307: {",
      "309: }",
      "311: static VALUE",
      "313: {",
      "314: #if defined(HAVE_DLERROR)",
      "315:     const char *err;",
      "",
      "[Removed Lines]",
      "308:     return fiddle_handle_sym(RTLD_NEXT, StringValueCStr(sym));",
      "312: fiddle_handle_sym(void *handle, const char *name)",
      "",
      "[Added Lines]",
      "310:     return fiddle_handle_sym(RTLD_NEXT, sym);",
      "314: fiddle_handle_sym(void *handle, VALUE symbol)",
      "",
      "---------------",
      "--- Hunk 6 ---",
      "[Context before]",
      "318: # define CHECK_DLERROR",
      "319: #endif",
      "320:     void (*func)();",
      "322:     rb_secure(2);",
      "323: #ifdef HAVE_DLERROR",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "323:     const char *name = SafeStringValueCStr(symbol);",
      "",
      "---------------",
      "--- Hunk 7 ---",
      "[Context before]",
      "367:     }",
      "368: #endif",
      "369:     if( !func ){",
      "371:     }",
      "373:     return PTR2NUM(func);",
      "",
      "[Removed Lines]",
      "370:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%s\\\"\", name);",
      "",
      "[Added Lines]",
      "373:  rb_raise(rb_eFiddleError, \"unknown symbol \\\"%\"PRIsVALUE\"\\\"\", symbol);",
      "",
      "---------------"
    ],
    "test/fiddle/test_handle.rb||test/fiddle/test_handle.rb": [
      "File: test/fiddle/test_handle.rb -> test/fiddle/test_handle.rb",
      "--- Hunk 1 ---",
      "[Context before]",
      "11:     include Test::Unit::Assertions",
      "13:     def test_to_i",
      "14:       handle = Fiddle::Handle.new(LIBC_SO)",
      "15:       assert_kind_of Integer, handle.to_i",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "13:     def test_safe_handle_open",
      "14:       t = Thread.new do",
      "15:         $SAFE = 1",
      "16:         Fiddle::Handle.new(LIBC_SO.taint)",
      "17:       end",
      "18:       assert_raise(SecurityError) { t.value }",
      "19:     end",
      "21:     def test_safe_function_lookup",
      "22:       t = Thread.new do",
      "23:         h = Fiddle::Handle.new(LIBC_SO)",
      "24:         $SAFE = 1",
      "25:         h[\"qsort\".taint]",
      "26:       end",
      "27:       assert_raise(SecurityError) { t.value }",
      "28:     end",
      "",
      "---------------"
    ],
    "version.h||version.h": [
      "File: version.h -> version.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "1: #define RUBY_VERSION \"2.1.8\"",
      "2: #define RUBY_RELEASE_DATE \"2015-12-16\"",
      "5: #define RUBY_RELEASE_YEAR 2015",
      "6: #define RUBY_RELEASE_MONTH 12",
      "",
      "[Removed Lines]",
      "3: #define RUBY_PATCHLEVEL 438",
      "",
      "[Added Lines]",
      "3: #define RUBY_PATCHLEVEL 439",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "095d964e156e73d1827d1213ab30cef602ce9c10",
      "candidate_info": {
        "commit_hash": "095d964e156e73d1827d1213ab30cef602ce9c10",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/095d964e156e73d1827d1213ab30cef602ce9c10",
        "files": [
          "test/openssl/test_cipher.rb",
          "version.h"
        ],
        "message": "merge revision(s) r49525: [Backport #10839]\n\n\ttest_cipher.rb: OpenSSL 1.0.2\n\n\t* test/openssl/test_cipher.rb (OpenSSL::TestCipher#test_ciphers):\n  OpenSSL 1.0.2 does not allow wrap mode.\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49548 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "test/openssl/test_cipher.rb||test/openssl/test_cipher.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "test/openssl/test_cipher.rb||test/openssl/test_cipher.rb": [
          "File: test/openssl/test_cipher.rb -> test/openssl/test_cipher.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "104:     def test_ciphers",
          "105:       OpenSSL::Cipher.ciphers.each{|name|",
          "106:         next if /netbsd/ =~ RUBY_PLATFORM && /idea|rc5/i =~ name",
          "108:       }",
          "109:     end",
          "",
          "[Removed Lines]",
          "107:         assert(OpenSSL::Cipher::Cipher.new(name).is_a?(OpenSSL::Cipher::Cipher))",
          "",
          "[Added Lines]",
          "107:         begin",
          "108:           assert_kind_of(OpenSSL::Cipher::Cipher, OpenSSL::Cipher::Cipher.new(name))",
          "109:         rescue OpenSSL::Cipher::CipherError => e",
          "110:           next if /wrap\\z/ =~ name and e.message == 'wrap mode not allowed'",
          "111:           raise",
          "112:         end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 2",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-02-02\"",
          "3: #define RUBY_PATCHLEVEL 290",
          "7: #define RUBY_RELEASE_DAY 2",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-02-09\"",
          "3: #define RUBY_PATCHLEVEL 291",
          "7: #define RUBY_RELEASE_DAY 9",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "af3ab0bb2c97da94cbcd0d2e63e0c99b985d7028",
      "candidate_info": {
        "commit_hash": "af3ab0bb2c97da94cbcd0d2e63e0c99b985d7028",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/af3ab0bb2c97da94cbcd0d2e63e0c99b985d7028",
        "files": [
          "ChangeLog",
          "ext/socket/init.c",
          "version.h"
        ],
        "message": "merge revision(s) 53259: [Backport #11862]\n\n\t* ext/socket/init.c (rsock_init_sock): reject reserved FDs\n\t  [ruby-core:72445] [Bug #11862]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53924 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/socket/init.c||ext/socket/init.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/socket/init.c||ext/socket/init.c": [
          "File: ext/socket/init.c -> ext/socket/init.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "49:     if (fstat(fd, &sbuf) < 0)",
          "50:         rb_sys_fail(\"fstat(2)\");",
          "52:  errno = EBADF;",
          "53:         rb_sys_fail(\"not a socket file descriptor\");",
          "54:     }",
          "55: #else",
          "57:  errno = EBADF;",
          "58:         rb_sys_fail(\"not a socket file descriptor\");",
          "59:     }",
          "",
          "[Removed Lines]",
          "51:     if (!S_ISSOCK(sbuf.st_mode)) {",
          "56:     if (!rb_w32_is_socket(fd)) {",
          "",
          "[Added Lines]",
          "51:     if (!S_ISSOCK(sbuf.st_mode) || rb_reserved_fd_p(fd)) {",
          "56:     if (!rb_w32_is_socket(fd) || rb_reserved_fd_p(fd)) {",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.9\"",
          "2: #define RUBY_RELEASE_DATE \"2016-02-25\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 2",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 445",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 446",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d849db29b09e9cef039c5b4980d0417df94ae476",
      "candidate_info": {
        "commit_hash": "d849db29b09e9cef039c5b4980d0417df94ae476",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/d849db29b09e9cef039c5b4980d0417df94ae476",
        "files": [
          "ChangeLog",
          "ext/tk/lib/multi-tk.rb",
          "version.h"
        ],
        "message": "merge revision(s) 53022: [Backport #11764]\n\n\t* ext/tk/lib/multi-tk.rb: fix typos.\n\t  [Bug #11764][ruby-core:71800]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@53921 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "ext/tk/lib/multi-tk.rb||ext/tk/limulti-tk.rb",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "ext/tk/lib/multi-tk.rb||ext/tk/limulti-tk.rb": [
          "File: ext/tk/lib/multi-tk.rb -> ext/tk/limulti-tk.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1490:         begin",
          "1491:           @interp._eval(\"::safe::disallowTk #{slave}\")",
          "1492:         rescue",
          "1494:         end",
          "1495:       else # toplevel path",
          "1496:         begin",
          "1497:           @interp._eval(\"::safe::tkDelete {} #{top} #{slave}\")",
          "1498:         rescue",
          "1500:           begin",
          "1501:             @interp._eval(\"destroy #{top}\")",
          "1502:           rescue",
          "1504:           end",
          "1505:         end",
          "1506:       end",
          "",
          "[Removed Lines]",
          "1493:           warn(\"Waring: fail to call '::safe::disallowTk'\") if $DEBUG",
          "1499:           warn(\"Waring: fail to call '::safe::tkDelete'\") if $DEBUG",
          "1503:             warn(\"Waring: fail to destroy toplevel\") if $DEBUG",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.9\"",
          "2: #define RUBY_RELEASE_DATE \"2016-02-25\"",
          "5: #define RUBY_RELEASE_YEAR 2016",
          "6: #define RUBY_RELEASE_MONTH 2",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 442",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 443",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f50f70259ded4e1be9c197dd04d7da9518e8ca68",
      "candidate_info": {
        "commit_hash": "f50f70259ded4e1be9c197dd04d7da9518e8ca68",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/f50f70259ded4e1be9c197dd04d7da9518e8ca68",
        "files": [
          "ChangeLog",
          "test/ruby/test_refinement.rb",
          "version.h",
          "vm_method.c"
        ],
        "message": "merge revision(s) r49221: [Backport #10731]\n\n\t* vm_method.c (rb_alias): raise a NameError when creating alias to\n\t  a refined method if the original method of the refined method is\n\t  not defined.  [ruby-core:67523] [Bug #10731]\n\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49787 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "test/ruby/test_refinement.rb||test/ruby/test_refinement.rb",
          "version.h||version.h",
          "vm_method.c||vm_method.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "test/ruby/test_refinement.rb||test/ruby/test_refinement.rb": [
          "File: test/ruby/test_refinement.rb -> test/ruby/test_refinement.rb",
          "--- Hunk 1 ---",
          "[Context before]",
          "1181:     end;",
          "1182:   end",
          "1184:   private",
          "1186:   def eval_using(mod, s)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1184:   def test_alias_refined_method",
          "1185:     assert_separately([], <<-\"end;\")",
          "1186:     bug10731 = '[ruby-core:67523] [Bug #10731]'",
          "1188:     class C",
          "1189:     end",
          "1191:     module RefinementBug",
          "1192:       refine C do",
          "1193:         def foo",
          "1194:         end",
          "1196:         def bar",
          "1197:         end",
          "1198:       end",
          "1199:     end",
          "1201:     assert_raise(NameError, bug10731) do",
          "1202:       class C",
          "1203:         alias foo bar",
          "1204:       end",
          "1205:     end",
          "1206:     end;",
          "1207:   end",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "2: #define RUBY_RELEASE_DATE \"2015-03-01\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "6: #define RUBY_RELEASE_MONTH 3",
          "",
          "[Removed Lines]",
          "3: #define RUBY_PATCHLEVEL 304",
          "",
          "[Added Lines]",
          "3: #define RUBY_PATCHLEVEL 305",
          "",
          "---------------"
        ],
        "vm_method.c||vm_method.c": [
          "File: vm_method.c -> vm_method.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1259:   again:",
          "1260:     orig_me = search_method(klass, def, &defined_class);",
          "1263:  if ((!RB_TYPE_P(klass, T_MODULE)) ||",
          "1264:      (orig_me = search_method(rb_cObject, def, 0),",
          "1265:       UNDEFINED_METHOD_ENTRY_P(orig_me))) {",
          "",
          "[Removed Lines]",
          "1262:     if (UNDEFINED_METHOD_ENTRY_P(orig_me)) {",
          "",
          "[Added Lines]",
          "1262:     if (UNDEFINED_METHOD_ENTRY_P(orig_me) ||",
          "1263:  (orig_me->def->type == VM_METHOD_TYPE_REFINED &&",
          "1264:   UNDEFINED_METHOD_ENTRY_P(orig_me->def->body.orig_me))) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3fb0936a985d6aa56ce73025572ad06aa5f337e8",
      "candidate_info": {
        "commit_hash": "3fb0936a985d6aa56ce73025572ad06aa5f337e8",
        "repo": "ruby/ruby",
        "commit_url": "https://github.com/ruby/ruby/commit/3fb0936a985d6aa56ce73025572ad06aa5f337e8",
        "files": [
          "signal.c",
          "version.h"
        ],
        "message": "merge revision(s) r49463: [Backport #10814]\n\n\tsignal.c: SIGBUS by stack overflow on Funtoo\n\n\t* signal.c (sigbus): seems that Funtoo Linux also delivers SIGBUS\n  at stack overflow.\n\ngit-svn-id: svn+ssh://ci.ruby-lang.org/ruby/branches/ruby_2_1@49467 b2dd03c8-39d4-4d8f-98ff-823fe69b080e",
        "before_after_code_files": [
          "signal.c||signal.c",
          "version.h||version.h"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.h||version.h"
          ],
          "candidate": [
            "version.h||version.h"
          ]
        }
      },
      "candidate_diff": {
        "signal.c||signal.c": [
          "File: signal.c -> signal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "784:     CHECK_STACK_OVERFLOW();",
          "785: #endif",
          "786:     rb_bug(\"Bus Error\" MESSAGE_FAULT_ADDRESS);",
          "",
          "[Removed Lines]",
          "783: #if defined __APPLE__",
          "",
          "[Added Lines]",
          "784: #if defined __APPLE__ || defined __linux__",
          "",
          "---------------"
        ],
        "version.h||version.h": [
          "File: version.h -> version.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: #define RUBY_VERSION \"2.1.5\"",
          "5: #define RUBY_RELEASE_YEAR 2015",
          "9: #include \"ruby/version.h\"",
          "",
          "[Removed Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-01-22\"",
          "3: #define RUBY_PATCHLEVEL 285",
          "6: #define RUBY_RELEASE_MONTH 1",
          "7: #define RUBY_RELEASE_DAY 22",
          "",
          "[Added Lines]",
          "2: #define RUBY_RELEASE_DATE \"2015-02-02\"",
          "3: #define RUBY_PATCHLEVEL 286",
          "6: #define RUBY_RELEASE_MONTH 2",
          "7: #define RUBY_RELEASE_DAY 2",
          "",
          "---------------"
        ]
      }
    }
  ]
}