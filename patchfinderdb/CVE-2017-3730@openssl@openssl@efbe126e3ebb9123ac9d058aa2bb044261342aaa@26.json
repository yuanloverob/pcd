{
  "cve_id": "CVE-2017-3730",
  "cve_desc": "In OpenSSL 1.1.0 before 1.1.0d, if a malicious server supplies bad parameters for a DHE or ECDHE key exchange then this can result in the client attempting to dereference a NULL pointer leading to a client crash. This could be exploited in a Denial of Service attack.",
  "repo": "openssl/openssl",
  "patch_hash": "efbe126e3ebb9123ac9d058aa2bb044261342aaa",
  "patch_info": {
    "commit_hash": "efbe126e3ebb9123ac9d058aa2bb044261342aaa",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/efbe126e3ebb9123ac9d058aa2bb044261342aaa",
    "files": [
      "ssl/statem/statem_clnt.c"
    ],
    "message": "Fix missing NULL checks in CKE processing\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "ssl/statem/statem_clnt.c||ssl/statem/statem_clnt.c"
    ]
  },
  "patch_diff": {
    "ssl/statem/statem_clnt.c||ssl/statem/statem_clnt.c": [
      "File: ssl/statem/statem_clnt.c -> ssl/statem/statem_clnt.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2258:         return 0;",
      "2259:     }",
      "2260:     ckey = ssl_generate_pkey(skey);",
      "2261:     dh_clnt = EVP_PKEY_get0_DH(ckey);",
      "2263:     if (dh_clnt == NULL || ssl_derive(s, ckey, skey) == 0) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2261:     if (ckey == NULL) {",
      "2262:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_DHE, ERR_R_INTERNAL_ERROR);",
      "2263:         return 0;",
      "2264:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2296:     }",
      "2298:     ckey = ssl_generate_pkey(skey);",
      "2300:     if (ssl_derive(s, ckey, skey) == 0) {",
      "2301:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_ECDHE, ERR_R_EVP_LIB);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2304:     if (ckey == NULL) {",
      "2305:         SSLerr(SSL_F_TLS_CONSTRUCT_CKE_ECDHE, ERR_R_INTERNAL_ERROR);",
      "2306:         goto err;",
      "2307:     }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "609673d93b8d9d53b687d84afe40b7f30f43adf3",
      "candidate_info": {
        "commit_hash": "609673d93b8d9d53b687d84afe40b7f30f43adf3",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/609673d93b8d9d53b687d84afe40b7f30f43adf3",
        "files": [
          "crypto/ct/ct_policy.c"
        ],
        "message": "Default CT_POLICY_EVAL_CTX.epoch_time_in_ms to time()\n\nReviewed-by: Viktor Dukhovni <viktor@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1554)\n(cherry picked from commit e25233d99c30885bdf97bfb6df657e13ca2bf1da)",
        "before_after_code_files": [
          "crypto/ct/ct_policy.c||crypto/ct/ct_policy.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/ct/ct_policy.c||crypto/ct/ct_policy.c": [
          "File: crypto/ct/ct_policy.c -> crypto/ct/ct_policy.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "14: #include <openssl/ct.h>",
          "15: #include <openssl/err.h>",
          "17: #include \"ct_locl.h\"",
          "19: CT_POLICY_EVAL_CTX *CT_POLICY_EVAL_CTX_new(void)",
          "20: {",
          "21:     CT_POLICY_EVAL_CTX *ctx = OPENSSL_zalloc(sizeof(CT_POLICY_EVAL_CTX));",
          "23:     if (ctx == NULL) {",
          "24:         CTerr(CT_F_CT_POLICY_EVAL_CTX_NEW, ERR_R_MALLOC_FAILURE);",
          "25:         return NULL;",
          "26:     }",
          "28:     return ctx;",
          "29: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "16: #include <time.h>",
          "23:     time_t epoch_time_in_s;",
          "31:     time(&epoch_time_in_s);",
          "32:     if (epoch_time_in_s != -1)",
          "33:         ctx->epoch_time_in_ms = epoch_time_in_s * 1000;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "fadfc8ecfd277af189600648fcf1d28f33fd76fe",
      "candidate_info": {
        "commit_hash": "fadfc8ecfd277af189600648fcf1d28f33fd76fe",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/fadfc8ecfd277af189600648fcf1d28f33fd76fe",
        "files": [
          "crypto/asn1/a_int.c"
        ],
        "message": "Cast to an unsigned type before negating\n\nllvm's ubsan reported:\nruntime error: negation of -9223372036854775808 cannot be represented in\ntype 'int64_t' (aka 'long'); cast to an unsigned type to negate this\nvalue to itself\n\nFound using libfuzzer\n\nReviewed-by: Rich Salz <rsalz@openssl.org>\n\nGH: #1908\n(cherry picked from commit e80f3b6af295133107ac709329eee16ccf9af61c)",
        "before_after_code_files": [
          "crypto/asn1/a_int.c||crypto/asn1/a_int.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/asn1/a_int.c||crypto/asn1/a_int.c": [
          "File: crypto/asn1/a_int.c -> crypto/asn1/a_int.c"
        ]
      }
    },
    {
      "candidate_hash": "af8852e9957ce00c44653a73ba2f3e332b493c52",
      "candidate_info": {
        "commit_hash": "af8852e9957ce00c44653a73ba2f3e332b493c52",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/af8852e9957ce00c44653a73ba2f3e332b493c52",
        "files": [
          "crypto/ct/ct_policy.c"
        ],
        "message": "Cast time_t to uint64_t before converting to milliseconds in ct_policy.c\n\nReviewed-by: Viktor Dukhovni <viktor@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1554)\n(cherry picked from commit 5e08606619c0b0e065f1ffa12ce6411f321ed174)",
        "before_after_code_files": [
          "crypto/ct/ct_policy.c||crypto/ct/ct_policy.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/ct/ct_policy.c||crypto/ct/ct_policy.c": [
          "File: crypto/ct/ct_policy.c -> crypto/ct/ct_policy.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "33:     }",
          "37:     return ctx;",
          "38: }",
          "",
          "[Removed Lines]",
          "36:     ctx->epoch_time_in_ms = (time(NULL) + SCT_CLOCK_DRIFT_TOLERANCE) * 1000;",
          "",
          "[Added Lines]",
          "36:     ctx->epoch_time_in_ms = (uint64_t)(time(NULL) + SCT_CLOCK_DRIFT_TOLERANCE) *",
          "37:             1000;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "6bdd2637daa862706598d04ae2750a920ebee0ae",
      "candidate_info": {
        "commit_hash": "6bdd2637daa862706598d04ae2750a920ebee0ae",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/6bdd2637daa862706598d04ae2750a920ebee0ae",
        "files": [
          "crypto/dsa/dsa_gen.c"
        ],
        "message": "Fix a missing NULL check in dsa_builtin_paramgen\n\nWe should check the last BN_CTX_get() call to ensure that it isn't NULL\nbefore we try and use any of the allocated BIGNUMs.\n\nIssue reported by Shi Lei.\n\nReviewed-by: Richard Levitte <levitte@openssl.org>\n(cherry picked from commit 1ff7425d6130380bb00d3e64739633a4b21b11a3)",
        "before_after_code_files": [
          "crypto/dsa/dsa_gen.c||crypto/dsa/dsa_gen.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "crypto/dsa/dsa_gen.c||crypto/dsa/dsa_gen.c": [
          "File: crypto/dsa/dsa_gen.c -> crypto/dsa/dsa_gen.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "100:     p = BN_CTX_get(ctx);",
          "101:     test = BN_CTX_get(ctx);",
          "103:     if (!BN_lshift(test, BN_value_one(), bits - 1))",
          "104:         goto err;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "103:     if (test == NULL)",
          "104:         goto err;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3fd181a8b5b85a1f7383e82438da494a08f7d843",
      "candidate_info": {
        "commit_hash": "3fd181a8b5b85a1f7383e82438da494a08f7d843",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/3fd181a8b5b85a1f7383e82438da494a08f7d843",
        "files": [
          "apps/cms.c",
          "apps/smime.c"
        ],
        "message": "Remove an option related to a deprecated flag\n\nCMS_NOOLDMIMETYPE and PKCS7_NOOLDMIMETYPE  are unused in pkcs7/cms code.\n\nReviewed-by: Andy Polyakov <appro@openssl.org>\nReviewed-by: Rich Salz <rsalz@openssl.org>\n(Merged from https://github.com/openssl/openssl/pull/1585)\n(cherry picked from commit 28aef3d9558dc2e11ba56576b3a4d3faaef8a9d3)",
        "before_after_code_files": [
          "apps/cms.c||apps/cms.c",
          "apps/smime.c||apps/smime.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/EktapopaT/openssl/pull/1"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "apps/cms.c||apps/cms.c": [
          "File: apps/cms.c -> apps/cms.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "72:     OPT_ASCIICRLF, OPT_NOINTERN, OPT_NOVERIFY, OPT_NOCERTS,",
          "73:     OPT_NOATTR, OPT_NODETACH, OPT_NOSMIMECAP, OPT_BINARY, OPT_KEYID,",
          "74:     OPT_NOSIGS, OPT_NO_CONTENT_VERIFY, OPT_NO_ATTR_VERIFY, OPT_INDEF,",
          "76:     OPT_RR_ALL, OPT_RR_FIRST, OPT_RCTFORM, OPT_CERTFILE, OPT_CAFILE,",
          "77:     OPT_CAPATH, OPT_NOCAPATH, OPT_NOCAFILE,OPT_CONTENT, OPT_PRINT,",
          "78:     OPT_SECRETKEY, OPT_SECRETKEYID, OPT_PWRI_PASSWORD, OPT_ECONTENT_TYPE,",
          "",
          "[Removed Lines]",
          "75:     OPT_NOINDEF, OPT_NOOLDMIME, OPT_CRLFEOL, OPT_NOOUT, OPT_RR_PRINT,",
          "",
          "[Added Lines]",
          "75:     OPT_NOINDEF, OPT_CRLFEOL, OPT_NOOUT, OPT_RR_PRINT,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "131:     {\"stream\", OPT_INDEF, '-', \"Enable CMS streaming\"},",
          "132:     {\"indef\", OPT_INDEF, '-', \"Same as -stream\"},",
          "133:     {\"noindef\", OPT_NOINDEF, '-', \"Disable CMS streaming\"},",
          "135:     {\"crlfeol\", OPT_CRLFEOL, '-', \"Use CRLF as EOL termination instead of CR only\" },",
          "136:     {\"noout\", OPT_NOOUT, '-', \"For the -cmsout operation do not output the parsed CMS structure\"},",
          "137:     {\"receipt_request_print\", OPT_RR_PRINT, '-', \"Print CMS Receipt Request\" },",
          "",
          "[Removed Lines]",
          "134:     {\"nooldmime\", OPT_NOOLDMIME, '-'},",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "347:         case OPT_NOINDEF:",
          "348:             flags &= ~CMS_STREAM;",
          "349:             break;",
          "353:         case OPT_CRLFEOL:",
          "354:             mime_eol = \"\\r\\n\";",
          "355:             flags |= CMS_CRLFEOL;",
          "",
          "[Removed Lines]",
          "350:         case OPT_NOOLDMIME:",
          "351:             flags |= CMS_NOOLDMIMETYPE;",
          "352:             break;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "apps/smime.c||apps/smime.c": [
          "File: apps/smime.c -> apps/smime.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "37:     OPT_PK7OUT, OPT_TEXT, OPT_NOINTERN, OPT_NOVERIFY, OPT_NOCHAIN,",
          "38:     OPT_NOCERTS, OPT_NOATTR, OPT_NODETACH, OPT_NOSMIMECAP,",
          "39:     OPT_BINARY, OPT_NOSIGS, OPT_STREAM, OPT_INDEF, OPT_NOINDEF,",
          "41:     OPT_TO, OPT_FROM, OPT_SUBJECT, OPT_SIGNER, OPT_RECIP, OPT_MD,",
          "42:     OPT_CIPHER, OPT_INKEY, OPT_KEYFORM, OPT_CERTFILE, OPT_CAFILE,",
          "43:     OPT_V_ENUM,",
          "",
          "[Removed Lines]",
          "40:     OPT_NOOLDMIME, OPT_CRLFEOL, OPT_RAND, OPT_ENGINE, OPT_PASSIN,",
          "",
          "[Added Lines]",
          "40:     OPT_CRLFEOL, OPT_RAND, OPT_ENGINE, OPT_PASSIN,",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "95:     {\"stream\", OPT_STREAM, '-', \"Enable CMS streaming\" },",
          "96:     {\"indef\", OPT_INDEF, '-', \"Same as -stream\" },",
          "97:     {\"noindef\", OPT_NOINDEF, '-', \"Disable CMS streaming\"},",
          "99:     {\"crlfeol\", OPT_CRLFEOL, '-', \"Use CRLF as EOL termination instead of CR only\"},",
          "100:     {\"rand\", OPT_RAND, 's',",
          "101:      \"Load the file(s) into the random number generator\"},",
          "",
          "[Removed Lines]",
          "98:     {\"nooldmime\", OPT_NOOLDMIME, '-', NULL},",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "221:         case OPT_NOINDEF:",
          "222:             indef = 0;",
          "223:             break;",
          "227:         case OPT_CRLFEOL:",
          "228:             flags |= PKCS7_CRLFEOL;",
          "229:             mime_eol = \"\\r\\n\";",
          "",
          "[Removed Lines]",
          "224:         case OPT_NOOLDMIME:",
          "225:             flags |= PKCS7_NOOLDMIMETYPE;",
          "226:             break;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}