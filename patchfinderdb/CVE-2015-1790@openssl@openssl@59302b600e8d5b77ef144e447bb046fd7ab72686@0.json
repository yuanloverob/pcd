{
  "cve_id": "CVE-2015-1790",
  "cve_desc": "The PKCS7_dataDecodefunction in crypto/pkcs7/pk7_doit.c in OpenSSL before 0.9.8zg, 1.0.0 before 1.0.0s, 1.0.1 before 1.0.1n, and 1.0.2 before 1.0.2b allows remote attackers to cause a denial of service (NULL pointer dereference and application crash) via a PKCS#7 blob that uses ASN.1 encoding and lacks inner EncryptedContent data.",
  "repo": "openssl/openssl",
  "patch_hash": "59302b600e8d5b77ef144e447bb046fd7ab72686",
  "patch_info": {
    "commit_hash": "59302b600e8d5b77ef144e447bb046fd7ab72686",
    "repo": "openssl/openssl",
    "commit_url": "https://github.com/openssl/openssl/commit/59302b600e8d5b77ef144e447bb046fd7ab72686",
    "files": [
      "crypto/pkcs7/pk7_doit.c"
    ],
    "message": "PKCS#7: Fix NULL dereference with missing EncryptedContent.\n\nCVE-2015-1790\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
    "before_after_code_files": [
      "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
    ]
  },
  "patch_diff": {
    "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
      "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "468:         goto err;",
      "469:     }",
      "472:     if (md_sk != NULL) {",
      "473:         for (i = 0; i < sk_X509_ALGOR_num(md_sk); i++) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "480:     if (data_body == NULL && in_bio == NULL) {",
      "481:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
      "482:         goto err;",
      "483:     }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "593:             BIO_push(out, etmp);",
      "594:         etmp = NULL;",
      "595:     }",
      "597:         bio = in_bio;",
      "598:     } else {",
      "599:         if (data_body->length > 0)",
      "",
      "[Removed Lines]",
      "596:     if (PKCS7_is_detached(p7) || (in_bio != NULL)) {",
      "",
      "[Added Lines]",
      "610:     if (in_bio != NULL) {",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "c225c3cf9bd67297fb0c297768d69cbc03fbdab7",
      "candidate_info": {
        "commit_hash": "c225c3cf9bd67297fb0c297768d69cbc03fbdab7",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/c225c3cf9bd67297fb0c297768d69cbc03fbdab7",
        "files": [
          "crypto/pkcs7/pk7_doit.c",
          "crypto/pkcs7/pk7_lib.c"
        ],
        "message": "PKCS#7: avoid NULL pointer dereferences with missing content\n\nIn PKCS#7, the ASN.1 content component is optional.\nThis typically applies to inner content (detached signatures),\nhowever we must also handle unexpected missing outer content\ncorrectly.\n\nThis patch only addresses functions reachable from parsing,\ndecryption and verification, and functions otherwise associated\nwith reading potentially untrusted data.\n\nCorrecting all low-level API calls requires further work.\n\nCVE-2015-0289\n\nThanks to Michal Zalewski (Google) for reporting this issue.\n\nReviewed-by: Steve Henson <steve@openssl.org>",
        "before_after_code_files": [
          "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c",
          "crypto/pkcs7/pk7_lib.c||crypto/pkcs7/pk7_lib.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ],
          "candidate": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ]
        }
      },
      "candidate_diff": {
        "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
          "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "261:     PKCS7_RECIP_INFO *ri = NULL;",
          "262:     ASN1_OCTET_STRING *os = NULL;",
          "264:     i = OBJ_obj2nid(p7->type);",
          "265:     p7->state = PKCS7_S_HEADER;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "264:     if (p7 == NULL) {",
          "265:         PKCS7err(PKCS7_F_PKCS7_DATAINIT, PKCS7_R_INVALID_NULL_POINTER);",
          "266:         return NULL;",
          "267:     }",
          "278:     if (p7->d.ptr == NULL) {",
          "279:         PKCS7err(PKCS7_F_PKCS7_DATAINIT, PKCS7_R_NO_CONTENT);",
          "280:         return NULL;",
          "281:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "411:     unsigned char *ek = NULL, *tkey = NULL;",
          "412:     int eklen = 0, tkeylen = 0;",
          "414:     i = OBJ_obj2nid(p7->type);",
          "415:     p7->state = PKCS7_S_HEADER;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "433:     if (p7 == NULL) {",
          "434:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_INVALID_NULL_POINTER);",
          "435:         return NULL;",
          "436:     }",
          "438:     if (p7->d.ptr == NULL) {",
          "439:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
          "440:         return NULL;",
          "441:     }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "683:     STACK_OF(PKCS7_SIGNER_INFO) *si_sk = NULL;",
          "684:     ASN1_OCTET_STRING *os = NULL;",
          "686:     EVP_MD_CTX_init(&ctx_tmp);",
          "687:     i = OBJ_obj2nid(p7->type);",
          "688:     p7->state = PKCS7_S_HEADER;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "715:     if (p7 == NULL) {",
          "716:         PKCS7err(PKCS7_F_PKCS7_DATAFINAL, PKCS7_R_INVALID_NULL_POINTER);",
          "717:         return 0;",
          "718:     }",
          "720:     if (p7->d.ptr == NULL) {",
          "721:         PKCS7err(PKCS7_F_PKCS7_DATAFINAL, PKCS7_R_NO_CONTENT);",
          "722:         return 0;",
          "723:     }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "723:         if (PKCS7_type_is_data(p7->d.sign->contents) && p7->detached) {",
          "724:             M_ASN1_OCTET_STRING_free(os);",
          "725:             p7->d.sign->contents->d.data = NULL;",
          "726:         }",
          "727:         break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "764:             os = NULL;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "732:         if (PKCS7_type_is_data(p7->d.digest->contents) && p7->detached) {",
          "733:             M_ASN1_OCTET_STRING_free(os);",
          "734:             p7->d.digest->contents->d.data = NULL;",
          "735:         }",
          "736:         break;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "774:             os = NULL;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "796:         M_ASN1_OCTET_STRING_set(p7->d.digest->digest, md_data, md_len);",
          "797:     }",
          "815:     }",
          "816:     ret = 1;",
          "817:  err:",
          "",
          "[Removed Lines]",
          "799:     if (!PKCS7_is_detached(p7) && !(os->flags & ASN1_STRING_FLAG_NDEF)) {",
          "800:         char *cont;",
          "801:         long contlen;",
          "802:         btmp = BIO_find_type(bio, BIO_TYPE_MEM);",
          "803:         if (btmp == NULL) {",
          "804:             PKCS7err(PKCS7_F_PKCS7_DATAFINAL, PKCS7_R_UNABLE_TO_FIND_MEM_BIO);",
          "805:             goto err;",
          "806:         }",
          "807:         contlen = BIO_get_mem_data(btmp, &cont);",
          "812:         BIO_set_flags(btmp, BIO_FLAGS_MEM_RDONLY);",
          "813:         BIO_set_mem_eof_return(btmp, 0);",
          "814:         ASN1_STRING_set0(os, (unsigned char *)cont, contlen);",
          "",
          "[Added Lines]",
          "840:     if (!PKCS7_is_detached(p7)) {",
          "845:         if (os == NULL)",
          "846:             goto err;",
          "847:         if (!(os->flags & ASN1_STRING_FLAG_NDEF)) {",
          "848:             char *cont;",
          "849:             long contlen;",
          "850:             btmp = BIO_find_type(bio, BIO_TYPE_MEM);",
          "851:             if (btmp == NULL) {",
          "852:                 PKCS7err(PKCS7_F_PKCS7_DATAFINAL, PKCS7_R_UNABLE_TO_FIND_MEM_BIO);",
          "853:                 goto err;",
          "854:             }",
          "855:             contlen = BIO_get_mem_data(btmp, &cont);",
          "860:             BIO_set_flags(btmp, BIO_FLAGS_MEM_RDONLY);",
          "861:             BIO_set_mem_eof_return(btmp, 0);",
          "862:             ASN1_STRING_set0(os, (unsigned char *)cont, contlen);",
          "863:         }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "886:     STACK_OF(X509) *cert;",
          "887:     X509 *x509;",
          "889:     if (PKCS7_type_is_signed(p7)) {",
          "890:         cert = p7->d.sign->cert;",
          "891:     } else if (PKCS7_type_is_signedAndEnveloped(p7)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "938:     if (p7 == NULL) {",
          "939:         PKCS7err(PKCS7_F_PKCS7_DATAVERIFY, PKCS7_R_INVALID_NULL_POINTER);",
          "940:         return 0;",
          "941:     }",
          "943:     if (p7->d.ptr == NULL) {",
          "944:         PKCS7err(PKCS7_F_PKCS7_DATAVERIFY, PKCS7_R_NO_CONTENT);",
          "945:         return 0;",
          "946:     }",
          "",
          "---------------"
        ],
        "crypto/pkcs7/pk7_lib.c||crypto/pkcs7/pk7_lib.c": [
          "File: crypto/pkcs7/pk7_lib.c -> crypto/pkcs7/pk7_lib.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "445: STACK_OF(PKCS7_SIGNER_INFO) *PKCS7_get_signer_info(PKCS7 *p7)",
          "446: {",
          "447:     if (PKCS7_type_is_signed(p7)) {",
          "448:         return (p7->d.sign->signer_info);",
          "449:     } else if (PKCS7_type_is_signedAndEnveloped(p7)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "448:     if (p7 == NULL || p7->d.ptr == NULL)",
          "449:         return NULL;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "582f1f41d49b5bf5ceaca241356d5f9c986f230f",
      "candidate_info": {
        "commit_hash": "582f1f41d49b5bf5ceaca241356d5f9c986f230f",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/582f1f41d49b5bf5ceaca241356d5f9c986f230f",
        "files": [
          "crypto/pkcs7/pk7_doit.c"
        ],
        "message": "PKCS#7: Fix NULL dereference with missing EncryptedContent.\n\nCVE-2015-1790\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
        "before_after_code_files": [
          "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ],
          "candidate": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ]
        }
      },
      "candidate_diff": {
        "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
          "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "390:         goto err;",
          "391:     }",
          "394:     if (md_sk != NULL) {",
          "395:         for (i = 0; i < sk_X509_ALGOR_num(md_sk); i++) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "402:     if (data_body == NULL && in_bio == NULL) {",
          "403:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
          "404:         goto err;",
          "405:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "557:         etmp = NULL;",
          "558:     }",
          "559: #if 1",
          "561:         bio = in_bio;",
          "562:     } else {",
          "563: # if 0",
          "",
          "[Removed Lines]",
          "560:     if (PKCS7_is_detached(p7) || (in_bio != NULL)) {",
          "",
          "[Added Lines]",
          "574:     if (in_bio != NULL) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7bc2aee4f196f9b049416dfb08fc3a271755c0d8",
      "candidate_info": {
        "commit_hash": "7bc2aee4f196f9b049416dfb08fc3a271755c0d8",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/7bc2aee4f196f9b049416dfb08fc3a271755c0d8",
        "files": [
          "crypto/pkcs7/pk7_doit.c"
        ],
        "message": "PKCS#7: Fix NULL dereference with missing EncryptedContent.\n\nCVE-2015-1790\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
        "before_after_code_files": [
          "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ],
          "candidate": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ]
        }
      },
      "candidate_diff": {
        "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
          "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:         goto err;",
          "482:     }",
          "485:     if (md_sk != NULL) {",
          "486:         for (i = 0; i < sk_X509_ALGOR_num(md_sk); i++) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "493:     if (data_body == NULL && in_bio == NULL) {",
          "494:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
          "495:         goto err;",
          "496:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "623:         etmp = NULL;",
          "624:     }",
          "625: #if 1",
          "627:         bio = in_bio;",
          "628:     } else {",
          "629: # if 0",
          "",
          "[Removed Lines]",
          "626:     if (PKCS7_is_detached(p7) || (in_bio != NULL)) {",
          "",
          "[Added Lines]",
          "640:     if (in_bio != NULL) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f46e8095aa16ed61411ab4c231570762261df438",
      "candidate_info": {
        "commit_hash": "f46e8095aa16ed61411ab4c231570762261df438",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/f46e8095aa16ed61411ab4c231570762261df438",
        "files": [
          "crypto/pkcs7/pk7_doit.c"
        ],
        "message": "PKCS#7: Fix NULL dereference with missing EncryptedContent.\n\nCVE-2015-1790\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
        "before_after_code_files": [
          "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ],
          "candidate": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ]
        }
      },
      "candidate_diff": {
        "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
          "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:         goto err;",
          "482:     }",
          "485:     if (md_sk != NULL) {",
          "486:         for (i = 0; i < sk_X509_ALGOR_num(md_sk); i++) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "493:     if (data_body == NULL && in_bio == NULL) {",
          "494:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
          "495:         goto err;",
          "496:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "623:         etmp = NULL;",
          "624:     }",
          "625: #if 1",
          "627:         bio = in_bio;",
          "628:     } else {",
          "629: # if 0",
          "",
          "[Removed Lines]",
          "626:     if (PKCS7_is_detached(p7) || (in_bio != NULL)) {",
          "",
          "[Added Lines]",
          "640:     if (in_bio != NULL) {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "5fbc59cac60db4d7c3172152b8bdafe0c675fabd",
      "candidate_info": {
        "commit_hash": "5fbc59cac60db4d7c3172152b8bdafe0c675fabd",
        "repo": "openssl/openssl",
        "commit_url": "https://github.com/openssl/openssl/commit/5fbc59cac60db4d7c3172152b8bdafe0c675fabd",
        "files": [
          "crypto/pkcs7/pk7_doit.c"
        ],
        "message": "PKCS#7: Fix NULL dereference with missing EncryptedContent.\n\nCVE-2015-1790\n\nReviewed-by: Rich Salz <rsalz@openssl.org>",
        "before_after_code_files": [
          "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ],
          "candidate": [
            "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c"
          ]
        }
      },
      "candidate_diff": {
        "crypto/pkcs7/pk7_doit.c||crypto/pkcs7/pk7_doit.c": [
          "File: crypto/pkcs7/pk7_doit.c -> crypto/pkcs7/pk7_doit.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "481:         goto err;",
          "482:     }",
          "485:     if (md_sk != NULL) {",
          "486:         for (i = 0; i < sk_X509_ALGOR_num(md_sk); i++) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "493:     if (data_body == NULL && in_bio == NULL) {",
          "494:         PKCS7err(PKCS7_F_PKCS7_DATADECODE, PKCS7_R_NO_CONTENT);",
          "495:         goto err;",
          "496:     }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "623:         etmp = NULL;",
          "624:     }",
          "625: #if 1",
          "627:         bio = in_bio;",
          "628:     } else {",
          "629: # if 0",
          "",
          "[Removed Lines]",
          "626:     if (PKCS7_is_detached(p7) || (in_bio != NULL)) {",
          "",
          "[Added Lines]",
          "640:     if (in_bio != NULL) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}