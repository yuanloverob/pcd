{
  "cve_id": "CVE-2019-19923",
  "cve_desc": "flattenSubquery in select.c in SQLite 3.30.1 mishandles certain uses of SELECT DISTINCT involving a LEFT JOIN in which the right-hand side is a view. This can cause a NULL pointer dereference (or incorrect results).",
  "repo": "sqlite/sqlite",
  "patch_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
  "patch_info": {
    "commit_hash": "396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/396afe6f6aa90a31303c183e11b2b2d4b7956b35",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/select.c",
      "test/join.test"
    ],
    "message": "Continue to back away from the LEFT JOIN optimization of check-in [41c27bc0ff1d3135] by disallowing query flattening if the outer query is DISTINCT.  Without this fix, if an index scan is run on the table within the view on the right-hand side of the LEFT JOIN, stale result registers might be accessed yielding incorrect results, and/or an OP_IfNullRow opcode might be invoked on the un-opened table, resulting in a NULL-pointer dereference.  This problem was found by the Yongheng and Rui fuzzer.\n\nFossilOrigin-Name: 862974312edf00e9d1068115d1a39b7235b7db68b6d86b81d38a12f025a4748e",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/select.c||src/select.c",
      "test/join.test||test/join.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 289158aa24b066c453d2bce4bc2dead1c56fb0b23c3f7c4810b34b13627cef34",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/select.c||src/select.c": [
      "File: src/select.c -> src/select.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "3797:   if( (pSubitem->fg.jointype & JT_OUTER)!=0 ){",
      "3798:     isLeftJoin = 1;",
      "3801:       return 0;",
      "3802:     }",
      "3803:   }",
      "",
      "[Removed Lines]",
      "3799:     if( pSubSrc->nSrc>1 || isAgg || IsVirtual(pSubSrc->a[0].pTab) ){",
      "",
      "[Added Lines]",
      "3804:     ){",
      "",
      "---------------"
    ],
    "test/join.test||test/join.test": [
      "File: test/join.test -> test/join.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "975:   SELECT 24, * FROM t1 LEFT JOIN t0 ON +aa ISNULL;",
      "976: } {13 1 {} 14 1 {} 23 1 {} 24 1 {}}",
      "978: finish_test",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "978: # 2019-12-18 problem with a LEFT JOIN where the RHS is a view.",
      "979: # Detected by Yongheng and Rui.",
      "980: # Follows from the optimization attempt of check-in 41c27bc0ff1d3135",
      "981: # on 2017-04-18",
      "982: #",
      "983: reset_db",
      "984: do_execsql_test join-22.10 {",
      "985:   CREATE TABLE t0(a, b);",
      "986:   CREATE INDEX t0a ON t0(a);",
      "987:   INSERT INTO t0 VALUES(10,10),(10,11),(10,12);",
      "988:   SELECT DISTINCT c FROM t0 LEFT JOIN (SELECT a+1 AS c FROM t0) ORDER BY c ;",
      "989: } {11}",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "89b6de0357a499209c13cf66a3cc406f26f67e6f",
      "candidate_info": {
        "commit_hash": "89b6de0357a499209c13cf66a3cc406f26f67e6f",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/89b6de0357a499209c13cf66a3cc406f26f67e6f",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c"
        ],
        "message": "Remove an ALWAYS() from a branch that is not always taken.  The test case found by OSSFuzz has been added to TH3.\n\nFossilOrigin-Name: 5c7dab85535ac42c021977dbd4a39cef5a72e3d9dccff1c5ca5570a1780516cd",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 23b62fb160d86dc9d9073bcc714601f5b7695f96abd893eafecf4b2e565b87f2",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "4778:     }",
          "4779:   }",
          "4780:   if( (pA->flags & EP_Distinct)!=(pB->flags & EP_Distinct) ) return 2;",
          "4782:     if( combinedFlags & EP_xIsSelect ) return 2;",
          "4783:     if( (combinedFlags & EP_FixedCol)==0",
          "4784:      && sqlite3ExprCompare(pParse, pA->pLeft, pB->pLeft, iTab) ) return 2;",
          "",
          "[Removed Lines]",
          "4781:   if( ALWAYS((combinedFlags & EP_TokenOnly)==0) ){",
          "",
          "[Added Lines]",
          "4781:   if( (combinedFlags & EP_TokenOnly)==0 ){",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "554a19dbeef3c45d5f52c540a79920403c54170a",
      "candidate_info": {
        "commit_hash": "554a19dbeef3c45d5f52c540a79920403c54170a",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/554a19dbeef3c45d5f52c540a79920403c54170a",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/btree.c",
          "test/insert.test"
        ],
        "message": "Make sure the btree cursor overflow cache is cleared when overwriting a cell in sqlite3BtreeInsert().  Ticket [3cf9bb227e9a5d32]\n\nFossilOrigin-Name: 7dae7b969ed314605a3a2da2cfdce4d81152740f5d3bfbc2a6e311b13ee325a7",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/btree.c||src/btree.c",
          "test/insert.test||test/insert.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 636ca4472c9f41eb3989f28854d4968867837399a2092f389d1b814d98cccbae",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/btree.c||src/btree.c": [
          "File: src/btree.c -> src/btree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "8716:       memcpy(newCell, oldCell, 4);",
          "8717:     }",
          "8718:     rc = clearCell(pPage, oldCell, &info);",
          "8719:     if( info.nSize==szNew && info.nLocal==info.nPayload",
          "8720:      && (!ISAUTOVACUUM || szNew<pPage->minLocal)",
          "8721:     ){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "8719:     testcase( pCur->curFlags & BTCF_ValidOvfl );",
          "8720:     invalidateOverflowCache(pCur);",
          "",
          "---------------"
        ],
        "test/insert.test||test/insert.test": [
          "File: test/insert.test -> test/insert.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "461: integrity_check insert-99.0",
          "463: finish_test",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "463: # 2019-08-12.",
          "464: #",
          "465: do_execsql_test insert-15.1 {",
          "466:   DROP TABLE IF EXISTS t1;",
          "467:   DROP TABLE IF EXISTS t2;",
          "468:   CREATE TABLE t1(a INTEGER PRIMARY KEY, b TEXT);",
          "469:   CREATE INDEX i1 ON t1(b);",
          "470:   CREATE TABLE t2(a, b);",
          "471:   INSERT INTO t2 VALUES(4, randomblob(31000));",
          "472:   INSERT INTO t2 VALUES(4, randomblob(32000));",
          "473:   INSERT INTO t2 VALUES(4, randomblob(33000));",
          "474:   REPLACE INTO t1 SELECT a, b FROM t2;",
          "475:   SELECT a, length(b) FROM t1;",
          "476: } {4 33000}",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4e2d3d40dcc32a70d3a481bae9a5707fc93237fc",
      "candidate_info": {
        "commit_hash": "4e2d3d40dcc32a70d3a481bae9a5707fc93237fc",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/4e2d3d40dcc32a70d3a481bae9a5707fc93237fc",
        "files": [
          "Makefile.msc",
          "ext/session/changesetfuzz.c",
          "manifest",
          "manifest.uuid",
          "src/btree.c",
          "tool/dbtotxt.c"
        ],
        "message": "Fix harmless compiler warnings seen with MSVC.\n\nFossilOrigin-Name: 6cf8b18ec20f11c25ff7396f29c742404d3a88d5e97a5fd53ccfaff51dec3f33",
        "before_after_code_files": [
          "Makefile.msc||Makefile.msc",
          "ext/session/changesetfuzz.c||ext/session/changesetfuzz.c",
          "manifest.uuid||manifest.uuid",
          "src/btree.c||src/btree.c",
          "tool/dbtotxt.c||tool/dbtotxt.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "Makefile.msc||Makefile.msc": [
          "File: Makefile.msc -> Makefile.msc",
          "--- Hunk 1 ---",
          "[Context before]",
          "2560:  del /Q .target_source 2>NUL",
          "2561:  del /Q tclsqlite3.exe $(SQLITETCLH) $(SQLITETCLDECLSH) 2>NUL",
          "2562:  del /Q lsm.dll lsmtest.exe 2>NUL",
          "2563:  del /Q testloadext.dll 2>NUL",
          "2564:  del /Q testfixture.exe test.db 2>NUL",
          "2565:  del /Q LogEst.exe fts3view.exe rollback-test.exe showdb.exe dbdump.exe 2>NUL",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2563:  del /Q atrc.exe changesetfuzz.exe dbtotxt.exe index_usage.exe 2>NUL",
          "",
          "---------------"
        ],
        "ext/session/changesetfuzz.c||ext/session/changesetfuzz.c": [
          "File: ext/session/changesetfuzz.c -> ext/session/changesetfuzz.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "154:   pBuf = sqlite3_malloc64( sz ? sz : 1 );",
          "155:   if( pBuf==0 ){",
          "156:     fprintf(stderr, \"cannot allocate %d to hold content of \\\"%s\\\"\\n\",",
          "158:     exit(1);",
          "159:   }",
          "160:   if( sz>0 ){",
          "163:       exit(1);",
          "164:     }",
          "165:     fclose(f);",
          "166:   }",
          "169: }",
          "",
          "[Removed Lines]",
          "157:             sz, zFilename);",
          "161:     if( fread(pBuf, sz, 1, f)!=1 ){",
          "162:       fprintf(stderr, \"cannot read all %d bytes of \\\"%s\\\"\\n\", sz, zFilename);",
          "",
          "[Added Lines]",
          "157:             (int)sz, zFilename);",
          "161:     if( fread(pBuf, (size_t)sz, 1, f)!=1 ){",
          "162:       fprintf(stderr, \"cannot read all %d bytes of \\\"%s\\\"\\n\",",
          "163:               (int)sz, zFilename);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "343: static void *fuzzMalloc(sqlite3_int64 nByte){",
          "344:   void *pRet = sqlite3_malloc64(nByte);",
          "345:   if( pRet ){",
          "347:   }",
          "348:   return pRet;",
          "349: }",
          "",
          "[Removed Lines]",
          "346:     memset(pRet, 0, nByte);",
          "",
          "[Added Lines]",
          "347:     memset(pRet, 0, (size_t)nByte);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "384: static int fuzzPutVarint(u8 *p, int nVal){",
          "385:   assert( nVal>0 && nVal<2097152 );",
          "386:   if( nVal<128 ){",
          "388:     return 1;",
          "389:   }",
          "390:   if( nVal<16384 ){",
          "",
          "[Removed Lines]",
          "387:     p[0] = nVal;",
          "",
          "[Added Lines]",
          "388:     p[0] = (u8)nVal;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "459:       pGrp->aPK = p;",
          "460:       p += pGrp->nCol;",
          "461:       pGrp->zTab = (const char*)p;",
          "464:       if( p>=pEnd ){",
          "465:         rc = fuzzCorrupt();",
          "",
          "[Removed Lines]",
          "462:       p = &p[strlen(p)+1];",
          "",
          "[Added Lines]",
          "463:       p = &p[strlen((const char*)p)+1];",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "697:           int nTxt;",
          "700:           p += fuzzGetVarint(p, &nTxt);",
          "701:           printf(\"%s%s\", zPre, eType==0x03 ? \"'\" : \"X'\");",
          "702:           for(i=0; i<nTxt; i++){",
          "",
          "[Removed Lines]",
          "698:           int sz;",
          "699:           int i;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "861:           int nByte = fuzzRandomInt(48);",
          "863:           fuzzRandomBlob(nByte, &pChange->aSub[2]);",
          "864:           if( pChange->aSub[0]==0x03 ){",
          "865:             int i;",
          "",
          "[Removed Lines]",
          "862:           pChange->aSub[1] = nByte;",
          "",
          "[Added Lines]",
          "861:           pChange->aSub[1] = (u8)nByte;",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1004:       }else if( p==pFuzz->pSub2 ){",
          "1005:         pCopy = pFuzz->pSub1;",
          "1006:       }else if( i==iUndef ){",
          "1008:       }",
          "1010:       if( pCopy[0]==0x00 && eNew!=eType && eType==SQLITE_UPDATE && iRec==0 ){",
          "",
          "[Removed Lines]",
          "1007:         pCopy = \"\\0\";",
          "",
          "[Added Lines]",
          "1006:         pCopy = (u8*)\"\\0\";",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1067:       for(i=0; i<pGrp->nCol; i++){",
          "1068:         int sz;",
          "1069:         u8 *pCopy = pCsr;",
          "1071:         fuzzChangeSize(pCopy, &sz);",
          "1072:         memcpy(pOut, pCopy, sz);",
          "1073:         pOut += sz;",
          "",
          "[Removed Lines]",
          "1070:         if( pGrp->aPK[i] ) pCopy = \"\\0\";",
          "",
          "[Added Lines]",
          "1069:         if( pGrp->aPK[i] ) pCopy = (u8*)\"\\0\";",
          "",
          "---------------"
        ],
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 8af0caeb6d1e55f66ad2f12af94845dccfe1d0420faf326f5917fc07f8aa6050",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/btree.c||src/btree.c": [
          "File: src/btree.c -> src/btree.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "834: static int btreeRestoreCursorPosition(BtCursor *pCur){",
          "835:   int rc;",
          "837:   assert( cursorOwnsBtShared(pCur) );",
          "838:   assert( pCur->eState>=CURSOR_REQUIRESEEK );",
          "839:   if( pCur->eState==CURSOR_FAULT ){",
          "",
          "[Removed Lines]",
          "836:   int skipNext;",
          "",
          "[Added Lines]",
          "836:   int skipNext = 0;",
          "",
          "---------------"
        ],
        "tool/dbtotxt.c||tool/dbtotxt.c": [
          "File: tool/dbtotxt.c -> tool/dbtotxt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "52:   memset(bShow, '.', sizeof(bShow));",
          "53:   for(i=' '; i<='~'; i++){",
          "55:   }",
          "56:   for(i=1; i<argc; i++){",
          "57:     if( argv[i][0]=='-' ){",
          "",
          "[Removed Lines]",
          "54:     if( i!='{' && i!='}' && i!='\"' && i!='\\\\' ) bShow[i] = i;",
          "",
          "[Added Lines]",
          "54:     if( i!='{' && i!='}' && i!='\"' && i!='\\\\' ) bShow[i] = (unsigned char)i;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
      "candidate_info": {
        "commit_hash": "844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/844b9004917ac2843eb1eb15c4b2e5cfbf8b5a7b",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/tokenize.c"
        ],
        "message": "Fix harmless compiler warning.\n\nFossilOrigin-Name: dddda685f3443d8a38901f758543fcde73d7b8cfe72b0ad5f419cd7459343bf5",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/tokenize.c||src/tokenize.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 1aee70d6de8a9b17ebb74a7cb1dad65139cde1b615dcce4d15d3a476fda8676b",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/tokenize.c||src/tokenize.c": [
          "File: src/tokenize.c -> src/tokenize.c"
        ]
      }
    },
    {
      "candidate_hash": "c930b405f0717d5f8626dd846f3ab1d2a7243195",
      "candidate_info": {
        "commit_hash": "c930b405f0717d5f8626dd846f3ab1d2a7243195",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c930b405f0717d5f8626dd846f3ab1d2a7243195",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/func.c"
        ],
        "message": "Performance improvement on the instr() function, especially for large haystacks.\n\nFossilOrigin-Name: ce51f1a2b6a1789a5876e01cf829e45d84f3851d135a2fa5c44a56f948673a60",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/func.c||src/func.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 63eb803dbc27077007dbee8def659d1523724eb73f1def1cdb68027e5c20843a",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/func.c||src/func.c": [
          "File: src/func.c -> src/func.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "201:   int typeHaystack, typeNeedle;",
          "202:   int N = 1;",
          "203:   int isText;",
          "205:   UNUSED_PARAMETER(argc);",
          "206:   typeHaystack = sqlite3_value_type(argv[0]);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "204:   unsigned char firstChar;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "219:       isText = 1;",
          "220:     }",
          "221:     if( zNeedle==0 || (nHaystack && zHaystack==0) ) return;",
          "223:       N++;",
          "224:       do{",
          "225:         nHaystack--;",
          "",
          "[Removed Lines]",
          "222:     while( nNeedle<=nHaystack && memcmp(zHaystack, zNeedle, nNeedle)!=0 ){",
          "",
          "[Added Lines]",
          "223:     firstChar = zNeedle[0];",
          "224:     while( nNeedle<=nHaystack",
          "225:        && (zHaystack[0]!=firstChar || memcmp(zHaystack, zNeedle, nNeedle)!=0)",
          "226:     ){",
          "",
          "---------------"
        ]
      }
    }
  ]
}