{
  "cve_id": "CVE-2014-3631",
  "cve_desc": "The assoc_array_gc function in the associative-array implementation in lib/assoc_array.c in the Linux kernel before 3.16.3 does not properly implement garbage collection, which allows local users to cause a denial of service (NULL pointer dereference and system crash) or possibly have unspecified other impact via multiple \"keyctl newring\" operations followed by a \"keyctl timeout\" operation.",
  "repo": "torvalds/linux",
  "patch_hash": "95389b08d93d5c06ec63ab49bd732b0069b7c35e",
  "patch_info": {
    "commit_hash": "95389b08d93d5c06ec63ab49bd732b0069b7c35e",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/95389b08d93d5c06ec63ab49bd732b0069b7c35e",
    "files": [
      "lib/assoc_array.c"
    ],
    "message": "KEYS: Fix termination condition in assoc array garbage collection\n\nThis fixes CVE-2014-3631.\n\nIt is possible for an associative array to end up with a shortcut node at the\nroot of the tree if there are more than fan-out leaves in the tree, but they\nall crowd into the same slot in the lowest level (ie. they all have the same\nfirst nibble of their index keys).\n\nWhen assoc_array_gc() returns back up the tree after scanning some leaves, it\ncan fall off of the root and crash because it assumes that the back pointer\nfrom a shortcut (after label ascend_old_tree) must point to a normal node -\nwhich isn't true of a shortcut node at the root.\n\nShould we find we're ascending rootwards over a shortcut, we should check to\nsee if the backpointer is zero - and if it is, we have completed the scan.\n\nThis particular bug cannot occur if the root node is not a shortcut - ie. if\nyou have fewer than 17 keys in a keyring or if you have at least two keys that\nsit into separate slots (eg. a keyring and a non keyring).\n\nThis can be reproduced by:\n\n\tring=`keyctl newring bar @s`\n\tfor ((i=1; i<=18; i++)); do last_key=`keyctl newring foo$i $ring`; done\n\tkeyctl timeout $last_key 2\n\nDoing this:\n\n\techo 3 >/proc/sys/kernel/keys/gc_delay\n\nfirst will speed things up.\n\nIf we do fall off of the top of the tree, we get the following oops:\n\nBUG: unable to handle kernel NULL pointer dereference at 0000000000000018\nIP: [<ffffffff8136cea7>] assoc_array_gc+0x2f7/0x540\nPGD dae15067 PUD cfc24067 PMD 0\nOops: 0000 [#1] SMP\nModules linked in: xt_nat xt_mark nf_conntrack_netbios_ns nf_conntrack_broadcast ip6t_rpfilter ip6t_REJECT xt_conntrack ebtable_nat ebtable_broute bridge stp llc ebtable_filter ebtables ip6table_ni\nCPU: 0 PID: 26011 Comm: kworker/0:1 Not tainted 3.14.9-200.fc20.x86_64 #1\nHardware name: Bochs Bochs, BIOS Bochs 01/01/2011\nWorkqueue: events key_garbage_collector\ntask: ffff8800918bd580 ti: ffff8800aac14000 task.ti: ffff8800aac14000\nRIP: 0010:[<ffffffff8136cea7>] [<ffffffff8136cea7>] assoc_array_gc+0x2f7/0x540\nRSP: 0018:ffff8800aac15d40  EFLAGS: 00010206\nRAX: 0000000000000000 RBX: 0000000000000000 RCX: ffff8800aaecacc0\nRDX: ffff8800daecf440 RSI: 0000000000000001 RDI: ffff8800aadc2bc0\nRBP: ffff8800aac15da8 R08: 0000000000000001 R09: 0000000000000003\nR10: ffffffff8136ccc7 R11: 0000000000000000 R12: 0000000000000000\nR13: 0000000000000000 R14: 0000000000000070 R15: 0000000000000001\nFS:  0000000000000000(0000) GS:ffff88011fc00000(0000) knlGS:0000000000000000\nCS:  0010 DS: 0000 ES: 0000 CR0: 000000008005003b\nCR2: 0000000000000018 CR3: 00000000db10d000 CR4: 00000000000006f0\nStack:\n ffff8800aac15d50 0000000000000011 ffff8800aac15db8 ffffffff812e2a70\n ffff880091a00600 0000000000000000 ffff8800aadc2bc3 00000000cd42c987\n ffff88003702df20 ffff88003702dfa0 0000000053b65c09 ffff8800aac15fd8\nCall Trace:\n [<ffffffff812e2a70>] ? keyring_detect_cycle_iterator+0x30/0x30\n [<ffffffff812e3e75>] keyring_gc+0x75/0x80\n [<ffffffff812e1424>] key_garbage_collector+0x154/0x3c0\n [<ffffffff810a67b6>] process_one_work+0x176/0x430\n [<ffffffff810a744b>] worker_thread+0x11b/0x3a0\n [<ffffffff810a7330>] ? rescuer_thread+0x3b0/0x3b0\n [<ffffffff810ae1a8>] kthread+0xd8/0xf0\n [<ffffffff810ae0d0>] ? insert_kthread_work+0x40/0x40\n [<ffffffff816ffb7c>] ret_from_fork+0x7c/0xb0\n [<ffffffff810ae0d0>] ? insert_kthread_work+0x40/0x40\nCode: 08 4c 8b 22 0f 84 bf 00 00 00 41 83 c7 01 49 83 e4 fc 41 83 ff 0f 4c 89 65 c0 0f 8f 5a fe ff ff 48 8b 45 c0 4d 63 cf 49 83 c1 02 <4e> 8b 34 c8 4d 85 f6 0f 84 be 00 00 00 41 f6 c6 01 0f 84 92\nRIP  [<ffffffff8136cea7>] assoc_array_gc+0x2f7/0x540\n RSP <ffff8800aac15d40>\nCR2: 0000000000000018\n---[ end trace 1129028a088c0cbd ]---\n\nSigned-off-by: David Howells <dhowells@redhat.com>\nAcked-by: Don Zickus <dzickus@redhat.com>\nSigned-off-by: James Morris <james.l.morris@oracle.com>",
    "before_after_code_files": [
      "lib/assoc_array.c||lib/assoc_array.c"
    ]
  },
  "patch_diff": {
    "lib/assoc_array.c||lib/assoc_array.c": [
      "File: lib/assoc_array.c -> lib/assoc_array.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1723:   shortcut = assoc_array_ptr_to_shortcut(ptr);",
      "1724:   slot = shortcut->parent_slot;",
      "1725:   cursor = shortcut->back_pointer;",
      "1726:  } else {",
      "1727:   slot = node->parent_slot;",
      "1728:   cursor = ptr;",
      "1729:  }",
      "1731:  node = assoc_array_ptr_to_node(cursor);",
      "1732:  slot++;",
      "1733:  goto continue_node;",
      "",
      "[Removed Lines]",
      "1730:  BUG_ON(!ptr);",
      "",
      "[Added Lines]",
      "1726:   if (!cursor)",
      "1727:    goto gc_complete;",
      "1732:  BUG_ON(!cursor);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "20d412b2d805d650d1b820d41a80e023d6a98461",
      "candidate_info": {
        "commit_hash": "20d412b2d805d650d1b820d41a80e023d6a98461",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/20d412b2d805d650d1b820d41a80e023d6a98461",
        "files": [
          "arch/arm/boot/dts/imx28-evk.dts"
        ],
        "message": "ARM: dts: imx28-evk: Fix display duplicate name warning\n\nThe lcdif node has a property named \"display\" and also a child node\ncalled \"display\", which causes the following warning:\n\ndevice-tree: Duplicate name in lcdif@80030000, renamed to \"display#1\"\n\nRename the child node name in order to avoid the warning.\n\nSigned-off-by: Fabio Estevam <fabio.estevam@freescale.com>\nSigned-off-by: Shawn Guo <shawn.guo@freescale.com>",
        "before_after_code_files": [
          "arch/arm/boot/dts/imx28-evk.dts||arch/arm/boot/dts/imx28-evk.dts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/arm/boot/dts/imx28-evk.dts||arch/arm/boot/dts/imx28-evk.dts": [
          "File: arch/arm/boot/dts/imx28-evk.dts -> arch/arm/boot/dts/imx28-evk.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "124:     pinctrl-0 = <&lcdif_24bit_pins_a",
          "125:           &lcdif_pins_evk>;",
          "126:     lcd-supply = <&reg_lcd_3v3>;",
          "128:     status = \"okay\";",
          "131:      bits-per-pixel = <32>;",
          "132:      bus-width = <24>;",
          "",
          "[Removed Lines]",
          "127:     display = <&display>;",
          "130:     display: display {",
          "",
          "[Added Lines]",
          "127:     display = <&display0>;",
          "130:     display0: display0 {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7029b396b08aeb15d8cb23c4bff3e10c1f518238",
      "candidate_info": {
        "commit_hash": "7029b396b08aeb15d8cb23c4bff3e10c1f518238",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/7029b396b08aeb15d8cb23c4bff3e10c1f518238",
        "files": [
          "arch/arm/boot/dts/imx28-cfa10049.dts",
          "arch/arm/boot/dts/imx28-cfa10055.dts",
          "arch/arm/boot/dts/imx28-cfa10056.dts",
          "arch/arm/boot/dts/imx28-cfa10057.dts",
          "arch/arm/boot/dts/imx28-cfa10058.dts"
        ],
        "message": "ARM: dts: imx28-cfa100: Fix display duplicate name warning\n\nThe lcdif node has a property named \"display\" and also a child node\ncalled \"display\", which causes the following warning:\n\ndevice-tree: Duplicate name in lcdif@80030000, renamed to \"display#1\"\n\nRename the child node name in order to avoid the warning.\n\nSigned-off-by: Fabio Estevam <fabio.estevam@freescale.com>\nSigned-off-by: Shawn Guo <shawn.guo@freescale.com>",
        "before_after_code_files": [
          "arch/arm/boot/dts/imx28-cfa10049.dts||arch/arm/boot/dts/imx28-cfa10049.dts",
          "arch/arm/boot/dts/imx28-cfa10055.dts||arch/arm/boot/dts/imx28-cfa10055.dts",
          "arch/arm/boot/dts/imx28-cfa10056.dts||arch/arm/boot/dts/imx28-cfa10056.dts",
          "arch/arm/boot/dts/imx28-cfa10057.dts||arch/arm/boot/dts/imx28-cfa10057.dts",
          "arch/arm/boot/dts/imx28-cfa10058.dts||arch/arm/boot/dts/imx28-cfa10058.dts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/arm/boot/dts/imx28-cfa10049.dts||arch/arm/boot/dts/imx28-cfa10049.dts": [
          "File: arch/arm/boot/dts/imx28-cfa10049.dts -> arch/arm/boot/dts/imx28-cfa10049.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "177:     pinctrl-0 = <&lcdif_18bit_pins_cfa10049",
          "178:           &lcdif_pins_cfa10049",
          "179:           &lcdif_pins_cfa10049_pullup>;",
          "181:     status = \"okay\";",
          "184:      bits-per-pixel = <32>;",
          "185:      bus-width = <18>;",
          "",
          "[Removed Lines]",
          "180:     display = <&display>;",
          "183:     display: display {",
          "",
          "[Added Lines]",
          "180:     display = <&display0>;",
          "183:     display0: display0 {",
          "",
          "---------------"
        ],
        "arch/arm/boot/dts/imx28-cfa10055.dts||arch/arm/boot/dts/imx28-cfa10055.dts": [
          "File: arch/arm/boot/dts/imx28-cfa10055.dts -> arch/arm/boot/dts/imx28-cfa10055.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "92:     pinctrl-0 = <&lcdif_18bit_pins_cfa10055",
          "93:           &lcdif_pins_cfa10055",
          "94:           &lcdif_pins_cfa10055_pullup>;",
          "96:     status = \"okay\";",
          "99:      bits-per-pixel = <32>;",
          "100:      bus-width = <18>;",
          "",
          "[Removed Lines]",
          "95:     display = <&display>;",
          "98:     display: display {",
          "",
          "[Added Lines]",
          "95:     display = <&display0>;",
          "98:     display0: display0 {",
          "",
          "---------------"
        ],
        "arch/arm/boot/dts/imx28-cfa10056.dts||arch/arm/boot/dts/imx28-cfa10056.dts": [
          "File: arch/arm/boot/dts/imx28-cfa10056.dts -> arch/arm/boot/dts/imx28-cfa10056.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "64:     pinctrl-0 = <&lcdif_24bit_pins_a",
          "65:       &lcdif_pins_cfa10056",
          "66:       &lcdif_pins_cfa10056_pullup >;",
          "68:     status = \"okay\";",
          "71:      bits-per-pixel = <32>;",
          "72:      bus-width = <24>;",
          "",
          "[Removed Lines]",
          "67:     display = <&display>;",
          "70:     display: display {",
          "",
          "[Added Lines]",
          "67:     display = <&display0>;",
          "70:     display0: display0 {",
          "",
          "---------------"
        ],
        "arch/arm/boot/dts/imx28-cfa10057.dts||arch/arm/boot/dts/imx28-cfa10057.dts": [
          "File: arch/arm/boot/dts/imx28-cfa10057.dts -> arch/arm/boot/dts/imx28-cfa10057.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "78:     pinctrl-names = \"default\";",
          "79:     pinctrl-0 = <&lcdif_18bit_pins_cfa10057",
          "80:           &lcdif_pins_cfa10057>;",
          "82:     status = \"okay\";",
          "85:      bits-per-pixel = <32>;",
          "86:      bus-width = <18>;",
          "",
          "[Removed Lines]",
          "81:     display = <&display>;",
          "84:     display: display {",
          "",
          "[Added Lines]",
          "81:     display = <&display0>;",
          "84:     display0: display0 {",
          "",
          "---------------"
        ],
        "arch/arm/boot/dts/imx28-cfa10058.dts||arch/arm/boot/dts/imx28-cfa10058.dts": [
          "File: arch/arm/boot/dts/imx28-cfa10058.dts -> arch/arm/boot/dts/imx28-cfa10058.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "51:     pinctrl-names = \"default\";",
          "52:     pinctrl-0 = <&lcdif_24bit_pins_a",
          "53:        &lcdif_pins_cfa10058>;",
          "55:     status = \"okay\";",
          "58:      bits-per-pixel = <32>;",
          "59:      bus-width = <24>;",
          "",
          "[Removed Lines]",
          "54:     display = <&display>;",
          "57:     display: display {",
          "",
          "[Added Lines]",
          "54:     display = <&display0>;",
          "57:     display0: display0 {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ee99b4636b3108a3a6d92f1189b797006e4416e9",
      "candidate_info": {
        "commit_hash": "ee99b4636b3108a3a6d92f1189b797006e4416e9",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/ee99b4636b3108a3a6d92f1189b797006e4416e9",
        "files": [
          "arch/arm/boot/dts/imx28-apf28dev.dts"
        ],
        "message": "ARM: dts: imx28-apf28dev: Fix display duplicate name warning\n\nThe lcdif node has a property named \"display\" and also a child node\ncalled \"display\", which causes the following warning:\n\ndevice-tree: Duplicate name in lcdif@80030000, renamed to \"display#1\"\n\nRename the child node name in order to avoid the wa\n\nSigned-off-by: Fabio Estevam <fabio.estevam@freescale.com>\nSigned-off-by: Shawn Guo <shawn.guo@freescale.com>",
        "before_after_code_files": [
          "arch/arm/boot/dts/imx28-apf28dev.dts||arch/arm/boot/dts/imx28-apf28dev.dts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/arm/boot/dts/imx28-apf28dev.dts||arch/arm/boot/dts/imx28-apf28dev.dts": [
          "File: arch/arm/boot/dts/imx28-apf28dev.dts -> arch/arm/boot/dts/imx28-apf28dev.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "83:     pinctrl-names = \"default\";",
          "84:     pinctrl-0 = <&lcdif_16bit_pins_a",
          "85:       &lcdif_pins_apf28dev>;",
          "87:     status = \"okay\";",
          "90:      bits-per-pixel = <16>;",
          "91:      bus-width = <16>;",
          "",
          "[Removed Lines]",
          "86:     display = <&display>;",
          "89:     display: display {",
          "",
          "[Added Lines]",
          "86:     display = <&display0>;",
          "89:     display0: display0 {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "1bf1890e86869032099b539bc83b098be12fc5a7",
      "candidate_info": {
        "commit_hash": "1bf1890e86869032099b539bc83b098be12fc5a7",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/1bf1890e86869032099b539bc83b098be12fc5a7",
        "files": [
          "drivers/mtd/ubi/fastmap.c"
        ],
        "message": "UBI: add missing kmem_cache_free() in process_pool_aeb error path\n\nI ran into this error after a ubiupdatevol, because I forgot to backport\ne9110361a9a4 UBI: fix the volumes tree sorting criteria.\n\nUBI error: process_pool_aeb: orphaned volume in fastmap pool\nUBI error: ubi_scan_fastmap: Attach by fastmap failed, doing a full scan!\nkmem_cache_destroy ubi_ainf_peb_slab: Slab cache still has objects\nCPU: 0 PID: 1 Comm: swapper Not tainted 3.14.18-00053-gf05cac8dbf85 #1\n[<c000d298>] (unwind_backtrace) from [<c000baa8>] (show_stack+0x10/0x14)\n[<c000baa8>] (show_stack) from [<c01b7a68>] (destroy_ai+0x230/0x244)\n[<c01b7a68>] (destroy_ai) from [<c01b8fd4>] (ubi_attach+0x98/0x1ec)\n[<c01b8fd4>] (ubi_attach) from [<c01ade90>] (ubi_attach_mtd_dev+0x2b8/0x868)\n[<c01ade90>] (ubi_attach_mtd_dev) from [<c038b510>] (ubi_init+0x1dc/0x2ac)\n[<c038b510>] (ubi_init) from [<c0008860>] (do_one_initcall+0x94/0x140)\n[<c0008860>] (do_one_initcall) from [<c037aadc>] (kernel_init_freeable+0xe8/0x1b0)\n[<c037aadc>] (kernel_init_freeable) from [<c02730ac>] (kernel_init+0x8/0xe4)\n[<c02730ac>] (kernel_init) from [<c00093f0>] (ret_from_fork+0x14/0x24)\nUBI: scanning is finished\n\nFreeing the cache in the error path fixes the Slab error.\n\nTested on at91sam9g35 (3.14.18+fastmap backports)\n\nSigned-off-by: Richard Genoud <richard.genoud@gmail.com>\nCc: stable <stable@vger.kernel.org> # 3.10+",
        "before_after_code_files": [
          "drivers/mtd/ubi/fastmap.c||drivers/mtd/ubi/fastmap.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "drivers/mtd/ubi/fastmap.c||drivers/mtd/ubi/fastmap.c": [
          "File: drivers/mtd/ubi/fastmap.c -> drivers/mtd/ubi/fastmap.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "330:   av = tmp_av;",
          "331:  else {",
          "332:   ubi_err(\"orphaned volume in fastmap pool!\");",
          "333:   return UBI_BAD_FASTMAP;",
          "334:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "333:   kmem_cache_free(ai->aeb_slab_cache, new_aeb);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3148092df08f741d677c8eadce5a409555eda32c",
      "candidate_info": {
        "commit_hash": "3148092df08f741d677c8eadce5a409555eda32c",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/3148092df08f741d677c8eadce5a409555eda32c",
        "files": [
          "arch/arm/boot/dts/imx23-evk.dts"
        ],
        "message": "ARM: dts: imx23-evk: Fix display duplicate name warning\n\nThe lcdif node has a property named \"display\" and also a child node\ncalled \"display\", which causes the following warning:\n\ndevice-tree: Duplicate name in lcdif@80030000, renamed to \"display#1\"\n\nRename the child node name in order to avoid the warning.\n\nSigned-off-by: Fabio Estevam <fabio.estevam@freescale.com>\nSigned-off-by: Shawn Guo <shawn.guo@freescale.com>",
        "before_after_code_files": [
          "arch/arm/boot/dts/imx23-evk.dts||arch/arm/boot/dts/imx23-evk.dts"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/arm/boot/dts/imx23-evk.dts||arch/arm/boot/dts/imx23-evk.dts": [
          "File: arch/arm/boot/dts/imx23-evk.dts -> arch/arm/boot/dts/imx23-evk.dts",
          "--- Hunk 1 ---",
          "[Context before]",
          "60:     pinctrl-names = \"default\";",
          "61:     pinctrl-0 = <&lcdif_24bit_pins_a>;",
          "62:     lcd-supply = <&reg_lcd_3v3>;",
          "64:     status = \"okay\";",
          "67:      bits-per-pixel = <32>;",
          "68:      bus-width = <24>;",
          "",
          "[Removed Lines]",
          "63:     display = <&display>;",
          "66:     display: display {",
          "",
          "[Added Lines]",
          "63:     display = <&display0>;",
          "66:     display0: display0 {",
          "",
          "---------------"
        ]
      }
    }
  ]
}