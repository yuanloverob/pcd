{
  "cve_id": "CVE-2012-6113",
  "cve_desc": "The openssl_encrypt function in ext/openssl/openssl.c in PHP 5.3.9 through 5.3.13 does not initialize a certain variable, which allows remote attackers to obtain sensitive information from process memory by providing zero bytes of input data.",
  "repo": "php/php-src",
  "patch_hash": "270a406ac94b5fc5cc9ef59fc61e3b4b95648a3e",
  "patch_info": {
    "commit_hash": "270a406ac94b5fc5cc9ef59fc61e3b4b95648a3e",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/270a406ac94b5fc5cc9ef59fc61e3b4b95648a3e",
    "files": [
      "ext/openssl/openssl.c"
    ],
    "message": "Fix bug #61413 ext\\openssl\\tests\\openssl_encrypt_crash.phpt fails 5.3 only",
    "before_after_code_files": [
      "ext/openssl/openssl.c||ext/openssl/openssl.c"
    ]
  },
  "patch_diff": {
    "ext/openssl/openssl.c||ext/openssl/openssl.c": [
      "File: ext/openssl/openssl.c -> ext/openssl/openssl.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4677:  int data_len, method_len, password_len, iv_len = 0, max_iv_len;",
      "4678:  const EVP_CIPHER *cipher_type;",
      "4679:  EVP_CIPHER_CTX cipher_ctx;",
      "4681:  unsigned char *outbuf, *key;",
      "4682:  zend_bool free_iv;",
      "",
      "[Removed Lines]",
      "4680:  int i, outlen, keylen;",
      "",
      "[Added Lines]",
      "4680:  int i = 0, outlen, keylen;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "2655e63e10d15f62e51c9360b61fcd4b19182d6d",
      "candidate_info": {
        "commit_hash": "2655e63e10d15f62e51c9360b61fcd4b19182d6d",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/2655e63e10d15f62e51c9360b61fcd4b19182d6d",
        "files": [
          "NEWS",
          "ext/openssl/openssl.c",
          "ext/openssl/tests/011.phpt",
          "ext/openssl/tests/openssl_decrypt_error.phpt"
        ],
        "message": "MFH: Add IV to openssl_(en|de)crypt() Add openssl_cipher_iv_length()",
        "before_after_code_files": [
          "ext/openssl/openssl.c||ext/openssl/openssl.c",
          "ext/openssl/tests/011.phpt||ext/openssl/tests/011.phpt",
          "ext/openssl/tests/openssl_decrypt_error.phpt||ext/openssl/tests/openssl_decrypt_error.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/openssl/openssl.c||ext/openssl/openssl.c"
          ],
          "candidate": [
            "ext/openssl/openssl.c||ext/openssl/openssl.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/openssl/openssl.c||ext/openssl/openssl.c": [
          "File: ext/openssl/openssl.c -> ext/openssl/openssl.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "99: PHP_FUNCTION(openssl_digest);",
          "100: PHP_FUNCTION(openssl_encrypt);",
          "101: PHP_FUNCTION(openssl_decrypt);",
          "103: PHP_FUNCTION(openssl_dh_compute_key);",
          "104: PHP_FUNCTION(openssl_random_pseudo_bytes);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "102: PHP_FUNCTION(openssl_cipher_iv_length);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "347:     ZEND_ARG_INFO(0, method)",
          "348:     ZEND_ARG_INFO(0, password)",
          "349:     ZEND_ARG_INFO(0, raw_output)",
          "350: ZEND_END_ARG_INFO()",
          "352: ZEND_BEGIN_ARG_INFO_EX(arginfo_openssl_decrypt, 0, 0, 3)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "351:     ZEND_ARG_INFO(0, iv)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "354:     ZEND_ARG_INFO(0, method)",
          "355:     ZEND_ARG_INFO(0, password)",
          "356:     ZEND_ARG_INFO(0, raw_input)",
          "357: ZEND_END_ARG_INFO()",
          "359: ZEND_BEGIN_ARG_INFO(arginfo_openssl_dh_compute_key, 0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "359:     ZEND_ARG_INFO(0, iv)",
          "360: ZEND_END_ARG_INFO()",
          "362: ZEND_BEGIN_ARG_INFO(arginfo_openssl_cipher_iv_length, 0)",
          "363:     ZEND_ARG_INFO(0, method)",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "408:  PHP_FE(openssl_digest,    arginfo_openssl_digest)",
          "409:  PHP_FE(openssl_encrypt,    arginfo_openssl_encrypt)",
          "410:  PHP_FE(openssl_decrypt,    arginfo_openssl_decrypt)",
          "411:  PHP_FE(openssl_sign,    arginfo_openssl_sign)",
          "412:  PHP_FE(openssl_verify,    arginfo_openssl_verify)",
          "413:  PHP_FE(openssl_seal,    arginfo_openssl_seal)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "418:  PHP_FE(openssl_cipher_iv_length, arginfo_openssl_cipher_iv_length)",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "4590: }",
          "4595: PHP_FUNCTION(openssl_encrypt)",
          "4596: {",
          "4597:  zend_bool raw_output = 0;",
          "4600:  const EVP_CIPHER *cipher_type;",
          "4601:  EVP_CIPHER_CTX cipher_ctx;",
          "4606:   return;",
          "4607:  }",
          "4608:  cipher_type = EVP_get_cipherbyname(method);",
          "",
          "[Removed Lines]",
          "4598:  char *data, *method, *password;",
          "4599:  int data_len, method_len, password_len;",
          "4602:  int i, outlen, keylen, ivlen;",
          "4603:  unsigned char *outbuf, *key, *iv;",
          "4605:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"sss|b\", &data, &data_len, &method, &method_len, &password, &password_len, &raw_output) == FAILURE) {",
          "",
          "[Added Lines]",
          "4601: static zend_bool php_openssl_validate_iv(char **piv, int *piv_len, int iv_required_len)",
          "4602: {",
          "4603:  char *iv_new;",
          "4606:  if (*piv_len == iv_required_len) {",
          "4607:   return 0;",
          "4608:  }",
          "4610:  iv_new = ecalloc(1, iv_required_len + 1);",
          "4612:  if (*piv_len <= 0) {",
          "4616:   return 1;",
          "4617:  }",
          "4619:  if (*piv_len < iv_required_len) {",
          "4620:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"IV passed is only %d bytes long, cipher expects an IV of precisely %d bytes, padding with \\\\0\", *piv_len, iv_required_len);",
          "4621:   memcpy(iv_new, *piv, *piv_len);",
          "4624:   return 1;",
          "4625:  }",
          "4627:  php_error_docref(NULL TSRMLS_CC, E_WARNING, \"IV passed is %d bytes long which is longer than the %d expected by selected cipher, truncating\", *piv_len, iv_required_len);",
          "4628:  memcpy(iv_new, *piv, iv_required_len);",
          "4631:  return 1;",
          "4633: }",
          "4640:  char *data, *method, *password, *iv = \"\";",
          "4641:  int data_len, method_len, password_len, iv_len = 0;",
          "4644:  int i, outlen, keylen;",
          "4645:  unsigned char *outbuf, *key;",
          "4646:  zend_bool free_iv;",
          "4648:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"sss|bs\", &data, &data_len, &method, &method_len, &password, &password_len, &raw_output, &iv, &iv_len) == FAILURE) {",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "4620:   key = (unsigned char*)password;",
          "4621:  }",
          "4627:  outlen = data_len + EVP_CIPHER_block_size(cipher_type);",
          "4628:  outbuf = emalloc(outlen + 1);",
          "4631:  EVP_EncryptUpdate(&cipher_ctx, outbuf, &i, (unsigned char *)data, data_len);",
          "4632:  outlen = i;",
          "4633:  if (EVP_EncryptFinal(&cipher_ctx, (unsigned char *)outbuf + i, &i)) {",
          "",
          "[Removed Lines]",
          "4623:  ivlen = EVP_CIPHER_iv_length(cipher_type);",
          "4624:  iv = emalloc(ivlen);",
          "4625:  memset(iv, 0, ivlen);",
          "4630:  EVP_EncryptInit(&cipher_ctx, cipher_type, key, iv);",
          "",
          "[Added Lines]",
          "4666:  if (iv_len <= 0) {",
          "4667:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Using an empty Initialization Vector (iv) is potentially insecure and not recommended\");",
          "4668:  }",
          "4669:  free_iv = php_openssl_validate_iv(&iv, &iv_len, EVP_CIPHER_iv_length(cipher_type));",
          "4674:  EVP_EncryptInit(&cipher_ctx, cipher_type, key, (unsigned char *)iv);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "4650:  if (key != (unsigned char*)password) {",
          "4651:   efree(key);",
          "4652:  }",
          "4654: }",
          "4659: PHP_FUNCTION(openssl_decrypt)",
          "4660: {",
          "4661:  zend_bool raw_input = 0;",
          "4664:  const EVP_CIPHER *cipher_type;",
          "4665:  EVP_CIPHER_CTX cipher_ctx;",
          "4668:  int base64_str_len;",
          "4669:  char *base64_str = NULL;",
          "4672:   return;",
          "4673:  }",
          "",
          "[Removed Lines]",
          "4653:  efree(iv);",
          "4662:  char *data, *method, *password;",
          "4663:  int data_len, method_len, password_len;",
          "4666:  int i, outlen, keylen, ivlen;",
          "4667:  unsigned char *outbuf, *key, *iv;",
          "4671:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"sss|b\", &data, &data_len, &method, &method_len, &password, &password_len, &raw_input) == FAILURE) {",
          "",
          "[Added Lines]",
          "4697:  if (free_iv) {",
          "4698:   efree(iv);",
          "4699:  }",
          "4708:  char *data, *method, *password, *iv = \"\";",
          "4709:  int data_len, method_len, password_len, iv_len = 0;",
          "4712:  int i, outlen, keylen;",
          "4713:  unsigned char *outbuf, *key;",
          "4716:  zend_bool free_iv;",
          "4718:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"sss|bs\", &data, &data_len, &method, &method_len, &password, &password_len, &raw_input, &iv, &iv_len) == FAILURE) {",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "4698:   key = (unsigned char*)password;",
          "4699:  }",
          "4705:  outlen = data_len + EVP_CIPHER_block_size(cipher_type);",
          "4706:  outbuf = emalloc(outlen + 1);",
          "4709:  EVP_DecryptUpdate(&cipher_ctx, outbuf, &i, (unsigned char *)data, data_len);",
          "4710:  outlen = i;",
          "4711:  if (EVP_DecryptFinal(&cipher_ctx, (unsigned char *)outbuf + i, &i)) {",
          "",
          "[Removed Lines]",
          "4701:  ivlen = EVP_CIPHER_iv_length(cipher_type);",
          "4702:  iv = emalloc(ivlen);",
          "4703:  memset(iv, 0, ivlen);",
          "4708:  EVP_DecryptInit(&cipher_ctx, cipher_type, key, iv);",
          "",
          "[Added Lines]",
          "4748:  free_iv = php_openssl_validate_iv(&iv, &iv_len, EVP_CIPHER_iv_length(cipher_type));",
          "4753:  EVP_DecryptInit(&cipher_ctx, cipher_type, key, (unsigned char *)iv);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "4719:  if (key != (unsigned char*)password) {",
          "4720:   efree(key);",
          "4721:  }",
          "4723:  if (base64_str) {",
          "4724:   efree(base64_str);",
          "4725:  }",
          "4726: }",
          "4731: PHP_FUNCTION(openssl_dh_compute_key)",
          "",
          "[Removed Lines]",
          "4722:  efree(iv);",
          "",
          "[Added Lines]",
          "4767:  if (free_iv) {",
          "4768:   efree(iv);",
          "4769:  }",
          "4777: PHP_FUNCTION(openssl_cipher_iv_length)",
          "4778: {",
          "4779:  char *method;",
          "4780:  int method_len, iv_len;",
          "4781:  const EVP_CIPHER *cipher_type;",
          "4783:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"s\", &method, &method_len) == FAILURE) {",
          "4784:   return;",
          "4785:  }",
          "4787:  if (!method_len) {",
          "4788:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Unknown cipher algorithm\");",
          "4789:   RETURN_FALSE;",
          "4790:  }",
          "4792:  cipher_type = EVP_get_cipherbyname(method);",
          "4793:  if (!cipher_type) {",
          "4794:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Unknown cipher algorithm\");",
          "4795:   RETURN_FALSE;",
          "4796:  }",
          "4798:  RETURN_LONG(EVP_CIPHER_iv_length(cipher_type));",
          "4799: }",
          "",
          "---------------"
        ],
        "ext/openssl/tests/011.phpt||ext/openssl/tests/011.phpt": [
          "File: ext/openssl/tests/011.phpt -> ext/openssl/tests/011.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: $method = \"AES-128-CBC\";",
          "9: $password = \"openssl\";",
          "13: var_dump($output);",
          "16: var_dump($output);",
          "17: ?>",
          "18: --EXPECT--",
          "",
          "[Removed Lines]",
          "11: $encrypted = openssl_encrypt($data, $method, $password);",
          "12: $output = openssl_decrypt($encrypted, $method, $password);",
          "14: $encrypted = openssl_encrypt($data, $method, $password, true);",
          "15: $output = openssl_decrypt($encrypted, $method, $password, true);",
          "",
          "[Added Lines]",
          "11: $ivlen = openssl_cipher_iv_length($method);",
          "12: $iv    = '';",
          "13: srand(time() + ((microtime(true) * 1000000) % 1000000));",
          "14: while(strlen($iv) < $ivlen) $iv .= chr(rand(0,255));",
          "16: $encrypted = openssl_encrypt($data, $method, $password, false, $iv);",
          "17: $output = openssl_decrypt($encrypted, $method, $password, false, $iv);",
          "19: $encrypted = openssl_encrypt($data, $method, $password, true, $iv);",
          "20: $output = openssl_decrypt($encrypted, $method, $password, true, $iv);",
          "",
          "---------------"
        ],
        "ext/openssl/tests/openssl_decrypt_error.phpt||ext/openssl/tests/openssl_decrypt_error.phpt": [
          "File: ext/openssl/tests/openssl_decrypt_error.phpt -> ext/openssl/tests/openssl_decrypt_error.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "8: $method = \"AES-128-CBC\";",
          "9: $password = \"openssl\";",
          "10: $wrong = \"wrong\";",
          "12: $encrypted = openssl_encrypt($data, $method, $password);",
          "13: var_dump(openssl_decrypt($encrypted, $method, $wrong));",
          "14: var_dump(openssl_decrypt($encrypted, $wrong, $password));",
          "15: var_dump(openssl_decrypt($wrong, $method, $password));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "11: $iv = str_repeat(\"\\0\", openssl_cipher_iv_length($method));",
          "15: var_dump(openssl_encrypt($data, $method, $password, false, $iv));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "21: var_dump(openssl_decrypt($encrypted, $method, array()));",
          "22: ?>",
          "23: --EXPECTF--",
          "24: bool(false)",
          "26: Warning: openssl_decrypt(): Unknown cipher algorithm in %s on line %d",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "28: Warning: openssl_encrypt(): Using an empty Initialization Vector (iv) is potentially insecure and not recommended in %s on line %d",
          "29: string(44) \"yof6cPPH4mLee6TOc0YQSrh4dvywMqxGUyjp0lV6+aM=\"",
          "30: string(44) \"yof6cPPH4mLee6TOc0YQSrh4dvywMqxGUyjp0lV6+aM=\"",
          "",
          "---------------"
        ]
      }
    }
  ]
}