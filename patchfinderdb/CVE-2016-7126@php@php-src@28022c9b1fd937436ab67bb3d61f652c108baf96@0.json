{
  "cve_id": "CVE-2016-7126",
  "cve_desc": "The imagetruecolortopalette function in ext/gd/gd.c in PHP before 5.6.25 and 7.x before 7.0.10 does not properly validate the number of colors, which allows remote attackers to cause a denial of service (select_colors allocation error and out-of-bounds write) or possibly have unspecified other impact via a large value in the third argument.",
  "repo": "php/php-src",
  "patch_hash": "28022c9b1fd937436ab67bb3d61f652c108baf96",
  "patch_info": {
    "commit_hash": "28022c9b1fd937436ab67bb3d61f652c108baf96",
    "repo": "php/php-src",
    "commit_url": "https://github.com/php/php-src/commit/28022c9b1fd937436ab67bb3d61f652c108baf96",
    "files": [
      "ext/gd/gd.c",
      "ext/gd/tests/bug72697.phpt"
    ],
    "message": "Fix bug#72697 - select_colors write out-of-bounds\n\n(cherry picked from commit b6f13a5ef9d6280cf984826a5de012a32c396cd4)\n\nConflicts:\n\text/gd/gd.c",
    "before_after_code_files": [
      "ext/gd/gd.c||ext/gd/gd.c",
      "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
    ]
  },
  "patch_diff": {
    "ext/gd/gd.c||ext/gd/gd.c": [
      "File: ext/gd/gd.c -> ext/gd/gd.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1537:   RETURN_FALSE;",
      "1538:  }",
      "1542:   RETURN_FALSE;",
      "1543:  }",
      "1546:  RETURN_TRUE;",
      "1547: }",
      "",
      "[Removed Lines]",
      "1540:  if (ncolors <= 0) {",
      "1541:   php_error_docref(NULL, E_WARNING, \"Number of colors has to be greater than zero\");",
      "1544:  gdImageTrueColorToPalette(im, dither, ncolors);",
      "",
      "[Added Lines]",
      "1540:  if (ncolors <= 0 || ZEND_LONG_INT_OVFL(ncolors)) {",
      "1541:   php_error_docref(NULL, E_WARNING, \"Number of colors has to be greater than zero and no more than %d\", INT_MAX);",
      "1544:  gdImageTrueColorToPalette(im, dither, (int)ncolors);",
      "",
      "---------------"
    ],
    "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt": [
      "File: ext/gd/tests/bug72697.phpt -> ext/gd/tests/bug72697.phpt",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1: --TEST--",
      "2: Bug #72697: select_colors write out-of-bounds",
      "3: --SKIPIF--",
      "4: <?php",
      "5: if (!function_exists(\"imagecreatetruecolor\")) die(\"skip\");",
      "6: if (PHP_INT_MAX !== 9223372036854775807) die(\"skip for 64-bit long systems only\");",
      "7: ?>",
      "8: --FILE--",
      "9: <?php",
      "11: $img=imagecreatetruecolor(10, 10);",
      "12: imagetruecolortopalette($img, false, PHP_INT_MAX / 8);",
      "13: ?>",
      "14: DONE",
      "15: --EXPECTF--",
      "16: Warning: imagetruecolortopalette(): Number of colors has to be greater than zero and no more than 2147483647 in %sbug72697.php on line %d",
      "17: DONE",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "3493ed5b528be73c73a85c75effdfd3a469ac55d",
      "candidate_info": {
        "commit_hash": "3493ed5b528be73c73a85c75effdfd3a469ac55d",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/3493ed5b528be73c73a85c75effdfd3a469ac55d",
        "files": [
          "ext/gd/gd.c",
          "ext/gd/tests/bug72697.phpt"
        ],
        "message": "Fix bug#72697 - select_colors write out-of-bounds\n\n(cherry picked from commit b6f13a5ef9d6280cf984826a5de012a32c396cd4)\n\nConflicts:\n\text/gd/gd.c\n\n(cherry picked from commit 28022c9b1fd937436ab67bb3d61f652c108baf96)",
        "before_after_code_files": [
          "ext/gd/gd.c||ext/gd/gd.c",
          "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_cherry_pick": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/gd.c||ext/gd/gd.c",
            "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
          ],
          "candidate": [
            "ext/gd/gd.c||ext/gd/gd.c",
            "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/gd.c||ext/gd/gd.c": [
          "File: ext/gd/gd.c -> ext/gd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1530:   RETURN_FALSE;",
          "1531:  }",
          "1535:   RETURN_FALSE;",
          "1536:  }",
          "1539:  RETURN_TRUE;",
          "1540: }",
          "",
          "[Removed Lines]",
          "1533:  if (ncolors <= 0) {",
          "1534:   php_error_docref(NULL, E_WARNING, \"Number of colors has to be greater than zero\");",
          "1537:  gdImageTrueColorToPalette(im, dither, ncolors);",
          "",
          "[Added Lines]",
          "1533:  if (ncolors <= 0 || ZEND_LONG_INT_OVFL(ncolors)) {",
          "1534:   php_error_docref(NULL, E_WARNING, \"Number of colors has to be greater than zero and no more than %d\", INT_MAX);",
          "1537:  gdImageTrueColorToPalette(im, dither, (int)ncolors);",
          "",
          "---------------"
        ],
        "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt": [
          "File: ext/gd/tests/bug72697.phpt -> ext/gd/tests/bug72697.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72697: select_colors write out-of-bounds",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!function_exists(\"imagecreatetruecolor\")) die(\"skip\");",
          "6: if (PHP_INT_MAX !== 9223372036854775807) die(\"skip for 64-bit long systems only\");",
          "7: ?>",
          "8: --FILE--",
          "9: <?php",
          "11: $img=imagecreatetruecolor(10, 10);",
          "12: imagetruecolortopalette($img, false, PHP_INT_MAX / 8);",
          "13: ?>",
          "14: DONE",
          "15: --EXPECTF--",
          "16: Warning: imagetruecolortopalette(): Number of colors has to be greater than zero and no more than 2147483647 in %sbug72697.php on line %d",
          "17: DONE",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "b6f13a5ef9d6280cf984826a5de012a32c396cd4",
      "candidate_info": {
        "commit_hash": "b6f13a5ef9d6280cf984826a5de012a32c396cd4",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/b6f13a5ef9d6280cf984826a5de012a32c396cd4",
        "files": [
          "ext/gd/gd.c",
          "ext/gd/tests/bug72697.phpt"
        ],
        "message": "Fix bug#72697 - select_colors write out-of-bounds",
        "before_after_code_files": [
          "ext/gd/gd.c||ext/gd/gd.c",
          "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_cherry_pick": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/gd.c||ext/gd/gd.c",
            "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
          ],
          "candidate": [
            "ext/gd/gd.c||ext/gd/gd.c",
            "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/gd.c||ext/gd/gd.c": [
          "File: ext/gd/gd.c -> ext/gd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "100: #include \"gd_ctx.c\"",
          "104: int overflow2(int a, int b);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1197:  REGISTER_LONG_CONSTANT(\"IMG_CROP_SIDES\", GD_CROP_SIDES, CONST_CS | CONST_PERSISTENT);",
          "1198:  REGISTER_LONG_CONSTANT(\"IMG_CROP_THRESHOLD\", GD_CROP_THRESHOLD, CONST_CS | CONST_PERSISTENT);",
          "1201:  REGISTER_LONG_CONSTANT(\"IMG_BELL\", GD_BELL, CONST_CS | CONST_PERSISTENT);",
          "1202:  REGISTER_LONG_CONSTANT(\"IMG_BESSEL\", GD_BESSEL, CONST_CS | CONST_PERSISTENT);",
          "1203:  REGISTER_LONG_CONSTANT(\"IMG_BILINEAR_FIXED\", GD_BILINEAR_FIXED, CONST_CS | CONST_PERSISTENT);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1652:  ZEND_FETCH_RESOURCE(im, gdImagePtr, &IM, -1, \"Image\", le_gd);",
          "1656:   RETURN_FALSE;",
          "1657:  }",
          "1660:  RETURN_TRUE;",
          "1661: }",
          "",
          "[Removed Lines]",
          "1654:  if (ncolors <= 0) {",
          "1655:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Number of colors has to be greater than zero\");",
          "1658:  gdImageTrueColorToPalette(im, dither, ncolors);",
          "",
          "[Added Lines]",
          "1654:  if (ncolors <= 0 || ncolors > INT_MAX) {",
          "1655:   php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Number of colors has to be greater than zero and no more than %d\", INT_MAX);",
          "1658:  gdImageTrueColorToPalette(im, dither, (int)ncolors);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "3908:  PHP_GD_CHECK_OPEN_BASEDIR(fontname, \"Invalid font filename\");",
          "3910: #ifdef HAVE_GD_FREETYPE",
          "3911:  if (extended) {",
          "3912:   error = gdImageStringFTEx(im, brect, col, fontname, ptsize, angle, x, y, str, &strex);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "4484:  int x, y;",
          "4485:  float x_ratio, y_ratio;",
          "4486:     long ignore_warning;",
          "4488:  if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, \"pplll\", &f_org, &f_org_len, &f_dest, &f_dest_len, &height, &width, &threshold) == FAILURE) {",
          "4489:   return;",
          "4490:  }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "5367:     php_error_docref(NULL TSRMLS_CC, E_WARNING, \"Missing y position\");",
          "5368:     RETURN_FALSE;",
          "5369:    }",
          "5371:    if (type == GD_AFFINE_TRANSLATE) {",
          "5372:     res = gdAffineTranslate(affine, x, y);",
          "5373:    } else {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "ext/gd/tests/bug72697.phpt||ext/gd/tests/bug72697.phpt": [
          "File: ext/gd/tests/bug72697.phpt -> ext/gd/tests/bug72697.phpt",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: --TEST--",
          "2: Bug #72697: select_colors write out-of-bounds",
          "3: --SKIPIF--",
          "4: <?php",
          "5: if (!function_exists(\"imagecreatetruecolor\")) die(\"skip\");",
          "6: if (PHP_INT_MAX !== 9223372036854775807) die(\"skip for 64-bit long systems only\");",
          "7: ?>",
          "8: --FILE--",
          "9: <?php",
          "11: $img=imagecreatetruecolor(10, 10);",
          "12: imagetruecolortopalette($img, false, PHP_INT_MAX / 8);",
          "13: ?>",
          "14: DONE",
          "15: --EXPECTF--",
          "16: Warning: imagetruecolortopalette(): Number of colors has to be greater than zero and no more than 2147483647 in %sbug72697.php on line %d",
          "17: DONE",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ec591b555f6a902c429f51804cbfcb1c67f8333b",
      "candidate_info": {
        "commit_hash": "ec591b555f6a902c429f51804cbfcb1c67f8333b",
        "repo": "php/php-src",
        "commit_url": "https://github.com/php/php-src/commit/ec591b555f6a902c429f51804cbfcb1c67f8333b",
        "files": [
          "ext/gd/gd.c",
          "ext/gd/libgd/gd.h",
          "ext/gd/libgd/gd_topal.c"
        ],
        "message": "Change gdImageTrueColorToPalette() to return success/failure\n\nWe're porting the relevant changes from\n<https://github.com/libgd/libgd/commit/34a00a40>.\n\nWe also check the return value in the PHP binding, and throw E_WARNING if\nthe conversion failed.",
        "before_after_code_files": [
          "ext/gd/gd.c||ext/gd/gd.c",
          "ext/gd/libgd/gd.h||ext/gd/libgd/gd.h",
          "ext/gd/libgd/gd_topal.c||ext/gd/libgd/gd_topal.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "ext/gd/gd.c||ext/gd/gd.c"
          ],
          "candidate": [
            "ext/gd/gd.c||ext/gd/gd.c"
          ]
        }
      },
      "candidate_diff": {
        "ext/gd/gd.c||ext/gd/gd.c": [
          "File: ext/gd/gd.c -> ext/gd/gd.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1554:   php_error_docref(NULL, E_WARNING, \"Number of colors has to be greater than zero and no more than %d\", INT_MAX);",
          "1555:   RETURN_FALSE;",
          "1556:  }",
          "1560: }",
          "",
          "[Removed Lines]",
          "1557:  gdImageTrueColorToPalette(im, dither, (int)ncolors);",
          "1559:  RETURN_TRUE;",
          "",
          "[Added Lines]",
          "1557:  if (gdImageTrueColorToPalette(im, dither, (int)ncolors)) {",
          "1558:   RETURN_TRUE;",
          "1559:  } else {",
          "1560:   php_error_docref(NULL, E_WARNING, \"Couldn't convert to palette\");",
          "1561:   RETURN_FALSE;",
          "1562:  }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4039:  }",
          "4041:  if (im_org->trueColor) {",
          "4043:  }",
          "4045:  for (y = 0; y < dest_height; y++) {",
          "",
          "[Removed Lines]",
          "4042:   gdImageTrueColorToPalette(im_org, 1, 256);",
          "",
          "[Added Lines]",
          "4045:   if (!gdImageTrueColorToPalette(im_org, 1, 256)) {",
          "4046:    php_error_docref(NULL, E_WARNING, \"Unable to convert to palette\");",
          "4047:    return;",
          "4048:   }",
          "",
          "---------------"
        ],
        "ext/gd/libgd/gd.h||ext/gd/libgd/gd.h": [
          "File: ext/gd/libgd/gd.h -> ext/gd/libgd/gd.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "555: gdImagePtr gdImageCreatePaletteFromTrueColor (gdImagePtr im, int ditherFlag, int colorsWanted);",
          "558: int gdImagePaletteToTrueColor(gdImagePtr src);",
          "",
          "[Removed Lines]",
          "557: void gdImageTrueColorToPalette(gdImagePtr im, int ditherFlag, int colorsWanted);",
          "",
          "[Added Lines]",
          "557: int gdImageTrueColorToPalette(gdImagePtr im, int ditherFlag, int colorsWanted);",
          "",
          "---------------"
        ],
        "ext/gd/libgd/gd_topal.c||ext/gd/libgd/gd_topal.c": [
          "File: ext/gd/libgd/gd_topal.c -> ext/gd/libgd/gd_topal.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1426:     }",
          "1427: }",
          "1431: gdImagePtr gdImageCreatePaletteFromTrueColor (gdImagePtr im, int dither, int colorsWanted)",
          "1432: {",
          "1433:  gdImagePtr nim;",
          "1436: }",
          "1439: {",
          "1441: }",
          "1448: {",
          "1449:   my_cquantize_ptr cquantize = NULL;",
          "1453:   size_t arraysize;",
          "",
          "[Removed Lines]",
          "1429: static void gdImageTrueColorToPaletteBody (gdImagePtr oim, int dither, int colorsWanted, gdImagePtr *cimP);",
          "1434:  gdImageTrueColorToPaletteBody(im, dither, colorsWanted, &nim);",
          "1435:  return nim;",
          "1438: void gdImageTrueColorToPalette (gdImagePtr im, int dither, int colorsWanted)",
          "1440:  gdImageTrueColorToPaletteBody(im, dither, colorsWanted, 0);",
          "1447: static void gdImageTrueColorToPaletteBody (gdImagePtr oim, int dither, int colorsWanted, gdImagePtr *cimP)",
          "1450:   int i;",
          "",
          "[Added Lines]",
          "1429: static int gdImageTrueColorToPaletteBody (gdImagePtr oim, int dither, int colorsWanted, gdImagePtr *cimP);",
          "1434:  if (TRUE == gdImageTrueColorToPaletteBody(im, dither, colorsWanted, &nim)) {",
          "1435:   return nim;",
          "1436:  }",
          "1437:  return NULL;",
          "1440: int gdImageTrueColorToPalette (gdImagePtr im, int dither, int colorsWanted)",
          "1442:  return gdImageTrueColorToPaletteBody(im, dither, colorsWanted, 0);",
          "1449: static int gdImageTrueColorToPaletteBody (gdImagePtr oim, int dither, int colorsWanted, gdImagePtr *cimP)",
          "1452:   int i, conversionSucceeded=0;",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1457:     nim = gdImageCreate(oim->sx, oim->sy);",
          "1459:     if (!nim) {",
          "1461:     }",
          "1462:   } else {",
          "1463:     nim = oim;",
          "",
          "[Removed Lines]",
          "1460:       return;",
          "",
          "[Added Lines]",
          "1462:       return FALSE;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1469:         gdImageCopy(nim, oim, 0, 0, 0, 0, oim->sx, oim->sy);",
          "1471:       }",
          "1473:     }",
          "",
          "[Removed Lines]",
          "1472:       return;",
          "",
          "[Added Lines]",
          "1474:       return TRUE;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1602:     }",
          "1605:   if (!cimP) {",
          "1606:     oim->trueColor = 0;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1607:   conversionSucceeded = TRUE;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1612:     gdFree (oim->tpixels);",
          "1613:     oim->tpixels = 0;",
          "1614:   }",
          "1617: outOfMemory:",
          "1618:   if (oim->trueColor)",
          "1619:     {",
          "1620:       if (!cimP) {",
          "",
          "[Removed Lines]",
          "1615:   goto success;",
          "",
          "[Added Lines]",
          "1618:   goto freeQuantizeData;",
          "1621:   conversionSucceeded = FALSE;",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1637:       }",
          "1638:     }",
          "1640:   for (i = 0; i < HIST_C0_ELEMS; i++)",
          "1641:     {",
          "1642:       if (cquantize->histogram[i])",
          "",
          "[Removed Lines]",
          "1639: success:",
          "",
          "[Added Lines]",
          "1643: freeQuantizeData:",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1660:     {",
          "1661:       gdFree (cquantize);",
          "1662:     }",
          "1663: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1667:   return conversionSucceeded;",
          "",
          "---------------"
        ]
      }
    }
  ]
}