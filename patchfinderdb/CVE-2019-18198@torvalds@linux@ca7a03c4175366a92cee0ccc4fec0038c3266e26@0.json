{
  "cve_id": "CVE-2019-18198",
  "cve_desc": "In the Linux kernel before 5.3.4, a reference count usage error in the fib6_rule_suppress() function in the fib6 suppression feature of net/ipv6/fib6_rules.c, when handling the FIB_LOOKUP_NOREF flag, can be exploited by a local attacker to corrupt memory, aka CID-ca7a03c41753.",
  "repo": "torvalds/linux",
  "patch_hash": "ca7a03c4175366a92cee0ccc4fec0038c3266e26",
  "patch_info": {
    "commit_hash": "ca7a03c4175366a92cee0ccc4fec0038c3266e26",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/ca7a03c4175366a92cee0ccc4fec0038c3266e26",
    "files": [
      "net/ipv6/fib6_rules.c",
      "tools/testing/selftests/net/fib_tests.sh"
    ],
    "message": "ipv6: do not free rt if FIB_LOOKUP_NOREF is set on suppress rule\n\nCommit 7d9e5f422150 removed references from certain dsts, but accounting\nfor this never translated down into the fib6 suppression code. This bug\nwas triggered by WireGuard users who use wg-quick(8), which uses the\n\"suppress-prefix\" directive to ip-rule(8) for routing all of their\ninternet traffic without routing loops. The test case added here\ncauses the reference underflow by causing packets to evaluate a suppress\nrule.\n\nFixes: 7d9e5f422150 (\"ipv6: convert major tx path to use RT6_LOOKUP_F_DST_NOREF\")\nSigned-off-by: Jason A. Donenfeld <Jason@zx2c4.com>\nAcked-by: Wei Wang <weiwan@google.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
    "before_after_code_files": [
      "net/ipv6/fib6_rules.c||net/ipv6/fib6_rules.c",
      "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
    ]
  },
  "patch_diff": {
    "net/ipv6/fib6_rules.c||net/ipv6/fib6_rules.c": [
      "File: net/ipv6/fib6_rules.c -> net/ipv6/fib6_rules.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "287:  return false;",
      "289: suppress_route:",
      "291:  return true;",
      "292: }",
      "",
      "[Removed Lines]",
      "290:  ip6_rt_put(rt);",
      "",
      "[Added Lines]",
      "290:  if (!(arg->flags & FIB_LOOKUP_NOREF))",
      "291:   ip6_rt_put(rt);",
      "",
      "---------------"
    ],
    "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
      "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "9: ksft_skip=4",
      "11: # all tests in this script. Can be overridden with -t option",
      "14: VERBOSE=0",
      "15: PAUSE_ON_FAIL=no",
      "",
      "[Removed Lines]",
      "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter\"",
      "",
      "[Added Lines]",
      "12: TESTS=\"unregister down carrier nexthop suppress ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter\"",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "616:  cleanup",
      "617: }",
      "619: ################################################################################",
      "620: # Tests on route add and replace",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "619: fib_suppress_test()",
      "620: {",
      "621:  $IP link add dummy1 type dummy",
      "622:  $IP link set dummy1 up",
      "623:  $IP -6 route add default dev dummy1",
      "624:  $IP -6 rule add table main suppress_prefixlength 0",
      "625:  ping -f -c 1000 -W 1 1234::1 || true",
      "626:  $IP -6 rule del table main suppress_prefixlength 0",
      "627:  $IP link del dummy1",
      "629:  # If we got here without crashing, we're good.",
      "630:  return 0",
      "631: }",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1593:  fib_carrier_test|carrier) fib_carrier_test;;",
      "1594:  fib_rp_filter_test|rp_filter) fib_rp_filter_test;;",
      "1595:  fib_nexthop_test|nexthop) fib_nexthop_test;;",
      "1596:  ipv6_route_test|ipv6_rt) ipv6_route_test;;",
      "1597:  ipv4_route_test|ipv4_rt) ipv4_route_test;;",
      "1598:  ipv6_addr_metric)  ipv6_addr_metric_test;;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1610:  fib_suppress_test|suppress) fib_suppress_test;;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "228ddb3315baf03fc32ebb1cdd928c4839b49e13",
      "candidate_info": {
        "commit_hash": "228ddb3315baf03fc32ebb1cdd928c4839b49e13",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/228ddb3315baf03fc32ebb1cdd928c4839b49e13",
        "files": [
          "tools/testing/selftests/net/fib_tests.sh"
        ],
        "message": "selftests: fib_tests: Add tests for ipv6 gateway with ipv4 route\n\nAdd tests for ipv6 gateway with ipv4 route. Tests include basic\nsingle path with ping to verify connectivity and multipath.\n\nSigned-off-by: David Ahern <dsahern@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ],
          "candidate": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ]
        }
      },
      "candidate_diff": {
        "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
          "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: ksft_skip=4",
          "11: # all tests in this script. Can be overridden with -t option",
          "13: VERBOSE=0",
          "14: PAUSE_ON_FAIL=no",
          "15: PAUSE=no",
          "",
          "[Removed Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics\"",
          "",
          "[Added Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "48: {",
          "49:  set -e",
          "50:  ip netns add ns1",
          "51:  $IP link set dev lo up",
          "52:  ip netns exec ns1 sysctl -qw net.ipv4.ip_forward=1",
          "53:  ip netns exec ns1 sysctl -qw net.ipv6.conf.all.forwarding=1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "52:  ip netns set ns1 auto",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "698:  set -e",
          "700:  ip netns add ns2",
          "701:  ip -netns ns2 link set dev lo up",
          "702:  ip netns exec ns2 sysctl -qw net.ipv4.ip_forward=1",
          "703:  ip netns exec ns2 sysctl -qw net.ipv6.conf.all.forwarding=1",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "703:  ip netns set ns2 auto",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1442:  route_cleanup",
          "1443: }",
          "1446: ################################################################################",
          "1447: # usage",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1448: ipv4_route_v6_gw_test()",
          "1449: {",
          "1450:  local rc",
          "1452:  echo",
          "1453:  echo \"IPv4 route with IPv6 gateway tests\"",
          "1455:  route_setup",
          "1456:  sleep 2",
          "1458:  #",
          "1459:  # single path route",
          "1460:  #",
          "1461:  run_cmd \"$IP ro add 172.16.104.0/24 via inet6 2001:db8:101::2\"",
          "1462:  rc=$?",
          "1463:  log_test $rc 0 \"Single path route with IPv6 gateway\"",
          "1464:  if [ $rc -eq 0 ]; then",
          "1465:   check_route \"172.16.104.0/24 via inet6 2001:db8:101::2 dev veth1\"",
          "1466:  fi",
          "1468:  run_cmd \"ip netns exec ns1 ping -w1 -c1 172.16.104.1\"",
          "1469:  log_test $rc 0 \"Single path route with IPv6 gateway - ping\"",
          "1471:  run_cmd \"$IP ro del 172.16.104.0/24 via inet6 2001:db8:101::2\"",
          "1472:  rc=$?",
          "1473:  log_test $rc 0 \"Single path route delete\"",
          "1474:  if [ $rc -eq 0 ]; then",
          "1475:   check_route \"172.16.112.0/24\"",
          "1476:  fi",
          "1478:  #",
          "1479:  # multipath - v6 then v4",
          "1480:  #",
          "1481:  run_cmd \"$IP ro add 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3\"",
          "1482:  rc=$?",
          "1483:  log_test $rc 0 \"Multipath route add - v6 nexthop then v4\"",
          "1484:  if [ $rc -eq 0 ]; then",
          "1485:   check_route \"172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 weight 1 nexthop via 172.16.103.2 dev veth3 weight 1\"",
          "1486:  fi",
          "1488:  run_cmd \"$IP ro del 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1\"",
          "1489:  log_test $? 2 \"    Multipath route delete - nexthops in wrong order\"",
          "1491:  run_cmd \"$IP ro del 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3\"",
          "1492:  log_test $? 0 \"    Multipath route delete exact match\"",
          "1494:  #",
          "1495:  # multipath - v4 then v6",
          "1496:  #",
          "1497:  run_cmd \"$IP ro add 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1\"",
          "1498:  rc=$?",
          "1499:  log_test $rc 0 \"Multipath route add - v4 nexthop then v6\"",
          "1500:  if [ $rc -eq 0 ]; then",
          "1501:   check_route \"172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 weight 1 nexthop via inet6 2001:db8:101::2 dev veth1 weight 1\"",
          "1502:  fi",
          "1504:  run_cmd \"$IP ro del 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3\"",
          "1505:  log_test $? 2 \"    Multipath route delete - nexthops in wrong order\"",
          "1507:  run_cmd \"$IP ro del 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1\"",
          "1508:  log_test $? 0 \"    Multipath route delete exact match\"",
          "1510:  route_cleanup",
          "1511: }",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1511:  ipv4_addr_metric)  ipv4_addr_metric_test;;",
          "1512:  ipv6_route_metrics)  ipv6_route_metrics_test;;",
          "1513:  ipv4_route_metrics)  ipv4_route_metrics_test;;",
          "1515:  help) echo \"Test names: $TESTS\"; exit 0;;",
          "1516:  esac",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1581:  ipv4_route_v6_gw)  ipv4_route_v6_gw_test;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2c1dd4c110627c2a4f006643f074119205cfcff4",
      "candidate_info": {
        "commit_hash": "2c1dd4c110627c2a4f006643f074119205cfcff4",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/2c1dd4c110627c2a4f006643f074119205cfcff4",
        "files": [
          "tools/testing/selftests/net/fib_tests.sh"
        ],
        "message": "selftests: Fix suppress test in fib_tests.sh\n\nfib_tests is spewing errors:\n    ...\n    Cannot open network namespace \"ns1\": No such file or directory\n    Cannot open network namespace \"ns1\": No such file or directory\n    Cannot open network namespace \"ns1\": No such file or directory\n    Cannot open network namespace \"ns1\": No such file or directory\n    ping: connect: Network is unreachable\n    Cannot open network namespace \"ns1\": No such file or directory\n    Cannot open network namespace \"ns1\": No such file or directory\n    ...\n\nEach test entry in fib_tests is supposed to do its own setup and\ncleanup. Right now the $IP commands in fib_suppress_test are\nfailing because there is no ns1. Add the setup/cleanup and logging\nexpected for each test.\n\nFixes: ca7a03c41753 (\"ipv6: do not free rt if FIB_LOOKUP_NOREF is set on suppress rule\")\nSigned-off-by: David Ahern <dsahern@gmail.com>\nCc: Jason A. Donenfeld <Jason@zx2c4.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ],
          "candidate": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ]
        }
      },
      "candidate_diff": {
        "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
          "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "619: fib_suppress_test()",
          "620: {",
          "621:  $IP link add dummy1 type dummy",
          "622:  $IP link set dummy1 up",
          "623:  $IP -6 route add default dev dummy1",
          "624:  $IP -6 rule add table main suppress_prefixlength 0",
          "626:  $IP -6 rule del table main suppress_prefixlength 0",
          "627:  $IP link del dummy1",
          "629:  # If we got here without crashing, we're good.",
          "631: }",
          "633: ################################################################################",
          "",
          "[Removed Lines]",
          "625:  ping -f -c 1000 -W 1 1234::1 || true",
          "630:  return 0",
          "",
          "[Added Lines]",
          "621:  echo",
          "622:  echo \"FIB rule with suppress_prefixlength\"",
          "623:  setup",
          "629:  ping -f -c 1000 -W 1 1234::1 >/dev/null 2>&1",
          "634:  log_test 0 0 \"FIB rule suppress test\"",
          "636:  cleanup",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "adb701d6cfa432f5dbdf28839b5e64291a7ed30b",
      "candidate_info": {
        "commit_hash": "adb701d6cfa432f5dbdf28839b5e64291a7ed30b",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/adb701d6cfa432f5dbdf28839b5e64291a7ed30b",
        "files": [
          "tools/testing/selftests/net/fib_tests.sh"
        ],
        "message": "selftests: add a test case for rp_filter\n\nAdd a test case to simulate the loopback packet case fixed\nin the previous patch.\n\nThis test gets passed after the fix:\n\nIPv4 rp_filter tests\n    TEST: rp_filter passes local packets                                [ OK ]\n    TEST: rp_filter passes loopback packets                             [ OK ]\n\nCc: David Ahern <dsahern@gmail.com>\nSigned-off-by: Cong Wang <xiyou.wangcong@gmail.com>\nReviewed-by: David Ahern <dsahern@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ],
          "candidate": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ]
        }
      },
      "candidate_diff": {
        "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
          "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: ksft_skip=4",
          "11: # all tests in this script. Can be overridden with -t option",
          "14: VERBOSE=0",
          "15: PAUSE_ON_FAIL=no",
          "16: PAUSE=no",
          "17: IP=\"ip -netns ns1\"",
          "19: log_test()",
          "20: {",
          "",
          "[Removed Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw\"",
          "",
          "[Added Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter\"",
          "18: NS_EXEC=\"ip netns exec ns1\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "433:  fib_carrier_unicast_test",
          "434: }",
          "436: ################################################################################",
          "437: # Tests on nexthop spec",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "437: fib_rp_filter_test()",
          "438: {",
          "439:  echo",
          "440:  echo \"IPv4 rp_filter tests\"",
          "442:  setup",
          "444:  set -e",
          "445:  $IP link set dev lo address 52:54:00:6a:c7:5e",
          "446:  $IP link set dummy0 address 52:54:00:6a:c7:5e",
          "447:  $IP link add dummy1 type dummy",
          "448:  $IP link set dummy1 address 52:54:00:6a:c7:5e",
          "449:  $IP link set dev dummy1 up",
          "450:  $NS_EXEC sysctl -qw net.ipv4.conf.all.rp_filter=1",
          "451:  $NS_EXEC sysctl -qw net.ipv4.conf.all.accept_local=1",
          "452:  $NS_EXEC sysctl -qw net.ipv4.conf.all.route_localnet=1",
          "454:  $NS_EXEC tc qd add dev dummy1 parent root handle 1: fq_codel",
          "455:  $NS_EXEC tc filter add dev dummy1 parent 1: protocol arp basic action mirred egress redirect dev lo",
          "456:  $NS_EXEC tc filter add dev dummy1 parent 1: protocol ip basic action mirred egress redirect dev lo",
          "457:  set +e",
          "459:  run_cmd \"ip netns exec ns1 ping -I dummy1 -w1 -c1 198.51.100.1\"",
          "460:  log_test $? 0 \"rp_filter passes local packets\"",
          "462:  run_cmd \"ip netns exec ns1 ping -I dummy1 -w1 -c1 127.0.0.1\"",
          "463:  log_test $? 0 \"rp_filter passes loopback packets\"",
          "465:  cleanup",
          "466: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1557:  fib_unreg_test|unregister) fib_unreg_test;;",
          "1558:  fib_down_test|down)  fib_down_test;;",
          "1559:  fib_carrier_test|carrier) fib_carrier_test;;",
          "1560:  fib_nexthop_test|nexthop) fib_nexthop_test;;",
          "1561:  ipv6_route_test|ipv6_rt) ipv6_route_test;;",
          "1562:  ipv4_route_test|ipv4_rt) ipv4_route_test;;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1592:  fib_rp_filter_test|rp_filter) fib_rp_filter_test;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2386d74845c358f464429c4b071bfc681e913013",
      "candidate_info": {
        "commit_hash": "2386d74845c358f464429c4b071bfc681e913013",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/2386d74845c358f464429c4b071bfc681e913013",
        "files": [
          "tools/testing/selftests/net/fib_tests.sh"
        ],
        "message": "selftests: Add source route tests to fib_tests\n\nAdd tests to verify routes with source address set are deleted when\nsource address is deleted.\n\nSigned-off-by: David Ahern <dsahern@kernel.org>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ],
          "candidate": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ]
        }
      },
      "candidate_diff": {
        "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
          "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: ksft_skip=4",
          "11: # all tests in this script. Can be overridden with -t option",
          "14: VERBOSE=0",
          "15: PAUSE_ON_FAIL=no",
          "",
          "[Removed Lines]",
          "12: TESTS=\"unregister down carrier nexthop suppress ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter\"",
          "",
          "[Added Lines]",
          "12: TESTS=\"unregister down carrier nexthop suppress ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter ipv4_del_addr\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1500:  route_cleanup",
          "1501: }",
          "1503: ipv4_route_v6_gw_test()",
          "1504: {",
          "1505:  local rc",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1503: ipv4_del_addr_test()",
          "1504: {",
          "1505:  echo",
          "1506:  echo \"IPv4 delete address route tests\"",
          "1508:  setup",
          "1510:  set -e",
          "1511:  $IP li add dummy1 type dummy",
          "1512:  $IP li set dummy1 up",
          "1513:  $IP li add dummy2 type dummy",
          "1514:  $IP li set dummy2 up",
          "1515:  $IP li add red type vrf table 1111",
          "1516:  $IP li set red up",
          "1517:  $IP ro add vrf red unreachable default",
          "1518:  $IP li set dummy2 vrf red",
          "1520:  $IP addr add dev dummy1 172.16.104.1/24",
          "1521:  $IP addr add dev dummy1 172.16.104.11/24",
          "1522:  $IP addr add dev dummy2 172.16.104.1/24",
          "1523:  $IP addr add dev dummy2 172.16.104.11/24",
          "1524:  $IP route add 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11",
          "1525:  $IP route add vrf red 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11",
          "1526:  set +e",
          "1528:  # removing address from device in vrf should only remove route from vrf table",
          "1529:  $IP addr del dev dummy2 172.16.104.11/24",
          "1530:  $IP ro ls vrf red | grep -q 172.16.105.0/24",
          "1531:  log_test $? 1 \"Route removed from VRF when source address deleted\"",
          "1533:  $IP ro ls | grep -q 172.16.105.0/24",
          "1534:  log_test $? 0 \"Route in default VRF not removed\"",
          "1536:  $IP addr add dev dummy2 172.16.104.11/24",
          "1537:  $IP route add vrf red 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11",
          "1539:  $IP addr del dev dummy1 172.16.104.11/24",
          "1540:  $IP ro ls | grep -q 172.16.105.0/24",
          "1541:  log_test $? 1 \"Route removed in default VRF when source address deleted\"",
          "1543:  $IP ro ls vrf red | grep -q 172.16.105.0/24",
          "1544:  log_test $? 0 \"Route in VRF is not removed by address delete\"",
          "1546:  $IP li del dummy1",
          "1547:  $IP li del dummy2",
          "1548:  cleanup",
          "1549: }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1633:  ipv4_route_test|ipv4_rt) ipv4_route_test;;",
          "1634:  ipv6_addr_metric)  ipv6_addr_metric_test;;",
          "1635:  ipv4_addr_metric)  ipv4_addr_metric_test;;",
          "1636:  ipv6_route_metrics)  ipv6_route_metrics_test;;",
          "1637:  ipv4_route_metrics)  ipv4_route_metrics_test;;",
          "1638:  ipv4_route_v6_gw)  ipv4_route_v6_gw_test;;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1685:  ipv4_del_addr)   ipv4_del_addr_test;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "a0e11da78f487bc26ca7b14e4c9b40638623ebf6",
      "candidate_info": {
        "commit_hash": "a0e11da78f487bc26ca7b14e4c9b40638623ebf6",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/a0e11da78f487bc26ca7b14e4c9b40638623ebf6",
        "files": [
          "tools/testing/selftests/net/fib_tests.sh"
        ],
        "message": "fib_tests: Add tests for metrics on routes\n\nAdd ipv4 and ipv6 test cases for metrics (mtu) when fib entries are\ncreated. Can be used with kmemleak to see leaks with both fib entries\nand dst_entry.\n\nSigned-off-by: David Ahern <dsahern@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>",
        "before_after_code_files": [
          "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ],
          "candidate": [
            "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh"
          ]
        }
      },
      "candidate_diff": {
        "tools/testing/selftests/net/fib_tests.sh||tools/testing/selftests/net/fib_tests.sh": [
          "File: tools/testing/selftests/net/fib_tests.sh -> tools/testing/selftests/net/fib_tests.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "9: ksft_skip=4",
          "11: # all tests in this script. Can be overridden with -t option",
          "13: VERBOSE=0",
          "14: PAUSE_ON_FAIL=no",
          "15: PAUSE=no",
          "18: log_test()",
          "19: {",
          "",
          "[Removed Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric\"",
          "16: IP=\"ip -netns testns\"",
          "",
          "[Added Lines]",
          "12: TESTS=\"unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics\"",
          "16: IP=\"ip -netns ns1\"",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "47: setup()",
          "48: {",
          "49:  set -e",
          "51:  $IP link set dev lo up",
          "53:  $IP link add dummy0 type dummy",
          "54:  $IP link set dev dummy0 up",
          "",
          "[Removed Lines]",
          "50:  ip netns add testns",
          "",
          "[Added Lines]",
          "50:  ip netns add ns1",
          "52:  ip netns exec ns1 sysctl -qw net.ipv4.ip_forward=1",
          "53:  ip netns exec ns1 sysctl -qw net.ipv6.conf.all.forwarding=1",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "61: cleanup()",
          "62: {",
          "63:  $IP link del dev dummy0 &> /dev/null",
          "65: }",
          "67: get_linklocal()",
          "",
          "[Removed Lines]",
          "64:  ip netns del testns",
          "",
          "[Added Lines]",
          "66:  ip netns del ns1",
          "67:  ip netns del ns2 &> /dev/null",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "640: check_route6()",
          "641: {",
          "643:  local expected=\"$1\"",
          "644:  local out",
          "645:  local rc=0",
          "647:  out=$($IP -6 ro ls match ${pfx} | sed -e 's/ pref medium//')",
          "648:  [ \"${out}\" = \"${expected}\" ] && return 0",
          "",
          "[Removed Lines]",
          "642:  local pfx=\"2001:db8:104::/64\"",
          "",
          "[Added Lines]",
          "645:  local pfx",
          "650:  set -- $expected",
          "651:  pfx=$1",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "690:  [ \"${VERBOSE}\" = \"1\" ] && set -x",
          "691:  set -e",
          "694:  $IP li add veth1 type veth peer name veth2",
          "695:  $IP li add veth3 type veth peer name veth4",
          "697:  $IP li set veth1 up",
          "698:  $IP li set veth3 up",
          "704:  $IP -6 addr add 2001:db8:101::1/64 dev veth1",
          "706:  $IP -6 addr add 2001:db8:103::1/64 dev veth3",
          "710:  $IP addr add 172.16.101.1/24 dev veth1",
          "712:  $IP addr add 172.16.103.1/24 dev veth3",
          "716:  set +ex",
          "717: }",
          "",
          "[Removed Lines]",
          "693:  $IP li add red up type vrf table 101",
          "699:  $IP li set veth2 vrf red up",
          "700:  $IP li set veth4 vrf red up",
          "701:  $IP li add dummy1 type dummy",
          "702:  $IP li set dummy1 vrf red up",
          "705:  $IP -6 addr add 2001:db8:101::2/64 dev veth2",
          "707:  $IP -6 addr add 2001:db8:103::2/64 dev veth4",
          "708:  $IP -6 addr add 2001:db8:104::1/64 dev dummy1",
          "711:  $IP addr add 172.16.101.2/24 dev veth2",
          "713:  $IP addr add 172.16.103.2/24 dev veth4",
          "714:  $IP addr add 172.16.104.1/24 dev dummy1",
          "",
          "[Added Lines]",
          "699:  ip netns add ns2",
          "700:  ip -netns ns2 link set dev lo up",
          "701:  ip netns exec ns2 sysctl -qw net.ipv4.ip_forward=1",
          "702:  ip netns exec ns2 sysctl -qw net.ipv6.conf.all.forwarding=1",
          "709:  $IP li set veth2 netns ns2 up",
          "710:  $IP li set veth4 netns ns2 up",
          "711:  ip -netns ns2 li add dummy1 type dummy",
          "712:  ip -netns ns2 li set dummy1 up",
          "719:  ip -netns ns2 -6 addr add 2001:db8:101::2/64 dev veth2",
          "720:  ip -netns ns2 -6 addr add 2001:db8:103::2/64 dev veth4",
          "721:  ip -netns ns2 -6 addr add 2001:db8:104::1/64 dev dummy1",
          "723:  ip -netns ns2 addr add 172.16.101.2/24 dev veth2",
          "724:  ip -netns ns2 addr add 172.16.103.2/24 dev veth4",
          "725:  ip -netns ns2 addr add 172.16.104.1/24 dev dummy1",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "944:  log_test $rc 0 \"Modify metric of address\"",
          "946:  # verify prefix route removed on down",
          "948:  run_cmd \"$IP li set dev dummy2 down\"",
          "949:  rc=$?",
          "950:  if [ $rc -eq 0 ]; then",
          "",
          "[Removed Lines]",
          "947:  run_cmd \"ip netns exec testns sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\"",
          "",
          "[Added Lines]",
          "958:  run_cmd \"ip netns exec ns1 sysctl -qw net.ipv6.conf.all.keep_addr_on_down=1\"",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "967:  cleanup",
          "968: }",
          "970: # add route for a prefix, flushing any existing routes first",
          "971: # expected to be the first step of a test",
          "972: add_route()",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "981: ipv6_route_metrics_test()",
          "982: {",
          "983:  local rc",
          "985:  echo",
          "986:  echo \"IPv6 routes with metrics\"",
          "988:  route_setup",
          "990:  #",
          "991:  # single path with metrics",
          "992:  #",
          "993:  run_cmd \"$IP -6 ro add 2001:db8:111::/64 via 2001:db8:101::2 mtu 1400\"",
          "994:  rc=$?",
          "995:  if [ $rc -eq 0 ]; then",
          "996:   check_route6  \"2001:db8:111::/64 via 2001:db8:101::2 dev veth1 metric 1024 mtu 1400\"",
          "997:   rc=$?",
          "998:  fi",
          "999:  log_test $rc 0 \"Single path route with mtu metric\"",
          "1002:  #",
          "1003:  # multipath via separate routes with metrics",
          "1004:  #",
          "1005:  run_cmd \"$IP -6 ro add 2001:db8:112::/64 via 2001:db8:101::2 mtu 1400\"",
          "1006:  run_cmd \"$IP -6 ro append 2001:db8:112::/64 via 2001:db8:103::2\"",
          "1007:  rc=$?",
          "1008:  if [ $rc -eq 0 ]; then",
          "1009:   check_route6 \"2001:db8:112::/64 metric 1024 mtu 1400 nexthop via 2001:db8:101::2 dev veth1 weight 1 nexthop via 2001:db8:103::2 dev veth3 weight 1\"",
          "1010:   rc=$?",
          "1011:  fi",
          "1012:  log_test $rc 0 \"Multipath route via 2 single routes with mtu metric on first\"",
          "1014:  # second route is coalesced to first to make a multipath route.",
          "1015:  # MTU of the second path is hidden from display!",
          "1016:  run_cmd \"$IP -6 ro add 2001:db8:113::/64 via 2001:db8:101::2\"",
          "1017:  run_cmd \"$IP -6 ro append 2001:db8:113::/64 via 2001:db8:103::2 mtu 1400\"",
          "1018:  rc=$?",
          "1019:  if [ $rc -eq 0 ]; then",
          "1020:   check_route6 \"2001:db8:113::/64 metric 1024 nexthop via 2001:db8:101::2 dev veth1 weight 1 nexthop via 2001:db8:103::2 dev veth3 weight 1\"",
          "1021:   rc=$?",
          "1022:  fi",
          "1023:  log_test $rc 0 \"Multipath route via 2 single routes with mtu metric on 2nd\"",
          "1025:  run_cmd \"$IP -6 ro del 2001:db8:113::/64 via 2001:db8:101::2\"",
          "1026:  if [ $? -eq 0 ]; then",
          "1027:   check_route6 \"2001:db8:113::/64 via 2001:db8:103::2 dev veth3 metric 1024 mtu 1400\"",
          "1028:   log_test $? 0 \"    MTU of second leg\"",
          "1029:  fi",
          "1031:  #",
          "1032:  # multipath with metrics",
          "1033:  #",
          "1034:  run_cmd \"$IP -6 ro add 2001:db8:115::/64 mtu 1400 nexthop via 2001:db8:101::2 nexthop via 2001:db8:103::2\"",
          "1035:  rc=$?",
          "1036:  if [ $rc -eq 0 ]; then",
          "1037:   check_route6  \"2001:db8:115::/64 metric 1024 mtu 1400 nexthop via 2001:db8:101::2 dev veth1 weight 1 nexthop via 2001:db8:103::2 dev veth3 weight 1\"",
          "1038:   rc=$?",
          "1039:  fi",
          "1040:  log_test $rc 0 \"Multipath route with mtu metric\"",
          "1042:  $IP -6 ro add 2001:db8:104::/64 via 2001:db8:101::2 mtu 1300",
          "1043:  run_cmd \"ip netns exec ns1 ping6 -w1 -c1 -s 1500 2001:db8:104::1\"",
          "1044:  log_test $? 0 \"Using route with mtu metric\"",
          "1046:  route_cleanup",
          "1047: }",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1006: check_route()",
          "1007: {",
          "1009:  local expected=\"$1\"",
          "1010:  local out",
          "1011:  local rc=0",
          "1013:  out=$($IP ro ls match ${pfx})",
          "1014:  [ \"${out}\" = \"${expected}\" ] && return 0",
          "",
          "[Removed Lines]",
          "1008:  local pfx=\"172.16.104.0/24\"",
          "",
          "[Added Lines]",
          "1087:  local pfx",
          "1092:  set -- $expected",
          "1093:  pfx=$1",
          "1094:  [ \"${pfx}\" = \"unreachable\" ] && pfx=$2",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "1319:  cleanup",
          "1320: }",
          "1322: ################################################################################",
          "1323: # usage",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1405: ipv4_route_metrics_test()",
          "1406: {",
          "1407:  local rc",
          "1409:  echo",
          "1410:  echo \"IPv4 route add / append tests\"",
          "1412:  route_setup",
          "1414:  run_cmd \"$IP ro add 172.16.111.0/24 via 172.16.101.2 mtu 1400\"",
          "1415:  rc=$?",
          "1416:  if [ $rc -eq 0 ]; then",
          "1417:   check_route \"172.16.111.0/24 via 172.16.101.2 dev veth1 mtu 1400\"",
          "1418:   rc=$?",
          "1419:  fi",
          "1420:  log_test $rc 0 \"Single path route with mtu metric\"",
          "1423:  run_cmd \"$IP ro add 172.16.112.0/24 mtu 1400 nexthop via 172.16.101.2 nexthop via 172.16.103.2\"",
          "1424:  rc=$?",
          "1425:  if [ $rc -eq 0 ]; then",
          "1426:   check_route \"172.16.112.0/24 mtu 1400 nexthop via 172.16.101.2 dev veth1 weight 1 nexthop via 172.16.103.2 dev veth3 weight 1\"",
          "1427:   rc=$?",
          "1428:  fi",
          "1429:  log_test $rc 0 \"Multipath route with mtu metric\"",
          "1431:  $IP ro add 172.16.104.0/24 via 172.16.101.2 mtu 1300",
          "1432:  run_cmd \"ip netns exec ns1 ping -w1 -c1 -s 1500 172.16.104.1\"",
          "1433:  log_test $? 0 \"Using route with mtu metric\"",
          "1435:  route_cleanup",
          "1436: }",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "1385:  ipv4_route_test|ipv4_rt) ipv4_route_test;;",
          "1386:  ipv6_addr_metric)  ipv6_addr_metric_test;;",
          "1387:  ipv4_addr_metric)  ipv4_addr_metric_test;;",
          "1389:  help) echo \"Test names: $TESTS\"; exit 0;;",
          "1390:  esac",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1505:  ipv6_route_metrics)  ipv6_route_metrics_test;;",
          "1506:  ipv4_route_metrics)  ipv4_route_metrics_test;;",
          "",
          "---------------"
        ]
      }
    }
  ]
}