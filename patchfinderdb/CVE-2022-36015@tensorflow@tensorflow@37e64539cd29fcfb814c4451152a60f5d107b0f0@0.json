{
  "cve_id": "CVE-2022-36015",
  "cve_desc": "TensorFlow is an open source platform for machine learning. When `RangeSize` receives values that do not fit into an `int64_t`, it crashes. We have patched the issue in GitHub commit 37e64539cd29fcfb814c4451152a60f5d107b0f0. The fix will be included in TensorFlow 2.10.0. We will also cherrypick this commit on TensorFlow 2.9.1, TensorFlow 2.8.1, and TensorFlow 2.7.2, as these are also affected and still in supported range. There are no known workarounds for this issue.",
  "repo": "tensorflow/tensorflow",
  "patch_hash": "37e64539cd29fcfb814c4451152a60f5d107b0f0",
  "patch_info": {
    "commit_hash": "37e64539cd29fcfb814c4451152a60f5d107b0f0",
    "repo": "tensorflow/tensorflow",
    "commit_url": "https://github.com/tensorflow/tensorflow/commit/37e64539cd29fcfb814c4451152a60f5d107b0f0",
    "files": [
      "tensorflow/core/ops/math_ops.cc"
    ],
    "message": "Fix overflow issue\n\nWe're also decreasing the test numbers by 1 as the overflow threshold is 1 less.\n\nPiperOrigin-RevId: 449856148",
    "before_after_code_files": [
      "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
    ]
  },
  "patch_diff": {
    "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
      "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
      "--- Hunk 1 ---",
      "[Context before]",
      "1487:     return errors::InvalidArgument(\"Requires delta != 0\");",
      "1488:   }",
      "1501:   }",
      "1503:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
      "",
      "[Removed Lines]",
      "1490:   auto size = (std::is_integral<T>::value",
      "1491:                    ? ((Eigen::numext::abs(limit - start) +",
      "1492:                        Eigen::numext::abs(delta) - T(1)) /",
      "1493:                       Eigen::numext::abs(delta))",
      "1494:                    : (Eigen::numext::ceil(",
      "1495:                          Eigen::numext::abs((limit - start) / delta))));",
      "1498:   if (size > std::numeric_limits<int64_t>::max()) {",
      "1499:     return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
      "1500:                                    std::numeric_limits<int64_t>::max());",
      "",
      "[Added Lines]",
      "1490:   int64_t size;",
      "1491:   if (std::is_integral<T>::value) {",
      "1492:     size = Eigen::divup(static_cast<int64_t>(Eigen::numext::abs(limit - start)),",
      "1493:                         static_cast<int64_t>(Eigen::numext::abs(delta)));",
      "1494:   } else {",
      "1495:     auto size_auto =",
      "1496:         Eigen::numext::ceil(Eigen::numext::abs((limit - start) / delta));",
      "1497:     if (size_auto > std::numeric_limits<int64_t>::max()) {",
      "1498:       return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
      "1499:                                      std::numeric_limits<int64_t>::max());",
      "1500:     }",
      "1501:     size = static_cast<int64_t>(size_auto);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "55deb9b27620d8c5ef2f61a32520cb035079d0da",
      "candidate_info": {
        "commit_hash": "55deb9b27620d8c5ef2f61a32520cb035079d0da",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/55deb9b27620d8c5ef2f61a32520cb035079d0da",
        "files": [
          "tensorflow/core/kernels/sequence_ops.cc",
          "tensorflow/core/ops/math_ops.cc",
          "tensorflow/python/kernel_tests/array_ops/init_ops_test.py"
        ],
        "message": "Test for case that would lead to undefined behaviour and throw error if found",
        "before_after_code_files": [
          "tensorflow/core/kernels/sequence_ops.cc||tensorflow/core/kernels/sequence_ops.cc",
          "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc",
          "tensorflow/python/kernel_tests/array_ops/init_ops_test.py||tensorflow/python/kernel_tests/array_ops/init_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sequence_ops.cc||tensorflow/core/kernels/sequence_ops.cc": [
          "File: tensorflow/core/kernels/sequence_ops.cc -> tensorflow/core/kernels/sequence_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "71:           errors::InvalidArgument(",
          "72:               \"Requires start >= limit when delta < 0: \", start, \"/\", limit));",
          "73:     }",
          "81:     TensorShape shape;",
          "82:     OP_REQUIRES_OK(context, shape.AddDimWithStatus(size));",
          "83:     Tensor* out = nullptr;",
          "",
          "[Removed Lines]",
          "74:     int64_t size = 0;",
          "75:     if (std::is_integral<T>::value) {",
          "76:       size = static_cast<int64_t>(",
          "77:           (std::abs(limit - start) + std::abs(delta) - 1) / std::abs(delta));",
          "78:     } else {",
          "79:       size = static_cast<int64_t>(std::ceil(std::abs((limit - start) / delta)));",
          "80:     }",
          "",
          "[Added Lines]",
          "74:     auto size_auto = (std::is_integral<T>::value",
          "75:      ? (Eigen::numext::abs(limit - start) +",
          "76:       Eigen::numext::abs(delta) - T(1)) /",
          "77:       Eigen::numext::abs(delta)",
          "78:      : Eigen::numext::ceil(",
          "79:       Eigen::numext::abs((limit - start) / delta)));",
          "80:     OP_REQUIRES(context, size_auto <= std::numeric_limits<int64_t>::max(),",
          "81:           errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "82:       std::numeric_limits<int64_t>::max()));",
          "84:     int64_t size = static_cast<int64_t>(size_auto);",
          "",
          "---------------"
        ],
        "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
          "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1489:                       Eigen::numext::abs(delta))",
          "1490:                    : (Eigen::numext::ceil(",
          "1491:                          Eigen::numext::abs((limit - start) / delta))));",
          "1492:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
          "1493:   return Status::OK();",
          "1494: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1494:   if (size > std::numeric_limits<int64_t>::max()) {",
          "1495:     return errors::InvalidArgument(",
          "1496:         \"Requires ((limit - start) / delta) <= \", std::numeric_limits<int64_t>::max());",
          "1497:   }",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/array_ops/init_ops_test.py||tensorflow/python/kernel_tests/array_ops/init_ops_test.py": [
          "File: tensorflow/python/kernel_tests/array_ops/init_ops_test.py -> tensorflow/python/kernel_tests/array_ops/init_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "548:   def testLargeStarts(self):",
          "549:     # Test case for GitHub issue 46899.",
          "550:     with self.session():",
          "552:         v = math_ops.range(start=-1e+38, limit=1)",
          "553:         self.evaluate(v)",
          "",
          "[Removed Lines]",
          "551:       with self.assertRaises(errors_impl.InvalidArgumentError):",
          "",
          "[Added Lines]",
          "551:       with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f0147751fd5d2ff23251149ebad9af9f03010732",
      "candidate_info": {
        "commit_hash": "f0147751fd5d2ff23251149ebad9af9f03010732",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/f0147751fd5d2ff23251149ebad9af9f03010732",
        "files": [
          "tensorflow/core/kernels/sequence_ops.cc",
          "tensorflow/core/ops/math_ops.cc",
          "tensorflow/python/kernel_tests/array_ops/init_ops_test.py"
        ],
        "message": "Merge pull request #52707 from elfringham:init_ops_test_fix\n\nPiperOrigin-RevId: 416941851\nChange-Id: Iefa5a9b841b053b36f6b105cd82c9d32d5e47850",
        "before_after_code_files": [
          "tensorflow/core/kernels/sequence_ops.cc||tensorflow/core/kernels/sequence_ops.cc",
          "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc",
          "tensorflow/python/kernel_tests/array_ops/init_ops_test.py||tensorflow/python/kernel_tests/array_ops/init_ops_test.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/kernels/sequence_ops.cc||tensorflow/core/kernels/sequence_ops.cc": [
          "File: tensorflow/core/kernels/sequence_ops.cc -> tensorflow/core/kernels/sequence_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "91:           errors::InvalidArgument(",
          "92:               \"Requires start >= limit when delta < 0: \", start, \"/\", limit));",
          "93:     }",
          "101:     TensorShape shape;",
          "102:     OP_REQUIRES_OK(context, shape.AddDimWithStatus(size));",
          "103:     Tensor* out = nullptr;",
          "",
          "[Removed Lines]",
          "94:     int64_t size = 0;",
          "95:     if (std::is_integral<T>::value) {",
          "96:       size = static_cast<int64_t>(",
          "97:           (std::abs(limit - start) + std::abs(delta) - 1) / std::abs(delta));",
          "98:     } else {",
          "99:       size = static_cast<int64_t>(std::ceil(std::abs((limit - start) / delta)));",
          "100:     }",
          "",
          "[Added Lines]",
          "94:     auto size_auto = (std::is_integral<T>::value",
          "95:                           ? (Eigen::numext::abs(limit - start) +",
          "96:                              Eigen::numext::abs(delta) - T(1)) /",
          "97:                                 Eigen::numext::abs(delta)",
          "98:                           : Eigen::numext::ceil(",
          "99:                                 Eigen::numext::abs((limit - start) / delta)));",
          "100:     OP_REQUIRES(",
          "101:         context, size_auto <= std::numeric_limits<int64_t>::max(),",
          "102:         errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "103:                                 std::numeric_limits<int64_t>::max()));",
          "105:     int64_t size = static_cast<int64_t>(size_auto);",
          "",
          "---------------"
        ],
        "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
          "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1489:                       Eigen::numext::abs(delta))",
          "1490:                    : (Eigen::numext::ceil(",
          "1491:                          Eigen::numext::abs((limit - start) / delta))));",
          "1492:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
          "1493:   return Status::OK();",
          "1494: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1494:   if (size > std::numeric_limits<int64_t>::max()) {",
          "1495:     return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1496:                                    std::numeric_limits<int64_t>::max());",
          "1497:   }",
          "",
          "---------------"
        ],
        "tensorflow/python/kernel_tests/array_ops/init_ops_test.py||tensorflow/python/kernel_tests/array_ops/init_ops_test.py": [
          "File: tensorflow/python/kernel_tests/array_ops/init_ops_test.py -> tensorflow/python/kernel_tests/array_ops/init_ops_test.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "548:   def testLargeStarts(self):",
          "549:     # Test case for GitHub issue 46899.",
          "550:     with self.session():",
          "552:         v = math_ops.range(start=-1e+38, limit=1)",
          "553:         self.evaluate(v)",
          "",
          "[Removed Lines]",
          "551:       with self.assertRaises(errors_impl.InvalidArgumentError):",
          "",
          "[Added Lines]",
          "551:       with self.assertRaises((ValueError, errors_impl.InvalidArgumentError)):",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "d14d72d41c8c2a9dd12d6342f904db57b36ea4ec",
      "candidate_info": {
        "commit_hash": "d14d72d41c8c2a9dd12d6342f904db57b36ea4ec",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/d14d72d41c8c2a9dd12d6342f904db57b36ea4ec",
        "files": [
          "tensorflow/core/ops/math_ops.cc"
        ],
        "message": "Fix overflow issue\n\nWe're also decreasing the test numbers by 1 as the overflow threshold is 1 less.\n\nPiperOrigin-RevId: 449856148",
        "before_after_code_files": [
          "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
          "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1475:     return errors::InvalidArgument(\"Requires delta != 0\");",
          "1476:   }",
          "1489:   }",
          "1491:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
          "",
          "[Removed Lines]",
          "1478:   auto size = (std::is_integral<T>::value",
          "1479:                    ? ((Eigen::numext::abs(limit - start) +",
          "1480:                        Eigen::numext::abs(delta) - T(1)) /",
          "1481:                       Eigen::numext::abs(delta))",
          "1482:                    : (Eigen::numext::ceil(",
          "1483:                          Eigen::numext::abs((limit - start) / delta))));",
          "1486:   if (size > std::numeric_limits<int64_t>::max()) {",
          "1487:     return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1488:                                    std::numeric_limits<int64_t>::max());",
          "",
          "[Added Lines]",
          "1478:   int64_t size;",
          "1479:   if (std::is_integral<T>::value) {",
          "1480:     size = Eigen::divup(static_cast<int64_t>(Eigen::numext::abs(limit - start)),",
          "1481:                         static_cast<int64_t>(Eigen::numext::abs(delta)));",
          "1482:   } else {",
          "1483:     auto size_auto =",
          "1484:         Eigen::numext::ceil(Eigen::numext::abs((limit - start) / delta));",
          "1485:     if (size_auto > std::numeric_limits<int64_t>::max()) {",
          "1486:       return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1487:                                      std::numeric_limits<int64_t>::max());",
          "1488:     }",
          "1489:     size = static_cast<int64_t>(size_auto);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cbde246f3141301d2bd366790f50c5d87ed095e7",
      "candidate_info": {
        "commit_hash": "cbde246f3141301d2bd366790f50c5d87ed095e7",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/cbde246f3141301d2bd366790f50c5d87ed095e7",
        "files": [
          "tensorflow/core/ops/math_ops.cc"
        ],
        "message": "Fix overflow issue\n\nWe're also decreasing the test numbers by 1 as the overflow threshold is 1 less.\n\nPiperOrigin-RevId: 449856148",
        "before_after_code_files": [
          "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
          "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1483:     return errors::InvalidArgument(\"Requires delta != 0\");",
          "1484:   }",
          "1497:   }",
          "1499:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
          "",
          "[Removed Lines]",
          "1486:   auto size = (std::is_integral<T>::value",
          "1487:                    ? ((Eigen::numext::abs(limit - start) +",
          "1488:                        Eigen::numext::abs(delta) - T(1)) /",
          "1489:                       Eigen::numext::abs(delta))",
          "1490:                    : (Eigen::numext::ceil(",
          "1491:                          Eigen::numext::abs((limit - start) / delta))));",
          "1494:   if (size > std::numeric_limits<int64_t>::max()) {",
          "1495:     return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1496:                                    std::numeric_limits<int64_t>::max());",
          "",
          "[Added Lines]",
          "1486:   int64_t size;",
          "1487:   if (std::is_integral<T>::value) {",
          "1488:     size = Eigen::divup(static_cast<int64_t>(Eigen::numext::abs(limit - start)),",
          "1489:                         static_cast<int64_t>(Eigen::numext::abs(delta)));",
          "1490:   } else {",
          "1491:     auto size_auto =",
          "1492:         Eigen::numext::ceil(Eigen::numext::abs((limit - start) / delta));",
          "1493:     if (size_auto > std::numeric_limits<int64_t>::max()) {",
          "1494:       return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1495:                                      std::numeric_limits<int64_t>::max());",
          "1496:     }",
          "1497:     size = static_cast<int64_t>(size_auto);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "66ab838126f0b0dd8854276fbef00d10268268a3",
      "candidate_info": {
        "commit_hash": "66ab838126f0b0dd8854276fbef00d10268268a3",
        "repo": "tensorflow/tensorflow",
        "commit_url": "https://github.com/tensorflow/tensorflow/commit/66ab838126f0b0dd8854276fbef00d10268268a3",
        "files": [
          "tensorflow/core/ops/math_ops.cc"
        ],
        "message": "Fix overflow issue\n\nWe're also decreasing the test numbers by 1 as the overflow threshold is 1 less.\n\nPiperOrigin-RevId: 449856148",
        "before_after_code_files": [
          "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ],
          "candidate": [
            "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc"
          ]
        }
      },
      "candidate_diff": {
        "tensorflow/core/ops/math_ops.cc||tensorflow/core/ops/math_ops.cc": [
          "File: tensorflow/core/ops/math_ops.cc -> tensorflow/core/ops/math_ops.cc",
          "--- Hunk 1 ---",
          "[Context before]",
          "1483:     return errors::InvalidArgument(\"Requires delta != 0\");",
          "1484:   }",
          "1497:   }",
          "1499:   c->set_output(0, c->Vector(static_cast<int64_t>(size)));",
          "",
          "[Removed Lines]",
          "1486:   auto size = (std::is_integral<T>::value",
          "1487:                    ? ((Eigen::numext::abs(limit - start) +",
          "1488:                        Eigen::numext::abs(delta) - T(1)) /",
          "1489:                       Eigen::numext::abs(delta))",
          "1490:                    : (Eigen::numext::ceil(",
          "1491:                          Eigen::numext::abs((limit - start) / delta))));",
          "1494:   if (size > std::numeric_limits<int64_t>::max()) {",
          "1495:     return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1496:                                    std::numeric_limits<int64_t>::max());",
          "",
          "[Added Lines]",
          "1486:   int64_t size;",
          "1487:   if (std::is_integral<T>::value) {",
          "1488:     size = Eigen::divup(static_cast<int64_t>(Eigen::numext::abs(limit - start)),",
          "1489:                         static_cast<int64_t>(Eigen::numext::abs(delta)));",
          "1490:   } else {",
          "1491:     auto size_auto =",
          "1492:         Eigen::numext::ceil(Eigen::numext::abs((limit - start) / delta));",
          "1493:     if (size_auto > std::numeric_limits<int64_t>::max()) {",
          "1494:       return errors::InvalidArgument(\"Requires ((limit - start) / delta) <= \",",
          "1495:                                      std::numeric_limits<int64_t>::max());",
          "1496:     }",
          "1497:     size = static_cast<int64_t>(size_auto);",
          "",
          "---------------"
        ]
      }
    }
  ]
}