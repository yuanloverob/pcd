{
  "cve_id": "CVE-2016-7151",
  "cve_desc": "Capstone 3.0.4 has an out-of-bounds vulnerability (SEGV caused by a read memory access) in X86_insn_reg_intel in arch/X86/X86Mapping.c.",
  "repo": "aquynh/capstone",
  "patch_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
  "patch_info": {
    "commit_hash": "87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/87a25bb543c8e4c09b48d4b4a6c7db31ce58df06",
    "files": [
      "arch/X86/X86Mapping.c"
    ],
    "message": "x86: fast path checking for X86_insn_reg_intel()",
    "before_after_code_files": [
      "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c"
    ]
  },
  "patch_diff": {
    "arch/X86/X86Mapping.c||arch/X86/X86Mapping.c": [
      "File: arch/X86/X86Mapping.c -> arch/X86/X86Mapping.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2930:  return (l - r);",
      "2931: }",
      "2937: x86_reg X86_insn_reg_intel(unsigned int id, enum cs_ac_type *access)",
      "2938: {",
      "2939:  unsigned int first = 0;",
      "2940:  unsigned int last = ARR_SIZE(insn_regs_intel) - 1;",
      "2943:  if (!intel_regs_sorted) {",
      "2944:   memcpy(insn_regs_intel_sorted, insn_regs_intel,",
      "",
      "[Removed Lines]",
      "2933: static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid = ARR_SIZE(insn_regs_intel) / 2;",
      "",
      "[Added Lines]",
      "2938:  static bool intel_regs_sorted = false;",
      "2941:  unsigned int mid;",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "2949:   intel_regs_sorted = true;",
      "2950:  }",
      "2952:  while (first <= last) {",
      "2953:   if (insn_regs_intel_sorted[mid].insn < id) {",
      "2954:    first = mid + 1;",
      "2955:   } else if (insn_regs_intel_sorted[mid].insn == id) {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2952:  if (insn_regs_intel_sorted[0].insn > id ||",
      "2953:    insn_regs_intel_sorted[last].insn < id) {",
      "2954:   return 0;",
      "2955:  }",
      "2958:   mid = (first + last) / 2;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2962:     break;",
      "2963:    last = mid - 1;",
      "2964:   }",
      "2966:  }",
      "",
      "[Removed Lines]",
      "2965:   mid = (first + last) / 2;",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "375d7432c80675e6ce4ba46519776cab1018009b",
      "candidate_info": {
        "commit_hash": "375d7432c80675e6ce4ba46519776cab1018009b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/375d7432c80675e6ce4ba46519776cab1018009b",
        "files": [
          "include/capstone.h",
          "tests/test_skipdata.c"
        ],
        "message": "Rename CS_OPT_NONE to CS_OPT_INVALID",
        "before_after_code_files": [
          "include/capstone.h||include/capstone.h",
          "tests/test_skipdata.c||tests/test_skipdata.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "include/capstone.h||include/capstone.h": [
          "File: include/capstone.h -> include/capstone.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "122: typedef enum cs_opt_type {",
          "124:  CS_OPT_SYNTAX, // Assembly output syntax",
          "125:  CS_OPT_DETAIL, // Break down instruction structure into details",
          "126:  CS_OPT_MODE, // Change engine's mode at run-time",
          "",
          "[Removed Lines]",
          "123:  CS_OPT_NONE = 0, // No opetion specified",
          "",
          "[Added Lines]",
          "123:  CS_OPT_INVALID = 0, // No opetion specified",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "173:  @return: return number of bytes to skip, or 0 to immediately stop disassembling.",
          "178: typedef struct cs_opt_skipdata {",
          "",
          "[Removed Lines]",
          "175: typedef size_t (CAPSTONE_API*cs_skipdata_cb_t)(const uint8_t *code, size_t code_size, size_t offset, void *user_data);",
          "",
          "[Added Lines]",
          "175: typedef size_t (*cs_skipdata_cb_t)(const uint8_t *code, size_t code_size, size_t offset, void *user_data);",
          "",
          "---------------"
        ],
        "tests/test_skipdata.c||tests/test_skipdata.c": [
          "File: tests/test_skipdata.c -> tests/test_skipdata.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "30:  printf(\"\\n\");",
          "31: }",
          "34: {",
          "36:  return 2;",
          "",
          "[Removed Lines]",
          "33: static size_t CAPSTONE_API mycallback(const uint8_t *buffer, size_t buffer_size, size_t offset, void *p)",
          "",
          "[Added Lines]",
          "33: static size_t mycallback(const uint8_t *buffer, size_t buffer_size, size_t offset, void *p)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "72:    (unsigned char*)X86_CODE32,",
          "73:    sizeof(X86_CODE32) - 1,",
          "74:    \"X86 32 (Intel syntax) - Skip data with custom mnemonic\",",
          "76:    CS_OPT_OFF,",
          "77:    CS_OPT_SKIPDATA_SETUP,",
          "78:    (size_t) &skipdata,",
          "",
          "[Removed Lines]",
          "75:    CS_OPT_NONE,",
          "",
          "[Added Lines]",
          "75:    CS_OPT_INVALID,",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "83:    (unsigned char*)RANDOM_CODE,",
          "84:    sizeof(RANDOM_CODE) - 1,",
          "85:    \"Arm - Skip data with callback\",",
          "87:    CS_OPT_OFF,",
          "88:    CS_OPT_SKIPDATA_SETUP,",
          "89:    (size_t) &skipdata_callback,",
          "",
          "[Removed Lines]",
          "86:    CS_OPT_NONE,",
          "",
          "[Added Lines]",
          "86:    CS_OPT_INVALID,",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "918215d7efb8f85fafc0ebdc865f7968060cba1b",
      "candidate_info": {
        "commit_hash": "918215d7efb8f85fafc0ebdc865f7968060cba1b",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/918215d7efb8f85fafc0ebdc865f7968060cba1b",
        "files": [
          "arch/M68K/M68KDisassembler.c",
          "suite/arm/test_arm_regression.c"
        ],
        "message": "fix some MSVC warnings",
        "before_after_code_files": [
          "arch/M68K/M68KDisassembler.c||arch/M68K/M68KDisassembler.c",
          "suite/arm/test_arm_regression.c||suite/arm/test_arm_regression.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/M68K/M68KDisassembler.c||arch/M68K/M68KDisassembler.c": [
          "File: arch/M68K/M68KDisassembler.c -> arch/M68K/M68KDisassembler.c"
        ],
        "suite/arm/test_arm_regression.c||suite/arm/test_arm_regression.c": [
          "File: suite/arm/test_arm_regression.c -> suite/arm/test_arm_regression.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "5: #ifdef _MSC_VER",
          "9: #include <stdio.h>",
          "10: #include <stdlib.h>",
          "11: #include <string.h>",
          "",
          "[Removed Lines]",
          "6: #define _CRT_SECURE_NO_WARNINGS",
          "7: #define snprintf _snprintf",
          "8: #endif",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "f78a41eb0b6c8df618f77546724768fb1adb9d59",
      "candidate_info": {
        "commit_hash": "f78a41eb0b6c8df618f77546724768fb1adb9d59",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/f78a41eb0b6c8df618f77546724768fb1adb9d59",
        "files": [
          "bindings/ocaml/test_basic.ml"
        ],
        "message": "ocaml: recover test_basic.ml",
        "before_after_code_files": [
          "bindings/ocaml/test_basic.ml||bindings/ocaml/test_basic.ml"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/ocaml/test_basic.ml||bindings/ocaml/test_basic.ml": [
          "File: bindings/ocaml/test_basic.ml -> bindings/ocaml/test_basic.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: (* Capstone Disassembly Engine",
          "4: open Printf",
          "5: open List",
          "6: open Capstone",
          "8: let _X86_CODE16 = \"\\x8d\\x4c\\x32\\x08\\x01\\xd8\\x81\\xc6\\x34\\x12\\x00\\x00\";;",
          "9: let _X86_CODE32 = \"\\x8d\\x4c\\x32\\x08\\x01\\xd8\\x81\\xc6\\x34\\x12\\x00\\x00\";;",
          "10: let _X86_CODE64 = \"\\x55\\x48\\x8b\\x05\\xb8\\x13\\x00\\x00\";;",
          "11: let _ARM_CODE = \"\\xED\\xFF\\xFF\\xEB\\x04\\xe0\\x2d\\xe5\\x00\\x00\\x00\\x00\\xe0\\x83\\x22\\xe5\\xf1\\x02\\x03\\x0e\\x00\\x00\\xa0\\xe3\\x02\\x30\\xc1\\xe7\\x00\\x00\\x53\\xe3\";;",
          "12: let _ARM_CODE2 = \"\\x10\\xf1\\x10\\xe7\\x11\\xf2\\x31\\xe7\\xdc\\xa1\\x2e\\xf3\\xe8\\x4e\\x62\\xf3\";;",
          "13: let _THUMB_CODE = \"\\x70\\x47\\xeb\\x46\\x83\\xb0\\xc9\\x68\";;",
          "14: let _THUMB_CODE2 = \"\\x4f\\xf0\\x00\\x01\\xbd\\xe8\\x00\\x88\";;",
          "15: let _MIPS_CODE = \"\\x0C\\x10\\x00\\x97\\x00\\x00\\x00\\x00\\x24\\x02\\x00\\x0c\\x8f\\xa2\\x00\\x00\\x34\\x21\\x34\\x56\";;",
          "16: let _MIPS_CODE2 = \"\\x56\\x34\\x21\\x34\\xc2\\x17\\x01\\x00\";;",
          "17: let _ARM64_CODE = \"\\x21\\x7c\\x02\\x9b\\x21\\x7c\\x00\\x53\\x00\\x40\\x21\\x4b\\xe1\\x0b\\x40\\xb9\";;",
          "18: let _PPC_CODE = \"\\x80\\x20\\x00\\x00\\x80\\x3f\\x00\\x00\\x10\\x43\\x23\\x0e\\xd0\\x44\\x00\\x80\\x4c\\x43\\x22\\x02\\x2d\\x03\\x00\\x80\\x7c\\x43\\x20\\x14\\x7c\\x43\\x20\\x93\\x4f\\x20\\x00\\x21\\x4c\\xc8\\x00\\x21\";;",
          "19: let _SPARC_CODE = \"\\x80\\xa0\\x40\\x02\\x85\\xc2\\x60\\x08\\x85\\xe8\\x20\\x01\\x81\\xe8\\x00\\x00\\x90\\x10\\x20\\x01\\xd5\\xf6\\x10\\x16\\x21\\x00\\x00\\x0a\\x86\\x00\\x40\\x02\\x01\\x00\\x00\\x00\\x12\\xbf\\xff\\xff\\x10\\xbf\\xff\\xff\\xa0\\x02\\x00\\x09\\x0d\\xbf\\xff\\xff\\xd4\\x20\\x60\\x00\\xd4\\x4e\\x00\\x16\\x2a\\xc2\\x80\\x03\";;",
          "20: let _SPARCV9_CODE = \"\\x81\\xa8\\x0a\\x24\\x89\\xa0\\x10\\x20\\x89\\xa0\\x1a\\x60\\x89\\xa0\\x00\\xe0\";;",
          "21: let _SYSZ_CODE = \"\\xed\\x00\\x00\\x00\\x00\\x1a\\x5a\\x0f\\x1f\\xff\\xc2\\x09\\x80\\x00\\x00\\x00\\x07\\xf7\\xeb\\x2a\\xff\\xff\\x7f\\x57\\xe3\\x01\\xff\\xff\\x7f\\x57\\xeb\\x00\\xf0\\x00\\x00\\x24\\xb2\\x4f\\x00\\x78\";;",
          "22: let _XCORE_CODE = \"\\xfe\\x0f\\xfe\\x17\\x13\\x17\\xc6\\xfe\\xec\\x17\\x97\\xf8\\xec\\x4f\\x1f\\xfd\\xec\\x37\\x07\\xf2\\x45\\x5b\\xf9\\xfa\\x02\\x06\\x1b\\x10\";;",
          "24: let all_tests = [",
          "25:  (CS_ARCH_X86, [CS_MODE_16], _X86_CODE16, \"X86 16bit (Intel syntax)\", 0L);",
          "26:  (CS_ARCH_X86, [CS_MODE_32], _X86_CODE32, \"X86 32bit (ATT syntax)\", _CS_OPT_SYNTAX_ATT);",
          "27:  (CS_ARCH_X86, [CS_MODE_32], _X86_CODE32, \"X86 32 (Intel syntax)\", 0L);",
          "28:  (CS_ARCH_X86, [CS_MODE_64], _X86_CODE64, \"X86 64 (Intel syntax)\", 0L);",
          "29:  (CS_ARCH_ARM, [CS_MODE_ARM], _ARM_CODE, \"ARM\", 0L);",
          "30:  (CS_ARCH_ARM, [CS_MODE_ARM], _ARM_CODE2, \"ARM: Cortex-A15 + NEON\", 0L);",
          "31:  (CS_ARCH_ARM, [CS_MODE_THUMB], _THUMB_CODE, \"THUMB\", 0L);",
          "32:  (CS_ARCH_ARM, [CS_MODE_THUMB], _THUMB_CODE2, \"THUMB-2\", 0L);",
          "33:  (CS_ARCH_ARM64, [CS_MODE_ARM], _ARM64_CODE, \"ARM-64\", 0L);",
          "34:  (CS_ARCH_MIPS, [CS_MODE_MIPS32; CS_MODE_BIG_ENDIAN], _MIPS_CODE, \"MIPS-32 (Big-endian)\", 0L);",
          "35:  (CS_ARCH_MIPS, [CS_MODE_MIPS64; CS_MODE_LITTLE_ENDIAN], _MIPS_CODE2, \"MIPS-64-EL (Little-endian)\", 0L);",
          "36:         (CS_ARCH_PPC, [CS_MODE_BIG_ENDIAN], _PPC_CODE, \"PPC-64\", 0L);",
          "37:         (CS_ARCH_PPC, [CS_MODE_BIG_ENDIAN], _PPC_CODE, \"PPC-64, print register with number only\", 0L);",
          "38:         (CS_ARCH_SPARC, [CS_MODE_BIG_ENDIAN], _SPARC_CODE, \"Sparc\", 0L);",
          "39:         (CS_ARCH_SPARC, [CS_MODE_BIG_ENDIAN; CS_MODE_V9], _SPARCV9_CODE, \"SparcV9\", 0L);",
          "40:         (CS_ARCH_SYSZ, [CS_MODE_LITTLE_ENDIAN], _SYSZ_CODE, \"SystemZ\", 0L);",
          "41:         (CS_ARCH_XCORE, [CS_MODE_LITTLE_ENDIAN], _XCORE_CODE, \"XCore\", 0L);",
          "42: ];;",
          "45: let print_insn insn =",
          "46:  printf \"0x%x\\t%s\\t%s\\n\" insn.address insn.mnemonic insn.op_str;;",
          "48: let print_arch x =",
          "49:  let (arch, mode, code, comment, syntax) = x in",
          "50:  let handle = cs_open arch mode in (",
          "51:   if syntax != 0L then (",
          "52:    let err = cs_option handle CS_OPT_SYNTAX syntax in",
          "53:    match err with",
          "54:    | _ -> ();",
          "55:   );",
          "56:   let insns = cs_disasm handle code 0x1000L 0L in (",
          "57:    printf \"*************\\n\";",
          "58:    printf \"Platform: %s\\n\" comment;",
          "59:    List.iter print_insn insns;",
          "60:   );",
          "61:   match cs_close handle with",
          "62:   | 0 -> ();",
          "63:   | _ -> printf \"Failed to close handle\";",
          "64:  );;",
          "67: List.iter print_arch all_tests;;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ef4a2dbccc2a2f1b3bba22cb96e9214c241747db",
      "candidate_info": {
        "commit_hash": "ef4a2dbccc2a2f1b3bba22cb96e9214c241747db",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/ef4a2dbccc2a2f1b3bba22cb96e9214c241747db",
        "files": [
          "tests/test_x86.c"
        ],
        "message": "tests: cleanup",
        "before_after_code_files": [
          "tests/test_x86.c||tests/test_x86.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "tests/test_x86.c||tests/test_x86.c": [
          "File: tests/test_x86.c -> tests/test_x86.c"
        ]
      }
    },
    {
      "candidate_hash": "921904888d7c1547c558db3a24fa64bcf97dede4",
      "candidate_info": {
        "commit_hash": "921904888d7c1547c558db3a24fa64bcf97dede4",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/921904888d7c1547c558db3a24fa64bcf97dede4",
        "files": [
          "arch/X86/X86DisassemblerDecoder.c"
        ],
        "message": "x86: coding style",
        "before_after_code_files": [
          "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/X86/X86DisassemblerDecoder.c||arch/X86/X86DisassemblerDecoder.c": [
          "File: arch/X86/X86DisassemblerDecoder.c -> arch/X86/X86DisassemblerDecoder.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "352: static void setPrefixPresent(struct InternalInstruction *insn,",
          "353:   uint8_t prefix, uint64_t location)",
          "354: {",
          "357:  case 0x26:",
          "358:   insn->isPrefix26 = true;",
          "359:   insn->prefix26 = location;",
          "",
          "[Removed Lines]",
          "355:  switch (prefix)",
          "356:  {",
          "",
          "[Added Lines]",
          "355:  switch (prefix) {",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "415: static bool isPrefixAtLocation(struct InternalInstruction *insn, uint8_t prefix,",
          "416:   uint64_t location)",
          "417: {",
          "420:  case 0x26:",
          "421:   if (insn->isPrefix26 && insn->prefix26 == location)",
          "422:    return true;",
          "",
          "[Removed Lines]",
          "418:  switch (prefix)",
          "419:  {",
          "",
          "[Added Lines]",
          "417:  switch (prefix) {",
          "",
          "---------------"
        ]
      }
    }
  ]
}