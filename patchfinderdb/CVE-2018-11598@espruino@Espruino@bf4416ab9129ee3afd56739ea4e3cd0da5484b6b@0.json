{
  "cve_id": "CVE-2018-11598",
  "cve_desc": "Espruino before 1.99 allows attackers to cause a denial of service (application crash) and a potential Information Disclosure with user crafted input files via a Buffer Overflow or Out-of-bounds Read during syntax parsing of certain for loops in jsparse.c.",
  "repo": "espruino/Espruino",
  "patch_hash": "bf4416ab9129ee3afd56739ea4e3cd0da5484b6b",
  "patch_info": {
    "commit_hash": "bf4416ab9129ee3afd56739ea4e3cd0da5484b6b",
    "repo": "espruino/Espruino",
    "commit_url": "https://github.com/espruino/Espruino/commit/bf4416ab9129ee3afd56739ea4e3cd0da5484b6b",
    "files": [
      "ChangeLog",
      "src/jsparse.c"
    ],
    "message": "Fix bug if using an undefined member of an object for for..in (fix #1437)",
    "before_after_code_files": [
      "src/jsparse.c||src/jsparse.c"
    ]
  },
  "patch_diff": {
    "src/jsparse.c||src/jsparse.c": [
      "File: src/jsparse.c -> src/jsparse.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "122:   }",
      "123: }",
      "125: bool jspeiAddScope(JsVar *scope) {",
      "126:   if (execInfo.scopeCount >= JSPARSE_MAX_SCOPES) {",
      "127:     jsExceptionHere(JSET_ERROR, \"Maximum number of scopes exceeded\");",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "125: void jspReplaceWithOrAddToRoot(JsVar *dst, JsVar *src) {",
      "128:   if (!jsvGetRefs(dst) && jsvIsName(dst)) {",
      "129:     if (!jsvIsArrayBufferName(dst) && !jsvIsNewChild(dst))",
      "130:       jsvAddName(execInfo.root, dst);",
      "131:   }",
      "132:   jspReplaceWith(dst, src);",
      "133: }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1972:     if (JSP_SHOULD_EXECUTE && lhs) {",
      "1973:       if (op=='=') {",
      "1981:       } else {",
      "1982:         if (op==LEX_PLUSEQUAL) op='+';",
      "1983:         else if (op==LEX_MINUSEQUAL) op='-';",
      "",
      "[Removed Lines]",
      "1976:         if (!jsvGetRefs(lhs) && jsvIsName(lhs)) {",
      "1977:           if (!jsvIsArrayBufferName(lhs) && !jsvIsNewChild(lhs))",
      "1978:             jsvAddName(execInfo.root, lhs);",
      "1979:         }",
      "1980:         jspReplaceWith(lhs, rhs);",
      "",
      "[Added Lines]",
      "1984:         jspReplaceWithOrAddToRoot(lhs, rhs);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2330:       jsExceptionHere(JSET_ERROR, \"FOR a IN b - 'a' must be a variable name, not %t\", forStatement);",
      "2331:       return 0;",
      "2332:     }",
      "2339:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(LEX_R_IN, jsvUnLock(forStatement), 0);",
      "2340:     JsVar *array = jsvSkipNameAndUnLock(jspeExpression());",
      "2341:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(')', jsvUnLock2(forStatement, array), 0);",
      "",
      "[Removed Lines]",
      "2333:     bool addedIteratorToScope = false;",
      "2334:     if (JSP_SHOULD_EXECUTE && !jsvGetRefs(forStatement)) {",
      "2336:       addedIteratorToScope = true;",
      "2337:       jsvAddName(execInfo.root, forStatement);",
      "2338:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2371:                 loopIndexVar;",
      "2372:             if (indexValue) { // could be out of memory",
      "2373:               assert(!jsvIsName(indexValue) && jsvGetRefs(indexValue)==0);",
      "2375:               if (indexValue!=loopIndexVar) jsvUnLock(indexValue);",
      "2377:               jsvIteratorNext(&it);",
      "",
      "[Removed Lines]",
      "2374:               jsvSetValueOfName(forStatement, indexValue);",
      "",
      "[Added Lines]",
      "2372:               jspReplaceWithOrAddToRoot(forStatement, indexValue);",
      "",
      "---------------",
      "--- Hunk 5 ---",
      "[Context before]",
      "2410:     jslCharPosFree(&forBodyStart);",
      "2411:     jslCharPosFree(&forBodyEnd);",
      "2416:     jsvUnLock2(forStatement, array);",
      "2417:   } else { // ----------------------------------------------- NORMAL FOR LOOP",
      "2418: #ifdef JSPARSE_MAX_LOOP_ITERATIONS",
      "",
      "[Removed Lines]",
      "2413:     if (addedIteratorToScope) {",
      "2414:       jsvRemoveChild(execInfo.root, forStatement);",
      "2415:     }",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "5aad237f72c891d4abe34438dda91ff4ac2d9f31",
      "candidate_info": {
        "commit_hash": "5aad237f72c891d4abe34438dda91ff4ac2d9f31",
        "repo": "espruino/Espruino",
        "commit_url": "https://github.com/espruino/Espruino/commit/5aad237f72c891d4abe34438dda91ff4ac2d9f31",
        "files": [
          "ChangeLog",
          "src/jsparse.c",
          "src/jsparse.h",
          "src/jsvar.c",
          "src/jsvar.h",
          "src/jsvariterator.c",
          "src/jswrap_json.c",
          "src/jswrap_object.c",
          "src/jswrap_process.c",
          "tests/test_getter.js",
          "tests/test_setter.js"
        ],
        "message": "Added getter and setter support",
        "before_after_code_files": [
          "src/jsparse.c||src/jsparse.c",
          "src/jsparse.h||src/jsparse.h",
          "src/jsvar.c||src/jsvar.c",
          "src/jsvar.h||src/jsvar.h",
          "src/jsvariterator.c||src/jsvariterator.c",
          "src/jswrap_json.c||src/jswrap_json.c",
          "src/jswrap_object.c||src/jswrap_object.c",
          "src/jswrap_process.c||src/jswrap_process.c",
          "tests/test_getter.js||tests/test_getter.js",
          "tests/test_setter.js||tests/test_setter.js"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/jsparse.c||src/jsparse.c"
          ],
          "candidate": [
            "src/jsparse.c||src/jsparse.c"
          ]
        }
      },
      "candidate_diff": {
        "src/jsparse.c||src/jsparse.c": [
          "File: src/jsparse.c -> src/jsparse.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "81:   return JSP_HAS_ERROR;",
          "82: }",
          "135: bool jspeiAddScope(JsVar *scope) {",
          "136:   if (execInfo.scopeCount >= JSPARSE_MAX_SCOPES) {",
          "137:     jsExceptionHere(JSET_ERROR, \"Maximum number of scopes exceeded\");",
          "",
          "[Removed Lines]",
          "84: void jspReplaceWith(JsVar *dst, JsVar *src) {",
          "86:   if (jsvIsArrayBufferName(dst)) {",
          "87:     size_t idx = (size_t)jsvGetInteger(dst);",
          "88:     JsVar *arrayBuffer = jsvLock(jsvGetFirstChild(dst));",
          "89:     jsvArrayBufferSet(arrayBuffer, idx, src);",
          "90:     jsvUnLock(arrayBuffer);",
          "91:     return;",
          "92:   }",
          "94:   if (!jsvIsName(dst)) {",
          "95:     jsExceptionHere(JSET_ERROR, \"Unable to assign value to non-reference %t\", dst);",
          "96:     return;",
          "97:   }",
          "98:   jsvSetValueOfName(dst, src);",
          "103:   if (jsvIsNewChild(dst)) {",
          "105:     JsVar *parent = jsvLock(jsvGetNextSibling(dst));",
          "106:     if (!jsvIsString(parent)) {",
          "109:       if (!jsvHasChildren(parent)) {",
          "110:         jsExceptionHere(JSET_ERROR, \"Field or method \\\"%s\\\" does not already exist, and can't create it on %t\", dst, parent);",
          "111:       } else {",
          "113:         jsvUnRef(parent);",
          "114:         jsvSetNextSibling(dst, 0);",
          "115:         jsvUnRef(parent);",
          "116:         jsvSetPrevSibling(dst, 0);",
          "118:         jsvAddName(parent, dst);",
          "119:       }",
          "120:     }",
          "121:     jsvUnLock(parent);",
          "122:   }",
          "123: }",
          "125: void jspReplaceWithOrAddToRoot(JsVar *dst, JsVar *src) {",
          "128:   if (!jsvGetRefs(dst) && jsvIsName(dst)) {",
          "129:     if (!jsvIsArrayBufferName(dst) && !jsvIsNewChild(dst))",
          "130:       jsvAddName(execInfo.root, dst);",
          "131:   }",
          "132:   jspReplaceWith(dst, src);",
          "133: }",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1273:       } else {",
          "1274:         JSP_MATCH_WITH_RETURN(LEX_ID, contents);",
          "1275:       }",
          "1283:         }",
          "1284:       }",
          "1285:       jsvUnLock(varName);",
          "",
          "[Removed Lines]",
          "1276:       JSP_MATCH_WITH_CLEANUP_AND_RETURN(':', jsvUnLock(varName), contents);",
          "1277:       if (JSP_SHOULD_EXECUTE) {",
          "1278:         varName = jsvAsArrayIndexAndUnLock(varName);",
          "1279:         JsVar *contentsName = jsvFindChildFromVar(contents, varName, true);",
          "1280:         if (contentsName) {",
          "1281:           JsVar *value = jsvSkipNameAndUnLock(jspeAssignmentExpression()); // value can be 0 (could be undefined!)",
          "1282:           jsvUnLock2(jsvSetValueOfName(contentsName, value), value);",
          "",
          "[Added Lines]",
          "1225: #ifndef SAVE_ON_FLASH",
          "1226:       bool isGetter, isSetter;",
          "1227:       if (lex->tk==LEX_ID && jsvIsString(varName)) {",
          "1228:         isGetter = jsvIsStringEqual(varName, \"get\");",
          "1229:         isSetter = jsvIsStringEqual(varName, \"set\");",
          "1230:         if (isGetter || isSetter) {",
          "1231:           jsvUnLock(varName);",
          "1232:           varName = jslGetTokenValueAsVar(lex);",
          "1233:           JSP_ASSERT_MATCH(LEX_ID);",
          "1234:           JsVar *method = jspeFunctionDefinition(false);",
          "1235:           jsvAddGetterOrSetter(contents, varName, isGetter, method);",
          "1236:           jsvUnLock(method);",
          "1237:         }",
          "1238:       } else",
          "1239: #endif",
          "1240:       {",
          "1241:         JSP_MATCH_WITH_CLEANUP_AND_RETURN(':', jsvUnLock(varName), contents);",
          "1242:         if (JSP_SHOULD_EXECUTE) {",
          "1243:           varName = jsvAsArrayIndexAndUnLock(varName);",
          "1244:           JsVar *contentsName = jsvFindChildFromVar(contents, varName, true);",
          "1245:           if (contentsName) {",
          "1246:             JsVar *value = jsvSkipNameAndUnLock(jspeAssignmentExpression()); // value can be 0 (could be undefined!)",
          "1247:             jsvUnLock2(jsvSetValueOfName(contentsName, value), value);",
          "1248:           }",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "1551:     if (isStatic) JSP_ASSERT_MATCH(LEX_R_STATIC);",
          "1553:     JsVar *funcName = jslGetTokenValueAsVar(lex);",
          "1555:     JsVar *method = jspeFunctionDefinition(false);",
          "1556:     if (classFunction && classPrototype) {",
          "1560:         jswrap_function_replaceWith(classFunction, method);",
          "1561:       } else {",
          "1562:         funcName = jsvMakeIntoVariableName(funcName, 0);",
          "1563:         jsvSetValueOfName(funcName, method);",
          "1565:       }",
          "1566:     }",
          "1567:     jsvUnLock2(method,funcName);",
          "1568:   }",
          "",
          "[Removed Lines]",
          "1554:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(LEX_ID,jsvUnLock3(classFunction,classInternalName,classPrototype),0);",
          "1557:       if (jsvIsStringEqual(funcName, \"get\") || jsvIsStringEqual(funcName, \"set\")) {",
          "1558:         jsExceptionHere(JSET_SYNTAXERROR, \"'get' and 'set' and not supported in Espruino\");",
          "1559:       } else if (jsvIsStringEqual(funcName, \"constructor\")) {",
          "1564:         jsvAddName(isStatic ? classFunction : classPrototype, funcName);",
          "",
          "[Added Lines]",
          "1520:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(LEX_ID,jsvUnLock4(funcName,classFunction,classInternalName,classPrototype),0);",
          "1521: #ifndef SAVE_ON_FLASH",
          "1522:     bool isGetter, isSetter;",
          "1523:     if (lex->tk==LEX_ID) {",
          "1524:       isGetter = jsvIsStringEqual(funcName, \"get\");",
          "1525:       isSetter = jsvIsStringEqual(funcName, \"set\");",
          "1526:       if (isGetter || isSetter) {",
          "1527:         jsvUnLock(funcName);",
          "1528:         funcName = jslGetTokenValueAsVar(lex);",
          "1529:         JSP_ASSERT_MATCH(LEX_ID);",
          "1530:       }",
          "1531:     }",
          "1532: #endif",
          "1536:       JsVar *obj = isStatic ? classFunction : classPrototype;",
          "1537:       if (jsvIsStringEqual(funcName, \"constructor\")) {",
          "1539: #ifndef SAVE_ON_FLASH",
          "1540:       } else if (isGetter || isSetter) {",
          "1541:         jsvAddGetterOrSetter(obj, funcName, isGetter, method);",
          "1542: #endif",
          "1546:         jsvAddName(obj, funcName);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1748:       jsvUnLock(one);",
          "1752:       jsvUnLock(res);",
          "1754:       jsvUnLock(a);",
          "",
          "[Removed Lines]",
          "1751:       jspReplaceWith(a, res);",
          "",
          "[Added Lines]",
          "1734:       jsvReplaceWith(a, res);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1770:       JsVar *res = jsvMathsOpSkipNames(a, one, op==LEX_PLUSPLUS ? '+' : '-');",
          "1771:       jsvUnLock(one);",
          "1774:       jsvUnLock(res);",
          "1775:     }",
          "1776:   } else",
          "",
          "[Removed Lines]",
          "1773:       jspReplaceWith(a, res);",
          "",
          "[Added Lines]",
          "1756:       jsvReplaceWith(a, res);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1983:     if (JSP_SHOULD_EXECUTE && lhs) {",
          "1984:       if (op=='=') {",
          "1986:       } else {",
          "1987:         if (op==LEX_PLUSEQUAL) op='+';",
          "1988:         else if (op==LEX_MINUSEQUAL) op='-';",
          "",
          "[Removed Lines]",
          "1985:         jspReplaceWithOrAddToRoot(lhs, rhs);",
          "",
          "[Added Lines]",
          "1968:         jsvReplaceWithOrAddToRoot(lhs, rhs);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2011:         if (op) {",
          "2013:           JsVar *res = jsvMathsOpSkipNames(lhs,rhs,op);",
          "2015:           jsvUnLock(res);",
          "2016:         }",
          "2017:       }",
          "",
          "[Removed Lines]",
          "2014:           jspReplaceWith(lhs, res);",
          "",
          "[Added Lines]",
          "1997:           jsvReplaceWith(lhs, res);",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "2127:       JSP_MATCH_WITH_CLEANUP_AND_RETURN('=', jsvUnLock(a), lastDefined);",
          "2128:       var = jsvSkipNameAndUnLock(jspeAssignmentExpression());",
          "2129:       if (JSP_SHOULD_EXECUTE)",
          "2131:       jsvUnLock(var);",
          "2132:     }",
          "2133:     jsvUnLock(lastDefined);",
          "",
          "[Removed Lines]",
          "2130:         jspReplaceWith(a, var);",
          "",
          "[Added Lines]",
          "2113:         jsvReplaceWith(a, var);",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2400:             }",
          "2401:             if (isForOf || iteratorValue) { // could be out of memory",
          "2402:               assert(!jsvIsName(iteratorValue));",
          "2404:               if (iteratorValue!=loopIndexVar) jsvUnLock(iteratorValue);",
          "2406:               jslSeekToP(&forBodyStart);",
          "",
          "[Removed Lines]",
          "2403:               jspReplaceWithOrAddToRoot(forStatement, iteratorValue);",
          "",
          "[Added Lines]",
          "2386:               jsvReplaceWithOrAddToRoot(forStatement, iteratorValue);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "2600:   if (JSP_SHOULD_EXECUTE) {",
          "2601:     JsVar *resultVar = jspeiFindInScopes(JSPARSE_RETURN_VAR);",
          "2602:     if (resultVar) {",
          "2604:       jsvUnLock(resultVar);",
          "2605:       execInfo.execute |= EXEC_RETURN; // Stop anything else in this function executing",
          "2606:     } else {",
          "",
          "[Removed Lines]",
          "2603:       jspReplaceWith(resultVar, result);",
          "",
          "[Added Lines]",
          "2586:       jsvReplaceWith(resultVar, result);",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "2655:       funcVar = jsvSkipNameAndUnLock(funcVar);",
          "2656:       jswrap_function_replaceWith(existingFunc, funcVar);",
          "2657:     } else {",
          "2659:     }",
          "2660:     jsvUnLock(funcName);",
          "2661:     funcName = existingName;",
          "",
          "[Removed Lines]",
          "2658:       jspReplaceWith(existingName, funcVar);",
          "",
          "[Added Lines]",
          "2641:       jsvReplaceWith(existingName, funcVar);",
          "",
          "---------------"
        ],
        "src/jsparse.h||src/jsparse.h": [
          "File: src/jsparse.h -> src/jsparse.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "194: JsVar *jspeiFindInScopes(const char *name);",
          "",
          "[Removed Lines]",
          "195: void jspReplaceWith(JsVar *dst, JsVar *src);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/jsvar.c||src/jsvar.c": [
          "File: src/jsvar.c -> src/jsvar.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "91: bool jsvIsNameIntBool(const JsVar *v) { return v && (v->flags&JSV_VARTYPEMASK)==JSV_NAME_INT_BOOL; }",
          "93: bool jsvIsNewChild(const JsVar *v) { return jsvIsName(v) && jsvGetNextSibling(v) && jsvGetNextSibling(v)==jsvGetPrevSibling(v); }",
          "95: bool jsvIsRefUsedForData(const JsVar *v) { return jsvIsStringExt(v) || (jsvIsString(v)&&!jsvIsName(v)) ||  jsvIsFloat(v) || jsvIsNativeFunction(v) || jsvIsArrayBuffer(v) || jsvIsArrayBufferName(v); }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "95: bool jsvIsGetterOrSetter(const JsVar *v) {",
          "96: #ifdef SAVE_ON_FLASH",
          "97:   return false;",
          "98: #else",
          "99:   return v && (v->flags&JSV_VARTYPEMASK)==JSV_GET_SET;",
          "100: #endif",
          "101: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "359: }",
          "361: bool jsvHasChildren(const JsVar *v) {",
          "363: }",
          "",
          "[Removed Lines]",
          "362:   return jsvIsFunction(v) || jsvIsObject(v) || jsvIsArray(v) || jsvIsRoot(v);",
          "",
          "[Added Lines]",
          "370:   return jsvIsFunction(v) || jsvIsObject(v) || jsvIsArray(v) || jsvIsRoot(v) || jsvIsGetterOrSetter(v);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "641:   return var;",
          "642: }",
          "645: ALWAYS_INLINE JsVar *jsvLockAgain(JsVar *var) {",
          "646:   assert(var);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "653: JsVar *jsvLockSafe(JsVarRef ref) {",
          "654:   if (!ref) return 0;",
          "655:   return jsvLock(ref);",
          "656: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1192:     len--;",
          "1194:     while (s[l] && l<len) {",
          "1195:       str[l] = s[l];",
          "1196:       l++;",
          "",
          "[Removed Lines]",
          "1193:     int l = 0;",
          "",
          "[Added Lines]",
          "1207:     size_t l = 0;",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "1410:     jsvUnLock(newVar); // note use of if (ref), not var",
          "1412:   }",
          "1413:   jsvUnLock(newVar); // note use of if (ref), not var",
          "1414:   return strLength;",
          "",
          "[Removed Lines]",
          "1411:     var = newVar = ref ? jsvLock(ref) : 0;",
          "",
          "[Added Lines]",
          "1425:     var = newVar = jsvLockSafe(ref);",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "1863: JsVarFloat jsvGetFloatAndUnLock(JsVar *v) { return _jsvGetFloatAndUnLock(v); }",
          "1864: bool jsvGetBoolAndUnLock(JsVar *v) { return _jsvGetBoolAndUnLock(v); }",
          "1867: size_t jsvGetArrayBufferLength(const JsVar *arrayBuffer) {",
          "1868:   assert(jsvIsArrayBuffer(arrayBuffer));",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1881: #ifndef SAVE_ON_FLASH",
          "1883: JsVar *jsvExecuteGetter(JsVar *getset) {",
          "1884:   assert(jsvIsGetterOrSetter(getset));",
          "1885:   if (!jsvIsGetterOrSetter(getset)) return 0; // wasn't an object?",
          "1886:   JsVar *fn = jsvObjectGetChild(getset, \"get\", 0);",
          "1887:   if (!jsvIsFunction(fn)) {",
          "1888:     jsvUnLock(fn);",
          "1889:     return 0;",
          "1890:   }",
          "1891:   JsVar *this = jsvObjectGetChild(getset, \"this\", 0);",
          "1892:   JsVar *result = jspExecuteFunction(fn, this, 0, NULL);",
          "1893:   jsvUnLock2(fn, this);",
          "1894:   return result;",
          "1895: }",
          "1898: void jsvExecuteSetter(JsVar *getset, JsVar *value) {",
          "1899:   assert(jsvIsGetterOrSetter(getset));",
          "1900:   if (!jsvIsGetterOrSetter(getset)) return; // wasn't an object?",
          "1901:   JsVar *fn = jsvObjectGetChild(getset, \"set\", 0);",
          "1902:   if (!jsvIsFunction(fn)) {",
          "1903:     jsvUnLock(fn);",
          "1904:     return;",
          "1905:   }",
          "1906:   if (!fn) return;",
          "1907:   JsVar *this = jsvObjectGetChild(getset, \"this\", 0);",
          "1908:   jsvUnLock3(jspExecuteFunction(fn, this, 1, &value), fn, this);",
          "1909: }",
          "1912: void jsvAddGetterOrSetter(JsVar *obj, JsVar *varName, bool isGetter, JsVar *method) {",
          "1914:   JsVar *getsetName = jsvFindChildFromVar(obj, varName, true);",
          "1915:   if (jsvIsName(getsetName)) {",
          "1916:     JsVar *getset = jsvGetValueOfName(getsetName);",
          "1917:     if (!jsvIsGetterOrSetter(getset)) {",
          "1918:       jsvUnLock(getset);",
          "1919:       getset = jsvNewWithFlags(JSV_GET_SET);",
          "1920:       jsvSetValueOfName(getsetName, getset);",
          "1921:     }",
          "1922:     if (jsvIsGetterOrSetter(getset)) {",
          "1923:       jsvObjectSetChild(getset, \"this\", obj);",
          "1924:       jsvObjectSetChild(getset, isGetter?\"get\":\"set\", method);",
          "1925:     }",
          "1926:     jsvUnLock(getset);",
          "1927:   }",
          "1928:   jsvUnLock(getsetName);",
          "1929: }",
          "1930: #endif",
          "1938: void jsvReplaceWith(JsVar *dst, JsVar *src) {",
          "1940:   if (jsvIsArrayBufferName(dst)) {",
          "1941:     size_t idx = (size_t)jsvGetInteger(dst);",
          "1942:     JsVar *arrayBuffer = jsvLock(jsvGetFirstChild(dst));",
          "1943:     jsvArrayBufferSet(arrayBuffer, idx, src);",
          "1944:     jsvUnLock(arrayBuffer);",
          "1945:     return;",
          "1946:   }",
          "1948:   if (!jsvIsName(dst)) {",
          "1949:     jsExceptionHere(JSET_ERROR, \"Unable to assign value to non-reference %t\", dst);",
          "1950:     return;",
          "1951:   }",
          "1952:   bool setValue = true;",
          "1953: #ifndef SAVE_ON_FLASH",
          "1954:   JsVar *v = jsvGetValueOfName(dst);",
          "1955:   if (jsvIsGetterOrSetter(v)) {",
          "1956:     jsvExecuteSetter(v,src);",
          "1957:     setValue = false;",
          "1958:   }",
          "1959:   jsvUnLock(v);",
          "1960: #endif",
          "1961:   if (setValue) jsvSetValueOfName(dst, src);",
          "1966:   if (jsvIsNewChild(dst)) {",
          "1968:     JsVar *parent = jsvLock(jsvGetNextSibling(dst));",
          "1969:     if (!jsvIsString(parent)) {",
          "1972:       if (!jsvHasChildren(parent)) {",
          "1973:         jsExceptionHere(JSET_ERROR, \"Field or method \\\"%s\\\" does not already exist, and can't create it on %t\", dst, parent);",
          "1974:       } else {",
          "1976:         jsvUnRef(parent);",
          "1977:         jsvSetNextSibling(dst, 0);",
          "1978:         jsvUnRef(parent);",
          "1979:         jsvSetPrevSibling(dst, 0);",
          "1981:         jsvAddName(parent, dst);",
          "1982:       }",
          "1983:     }",
          "1984:     jsvUnLock(parent);",
          "1985:   }",
          "1986: }",
          "1991: void jsvReplaceWithOrAddToRoot(JsVar *dst, JsVar *src) {",
          "1994:   if (!jsvGetRefs(dst) && jsvIsName(dst)) {",
          "1995:     if (!jsvIsArrayBufferName(dst) && !jsvIsNewChild(dst))",
          "1996:       jsvAddName(execInfo.root, dst);",
          "1997:   }",
          "1998:   jsvReplaceWith(dst, src);",
          "1999: }",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "1939:          (jsvGetFirstChild(a)!=0);",
          "1940: }",
          "1943: void jsvCheckReferenceError(JsVar *a) {",
          "1944:   if (jsvIsName(a) && jsvGetRefs(a)==0 && !jsvIsNewChild(a) && !jsvGetFirstChild(a))",
          "1945:     jsExceptionHere(JSET_REFERENCEERROR, \"%q is not defined\", a);",
          "1946: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2079: JsVar *jsvGetValueOfName(JsVar *a) {",
          "2080:   if (!a) return 0;",
          "2081:   if (jsvIsArrayBufferName(a)) return jsvArrayBufferGetFromName(a);",
          "2082:   if (jsvIsNameInt(a)) return jsvNewFromInteger((JsVarInt)jsvGetFirstChildSigned(a));",
          "2083:   if (jsvIsNameIntBool(a)) return jsvNewFromBool(jsvGetFirstChild(a)!=0);",
          "2084:   assert(!jsvIsNameWithValue(a));",
          "2085:   if (jsvIsName(a))",
          "2086:     return jsvLockSafe(jsvGetFirstChild(a));",
          "2087:   return 0;",
          "2088: }",
          "",
          "---------------",
          "--- Hunk 8 ---",
          "[Context before]",
          "1965:     }",
          "1966:     pa = jsvLock(n);",
          "1967:     assert(pa!=a);",
          "1968:     if (!repeat) return pa;",
          "1969:   }",
          "1970:   return pa;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2118: #ifndef SAVE_ON_FLASH",
          "2119:     if (jsvIsGetterOrSetter(pa)) {",
          "2120:       JsVar *v = jsvExecuteGetter(pa);",
          "2121:       jsvUnLock(pa);",
          "2122:       pa = v;",
          "2123:     }",
          "2124: #endif",
          "",
          "---------------",
          "--- Hunk 9 ---",
          "[Context before]",
          "2289:       while (insertAfter && jsvCompareInteger(namedChild, insertAfter)<0) {",
          "2290:         JsVarRef prev = jsvGetPrevSibling(insertAfter);",
          "2291:         jsvUnLock(insertAfter);",
          "2293:       }",
          "2294:     }",
          "",
          "[Removed Lines]",
          "2292:         insertAfter = prev ? jsvLock(prev) : 0;",
          "",
          "[Added Lines]",
          "2449:         insertAfter = jsvLockSafe(prev);",
          "",
          "---------------",
          "--- Hunk 10 ---",
          "[Context before]",
          "3310:   char endBracket = ' ';",
          "3311:   if (jsvIsObject(var)) { jsiConsolePrint(\"Object { \"); endBracket = '}'; }",
          "3312:   else if (jsvIsArray(var)) { jsiConsolePrintf(\"Array(%d) [ \", var->varData.integer); endBracket = ']'; }",
          "3313:   else if (jsvIsNativeFunction(var)) { jsiConsolePrintf(\"NativeFunction 0x%x (%d) { \", var->varData.native.ptr, var->varData.native.argTypes); endBracket = '}'; }",
          "3314:   else if (jsvIsFunction(var)) {",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3469:   else if (jsvIsGetterOrSetter(var)) { jsiConsolePrint(\"Getter/Setter { \"); endBracket = '}'; }",
          "",
          "---------------",
          "--- Hunk 11 ---",
          "[Context before]",
          "3347:   }",
          "3349:   if (jsvHasSingleChild(var)) {",
          "3351:     _jsvTrace(child, indent+2, baseVar, level+1);",
          "3352:     jsvUnLock(child);",
          "3353:   } else if (jsvHasChildren(var)) {",
          "",
          "[Removed Lines]",
          "3350:     JsVar *child = jsvGetFirstChild(var) ? jsvLock(jsvGetFirstChild(var)) : 0;",
          "",
          "[Added Lines]",
          "3508:     JsVar *child = jsvLockSafe(jsvGetFirstChild(var));",
          "",
          "---------------"
        ],
        "src/jsvar.h||src/jsvar.h": [
          "File: src/jsvar.h -> src/jsvar.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "33:     JSV_NULL        = JSV_ROOT+1, ///< it seems null is its own data type",
          "41:   _JSV_NUMERIC_START = JSV_INTEGER, ///< --------- Start of numeric variable types",
          "42:     JSV_FLOAT       = JSV_INTEGER+1, ///< floating point double (note JSV_NUMERICMASK)",
          "43:     JSV_BOOLEAN     = JSV_FLOAT+1, ///< boolean (note JSV_NUMERICMASK)",
          "",
          "[Removed Lines]",
          "35:     JSV_ARRAY = JSV_NULL+1, ///< A JavaScript Array Buffer - Implemented just like a String at the moment",
          "36:     JSV_ARRAYBUFFER  = JSV_ARRAY+1,",
          "37:     JSV_OBJECT      = JSV_ARRAYBUFFER+1,",
          "38:     JSV_FUNCTION    = JSV_OBJECT+1,",
          "39:     JSV_FUNCTION_RETURN    = JSV_FUNCTION+1, ///< A simple function that starts with `return` (which is implicit)",
          "40:     JSV_INTEGER     = JSV_FUNCTION_RETURN+1, ///< integer number (note JSV_NUMERICMASK)",
          "",
          "[Added Lines]",
          "35:     JSV_ARRAY,           ///< A JavaScript Array Buffer - Implemented just like a String at the moment",
          "36:     JSV_ARRAYBUFFER,     ///< An arraybuffer (see varData.arraybuffer)",
          "37:     JSV_OBJECT,",
          "38: #ifndef SAVE_ON_FLASH",
          "39:     JSV_GET_SET,         ///< Getter/setter (an object with get/set fields)",
          "40: #endif",
          "41:     JSV_FUNCTION,",
          "42:     JSV_FUNCTION_RETURN, ///< A simple function that starts with `return` (which is implicit)",
          "43:     JSV_INTEGER,         ///< integer number (note JSV_NUMERICMASK)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "345: ALWAYS_INLINE JsVar *jsvLock(JsVarRef ref);",
          "348: ALWAYS_INLINE JsVar *jsvLockAgain(JsVar *var);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "351: JsVar *jsvLockSafe(JsVarRef ref);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "407: extern bool jsvIsNameIntBool(const JsVar *v);",
          "409: extern bool jsvIsNewChild(const JsVar *v);",
          "412: extern bool jsvIsRefUsedForData(const JsVar *v);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "417: extern bool jsvIsGetterOrSetter(const JsVar *v);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "524: static ALWAYS_INLINE char jsvStringCharToUpper(char ch) { return (char)((ch >= 97 && ch <= 122) ? ch - 32 : ch); } // a-z",
          "525: static ALWAYS_INLINE char jsvStringCharToLower(char ch) { return (char)((ch >= 65 && ch <= 90)  ? ch + 32 : ch); } // A-Z",
          "530: size_t jsvGetArrayBufferLength(const JsVar *arrayBuffer);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "535: #ifndef SAVE_ON_FLASH",
          "537: JsVar *jsvExecuteGetter(JsVar *getset);",
          "539: void jsvExecuteSetter(JsVar *getset, JsVar *value);",
          "541: void jsvAddGetterOrSetter(JsVar *obj, JsVar *varName, bool isGetter, JsVar *method);",
          "542: #endif",
          "549: void jsvReplaceWith(JsVar *dst, JsVar *src);",
          "554: void jsvReplaceWithOrAddToRoot(JsVar *dst, JsVar *src);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "547: bool jsvIsVariableDefined(JsVar *a);",
          "550: void jsvCheckReferenceError(JsVar *a);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "578: JsVar *jsvGetValueOfName(JsVar *name);",
          "",
          "---------------"
        ],
        "src/jsvariterator.c||src/jsvariterator.c": [
          "File: src/jsvariterator.c -> src/jsvariterator.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "265: void jsvObjectIteratorNew(JsvObjectIterator *it, JsVar *obj) {",
          "268: }",
          "",
          "[Removed Lines]",
          "266:   assert(jsvIsArray(obj) || jsvIsObject(obj) || jsvIsFunction(obj));",
          "267:   it->var = jsvGetFirstChild(obj) ? jsvLock(jsvGetFirstChild(obj)) : 0;",
          "",
          "[Added Lines]",
          "266:   assert(jsvIsArray(obj) || jsvIsObject(obj) || jsvIsFunction(obj) || jsvIsGetterOrSetter(obj));",
          "267:   it->var = jsvLockSafe(jsvGetFirstChild(obj));",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "279:   if (it->var) {",
          "280:     JsVarRef next = jsvGetNextSibling(it->var);",
          "281:     jsvUnLock(it->var);",
          "283:   }",
          "284: }",
          "",
          "[Removed Lines]",
          "282:     it->var = next ? jsvLock(next) : 0;",
          "",
          "[Added Lines]",
          "282:     it->var = jsvLockSafe(next);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "293:     JsVarRef next = jsvGetNextSibling(it->var);",
          "294:     jsvRemoveChild(parent, it->var);",
          "295:     jsvUnLock(it->var);",
          "297:   }",
          "298: }",
          "",
          "[Removed Lines]",
          "296:     it->var = next ? jsvLock(next) : 0;",
          "",
          "[Added Lines]",
          "296:     it->var = jsvLockSafe(next);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "523: void jsvIteratorNew(JsvIterator *it, JsVar *obj, JsvIteratorFlags flags) {",
          "525:     it->type = JSVI_OBJECT;",
          "526:     if (jsvIsArray(obj) && (flags&JSIF_EVERY_ARRAY_ELEMENT)) {",
          "527:       it->type = JSVI_FULLARRAY;",
          "",
          "[Removed Lines]",
          "524:   if (jsvIsArray(obj) || jsvIsObject(obj) || jsvIsFunction(obj)) {",
          "",
          "[Added Lines]",
          "524:   if (jsvIsArray(obj) || jsvIsObject(obj) || jsvIsFunction(obj) || jsvIsGetterOrSetter(obj)) {",
          "",
          "---------------"
        ],
        "src/jswrap_json.c||src/jswrap_json.c": [
          "File: src/jswrap_json.c -> src/jswrap_json.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "275:   size_t sinceNewLine = 0;",
          "276:   while (jsvObjectIteratorHasValue(it) && !jspIsInterrupted()) {",
          "277:     JsVar *index = jsvObjectIteratorGetKey(it);",
          "279:     bool hidden = jsvIsInternalObjectKey(index) ||",
          "280:         ((flags & JSON_IGNORE_FUNCTIONS) && jsvIsFunction(item)) ||",
          "282:     if (!hidden) {",
          "283:       sinceNewLine++;",
          "284:       if (!first) cbprintf(user_callback, user_data, (flags&JSON_PRETTY)?\", \":\",\");",
          "",
          "[Removed Lines]",
          "278:     JsVar *item = jsvObjectIteratorGetValue(it);",
          "281:         ((flags&JSON_NO_UNDEFINED) && jsvIsUndefined(item));",
          "",
          "[Added Lines]",
          "278:     JsVar *item = jsvGetValueOfName(index);",
          "281:         ((flags&JSON_NO_UNDEFINED) && jsvIsUndefined(item)) ||",
          "282:         jsvIsGetterOrSetter(item);",
          "",
          "---------------"
        ],
        "src/jswrap_object.c||src/jswrap_object.c": [
          "File: src/jswrap_object.c -> src/jswrap_object.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "356:     return 0;",
          "357:   }",
          "362:   bool isBuiltIn = jsvIsNewChild(varName);",
          "363:   JsvIsInternalChecker checkerFunction = jsvGetInternalFunctionCheckerFor(parent);",
          "366:   jsvObjectSetChildAndUnLock(obj, \"writable\", jsvNewFromBool(true));",
          "367:   jsvObjectSetChildAndUnLock(obj, \"enumerable\", jsvNewFromBool(!checkerFunction || !checkerFunction(varName)));",
          "368:   jsvObjectSetChildAndUnLock(obj, \"configurable\", jsvNewFromBool(!isBuiltIn));",
          "371:   return obj;",
          "372: }",
          "",
          "[Removed Lines]",
          "360:   JsVar *var = jsvSkipName(varName);",
          "365:   jsvObjectSetChild(obj, \"value\", var);",
          "370:   jsvUnLock2(var, varName);",
          "",
          "[Added Lines]",
          "366: #ifndef SAVE_ON_FLASH",
          "367:   JsVar *getset = jsvGetValueOfName(varName);",
          "368:   if (jsvIsGetterOrSetter(getset)) {",
          "369:     jsvObjectSetChildAndUnLock(obj, \"get\", jsvObjectGetChild(getset,\"get\",0));",
          "370:     jsvObjectSetChildAndUnLock(obj, \"set\", jsvObjectGetChild(getset,\"set\",0));",
          "371:   } else {",
          "372: #endif",
          "373:     jsvObjectSetChildAndUnLock(obj, \"value\", jsvSkipName(varName));",
          "374: #ifndef SAVE_ON_FLASH",
          "375:   }",
          "376:   jsvUnLock(getset);",
          "377: #endif",
          "379:   jsvUnLock(varName);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "450:   }",
          "452:   JsVar *name = jsvAsArrayIndex(propName);",
          "454:   jsvObjectSetChildVar(parent, name, value);",
          "455:   jsvUnLock2(name, value);",
          "",
          "[Removed Lines]",
          "453:   JsVar *value = jsvObjectGetChild(desc, \"value\", 0);",
          "",
          "[Added Lines]",
          "462:   JsVar *value = 0;",
          "464:   JsVar *getter = jsvObjectGetChild(desc, \"get\", 0);",
          "465:   JsVar *setter = jsvObjectGetChild(desc, \"set\", 0);",
          "466:   if (getter || setter) {",
          "467: #ifdef SAVE_ON_FLASH",
          "468:     jsExceptionHere(JSET_ERROR, \"get/set unsupported in this build\");",
          "469: #else",
          "471:     value = jsvNewWithFlags(JSV_GET_SET);",
          "472:     if (value) {",
          "473:       if (getter) jsvObjectSetChild(value, \"get\", getter);",
          "474:       if (setter) jsvObjectSetChild(value, \"set\", setter);",
          "475:       jsvObjectSetChild(value, \"this\", parent);",
          "476:     }",
          "477: #endif",
          "478:     jsvUnLock2(getter,setter);",
          "479:   }",
          "480:   if (!value) value = jsvObjectGetChild(desc, \"value\", 0);",
          "",
          "---------------"
        ],
        "src/jswrap_process.c||src/jswrap_process.c": [
          "File: src/jswrap_process.c -> src/jswrap_process.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "66:     jsvGetFloat,",
          "67:     jsvGetInteger,",
          "68:     jsvGetBool,",
          "70:     jspeFunctionCall,",
          "71:     jspGetNamedVariable,",
          "72:     jspGetNamedField,",
          "",
          "[Removed Lines]",
          "69:     jspReplaceWith,",
          "",
          "[Added Lines]",
          "69:     jsvReplaceWith,",
          "",
          "---------------"
        ],
        "tests/test_getter.js||tests/test_getter.js": [
          "File: tests/test_getter.js -> tests/test_getter.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: var results = [];",
          "5: var obj = {",
          "6:   log: ['a', 'b', 'c'],",
          "7:   get latest() {",
          "8:     if (this.log.length == 0) {",
          "9:       return undefined;",
          "10:     }",
          "11:     return this.log[this.log.length - 1];",
          "12:   }",
          "13: }",
          "15: results.push(obj.latest);",
          "18: var obj = {",
          "19:   log: ['example','test'],",
          "20:   get latest() {",
          "21:     if (this.log.length == 0) return undefined;",
          "22:     return this.log[this.log.length - 1];",
          "23:   }",
          "24: }",
          "25: results.push(obj.latest); // \"test\".",
          "27: delete obj.latest;",
          "28: results.push(obj.latest); // undefined",
          "30: var o = {a: 0};",
          "32: Object.defineProperty(o, 'b', { get: function() { return this.a + 1; } });",
          "34: results.push(o.b) // Runs the getter, which yields a + 1 (which is 1)",
          "36: result = results==\"c,test,,1\";",
          "",
          "---------------"
        ],
        "tests/test_setter.js||tests/test_setter.js": [
          "File: tests/test_setter.js -> tests/test_setter.js",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3: var results = [];",
          "5: var language = {",
          "6:   set current(name) {",
          "7:     this.log.push(name);",
          "8:   },",
          "9:   log: []",
          "10: }",
          "12: language.current = 'EN';",
          "13: language.current = 'FA';",
          "15: results.push(JSON.stringify(language.log));",
          "18: var language = {",
          "19:   set current(name) {",
          "20:     this.log.push(name);",
          "21:   },",
          "22:   log: []",
          "23: }",
          "25: language.current = 'EN';",
          "26: results.push(JSON.stringify(language.log)); // ['EN']",
          "28: language.current = 'FA';",
          "29: results.push(JSON.stringify(language.log)); // ['EN', 'FA']",
          "31: delete language.current;",
          "32: language.current = 'EN';",
          "33: results.push(JSON.stringify(language.log)); // ['EN', 'FA']",
          "35: var o = {a: 0};",
          "37: Object.defineProperty(o, 'b', { set: function(x) { this.a = x / 2; } });",
          "39: o.b = 10; // Runs the setter, which assigns 10 / 2 (5) to the 'a' property",
          "40: results.push(o.a) // 5",
          "42: print(results+\"\");",
          "43: result = results=='[\"EN\",\"FA\"],[\"EN\"],[\"EN\",\"FA\"],[\"EN\",\"FA\"],5';",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "36747074d786ce31221537def37f43732df29297",
      "candidate_info": {
        "commit_hash": "36747074d786ce31221537def37f43732df29297",
        "repo": "espruino/Espruino",
        "commit_url": "https://github.com/espruino/Espruino/commit/36747074d786ce31221537def37f43732df29297",
        "files": [
          "ChangeLog",
          "src/jslex.c",
          "src/jslex.h",
          "src/jsparse.c"
        ],
        "message": "Allow for..in to iterate over prototype chains down from Array and Object             Add for(var i of array) to iterate over elements",
        "before_after_code_files": [
          "src/jslex.c||src/jslex.c",
          "src/jslex.h||src/jslex.h",
          "src/jsparse.c||src/jsparse.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "src/jsparse.c||src/jsparse.c"
          ],
          "candidate": [
            "src/jsparse.c||src/jsparse.c"
          ]
        }
      },
      "candidate_diff": {
        "src/jslex.c||src/jslex.c": [
          "File: src/jslex.c -> src/jslex.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "419:       case 'n': if (jslIsToken(\"new\", 1)) lex->tk = LEX_R_NEW;",
          "420:       else if (jslIsToken(\"null\", 1)) lex->tk = LEX_R_NULL;",
          "421:       break;",
          "422:       case 'r': if (jslIsToken(\"return\", 1)) lex->tk = LEX_R_RETURN;",
          "423:       break;",
          "424:       case 's': if (jslIsToken(\"static\", 1)) lex->tk = LEX_R_STATIC;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "422:       case 'o': if (jslIsToken(\"of\", 1)) lex->tk = LEX_R_OF;",
          "423:       break;",
          "",
          "---------------"
        ],
        "src/jslex.h||src/jslex.h": [
          "File: src/jslex.h -> src/jslex.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "98:     LEX_R_EXTENDS,",
          "99:     LEX_R_SUPER,",
          "100:     LEX_R_STATIC,",
          "102: } LEX_TYPES;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "101:     LEX_R_OF,",
          "",
          "---------------"
        ],
        "src/jsparse.c||src/jsparse.c": [
          "File: src/jsparse.c -> src/jsparse.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "172:   return jsvFindChildFromVar(execInfo.root, childName, createIfNotFound);",
          "173: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "175: JsVar *jspFindPrototypeFor(const char *className) {",
          "176:   JsVar *obj = jsvObjectGetChild(execInfo.root, className, 0);",
          "177:   if (!obj) return 0;",
          "178:   JsVar *proto = jsvObjectGetChild(obj, JSPARSE_PROTOTYPE_VAR, 0);",
          "179:   jsvUnLock(obj);",
          "180:   return proto;",
          "181: }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "182:     JsVar *inheritsFrom = jsvObjectGetChild(parent, JSPARSE_INHERITS_VAR, 0);",
          "193:     if (inheritsFrom && inheritsFrom!=parent) {",
          "",
          "[Removed Lines]",
          "185:     if (!inheritsFrom) {",
          "186:       JsVar *obj = jsvObjectGetChild(execInfo.root, \"Object\", 0);",
          "187:       if (obj) {",
          "188:         inheritsFrom = jsvObjectGetChild(obj, JSPARSE_PROTOTYPE_VAR, 0);",
          "189:         jsvUnLock(obj);",
          "190:       }",
          "191:     }",
          "",
          "[Added Lines]",
          "191:     if (!inheritsFrom)",
          "192:       inheritsFrom = jspFindPrototypeFor(\"Object\");",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2311:   return 0;",
          "2312: }",
          "2314: NO_INLINE JsVar *jspeStatementFor() {",
          "2315:   JSP_ASSERT_MATCH(LEX_R_FOR);",
          "2316:   JSP_MATCH('(');",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2315: NO_INLINE JsVar *jspGetBuiltinPrototype(JsVar *obj) {",
          "2316:   if (jsvIsArray(obj)) {",
          "2317:     JsVar *v = jspFindPrototypeFor(\"Array\");",
          "2318:     if (v) return v;",
          "2319:   }",
          "2320:   if (jsvIsObject(obj) || jsvIsArray(obj)) {",
          "2321:     JsVar *v = jspFindPrototypeFor(\"Object\");",
          "2322:     if (v==obj) { // don't return ourselves",
          "2323:       jsvUnLock(v);",
          "2324:       v = 0;",
          "2325:     }",
          "2326:     return v;",
          "2327:   }",
          "2328:   return 0;",
          "2329: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "2326:     return 0;",
          "2327:   }",
          "2328:   execInfo.execute &= (JsExecFlags)~EXEC_FOR_INIT;",
          "2332:     if (JSP_SHOULD_EXECUTE && !jsvIsName(forStatement)) {",
          "2333:       jsvUnLock(forStatement);",
          "2335:       return 0;",
          "2336:     }",
          "2338:     JsVar *array = jsvSkipNameAndUnLock(jspeExpression());",
          "2339:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(')', jsvUnLock2(forStatement, array), 0);",
          "2340:     JslCharPos forBodyStart = jslCharPosClone(&lex->tokenStart);",
          "2341:     JSP_SAVE_EXECUTE();",
          "2342:     jspSetNoExecute();",
          "2343:     execInfo.execute |= EXEC_IN_LOOP;",
          "",
          "[Removed Lines]",
          "2329:   if (lex->tk == LEX_R_IN) {",
          "2334:       jsExceptionHere(JSET_ERROR, \"FOR a IN b - 'a' must be a variable name, not %t\", forStatement);",
          "2337:     JSP_MATCH_WITH_CLEANUP_AND_RETURN(LEX_R_IN, jsvUnLock(forStatement), 0);",
          "",
          "[Added Lines]",
          "2346:   if (lex->tk == LEX_R_IN || lex->tk == LEX_R_OF) {",
          "2347:     bool isForOf = lex->tk == LEX_R_OF;",
          "2352:       jsExceptionHere(JSET_ERROR, \"for(a %s b) - 'a' must be a variable name, not %t\", isForOf?\"of\":\"in\", forStatement);",
          "2356:     JSP_ASSERT_MATCH(lex->tk); // skip over in/of",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "2345:     JslCharPos forBodyEnd = jslCharPosClone(&lex->tokenStart);",
          "2346:     if (!wasInLoop) execInfo.execute &= (JsExecFlags)~EXEC_IN_LOOP;",
          "2347:     JSP_RESTORE_EXECUTE();",
          "2349:     if (JSP_SHOULD_EXECUTE) {",
          "2350:       if (jsvIsIterable(array)) {",
          "2351:         JsvIsInternalChecker checkerFunction = jsvGetInternalFunctionCheckerFor(array);",
          "2352:         JsVar *foundPrototype = 0;",
          "2354:         JsvIterator it;",
          "2356:         bool hasHadBreak = false;",
          "2357:         while (JSP_SHOULD_EXECUTE && jsvIteratorHasElement(&it) && !hasHadBreak) {",
          "2358:           JsVar *loopIndexVar = jsvIteratorGetKey(&it);",
          "",
          "[Removed Lines]",
          "2355:         jsvIteratorNew(&it, array, JSIF_DEFINED_ARRAY_ElEMENTS);",
          "",
          "[Added Lines]",
          "2374:         if (!isForOf) // for..in",
          "2375:           foundPrototype = jspGetBuiltinPrototype(array);",
          "2378:         jsvIteratorNew(&it, array, isForOf ?",
          "",
          "---------------",
          "--- Hunk 6 ---",
          "[Context before]",
          "2364:               foundPrototype = jsvSkipName(loopIndexVar);",
          "2365:           }",
          "2366:           if (!ignore) {",
          "2377:               jslSeekToP(&forBodyStart);",
          "2378:               execInfo.execute |= EXEC_IN_LOOP;",
          "",
          "[Removed Lines]",
          "2367:             JsVar *indexValue = jsvIsName(loopIndexVar) ?",
          "2368:                 jsvCopyNameOnly(loopIndexVar, false/*no copy children*/, false/*not a name*/) :",
          "2369:                 loopIndexVar;",
          "2370:             if (indexValue) { // could be out of memory",
          "2371:               assert(!jsvIsName(indexValue) && jsvGetRefs(indexValue)==0);",
          "2372:               jspReplaceWithOrAddToRoot(forStatement, indexValue);",
          "2373:               if (indexValue!=loopIndexVar) jsvUnLock(indexValue);",
          "2375:               jsvIteratorNext(&it);",
          "",
          "[Added Lines]",
          "2392:             JsVar *iteratorValue;",
          "2393:             if (isForOf) { // for (... of ...)",
          "2394:               iteratorValue = jsvIteratorGetValue(&it);",
          "2395:             } else { // for (... in ...)",
          "2396:               iteratorValue = jsvIsName(loopIndexVar) ?",
          "2397:                   jsvCopyNameOnly(loopIndexVar, false/*no copy children*/, false/*not a name*/) :",
          "2398:                   loopIndexVar;",
          "2399:               assert(jsvGetRefs(iteratorValue)==0);",
          "2400:             }",
          "2401:             if (isForOf || iteratorValue) { // could be out of memory",
          "2402:               assert(!jsvIsName(iteratorValue));",
          "2403:               jspReplaceWithOrAddToRoot(forStatement, iteratorValue);",
          "2404:               if (iteratorValue!=loopIndexVar) jsvUnLock(iteratorValue);",
          "",
          "---------------",
          "--- Hunk 7 ---",
          "[Context before]",
          "2387:                 hasHadBreak = true;",
          "2388:               }",
          "2389:             }",
          "2392:           jsvUnLock(loopIndexVar);",
          "2395:             jsvIteratorFree(&it);",
          "2399:           }",
          "2400:         }",
          "2401:         assert(!foundPrototype);",
          "",
          "[Removed Lines]",
          "2390:           } else",
          "2391:             jsvIteratorNext(&it);",
          "2394:           if (!jsvIteratorHasElement(&it) && foundPrototype) {",
          "2396:             jsvIteratorNew(&it, foundPrototype, JSIF_DEFINED_ARRAY_ElEMENTS);",
          "2397:             jsvUnLock(foundPrototype);",
          "2398:             foundPrototype = 0;",
          "",
          "[Added Lines]",
          "2419:           }",
          "2420:           jsvIteratorNext(&it);",
          "2423:           if (!jsvIteratorHasElement(&it) && !isForOf && foundPrototype) {",
          "2425:             JsVar *iterable = foundPrototype;",
          "2426:             jsvIteratorNew(&it, iterable, JSIF_DEFINED_ARRAY_ElEMENTS);",
          "2427:             checkerFunction = jsvGetInternalFunctionCheckerFor(iterable);",
          "2428:             foundPrototype = jspGetBuiltinPrototype(iterable);",
          "2429:             jsvUnLock(iterable);",
          "",
          "---------------"
        ]
      }
    }
  ]
}