{
  "cve_id": "CVE-2017-6952",
  "cve_desc": "Integer overflow in the cs_winkernel_malloc function in winkernel_mm.c in Capstone 3.0.4 and earlier allows attackers to cause a denial of service (heap-based buffer overflow in a kernel driver) or possibly have unspecified other impact via a large value.",
  "repo": "aquynh/capstone",
  "patch_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
  "patch_info": {
    "commit_hash": "6fe86eef621b9849f51a5e1e5d73258a93440403",
    "repo": "aquynh/capstone",
    "commit_url": "https://github.com/aquynh/capstone/commit/6fe86eef621b9849f51a5e1e5d73258a93440403",
    "files": [
      "windows/winkernel_mm.c"
    ],
    "message": "provide a validity check to prevent against Integer overflow conditions (#870)\n\n* provide a validity check to prevent against Integer overflow conditions\n\n* fix some style issues.",
    "before_after_code_files": [
      "windows/winkernel_mm.c||windows/winkernel_mm.c"
    ]
  },
  "patch_diff": {
    "windows/winkernel_mm.c||windows/winkernel_mm.c": [
      "File: windows/winkernel_mm.c -> windows/winkernel_mm.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "4: #include \"winkernel_mm.h\"",
      "5: #include <ntddk.h>",
      "8: static const ULONG CS_WINKERNEL_POOL_TAG = 'kwsC';",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "6: #include <Ntintsafe.h>",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "35: #pragma prefast(suppress : 30030)  // Allocating executable POOL_TYPE memory",
      "38:  if (!block) {",
      "39:   return NULL;",
      "40:  }",
      "",
      "[Removed Lines]",
      "36:  CS_WINKERNEL_MEMBLOCK *block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "37:    NonPagedPool, size + sizeof(CS_WINKERNEL_MEMBLOCK), CS_WINKERNEL_POOL_TAG);",
      "",
      "[Added Lines]",
      "37:  size_t number_of_bytes = 0;",
      "38:  CS_WINKERNEL_MEMBLOCK *block = NULL;",
      "42:  if (!NT_SUCCESS(RtlSizeTAdd(size, sizeof(CS_WINKERNEL_MEMBLOCK), &number_of_bytes))) {",
      "43:   return NULL;",
      "44:  }",
      "45:  block = (CS_WINKERNEL_MEMBLOCK *)ExAllocatePoolWithTag(",
      "46:    NonPagedPool, number_of_bytes, CS_WINKERNEL_POOL_TAG);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "7925323569769659cb21e3b0d7a2f02ad02e87e3",
      "candidate_info": {
        "commit_hash": "7925323569769659cb21e3b0d7a2f02ad02e87e3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/7925323569769659cb21e3b0d7a2f02ad02e87e3",
        "files": [
          "arch/AArch64/AArch64GenAsmWriter.inc"
        ],
        "message": "Bug fix for incorrect operand type in certain load/store instructions on AArch64. (#952)",
        "before_after_code_files": [
          "arch/AArch64/AArch64GenAsmWriter.inc||arch/AArch64/AArch64GenAsmWriter.inc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "arch/AArch64/AArch64GenAsmWriter.inc||arch/AArch64/AArch64GenAsmWriter.inc": [
          "File: arch/AArch64/AArch64GenAsmWriter.inc -> arch/AArch64/AArch64GenAsmWriter.inc",
          "--- Hunk 1 ---",
          "[Context before]",
          "12578:   if (*AsmOps) {",
          "12579:     SStream_concat0(OS, \"\\t\");",
          "12580:     for (c = AsmOps; *c; c++) {",
          "12582:         c += 1;",
          "12583:         if (*c == (char)0xff) {",
          "12584:           c += 1;",
          "",
          "[Removed Lines]",
          "12581:       if (*c == '$') {",
          "",
          "[Added Lines]",
          "12581:       if (*c == '[') {",
          "12582:         SStream_concat0(OS, \"[\");",
          "12583:         set_mem_access(MI, true);",
          "12584:       }",
          "12585:       else if (*c == ']') {",
          "12586:         SStream_concat0(OS, \"]\");",
          "12587:         set_mem_access(MI, false);",
          "12588:       }",
          "12589:       else if (*c == '$') {",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3239acea18dd8abb2d6c3743e85bef2e54d07656",
      "candidate_info": {
        "commit_hash": "3239acea18dd8abb2d6c3743e85bef2e54d07656",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/3239acea18dd8abb2d6c3743e85bef2e54d07656",
        "files": [
          "pkgconfig.mk"
        ],
        "message": "bump package version to 3.0.5",
        "before_after_code_files": [
          "pkgconfig.mk||pkgconfig.mk"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "pkgconfig.mk||pkgconfig.mk": [
          "File: pkgconfig.mk -> pkgconfig.mk",
          "--- Hunk 1 ---",
          "[Context before]",
          "6: PKG_MINOR = 0",
          "8: # version bugfix level. Example: PKG_EXTRA = 1",
          "",
          "[Removed Lines]",
          "9: PKG_EXTRA = 4",
          "",
          "[Added Lines]",
          "9: PKG_EXTRA = 5",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "85cd24b5626e295e702ebc508eba63ac4727a6c5",
      "candidate_info": {
        "commit_hash": "85cd24b5626e295e702ebc508eba63ac4727a6c5",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/85cd24b5626e295e702ebc508eba63ac4727a6c5",
        "files": [
          "bindings/python/BUILDING.txt",
          "bindings/python/MANIFEST.in",
          "bindings/python/PKG-INFO.src",
          "bindings/python/PKG-INFO.win",
          "bindings/python/README.TXT",
          "bindings/python/README.pypi-src",
          "bindings/python/README.pypi-win",
          "bindings/python/README.txt",
          "bindings/python/prebuilt/win32/.gitignore",
          "bindings/python/prebuilt/win64/.gitignore",
          "bindings/python/setup.py"
        ],
        "message": "Python: Clean up the capstone-windows stuff with extreme prejudice",
        "before_after_code_files": [
          "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in",
          "bindings/python/PKG-INFO.src||bindings/python/PKG-INFO.src",
          "bindings/python/PKG-INFO.win||bindings/python/PKG-INFO.win",
          "bindings/python/README.pypi-src||bindings/python/README.pypi-src",
          "bindings/python/setup.py||bindings/python/setup.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/python/MANIFEST.in||bindings/python/MANIFEST.in": [
          "File: bindings/python/MANIFEST.in -> bindings/python/MANIFEST.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "1: recursive-include src *",
          "2: include LICENSE.TXT",
          "",
          "[Removed Lines]",
          "3: include README",
          "",
          "[Added Lines]",
          "3: include README.txt",
          "4: include BUILDING.txt",
          "5: include Makefile",
          "",
          "---------------"
        ],
        "bindings/python/PKG-INFO.src||bindings/python/PKG-INFO.src": [
          "File: bindings/python/PKG-INFO.src -> bindings/python/PKG-INFO.src",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/PKG-INFO.win||bindings/python/PKG-INFO.win": [
          "File: bindings/python/PKG-INFO.win -> bindings/python/PKG-INFO.win",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/README.pypi-src||bindings/python/README.pypi-src": [
          "File: bindings/python/README.pypi-src -> bindings/python/README.pypi-src",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/setup.py||bindings/python/setup.py": [
          "File: bindings/python/setup.py -> bindings/python/setup.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "156:     print \"Proper 'develop' support unavailable.\"",
          "158: if 'bdist_wheel' in sys.argv and '--plat-name' not in sys.argv:",
          "160:     name = get_platform()",
          "161:     if 'linux' in name:",
          "162:         # linux_* platform tags are disallowed because the python ecosystem is fubar",
          "163:         # linux builds should be built in the centos 5 vm for maximum compatibility",
          "164:         # see https://github.com/pypa/manylinux",
          "165:         # see also https://github.com/angr/angr-dev/blob/master/bdist.sh",
          "167:     else:",
          "168:         # https://www.python.org/dev/peps/pep-0425/",
          "171: setup(",
          "172:     provides=['capstone'],",
          "",
          "[Removed Lines]",
          "159:     sys.argv.append('--plat-name')",
          "166:         sys.argv.append('manylinux1_' + platform.machine())",
          "169:         sys.argv.append(name.replace('.', '_').replace('-', '_'))",
          "",
          "[Added Lines]",
          "159:     idx = sys.argv.index('bdist_wheel') + 1",
          "160:     sys.argv.insert(idx, '--plat-name')",
          "167:         sys.argv.insert(idx + 1, 'manylinux1_' + platform.machine())",
          "170:         sys.argv.insert(idx + 1, name.replace('.', '_').replace('-', '_'))",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
      "candidate_info": {
        "commit_hash": "7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/7114a6258e7860f1fb806ca7a6e36b89781b4ba3",
        "files": [
          "bindings/java/TestX86.java",
          "bindings/java/capstone/X86.java",
          "bindings/java/capstone/X86_const.java",
          "bindings/ocaml/ocaml.c",
          "bindings/ocaml/test_x86.ml",
          "bindings/ocaml/x86.ml",
          "bindings/ocaml/x86_const.ml",
          "bindings/python/capstone/x86.py",
          "bindings/python/capstone/x86_const.py",
          "bindings/python/test_x86.py"
        ],
        "message": "binding: remove cx_x86_op::fp following the change in the core",
        "before_after_code_files": [
          "bindings/javTestX86.java||bindings/java/TestX86.java",
          "bindings/javcapstone/X86.java||bindings/java/capstone/X86.java",
          "bindings/javcapstone/X86_const.java||bindings/java/capstone/X86_const.java",
          "bindings/ocaml/ocaml.c||bindings/ocaml/ocaml.c",
          "bindings/ocaml/test_x86.ml||bindings/ocaml/test_x86.ml",
          "bindings/ocaml/x86.ml||bindings/ocaml/x86.ml",
          "bindings/ocaml/x86_const.ml||bindings/ocaml/x86_const.ml",
          "bindings/python/capstone/x86.py||bindings/python/capstone/x86.py",
          "bindings/python/capstone/x86_const.py||bindings/python/capstone/x86_const.py",
          "bindings/python/test_x86.py||bindings/python/test_x86.py"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/javTestX86.java||bindings/java/TestX86.java": [
          "File: bindings/javTestX86.java -> bindings/java/TestX86.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/javcapstone/X86.java||bindings/java/capstone/X86.java": [
          "File: bindings/javcapstone/X86.java -> bindings/java/capstone/X86.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "36:       return Arrays.asList(\"reg\", \"imm\", \"mem\");",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/javcapstone/X86_const.java||bindings/java/capstone/X86_const.java": [
          "File: bindings/javcapstone/X86_const.java -> bindings/java/capstone/X86_const.java",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/ocaml.c||bindings/ocaml/ocaml.c": [
          "File: bindings/ocaml/ocaml.c -> bindings/ocaml/ocaml.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "376:           tmp = caml_alloc(5, 2);",
          "377:           Store_field(tmp, 0, Val_int(insn[j-1].detail->x86.operands[i].imm));",
          "378:           break;",
          "383:          case X86_OP_MEM:",
          "385:           tmp2 = caml_alloc(5, 0);",
          "386:           Store_field(tmp2, 0, Val_int(insn[j-1].detail->x86.operands[i].mem.segment));",
          "387:           Store_field(tmp2, 1, Val_int(insn[j-1].detail->x86.operands[i].mem.base));",
          "",
          "[Removed Lines]",
          "379:          case X86_OP_FP:",
          "380:           tmp = caml_alloc(5, 3);",
          "381:           Store_field(tmp, 0, caml_copy_double(insn[j-1].detail->x86.operands[i].fp));",
          "382:           break;",
          "384:           tmp = caml_alloc(5, 4);",
          "",
          "[Added Lines]",
          "380:           tmp = caml_alloc(5, 3);",
          "",
          "---------------"
        ],
        "bindings/ocaml/test_x86.ml||bindings/ocaml/test_x86.ml": [
          "File: bindings/ocaml/test_x86.ml -> bindings/ocaml/test_x86.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "32:  | X86_OP_INVALID _ -> (); (* this would never happens *)",
          "33:  | X86_OP_REG reg -> printf \"\\t\\top[%d]: REG = %s\\n\" i (cs_reg_name handle reg);",
          "34:  | X86_OP_IMM imm -> printf \"\\t\\top[%d]: IMM = 0x%x\\n\" i imm;",
          "36:  | X86_OP_MEM mem -> ( printf \"\\t\\top[%d]: MEM\\n\" i;",
          "37:   if mem.base != 0 then",
          "38:    printf \"\\t\\t\\toperands[%u].mem.base: REG = %s\\n\" i (cs_reg_name handle  mem.base);",
          "",
          "[Removed Lines]",
          "35:  | X86_OP_FP fp -> printf \"\\t\\top[%d]: FP = %f\\n\" i fp;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/x86.ml||bindings/ocaml/x86.ml": [
          "File: bindings/ocaml/x86.ml -> bindings/ocaml/x86.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "16:  | X86_OP_INVALID of int",
          "17:  | X86_OP_REG of int",
          "18:  | X86_OP_IMM of int",
          "20:  | X86_OP_MEM of x86_op_mem",
          "22: type x86_op = {",
          "",
          "[Removed Lines]",
          "19:  | X86_OP_FP of float",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/ocaml/x86_const.ml||bindings/ocaml/x86_const.ml": [
          "File: bindings/ocaml/x86_const.ml -> bindings/ocaml/x86_const.ml",
          "--- Hunk 1 ---",
          "[Context before]",
          "300: let _X86_OP_REG = 1;;",
          "301: let _X86_OP_IMM = 2;;",
          "302: let _X86_OP_MEM = 3;;",
          "305: (* XOP Code Condition type *)",
          "",
          "[Removed Lines]",
          "303: let _X86_OP_FP = 4;;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/capstone/x86.py||bindings/python/capstone/x86.py": [
          "File: bindings/python/capstone/x86.py -> bindings/python/capstone/x86.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "17:     _fields_ = (",
          "18:         ('reg', ctypes.c_uint),",
          "19:         ('imm', ctypes.c_int64),",
          "21:         ('mem', X86OpMem),",
          "22:     )",
          "",
          "[Removed Lines]",
          "20:         ('fp', ctypes.c_double),",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "39:     def reg(self):",
          "40:         return self.value.reg",
          "46:     @property",
          "47:     def mem(self):",
          "48:         return self.value.mem",
          "",
          "[Removed Lines]",
          "42:     @property",
          "43:     def fp(self):",
          "44:         return self.value.fp",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/capstone/x86_const.py||bindings/python/capstone/x86_const.py": [
          "File: bindings/python/capstone/x86_const.py -> bindings/python/capstone/x86_const.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "300: X86_OP_REG = 1",
          "301: X86_OP_IMM = 2",
          "302: X86_OP_MEM = 3",
          "305: # XOP Code Condition type",
          "",
          "[Removed Lines]",
          "303: X86_OP_FP = 4",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "bindings/python/test_x86.py||bindings/python/test_x86.py": [
          "File: bindings/python/test_x86.py -> bindings/python/test_x86.py",
          "--- Hunk 1 ---",
          "[Context before]",
          "99:                 print(\"\\t\\toperands[%u].type: REG = %s\" % (c, insn.reg_name(i.reg)))",
          "100:             if i.type == X86_OP_IMM:",
          "101:                 print(\"\\t\\toperands[%u].type: IMM = 0x%s\" % (c, to_x(i.imm)))",
          "104:             if i.type == X86_OP_MEM:",
          "105:                 print(\"\\t\\toperands[%u].type: MEM\" % c)",
          "106:                 if i.mem.segment != 0:",
          "",
          "[Removed Lines]",
          "102:             if i.type == X86_OP_FP:",
          "103:                 print(\"\\t\\toperands[%u].type: FP = %f\" % (c, i.fp))",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "232825380243f3cc8bb9dd7afc2cba9bc7459099",
      "candidate_info": {
        "commit_hash": "232825380243f3cc8bb9dd7afc2cba9bc7459099",
        "repo": "aquynh/capstone",
        "commit_url": "https://github.com/aquynh/capstone/commit/232825380243f3cc8bb9dd7afc2cba9bc7459099",
        "files": [
          "bindings/powershell/Capstone/Capstone.psm1"
        ],
        "message": "$Address -> UInt64 !Int32",
        "before_after_code_files": [
          "bindings/powershell/Capstone/Capstone.psm1||bindings/powershell/Capstone/Capstone.psm1"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/NeatNerdPrime/capstone/pull/17"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bindings/powershell/Capstone/Capstone.psm1||bindings/powershell/Capstone/Capstone.psm1": [
          "File: bindings/powershell/Capstone/Capstone.psm1 -> bindings/powershell/Capstone/Capstone.psm1",
          "--- Hunk 1 ---",
          "[Context before]",
          "125:   [String]$Syntax = \"Intel\",",
          "127:   [Parameter(ParameterSetName='Capstone', Mandatory = $False)]",
          "130:   [Parameter(ParameterSetName='Capstone', Mandatory = $False)]",
          "131:   [switch]$Detailed = $null,",
          "",
          "[Removed Lines]",
          "128:   [Int]$Address = 0x100000,",
          "",
          "[Added Lines]",
          "128:   [UInt64]$Address = 0x100000,",
          "",
          "---------------"
        ]
      }
    }
  ]
}