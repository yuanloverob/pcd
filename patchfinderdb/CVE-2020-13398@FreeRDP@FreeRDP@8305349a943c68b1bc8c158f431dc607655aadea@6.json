{
  "cve_id": "CVE-2020-13398",
  "cve_desc": "An issue was discovered in FreeRDP before 2.1.1. An out-of-bounds (OOB) write vulnerability has been detected in crypto_rsa_common in libfreerdp/crypto/crypto.c.",
  "repo": "FreeRDP/FreeRDP",
  "patch_hash": "8305349a943c68b1bc8c158f431dc607655aadea",
  "patch_info": {
    "commit_hash": "8305349a943c68b1bc8c158f431dc607655aadea",
    "repo": "FreeRDP/FreeRDP",
    "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/8305349a943c68b1bc8c158f431dc607655aadea",
    "files": [
      "libfreerdp/crypto/crypto.c"
    ],
    "message": "Fixed  GHSL-2020-102 heap overflow\n\n(cherry picked from commit 197b16cc15a12813c2e4fa2d6ae9cd9c4a57e581)",
    "before_after_code_files": [
      "libfreerdp/crypto/crypto.c||libfreerdp/crypto/crypto.c"
    ]
  },
  "patch_diff": {
    "libfreerdp/crypto/crypto.c||libfreerdp/crypto/crypto.c": [
      "File: libfreerdp/crypto/crypto.c -> libfreerdp/crypto/crypto.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "96: static int crypto_rsa_common(const BYTE* input, int length, UINT32 key_length, const BYTE* modulus,",
      "97:                              const BYTE* exponent, int exponent_size, BYTE* output)",
      "98: {",
      "100:  int output_length = -1;",
      "107:  if (!input_reverse)",
      "108:   return -1;",
      "",
      "[Removed Lines]",
      "99:  BN_CTX* ctx;",
      "101:  BYTE* input_reverse;",
      "102:  BYTE* modulus_reverse;",
      "103:  BYTE* exponent_reverse;",
      "104:  BIGNUM *mod, *exp, *x, *y;",
      "105:  input_reverse = (BYTE*)malloc(2 * key_length + exponent_size);",
      "",
      "[Added Lines]",
      "99:  BN_CTX* ctx = NULL;",
      "101:  BYTE* input_reverse = NULL;",
      "102:  BYTE* modulus_reverse = NULL;",
      "103:  BYTE* exponent_reverse = NULL;",
      "104:  BIGNUM* mod = NULL;",
      "105:  BIGNUM* exp = NULL;",
      "106:  BIGNUM* x = NULL;",
      "107:  BIGNUM* y = NULL;",
      "108:  size_t bufferSize = 2 * key_length + exponent_size;",
      "110:  if (!input || (length < 0) || (exponent_size < 0) || !modulus || !exponent || !output)",
      "111:   return -1;",
      "113:  if (length > bufferSize)",
      "114:   bufferSize = length;",
      "116:  input_reverse = (BYTE*)calloc(bufferSize, 1);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "131:  if (!(y = BN_new()))",
      "132:   goto fail_bn_y;",
      "138:  output_length = BN_bn2bin(y, output);",
      "139:  crypto_reverse(output, output_length);",
      "142:   memset(output + output_length, 0, key_length - output_length);",
      "144:  BN_free(y);",
      "145: fail_bn_y:",
      "146:  BN_clear_free(x);",
      "",
      "[Removed Lines]",
      "134:  BN_bin2bn(modulus_reverse, key_length, mod);",
      "135:  BN_bin2bn(exponent_reverse, exponent_size, exp);",
      "136:  BN_bin2bn(input_reverse, length, x);",
      "137:  BN_mod_exp(y, x, exp, mod, ctx);",
      "141:  if (output_length < (int)key_length)",
      "",
      "[Added Lines]",
      "145:  if (!BN_bin2bn(modulus_reverse, key_length, mod))",
      "146:   goto fail;",
      "148:  if (!BN_bin2bn(exponent_reverse, exponent_size, exp))",
      "149:   goto fail;",
      "150:  if (!BN_bin2bn(input_reverse, length, x))",
      "151:   goto fail;",
      "152:  if (BN_mod_exp(y, x, exp, mod, ctx) != 1)",
      "153:   goto fail;",
      "155:  if (output_length < 0)",
      "156:   goto fail;",
      "159:  if (output_length < key_length)",
      "162: fail:",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
      "candidate_info": {
        "commit_hash": "ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/ece877b515f1f7f3800fac9bcfdbdf0ee56f3ce3",
        "files": [
          "libfreerdp/core/nla.c"
        ],
        "message": "Fixed some more resource cleanup leaks in nla\n\n(cherry picked from commit 354bb7d6ae98df282775d154b609a39c1068a09b)",
        "before_after_code_files": [
          "libfreerdp/core/nla.c||libfreerdp/core/nla.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/core/nla.c||libfreerdp/core/nla.c": [
          "File: libfreerdp/core/nla.c -> libfreerdp/core/nla.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1144:  const BOOL ntlm = (_tcsncmp(nla->packageName, NTLM_SSP_NAME, ARRAYSIZE(NTLM_SSP_NAME)) == 0);",
          "1145:  public_key_length = nla->PublicKey.cbBuffer;",
          "1147:  if (!sspi_SecBufferAlloc(&nla->pubKeyAuth,",
          "1148:                           public_key_length + nla->ContextSizes.cbSecurityTrailer))",
          "1149:   return SEC_E_INSUFFICIENT_MEMORY;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1147:  sspi_SecBufferFree(&nla->pubKeyAuth);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2465:  sspi_SecBufferFree(&nla->tsCredentials);",
          "2466:  free(nla->ServicePrincipalName);",
          "2467:  nla_identity_free(nla->identity);",
          "2468:  free(nla);",
          "2469: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2469:  nla_buffer_free(nla);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "11eb374ef4306bec43213b5589e70995f236adc3",
      "candidate_info": {
        "commit_hash": "11eb374ef4306bec43213b5589e70995f236adc3",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/11eb374ef4306bec43213b5589e70995f236adc3",
        "files": [
          "libfreerdp/codec/rfx_dwt.c"
        ],
        "message": "improve RFX DWT algorithm\n\nmerge multiple loops into the one loop for vertical DWT inverse\n\n(cherry picked from commit fff9eba34af8a54bd93b1a7ccdda0a6a6898f755)",
        "before_after_code_files": [
          "libfreerdp/codec/rfx_dwt.c||libfreerdp/codec/rfx_dwt.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/codec/rfx_dwt.c||libfreerdp/codec/rfx_dwt.c": [
          "File: libfreerdp/codec/rfx_dwt.c -> libfreerdp/codec/rfx_dwt.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "88:  for (x = 0; x < total_width; x++)",
          "89:  {",
          "102:   {",
          "109:   }",
          "110:  }",
          "111: }",
          "",
          "[Removed Lines]",
          "91:   for (n = 0; n < subband_width; n++)",
          "92:   {",
          "93:    y = n << 1;",
          "94:    dst = buffer + y * total_width + x;",
          "95:    l = idwt + n * total_width + x;",
          "96:    h = l + subband_width * total_width;",
          "97:    dst[0] = *l - (((n > 0 ? *(h - total_width) : *h) + (*h) + 1) >> 1);",
          "98:   }",
          "101:   for (n = 0; n < subband_width; n++)",
          "103:    y = n << 1;",
          "104:    dst = buffer + y * total_width + x;",
          "105:    l = idwt + n * total_width + x;",
          "106:    h = l + subband_width * total_width;",
          "107:    dst[total_width] =",
          "108:        (*h << 1) + ((dst[0] + dst[n < subband_width - 1 ? 2 * total_width : 0]) >> 1);",
          "",
          "[Added Lines]",
          "90:   l = idwt + x;",
          "91:   h = idwt + x + subband_width * total_width;",
          "92:   dst = buffer + x;",
          "96:   for (n = 1; n < subband_width; n++)",
          "98:    l += total_width;",
          "99:    h += total_width;",
          "102:    dst[2 * total_width] = *l - ((*(h - total_width) + *h + 1) >> 1);",
          "105:    dst[total_width] = (*(h - total_width) << 1) + ((*dst + dst[2 * total_width]) >> 1);",
          "107:    dst += 2 * total_width;",
          "110:   dst[total_width] = (*h << 1) + ((*dst * 2) >> 1);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "630415e5237cfd661386f5a9b4f1ba3232aa4733",
      "candidate_info": {
        "commit_hash": "630415e5237cfd661386f5a9b4f1ba3232aa4733",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/630415e5237cfd661386f5a9b4f1ba3232aa4733",
        "files": [
          "winpr/include/winpr/sam.h",
          "winpr/libwinpr/utils/sam.c"
        ],
        "message": "Refactored sam functions to utilize strtok_s\n\n(cherry picked from commit ddb388e1527de69e47d55068d8a318ef270fc4a0)",
        "before_after_code_files": [
          "winpr/include/winpr/sam.h||winpr/include/winpr/sam.h",
          "winpr/libwinpr/utils/sam.c||winpr/libwinpr/utils/sam.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "winpr/include/winpr/sam.h||winpr/include/winpr/sam.h": [
          "File: winpr/include/winpr/sam.h -> winpr/include/winpr/sam.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "23: #include <winpr/winpr.h>",
          "24: #include <winpr/wtypes.h>",
          "33: typedef struct winpr_sam WINPR_SAM;",
          "35: struct winpr_sam_entry",
          "",
          "[Removed Lines]",
          "26: struct winpr_sam",
          "27: {",
          "28:  FILE* fp;",
          "29:  char* line;",
          "30:  char* buffer;",
          "31:  BOOL readOnly;",
          "32: };",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "winpr/libwinpr/utils/sam.c||winpr/libwinpr/utils/sam.c": [
          "File: winpr/libwinpr/utils/sam.c -> winpr/libwinpr/utils/sam.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "43: #endif",
          "44: #define TAG WINPR_TAG(\"utils\")",
          "46: WINPR_SAM* SamOpen(const char* filename, BOOL readOnly)",
          "47: {",
          "48:  FILE* fp = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "46: struct winpr_sam",
          "47: {",
          "48:  FILE* fp;",
          "49:  char* line;",
          "50:  char* buffer;",
          "51:  char* context;",
          "52:  BOOL readOnly;",
          "53: };",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "98:  if (fileSize < 1)",
          "99:   return FALSE;",
          "101:  sam->buffer = (char*)malloc(fileSize + 2);",
          "103:  if (!sam->buffer)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "110:  sam->context = NULL;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "121:  sam->buffer[fileSize] = '\\n';",
          "122:  sam->buffer[fileSize + 1] = '\\0';",
          "124:  return TRUE;",
          "125: }",
          "",
          "[Removed Lines]",
          "123:  sam->line = strtok(sam->buffer, \"\\n\");",
          "",
          "[Added Lines]",
          "133:  sam->line = strtok_s(sam->buffer, \"\\n\", &sam->context);",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "300:   }",
          "302:   SamResetEntry(entry);",
          "304:  }",
          "306: out_fail:",
          "",
          "[Removed Lines]",
          "303:   sam->line = strtok(NULL, \"\\n\");",
          "",
          "[Added Lines]",
          "313:   sam->line = strtok_s(NULL, \"\\n\", sam->context);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "415:   }",
          "417:   SamResetEntry(entry);",
          "419:  }",
          "421: out_fail:",
          "",
          "[Removed Lines]",
          "418:   sam->line = strtok(NULL, \"\\n\");",
          "",
          "[Added Lines]",
          "428:   sam->line = strtok_s(NULL, \"\\n\", sam->context);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "064a90c8b36b93f9d5c74dbb522203dfdca385c3",
      "candidate_info": {
        "commit_hash": "064a90c8b36b93f9d5c74dbb522203dfdca385c3",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/064a90c8b36b93f9d5c74dbb522203dfdca385c3",
        "files": [
          "libfreerdp/core/capabilities.c"
        ],
        "message": "Fixed BehaviorSanitizer warnings\n\n(cherry picked from commit afdd81dab5c484ab95b977a0d71f3809c8fa89a3)",
        "before_after_code_files": [
          "libfreerdp/core/capabilities.c||libfreerdp/core/capabilities.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "libfreerdp/core/capabilities.c||libfreerdp/core/capabilities.c": [
          "File: libfreerdp/core/capabilities.c -> libfreerdp/core/capabilities.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2702:  if (Stream_GetRemainingLength(s) < 16)",
          "2703:   return FALSE;",
          "2704:  Stream_Read(s, g, 16);",
          "2708:  guid->Data4[0] = g[8];",
          "2709:  guid->Data4[1] = g[9];",
          "2710:  guid->Data4[2] = g[10];",
          "",
          "[Removed Lines]",
          "2705:  guid->Data1 = (g[3] << 24) | (g[2] << 16) | (g[1] << 8) | g[0];",
          "2706:  guid->Data2 = (g[5] << 8) | g[4];",
          "2707:  guid->Data3 = (g[7] << 8) | g[6];",
          "",
          "[Added Lines]",
          "2705:  guid->Data1 = ((UINT32)g[3] << 24U) | ((UINT32)g[2] << 16U) | (g[1] << 8U) | g[0];",
          "2706:  guid->Data2 = (g[5] << 8U) | g[4];",
          "2707:  guid->Data3 = (g[7] << 8U) | g[6];",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "ca246a6bfd3b085b61695f458b863f2d60e082c2",
      "candidate_info": {
        "commit_hash": "ca246a6bfd3b085b61695f458b863f2d60e082c2",
        "repo": "FreeRDP/FreeRDP",
        "commit_url": "https://github.com/FreeRDP/FreeRDP/commit/ca246a6bfd3b085b61695f458b863f2d60e082c2",
        "files": [
          "channels/drdynvc/client/drdynvc_main.c"
        ],
        "message": "Clear dynamic channel lists on disconnect.\n\n(cherry picked from commit a1eb3e66b31579d3d878dee67913962140f75255)",
        "before_after_code_files": [
          "channels/drdynvc/client/drdynvc_main.c||channels/drdynvc/client/drdynvc_main.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_pr": 1,
        "olp_pr_links": [
          "https://github.com/FreeRDP/FreeRDP/pull/6212"
        ],
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "channels/drdynvc/client/drdynvc_main.c||channels/drdynvc/client/drdynvc_main.c": [
          "File: channels/drdynvc/client/drdynvc_main.c -> channels/drdynvc/client/drdynvc_main.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "381:  free(channel);",
          "382: }",
          "384: static void dvcman_free(drdynvcPlugin* drdynvc, IWTSVirtualChannelManager* pChannelMgr)",
          "385: {",
          "386:  DVCMAN* dvcman = (DVCMAN*)pChannelMgr;",
          "388:  ArrayList_Free(dvcman->plugins);",
          "389:  ArrayList_Free(dvcman->channels);",
          "390:  ArrayList_Free(dvcman->plugin_names);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "384: static void dvcman_clear(drdynvcPlugin* drdynvc, IWTSVirtualChannelManager* pChannelMgr)",
          "385: {",
          "386:  DVCMAN* dvcman = (DVCMAN*)pChannelMgr;",
          "388:  WINPR_UNUSED(drdynvc);",
          "390:  ArrayList_Clear(dvcman->plugins);",
          "391:  ArrayList_Clear(dvcman->channels);",
          "392:  ArrayList_Clear(dvcman->plugin_names);",
          "393:  ArrayList_Clear(dvcman->listeners);",
          "394: }",
          "400:  WINPR_UNUSED(drdynvc);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "473:  BOOL bAccept;",
          "474:  DVCMAN_CHANNEL* channel;",
          "475:  DrdynvcClientContext* context;",
          "477:  DVCMAN* dvcman = (DVCMAN*)pChannelMgr;",
          "478:  UINT error;",
          "",
          "[Removed Lines]",
          "476:  IWTSVirtualChannelCallback* pCallback;",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "495:   if (strcmp(listener->channel_name, ChannelName) == 0)",
          "496:   {",
          "497:    channel->iface.Write = dvcman_write_channel;",
          "498:    channel->iface.Close = dvcman_close_channel_iface;",
          "499:    bAccept = TRUE;",
          "502:    if ((error = listener->listener_callback->OnNewChannelConnection(",
          "503:             listener->listener_callback, &channel->iface, NULL, &bAccept, &pCallback)) ==",
          "",
          "[Removed Lines]",
          "500:    pCallback = NULL;",
          "",
          "[Added Lines]",
          "510:    IWTSVirtualChannelCallback* pCallback = NULL;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "1547:              WTSErrorToString(status), status);",
          "1548:  }",
          "1550:  drdynvc->OpenHandle = 0;",
          "1552:  if (drdynvc->data_in)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1563:  dvcman_clear(drdynvc, drdynvc->channel_mgr);",
          "1564:  MessageQueue_Clear(drdynvc->queue);",
          "",
          "---------------"
        ]
      }
    }
  ]
}