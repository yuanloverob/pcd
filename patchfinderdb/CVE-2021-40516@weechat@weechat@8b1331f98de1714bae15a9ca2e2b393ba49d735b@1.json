{
  "cve_id": "CVE-2021-40516",
  "cve_desc": "WeeChat before 3.2.1 allows remote attackers to cause a denial of service (crash) via a crafted WebSocket frame that trigger an out-of-bounds read in plugins/relay/relay-websocket.c in the Relay plugin.",
  "repo": "weechat/weechat",
  "patch_hash": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
  "patch_info": {
    "commit_hash": "8b1331f98de1714bae15a9ca2e2b393ba49d735b",
    "repo": "weechat/weechat",
    "commit_url": "https://github.com/weechat/weechat/commit/8b1331f98de1714bae15a9ca2e2b393ba49d735b",
    "files": [
      "ChangeLog.adoc",
      "src/plugins/relay/relay-websocket.c",
      "version.sh"
    ],
    "message": "relay: fix crash when decoding a malformed websocket frame",
    "before_after_code_files": [
      "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c",
      "version.sh||version.sh"
    ]
  },
  "patch_diff": {
    "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c": [
      "File: src/plugins/relay/relay-websocket.c -> src/plugins/relay/relay-websocket.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "278:     index_buffer = 0;",
      "282:     {",
      "283:         opcode = buffer[index_buffer] & 15;",
      "",
      "[Removed Lines]",
      "281:     while (index_buffer + 2 <= buffer_length)",
      "",
      "[Added Lines]",
      "281:     while (index_buffer + 1 < buffer_length)",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "293:         length_frame_size = 1;",
      "294:         length_frame = buffer[index_buffer + 1] & 127;",
      "295:         index_buffer += 2;",
      "296:         if ((length_frame == 126) || (length_frame == 127))",
      "297:         {",
      "298:             length_frame_size = (length_frame == 126) ? 2 : 8;",
      "300:                 return 0;",
      "301:             length_frame = 0;",
      "302:             for (i = 0; i < length_frame_size; i++)",
      "",
      "[Removed Lines]",
      "299:             if (buffer_length < 1 + length_frame_size)",
      "",
      "[Added Lines]",
      "296:         if (index_buffer >= buffer_length)",
      "297:             return 0;",
      "301:             if (index_buffer + length_frame_size > buffer_length)",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "306:             index_buffer += length_frame_size;",
      "307:         }",
      "313:         int masks[4];",
      "314:         for (i = 0; i < 4; i++)",
      "315:         {",
      "",
      "[Removed Lines]",
      "309:         if (buffer_length < 1 + length_frame_size + 4 + length_frame)",
      "310:             return 0;",
      "",
      "[Added Lines]",
      "312:         if (index_buffer + 4 > buffer_length)",
      "313:             return 0;",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "336:         for (i = 0; i < length_frame; i++)",
      "337:         {",
      "338:             decoded[*decoded_length + i] = (int)((unsigned char)buffer[index_buffer + i]) ^ masks[i % 4];",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "337:         if ((length_frame > buffer_length)",
      "338:             || (index_buffer + length_frame > buffer_length))",
      "339:         {",
      "340:             return 0;",
      "341:         }",
      "",
      "---------------"
    ],
    "version.sh||version.sh": [
      "File: version.sh -> version.sh",
      "--- Hunk 1 ---",
      "[Context before]",
      "33: #",
      "35: WEECHAT_STABLE=3.2",
      "39: if [ $# -lt 1 ]; then",
      "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
      "",
      "[Removed Lines]",
      "36: WEECHAT_DEVEL=3.2",
      "37: WEECHAT_DEVEL_FULL=3.2",
      "",
      "[Added Lines]",
      "36: WEECHAT_DEVEL=3.2.1",
      "37: WEECHAT_DEVEL_FULL=3.2.1-dev",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "43d9b3a7231175d1810756dc21d0ac93b9d2092c",
      "candidate_info": {
        "commit_hash": "43d9b3a7231175d1810756dc21d0ac93b9d2092c",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/43d9b3a7231175d1810756dc21d0ac93b9d2092c",
        "files": [
          "version.sh"
        ],
        "message": "Version 3.0-rc1",
        "before_after_code_files": [
          "version.sh||version.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: WEECHAT_STABLE=2.9",
          "36: WEECHAT_DEVEL=3.0",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "37: WEECHAT_DEVEL_FULL=3.0-dev",
          "",
          "[Added Lines]",
          "37: WEECHAT_DEVEL_FULL=3.0-rc1",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3ca58c2fd9a8cede7e02d3fa86340dd4cd69923d",
      "candidate_info": {
        "commit_hash": "3ca58c2fd9a8cede7e02d3fa86340dd4cd69923d",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/3ca58c2fd9a8cede7e02d3fa86340dd4cd69923d",
        "files": [
          "version.sh"
        ],
        "message": "Version 3.1-rc1",
        "before_after_code_files": [
          "version.sh||version.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "35: WEECHAT_STABLE=3.0",
          "36: WEECHAT_DEVEL=3.1",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "37: WEECHAT_DEVEL_FULL=3.1-dev",
          "",
          "[Added Lines]",
          "37: WEECHAT_DEVEL_FULL=3.1-rc1",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "4065d32e685ad0db1c46dc245ed067d3786d3d09",
      "candidate_info": {
        "commit_hash": "4065d32e685ad0db1c46dc245ed067d3786d3d09",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/4065d32e685ad0db1c46dc245ed067d3786d3d09",
        "files": [
          "version.sh"
        ],
        "message": "Version 3.1-dev",
        "before_after_code_files": [
          "version.sh||version.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #",
          "35: WEECHAT_STABLE=3.0",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "36: WEECHAT_DEVEL=3.0",
          "37: WEECHAT_DEVEL_FULL=3.0",
          "",
          "[Added Lines]",
          "36: WEECHAT_DEVEL=3.1",
          "37: WEECHAT_DEVEL_FULL=3.1-dev",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "2b1c2d6d05d55d176400d546a8b18b2231a82c3e",
      "candidate_info": {
        "commit_hash": "2b1c2d6d05d55d176400d546a8b18b2231a82c3e",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/2b1c2d6d05d55d176400d546a8b18b2231a82c3e",
        "files": [
          "version.sh"
        ],
        "message": "Version 3.2-dev",
        "before_after_code_files": [
          "version.sh||version.sh"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "version.sh||version.sh"
          ],
          "candidate": [
            "version.sh||version.sh"
          ]
        }
      },
      "candidate_diff": {
        "version.sh||version.sh": [
          "File: version.sh -> version.sh",
          "--- Hunk 1 ---",
          "[Context before]",
          "33: #",
          "35: WEECHAT_STABLE=3.1",
          "39: if [ $# -lt 1 ]; then",
          "40:     echo >&2 \"Syntax: $0 stable|devel|devel-full|devel-major|devel-minor|devel-patch\"",
          "",
          "[Removed Lines]",
          "36: WEECHAT_DEVEL=3.1",
          "37: WEECHAT_DEVEL_FULL=3.1",
          "",
          "[Added Lines]",
          "36: WEECHAT_DEVEL=3.2",
          "37: WEECHAT_DEVEL_FULL=3.2-dev",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "84e44632e54dba8e6f4f5190eb8d5e26bf0c9b8b",
      "candidate_info": {
        "commit_hash": "84e44632e54dba8e6f4f5190eb8d5e26bf0c9b8b",
        "repo": "weechat/weechat",
        "commit_url": "https://github.com/weechat/weechat/commit/84e44632e54dba8e6f4f5190eb8d5e26bf0c9b8b",
        "files": [
          "ChangeLog.adoc",
          "src/plugins/relay/relay-websocket.c"
        ],
        "message": "relay: fix crash when decoding a malformed websocket frame",
        "before_after_code_files": [
          "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_message": 1,
        "olp_code_files": {
          "patch": [
            "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c"
          ],
          "candidate": [
            "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c"
          ]
        }
      },
      "candidate_diff": {
        "src/plugins/relay/relay-websocket.c||src/plugins/relay/relay-websocket.c": [
          "File: src/plugins/relay/relay-websocket.c -> src/plugins/relay/relay-websocket.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "278:     index_buffer = 0;",
          "282:     {",
          "283:         opcode = buffer[index_buffer] & 15;",
          "",
          "[Removed Lines]",
          "281:     while (index_buffer + 2 <= buffer_length)",
          "",
          "[Added Lines]",
          "281:     while (index_buffer + 1 < buffer_length)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "293:         length_frame_size = 1;",
          "294:         length_frame = buffer[index_buffer + 1] & 127;",
          "295:         index_buffer += 2;",
          "296:         if ((length_frame == 126) || (length_frame == 127))",
          "297:         {",
          "298:             length_frame_size = (length_frame == 126) ? 2 : 8;",
          "300:                 return 0;",
          "301:             length_frame = 0;",
          "302:             for (i = 0; i < length_frame_size; i++)",
          "",
          "[Removed Lines]",
          "299:             if (buffer_length < 1 + length_frame_size)",
          "",
          "[Added Lines]",
          "296:         if (index_buffer >= buffer_length)",
          "297:             return 0;",
          "301:             if (index_buffer + length_frame_size > buffer_length)",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "306:             index_buffer += length_frame_size;",
          "307:         }",
          "313:         int masks[4];",
          "314:         for (i = 0; i < 4; i++)",
          "315:         {",
          "",
          "[Removed Lines]",
          "309:         if (buffer_length < 1 + length_frame_size + 4 + length_frame)",
          "310:             return 0;",
          "",
          "[Added Lines]",
          "312:         if (index_buffer + 4 > buffer_length)",
          "313:             return 0;",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "336:         for (i = 0; i < length_frame; i++)",
          "337:         {",
          "338:             decoded[*decoded_length + i] = (int)((unsigned char)buffer[index_buffer + i]) ^ masks[i % 4];",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "337:         if ((length_frame > buffer_length)",
          "338:             || (index_buffer + length_frame > buffer_length))",
          "339:         {",
          "340:             return 0;",
          "341:         }",
          "",
          "---------------"
        ]
      }
    }
  ]
}