{
  "cve_id": "CVE-2017-8807",
  "cve_desc": "vbf_stp_error in bin/varnishd/cache/cache_fetch.c in Varnish HTTP Cache 4.1.x before 4.1.9 and 5.x before 5.2.1 allows remote attackers to obtain sensitive information from process memory because a VFP_GetStorage buffer is larger than intended in certain circumstances involving -sfile Stevedore transient objects.",
  "repo": "varnishcache/varnish-cache",
  "patch_hash": "176f8a075a963ffbfa56f1c460c15f6a1a6af5a7",
  "patch_info": {
    "commit_hash": "176f8a075a963ffbfa56f1c460c15f6a1a6af5a7",
    "repo": "varnishcache/varnish-cache",
    "commit_url": "https://github.com/varnishcache/varnish-cache/commit/176f8a075a963ffbfa56f1c460c15f6a1a6af5a7",
    "files": [
      "bin/varnishd/cache/cache_fetch.c"
    ],
    "message": "Avoid buffer read overflow on vcl_error and -sfile\n\nThe file stevedore may return a buffer larger than asked for when\nrequesting storage. Due to lack of check for this condition, the code\nto copy the synthetic error memory buffer from vcl_error would overrun\nthe buffer.\n\nPatch by @shamger\n\nFixes: #2429",
    "before_after_code_files": [
      "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
    ]
  },
  "patch_diff": {
    "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c": [
      "File: bin/varnishd/cache/cache_fetch.c -> bin/varnishd/cache/cache_fetch.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "899:   l = ll;",
      "900:   if (VFP_GetStorage(bo->vfc, &l, &ptr) != VFP_OK)",
      "901:    break;",
      "902:   memcpy(ptr, VSB_data(synth_body) + o, l);",
      "903:   VFP_Extend(bo->vfc, l);",
      "904:   ll -= l;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "902:   if (l > ll)",
      "903:    l = ll;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "ce3c13b5f43ff76e8f6b9f11141cb8a143546b7b",
      "candidate_info": {
        "commit_hash": "ce3c13b5f43ff76e8f6b9f11141cb8a143546b7b",
        "repo": "varnishcache/varnish-cache",
        "commit_url": "https://github.com/varnishcache/varnish-cache/commit/ce3c13b5f43ff76e8f6b9f11141cb8a143546b7b",
        "files": [
          "bin/varnishtest/tests/r02429.vtc"
        ],
        "message": "Add a test case for #2429",
        "before_after_code_files": [
          "bin/varnishtest/tests/r02429.vtc||bin/varnishtest/tests/r02429.vtc"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_issue": 1,
        "olp_code_files": {
          "patch": [],
          "candidate": []
        }
      },
      "candidate_diff": {
        "bin/varnishtest/tests/r02429.vtc||bin/varnishtest/tests/r02429.vtc": [
          "File: bin/varnishtest/tests/r02429.vtc -> bin/varnishtest/tests/r02429.vtc",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1: varnishtest \"#2429 file stevedore error buffer regression test\"",
          "3: server s1 {",
          "4:  accept",
          "5: } -start",
          "7: varnish v1 -arg \"-s Transient=file,${tmpdir}/_.file,1m\" -vcl+backend {",
          "8:  sub vcl_backend_error {",
          "9:   synthetic(\"foo\");",
          "10:   return (deliver);",
          "11:  }",
          "12: } -start",
          "14: client c1 {",
          "15:  txreq",
          "16:  rxresp",
          "17:  expect resp.status == 503",
          "18:  expect resp.http.content-length == 3",
          "19:  expect resp.body == \"foo\"",
          "20: } -run",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "19a73184c6470a54f843c7c226c641a0b4ac2e8e",
      "candidate_info": {
        "commit_hash": "19a73184c6470a54f843c7c226c641a0b4ac2e8e",
        "repo": "varnishcache/varnish-cache",
        "commit_url": "https://github.com/varnishcache/varnish-cache/commit/19a73184c6470a54f843c7c226c641a0b4ac2e8e",
        "files": [
          "bin/varnishd/cache/cache_fetch.c"
        ],
        "message": "Avoid buffer read overflow on vcl_error and -sfile\n\nThe file stevedore may return a buffer larger than asked for when\nrequesting storage. Due to lack of check for this condition, the code\nto copy the synthetic error memory buffer from vcl_error would overrun\nthe buffer.\n\nPatch by @shamger\n\nFixes: #2429",
        "before_after_code_files": [
          "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
          ],
          "candidate": [
            "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
          ]
        }
      },
      "candidate_diff": {
        "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c": [
          "File: bin/varnishd/cache/cache_fetch.c -> bin/varnishd/cache/cache_fetch.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "873:   l = ll;",
          "874:   if (VFP_GetStorage(bo->vfc, &l, &ptr) != VFP_OK)",
          "875:    break;",
          "876:   memcpy(ptr, VSB_data(synth_body) + o, l);",
          "877:   VBO_extend(bo, l);",
          "878:   ll -= l;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "876:   if (l > ll)",
          "877:    l = ll;",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "14db3ecb442b016e1c5d0dbd830b1565b6cf5abb",
      "candidate_info": {
        "commit_hash": "14db3ecb442b016e1c5d0dbd830b1565b6cf5abb",
        "repo": "varnishcache/varnish-cache",
        "commit_url": "https://github.com/varnishcache/varnish-cache/commit/14db3ecb442b016e1c5d0dbd830b1565b6cf5abb",
        "files": [
          "bin/varnishd/cache/cache_fetch.c"
        ],
        "message": "Avoid buffer read overflow on vcl_error and -sfile\n\nThe file stevedore may return a buffer larger than asked for when\nrequesting storage. Due to lack of check for this condition, the code\nto copy the synthetic error memory buffer from vcl_error would overrun\nthe buffer.\n\nPatch by @shamger\n\nFixes: #2429",
        "before_after_code_files": [
          "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
          ],
          "candidate": [
            "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c"
          ]
        }
      },
      "candidate_diff": {
        "bin/varnishd/cache/cache_fetch.c||bin/varnishd/cache/cache_fetch.c": [
          "File: bin/varnishd/cache/cache_fetch.c -> bin/varnishd/cache/cache_fetch.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "899:   l = ll;",
          "900:   if (VFP_GetStorage(bo->vfc, &l, &ptr) != VFP_OK)",
          "901:    break;",
          "902:   memcpy(ptr, VSB_data(synth_body) + o, l);",
          "903:   VFP_Extend(bo->vfc, l);",
          "904:   ll -= l;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "902:   if (l > ll)",
          "903:    l = ll;",
          "",
          "---------------"
        ]
      }
    }
  ]
}