{
  "cve_id": "CVE-2020-15260",
  "cve_desc": "PJSIP is a free and open source multimedia communication library written in C language implementing standard based protocols such as SIP, SDP, RTP, STUN, TURN, and ICE. In version 2.10 and earlier, PJSIP transport can be reused if they have the same IP address + port + protocol. However, this is insufficient for secure transport since it lacks remote hostname authentication. Suppose we have created a TLS connection to `sip.foo.com`, which has an IP address `100.1.1.1`. If we want to create a TLS connection to another hostname, say `sip.bar.com`, which has the same IP address, then it will reuse that existing connection, even though `100.1.1.1` does not have certificate to authenticate as `sip.bar.com`. The vulnerability allows for an insecure interaction without user awareness. It affects users who need access to connections to different destinations that translate to the same address, and allows man-in-the-middle attack if attacker can route a connection to another destination such as in the case of DNS spoofing.",
  "repo": "pjsip/pjproject",
  "patch_hash": "67e46c1ac45ad784db5b9080f5ed8b133c122872",
  "patch_info": {
    "commit_hash": "67e46c1ac45ad784db5b9080f5ed8b133c122872",
    "repo": "pjsip/pjproject",
    "commit_url": "https://github.com/pjsip/pjproject/commit/67e46c1ac45ad784db5b9080f5ed8b133c122872",
    "files": [
      "pjsip/include/pjsip/sip_dialog.h",
      "pjsip/src/pjsip/sip_dialog.c",
      "pjsip/src/pjsip/sip_transport.c",
      "pjsip/src/pjsip/sip_util.c"
    ],
    "message": "Merge pull request from GHSA-8hcp-hm38-mfph\n\n* Check hostname during TLS transport selection\n\n* revision based on feedback\n\n* remove the code in create_request that has been moved",
    "before_after_code_files": [
      "pjsip/include/pjsip/sip_dialog.h||pjsip/include/pjsip/sip_dialog.h",
      "pjsip/src/pjsip/sip_dialog.c||pjsip/src/pjsip/sip_dialog.c",
      "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c",
      "pjsip/src/pjsip/sip_util.c||pjsip/src/pjsip/sip_util.c"
    ]
  },
  "patch_diff": {
    "pjsip/include/pjsip/sip_dialog.h||pjsip/include/pjsip/sip_dialog.h": [
      "File: pjsip/include/pjsip/sip_dialog.h -> pjsip/include/pjsip/sip_dialog.h"
    ],
    "pjsip/src/pjsip/sip_dialog.c||pjsip/src/pjsip/sip_dialog.c": [
      "File: pjsip/src/pjsip/sip_dialog.c -> pjsip/src/pjsip/sip_dialog.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "469:     pj_strdup(dlg->pool, &dlg->remote.info_str, &tmp);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "472:     pj_strdup(dlg->pool, &dlg->initial_dest,",
      "473:            &rdata->tp_info.transport->remote_name.host);",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1192:      return status;",
      "1193:     }",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1202:     if (dlg->initial_dest.slen)",
      "1203:      pj_strdup(tdata->pool, &tdata->dest_info.name, &dlg->initial_dest);",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "1824:     if (dlg->role == PJSIP_ROLE_UAC) {",
      "1827:  if (msg->type != PJSIP_RESPONSE_MSG)",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "1836:      if (!dlg->initial_dest.slen) {",
      "1837:          pj_strdup(dlg->pool, &dlg->initial_dest,",
      "1838:                   &rdata->tp_info.transport->remote_name.host);",
      "1839:      }",
      "",
      "---------------"
    ],
    "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c": [
      "File: pjsip/src/pjsip/sip_transport.c -> pjsip/src/pjsip/sip_transport.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "2335:       if (!tp_iter->tp->is_shutdown &&",
      "2336:    !tp_iter->tp->is_destroying)",
      "2337:       {",
      "2338:    if (sel && sel->type == PJSIP_TPSELECTOR_LISTENER &&",
      "2339:        sel->u.listener)",
      "2340:    {",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "2338:    if ((type & PJSIP_TRANSPORT_SECURE) && tdata) {",
      "2343:        if (pj_stricmp(&tdata->dest_info.name,",
      "2344:           &tp_iter->tp->remote_name.host))",
      "2345:        {",
      "2346:         tp_iter = tp_iter->next;",
      "2347:         continue;",
      "2348:        }",
      "2349:    }",
      "",
      "---------------"
    ],
    "pjsip/src/pjsip/sip_util.c||pjsip/src/pjsip/sip_util.c": [
      "File: pjsip/src/pjsip/sip_util.c -> pjsip/src/pjsip/sip_util.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1418:     if (tdata->dest_info.addr.count == 0) {",
      "1422:  pjsip_endpt_resolve( endpt, tdata->pool, &dest_info, stateless_data,",
      "1423:         &stateless_send_resolver_callback);",
      "",
      "[Removed Lines]",
      "1420:  pj_strdup(tdata->pool, &tdata->dest_info.name, &dest_info.addr.host);",
      "",
      "[Added Lines]",
      "1420:  if (!tdata->dest_info.name.slen) {",
      "1421:      pj_strdup(tdata->pool, &tdata->dest_info.name,",
      "1422:             &dest_info.addr.host);",
      "1423:  }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "1810:  }",
      "1811:     } else {",
      "1816:  pjsip_endpt_resolve(endpt, tdata->pool, &res_addr->dst_host,",
      "1817:        send_state, &send_response_resolver_cb);",
      "",
      "[Removed Lines]",
      "1813:  pj_strdup(tdata->pool, &tdata->dest_info.name,",
      "1814:     &res_addr->dst_host.addr.host);",
      "",
      "[Added Lines]",
      "1816:  if (!tdata->dest_info.name.slen) {",
      "1817:      pj_strdup(tdata->pool, &tdata->dest_info.name,",
      "1818:         &res_addr->dst_host.addr.host);",
      "1819:  }",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "90a7d70ae24eed1f482e1f67c1f009f11787f3f5",
      "candidate_info": {
        "commit_hash": "90a7d70ae24eed1f482e1f67c1f009f11787f3f5",
        "repo": "pjsip/pjproject",
        "commit_url": "https://github.com/pjsip/pjproject/commit/90a7d70ae24eed1f482e1f67c1f009f11787f3f5",
        "files": [
          "pjsip/src/pjsip/sip_transport.c"
        ],
        "message": "Fix secure transport checking (#2663)",
        "before_after_code_files": [
          "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 0,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c"
          ],
          "candidate": [
            "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c"
          ]
        }
      },
      "candidate_diff": {
        "pjsip/src/pjsip/sip_transport.c||pjsip/src/pjsip/sip_transport.c": [
          "File: pjsip/src/pjsip/sip_transport.c -> pjsip/src/pjsip/sip_transport.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "2304:  int key_len;",
          "2305:  pjsip_transport *tp_ref = NULL;",
          "2306:  transport *tp_entry = NULL;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "2307:  unsigned flag = pjsip_transport_get_flag_from_type(type);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "2335:       if (!tp_iter->tp->is_shutdown &&",
          "2336:    !tp_iter->tp->is_destroying)",
          "2337:       {",
          "",
          "[Removed Lines]",
          "2338:    if ((type & PJSIP_TRANSPORT_SECURE) && tdata) {",
          "",
          "[Added Lines]",
          "2338:    if ((flag & PJSIP_TRANSPORT_SECURE) && tdata) {",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "2369:  if (tp_ref == NULL &&",
          "2370:      (!sel || sel->disable_connection_reuse == PJ_FALSE))",
          "2371:  {",
          "2373:      const pj_sockaddr *remote_addr = (const pj_sockaddr*)remote;",
          "",
          "[Removed Lines]",
          "2372:      unsigned flag = pjsip_transport_get_flag_from_type(type);",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ]
      }
    }
  ]
}