{
  "cve_id": "CVE-2010-4159",
  "cve_desc": "Untrusted search path vulnerability in metadata/loader.c in Mono 2.8 and earlier allows local users to gain privileges via a Trojan horse shared library in the current working directory.",
  "repo": "mono/mono",
  "patch_hash": "8e890a3bf80a4620e417814dc14886b1bbd17625",
  "patch_info": {
    "commit_hash": "8e890a3bf80a4620e417814dc14886b1bbd17625",
    "repo": "mono/mono",
    "commit_url": "https://github.com/mono/mono/commit/8e890a3bf80a4620e417814dc14886b1bbd17625",
    "files": [
      "mono/metadata/loader.c"
    ],
    "message": "Search for dllimported shared libs in the base directory, not cwd.\n\n* loader.c: we don't search the current directory anymore for shared\nlibraries referenced in DllImport attributes, as it has a slight\nsecurity risk. We search in the same directory where the referencing\nimage was loaded from, instead. Fixes bug# 641915.",
    "before_after_code_files": [
      "mono/metadata/loader.c||mono/metadata/loader.c"
    ]
  },
  "patch_diff": {
    "mono/metadata/loader.c||mono/metadata/loader.c": [
      "File: mono/metadata/loader.c -> mono/metadata/loader.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "1341:   if (!module) {",
      "1342:    void *iter = NULL;",
      "1344:     mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
      "1346:     module = cached_module_load (full_name, MONO_DL_LAZY, &error_msg);",
      "1347:     if (!module) {",
      "1348:      mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
      "1351:      g_free (error_msg);",
      "1352:     }",
      "1353:     g_free (full_name);",
      "1354:     if (module)",
      "1355:      break;",
      "1356:    }",
      "1357:   }",
      "1359:   if (!module) {",
      "1360:    void *iter = NULL;",
      "1362:     mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
      "1364:     module = cached_module_load (full_name, MONO_DL_LAZY, &error_msg);",
      "1365:     if (!module) {",
      "1366:      mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
      "1369:      g_free (error_msg);",
      "1370:     }",
      "1371:     g_free (full_name);",
      "",
      "[Removed Lines]",
      "1343:    while ((full_name = mono_dl_build_path (NULL, file_name, &iter))) {",
      "1345:       \"DllImport loading location: '%s'.\", full_name);",
      "1349:        \"DllImport error loading library: '%s'.\",",
      "1350:        error_msg);",
      "1361:    while ((full_name = mono_dl_build_path (\".\", file_name, &iter))) {",
      "1363:      \"DllImport loading library: '%s'.\", full_name);",
      "1367:       \"DllImport error loading library '%s'.\",",
      "1368:       error_msg);",
      "",
      "[Added Lines]",
      "1343:    char *mdirname = g_path_get_dirname (image->name);",
      "1344:    while ((full_name = mono_dl_build_path (mdirname, file_name, &iter))) {",
      "1346:      \"DllImport loading library: '%s'.\", full_name);",
      "1350:       \"DllImport error loading library '%s'.\",",
      "1351:       error_msg);",
      "1358:    g_free (mdirname);",
      "1363:    while ((full_name = mono_dl_build_path (NULL, file_name, &iter))) {",
      "1365:       \"DllImport loading location: '%s'.\", full_name);",
      "1369:        \"DllImport error loading library: '%s'.\",",
      "1370:        error_msg);",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "d3985be4e45a001e73fdcc47db190b3df61b2a51",
      "candidate_info": {
        "commit_hash": "d3985be4e45a001e73fdcc47db190b3df61b2a51",
        "repo": "mono/mono",
        "commit_url": "https://github.com/mono/mono/commit/d3985be4e45a001e73fdcc47db190b3df61b2a51",
        "files": [
          "mono/metadata/loader.c"
        ],
        "message": "Search for dllimported shared libs in the base directory, not cwd.\n\n* loader.c: we don't search the current directory anymore for shared\nlibraries referenced in DllImport attributes, as it has a slight\nsecurity risk. We search in the same directory where the referencing\nimage was loaded from, instead. Fixes bug# 641915.",
        "before_after_code_files": [
          "mono/metadata/loader.c||mono/metadata/loader.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "mono/metadata/loader.c||mono/metadata/loader.c"
          ],
          "candidate": [
            "mono/metadata/loader.c||mono/metadata/loader.c"
          ]
        }
      },
      "candidate_diff": {
        "mono/metadata/loader.c||mono/metadata/loader.c": [
          "File: mono/metadata/loader.c -> mono/metadata/loader.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1344:   if (!module) {",
          "1345:    void *iter = NULL;",
          "1347:     mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
          "1349:     module = cached_module_load (full_name, MONO_DL_LAZY, &error_msg);",
          "1350:     if (!module) {",
          "1351:      mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
          "1354:      g_free (error_msg);",
          "1355:     }",
          "1356:     g_free (full_name);",
          "1357:     if (module)",
          "1358:      break;",
          "1359:    }",
          "1360:   }",
          "1362:   if (!module) {",
          "1363:    void *iter = NULL;",
          "1365:     mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
          "1367:     module = cached_module_load (full_name, MONO_DL_LAZY, &error_msg);",
          "1368:     if (!module) {",
          "1369:      mono_trace (G_LOG_LEVEL_INFO, MONO_TRACE_DLLIMPORT,",
          "1372:      g_free (error_msg);",
          "1373:     }",
          "1374:     g_free (full_name);",
          "",
          "[Removed Lines]",
          "1346:    while ((full_name = mono_dl_build_path (NULL, file_name, &iter))) {",
          "1348:       \"DllImport loading location: '%s'.\", full_name);",
          "1352:        \"DllImport error loading library: '%s'.\",",
          "1353:        error_msg);",
          "1364:    while ((full_name = mono_dl_build_path (\".\", file_name, &iter))) {",
          "1366:      \"DllImport loading library: '%s'.\", full_name);",
          "1370:       \"DllImport error loading library '%s'.\",",
          "1371:       error_msg);",
          "",
          "[Added Lines]",
          "1346:    char *mdirname = g_path_get_dirname (image->name);",
          "1347:    while ((full_name = mono_dl_build_path (mdirname, file_name, &iter))) {",
          "1349:      \"DllImport loading library: '%s'.\", full_name);",
          "1353:       \"DllImport error loading library '%s'.\",",
          "1354:       error_msg);",
          "1361:    g_free (mdirname);",
          "1366:    while ((full_name = mono_dl_build_path (NULL, file_name, &iter))) {",
          "1368:       \"DllImport loading location: '%s'.\", full_name);",
          "1372:        \"DllImport error loading library: '%s'.\",",
          "1373:        error_msg);",
          "",
          "---------------"
        ]
      }
    }
  ]
}