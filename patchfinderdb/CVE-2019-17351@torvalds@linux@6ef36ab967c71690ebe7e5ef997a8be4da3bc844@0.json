{
  "cve_id": "CVE-2019-17351",
  "cve_desc": "An issue was discovered in drivers/xen/balloon.c in the Linux kernel before 5.2.3, as used in Xen through 4.12.x, allowing guest OS users to cause a denial of service because of unrestricted resource consumption during the mapping of guest memory, aka CID-6ef36ab967c7.",
  "repo": "torvalds/linux",
  "patch_hash": "6ef36ab967c71690ebe7e5ef997a8be4da3bc844",
  "patch_info": {
    "commit_hash": "6ef36ab967c71690ebe7e5ef997a8be4da3bc844",
    "repo": "torvalds/linux",
    "commit_url": "https://github.com/torvalds/linux/commit/6ef36ab967c71690ebe7e5ef997a8be4da3bc844",
    "files": [
      "drivers/xen/balloon.c"
    ],
    "message": "xen: let alloc_xenballooned_pages() fail if not enough memory free\n\ncommit a1078e821b605813b63bf6bca414a85f804d5c66 upstream.\n\nInstead of trying to allocate pages with GFP_USER in\nadd_ballooned_pages() check the available free memory via\nsi_mem_available(). GFP_USER is far less limiting memory exhaustion\nthan the test via si_mem_available().\n\nThis will avoid dom0 running out of memory due to excessive foreign\npage mappings especially on ARM and on x86 in PVH mode, as those don't\nhave a pre-ballooned area which can be used for foreign mappings.\n\nAs the normal ballooning suffers from the same problem don't balloon\ndown more than si_mem_available() pages in one iteration. At the same\ntime limit the default maximum number of retries.\n\nThis is part of XSA-300.\n\nSigned-off-by: Juergen Gross <jgross@suse.com>\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>",
    "before_after_code_files": [
      "drivers/xen/balloon.c||drivers/xen/balloon.c"
    ]
  },
  "patch_diff": {
    "drivers/xen/balloon.c||drivers/xen/balloon.c": [
      "File: drivers/xen/balloon.c -> drivers/xen/balloon.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "538:     state = reserve_additional_memory();",
      "539:   }",
      "544:   state = update_schedule(state);",
      "",
      "[Removed Lines]",
      "541:   if (credit < 0)",
      "542:    state = decrease_reservation(-credit, GFP_BALLOON);",
      "",
      "[Added Lines]",
      "541:   if (credit < 0) {",
      "542:    long n_pages;",
      "544:    n_pages = min(-credit, si_mem_available());",
      "545:    state = decrease_reservation(n_pages, GFP_BALLOON);",
      "546:    if (state == BP_DONE && n_pages != -credit &&",
      "547:        n_pages < totalreserve_pages)",
      "548:     state = BP_EAGAIN;",
      "549:   }",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "578:   }",
      "579:  }",
      "581:  st = decrease_reservation(nr_pages, GFP_USER);",
      "582:  if (st != BP_DONE)",
      "583:   return -ENOMEM;",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "588:  if (si_mem_available() < nr_pages)",
      "589:   return -ENOMEM;",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "710:  balloon_stats.schedule_delay = 1;",
      "711:  balloon_stats.max_schedule_delay = 32;",
      "712:  balloon_stats.retry_count = 1;",
      "715: #ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG",
      "716:  set_online_page_callback(&xen_online_page);",
      "",
      "[Removed Lines]",
      "713:  balloon_stats.max_retry_count = RETRY_UNLIMITED;",
      "",
      "[Added Lines]",
      "723:  balloon_stats.max_retry_count = 4;",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a1078e821b605813b63bf6bca414a85f804d5c66",
      "candidate_info": {
        "commit_hash": "a1078e821b605813b63bf6bca414a85f804d5c66",
        "repo": "torvalds/linux",
        "commit_url": "https://github.com/torvalds/linux/commit/a1078e821b605813b63bf6bca414a85f804d5c66",
        "files": [
          "drivers/xen/balloon.c"
        ],
        "message": "xen: let alloc_xenballooned_pages() fail if not enough memory free\n\nInstead of trying to allocate pages with GFP_USER in\nadd_ballooned_pages() check the available free memory via\nsi_mem_available(). GFP_USER is far less limiting memory exhaustion\nthan the test via si_mem_available().\n\nThis will avoid dom0 running out of memory due to excessive foreign\npage mappings especially on ARM and on x86 in PVH mode, as those don't\nhave a pre-ballooned area which can be used for foreign mappings.\n\nAs the normal ballooning suffers from the same problem don't balloon\ndown more than si_mem_available() pages in one iteration. At the same\ntime limit the default maximum number of retries.\n\nThis is part of XSA-300.\n\nSigned-off-by: Juergen Gross <jgross@suse.com>",
        "before_after_code_files": [
          "drivers/xen/balloon.c||drivers/xen/balloon.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "diff_branch_same_aad": 1,
        "olp_code_files": {
          "patch": [
            "drivers/xen/balloon.c||drivers/xen/balloon.c"
          ],
          "candidate": [
            "drivers/xen/balloon.c||drivers/xen/balloon.c"
          ]
        }
      },
      "candidate_diff": {
        "drivers/xen/balloon.c||drivers/xen/balloon.c": [
          "File: drivers/xen/balloon.c -> drivers/xen/balloon.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "538:     state = reserve_additional_memory();",
          "539:   }",
          "544:   state = update_schedule(state);",
          "",
          "[Removed Lines]",
          "541:   if (credit < 0)",
          "542:    state = decrease_reservation(-credit, GFP_BALLOON);",
          "",
          "[Added Lines]",
          "541:   if (credit < 0) {",
          "542:    long n_pages;",
          "544:    n_pages = min(-credit, si_mem_available());",
          "545:    state = decrease_reservation(n_pages, GFP_BALLOON);",
          "546:    if (state == BP_DONE && n_pages != -credit &&",
          "547:        n_pages < totalreserve_pages)",
          "548:     state = BP_EAGAIN;",
          "549:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "578:   }",
          "579:  }",
          "581:  st = decrease_reservation(nr_pages, GFP_USER);",
          "582:  if (st != BP_DONE)",
          "583:   return -ENOMEM;",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "588:  if (si_mem_available() < nr_pages)",
          "589:   return -ENOMEM;",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "710:  balloon_stats.schedule_delay = 1;",
          "711:  balloon_stats.max_schedule_delay = 32;",
          "712:  balloon_stats.retry_count = 1;",
          "715: #ifdef CONFIG_XEN_BALLOON_MEMORY_HOTPLUG",
          "716:  set_online_page_callback(&xen_online_page);",
          "",
          "[Removed Lines]",
          "713:  balloon_stats.max_retry_count = RETRY_UNLIMITED;",
          "",
          "[Added Lines]",
          "723:  balloon_stats.max_retry_count = 4;",
          "",
          "---------------"
        ]
      }
    }
  ]
}