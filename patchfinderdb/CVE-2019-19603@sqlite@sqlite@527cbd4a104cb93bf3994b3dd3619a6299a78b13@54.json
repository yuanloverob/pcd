{
  "cve_id": "CVE-2019-19603",
  "cve_desc": "SQLite 3.30.1 mishandles certain SELECT statements with a nonexistent VIEW, leading to an application crash.",
  "repo": "sqlite/sqlite",
  "patch_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
  "patch_info": {
    "commit_hash": "527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "repo": "sqlite/sqlite",
    "commit_url": "https://github.com/sqlite/sqlite/commit/527cbd4a104cb93bf3994b3dd3619a6299a78b13",
    "files": [
      "manifest",
      "manifest.uuid",
      "src/build.c",
      "src/sqliteInt.h",
      "test/altertab.test"
    ],
    "message": "Do not allow CREATE TABLE or CREATE VIEW of an object with a name that looks like a shadow table name.\n\nFossilOrigin-Name: 6aef58b629d89955f85f65191ba2be67b2adfac4f0327fe9a7141cb2705dbc00",
    "before_after_code_files": [
      "manifest.uuid||manifest.uuid",
      "src/build.c||src/build.c",
      "src/sqliteInt.h||src/sqliteInt.h",
      "test/altertab.test||test/altertab.test"
    ]
  },
  "patch_diff": {
    "manifest.uuid||manifest.uuid": [
      "File: manifest.uuid -> manifest.uuid",
      "--- Hunk 1 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "1: 8ad34d36a141fa8f5d9bd784dfeb892c983897a6dc6b867607cc668508acf944",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------"
    ],
    "src/build.c||src/build.c": [
      "File: src/build.c -> src/build.c",
      "--- Hunk 1 ---",
      "[Context before]",
      "856:       }",
      "857:     }",
      "858:   }else{",
      "861:     ){",
      "862:       sqlite3ErrorMsg(pParse, \"object name reserved for internal use: %s\",",
      "863:                       zName);",
      "864:       return SQLITE_ERROR;",
      "865:     }",
      "866:   }",
      "867:   return SQLITE_OK;",
      "868: }",
      "",
      "[Removed Lines]",
      "859:     if( pParse->nested==0",
      "860:      && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7)",
      "",
      "[Added Lines]",
      "859:     if( (pParse->nested==0 && 0==sqlite3StrNICmp(zName, \"sqlite_\", 7))",
      "860:      || (sqlite3ReadOnlyShadowTables(db) && sqlite3ShadowTableName(db, zName))",
      "",
      "---------------",
      "--- Hunk 2 ---",
      "[Context before]",
      "[No context available]",
      "",
      "[Removed Lines]",
      "2132: static int isShadowTableName(sqlite3 *db, char *zName){",
      "",
      "[Added Lines]",
      "2133: int sqlite3ShadowTableName(sqlite3 *db, const char *zName){",
      "",
      "---------------",
      "--- Hunk 3 ---",
      "[Context before]",
      "2147:   if( pMod->pModule->xShadowName==0 ) return 0;",
      "2148:   return pMod->pModule->xShadowName(zTail+1);",
      "2149: }",
      "",
      "[Removed Lines]",
      "2150: #else",
      "2151: # define isShadowTableName(x,y) 0",
      "",
      "[Added Lines]",
      "[None]",
      "",
      "---------------",
      "--- Hunk 4 ---",
      "[Context before]",
      "2190:   p = pParse->pNewTable;",
      "2191:   if( p==0 ) return;",
      "2194:     p->tabFlags |= TF_Shadow;",
      "2195:   }",
      "",
      "[Removed Lines]",
      "2193:   if( pSelect==0 && isShadowTableName(db, p->zName) ){",
      "",
      "[Added Lines]",
      "2192:   if( pSelect==0 && sqlite3ShadowTableName(db, p->zName) ){",
      "",
      "---------------"
    ],
    "src/sqliteInt.h||src/sqliteInt.h": [
      "File: src/sqliteInt.h -> src/sqliteInt.h",
      "--- Hunk 1 ---",
      "[Context before]",
      "4548: #  define sqlite3VtabInSync(db) ((db)->nVTrans>0 && (db)->aVTrans==0)",
      "4549: #endif",
      "4550: int sqlite3ReadOnlyShadowTables(sqlite3 *db);",
      "4551: int sqlite3VtabEponymousTableInit(Parse*,Module*);",
      "4552: void sqlite3VtabEponymousTableClear(sqlite3*,Module*);",
      "4553: void sqlite3VtabMakeWritable(Parse*,Table*);",
      "",
      "[Removed Lines]",
      "[None]",
      "",
      "[Added Lines]",
      "4551: #ifndef SQLITE_OMIT_VIRTUALTABLE",
      "4552:   int sqlite3ShadowTableName(sqlite3 *db, const char *zName);",
      "4553: #else",
      "4554: # define sqlite3ShadowTableName(A,B) 0",
      "4555: #endif",
      "",
      "---------------"
    ],
    "test/altertab.test||test/altertab.test": [
      "File: test/altertab.test -> test/altertab.test",
      "--- Hunk 1 ---",
      "[Context before]",
      "547:   } {1 {table y1_segments may not be modified}}",
      "549:   do_catchsql_test 16.20 {",
      "554:     DROP TABLE y1_segments;",
      "555:   } {1 {table y1_segments may not be dropped}}",
      "557:   do_execsql_test 16.30 {",
      "558:     ALTER TABLE y1 RENAME TO z1;",
      "559:   }",
      "",
      "[Removed Lines]",
      "550:     ALTER TABLE y1_segments RENAME TO abc;",
      "551:   } {1 {table y1_segments may not be altered}}",
      "553:   do_catchsql_test 16.21 {",
      "",
      "[Added Lines]",
      "553:   do_catchsql_test 16.20 {",
      "554:     ALTER TABLE y1_segments RENAME TO abc;",
      "555:   } {1 {table y1_segments may not be altered}}",
      "556:   sqlite3_db_config db DEFENSIVE 0",
      "557:   do_catchsql_test 16.22 {",
      "558:     ALTER TABLE y1_segments RENAME TO abc;",
      "559:   } {0 {}}",
      "560:   sqlite3_db_config db DEFENSIVE 1",
      "561:   do_catchsql_test 16.23 {",
      "562:     CREATE TABLE y1_segments AS SELECT * FROM abc;",
      "563:   } {1 {object name reserved for internal use: y1_segments}}",
      "564:   do_catchsql_test 16.24 {",
      "565:     CREATE VIEW y1_segments AS SELECT * FROM abc;",
      "566:   } {1 {object name reserved for internal use: y1_segments}}",
      "567:   sqlite3_db_config db DEFENSIVE 0",
      "568:   do_catchsql_test 16.25 {",
      "569:     ALTER TABLE abc RENAME TO y1_segments;",
      "570:   } {0 {}}",
      "571:   sqlite3_db_config db DEFENSIVE 1",
      "",
      "---------------"
    ]
  },
  "candidates": [
    {
      "candidate_hash": "a7d6db6ac05cb7d51c19494feba51a65c6a21cd2",
      "candidate_info": {
        "commit_hash": "a7d6db6ac05cb7d51c19494feba51a65c6a21cd2",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/a7d6db6ac05cb7d51c19494feba51a65c6a21cd2",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/expr.c",
          "src/resolve.c",
          "src/sqliteInt.h",
          "test/func3.test"
        ],
        "message": "The affinity of the unlikely() function and its cousins should be \"none\". Ticket [0c620df60bffd9ef]\n\nFossilOrigin-Name: 614ecb0af47038848e8ba2aed6b92db6f33ddc4aea6361795dbde440380f5a35",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/expr.c||src/expr.c",
          "src/resolve.c||src/resolve.c",
          "src/sqliteInt.h||src/sqliteInt.h",
          "test/func3.test||test/func3.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 0f748fe58bbbb7ce3f30303da25ec811b2bbce249549aa9c7927979ac5b38013",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/expr.c||src/expr.c": [
          "File: src/expr.c -> src/expr.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "45: char sqlite3ExprAffinity(Expr *pExpr){",
          "46:   int op;",
          "47:   if( pExpr->flags & EP_Generic ) return 0;",
          "49:   op = pExpr->op;",
          "50:   if( op==TK_SELECT ){",
          "51:     assert( pExpr->flags&EP_xIsSelect );",
          "",
          "[Removed Lines]",
          "48:   pExpr = sqlite3ExprSkipCollate(pExpr);",
          "",
          "[Added Lines]",
          "48:   while( ExprHasProperty(pExpr, EP_Skip) ){",
          "49:     assert( pExpr->op==TK_COLLATE );",
          "50:     pExpr = pExpr->pLeft;",
          "51:     assert( pExpr!=0 );",
          "52:   }",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "108: Expr *sqlite3ExprSkipCollate(Expr *pExpr){",
          "110:     if( ExprHasProperty(pExpr, EP_Unlikely) ){",
          "111:       assert( !ExprHasProperty(pExpr, EP_xIsSelect) );",
          "112:       assert( pExpr->x.pList->nExpr>0 );",
          "",
          "[Removed Lines]",
          "109:   while( pExpr && ExprHasProperty(pExpr, EP_Skip) ){",
          "",
          "[Added Lines]",
          "113:   while( pExpr && ExprHasProperty(pExpr, EP_Skip|EP_Unlikely) ){",
          "",
          "---------------"
        ],
        "src/resolve.c||src/resolve.c": [
          "File: src/resolve.c -> src/resolve.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "747:       }else{",
          "748:         is_agg = pDef->xFinalize!=0;",
          "749:         if( pDef->funcFlags & SQLITE_FUNC_UNLIKELY ){",
          "751:           if( n==2 ){",
          "752:             pExpr->iTable = exprProbability(pList->a[1].pExpr);",
          "753:             if( pExpr->iTable<0 ){",
          "",
          "[Removed Lines]",
          "750:           ExprSetProperty(pExpr, EP_Unlikely|EP_Skip);",
          "",
          "[Added Lines]",
          "750:           ExprSetProperty(pExpr, EP_Unlikely);",
          "",
          "---------------"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h"
        ],
        "test/func3.test||test/func3.test": [
          "File: test/func3.test -> test/func3.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "153:   db eval {EXPLAIN SELECT unlikely(min(1.0+'2.0',4*11))}",
          "154: } [db eval {EXPLAIN SELECT min(1.0+'2.0',4*11)}]",
          "157: # EVIDENCE-OF: R-23735-03107 The likely(X) function returns the argument",
          "158: # X unchanged.",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "156: # Unlikely() does not preserve the affinity of X.",
          "157: # ticket https://www.sqlite.org/src/tktview/0c620df60b",
          "158: #",
          "159: do_execsql_test func3-5.40 {",
          "160:   SELECT likely(CAST(1 AS INT))=='1';",
          "161: } 0",
          "162: do_execsql_test func3-5.41 {",
          "163:   SELECT unlikely(CAST(1 AS INT))=='1';",
          "164: } 0",
          "165: do_execsql_test func3-5.41 {",
          "166:   SELECT likelihood(CAST(1 AS INT),0.5)=='1';",
          "167: } 0",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "c5b35ae567e0f68d20bb102f781d23c42251d042",
      "candidate_info": {
        "commit_hash": "c5b35ae567e0f68d20bb102f781d23c42251d042",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/c5b35ae567e0f68d20bb102f781d23c42251d042",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/window.c"
        ],
        "message": "Simplifications to the window-function code.\n\nFossilOrigin-Name: 489a1eb3aa2f1225b97b50a5f8688cf1a4ab0371973da1badc29616d70386c03",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/window.c||src/window.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: 040e196a8be3ca41b9365310ab88c2a3cc84b918a6511c77a6d95d4b4e0da3ed",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/window.c||src/window.c": [
          "File: src/window.c -> src/window.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1550:     assert( bInverse==0 || pWin->eStart!=TK_UNBOUNDED );",
          "1552:     for(i=0; i<nArg; i++){",
          "1553:       if( i!=1 || pFunc->zName!=nth_valueName ){",
          "1554:         sqlite3VdbeAddOp3(v, OP_Column, csr, pWin->iArgCol+i, reg+i);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "1554:     assert( pWin==pMWin || sqlite3WindowCompare(pParse,pWin,pMWin,0)==0 );",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1608:        && pWin->eStart==pWin->eEnd",
          "1609:        && pWin->eStart==TK_PRECEDING",
          "1610:       ){",
          "1612:         int regPeer = sqlite3GetTempReg(pParse);",
          "1613:         int regString = sqlite3GetTempReg(pParse);",
          "1614:         int lbl = sqlite3VdbeMakeLabel(pParse);",
          "1615:         VdbeModuleComment((v, \"windowAggStep \\\"peer is numeric?\\\" test\"));",
          "1619:         windowReadPeerValues(p, csr, regPeer);",
          "1620:         sqlite3VdbeAddOp2(v, OP_IsNull, regPeer, lbl);",
          "1621:         sqlite3VdbeAddOp4(v, OP_String8, 0, regString, 0, \"\", P4_STATIC);",
          "",
          "[Removed Lines]",
          "1611:         int op = ((pMWin->eStart==TK_FOLLOWING) ? OP_Ge : OP_Le);",
          "1616:         sqlite3VdbeAddOp3(v, op, p->regStart, lbl, p->regEnd);",
          "",
          "[Added Lines]",
          "1620:         sqlite3VdbeAddOp3(v, OP_Le, p->regStart, lbl, p->regEnd);",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "cc5979dbd384049c1efef847e5cc22082191024b",
      "candidate_info": {
        "commit_hash": "cc5979dbd384049c1efef847e5cc22082191024b",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/cc5979dbd384049c1efef847e5cc22082191024b",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/main.c",
          "src/shell.c.in",
          "src/sqlite.h.in",
          "src/sqliteInt.h",
          "src/vtab.c",
          "test/intarray.test",
          "test/vtab1.test"
        ],
        "message": "Add the ability to unregister a virtual table module by invoking sqlite3_create_module() with a NULL sqlite3_module pointer.\n\nFossilOrigin-Name: 31e34fa3390196cdc3178bf120224b08df5ec58fa2c77079ede6e9461a430dad",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/main.c||src/main.c",
          "src/shell.c.in||src/shell.c.in",
          "src/sqlite.h.in||src/sqlite.h.in",
          "src/sqliteInt.h||src/sqliteInt.h",
          "src/vtab.c||src/vtab.c",
          "test/intarray.test||test/intarray.test",
          "test/vtab1.test||test/vtab1.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid",
            "src/sqliteInt.h||src/sqliteInt.h"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: f17e72291f197a92b3e15e054271b997d45211a5a31ca4ea6c7fbb33026d5f1f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/main.c||src/main.c": [
          "File: src/main.c -> src/main.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "1236: #ifndef SQLITE_OMIT_VIRTUALTABLE",
          "1237:   for(i=sqliteHashFirst(&db->aModule); i; i=sqliteHashNext(i)){",
          "1238:     Module *pMod = (Module *)sqliteHashData(i);",
          "1242:     sqlite3VtabEponymousTableClear(db, pMod);",
          "1244:   }",
          "1245:   sqlite3HashClear(&db->aModule);",
          "1246: #endif",
          "",
          "[Removed Lines]",
          "1239:     if( pMod->xDestroy ){",
          "1240:       pMod->xDestroy(pMod->pAux);",
          "1241:     }",
          "1243:     sqlite3DbFree(db, pMod);",
          "",
          "[Added Lines]",
          "1240:     sqlite3VtabModuleUnref(db, pMod);",
          "",
          "---------------"
        ],
        "src/shell.c.in||src/shell.c.in": [
          "File: src/shell.c.in -> src/shell.c.in",
          "--- Hunk 1 ---",
          "[Context before]",
          "3649:   \"    --row                   Trace each row (SQLITE_TRACE_ROW)\",",
          "3650:   \"    --close                 Trace connection close (SQLITE_TRACE_CLOSE)\",",
          "3652:   \".vfsinfo ?AUX?           Information about the top-level VFS\",",
          "3653:   \".vfslist                 List all available VFSes\",",
          "3654:   \".vfsname ?AUX?           Print the name of the VFS stack\",",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "3652: #ifdef SQLITE_DEBUG",
          "3653:   \".unmodule NAME ...       Unregister virtual table modules\",",
          "3654: #endif",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "9401:   }else",
          "9404: #if SQLITE_USER_AUTHENTICATION",
          "9405:   if( c=='u' && strncmp(azArg[0], \"user\", n)==0 ){",
          "9406:     if( nArg<2 ){",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "9407: #ifdef SQLITE_DEBUG",
          "9408:   if( c=='u' && strncmp(azArg[0], \"unmodule\", n)==0 ){",
          "9409:     int ii;",
          "9410:     if( nArg<2 ){",
          "9411:       raw_printf(stderr, \"Usage: .unmodule NAME ...\\n\");",
          "9412:       rc = 1;",
          "9413:       goto meta_command_exit;",
          "9414:     }",
          "9415:     open_db(p, 0);",
          "9416:     for(ii=1; ii<nArg; ii++){",
          "9417:       sqlite3_create_module(p->db, azArg[ii], 0, 0);",
          "9418:     }",
          "9419:   }else",
          "9420: #endif",
          "",
          "---------------"
        ],
        "src/sqlite.h.in||src/sqlite.h.in": [
          "File: src/sqlite.h.in -> src/sqlite.h.in"
        ],
        "src/sqliteInt.h||src/sqliteInt.h": [
          "File: src/sqliteInt.h -> src/sqliteInt.h",
          "--- Hunk 1 ---",
          "[Context before]",
          "4438: #  define sqlite3VtabInSync(db) 0",
          "4439: #  define sqlite3VtabLock(X)",
          "4440: #  define sqlite3VtabUnlock(X)",
          "4441: #  define sqlite3VtabUnlockList(X)",
          "4442: #  define sqlite3VtabSavepoint(X, Y, Z) SQLITE_OK",
          "4443: #  define sqlite3GetVTable(X,Y)  ((VTable*)0)",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4442: #  define sqlite3VtabModuleUnref(D,X)",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "4449:    int sqlite3VtabCommit(sqlite3 *db);",
          "4450:    void sqlite3VtabLock(VTable *);",
          "4451:    void sqlite3VtabUnlock(VTable *);",
          "4452:    void sqlite3VtabUnlockList(sqlite3*);",
          "4453:    int sqlite3VtabSavepoint(sqlite3 *, int, int);",
          "4454:    void sqlite3VtabImportErrmsg(Vdbe*, sqlite3_vtab*);",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "4454:    void sqlite3VtabModuleUnref(sqlite3*,Module*);",
          "",
          "---------------"
        ],
        "src/vtab.c||src/vtab.c": [
          "File: src/vtab.c -> src/vtab.c",
          "--- Hunk 1 ---",
          "[Context before]",
          "42: ){",
          "43:   Module *pMod;",
          "48:   }else{",
          "51:     memcpy(zCopy, zName, nName+1);",
          "52:     pMod->zName = zCopy;",
          "53:     pMod->pModule = pModule;",
          "54:     pMod->pAux = pAux;",
          "55:     pMod->xDestroy = xDestroy;",
          "56:     pMod->pEpoTab = 0;",
          "60:       sqlite3OomFault(db);",
          "61:       sqlite3DbFree(db, pDel);",
          "62:       pMod = 0;",
          "63:     }",
          "64:   }",
          "65:   return pMod;",
          "",
          "[Removed Lines]",
          "44:   int nName = sqlite3Strlen30(zName);",
          "45:   pMod = (Module *)sqlite3Malloc(sizeof(Module) + nName + 1);",
          "46:   if( pMod==0 ){",
          "47:     sqlite3OomFault(db);",
          "49:     Module *pDel;",
          "50:     char *zCopy = (char *)(&pMod[1]);",
          "57:     pDel = (Module *)sqlite3HashInsert(&db->aModule,zCopy,(void*)pMod);",
          "58:     assert( pDel==0 || pDel==pMod );",
          "59:     if( pDel ){",
          "",
          "[Added Lines]",
          "47:   Module *pDel;",
          "48:   char *zCopy;",
          "49:   if( pModule==0 ){",
          "50:     zCopy = (char*)zName;",
          "51:     pMod = 0;",
          "53:     int nName = sqlite3Strlen30(zName);",
          "54:     pMod = (Module *)sqlite3Malloc(sizeof(Module) + nName + 1);",
          "55:     if( pMod==0 ){",
          "56:       sqlite3OomFault(db);",
          "57:       return 0;",
          "58:     }",
          "59:     zCopy = (char *)(&pMod[1]);",
          "66:     pMod->nRefModule = 1;",
          "67:   }",
          "68:   pDel = (Module *)sqlite3HashInsert(&db->aModule,zCopy,(void*)pMod);",
          "69:   if( pDel ){",
          "70:     if( pDel==pMod ){",
          "74:     }else{",
          "75:       sqlite3VtabModuleUnref(db, pDel);",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "80:   int rc = SQLITE_OK;",
          "82:   sqlite3_mutex_enter(db->mutex);",
          "88:   rc = sqlite3ApiExit(db, rc);",
          "89:   if( rc!=SQLITE_OK && xDestroy ) xDestroy(pAux);",
          "90:   sqlite3_mutex_leave(db->mutex);",
          "",
          "[Removed Lines]",
          "83:   if( sqlite3HashFind(&db->aModule, zName) ){",
          "84:     rc = SQLITE_MISUSE_BKPT;",
          "85:   }else{",
          "86:     (void)sqlite3VtabCreateModule(db, zName, pModule, pAux, xDestroy);",
          "87:   }",
          "",
          "[Added Lines]",
          "96:   (void)sqlite3VtabCreateModule(db, zName, pModule, pAux, xDestroy);",
          "",
          "---------------",
          "--- Hunk 3 ---",
          "[Context before]",
          "123:   return createModule(db, zName, pModule, pAux, xDestroy);",
          "124: }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "139: void sqlite3VtabModuleUnref(sqlite3 *db, Module *pMod){",
          "140:   assert( pMod->nRefModule>0 );",
          "141:   pMod->nRefModule--;",
          "142:   if( pMod->nRefModule==0 ){",
          "143:     if( pMod->xDestroy ){",
          "144:       pMod->xDestroy(pMod->pAux);",
          "145:     }",
          "146:     assert( pMod->pEpoTab==0 );",
          "147:     sqlite3DbFree(db, pMod);",
          "148:   }",
          "149: }",
          "",
          "---------------",
          "--- Hunk 4 ---",
          "[Context before]",
          "162:   pVTab->nRef--;",
          "163:   if( pVTab->nRef==0 ){",
          "164:     sqlite3_vtab *p = pVTab->pVtab;",
          "165:     if( p ){",
          "166:       p->pModule->xDisconnect(p);",
          "167:     }",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "190:     sqlite3VtabModuleUnref(pVTab->db, pVTab->pMod);",
          "",
          "---------------",
          "--- Hunk 5 ---",
          "[Context before]",
          "567:     memset(pVTable->pVtab, 0, sizeof(pVTable->pVtab[0]));",
          "568:     pVTable->pVtab->pModule = pMod->pModule;",
          "569:     pVTable->nRef = 1;",
          "570:     if( sCtx.bDeclared==0 ){",
          "571:       const char *zFormat = \"vtable constructor did not declare schema: %s\";",
          "",
          "[Removed Lines]",
          "[None]",
          "",
          "[Added Lines]",
          "595:     pMod->nRefModule++;",
          "",
          "---------------"
        ],
        "test/intarray.test||test/intarray.test": [
          "File: test/intarray.test -> test/intarray.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "47:   }",
          "48: } {table ia1 table ia2 table ia3 table ia4}",
          "51: do_test intarray-1.1b {",
          "52:   db eval {DROP TABLE ia1}",
          "57: do_test intarray-1.2 {",
          "58:   db eval {",
          "",
          "[Removed Lines]",
          "50: # Verify the inability to DROP and recreate an intarray virtual table.",
          "53:   set rc [catch {sqlite3_intarray_create db ia1} msg]",
          "54:   lappend rc $msg",
          "55: } {1 SQLITE_MISUSE}",
          "",
          "[Added Lines]",
          "50: # Verify the ability to DROP and recreate an intarray virtual table.",
          "53:   set rc [catch {sqlite3_intarray_create db ia1} ia1]",
          "54:   lappend rc $ia1",
          "55: } {/0 [0-9A-Z]+/}",
          "",
          "---------------"
        ],
        "test/vtab1.test||test/vtab1.test": [
          "File: test/vtab1.test -> test/vtab1.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "1352: do_execsql_test 18.2.x {  PRAGMA case_sensitive_like = OFF }",
          "1354: #-------------------------------------------------------------------------",
          "1356: #",
          "1357: do_test 19.1 {",
          "1358:   sqlite3 db2 test.db",
          "",
          "[Removed Lines]",
          "1355: # Test that an existing module may not be overridden.",
          "",
          "[Added Lines]",
          "1355: # Test that it is ok to override and existing module.",
          "",
          "---------------",
          "--- Hunk 2 ---",
          "[Context before]",
          "1360: } SQLITE_OK",
          "1361: do_test 19.2 {",
          "1362:   register_echo_module [sqlite3_connection_pointer db2]",
          "1364: do_test 19.3 {",
          "1365:   db2 close",
          "1366: } {}",
          "",
          "[Removed Lines]",
          "1363: } SQLITE_MISUSE",
          "",
          "[Added Lines]",
          "1363: } SQLITE_OK",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "3a85a298c903a1b5761a2d1f90b7519d6211b5c7",
      "candidate_info": {
        "commit_hash": "3a85a298c903a1b5761a2d1f90b7519d6211b5c7",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/3a85a298c903a1b5761a2d1f90b7519d6211b5c7",
        "files": [
          "manifest",
          "manifest.uuid",
          "test/incrvacuum.test"
        ],
        "message": "Update incrvacuum.test so that it works with builds that do not support mmap().\n\nFossilOrigin-Name: 8eb62fd5fa9adb88de51aa812270dbdb32ee5cacd636d200e658c507a14a035b",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "test/incrvacuum.test||test/incrvacuum.test"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: b53a9a3dc6b0422a102b245451769b0cd8c0d67090fefabf7cb3a65137a73771",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "test/incrvacuum.test||test/incrvacuum.test": [
          "File: test/incrvacuum.test -> test/incrvacuum.test",
          "--- Hunk 1 ---",
          "[Context before]",
          "788: # were outstanding xFetch() references. This test case attempts to hit",
          "789: # that case.",
          "790: #",
          "834: finish_test",
          "",
          "[Removed Lines]",
          "791: reset_db",
          "792: do_execsql_test incrvacuum-16.0 {",
          "793:   PRAGMA auto_vacuum = 2;",
          "794:   CREATE TABLE t3(a);",
          "795:   INSERT INTO t3 VALUES(1), (2), (3), (4);",
          "797:   CREATE TABLE t2(x);",
          "798:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "799:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "800:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "801:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "802:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "803:   INSERT INTO t2 VALUES( randomblob(1000) );",
          "804: } {}",
          "806: # Reopen db to ensure the page-cache is empty.",
          "807: #",
          "808: db close",
          "809: sqlite3 db test.db",
          "811: # Open db in mmap-mode. Open a transaction, delete some data, then run",
          "812: # incremental-vacuum. Do not commit the transaction.",
          "813: #",
          "814: do_execsql_test incrvacuum-16.1 {",
          "815:   PRAGMA mmap_size = 1000000;",
          "816:   BEGIN;",
          "817:   DELETE FROM t2;",
          "818:   PRAGMA incremental_vacuum = 1000;",
          "819: } {1000000}",
          "821: # Scan through table t3 (which is all clean pages - so mmap is used). Then,",
          "822: # midway through, commit the transaction. This causes the db to be truncated",
          "823: # while there are outstanding xFetch pages.",
          "824: #",
          "825: do_test incrvacuum-16.2 {",
          "826:   set res [list]",
          "827:   db eval { SELECT a FROM t3 } {",
          "828:     if {$a==3} { db eval COMMIT }",
          "829:     lappend res $a",
          "830:   }",
          "831:   set res",
          "832: } {1 2 3 4}",
          "",
          "[Added Lines]",
          "791: ifcapable mmap {",
          "792:   reset_db",
          "793:   do_execsql_test incrvacuum-16.0 {",
          "794:     PRAGMA auto_vacuum = 2;",
          "795:     CREATE TABLE t3(a);",
          "796:     INSERT INTO t3 VALUES(1), (2), (3), (4);",
          "798:     CREATE TABLE t2(x);",
          "799:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "800:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "801:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "802:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "803:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "804:     INSERT INTO t2 VALUES( randomblob(1000) );",
          "805:   } {}",
          "807:   # Reopen db to ensure the page-cache is empty.",
          "808:   #",
          "809:   db close",
          "810:   sqlite3 db test.db",
          "812:   # Open db in mmap-mode. Open a transaction, delete some data, then run",
          "813:   # incremental-vacuum. Do not commit the transaction.",
          "814:   #",
          "815:   do_execsql_test incrvacuum-16.1 {",
          "816:     PRAGMA mmap_size = 1000000;",
          "817:     BEGIN;",
          "818:     DELETE FROM t2;",
          "819:     PRAGMA incremental_vacuum = 1000;",
          "820:   } {1000000}",
          "822:   # Scan through table t3 (which is all clean pages - so mmap is used). Then,",
          "823:   # midway through, commit the transaction. This causes the db to be truncated",
          "824:   # while there are outstanding xFetch pages.",
          "825:   #",
          "826:   do_test incrvacuum-16.2 {",
          "827:     set res [list]",
          "828:     db eval { SELECT a FROM t3 } {",
          "829:       if {$a==3} { db eval COMMIT }",
          "830:       lappend res $a",
          "831:     }",
          "832:     set res",
          "833:   } {1 2 3 4}",
          "834: }",
          "",
          "---------------"
        ]
      }
    },
    {
      "candidate_hash": "0c5a95e43a789f60d480bcdb0283356738c38b10",
      "candidate_info": {
        "commit_hash": "0c5a95e43a789f60d480bcdb0283356738c38b10",
        "repo": "sqlite/sqlite",
        "commit_url": "https://github.com/sqlite/sqlite/commit/0c5a95e43a789f60d480bcdb0283356738c38b10",
        "files": [
          "manifest",
          "manifest.uuid",
          "src/where.c"
        ],
        "message": "Remove a C++-style comment.\n\nFossilOrigin-Name: 645232f2b9ce3ee345b1d22c0db1265e39bb674bef9ab6fb10d5bee8ab696787",
        "before_after_code_files": [
          "manifest.uuid||manifest.uuid",
          "src/where.c||src/where.c"
        ]
      },
      "candidate_patch_features": {
        "candidate_earlier_than_patch": 1,
        "same_branch_evolution": 1,
        "olp_code_files": {
          "patch": [
            "manifest.uuid||manifest.uuid"
          ],
          "candidate": [
            "manifest.uuid||manifest.uuid"
          ]
        }
      },
      "candidate_diff": {
        "manifest.uuid||manifest.uuid": [
          "File: manifest.uuid -> manifest.uuid",
          "--- Hunk 1 ---",
          "[Context before]",
          "[No context available]",
          "",
          "[Removed Lines]",
          "1: acfd0a05a8957728c1f0eb936f4121ce26f291f20dd583bd57ce2bb271617d3f",
          "",
          "[Added Lines]",
          "[None]",
          "",
          "---------------"
        ],
        "src/where.c||src/where.c": [
          "File: src/where.c -> src/where.c"
        ]
      }
    }
  ]
}